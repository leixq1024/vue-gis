// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../core/colorUtils ../../core/Error ../../intl/messages ../../renderers/support/AuthoringInfo ../../renderers/support/AuthoringInfoVisualVariable ../../renderers/support/numberUtils ../../renderers/visualVariables/OpacityVariable ../../renderers/visualVariables/support/OpacityStop ../../renderers/visualVariables/support/VisualVariableLegendOptions ../heuristics/outline ./size ./type ./support/regenerateUtils ./support/utils ../statistics/predominantCategories ../statistics/support/predominanceUtils ../support/binningUtils ../support/adapters/support/layerUtils ../symbology/predominance".split(" "),
function(B,R,p,C,D,S,T,U,G,V,H,W,X,k,n,Y,I,Z,x,J){async function K(a){if(!(a?.layer&&a.view&&a.fields?.length))throw new p("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(2>a.fields.length)throw new p("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(10<a.fields.length)throw new p("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");a.forBinning&&Z.verifyBinningParams(a,"predominance-renderer");
const b={...a,layer:a.layer,fields:a.fields};b.symbolType=b.symbolType||"2d";b.defaultSymbolEnabled??(b.defaultSymbolEnabled=!0);b.includeOpacityVariable=a.includeOpacityVariable||!1;b.includeSizeVariable=a.includeSizeVariable||!1;b.sortBy??(b.sortBy="count");a=x.createLayerAdapter(b.layer,a.forBinning?x.binningCapableLayerTypes:x.featureCapableLayerTypes,a.forBinning);if(!a)throw new p("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+x.getLayerTypeLabels(x.featureCapableLayerTypes).join(", "));
await a.load(null!=b.signal?{signal:b.signal}:null);var c=a.geometryType;const d=b.symbolType.includes("3d");b.outlineOptimizationEnabled="polygon"===c?b.outlineOptimizationEnabled:!1;b.includeSizeVariable||(b.sizeOptimizationEnabled="point"===c||"multipoint"===c||"polyline"===c?b.sizeOptimizationEnabled:!1);if("mesh"===c)b.symbolType="3d-volumetric",b.colorMixMode=b.colorMixMode||"replace",b.edgesType=b.edgesType||"none",b.sizeOptimizationEnabled=!1;else{if(d&&("polyline"===c||"polygon"===c))throw new p("predominance-renderer:not-supported",
"3d symbols are not supported for polyline and polygon layers");if(b.symbolType.includes("3d-volumetric")&&(!b.view||"3d"!==b.view.type))throw new p("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");}c=b.fields.map(f=>f.name);if(c=n.verifyBasicFieldValidity(a,c,"predominance-renderer:invalid-parameters"))throw c;return{...b,layer:a}}async function aa(a){await k.processRegenerateParams(a,
"regenerate-predominance-renderer");const b=await k.getRendererToUpdate(a);if("predominance"!==k.getStyleType(b))throw new p("regenerate-predominance-renderer:invalid-parameters","Renderer is invalid");var {visualVariables:c}=b;const {layer:d,forBinning:f,filter:e,view:h,signal:g}=a;var q=k.hasOutlineVV(b);const v=k.hasScaleDependentSizeVV(b),u=c?.some(k.isSizeVV);c=c?.some(r=>"opacity"===r.type);const m=b.authoringInfo?.fields?.map(r=>({name:r}));if(!m?.length)throw new p("regenerate-predominance-renderer:invalid-parameters",
"Fields are required");q=await K({layer:d,fields:m,outlineOptimizationEnabled:q,sizeOptimizationEnabled:v,includeSizeVariable:u,includeOpacityVariable:c,forBinning:f,filter:e,view:h,signal:g});return{...a,creatorParameters:q,renderer:b}}async function L(a){let b=a.predominanceScheme,c=null;var d=null;d=await n.getBasemapInfo(a.basemap,a.view);c=null!=d.basemapId?d.basemapId:null;d=null!=d.basemapTheme?d.basemapTheme:null;if(b)return{scheme:J.cloneScheme(b),basemapId:c,basemapTheme:d};if(a=J.getSchemes({basemapTheme:d,
geometryType:a.geometryType,numColors:a.numColors,theme:a.theme,worldScale:a.worldScale,view:a.view}))b=a.primaryScheme,c=a.basemapId,d=a.basemapTheme;return{scheme:b,basemapId:c,basemapTheme:d}}async function ba(a,b,c,d){var f=await C.fetchMessageBundle("esri/smartMapping/t9n/smartMapping"),e=a.layer;const {view:h,filter:g,signal:q}=a,[v,u]=await Promise.all([Y({layer:e,fields:d,view:h,filter:g,signal:q}),a.outlineOptimizationEnabled?H({layer:e,view:h,filter:g,signal:q}).catch(n.errorCallback):null]);
let m=v;v?.predominantCategoryInfos||(m={predominantCategoryInfos:d.map(l=>({value:l,count:0}))});const r=u?.opacity;b=await X.createRenderer({layer:e,basemap:a.basemap,valueExpression:b.valueExpression,valueExpressionTitle:f.predominantCategory,numTypes:-1,defaultSymbolEnabled:a.defaultSymbolEnabled,sortBy:a.sortBy,typeScheme:c,statistics:{uniqueValueInfos:m.predominantCategoryInfos},legendOptions:a.legendOptions,outlineOptimizationEnabled:!1,sizeOptimizationEnabled:a.includeSizeVariable&&a.sizeOptimizationEnabled?
!1:a.sizeOptimizationEnabled,symbolType:a.symbolType,colorMixMode:a.colorMixMode,edgesType:a.edgesType,filter:a.filter,view:a.view,signal:a.signal});const {renderer:t,basemapId:z,basemapTheme:E,uniqueValueInfos:F,excludedUniqueValueInfos:ca}=b;b=t.uniqueValueInfos??[];const M={};for(var w of a.fields)f=e.getField(w.name),M[f.name]=w.label||f&&f.alias||w.name;b.forEach((l,y)=>{const A=M[l.value];l.label=A;F[y].label=A});if(a.includeSizeVariable){let l=e.geometryType,y=null;"polygon"===l?(e=c.sizeScheme,
w=e.background,t.backgroundFillSymbol=n.createSymbol(l,{type:a.symbolType,color:w.color,outline:n.getSymbolOutlineFromScheme(w,l,r)}),y=e.marker.size,l="point"):y="polyline"===l?c.width:c.size;const A=R.createUniqueColors(c.colors,b.length);b.forEach((da,N)=>{const O=n.createSymbol(l,{type:a.symbolType,color:A[N],size:y,outline:n.getSymbolOutlineFromScheme(c,l,r),meshInfo:{colorMixMode:a.colorMixMode,edgesType:a.edgesType}});da.symbol=O;F[N].symbol=O.clone()})}u?.visualVariables.length&&(t.visualVariables=
u.visualVariables.map(l=>l.clone()));t.authoringInfo=new D({type:"predominance",fields:[...d]});return{renderer:t,predominantCategoryInfos:F,excludedCategoryInfos:ca,predominanceScheme:c,basemapId:z,basemapTheme:E}}async function P(a,b,c){const d=await C.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");return W.createVisualVariables({layer:a.layer,basemap:a.basemap,valueExpression:b.valueExpression,sqlExpression:b.statisticsQuery.sqlExpression,sqlWhere:b.statisticsQuery.sqlWhere,sizeScheme:c,
sizeOptimizationEnabled:a.sizeOptimizationEnabled,worldScale:!!a.symbolType?.includes("3d-volumetric"),legendOptions:{title:d.sumOfCategories},filter:a.filter,view:a.view,signal:a.signal})}async function Q(a,b){var c=await C.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");const d=await n.getSummaryStatistics({layer:a.layer,valueExpression:b.valueExpression,sqlExpression:b.statisticsQuery.sqlExpression,sqlWhere:b.statisticsQuery.sqlWhere,filter:a.filter,view:a.view,signal:a.signal}),{avg:f,
stddev:e}=d,h=null==f||null==e;a=1/a.fields.length*100;let g=h?100:f+1.285*e;100<g&&(g=100);a=T.round([a,g],{strictBounds:!0});b=new U({valueExpression:b.valueExpression,stops:[new G({value:a[0],opacity:.15}),new G({value:a[1],opacity:1})],legendOptions:new V({title:c.strengthOfPredominance})});c=new S({type:"opacity",minSliderValue:d.min,maxSliderValue:d.max});c=new D({visualVariables:[c]});return{visualVariable:b,statistics:d,defaultValuesUsed:h,authoringInfo:c}}B.createRenderer=async function(a){a=
await K(a);var b=a.layer,c=(await L({basemap:a.basemap,geometryType:b.geometryType,numColors:a.fields.length,predominanceScheme:a.predominanceScheme,worldScale:!!a.symbolType?.includes("3d-volumetric"),view:a.view})).scheme,d=a.fields.map(g=>g.name);b=I.getPredominanceExpressions(b,d);d=ba(a,b.predominantCategory,c,d);c=a.includeSizeVariable?P(a,b.size,c.sizeScheme):null;a=a.includeOpacityVariable?Q(a,b.opacity):null;const [f,e,h]=await Promise.all([d,c,a]);a=[];c=[];e&&(Array.prototype.push.apply(a,
e.visualVariables.map(g=>g.clone())),delete e.sizeScheme,f.size=e,Array.prototype.push.apply(c,e.authoringInfo.visualVariables.map(g=>g.clone())));h&&(a.push(h.visualVariable.clone()),f.opacity=h,Array.prototype.push.apply(c,h.authoringInfo.visualVariables.map(g=>g.clone())));if(a.length){b=f.renderer.visualVariables||[];Array.prototype.push.apply(b,a);f.renderer.visualVariables=b;let g;(g=f.renderer).authoringInfo??(g.authoringInfo=new D);f.renderer.authoringInfo.visualVariables=c}return f};B.regenerateRenderer=
async function(a){const {creatorParameters:b,view:c,signal:d,filter:f,renderer:e}=await aa(a),{layer:h,fields:g,outlineOptimizationEnabled:q,includeSizeVariable:v,includeOpacityVariable:u}=b;a=g.map(E=>E.name);a=I.getPredominanceExpressions(h,a);var m=(await L({geometryType:h.geometryType,numColors:b.fields.length,view:b.view})).scheme;m=m&&"sizeScheme"in m?m.sizeScheme:null;const [r,t,z]=await Promise.all([q?H({layer:h,view:c,signal:d,filter:f}).catch(n.errorCallback):null,v?P(b,a.size,m):null,u?
Q(b,a.opacity):null]);k.spliceVisualVariables(e,r?.visualVariables,k.findOutlineVVIndex);k.spliceVisualVariables(e,t?.visualVariables,k.findSizeVVIndex);k.spliceVisualVariables(e,z?.visualVariable,k.findOpacityVVIndex);k.updateAuthoringInfoVisualVariable(e,t?.authoringInfo,"size");k.updateAuthoringInfoVisualVariable(e,z?.authoringInfo,"opacity");return{renderer:e}};Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});