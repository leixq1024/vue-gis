// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../renderers/support/AuthoringInfo ../../renderers/support/ClassBreakInfo ../../renderers/visualVariables/support/SizeStop ../../renderers/visualVariables/support/visualVariableUtils ./color ./size ./support/regenerateUtils ./support/utils ../support/binningUtils ../support/utils ../support/adapters/support/layerUtils ../symbology/support/aboveAndBelowUtils ../../symbols/support/cimSymbolUtils ../../symbols/support/Symbol3DMaterial".split(" "),function(u,p,P,A,
q,v,B,w,r,x,C,y,t,Q,R,S){async function D(a){if(!a?.layer||!(a.field||a.valueExpression||a.sqlExpression))throw new p("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(a.valueExpression&&!a.sqlExpression&&!a.view)throw new p("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===a.theme&&a.sizeOptions?.sizeOptimizationEnabled)throw new p("univariate-colorsize-visual-variables:invalid-parameters",
"sizeOptimizationEnabled cannot be true for 'above-and-below' theme");a.forBinning&&C.verifyBinningParams(a,"univariate-colorsize-visual-variables");const b={...a,layer:a.layer};var c=a.forBinning?t.binningCapableLayerTypes:t.featureCapableLayerTypes;a=t.createLayerAdapter(b.layer,c,a.forBinning);if(!a)throw new p("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+t.getLayerTypeLabels(c).join(", "));b.layer=a;b.theme=b.theme||b.colorOptions?.theme?b.theme:
"high-to-low";await a.load(null!=b.signal?{signal:b.signal}:null);c=await y.getFieldsList({field:b.field,normalizationField:b.normalizationField,valueExpression:b.valueExpression});if(c=x.verifyBasicFieldValidity(a,c,"univariate-colorsize-visual-variables:invalid-parameters"))throw c;return b}function E(a,b){a={...a};const {sizeOptions:c,theme:d}=a,f=a.legendOptions||a.sizeOptions?.legendOptions;delete a.sizeOptions;delete a.colorOptions;return{...a,...c,statistics:b||a.statistics,theme:"above-and-below"===
d?null:d,legendOptions:f}}function F(a,b){a={...a};const c=a.colorOptions,d=a.theme||c?.theme,f=a.legendOptions||a.colorOptions?.legendOptions;delete a.sizeOptions;delete a.colorOptions;return{...a,...c,statistics:b||a.statistics,theme:d,legendOptions:f}}async function G(a){if(!a?.layer||!(a.field||a.valueExpression||a.sqlExpression))throw new p("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(a.valueExpression&&
!a.sqlExpression&&!a.view)throw new p("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");a.forBinning&&C.verifyBinningParams(a,"univariate-colorsize-continuous-renderer");const b={...a,layer:a.layer};b.symbolType=b.symbolType||"2d";b.colorOptions||(b.colorOptions={});b.colorOptions.isContinuous=b.colorOptions.isContinuous??!1;var c=a.forBinning?t.binningCapableLayerTypes:t.featureCapableLayerTypes;a=t.createLayerAdapter(b.layer,c,
a.forBinning);if(!a)throw new p("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+t.getLayerTypeLabels(c).join(", "));await a.load(null!=b.signal?{signal:b.signal}:null);if("above-and-below"===b.theme&&b.symbolOptions){if(b.symbolType.includes("3d-volumetric"))throw new p("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==a.geometryType&&"polygon"!==
a.geometryType)throw new p("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType");}c=await y.getFieldsList({field:b.field,normalizationField:b.normalizationField,valueExpression:b.valueExpression});if(c=x.verifyBasicFieldValidity(a,c,"univariate-colorsize-continuous-renderer:invalid-parameters"))throw c;return{...b,layer:a}}async function T(a){await r.processRegenerateParams(a,"regenerate-univariate-color-size-renderer");
const b=await r.getRendererToUpdate(a);if("univariate-color-size"!==r.getStyleType(b))throw new p("regenerate-univariate-color-size-renderer:invalid-parameters","Renderer is invalid");const {layer:c,forBinning:d,filter:f,view:e,signal:h}=a,{field:g,normalizationField:l,valueExpression:k,valueExpressionTitle:m}=b;var n=r.hasOutlineVV(b);const z=r.hasScaleDependentSizeVV(b),H=b.authoringInfo?.univariateTheme;n=await G({layer:c,field:g,normalizationField:l,valueExpression:k,valueExpressionTitle:m,outlineOptimizationEnabled:n,
theme:H,colorOptions:{isContinuous:"above-and-below"===H?b.visualVariables?.some(U=>"color"===U.type):void 0},sizeOptions:{sizeOptimizationEnabled:z},forBinning:d,filter:f,view:e,signal:h});return{...a,creatorParameters:n,renderer:b}}function I(a,b){"type"in a&&"cim"===a.type?R.applyCIMSymbolColor(a,b):"type"in a&&a.type.includes("3d")?a.symbolLayers.forEach(c=>{"material"in c&&null!=c.material&&"color"in c.material&&(c.material?c.material.color=b:c.material=new S.Symbol3DMaterial({color:b}))}):"color"in
a&&(a.color=b)}function J(a,b,c=!0){const d=b?.authoringInfo?.clone(),f=d?.visualVariables?.some(e=>"reference-size"===e.theme)?[]:b.size.visualVariables.map(e=>e.clone());c?f.push(b.color.visualVariable.clone()):d.visualVariables=d.visualVariables?.filter(e=>"size"===e.type);a.visualVariables&&f.push(...a.visualVariables.filter(e=>"target"in e&&"outline"===e.target).map(e=>e.clone()));a.authoringInfo=d;a.visualVariables=f}function K(a){a={...a};const b=a.symbolType,c=!!b?.includes("3d-volumetric");
delete a.symbolType;delete a.defaultSymbolEnabled;if(a.worldScale=c)a.sizeOptions={...a.sizeOptions},a.sizeOptions.axis="3d-volumetric-uniform"===b?"all":"height";return a}async function V(a,b,c,d){const f=b[0];b=b[1];const e=Math.round((b-f)/2)+f,h=a.clone();h.stops=[new q({value:c[0],size:b}),new q({value:c[1],size:e}),new q({value:c[2],size:f}),new q({value:c[3],size:e}),new q({value:c[4],size:b})];a.stops=[new q({value:d[0],size:v.getSize(h,d[0])}),new q({value:d[1],size:v.getSize(h,d[1])}),new q({value:d[2],
size:v.getSize(h,d[2])}),new q({value:d[3],size:v.getSize(h,d[3])}),new q({value:d[4],size:v.getSize(h,d[4])})]}async function L(a,b,c,d,f){a=a.find(g=>"width-and-depth"!==g.axis&&!g.target);const e="number"===typeof a?.minSize?a?.minSize:null,h="number"===typeof a?.maxSize?a?.maxSize:null;if(null!=a?.minDataValue&&null!=e&&null!=h)if(d)if("above-and-below"===d){a.minDataValue=null;a.maxDataValue=null;a.minSize=null;a.maxSize=null;d=x.createStopValuesForAboveBelow(c,f);const g=x.clampAboveAndBelowStopValues(d,
c);await V(a,[e,h],d,g);b.stops.forEach((l,k)=>l.value=g[k])}else{const {minDataValue:g,maxDataValue:l}=a,k=x.createDefaultStopValues(g,l,5);b.stops.forEach((m,n)=>m.value=k[n]);a.minDataValue=k[0];a.maxDataValue=k[k.length-1]}else a.minDataValue=b.stops[0].value,a.maxDataValue=b.stops[b.stops.length-1].value}async function M(a){var b=await D(a),c=await B.createVisualVariable(F(b));const {visualVariable:d,statistics:f}=c;var e=await w.createVisualVariables(E(b,f)),h=e.visualVariables,g=a.layer;a=
a.field?g.getField(a.field):null;await L(h,d,f,b.theme,y.isAnyDateField(a));a=e.basemapId;g=e.basemapTheme;var l=c.defaultValuesUsed,k={visualVariable:d,colorScheme:c.colorScheme};h={visualVariables:h,sizeScheme:e.sizeScheme};const {theme:m,minValue:n,maxValue:z}=b;b=c.authoringInfo.visualVariables[0].clone();e=e.authoringInfo.visualVariables[0].clone();({stops:c}=c.visualVariable);"above-and-below"===m?(b.minSliderValue=e.minSliderValue=n??c[0].value,b.maxSliderValue=e.maxSliderValue=z??c.at(-1)?.value,
e.theme="above-and-below"):m&&"high-to-low"!==m||"reference-size"!==e.theme||2!==e.sizeStops?.length||(e.sizeStops[0].value=c[0].value,e.sizeStops[1].value=c.at(-1)?.value);c=new P({type:"univariate-color-size",univariateTheme:m,visualVariables:[b,e]});return{basemapId:a,basemapTheme:g,statistics:f,defaultValuesUsed:l,color:k,size:h,authoringInfo:c}}async function N(a){a=await G(a);var b=w.createContinuousRenderer,c={...a},d={...c.sizeOptions};delete c.sizeOptions;delete c.colorOptions;delete d.sizeOptimizationEnabled;
const {renderer:f,statistics:e,defaultValuesUsed:h}=await b.call(w,{...c,...d});b=K(a);b.statistics=e;b=await M(b);if("above-and-below"===a.theme){var g=a.symbolOptions,l=a.layer;c=g?.symbols?"custom":g?.symbolStyle;var k=a.colorOptions?.isContinuous;J(f,b,k);if(c||!k){d=b.size.visualVariables[0].stops;l=l.geometryType;!g?.symbolStyle&&!g?.symbols||"point"!==l&&"polygon"!==l?(g=f.classBreakInfos[0].symbol,g={above:g.clone(),below:g.clone()}):g=g.symbols||Q.getAboveAndBelowSymbols(g.symbolStyle);const {above:m,
below:n}=g;k||(k=b.color.colorScheme.colors,g=k[0],I(m,k[k.length-1]),I(n,g));f.classBreakInfos=[new A({minValue:-O,maxValue:d[2].value,symbol:n}),new A({minValue:d[2].value,maxValue:O,symbol:m})];c&&f.authoringInfo&&(f.authoringInfo.univariateSymbolStyle=c)}}else J(f,b);return{renderer:f,statistics:e,defaultValuesUsed:h,color:a.colorOptions?.isContinuous||"above-and-below"!==a.theme?b.color:null,size:b.size,basemapId:b.basemapId,basemapTheme:b.basemapTheme}}const O=2**53-1;u.createContinuousRenderer=
async function(a){return N(a)};u.createRenderer=N;u.createVisualVariables=M;u.regenerateRenderer=async function(a){var {creatorParameters:b}=await T(a);const {layer:c,field:d,theme:f,colorOptions:e}=b,{renderer:h,statistics:g}=await w.regenerateContinuousRenderer(a);a=await D({...K(b),statistics:g});b=await B.createVisualVariable(F(a));const l=b.visualVariable;a=(await w.createVisualVariables(E(a))).visualVariables;var k=d?c.getField(d):null;await L(a,l,g,f,y.isAnyDateField(k));k=h.visualVariables?.find(r.isColorVV);
(e?.isContinuous||"above-and-below"!==f)&&k?.stops&&(k.stops.forEach((m,n)=>m.value=l.stops[n].value),r.updateAuthoringInfoVisualVariable(h,b.authoringInfo,"color"));r.spliceVisualVariables(h,a,r.findSizeVVIndex);b=r.getAuthoringInfoVisualVariable(h,"size");f&&"high-to-low"!==f||!b||"reference-size"!==b.theme||2!==b.sizeStops?.length||({stops:k}=l,b.sizeStops[0].value=k[0].value,b.sizeStops[1].value=k.at(-1)?.value);"above-and-below"===f&&a[0]?.stops&&(a=a[0].stops,h.classBreakInfos[0].maxValue=a[2].value,
h.classBreakInfos[1].minValue=a[2].value);return{renderer:h}};Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});