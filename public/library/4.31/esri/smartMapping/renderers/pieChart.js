// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../Color ../../renderers/ClassBreaksRenderer ../../renderers/DictionaryRenderer ../../renderers/DotDensityRenderer ../../renderers/HeatmapRenderer ../../renderers/PieChartRenderer ../../renderers/Renderer ../../renderers/SimpleRenderer ../../renderers/UniqueValueRenderer ../../renderers/support/jsonUtils ../../core/Logger ../../symbols ../../core/arrayUtils ../../core/colorUtils ../../core/Error ../../core/screenUtils ../../intl/messages ../../layers/support/AggregateField ../../layers/support/ExpressionInfo ../../renderers/support/AttributeColorInfo ../../renderers/support/OthersCategory ../heuristics/outline ../heuristics/sizeRange ./size ./support/regenerateUtils ./support/utils ../statistics/predominantCategories ../statistics/support/utils ../support/binningUtils ../support/utils ../support/adapters/support/layerUtils ../symbology/pieChart ../../symbols/support/cimSymbolUtils ../../symbols/SimpleLineSymbol".split(" "),
function(A,u,sa,ta,ua,va,M,wa,xa,ya,za,Aa,Ba,X,I,n,Y,J,B,C,N,Z,O,P,aa,t,w,ba,ca,da,ea,v,K,fa,ha){async function Q(a){if(!(a?.layer&&a.view&&a.attributes?.length))throw new n("pie-chart-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(10<a.attributes.length)throw new n("pie-chart-renderer:invalid-parameters","PieChart renderer does not support more than 10 attributes");a.forBinning&&da.verifyBinningParams(a,"pie-chart-renderer");const b={...a,layer:a.layer,
view:a.view,attributes:a.attributes};b.shape=b.shape||"pie";b.othersCategoryEnabled??(b.othersCategoryEnabled=!0);b.includeSizeVariable=a.includeSizeVariable||!1;var c=a.forBinning?v.binningCapableLayerTypes:L;const d=v.createLayerAdapter(b.layer,c,a.forBinning);if(!d)throw new n("pie-chart-renderer:invalid-parameters","'layer' must be one of these types: "+v.getLayerTypeLabels(c).join(", "));c=null!=b.signal?{signal:b.signal}:null;await Promise.all([a.view.when(),d.load(c)]);c=d.geometryType;a="polygon"===
c;c="point"===c||"multipoint"===c||a;b.outlineOptimizationEnabled=a?b.outlineOptimizationEnabled:!1;b.sizeOptimizationEnabled=c?b.sizeOptimizationEnabled:!1;if(!c)throw new n("pie-chart-renderer:not-supported","PieChart renderer is only supported for point and polygon layers");a=[];c=b.attributes;for(var f of c)c=await ea.getFieldsList({field:f.field,valueExpression:f.valueExpression}),a.push(...c);if(f=w.verifyBasicFieldValidity(d,a.filter(Boolean),"pie-chart-renderer:invalid-parameters"))throw f;
return{...b,layer:d}}async function ia(a){await t.processRegenerateParams(a,"regenerate-pie-chart-renderer");const b=await t.getRendererToUpdate(a);if("pie-chart"!==t.getStyleType(b))throw new n("regenerate-pie-chart-renderer:invalid-parameters","Renderer is invalid");var {visualVariables:c}=b;const {layer:d,forBinning:f,filter:g,view:l,signal:p}=a;var h=t.hasOutlineVV(b);const r=t.hasScaleDependentSizeVV(b);c=c?.some(t.isSizeVV);const k=b.attributes.map(e=>({field:e.field,label:e.label,valueExpression:e.valueExpression,
valueExpressionTitle:e.valueExpressionTitle}));h=await Q({layer:d,attributes:k,outlineOptimizationEnabled:h,sizeOptimizationEnabled:r,includeSizeVariable:c,forBinning:f,filter:g,view:l,signal:p});return{...a,creatorParameters:h,renderer:b}}async function R(a){let b=a.pieChartScheme,c=null;var d=null;d=await w.getBasemapInfo(a.basemap,a.view);c=null!=d.basemapId?d.basemapId:null;d=null!=d.basemapTheme?d.basemapTheme:null;if(b)return{scheme:K.cloneScheme(b),basemapId:c,basemapTheme:d};if(a=K.getSchemes({numColors:a.attributes.length,
geometryType:a.layer.geometryType,basemapTheme:d}))b=a.primaryScheme,c=a.basemapId,d=a.basemapTheme;return{scheme:b,basemapId:c,basemapTheme:d}}async function S(a,b){const {valueExpression:c,sqlExpression:d,sqlWhere:f}=ca.getSumOfAttributesExpr(a.attributes),g=await J.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");return aa.createVisualVariables({layer:a.layer,basemap:a.basemap,valueExpression:c,sqlExpression:d,sqlWhere:f,sizeScheme:b,sizeOptimizationEnabled:a.sizeOptimizationEnabled,legendOptions:{title:g.sumOfCategories},
view:a.view,signal:a.signal})}function T(a,b,c){b||a.visualVariables.forEach(d=>{"number"===typeof d.minSize&&"number"===typeof d.maxSize&&(d.minSize*=2.5,d.maxSize*=1.8)});b&&"point"===c&&a.visualVariables.forEach(d=>{d?.minSize&&"object"===typeof d.minSize&&d.minSize?.stops?.forEach(f=>{f.size*=1.8})})}function U(a,b){"point"===b&&a.minSize.stops?.forEach(c=>{c.size*=2.5});"polygon"===b&&a.minSize.stops?.forEach(c=>{c.size*=1.8})}async function ja(a){if(!a||!a.layer)throw new n("pie-chart-cluster-renderer:missing-parameters",
"'layer' parameter is required");const b={...a};b.shape=b.shape||"pie";b.defaultSymbolEnabled??(b.defaultSymbolEnabled=!0);a=a.layer;if(!v.getLayerTypes(L).includes(a.type))throw new n("pie-chart-cluster-renderer:invalid-parameters","'layer' must be one of these types: "+v.getLayerTypeLabels(L).join(", "));await a.load(null!=b.signal?{signal:b.signal}:null);if("point"!==a.geometryType)throw new n("pie-chart-cluster-renderer:invalid-parameters","Cluster renderers are only supported for point layers");
({renderer:a}=a);if(!a)throw new n("pie-chart-cluster-renderer:invalid-parameters","input layer does not have a renderer.");if(!ka.has(a.type))throw new n("pie-chart-cluster-renderer:invalid-parameters",`Cannot create a pie chart renderer for clusters based on a ${a.type} renderer.`);if("valueExpression"in a&&a.valueExpression)throw new n("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer whose renderer contains a valueExpression.");if("unique-value"===
a.type){if(a.field2)throw new n("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a UniqueValueRenderer using more than one field.");if(null!=a.uniqueValueInfos&&10<a.uniqueValueInfos.length)throw new n("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer cannot be created from a UniqueValueRenderer with more than 10 unique value infos.");}if("class-breaks"===a.type){if(2>a.classBreakInfos.length)throw new n("pie-chart-cluster-renderer:invalid-parameters",
"Cannot create a pie chart renderer for clusters from a layer renderer with a continuous color or size gradient.");if(10<a.classBreakInfos.length)throw new n("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with more than 10 class break infos.");if("class-breaks-size"===a?.authoringInfo?.type)throw new n("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with breaks varied by size instead of color.");
}return b}function la(a){const {renderer:b,defaultSymbolEnabled:c,defaultLabelBackup:d}=a,{field:f,defaultSymbol:g,defaultLabel:l}=b;a=b.uniqueValueInfos??[];var p=g&&c,h=p?9:10;const r=I.createUniqueColors(V,h);h=(f?a.slice(0,h).map((k,e)=>{const m=k.label;e=r[e];return{field:new B({name:D(k.value?.toString()),alias:m,onStatisticExpression:new C({title:`Field definition - ${m}`,expression:`Number(Text($feature["${f}"]) == "${k.value+""}")`,returnType:"number"}),statisticType:"sum"}),color:E(k.symbol,
e)}}):null)??[];p&&(p=l||d,h.push({field:new B({name:D("cluster_default"),alias:p,onStatisticExpression:new C({title:`Field definition - ${p}`,expression:ma(f,a),returnType:"number"}),statisticType:"sum"}),color:E(g,W)}));return h}function na(a){const {renderer:b,defaultSymbolEnabled:c,defaultLabelBackup:d}=a,{field:f,classBreakInfos:g,defaultSymbol:l,defaultLabel:p}=b;var h=(a=l&&c)?9:10;const r=I.createUniqueColors(V,h);h=g.slice(0,h).map((k,e)=>{const m=k.label||`${k.minValue} - ${k.maxValue}`;
e=r[e];return{field:new B({name:D(m),alias:m,onStatisticExpression:new C({title:`Field definition - ${m}`,expression:`Number($feature["${f}"] >= ${k.minValue} && $feature["${f}"] < ${k.maxValue})`,returnType:"number"}),statisticType:"sum"}),color:E(k.symbol,e)}});a&&(a=p||d,h.push({field:new B({name:D("cluster_default"),alias:a,onStatisticExpression:new C({title:`Field definition - ${a}`,expression:oa(f,g),returnType:"number"}),statisticType:"sum"}),color:E(l,W)}));return h}function D(a){return"SUM_"+
(a+"").replaceAll(/[^a-zA-Z0-9_]/g,"_")}function E(a,b){return"simple-marker"===a?.type&&a.color?a.color.clone():"cim"===a?.type&&(a=fa.getCIMSymbolColor(a))?a.clone():b?b.clone():pa.clone()}function ma(a,b){return`Number(!(${b.map(c=>`(Text($feature["${a}"]) == "${c.value+""}")`).join(" || ")}))`}function oa(a,b){return`Number(!(${b.map(c=>`($feature["${a}"] >= ${c.minValue} && $feature["${a}"] < ${c.maxValue})`).join(" || ")}))`}const L=[v.LayerType.CSVLayer,v.LayerType.FeatureLayer,v.LayerType.GeoJSONLayer,
v.LayerType.OGCFeatureLayer,v.LayerType.OrientedImageryLayer,v.LayerType.StreamLayer,v.LayerType.WFSLayer],ka=new Set(["unique-value","class-breaks"]),pa=new u("#aaaaaa"),W=new u("#5c5c5c"),V=[new u("#e60049"),new u("#0bb4ff"),new u("#50e991"),new u("#e6d800"),new u("#9b19f5"),new u("#ffa300"),new u("#dc0ab4"),new u("#b3d4ff"),new u("#00bfa0"),new u("#f0cccc")];A.createRenderer=async function(a){const [b,c]=await Promise.all([Q(a),J.fetchMessageBundle("esri/smartMapping/t9n/smartMapping")]);a=await R(b);
const d=a?.scheme;if(!d)throw new n("pie-chart-renderer:insufficient-info","Unable to find pie-chart scheme");const {layer:f,includeSizeVariable:g,sizeOptimizationEnabled:l,outlineOptimizationEnabled:p,view:h,signal:r,filter:k}=b;var e=d.sizeScheme,m=b.attributes,x=m.map(q=>q.field).filter(X.isSome);const [y,z,F,G]=await Promise.all([1<x.length?ba({layer:f,fields:x,view:h,signal:r,filter:k}):null,g?S(b,e):null,!g&&l?P({layer:f,view:h,signal:r,filter:k}).catch(w.errorCallback):null,p?O({layer:f,view:h,
signal:r,filter:k}).catch(w.errorCallback):null]);x=y?.predominantCategoryInfos?{uniqueValueInfos:y.predominantCategoryInfos}:{uniqueValueInfos:x.map(q=>({value:q,count:0}))};const qa=I.createUniqueColors(d.colors,m.length);var H=m.map((q,ra)=>new N({field:q.field,valueExpression:q.valueExpression,label:q.label,valueExpressionTitle:q.valueExpressionTitle,color:qa[ra]}));m=f.geometryType;e=null!=e&&"background"in e&&e.background;e=new M({attributes:H,othersCategory:new Z.OthersCategory({label:c.other,
color:b.othersCategoryEnabled?d.colorForOthersCategory:null,threshold:.04}),holePercentage:"donut"===b.shape?.45:0,backgroundFillSymbol:e?w.createSymbol(m,{type:"2d",color:e.color,outline:w.getSymbolOutlineFromScheme(e,m,G?.opacity)}):null,size:Y.toPt(d.size),outline:new ha(w.getSymbolOutlineFromScheme(d,"point",G?.opacity)),legendOptions:b.legendOptions});z&&(T(z,l,m),e.authoringInfo=z.authoringInfo.clone(),e.visualVariables=z.visualVariables?.map(q=>q.clone()));G?.visualVariables?.length&&(H=G.visualVariables.map(q=>
q.clone()).filter(q=>"color"!==q.type&&"rotation"!==q.type),e.visualVariables?e.visualVariables.push(...H):e.visualVariables=H);F?.minSize&&(U(F,m),e.visualVariables?e.visualVariables.push(F.minSize):e.visualVariables=[F.minSize]);return{renderer:e,pieChartScheme:K.cloneScheme(d),size:z,basemapId:a.basemapId,basemapTheme:a.basemapTheme,statistics:x}};A.createRendererForClustering=async function(a){a=await ja(a);const {layer:b,shape:c,defaultSymbolEnabled:d,legendOptions:f}=a;var {renderer:g}=b,l=
(await J.fetchMessageBundle("esri/smartMapping/t9n/smartMapping")).other;a=[];"unique-value"===g?.type&&(a=la({renderer:g,defaultSymbolEnabled:d,defaultLabelBackup:l}));"class-breaks"===g?.type&&(a=na({renderer:g,defaultSymbolEnabled:d,defaultLabelBackup:l}));g=[];l=[];for(var p of a){const {field:h,color:r}=p;g.push(h);l.push(new N({color:r,field:h.name,label:h.alias}))}p=new M({attributes:l,legendOptions:f,holePercentage:"donut"===c?.45:0,outline:null,size:9,othersCategory:null});return{fields:g,
renderer:p}};A.regenerateRenderer=async function(a){const {creatorParameters:b,view:c,signal:d,filter:f,renderer:g}=await ia(a),{layer:l,outlineOptimizationEnabled:p,includeSizeVariable:h,sizeOptimizationEnabled:r}=b;a=(await R(b))?.scheme?.sizeScheme;const [k,e,m]=await Promise.all([p?O({layer:l,view:c,signal:d,filter:f}).catch(w.errorCallback):null,h?S(b,a):null,!h&&r?P({layer:l,view:c,signal:d,filter:f}).catch(w.errorCallback):null]);a=l.geometryType;e&&(T(e,r,a),t.spliceVisualVariables(g,e?.visualVariables,
t.findSizeVVIndex),t.updateAuthoringInfoVisualVariable(g,e?.authoringInfo,"size"));if(k?.visualVariables?.length){const x=k.visualVariables.map(y=>y.clone()).filter(y=>"color"!==y.type&&"rotation"!==y.type);t.spliceVisualVariables(g,x,t.findOutlineVVIndex)}m?.minSize&&(U(m,a),t.spliceVisualVariables(g,m?.minSize,t.findScaleDependentSizeVVIndex));return{renderer:g}};Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});