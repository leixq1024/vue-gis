// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["../../core/Error","../../geometry/support/scaleUtils","../statistics/spatialStatistics","../support/binningUtils","../support/adapters/support/layerUtils"],function(l,p,r,t,m){async function u(a){const {view:b,sampleSize:f}=a;if(!a||!a.layer)throw new l("scale-range:missing-parameters","'layer' parameter is required");if(a.snapToLOD&&!b)throw new l("scale-range:missing-parameters","'view' parameter is required when 'snapToLOD' is true");a.forBinning&&t.verifyBinningParams(a,"scale-range");
const {layer:g,...h}=a;var e=a.forBinning?m.binningCapableLayerTypes:m.featureCapableLayerTypes;a=m.createLayerAdapter(g,e,a.forBinning);if(!a)throw new l("scale-range:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(e).join(", "));e={layerAdapter:a,...h};e.sampleSize=f||500;await b?.when();await a.load(null!=e.signal?{signal:e.signal}:null);return e}function q(a,b,f=!0){if(a.constraints&&"effectiveLODs"in a.constraints){a=a.constraints.effectiveLODs;a=f?a:a.slice().reverse();
let g=null;for(const h of a)if(!(f?h.scale>b:h.scale<b)){g=h;break}return g}}return async function(a){var b,f=await u(a);const {view:g,sampleSize:h,layerAdapter:e,signal:v,filter:w}=f;a=await e.getSampleFeatures({view:g,sampleSize:h,returnGeometry:!0,filter:w,signal:v},"json");if(!a?.length)throw new l("scale-range:insufficient-info","No features are available to calculate statistics");a=await r({features:a,geometryType:e.geometryType});var c=0,d=0,k=b=0;switch(e.geometryType){case "point":case "multipoint":c=
a.avgMinDistance??0;d=12;b=a.minDistance??0;k=320;break;case "polyline":c=a.avgLength??0;d=30;b=a.minLength??0;k=320;break;case "polygon":c=a.avgSize??0,d=15,b=a.minSize??0,k=640}b=0<b?b/k:null;k=g?.spatialReference||e.layer.spatialReference;c=p.getScaleForResolution((0<c?c/d:null)??0,k);d=p.getScaleForResolution(b??0,k);const {minScale:x,maxScale:y}={minScale:c,maxScale:d};c=x;d=y;const {view:n,snapToLOD:z,layerAdapter:A}=f;z&&n&&(f=q(n,c),b=q(n,d,!1),c=f?f.scale:c,d=b?b.scale:d);if(c<d)throw new l("scale-range:invalid",
"calculated minScale is less than maxScale.");d>c/2&&(d=Math.floor(d/2));1E8<c&&(c=0);"polygon"!==A.geometryType&&(d=0);return{minScale:Math.ceil(c),maxScale:Math.floor(d),spatialStatistics:a}}});