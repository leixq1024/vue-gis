// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/mathUtils ../../../core/unitUtils ../../../core/libs/gl-matrix-2/math/mat3 ../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../core/libs/gl-matrix-2/math/mat4 ../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../spatialReferenceEllipsoidUtils ../../projection/computeTranslationToOriginAndRotation ../../projection/projectPointToVector ../meshVertexSpaceUtils ../spatialReferenceUtils ../../../chunks/vec3 ./projection".split(" "),
function(z,M,u,I,N,O,q,v,A,P,C,w,J,K,Q,r,h){function R({vertexAttributes:a,transform:b,spatialReference:c},{origin:d},f,e){const g=B(c,e,t.SOURCE_AND_TARGET);(b=d||!u.floatEqualUlp(g,1)?q.copy(m,b?.localMatrix??v.IDENTITY):null)&&D(b,c,e,t.SOURCE_AND_TARGET);const {position:n,normal:k,tangent:l}=b?E(a,b):a;e=(c=e?.allowBufferReuse)?n:new Float64Array(n.length);b=n;d&&(b=r.translate(e,b,d));f&&(d=A.negate(L,f),b=r.translate(e,b,d));return{position:b!==a.position||c?b:b.slice(),normal:k!==a.normal||
c?k:k?.slice(),tangent:l!==a.tangent||c?l:l?.slice()}}function F(a,b){return b?.useEllipsoid&&Q.isEarth(a)?C.WGS84ECEFSpatialReference:C.getSphericalPCPF(a)}function S({spatialReference:a,vertexAttributes:b,transform:c},{origin:d},f,e){const g=F(a,e);if(!w.computeTranslationToOriginAndRotation(a,d,m,g))return h.logProjectionError(p(),a,g),null;c&&q.multiply(m,m,c.localMatrix);D(m,a,e,t.SOURCE);c=new Float64Array(b.position.length);d=b.position;r.transformMat4(c,d,m);d=new Float64Array(d.length);h.projectFromPCPF(c,
g,d,a)||(h.logProjectionError(p(),g,a),d=null);if(!d)return null;e=b.normal;var n=m;if(null==e)e=null;else{var k=new Float32Array(e.length);h.transformNormal(e,k,n);h.projectNormalFromPCPF(k,d,a,c,g,k)?e=k:(h.logProjectionError(p(),g,a),e=null)}if(b.normal&&!e)return null;n=b.tangent;k=m;if(null==n)a=null;else{var l=new Float32Array(n.length);h.transformTangent(n,l,k);h.projectTangentFromPCPF(l,d,a,c,g,l)?a=l:(h.logProjectionError(p(),g,a),a=null)}if(b.tangent&&!a)return null;f&&(b=A.negate(L,f),
r.translate(d,d,b));return{position:d,normal:e,tangent:a}}function T({vertexAttributes:a,spatialReference:b,transform:c},{origin:d},f,e){const g=F(b,e);if(!w.computeTranslationToOriginAndRotation(b,f,m,g))return h.logProjectionError(p(),b,g),null;f=1/B(b,e,t.TARGET);q.scale(m,m,[f,f,f]);f=q.invert(x,m);if(d)if(c)c=E(a,c.localMatrix),r.translate(c.position,c.position,d),d=c;else{const {position:y,normal:U,tangent:V}=a;d={position:r.translate(new Float64Array(y.length),y,d),tangent:V,normal:U}}else d=
a;const {position:n,normal:k,tangent:l}=d;d=new Float64Array(n.length);(e=h.projectToPCPF(n,b,d,g))?(c=new Float64Array(e.length),r.transformMat4(c,e,f)):(h.logProjectionError(p(),b,g),c=null);if(!c)return null;f=N.normalFromMat4(W,f);null==k?e=null:(e=(k!==a.normal?k:void 0)??new Float32Array(k.length),h.projectNormalToPCPF(k,n,b,d,g,e)?r.transformMat3(e,e,f):(h.logProjectionError(p(),b,g),e=null));if(!e&&k)return null;null==l?b=null:(a=(l!==a.tangent?l:void 0)??new Float32Array(l.length),h.projectTangentToPCPF(l,
n,b,d,g,a)?(r.transformMat3(a,a,f,4),b=a):(h.logProjectionError(p(),b,g),b=null));return!b&&l?null:{position:c,normal:e,tangent:b}}function X({vertexAttributes:a,spatialReference:b,transform:c},{origin:d},f,e){const g=F(b,e);if(!w.computeTranslationToOriginAndRotation(b,d,m,g))return h.logProjectionError(p(),b,g),null;c&&q.multiply(m,m,c.localMatrix);if(!w.computeTranslationToOriginAndRotation(b,f,x,g))return h.logProjectionError(p(),g,b),null;q.invert(x,x);c=q.multiply(m,x,m);D(c,b,e,t.SOURCE_AND_TARGET);
return E(a,c)}function E(a,b){const c=new Float64Array(a.position.length);r.transformMat4(c,a.position,b);const d=a.normal?new Float32Array(a.normal.length):null,f=a.tangent?new Float32Array(a.tangent.length):null;d&&a.normal&&h.transformNormal(a.normal,d,b);f&&a.tangent&&h.transformTangent(a.tangent,f,b);return{position:c,normal:d,tangent:f}}function D(a,b,c,d){b=B(b,c,d);u.floatEqualUlp(b,1)||q.scale(a,a,[b,b,b])}function B(a,b,c){const d=!!(c&t.SOURCE);c=!!(c&t.TARGET);const f=b?.sourceUnit;b=
b?.targetUnit;if(!f&&!b)return 1;let e=G(f,a);d||!f||u.floatEqualUlp(e,1)||(p().warn("source unit conversion not supported"),e=1);a=1/G(b,a);c||!b||u.floatEqualUlp(a,1)||(p().warn("target unit conversion not supported"),a=1);return e*a}function G(a,b){if(null==a)return 1;b=I.getMetersPerCartesianUnitForSR(b);return 1/I.convertUnit(b,"meters",a)}const p=()=>M.getLogger("esri.geometry.support.meshUtils.vertexSpaceConversion"),m=v.create(),x=v.create(),W=O.create(),L=P.create(),H=v.create();var t;(function(a){a[a.NONE=
0]="NONE";a[a.SOURCE=1]="SOURCE";a[a.TARGET=2]="TARGET";a[a.SOURCE_AND_TARGET=3]="SOURCE_AND_TARGET"})(t||={});z.convertVertexSpace=function(a,b,c){const {vertexSpace:d,transform:f,vertexAttributes:e}=a,g=K.isRelativeVertexSpace(d)?f:null,n=B(a.spatialReference,c,t.SOURCE_AND_TARGET);if(K.vertexSpaceEquals(d,b)&&(!g||q.exactEquals(g.localMatrix,v.IDENTITY))&&u.floatEqualUlp(n,1)){const {position:k,normal:l,tangent:y}=e;a=c?.allowBufferReuse;return{position:a?k:k.slice(),normal:a?l:l?.slice(),tangent:a?
y:y?.slice()}}switch(a.vertexSpace.type){case "local":return"local"===b.type?X(a,a.vertexSpace,b.origin,c):S(a,a.vertexSpace,b.origin,c);case "georeferenced":return"local"===b.type?T(a,a.vertexSpace,b.origin,c):R(a,a.vertexSpace,b.origin,c)}};z.getUnitToSpatialReferenceScaleConversion=G;z.projectPointToVertexSpace=function(a,b,{vertexSpace:c,spatialReference:d}){if("georeferenced"===c.type){if(!J.projectPointToVector(b,a,d))return!1;({origin:d}=c);A.subtract(a,a,d);return!0}const f=C.getSphericalPCPF(d);
if(!J.projectPointToVector(b,a,f))return!1;({origin:b}=c);if(!w.computeTranslationToOriginAndRotation(d,b,H,f))return!1;d=q.invert(H,H);if(null==d)return!1;A.transformMat4(a,a,d);return!0};Object.defineProperty(z,Symbol.toStringTag,{value:"Module"})});