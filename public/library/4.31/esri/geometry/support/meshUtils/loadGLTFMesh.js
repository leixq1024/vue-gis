// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../Color ../../../request ../../../core/Error ../../../core/MapUtils ../../../core/mathUtils ../../../core/libs/gl-matrix-2/math/mat3 ../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../core/libs/gl-matrix-2/factories/vec4f64 ../MeshComponent ../MeshMaterialMetallicRoughness ../MeshTexture ../MeshTextureTransform ../MeshVertexAttributes ../meshVertexSpaceUtils ../buffer/BufferView ../../../chunks/vec3 ../../../chunks/vec4 ../buffer/utils ./vertexSpaceConversion ../../../views/3d/glTF/DefaultLoadingContext ../../../views/3d/glTF/loader ../../../views/3d/glTF/internal/indexUtils ../../../views/3d/glTF/internal/resourceUtils ../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../../views/webgl/enums ../../../chunks/vec33 ../../../chunks/vec43 ../../../chunks/vec2".split(" "),
function(F,G,O,P,H,C,I,J,Q,R,S,T,U,V,W,K,l,x,A,y,X,Y,Z,aa,ba,ca,D,L,B,M){function da(a){const c=a?.resolveFile;return c?{busy:!1,request:async(g,b,f)=>{g=c?.(g)??g;return(await O(g,{responseType:"image"===b?"image":"binary"===b||"image+type"===b?"array-buffer":"json",signal:f?.signal,timeout:0})).data}}:null}function z(a,c){if(null==a)return"-";a=a.typedBuffer;return`${H.getOrCreateMapValue(c,a.buffer,()=>c.size)}/${a.byteOffset}/${a.byteLength}`}function ea(a){return null!=a?a.toString():"-"}function fa(a){let c=
0;var g=!1,b=!1,f=!1,d=!1;const e=new Map,u=new Map,r=[];for(const m of a.parts){const {attributes:{position:k,normal:v,color:h,tangent:p,texCoord0:t}}=m;a=`\n      ${z(k,e)}/\n      ${z(v,e)}/\n      ${z(h,e)}/\n      ${z(p,e)}/\n      ${z(t,e)}/\n      ${ea(m.transform)}\n    `;let n=!1;a=H.getOrCreateMapValue(u,a,()=>{n=!0;return{start:c,length:k.count}});n&&(c+=k.count);v&&(f=!0);h&&(g=!0);p&&(b=!0);t&&(d=!0);r.push({gltf:m,writeVertices:n,region:a})}return{vertexAttributes:{position:y.createBuffer(l.BufferViewVec3f64,
c),normal:f?y.createBuffer(l.BufferViewVec3f,c):null,tangent:b?y.createBuffer(l.BufferViewVec4f,c):null,color:g?y.createBuffer(l.BufferViewVec4u8,c):null,texCoord0:d?y.createBuffer(l.BufferViewVec2f,c):null},parts:r,components:[]}}function ha(a,c){const g=new G(ia(a.color,a.opacity)),b=a.emissiveFactor?new G(ja(a.emissiveFactor)):null,f=k=>k?new V({scale:k.scale?[k.scale[0],k.scale[1]]:[1,1],rotation:C.rad2deg(k.rotation??0),offset:k.offset?[k.offset[0],k.offset[1]]:[0,0]}):null;var d=c.get(a.textureColor),
e=c.get(a.textureNormal),u=c.get(a.textureEmissive),r=c.get(a.textureOcclusion);a:{switch(a.alphaMode){case "OPAQUE":var m="opaque";break a;case "MASK":m="mask";break a;case "BLEND":m="blend";break a}m=void 0}return new T({color:g,colorTexture:d,normalTexture:e,emissiveColor:b,emissiveTexture:u,occlusionTexture:r,alphaMode:m,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,metallic:a.metallicFactor,roughness:a.roughnessFactor,metallicRoughnessTexture:c.get(a.textureMetallicRoughness),colorTextureTransform:f(a.colorTextureTransform),
normalTextureTransform:f(a.normalTextureTransform),occlusionTextureTransform:f(a.occlusionTextureTransform),emissiveTextureTransform:f(a.emissiveTextureTransform),metallicRoughnessTextureTransform:f(a.metallicRoughnessTextureTransform)})}function ka(a,c,g){if(c.writeVertices){const {position:v,normal:h,tangent:p,color:t,texCoord0:n}=a.vertexAttributes;var b=c.region.start;const {attributes:q,transform:E}=c.gltf;var f=q.position.count;x.transformMat4View(v.slice(b,f),q.position,E);if(null!=q.normal&&
null!=h){var d=I.normalFromMat4(J.create(),E),e=h.slice(b,f);x.transformMat3View(e,q.normal,d);C.hasScaling(d)&&x.normalizeView(e,e)}else null!=h&&L.fill(h,0,0,1,{dstIndex:b,count:f});null!=q.tangent&&null!=p?(d=I.fromMat4(J.create(),E),e=p.slice(b,f),A.transformMat3View(e,q.tangent,d),C.hasScaling(d)&&A.normalize(e,e)):null!=p&&B.fill(p,0,0,1,1,{dstIndex:b,count:f});null!=q.texCoord0&&null!=n?M.normalizeIntegerBufferView(n.slice(b,f),q.texCoord0):null!=n&&M.fill(n,0,0,{dstIndex:b,count:f});null!=
q.color&&null!=t?(d=q.color,b=t.slice(b,f),4===d.elementCount?d instanceof l.BufferViewVec4f?A.scaleView(b,d,255):d instanceof l.BufferViewVec4u8?B.copyView(b,d):d instanceof l.BufferViewVec4u16&&A.scaleView(b,d,1/256):(B.fill(b,255,255,255,255),b=l.BufferViewVec3u8.fromTypedArray(b.typedBuffer,b.typedBufferStride),d instanceof l.BufferViewVec3f?x.scaleView(b,d,255):d instanceof l.BufferViewVec3u8?L.copyView(b,d):d instanceof l.BufferViewVec3u16&&x.scaleView(b,d,1/256))):null!=t&&B.fill(t.slice(b,
f),255,255,255,255)}const {indices:u,attributes:r,primitiveType:m,material:k}=c.gltf;b=aa.convertPrimitiveToTriangles(u||r.position.count,m);if(f=c.region.start){d=new Uint32Array(b);for(e=0;e<b.length;e++)d[e]+=f;b=d}a.components.push(new S({name:c.gltf.name,faces:b,material:g.get(k),shading:r.normal?"source":"flat",trustSourceNormals:!0}))}function N(a){switch(a){case D.TextureWrapMode.CLAMP_TO_EDGE:return"clamp";case D.TextureWrapMode.MIRRORED_REPEAT:return"mirror";case D.TextureWrapMode.REPEAT:return"repeat"}}
function w(a){return 255*a**(1/ca.colorGamma)}function ia(a,c){return R.fromValues(w(a[0]),w(a[1]),w(a[2]),c)}function ja(a){return Q.fromValues(w(a[0]),w(a[1]),w(a[2]))}F.loadGLTFMesh=async function(a,c,g){var b=new Y.DefaultLoadingContext(da(g));c=(await Z.loadGLTF(b,c,g,!0)).model;b=c.lods.shift();const f=new Map,d=new Map;c.textures.forEach((h,p)=>{var t=f.set;var n=(ba.isEncodedMeshTexture(h.data),h.data);h=h.parameters.wrap;h={horizontal:N(h.s),vertical:N(h.t)};n=new U({data:n,wrap:h});return t.call(f,
p,n)});c.materials.forEach((h,p)=>d.set(p,ha(h,f)));c=fa(b);for(var e of c.parts)ka(c,e,d);const {position:u,normal:r,tangent:m,color:k,texCoord0:v}=c.vertexAttributes;e=K.selectVertexSpace(a,g);b=a.spatialReference.isGeographic?K.selectVertexSpace(a):e;g=X.convertVertexSpace({vertexAttributes:{position:u.typedBuffer,normal:r?.typedBuffer,tangent:m?.typedBuffer},vertexSpace:b,spatialReference:a.spatialReference},e,{allowBufferReuse:!0,sourceUnit:g?.unitConversionDisabled?void 0:"meters"});if(!g)throw new P("load-gltf-mesh:vertex-space-projection",
`Failed to load mesh from glTF because we could not convert the vertex space from ${b.type} to ${e.type}`);return{transform:null,vertexSpace:e,components:c.components,spatialReference:a.spatialReference,vertexAttributes:new W.MeshVertexAttributes({...g,color:k?.typedBuffer,uv:v?.typedBuffer})}};Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});