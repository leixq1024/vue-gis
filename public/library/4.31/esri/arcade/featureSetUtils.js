// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../request ./featureSetCollection ../chunks/languageUtils ./featureset/actions/AttributeFilter ./featureset/actions/GroupBy ./featureset/actions/OrderBy ./featureset/actions/SpatialFilter ./featureset/actions/Top ./featureset/sources/FeatureLayerDynamic ./featureset/sources/FeatureLayerMemory ./featureset/sources/FeatureLayerRelated ./featureset/support/cache ./featureset/support/errorsupport ./featureset/support/shared ../core/Loadable ../core/sql/WhereClause ../layers/FeatureLayer ../layers/Layer ../portal/PortalItem".split(" "),
function(n,v,z,A,I,J,K,L,M,N,B,O,h,C,t,D,E,p,w,P){async function u(a,d,b){if(h.applicationCache){if(b=h.applicationCache.getLayerInfo(a))return b=await b,new p({url:a,outFields:d,sourceJSON:b});const c=new p({url:a,outFields:d});d=(async()=>{await c.load();return c.sourceJSON})();if(h.applicationCache){h.applicationCache.setLayerInfo(a,d);try{return await d,c}catch(e){throw h.applicationCache.clearLayerInfo(a),e;}}await d;return c}if(null!=b){const c=b.getCachedLayerMetadata(a);if(c)return b=await c,
new p({url:a,outFields:d,sourceJSON:b});const e=new p({url:a,outFields:d});d=(async()=>{await e.load();return e.sourceJSON})();b.setCachedLayerMetadata(a,d);try{return await d,e}catch(f){throw b.removeCachedLayerMetadata(a,d),f;}}return new p({url:a,outFields:d})}async function x(a,d,b,c,e,f=null){a=await u(a,["*"],e);return m(a,d,b,c,e,f)}function m(a,d=null,b=null,c=!0,e=null,f=null){switch(a.type){case "catalog-footprint":return m(a.parent,d,b,c,e,f);case "subtype-sublayer":return d=m(a.parent,
d,b,c,e,f),d.filter(E.WhereClause.create(a.parent.subtypeField+"\x3d"+a.subtypeCode.toString(),{fieldsIndex:a.parent.fieldsIndex,timeZone:d.dateFieldsTimeZoneDefaultUTC}));case "csv":case "geojson":case "wfs":return new B({layer:a,spatialReference:d,outFields:b,includeGeometry:c,lrucache:e,interceptor:f});case "catalog":case "feature":case "oriented-imagery":case "subtype-group":return d={layer:a,spatialReference:d,outFields:b,includeGeometry:c,lrucache:e,interceptor:f},!a.url&&a.source?new B(d):
new N(d);default:throw Error(`Unsupported layer type: ${a.type}`);}}async function Q(a){if(null!==h.applicationCache){var d=h.applicationCache.getLayerInfo(a);if(null!==d)return d}d=(async()=>{const b=await v(a,{responseType:"json",query:{f:"json"}});return b.data?b.data:null})();if(null!==h.applicationCache){h.applicationCache.setLayerInfo(a,d);try{return await d}catch(b){throw h.applicationCache.clearLayerInfo(a),b;}}return d}async function R(a,d){const b="QUERYDATAELEMTS:"+d.toString()+":"+a;if(null!==
h.applicationCache){var c=h.applicationCache.getLayerInfo(b);if(null!==c)return c}c=(async()=>{var e=await v(a+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([d.toString()]),f:"json"}});if(e.data&&(e=e.data,e.layerDataElements?.[0]))return e.layerDataElements[0];throw new C.FeatureSetError(C.FeatureSetErrorCodes.DataElementsNotFound);})();if(null!==h.applicationCache){h.applicationCache.setLayerInfo(b,c);try{return await c}catch(e){throw h.applicationCache.clearLayerInfo(b),
e;}}return c}async function F(a,d){if(null!==h.applicationCache){var b=h.applicationCache.getLayerInfo(a);if(null!==b)return b}if(null!=d&&(b=d.getCachedServiceMetadata(a),null!=b))return b;b=(async()=>{var c=await v(a,{responseType:"json",query:{f:"json"}});return c.data?(c=c.data,c.layers||(c.layers=[]),c.tables||(c.tables=[]),c):{layers:[],tables:[]}})();if(null!==h.applicationCache){h.applicationCache.setLayerInfo(a,b);try{return await b}catch(c){throw h.applicationCache.clearLayerInfo(a),c;}}if(null!=
d){d.setCachedServiceMetadata(a,b);try{return await b}catch(c){throw d.removeCachedServiceMetadata(a,b),c;}}return b}async function y(a,d,b,c,e,f,k){let l;if("Feature Service"===a.type||"Map Service"===a.type)l=await u(t.extractServiceUrl(a.url??"")+"/"+d,["*"],f);else{if(d)throw Error(`layerId=${d} provided for ${a.type} item`);if(null!=f)if(d=f.getCachedPortalItemLayer(a.portal.url,a.id),null!=d)l=await d;else{d=w.fromPortalItem(a);f.setCachedPortalItemLayer(a.portal.url,a.id,d);try{l=await d}catch(g){throw f.removeCachedPortalItemLayer(a.portal.url,
a.id,d),g;}}else l=await w.fromPortalItem(a)}return m(l,b,c,e,f,k)}I.registerAction();J.registerAction();K.registerAction();L.registerAction();M.registerAction();class S extends z{constructor(a,d=null,b=null,c=null){super();this._map=a;this._overrideSpatialReference=d;this._lrucache=b;this._interceptor=c;this._instantLayers=[]}_makeAndAddFeatureSet(a,d=!0,b=null){const c=m(a,this._overrideSpatialReference,null===b?["*"]:b,d,this._lrucache,this._interceptor);this._instantLayers.push({featureset:c,
opitem:a,includeGeometry:d,outFields:JSON.stringify(b)});return c}async featureSetByName(a,d=!0,b=null){if(D.isLoadable(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetByName(a,d,b);null===b&&(b=["*"]);b=b.slice();b=b.sort();var c=JSON.stringify(b);for(let e=0;e<this._instantLayers.length;e++){const f=this._instantLayers[e];if(f.opitem.title===a&&f.includeGeometry===d&&f.outFields===c)return this._instantLayers[e].featureset}c=this._map.allLayers.find(e=>t.isSupportedLayer(e)&&
e.title===a);if(null!=c)return this._makeAndAddFeatureSet(c,d,b);if(this._map.tables&&(c=this._map.tables.find(e=>e.title===a),null!=c)){if(c instanceof p)return this._makeAndAddFeatureSet(c,d,b);null==c._materializedTable&&(c._materializedTable=new p(c.outFields?c:{...c,outFields:["*"]}));await c._materializedTable.load();return this._makeAndAddFeatureSet(c._materializedTable,d,b)}return null}async featureSetById(a,d=!0,b=["*"]){if(D.isLoadable(this._map)&&!this._map.loaded)return await this._map.load(),
this.featureSetById(a,d,b);null===b&&(b=["*"]);b=b.slice();b=b.sort();var c=JSON.stringify(b);for(let e=0;e<this._instantLayers.length;e++){const f=this._instantLayers[e];if(f.opitem.id===a&&f.includeGeometry===d&&f.outFields===c)return this._instantLayers[e].featureset}if(c=this._map.allLayers.find(e=>t.isSupportedLayer(e)&&e.id===a))return this._makeAndAddFeatureSet(c,d,b);if(this._map.tables&&(c=this._map.tables.find(e=>e.id===a),null!=c)){if(c instanceof p)return this._makeAndAddFeatureSet(c,
d,b);null==c._materializedTable&&(c._materializedTable=new p({...c,outFields:["*"]}));await c._materializedTable.load();return this._makeAndAddFeatureSet(c._materializedTable,d,b)}return null}}class G extends z{constructor(a,d=null,b=null,c=null){super();this._url=a;this._overrideSpatialReference=d;this._lrucache=b;this._interceptor=c;this.metadata=null;this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(a,d=!0,b=null){const c=m(a,this._overrideSpatialReference,null===b?["*"]:
b,d,this._lrucache);this._instantLayers.push({featureset:c,opitem:a,includeGeometry:d,outFields:JSON.stringify(b)});return c}async _loadMetaData(){const a=await F(this._url,this._lrucache);return this.metadata=a}load(){return this._loadMetaData()}clone(){return new G(this._url,this._overrideSpatialReference,this._lrucache,this._interceptor)}async featureSetByName(a,d=!0,b=null){null===b&&(b=["*"]);b=b.slice();b=b.sort();var c=JSON.stringify(b);for(var e=0;e<this._instantLayers.length;e++){const f=
this._instantLayers[e];if(f.opitem.title===a&&f.includeGeometry===d&&f.outFields===c)return this._instantLayers[e].featureset}c=await this._loadMetaData();e=null;for(const f of c.layers??[])f.name===a&&(e=f);if(!e)for(const f of c.tables??[])f.name===a&&(e=f);return e?(a=await u(this._url+"/"+e.id,["*"],this._lrucache),this._makeAndAddFeatureSet(a,d,b)):null}async featureSetById(a,d=!0,b=["*"]){null===b&&(b=["*"]);b=b.slice();b=b.sort();var c=JSON.stringify(b);a=null!==a&&void 0!==a?a.toString():
"";for(var e=0;e<this._instantLayers.length;e++){const f=this._instantLayers[e];if(f.opitem.id===a&&f.includeGeometry===d&&f.outFields===c)return this._instantLayers[e].featureset}c=await this._loadMetaData();e=null;for(const f of c.layers??[])null!==f.id&&void 0!==f.id&&f.id.toString()===a&&(e=f);if(!e)for(const f of c.tables??[])null!==f.id&&void 0!==f.id&&f.id.toString()===a&&(e=f);return e?(a=await u(this._url+"/"+e.id,["*"],this._lrucache),this._makeAndAddFeatureSet(a,d,b)):null}}n.constructAssociationMetaDataFeatureSetFromUrl=
async function(a,d){var b=3,c=[],e=null,f={},k=null;k=await F(a,null);if(void 0!==k.controllerDatasetLayers?.utilityNetworkLayerId&&null!==k.controllerDatasetLayers.utilityNetworkLayerId){if(k.layers)for(var l of k.layers)f[l.id]=l.name;if(k.tables)for(var g of k.tables)f[g.id]=g.name;l=k.controllerDatasetLayers.utilityNetworkLayerId;if(k=await R(a,l)){e=k;e?.dataElement&&void 0!==e.dataElement.schemaGeneration&&(b=e.dataElement.schemaGeneration);k={};e.dataElement.domainNetworks||(e.dataElement.domainNetworks=
[]);for(var r of e.dataElement.domainNetworks){for(const q of r.edgeSources??[])g={layerId:q.layerId,sourceId:q.sourceId,className:f[q.layerId]??null},g.className&&(k[g.className]=g);for(const q of r.junctionSources??[])g={layerId:q.layerId,sourceId:q.sourceId,className:f[q.layerId]??null},g.className&&(k[g.className]=g)}if(e.dataElement.terminalConfigurations)for(const q of e.dataElement.terminalConfigurations)for(const H of q.terminals)c.push({terminalId:H.terminalId,terminalName:H.terminalName});
f=await Q(a+"/"+l);if(void 0!==f.systemLayers?.associationsTableId&&null!==f.systemLayers.associationsTableId)return r=[],4<=b&&(r.push("STATUS"),r.push("PERCENTALONG")),a=await x(a+"/"+f.systemLayers.associationsTableId.toString(),d,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...r],!1,null,null),await a.load(),4<=b&&(a=a.filter(E.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62, 63)",
{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),await a.load()),{lkp:k,associations:a,unVersion:b,terminals:c}}}return{associations:null,unVersion:b,lkp:null,terminals:[]}};n.constructFeatureSet=m;n.constructFeatureSetFromPortalItem=async function(a,d,b,c,e,f,k,l=null){if(h.applicationCache){var g=h.applicationCache.getLayerInfo(a+":"+f.url);if(g)return y(await g,d,b,c,e,k,l)}if(null!=k&&(g=k.getCachedPortalItem(f.url,a),null!=g))return await y(await g,d,b,c,e,k,l);g=(new P({id:a,
portal:f})).load();h.applicationCache?h.applicationCache.setLayerInfo(a+":"+f.url,g):null!=k&&k.setCachedPortalItem(f.url,a,g);try{return await y(await g,d,b,c,e,k,l)}catch(r){throw h.applicationCache&&h.applicationCache.clearLayerInfo(a+":"+f.url),null!=k&&k.removeCachedPortalItem(f.url,a,g),r;}};n.constructFeatureSetFromRelationship=async function(a,d,b,c=null,e=null,f=!0,k=null,l=null){var g=a.serviceUrl();if(!g)return null;g="/"===g.charAt(g.length-1)?g+d.relatedTableId.toString():g+"/"+d.relatedTableId.toString();
g=await x(g,c,e,f,k,l);return new O({layer:a,relatedLayer:g,relationship:d,objectId:b,spatialReference:c,outFields:e,includeGeometry:f,lrucache:k,interceptor:l})};n.constructFeatureSetFromUrl=x;n.convertToFeatureSet=function(a,d,b,c,e){if(null===a)return null;if(A.isFeatureSet(a)){switch(d){case "datasource":return a.getDataSourceFeatureSet();case "parent":return a;case "root":return a.getRootFeatureSet()}return null}if(a instanceof w&&t.isSupportedSourceLayer(a)){switch(d){case "datasource":return m(a,
e,a.outFields,!0,b,c).getDataSourceFeatureSet();case "parent":return m(a,e,a.outFields,!0,b,c);case "root":return m(a,e,a.outFields,!0,b,c)}return null}if(A.isSubtypeSublayer(a))switch(d){case "datasource":return m(a.parent,e,a.parent.outFields,!0,b,c).getDataSourceFeatureSet();case "parent":return m(a,e,a.parent.outFields,!0,b,c);case "root":return m(a,e,a.parent.outFields,!0,b,c)}return null};n.createFeatureSetCollectionFromMap=function(a,d,b=null,c=null){return new S(a,d,b,c)};n.createFeatureSetCollectionFromService=
function(a,d,b=null,c=null){return new G(a,d,b,c)};n.initialiseMetaDataCache=function(){null===h.applicationCache&&(h.applicationCache=new h)};Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});