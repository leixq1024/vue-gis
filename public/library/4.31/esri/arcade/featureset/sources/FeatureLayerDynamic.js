// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../Graphic ../../../kernel ../../../request ../../Attachment ../../Dictionary ../support/errorsupport ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../support/stats ../../../core/MD5 ../../../core/sql ../../../geometry/support/jsonUtils ../../../geometry/support/spatialReferenceUtils ../../../layers/FeatureLayer ../../../rest/support/AttachmentQuery ../../../rest/support/Query ../../../rest/support/StatisticDefinition".split(" "),function(z,A,x,D,E,q,F,
w,t,r,G,B,u,H,I,J,K,L,C){class y extends F{constructor(a){super(a);this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic";this._removeGeometry=!1;this.formulaCredential=this._overrideFields=null;this._requestStandardised=this._pageJustIds=!1;this._useDefinitionExpression=!0;a.spatialReference&&(this.spatialReference=a.spatialReference);this._transparent=!0;this._maxProcessing=1E3;this._layer=a.layer;this._wset=null;void 0!==a.outFields&&(this._overrideFields=a.outFields);void 0!==
a.includeGeometry&&(this._removeGeometry=!1===a.includeGeometry)}_maxQueryRate(){return t.defaultMaxRecords}end(){return this._layer}optimisePagingFeatureQueries(a){this._pageJustIds=a}get urlQueryPath(){return this._layer.parsedUrl.path||""}convertQueryToLruCacheKey(a){a=this.urlQueryPath+","+t.stableStringify(a.toJSON());return B.createMD5Hash(a,B.outputTypes.String)}async loadImpl(){if(!0===this._layer.loaded)return this._initialiseFeatureSet(),this;await this._layer.load();this._initialiseFeatureSet();
return this}_initialiseFeatureSet(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType??"";this.fields=this._layer.fields.slice();this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ;this.hasM=!0===this._layer?.capabilities?.data?.supportsM;if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var a=[];const b=[];for(const d of this.fields)if("oid"===
d.type)a.push(d),b.push(d.name);else for(const c of this._overrideFields)if(c.toLowerCase()===d.name.toLowerCase()){a.push(d);b.push(d.name);break}this.fields=a;this._overrideFields=b}this._layer.source&&this._layer.source.sourceJSON&&(a=this._layer.source.sourceJSON.currentVersion,!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=t.FeatureServiceDatabaseType.StandardisedNoInterval,void 0!==a&&null!==a&&10.61<=a&&(this._databaseType=t.FeatureServiceDatabaseType.Standardised)):
void 0!==a&&null!==a&&(10.5<=a&&(this._databaseType=t.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),10.61<=a&&(this._databaseType=t.FeatureServiceDatabaseType.Standardised)));this.objectIdField=this._layer.objectIdField;for(const b of this.fields)"global-id"===b.type&&(this.globalIdField=b.name);this.subtypeField=this._layer.subtypeField??"";this.subtypes=this._layer.subtypes;this.typeIdField=("typeIdField"in this._layer?this._layer.typeIdField:null)??"";this.types=
"types"in this._layer?this._layer.types:null}_isInFeatureSet(){return t.IdState.InFeatureSet}async _refineSetBlock(a){return a}_candidateIdTransform(a){return a}async _getSet(a){return null===this._wset?(await this._ensureLoaded(),this._wset=a=await this._getFilteredSet("",null,null,null,a)):this._wset}async _runDatabaseProbe(a){await this._ensureLoaded();const b=new L;this.datesInUnknownTimezone&&(b.timeReferenceUnknownClient=!0);b.where=a.replace("OBJECTID",this._layer.objectIdField);try{return await this._layer.queryObjectIds(b),
!0}catch(d){return!1}}_canUsePagination(){return this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsPagination?!0:!1}_cacheableFeatureSetSourceKey(){return this._layer.url}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion||"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,
databaseType:this._databaseType,requestStandardised:this._requestStandardised}}_createQuery(){const a=this._layer.createQuery();a.returnZ=this.hasZ;a.returnM=this.hasM;this.datesInUnknownTimezone&&(a.timeReferenceUnknownClient=!0);this._requestStandardised&&(a.sqlFormat="standard");this._useDefinitionExpression?"subtype-group"===this._layer.type&&(a.where=this._layer.definitionExpression):a.where=null;return a}executeQuery(a,b){const d="execute"===b?this._layer.queryFeatures.bind(this._layer):"executeForCount"===
b?this._layer.queryFeatureCount.bind(this._layer):this._layer.queryObjectIds.bind(this._layer);let c=null;if(this.recentlyUsedQueries){const e=this.convertQueryToLruCacheKey(a);c=this.recentlyUsedQueries.getFromCache(e);null===c&&(c=d(a),this.recentlyUsedQueries.addToCache(e,c),c=c.catch(f=>{this.recentlyUsedQueries?.removeFromCache(e);throw f;}))}this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:a,method:b});null===c&&(c=d(a));return c}async _getFilteredSet(a,
b,d,c,e){const f=await this.databaseType();if(this.isTable()&&b&&null!==a&&""!==a)return new w([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(a,b,d,c,e);let g="",h=!1;null!==c&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(g=c.constructClause(),h=!0);c=this._createQuery();c.where=u.sqlAnd(c.where,null===d?null===b?"1\x3d1":"":r.toWhereClause(d,f));c.spatialRelationship=this._makeRelationshipEnum(a);
c.outSpatialReference=this.spatialReference;c.orderByFields=""!==g?g.split(","):null;c.geometry=null===b?null:b;c.relationParameter=this._makeRelationshipParam(a);a=await this.executeQuery(c,"executeForIds");null===a&&(a=[]);this._checkCancelled(e);return new w([],a,h,null)}_expandPagedSet(a,b,d,c,e){return this._expandPagedSetFeatureSet(a,b,d,c,e)}async _getFilteredSetUsingPaging(a,b,d,c,e){let f="",g=!1;null!==c&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&
(f=c.constructClause(),g=!0);c=await this.databaseType();d=null===d?null===b?"1\x3d1":"":r.toWhereClause(d,c);c=this._maxQueryRate();var h=this._layer.capabilities?.query.maxRecordCount;null!=h&&h<c&&(c=h);h=null;if(!0===this._pageJustIds)h=new w([],["GETPAGES"],g,{spatialRel:this._makeRelationshipEnum(a),relationParam:this._makeRelationshipParam(a),outFields:this._layer.objectIdField,resultRecordCount:c,resultOffset:0,geometry:null===b?null:b,where:d,orderByFields:f,returnGeometry:!1,returnIdsOnly:"false",
internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{h=!0;!0===this._removeGeometry&&(h=!1);const k=this._overrideFields??this._fieldsIncludingObjectId(["*"]);h=new w([],["GETPAGES"],g,{spatialRel:this._makeRelationshipEnum(a),relationParam:this._makeRelationshipParam(a),outFields:k.join(","),resultRecordCount:c,resultOffset:0,geometry:null===b?null:b,where:d,orderByFields:f,returnGeometry:h,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}await this._expandPagedSet(h,
c,0,1,e);return h}_clonePageDefinition(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}:{groupbypage:!0,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,
useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}}async _getPhysicalPage(a,b,d){b=a.pagesDefinition.internal.lastRetrieved;var c=a.pagesDefinition.internal.lastPage,e=this._createQuery();e.spatialRelationship=a.pagesDefinition.spatialRel;
e.relationParameter=a.pagesDefinition.relationParam;e.outFields=a.pagesDefinition.outFields.split(",");e.num=a.pagesDefinition.resultRecordCount;e.start=a.pagesDefinition.internal.lastPage;e.geometry=a.pagesDefinition.geometry;e.where=u.sqlAnd(e.where,a.pagesDefinition.where);e.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;e.returnGeometry=a.pagesDefinition.returnGeometry;e.outSpatialReference=this.spatialReference;e=await this.executeQuery(e,"execute");
this._checkCancelled(d);if(a.pagesDefinition.internal.lastPage!==c)return"done";d=this._layer.objectIdField;for(c=0;c<e.features.length;c++)a.pagesDefinition.internal.set[b+c]=e.features[c].attributes[d];if(!1===this._pageJustIds)for(c=0;c<e.features.length;c++)this._featureCache[e.features[c].attributes[d]]=e.features[c];if(void 0===e.exceededTransferLimit&&e.features.length!==a.pagesDefinition.resultRecordCount||!1===e.exceededTransferLimit)a.pagesDefinition.internal.fullyResolved=!0;a.pagesDefinition.internal.lastRetrieved=
b+e.features.length;a.pagesDefinition.internal.lastPage+=a.pagesDefinition.resultRecordCount;return"done"}_fieldsIncludingObjectId(a){if(null===a)return[this.objectIdField];a=a.slice();if(a.includes("*"))return a;let b=!1;for(const d of a)if(d.toUpperCase()===this.objectIdField.toUpperCase()){b=!0;break}!1===b&&a.push(this.objectIdField);return a}async _getFeatures(a,b,d,c){var e=[];-1!==b&&void 0===this._featureCache[b]&&e.push(b);if(!0===this._checkIfNeedToExpandKnownPage(a,this._maxProcessingRate()))return await this._expandPagedSet(a,
this._maxProcessingRate(),0,0,c),this._getFeatures(a,b,d,c);let f=0;for(let h=a._lastFetchedIndex;h<a._known.length;h++){a._lastFetchedIndex+=1;f++;if(void 0===this._featureCache[a._known[h]]){let k=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var g=this._layer._mode;void 0!==g._featureMap[a._known[h]]&&(g=g._featureMap[a._known[h]],null!==g&&(k=!0,this._featureCache[a._known[h]]=g))}if(!1===k&&(a._known[h]!==b&&e.push(a._known[h]),e.length>=this._maxProcessingRate()-1))break}if(f>=
d&&0===e.length)break}if(0===e.length)return"success";a=this._createQuery();a.objectIds=e;a.outFields=this._overrideFields??this._fieldsIncludingObjectId(["*"]);a.returnGeometry=!0;!0===this._removeGeometry&&(a.returnGeometry=!1);a.outSpatialReference=this.spatialReference;e=await this.executeQuery(a,"execute");this._checkCancelled(c);if(void 0!==e.error)throw new q.FeatureSetError(q.FeatureSetErrorCodes.RequestFailed,{reason:e.error});c=this._layer.objectIdField;for(a=0;a<e.features.length;a++)this._featureCache[e.features[a].attributes[c]]=
e.features[a];return"success"}async _getDistinctPages(a,b,d,c,e,f,g,h,k){await this._ensureLoaded();var n=await this.databaseType();let p=d.parseTree.column;var l=this._layer.fields??[];for(var m=0;m<l.length;m++)if(l[m].name.toLowerCase()===p.toLowerCase()){p=l[m].name;break}m=this._createQuery();m.where=u.sqlAnd(m.where,null===f?null===e?"1\x3d1":"":r.toWhereClause(f,n));m.spatialRelationship=this._makeRelationshipEnum(c);m.relationParameter=this._makeRelationshipParam(c);m.geometry=null===e?null:
e;m.returnDistinctValues=!0;m.returnGeometry=!1;m.outFields=[p];n=await this.executeQuery(m,"execute");this._checkCancelled(k);if(!n.hasOwnProperty("features"))throw new q.FeatureSetError(q.FeatureSetErrorCodes.InvalidStatResponse);m=!1;for(var v=0;v<l.length;v++)if(l[v].name===p){"date"===l[v].type&&(m=!0);break}for(l=0;l<n.features.length&&!(m?(v=n.features[l].attributes[p],null!==v?h.push(new Date(v)):h.push(v)):h.push(n.features[l].attributes[p]),h.length>=g);l++);return 0===n.features.length?
h:n.features.length===this._layer.capabilities?.query.maxRecordCount&&h.length<g?{calculated:!0,result:await this._getDistinctPages(a+n.features.length,b,d,c,e,f,g,h,k)}:h}async _distinctStat(a,b,d,c,e,f,g){return{calculated:!0,result:await this._getDistinctPages(0,a,b,d,c,e,f,[],g)}}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType||"esriGeometryNull"===this._layer.geometryType}async _countstat(a,b,d,c){a=await this.databaseType();
if(this.isTable()&&d&&null!==b&&""!==b)return{calculated:!0,result:0};const e=this._createQuery();e.where=u.sqlAnd(e.where,null===c?null===d?"1\x3d1":"":r.toWhereClause(c,a));e.spatialRelationship=this._makeRelationshipEnum(b);e.relationParameter=this._makeRelationshipParam(b);e.geometry=null===d?null:d;e.returnGeometry=!1;return{calculated:!0,result:await this.executeQuery(e,"executeForCount")}}async _stats(a,b,d,c,e,f,g){await this._ensureLoaded();const h=this._layer.capabilities&&this._layer.capabilities.query&&
!0===this._layer.capabilities.query.supportsSqlExpression,k=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,n=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;if("count"===a)return n?this._countstat(a,d,c,e):{calculated:!1};if(!1===k||!1===r.isSingleField(b)&&!1===h||!1===b.isStandardized)return""!==d||null!==e?{calculated:!1}:this._manualStat(a,b,f,g);if("distinct"===a)return!1===
n?""!==d||null!==e?{calculated:!1}:this._manualStat(a,b,f,g):this._distinctStat(a,b,d,c,e,f,g);g=await this.databaseType();if(this.isTable()&&c&&null!==d&&""!==d)return{calculated:!0,result:null};f=this._createQuery();f.where=u.sqlAnd(f.where,null===e?null===c?"1\x3d1":"":r.toWhereClause(e,g));f.spatialRelationship=this._makeRelationshipEnum(d);f.relationParameter=this._makeRelationshipParam(d);f.geometry=null===c?null:c;d=new C;d.statisticType=G.decodeStatType(a);d.onStatisticField=r.toWhereClause(b,
g);d.outStatisticFieldName="ARCADE_STAT_RESULT";f.returnGeometry=!1;a="ARCADE_STAT_RESULT";f.outStatistics=[d];b=await this.executeQuery(f,"execute");if(!b.hasOwnProperty("features")||0===b.features.length)throw new q.FeatureSetError(q.FeatureSetErrorCodes.InvalidStatResponse);d=!1;c=b.fields??[];for(e=0;e<c.length;e++)if("ARCADE_STAT_RESULT"===c[e].name.toUpperCase()){a=c[e].name;"date"===c[e].type&&(d=!0);break}return d?(d=b.features[0].attributes[a],null!==d&&(d=new Date(b.features[0].attributes[a])),
{calculated:!0,result:d}):{calculated:!0,result:b.features[0].attributes[a]}}_stat(a,b,d,c,e,f,g){return this._stats(a,b,d,c,e,f,g)}async _canDoAggregates(a,b){await this._ensureLoaded();a=!1;var d=this._layer.capabilities?.query;const c=!0===d?.supportsSqlExpression;null!=d&&!0===d.supportsStatistics&&!0===d.supportsOrderBy&&(a=!0);if(a)for(d=0;d<b.length-1;d++)!1===b[d].workingexpr?.isStandardized?a=!1:!1===r.isSingleField(b[d].workingexpr)&&!1===c&&(a=!1);return!1===a?!1:!0}_makeRelationshipEnum(a){if(a.includes("esriSpatialRelRelation"))return"relation";
switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a}_makeRelationshipParam(a){return a.includes("esriSpatialRelRelation")?a.split(":")[1]:""}async _getAggregatePagesDataSourceDefinition(a,
b,d,c,e,f,g){await this._ensureLoaded();const h=await this.databaseType();let k="",n=!1,p=!1;null!==f&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(k=f.constructClause(),p=!0);this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(p=!1,n=!0,k=this._layer.objectIdField);f=[];for(var l=0;l<b.length;l++){const m=new C;m.onStatisticField=null!==b[l].workingexpr?r.toWhereClause(b[l].workingexpr,
h):"";m.outStatisticFieldName=b[l].field;m.statisticType=b[l].toStatisticsName();f.push(m)}""===k&&(k=a.join(","));b=this._maxQueryRate();l=this._layer.capabilities?.query.maxRecordCount;null!=l&&l<b&&(b=l);e=null===e?null===c?"1\x3d1":"":r.toWhereClause(e,h);return new w([],["GETPAGES"],p,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(d),relationParam:this._makeRelationshipParam(d),outFields:["*"],useOIDpagination:n,generatedOid:g,resultRecordCount:b,resultOffset:0,groupByFieldsForStatistics:a,
outStatistics:f,geometry:null===c?null:c,where:e,orderByFields:k,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}async _getAgregagtePhysicalPage(a,b,d){var c=a.pagesDefinition.where;!0===a.pagesDefinition.useOIDpagination&&(c=u.sqlAnd(c,a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString()));b=a.pagesDefinition.internal.lastRetrieved;var e=a.pagesDefinition.internal.lastPage;const f=this._createQuery();
f.where=u.sqlAnd(f.where,c);f.spatialRelationship=a.pagesDefinition.spatialRel;f.relationParameter=a.pagesDefinition.relationParam;f.outFields=a.pagesDefinition.outFields;f.outStatistics=a.pagesDefinition.outStatistics;f.geometry=a.pagesDefinition.geometry;f.groupByFieldsForStatistics=a.pagesDefinition.groupByFieldsForStatistics;f.num=a.pagesDefinition.resultRecordCount;f.start=a.pagesDefinition.internal.lastPage;f.returnGeometry=a.pagesDefinition.returnGeometry;f.orderByFields=""!==a.pagesDefinition.orderByFields?
a.pagesDefinition.orderByFields.split(","):null;if(this.isTable()&&f.geometry&&f.spatialRelationship)return[];c=await this.executeQuery(f,"execute");this._checkCancelled(d);if(!c.hasOwnProperty("features"))throw new q.FeatureSetError(q.FeatureSetErrorCodes.InvalidStatResponse);d=[];if(a.pagesDefinition.internal.lastPage!==e)return[];0<c.features.length&&void 0===c.features[0].attributes[a.pagesDefinition.generatedOid]&&(a.pagesDefinition.generatedOid=a.pagesDefinition.generatedOid.toLowerCase());
for(e=0;e<c.features.length;e++)a.pagesDefinition.internal.set[b+e]=c.features[e].attributes[a.pagesDefinition.generatedOid];for(e=0;e<c.features.length;e++)d.push(new z({attributes:c.features[e].attributes,geometry:null}));if(!0===a.pagesDefinition.useOIDpagination)0===c.features.length?a.pagesDefinition.internal.fullyResolved=!0:a.pagesDefinition.internal.lastMaxId=c.features[c.features.length-1].attributes[a.pagesDefinition.generatedOid];else if(void 0===c.exceededTransferLimit&&c.features.length!==
a.pagesDefinition.resultRecordCount||!1===c.exceededTransferLimit)a.pagesDefinition.internal.fullyResolved=!0;a.pagesDefinition.internal.lastRetrieved=b+c.features.length;a.pagesDefinition.internal.lastPage+=a.pagesDefinition.resultRecordCount;return d}static create(a,b,d,c,e){a=new J({url:a,outFields:null===b?["*"]:b});return new y({layer:a,spatialReference:d,lrucache:c,interceptor:e})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON?.relationships?this._layer.source.sourceJSON.relationships:
[]}serviceUrl(){return t.extractServiceUrl(this._layer.parsedUrl.path)}async queryAttachments(a,b,d,c,e){const f=this._layer;if(function(g){g=g.capabilities;return g?.data.supportsAttachment&&g?.operations.supportsQueryAttachments}(f)){const g={objectIds:[a],returnMetadata:e};if(b&&0<b||d&&0<d)g.size=[b&&0<b?b:0,d&&0<d?d:b+1];c&&0<c.length&&(g.attachmentTypes=c);this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:f,query:g,method:"attachments"});b=await f.queryAttachments(new K(g));
const h=[];b&&b[a]&&b[a].forEach(k=>{const n=this._layer.parsedUrl.path+"/"+a.toString()+"/attachments/"+k.id.toString();let p=null;e&&k.exifInfo&&(p=E.convertJsonToArcade(k.exifInfo,"system",!0));h.push(new D(k.id,k.name,k.contentType,k.size,n,p,k.keywords??null))});return h}return[]}async queryRelatedFeatures(a){var b={f:"json",relationshipId:a.relationshipId.toString(),definitionExpression:a.where,outFields:a.outFields?.join(","),returnGeometry:a.returnGeometry.toString()};void 0!==a.resultOffset&&
null!==a.resultOffset&&(b.resultOffset=a.resultOffset.toString());void 0!==a.resultRecordCount&&null!==a.resultRecordCount&&(b.resultRecordCount=a.resultRecordCount.toString());a.orderByFields&&(b.orderByFields=a.orderByFields.join(","));a.objectIds&&0<a.objectIds.length&&(b.objectIds=a.objectIds.join(","));a.outSpatialReference&&(b.outSR=I.srToRESTValue(a.outSpatialReference));this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:b,method:"relatedrecords",
url:this._layer.parsedUrl.path+"/queryRelatedRecords"});b=await x(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:b});if(b.data){a={};b=b.data;if(b?.relatedRecordGroups){const d=b.spatialReference;for(const c of b.relatedRecordGroups){const e=c.objectId,f=[];for(const g of c.relatedRecords){g.geometry&&(g.geometry.spatialReference=d);const h=new z({geometry:g.geometry?H.fromJSON(g.geometry):null,attributes:g.attributes});f.push(h)}a[e]={features:f,exceededTransferLimit:!0===
b.exceededTransferLimit}}}return a}throw new q.FeatureSetError(q.FeatureSetErrorCodes.InvalidRequest);}async getFeatureByObjectId(a,b){const d=this._createQuery();d.outFields=b;d.returnGeometry=!1;d.outSpatialReference=this.spatialReference;d.where=u.sqlAnd(d.where,this.objectIdField+"\x3d"+a.toString());this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:d,method:"execute"});a=await this._layer.queryFeatures(d);return 1===a.features.length?
a.features[0]:null}async getIdentityUser(){await this.load();const a=A.id?.findCredential(this._layer.url);return a?a.userId:null}async getOwningSystemUrl(){await this.load();var a=A.id?.findServerInfo(this._layer.url);if(a)return a.owningSystemUrl;a=this._layer.url;const b=a.toLowerCase().indexOf("/rest/services");if(a=-1<b?a.slice(0,b):a)try{const d=await x(a+"/rest/info",{query:{f:"json"}});a="";d.data?.owningSystemUrl&&(a=d.data.owningSystemUrl);return a}catch(d){}return""}getDataSourceFeatureSet(){const a=
new y({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});a._useDefinitionExpression=!1;return a}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone??!1}get editFieldsInfo(){return this._layer.editFieldsInfo??
null}get timeInfo(){return this._layer.timeInfo??null}async getFeatureSetInfo(){if(this.fsetInfo)return this.fsetInfo;let a=null;var b="serviceItemId"in this._layer?this._layer.serviceItemId:null;const d=this._layer.parsedUrl.path;d&&(b=await x(d,{responseType:"json",query:{f:"json"}}),a=b?.data?.name??null,b=b?.data?.serviceItemId??null);const c=this._layer.title&&null!==(this._layer.parent??null);this.featureSetInfo={layerId:this._layer.layerId,layerName:""===a?null:a,itemId:""===b?null:b,serviceLayerUrl:""===
d?null:d,webMapLayerId:c?this._layer.id??null:null,webMapLayerTitle:c?this._layer.title??null:null,className:null,objectClassId:null};return this.fsetInfo}}return y});