// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../Graphic ../support/errorsupport ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../core/sql ../../../geometry/Geometry ../../../layers/FeatureLayer ../../../layers/support/FeatureType ../../../layers/support/Field ../../../rest/support/Query".split(" "),function(x,t,y,p,q,z,A,B,C,D,u,v){class w extends y{constructor(a){super(a);this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory";this._removeGeometry=!1;this._overrideFields=null;
this._forceIsTable=!1;a.spatialReference&&(this.spatialReference=a.spatialReference);this._transparent=!0;this._maxProcessing=1E3;this._layer=a.layer;this._wset=null;!0===a.isTable&&(this._forceIsTable=!0);void 0!==a.outFields&&(this._overrideFields=a.outFields);void 0!==a.includeGeometry&&(this._removeGeometry=!1===a.includeGeometry)}_maxQueryRate(){return q.defaultMaxRecords}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){if(!0===this._layer.loaded)return this._initialiseFeatureSet(),
this;await this._layer.load();this._initialiseFeatureSet();return this}get gdbVersion(){return""}_initialiseFeatureSet(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType??"";this.fields=this._layer.fields.slice();if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const a=[],d=[];for(const b of this.fields)if("oid"===b.type)a.push(b),d.push(b.name);
else for(const c of this._overrideFields)if(c.toLowerCase()===b.name.toLowerCase()){a.push(b);d.push(b.name);break}this.fields=a;this._overrideFields=d}this.objectIdField=this._layer.objectIdField;for(const a of this.fields)"global-id"===a.type&&(this.globalIdField=a.name);this._databaseType=q.FeatureServiceDatabaseType.Standardised;this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ;this.hasM=!0===this._layer?.capabilities?.data?.supportsM;this.subtypeField=("subtypeField"in this._layer?this._layer.subtypeField:
null)??"";this.subtypes="subtypes"in this._layer?this._layer.subtypes:null;this.typeIdField=("typeIdField"in this._layer?this._layer.typeIdField:null)??"";this.types="types"in this._layer?this._layer.types:null}isTable(){return this._forceIsTable||"isTable"in this._layer&&this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return q.IdState.InFeatureSet}_candidateIdTransform(a){return a}async _getSet(a){return null===this._wset?(await this._ensureLoaded(),this._wset=
a=await this._getFilteredSet("",null,null,null,a)):this._wset}_changeFeature(a){const d={};for(const b of this.fields)d[b.name]=a.attributes[b.name];return new x({geometry:!0===this._removeGeometry?null:a.geometry,attributes:d})}async _getFilteredSet(a,d,b,c,e){let h="",n=!1;null!==c&&(h=c.constructClause(),n=!0);if(this.isTable()&&d&&null!==a&&""!==a)return new p([],[],!0,null);c=this._layer.createQuery();c.returnZ=this.hasZ;c.returnM=this.hasM;c.where=A.sqlAnd(c.where,null===b?null===d?"1\x3d1":
"":z.toWhereClause(b,q.FeatureServiceDatabaseType.Standardised));c.spatialRelationship=this._makeRelationshipEnum(a);c.outSpatialReference=this.spatialReference;c.orderByFields=""!==h?h.split(","):null;c.geometry=null===d?null:d;c.returnGeometry=!0;c.relationParameter=this._makeRelationshipParam(a);a=await this._layer.queryFeatures(c);if(null===a)return new p([],[],n,null);this._checkCancelled(e);const r=[];a.features.forEach(m=>{const f=m.attributes[this._layer.objectIdField];r.push(f);this._featureCache[f]=
this._changeFeature(m)});return new p([],r,n,null)}_makeRelationshipEnum(a){if(a.includes("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a}_makeRelationshipParam(a){return a.includes("esriSpatialRelRelation")?
a.split(":")[1]:""}async _queryAllFeatures(){if(this._wset)return this._wset;const a=new v;a.where="1\x3d1";await this._ensureLoaded();if(this._layer.source&&this._layer.source.items){const b=[];this._layer.source.items.forEach(c=>{const e=c.attributes[this._layer.objectIdField];b.push(e);this._featureCache[e]=this._changeFeature(c)});return this._wset=new p([],b,!1,null)}a.returnZ=this.hasZ;a.returnM=this.hasM;const d=[];(await this._layer.queryFeatures(a)).features.forEach(b=>{const c=b.attributes[this._layer.objectIdField];
d.push(c);this._featureCache[c]=this._changeFeature(b)});return this._wset=new p([],d,!1,null)}async _getFeatures(a,d,b){const c=[];-1!==d&&void 0===this._featureCache[d]&&c.push(d);for(let e=a._lastFetchedIndex;e<a._known.length&&!(a._lastFetchedIndex+=1,void 0===this._featureCache[a._known[e]]&&(a._known[e]!==d&&c.push(a._known[e]),c.length>b));e++);if(0===c.length)return"success";throw new t.FeatureSetError(t.FeatureSetErrorCodes.MissingFeatures);}async _refineSetBlock(a){return a}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}relationshipMetaData(){return[]}static _cloneAttr(a){const d=
{};for(const b in a)d[b]=a[b];return d}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(a,d){var b=a.layerDefinition.objectIdField,c=a.layerDefinition.typeIdField??"",e=[];if(a.layerDefinition.types)for(var h of a.layerDefinition.types)e.push(D.fromJSON(h));let n=a.layerDefinition.geometryType;void 0===n&&(n=a.featureSet.geometryType||"");h=a.featureSet.features;
const r=d.toJSON();if(!b){var m=!1;for(var f of a.layerDefinition.fields)if("oid"===f.type||"esriFieldTypeOID"===f.type){b=f.name;m=!0;break}if(!1===m){b="FID";f=!0;for(m=0;f;){let k=!0;for(var l of a.layerDefinition.fields)if(l.name===b){k=!1;break}!0===k?f=!1:(m++,b="FID"+m.toString())}a.layerDefinition.fields.push({type:"esriFieldTypeOID",name:b,alias:b});l=[];for(f=0;f<h.length;f++)l.push({geometry:a.featureSet.features[f].geometry,attributes:a.featureSet.features[f].attributes?this._cloneAttr(a.featureSet.features[f].attributes):
{}}),l[f].attributes[b]=f;h=l}}l=[];for(var g of a.layerDefinition.fields)g instanceof u?l.push(g):l.push(u.fromJSON(g));(g=n)||(g="");switch(g){case "esriGeometryPoint":g="point";break;case "esriGeometryPolyline":g="polyline";break;case "esriGeometryPolygon":g="polygon";break;case "esriGeometryEnvelope":g="extent";break;case "esriGeometryMultipoint":g="multipoint";break;case "":case "esriGeometryNull":g="esriGeometryNull"}if("esriGeometryNull"!==g)for(const k of h)k.geometry&&!1===k.geometry instanceof
B&&(k.geometry.type=g,void 0===k.geometry.spatialReference&&(k.geometry.spatialReference=r));else for(const k of h)k.geometry&&(k.geometry=null);e={outFields:["*"],source:h,fields:l,hasZ:!0===a?.layerDefinition?.hasZ||!0===a?.featureSet?.hasZ,hasM:!0===a?.layerDefinition?.hasM||!0===a?.featureSet?.hasM,types:e,typeIdField:c,objectIdField:b,spatialReference:d};c="esriGeometryNull"===g||null===g;c||(e.geometryType=g);e=new C(e);a?.layerDefinition?.subtypeField&&a?.layerDefinition?.subtypes&&e.read({subtypes:a.layerDefinition.subtypes,
subtypeField:a.layerDefinition.subtypeField});return new w({layer:e,spatialReference:d,isTable:c})}async queryAttachments(){return[]}async getFeatureByObjectId(a){const d=new v;d.where=this.objectIdField+"\x3d"+a.toString();d.returnZ=this.hasZ;d.returnM=this.hasM;a=await this._layer.queryFeatures(d);return 1===a.features.length?a.features[0]:null}async getOwningSystemUrl(){return""}async getIdentityUser(){return""}get preferredTimeZone(){return"preferredTimeZone"in this._layer?this._layer.preferredTimeZone:
null}get dateFieldsTimeZone(){return"dateFieldsTimeZone"in this._layer?this._layer.dateFieldsTimeZone:null}get datesInUnknownTimezone(){return"datesInUnknownTimezone"in this._layer?this._layer.datesInUnknownTimezone:!1}get editFieldsInfo(){return"editFieldsInfo"in this._layer?this._layer.editFieldsInfo:null}get timeInfo(){return this._layer?.timeInfo}async getFeatureSetInfo(){const a=this._layer.title&&this._layer.parent;return this.fsetInfo??{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,
webMapLayerId:a?this._layer.id??null:null,webMapLayerTitle:a?this._layer.title??null:null,className:null,objectClassId:null}}}return w});