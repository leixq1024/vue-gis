// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../ArcadeDate ./shared ../../../core/sql/errorSupport ../../../core/sql/TimeOnly ../../../core/sql/WhereClause ../../../chunks/datetime".split(" "),function(l,E,f,k,F,x,G){function t(a,b){return g(a?.parseTree,b,a?.parameters)}function y(a){return!0===a.delimited?`"${a.column.split('"').join('""')}"`:a.column}function g(a,b,c,d=null,e=null){switch(a.type){case "interval":return z(g(a.value,b,c,d,e),a.qualifier,a.op);case "case-expression":var h=" CASE ";"simple"===a.format&&(h+=
g(a.operand,b,c,d,e));for(var m=0;m<a.clauses.length;m++)h+=" WHEN "+g(a.clauses[m].operand,b,c,d,e)+" THEN "+g(a.clauses[m].value,b,c,d,e);null!==a.else&&(h+=" ELSE "+g(a.else,b,c,d,e));return h+" END ";case "parameter":d=c[a.value.toLowerCase()];if("string"===typeof d)return"'"+c[a.value.toLowerCase()].toString().replaceAll("'","''")+"'";if(f.isDate(d)||f.isLuxonDate(d))return q(d,b);if(f.isArcadeTime(d))return u(d,b);if(f.isArcadeDate(d))return r(d,b);if(f.isArcadeDateOnly(d))return v(d,b);if(Array.isArray(d)){a=
[];for(c=0;c<d.length;c++)"string"===typeof d[c]?a.push("'"+d[c].toString().replaceAll("'","''")+"'"):f.isDate(d[c])?a.push(q(d[c],b)):f.isLuxonDate(d[c])?a.push(q(d[c],b)):f.isArcadeTime(d[c])?a.push(u(d[c],b)):f.isArcadeDate(d[c])?a.push(r(d[c],b)):f.isArcadeDateOnly(d[c])?a.push(v(d[c],b)):a.push(d[c].toString());return a}return d.toString();case "expression-list":h=[];for(m of a.value)h.push(g(m,b,c,d,e));return h;case "unary-expression":return" ( NOT "+g(a.expr,b,c,d,e)+" ) ";case "binary-expression":switch(a.operator){case "AND":return" ("+
g(a.left,b,c,d,e)+" AND "+g(a.right,b,c,d,e)+") ";case "OR":return" ("+g(a.left,b,c,d,e)+" OR "+g(a.right,b,c,d,e)+") ";case "IS":if("null"!==a.right.type)throw new k.SqlError(k.SqlErrorCodes.UnsupportedIsRhs);return" ("+g(a.left,b,c,d,e)+" IS NULL )";case "ISNOT":if("null"!==a.right.type)throw new k.SqlError(k.SqlErrorCodes.UnsupportedIsRhs);return" ("+g(a.left,b,c,d,e)+" IS NOT NULL )";case "IN":h=[];if("expression-list"===a.right.type)return h=g(a.right,b,c,d,e)," ("+g(a.left,b,c,d,e)+" IN ("+
h.join(",")+")) ";h=g(a.right,b,c,d,e);return Array.isArray(h)?" ("+g(a.left,b,c,d,e)+" IN ("+h.join(",")+")) ":" ("+g(a.left,b,c,d,e)+" IN ("+h+")) ";case "NOT IN":h=[];if("expression-list"===a.right.type)return h=g(a.right,b,c,d,e)," ("+g(a.left,b,c,d,e)+" NOT IN ("+h.join(",")+")) ";h=g(a.right,b,c,d,e);return Array.isArray(h)?" ("+g(a.left,b,c,d,e)+" NOT IN ("+h.join(",")+")) ":" ("+g(a.left,b,c,d,e)+" NOT IN ("+h+")) ";case "BETWEEN":return h=g(a.right,b,c,d,e)," ("+g(a.left,b,c,d,e)+" BETWEEN "+
h[0]+" AND "+h[1]+" ) ";case "NOTBETWEEN":return h=g(a.right,b,c,d,e)," ("+g(a.left,b,c,d,e)+" NOT BETWEEN "+h[0]+" AND "+h[1]+" ) ";case "LIKE":return""!==a.escape?" ("+g(a.left,b,c,d,e)+" LIKE "+g(a.right,b,c,d,e)+" ESCAPE '"+a.escape+"') ":" ("+g(a.left,b,c,d,e)+" LIKE "+g(a.right,b,c,d,e)+") ";case "NOT LIKE":return""!==a.escape?" ("+g(a.left,b,c,d,e)+" NOT LIKE "+g(a.right,b,c,d,e)+" ESCAPE '"+a.escape+"') ":" ("+g(a.left,b,c,d,e)+" NOT LIKE "+g(a.right,b,c,d,e)+") ";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":case "*":case "-":case "+":case "/":return" ("+
g(a.left,b,c,d,e)+" "+a.operator+" "+g(a.right,b,c,d,e)+") ";case "||":return" ("+g(a.left,b,c,d,e)+" "+(b===f.FeatureServiceDatabaseType.SqlServer?"+":a.operator)+" "+g(a.right,b,c,d,e)+") "}throw new k.SqlError(k.SqlErrorCodes.UnsupportedOperator,{operator:a.operator});case "null":return"null";case "boolean":return!0===a.value?"1":"0";case "string":return"'"+a.value.toString().replaceAll("'","''")+"'";case "timestamp":return`timestamp '${a.value}'`;case "date":return`date '${a.value}'`;case "time":return`time '${a.value}'`;
case "number":return a.value.toString();case "current-time":return A(a.mode,b);case "current-user":return"CURRENT_USER";case "column-reference":return d&&d.toLowerCase()===a.column.toLowerCase()?"("+e+")":y(a);case "data-type":return a.value;case "function":return c=g(a.args,b,c,d,e),B(a.name,c,b)}throw new k.SqlError(k.SqlErrorCodes.UnsupportedSyntax,{node:a.type});}function B(a,b,c){switch(a.toLowerCase().trim()){case "cos":case "sin":case "tan":case "cosh":case "tanh":case "sinh":case "acos":case "asin":case "atan":case "floor":case "log10":case "log":case "abs":if(1!==
b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:a.toLowerCase().trim()});return`${a.toUpperCase().trim()}(${b[0]})`;case "ceiling":case "ceil":if(1!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"ceiling"});switch(c){case f.FeatureServiceDatabaseType.Standardised:case f.FeatureServiceDatabaseType.StandardisedNoInterval:return"CEILING("+b[0]+")";default:return"CEILING("+b[0]+")"}case "mod":case "power":case "nullif":if(2!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,
{function:a.toLowerCase().trim()});return`${a.toUpperCase().trim()}(${b[0]},${b[1]})`;case "round":if(2===b.length)return"ROUND("+b[0]+","+b[1]+")";if(1===b.length)return"ROUND("+b[0]+")";throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"round"});case "truncate":if(1>b.length||2<b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"truncate"});switch(c){case f.FeatureServiceDatabaseType.SqlServer:return"ROUND("+b[0]+(1===b.length?"0":","+b[1])+
",1)";default:return"TRUNCATE("+b[0]+(1===b.length?")":","+b[1]+")")}case "char_length":case "len":if(1!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"char_length"});switch(c){case f.FeatureServiceDatabaseType.SqlServer:return"LEN("+b[0]+")";case f.FeatureServiceDatabaseType.Oracle:return"LENGTH("+b[0]+")";default:return"CHAR_LENGTH("+b[0]+")"}case "coalesce":case "concat":if(1>b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:a.toLowerCase()});
c=a.toUpperCase().trim()+"(";for(a=0;a<b.length;a++)0!==a&&(c+=","),c+=b[a];return c+")";case "lower":case "lcase":if(1!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"lower"});return"LOWER("+b[0]+")";case "upper":case "ucase":if(1!==b.length)throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:"upper"});return"UPPER("+b[0]+")";case "substring":switch(a="",c){case f.FeatureServiceDatabaseType.Oracle:return a="SUBSTR("+b[0]+","+b[1],3===b.length&&
(a+=","+b[2]),a+")";case f.FeatureServiceDatabaseType.SqlServer:return a=3===b.length?"SUBSTRING("+b[0]+","+b[1]+","+b[2]+")":"SUBSTRING("+b[0]+",  "+b[1]+", LEN("+b[0]+") - "+b[1]+")";default:return a="SUBSTRING("+b[0]+" FROM "+b[1],3===b.length&&(a+=" FOR "+b[2]),a+")"}case "extract":return"EXTRACT("+b[0].replaceAll("'","")+" FROM "+b[1]+")";case "cast":switch(a="",c){case f.FeatureServiceDatabaseType.Oracle:switch(b[1].type){case "date":a="DATE";break;case "float":a="DOUBLE";break;case "integer":a=
"INTEGER";break;case "real":a="REAL";break;case "smallint":a="SMALLINT";break;case "timestamp":a="TIMESTAMP";break;case "varchar":a="VARCHAR("+b[1].size.toString()+")"}return`CAST(${b[0]} AS ${a})`;case f.FeatureServiceDatabaseType.Postgres:switch(b[1].type){case "date":a="DATE";break;case "float":a="DOUBLE PRECISION";break;case "integer":a="INT";break;case "real":a="REAL";break;case "smallint":a="SMALLINT";break;case "timestamp":a="TIMESTAMP";break;case "varchar":a="VARCHAR("+b[1].size.toString()+
")"}return`CAST(${b[0]} AS ${a})`;case f.FeatureServiceDatabaseType.SqlServer:switch(b[1].type){case "date":a="DATE";break;case "float":a="FLOAT";break;case "integer":a="INT";break;case "real":a="REAL";break;case "smallint":a="SMALLINT";break;case "timestamp":a="DATETIME";break;case "varchar":a="VARCHAR("+b[1].size.toString()+")"}return`CAST(${b[0]} AS ${a})`;default:switch(b[1].type){case "date":a="DATE";break;case "float":a="FLOAT";break;case "integer":a="INTEGER";break;case "real":a="REAL";break;
case "smallint":a="SMALLINT";break;case "timestamp":a="TIMESTAMP";break;case "varchar":a="VARCHAR("+b[1].size.toString()+")"}return`CAST(${b[0]} AS ${a})`}}throw new k.SqlError(k.SqlErrorCodes.InvalidFunctionParameters,{function:a});}function r(a,b){a=a.toDateTime();const c=0===a.hour&&0===a.minute&&0===a.second&&0===a.millisecond;switch(b){case f.FeatureServiceDatabaseType.FILEGDB:case f.FeatureServiceDatabaseType.Standardised:case f.FeatureServiceDatabaseType.StandardisedNoInterval:return c?`date '${a.toFormat("yyyy-LL-dd")}'`:
`timestamp '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case f.FeatureServiceDatabaseType.Oracle:return c?`TO_DATE('${a.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${a.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case f.FeatureServiceDatabaseType.SqlServer:return`'${a.toFormat(c?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case f.FeatureServiceDatabaseType.PGDB:return`#${a.toFormat(c?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case f.FeatureServiceDatabaseType.Postgres:return`TIMESTAMP '${a.toFormat(c?
"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`timestamp '${a.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function v(a,b){switch(b){case f.FeatureServiceDatabaseType.FILEGDB:case f.FeatureServiceDatabaseType.Standardised:case f.FeatureServiceDatabaseType.StandardisedNoInterval:return a.toSQLWithKeyword();case f.FeatureServiceDatabaseType.Oracle:return`TO_DATE('${a.toFormat("Y-MM-DD")}'`;case f.FeatureServiceDatabaseType.SqlServer:return`'${a.toFormat("Y-MM-DD")}'`;case f.FeatureServiceDatabaseType.PGDB:return`#${a.toFormat("Y-MM-DD")}#`;
case f.FeatureServiceDatabaseType.Postgres:return`TIMESTAMP '${a.toFormat("Y-MM-DD")}'`;default:return a.toSQLWithKeyword()}}function u(a,b){a instanceof F.TimeOnly&&(a=a.toStorageString());switch(b){case f.FeatureServiceDatabaseType.Oracle:return`TO_DATE('${a}', 'HH24:MI:SS')`;case f.FeatureServiceDatabaseType.SqlServer:return`'${a}'`;default:return`time '${a}'`}}function q(a,b){return r(E.ArcadeDate.dateTimeToArcadeDate(f.isLuxonDate(a)?a:G.DateTime.fromJSDate(a)),b)}function A(a,b){switch(b){default:return"date"===
a?"CURRENT_DATE":"time"===a?"CURRENT_TIME":"CURRENT_TIMESTAMP";case f.FeatureServiceDatabaseType.SqlServer:return"date"===a?"CAST(GETDATE() AS DATE)":"time"===a?"CAST(GETDATE() AS TIME)":"GETDATE()";case f.FeatureServiceDatabaseType.Postgres:return"date"===a?"CURRENT_DATE":"time"===a?"LOCALTIME":"CURRENT_TIMESTAMP"}}function n(a,b,c,d){switch(b.type){case "interval":return"integer";case "case-expression":var e=[];if("simple"===b.format)for(var h=0;h<b.clauses.length;h++)e.push(n(a,b.clauses[h].value,
c,d));else for(h=0;h<b.clauses.length;h++)e.push(n(a,b.clauses[h].value,c,d));null!==b.else&&e.push(n(a,b.else,c,d));return w(e);case "parameter":a=d[b.value.toLowerCase()];if(void 0===a&&c){b=c[b.value.toLowerCase()];if(void 0===b||null===b)return"";if("string"===typeof b||b instanceof String)return"string";if("boolean"===typeof b)return"boolean";if(f.isDate(b)||f.isArcadeDate(b))return"date";if(f.isArcadeDateOnly(b))return"date-only";if(f.isArcadeTime(b))return"time-only";if("number"===typeof b)return 0===
b%1?"integer":"double"}return void 0===a?"":a;case "expression-list":e=[];for(h of b.value)e.push(n(a,h,c,d));return e;case "unary-expression":return"boolean";case "binary-expression":switch(b.operator){case "AND":return"boolean";case "OR":return"boolean";case "IS":if("null"!==b.right.type)throw new k.SqlError(k.SqlErrorCodes.UnsupportedIsRhs);return"boolean";case "ISNOT":if("null"!==b.right.type)throw new k.SqlError(k.SqlErrorCodes.UnsupportedIsRhs);return"boolean";case "IN":return"boolean";case "NOT IN":return"boolean";
case "BETWEEN":return"boolean";case "NOTBETWEEN":return"boolean";case "LIKE":return"boolean";case "NOT LIKE":return"boolean";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return"boolean";case "*":case "-":case "+":case "/":return w([n(a,b.left,c,d),n(a,b.right,c,d)]);case "||":return"string";default:throw new k.SqlError(k.SqlErrorCodes.UnsupportedOperator,{operator:b.operator});}case "null":return"";case "boolean":return"boolean";case "string":return"string";
case "number":return null===b.value?"":0===b.value%1?"integer":"double";case "date":return"date";case "timestamp":return b.withtimezone?"timestamp-offset":"date";case "time":return"time-only";case "current-time":return"time"===b.mode?"time-only":"date";case "current-user":return"string";case "column-reference":return b=a[b.column.toLowerCase()],void 0===b?"":b;case "function":switch(b.name.toLowerCase()){case "cast":switch(b.args?.value[1]?.value.type??""){case "integer":case "smallint":return"integer";
case "real":case "float":return"double";case "date":case "timestamp":return!0===b.args?.value[1]?.value?.withtimezone?"timestamp-offset":"date";case "time":return"time-only";case "varchar":return"string";default:return""}case "position":case "extract":case "char_length":case "mod":return"integer";case "round":b=n(a,b.args,c,d);if(Array.isArray(b)){if(0>=b.length)return"double";b=b[0]}return b;case "sign":return"integer";case "ceiling":case "floor":case "abs":return b=n(a,b.args,c,d),Array.isArray(b)&&
(b=w(b)),"integer"===b||"double"===b?b:"double";case "area":case "length":case "log":case "log10":case "sin":case "cos":case "tan":case "asin":case "acos":case "atan":case "cosh":case "sinh":case "tanh":case "power":return"double";case "substring":case "trim":case "concat":case "lower":case "upper":return"string";case "truncate":return"double";case "nullif":b=n(a,b.args,c,d);if(Array.isArray(b)){if(0<b.length)return b[0];break}return b;case "coalesce":if(b=n(a,b.args,c,d),Array.isArray(b)){if(0<b.length)return b[0]}else return b}return""}throw new k.SqlError(k.SqlErrorCodes.UnsupportedSyntax,
{node:b.type});}function w(a){if(a){let b="";for(const c of a)""!==c&&(b=""===b?c:C[b]<C[c]?c:b);return b}return""}function p(a,b){if(null===a||void 0===a)return!1;switch(a.type){case "when-clause":return p(a.operand,b)||p(a.value,b);case "case-expression":for(const c of a.clauses)if(p(c,b))return!0;if("simple"===a.format&&p(a.operand,b)||null!==a.else&&p(a.else,b))return!0;break;case "expression-list":for(const c of a.value)if(p(c,b))return!0;break;case "unary-expression":return p(a.expr,b);case "binary-expression":return p(a.left,
b)||p(a.right,b);case "column-reference":return b.toLowerCase()===a.column.toLowerCase();case "function":return p(a.args,b)}return!1}function z(a,b,c){let d="";d="interval-period"===b.type?""+b.period.toUpperCase():""+b.start.period.toUpperCase()+" TO "+b.end.period.toUpperCase();return"INTERVAL "+c+" "+a+" "+d}const C={boolean:1,string:2,integer:3,double:4,date:5};l.arcadeDateOnlyToSqlString=v;l.arcadeDateToSqlString=r;l.combine=function(a,b,c="AND"){return x.WhereClause.create("(("+t(a,f.FeatureServiceDatabaseType.Standardised)+
")"+c+"("+t(b,f.FeatureServiceDatabaseType.Standardised)+"))",{fieldsIndex:a.fieldsIndex,timeZone:a.timeZone,currentUser:a.currentUser})};l.convertColumnReferenceToSql=y;l.convertIntervalToSql=z;l.isSingleField=function(a){return"column-reference"===a?.parseTree.type};l.makeSqlFromDateTimeParameter=q;l.makeTimeString=u;l.makeToday=A;l.predictType=function(a,b,c={}){const d={},e={},h={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeBigInteger:"integer",esriFieldTypeSingle:"double",
esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeTimeOnly:"time-only",esriFieldTypeDateOnly:"date-only",esriFieldTypeTimestampOffset:"timestamp-offset",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"guid",oid:"integer",long:"integer","small-integer":"integer",integer:"integer","big-integer":"integer",single:"double","time-only":"time-only","date-only":"date-only","timestamp-offset":"timestemp-offset",double:"double",date:"date",
guid:"guid","global-id":"guid",string:"string"};for(var m of b)b=m.type?h[m.type]:void 0,d[m.name.toLowerCase()]=void 0===b?"":b;for(const D in c)m=h[c[D]],e[D.toLowerCase()]=void 0===m?"":m;switch(n(d,a.parseTree,a.parameters,e)){case "double":return"double";case "integer":return"integer";case "date":return"date";case "date-only":return"date-only";case "time-only":return"time-only";case "timestamp-offset":return"timestamp-offset";case "string":return"string";case "global-id":return"guid";case "guid":return"guid"}return""};
l.reformulateWithoutField=function(a,b,c,d){b=g(a.parseTree,f.FeatureServiceDatabaseType.Standardised,a.parameters,b,c);return x.WhereClause.create(b,{fieldsIndex:d,timeZone:a.timeZone,currentUser:a.currentUser})};l.scanForField=function(a,b){return p(a.parseTree,b)};l.toWhereClause=t;l.toWhereClauseFromTree=function(a,b,c){return g(a,b,c)};l.translateFunctionToDatabaseSpecific=B;Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});