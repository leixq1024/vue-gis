// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../kernel ../../core/Collection ../../core/deprecate ../../core/Error ../../core/Evented ../../core/Logger ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../geometry/support/jsonUtils ../../intl/messages ../../layers/FeatureLayer ../../layers/GraphicsLayer ../../layers/support/CodedValueDomain ../../layers/support/layerUtils ../../networks/UtilityNetwork ../../networks/support/utils ../../portal/Portal ../../portal/support/utils ../../rest/networks/trace ../../rest/networks/support/TraceLocation ../../rest/networks/support/TraceParameters ./support/GeometryHandler ./support/GraphicHandler ./support/ResultAreaHandler ./support/UtilityHelper".split(" "),
function(k,A,B,C,v,h,w,D,l,T,U,E,r,x,F,G,H,y,I,J,K,L,M,t,N,O,u,P,Q){function z(a){return"feature"===a.type||"subtype-group"===a.type||"group"===a.type}async function R(a){var b=new F({url:a.networkSystemLayers.dirtyAreasLayerUrl});await b.load();return 11.1>=Number(b.version)?(a=await y.getOwningPortalUrl(a.layerUrl),a=new K({url:a}),await a.load(),(b=a?.user?.username)?L.hasUserTypeExtension(a,b,"utilityNetwork"):!1):!0}const p=`utility-network-trace-flags-${Date.now()}`,q=`utility-network-trace-results-${Date.now()}`;
h=class extends h.EventedAccessor{constructor(a){super(a);this._activeProgress=!1;this._clickHandler=null;this._flags=[];this._flagId=0;this._geometryHandler=null;this._highlightHandler=[];this._resultAreaHandler=null;this._utilityHelper=new Q.UtilityHelper;this._watchHandler=null;this._validUNLayers=[];this._traceTimeout=6E5;this._sketchViewModel=null;this.traces=[];this.graphicHandler=null;this.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"};this.enableResultArea=
!1;this.flags=[];this.gdbVersion="sde.DEFAULT";this.messagesUnits=this.messages=null;this.defaultResultAreaProperties={type:"convexhull",distance:10,unit:"meters",areaUnit:"square-meters",color:{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},show:!1};this.selectedTraces=[];this.showSelectionAttributes=this.showGraphicsOnComplete=this.selectOnComplete=!0;this.traceResults=[];this.utilityNetwork=null}initialize(){C.deprecatedFunction(w.getLogger(this),"gdbVersion will be removed and the gdbVersion of the UtilityNetwork will be consumed directly.",
{replacement:"UtilityNetwork.gdbVersion",version:"4.31"});this._geometryHandler=new O.GeometryHandler;this.graphicHandler=new u.GraphicHandler;this._resultAreaHandler=new P.ResultAreaHandler;(async()=>{const [a,b]=await Promise.all([x.fetchMessageBundle("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace"),x.fetchMessageBundle("esri/core/t9n/Units")]);this.set({messages:a,messagesUnits:b})})()}destroy(){this.view=null}get resultAreaProperties(){return this.defaultResultAreaProperties}set resultAreaProperties(a){this._set("resultAreaProperties",
{...this.defaultResultAreaProperties,...a});this.graphicHandler.addCustomColor(this.resultAreaProperties.color);this.traceResults.forEach(b=>{const d=b.resultArea?.show;b.resultArea={...this.defaultResultAreaProperties,...a};this.removeResultAreaFromMap(b);this.enableResultArea&&this.createResultAreaGraphic(b).then(c=>{if(c){b.resultAreaGraphic=c;const e=a?.show??d;b.resultArea&&(b.resultArea.show=e);e&&this.addResultAreaToMap(b,c)}})})}get state(){return this.view?.ready?"ready":"loading"}get view(){return this._get("view")}set view(a){a&&
"2d"!==a.type&&w.getLogger(this).error(new v("view:invalid-view","SceneView is not supported",{view:a}));this._set("view",a);this.utilityNetwork&&this.reset();this.utilityNetwork=null;this.loadUtilityNetwork().then(b=>{b&&this.selectTracesOnLoad()})}addFlagByHit(a,b){const d=c=>{this.view?.popup&&(this.view.popupEnabled=c)};return new Promise((c,e)=>{d(!1);this._clickHandler?.remove();this._clickHandler=this._sketchViewModel.on("create",f=>{if("complete"===f.state){const g=this._getGraphicLayer(p);
g&&f.graphic&&g.remove(f.graphic);this.queryFlagByHitTest(f,a,b).then(m=>{d(!0);this._clickHandler?.remove();this.emit("add-flag-complete",{type:a,symbol:b});c(m)}).catch(m=>{d(!0);this._clickHandler?.remove();this.emit("add-flag-error",{type:a,symbol:b});e(m)})}});this._sketchViewModel.create("point");this.emit("add-flag",{type:a})})}async addFlagsOnLoad(){if(0<this._flags.length)return[];await D.whenOnce(()=>null!=this.view&&!this.view.updating);return(await Promise.all(this.flags.map(async a=>
{if(!a.mapPoint)return null;const {type:b}=a;var d=a.mapPoint.clone();d={graphic:this.graphicHandler.makeGraphic(d,"barrier"===b?u.barrierColor:u.startingPointColor),state:"complete",tool:"point",toolEventInfo:null,type:"create"};try{return await this.queryFlagByHitTest(d,a.type,null),this.emit("add-flag-complete",{type:b}),null}catch(c){return this.emit("add-flag-error",{type:b}),"barrier"===b?"barrier":"starting-point"}}))).filter(a=>!a)}async addResultAreaToMap(a,b){this.view&&((a.resultArea.show=
!0,b)?(this._resultAreaHandler?.addResultAreaToMap(b,this.view.map),this.emit("add-result-area",{graphic:b})):a.results&&(b=await this.createResultAreaGraphic(a))&&(a.resultAreaGraphic=b,this._resultAreaHandler?.addResultAreaToMap(b,this.view.map),this.emit("add-result-area",{graphic:b})))}async addResultGraphicToView(a,b){const {view:d}=this,{results:c}=a;if(d&&c&&this.utilityNetwork)for(const f in c.aggregatedGeometry)if("line,multipoint,polygon".includes(f)){var e=c.aggregatedGeometry[f];if(null!=
e){e.spatialReference=this.utilityNetwork.spatialReference;a.graphicEnabled=!0;e=await this._geometryHandler.projectGeometry(e,d.spatialReference);const g={globalid:a.trace.globalId};null!==e&&(e=this.graphicHandler.makeGraphic(e,b.color,g,d.spatialReference),this._getGraphicLayer(q)?.add(e))}}}addTerminal(a,b){const d=[...this._flags];d.forEach(c=>{c.globalId===b.globalId&&(b.selectedTerminals?.includes(parseInt(a,10))||c.selectedTerminals?.push(parseInt(a,10)))});this._flags=d}async callTrace(){const a=
this.traces.filter(b=>b.selected);return 0<a.length?(0<this.traceResults.length&&this.traceResults.forEach(b=>{this.removeResultGraphicFromView(b)}),this.traceResults=[],this.removeSelection(),await Promise.all(a.map(async(b,d)=>{const c=new N({gdbVersion:this.utilityNetwork?.gdbVersion,moment:this.utilityNetwork?.historicMoment,namedTraceConfigurationGlobalId:b.globalId,outSpatialReference:null,resultTypes:null,traceType:b.traceType,traceLocations:this._flags,traceConfiguration:null});await this.executeTrace(b,
this.utilityNetwork?.networkServiceUrl,c).then(e=>{if(e.hasOwnProperty("results")){const g={...e};if(null!==g.results){g.resultArea={...this.resultAreaProperties};e=[...g.results.elements];g.results.elements.length=0;const m=new Map;for(var f of e)m.has(f.globalId)||(m.set(f.globalId,!0),g.results.elements.push(f));e=[...this.traceResults];e.splice(d,0,g);this.traceResults=e;null!==g.results&&(this.selectOnComplete&&this.mergeSelection(!0,g.trace),this.showGraphicsOnComplete&&this.addResultGraphicToView(g,
g.graphicColor),this.enableResultArea&&this.createResultAreaGraphic(g).then(n=>{n&&(g.resultAreaGraphic=n,g.resultArea?.show&&this.addResultAreaToMap(g,g.resultAreaGraphic))}))}else f=[...this.traceResults],f.splice(d,0,e),this.traceResults=f;this._activeProgress=!1}else this._activeProgress=!1,f=[...this.traceResults],f.splice(d,0,e),this.traceResults=f}).catch(e=>{this._activeProgress=!1;throw e;})})),!0):!1}changeResultAreaColor(a,b){a.resultArea&&(a.resultArea.color=b,b=this._resultAreaHandler?.changeResultAreaColor(a.trace.globalId,
b,this.view.map),a.resultAreaGraphic&&(a.resultAreaGraphic.symbol=b))}changeResultGraphicColor(a,b){const d=[...this.traceResults];0<d.length&&d.forEach(c=>{c.trace.globalId===b.trace.globalId&&(c.graphicColor=a,c.graphicEnabled=!0)});this.traceResults=d;this.removeResultGraphicFromView(b);this.addResultGraphicToView(b,a)}changeFlagSymbol(a,b){0<this._flags.length&&this._flags.forEach(d=>{d.type===a&&b&&d.mapGraphic&&(d.mapGraphic.symbol=b)})}checkCanTrace(){const a={status:!0,issues:[]};let b=!1;
const d=this._flags.some(e=>"starting-point"===e.type);var c=this._flags.filter(e=>null!==e.allTerminals);0<c.length&&(b=c.some(e=>0>=e.selectedTerminals.length));c=[];d?(c=this.traces.filter(e=>e.selected),0>=c.length?(a.status=!1,a.issues=["noTrace"],b&&(a.status=!1,a.issues=["noTrace","noTerminalSelected"])):b&&(a.status=!1,a.issues=["noTerminalSelected"])):(c=this.traces.filter(e=>!0===e.selected),0<c.length?(a.status=!1,a.issues=["noStart"],b&&(a.status=!1,a.issues=["noStart","noTerminalSelected"])):
(a.status=!1,a.issues=["noStart","noTrace"],b&&(a.status=!1,a.issues=["noStart","noTrace","noTerminalSelected"])));return a}checkSelectionExist(){return this._highlightHandler.some(a=>a)}clearResult(a){if(this.view){var b=this.traceResults;if(0<b.length){const d=b.filter(c=>c.trace.globalId===a.globalId);0<d.length&&(this.removeResultGraphicFromView(d[0]),this.removeResultAreaFromMap(d[0]));b=b.filter(c=>c.trace.globalId!==a.globalId)}this.traceResults=b;0===b.length?(this.removeAllResultAreaGraphics(),
this.removeSelection(),this.emit("clear-selection",{resultSet:[]})):this.mergeSelection(!1,a)}}createResultAreaGeometries(a,b,d){if(this.view&&this.resultAreaProperties&&(b="convexhull"===this.resultAreaProperties?.type?1===b.length&&(r.isPoint(b[0])||r.isMultipoint(b[0])&&1===b[0].points.length)?this._resultAreaHandler?.createBuffer(b,d,a.resultArea?.unit,!0):this._resultAreaHandler?.createConvexHull(b,a.resultArea?.distance,a.resultArea?.unit):this._resultAreaHandler?.createBuffer(b,d,a.resultArea?.unit,
!0)))if(Array.isArray(b))for(var c of b){if(b=this.getResultAreaAttributes(a,c),b=this._resultAreaHandler?.createResultAreaGraphic(c,b,a.resultArea?.areaUnit,this.messages,this.messagesUnits,a.resultArea?.color))return b}else return c=this.getResultAreaAttributes(a,b),this._resultAreaHandler?.createResultAreaGraphic(b,c,a.resultArea?.areaUnit,this.messages,this.messagesUnits,a.resultArea?.color)}async createResultAreaGraphic(a){if(a.results){const b=await this._createResultAreaInputGeometry(a.results);
if(0<b.length){const d=Array(b.length).fill(a.resultArea?.distance);a=this.createResultAreaGeometries(a,b,d);this.emit("create-result-area",{graphic:a});return a}}}executeTrace(a,b,d){const c=this._processFlags(d.traceLocations);d.traceLocations=c;return M.trace(b,d,{timeout:this._traceTimeout}).then(e=>({trace:a,results:e,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:"success",date:new Date})).catch(e=>({trace:a,results:null,selectionEnabled:!1,graphicEnabled:!1,
graphicColor:this.defaultGraphicColor,status:e.message,date:new Date}))}getResultAreaAttributes(a,b){const {messages:d}=this,c=[],e=[];this._flags.forEach(f=>{const g=f.displayValue?.field+":"+f.displayValue?.value+";"+d.attributeStrings.globalid+":"+f.globalId+";"+d.attributeStrings.terminalid+":"+f.terminalId+";"+d.attributeStrings.x+":"+f.mapPoint?.x+";"+d.attributeStrings.y+":"+f.mapPoint?.y;"starting-point"===f.type?c.push(g):e.push(g)});return{traceId:a.trace.globalId,traceName:a.trace.title,
traceDescription:a.trace.description??"",startingPoints:c.toString(),barriers:e.toString(),version:(this.utilityNetwork?this.utilityNetwork.gdbVersion:this.gdbVersion)??void 0,username:A.id.credentials[0].userId,date:a.date,elementCount:a.results?.elements.length,functionResult:JSON.stringify(a.results?.globalFunctionResults),areaStatistic:b?this._geometryHandler.calculateArea(b,a.resultArea?.areaUnit):0}}getValidSources(){let a=[];const b=this.utilityNetwork?.dataElement?.domainNetworks??[];for(const d of b)a=
a.concat(d.junctionSources),a=a.concat(d.edgeSources);return a}groupResultsByNetworkSource(a){return 0===a.length?[]:this._groupBy(a,"networkSourceId")}async loadUtilityNetwork(){var {view:a}=this;if(!a)return null;await a.when();if(this.utilityNetwork){this.utilityNetwork.loaded||await this.utilityNetwork.load();if(this.utilityNetwork instanceof I){try{await a.map.loadAll(),this._loadUNSupportItems()}catch(d){this._loadUNSupportItems()}return this.utilityNetwork}return null}a=a.map;const b=a.utilityNetworks?.at(0);
if(b){await b.load();this.utilityNetwork=b;if(!await R(b))throw new v("utility-network:no-user-type-extension","User type extension not found");try{await a.loadAll(),this._loadUNSupportItems()}catch(d){}finally{this._loadUNSupportItems()}return b}return null}manageFilterBarrier(a,b){const d=[...this._flags];d.forEach(c=>{c.globalId===b.globalId&&"barrier"===b.type&&c.id===b.id&&(c.isFilterBarrier=a)});this._flags=d}mergeSelection(a,b){let d=[];const c=[...this.traceResults],e=b.globalId;c.forEach(f=>
{e===f.trace.globalId&&(f.selectionEnabled=a);f.selectionEnabled&&null!==f.results?.elements&&(d=[...d,...(f.results?.elements??[])])});this.selectResults([...(new Set(d))])}async queryFeaturesById(a){const {view:b}=this;if(!b||!this.utilityNetwork)return null;const d=this.utilityNetwork.getObjectIdsFromElements(a),c={layerUrl:d[0].layerUrl,objectIds:d[0].objectIds,outFields:["*"]},e=b.map?.allTables.toArray().filter(f=>f?.parsedUrl?.path===d[0].layerUrl).filter(y.isFeatureLayer)??[];this._getUniqueMapLayerViews(b).filter(({layer:f})=>
f?.parsedUrl?.path===d[0].layerUrl).forEach(({layer:f})=>{"feature"!==f.type&&"subtype-group"!==f.type||e.push(f)});a=(await Promise.all(e.map(async f=>{f={layers:new B([f]),layerInfos:[c],returnGeometry:!0,outSpatialReference:b.spatialReference};[f]=await J.getFeaturesFromLayers(f,!1);return f}))).filter(({featureSet:f})=>0<f.features.length);return 0<a.length?a:null}queryFlagByHitTest(a,b,d){return this._lookupFlagByHit(a).then(c=>{const {view:e}=this;if(!e)return!1;if(0<c.length){const f=[...this._flags];
c.forEach(g=>{g=g.graphic;const m=g.attributes.hasOwnProperty("GLOBALID")?g.attributes.GLOBALID:g.attributes.globalid;if(0>=f.filter(S=>S.globalId===m).length){var n=this.graphicHandler.getFlagGraphic(g.attributes.mapPoint,b,g,d);this._getGraphicLayer(p)?.add(n);g=this._createFlagProperty(g,b,n);f.push(g)}else null!==g.attributes.percentAlong&&(n=this.graphicHandler.getFlagGraphic(g.attributes.mapPoint,b,g,d),this._getGraphicLayer(p)?.add(n),g=this._createFlagProperty(g,b,n),f.push(g))});this._flags=
f;return!0}return!1})}removeResultGraphicFromView(a){var {view:b}=this;b&&(b=this._getGraphicLayer(q)?.graphics,a.graphicEnabled=!1,b?.filter(d=>d.attributes[d.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===a.trace.globalId)?.forEach(d=>{this._getGraphicLayer(q)?.remove(d)}))}removeFlag(a){const b=this._flags.filter(d=>{if(d.id!==a.id)return d});this._removeGraphic(a);this._flags=b}removeAllResultAreaGraphics(){this._resultAreaHandler?.removeAllResultAreaGraphics(this.view.map)}removeResultAreaFromMap(a){a.resultArea&&
(a.resultArea.show=!1,(a=this._resultAreaHandler?.removeResultArea(a.trace.globalId,this.view?.map))&&this.emit("remove-result-area",{graphic:a}))}removeSelection(){this._highlightHandler.forEach(a=>{a&&a.remove()});this._highlightHandler=[]}removeTerminal(a,b){const d=[...this._flags];d.forEach(c=>{if(c.globalId===b.globalId&&b.selectedTerminals?.includes(parseInt(a,10))){const e=b.selectedTerminals.indexOf(parseInt(a,10));c.selectedTerminals?.splice(e,1)}});this._flags=d}removeFlagsOnLoadWatcher(){this._watchHandler&&
null!==this._watchHandler&&this._watchHandler.remove()}removeClickHandler(){this._clickHandler&&(this._sketchViewModel.cancel(),this._clickHandler.remove())}reset(){this._flags=[];this.traceResults=[];const a=[...this.traces];a.forEach(b=>{b.selected=!1});this.traces=a;this.view&&(this._getGraphicLayer(q)?.removeAll(),this._getGraphicLayer(p)?.removeAll(),this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}),this.emit("reset"))}selectFeaturesById(a){const {view:b}=
this;if(b&&this.utilityNetwork){var d=this.utilityNetwork.getObjectIdsFromElements(a);this._getUniqueMapLayerViews(b).forEach(c=>{"layer"in c&&c.layer?.parsedUrl?.path===d[0].layerUrl&&("feature"===c.layer.type||"subtype-group"===c.layer.type)&&this._highlightHandler.push(c.highlight(d[0].objectIds))})}}selectResults(a){if(0<a.length){this.removeSelection();a=this.groupResultsByNetworkSource(a);const b=[];for(const d in a)this.selectFeaturesById(a[d]),b.push(this.queryFeaturesById(a[d]));Promise.all(b).then(d=>
{this.emit("select-features",{resultSet:d})})}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})}selectTraces(a,b){const d=[...this.traces];d.forEach(c=>{b===c.globalId&&(c.selected=a)});this.traces=d}selectTracesOnLoad(){this.utilityNetwork?.hasOwnProperty("sharedNamedTraceConfigurations")&&(this.traces=[...this.utilityNetwork.sharedNamedTraceConfigurations],this.traces.forEach(a=>{a.selected=!1;this.selectedTraces.includes(a.globalId)&&(a.selected=!0)}))}zoomToAsset(a){this.view?.goTo(a).catch(b=>
console.error(b))}async _createResultAreaInputGeometry(a){if(null!=a.aggregatedGeometry)return this._geometryHandler.mergeAggregatedToGeometries(a.aggregatedGeometry);a=this.groupResultsByNetworkSource(a.elements);const b=[];for(var d in a)b.push(this.queryFeaturesById(a[d]));try{const c=await Promise.all(b);d=[];for(const e of c)if(e)for(const f of e)for(const g of f.featureSet.features)g.geometry&&d.push(g.geometry);return d}catch{return[]}}_loadUNSupportItems(){if(this.utilityNetwork){var {map:a}=
this.view,{messages:b}=this;this._populateOutfields();this._createGraphicLayer(p);this._createGraphicLayer(q);this._resultAreaHandler?.createGraphicLayer(a,b?.alertsStrings.genericResultHeader);this._validUNLayers=this._utilityHelper.getValidUtilityNetworkLayers(a,this.utilityNetwork);this._sketchViewModel=this.graphicHandler.initializeSketch(this.view,this._getGraphicLayer(p),this._validUNLayers)}}_getUniqueMapLayerViews(a){const b=[],d=c=>{for(const e of c.layerViews)void 0!==e.layerViews?d(e):
b.push(e)};a.layerViews.filter(({layer:{type:c}})=>"feature"===c||"group"===c||"subtype-group"===c).toArray().forEach(c=>{switch(c.layer.type){case "group":void 0!==c.layerViews&&d(c);break;case "subtype-group":b.push(c);break;default:b.some(e=>e.layer.id===c.layer.id)||b.push(c)}});return b}_processFlags(a){const b=[];a.forEach(d=>{if(null!==d.selectedTerminals&&0<d.selectedTerminals.length)d.selectedTerminals.forEach(c=>{c=new t({globalId:d.globalId,percentAlong:d.percentAlong,terminalId:c,type:d.type,
isFilterBarrier:d.isFilterBarrier});b.push(c)});else{const c=new t({globalId:d.globalId,percentAlong:d.percentAlong,type:d.type,isFilterBarrier:d.isFilterBarrier});b.push(c)}});return b}_getDisplayField(a){return"subtype-sublayer"===a?.layer?.type?this._getDisplayFieldBySublayer(a):this._getDisplayFieldByFeatureLayer(a)}_getDisplayFieldBySublayer(a){let b="",d="";const c=a.layer;b=this._checkParentForData(c,"displayField");for(const e in a.attributes){const f=e.toLowerCase();f===b?.toLowerCase()?
(d=a.attributes[e],"assetgroup"===f||"assettype"===f?d=this._checkSubtype(c,c.subtypeCode):(d=this._checkDomain(c.fields,e,d),"string"===typeof d&&(d=this._defaultDisplayField(d,c)))):(d=this._checkDomain(c.fields,e,d),"string"===typeof d&&(d=this._defaultDisplayField(d,c)))}return{field:b,value:d.toString()}}_getDisplayFieldByFeatureLayer(a){const b=a.layer;let d=b.displayField;var c="";for(const e in a.attributes){const f=e.toLowerCase();f===d?.toLowerCase()?(c=a.attributes[e],"assetgroup"===f||
"assettype"===f?((c=a.attributes[b.typeIdField.toUpperCase()])||(c=a.attributes[b.typeIdField.toLowerCase()]),d=b.typeIdField,c=this._checkSubtype(b,c),""===d&&(b.templates&&0<b.templates.length?(d=b.templates[0]?.name,c=b.templates[0]?.name):(d=b.displayField,c=a.attributes[e]))):(c=this._checkDomain(b.fields,e,c),"string"===typeof c&&(c=this._defaultDisplayField(c,b)))):(c=this._checkDomain(b.fields,e,c),"string"===typeof c&&(c=this._defaultDisplayField(c,b)))}return{field:d,value:c?c.toString():
""}}_checkSubtype(a,b){let d=b;"subtype-sublayer"===a.type?(a=this._checkParentForData(a,"subtypes"),0<a?.length&&a.forEach(c=>{c.code===b&&(d=c.name)})):null!=a.types&&0<a.types.length&&(a=a.types.filter(c=>c.id===b),0<a.length&&(d=a[0].name));return d}_checkDomain(a,b,d){let c=d;a=a.filter(e=>e.name.toLowerCase()===b.toLowerCase());0<a.length&&a[0].domain instanceof H&&a[0].domain?.codedValues&&(a=a[0].domain.codedValues.filter(({code:e})=>e===d),0<a.length&&(c=a[0].name));return c}_checkParentForData(a,
b){return a.parent?.[b]??null}_defaultDisplayField(a,b){return a.trim()?a:b.templates&&0<b.templates?.length?b.templates[0].name:b.title}get _uniqueFlagId(){return this._flagId++}_groupBy(a,b){return a.reduce((d,c)=>{(d[c[b]]=d[c[b]]||[]).push(c);return d},{})}async _lookupFlagByHit(a){var b=a.graphic?.geometry;const d=[];if(b&&r.isPoint(b)&&this.view&&(b=this.view.toScreen(b))&&(b=await this.view.hitTest(b,{include:this._validUNLayers}))&&0<b.results.length&&(b=b.results.find(e=>null!==e.layer),
null!=b.graphic?.geometry))if("polyline"===b.graphic.geometry.type){a=this._geometryHandler.getPercentageAlong(b.graphic.geometry,a.graphic?.geometry,b.graphic.geometry.spatialReference);var c=this._getDisplayField(b.graphic);b.graphic.attributes={...b.graphic.attributes,terminalId:null,isFilterBarrier:!1,allTerminals:null,selectedTerminals:null,percentAlong:a,displayValue:c,mapPoint:b.mapPoint};d.push(b)}else"point"!==b.graphic.geometry.type&&"polygon"!==b.graphic.geometry.type||null===this.utilityNetwork||
(a=this.utilityNetwork?.getTerminalConfiguration(b.graphic),c=this._getDisplayField(b.graphic),b.graphic.attributes={...b.graphic.attributes,terminalId:a?a.terminals[0].id||null:1,isFilterBarrier:!1,allTerminals:a??null,selectedTerminals:[a?a.terminals[0].id||null:1],percentAlong:null,displayValue:c,mapPoint:b.mapPoint},d.push(b));return d}_createFlagProperty(a,b,d){const c=new t;c.terminalId=a.attributes.terminalId;c.isFilterBarrier=a.attributes.isFilterBarrier;c.percentAlong=a.attributes.percentAlong;
c.globalId=a.attributes.globalid||a.attributes.GLOBALID;c.type=b;c.details=a;c.mapGraphic=d;c.id=this._uniqueFlagId;c.allTerminals=a.attributes.allTerminals;c.selectedTerminals=a.attributes.selectedTerminals;c.displayValue=a.attributes.displayValue;c.mapPoint=a.attributes.mapPoint;return c}async _populateOutfields(){if(this.view){var {map:a}=this.view,b=this.getValidSources(),d=c=>{"group"===c.type?c.layers.forEach(e=>{z(e)&&d(e)}):b.some(e=>e.layerId===c.layerId)&&c.fields.some(e=>"assetgroup"===
e.name.toLowerCase())&&(c.outFields=["assetgroup","assettype","globalid","objectid"])};for(const c of a.layers)z(c)&&d(c)}}_removeGraphic(a){this._getGraphicLayer(p)?.remove(a.mapGraphic)}_createGraphicLayer(a){const {map:b}=this.view;b.findLayerById(a)||(a=new G({title:a,listMode:"hide",id:a}),b.add(a))}_getGraphicLayer(a){const {map:b}=this.view;return b&&(a=b.findLayerById(a))&&"graphics"===a.type?a:null}};k.__decorate([l.property()],h.prototype,"_activeProgress",void 0);k.__decorate([l.property()],
h.prototype,"_flags",void 0);k.__decorate([l.property()],h.prototype,"traces",void 0);k.__decorate([l.property()],h.prototype,"defaultGraphicColor",void 0);k.__decorate([l.property()],h.prototype,"enableResultArea",void 0);k.__decorate([l.property()],h.prototype,"flags",void 0);k.__decorate([l.property()],h.prototype,"gdbVersion",void 0);k.__decorate([l.property()],h.prototype,"messages",void 0);k.__decorate([l.property()],h.prototype,"messagesUnits",void 0);k.__decorate([l.property()],h.prototype,
"resultAreaProperties",null);k.__decorate([l.property()],h.prototype,"selectedTraces",void 0);k.__decorate([l.property()],h.prototype,"selectOnComplete",void 0);k.__decorate([l.property()],h.prototype,"showGraphicsOnComplete",void 0);k.__decorate([l.property()],h.prototype,"showSelectionAttributes",void 0);k.__decorate([l.property({readOnly:!0})],h.prototype,"state",null);k.__decorate([l.property()],h.prototype,"traceResults",void 0);k.__decorate([l.property()],h.prototype,"utilityNetwork",void 0);
k.__decorate([l.property({value:null})],h.prototype,"view",null);return h=k.__decorate([E.subclass("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],h)});