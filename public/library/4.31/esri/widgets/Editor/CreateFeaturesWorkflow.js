// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require ../../chunks/tslib.es6 ../../Graphic ../../core/arrayUtils ../../core/Error ../../core/handleUtils ../../core/has ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/uuid ../../core/accessorSupport/decorators/property ../../core/Logger ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../../layers/support/layerUtils ../../views/draw/support/helpMessageUtils ../../views/input/InputManager ../../views/interactive/sketch/SketchOptions ../../views/interactive/snapping/FeatureSnappingLayerSource ./CreateFeaturesWorkflowData ./modelUploadUtils ./Workflow ./workflowUtils ../FeatureForm/FeatureFormViewModel ../Sketch/SketchViewModel".split(" "),
function(O,t,P,I,Q,w,p,C,R,z,J,v,ha,S,T,G,U,V,W,X,Y,D,Z,x,aa,ba){function ca(a,b){let c=null;const e=()=>{null!=c&&(a.snappingOptions.featureSources.remove(c),c=C.destroyMaybe(c))};return w.handlesGroup([z.watch(()=>{const f=b.creationInfo?.layer,g=a.snappingOptions.featureSources.find(h=>h.layer===f);return{hasFeatureLayerSource:!!g,enabled:g?.enabled??!1}},({hasFeatureLayerSource:f,enabled:g})=>{if(f)null==c&&(c=new X({layer:a.layer}),a.snappingOptions.featureSources.add(c)),c.enabled=g;else return e()},
z.syncAndInitial),w.makeHandle(e)])}function da(a,b,c,e){const f=[];b.forEach((g,h)=>{if(!g.error){const q=a[h];h=e.get(q)||[];q.attributes[c.objectIdField]=g.objectId;h.forEach(({form:l})=>f.push({feature:q,attachment:l}))}});return f}function ea(a,b,c){const e=[],f=b.globalIdField;a.forEach((g,h)=>{let q;(q=a[h].attributes)[f]??(q[f]=J.generateBracedUUID());(c?.get(g)||[]).forEach(({file:l})=>e.push({feature:g,attachment:{globalId:J.generateBracedUUID(),data:l}}))});return e.length?{addFeatures:a,
addAttachments:e}:{addFeatures:a}}var E;const H=Symbol(),B=Symbol(),F=Symbol(),K=Symbol();p=E=class extends Z{constructor(a){super(a);this.type="create-features";this.createFeatureState="create-new";this.data=void 0;this.isNested=!1;this._getDrawMeshHelpMessage=void 0;this._featureFormHandle=null;this._visualVariableAttributes={rotation:null,size:null};this._featureFormViewModel=new aa;this._sketchViewModel=null;this._attachmentFileInfos=new Map;this._highlightHandles=new Map;this._preventDefaultActionOnCancel=
!1;this._lastActiveGraphics=[];this._isActive=!0;this._updateGraphicDebounced=R.debounce((b,c,e)=>x.updateGraphicSymbolWhenRequired(b,c,e))}initialize(){this.isNested&&(this._isActive=!1);this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(this.pendingFeatures.some(f=>!!this.data.getEditsForPendingFeature(f)?.modified))return!0;const {creationInfo:a,upload:b}=this.data;var c=this._sketchViewModel;
const {activeComponent:e}=c;c=c.createGraphic?.geometry?.type;return!("polyline"!==c&&"polygon"!==c&&"multipoint"!==c||"draw-2d"!==e?.type&&"draw-3d"!==e?.type)&&0<e.drawOperation.committedVertices.length||b&&("pending"===b.state||"success"===b.state)||a?.geometryToPlace?!0:!1}get helpMessage(){const {creationInfo:a,viewModel:b}=this.data;if("creating-features"===this.stepId&&a){var c=a.layer.geometryType,e=this._sketchViewModel.createGraphic;return"mesh"===c?(this._getDrawMeshHelpMessage||(new Promise((f,
g)=>O(["../../views/draw/support/helpMessageUtils3d"],f,g))).then(f=>{this._getDrawMeshHelpMessage=f.getDrawMeshHelpMessage}),{view:c}=b,"3d"===c?.type?this._getDrawMeshHelpMessage?.(e,c):void 0):U.getDrawHelpMessage(c,e?.geometry)}}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===
this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){return this.data.editorItem?.capabilities.create.reliesOnOwnerAdminPrivileges??!1}get shouldShowAttachments(){return this.data.editorItem?.capabilities.create.attachments.enabled??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}async enter(){this._isActive=!0;"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=
!1;this.removeHandles([F])}async updatePendingFeature(a,b){this._preventDefaultActionOnCancel=!0;this._sketchViewModel.cancel();I.remove(this._lastActiveGraphics,a);return this._startUpdating({feature:a,webStyleCache:b})}async start(){await super.start();return G.isTable(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}static create(a){const {addAttachmentsCallback:b,applyEditsCallback:c,isNested:e,creationInfo:f,parent:g,snappingManager:h,startAt:q,
viewModel:l}=a;a=a.sketchOptions??new W;var n=f?.layer;n=n?l.findEditorItemForLayer(n):void 0;const y=new E({data:new Y.CreateFeaturesWorkflowData({creationInfo:f,editorItem:n,parent:g,sketchOptions:a,snappingManager:h,viewModel:l}),isNested:e,onCommit:async k=>{var {creationInfo:d}=k;if(d){k=k.pendingFeatures.toArray();({layer:d}=d);var u=y._attachmentFileInfos;if(d.capabilities?.editing.supportsGlobalId&&"globalIdField"in d)k=ea(k,d,u),await c(d,k,{globalIdUsed:!0});else{var m=await c(d,{addFeatures:k});
0<u.size&&await b(d,da(k,m?.addFeatureResults??[],d,u))}}}});y._set("steps",this._createWorkflowSteps(y,q));return y}_fadeExistingFeatures(a){if("effect"in a){const c=a.effect;a.effect="saturate(0.6) opacity(0.8)";return w.makeHandle(()=>a.effect=c)}const b=a.opacity;a.opacity=.7;return w.makeHandle(()=>a.opacity=b)}_highlight(a){const b=this.data.viewModel.view;"3d"===b?.type&&this._highlightHandles.set(a,b.highlight(a))}_removeHighlight(a){C.removeMaybe(this._highlightHandles.get(a));this._highlightHandles.delete(a)}async _startCreating(a){this.removeHandles(B);
const {creationInfo:b}=this.data;b&&(this.createFeatureState="create-new",a=await x.startCreatingNewFeature(this._sketchViewModel,b,a),this.addHandles(a,B))}async _startUpdating({feature:a,webStyleCache:b,initialFeature:c=a}){const {data:e,pendingFeatures:f}=this;f.includes(a)||e.addPendingFeature(a,c);const {_featureFormViewModel:g,_sketchViewModel:h}=this,{creationInfo:q,viewModel:l}=e,{attachmentsViewModel:n,layerInfos:y,view:k}=l;if(k&&q){c=q.layer;var d=x.findLayerInfo(y,c);g.set({arcadeEditType:"INSERT",
feature:a,formTemplate:d?.formTemplate,spatialReference:k.spatialReference,map:k.map});"add"!==n.mode&&"edit"!==n.mode||l.activeWorkflow?.previous();n.graphic=a;n.fileInfos.removeAll();n.mode="view";(this._attachmentFileInfos.get(a)||[]).forEach(({file:m,form:r})=>n.addFile(m,r));this._removeHighlight(a);await x.updateGraphicSymbolWhenRequired(a,b,"2d"===k.type?k.scale:null);this.removeHandles(B);C.removeMaybe(this._featureFormHandle);"2d"===k.type&&(d=z.watch(()=>k.scale,m=>this._updateGraphicDebounced(a,
b,m)),this.addHandles(d,B));var u=e.getEditsForPendingFeature(a);this._featureFormHandle=w.handlesGroup([g.on("value-change",async()=>{u?.updateAttributes(g.getValues());await x.updateGraphicSymbolWhenRequired(a,b,"2d"===k.type?k.scale:null)}),h.on(["update","undo","redo"],m=>{("undo"===m.type||"redo"===m.type||"update"===m.type&&null!=m.toolEventInfo&&x.isTerminalUpdateEventType(m.toolEventInfo.type))&&g.notifyFeatureGeometryChanged()}),z.watch(()=>g.feature?.sourceLayer,m=>a.sourceLayer=m)]);this.createFeatureState=
"update-pending";this._visualVariableAttributes=x.getVisualVariableAttributes(a);if(!G.isTable(c))return x.startUpdatingFeature({graphic:a,sketchViewModel:h,sourceLayer:c,visualVariables:this._visualVariableAttributes,webStyleCache:b})}}static _createWorkflowSteps(a,b="awaiting-feature-creation-info"){const {data:c}=a;b=x.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],b,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",
async setUp(){const {creationInfo:e,viewModel:f}=c,{view:g}=f;g&&(D.isModelUpload(e)?a.addHandles(await D.handleModelUpload({view:g,data:c,next:()=>a.next(),cancel:()=>f.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(c.parent&&e&&(a.addHandles(f.lockFeatureTemplatesViewModel(),this.id),f.featureTemplatesViewModel.layers=[e.layer]),a.addHandles(f.featureTemplatesViewModel.on("select",({item:h})=>{h&&(c.creationInfo={...c.creationInfo,layer:h.layer,template:h.template},a.next())}),this.id)))},async tearDown(){a.removeHandles([this.id,
B])}}),"creating-features":()=>({id:"creating-features",async setUp(){a._isActive&&await a._setUpCreatingFeaturesStep()},async tearDown(e){const {viewModel:f}=c;e.canceled&&(a.removeHandles([F,H,B,K]),f.attachmentsViewModel.fileInfos.removeAll(),a._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const {attachmentsViewModel:e}=c.viewModel,{graphic:f,fileInfos:g}=e;a._attachmentFileInfos.set(f,g.toArray());
e.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const {attachmentsViewModel:e}=c.viewModel,{graphic:f,fileInfos:g}=e;a._attachmentFileInfos.set(f,g.toArray());e.mode="view"}})});return x.avoidFeatureTemplateSelectionWithOnlyOneItem(c,b)}static _configureSketchViewModel(a,b){const {data:c}=a,{creationInfo:e,viewModel:f}=c,{view:g}=f,h=a._sketchViewModel;let q=null;var l=[];if(!g)return w.makeHandle();"2d"===g.type&&e&&
l.push(a._fadeExistingFeatures(e.layer));const n=async d=>{if("cancel"===d.state){if(a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}if(null==g.activeTool){if(1>a._lastActiveGraphics.length)return a._startCreating(b);d=a._lastActiveGraphics.pop();return a._startUpdating({feature:d,webStyleCache:b})}return a._waitForActiveToolCleared().then(()=>a._startCreating(b))}if("complete"===d.state&&d.graphic){const u=d.graphic.clone();u.geometry=null;return a._startUpdating({feature:d.graphic,
webStyleCache:b,initialFeature:u})}},y=async d=>{var {attachmentsViewModel:u}=f;const {_featureFormViewModel:m}=a;var r=d.graphics[0];if("complete"===d.state){r!==q&&(a._lastActiveGraphics.push(r),a._highlight(r));q=null;const {hasPendingSubtypeChoice:fa,submittable:L}=m;if(a.numPendingFeatures===e?.maxFeatures||fa||!L){!L&&m.submit();const A=a._lastActiveGraphics.pop();return null===f.view?.activeTool?a._startUpdating({feature:A,webStyleCache:b}):a._waitForActiveToolCleared().then(()=>a._startUpdating({feature:A,
webStyleCache:b}))}"add"!==u.mode&&"edit"!==u.mode||f.activeWorkflow?.previous();if(d.aborted&&a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}a.addHandles([x.showProgressCursor(g),g.on("click",A=>A.preventDefault())],H);await z.whenOnce(()=>!m.updating);a.removeHandles(H);if(null==f.view?.activeTool)a._startCreating(b);else return a._waitForActiveToolCleared().then(()=>{const A=a._lastActiveGraphics.pop();if(A)return a._startUpdating({feature:A,webStyleCache:b})})}"start"===
d.state&&a._removeHighlight(r);u=a._visualVariableAttributes;await x.visualVariableInteractiveUpdate(g,r,d,u,b);d=r.attributes;const {rotation:M,size:N}=u;null!=M&&({field:r}=M,m.setValue(r,d[r]));null!=N&&({field:r}=N,m.setValue(r,d[r]))},k=async d=>{if(!D.isModelUpload(e)&&({results:d}=await g.hitTest(d,{include:h.layer}),d=d.find(r=>"graphic"===r.type&&r.graphic.sourceLayer===e?.layer))&&(d=d.graphic,("transform"===h.activeTool||"reshape"===h.activeTool)&&h.updateGraphics.at(0)!==d)){var {submittable:u,
hasPendingSubtypeChoice:m}=a._featureFormViewModel;u&&!m&&await a.updatePendingFeature(d,b)}};l.push(h.on("create",d=>a._updatingHandles.addPromise(n(d))),h.on("update",d=>a._updatingHandles.addPromise(y(d))),h.on("delete",d=>{d=d.graphics[0];c.removePendingFeature(d);I.remove(a._lastActiveGraphics,d);q=d}),g.on("immediate-click",d=>a._updatingHandles.addPromise(k(d)),V.ViewEventPriorities.TOOL),w.makeHandle(()=>{a._preventDefaultActionOnCancel=!0;h.cancel()}),ca(h,c));l=w.handlesGroup(l);h.addHandles(l);
return l}_initializeSketchViewModel(){const {data:a}=this,{view:b}=a.viewModel,c=new T({elevationInfo:a.creationInfo?.layer.elevationInfo,internal:!0,listMode:"hide"});this._sketchViewModel=new ba({layer:c,sketchOptions:a.sketchOptions,snappingManager:a.snappingManager,updateOnGraphicClick:!1,view:b});b?.map.add(c);this.addHandles(w.makeHandle(()=>{b?.destroyed||b?.map.remove(c);c.destroy()}))}async _setUpCreatingFeaturesStep(){if(!this.hasHandles(F)){var {data:a}=this,{creationInfo:b,viewModel:c}=
a,{attachmentsViewModel:e,view:f}=c;if(!f||!b?.layer)throw new Q("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");this._preventDefaultActionOnCancel=!1;var {initialFeature:g,layer:h}=b,q=this._sketchViewModel,l=new Map,n=[];this._lastActiveGraphics=[];this._featureFormHandle=C.removeMaybe(this._featureFormHandle);this._visualVariableAttributes={rotation:null,size:null};this.data.editorItem=c.findEditorItemForLayer(b.layer);x.prepareAttachmentsForCreateFeaturesWorkflow(e);
n.push(z.watch(()=>e.mode,d=>{switch(d){case "add":this.go("adding-attachment");break;case "edit":this.go("editing-attachment")}}));var y=x.showProgressCursor(f);n.push(y);var k=G.isTable(b.layer);try{if(k){const d=g??new P({attributes:{...b.template?.prototype.attributes,...b.attributeOverrides},sourceLayer:h});await this._startUpdating({feature:d,webStyleCache:l})}else n.push(E._configureSketchViewModel(this,l)),g?(q.layer.add(g),await this._startUpdating({feature:g,webStyleCache:l})):await this._startCreating(l)}finally{y.remove()}l=
w.makeHandle(()=>{for(const d of a.pendingFeatures)q.layer.remove(d),a.removePendingFeature(d)});y=z.watch(()=>f?.timeZone,d=>this._featureFormViewModel.timeZone=d,z.initial);k=w.makeHandle(()=>{D.isModelUpload(b)&&c.cancelWorkflow({warnIfNoWorkflow:!1})});this._featureFormHandle&&n.push(this._featureFormHandle);this.addHandles(n,this._handleKeys.beforeCommit);this.addHandles([w.makeHandle(()=>e.fileInfos.removeAll()),w.handlesGroup(n),k,l,y],F)}}async _waitForActiveToolCleared(){const a=this.data.viewModel.view;
if(null!=a?.activeTool){var b=new AbortController;this.addHandles(w.abortHandle(b),K);await z.whenOnce(()=>null==a?.activeTool,b.signal);b.abort()}}};t.__decorate([v.property()],p.prototype,"createFeatureState",void 0);t.__decorate([v.property()],p.prototype,"data",void 0);t.__decorate([v.property({constructOnly:!0})],p.prototype,"isNested",void 0);t.__decorate([v.property()],p.prototype,"featureFormViewModel",null);t.__decorate([v.property()],p.prototype,"hasPendingEdits",null);t.__decorate([v.property()],
p.prototype,"_getDrawMeshHelpMessage",void 0);t.__decorate([v.property()],p.prototype,"helpMessage",null);t.__decorate([v.property()],p.prototype,"layer",null);t.__decorate([v.property()],p.prototype,"parent",null);t.__decorate([v.property()],p.prototype,"parentLayer",null);t.__decorate([v.property()],p.prototype,"keyboardCancellationEnabled",null);t.__decorate([v.property()],p.prototype,"reliesOnOwnerAdminPrivileges",null);t.__decorate([v.property()],p.prototype,"shouldShowAttachments",null);t.__decorate([v.property()],
p.prototype,"shouldAllowAttachmentEditing",null);t.__decorate([v.property()],p.prototype,"sketchViewModel",null);return p=E=t.__decorate([S.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],p)});