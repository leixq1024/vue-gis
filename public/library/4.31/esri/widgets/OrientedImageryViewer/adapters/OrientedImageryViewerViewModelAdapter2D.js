// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../geometry ../../../Graphic ../../../core/arrayUtils ../../../core/Logger ../../../core/promiseUtils ../../../layers/orientedImagery/transformations/utils ../symbols ../../../geometry/Polygon".split(" "),function(D,n,y,z,p,A,q,x){class B{constructor(C){this.viewModel=C;this.createFootprints=async a=>{await p.waitTick(a);const {coveragePolygons:e,currentBestFeature:c,isAdditionalCoverageVisible:d}=this.viewModel;for(const b of e)b?.imageID===c.attributes.objectId?this.viewModel.bestFeatureFootprint=
new n({attributes:{imageID:b?.imageID},geometry:b,symbol:q.activePolygonSymbol,visible:!1}):this.viewModel.additionalFootprints.push(new n({attributes:{imageID:b?.imageID},geometry:b,symbol:q.polygonSymbol.clone(),visible:d}))};this.updateFootprint=async(a,e)=>{const {activeViewer:c,currentBestFeature:d,currentCoverageVisible:b,footprintExtent:t}=this.viewModel,r=c?.imageSize;if(d&&r&&t)try{const h=await this.viewModel.getMapPoint(a,{feature:d,mode:"default",imageSize:r});p.throwIfAborted(e);const f=
h.filter(y.isSome);if(f.length){var g=[f.map(({x:k,y:u})=>[k,u,1])];g[0].push(g[0][0]);var v=new x({rings:g,spatialReference:f[0].spatialReference});this.viewModel.updateCurrentCoveragePolygon(new n({geometry:v,attributes:{imageID:d.attributes.objectId},symbol:q.activePolygonSymbol,visible:b}))}}catch(h){p.isAbortError(h)||z.getLogger(this.viewModel).error("update-footprint",h)}else this.viewModel.updateCurrentCoveragePolygon(null)};this.updateFootprintPanorama=async(a,e)=>{const {horizontalFieldOfView:c,
pitch:d,verticalFieldOfView:b,yaw:t}=a,{activeViewer:r,currentBestFeature:g,currentCoverageVisible:v,footprintExtent:h}=this.viewModel,f=r?.imageSize;if(g&&f&&h){var {cameraPitch:k,objectId:u}=g.attributes;if(180<d+k-b/2)this.viewModel.updateCurrentCoveragePolygon(null);else{a=[];if(180>d+k+b/2)a=[[-c/2,b/2],[c/2,b/2],...(0>d-b/2?[[-c/2,-b/2],[c/2,-b/2]]:[[c/2,-b/2],[-c/2,-b/2]])];else if(180>d+k-b/2&&180<d+k+b/2){a=[[-c/2,-b/2]];const l=Math.floor(c/6),m=c/l;for(let w=0;w<=l;w++)a.push([w*m-c/2,
90-d]);a.push([c/2,-b/2]);0>d-b/2&&([a[0],a[a.length-1]]=[a[a.length-1],a[0]])}a=a.map(([l,m])=>A.convertOrientationToPixelLocation(t+l,d+m,f[0],f[1]));a=await this.viewModel.getMapPoint(a,{feature:g,mode:"panorama",imageSize:f});p.throwIfAborted(e);e=[a.map(({x:l,y:m})=>[l,m,1])];e[0].push(e[0][0]);e=new x({rings:e,spatialReference:a[0].spatialReference});this.viewModel.updateCurrentCoveragePolygon(new n({geometry:e,attributes:{imageID:u},symbol:q.activePolygonSymbol.clone(),visible:v}))}}else this.viewModel.updateCurrentCoveragePolygon(null)}}}
return B});