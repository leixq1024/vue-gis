// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../core/Logger ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../intl/date ../../intl/number ../../layers/support/editableLayers ../../layers/support/featureLayerUtils ../../layers/support/fieldUtils ../../smartMapping/support/utils ../../time/timeZoneUtils ../FeatureForm/FieldInput ./Grid/EditorColumn ./support/tableUtils ../support/dateUtils ../support/widgetUtils".split(" "),
function(g,x,h,f,J,C,v,w,D,E,q,y,z,F,G,A,p,t){const H=v.convertDateFormatToIntlOptions("short-date-short-time"),I=v.convertDateFormatToIntlOptions("short-date"),B={useGrouping:!0,maximumFractionDigits:20};f=class extends G{constructor(b){super(b);this._activeFieldInput=null;this.cellValueFormatFunction=({root:a,rowData:c,value:e})=>{var {formatFunction:k}=this;if(k&&c){const {index:d,item:{attachments:l,feature:m,relatedRecords:r}}=c;return k({attachments:l,column:this,feature:m,field:this.field,
index:d,relatedRecords:r,value:t.renderingSanitizer.sanitize(e),virtualIndex:this.getVirtualRowIndex(a)})}if(null===e)return"\x26nbsp;";({field:a}=this);return(c=this._getDomainForFeature(c?.item?.feature))?(k=this._getComputedDomain(e,c),"date"===a.type&&"range"===c.type?this._formatDateValueForDisplay(a,k):this._isNumericField&&"range"===c.type?(c=(c=this.template?.format)?w.convertNumberFormatToIntlOptions(c):B,w.formatNumber(parseFloat(e),c)):p.dateFieldsWithStringFieldValue.has(a.type)?"range"===
c.type?t.renderingSanitizer.sanitize(p.getLabelForDateFieldValue(a,k)):t.renderingSanitizer.sanitize(k):k):"date"===a.type||p.dateFieldsWithStringFieldValue.has(a.type)?this._formatDateValueForDisplay(a,e):this._isNumericField?(c=(c=this.template?.format)?w.convertNumberFormatToIntlOptions(c):B,w.formatNumber(parseFloat(e),c)):t.renderingSanitizer.sanitize(e)};this.cellValueValidatorFunction=({oldValue:a,value:c})=>{const {_effectiveRange:e,field:k}=this,{max:d,min:l}=e;return!this.effectiveRequired||
null!=c&&""!==c?!this._isNumericField||!q.validateFieldValue(k,c)&&p.valueIsInRange({max:d,min:l,value:c})?this._isAnyDateOrTimeField&&!p.dateTimeIsInRange({type:k.type,range:e,value:c})?!1:a!==c:(x.getLogger(this).warn("value-exceeds-valid-range","Field value exceeds valid range. Attempted edit was rejected."),!1):!1};this.formatFunction=this.field=null;this.inputRenderFunction=async({root:a,column:c,rowData:e})=>{if(!this.editInfo&&this.effectiveEditable){var k=this.getCellValue(e),{field:d}=this;
if("big-integer"===d.type&&q.validateFieldValue(d,k))x.getLogger(this).warn("value-exceeds-valid-range","Field value is beyond supported limit. Editing is disabled for this field value.");else if(d=e?.item.feature){this._activeFieldInput=this._setUpFieldInput(d,k);d=document.createElement("div");d.classList.add("esri-column__cell__input-container");var l=[],m="coded-value"===this._effectiveDomain?.type;if(this._isAnyDateOrTimeField&&!m){const r=document.createElement("div");m=this._setUpDateComponents(k);
const u=this._setUpDateActionBar();m.forEach(n=>r.appendChild(n));d.appendChild(r);d.appendChild(u);l.push(...m)}else m=this.createInputElement({value:k}),d.appendChild(m),l.push(m);this._set("editInfo",{column:c,inputs:l,root:a,rowData:e,oldValue:k});this.removeCellContent(a);a.appendChild(d);this._syncRowEditingState(a,!0);this.grid?.generateCellPartNames();a=l[0];await t.setFocus(a);"selectText"in a&&await a.selectText()}}};this.layer=null;this.parseInputValueFunction=({inputs:a})=>{const {editInfo:c,
field:e,includeTime:k}=this;if(!c||!a.length)return null;var d=a[0];if(this._isAnyDateOrTimeField){var {timeZone:l}=this.effectiveTimeZoneOptions;const m=c.oldValue??void 0;if("coded-value"===this._effectiveDomain?.type)return null!=d.value?parseFloat(d.value):null;switch(e.type){case "date-only":return d=d.value,""!==d?d:null;case "time-only":return d=p.normalizeTimeOnlyString(d.value),""!==d?d:null;case "timestamp-offset":const r=k?a[1]:void 0;a=a.at(-1);return p.getISOFieldValueFromDateComponents({oldValue:m,
dateComponent:d,timeComponent:r,timeZoneComponent:a,defaultTimeZone:l});case "date":const {max:u,min:n}=this._effectiveRange;return p.getUnixFieldValueFromDateComponents({oldValue:m,dateComponent:d,timeComponent:a[1],timeZone:l,max:u,min:n})}return null}d=d.value;({effectiveRequired:l}=this);return l||null!=d&&""!==d?this._isNumericField?parseFloat(d):this._isStringField?d.trim():d:null};this.sortable=!0;this.view=this.template=this.store=null}get _effectiveDomain(){const b=this._activeFieldInput?.feature;
return b?this._getDomainForFeature(b):null}get _effectiveRange(){return this._activeFieldInput?.range??{max:null,min:null}}get _isAnyDateOrTimeField(){const {field:b}=this;return y.isAnyDateField(b)||q.isTimeOnlyField(b)}get _isIntegerField(){return q.isIntegerField(this.field)}get _isNumericField(){return q.isNumericField(this.field)}get _isStringField(){return q.isStringField(this.field)}get _isSubtypeField(){const {layer:b}=this;if(b?.subtypeField){const {subtypeField:a,fieldsIndex:c}=b;return(c.get(a)?.name??
a)===this.fieldName}return!1}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get effectiveDescription(){const {description:b,field:a}=this;var c=a.description;c=A.isEmptyStringOrWhitespace(b)?A.isEmptyStringOrWhitespace(c)?null:c:b;return null==c?null:t.renderingSanitizer.sanitize(c)}get effectiveEditable(){const {editable:b,field:a,layer:c,tableEditingEnabled:e}=this;if(!a||!c)return!1;const k=D.isEditableLayer(c),d=c.effectiveCapabilities??c.capabilities;
return a.editable&&k&&d?.operations?.supportsUpdate&&"oid"!==a.type&&e?b:!1}get effectiveLabel(){return t.renderingSanitizer.sanitize(this.label||this.alias||this.fieldName)}get effectiveRequired(){return!this.nullable||this._isSubtypeField||this._activeFieldInput?.required||this.required}get effectiveTimeZoneOptions(){const {layer:b,field:a}=this;if(!b||"date"!==a?.type&&"timestamp-offset"!==a?.type)return{timeZone:void 0,timeZoneName:void 0};const {tableTimeZone:c,timeZone:e,view:k}=this;return z.getTimeZoneFormattingOptions(b.preferredTimeZone||
null,!!b.datesInUnknownTimezone,e??c??k?.timeZone??z.system,v.convertDateFormatToIntlOptions("short-time"),a.type)}get includeTime(){const {field:b,template:a}=this;return"time-only"===b.type?!0:"date-only"===b.type?!1:!a?.input||"includeTime"in a.input&&!1!==a.input.includeTime}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){const {field:b,template:a}=this,c=b?.length??-1,e=a?.input&&"maxLength"in a.input?a.input.maxLength:null;return null!=e&&!isNaN(e)&&-1<=e&&(-1===c||
e<=c)?e:c}get minLength(){const {template:b,maxLength:a}=this,c=b?.input&&"minLength"in b.input?b.input.minLength:null;return a&&c<=a?c:null}get name(){return this.field?.name}get nullable(){return!1!==this.field.nullable}get shouldShowPrompt(){return this._isSubtypeField}createInputElement({value:b}){const {_effectiveDomain:a,maxLength:c,minLength:e,effectiveRequired:k}=this;let d;if("coded-value"===a?.type)d=this.createCalciteSelect(b,a.codedValues.map(({code:l,name:m})=>({value:l,name:m}))),d.addEventListener("calciteSelectChange",
()=>this.onInputBlur(d));else if(this._isNumericField){const {_effectiveRange:{max:l,min:m}}=this;d=document.createElement("calcite-input");d.type="number";this._isIntegerField&&(d.step=1);null!=l&&(d.max=l);null!=m&&(d.min=m);d.status=p.valueIsInRange({max:l,min:m,value:b})?"idle":"invalid"}else d=document.createElement("calcite-input"),d.addEventListener("calciteInputChange",()=>this.onInputBlur(d)),-1<c&&(d.maxLength=c),0<e&&(d.minLength=e);d.classList.add("esri-column__cell-input");d.required=
k;d.value=b;d.onkeydown=l=>{if("Escape"===l.key)this.onInputBlur(d,!0)};d.onblur=()=>this.onInputBlur(d);return d}onEditComplete(){const b=this.editInfo?.root;b&&this._syncRowEditingState(b,!1);this._activeFieldInput=null;super.onEditComplete()}_clearActiveEditValues(){this.editInfo?.inputs?.forEach(b=>b.value="")}_setUpDateActionBar(){var {messagesCommon:b}=this;const a=b?.cancel??"",c=b?.clear??"";b=b?.save??"";const e=document.createElement("calcite-action-bar");e.expandDisabled=!0;e.layout="horizontal";
e.appendChild(this.createCalciteAction({text:b,icon:"save",onclick:()=>this.submit()}));this.effectiveRequired||e.appendChild(this.createCalciteAction({text:c,icon:"trash",onclick:()=>{this._clearActiveEditValues();this.submit()}}));e.appendChild(this.createCalciteAction({text:a,icon:"x",onclick:()=>this.cancel()}));return e}_formatDateValueForDisplay(b,a){const {timeZone:c,timeZoneName:e}=this.effectiveTimeZoneOptions;return null!=a?p.getLabelForDateFieldValue(b,a,{...this._getDateFormatOptions(),
timeZone:c,timeZoneName:e}):null}_setUpDateComponents(b){const {_effectiveRange:{max:a,min:c,rawMax:e,rawMin:k},field:d,effectiveRequired:l}=this;b=this._getDateFieldValuesForComponents(d,b);const m=[];if(y.isAnyDateField(d)){const n=this.createDateComponent();var r=q.isDateOnlyField(d)||q.isTimestampOffsetField(d)?e:a,u=q.isDateOnlyField(d)||q.isTimestampOffsetField(d)?k:c;r=this._getDateFieldValuesForComponents(d,r??null);u=this._getDateFieldValuesForComponents(d,u??null);n.value=b.date??"";n.max=
r.date??"";n.min=u.date??"";n.required=l;n.addEventListener("calciteInputDatePickerOpen",()=>this._onDateComponentOpen(n));m.push(n)}if(this.includeTime){const n=this.createTimeComponent();n.value=b.time??"";n.required=l;n.addEventListener("calciteInputTimePickerOpen",()=>this._onDateComponentOpen(n));m.push(n)}if("timestamp-offset"===d.type){const n=this.createTimeZoneComponent();n.value=b.timeZoneOffset??"0";n.addEventListener("calciteInputTimeZoneOpen",()=>this._onDateComponentOpen(n));m.push(n)}return m}_onDateComponentOpen(b){this.editInfo?.inputs.forEach(a=>
{a!==b&&"open"in a&&(a.open=!1)})}_syncRowEditingState(b,a=!1){(b=this.grid?.getRowContainingNode(b))&&(a?b.setAttribute("editing","true"):b.removeAttribute("editing"))}_getDateFieldValuesForComponents(b,a){switch(b.type){case "date":return p.prepareUnixFieldValueForDateComponents(a,this.effectiveTimeZoneOptions.timeZone);case "date-only":return{date:a};case "time-only":return{time:a};case "timestamp-offset":return p.prepareISOFieldValueForDateComponents(a);default:return{}}}_setUpFieldInput(b,a){const {field:c,
layer:e,effectiveTimeZoneOptions:{timeZone:k}}=this;b=new F({feature:b,field:c,initialFeature:b.clone(),layer:e,timeZone:k});b.set("value",a);return b}_isDomainCompatible(b){if(!b)return!1;const {_isNumericField:a,_isStringField:c}=this,{type:e}=b;return"coded-value"===e&&(b=typeof b.codedValues[0].code,"string"===b&&c||"number"===b&&a)?!0:"range"===e&&a?!0:!1}_getDomainForFeature(b){const {fieldName:a,layer:c,template:e}=this;if(!b||!c?.getFieldDomain||"wfs"===c.type||"geojson"===c.type||"csv"===
c.type||"knowledge-graph-sublayer"===c.type)return null;if(e?.domain&&this._isDomainCompatible(e.domain))return e.domain;if("feature"!==c.type&&"subtype-group"!==c.type&&null==c.getField(a)?.domain){const k=E.computeDomainFromTypes(c,a);if(k)return k}return c.getFieldDomain(a,{feature:b})}_getComputedDomain(b,a){return a?"range"===a.type?b:"coded-value"===a.type?(a=a.codedValues.filter(c=>c.hasOwnProperty("code")&&c.code===b))&&a.length?a[0].name:b:null:null}_getDateFormatOptions(){const {template:b}=
this,a=b?.format?.dateFormat;return a?v.convertDateFormatToIntlOptions(a):b?.input&&"includeTime"in b.input&&!1===b.input.includeTime?I:H}};g.__decorate([h.property()],f.prototype,"_effectiveDomain",null);g.__decorate([h.property()],f.prototype,"_activeFieldInput",void 0);g.__decorate([h.property()],f.prototype,"_effectiveRange",null);g.__decorate([h.property()],f.prototype,"_isAnyDateOrTimeField",null);g.__decorate([h.property()],f.prototype,"_isIntegerField",null);g.__decorate([h.property()],f.prototype,
"_isNumericField",null);g.__decorate([h.property()],f.prototype,"_isStringField",null);g.__decorate([h.property()],f.prototype,"_isSubtypeField",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"alias",null);g.__decorate([h.property()],f.prototype,"cellValueFormatFunction",void 0);g.__decorate([h.property()],f.prototype,"cellValueValidatorFunction",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"defaultValue",null);g.__decorate([h.property()],f.prototype,"effectiveDescription",
null);g.__decorate([h.property()],f.prototype,"effectiveEditable",null);g.__decorate([h.property()],f.prototype,"effectiveLabel",null);g.__decorate([h.property()],f.prototype,"effectiveRequired",null);g.__decorate([h.property()],f.prototype,"effectiveTimeZoneOptions",null);g.__decorate([h.property()],f.prototype,"field",void 0);g.__decorate([h.property()],f.prototype,"formatFunction",void 0);g.__decorate([h.property()],f.prototype,"includeTime",null);g.__decorate([h.property()],f.prototype,"inputRenderFunction",
void 0);g.__decorate([h.property()],f.prototype,"layer",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"loadingMessage",null);g.__decorate([h.property()],f.prototype,"maxLength",null);g.__decorate([h.property()],f.prototype,"minLength",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"name",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"nullable",null);g.__decorate([h.property()],f.prototype,"parseInputValueFunction",void 0);g.__decorate([h.property()],f.prototype,
"shouldShowPrompt",null);g.__decorate([h.property()],f.prototype,"sortable",void 0);g.__decorate([h.property()],f.prototype,"store",void 0);g.__decorate([h.property()],f.prototype,"template",void 0);g.__decorate([h.property()],f.prototype,"view",void 0);return f=g.__decorate([C.subclass("esri.widgets.FeatureTable.FieldColumn")],f)});