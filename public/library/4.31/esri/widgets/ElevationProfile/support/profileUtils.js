// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../core/arrayUtils ../../../core/mathUtils ../../../core/promiseUtils ../../../geometry/Multipoint ../../../geometry/support/coordsUtils ../../../geometry/support/spatialReferenceUtils ../../../views/support/QueueProcessor ../../../views/support/Scheduler ./constants ./geometryUtils ./ProfileGenerationError ./statisticsUtils ../../support/traversalUtils".split(" "),function(t,E,F,u,G,H,I,J,K,x,y,r,L,M){function*A(a,b){var {densificationResult:d}=a;a={...a,abortOptions:b,densificationResult:d};
b=M.breadthFirstBinaryPartitioning(0,a.result.samples.length);d=b.slice(0,a.provider.numSamplesForPreview);yield B(a,d,!0);b=E.splitIntoChunks(b,a.provider.numSamplesPerChunk);for(const l of b)yield B(a,l,!1)}async function B({densificationResult:a,result:b,provider:d,queue:l,abortOptions:c,cache:h},k,f){const {densifiedPath:g,pathLength:m}=a;a=b.spatialReference;const {samples:n}=b,p=[];for(let e=0;e<k.length;e++)p[e]=n[k[e]].coordinate;try{return await l.push({geometry:new G({spatialReference:a,
points:p,hasZ:g.hasZ}),provider:d,indices:k,preview:f,result:b,queryOptions:{...x.getConfig().defaultQueryOptions(),minDemResolution:f?Math.round(m/d.numSamplesForPreview):Math.round(m/n.length),cache:h}},c),{...b}}catch(e){return u.isAbortError(e)?null:x.errorResult}}async function N({geometry:a,provider:b,indices:d,preview:l,result:c,queryOptions:h}){if(0!==d.length){a=(await O(b,a,h)).geometry;var {hasZ:k,points:f}=a;h=h.noDataValue;({samples:a}=c);for(b=0;b<d.length;b++){const g=a[d[b]];if(g.isHole)continue;
const m=k?f[b][2]:null;null===m||m===h?g.sampledZ=null:(c.hasZ=!0,g.sampledZ=m);g.sampled=!0}C(a);c.progress=l?0:c.progress+d.length/a.length;c.statistics=L.getStatistics(c.samples,c.spatialReference)}}function C(a){const b=a.length-1;var d=0;for(let g=1;g<=b;g++)if(a[g].sampled||g===b){a:{var l=a,c=d;d=g;if(1===d-c)break a;var h=l[c],k=h.sampledZ,f=l[d];const m=f.sampledZ;if(null==k||null==m)for(k=c+1;k<d;k++)l[k].sampledZ=null;else for(h=h.distance,f=f.distance-h,c+=1;c<d;c++){const n=l[c];n.sampledZ=
F.lerp(k,m,(n.distance-h)/f)}}d=g}}function P({densifiedPath:a,distances:b}){const d=a.spatialReference,l=I.getInfo(d);a=a.paths;const c=a.length,h=[];let k=null,f=0;for(let p=0;p<c;p++){const e=a[p],q=e.length,Q=b[p];for(let v=0;v<q;v++){const w=e[v],z=Q[v];l&&(w[0]=H.unnormalizedCoordinate(w[0],l.valid[0],l.valid[1]));if(k&&0===v){var g=h,m=w,n=z;g.push(D(k,f));g.push(D(m,n))}h.push({coordinate:w,distance:z,sampledZ:null,sampled:!1,isHole:!1});k=w;f=z}}return{progress:0,samples:h,hasZ:!1,statistics:null,
spatialReference:d}}function D(a,b){return{coordinate:a,distance:b,sampledZ:null,sampled:!0,isHole:!0}}async function O(a,b,d){try{return await a.queryElevation(b,d)}catch(l){throw new r.ProfileGenerationError(r.ProfileGenerationErrorCause.ElevationQueryError);}}t.binaryFindClosest=function(a,b,d){if(a&&0!==a.length){var l=a.length-1,c=a[0];if(b<=d(c))return c;c=a[l];if(b>=d(c))return c;var h=0;c=0;for(var k=l;h<k;){c=h+Math.floor((k-h)/2);const g=a[c],m=d(g);if(m===b)return g;if(b<m){if(0<c){k=a[c-
1];var f=d(k);if(b>f)return b-f>=m-b?g:k}k=c}else{if(c<l&&(h=a[c+1],f=d(h),b<f))return b-m>=f-b?h:g;h=c+1}}return a[c]}};t.createProfileQueue=function(a){return new J.QueueProcessor({priority:K.TaskPriority.ELEVATION_PROFILE,concurrency:1,scheduler:a,process:async b=>{u.throwIfAborted(b.queryOptions);try{await N(b)}catch(d){u.throwIfNotAbortError(d)}}})};t.generateProfile=A;t.generateProfiles=async function*(a,b){const {view:d,geometry:l,elevationInfo:c,providers:h,options:k}=a;var f=d.spatialReference;
if(!f||null==l||!y.isValidInputPath(l))throw new r.ProfileGenerationError(r.ProfileGenerationErrorCause.InvalidGeometry);const g=h.length;if(0===g)return null;var m=Math.round(k.maxTotalSamples/g);if(y.countPoints(l)>m)throw new r.ProfileGenerationError(r.ProfileGenerationErrorCause.TooComplex);var n=await y.densifyPath(l,c,d,f,k,m,b),p=0;f=Array(g);m=Array(g);for(let e=0;e<g;e++){const q=P(n);f[e]=q;p+=q.samples.length;m[e]=A({...a,provider:h[e],result:q,densificationResult:n},b)[Symbol.iterator]()}if(p>
k.maxTotalSamples)throw new r.ProfileGenerationError(r.ProfileGenerationErrorCause.TooComplex);n=await Promise.all(m.map(e=>{e=e.next();return!0===e.done?Promise.resolve(null):e.value}));u.throwIfAborted(b);for(p=0;p<g;p++)f[p]=n[p];yield f;await u.after(a.delayAfterPreview??x.getConfig().delayAfterPreviewMillis,null,b.signal);a=[];try{let e;do for(e=!1,n=0;n<g;n++){const q=m[n].next();!1===q.done&&(a.push({resultPromise:q.value,index:n}),e=!0)}while(e)}finally{m.forEach(e=>e.return?.())}for(const {resultPromise:e,
index:q}of a)f[q]=await e,u.throwIfAborted(b),yield f;for(const e of f)null!=e&&(e.progress=1);yield f};t.interpolateElevations=C;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});