// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../intl ../../core/Accessor ../../core/Collection ../../core/Error ../../core/Logger ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../core/support/UpdatingHandles ../../layers/support/layerUtils ../../portal/Portal ../../portal/support/utils ../../intl/locale ../../intl/messages".split(" "),function(d,c,r,t,h,k,p,f,A,B,u,v,q,w,x,y,z){c=class extends r{constructor(b){super(b);
this._initialValidationsFinished=this._activeOperationDidSucceed=!1;this._serverVersion=this._dirtyAreasLayer=null;this._updatingHandles=new v.UpdatingHandles;this._validConstructProperties=!1;this.executionError="";this.extentToValidate="current";this.loadErrors=new t}initialize(){const b=async()=>{this.messages||(this.messages=await z.fetchMessageBundle("esri/widgets/UtilityNetworkValidateTopology/t9n/UtilityNetworkValidateTopology"))};b().then(()=>{this.view||(this.view=null);this.utilityNetwork||
(this.utilityNetwork=null);this.addHandles([p.watch(()=>[this.view,this.utilityNetwork],async()=>{const {loadErrors:e,messages:{info:{noUtilityNetwork:a,noView:g}}}=this;this._initialValidationsFinished=!1;e.removeAll();this._validConstructProperties=!0;this._serverVersion=this._dirtyAreasLayer=null;"utility"!==this.utilityNetwork?.type&&(this.loadErrors.push(a),k.getLogger(this).error(new h("utilityNetworkValidateTopology:missing-property",a)),this._validConstructProperties=!1);"2d"!==this.view?.type&&
(this.loadErrors.push(g),k.getLogger(this).error(new h("utilityNetworkValidateTopology:missing-property",g)),this._validConstructProperties=!1);this._validConstructProperties&&(this.utilityNetwork.loaded||await this.utilityNetwork.load().catch(l=>{k.getLogger(this).error(l);this._validConstructProperties=!1}),await this._setDirtyAreasLayer());this._validConstructProperties&&await this._validateNetworkExtension()},p.initial),p.on(()=>this.view?.map?.layers,"change",async()=>{const {loadErrors:e,messages:{info:{noUtilityNetwork:a}}}=
this,g=e.find(l=>l===a);this._initialValidationsFinished=!1;g||(e.removeAll(),await this._validateNetworkExtension(),await this._setDirtyAreasLayer());this._initialValidationsFinished=!0}),y.onLocaleChange(b)])})}destroy(){this._updatingHandles.destroy()}get state(){return this.loadErrors.length||!this._validConstructProperties?"disabled":this.executionError?"failed":this._updatingHandles.updating?"executing":this._activeOperationDidSucceed?"success":this._initialValidationsFinished?"ready":"loading"}set utilityNetwork(b){this._get("utilityNetwork")!==
b&&this._set("utilityNetwork",b)}set view(b){this._get("view")!==b&&this._set("view",b)}async validateTopology(){const {messages:{info:{cannotAcquireVersionLock:b,noDirtyAreasInExtent:e}},utilityNetwork:a,view:g}=this;if(!this.loadErrors.length){this._activeOperationDidSucceed=!1;this._set("executionError","");const l={gdbVersion:a?.gdbVersion,outSpatialReference:g.spatialReference?.clone()||null,validateArea:"current"===this.extentToValidate?g.extent.clone():a.fullExtent.clone()};this._updatingHandles.addPromise(a?.validateTopology(l).then(()=>
{this._activeOperationDidSucceed=!0},m=>{let n="Error: "+m;if(m instanceof h&&m.details?.raw)switch(m.details.raw.extendedCode){case -2147208940:n=e;break;case -2147217146:case -2147220947:n=b;break;default:n=m.details.message}this._set("executionError",n)}))}}async _setDirtyAreasLayer(){const {messages:{info:{noDirtyAreasLayer:b}}}=this,e=this.view?.map.allLayers.items.filter(a=>q.isFeatureLayer(a)).find(a=>a.parsedUrl?.path===this.utilityNetwork?.networkSystemLayers.dirtyAreasLayerUrl);e?(this._dirtyAreasLayer=
e,await this._dirtyAreasLayer.load(),this._serverVersion=this._dirtyAreasLayer.version??0,this._validConstructProperties=!0):(this.loadErrors.includes(b)||(this.loadErrors.push(b),k.getLogger(this).error(new h("utilityNetworkValidateTopology:missing-layer",b))),this._validConstructProperties=!1)}async _validateNetworkExtension(){const {messages:{info:{noAdvancedEditingUserTypeExtension:b,noUtilityNetworkServiceUserTypeExtension:e}}}=this;var a=await q.getOwningPortalUrl(this.utilityNetwork.layerUrl);
a=new w({url:a});await a.load();await x.hasUserTypeExtension(a,a.user?.username??"",11.1>=Number(this._serverVersion)?"utilityNetwork":"advediting")||(a=11.1>=Number(this._serverVersion)?e:b,this.loadErrors.push(a),k.getLogger(this).error(new h("utilityNetworkValidateTopology:no-user-type-extension",a)),this._validConstructProperties=!1);this._initialValidationsFinished=!0}};d.__decorate([f.property()],c.prototype,"_initialValidationsFinished",void 0);d.__decorate([f.property()],c.prototype,"_dirtyAreasLayer",
void 0);d.__decorate([f.property()],c.prototype,"_validConstructProperties",void 0);d.__decorate([f.property({readOnly:!0})],c.prototype,"executionError",void 0);d.__decorate([f.property()],c.prototype,"extentToValidate",void 0);d.__decorate([f.property()],c.prototype,"loadErrors",void 0);d.__decorate([f.property()],c.prototype,"messages",void 0);d.__decorate([f.property({readOnly:!0})],c.prototype,"state",null);d.__decorate([f.property()],c.prototype,"utilityNetwork",null);d.__decorate([f.property()],
c.prototype,"view",null);return c=d.__decorate([u.subclass("esri.widgets.UtilityNetworkValidateTopology.UtilityNetworkValidateTopologyViewModel")],c)});