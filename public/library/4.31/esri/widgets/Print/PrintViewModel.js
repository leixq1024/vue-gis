// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../geometry ../../request ../../core/arrayUtils ../../core/Collection ../../core/Error ../../core/jsonMap ../../core/lang ../../core/Loadable ../../core/promiseUtils ../../core/ReactiveMap ../../core/reactiveUtils ../../core/screenUtils ../../core/unitUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/accessorSupport/decorators/subclass ../../intl/date ../../intl/locale ../../portal/Portal ../../portal/PortalQueryParams ../../portal/support/urlUtils ../../rest/print ../../rest/support/fileFormat ../../rest/support/layoutTemplate ../../rest/support/PrintParameters ../../rest/support/PrintTemplate ../../views/2d/viewpointUtils ../../views/input/InputManager ../../views/overlay/BoxOverlayItem ./CustomTemplate ./TemplateOptions ./utils ../../geometry/Extent ../../geometry/SpatialReference".split(" "),
function(h,g,N,B,O,r,P,Q,R,S,T,z,U,t,k,pa,qa,V,C,W,D,E,X,F,G,x,Y,Z,aa,H,ba,u,I,ca,da,ea){function fa(a){a.layoutOptions??(a.layoutOptions={});var b;(b=a.layoutOptions).customTextElements??(b.customTextElements=[]);a.layoutOptions.customTextElements.find(c=>"date"in c)||({customTextElements:a}=a.layoutOptions,b=C.formatDate(Date.now(),C.convertDateFormatToIntlOptions("short-date")),"ar"===W.getLanguage()&&(b="\u200f"+b),a.push({date:b}))}function J(a,b,c){b&&b.visible!==c&&a.layoutOptions&&(a.layoutOptions.elementOverrides?
a.layoutOptions.elementOverrides[b.name]={visible:c}:a.layoutOptions.elementOverrides={[b.name]:{visible:c}})}const ha=[30,144,255,255],K=[237,211,23,255],ia=[216,48,32,255],ja=new Set(["GISProfessionalStdUT","GISProfessionalAdvUT"]),ka=/(\/GPServer\/).+/i,la=new P.JSONMap({inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers"}),v=O.ofType(u);g=class extends R{constructor(a){super(a);
this._serviceTemplateCustomTextElements=null;this._templateIdToCustomTemplate=new T;this._isFreeHand=!1;this._freehandHeight=this._freeHandWidth=0;this._layoutInfoTaskUrl=this._asyncPrintTaskUrl=null;this.allowedLayouts=this.allowedFormats="all";this.browseTemplates=new v;this.defaultTemplates=new v;this.extraParameters=this.error=null;this.includeDefaultTemplates=!0;this.outSpatialReference=null;this.portal=D.getDefault();this.portalTemplateIds=[];this.printServiceTemplates=new v;this.defaultTemplate=
null;this.showPrintAreaEnabled=!1;this.printServiceUrl=null;this.printTimeout=12E4;this.templatesInfo=null;this.updateDelay=1E3;this.templateCustomTextElements=this.view=null;this.templateOptions=new I}initialize(){this.addHandles([z.watch(()=>[this.showPrintAreaEnabled,this.view],()=>{this.showPrintAreaEnabled?this._enablePrintPreview():(this.removeHandles("overlay-handler"),this.view?.overlay?.removeItem(this._getOverlayItem()))}),z.watch(()=>[this.templateOptions.layout,this.templateOptions.layoutItem],
()=>{this.loaded&&this._processTemplateOptions()})])}destroy(){this.removeHandles("overlay-handler");this.view&&(this._overlayItem&&(this.view.overlay?.removeItem(this._overlayItem),this._overlayItem.destroy(),this._overlayItem=null),this.view=null)}get effectivePrintServiceUrl(){return this.printServiceUrl??null}get effectiveTemplateCustomTextElements(){if(!this._serviceTemplateCustomTextElements)return{};const a=Q.clone(this._serviceTemplateCustomTextElements);this.templateCustomTextElements&&Object.keys(this.templateCustomTextElements).forEach(b=>
{const c=a[b];if(c){const d=this.templateCustomTextElements?.[b];c.forEach(e=>{const [f]=Object.entries(e)[0];d?.forEach(l=>{const [n,m]=Object.entries(l)[0];f===n&&(e[f]=m)})})}});return Object.freeze(a)}get state(){return"loading"===this.loadStatus?"initializing":"failed"===this.loadStatus||this.error?"error":"loaded"===this.loadStatus&&this.view?.ready?"ready":"disabled"}async load(a){this.addResolvingPromise(this._loadResources(a).catch(b=>this.error=b));return this}async print(a){const {view:b,
extraParameters:c,updateDelay:d,outSpatialReference:e}=this;if(!b)throw new r("print:view-required","view is not set");fa(a);var f=this._getOverlayItem();f=a.scalePreserved||!this.showPrintAreaEnabled?void 0:aa.getExtent(new da,b.viewpoint,"map-only"===a.layout?[a.exportOptions.width,a.exportOptions.height]:[f.boxWidth,f.boxHeight]);f=new Y({view:b,template:a,extent:f,extraParameters:c,updateDelay:d,outSpatialReference:e});try{const l=!!a.layoutItem?.id&&(this.portalTemplateIds.includes(a.layoutItem.id)||
this.browseTemplates.some(n=>n.layoutItem?.id===a.layoutItem?.id));return await F.execute(l&&this._asyncPrintTaskUrl?this._asyncPrintTaskUrl:this.effectivePrintServiceUrl,f,{timeout:this.printTimeout})}catch(l){throw new r("print:export-error","An error occurred while exporting the web map.",{error:l});}}toPrintTemplate({attributionEnabled:a,author:b,copyright:c,customTextElements:d,dpi:e,forceFeatureAttributes:f,format:l,height:n,id:m,includeTables:q,layout:A,layoutItem:y,legendEnabled:p,northArrowEnabled:w,
scale:ma,scaleEnabled:L,title:na,width:M}){if(!A&&!y)throw new r("print:layout-required","layout is not set");a=new Z({attributionVisible:a,forceFeatureAttributes:f,format:l,includeTables:q,layout:A,layoutItem:y,layoutOptions:{authorText:b||"",copyrightText:c||"",customTextElements:d,titleText:na||""},outScale:ma??0,scalePreserved:L});M&&(a.exportOptions.width=M);n&&(a.exportOptions.height=n);e&&(a.exportOptions.dpi=e);if(a.layoutOptions&&(p||(a.layoutOptions.legendLayers=[]),e=this.getLayoutTemplateById(m)?.mapSurroundInfoOptions)){J(a,
e.northArrow[0],w);w=e.scaleBar;for(const oa of w)J(a,oa,L)}return a}getLayoutTemplateById(a){return a?this._templateIdToCustomTemplate.get(a):null}async addPortalTemplate(a){if(this.portal&&a?.id){try{a.loaded||await a.load()}catch{this.applyTemplate(this.defaultTemplate);return}a=new u({type:"browse-template",layoutInfoTaskUrl:this._layoutInfoTaskUrl,label:a.title,layoutItem:a});this._templateIdToCustomTemplate.set(a.id,a);this.browseTemplates.add(a)}}removePortalTemplate(a){a.layoutItem&&this.templateOptions.id===
a.layoutItem.id&&(this.defaultTemplate?this.applyTemplate(this.defaultTemplate):this.templateOptions.reset());this.browseTemplates.remove(a);this._templateIdToCustomTemplate.delete(a.id)}async applyTemplate(a){a?(a.layout&&this.templatesInfo&&!this.templatesInfo.layout.choiceList.includes(a.layout)&&(this.defaultTemplate?a=this.defaultTemplate:this.templateOptions.reset()),await this.templateOptions.applyTemplate(a,a.layout?this.effectiveTemplateCustomTextElements[a.layout]:null)):this.templateOptions.reset()}async _loadResources(a){if(!this.destroyed){await this._loadUrls(a);
var [b,c]=await Promise.all([this._getLayoutToLayoutTemplateInfos(a),this._getPrintServiceTemplatesInfo(a)]);await this._loadAllTemplates(b,c,a);this._processPrintServiceTemplatesInfo(c);await this._processTemplateOptions();this._updateOverLayItem()}}async _processTemplateOptions(){const {layout:a,layoutItem:b}=this.templateOptions;if("map-only"!==a&&!this.templateOptions.id)if(b?.id){try{b.loaded||await b.load()}catch{this.applyTemplate(this.defaultTemplate);return}var c=this._templateIdToCustomTemplate.get(b.id);
c||(c=new u({label:b.title,layoutItem:b,layoutInfoTaskUrl:this._layoutInfoTaskUrl}),this._templateIdToCustomTemplate.set(c.id,c));await this.applyTemplate(c)}else a&&(c=this.defaultTemplates.find(d=>d.layout===this.templateOptions.layout)??this.printServiceTemplates.find(d=>d.layout===this.templateOptions.layout),await this.applyTemplate(c??this.defaultTemplate))}async _loadPortal(a){try{await this.portal.load(a)}catch(b){throw new r("print:could-not-load-portal","Cannot load print resource information from portal",
{error:b,url:this.effectivePrintServiceUrl});}}async _loadUrls(a){if(this.printServiceUrl)this._set("effectivePrintServiceUrl",this.printServiceUrl),await this._updateLayoutInfoTaskUrl(this.effectivePrintServiceUrl);else{await this._loadPortal(a);const {printTask:b,asyncPrintTask:c,layoutInfoTask:d}=this.portal?.helperServices??{};this._set("effectivePrintServiceUrl",b?.url);this._asyncPrintTaskUrl=c?.url;await this._updateLayoutInfoTaskUrl(d?.url||this.effectivePrintServiceUrl)}if(!this.effectivePrintServiceUrl?.toLowerCase().split("/")?.includes("gpserver"))throw new r("print:invalid-print-service-url",
"Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl});}async _updateLayoutInfoTaskUrl(a,b){a&&(b=(await F.getTasks(a,b)).find(c=>c.includes("Get Layout Templates Info")))&&(this._layoutInfoTaskUrl=a.replace(ka,`$1${encodeURI(b)}`))}_getPortalDefaultTemplates(a,b){return this.portal?.helperServices?.printTask?.templates?.filter(c=>"map_only"!==c.layout.toLowerCase()&&(!b||b.includes(x.fromJSON(c.layout))))?.map(c=>{c=u.fromJSON(c);c.type="default-template";
c.layoutInfoTaskUrl=this._layoutInfoTaskUrl;if(c.layout){const d=a.get(c.layout);d&&c.setLayoutTemplateInfo(d)}return c})??[]}async _getPortalCustomTemplates(a){if(this.printServiceUrl||!this.portal)return[];const {layoutGroupQuery:b,user:c}=this.portal;var d=X.reArcGISOnlineDomain.test(this.portal.url),e=c?.userLicenseTypeId;e=e&&ja.has(e);if(!b||d&&!e)return[];d=new E({query:b,disableExtraQuery:!0});d=await this.portal.queryGroups(d,a);if(!d.total)return[];d=d.results[0];e=new E({num:100,query:"type:Layout",
sortField:d.sortField,sortOrder:d.sortOrder??void 0});a=(await d.queryItems(e,a)).results;return a.length?a.map(f=>{this.portalTemplateIds.push(f.id);return new u({type:"default-template",label:f.title,layoutItem:f,layoutInfoTaskUrl:this._layoutInfoTaskUrl})}):[]}async _loadAllTemplates(a,b,c){let d=!1;const e=b?.layout?.choiceList;if(this.includeDefaultTemplates&&this.portal&&!this.printServiceUrl){b=this._getPortalDefaultTemplates(a,e);d=!!b.length;this.defaultTemplates.addMany(b);c=await this._getPortalCustomTemplates(c);
this.defaultTemplates.addMany(c);for(const f of this.defaultTemplates)this._templateIdToCustomTemplate.set(f.id,f)}d||a.forEach((f,l)=>{if(!e||e.includes(l))l=new u({type:"print-service-template",layout:l,layoutInfoTaskUrl:this._layoutInfoTaskUrl}),l.setLayoutTemplateInfo(f),this.printServiceTemplates.add(l),this._templateIdToCustomTemplate.set(l.id,l)})}_processPrintServiceTemplatesInfo(a){this._set("templatesInfo",a);const b=a?.layout?.defaultValue;b&&"map-only"!==b&&(a=this.defaultTemplates.find(c=>
c.layout===b)??this.printServiceTemplates.find(c=>c.layout===b)??this.defaultTemplates.at(0)??this.printServiceTemplates.at(0),this._set("defaultTemplate",a))}async _getLayoutToLayoutTemplateInfos(a){var b=await ca.fetchLayoutTemplateInfos(this._layoutInfoTaskUrl,void 0,a);a=new Map;const c={};for(const d of b)b=x.fromJSON(d.layoutTemplate),a.set(b,d),c[b]=d.layoutOptions.customTextElements;this._serviceTemplateCustomTextElements=Object.freeze(c);return a}async _getPrintServiceTemplatesInfo(a){try{({data:b}=
await N(this.effectivePrintServiceUrl,{...a,query:{f:"json"},timeout:this.printTimeout}))}catch(c){throw S.isAbortError(c)?c:new r("print:unavailable-service-info","Can't fetch templates info from service",{error:c});}({parameters:b}=b);a=b.find(({name:c})=>"Format"===c);var b=b.find(({name:c})=>"Layout_Template"===c);a=this._getFormat(a);b=this._getLayout(b);return{format:a,layout:b}}_getFormat(a){var b="all"===this.allowedFormats?a.choiceList:a.choiceList.filter(d=>"string"!==typeof this.allowedFormats&&
this.allowedFormats.some(e=>(new RegExp(`\\b${e}\\b`,"i")).test(d)));b=(b.length?b:a.choiceList).map(d=>G.formatJsonMap.fromJSON(d)).filter(B.isSome);const c=G.formatJsonMap.fromJSON(a.defaultValue);a=b.some(d=>(new RegExp(`\\b${c}\\b`,"i")).test(d))?c:b[0];return{choiceList:b,defaultValue:a}}_getLayout(a){var b=a.choiceList.filter(d=>"map_only"!==d.toLowerCase());const c="all"===this.allowedLayouts?b:b.filter(d=>this.allowedLayouts.includes(x.fromJSON(d)));b=(c.length?c:b).map(x.fromJSON).filter(B.isSome);
a=x.fromJSON(a.defaultValue);a=b.includes(a)?a:b.find(d=>/(?=.*letter)(?=.*landscape)/i.test(d))??b.find(d=>/(?=.*a4)(?=.*landscape)/i.test(d))??b[0];return{choiceList:b,defaultValue:a}}_getOverlayItem(){this._overlayItem||(this._overlayItem=new ba({strokeDash:[5],strokeWidth:2,strokeColor:[30,144,255,255]}));return this._overlayItem}_enablePrintPreview(){if(this.view?.overlay){var a=this.templateOptions,b=this._getOverlayItem();this.addHandles([z.watch(()=>[a.width,a.height,a.scaleEnabled,a.scale,
a.layout,a.layoutItem,a.id,a.state,this.view?.scale,this.view?.size,this.view?.state.paddedViewState.size,this.view?.state.padding,this.loaded],()=>this._updateOverLayItem(),z.initial),this.view?.on("drag",["Shift"],c=>this._handleDrag(c),H.ViewEventPriorities.WIDGET),this.view?.on("key-down",["Escape"],()=>this._resetDrag(),H.ViewEventPriorities.WIDGET)],"overlay-handler");this.view.overlay.addItem(b)}}_updateOverLayItem(){if(this.view){var a=this.templateOptions,b=this._getOverlayItem(),c=a.layoutItem?.id??
a.layout,d=this.view,e=d.spatialReference,[f,l]=d.state.paddedViewState.size;d=d.state.padding;var n=0,m=0;if("map-only"===c)null!=a.width&&null!=a.height&&(n=a.width,m=a.height);else if(c){c=a.id?this._templateIdToCustomTemplate.get(a.id):null;const {webMapFrameSize:p,pageUnits:w}=c?.layoutTemplateInfo??{};c=!1;if(p&&w)if(this._isFreeHand){var q=p[0]/p[1];n=this._freeHandWidth;m=this._freehandHeight;n>m?m=n/q:n=m*q}else m=la.fromJSON(w.toLowerCase()),q=e.unit,t.unitType(m)===t.unitType(q)?(n=t.convertUnit(p[0],
m,q),m=t.convertUnit(p[1],m,q)):(c=!0,n=p[0],m=p[1]);this._isFreeHand||(a.scaleEnabled&&a.scale?(e=c?Math.min(f/n,l/m):t.getMetersPerUnitForSR(e)*t.inchesPerMeter*a.dpi,n*=e,m*=e):0===n||0===m?(n=f,m=l):(e=Math.min((f-.1*f)/n,(l-.1*l)/m),n*=e,m*=e))}var {scaleEnabled:A,scale:y}=a;a=A&&y?y/this.view.scale:1;b.boxWidth=n*a||f;b.boxHeight=m*a||l;d&&(b.padding=d);b.backgroundWidth=f??0;b.backgroundHeight=l??0;if("loading"===this.loadStatus)b.strokeColor=K;else if("loaded"===this.loadStatus)switch(this.templateOptions.state){case "pending":b.strokeColor=
K;break;case "ready":b.strokeColor=ha;break;case "error":b.strokeColor=ia}}}_resetDrag(){this._isFreeHand=!1;this._updateOverLayItem()}_handleDrag(a){switch(a.action){case "start":this._start();break;case "update":this._update(a);break;case "end":this._end()}a.stopPropagation()}_start(){this._isFreeHand=!0}_update(a){const b=this._getOverlayItem(),{x:c,y:d}=a,{x:e,y:f}=a.origin;c>e?(b.x=e,b.boxWidth=c-e):(b.x=c,b.boxWidth=e-c);d>f?(b.y=f,b.boxHeight=d-f):(b.y=d,b.boxHeight=f-d)}_end(){const a=this._getOverlayItem();
if(this.view&&null!=a.x&&null!=a.y){var b=this.view,c=b.toMap(U.createScreenPoint(a.x+.5*a.boxWidth,a.y+.5*a.boxHeight));a.x=null;a.y=null;b.goTo({center:c});this._freeHandWidth=a.boxWidth;this._freehandHeight=a.boxHeight;"map-only"===this.templateOptions.layout&&(this.templateOptions.width=this._freeHandWidth,this.templateOptions.height=this._freehandHeight);this.templateOptions.scale=this.view.scale;this._updateOverLayItem()}}};h.__decorate([k.property()],g.prototype,"_serviceTemplateCustomTextElements",
void 0);h.__decorate([k.property()],g.prototype,"_templateIdToCustomTemplate",void 0);h.__decorate([k.property()],g.prototype,"allowedFormats",void 0);h.__decorate([k.property()],g.prototype,"allowedLayouts",void 0);h.__decorate([k.property({type:v})],g.prototype,"browseTemplates",void 0);h.__decorate([k.property({type:v})],g.prototype,"defaultTemplates",void 0);h.__decorate([k.property()],g.prototype,"error",void 0);h.__decorate([k.property()],g.prototype,"extraParameters",void 0);h.__decorate([k.property()],
g.prototype,"includeDefaultTemplates",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"effectivePrintServiceUrl",null);h.__decorate([k.property()],g.prototype,"effectiveTemplateCustomTextElements",null);h.__decorate([k.property({type:ea})],g.prototype,"outSpatialReference",void 0);h.__decorate([k.property({type:D})],g.prototype,"portal",void 0);h.__decorate([k.property()],g.prototype,"portalTemplateIds",void 0);h.__decorate([k.property({type:v})],g.prototype,"printServiceTemplates",void 0);
h.__decorate([k.property({readOnly:!0})],g.prototype,"defaultTemplate",void 0);h.__decorate([k.property()],g.prototype,"showPrintAreaEnabled",void 0);h.__decorate([k.property()],g.prototype,"printServiceUrl",void 0);h.__decorate([k.property()],g.prototype,"printTimeout",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"state",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"templatesInfo",void 0);h.__decorate([k.property()],g.prototype,"updateDelay",void 0);h.__decorate([k.property()],
g.prototype,"view",void 0);h.__decorate([k.property()],g.prototype,"templateCustomTextElements",void 0);h.__decorate([k.property({type:I})],g.prototype,"templateOptions",void 0);return g=h.__decorate([V.subclass("esri.widgets.Print.PrintViewModel")],g)});