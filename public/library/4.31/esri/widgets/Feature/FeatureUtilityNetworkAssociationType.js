// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require ../../chunks/tslib.es6 ../../intl ../../core/promiseUtils ../../core/ReactiveMap ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../intl/number ../../support/popupUtils ../Widget ./FeatureUtilityNetworkAssociations/FeatureUtilityNetworkAssociationsViewModel ./FeatureUtilityNetworkAssociations/VisibleElements ../../chunks/componentsUtils ../support/globalCss ../support/widgetUtils ../support/decorators/messageBundle ../support/jsxFactory ../../intl/substitute".split(" "),
function(l,f,e,w,x,y,g,G,H,I,z,A,q,B,r,t,C,D,J,u,h,E){var n;e=n=class extends B{constructor(a,b){super(a,b);this.flowType="feature-utility-network-association-type";this.description=null;this.headingLevel=2;this.title=null;this.viewModel=new r;this.messagesCommon=this.messages=this.flowItems=this.selectedLayer=this.listType=this.parentFeatureViewModel=null;this.visibleElements=new t;this._featuresPerPage=50;this._maxNumFeatures=1E3;this._currentFeaturePage=1;this._previewDisplayCount=3;this._associatedFeatureIntersectionObserverNode=
null;this._associatedFeatureIntersectionObserver=new IntersectionObserver(([c])=>{c?.isIntersecting&&this._increaseFeaturePage()},{root:window.document});this._tooltipReferenceMap=new x;this._filterText=""}initialize(){this.addHandles([y.watch(()=>[this._associatedFeatureIntersectionObserverNode],()=>this._handleAssociatedFeatureObserverChange())])}loadDependencies(){return C.loadCalciteComponents({chip:()=>new Promise((a,b)=>l(["../../chunks/calcite-chip"],a,b)),icon:()=>new Promise((a,b)=>l(["../../chunks/calcite-icon"],
a,b)),input:()=>new Promise((a,b)=>l(["../../chunks/calcite-input"],a,b)),loader:()=>new Promise((a,b)=>l(["../../chunks/calcite-loader"],a,b)),list:()=>new Promise((a,b)=>l(["../../chunks/calcite-list"],a,b)),"list-item":()=>new Promise((a,b)=>l(["../../chunks/calcite-list-item"],a,b)),tooltip:()=>new Promise((a,b)=>l(["../../chunks/calcite-tooltip"],a,b))})}destroy(){this._tooltipReferenceMap.clear()}get _numAssociatedFeatures(){const a=this.viewModel.associationViewModels;return this.selectedLayer?
a.get(this.selectedLayer).length:0}set currentFeaturePage(a){const {_featuresPerPage:b,_numAssociatedFeatures:c}=this;this._currentFeaturePage=Math.max(Math.min(a,Math.ceil(c/b)||1),1)}get currentFeaturePage(){return this._currentFeaturePage}render(){const a=this.viewModel.associationViewModels,{state:b,showAllEnabled:c}=this.viewModel,{state:d}=this.parentFeatureViewModel??{};return h.tsx("div",{class:this.classes("esri-feature-relationship",D.globalCss.widget)},"loading"===b||"querying"===b||"loading"===
d?this._renderLoading():h.tsx("calcite-list",null,c&&this.selectedLayer?h.tsx(h.tsxFragment,null,this._renderFilter(),this._renderAssociatedFeatureListPage(),this._renderFeatureObserver()):Array.from(a.keys(),k=>this._renderTypeList(k,a.get(k)))))}_renderFilter(){return h.tsx("div",{class:"esri-feature__filter-container",key:"filter"},h.tsx("calcite-input",{icon:"search",placeholder:this.messages.associationFilterPlaceholder,type:"search",onCalciteInputInput:a=>{this._filterText=a.target.value.trim().toLowerCase();
this._currentFeaturePage=1}}))}_showAllAssociations(a){const {flowItems:b,viewModel:c,description:d}=this;b&&a&&(c.showAllEnabled=!0,a=new n({selectedLayer:a,title:a?.title,flowItems:b,parentFeatureViewModel:this.parentFeatureViewModel,featureVisibleElements:this.featureVisibleElements,description:d,visibleElements:{title:!1,description:!1},viewModel:c}),b.push(a))}_renderAssociatedFeatureListPage(){const {currentFeaturePage:a,_featuresPerPage:b,_maxNumFeatures:c,_filterText:d}=this;var k=Math.min(a*
b,c);k=this.viewModel.associationViewModels.get(this.selectedLayer).filter(m=>q.getFeaturePopupTitle(m.featureViewModel).toLowerCase().includes(d)).slice(0,k);return[...this._renderTooltips(k),...this._renderAssociatedFeatureList(k)]}async _handleAssociatedFeatureObserverChange(){this._associatedFeatureIntersectionObserverNode&&this._associatedFeatureIntersectionObserver.unobserve(this._associatedFeatureIntersectionObserverNode);const {state:a,showAllEnabled:b}=this.viewModel;await w.after(0);this._associatedFeatureIntersectionObserverNode&&
"ready"===a&&b&&this._associatedFeatureIntersectionObserver.observe(this._associatedFeatureIntersectionObserverNode)}_associatedFeatureIntersectionObserverCreated(a){this._associatedFeatureIntersectionObserverNode=a}_renderFeatureObserver(){return h.tsx("div",{afterCreate:this._associatedFeatureIntersectionObserverCreated,bind:this,class:"esri-feature__feature-observer",key:"feature-observer"})}_increaseFeaturePage(){this.currentFeaturePage++}_renderLoading(){return h.tsx("div",{class:"esri-feature__loading-container",
key:"loading-container"},this._renderLoadingIcon())}_renderLoadingIcon(){return h.tsx("calcite-loader",{inline:!0,label:""})}isConnectivity(a){return["connectivity","junction-junction-connectivity","junction-edge-from-connectivity","junction-midspan-connectivity","junction-edge-to-connectivity"].includes(a.association.associationType)}_getConnectivityTooltip(a){switch(a){case "connectivity":case "junction-junction-connectivity":return this.messages.associationsJunctionJunction;case "junction-edge-from-connectivity":return this.messages.associationsJunctionEdgeFrom;
case "junction-midspan-connectivity":return this.messages.associationsJunctionEdgeMidspan;case "junction-edge-to-connectivity":return this.messages.associationsJunctionEdgeTo;default:return""}}_renderItemTooltip(a){const {_tooltipReferenceMap:b}=this;return this.isConnectivity(a)?h.tsx("calcite-tooltip",{key:`tooltip-${a.featureViewModel.uid}`,referenceElement:b.get(a.featureViewModel.uid)},this._getConnectivityTooltip(a.association.associationType)):null}_renderConnectivityIcon(a,b){switch(a){case "junction-edge-from-connectivity":a=
"connection-end-left";break;case "junction-edge-to-connectivity":a="connection-end-right";break;case "junction-midspan-connectivity":a="connection-middle";break;default:a="connection-to-connection"}return h.tsx("calcite-icon",{afterCreate:c=>this._tooltipReferenceMap.set(b,c),afterRemoved:()=>this._tooltipReferenceMap.delete(b),icon:a,scale:"s",slot:"content-start"})}_formatPercentAlong(a){return`${A.formatNumber(a.association.percentAlong,{style:"percent",maximumFractionDigits:2})}`}_renderAssociatedFeature(a){const {featureViewModel:b}=
a,c=q.getFeaturePopupTitle(b),d="loading"===b.state,k=this._findFlowItem(b),m=0>k&&this._isParentFeature(b),p=m||0<=k,v=this.isConnectivity(a),F=v&&"junction-midspan-connectivity"===a.association.associationType;return h.tsx("calcite-list-item",{class:this.classes("esri-feature-relationship__list-item",{["esri-feature-relationship__list-item--hidden"]:d}),description:a.terminalName??"",key:`associated-feature-type-${b.uid}`,label:c,onCalciteListItemSelect:()=>this._handleFeatureClick(m,k,b)},v?this._renderConnectivityIcon(a.association.associationType,
a.featureViewModel.uid):null,F?h.tsx("calcite-chip",{scale:"s",slot:"content-end",value:a.association.percentAlong},this._formatPercentAlong(a)):null,this._renderChevronIconNode(p))}async _selectAssociation(a){const {flowItems:b,featureVisibleElements:c}=this;if(b){a.abilities={utilityNetworkAssociationsContent:!0};var {default:d}=await new Promise((k,m)=>l(["../Feature"],p=>k(Object.freeze(Object.defineProperty({__proto__:null,default:p},Symbol.toStringTag,{value:"Module"}))),m));b.push(new d({flowItems:b,
flowType:"feature-association",viewModel:a,visibleElements:c}))}}_handleFeatureClick(a,b,c){if(a)this.flowItems.drain(d=>{"showAllEnabled"in d.viewModel&&(d.viewModel.showAllEnabled=!1);d.viewModel=null;d.destroy()});else if(0>b||!this.flowItems)this._selectAssociation(c);else for(;this.flowItems.length>b+1;)if(a=this.flowItems.pop())"showAllEnabled"in a.viewModel&&(a.viewModel.showAllEnabled=!1),a.viewModel=null,a.destroy()}_featureViewModelMatch(a,b){a=a.graphic;var c=a?.layer,d=null;"subtype-sublayer"===
c?.type&&c.parent?d=c.parent.globalIdField??null:c&&"globalIdField"in c&&(d=c.globalIdField);a=d?a?.attributes[d]:null;b=b.graphic;c=b?.layer;d=null;"subtype-sublayer"===c?.type&&c.parent?d=c.parent.globalIdField??null:c&&"globalIdField"in c&&(d=c.globalIdField);b=d?b?.attributes[d]:null;return a&&b&&a===b}_isParentFeature(a){const b=this.flowItems?.getItemAt(0);return b?this._featureViewModelMatch(b.parentFeatureViewModel,a):!1}_findFlowItem(a){return this.flowItems?.findIndex(b=>"feature"!==b.flowType?
!1:this._featureViewModelMatch(b.viewModel,a))??-1}_renderTooltips(a){return a.toArray().map(b=>this._renderItemTooltip(b))}_renderAssociatedFeatureList(a){return a.toArray().map(b=>this._renderAssociatedFeature(b))}_renderChevronIconNode(a){return h.tsx("calcite-icon",{flipRtl:!0,icon:a?"move-up":"chevron-right",scale:"s",slot:"content-end"})}_renderTypeList(a,b){const {messages:c}=this,d=b.slice(0,this._previewDisplayCount),k=d.length<b.length;return h.tsx("calcite-list-item",{key:"show-all",label:a.title,
open:!0,value:a.id},h.tsx("calcite-chip",{scale:"s",slot:"actions-end",value:a.id},b.length),h.tsx("calcite-list",{group:a.id},[this._renderTooltips(d),this._renderAssociatedFeatureList(d)],k?h.tsx("calcite-list-item",{description:E.substitute(c?.numberRecords,{number:b.length.toString()}),key:"show-all-item",label:c.showAll,onCalciteListItemSelect:()=>this._showAllAssociations(a)},h.tsx("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})):null))}};f.__decorate([g.property()],e.prototype,"flowType",
void 0);f.__decorate([g.property()],e.prototype,"description",void 0);f.__decorate([g.property()],e.prototype,"headingLevel",void 0);f.__decorate([g.property()],e.prototype,"title",void 0);f.__decorate([g.property({type:r})],e.prototype,"viewModel",void 0);f.__decorate([g.property()],e.prototype,"parentFeatureViewModel",void 0);f.__decorate([g.property()],e.prototype,"listType",void 0);f.__decorate([g.property()],e.prototype,"selectedLayer",void 0);f.__decorate([g.property()],e.prototype,"featureVisibleElements",
void 0);f.__decorate([g.property()],e.prototype,"flowItems",void 0);f.__decorate([g.property(),u.messageBundle("esri/widgets/Feature/t9n/Feature")],e.prototype,"messages",void 0);f.__decorate([g.property(),u.messageBundle("esri/t9n/common")],e.prototype,"messagesCommon",void 0);f.__decorate([g.property({type:t,nonNullable:!0})],e.prototype,"visibleElements",void 0);f.__decorate([g.property()],e.prototype,"_featuresPerPage",void 0);f.__decorate([g.property()],e.prototype,"_maxNumFeatures",void 0);
f.__decorate([g.property()],e.prototype,"_numAssociatedFeatures",null);f.__decorate([g.property()],e.prototype,"_currentFeaturePage",void 0);f.__decorate([g.property()],e.prototype,"currentFeaturePage",null);f.__decorate([g.property()],e.prototype,"_previewDisplayCount",void 0);f.__decorate([g.property()],e.prototype,"_associatedFeatureIntersectionObserverNode",void 0);f.__decorate([g.property()],e.prototype,"_tooltipReferenceMap",void 0);f.__decorate([g.property()],e.prototype,"_filterText",void 0);
return e=n=f.__decorate([z.subclass("esri.widgets.Feature.FeatureUtilityNetworkAssociationType")],e)});