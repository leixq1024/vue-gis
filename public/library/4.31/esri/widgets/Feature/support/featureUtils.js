// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../core/has ../../../core/Logger ../../../core/string ../../../intl/date ../../../intl/number ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../smartMapping/support/utils ../../../support/arcadeOnDemand ../../../time/timeZoneUtils".split(" "),function(g,R,q,r,t,m,p,S,u,T,U){function C(a){return a?D.test(a):!1}function V(a,b){if(b&&C(b)&&a){var c=b.replace(D,"").toLowerCase();return a.find(({name:d})=>d.toLowerCase()===c)}}function v(a,b){return(b=
w(b,a))?b.name:a}function w(a,b){return a&&"function"===typeof a.getField&&b?a.getField(b)??null:null}function E({formattedAttributes:a,template:b,fieldInfoMap:c}){return`${r.replace(r.replace(b,d=>`{${c.get(d.toLowerCase())?.fieldName||d}}`),a).replaceAll(W,"")}`.trim()}function X(a,b,c=!1){const d=b[a];"string"===typeof d&&(c=(c?encodeURIComponent(d):d).replaceAll(Y,"%27"),b[a]=c)}function Z(a,b=!1){const c={...a};Object.keys(c).forEach(d=>X(d,c,b));return c}function F(a,b){return a.replaceAll(aa,
(c,d,f)=>(c=w(b,f))?`{${c.name}}`:d)}function ba(a,b,c){return(a=F(a,c))?a.replaceAll(ca,(d,f,e)=>{f=`${f||e}`.trim();return r.replace(d,Z(b,f&&"{"!==f[0]||!1))}):a}function x(a){return null!=a&&"object"===typeof a&&"fieldsIndex"in a&&"geometryType"in a&&"getField"in a&&"load"in a&&"loaded"in a&&"objectIdField"in a&&"spatialReference"in a&&"type"in a&&("feature"===a.type||"scene"===a.type||"subtype-sublayer"===a.type||"sublayer"===a.type)&&"when"in a}function G(a){return null!=a&&"object"===typeof a&&
"createQuery"in a&&"queryFeatureCount"in a&&"queryObjectIds"in a&&"queryRelatedFeatures"in a&&"queryRelatedFeaturesCount"in a&&"relationships"in a}function H(a){return a&&"object"===typeof a&&"createQuery"in a&&"queryFeatureCount"in a&&"type"in a?"subtype-sublayer"===a.type&&"parent"in a&&a.parent&&"object"===typeof a.parent?"globalIdField"in a.parent:"globalIdField"in a:!1}function y(a){return x(a)&&G(a)}function I(a,b){const {fieldInfos:c,fieldName:d,preventPlacesFormatting:f,layer:e,timeZone:k}=
b;b=J(c,d);var h=w(e,d);if(b&&!p.isRasterPixelValueField(d)){h=h?.type;const l=b.format?.dateFormat;if("date"===h||"date-only"===h||"time-only"===h||"timestamp-offset"===h||l)return u.formatAnyDate(a,{format:l,fieldType:h,timeZoneOptions:{layerTimeZone:e&&"preferredTimeZone"in e?e.preferredTimeZone:null,viewTimeZone:k,datesInUnknownTimezone:e&&"datesInUnknownTimezone"in e?!!e.datesInUnknownTimezone:!1}})}b=b?.format;if("string"===typeof a&&p.isRasterPixelValueField(d)&&b)return a=a.trim(),/\d{2}-\d{2}/.test(a)?
a:a.includes(",")?z(a,",",", ",b):a.includes(";")?z(a,";","; ",b):a.includes(" ")?z(a," "," ",b):m.formatNumber(Number(a),m.convertNumberFormatToIntlOptions(b));"string"!==typeof a||!b||null!=b.dateFormat||null==b.places&&null==b.digitSeparator||(h=Number(a),isNaN(h)||(a=h));return"string"===typeof a||null==a||null==b?A(a):f?m.formatNumber(a,{...m.convertNumberFormatToIntlOptions(b),minimumFractionDigits:0,maximumFractionDigits:20}):m.formatNumber(a,m.convertNumberFormatToIntlOptions(b))}function z(a,
b,c,d){return a.trim().split(b).map(f=>m.formatNumber(Number(f),m.convertNumberFormatToIntlOptions(d))).join(c)}function J(a,b){if(a?.length&&b)return a.find(c=>c.fieldName?.toLowerCase()===b.toLowerCase())}function da({fieldName:a,graphic:b,layer:c}){if(B(a)||!c||"function"!==typeof c.getFeatureType)return null;const {typeIdField:d}=c;return d&&a===d?(a=c.getFeatureType(b))?a.name:null:null}function ea({fieldName:a,value:b,graphic:c,layer:d}){return B(a)||!d||"function"!==typeof d.getFieldDomain?
null:(a=c&&d.getFieldDomain(a,{feature:c,excludeImpliedDomains:R("esri-widget-legacy-field-domain-calculation")}))&&"coded-value"===a.type?a.getName(b):null}function A(a){return"string"===typeof a?a.replaceAll(fa,'\x3cbr class\x3d"esri-text-new-line" /\x3e'):a}function K(a){const {value:b,fieldName:c,fieldInfos:d,fieldInfoMap:f,layer:e,graphic:k,timeZone:h}=a;return null==b?"":(a=ea({fieldName:c,value:b,graphic:k,layer:e}))||(a=da({fieldName:c,graphic:k,layer:e}))?a:f.get(c.toLowerCase())?I(b,{fieldInfos:d||
Array.from(f.values()),fieldName:c,layer:e,timeZone:h}):(a=e?.fieldsIndex?.get(c))&&(u.isAnyDateField(a)||p.isTimeOnlyField(a))?u.formatAnyDate(b,{fieldType:a.type,timeZoneOptions:{layerTimeZone:e&&"preferredTimeZone"in e?e.preferredTimeZone:null,viewTimeZone:h,datesInUnknownTimezone:e&&"datesInUnknownTimezone"in e?!!e.datesInUnknownTimezone:!1}}):A(b)}async function L(a,b){const {layer:c,graphic:d,outFields:f,objectIds:e,returnGeometry:k,spatialReference:h}=a;a=e[0];if("number"!==typeof a&&"string"!==
typeof a)return b={layer:c,graphic:d,objectId:a,requiredFields:f},q.getLogger("esri.widgets.Feature.support.featureUtils").warn("Could not query required fields for the specified feature. The feature's ID is invalid.",b),null;if(!S.getEffectiveLayerCapabilities(c)?.operations?.supportsQuery)return b={layer:c,graphic:d,requiredFields:f,returnGeometry:k},q.getLogger("esri.widgets.Feature.support.featureUtils").warn("The specified layer cannot be queried. The following fields will not be available.",
b),null;a=c.createQuery();a.objectIds=e;a.outFields=f?.length?f:[c.objectIdField];a.returnGeometry=!!k;a.returnZ=!!k;a.returnM=!!k;a.outSpatialReference=h;return(await c.queryFeatures(a,b)).features[0]}async function ha(a){if(!a.expressionInfos?.length)return!1;var b=await T.loadArcade();({arcadeUtils:{hasGeometryFunctions:b}}=b);return b(a)}function B(a=""){return a?a.includes("relationships/"):!1}function M({attributes:a,graphic:b,relatedInfo:c,fieldInfos:d,fieldInfoMap:f,layer:e,timeZone:k}){a&&
b&&c&&Object.keys(b.attributes).forEach(h=>{var l=(l={layerId:c.relation.id.toString(),fieldName:h},`${"relationships/"}${l.layerId}/${l.fieldName}`);a[l]=K({fieldName:l,fieldInfos:d,fieldInfoMap:f,layer:e,value:b.attributes[h],graphic:b,timeZone:k})})}function ia({attributes:a,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:f,timeZone:e}){a&&b&&(b.relatedFeatures?.forEach(k=>M({attributes:a,graphic:k,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:f,timeZone:e})),b.relatedStatsFeatures?.forEach(k=>
M({attributes:a,graphic:k,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:f,timeZone:e})))}function N(a,b){return a?.allTables.find(c=>"feature"===c.type&&c.layerId===b.id&&c.url===b.layer?.url)}function n({map:a,relationship:b,relationship:{relatedTableId:c},relatedLayer:d,layers:f}){if(!f)return null;for(const e of f)if("map-image"===e.type){if(f=n({layers:e.sublayers,map:a,relatedLayer:d,relationship:b})||n({layers:e.subtables,map:a,relatedLayer:d,relationship:b}))return f}else if(y(e))if("sublayer"===
d.type){if(e!==d&&e.id===c)return e.isTable?N(a,e):e}else{f="scene"===d.type&&d.associatedLayer?d.associatedLayer.url:d.url;if(!f)break;if("sublayer"===e.type){if(e!==d&&e.layer?.url===f&&e.id===c)return e.isTable?N(a,e):e}else if(e!==d&&e.url===f&&e.layerId===c)return e}return null}const W=/href=(""|'')/gi,aa=/(\{([^{\r\n]+)\})/g,Y=/'/g,D=/^\s*expression\//i,fa=/(\n)/gi,ja=/[\u00A0-\u9999<>&]/gim,ca=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,ka=/^(?:mailto:|tel:)/,O=t.convertDateFormatToIntlOptions("short-date-short-time"),
P=a=>{if(!a)return!1;a=a.toUpperCase();return a.includes("CURRENT_TIMESTAMP")||a.includes("CURRENT_DATE")||a.includes("CURRENT_TIME")},Q=({layer:a,method:b,query:c,definitionExpression:d})=>{a.capabilities?.query?.supportsCacheHint&&"attachments"!==b&&(a=null!=c.where?c.where:null,b=null!=c.geometry?c.geometry:null,P(d)||P(a)||"extent"===b?.type||"tile"===c.resultType||(c.cacheHint=!0))};g.applyTextFormattingHTML=A;g.createFieldInfoMap=function(a,b){const c=new Map;if(!a)return c;for(const d of a)d.fieldName&&
(a=v(d.fieldName,b),d.fieldName=a,c.set(a.toLowerCase(),d));return c};g.findRelatedLayer=function(a,b,c){return a&&b&&c?"sublayer"===b.type?n({layers:b.layer?.sublayers,map:a,relatedLayer:b,relationship:c})||n({layers:b.layer?.subtables,map:a,relatedLayer:b,relationship:c}):n({layers:a.allLayers,map:a,relatedLayer:b,relationship:c})||n({layers:a.allTables,map:a,relatedLayer:b,relationship:c}):null};g.findUtilityNetwork=function(a,b){return a&&"utilityNetworks"in a&&b?a.utilityNetworks?.find(c=>c.isUtilityLayer(b)):
null};g.fixTokens=F;g.formatAttributes=function({fieldInfos:a,attributes:b,layer:c,graphic:d,fieldInfoMap:f,relatedInfos:e,timeZone:k}){const h={};e?.forEach(l=>ia({attributes:h,relatedInfo:l,fieldInfoMap:f,fieldInfos:a,layer:c,timeZone:k}));b&&Object.keys(b).forEach(l=>{h[l]=K({fieldName:l,fieldInfos:a,fieldInfoMap:f,layer:c,value:b[l],graphic:d,timeZone:k})});return h};g.formatEditInfo=function(a,b,c,d){const {creatorField:f,creationDateField:e,editorField:k,editDateField:h}=a;if(b){a=U.getTimeZoneFormattingOptions(d&&
"preferredTimeZone"in d?d.preferredTimeZone:null,d&&"datesInUnknownTimezone"in d?!!d.datesInUnknownTimezone:!1,c,O,"date");a={...O,...a};c=b[h];if("number"===typeof c)return b=b[k],{type:"edit",date:t.formatDate(c,a),user:b};c=b[e];return"number"===typeof c?(b=b[f],{type:"create",date:t.formatDate(c,a),user:b}):null}};g.formatValueToFieldInfo=I;g.getAllFieldInfos=function(a){const b=[];if(!a)return b;const {fieldInfos:c,content:d}=a;c&&b.push(...c);if(!d||!Array.isArray(d))return b;d.forEach(f=>{"fields"===
f.type&&(f=f?.fieldInfos)&&b.push(...f)});return b};g.getFieldInfo=J;g.getFieldInfoLabel=function(a,b){return(b=V(b,a?.fieldName))?b.title||null:a?a.label||a.fieldName:null};g.getFixedFieldName=v;g.getFixedFieldNames=function(a,b){return a&&a.map(c=>v(c,b))};g.getHighlightKeyForFeature=function(a){const b=a.getObjectId();return null!=b?`oid:${b}`:`uid:${a.uid}`};g.getSourceLayer=function(a){if(null!=a)return(a.sourceLayer||a.layer)??void 0};g.graphicCallback=async function({type:a,value:b,event:c}){try{return"function"===
typeof b?b(c):await b}catch(d){q.getLogger("esri.widgets.Feature.support.featureUtils").error("error",`An error occurred when calling the "${a}" function`,{error:d,graphic:c.graphic,value:b})}};g.htmlEntities=function(a){return a.replaceAll(ja,b=>`&#${b.charCodeAt(0)};`)};g.isAssociatedFeatureSupportedLayer=function(a){return x(a)&&H(a)};g.isAssociatedLayer=H;g.isExpressionField=C;g.isFeatureSupportedLayer=x;g.isGraphicForRelatableFeatureSupportedLayer=function(a){return!!a&&"object"===typeof a&&
"sourceLayer"in a&&y(a.sourceLayer)};g.isRelatableFeatureSupportedLayer=y;g.isRelatableLayer=G;g.isRelatedField=B;g.preLayerQueryCallback=({query:a,layer:b,method:c})=>{Q({layer:b,method:c,query:a,definitionExpression:`${b.definitionExpression} ${b.serviceDefinitionExpression??""}`})};g.preRequestCallback=({queryPayload:a,layer:b,method:c})=>{Q({layer:b,method:c,query:a,definitionExpression:`${b.definitionExpression} ${b.serviceDefinitionExpression??""}`})};g.querySourceLayer=L;g.queryUpdatedFeature=
async function({graphic:a,popupTemplate:b,layer:c,spatialReference:d},f){if(c&&b&&("function"===typeof c.load&&await c.load(f),a.attributes)){var e=c.objectIdField,k=a.attributes[e];if(null!=k){k=[k];var h=await b.getRequiredFields(c.fieldsIndex),l=p.featureHasFields(h,a);e=l?[]:h.includes(e)?h:[...h,e];b=b.returnGeometry||await ha(b);if(!l||b)if(c=await L({layer:c,graphic:a,outFields:e,objectIds:k,returnGeometry:b,spatialReference:d},f))c.geometry&&(a.geometry=c.geometry),c.attributes&&(a.attributes=
{...a.attributes,...c.attributes})}}};g.shouldOpenInNewTab=function(a=""){if(a)return!ka.test(a.trim().toLowerCase())};g.substituteAttributes=E;g.substituteFieldsInLinksAndAttributes=function({attributes:a,globalAttributes:b,layer:c,text:d,expressionAttributes:f,fieldInfoMap:e}){return d?E({formattedAttributes:b,template:ba(d,{...b,...f,...a},c),fieldInfoMap:e}):""};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});