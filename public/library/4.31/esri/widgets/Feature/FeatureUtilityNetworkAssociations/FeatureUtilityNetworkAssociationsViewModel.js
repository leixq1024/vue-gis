// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/Clonable ../../../core/Collection ../../../core/Identifiable ../../../core/promiseUtils ../../../core/ReactiveMap ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../layers/FeatureLayer ../../../networks/support/typeUtils ../../../rest/networks/support/Association ../../../rest/networks/support/NetworkElement ../../../rest/support/Query ./resources ../support/featureUtils".split(" "),
function(g,G,f,H,x,I,z,J,B,h,O,P,Q,K,L,C,M,D,E,m,F){f=class extends H.ClonableMixin(I.IdentifiableMixin(f)){constructor(a){super(a);this._loaded=!1;this._queryFeatureCountAbortController=this._queryPageAbortController=this._queryAbortController=null;this.networkSourceIdsInUse=new Set;this.map=this.layer=this.graphic=this.description=null;this.featureCount=0;this.associationTypes=null;this.showAllEnabled=!1;this.title=null;this.connectivityFeatureCount=this.containerFeatureCount=this.contentFeatureCount=
this.structureFeatureCount=this.attachmentsFeatureCount=0;this._cancelQuery=()=>{const {_queryAbortController:b}=this;b&&b.abort();this._queryAbortController=null};this._cancelQueryFeatureCount=()=>{const {_queryFeatureCountAbortController:b}=this;b&&b.abort();this._queryFeatureCountAbortController=null};this._queryController=async b=>{this._cancelQuery();const c=new AbortController;this._queryAbortController=c;await z.ignoreAbortErrors(this._query(b));this._queryAbortController===c&&(this._queryAbortController=
null)};this._queryFeatureCountController=async()=>{this._loaded=!1;this._cancelQueryFeatureCount();const b=new AbortController;this._queryFeatureCountAbortController=b;await z.ignoreAbortErrors(this._queryFeatureCount());this._queryFeatureCountAbortController===b&&(this._queryFeatureCountAbortController=null);this._loaded=!0};this._queryDebounced=z.debounce(this._queryController,100);this._queryFeatureCountDebounced=z.debounce(this._queryFeatureCountController,100)}initialize(){this.associationTypes?.forEach(a=>
{a.open=!1});this.addHandles([...(this.associationTypes?.map(a=>B.watch(()=>a.open,()=>{a.open&&this._queryDebounced(a)}))??[]),B.watch(()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery],()=>this._queryFeatureCountDebounced(),B.initial)])}destroy(){this._cancelQuery();this._cancelQueryFeatureCount();this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){return!!this.layer?.capabilities?.query?.supportsCacheHint}get canLoad(){return!!this.map&&
!!this.associationTypes&&"string"===typeof this.globalId}get canQuery(){const a=this.layer?.capabilities?.query;return!!this.associationTypes&&"string"===typeof this.globalId&&!!a?.supportsPagination}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){const {layer:a}=this;return"subtype-sublayer"===
a?.type&&a?.parent?a.parent.globalIdField??null:a?.globalIdField??null}get state(){const {_queryAbortController:a,_queryFeatureCountAbortController:b,_queryPageAbortController:c,canQuery:d,_loaded:l,canLoad:e}=this;return b||e&&!l?"loading":a||c?"querying":d&&0!==this.featureCount?"ready":"disabled"}get utilityNetwork(){const {layer:a,map:b}=this;return a?.loaded&&b?"subtype-sublayer"===a?.type&&a?.parent?F.findUtilityNetwork(b,a.parent)??null:F.findUtilityNetwork(b,a)??null:null}get associationsLayer(){const {utilityNetwork:a}=
this;return a?.loaded?new L({url:a.networkSystemLayers.associationsTableUrl,gdbVersion:a.gdbVersion}):null}get attachmentsAssociations(){return this._get("attachmentsAssociations")||new x}get structureAssociations(){return this._get("structureAssociations")||new x}get contentAssociations(){return this._get("contentAssociations")||new x}get containerAssociations(){return this._get("containerAssociations")||new x}get connectivityAssociations(){return this._get("connectivityAssociations")||new x}get associationFeatures(){return this._get("associationFeatures")||
new J}get associationViewModels(){return this._get("associationViewModels")||new Map}refresh(){this._queryFeatureCountDebounced()}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach(a=>a.destroyAll())}_generateGlobalIdWhereClause(a,b){const {globalId:c,networkSourceIdsInUse:d}=this;var {associatedNetworkSourceId:l}=a;const e=b.fieldsIndex.get(m.featureUtilityNetworkFields.fromGlobalId),p=b.fieldsIndex.get(m.featureUtilityNetworkFields.toGlobalId),u=b.fieldsIndex.get(m.featureUtilityNetworkFields.fromNetworkSourceId);
var n=b.fieldsIndex.get(m.featureUtilityNetworkFields.toNetworkSourceId);b=null!=l;const q=`(${Array.from(d.values())})`;n=b?` AND ${n.name} = ${l} AND ${n.name} IN ${q}`:"";l=b?` AND ${u.name} = ${l} AND ${u.name} IN ${q}`:"";switch(a.type){case "connectivity":return`((${e.name} = '${c}'${n}) OR (${p.name} = '${c}'${l}))`;case "attachment":case "content":return`${e.name} = '${c}'${n}`;case "container":case "structure":return`${p.name} = '${c}'${l}`;default:return""}}_generateNetworkSourceIdWhereClause(a){var {networkSourceIdsInUse:b}=
this;b=`(${Array.from(b.values())})`;const c=a.fieldsIndex.get(m.featureUtilityNetworkFields.fromNetworkSourceId);a=a.fieldsIndex.get(m.featureUtilityNetworkFields.toNetworkSourceId);return`(${c.name} IN ${b} AND ${a.name} IN ${b})`}_generateAssociationTypeWhereClause(a,b){b=b.fieldsIndex.get(m.featureUtilityNetworkFields.associationType);switch(a.type){case "attachment":case "structure":return`${b.name} = 3`;case "connectivity":return`${b.name} IN  (1, 4, 5, 6)`;case "container":case "content":return`${b.name} = 2`;
default:return""}}_generateWhereClause(a,b){var c=b.fieldsIndex.get(m.featureUtilityNetworkFields.status),d=`(${C.AssociationOpenStatus.join(",")})`;c=`${c.name} IN ${d}`;d=this._generateGlobalIdWhereClause(a,b);a=this._generateAssociationTypeWhereClause(a,b);return`(${d} AND ${c} AND ${a})`}async _loadUtiltyNetworks(){const a=this.map;if(a){await Promise.allSettled(a.utilityNetworks?.map(async d=>{await d.load()})??[]);var b=d=>{"layerId"in d&&c.isUtilityLayer(d)&&(d=c.getSourceIdByLayerId(d.layerId),
null!==d&&this.networkSourceIdsInUse.add(d))},c=this.utilityNetwork;this._set("networkSourceIdsInUse",new Set);a.allLayers.forEach(b);a.allTables.forEach(b)}}async _findLayersBySourceId(a){const {utilityNetwork:b,map:c}=this;var d=e=>e.url&&e.layerId===l?e.url.replace(/\/\d+$/,"")===b?.featureServiceUrl:!1;await b?.load();const l=b.getLayerIdBySourceId(a);a=c.allLayers.filter(d);d=c.allTables.filter(d);d=a.concat(d).toArray();await Promise.allSettled(d.map(e=>e.load()));return d}_clearAssociations(){this.attachmentsAssociations.removeAll();
this.structureAssociations.removeAll();this.contentAssociations.removeAll();this.containerAssociations.removeAll();this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach(a=>a.removeAll());this.associationFeatures.clear()}_getAssociationsByType(a){switch(a){case "attachment":return this.attachmentsAssociations;case "structure":return this.structureAssociations;case "connectivity":return this.connectivityAssociations;case "container":return this.containerAssociations;
case "content":return this.contentAssociations}}_createAssociationFromFeature(a,b){if(!a)return null;const c=C.AssociationTypeDict.get(b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.associationType).name]);return new M({globalId:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.globalId).name],fromNetworkElement:new D({globalId:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.fromGlobalId).name],networkSourceId:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.fromNetworkSourceId).name],
terminalId:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.fromTerminalId).name]}),toNetworkElement:new D({globalId:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.toGlobalId).name],networkSourceId:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.toNetworkSourceId).name],terminalId:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.toTerminalId).name]}),associationType:c,status:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.status).name],
isContentVisible:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.isContentVisible).name],percentAlong:b.attributes[a.fieldsIndex.get(m.featureUtilityNetworkFields.percentAlong).name]})}async _queryLayer(a,b,c,d,l){const e=a.fieldsIndex.get(m.featureUtilityNetworkFields.assetGroup),p=a.fieldsIndex.get(m.featureUtilityNetworkFields.assetType),u=null!=c,n=null!=d;b="("+b.map(q=>`'${q}'`).join(", ")+")";c=new E({outFields:["*"],cacheHint:this.supportsCacheHint,where:`${a.globalIdField} IN ${b}`+
(u?` AND ${e?.name} = ${c}`:"")+(u&&n?` AND ${p?.name} = ${d}`:"")});return await this._queryAll(c,a,{signal:l?.signal})}async _createAssociationFeatureObjects(a,b,c,d,l,e){if(0===a.length)return[];const p=new Map;for(const [n,q]of b){b=await this._findLayersBySourceId(n);for(const v of b)(await this._queryLayer(v,q,d,l,e)).forEach(r=>{if(r.getEffectivePopupTemplate()&&r.layer){const t=p.get(r.attributes[v.globalIdField])??[];t.push(r);p.set(r.attributes[v.globalIdField],t)}})}const u=[];a.toArray().forEach(n=>
{const q=n.fromNetworkElement.globalId===c?n.toNetworkElement:n.fromNetworkElement;(p.get(q.globalId)??[]).forEach(v=>{const r=this.utilityNetwork?.getTerminalById(q?.terminalId)?.name;u.push({association:n,feature:v,terminalName:r})})});return u}_parseFeatureObjects(a,b){a.forEach(c=>{const d=(c?.feature).layer,l=b.get(d)??new x;l.add(c);b.set(d,l)})}async _queryAll(a,b,c){const d=[];let l=0,e=!1;a.num=b.sourceJSON?.maxRecordCount??2E3;do{a.start=l;const p=await b.queryFeatures(a,c);d.push(...p.features);
(e=p.exceededTransferLimit)&&(l+=p.features.length)}while(e);return d}async _queryAssociatedFeatureCount(a){const {layer:b,globalId:c,supportsCacheHint:d,associationTypes:l,associationsLayer:e,utilityNetwork:p,canQuery:u}=this;await Promise.allSettled([b?.load(),p?.load(),e?.load()]);this._clearAssociations();if(u&&b&&l&&e){var n=e.fieldsIndex.get(m.featureUtilityNetworkFields.toGlobalId).name,q=e.fieldsIndex.get(m.featureUtilityNetworkFields.fromGlobalId).name,v=l.map(k=>this._generateWhereClause(k,
e)),r=this._generateNetworkSourceIdWhereClause(e);v=v.join(" OR ");r=new E({outFields:["*"],cacheHint:d,returnGeometry:!1,where:`(${v}) AND (${r})`});r=await this._queryAll(r,e,{signal:a?.signal});var t=new Map;l.forEach(k=>{t.set(k.type,[])});r.forEach(k=>{const y=e.fieldsIndex.get(m.featureUtilityNetworkFields.associationType);switch(k.attributes[y.name]){case 1:case 4:case 5:case 6:k.attributes[q]===c?t.get("connectivity").push(k.attributes[n]):t.get("connectivity").push(k.attributes[q]);this.connectivityAssociations.add(this._createAssociationFromFeature(e,
k));break;case 2:k.attributes[q]===c?(t.get("content").push(k.attributes[n]),this.contentAssociations.add(this._createAssociationFromFeature(e,k))):(t.get("container").push(k.attributes[q]),this.containerAssociations.add(this._createAssociationFromFeature(e,k)));break;case 3:k.attributes[q]===c?(t.get("attachment").push(k.attributes[n]),this.attachmentsAssociations.add(this._createAssociationFromFeature(e,k))):(t.get("structure").push(k.attributes[q]),this.structureAssociations.add(this._createAssociationFromFeature(e,
k)))}});r=l.map(async k=>{const {associatedNetworkSourceId:y,associatedAssetGroup:A,associatedAssetType:N}=k;var w=t.get(k.type);w=null!=A?await this._countAssociatedFeatures(y,w,A,N,a):w.length;switch(k.type){case "attachment":this._set("attachmentsFeatureCount",w);break;case "structure":this._set("structureFeatureCount",w);break;case "content":this._set("contentFeatureCount",w);break;case "container":this._set("containerFeatureCount",w);break;case "connectivity":this._set("connectivityFeatureCount",
w)}});await Promise.allSettled(r)}}async _countAssociatedFeatureCount(a,b,c,d,l){const e=a.fieldsIndex.get(m.featureUtilityNetworkFields.assetGroup),p=a.fieldsIndex.get(m.featureUtilityNetworkFields.assetType),u=null!=d;b="("+b.map(n=>`'${n}'`).join(", ")+")";return a.queryFeatureCount({where:`${a.globalIdField} IN ${b}`+` AND ${e?.name} = ${c}`+(u?` AND ${p?.name} = ${d}`:""),outFields:["*"],returnGeometry:!1},{signal:l?.signal})}async _countAssociatedFeatures(a,b,c,d,l){if(0===b.length)return 0;
a=(await this._findLayersBySourceId(a)).map(async e=>this._countAssociatedFeatureCount(e,b,c,d,l));return(await Promise.all(a)).reduce((e,p)=>e+p,0)}async _queryAssociatedFeatures(a,b){const {layer:c,globalId:d,associationTypes:l,associationsLayer:e,utilityNetwork:p,canQuery:u,associationFeatures:n}=this;await Promise.allSettled([c?.load(),p?.load(),e?.load()]);if(u&&c&&l&&e){var q=this._getAssociationsByType(a.type),{associatedAssetGroup:v,associatedAssetType:r}=a,t=new Map;q.forEach(k=>{const {networkSourceId:y,
elementGlobalId:A}=k.fromNetworkElement.globalId===d?{networkSourceId:k.toNetworkElement.networkSourceId,elementGlobalId:k.toNetworkElement.globalId}:{networkSourceId:k.fromNetworkElement.networkSourceId,elementGlobalId:k.fromNetworkElement.globalId};k=t.get(y)||[];k.push(A);t.set(y,k)});a=await this._createAssociationFeatureObjects(q,t,d,v,r,b);this._parseFeatureObjects(a,n)}}async _queryFeatureCount(){await this._loadUtiltyNetworks();const {_queryFeatureCountAbortController:a,canQuery:b}=this;b?
(await this._queryAssociatedFeatureCount(a),this._set("featureCount",this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set("featureCount",0)}async _query(a){await this._loadUtiltyNetworks();const {_queryAbortController:b}=this;this.featureCount&&(this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),this.destroyed||await this._queryAssociatedFeatures(a,{signal:b?.signal}))}};g.__decorate([h.property()],
f.prototype,"_loaded",void 0);g.__decorate([h.property()],f.prototype,"_queryAbortController",void 0);g.__decorate([h.property()],f.prototype,"_queryPageAbortController",void 0);g.__decorate([h.property()],f.prototype,"_queryFeatureCountAbortController",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"supportsCacheHint",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"canLoad",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"canQuery",null);g.__decorate([h.property()],
f.prototype,"networkSourceIdsInUse",void 0);g.__decorate([h.property()],f.prototype,"description",void 0);g.__decorate([h.property({type:G})],f.prototype,"graphic",void 0);g.__decorate([h.property()],f.prototype,"layer",void 0);g.__decorate([h.property()],f.prototype,"map",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"objectId",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"objectIdField",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"globalId",null);g.__decorate([h.property({readOnly:!0})],
f.prototype,"globalIdField",null);g.__decorate([h.property()],f.prototype,"featureCount",void 0);g.__decorate([h.property()],f.prototype,"associationTypes",void 0);g.__decorate([h.property()],f.prototype,"showAllEnabled",void 0);g.__decorate([h.property()],f.prototype,"state",null);g.__decorate([h.property()],f.prototype,"title",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"utilityNetwork",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"associationsLayer",null);g.__decorate([h.property({readOnly:!0})],
f.prototype,"attachmentsFeatureCount",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"structureFeatureCount",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"attachmentsAssociations",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"structureAssociations",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"contentFeatureCount",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"containerFeatureCount",void 0);g.__decorate([h.property({readOnly:!0})],
f.prototype,"contentAssociations",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"containerAssociations",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"connectivityFeatureCount",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"connectivityAssociations",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"associationFeatures",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"associationViewModels",null);return f=g.__decorate([K.subclass("esri.widgets.Feature.FeatureUtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel")],
f)});