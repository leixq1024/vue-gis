// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../core/asyncUtils ../../core/Evented ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../core/support/UpdatingHandles ../../layers/support/layerUtils ./featureTemplatesUtils ./TemplateItem ./TemplateItemGroup ../support/templateUtils".split(" "),function(d,u,c,v,r,m,e,H,I,J,w,x,y,l,z,A,t){function B(a){for(const b of a){if(l.isTemplateItemGroup(b))for(const f of b.items)f.destroy();
b.destroy()}}var p;const C=({layer:a})=>({key:a,label:a.title??""}),D=({layer:a})=>({key:a.geometryType,label:a.geometryType??""});c=p=class extends c.EventedAccessor{constructor(a){super(a);this._allItems=[];this._updatingHandles=new x.UpdatingHandles;this._updateAllItemsTask=null;this.disabled=!1;this.selectedItem=this.filterFunction=this.disabledItemFunction=null}initialize(){this._get("groupBy")||(this.groupBy="layer");this.addHandles([m.watch(()=>[this._featureTemplatesByLayer,this._groupByFunction],
()=>{this._updateAllItemsTask=v.abortMaybe(this._updateAllItemsTask);const a=u.createTask(b=>this._updateAllItems(b));this._updateAllItemsTask=a;this._updatingHandles.addPromise(a.promise)},m.syncAndInitial),m.watch(()=>this.filterFunction,a=>{for(const b of this._allItems)l.isTemplateItemGroup(b)&&(b.filterFunction=a)},m.sync)])}get _featureTemplatesByLayer(){const a=new Map;if(!this.layers)return a;for(const b of this.layers)if("subtype-group"===b.type)for(const f of b.sublayers)a.set(f,t.getAllTemplatesForLayer(f));
else a.set(b,t.getAllTemplatesForLayer(b));return a}set groupBy(a){this._set("groupBy",a);if("function"===typeof a)this._groupByFunction=b=>this._ensureGroupByObject(a(b));else switch(a){case "layer":this._groupByFunction=C;break;case "geometry":this._groupByFunction=D;break;default:this._groupByFunction=null}}get layers(){return this._get("layers")}set layers(a){this.removeHandles("layers");if(a){const b=()=>this.notifyChange("state");this.addHandles(a.map(f=>m.when(()=>f.loadStatus,b)),"layers")}this._set("layers",
a)}get state(){return this.updating?"loading":0===this.layers.length?"disabled":"ready"}get numberOfFeatureTemplates(){return Array.from(this._featureTemplatesByLayer.values()).reduce((a,b)=>a+b.length,0)}get items(){const {filterFunction:a}=this;return null==a?this._allItems:this._allItems.filter(b=>l.isTemplateItemGroup(b)?0<b.items.length:a(b))}get updating(){return this._updatingHandles.updating}refresh(){this.notifyChange("filterFunction");for(const a of this._allItems)l.isTemplateItemGroup(a)&&
a.reapplyFilter()}select(a,{emit:b=!0}={}){const f=this.selectedItem;a=a?.clone()||null;this._set("selectedItem",a);b&&this.emit("select",{item:a,oldItem:f,template:a?.template??null})}_createItem(a,b){return new z({disabledFunction:this.disabledItemFunction,layer:b,template:a})}_ensureGroupByObject(a){return"string"===typeof a?{key:a,label:a}:a}async _updateAllItems(a){var b=this._allItems;if(0===this.numberOfFeatureTemplates)B(b),this._allItems=[];else{var [f,E]=l.mapItemsByTemplate(b),F={signal:a},
q=this._featureTemplatesByLayer;b=[];for(const [g,n]of q)if(await l.loadLayerWithTemplates(g,F),r.throwIfAborted(a),q=y.getEffectiveLayerCapabilities(g)?.operations,q?.supportsEditing&&q?.supportsAdd)for(var h of n)f.has(h)?(b.push(f.get(h)),f.delete(h)):b.push(this._createItem(h,g));for(const g of[...f.values(),...E])g.destroy();if(null==this._groupByFunction)r.throwIfAborted(a),this._allItems=b;else{h=new Map;for(var k of b){b=this._groupByFunction(k);const {key:g,label:n}=null!=b.key?b:p.nullGroupBy;
h.has(g)||h.set(g,{label:n,items:[]});h.get(g)?.items.push(k)}var {filterFunction:G}=this;k=Array.from(h.values()).map(({label:g,items:n})=>new A({allItems:n,filterFunction:G,label:g}));r.throwIfAborted(a);this._allItems=1===k.length&&k[0].label===p.nullGroupBy.label?k[0].allItems:k}}}};c.nullGroupBy={key:Symbol(),label:"Other\u200b"};d.__decorate([e.property()],c.prototype,"_allItems",void 0);d.__decorate([e.property()],c.prototype,"_featureTemplatesByLayer",null);d.__decorate([e.property()],c.prototype,
"_groupByFunction",void 0);d.__decorate([e.property()],c.prototype,"_updatingHandles",void 0);d.__decorate([e.property()],c.prototype,"disabled",void 0);d.__decorate([e.property()],c.prototype,"disabledItemFunction",void 0);d.__decorate([e.property({value:null})],c.prototype,"filterFunction",void 0);d.__decorate([e.property()],c.prototype,"groupBy",null);d.__decorate([e.property({value:[]})],c.prototype,"layers",null);d.__decorate([e.property()],c.prototype,"state",null);d.__decorate([e.property({readOnly:!0})],
c.prototype,"numberOfFeatureTemplates",null);d.__decorate([e.property({readOnly:!0})],c.prototype,"items",null);d.__decorate([e.property({readOnly:!0})],c.prototype,"selectedItem",void 0);d.__decorate([e.property()],c.prototype,"updating",null);return c=p=d.__decorate([w.subclass("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],c)});