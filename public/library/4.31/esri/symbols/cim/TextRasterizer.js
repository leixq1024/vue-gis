// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["../../core/screenUtils","../support/textUtils"],function(u,v){function t(c){return`rgba(${c.slice(0,3).toString()},${c[3]})`}function q(c,a){var d=a.font;d=`${d.style} ${d.weight} ${u.pt2px(Math.max(a.size,.5)).toFixed(1)}px ${d.family}, sans-serif`;c.font=d;c.textBaseline="top";switch(a.horizontalAlignment){case "left":a="left";break;case "right":a="right";break;case "center":a="center";break;default:a="left"}c.textAlign=a}class w{constructor(c){c&&(this._textRasterizationCanvas=c)}rasterizeText(c,
a){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const d=this._textRasterizationCanvas;var b=d.getContext("2d",{willReadFrequently:!0});q(b,a);this._parameters=a;this._textLines=c.split(/\r?\n/);this._lineHeight=this._computeLineHeight();const {decoration:k,weight:n}=a.font;this._lineThroughWidthOffset=k&&"line-through"===k?.1*this._lineHeight:0;var e=(c=null!=a.backgroundColor||null!=a.borderLine)?v.backgroundPadding:0,f=this._computeTextWidth(b,
a)+2*e,g=this._lineHeight*this._textLines.length+2*e;d.width=f+2*this._lineThroughWidthOffset;d.height=g;if(0===d.width||0===d.height)return d.width=d.height=1,{size:[0,0],image:new Uint32Array(0),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0,canvas:d};this._renderedLineHeight=Math.round(this._lineHeight);this._renderedOutlineSize=(a.outline.size||0)*a.pixelRatio;this._renderedHaloSize=(a.halo.size||0)*a.pixelRatio;this._renderedWidth=f;this._renderedHeight=g;this._lineThroughWidthOffset*=a.pixelRatio;
f=(a.outline&&a.outline.color)??[0,0,0,0];g=a.halo&&a.halo.color?a.halo.color:[0,0,0,0];this._fillStyle=t(a.color??[0,0,0,0]);this._outlineStyle=t(f);this._haloStyle=`rgb(${g.slice(0,3).toString()})`;f=this._renderedLineHeight;g=this._renderedOutlineSize;var h=this._renderedHaloSize;b.save();b.clearRect(0,0,d.width,d.height);q(b,a);var l=e*a.pixelRatio;e=b.textAlign;var m=this._renderedWidth-2*l,p=this._renderedHaloSize+this._renderedOutlineSize;e=("center"===e?.5*m:"right"===e?m-p:p)+l;l=h+g+l;h=
0<h;m=this._lineThroughWidthOffset;p=0;if(c){b.save();c=a.borderLine?.color??[0,0,0,0];const x=2*(a.borderLine?.size??0);b.fillStyle=t(a.backgroundColor??[0,0,0,0]);b.strokeStyle=t(c);b.lineWidth=x;b.fillRect(0,0,d.width,d.height);b.strokeRect(0,0,d.width,d.height);b.restore()}h&&this._renderHalo(b,e,l,m,p,a);0<g&&this._renderOutline(b,e,l,m,p,a);p+=l;m+=e;for(var r of this._textLines)h&&(b.globalCompositeOperation="destination-out",b.fillStyle="rgb(0, 0, 0)",b.fillText(r,m,p),b.globalCompositeOperation=
"source-over"),b.fillStyle=this._fillStyle,b.fillText(r,m,p),k&&"none"!==k&&this._renderDecoration(b,m,p,k,n),p+=f;b.restore();r=this._renderedWidth+2*this._lineThroughWidthOffset;c=this._renderedHeight;b=b.getImageData(0,0,r,c);b=new Uint8Array(b.data);if(a.premultiplyColors)for(g=0;g<b.length;g+=4)f=b[g+3]/255,b[g]*=f,b[g+1]*=f,b[g+2]*=f;switch(a.horizontalAlignment){case "left":f=-.5;break;case "right":f=.5;break;default:f=0}switch(a.verticalAlignment){case "bottom":a=-.5;break;case "top":a=.5;
break;case "baseline":a=-1/6;break;default:a=0}return{size:[r,c],image:new Uint32Array(b.buffer),sdf:!1,simplePattern:!1,anchorX:f,anchorY:a,canvas:d}}_renderHalo(c,a,d,b,k,n){const e=this._renderedWidth,f=this._renderedHeight;this._outlineRasterizationCanvas||(this._outlineRasterizationCanvas=document.createElement("canvas"));this._outlineRasterizationCanvas.width=e;this._outlineRasterizationCanvas.height=f;const g=this._outlineRasterizationCanvas,h=g.getContext("2d");h.clearRect(0,0,e,f);q(h,n);
const {decoration:l,weight:m}=n.font;h.fillStyle=this._haloStyle;h.strokeStyle=this._haloStyle;h.lineJoin="round";this._renderOutlineNative(h,a,d,l,m,this._renderedHaloSize+this._renderedOutlineSize);c.globalAlpha=this._parameters.halo.color[3];c.drawImage(g,0,0,e,f,b,k,e,f);c.globalAlpha=1}_renderOutline(c,a,d,b,k,n){const e=this._renderedWidth,f=this._renderedHeight;this._outlineRasterizationCanvas||(this._outlineRasterizationCanvas=document.createElement("canvas"));this._outlineRasterizationCanvas.width=
e;this._outlineRasterizationCanvas.height=f;const g=this._outlineRasterizationCanvas,h=g.getContext("2d");h.clearRect(0,0,e,f);q(h,n);const {decoration:l,weight:m}=n.font;h.fillStyle=this._outlineStyle;h.strokeStyle=this._outlineStyle;h.lineJoin="round";this._renderOutlineNative(h,a,d,l,m,this._renderedOutlineSize);c.globalAlpha=this._parameters.outline.color[3];c.drawImage(g,0,0,e,f,b,k,e,f);c.globalAlpha=1}_renderOutlineNative(c,a,d,b,k,n){const e=this._renderedLineHeight;for(const f of this._textLines){const g=
2*n;for(let h=0;5>h;h++){const l=(.6+.1*h)*g;c.lineWidth=l;c.strokeText(f,a,d);b&&"none"!==b&&this._renderDecoration(c,a,d,b,k,l)}d+=e}}computeTextSize(c,a){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const d=this._textRasterizationCanvas;var b=d.getContext("2d");q(b,a);this._parameters=a;this._textLines=c.split(/\r?\n/);this._lineHeight=this._computeLineHeight();c=this._computeTextWidth(b,a);b=this._lineHeight*this._textLines.length;d.width=c;d.height=
b;return[c*a.pixelRatio,b*a.pixelRatio]}_computeTextWidth(c,a){let d=0;for(const b of this._textLines)d=Math.max(d,c.measureText(b).width);a=a.font;if("italic"===a.style||"oblique"===a.style||"string"===typeof a.weight&&("bold"===a.weight||"bolder"===a.weight)||"number"===typeof a.weight&&600<a.weight)d+=.3*c.measureText("w").width;d+=2*u.pt2px(this._parameters.halo.size);return Math.round(d)}_computeLineHeightBase(){return 1.275*this._parameters.size}_computeLineHeight(){let c=this._computeLineHeightBase();
const a=this._parameters.font.decoration;a&&"underline"===a&&(c*=1.3);return Math.round(c+2*u.pt2px(this._parameters.halo.size))}_renderDecoration(c,a,d,b,k,n){let e=.9*this._lineHeight;k="bold"===k?.06:"bolder"===k?.09:.04;switch(c.textAlign){case "center":a-=this._renderedWidth/2;break;case "right":a-=this._renderedWidth}const f=c.textBaseline;if("underline"===b)switch(e=.9*this._computeLineHeightBase(),f){case "top":d+=e;break;case "middle":d+=e/2}else if("line-through"===b)switch(f){case "top":d+=
e/1.5;break;case "middle":d+=e/3}b=n?1.5*n:Math.ceil(e*k);c.save();c.beginPath();c.strokeStyle=c.fillStyle;c.lineWidth=b;c.moveTo(a-this._lineThroughWidthOffset,d);c.lineTo(a+this._renderedWidth+2*this._lineThroughWidthOffset,d);c.stroke();c.restore()}}return w});