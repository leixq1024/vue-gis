// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require exports ../chunks/tslib.es6 ../core/asyncUtils ../core/Error ../core/has ../core/Logger ../core/promiseUtils ../core/reactiveUtils ../core/accessorSupport/decorators/property ../core/RandomLCG ../core/accessorSupport/decorators/subclass ./input/InputManager".split(" "),function(q,r,n,x,y,z,A,k,p,t,E,B,C){function h(d){return null!=d&&"open"in d&&"declaredClass"in d}function u(d){return null!=d&&"declaredClass"in d&&"dockOptions"in d}const v=d=>Object.freeze(Object.defineProperty({__proto__:null,
default:d},Symbol.toStringTag,{value:"Module"}));class D{constructor(d){this.layerView=d;this._resolver=k.createResolver();this.graphics=[]}get promise(){return this._resolver.promise}resolve(d){const {layerView:a,graphics:c,_resolver:e}=this;if(!a)return e.resolve(c),e.promise;let g;a.fetchPopupFeaturesFromGraphics(c,d).catch(b=>{g=b;return null}).then(b=>{b?e.resolve(b):e.reject(g)});return e.promise}}r.PopupView=d=>{d=class extends d{constructor(){super(...arguments);this._popupSetupTask=null;
this.popup={};this.popupEnabled=!0}initialize(){this.addHandles([p.watch(()=>[this.ui,this.popup],([a,c],e)=>{if(e){const [g,b]=e;g&&h(b)&&(b.view=null,u(b)&&g.remove(b,"popup"))}a&&h(c)&&(c.view=this,u(c)&&a.add(c,{key:"popup",position:"manual",internal:!0}))},p.initial),this.on("click",a=>{this.popup&&this.popupEnabled&&("mouse"!==a.pointerType||0===a.button)&&(h(this.popup)?this.popup.viewModel.handleViewClick(a):a.async(async()=>{await this.setupPopup();h(this.popup)&&!this.destroyed&&this.ready&&
this.popupEnabled&&this.popup.viewModel.handleViewClick(a)}))},C.ViewEventPriorities.WIDGET)]);p.whenOnce(()=>this.ready&&this.popupEnabled&&!this.updating).then(()=>{new Promise((a,c)=>q(["../widgets/Popup"],e=>a(v(e)),c))})}destroy(){this.destroyed||this.closePopup()}async openPopup(a){if(h(this.popup))return this.popup.open(a);try{await this.setupPopup(),this.popup?this.popup.open(a):A.getLogger(this).error(new y("view:null-popup","Popup is null and can't be opened"))}catch{}}closePopup(){this._popupSetupTask?.abort();
h(this.popup)&&this.popup.close()}async fetchPopupFeatures(a,c){await this.when();return this._popupHitsToFeatures(await this._getPopupHits(a,c),c)}async setupPopup(){this._popupSetupTask?.abort();if(this.popup&&!h(this.popup))return this._popupSetupTask=x.createTask(async a=>{const {default:c}=await new Promise((e,g)=>q(["../widgets/Popup"],b=>e(v(b)),g));k.throwIfAborted(a);this.popup&&!h(this.popup)&&(a=this.popup,delete a.open,delete a.close,this.popup=new c(a))}),this._popupSetupTask.promise}async _popupHitsToFeatures({location:a,
hits:c},e){const g=[],b=[];let l=!1;const w=k.wrapAbortWithTimeout(e,z("popup-view-fetch-timeout")??5E3);e=f=>{const m=b.at(-1);m&&m.layerView===f&&!l?f=m:(f=new D(f),b.push(f),g.push(f.promise));return f};for(const f of c)"graphic"in f?(e(f.layerView).graphics.push(f.graphic),l=!1):(g.push(f.layerView.fetchPopupFeaturesAtLocation(f.mapPoint,w)),l=!0);b.map(f=>f.resolve(w));c=k.allSettledValues(g).then(f=>f.filter(m=>!!m).flat());return{pendingFeatures:g,allGraphicsPromise:c,location:a}}async _getPopupHits(a,
c){const {hits:e,location:g}=await this.popupHitTest(a);k.throwIfAborted(c);a=[];for(const b of e)if("graphic"in b){if(this._isValidPopupGraphic(b.graphic,c)){const l=this._isValidPopupGraphicsLayerView(b.layerView)?b.layerView:void 0;a.push({graphic:b.graphic,layerView:l})}}else this._isValidPopupLocationLayerView(b.layerView)&&a.push({mapPoint:b.mapPoint,layerView:b.layerView});return{hits:a,location:g}}_isValidPopupGraphic(a,c){return a&&!!a.getEffectivePopupTemplate(c?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(a){return!a||
(!("layer"in a)||!a.suspended)&&"fetchPopupFeaturesFromGraphics"in a}_isValidPopupLocationLayerView(a){return(!("layer"in a)||!a.suspended)&&"fetchPopupFeaturesAtLocation"in a}};n.__decorate([t.property()],d.prototype,"popup",void 0);n.__decorate([t.property()],d.prototype,"popupEnabled",void 0);return d=n.__decorate([B.subclass("esri.views.PopupView")],d)};Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});