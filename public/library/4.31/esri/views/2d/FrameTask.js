// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../core/promiseUtils ../../core/reactiveUtils ../../core/scheduling ./PaddedViewState ../support/RenderState ../support/Scheduler".split(" "),function(h,k,l,m,g,n){class p{constructor(a){this.view=a;this._updateParameters=this._frameTaskHandle=this._stationaryHandle=null;this._updateRequested=!1;this._scheduler=n.newScheduler();this.stationary=!0;this.prepare=()=>{this._updateParameters&&(this._updateParameters.state=this.view.state,this._updateParameters.stationary=this.view.stationary,
this._updateParameters.pixelRatio=window.devicePixelRatio,this._updateParameters.renderingOptions=this.view.renderingOptions,this._updateParameters.targetState.copy(this.view.state),null==this.view.animation?.target||h.isPromiseLike(this.view.animation.target)||(this._updateParameters.targetState.viewpoint=this.view.animation.target))};this.update=b=>{this._updateRequested=!1;if(!this.view?.destroyed){var {allLayerViews:e,graphicsView:c,labelManager:d,state:{id:f}}=this.view;e.forEach(this._updateLayerView,
this);null!=d&&(d.lastUpdateId!==f&&(d.viewChange(),d.lastUpdateId=f),d.updateRequested&&d.processUpdate(this._updateParameters));null!=c&&(c.lastUpdateId!==f&&(c.viewChange(),c.lastUpdateId=f),c.updateRequested&&c.processUpdate(this._updateParameters));this.view.graphicsTileStore.setViewState(this._updateParameters.state);this._scheduler.state=this.view.animation?g.RenderState.ANIMATING:this.view.interacting?g.RenderState.INTERACTING:g.RenderState.IDLE;this._scheduler.updateBudget(b)&&this._scheduler.frame()}}}destroy(){this.stop();
this._scheduler.destroy()}get scheduler(){return this._scheduler}start(){if(!this._frameTaskHandle){var a=this.view;this.stationary=a.stationary;this._updateParameters={state:a.state,targetState:new m,pixelRatio:window.devicePixelRatio,stationary:this.stationary,renderingOptions:a.renderingOptions};this._stationaryHandle=k.watch(()=>a.stationary,b=>{this.stationary=b;this.requestFrame()});this._frameTaskHandle=l.addFrameTask(this);this.requestUpdate()}}stop(){this._frameTaskHandle&&(this._updateRequested=
!1,this._stationaryHandle?.remove(),this._frameTaskHandle.remove(),this._updateParameters=this._stationaryHandle=this._frameTaskHandle=null,this.stationary=!0)}requestUpdate(){this._updateRequested||(this._updateRequested=!0,this.requestFrame())}requestFrame(){this._frameTaskHandle&&this._frameTaskHandle.resume()}_updateLayerView(a){if(a.attached){var b=this.view.state,e=a.lastUpdateId;if(null==e||!this.stationary&&!a.moving)a.moving=!0;e!==b.id&&a.viewChange();this.stationary&&a.moving&&(a.moving=
!1,a.moveEnd());a.lastUpdateId=b.id;a.updateRequested&&a.processUpdate(this._updateParameters);"layerViews"in a&&a.layerViews?.forEach(this._updateLayerView,this)}else this.requestUpdate()}}return p});