// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ./enums ./cpuMapped/FreeList ./shaderGraph/techniques/featureTechniqueUtils ../../../webgl/enums".split(" "),function(p,x,m,k,u,n){class h{constructor(a,c,g,d,f){this.instance=a;this.materialKey=c;this.target=g;this.start=d;this.count=f}get textureKey(){return this.materialKey&255}get indexEnd(){return this.start+this.count}extend(a){this.count+=a}render(a){this.instance.techniqueRef.render(a,this)}getStencilReference(){return this.target.stencilRef}getAttributePrecisionPackFactors(){return this.target.getMesh(this.instance.instanceId).getAttributePrecisionPackFactors()}draw(a,
c){u.isHittest(a)?this.drawCompute(a.context,c):this.drawGeometry(a.context,c)}drawCompute(a,c){c=this.target.getMesh(this.instance.instanceId).getComputeVAO(a,c);const g=this.start*Uint32Array.BYTES_PER_ELEMENT/3;a.bindVAO(c);a.drawElements(n.PrimitiveType.POINTS,this.count/3,n.DataType.UNSIGNED_INT,g);a.bindVAO(null)}drawGeometry(a,c){c=this.target.getMesh(this.instance.instanceId).getGeometryVAO(a,c);const g=this.start*Uint32Array.BYTES_PER_ELEMENT;a.bindVAO(c);a.drawElements(n.PrimitiveType.TRIANGLES,
this.count,n.DataType.UNSIGNED_INT,g);a.bindVAO(null)}}class r{constructor(){this._minOrderedLength=this._length=0;this._materialKeys=new Set}static fromDisplayEntities(a,c,g,d){const f=new r;for(const b of a.values())for(const e of b.records)a=g.getInstance(e.instanceId),f.addRecord(a,a.instanceId<<16|e.textureKey&255,e.indexStart,e.indexCount,e.vertexStart,e.vertexCount,c,d);return f}get length(){return this._length}get minOrderedLength(){return this._minOrderedLength}get minUnorderedLength(){return this._materialKeys.size}render(a,
c){const {drawPhase:g}=a;for(const d of this.infos()){const f=d.instance.techniqueRef;f.drawPhase&g&&(null==c||f.type===c)&&d.render(a)}}addRecord(a,c,g,d,f,b,e,l){d||(g=f,d=b);if(d)if(null==this._head)a=new h(a,c,e,g,d),this._tail=this._head=new k.List(a),this._length++,this._minOrderedLength++;else{if(l===m.FeatureBatchingStrategy.STRICT_ORDER)return this._insert(a,c,e,g,d,this._tail,null);f=null;b=this._head;var t=a.instanceId,q=a.techniqueRef.symbologyPlane;if(l===m.FeatureBatchingStrategy.STRICT_MARKERS_AND_TEXT&&
(q===m.FeatureSymbologyDrawOrder.MARKER||q===m.FeatureSymbologyDrawOrder.TEXT))return this._insert(a,c,e,g,d,this._tail,null);for(;b;){l=b.data.instance;const v=l.instanceId,w=f?.data.instance.instanceId;if(q<l.techniqueRef.symbologyPlane||t===w&&t!==v)return this._insert(a,c,e,g,d,f,b);f=b;b=b.next}this._insert(a,c,e,g,d,f,null)}}*infos(){if(null!=this._head)for(const a of this._head.values())yield a}_insert(a,c,g,d,f,b,e){if(null==b&&null==e)a=new h(a,c,g,d,f),this._tail=this._head=new k.List(a),
this._length++,this._minOrderedLength++;else{c!==this._tail.data.materialKey&&this._minOrderedLength++;this._materialKeys.add(c);if(null==b&&null!=e)return this._insertAtHead(a,c,g,d,f,e);if(null!=b&&null==e)return this._insertAtEnd(a,c,g,d,f,b);if(null!=b&&null!=e)return this._insertAtMiddle(a,c,g,d,f,b,e)}}_insertAtHead(a,c,g,d,f,b){c===b.data.materialKey&&g===b.data.target&&d+f===b.data.start?(b.data.start=d,b.data.count+=f):(a=new h(a,c,g,d,f),this._head=new k.List(a),this._head.next=b,this._length++)}_insertAtEnd(a,
c,g,d,f,b){b.data.materialKey===c&&b.data.indexEnd===d?b.data.count+=f:(a=new h(a,c,g,d,f),this._tail=new k.List(a),b.next=this._tail,this._length++)}_insertAtMiddle(a,c,g,d,f,b,e){b.data.materialKey===c&&b.data.target===g&&b.data.indexEnd===d?(b.data.count+=f,b.data.materialKey===e.data.materialKey&&b.data.target===e.data.target&&b.data.indexEnd===e.data.start&&(b.data.count+=e.data.count,b.next=e.next,this._length--)):c===e.data.materialKey&&g===e.data.target&&d+f===e.data.start?(e.data.start=d,
e.data.count+=f):(a=new h(a,c,g,d,f),a=new k.List(a),b.next=a,a.next=e,this._length++)}}p.DisplayList=r;p.DisplayListInfo=h;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});