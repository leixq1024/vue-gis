// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../../core/has ../../../../core/maybe ../brushes ../vectorTiles/shaders/VTLMaterialManager ./BitBlitRenderer ./definitions ./enums ./MaterialManager ./TextureManager ./TextureUploadManager ./WorldExtentClipRenderer ./effects/BlendEffect ./effects/FeatureEffect ./effects/HighlightEffect ./effects/HittestEffect ./effects/post-processing/EffectManager ./meshing/SimpleMesh ./painter/RenderPass ./shaderGraph/techniques/TechniqueProgramCache ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Renderbuffer ../../../webgl/RenderbufferDescriptor ../../../webgl/TextureDescriptor".split(" "),
function(O,p,t,y,z,A,n,B,C,D,E,F,u,G,H,I,J,K,v,e,r,L,M,w){function x(a,d,b,c){return a!==n.WGLDrawPhase.LABEL_ALPHA&&a!==n.WGLDrawPhase.LABEL&&a!==n.WGLDrawPhase.HIGHLIGHT&&(1!==c||null!=d&&"normal"!==d||null!=b&&0<b.length)}class N{constructor(a,d){this.context=a;this._currentPipelineStateNeedsUpdate=!1;this._blitRenderer=new z.BitBlitRenderer;this._worldExtentRenderer=new E.WorldExtentRenderer;this._brushCache=new Map;this._lastHeight=this._lastWidth=null;this._vtlMaterialManager=new y;this._blendEffect=
new F.BlendEffect;this._stencilBuf=null;this._prevBeforeLayerFBOStack=[];this._fboPool=[];this.effects={highlight:new G,hittest:new H.HittestEffect,insideEffect:new u.FeatureEffect("inside"),outsideEffect:new u.FeatureEffect("outside")};this._programCache=new v.TechniqueProgramCache;this._shaderState={shader:null,uniforms:null,defines:null,optionalAttributes:null,useComputeBuffer:!1};this.materialManager=new B(a);this.textureManager=new C(d);this.textureUploadManager=new D.TextureUploadManager(d);
this._effectsManager=new I.EffectManager;this._quadMesh=J.SimpleMesh.fromVertexStream(a,[0,0,1,0,0,1,1,1])}dispose(){this._programCache.destroy();this.materialManager.dispose();this.textureManager.dispose();this.textureUploadManager.destroy();this._blitRenderer=p.disposeMaybe(this._blitRenderer);this._worldExtentRenderer=p.disposeMaybe(this._worldExtentRenderer);this._quadMesh=p.destroyMaybe(this._quadMesh);this._brushCache&&(this._brushCache.forEach(a=>a.dispose()),this._brushCache.clear(),this._brushCache=
null);if(this._fbos){let a;for(a in this._fbos)this._fbos[a]&&this._fbos[a].dispose()}for(const a of this._fboPool)a.dispose();this._fboPool.length=0;if(this.effects){let a;for(a in this.effects)this.effects[a]&&this.effects[a].dispose()}this._effectsManager.dispose();this._blendEffect.dispose(this.context);this._vtlMaterialManager=p.disposeMaybe(this._vtlMaterialManager)}clearShaderCache(){this._programCache.destroy();this._programCache=new v.TechniqueProgramCache}get blitRenderer(){return this._blitRenderer}get vectorTilesMaterialManager(){return this._vtlMaterialManager}get quadMesh(){return this._quadMesh}getFbos(){if(!this._fbos)throw Error("InternalError: Painter FBOs not initialized");
return this._fbos}acquireFbo(a,d){if(0<this._fboPool.length)var b=this._fboPool.pop();else b=new w.TextureDescriptor(a,d),b.samplingMode=e.TextureSamplingMode.NEAREST,b.wrapMode=e.TextureWrapMode.CLAMP_TO_EDGE,b=new r.FramebufferObject(this.context,b,this._stencilBuf);b.width===a&&b.height===d||b.resize(a,d);return b}releaseFbo(a){this._fboPool.push(a)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderPhases(a,d,b){const {context:c}=a;this._worldExtentRenderer.render(a,d,b);const {width:f,
height:h}=c.getViewport();this.updateFBOs(f,h);this._prevFBO=c.getBoundFramebufferObject();c.bindFramebuffer(this.getFbos().output);c.setColorMask(!0,!0,!0,!0);if(null!=d){const {r:g,g:k,b:m,a:l}=d;c.setClearColor(l*g/255,l*k/255,l*m/255,l)}else c.setClearColor(0,0,0,0);c.setDepthWriteEnabled(!0);c.setClearDepth(1);c.clear(c.gl.COLOR_BUFFER_BIT|c.gl.DEPTH_BUFFER_BIT);c.setDepthWriteEnabled(!1)}afterRenderPhases(a){({context:a}=a);a.bindFramebuffer(this._prevFBO);a.setStencilFunction(e.CompareFunction.EQUAL,
A.backbufferStencilVisible,255);a.setStencilTestEnabled(!0);a.setDepthTestEnabled(!1);this.blitTexture(a,this.getFbos().output.colorTexture,e.TextureSamplingMode.NEAREST)}beforeRenderLayer(a,d,b){const {context:c,blendMode:f,effects:h,drawPhase:g,requireFBO:k}=a;if(k||x(g,f,h,b)){a=c.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(a);const {width:m,height:l}=c.getViewport();a=this.acquireFbo(m,l);c.bindFramebuffer(a);c.setColorMask(!0,!0,!0,!0);c.setClearColor(0,0,0,0);c.setDepthWriteEnabled(!0);
c.setClearDepth(1);c.clear(c.gl.COLOR_BUFFER_BIT|c.gl.DEPTH_BUFFER_BIT);c.setDepthWriteEnabled(!1)}c.setDepthWriteEnabled(!1);c.setDepthTestEnabled(!1);c.setStencilTestEnabled(!0);c.setClearStencil(d);c.setStencilWriteMask(255);c.clear(c.gl.STENCIL_BUFFER_BIT)}afterRenderLayer(a,d){const {context:b,blendMode:c,effects:f,requireFBO:h,drawPhase:g}=a;if(h||x(g,c,f,d)){const k=b.getBoundFramebufferObject();null!=f&&0<f.length&&g===n.WGLDrawPhase.MAP&&(b.setColorMask(!0,!0,!0,!0),this._applyEffects(a,
f,k));b.bindFramebuffer(this._prevBeforeLayerFBOStack.pop());b.setStencilTestEnabled(!1);b.setStencilWriteMask(0);b.setBlendingEnabled(!0);b.setBlendFunctionSeparate(e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA,e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA);b.setColorMask(!0,!0,!0,!0);this._blendEffect.draw(a,k.colorTexture,e.TextureSamplingMode.NEAREST,null==c||g===n.WGLDrawPhase.HIGHLIGHT||g===n.WGLDrawPhase.LABEL?"normal":c,d);this.releaseFbo(k)}}renderObject(a,d,b,c){if(b=t.brushes[b]){var f=
this._brushCache.get(b);void 0===f&&(f=new b,this._brushCache.set(b,f));f.prepareState(a);f.draw(a,d,c)}}renderObjects(a,d,b,c){if(b=t.brushes[b]){var f=this._brushCache.get(b);void 0===f&&(f=new b,this._brushCache.set(b,f));f.drawMany(a,d,c)}}registerRenderPass(a){const d=a.brushes.map(b=>{this._brushCache.has(b)||this._brushCache.set(b,new b);return this._brushCache.get(b)});return new K(d,a)}blitTexture(a,d,b,c=1){a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA,
e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA);a.setColorMask(!0,!0,!0,!0);this._blitRenderer.render(a,d,b,c);this._currentPipelineStateNeedsUpdate=!0}getPostProcessingEffects(a){return this._effectsManager.getPostProcessingEffects(a)}updateFBOs(a,d){if(a!==this._lastWidth||d!==this._lastHeight)if(this._lastWidth=a,this._lastHeight=d,this._fbos)for(var b in this._fbos)this._fbos[b].resize(a,d);else b=new w.TextureDescriptor(a,d),b.samplingMode=e.TextureSamplingMode.NEAREST,b.wrapMode=e.TextureWrapMode.CLAMP_TO_EDGE,
a=new M.RenderbufferDescriptor(e.RenderbufferFormat.DEPTH_STENCIL,a,d),this._stencilBuf=new L.Renderbuffer(this.context,a),this._fbos={output:new r.FramebufferObject(this.context,b,this._stencilBuf),effect0:new r.FramebufferObject(this.context,b,this._stencilBuf)}}_applyEffects(a,d,b){const {context:c}=a;d=this._effectsManager.getPostProcessingEffects(d);for(const {postProcessingEffect:f,effect:h}of d)c.bindFramebuffer(b),f.draw(a,b,h);this._currentPipelineStateNeedsUpdate=!0}setShader(a){this._shaderState.shader=
a.shader;this._shaderState.uniforms=a.uniforms;this._shaderState.defines=a.defines;this._shaderState.optionalAttributes=a.optionalAttributes;this._shaderState.useComputeBuffer=a.useComputeBuffer??!1}setPipelineState(a){a!==this._currentPipelineState&&(this._currentPipelineState=a,this._currentPipelineStateNeedsUpdate=!0)}submitDraw(a,d){const {shader:b,uniforms:c,defines:f,optionalAttributes:h}=this._shaderState,g=a.context;var k=d.getAttributePrecisionPackFactors();k=this._programCache.getProgram(b,
k,c,f??{},h??{});k.setUniforms(c);k.bind(g);this.updatePipelineState(g);this.setStencilRef(g,d);d.draw(a,b.locationInfo);k.cleanupTemporaryTextures();return{vertexShader:k.vertexShader,fragmentShader:k.fragmentShader}}submitDrawMesh(a,d,b,c){this.submitDrawMeshUntyped(a,d,b,c)}submitDrawMeshUntyped(a,d,b,c){this.setShader(d);const {shader:f,uniforms:h,defines:g,optionalAttributes:k}=this._shaderState;d=this._programCache.getProgram(f,{},h,g??{},k??{});d.setUniforms(h);d.bind(a);this.updatePipelineState(a);
if(c)for(const m of c)b.bind(a,m),b.draw(a);else for(c=0;c<b.parts.length;c++)b.bind(a,c),b.draw(a);b.unbind(a);d.cleanupTemporaryTextures()}updatePipelineState(a){this._currentPipelineStateNeedsUpdate&&(this._currentPipelineStateNeedsUpdate=!1,this._updatePipelineState(a))}_updatePipelineState(a){if(null==this._currentPipelineState)throw Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const {color:d,depth:b,stencil:c}=this._currentPipelineState;if(d){const {blendMode:h,
write:g}=d;a.setColorMask(...g);a.setBlendingEnabled(!0);a.setBlendEquation(e.BlendOperation.ADD);switch(h){case "composite":a.setBlendFunctionSeparate(e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA,e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA);break;case "additive":a.setBlendFunctionSeparate(e.BlendFactor.ONE,e.BlendFactor.ONE,e.BlendFactor.ONE,e.BlendFactor.ONE);break;case "custom":var {blendParameters:f}=d;const {dstAlpha:k,dstRGB:m,srcAlpha:l,srcRGB:q}=f;a.setBlendFunctionSeparate(q,
m,l,k);break;case "delete":a.setBlendEquation(e.BlendOperation.REVERSE_SUBTRACT),a.setBlendFunctionSeparate(e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA,e.BlendFactor.ONE,e.BlendFactor.ONE_MINUS_SRC_ALPHA)}}if(b){const {test:h,write:g}=b;g?(a.setDepthWriteEnabled(!0),a.setDepthRange(g.zNear,g.zFar)):a.setDepthWriteEnabled(!1);h?(a.setDepthTestEnabled(!0),a.setDepthFunction(h)):a.setDepthTestEnabled(!1)}else a.setDepthTestEnabled(!1),a.setDepthWriteEnabled(!1);if(c){const {test:h,write:g}=c;
if(h){const {compare:k,mask:m,op:l,ref:q}=h;a.setStencilTestEnabled(!0);"function"!==typeof q&&a.setStencilFunctionSeparate(e.Face.FRONT_AND_BACK,k,q,m);a.setStencilOpSeparate(e.Face.FRONT_AND_BACK,l.fail,l.zFail,l.zPass)}else a.setStencilTestEnabled(!1);g?({mask:f}=g,a.setStencilWriteMask(f)):a.setStencilWriteMask(0)}else a.setStencilTestEnabled(!1),a.setStencilWriteMask(0)}setStencilRef(a,d){if(null==this._currentPipelineState)throw Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");
var {stencil:b}=this._currentPipelineState;if(b&&({test:b}=b,b)){const {compare:c,mask:f,ref:h}=b;if("function"===typeof h){d=d.getStencilReference();if(null===d)throw Error("InternalError: Stencil reference expected for target but not defined");a.setStencilFunctionSeparate(e.Face.FRONT_AND_BACK,c,d,f)}}}}return N});