// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["../../../../core/floatRGBA","../../../../core/promiseUtils","../svgUtils"],function(x,t,q){class y{constructor(b,f=2){this._textureSize=b;this._rasterizationScale=f;this._canvasSize=this._textureSize*this._rasterizationScale;this._svg=null;({_canvasSize:b}=this);f=document.createElement("canvas");f.width=f.height=b;this._context=f.getContext("2d",{willReadFrequently:!1});this._gridOuter=new Float64Array(b*b);this._gridInner=new Float64Array(b*b);this._f=new Float64Array(b);this._d=new Float64Array(b);
this._z=new Float64Array(b+1);this._v=new Int16Array(b)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null;this._svg=q.destroyHiddenSvg(this._svg)}draw(b,f,e){const {_canvasSize:d,_textureSize:g,_rasterizationScale:a}=this,c=g/4;this._initSVG();const k=this.createSVGString(b,f);return new Promise((h,z)=>{const p=new Image;p.src="data:image/svg+xml; charset\x3dutf8, "+encodeURIComponent(k);p.onload=()=>{p.onload=null;this._context.clearRect(0,0,d,d);this._context.drawImage(p,
0,0,d,d);var n=this._context.getImageData(0,0,d,d);const u=new Uint8Array(g*g*4);for(var l=0;l<d*d;l++){var m=n.data[4*l+3]/255;this._gridOuter[l]=1===m?0:0===m?1E20:Math.max(0,.5-m)**2;this._gridInner[l]=1===m?1E20:0===m?0:Math.max(0,m-.5)**2}this._edt(this._gridOuter,d,d);this._edt(this._gridInner,d,d);for(n=0;n<g*g;n++){l=0;for(m=0;m<a;m++){const A=Math.floor(n/g)*a+m;for(let r=0;r<a;r++){const v=A*d+(n%g*a+r);l+=this._gridOuter[v]-this._gridInner[v]}}l/=a*a;l/=a;x.packFloatRGBA(.5-l/(2*c),u,4*
n)}h(u)};const w=e?.signal;if(w)t.onAbort(w,()=>z(t.createAbortError()))})}_initSVG(){this._svg||(this._svg=q.createHiddenSvg());return this._svg}createSVGString(b,f){const e=this._initSVG(),d=q.createSvgElement("path");d.setAttribute("d",b);e.appendChild(d);b=d.getBBox();var g=b.width/b.height;const a=this._canvasSize/2;let c,k;1<g?(c=a/b.width,k=this._canvasSize/4,g=a-1/g*a/2):(c=a/b.height,k=a-a*g/2,g=this._canvasSize/4);d.setAttribute("style",`transform: matrix(${c}, 0, 0, ${c}, ${-b.x*c+k}, ${-b.y*
c+g})`);d.setAttribute("stroke-width",`${.5/c}`);f=`<svg style="fill:${f?"red":"none"}; stroke:${f?"none":"red"}" height="${this._canvasSize}" width="${this._canvasSize}" xmlns="http://www.w3.org/2000/svg">${e.innerHTML}</svg>`;e.removeChild(d);return f}_edt(b,f,e){const d=this._f,g=this._d,a=this._v,c=this._z;for(var k=0;k<f;k++){for(var h=0;h<e;h++)d[h]=b[h*f+k];this._edt1d(d,g,a,c,e);for(h=0;h<e;h++)b[h*f+k]=g[h]}for(k=0;k<e;k++){for(h=0;h<f;h++)d[h]=b[k*f+h];this._edt1d(d,g,a,c,f);for(h=0;h<f;h++)b[k*
f+h]=Math.sqrt(g[h])}}_edt1d(b,f,e,d,g){e[0]=0;d[0]=-1E20;d[1]=1E20;for(let a=1,c=0;a<g;a++){let k=(b[a]+a*a-(b[e[c]]+e[c]*e[c]))/(2*a-2*e[c]);for(;k<=d[c];)c--,k=(b[a]+a*a-(b[e[c]]+e[c]*e[c]))/(2*a-2*e[c]);c++;e[c]=a;d[c]=k;d[c+1]=1E20}for(let a=0,c=0;a<g;a++){for(;d[c+1]<a;)c++;f[a]=(a-e[c])*(a-e[c])+b[e[c]]}}}return y});