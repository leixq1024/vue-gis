// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../../chunks/tslib.es6 ../../GraphShaderModule ../../graph/glsl ./markerConstants ../shaders/AFeatureShader ../shaders/constants ../shaders/hittestUtils ../shaders/MosaicInfo ../shaders/utils ../shaders/VisualVariableColor ../shaders/VisualVariableOpacity ../shaders/VisualVariableRotation ../shaders/VisualVariableSizeMinMaxValue ../shaders/VisualVariableSizeScaleStops ../shaders/VisualVariableSizeStops ../shaders/VisualVariableSizeUnitValue ../shaders/vvUtils".split(" "),
function(D,h,k,b,A,F,H,l,M,y,N,O,P,Q,R,S,T,E){function x(a,c,d,f){return c.multiply(a.x).add(d.multiply(a.y)).add(f.multiply(a.z))}function G(a){return a.multiply(a).divide(128)}class w extends F.FeatureVertexInput{}h.__decorate([k.location(3,b.Vec4)],w.prototype,"color",void 0);h.__decorate([k.location(4,b.Vec4)],w.prototype,"outlineColor",void 0);h.__decorate([k.location(5,b.Vec2)],w.prototype,"offset",void 0);h.__decorate([k.location(6,b.Vec2)],w.prototype,"textureUV",void 0);h.__decorate([k.location(7,
b.Vec4)],w.prototype,"sizing",void 0);h.__decorate([k.location(8,b.Float)],w.prototype,"placementAngle",void 0);h.__decorate([k.location(9,b.Float)],w.prototype,"sdfDecodeCoeff",void 0);h.__decorate([k.location(10,b.Vec2)],w.prototype,"zoomRange",void 0);class B extends k.ComputeVertexInput{}h.__decorate([k.location(12,b.Vec2)],B.prototype,"offsetNextVertex1",void 0);h.__decorate([k.location(13,b.Vec2)],B.prototype,"offsetNextVertex2",void 0);h.__decorate([k.location(14,b.Vec2)],B.prototype,"textureUVNextVertex1",
void 0);h.__decorate([k.location(15,b.Vec2)],B.prototype,"textureUVNextVertex2",void 0);class I extends F.FeatureFragmentInput{}class t extends F.AFeatureShader{constructor(){super(...arguments);this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(a,c){var d=G(a.sizing.x),f=G(a.sizing.y),g=G(a.sizing.z),q=a.placementAngle;const u=y.getBit(a.bitset,A.MarkerConstants.bitset.isSDF),v=y.getBit(a.bitset,A.MarkerConstants.bitset.isMapAligned);
var n=y.getBit(a.bitset,A.MarkerConstants.bitset.scaleSymbolsProportionally),e=y.getBitBool(a.bitset,A.MarkerConstants.bitset.colorLocked),m=E.getVisualVariableOpacity(this,a.id);e=E.getVisualVariableColor(this,a.id,a.color,e).multiply(m);m=this.view.displayViewScreenMat3.multiply(new b.Vec3(a.pos.xy,1));g=E.getVisualVariableSize(this,a.id,g).divide(g);d=d.multiply(g);var p=a.offset.xy.multiply(g);n=f.multiply(n.multiply(g.subtract(1)).add(1));n=b.min(n,b.max(d.subtract(.99),new b.Float(0)));f=b.max(n,
new b.Float(1));var r=b.min(n,new b.Float(1));q=b.Mat3.fromRotation(q.multiply(H.c256ToRad));n=E.getVisualVariableRotation(this,a.id);p=this._getViewRotationMatrix(v).multiply(n).multiply(q).multiply(new b.Vec3(p.xy,0));var z=this.clip(a.id,a.zoomRange);m=new b.Vec4(m.xy.add(p.xy),z,1);p=a.textureUV.divide(this.mosaicInfo.size);r=a.outlineColor.multiply(r);z=y.getBit(a.bitset,A.MarkerConstants.bitset.overrideOutlineColor);const C=a.sdfDecodeCoeff.multiply(d);return{glPosition:m,color:e,textureUV:p,
outlineColor:r,outlineSize:f,distanceToPx:C,isSDF:u,overrideOutlineColor:z,...this.maybeRunHittest(a,c,{pos:a.pos,size:d,sizeCorrection:g,isMapAligned:v,vvRotationMat3:n,placementMat3:q,outlineSize:f,distanceToPx:C,isSDF:u})}}fragment(a){const c=this._getColor(a.textureUV,a);return this.getFragmentOutput(c,a)}hittest(a,c,d){return b.ifElse(b.lessThan(d.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(a,c,d),this._hittestMarker(a,c,d))}_getViewRotationMatrix(a){const c=this.view.displayViewMat3,
d=this.view.displayMat3,f=(new b.Float(1)).subtract(a);return c.multiply(a).add(d.multiply(f))}_getViewScreenMatrix(a){const c=this.view.viewMat3.multiply(this.view.tileMat3),d=this.view.tileMat3,f=(new b.Float(1)).subtract(a);return c.multiply(a).add(d.multiply(f))}_getColor(a,c){return b.ifElse(b.equal(c.isSDF,new b.Float(1)),this._getSDFColor(a,c),this._getSpriteColor(a,c))}_getSpriteColor(a,c){return b.texture2D(this.mosaicInfo.texture,a).multiply(c.color)}_getSDFColor(a,c){a=b.texture2D(this.mosaicInfo.texture,
a);var d=(new b.Float(.5)).subtract(y.rgba2float(a)).multiply(c.distanceToPx).multiply(H.softEdgeRatio);a=b.clamp((new b.Float(.5)).subtract(d),new b.Float(0),new b.Float(1));a=c.color.multiply(a);var f=c.outlineSize;this.highlight&&(f=b.max(f,c.overrideOutlineColor.multiply(4)));f=f.multiply(.5);d=b.abs(d).subtract(f);d=b.clamp((new b.Float(.5)).subtract(d),new b.Float(0),new b.Float(1));c=b.mix(c.outlineColor,c.color,c.overrideOutlineColor).multiply(d);return(new b.Float(1)).subtract(c.a).multiply(a).add(c)}_hittestSmallMarker(a,
c,d){const {position:f,distance:g,smallSymbolDistance:q}=this.hittestRequest;a=g.subtract(q);const {viewMat3:u,tileMat3:v}=this.view;c=u.multiply(v).multiply(new b.Vec3(d.pos,1)).xy;d=d.size.multiply(.5);return b.distance(c,f).subtract(d).add(a)}_hittestMarker(a,c,d){const {pos:f,sizeCorrection:g,isMapAligned:q}=d;var u=new b.Vec3(a.offset.multiply(g),0),v=new b.Vec3(c.offsetNextVertex1.multiply(g),0),n=new b.Vec3(c.offsetNextVertex2.multiply(g),0);const {viewMat3:e,tileMat3:m}=this.view;var p=e.multiply(m).multiply(new b.Vec3(f,
1)),r=this._getViewScreenMatrix(q).multiply(d.vvRotationMat3).multiply(d.placementMat3);u=p.add(r.multiply(u)).xy;v=p.add(r.multiply(v)).xy;n=p.add(r.multiply(n)).xy;p=this.hittestRequest.distance;r=l.distPointTriangle(this.hittestRequest.position,u,v,n);return b.ifElse(b.greaterThan(r,p),r,this._hittestSamples(u,v,n,a,c,d))}_hittestSamples(a,c,d,f,g,q){const {outlineSize:u,isSDF:v,distanceToPx:n}=q;var e=this.hittestRequest.position;const m=this.hittestRequest.distance;q=l.xyToBarycentric(e.add(new b.Vec2(b.negate(m),
b.negate(m))),a,c,d);const p=l.xyToBarycentric(e.add(new b.Vec2(0,b.negate(m))),a,c,d),r=l.xyToBarycentric(e.add(new b.Vec2(m,b.negate(m))),a,c,d),z=l.xyToBarycentric(e.add(new b.Vec2(b.negate(m),0)),a,c,d),C=l.xyToBarycentric(e,a,c,d),J=l.xyToBarycentric(e.add(new b.Vec2(m,0)),a,c,d),K=l.xyToBarycentric(e.add(new b.Vec2(b.negate(m),m)),a,c,d),L=l.xyToBarycentric(e.add(new b.Vec2(0,m)),a,c,d);a=l.xyToBarycentric(e.add(new b.Vec2(m,m)),a,c,d);f=f.textureUV.divide(this.mosaicInfo.size);c=g.textureUVNextVertex1.divide(this.mosaicInfo.size);
g=g.textureUVNextVertex2.divide(this.mosaicInfo.size);d={color:new b.Vec4(1),outlineColor:new b.Vec4(1),overrideOutlineColor:new b.Float(1),outlineSize:u,distanceToPx:n,isSDF:v};e=new b.Float(0);e=e.add(l.inTriangle(q).multiply(this._getColor(x(q,f,c,g),d).a));e=e.add(l.inTriangle(p).multiply(this._getColor(x(p,f,c,g),d).a));e=e.add(l.inTriangle(r).multiply(this._getColor(x(r,f,c,g),d).a));e=e.add(l.inTriangle(z).multiply(this._getColor(x(z,f,c,g),d).a));e=e.add(l.inTriangle(C).multiply(this._getColor(x(C,
f,c,g),d).a));e=e.add(l.inTriangle(J).multiply(this._getColor(x(J,f,c,g),d).a));e=e.add(l.inTriangle(K).multiply(this._getColor(x(K,f,c,g),d).a));e=e.add(l.inTriangle(L).multiply(this._getColor(x(L,f,c,g),d).a));e=e.add(l.inTriangle(a).multiply(this._getColor(x(a,f,c,g),d).a));return b.step(e,new b.Float(.05)).multiply(l.failHittest(this.hittestRequest))}}h.__decorate([k.option(N.VisualVariableColor)],t.prototype,"visualVariableColor",void 0);h.__decorate([k.option(O.VisualVariableOpacity)],t.prototype,
"visualVariableOpacity",void 0);h.__decorate([k.option(P.VisualVariableRotation)],t.prototype,"visualVariableRotation",void 0);h.__decorate([k.option(Q.VisualVariableSizeMinMaxValue)],t.prototype,"visualVariableSizeMinMaxValue",void 0);h.__decorate([k.option(R.VisualVariableSizeScaleStops)],t.prototype,"visualVariableSizeScaleStops",void 0);h.__decorate([k.option(S.VisualVariableSizeStops)],t.prototype,"visualVariableSizeStops",void 0);h.__decorate([k.option(T.VisualVariableSizeUnitValue)],t.prototype,
"visualVariableSizeUnitValue",void 0);h.__decorate([k.uniform(M.MosaicInfo)],t.prototype,"mosaicInfo",void 0);h.__decorate([h.__param(0,k.input(w)),h.__param(1,k.input(B))],t.prototype,"vertex",null);h.__decorate([h.__param(0,k.input(I))],t.prototype,"fragment",null);D.MarkerFragmentInput=I;D.MarkerShader=t;D.MarkerVertexInput=w;Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});