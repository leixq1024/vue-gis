// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../../core/MapUtils ../../../../../../../core/screenUtils ../../../../../../../core/libs/gl-matrix-2/math/mat2d ../../../../../../../core/libs/gl-matrix-2/factories/mat2df32 ../../../../../../../core/libs/gl-matrix-2/math/vec2 ../../../../../../../core/libs/gl-matrix-2/factories/vec2f32 ../../../../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../../../../layers/graphics/featureConversionUtils ../../../../../../../layers/graphics/OptimizedGeometry ../../../alignmentUtils ../../../definitions ../../../DisplayId ../../../collisions/LabelMetric ../../../mesh/templates/segmentUtils ../fill/meshWriterUtils ../text/TextMeshWriter".split(" "),
function(F,O,G,A,B,r,H,w,C,D,I,J,K,L,x,M,z){function N(a,c,b){const {coords:f,lengths:e}=c;c=w.create();const d=w.create(),g=w.create(),h=w.create(),l=w.create(),k=w.create();let m=0;for(let t=0;t<e.length;t++){const q=e[t];for(let n=0;n<q;n++){var p=2*(n+m-1);const u=2*(n+m),y=2*(n+m+1);0<n?r.set(c,f[p],f[p+1]):r.set(c,0,0);r.set(d,f[u],f[u+1]);n<q-1?r.set(g,f[y],f[y+1]):r.set(g,0,0);0===n?r.set(h,0,0):(r.sub(h,d,c),r.normalize(h,h),r.set(h,h[1],-h[0]));n===q-1?r.set(l,0,0):(r.sub(l,g,d),r.normalize(l,
l),r.set(l,l[1],-l[0]));r.add(k,h,l);r.normalize(k,k);p=k[0]*l[0]+k[1]*l[1];0!==p&&r.scale(k,k,p);r.scale(k,k,b);a.coords.push(d[0]+k[0],d[1]+k[1])}a.lengths.push(q);m+=q}return a}const P=O.memoize(a=>{let c=0;if(0===a)return Infinity;for(;!(a%2);)c++,a/=2;return c});class Q extends z.TextMeshWriter{constructor(){super(...arguments);this._zoomLevel=0}_write(a,c,b,f){this._zoomLevel=f||0;if(null!=b)throw Error("InternalError: EffectGeometry not support for LabelMeshWriter");switch(c.geometryType){case "esriGeometryPoint":b=
c.readXForDisplay();f=c.readYForDisplay();this._writePoint(a,b,f,c);break;case "esriGeometryEnvelope":case "esriGeometryPolygon":case "esriGeometryMultipoint":b=c.readCentroidForDisplay();if(!b)break;const [e,d]=b.coords;this._writePoint(a,e,d,c);break;case "esriGeometryPolyline":this._writeLines(a,c)}}_createLineLabelMetric(a,c,b,f){a=K.getDisplayIdTexel(a);return new L.LabelMetric(a,c,b,"right"===this.evaluatedMeshParams.horizontalAlignment?-1:1,"bottom"===this.evaluatedMeshParams.verticalAlignment?
-1:1,this.evaluatedMeshParams.scaleInfo?.maxScale??0,this.evaluatedMeshParams.scaleInfo?.minScale??0,f??null)}_writePoint(a,c,b,f){const e=this._getShaping();if(e){var d=f.getDisplayId(),g=I.getXAnchorDirection(this.evaluatedMeshParams.horizontalAlignment),h=I.getYAnchorDirection(this.evaluatedMeshParams.verticalAlignment),l=this.evaluatedMeshParams.scaleInfo?.maxScale??0,k=this.evaluatedMeshParams.scaleInfo?.minScale??0;f=K.getDisplayIdTexel(f.getDisplayId());var m=this._getPointReferenceBounds()||
{offsetX:0,offsetY:0,size:0};a.metricStart(new L.LabelMetric(f,c,b,g,h,l,k,m));this._writeGlyphs(a,d,c,b,e,0,m);a.metricBoxWrite(e.boundsT);a.metricEnd()}}_getPointReferenceBounds(){if(!this._references)return null;for(const a of this._references){const c=a.getBoundsInfo();if(c)return c}return null}_writeLines(a,c){const {scaleInfo:b,verticalAlignment:f}=this.evaluatedMeshParams;var e=this.evaluatedMeshParams.repeatLabelDistance||128;const d=this._getShaping("middle");if(d){var g=(h,l,k,m)=>this._placeSubdivGlyphs(h,
l,k,m);e=(d.bounds.width+e)/2;this._current={out:a,id:c.getDisplayId(),shaping:d,zoomRange:M.getMinMaxZoom(b,this.getTileInfo()),referenceBounds:this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0},offsetDirection:null};(this._verticalPlacement="bottom"===f?"above":"top"===f?"below":null)?this._writeAboveAndBelowAlong(c,g,e):this._writeCenterAlong(c,g,e)}}_writeAboveAndBelowAlong(a,c,b){const {repeatLabel:f}=this.evaluatedMeshParams;var {shaping:e}=this._current,d=e.bounds.halfHeight;if(a=
a.readGeometryForDisplay()){var g=new D;C.generalizeOptimizedGeometry(g,a,!1,!1,"esriGeometryPolyline",1);a=N(new D,g,d);d=N(new D,g,-d);d=C.convertToGeometry(d,"esriGeometryPolyline",!1,!1);a=C.convertToGeometry(a,"esriGeometryPolyline",!1,!1);a=x.smoothPaths(a.paths,e.bounds.width);e=x.smoothPaths(d.paths,e.bounds.width);this._current.offsetDirection="above";for(const h of a)x.pathDivide(h,b,c,!!f);this._current.offsetDirection="below";for(const h of e)x.pathDivide(h,b,c,!!f)}}_writeCenterAlong(a,
c,b){const {repeatLabel:f}=this.evaluatedMeshParams,{shaping:e}=this._current;a=x.smoothPaths(a.readLegacyGeometryForDisplay().paths,e.bounds.width);for(const d of a)x.pathDivide(d,b,c,!!f)}_placeSubdivGlyphs(a,c,b,f){const {allowOverrun:e,labelPosition:d,repeatLabelDistance:g}=this.evaluatedMeshParams,h=this._current.zoomRange[0];var l=P(c),k=this._current.shaping.bounds.width/2,m=Math.sqrt(g||128)/2;b=Math.min(b,f-b);k=this._current.shaping.isMultiline?z.maxLabelZoom:Math.log2(b/(m+k/2));l=Math.max(h,
this._zoomLevel+1-(0===c?k:Math.min(l,k)));k=this._zoomLevel-l;m=this._current.shaping.bounds.width/2*2**k;this._current.shaping.isMultiline?0===c&&this._placeStraight(a,l):e&&0>k?this._placeStraightAlong(a,h):"parallel"===d?this._placeStraightAlong(a,l):"curved"===d&&this._placeCurved(a,l,m)}_placeStraight(a,c){const {out:b,id:f,shaping:e,referenceBounds:d}=this._current,{x:g,y:h}=a;b.metricStart(this._createLineLabelMetric(f,g,h));b.metricBoxWrite(e.boundsT);const l=(180/Math.PI*a.angle+180)%360;
this._writeGlyphs(b,f,g,h,e,0,d,{clipAngle:180/Math.PI*a.angle%360,mapAligned:!0,isLineLabel:!0,minZoom:c});this._writeGlyphs(b,f,g,h,e,0,d,{clipAngle:l,mapAligned:!0,isLineLabel:!0,minZoom:c});b.metricEnd()}_placeCurved(a,c,b){const {out:f,id:e}=this._current;f.metricStart(this._createLineLabelMetric(e,a.x,a.y));const d=a.clone(),g=180/Math.PI*a.angle%360,h=(180/Math.PI*a.angle+180)%360;this._verticalPlacement&&this._verticalPlacement!==this._current.offsetDirection||(this._placeFirst(d,c,1,g),this._placeBack(a,
d,c,b,1,g),this._placeForward(a,d,c,b,1,g));this._verticalPlacement&&this._verticalPlacement===this._current.offsetDirection||(this._placeFirst(d,c,0,h),this._placeBack(a,d,c,b,0,h),this._placeForward(a,d,c,b,0,h));f.metricEnd()}_placeStraightAlong(a,c){const {out:b,id:f,shaping:e,zoomRange:d,referenceBounds:g}=this._current,{boxBorderLineColor:h,boxBackgroundColor:l}=this.evaluatedMeshParams,k=a.clone(),m=180/Math.PI*a.angle%360,p=(180/Math.PI*a.angle+180)%360;var t=0<e.glyphs.length&&!(!h&&!l);
b.metricStart(this._createLineLabelMetric(f,a.x,a.y));if(t){var q=Math.max(c,d[0],0),n=Math.min(z.maxLabelZoom,d[1]);t=A.fromRotation(B.create(),-a.angle);q={minZoom:q,maxZoom:n,clipAngle:m,mapAligned:!0,isLineLabel:!0};n=G.pt2px(this.evaluatedMeshParams.offsetX);const y=G.pt2px(this.evaluatedMeshParams.offsetY);if(!this._verticalPlacement||this._verticalPlacement===this._current.offsetDirection){var u=H.fromValues(n,-1*y);const [v,E]=e.shapeBackground(A.translate(B.create(),t,u));b.recordStart(this.instanceId,
this.attributeLayout,e.glyphs[0].textureBinding);u=2*Math.max(v.width,v.height);b.recordBounds(a.x+v.x,a.y+v.y,u,u);this._writeTextBox(b,f,a.x,a.y,E,g,q);b.recordEnd()}if(!this._verticalPlacement||this._verticalPlacement!==this._current.offsetDirection){n=H.fromValues(n,y);const [v,E]=e.shapeBackground(A.translate(B.create(),t,n));q.clipAngle=p;b.recordStart(this.instanceId,this.attributeLayout,e.glyphs[0].textureBinding);t=2*Math.max(v.width,v.height);b.recordBounds(a.x+v.x,a.y+v.y,t,t);this._writeTextBox(b,
f,a.x,a.y,E,g,q);b.recordEnd()}}this._verticalPlacement&&this._verticalPlacement!==this._current.offsetDirection||this._placeFirst(k,c,1,m,!0);this._verticalPlacement&&this._verticalPlacement===this._current.offsetDirection||this._placeFirst(k,c,0,p,!0);b.metricEnd()}_placeBack(a,c,b,f,e,d){const g=a.clone();for(a=a.backwardLength+0;g.prev()&&!(a>=f);)this._placeOnSegment(g,c,a,b,-1,e,d),a+=g.length+0}_placeForward(a,c,b,f,e,d){const g=a.clone();for(a=a.remainingLength+0;g.next()&&!(a>=f);)this._placeOnSegment(g,
c,a,b,1,e,d),a+=g.length+0}_placeFirst(a,c,b,f,e=!1){const {out:d,id:g,shaping:h,zoomRange:l,referenceBounds:k}=this._current;var m=h.glyphs;for(const p of m)m=p.x>h.bounds.x?b:1-b,m=Math.max(0,this._zoomLevel+Math.log2(Math.abs(p.x+p.width/2-h.bounds.x)/(m*a.remainingLength+(1-m)*a.backwardLength))),m=Math.max(c,e?0:m),p.maxZoom=Math.min(l[1],z.maxLabelZoom),p.angle=a.angle+(1-b)*Math.PI,p.minZoom=Math.max(l[0],m),this._writeLineGlyph(d,g,a.x,a.y,h.bounds,p,f,k,!0),(b||this._current.offsetDirection)&&
this._isVisible(p.minZoom,p.maxZoom)&&d.metricBoxWrite(p.bounds)}_placeOnSegment(a,c,b,f,e,d,g){const {out:h,id:l,shaping:k,referenceBounds:m}=this._current;var p=k.glyphs;c=a.x+a.dx/a.length*-e*b;var t=a.y+a.dy/a.length*-e*b;for(const n of p)if((p=n.x>k.bounds.x?d:1-d)&&1===e||!p&&-1===e){var q=Math.abs(n.x+n.width/2-k.bounds.x);p=Math.max(0,this._zoomLevel+Math.log2(q/b)-.1);q=Math.max(f,this._zoomLevel+Math.log2(q/(b+a.length+0)));0!==p&&(n.angle=a.angle+(1-d)*Math.PI,n.minZoom=q,n.maxZoom=p,this._writeLineGlyph(h,
l,c,t,k.bounds,n,g,m,!0),(d||this._current.offsetDirection)&&this._isVisible(n.minZoom,n.maxZoom)&&h.metricBoxWrite(n.bounds))}}_writeLineGlyph(a,c,b,f,e,d,g,h,l){const k=b+e.x,m=f+e.y;e=2*Math.max(e.width,e.height)*(this.evaluatedMeshParams.minPixelBuffer?this.evaluatedMeshParams.minPixelBuffer/this._textMeshTransformProps.fontSize:1);a.recordStart(this.instanceId,this.attributeLayout,d.textureBinding);a.recordBounds(k,m,e,e);const {texcoords:p,offsets:t}=d,{fontSize:q,haloSize:n,outlineSize:u}=
this._textMeshTransformProps;this._writeQuad(a,c,b,f,{texcoords:p,offsets:t,fontSize:q,haloSize:n,outlineSize:u,color:M.processColorInput(this.evaluatedMeshParams.color),isBackground:!1,referenceBounds:h,minZoom:Math.max(this._current.zoomRange[0],d.minZoom),maxZoom:Math.min(this._current.zoomRange[1],d.maxZoom),clipAngle:g,mapAligned:l,isLineLabel:!0});a.recordEnd()}_isVisible(a,c){const b=Math.floor(this._zoomLevel*J.minMaxZoomPrecisionFactor)/J.minMaxZoomPrecisionFactor;return a<=b&&b<=c}}F.LabelMeshWriter=
Q;Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});