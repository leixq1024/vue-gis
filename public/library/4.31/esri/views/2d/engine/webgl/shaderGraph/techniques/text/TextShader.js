// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../../chunks/tslib.es6 ../../../definitions ../../GraphShaderModule ../../graph/glsl ../shaders/AFeatureShader ../shaders/constants ../shaders/hittestUtils ../shaders/MosaicInfo ../shaders/utils ../shaders/VisualVariableColor ../shaders/VisualVariableOpacity ../shaders/VisualVariableRotation ../shaders/VisualVariableSizeMinMaxValue ../shaders/VisualVariableSizeScaleStops ../shaders/VisualVariableSizeStops ../shaders/VisualVariableSizeUnitValue ../shaders/vvUtils".split(" "),
function(n,d,z,e,a,A,w,E,H,F,I,J,K,L,M,N,O,B){const P=360/254;n.TextRenderPassType=void 0;(function(b){b[b.Color=0]="Color";b[b.Outline=1]="Outline";b[b.Halo=2]="Halo"})(n.TextRenderPassType||(n.TextRenderPassType={}));class l extends A.FeatureVertexInput{}d.__decorate([e.location(3,a.Vec4)],l.prototype,"color",void 0);d.__decorate([e.location(4,a.Vec2)],l.prototype,"offset",void 0);d.__decorate([e.location(5,a.Vec2)],l.prototype,"textureUV",void 0);d.__decorate([e.location(6,a.Float)],l.prototype,
"fontSize",void 0);d.__decorate([e.location(7,a.Float)],l.prototype,"referenceSize",void 0);d.__decorate([e.location(8,a.Vec4)],l.prototype,"outlineColor",void 0);d.__decorate([e.location(9,a.Vec4)],l.prototype,"haloColor",void 0);d.__decorate([e.location(10,a.Vec2)],l.prototype,"outlineAndHaloSize",void 0);d.__decorate([e.location(11,a.Vec2)],l.prototype,"zoomRange",void 0);d.__decorate([e.location(12,a.Float)],l.prototype,"clipAngle",void 0);d.__decorate([e.location(13,a.Vec4)],l.prototype,"referenceSymbol",
void 0);class C extends e.ComputeVertexInput{}d.__decorate([e.location(14,a.Vec2)],C.prototype,"offsetNextVertex1",void 0);d.__decorate([e.location(15,a.Vec2)],C.prototype,"offsetNextVertex2",void 0);class G extends A.FeatureFragmentInput{}class k extends A.AFeatureShader{constructor(){super(...arguments);this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]};this.textRenderPassType=n.TextRenderPassType.Color;this.isLabel=this.isBackgroundPass=!1}clipLabel(b,c,g){c=c.multiply(P);
c=a.abs(this.view.rotation.subtract(c));var h=a.min((new a.Float(360)).subtract(c),c);c=new a.Float(0);const m=a.floor(this.view.currentZoom.multiply(z.minMaxZoomPrecisionFactor)).divide(z.minMaxZoomPrecisionFactor);var q=b.x;b=b.y;q=(new a.Float(1)).subtract(a.step(q,m)).multiply(2);h=a.step(new a.Float(90),h).multiply(2);b=(new a.Float(2)).multiply((new a.Float(1)).subtract(a.step(m,b)));c=c.add(g.multiply(q));c=c.add(g.multiply(h));return c=c.add(b)}vertex(b,c){var g=F.getBit(b.bitset,w.bitsetTextIsBackground),
h=(new a.Float(1)).subtract(g),m=b.fontSize;let q=m.divide(w.sdfFontSize);var t=this.textRenderPassType===n.TextRenderPassType.Outline?b.outlineColor:this.textRenderPassType===n.TextRenderPassType.Halo?b.haloColor:this._getVertexColor(b),p=this.isLabel?this.storage.getLabelVisibility(b.id):new a.Float(1);t=this.isLabel?t.multiply(p):t;var u=this.view.displayViewScreenMat3.multiply(new a.Vec3(b.pos,1)),f=b.offset;let x=new a.Float(1),D=a.Mat3.identity();var y=new a.Vec2(0);if(this.isLabel){if(!b.referenceSymbol)throw Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");
var v=b.referenceSymbol;y=v.xy;var r=v.z;v=this._unpackDirection(v.w);r=B.getVisualVariableSize(this,b.id,r).divide(2);r=v.multiply(r.add(z.labelPlacementOffsetPadding));y=y.add(r);f=f.add(y)}else x=B.getVisualVariableSize(this,b.id,b.referenceSize).divide(b.referenceSize),m=m.multiply(x),q=q.multiply(x),f=f.multiply(x),D=B.getVisualVariableRotation(this,b.id),f=D.multiply(new a.Vec3(f,0)).xy;v=F.getBit(b.bitset,w.bitsetTextIsMapAligned);r=this._getViewRotationMatrix(v).multiply(new a.Vec3(f,0));
f=this.isLabel?this.clipLabel(b.zoomRange,b.clipAngle,v):this.clip(b.id,b.zoomRange);f=this.isBackgroundPass?f.add(h.multiply(2)):f.add(g.multiply(2));g=this.isLabel?a.or(a.greaterThan(f,new a.Float(1)),a.equal(p,new a.Float(0))):new a.Bool(!1);h=new a.Vec4(u.xy.add(r.xy),f,1);p=b.textureUV.divide(this.mosaicInfo.size);u=new a.Float(0);this.textRenderPassType===n.TextRenderPassType.Outline&&(a.equal(b.outlineAndHaloSize.x,new a.Float(0))&&(f=f.add(new a.Float(2))),u=(new a.Float(b.outlineAndHaloSize.x)).divide(q).divide(w.maxSdfDistance));
this.textRenderPassType===n.TextRenderPassType.Halo&&(u=b.outlineAndHaloSize.x,r=new a.Float(b.outlineAndHaloSize.y),a.equal(r,new a.Float(0))&&(f=f.add(new a.Float(2))),u=r.add(u).divide(q).divide(w.maxSdfDistance));m=(new a.Float(.105*w.sdfFontSize)).divide(m).divide(this.view.pixelRatio);return{glPosition:h,color:t,size:q,textureUV:p,antialiasingWidth:m,outlineDistanceOffset:u,...this.maybeRunHittest(b,c,{vvSizeAdjustment:x,vvRotation:D,labelOffset:y,labelClipped:g})}}_getViewRotationMatrix(b){const c=
this.view.displayViewMat3,g=this.view.displayMat3,h=(new a.Float(1)).subtract(b);return c.multiply(b).add(g.multiply(h))}fragment(b){var c=new a.Float(.25),g=(new a.Float(1)).subtract(c);c=a.texture2D(this.mosaicInfo.texture,b.textureUV).a;g=g.subtract(b.outlineDistanceOffset);this.highlight&&(g=g.divide(2));const h=b.antialiasingWidth;c=a.smoothstep(g.subtract(h),g.add(h),c);return this.getFragmentOutput(b.color.multiply(c),b)}hittest(b,c,{vvSizeAdjustment:g,vvRotation:h,labelOffset:m,labelClipped:q}){if(this.isLabel){var t=
new a.Vec3(b.offset.add(m),0);var p=new a.Vec3(c.offsetNextVertex1.add(m),0);c=new a.Vec3(c.offsetNextVertex2.add(m),0)}else t=h.multiply(new a.Vec3(b.offset.multiply(g),0)),p=h.multiply(new a.Vec3(c.offsetNextVertex1.multiply(g),0)),c=h.multiply(new a.Vec3(c.offsetNextVertex2.multiply(g),0));const {viewMat3:u,tileMat3:f}=this.view;b=u.multiply(f).multiply(new a.Vec3(b.pos,1));t=b.add(f.multiply(t)).xy;p=b.add(f.multiply(p)).xy;b=b.add(f.multiply(c)).xy;p=E.distPointTriangle(this.hittestRequest.position,
t.xy,p.xy,b.xy);return this.isLabel?a.ifElse(q,E.failHittest(this.hittestRequest),p):p}_unpackDirection(b){var c=new a.Int(b);b=a.bitRShift(c,new a.Int(2));c=a.bitAnd(c,new a.Int(3));return new a.Vec2((new a.Float(b)).subtract(1),(new a.Float(c)).subtract(1))}_getVertexColor(b){var c=b.color;this.visualVariableColor&&(c=this.storage.getColorValue(b.id),c=this.visualVariableColor.getColor(c,b.color,new a.Bool(!1)));this.visualVariableOpacity&&(b=this.storage.getOpacityValue(b.id),b=this.visualVariableOpacity.getOpacity(b),
c=c.multiply(b));return c}}d.__decorate([e.option(I.VisualVariableColor)],k.prototype,"visualVariableColor",void 0);d.__decorate([e.option(J.VisualVariableOpacity)],k.prototype,"visualVariableOpacity",void 0);d.__decorate([e.option(K.VisualVariableRotation)],k.prototype,"visualVariableRotation",void 0);d.__decorate([e.option(L.VisualVariableSizeMinMaxValue)],k.prototype,"visualVariableSizeMinMaxValue",void 0);d.__decorate([e.option(M.VisualVariableSizeScaleStops)],k.prototype,"visualVariableSizeScaleStops",
void 0);d.__decorate([e.option(N.VisualVariableSizeStops)],k.prototype,"visualVariableSizeStops",void 0);d.__decorate([e.option(O.VisualVariableSizeUnitValue)],k.prototype,"visualVariableSizeUnitValue",void 0);d.__decorate([e.uniform(H.MosaicInfo)],k.prototype,"mosaicInfo",void 0);d.__decorate([e.define],k.prototype,"textRenderPassType",void 0);d.__decorate([e.define],k.prototype,"isBackgroundPass",void 0);d.__decorate([e.define],k.prototype,"isLabel",void 0);d.__decorate([d.__param(0,e.input(l)),
d.__param(1,e.input(C))],k.prototype,"vertex",null);d.__decorate([d.__param(0,e.input(G))],k.prototype,"fragment",null);n.TextFragmentInput=G;n.TextShader=k;n.TextVertexInput=l;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});