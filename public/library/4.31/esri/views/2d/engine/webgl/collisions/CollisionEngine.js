// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/has","../definitions","../enums","./CollisionGrid"],function(x,A,w,B,u){function t(b,e){b=b.children.slice();b.sort((g,h)=>g.tileAge-h.tileAge);b.forEach(g=>{null!=g.labelMetrics&&g.isReady&&e(g,g.labelMetrics)})}function y(b,e){return(!b.minScale||b.minScale>=e)&&(!b.maxScale||b.maxScale<=e)}class C{run(b,e,g,h){const a=[];for(let d=b.length-1;0<=d;d--){const k=b[d];k.labelingCollisionInfos?.length&&a.push(...k.labelingCollisionInfos)}A("esri-2d-update-debug")&&
a.length&&console.debug("CollisionEngine.run");this._transformMetrics(a);this._runCollision(a,e,g,h);for(const d of a)d.container.requestRender()}_runCollision(b,e,g,h){const [a,d]=e.state.size,k=new u.CollisionBitsetGrid(a,d,e.pixelRatio);for(const {container:l,deconflictionEnabled:c,visible:m}of b){const f=l.attributeView;c?m?(this._prepare(l),this._collideVisible(k,l,g,h),this._collideInvisible(k,l)):t(l,(p,q)=>{for(const n of q)f.setLabelMinZoom(n.entityTexel,255)}):t(l,(p,q)=>{for(const n of q)y(n,
g)?(f.setLabelMinZoom(n.entityTexel,0),m&&k.insertMetrics(n)):f.setLabelMinZoom(n.entityTexel,254)})}}_isFiltered(b,e,g){b=e.getFilterFlags(b);e=null==g.featureEffect||g.featureEffect.excludedLabelsVisible||!!(b&w.effectFlag0);return!((!g.hasFilter||b&w.filterFlag0)&&e)}_prepare(b){const e=b.attributeView,g=new Set;t(b,(h,a)=>{for(const d of a)h=d.entityTexel,g.has(h)||(g.add(h),this._isFiltered(h,e,b.layerView)?e.setLabelMinZoom(h,254):0!==e.getLabelMinZoom(h)?e.setLabelMinZoom(h,255):e.setLabelMinZoom(h,
0))})}_collideVisible(b,e,g,h){const a=e.attributeView,d=new Set;t(e,(k,l)=>{for(var c=0;c<l.length;c++){const f=l[c].entityTexel;if(d.has(f))continue;if(k.key.level!==h){a.setLabelMinZoom(f,254);d.add(f);continue}if(!y(l[c],g)){a.setLabelMinZoom(f,254);d.add(f);continue}if(0!==a.getLabelMinZoom(f)){d.add(f);continue}let p=!1,q=!0;for(var m=c;c<l.length;c++){const n=l[c];if(n.entityTexel!==f)break;if(!p)switch(b.hasCollision(n)){case u.hasCollision:p=!0;q=!1;break;case u.none:q=!1}}if(!p)for(;m<c;m++)b.insertMetrics(l[m]);
--c;q||(d.add(f),a.setLabelMinZoom(f,p?254:0))}})}_collideInvisible(b,e){const g=e.attributeView,h=new Set;t(e,(a,d)=>{for(var k=0;k<d.length;k++){a=d[k].entityTexel;if(h.has(a))continue;if(255!==g.getLabelMinZoom(a)){h.add(a);continue}let c=!1,m=!0;for(var l=k;k<d.length;k++){const f=d[k];if(f.entityTexel!==a)break;if(!c)switch(b.hasCollision(f)){case u.hasCollision:c=!0;m=!1;break;case u.none:m=!1}}if(!c)for(;l<k;l++)b.insertMetrics(d[l]);--k;m||(h.add(a),g.setLabelMinZoom(a,c?255:0))}})}_transformMetrics(b){for(const {container:e,
geometryType:g,vvEvaluators:h}of b)t(e,(a,d)=>{const k=e.attributeView;a=a.transforms.labelMat2d;a[4]=Math.round(a[4]);a[5]=Math.round(a[5]);const l="polyline"===g;for(const p of d){const {entityTexel:q,anchorX:n,anchorY:v}=p;d=p.referenceBounds?.size??0;var c=h[0];if(null!=c){var m=k.getVisualVariableData(q,B.VVBinding.SIZE);c=c(m);d=isNaN(c)||null==c||Infinity===c?d:c}c=w.labelPlacementOffsetPadding+d/2;d=p.directionX*c;c*=p.directionY;for(const r of p.bounds){m=n;var f=v;if(l){f=n+r.x+d;const z=
v+r.y+c;m=a[0]*f+a[2]*z+a[4];f=a[1]*f+a[3]*z+a[5];r.transformedX=Math.floor(m);r.transformedY=Math.floor(f)}else m=a[0]*n+a[2]*v+a[4],f=a[1]*n+a[3]*v+a[5],f=f+r.y+c,r.transformedX=m+r.x+d,r.transformedY=f}}})}}x.CollisionEngine=C;Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});