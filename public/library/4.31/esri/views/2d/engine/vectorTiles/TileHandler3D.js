// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../../core/MemCache ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/factories/mat3f32 ../../../../geometry/support/aaBoundingRect ./TileHandler ./VectorTile ../../tiling/TileInfoViewPOT ../../tiling/TileKey".split(" "),function(f,g,h,k,l,m,n,p){class q extends l.TileHandler{constructor(a,b,d,c){super(a,b,d,a.tileInfo.lods.length-1);this._memCache=c;this._ongoingTileRequests=new Map;this._ongoingRequestToController=new Map;this._tileInfoView=new n(a.tileInfo,a.fullExtent)}destroy(){super.destroy();
this._ongoingRequestToController.forEach(a=>a.abort());this._ongoingRequestToController.clear();this._ongoingTileRequests.clear()}async getVectorTile(a,b){const d=new p(a[0],a[1],a[2],0);let c=this._memCache.get(d.id);if(c)return c.retain(),c;const e=await this._getVectorTileData(d);g.throwIfAborted(b);if(!this._layer)return null;if(c=this._memCache.get(d.id))return c.retain(),c;b=this._layer.tileInfo.getTileBounds(k.create(),d);a=this._tileInfoView.getTileResolution(a[0]);c=new m.VectorTile(d,a,
b[0],b[3],512,512,this._styleRepository,this._memCache);c.setData(e);e&&(c.retain(),this._memCache.put(d.id,c,c.usedMemory,f.MinPriority));c.neededForCoverage=!0;c.transforms.tileUnitsToPixels=h.fromValues(.125,0,0,0,.125,0,0,0,1);return c}_getVectorTileData(a){const b=a.id;if(this._ongoingTileRequests.has(b))return this._ongoingTileRequests.get(b);const d=new AbortController;a=this._getParsedVectorTileData(a,{signal:d.signal}).then(c=>{this._ongoingTileRequests.delete(b);this._ongoingRequestToController.delete(b);
return c}).catch(()=>{this._ongoingTileRequests.delete(b);this._ongoingRequestToController.delete(b);return null});this._ongoingTileRequests.set(b,a);this._ongoingRequestToController.set(b,d);return a}_getParsedVectorTileData(a,b){return this.fetchTileData(a,b).then(d=>this.parseTileData({key:a,data:d},b))}}return q});