// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["../../../../core/maybe","../vtlBrushes","./shaders/VTLMaterialManager","./style/StyleDefinition","../../../webgl/enums"],function(q,l,r,h,n){class t{constructor(b,d){this.spriteMosaic=b;this.glyphMosaic=d;this._brushCache={vtlBackground:null,vtlFill:null,vtlLine:null,vtlCircle:null,vtlSymbol:null};this._vtlMaterialManager=new r}dispose(){this._brushCache.vtlBackground?.dispose();this._brushCache.vtlFill?.dispose();this._brushCache.vtlLine?.dispose();this._brushCache.vtlCircle?.dispose();
this._brushCache.vtlSymbol?.dispose();this._brushCache=null;this._vtlMaterialManager=q.disposeMaybe(this._vtlMaterialManager);this.spriteMosaic.dispose();this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(b,d,e){e=e.layers;b.renderPass="translucent";let c=this._brushCache.vtlSymbol;null==c&&(c=new l.vtlBrushes.vtlSymbol,this._brushCache.vtlSymbol=c);for(let f=0;f<e.length;f++){const g=e[f];if(g.type===h.StyleLayerType.SYMBOL){var a=g.getLayoutProperty("visibility");
a&&a.getValue()===h.Visibility.NONE||(a=b.displayLevel,void 0!==g.minzoom&&g.minzoom>a+1E-6||void 0!==g.maxzoom&&g.maxzoom<=a-1E-6||(b.styleLayerUID=g.uid,b.styleLayer=g,m[0]=d,c.drawMany(b,m)))}}}drawBackground(b,d,e){if(0!==e.backgroundBucketIds.length){var {context:c,displayLevel:a,requiredLevel:f}=b;d.key.level=f;c.setBlendingEnabled(!0);c.setDepthTestEnabled(!1);c.setStencilTestEnabled(!1);b.renderPass="background";var g=this._brushCache.vtlBackground;null==g&&(g=new l.vtlBrushes.vtlBackground,
this._brushCache.vtlBackground=g);e.backgroundBucketIds.forEach(k=>{k=e.getLayerById(k);if(k.type===h.StyleLayerType.BACKGROUND){var p=k.getLayoutProperty("visibility");p&&p.getValue()===h.Visibility.NONE||void 0!==k.minzoom&&k.minzoom>a+1E-6||void 0!==k.maxzoom&&k.maxzoom<=a-1E-6||(b.styleLayerUID=k.uid,b.styleLayer=k,m[0]=d,g.drawMany(b,m))}})}}drawTile(b,d,e,c){const {context:a}=b;e=e.layers;a.setBlendingEnabled(!1);a.setDepthTestEnabled(!0);a.setDepthWriteEnabled(!0);a.setDepthFunction(n.CompareFunction.LEQUAL);
e=e.filter(f=>null!=c&&c!==f.type||!d.layerData.has(f.uid)||f.getLayoutProperty("visibility")?.getValue()===h.Visibility.NONE?!1:!0);b.renderPass="opaque";for(let f=e.length-1;0<=f;--f)this._renderStyleLayer(e[f],b,d);a.setDepthWriteEnabled(!1);a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(n.BlendFactor.ONE,n.BlendFactor.ONE_MINUS_SRC_ALPHA,n.BlendFactor.ONE,n.BlendFactor.ONE_MINUS_SRC_ALPHA);b.renderPass="translucent";e.forEach(f=>this._renderStyleLayer(f,b,d));a.setDepthTestEnabled(!1);a.bindVAO()}_renderStyleLayer(b,
d,e){var {renderPass:c}=d;let a;switch(b.type){case h.StyleLayerType.BACKGROUND:if("background"!==c)return;a=this._brushCache.vtlBackground;a||(a=new l.vtlBrushes.vtlBackground,this._brushCache.vtlBackground=a);break;case h.StyleLayerType.FILL:if("opaque"!==c&&"translucent"!==d.renderPass)return;a=this._brushCache.vtlFill;null==a&&(a=new l.vtlBrushes.vtlFill,this._brushCache.vtlFill=a);break;case h.StyleLayerType.LINE:if("translucent"!==c)return;a=this._brushCache.vtlLine;null==a&&(a=new l.vtlBrushes.vtlLine,
this._brushCache.vtlLine=a);break;case h.StyleLayerType.CIRCLE:if("translucent"!==c)return;a=this._brushCache.vtlCircle;null==a&&(a=new l.vtlBrushes.vtlCircle,this._brushCache.vtlCircle=a);break;case h.StyleLayerType.SYMBOL:if("translucent"!==c)return;a=this._brushCache.vtlSymbol;null==a&&(a=new l.vtlBrushes.vtlSymbol,this._brushCache.vtlSymbol=a)}({displayLevel:c}=d);const {minzoom:f,maxzoom:g}=b;void 0!==f&&f>c+1E-6||void 0!==g&&g<=c-1E-6||({context:c}=d,c.setStencilTestEnabled(!1),c.setStencilWriteMask(0),
d.styleLayerUID=b.uid,d.styleLayer=b,m[0]=e,a.drawMany(d,m))}}const m=[null];return t});