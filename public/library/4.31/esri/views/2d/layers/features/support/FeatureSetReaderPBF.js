// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/pbf ../../../../../layers/graphics/OptimizedGeometry ./FeatureSetCache ./FeatureSetReader ./FeatureSetReaderPBFHeader".split(" "),function(E,J,R,K,L,M,y,N,O,P){function F(a){if(a<=q.small.delta.length)return q.small;if(a<=q.large.delta.length)return q.large;q.large.delta=new Int32Array(Math.round(1.25*a));q.large.decoded=new Int32Array(Math.round(1.25*a));return q.large}
function Q(a){var b=a.getLength();for(b=a.pos()+b;a.pos()<b&&a.next();)switch(a.tag()){case 1:return a.getString();case 2:return a.getFloat();case 3:return a.getDouble();case 4:return a.getSInt32();case 5:return a.getUInt32();case 6:return a.getInt64();case 7:return a.getUInt64();case 8:return a.getSInt64();case 9:return a.getBool();default:return a.skip(),null}return null}function B(a,b,e,g,f){return a?0===b*f-g*e&&0<b*g+e*f:!1}const q={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},
large:{delta:new Int32Array(128E3),decoded:new Int32Array(128E3)}};class C extends O.FeatureSetReader{static fromBuffer(a,b,e=!1){const g=b.geometryType;a:{try{const c=new M(new Uint8Array(a),new DataView(a));for(;c.next();)switch(c.tag()){case 2:b:{for(var f=c.getMessage();f.next();)switch(f.tag()){case 1:var d=f.getMessage();break b;default:f.skip()}d=null}break a;default:c.skip()}}catch(c){a=new J("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:c}),K.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(a)}d=
null}a=d;e=P.parseHeader(a,"esriGeometryPoint"===g,e);return new C(a,e,b)}constructor(a,b,e){super(e);this._isPoints=this._hasNext=!1;this._featureIndex=-1;this._featureOffset=0;this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0};this._parseCaches=[];this._geometryType=e.geometryType;this._reader=a;this._header=b;this._hasNext=b.hasFeatures;this._isPoints="esriGeometryPoint"===e.geometryType}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(a){this._cache.area=
0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;this._cache.optFeature=void 0;this._featureIndex=a}getAttributeHash(){let a="";for(const b of this._header.fields.fields)a+=this._readAttributeAtIndex(b.index)+".";return a}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(a){this._header.displayIds[this._featureIndex]=
a}readGeometryArea(){this._cache.area||this._readGeometry(!0);return this._cache.area}copy(){var a=this._reader.clone();a=new C(a,this._header,this.metadata);this.copyInto(a);return a}next(){this._cache.area=0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;for(this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*
this._featureIndex+1]}_readServerCentroid(){const a=this._header.centroid[2*this._featureIndex];return 268435455===a?null:new y([],[a,this._header.centroid[2*this._featureIndex+1]])}_readGeometry(a=!1){if(void 0===this._cache.geometry){let b=null;if(this._isPoints){if(268435455===this._header.centroid[2*this._featureIndex])return null;b=new y([],[this._header.centroid[2*this._featureIndex],this._header.centroid[2*this._featureIndex+1]])}else{const e=this._header.offsets.geometry[this._featureIndex],
g=this._reader;if(0===e)return null;g.move(e);try{b=a?this._parseGeometryForDisplay(g):this._parseGeometry(g)}catch(f){return null}}0===b?.coords.length&&(b=null);return this._cache.geometry=b}return this._cache.geometry}_readAttribute(a,b){var e=this._header.fields.get(a);if(null!=e)return a=this._readAttributeAtIndex(e.index),e=this._header.fields.isDateField(e.name),b&&null!=a?e?new Date(a):a:a}_readAttributes(){const a={};for(const b of this._header.fields.fields)a[b.name]=this._readAttributeAtIndex(b.index);
return a}copyInto(a){super.copyInto(a);a._featureIndex=this._featureIndex;a._featureOffset=this._featureOffset;a._hasNext=this._hasNext;a._parseCaches=this._parseCaches}_readAttributeAtIndex(a){let b=this._parseCaches[a];b||(b=new N.FeatureSetCache(this.getSize()),this._parseCaches[a]=b);if(b.has(this._featureIndex))return b.get(this._featureIndex);const e=this._reader;e.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]);a=Q(e);b.set(this._featureIndex,a);return a}_readGeometryDeltaDecoded(a=
!1){if(void 0===this._cache.unquantGeometry){a=this._readGeometry(a);if(!a)return this._cache.unquantGeometry=void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=a;var b=F(a.coords.length).decoded;a=a.clone(b);b=a.coords;let e=0;for(const g of a.lengths){for(let f=1;f<g;f++){const d=2*(e+f),c=2*(e+f-1);b[d]+=b[c];b[d+1]+=b[c+1]}e+=g}return this._cache.unquantGeometry=a}return this._cache.unquantGeometry}_parseGeometry(a){a=a.asUnsafe();var b=a.getLength();b=a.pos()+b;const e=
[],g=[];for(;a.pos()<b&&a.next();)switch(a.tag()){case 2:var f=a.getUInt32();for(f=a.pos()+f;a.pos()<f;)g.push(a.getUInt32());break;case 3:f=a.getUInt32();f=a.pos()+f;e.push(a.getSInt64());e.push(a.getSInt64());this.hasZ&&a.getSInt64();for(this.hasM&&a.getSInt64();a.pos()<f;)e.push(a.getSInt64()),e.push(a.getSInt64()),this.hasZ&&a.getSInt64(),this.hasM&&a.getSInt64();break;default:a.skip()}return new y(g,e)}_parseGeometryForDisplay(a){a=a.asUnsafe();var b=a.getLength();b=a.pos()+b;const e=[],g=[];
let f=0,d=0;var c=null;let z=0;const G="esriGeometryPolygon"===this.geometryType;var u="esriGeometryPolyline"===this.geometryType;for(u=G||u;a.pos()<b&&a.next();)switch(a.tag()){case 2:c=a.getUInt32();for(c=a.pos()+c;a.pos()<c;){var A=a.getUInt32();e.push(A);f+=A}c=F(2*f).delta;break;case 3:a.getUInt32();A=2+(this.hasZ?1:0)+(this.hasM?1:0);L.assertIsSome(c);for(const v of e)if(d+A*v>c.length)for(var p=0;p<v;p++)a.getSInt32(),a.getSInt32(),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();else if(G){p=
this.getAreaSimplificationThreshold(v,this._header.vertexCount);var r=2,n=1,m=a.getSInt32(),k=a.getSInt32();c[d++]=m;c[d++]=k;this.hasZ&&a.getSInt32();this.hasM&&a.getSInt32();var h=a.getSInt32(),l=a.getSInt32();this.hasZ&&a.getSInt32();for(this.hasM&&a.getSInt32();r<v;){var t=a.getSInt32();let D=a.getSInt32();this.hasZ&&a.getSInt32();this.hasM&&a.getSInt32();const w=m+h,x=k+l,H=w+t,I=x+D;.5*Math.abs(m*x+w*I+H*k-m*I-w*k-H*x)>=p?(z+=-.5*(w-m)*(x+k),1<n&&B(u,c[d-2],c[d-1],h,l)?(c[d-2]+=h,c[d-1]+=l):
(c[d++]=h,c[d++]=l,n++),m=w,k=x):(t+=h,D+=l);h=t;l=D;r++}3>n?d-=2*n:(z+=-.5*(m+h-m)*(k+l+k),B(u,c[d-2],c[d-1],h,l)?(c[d-2]+=h,c[d-1]+=l,g.push(n)):(c[d++]=h,c[d++]=l,g.push(++n)))}else{p=0;r=a.getSInt32();n=a.getSInt32();this.hasZ&&a.getSInt32();this.hasM&&a.getSInt32();c[d++]=r;c[d++]=n;p+=1;for(m=1;m<v;m++)k=a.getSInt32(),h=a.getSInt32(),l=r+k,t=n+h,z+=-.5*(l-r)*(t+n),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),2<m&&B(u,c[d-2],c[d-1],k,h)?(c[d-2]+=k,c[d-1]+=h):(c[d++]=k,c[d++]=h,p+=1),r=l,
n=t;g.push(p)}break;default:a.skip()}this._cache.area=z;return g.length?new y(g,c):null!=c?this._createQuantizedExtrudedGeometry(c[0],c[1]):null}}E.FeatureSetReaderPBF=C;Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})});