// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../geometry ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/data/projectionSupport ../../../../../layers/support/FieldsIndex ../aggregation/ComputedAggregateField ./AAggregateStrategy ./AProcessorStrategy ../sources/FeatureSourceMessage ../sources/strategies/chunks/OverrideChunk ../support/ComputedAttributeStorage ../support/FeatureFilter ../support/FeatureMetadata ../support/FeatureSetReaderJSON ../../../tiling/TileKey ../../../../../geometry/SpatialReference".split(" "),
function(n,I,p,w,x,y,z,A,B,q,C,D,E,F,r,G,H){class t extends B.ASendState{constructor(a,b){super(a);this.bins=new Map;this.featureCache=new Map;this.done=!1;this._store=b}reset(){this.destroy();this.done=!1}invaldateForLocalEditDropped(){this.handledChunks.clear();this.bins.clear()}destroy(){const a=this.subscription.tile.key.level;for(const b of this.featureCache.keys())this._store.releaseDisplayIdForObjectId(`${b}.${a}`);this.bins.clear();this.featureCache.clear();this.handledChunks.clear()}get tile(){return this.subscription.tile}*featuresWorldSpace(){for(const a of this.featureCache.values()){const b=
a.clone();b.geometry&&p.unquantizeOptimizedGeometry(b.geometry,b.geometry,!1,!1,this.subscription.tile.transform);yield b}}}class u extends A.AAggregateStrategy{static async create(a,b,c,e,d){const h=new D.ComputedAttributeStorage({spatialReference:b}),g=await Promise.all(a.fields.map(async k=>z.ComputedAggregateField.create(h,k))),f=a.featureFilter?await E.create({geometryType:c.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:c.metadata.timeInfo,fieldsIndex:c.metadata.fieldsIndex,spatialReference:b,
filterJSON:a.featureFilter}):null;"geohash"===a.index.type&&await x.checkProjectionSupport(b,H.WGS84);return new u(a,f,d,g,b,c,e)}constructor(a,b,c,e,d,h,g){super(h,g,d,e);this._schema=a;this._featureFilter=b;this._timeZone=c;this._metadata=F.FeatureMetadata.createFeature({geometryType:"esriGeometryPolygon",objectIdField:"aggregateId",fieldsIndex:(new y(a.fields)).toJSON(),globalIdField:null,spatialReference:h.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,
typeIdField:null,types:null})}createState(a){return new t(a,this._attributeStore)}async *applyLocalEdit(a){for(const b of this._sendStates.values())b.reset(),yield new q.FeatureTileAppendMessage(b.subscription,r.FeatureSetReaderJSON.empty(this._source.metadata),!0,!1,{})}displayMap(a,b,c){a=new Map(a.map(h=>[b(h),h]));const e=[];for(const h of this._sendStates.values())for(const g of h.featuresWorldSpace()){const {objectId:f,displayId:k}=g;var d=a.get(f);null!=d&&(d=c(k,d,f),e.push(d),a.delete(f))}return e}getDisplayFeatures(a){a=
new Set(a);const b=new Set,c=[];for(const e of this._sendStates.values())for(const d of e.featuresWorldSpace())a.has(d.displayId)&&!b.has(d.objectId)&&(d.geometry&&c.push({...p.convertToFeature(d,this._metadata.geometryType,!1,!1),displayId:d.displayId}),b.add(d.objectId));return{features:[],aggregates:c}}getFeatureObjectIdsForAggregate(a){for(const b of this._sendStates.values())for(const c of b.bins.values())if(c.id===a)return Array.from(c.containedObjectIds);return[]}beforeUpdateChunks(){const a=
this._source.chunks();if(a.length){var b=!1;for(const c of a)C.isLocalEditChunk(c)&&c.lastLocalEditDropped!==this._lastHandledLocalEdit&&(this._lastHandledLocalEdit=c.lastLocalEditDropped,b=!0);if(b)for(const c of this._sendStates.values())c.invaldateForLocalEditDropped()}}async *updateChunks(){for(const a of this._sendStates.values())yield*this._update(a,this._source)}forEachAggregateWorldSpace(a){const b=new Set;for(const c of this._sendStates.values())for(const e of c.featuresWorldSpace())b.has(e.objectId)||
(a(e),b.add(e.objectId))}_createIndexOptions(a){switch(this._schema.index.type){case "geohash":return{type:"geohash",fields:this.aggregateFields,featureFilter:this._featureFilter,geohashLevel:this._schema.index.fixBinLevel,spatialReference:this.spatialReference,timeZone:this._timeZone,scale:a.scale};case "grid":const b=this._schema.index.fixedBinLevel;a=null!=b?a.tileInfoView.getLODInfoAt(b).scale:a.scale;return{type:"grid",fields:this.aggregateFields,cellSize:this._schema.index.size,featureFilter:this._featureFilter,
spatialReference:this.spatialReference,timeZone:this._timeZone,scale:a}}}async *_update(a,b){const {handledChunks:c,subscription:e,bins:d,featureCache:h}=a;var g=e.tile;if(!a.done){for(var f of b.chunks())if(!c.has(f.chunkId)){c.add(f.chunkId);var k=f.queryInfo;if("tileId"in k&&(k=new G(k.tileId),k.level!==g.level||k.world!==g.key.world))continue;f.getAggregateIndex(this._createIndexOptions(a.tile)).putBounded(d,a.tile.extent,a.tile.resolution)}g=[];f=e.tile.transform;k=e.tile.key.level;for(var l of d.values()){let m=
h.get(l.id);if(m)m.attributes=l.getAttributes();else{const v=l.getGeometry(this.spatialReference,f);m=new w.OptimizedFeature(v,l.getAttributes(),null);v||(m.centroid=l.getGeometricCentroid(this.spatialReference,f));m.objectId=l.id;m.displayId=this._attributeStore.createDisplayIdForObjectId(`${m.objectId}.${k}`);h.set(l.id,m)}g.push(m)}this.events.emit("changed");a.done=!b.updateTracking.updating;b=r.FeatureSetReaderJSON.fromOptimizedFeatures(g,this._metadata,f);l=b.getCursor();for(g=a.subscription.tile.createArcadeEvaluationOptions(this._timeZone);l.next();)this._attributeStore.setAttributeData(l.getDisplayId(),
l,g);yield new q.FeatureTileUpdateMessage(a.subscription,b,[],a.done,{})}}}n.BinningState=t;n.BinningStrategy=u;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});