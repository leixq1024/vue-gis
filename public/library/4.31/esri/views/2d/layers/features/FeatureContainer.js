// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/promiseUtils ../../../../core/support/UpdatingHandles ../../engine/AFeatureContainer ../../engine/webgl/enums ../../engine/webgl/shaderGraph/techniques/FeatureInstanceStore ../../engine/webgl/shaderGraph/techniques/TechniqueRegistry ../../engine/webgl/shaderGraph/techniques/TechniqueType ./RenderState ../support/util".split(" "),function(l,g,h,p,q,e,r,m,n,t,u){class v{constructor(a,b){this.id=a;this.version=b;this._resolver=h.createResolver();
this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve();this._done=!0}destroy(){this._resolver.reject()}}class w extends q.AFeatureContainer{constructor(a){super(a.view.featuresTilingScheme);this.updatingHandles=new p.UpdatingHandles;this._hitTestsRequests=[];this._store=new r;this._visibleTiles=new Set;this._subscriptions=new Map;this._updateStatisticsRequests=[];this._lockStatisticUpdates=!1;this._layerView=a;this.addTransitionable(this._layerView.featureEffectView)}renderChildren(a){this._updateAttributeView();
this._renderState?.update(this.attributeView.currentEpoch);if(this._renderState){const b=Array.from(this._renderState.tiles()).filter(c=>c.needsUpload);b.length&&(b[Math.floor(Math.random()*b.length)].upload(),2<=b.length&&this.requestRender());for(const c of this._renderState.tiles())c.tryReady(this.attributeView.currentEpoch)&&(this._subscriptions.get(c.key.id)?.end(),this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this.requestRender())}for(const b of this.children)b.setTransform(a.state);
super.renderChildren(a);switch(a.drawPhase){case e.WGLDrawPhase.MAP:return this._renderMapPhase(a);case e.WGLDrawPhase.HIGHLIGHT:return this._renderHighlightPhase(a);case e.WGLDrawPhase.LABEL:return this._renderLabelPhase(a)}}subscriptions(){return this._subscriptions.values()}get _instanceStore(){return this._store}get instanceStore(){return this._store}get layerView(){return this._layerView}get hasLabels(){return 0<this._layerView.labelingCollisionInfos.length}get hasHighlight(){return this._layerView.hasHighlight()}get _layer(){return this._layerView.layer}_getHeatmapInstance(a){if(null==
this._instanceStore||!(a.drawPhase&m.Techniques.heatmap.drawPhase))return null;for(const b of this._instanceStore.values())if(b.techniqueRef.type===n.TechniqueType.Heatmap)return b;return null}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter(a=>this._visibleTiles.has(a.key.id)):[]}updateAttributeView(a){this.requestRender();this.attributeView.requestUpdate(a);this.hasLabels&&this._layerView.view.labelManager.requestUpdate()}updateSubscriptions(a){for(const {tileId:b,
version:c}of a.subscribe)if(this._subscriptions.has(b))this._subscriptions.get(b).version=c;else{const d=new v(b,c);this._subscriptions.set(b,d);this.updatingHandles.addPromise(d.promise)}for(const b of a.unsubscribe)this._subscriptions.get(b)?.destroy(),this._subscriptions.delete(b),this.removeTile(b)}isDone(a){return this._renderState?this._renderState.isTileDone(a):!1}async updateRenderState(a){g("esri-2d-update-debug")&&console.debug(`Version[${a}] FeatureContainer.updateRenderState`);this._renderStateNext=
new t.RenderState(()=>this._stage,b=>this._subscriptions.get(b)?.version,a,this.tileInfoView)}getDisplayStatistics(a,b){return(a=this._statisticsByLevel.get(a))?a.get(b):null}updateStatistics(a,b){if(this._lockStatisticUpdates)this._updateStatisticsRequests.push({level:a,statistics:b});else{var c=this._statisticsByLevel.get(a);c||(c=new Map,this._statisticsByLevel.set(a,c));for(const d of b)c.set(d.fieldName,{minValue:d.minValue,maxValue:d.maxValue})}}editStart(){this._renderState?.lockUploads();
this.attributeView.lockTextureUploads();this._lockStatisticUpdates=!0}editEnd(){this._renderState?.unlockUploads();this.attributeView.unlockTextureUploads();this._lockStatisticUpdates=!1;for(const a of this._updateStatisticsRequests)this.updateStatistics(a.level,a.statistics);this._updateStatisticsRequests=[];this.requestRender()}swapRenderState(){this._renderStateNext&&(g("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`),this._renderState?.destroy(),
this._renderState=this._renderStateNext,this._renderStateNext=null);this._renderState&&this._renderState.flush();this.requestRender()}setVisibleTiles(a){this._visibleTiles=a}async onMessage(a,b){h.throwIfAborted(b);b=a.inner;if(this._subscriptions.has(b.id)){var c=this._subscriptions.get(b.id);if(c.version!==b.subscriptionVesrion)g("esri-2d-update-debug")&&console.debug(`Version[${`${b.subscriptionVesrion} != ${c.version}`}] Tile[${b.id}] FeatureContainer - Dropping message, outdated version]`,b);
else{c=this._renderStateNext??this._renderState;if(!c)throw Error("InternalError: No renderState defined");c.version!==b.version&&console.error(`InternalError: Version mismatch. [renderState: ${c.version}, message: ${b.version}]`);c.enqueueUpdate(a);this.requestRender();this._layerView.view.labelManager.requestUpdate();this._layerView.requestUpdate()}}}removeTile(a){if(this._renderState||this._renderStateNext)this._renderState&&this._renderState.removeTile(a),this._renderStateNext&&this._renderStateNext.removeTile(a)}hitTest(a){let b=
this._hitTestsRequests.find(({x:d,y:f})=>d===a.x&&f===a.y);const c=h.createResolver();b?b.resolvers.push(c):(b={x:a.x,y:a.y,resolvers:[c]},this._hitTestsRequests.push(b));this.requestRender();return c.promise}getSortKeys(a){a=new Set(a);const b=new Map;for(const c of this.children)if(c.getSortKeys(a).forEach((d,f)=>b.set(f,d)),b.size===a.size)break;return b}get hasAnimation(){return this.hasLabels}doRender(a){const {minScale:b,maxScale:c}=this._layer.effectiveScaleRange,d=a.state.scale;d<=(b||Infinity)&&
d>=c&&super.doRender(a)}afterRender(a){super.afterRender(a);this._hitTestsRequests.length&&this.requestRender()}setStencilReference(a){if(null!=this._getHeatmapInstance(a))for(const b of this.children)b.stencilRef=m.Techniques.heatmap.getStencilReference(b);else super.setStencilReference(a)}_renderMapPhase(a){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(a),this._renderInsideEffect(a)):this._renderFeatures(a,e.FeatureSelection.All);0<this._hitTestsRequests.length&&this._renderHittest(a)}_renderHighlightPhase(a){this.hasHighlight&&
u.renderHighlight(a,!1,b=>{this._renderFeatures(b,e.FeatureSelection.Highlight)})}_renderLabelPhase(a){this._renderFeatures(a,e.FeatureSelection.All)}_renderInsideEffect(a){const b=a.painter.effects.insideEffect;b.bind(a);this._renderFeatures(a,e.FeatureSelection.InsideEffect);b.draw(a,this._layerView.featureEffectView.includedEffects);b.unbind()}_renderOutsideEffect(a){const b=a.painter.effects.outsideEffect;b.bind(a);this._renderFeatures(a,e.FeatureSelection.OutsideEffect);b.draw(a,this._layerView.featureEffectView.excludedEffects);
b.unbind()}_renderHittest(a){const {context:b}=a,c=a.painter.effects.hittest,d=b.getBoundFramebufferObject(),f=b.getViewport(),x=a.passOptions,y=a.drawPhase;c.bind(a);a.passOptions=c.createOptions(a,this._hitTestsRequests);a.drawPhase=e.WGLDrawPhase.HITTEST;const {distance:z,smallSymbolDistance:A}=a.passOptions,B=Math.max(z,A);for(const k of this.children)k.visible&&k.containsScreenPoint(a.state,a.passOptions.position,2*B)&&this._renderTile(k,a,e.FeatureSelection.All);c.draw(a);c.unbind();b.bindFramebuffer(d);
b.restoreViewport(f);a.passOptions=x;a.drawPhase=y}_renderFeatures(a,b){const c=this._getHeatmapInstance(a);null!=c?this._renderHeatmapFeatures(a,b,c):this._renderGeometryFeatures(a,b)}_renderGeometryFeatures(a,b){for(const c of this.children)c.visible&&this._renderTile(c,a,b)}_renderHeatmapFeatures(a,b,c){for(const d of this.children)d.visible&&this._renderTile(d,a,b,n.TechniqueType.Heatmap);c.techniqueRef.renderResolvePass(a,c)}_renderTile(a,b,c,d){const f=g("featurelayer-force-marker-text-draw-order")?
e.FeatureBatchingStrategy.STRICT_MARKERS_AND_TEXT:e.FeatureBatchingStrategy.BATCHING;a=a.getDisplayList(this._instanceStore,f);b.selection=c;a?.render(b,d)}}l.FeatureContainer=w;Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});