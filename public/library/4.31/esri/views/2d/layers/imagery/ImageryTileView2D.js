// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../../chunks/tslib.es6 ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../engine/imagery/RasterTileContainer ./BaseImageryTileSubView2D ../support/util ../../../layers/support/Geometry".split(" "),function(n,r,l,z,A,u,v,w,x,y){l=class extends w.BaseImageryTileSubView2D{constructor(){super(...arguments);this.type="raster"}attach(){super.attach();this.container=
new v.RasterTileContainer(this._tileInfoView);this.container.isCustomTilingScheme=this._isCustomTilingScheme;this.updateRasterFunctionParameters()}detach(){super.detach();this.container.removeAllChildren();this.container=null}canUseWebGLForProcessing(){const {symbolizer:a}=this.layer;var b=a.lookup?.colormapLut?.indexedColormap;b=b&&b.length>this._maxIndexedColormapSize;return this.useWebGLForProcessing&&a.canRenderInWebGL&&!b&&!("majority"===this.layer.interpolation&&x.canUseMajorityInterpolationOnDataSource(this.layer))}fetchTile(a,
b){return this.layer.fetchTile(a.level,a.row,a.col,b)}updateRasterFunctionParameters(){const {clips:a,view:b}=this.layerView;null!=this._geometry&&a.remove(this._geometry);const {raster:g,type:k}=this.layer;if("Function"===g.datasetFormat){var c=g.getClippingGeometry(b.spatialReference);c&&(c=new y({geometry:c}),a.add(c),this._geometry=c)}({container:c}=this);if("Function"!==g.datasetFormat||"wcs"===k)c.rasterFunctionChain=null,c.children.forEach(d=>{({bitmap:d}=d);d&&(d.suspended=!0,d.processed=
!1,d.projected&&(d.invalidateTexture(),d.rasterTexture=null))}),this._rasterFunctionState="na";else{var e=this._rasterFunctionState,{rasterFunction:f,primaryRasters:p}=g,m=f.supportsGPU&&(!p||1>=p.rasters.length),q=m?f.flatWebGLFunctionChain:null,{renderer:h}=this.layer;m=!m||!q?.functions.length||"raster-stretch"===h?.type&&h.dynamicRangeAdjustment||!this.canUseWebGLForProcessing();c.rasterFunctionChain=m?null:q;var t=null==f?"na":c.rasterFunctionChain?"gpu":"cpu";c.children.forEach(d=>{({bitmap:d}=
d);d&&(d.suspended=e!==t,d.processed=!1,d.processedTexture=null)});this._rasterFunctionState=t}}async updateTileSource(a,b){const g=this._getBandIds(),k=this._getLayerInterpolation(),c=this.canUseWebGLForProcessing(),{source:e,globalSymbolizerParams:f,suspended:p,coords:m,resolution:q}=b;b=this.layerView.hasTilingEffects?f:b.symbolizerParams;({bitmap:a}=a);[a.x,a.y]=m;a.resolution=q;if(null!=e?.pixelBlock){var h={extent:e.extent,pixelBlock:e.pixelBlock,srcPixelSize:e.srcTilePixelSize};a.rawPixelData=
h;c?(a.source=e.pixelBlock,a.isRendereredSource=!1):(h=await this.layer.applyRenderer(h,"stretch"===f?.type?f:void 0),a.source=h,a.isRendereredSource=!0);a.symbolizerParameters=c?b:null;a.transformGrid=c?e.transformGrid:null}else h=this.createEmptyTilePixelBlock(),a.source=h,a.symbolizerParameters=c?b:null,a.transformGrid=null;a.bandIds=c?g:null;a.width=this._tileInfoView.tileInfo.size[0];a.height=this._tileInfoView.tileInfo.size[1];a.interpolation=k;a.suspended=p;a.invalidateTexture()}async updateTileSymbolizerParameters(a,
b){const {local:g,global:k}=b;b=this._getBandIds();const c=this._getLayerInterpolation(),e=this.canUseWebGLForProcessing();({bitmap:a}=a);const {rawPixelData:f}=a;e||null==f?(a.isRendereredSource&&null!=f&&(a.source=f.pixelBlock),a.isRendereredSource=!1):(a.source=await this.layer.applyRenderer(f,"stretch"===k?.type?k:void 0),a.isRendereredSource=!0);a.symbolizerParameters=e?this.layerView.hasTilingEffects?k:g:null;a.bandIds=e?b:null;a.interpolation=c;a.suspended=!1}_getLayerInterpolation(){const {interpolation:a,
renderer:b}=this.layer;if(!b)return a;const g=b.type;return"raster-colormap"===g||"unique-value"===g?"nearest":"raster-stretch"===b.type&&null!=b.colorRamp?"bilinear"===a||"cubic"===a?"bilinear":"nearest":a}};n.__decorate([r.property()],l.prototype,"container",void 0);n.__decorate([r.property()],l.prototype,"layer",void 0);n.__decorate([r.property()],l.prototype,"type",void 0);return l=n.__decorate([u.subclass("esri.views.2d.layers.imagery.ImageryTileView2D")],l)});