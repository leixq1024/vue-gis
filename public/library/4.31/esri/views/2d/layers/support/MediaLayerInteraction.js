// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/handleUtils ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/support/UpdatingHandles ../../../input/InputManager".split(" "),function(q,c,e,r,g,t,k,f,z,A,B,u,v,l){const m=Symbol(),n=Symbol(),p=Symbol();
c.MediaLayerInteraction=class extends r{constructor(a){super(a);this._tool=null;this._updatingHandles=new v.UpdatingHandles;this.enabled=!1;this._onPointerMove=t.debounce(async b=>{b=await this._updatingHandles.addPromise(this._findElementAtScreenPoint(b));this.destroyed||(this.removeHandles(n),b&&b!==this.selectedElement&&(this.view.cursor="pointer",this.addHandles(g.makeHandle(()=>this.view.cursor=null),n)))})}initialize(){this.addHandles(g.destroyHandle(this._updatingHandles));this._updatingHandles.add(()=>
this.enabled,a=>this._setEnabled(a),k.initial);this._updatingHandles.add(()=>this._preferredInteractionTool,()=>this._preferredInteractionToolChanged())}get _validatedSelectedElement(){const a=this.selectedElement;if(!a)return null;const {layer:{source:b}}=this;return b?"hasElement"in b?b.hasElement(a)?a:null:b===a?a:null:null}get _preferredInteractionTool(){return this.options?.tool??"transform"}get updating(){return this._updatingHandles.updating}_setEnabled(a){this.removeHandles(m);if(a){var {view:b}=
this;this.addHandles([b.on("immediate-click",d=>this._onClick(d),l.ViewEventPriorities.TOOL),b.on("pointer-move",d=>this._onPointerMove(d).catch(()=>{}),l.ViewEventPriorities.TOOL),b.on("key-down",d=>{"z"===d.key&&this._tool?.canUndo()&&(this._tool.undo(),d.stopPropagation());"r"===d.key&&this._tool?.canRedo()&&(this._tool.redo(),d.stopPropagation())}),this._updatingHandles.add(()=>this._validatedSelectedElement,d=>this._selectedElementChanged(d),k.initial),g.makeHandle(()=>{b.cursor=null;this._removeTool()})],
m)}}async _findElementAtScreenPoint(a){a=(await this.view.hitTest(a,{include:[this.layer]})).results[0];return"media"===a?.type?a.element:null}async _onClick(a){await this._updatingHandles.addPromise(a.async(async()=>{const b=await this._findElementAtScreenPoint(a);!this.destroyed&&(b&&a.stopPropagation(),this.selectedElement=b)&&(this.view.cursor=null)}))}_preferredInteractionToolChanged(){const {_tool:a}=this;a&&this._preferredInteractionTool!==a.type&&this._updatingHandles.addPromise(this._recreateTool())}async _recreateTool(){this.removeHandles(p);
this._removeTool();const a=this._validatedSelectedElement;if(a){var b=new AbortController;this.addHandles(g.abortHandle(b),p);var {TransformTool:d,ControlPointsTransformTool:w}=await new Promise((x,y)=>q(["../../interactive/editingTools"],x,y));if(!b.signal.aborted){var {view:h}=this;switch(this._preferredInteractionTool){case "transform":this._tool=new d({target:a,view:h});break;case "reshape":this._tool=new w({mediaElement:a,view:h})}this.addHandles([g.makeHandle(()=>{this._tool&&(h.tools.remove(this._tool),
this._tool=null)})],this._tool);h.addAndActivateTool(this._tool)}}}_removeTool(){this._tool&&this.removeHandles(this._tool)}async _selectedElementChanged(a){a?.georeference?await this._updatingHandles.addPromise(this._recreateTool()):this._removeTool()}};e.__decorate([f.property()],c.MediaLayerInteraction.prototype,"_validatedSelectedElement",null);e.__decorate([f.property()],c.MediaLayerInteraction.prototype,"_preferredInteractionTool",null);e.__decorate([f.property({constructOnly:!0})],c.MediaLayerInteraction.prototype,
"view",void 0);e.__decorate([f.property({constructOnly:!0})],c.MediaLayerInteraction.prototype,"layer",void 0);e.__decorate([f.property()],c.MediaLayerInteraction.prototype,"selectedElement",void 0);e.__decorate([f.property()],c.MediaLayerInteraction.prototype,"enabled",void 0);e.__decorate([f.property()],c.MediaLayerInteraction.prototype,"options",void 0);e.__decorate([f.property()],c.MediaLayerInteraction.prototype,"updating",null);c.MediaLayerInteraction=e.__decorate([u.subclass("esri.views.2d.layers.support.MediaLayerInteraction")],
c.MediaLayerInteraction);Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});