// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/tslib.es6 ../../core/Accessor ../../core/asyncUtils ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../geometry/support/heightModelInfoUtils ../ViewingMode ./projectionUtils".split(" "),function(d,e,q,r,l,m,f,w,x,y,t,n,p,u){d.DefaultsFromMap=class extends q{constructor(a){super(a);this.required={extent:!1,heightModelInfo:!1,tileInfo:!1};
this.userSpatialReference=this.defaultSpatialReference=null;this.sourcePreloadCount=10;this.priorityCollection=null;this.requiresExtentInSpatialReference=!0;this.suspended=!1;this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=l.abortMaybe(this._projectExtentTask.task));this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference??
this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return null==this.userSpatialReference||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){const a=
this.map?.(),b=[];null!=this.priorityCollection&&b.push(this.priorityCollection);b.push({parent:a?.basemap,layers:a?.basemap?.baseLayers},{layers:a?.layers},{parent:a?.ground,layers:a?.ground?.layers},{parent:a?.basemap,layers:a?.basemap?.referenceLayers});return b}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};let a;if(this._collectLayers(this.mapCollections,c=>{c=this._getSupportedSpatialReferences(c);0<c.length&&(c=this._narrowDownSpatialReferenceCandidates(a,
c),null!=c&&(a=c));return 1===a?.length?!0:!1})&&1!==a?.length)return{updating:!0};const b=this._pickSpatialReferenceCandidate(a);return{spatialReference:b?.spatialReference??null,viewingMode:b?.viewingMode??null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};var a=this.map?.();const b=this.spatialReference;if(!b)return{updating:this._spatialReferenceTask.updating};let c;a=this._collectLayers([{parent:a?.basemap,layers:a?.basemap?.baseLayers},
{layers:a?.layers}],g=>"tileInfo"in g&&g.tileInfo?.spatialReference.equals(b)?(c=g,!0):!1,g=>"tileInfo"in g);return c?{tileInfo:c.tileInfo,updating:!1}:{updating:a}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};let a={};const b=this._collectLayers(this.mapCollections,c=>{const g=n.deriveHeightModelInfoFromLayer(c);return g?(a={heightModelInfo:g,vcsWkid:c.spatialReference?.vcsWkid,
latestVcsWkid:c.spatialReference?.latestVcsWkid},!0):!1},c=>n.supportsHeightModelInfo(c));return{...a,updating:b}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const a=[],b=this._collectLayers(this.mapCollections,c=>{const g="fullExtents"in c&&c.fullExtents||(null!=c.fullExtent?[c.fullExtent]:[]);var h=this.requiresExtentInSpatialReference?
null:g[0];if(h=g.find(k=>k.spatialReference.equals(this.spatialReference))??h)return a.push({extent:h,layer:c}),!0;if(0<this._getSupportedSpatialReferences(c).length)for(const k of g)a.push({extent:k,layer:c});return!1});return{candidates:a,updating:b}}get _extentTask(){const {candidates:a,updating:b}=this._extentCandidatesTask;if(b)return{updating:b};if(null==a||0===a.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const c=this._pickExtentCandidate(a),
g=this.spatialReference;if(c.extent.equals(this._projectExtentTask.input)&&g.equals(this._projectExtentTask.spatialReference))return{extent:this._projectExtentTask.output,updating:null!=this._projectExtentTask.task&&!this._projectExtentTask.task.finished};null!=this._projectExtentTask.task&&(this._projectExtentTask.task=l.abortMaybe(this._projectExtentTask.task));this._projectExtentTask={input:c.extent.clone(),output:null,spatialReference:g.clone(),task:r.createTask(async h=>{try{const k=await u.projectWithEngineOrService(c.extent,
g,"portalItem"in c.layer?c.layer.portalItem:void 0,h);this._projectExtentTask={...this._projectExtentTask,task:null,output:k}}catch(k){m.isAborted(h)||(this._projectExtentTask={...this._projectExtentTask,task:null})}})};return{updating:!0}}_narrowDownSpatialReferenceCandidates(a,b){if(null==a)return b;const c=[];for(const h of a)for(const k of b)if(h.spatialReference.equals(k.spatialReference)){a=h.viewingMode;var g=k.viewingMode;a=null!=a?null!=g?a===g?a:!1:a:g;if(!1!==a){c.push({spatialReference:h.spatialReference,
viewingMode:a});break}}return 0<c.length?c:null}_pickSpatialReferenceCandidate(a){const b=this.defaultSpatialReference;if(null==a||1>a.length)return b?{spatialReference:b,viewingMode:null}:null;null!=b&&1<a.length&&a.some(({spatialReference:c})=>c.equals(b))&&(a=a.filter(({spatialReference:c})=>c.equals(b)));1<a.length&&a.some(({viewingMode:c})=>c!==p.ViewingMode.Local)&&(a=a.filter(({viewingMode:c})=>c!==p.ViewingMode.Local));return a[0]}_getSupportedSpatialReferences(a){var b="supportedSpatialReferences"in
a&&a.supportedSpatialReferences||(a.spatialReference?[a.spatialReference]:[]);if(0===b.length)return[];const c=[];for(const g of b)if(b=this.getSpatialReferenceSupport(g,a),null!=b){b=b.constraints??[{spatialReference:g,viewingMode:null}];for(const {spatialReference:h,viewingMode:k}of b)this.requiresExtentInSpatialReference&&null!=this.userSpatialReference&&!h.equals(this.userSpatialReference)||c.push({spatialReference:h,viewingMode:k})}return c}_pickExtentCandidate(a){const b=this.spatialReference;
return a.find(({extent:c})=>b.equals(c.spatialReference))||a[0]}_collectLayers(a,b,c=()=>!0){if("loaded"!==this._loadMaybe(this.map?.()))return!0;b=new v(c,b);for(const g of a)if(this._collectCollection(g,b),b.done||b.preloading===this.sourcePreloadCount)break;return b.updating}_collectCollection(a,b){if(a.layers){switch(this._loadMaybe(a.parent)){case "loading":b.updating=!0;++b.preloading;return;case "failed":return}for(const c of a.layers)if(b.layerFilter(c)){switch(this._loadMaybe(c)){case "failed":continue;
case "loading":b.updating=!0;++b.preloading;break;case "loaded":b.updating||(b.done=b.pushLayer(c)),b.done||b.preloading===this.sourcePreloadCount||"layers"in c&&this._collectCollection({layers:c.layers},b)}if(b.done||b.preloading===this.sourcePreloadCount)break}}}_loadMaybe(a){return a&&"loadStatus"in a&&null!=a.loadStatus?"not-loaded"===a.loadStatus?(a.load().catch(b=>{m.isAbortError(b)}),"loading"):a.loadStatus:"loaded"}};e.__decorate([f.property()],d.DefaultsFromMap.prototype,"required",void 0);
e.__decorate([f.property({constructOnly:!0})],d.DefaultsFromMap.prototype,"map",void 0);e.__decorate([f.property({constructOnly:!0})],d.DefaultsFromMap.prototype,"getSpatialReferenceSupport",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"defaultSpatialReference",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"userSpatialReference",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"sourcePreloadCount",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,
"priorityCollection",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"requiresExtentInSpatialReference",void 0);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"suspended",void 0);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"ready",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"heightModelInfoReady",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"spatialReference",null);e.__decorate([f.property({readOnly:!0})],
d.DefaultsFromMap.prototype,"extent",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"heightModelInfo",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"vcsWkid",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"latestVcsWkid",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"viewingMode",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"tileInfo",null);e.__decorate([f.property({readOnly:!0})],
d.DefaultsFromMap.prototype,"mapCollections",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"_spatialReferenceTask",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"_tileInfoTask",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"_heightModelInfoTask",null);e.__decorate([f.property({readOnly:!0})],d.DefaultsFromMap.prototype,"_extentCandidatesTask",null);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"_extentTask",
null);e.__decorate([f.property()],d.DefaultsFromMap.prototype,"_projectExtentTask",void 0);d.DefaultsFromMap=e.__decorate([t.subclass("esri.views.support.DefaultsFromMap")],d.DefaultsFromMap);class v{constructor(a,b){this.layerFilter=a;this.pushLayer=b;this.preloading=-1;this.done=this.updating=!1}}Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});