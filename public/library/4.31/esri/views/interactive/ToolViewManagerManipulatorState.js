// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../core/iteratorUtils ../../core/mathUtils ../../core/screenUtils ./interactiveToolUtils ../support/screenUtils".split(" "),function(q,w,r,x,y,k){function t(a){for(const {manipulator:d}of a.values())if(null!=d&&d.interactive){if(d.grabbing&&d.grabCursor)return d.grabCursor;if(d.cursor)return d.cursor}return null}function m(a,d,c){let e=null;c(b=>{if(null==b.manipulators||!y.areToolManipulatorsEditable(b))return!1;const f=b.manipulators.intersect(a,d);if(null==f)return!1;e={tool:b,
manipulator:f};return!0});return e}class z{constructor(){this._pointerLocations=new Map;this._hoveredManipulators=new Map;this._grabbedManipulators=new Map;this._draggedManipulators=new Map;this._revertToNullActiveTool=this._externallyDragging=this._stopDrag=!1;this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return 0<this._grabbedManipulators.size||0<this._draggedManipulators.size}handleInputEvent(a,d){var c=()=>a.stopPropagation();switch(a.type){case "pointer-move":"mouse"===
a.pointerType&&this._pointerLocations.set(a.pointerId,{x:a.x,y:a.y,pointerType:a.pointerType});break;case "drag":0<this._grabbedManipulators.size?this._stopDrag=!0:"start"===a.action?this._externallyDragging=!0:"end"===a.action&&(this._externallyDragging=!1);this._stopDrag&&(a.stopPropagation(),"end"===a.action&&(this._stopDrag=!1));break;case "pointer-down":if("mouse"===a.pointerType&&0!==a.button)break;c=k.createScreenPointFromEvent(a);var e=m(c,a.pointerType,d.forEachTool);if(null==e)break;var b=
e.manipulator,f=e.tool;null==b||null==f||!b.interactive||b.grabbable&&b.grabbableForEvent(a)||!b.grabbing||b.dragging||this._releaseManipulatorBeforeDragging(b,a,d);null!=b&&null!=f&&b.interactive&&b.grabbable&&b.grabbableForEvent(a)&&!b.grabbing&&(this._grabbedManipulators.set(a.pointerId,{manipulator:b,tool:f,start:c,pointerType:a.pointerType}),1===this._grabbedManipulators.size&&null==d.activeTool&&(this._revertToNullActiveTool=!0,d.setActiveTool(e.tool)),b.grabbing=!0,b.events.emit("grab-changed",
{action:"start",pointerType:a.pointerType,screenPoint:c}),a.stopPropagation());break;case "pointer-up":this._draggedManipulators.has(a.pointerId)||this._handlePointerEnd(a,d);break;case "pointer-drag":if("mouse"===a.pointerType&&0!==a.button)break;f=this._grabbedManipulators.get(a.pointerId);c=f?.manipulator;e=f?.tool;if(null==c||null==e)break;b=k.createScreenPointFromEvent(a);b.x=r.clamp(b.x,0,d.view.width);b.y=r.clamp(b.y,0,d.view.height);f=f.start;const g=this._draggedManipulators.get(a.pointerId);
switch(a.action){case "start":case "update":if("update"===a.action||1===this._grabbedManipulators.size)c.dragging=!0,g?c.events.emit("drag",{action:"update",start:f,screenPoint:b}):c.events.emit("drag",{action:"start",start:f,screenPoint:b,pointerType:a.pointerType}),this._draggedManipulators.set(a.pointerId,{tool:e,manipulator:c,start:f});break;case "end":c.dragging=!1,g&&c.events.emit("drag",{action:"end",start:f,screenPoint:b}),this._draggedManipulators.delete(a.pointerId),this._handlePointerEnd(a,
d)}a.stopPropagation();break;case "immediate-click":e=k.createScreenPointFromEvent(a);const h=m(e,a.pointerType,d.forEachTool);a.native.shiftKey||d.forEachTool(n=>{if((null==h||h.tool!==n||n.automaticManipulatorSelection)&&n.manipulators){let u=!1;n.manipulators.forEach(({manipulator:v})=>{v.selected&&(v.selected=!1,u=!0)});if(u&&n.onManipulatorSelectionChanged)n.onManipulatorSelectionChanged()}});if(null==h)break;const {manipulator:l,tool:p}=h;if(!l.interactive)break;if(l.selectable&&p.automaticManipulatorSelection&&
(l.selected=!l.selected,p.onManipulatorSelectionChanged))p.onManipulatorSelectionChanged();l.events.emit("immediate-click",{screenPoint:e,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:c});l?.consumesClicks&&a.stopPropagation();break;case "click":c=k.createScreenPointFromEvent(a);e=m(c,a.pointerType,d.forEachTool)?.manipulator;if(null==e||!e.interactive)break;e.events.emit(a.type,{screenPoint:c,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey});
a.stopPropagation();break;case "double-click":e=k.createScreenPointFromEvent(a);b=m(e,a.pointerType,d.forEachTool);b=null!=b?b.manipulator:null;if(null==b||!b.interactive)break;b.events.emit("double-click",{screenPoint:e,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:c});b?.consumesClicks&&a.stopPropagation();break;case "immediate-double-click":e=k.createScreenPointFromEvent(a),b=m(e,a.pointerType,d.forEachTool),b=null!=b?b.manipulator:null,null!=b&&b.interactive&&
(b.events.emit("immediate-double-click",{screenPoint:e,button:a.button,pointerType:a.pointerType,shiftKey:a.native.shiftKey,stopPropagation:c}),"mouse"===a.pointerType&&b?.consumesClicks&&a.stopPropagation())}this._onFocusChange(d.forEachTool)}_releaseManipulatorBeforeDragging(a,d,c){a.grabbing=!1;a.events.emit("grab-changed",{action:"end",pointerType:d.pointerType,screenPoint:k.createScreenPointFromEvent(d)});this._grabbedManipulators.forEach(({manipulator:e},b)=>{e===a&&this._grabbedManipulators.delete(b)});
this._afterManipulatorRelease(c.setActiveTool)}_handlePointerEnd(a,d){const c=this._grabbedManipulators.get(a.pointerId)?.manipulator;null!=c&&c.grabbing&&(c.grabbing=!1,c.events.emit("grab-changed",{action:"end",pointerType:a.pointerType,screenPoint:k.createScreenPointFromEvent(a)}),this._grabbedManipulators.delete(a.pointerId),this._afterManipulatorRelease(d.setActiveTool))}_onFocusChange(a){this._updateCursor();this._updateFocusedManipulatorTools(a)}_updateCursor(){this._cursor=0<this._grabbedManipulators.size?
t(this._grabbedManipulators)||"grabbing":0<this._hoveredManipulators.size?t(this._hoveredManipulators)||"pointer":null}_updateFocusedManipulatorTools(a){const d=new Set,c=new Set;this._grabbedManipulators.forEach(({tool:e})=>{d.add(e)});this._hoveredManipulators.forEach(({tool:e})=>{c.add(e)});a(e=>{e.hasGrabbedManipulators=d.has(e);e.hasHoveredManipulators=c.has(e);var b=this._grabbedManipulators.values();b=w.find(b,({tool:f})=>f===e);e.firstGrabbedManipulator=null!=b?b.manipulator:null})}clearPointers(a,
{forEachTool:d,setActiveTool:c},e=!0,b){this._grabbedManipulators.forEach(({tool:f,manipulator:g,pointerType:h},l)=>{f!==a||null!=b&&b!==g||(this._grabbedManipulators.delete(l),g.grabbing=!1,g.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:h}))});this._draggedManipulators.forEach(({tool:f,manipulator:g},h)=>{f!==a||null!=b&&b!==g||(this._draggedManipulators.delete(h),g.dragging=!1,g.events.emit("drag",{action:"cancel"}))});e&&this._hoveredManipulators.forEach(({tool:f,manipulator:g},
h)=>{f!==a||null!=b&&b!==g||(this._hoveredManipulators.delete(h),g.hovering=!1)});this._afterManipulatorRelease(c);this._onFocusChange(d)}updateHoveredStateFromKnownPointers(a){this._pointerLocations.forEach((d,c)=>{this._updateHoveredStateForPointerAtScreenPosition(x.createScreenPoint(d.x,d.y),c,d.pointerType,a)})}handleHoverEvent(a,d){const c=a.type;"pointer-up"!==c&&"immediate-click"!==c&&"pointer-move"!==c||"mouse"!==a.pointerType||("pointer-up"!==c&&this._externallyDragging?this._clearHoveredManipulatorStates(a.pointerId):
this._updateHoveredStateForPointerAtScreenPosition(k.createScreenPointFromEvent(a),a.pointerId,a.pointerType,d))}_updateHoveredStateForPointerAtScreenPosition(a,d,c,e){a=m(a,c,e);c=this._hoveredManipulators.get(d)?.manipulator;null==a||a.manipulator.interactive||(a=null);if(null==a||c!==a.manipulator)null!=c&&(c.hovering=!1),null!=a?(a.manipulator.hovering=!0,this._hoveredManipulators.set(d,a)):this._hoveredManipulators.delete(d),this._onFocusChange(e)}_afterManipulatorRelease(a){0===this._grabbedManipulators.size&&
this._revertToNullActiveTool&&(a(null),this._revertToNullActiveTool=!1)}_clearHoveredManipulatorStates(a){this._hoveredManipulators.forEach(({manipulator:d},c)=>{a===c&&(this._hoveredManipulators.delete(a),d.hovering=!1)})}}q.ToolViewManagerManipulatorState=z;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});