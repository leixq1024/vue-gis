// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/asyncUtils ../../../../../core/Logger ../../../../../core/promiseUtils ../../../../../core/reactiveUtils ../../../../../core/SetUtils ../../../../../core/uuid ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/support/UpdatingHandles ../../../../../geometry/Extent ../../../../../geometry/support/aaBoundingRect ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/support/arcgisLayerUrl ../../../../../rest/query/operations/pbfOptimizedFeatureSet ../../../../../rest/query/operations/query ../../../../../rest/support/Query ./PendingFeatureTile".split(" "),
function(d,e,B,C,v,w,x,y,m,z,g,L,D,E,F,G,A,H,I,r,t,u){d.FeatureServiceTiledFetcher=class extends B{get _minimumVerticesPerFeature(){switch(this.store?.featureStore.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":return 1;case "esriGeometryPolygon":return 4;case "esriGeometryPolyline":return 2}}get _mandatoryOutFields(){const a=new Set;this.objectIdField&&a.add(this.objectIdField);this.globalIdField&&a.add(this.globalIdField);return a}set outFields(a){const b=this._get("outFields");
a=m.union(a,this._mandatoryOutFields);m.equals(a,b)||(this._set("outFields",a),m.isSubsetOf(a,b)||this.refresh())}get outFields(){return this._get("outFields")??this._mandatoryOutFields}set filter(a){const b=this._get("filter");a=this._filterProperties(a);JSON.stringify(b)!==JSON.stringify(a)&&this._set("filter",a)}set customParameters(a){const b=this._get("customParameters");JSON.stringify(b)!==JSON.stringify(a)&&this._set("customParameters",a)}get _configuration(){return{filter:this.filter,customParameters:this.customParameters,
tileInfo:this.tileInfo,tileSize:this.tileSize}}set tileInfo(a){const b=this._get("tileInfo");b===a||null!=a&&null!=b&&JSON.stringify(a)===JSON.stringify(b)||(this._set("tileInfo",a),this.store.tileInfo=a)}set tileSize(a){this._get("tileSize")!==a&&this._set("tileSize",a)}get updating(){return this._updatingHandles.updating}get hasZ(){return this.store.featureStore.hasZ}constructor(a){super(a);this.suspended=!0;this._historicMoment=null;this.tilesOfInterest=[];this.availability=0;this._pendingTiles=
new Map;this._updatingHandles=new E.UpdatingHandles}initialize(){this._initializeFetchExtent();this._updatingHandles.add(()=>this._configuration,()=>this.refresh());this._updatingHandles.add(()=>this.tilesOfInterest,(a,b)=>{C.equals(a,b,({id:c},{id:f})=>c===f)||this._process()},y.sync);this.addHandles(y.when(()=>!this.suspended,()=>this._process()))}destroy(){this._pendingTiles.forEach(a=>this._deletePendingTile(a));this._pendingTiles.clear();this.store.destroy();this.tilesOfInterest.length=0;this._updatingHandles.destroy()}refresh(){this.store.refresh();
this._pendingTiles.forEach(a=>this._deletePendingTile(a));this._process()}async handleEdits(a){a.historicMoment&&(this._historicMoment=a.historicMoment);if(a.addedFeatures.length||a.updatedFeatures.length||a.deletedFeatures.length){for(const c of this._pendingTiles.values())c.reset();var b={...a,deletedFeatures:a.deletedFeatures.map(({objectId:c,globalId:f})=>c&&-1!==c?c:this._lookupObjectIdByGlobalId(f))};a=v.createTask(async c=>{try{await this.store.processEdits(b,(f,h)=>this._queryFeaturesById(f,
h),c),this._processPendingTiles()}catch(f){x.throwIfAbortError(f),w.getLogger(this).warn("Failed to apply edits",f)}});this.addHandles(a);await this._updatingHandles.addPromise(a.promise)}}setHistoricMoment(a){a?.getTime()!==this._historicMoment?.getTime()&&(this._historicMoment=a,this.refresh())}_initializeFetchExtent(){if(this.capabilities.query.supportsExtent&&H.isHostedAgolService(this.url)){var a=v.createTask(async b=>{try{const c=await r.executeQueryForExtent(this.url,new t({where:"1\x3d1",
outSpatialReference:this.spatialReference,cacheHint:this.capabilities.query.supportsCacheHint??void 0}),{query:this._configuration.customParameters,signal:b});this.store.extent=F.fromJSON(c.data?.extent)}catch(c){x.throwIfAbortError(c),w.getLogger(this).warn("Failed to fetch data extent",c)}});this._updatingHandles.addPromise(a.promise.then(()=>this._process()));this.addHandles(a)}}get debugInfo(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this._pendingTiles.values()).map(a=>
a.debugInfo),storedTiles:this.store.debugInfo}}_process(){this._markTilesNotAlive();this._createPendingTiles();this._deletePendingTiles();this._processPendingTiles()}_markTilesNotAlive(){for(const a of this._pendingTiles.values())a.alive=!1}_createPendingTiles(){if(!this.suspended){var a=this._collectMissingTilesInfo();this._setAvailability(null==a?1:a.coveredArea/a.fullArea);if(null!=a)for(const {data:b,resolution:c}of a.missingTiles)(a=this._pendingTiles.get(b.id))?(a.resolution=c,a.alive=!0):this._createPendingTile(b,
c)}}_collectMissingTilesInfo(){let a=null;for(let b=this.tilesOfInterest.length-1;0<=b;b--){const c=this.store.process(this.tilesOfInterest[b],(f,h)=>this._verifyTileComplexity(f,h),this.outFields);null==a?a=c:a.prepend(c)}return a}_deletePendingTiles(){for(const a of this._pendingTiles.values())a.alive||this._deletePendingTile(a)}_processPendingTiles(){const a={fetchCount:(b,c)=>this._fetchCount(b,c),fetchFeatures:(b,c,f)=>this._fetchFeatures(b,c,f),finish:(b,c)=>this._finishPendingTile(b,c),resume:()=>
this._processPendingTiles()};if(this._ensureFetchAllCounts(a))for(const b of this._pendingTiles.values())this._verifyTileComplexity(this.store.getFeatureCount(b.data),b.resolution)&&this._updatingHandles.addPromise(b.process(a))}_verifyTileComplexity(a,b){return this._verifyVertexComplexity(a)&&this._verifyFeatureDensity(a,b)}_verifyVertexComplexity(a){return 1E6>a*this._minimumVerticesPerFeature}_verifyFeatureDensity(a,b){if(null==this.tileInfo)return!1;b*=this.tileSize;return 1>25/(b*b)*a}_ensureFetchAllCounts(a){let b=
!0;for(const c of this._pendingTiles.values())c.state.type<u.StateType.FETCHED_COUNT&&this._updatingHandles.addPromise(c.process(a)),c.state.type<=u.StateType.FETCH_COUNT&&(b=!1);return b}_finishPendingTile(a,b){this.store.add(a.data,b);this._deletePendingTile(a);this._updateAvailability()}_updateAvailability(){const a=this._collectMissingTilesInfo();this._setAvailability(null==a?1:a.coveredArea/a.fullArea)}_setAvailability(a){this._set("availability",a)}_createPendingTile(a,b){b=new u.PendingFeatureTile(a,
b);this._pendingTiles.set(a.id,b);return b}_deletePendingTile(a){a.reset();this._pendingTiles.delete(a.data.id)}async _fetchCount(a,b){return this.store.fetchCount(a.data,this.url,this._createCountQuery(a),{query:this.customParameters,timeout:6E5,signal:b})}async _fetchFeatures(a,b,c){let f=0;const h=[];let k=0,n=b;for(;;){const p=this._createFeaturesQuery(a),q=this._setPagingParameters(p,f,n),{features:l,exceededTransferLimit:J}=await this._queryFeatures(p,c);q&&(f+=p.num);k+=l.length;for(const K of l)h.push(K);
n=b-k;if(!q||!J||0>=n)return h}}_filterProperties(a){return null==a?{where:"1\x3d1",gdbVersion:void 0,timeExtent:void 0}:{where:a.where||"1\x3d1",timeExtent:a.timeExtent,gdbVersion:a.gdbVersion}}_lookupObjectIdByGlobalId(a){const b=this.globalIdField,c=this.objectIdField;if(null==b)throw Error("Expected globalIdField to be defined");let f=null;const h=a?z.normalizeGlobalID(a):a;this.store.featureStore.forEach(k=>{h===z.normalizeGlobalID(k.attributes[b])&&(f=k.objectId??k.attributes[c])});if(null==
f)throw Error(`Expected to find a feature with globalId ${a}`);return f}_queryFeaturesById(a,b){const c=this._createFeaturesQuery();c.objectIds=a;return this._queryFeatures(c,b)}_queryFeatures(a,b){return this.capabilities.query.supportsFormatPBF?this._queryFeaturesPBF(a,b):this._queryFeaturesJSON(a,b)}async _queryFeaturesPBF(a,b){const {sourceSpatialReference:c}=this;({data:a}=await r.executeQueryPBF(this.url,a,new I.OptimizedFeatureSetParserContext({sourceSpatialReference:c}),{query:this._configuration.customParameters,
timeout:6E5,signal:b}));return A.unquantizeOptimizedFeatureSet(a)}async _queryFeaturesJSON(a,b){const {sourceSpatialReference:c}=this;({data:a}=await r.executeQuery(this.url,a,c,{query:this._configuration.customParameters,timeout:6E5,signal:b}));return A.convertFromFeatureSet(a,this.objectIdField)}_createCountQuery(a){a=this._createBaseQuery(a);this.capabilities.query.supportsCacheHint&&(a.cacheHint=!0);return a}_createFeaturesQuery(a=null){const b=this._createBaseQuery(a);var c=null!=a?.data?this.store.getAttributesForTile(a?.data?.id):
null;c=m.union(m.difference(this.outFields,c??new Set),this._mandatoryOutFields);b.outFields=Array.from(c);b.returnGeometry=!0;null!=a&&(this.capabilities.query.supportsResultType?b.resultType="tile":this.capabilities.query.supportsCacheHint&&(b.cacheHint=!0));return b}_createBaseQuery(a){a=new t({returnZ:this.hasZ,returnM:!1,historicMoment:this._historicMoment,geometry:null!=this.tileInfo&&null!=a?G.toExtent(a.data.extent,this.tileInfo.spatialReference):void 0});const b=this._configuration.filter;
null!=b&&(a.where=b.where,a.gdbVersion=b.gdbVersion,a.timeExtent=b.timeExtent);a.outSpatialReference=this.spatialReference;return a}_setPagingParameters(a,b,c){if(!this.capabilities.query.supportsPagination)return!1;const {supportsMaxRecordCountFactor:f,supportsCacheHint:h,tileMaxRecordCount:k,maxRecordCount:n,supportsResultType:p}=this.capabilities.query,q=f?t.MAX_MAX_RECORD_COUNT_FACTOR:1,l=q*((p||h)&&k?k:n||2E3);a.start=b;f?(a.maxRecordCountFactor=Math.min(q,Math.ceil(c/l)),a.num=Math.min(c,a.maxRecordCountFactor*
l)):a.num=Math.min(c,l);return!0}};e.__decorate([g.property({constructOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"url",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"objectIdField",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"globalIdField",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"capabilities",void 0);e.__decorate([g.property({constructOnly:!0})],
d.FeatureServiceTiledFetcher.prototype,"sourceSpatialReference",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"spatialReference",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"store",void 0);e.__decorate([g.property({readOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"_minimumVerticesPerFeature",null);e.__decorate([g.property()],d.FeatureServiceTiledFetcher.prototype,"_mandatoryOutFields",null);e.__decorate([g.property()],
d.FeatureServiceTiledFetcher.prototype,"outFields",null);e.__decorate([g.property()],d.FeatureServiceTiledFetcher.prototype,"suspended",void 0);e.__decorate([g.property()],d.FeatureServiceTiledFetcher.prototype,"_historicMoment",void 0);e.__decorate([g.property()],d.FeatureServiceTiledFetcher.prototype,"filter",null);e.__decorate([g.property()],d.FeatureServiceTiledFetcher.prototype,"customParameters",null);e.__decorate([g.property({readOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"_configuration",
null);e.__decorate([g.property()],d.FeatureServiceTiledFetcher.prototype,"tileInfo",null);e.__decorate([g.property()],d.FeatureServiceTiledFetcher.prototype,"tileSize",null);e.__decorate([g.property()],d.FeatureServiceTiledFetcher.prototype,"tilesOfInterest",void 0);e.__decorate([g.property({readOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"updating",null);e.__decorate([g.property({readOnly:!0})],d.FeatureServiceTiledFetcher.prototype,"availability",void 0);e.__decorate([g.property()],d.FeatureServiceTiledFetcher.prototype,
"hasZ",null);d.FeatureServiceTiledFetcher=e.__decorate([D.subclass("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher")],d.FeatureServiceTiledFetcher);Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});