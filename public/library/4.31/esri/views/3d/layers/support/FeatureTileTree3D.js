// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Collection ../../../../core/handleUtils ../../../../core/Logger ../../../../core/maybe ../../../../core/PooledArray ../../../../core/reactiveUtils ../../../../core/uid ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ./FeatureTileDescriptor ./FeatureTileMeasurements3D ../../support/extentUtils ../../../support/Scheduler".split(" "),
function(c,d,n,p,q,r,t,u,g,v,e,A,B,w,l,m,x,y,k){c.FeatureTileTree3D=class extends n{constructor(a){super(a);this.tiles=new p;this.tileSize=512;this._idToTile=new Map;this._clients=new Set;this._dirty=!1;this._pendingTiles=null;this._newTiles=new u;this.tileBudget=100}initialize(){const a=()=>this._setDirty(),b=()=>this._reset();this.addHandles([g.watch(()=>this.tilingScheme,b,g.syncAndInitial),g.watch(()=>this.tileSize,b,g.syncAndInitial),g.watch(()=>this.cameraOnSurface?.location,a,g.syncAndInitial),
g.watch(()=>this.viewState?.contentCamera,a,g.syncAndInitial),g.watch(()=>this.focus?.location,a,g.syncAndInitial),g.watch(()=>this.terrain?.baseOpacity??1,a)]);this._frameWorker=this.scheduler?.registerTask(k.TaskPriority.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=t.removeMaybe(this._frameWorker)}get tilingScheme(){const a=this.tilingSchemeOwner.tilingScheme;return a?a.clone():null}set filterExtent(a){if(null==a||a.spatialReference.equals(this.viewState.spatialReference)){var b=this._get("filterExtent");
b===a||null!=b&&a&&b.equals(a)||(a=null!=a?a.clone():null,this._set("filterExtent",a),this._setDirty())}else r.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view")}get _filterExtentRect(){if(null==this.filterExtent)return null;const a=l.create();y.toBoundingRect(this.filterExtent,a,this.tilingScheme.spatialReference);return a}get _rootTileIds(){const {tilingScheme:a}=this;return this._filterExtentRect&&a?a.rootTilesInExtent(this._filterExtentRect):
[[0,0,0]]}set suspended(a){a!==this._get("suspended")&&(this._set("suspended",a),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}addClient(){const a=v.generateUID();this._clients.add(a);1===this._clients.size&&this._setDirty();return q.makeHandle(()=>this._removeClient(a))}_removeClient(a){this._clients.delete(a);this._hasClients||this._clear()}get _hasClients(){return 0<this._clients.size}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=
!0,this.notifyChange("updating")):this.runTask(k.noBudget))}_clear(){this.tiles.removeAll();this._idToTile.clear();this._reset();this._dirty=!1;this.notifyChange("updating")}get running(){return this.updating}runTask(a){this._dirty=!1;this._pendingTiles||(this._startUpdate(),null!=this._frameWorker&&(this._frameWorker.priority=k.TaskPriority.FEATURE_TILE_TREE_ACTIVE));this._subdivideTilesForView(a);this._pendingTiles||null==this._frameWorker||(this._frameWorker.priority=k.TaskPriority.FEATURE_TILE_TREE);
this.notifyChange("updating")}_startUpdate(){this.suspended||(this.tilingScheme?(this._tileMeasurements||(this._tileMeasurements=new x.FeatureTileMeasurements3D({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,getIsGroundOpaque:()=>1===(this.terrain?.baseOpacity??1)})),this._tileMeasurements.begin(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=this._getRootTiles()):this._clear())}_reset(){this._newTiles.clear();this._pendingTiles=
this._tileMeasurements=null;this._setDirty()}_getRootTiles(){const a=this.tilingScheme;return this._rootTileIds.map(b=>new m.FeatureTileDescriptor(b[0],b[1],b[2],a))}_subdivideTilesForView(a){if(this._pendingTiles){for(var {tilingScheme:b}=this;0<this._pendingTiles.length&&!a.done;){const f=this._pendingTiles.shift();a.madeProgress();if(this._filterExtentRect&&!l.intersects(this._filterExtentRect,f.extent))continue;this._tileMeasurements.updateTile(f);const {measures:h}=f;if(h.visibility===m.Visibility.INVISIBLE)continue;
const z=this._newTiles.length+this._pendingTiles.length+1;h.shouldSplit&&z<this.tileBudget?(b.ensureMaxLod(f.lij[0]+1),this._pendingTiles.push(...f.getChildren())):this._newTiles.push(f)}0===this._pendingTiles.length&&(this._updateTiles(this._newTiles.toArray()),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(a){for(var b of this.tiles.items)b.used=!1;a=a.filter(f=>{const h=this._idToTile.get(f.id);h?(h.copyMeasurementsFrom(f),h.used=!0):this._idToTile.set(f.id,
f);return!h});b=this.tiles.items.filter(f=>f.used?!1:(this._idToTile.delete(f.id),!0));this.tiles.removeMany(b);this.tiles.addMany(a);this._sortTiles();this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((a,b)=>a.measures.distance-b.measures.distance);this.tiles.forEach((a,b)=>a.loadPriority=b)}};d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"scheduler",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,
"renderCoordsHelper",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"tilingSchemeOwner",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"cameraOnSurface",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"focus",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"viewState",void 0);d.__decorate([e.property({constructOnly:!0})],c.FeatureTileTree3D.prototype,"terrain",
void 0);d.__decorate([e.property()],c.FeatureTileTree3D.prototype,"tiles",void 0);d.__decorate([e.property()],c.FeatureTileTree3D.prototype,"tileSize",void 0);d.__decorate([e.property({readOnly:!0})],c.FeatureTileTree3D.prototype,"tilingScheme",null);d.__decorate([e.property()],c.FeatureTileTree3D.prototype,"filterExtent",null);d.__decorate([e.property({readOnly:!0})],c.FeatureTileTree3D.prototype,"_filterExtentRect",null);d.__decorate([e.property({readOnly:!0})],c.FeatureTileTree3D.prototype,"_rootTileIds",
null);d.__decorate([e.property({value:!1})],c.FeatureTileTree3D.prototype,"suspended",null);d.__decorate([e.property({readOnly:!0})],c.FeatureTileTree3D.prototype,"updating",null);c.FeatureTileTree3D=d.__decorate([w.subclass("esri.views.3d.layers.support.FeatureTileTree3D")],c.FeatureTileTree3D);Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});