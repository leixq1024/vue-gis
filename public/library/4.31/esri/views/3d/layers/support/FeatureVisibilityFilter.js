// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/support/UpdatingHandles ../../../../layers/support/FeatureFilter ../../../../layers/support/floorFilterUtils ../graphics/QueryEngine ../../../support/Scheduler".split(" "),
function(b,d,p,q,m,k,n,e,z,A,r,t,u,v,w,x){b.FeatureVisibilityFilter=class extends p{constructor(f){super(f);this._queryEngine=this._frameTask=null;this._updateRequested=!0;this._updatingHandles=new t.UpdatingHandles;this._abortController=new AbortController}initialize(){const f=x.TaskPriority.FILTER_VISIBILITY,{layer:g,view:a}=this._configuration,{featureStore:c}=this.context;this._queryEngine=new w.QueryEngine({context:{spatialReference:a.spatialReference,layer:g,scheduler:a.resourceController.scheduler,
featureStore:c,hasM:this._configuration.hasM??!1,hasZ:this._configuration.hasZ??!1},priority:f});this._frameTask=a.resourceController.scheduler.registerTask(f);this._updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this._updateRequested=!0,n.initial);this._updatingHandles.addWhen(()=>!this._frameTask.updating&&this._updateRequested,()=>{this._frameTask.schedule(()=>this._updateVisibility(),this._abortController.signal);this._updateRequested=!1},n.initial)}destroy(){this._abortController.abort();
this._updatingHandles.destroy();this.clear();this._frameTask=m.removeMaybe(this._frameTask);this._queryEngine=m.destroyMaybe(this._queryEngine);this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _sceneFilter(){return"layerFilter"in this._configuration?
this._configuration.layerFilter:null}get _floorFilter(){return v.getFloorFilterClause(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){const {_featureFilter:f,_timeExtent:g,_floorFilter:a}=this;if(null==g&&null==a)return f;const c=f?.clone()??new u;null!=g&&(c.timeExtent=c.timeExtent?.intersection(g)??g);null!=a&&(c.where=null==c.where||""===c.where?a:`(${c.where}) AND (${a})`);return c}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=
!0}clear(){this._queryEngine.clear();this.context.clearFeaturesVisibility()}async _updateVisibility(){const f=this._compositedFeatureFilter,g=this._sceneFilter,{signal:a}=this._abortController,c=this._frameTask,{context:l}=this;k.throwIfAborted(a);if(null==f&&null==g||0===l.getFeatureCount())return await c.schedule(()=>this.clear(),a);try{const h=await this._queryEngine.executeQueryForIdSet(f,g,a);k.throwIfAborted(a);return await c.schedule(()=>{l.updateFeatureVisibilities(y=>h.has(y))},a)}catch(h){return k.throwIfAbortError(h),
q.getLogger(this).warn(`FeatureFilter query failed: ${h}`,{error:h}),await c.schedule(()=>{l.setAllFeaturesVisibility(!0)},a)}}};d.__decorate([e.property({constructOnly:!0})],b.FeatureVisibilityFilter.prototype,"context",void 0);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"updating",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"defaultVisibility",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_featureFilter",null);d.__decorate([e.property()],
b.FeatureVisibilityFilter.prototype,"_sceneFilter",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_floorFilter",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_timeExtent",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_configuration",null);d.__decorate([e.property()],b.FeatureVisibilityFilter.prototype,"_updateRequested",void 0);
b.FeatureVisibilityFilter=d.__decorate([r.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],b.FeatureVisibilityFilter);Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});