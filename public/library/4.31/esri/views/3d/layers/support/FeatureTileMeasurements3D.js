// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/mathUtils ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/frustum ../../../../geometry/support/ray ../../../ViewingMode ./FeatureTileDescriptor ./FeatureTileVisibility3D ../../webgl/RenderCamera".split(" "),function(F,G,c,n,Q,B,H,R,S,I,T){class U{constructor(d){this._camera=new T;this._focusOnMap=[0,0];this._renderCoordsHelper=d.renderCoordsHelper;this._tilingScheme=
d.tilingScheme;this._visibility=new I.FeatureTileVisibility3D(d.renderCoordsHelper,d.getIsGroundOpaque)}begin(d,b,a){this._camera.copyFrom(d);this._surfaceElevation=a;this._focusOnMap[0]=b.x;this._focusOnMap[1]=b.y;this._visibility.begin(this._camera)}end(){this._visibility.end()}updateTile(d){const {measures:b}=d;b.visibility=this._visibility.calculate(d);b.distance=Q.distance(d.extent,this._focusOnMap);b.visibility!==S.Visibility.INVISIBLE&&this._updateSplitDecisionAndLod(d)}_calculateTileShouldSplitGlobal(d){var {eye:b}=
this._camera,a=c.len(b),e=this._renderCoordsHelper;const h=e.referenceEllipsoid.radius;if(a>2*h)return d.measures.effectiveLevelForLod=0,!1;a=d.lij[0];if(a<=I.globalTileLevelThreshold)return d.measures.effectiveLevelForLod=a,!0;a=J;var {extent:f}=d,{_surfaceElevation:g}=this;c.set(a[0],f[0],f[1],g);c.set(a[1],f[2],f[1],g);c.set(a[2],f[2],f[3],g);c.set(a[3],f[0],f[3],g);f=c.set(K,.5*(f[0]+f[2]),.5*(f[1]+f[3]),g);g=this._tilingScheme.spatialReference;for(let k=0;4>k;++k)e.toRenderCoords(a[k],g,a[k]);
e.toRenderCoords(f,g,f);e=c.normalize(L,f);g=c.dot(b,e);g=c.scale(M,e,g);b=c.len(b)-h;c.copy(x.origin,V);c.copy(x.direction,e);return this._calculateTileShouldSplitCommon(d,a,f,x,b,g)}_calculateTileShouldSplitLocal(d){const b=J;var {extent:a}=d,{_surfaceElevation:e}=this;c.set(b[0],a[0],a[1],e);c.set(b[1],a[2],a[1],e);c.set(b[2],a[2],a[3],e);c.set(b[3],a[0],a[3],e);a=this._tilingScheme.spatialReference;for(e=0;4>e;++e)this._renderCoordsHelper.toRenderCoords(b[e],a,b[e]);a=c.set(K,.5*(b[0][0]+b[2][0]),
.5*(b[0][1]+b[2][1]),.25*(b[0][2]+b[1][2]+b[2][2]+b[3][2]));e=c.set(L,a[0],a[1],0);const {eye:h,far:f}=this._camera,g=c.set(M,e[0],e[1],h[2]),k=h[2];c.set(x.origin,e[0],e[1],h[2]-2*f);c.copy(x.direction,y);return this._calculateTileShouldSplitCommon(d,b,a,x,k,g,W,h[2]-2*f)}_calculateTileShouldSplitCommon(d,b,a,e,h,f,g,k){const p=Math.max(c.dist(b[0],b[2]),c.dist(b[1],b[3]),c.dist(b[0],a)+c.dist(a,b[2])),E=this._camera,{eye:z,near:w,far:X,fovY:Y,viewForward:C}=E;var q=G.clamp(c.dot(e.direction,C),
.1,1);const N=c.dot(z,C);var r=c.dot(a,C)-N;const O=2*Math.tan(.5*Y);var A=Math.abs(h)/p;const P=r<=w?1:1/(r*O),t=d.lij[0];var u=c.dist(z,a),m=0,l=Infinity;for(var v of b){var D=c.dist(z,v);l=Math.min(l,D);m=Math.max(m,D)}const {perScreenPixelRatio:Z}=E;v=aa=>Math.max(0,t-2,t+Math.ceil(Math.log2(.002*aa/Z)));D=300*G.clamp(q,.1,1);q=c.dist(f,z)>.7*p;u=v(q?1*p/u:r<w?D*p/Math.abs(h):.8*P*p);h=u+(l-w>.33*(X-w)?-1:0);d.measures.effectiveLevelForLod=h;if(t+2<h)return!0;if(t>=h)return!1;({frustum:d}=E);
A=1>A;if(c.dist(f,z)<w)return A;e=B.intersectsRay(d,e);if(q){if(l=v(1*p/l),m=v(1*p/m),2<Math.abs(l-m)||2<Math.abs(u-m)||2<Math.abs(u-l))return!0}else if(m=c.dist(z,a),l=.5*p/Math.SQRT2,t<=h+3||.6<m/l)return!0;if(!this.isGlobalMode&&q&&g&&void 0!==k){m=0;for(q=0;4>q;++q)l=g[q],f=k,v=n.create(),c.scaleAndAdd(v,b[q],l,f),l=H.fromValues(v,l),B.intersectsRay(d,l)&&++m;if(3<=m||2<=m&&e)return!1;if(2>=m&&!e&&t<u+1)return!0}a=B.intersectsPoint(d,a);g=0;for(k=0;4>k;++k)u=B.intersectsPoint(d,b[k]),g+=u?1:0;
if(a&&2<=g)return!1;if(!a&&!e&&1>=g&&t<h)return A;for(k=0;4>k;++k)d=c.dot(b[k],C)-N,r=Math.min(r,d);return r<=w?A:.3>(r<=w?1:1/(r*O))*p?!1:t<h&&.9<P*p&&2>=g&&!a&&!e}_updateSplitDecisionAndLod(d){d.measures.shouldSplit=this.isGlobalMode?this._calculateTileShouldSplitGlobal(d):this._calculateTileShouldSplitLocal(d);d.updateResolution()}get isGlobalMode(){return this._renderCoordsHelper.viewingMode===R.ViewingMode.Global}}const J=[n.create(),n.create(),n.create(),n.create()],K=n.create(),L=n.create(),
M=n.create(),y=n.freeze(0,0,1),W=[y,y,y,y],V=n.ZEROS,x=H.fromValues(n.ZEROS,y);F.FeatureTileMeasurements3D=U;Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});