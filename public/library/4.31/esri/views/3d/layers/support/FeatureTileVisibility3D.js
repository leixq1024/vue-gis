// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/spatialReferenceEllipsoidUtils ../../../../geometry/projection/projectBuffer ../../../../geometry/projection/projectVec3Array ../../../../geometry/support/frustum ../../../../geometry/support/plane ../../../ViewingMode ./FeatureTileDescriptor ../../state/Frustum".split(" "),function(E,c,g,Y,Z,aa,ba,F,w,ca,O,da){function z(a,b,d){c.cross(a,b,d);c.normalize(a,
a);return a}function P(a,b,d){c.sub(a,b,d);c.normalize(a,a);return a}function G(a,b){c.scale(a,a,b/c.len(a));return a}function J(a,b,d){for(const k of Q){a:{var f=a[k];var l=b,e=d;for(let h=0;h<e;++h)if(0>=w.signedDistance(f,l[h])){f=!1;break a}f=!0}if(f)return!0}return!1}function I(a,b,d=b.length){for(let f=0;f<d;++f){const l=b[f];let e=!0;for(const k of a)if(0<w.signedDistance(k,l)){e=!1;break}if(e)return!0}return!1}function ea(a,b,d){for(const f of b)if(c.dot(f,a)<d)return!1;return!0}function K(a,
b,d,f){if(0===d.length||0===f.length)return!0;var l=fa;z(l,a,b);var e=f[0]<d[0];a=e?d:f;b=ha;e=e?f:d;d=Infinity;f=-Infinity;for(var k of e)e=c.dot(l,k),d=Math.min(d,e),f=Math.max(f,e);b[0]=d;b[1]=f;a:{k=b[0];b=b[1];d=Infinity;f=-Infinity;for(const h of a)if(a=c.dot(l,h),d=Math.min(d,a),f=Math.max(f,a),d<=b&&f>=k){l=!1;break a}l=!0}return l}function L(a,b,d){const f={t0:0,t1:1};for(const l of Q)if(!R(a[l],b,d,f))return!1;return f.t0<f.t1}function S(a,b,d){const f={t0:0,t1:1};for(const l of a)if(!R(l,
b,d,f))return!1;return f.t0<f.t1}function R(a,b,d,f){let {t0:l,t1:e}=f;b=w.signedDistance(a,b);a=w.signedDistance(a,d);if(0<=b&&0<=a)return!1;if(0>b&&0<=a){a=-b/(a-b);if(a<l)return!1;a<e&&(e=a)}else if(0<=b&&0>a){a=b/(b-a);if(a>e)return!1;a>l&&(l=a)}f.t0=l;f.t1=e;return!0}class ia{constructor(a,b){this._renderCoordsHelper=a;this._getIsGroundOpaque=b;this._isGroundOpaque=!1;this._cache=new Map;this._cameraForward=g.create();this._cameraEye=g.create();this._cameraFovY=55*Math.PI/180;this._frustumBoundingSphereCenter=
g.create();this._frustumBoundingSphereRadius=0;this._frustum=new da.Frustum(a);this._renderSR=a.spatialReference;a=Z.getSphericalPCPF(this._renderSR);this._renderSREllipsoidRadius=Y.getReferenceEllipsoid(a).radius}begin(a){this._aboveGround=a.aboveGround;this._isGroundOpaque=this._getIsGroundOpaque();this._frustum.update(a);c.normalize(this._cameraForward,a.viewForward);c.copy(this._cameraEye,a.eye);this._cameraFovY=a.fovY;this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(a){return this._getOrCalculateSingleTileVisibility(a)}_getOrCalculateSingleTileVisibility(a){var b=
this._cache.get(a.id);if(null!=b)return b;b=this._calculateSingleTileVisibility(a);this._cache.set(a.id,b);return b}_calculateSingleTileVisibility(a){return this._calculateSingleTileVisibilitySided(a)}_isTileVisibleInFrustum(a){return this._renderCoordsHelper.viewingMode===ca.ViewingMode.Local?this._isTileVisibleInFrustumLocal(a):this._isTileVisibleInFrustumGlobal(a)}_updateFrustumBoundingSphere(){var a=this._frustum;const b=a.origin,d=ja;c.normalize(d,a.direction);var f=ka;c.sub(f,a.points[4],b);
a=c.dot(f,f);f=c.dot(d,f);f=.5*a/f;c.scaleAndAdd(this._frustumBoundingSphereCenter,b,d,f);this._frustumBoundingSphereRadius=1+f}_isTileVisibleInFrustumLocal(a){var b=a.tilingScheme.spatialReference,d=a.extent,f=this._renderSR;a=la;a[0]=d[0];a[1]=d[1];a[2]=0;a[3]=d[2];a[4]=d[3];a[5]=0;if(!aa.projectBuffer(a,b,0,a,f,0))return!1;b=T;c.set(b[0],a[0],a[1],0);c.set(b[1],a[3],a[1],0);c.set(b[2],a[3],a[4],0);c.set(b[3],a[0],a[4],0);f=U;c.set(f,.5*(a[0]+a[3]),.5*(a[1]+a[4]),.5*(a[2]+a[5]));d=V;var l=.5*c.dist(b[0],
b[2]);a=this._frustum;var e=this._frustumBoundingSphereRadius,k=this._frustumBoundingSphereCenter,h=ma;c.sub(h,k,f);h=c.dot(d,h);var n=na;c.scaleAndAdd(n,f,d,h);if(c.dist(n,k)>l+e)return!1;k=this._cameraForward;l=c.dot(k,V);f=this._cameraEye;if(Math.abs(l)<Math.abs(Math.cos(.5*this._cameraFovY))){l=!0;k=c.set(oa,k[0],k[1],0);n=c.dot(f,k);for(let m=0;4>m;++m)if(0<c.dot(b[m],k)-n){l=!1;break}if(l)return!1}l=b[0];k=b[2];if(l[0]<=f[0]&&f[0]<=k[0]&&l[1]<=f[1]&&f[1]<=k[1])return!0;l=pa;k=Math.min(this._isGroundOpaque&&
!this._aboveGround?430:Infinity,h+e);e=Math.max(this._isGroundOpaque&&this._aboveGround?-430:-Infinity,h-e);for(h=0;4>h;++h)c.scaleAndAdd(l[h],b[h],d,k),c.scaleAndAdd(l[h+4],b[h],d,e);if(J(a.planes,l,8))return!1;if(I(a.planes,l,8))return!0;for(d=0;4>d;++d)if(h=l[d],n=l[d+4],L(a.planes,h,n)||L(a.planes,h,l[(d+1)%4])||L(a.planes,n,l[4+(d+1)%4]))return!0;x[0][3]=+b[0][0];x[1][3]=-b[2][0];x[2][3]=+b[0][1];x[3][3]=-b[2][1];x[4][3]=+e;x[5][3]=-k;if(I(x,a.points)||I(x,a.points))return!0;for(b=0;4>b;++b)if(d=
a.points[b+4],S(x,f,d)||S(x,d,a.points[4+(b+1)%4]))return!0;return!1}_isTileVisibleInFrustumGlobal(a){if(2>a.lij[0])return!0;var b=a.tilingScheme.spatialReference,d=a.extent;const f=this._isGroundOpaque&&this._aboveGround,l=this._isGroundOpaque&&!this._aboveGround;var e=T,k=.5*(d[0]+d[2]);c.set(e[0],d[0],d[1],0);c.set(e[1],d[2],d[1],0);c.set(e[2],d[2],d[3],0);c.set(e[3],d[0],d[3],0);c.set(e[4],k,d[1],0);c.set(e[5],k,d[3],0);if(!ba.projectVec3Array(e,b,0,e,this._renderSR,0,6))return!1;var h=0<e[0][2],
n=0>e[3][2];d=this._renderSREllipsoidRadius;if(h||n){var m=g.fromValues(0,0,1),p=qa;z(p,m,e[0]);k=ra;z(k,m,e[1]);if(h){h=W;n=e[4];var v=X;z(v,n,m);z(h,v,n);m=e[0];c.cross(m,p,h);G(m,d);p=e[1];c.cross(p,k,h);G(p,d)}else n&&(h=W,n=e[5],v=X,z(v,n,m),z(h,n,v),m=e[3],c.cross(m,h,p),G(m,d),p=e[2],c.cross(p,h,k),G(p,d))}n=U;k=c.sub(sa,e[3],e[0]);c.normalize(k,k);p=c.add(ta,e[0],e[3]);c.scale(p,p,.5);m=-c.dot(p,k);p=c.add(ua,e[0],e[1]);c.scale(p,p,.5);h=c.add(va,e[2],e[3]);c.scale(h,h,.5);h=c.sub(wa,h,p);
c.normalize(h,h);k=-(m+c.dot(k,p))/c.dot(k,h);c.scaleAndAdd(n,p,h,k);G(n,d);h=this._frustumBoundingSphereRadius;v=this._frustumBoundingSphereCenter;const A=this._frustum;p=A.planes;var t=xa;c.normalize(t,n);m=c.dot(e[0],t)/c.len(e[0]);var u=A.origin;k=A.points;var y=!1;if(f){y=!0;var D=c.normalize(g.create(),u);for(var B=0;4>B;++B){var r=k[4+B];r=c.sub(g.create(),r,u);c.normalize(r,r);var C=c.cross(g.create(),D,r);c.normalize(C,C);r=c.cross(g.create(),r,C);c.normalize(r,r);if(c.dot(u,r)>d){y=!1;break}}if(y&&
c.dot(u,t)<d*m-430)return!1;u=c.normalize(ya,A.origin);if(0>c.dot(u,t))return!1;u=c.normalize(za,A.direction);if(c.dot(u,t)>Aa)return!1}D=Math.sqrt(1-m*m);if(.9<D)return!0;u=!1;r=c.dot(t,v);C=c.len(v);if(C<=h&&!p.some(H=>0<w.signedDistance(H,M)))if(f)u=!0;else return!0;B=r/C;if(!u&&0>=r&&-r>h)return!1;r=h/C;if(Math.sqrt(1-B*B)*Math.sqrt(1-r*r)-r*B>D)return!1;if(!y&&(e.some(H=>A.intersectsPoint(H))||A.intersectsPoint(n)))return!0;n=Ba;c.sub(n,v,M);n=c.dot(n,t);y=Ca;c.scale(y,t,n);v=c.dist(y,v);b=b.isWGS84;
t=a.lij;a=b&&t[2]===2**t[0]-1;b=(t=b&&0===t[2])?Da:a?Ea:Fa;a=t?Ga:a?Ha:Ia;if(!u){t=Ja;u=Ka;y=La;D=M;for(var q of b)if(b=e[q],P(u,e[(q+1)%4],b),P(y,D,b),z(t,y,u),ea(t,k,1))return!1}q=null;if(!f&&n<1.01*h){q=2.5*h;if(v>m*q+h)return!1;b=Ma;q/=m;for(m=0;4>m;++m)c.scale(b[m],e[m],q/d);c.set(b[4],0,0,0);q=b}else{q=(l?d+430:n+h)/m;b=f?d-430:(n-h)/m;m=Na;for(h=0;4>h;++h)n=e[h],c.scale(m[h],n,b/d),c.scale(m[h+4],n,q/d);q=m}if(J(p,q,q.length))return!1;b=A.lines;e=Oa;d=Pa;for(const H of b){c.normalize(d,H.direction);
for(const N of a){b=q[N];c.normalize(e,b);if(K(d,e,q,k))return!1;p=(N+1)%4;if(f&&(c.sub(e,q[p],b),c.normalize(e,e),K(d,e,q,k))||l&&(c.sub(e,q[4+p],q[4+N]),c.normalize(e,e),K(d,e,q,k)))return!1}}return!0}_calculateSingleTileVisibilitySided(a){return this._isTileVisibleInFrustum(a)?O.Visibility.VISIBLE:O.Visibility.INVISIBLE}}const Q=[F.PlaneIndex.LEFT,F.PlaneIndex.RIGHT,F.PlaneIndex.BOTTOM,F.PlaneIndex.TOP,F.PlaneIndex.FAR],pa=[g.create(),g.create(),g.create(),g.create(),g.create(),g.create(),g.create(),
g.create()],la=[0,0,0,0,0,0],T=[g.create(),g.create(),g.create(),g.create(),g.create(),g.create()],U=g.create(),W=g.create(),qa=g.create(),ra=g.create(),X=g.create(),xa=g.create(),Ca=g.create(),ja=g.create(),ka=g.create(),na=g.create(),ma=g.create(),M=g.freeze(0,0,0),Ba=g.create(),Na=[g.create(),g.create(),g.create(),g.create(),g.create(),g.create(),g.create(),g.create()],Ma=[g.create(),g.create(),g.create(),g.create(),g.create()],sa=g.create(),ta=g.create(),ua=g.create(),va=g.create(),wa=g.create(),
Ka=g.create(),La=g.create(),Oa=g.create(),Pa=g.create(),fa=g.create(),Fa=[0,1,2,3],Ia=[0,1,2,3],Ea=[0,1,3],Ha=[0,1,3],Da=[1,2,3],Ga=[1,2,3],Ja=g.create(),ha=[0,0],ya=g.create(),za=g.create(),Aa=Math.cos(.25*Math.PI),V=g.fromValues(0,0,1),oa=g.create(),x=[w.fromValues(-1,0,0,1),w.fromValues(1,0,0,-1),w.fromValues(0,-1,0,1),w.fromValues(0,1,0,-1),w.fromValues(0,0,-1,1),w.fromValues(0,0,1,-1)];E.FeatureTileVisibility3D=ia;E.globalTileLevelThreshold=2;E.isAnyVertexInPolyhedron=I;E.isConvexHullOutsideOfFrustum=
J;Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})});