// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../chunks/tslib.es6 ../../../../../../core/has ../../../../../../core/promiseUtils ../../../../../../core/Logger ../../../../../../core/RandomLCG ../../../../../../core/Error ../../../../../../core/accessorSupport/decorators/subclass ../../../../webgl-engine/lib/VertexAttribute ../../../../webgl-engine/lib/lodRendering/LodRenderer ../../../../webgl-engine/lib/lodRendering/LodResources".split(" "),function(k,q,r,t,y,z,A,u,v,w,l){function x(a,d){d=d.levels.map(f=>{const c=
f.components.map(e=>{const b=a(e.materialId);if(!m(b))throw Error("LodRenderer only supports DefaultMaterial");const g=b.createBufferWriter().vertexBufferLayout;return new l.LodComponentResources({material:b,vertexBufferLayout:g,buffer:e.renderGeometryBuffer.data,elementCount:e.renderGeometryBuffer.elementCount,boundingInfo:e.boundingInfo})});return new l.LodLevelResources(c,f.minScreenSpaceRadius)});return new l.LodResources(d)}function m(a){return null!=a&&"materialType"in a&&"default"===a.materialType}
k.LodRenderer=class{constructor(a){this._optionalFields=[];this._instanceIndexToFeatureId=new Map;this._featureIdToInstanceIndex=new Map;this._disposeResourceHandles=[];this._lodRendererResources=null;this.layerUid=a.layerUid;this.view=a.view;this.sharedResources=this.view.sharedSymbolResources;this.scheduler=this.view.resourceController.scheduler}async doLoad(a,d,f){r("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(v.VertexAttribute.OBJECTANDLAYERIDCOLOR);a=x(g=>d(g),a);const c=
this.view._stage,e=l.materialsFromLodResources(a);c.addMany(e);this._addDisposeResource(()=>c.removeMany(e));const b=l.texturesFromLodResources(a);c.addMany(b);this._addDisposeResource(()=>{b.forEach(g=>g.unload());c.removeMany(b)});await Promise.all(b.map(g=>this.view._stage.schedule(()=>g.load(c.renderView.renderingContext),f)));t.throwIfAborted(f);this._lodRendererResources={lodRenderer:await this._createLodRenderer(a,f),materials:e,textures:b}}addInstances(a){var d=this._lodRendererResources;
if(null!=d){var {featureIds:f,localTransforms:c,globalTransforms:e}=a;a=d.lodRenderer;if(null!=a){a=a.instanceData;d=f.length;for(let b=0;b<d;++b){const g=f[b],h=a.addInstance(),n=a.view,p=16*b;n.localTransform.copyFromTypedBuffer(h,c,p);n.globalTransform.copyFromTypedBuffer(h,e,p);a.updateModelTransform(h);a.setVisible(h,!0);this._instanceIndexToFeatureId.set(h,g);this._featureIdToInstanceIndex.set(g,h)}}}}removeInstances(a){var d=this._lodRendererResources;if(null!=d){d=(d?.lodRenderer).instanceData;
var f=this._instanceIndexToFeatureId,c=this._featureIdToInstanceIndex,e=a.length;for(let b=0;b<e;++b){const g=a[b],h=c.get(g);null!=h&&(d.removeInstance(h),f.delete(h),c.delete(g))}}}_addDisposeResource(a){this._disposeResourceHandles.push(a)}async _createLodRenderer(a,d){const f=this.view._stage,c=new w.LodRenderer({symbol:a,optionalFields:this._optionalFields,metadata:{layerUid:this.layerUid,graphicUid:e=>1,notifyGraphicGeometryChanged:e=>1,notifyGraphicVisibilityChanged:e=>1},shaderTransformation:null},
this.scheduler);c.slicePlaneEnabled=!1;this._addDisposeResource(()=>{f.removeRenderPlugin(c);c.destroy()});await f.addRenderPlugin(c,d);return c}};k.LodRenderer=q.__decorate([u.subclass("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],k.LodRenderer);k.isDefaultMaterial=m;Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});