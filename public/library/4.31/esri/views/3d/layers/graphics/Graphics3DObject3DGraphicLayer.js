// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../chunks/sphere ./elevationAlignmentUtils ./featureExpressionInfoUtils ./graphicUtils ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/edgeRendering/interfaces".split(" "),function(t,q,u,m,w,x,y,z,v,r){class A{constructor(a,b,d){this.baseMaterial=a;this.edgeMaterial=b;this.hasSlicePlane=d}}class B{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(a,
b,d,e,c,f,h,g=null){this.graphics3DSymbolLayer=a;this.stageObject=b;this._uniqueGeometries=d;this._uniqueMaterials=e;this._sharedResource=c;this.elevationAligner=f;this.elevationContext=h;this._edgeState=g;this.type="object3d";this._stageLayer=null;this._addedToStage=this._visible=!1;this.alignedSampledElevation=0;this.useObjectOriginAsAttachmentOrigin=this.needsElevationUpdates=!1}initialize(a){this._stageLayer=a;a=a.stage;a.addMany(this._uniqueMaterials);a.addMany(this._uniqueGeometries);a.add(this.stageObject)}destroy(){if(this._stageLayer){var a=
this._stageLayer.stage;a.removeMany(this._uniqueMaterials);a.removeMany(this._uniqueGeometries);a.remove(this.stageObject);this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);a.renderer.edgeView?.removeObject(this.stageObject);this.stageObject.dispose();this._sharedResource?.release();this._visible=!1;this._stageLayer=null}}layerOpacityChanged(a,b){const {stageObject:d,_edgeState:e,_stageLayer:c}=this;if(null!=e){var f=e.baseMaterial.parameters.transparent?r.Transparency.TRANSPARENT:
r.Transparency.OPAQUE;e.edgeMaterial.objectTransparency!==f&&(e.edgeMaterial.objectTransparency=f,this.resetEdgeObject(b));c.stage.renderer.withEdgeView(h=>h.updateAllComponentOpacities(d,[a]))}}slicePlaneEnabledChanged(a,b){const {stageObject:d,_edgeState:e,_stageLayer:c}=this;null!=e&&c.stage.renderer.withEdgeView(f=>{f.updateAllComponentMaterials(d,e.edgeMaterial,a,!b);e.hasSlicePlane=a})}setVisibility(a){const {_edgeState:b,stageObject:d,_stageLayer:e}=this;null!=e&&this.visible!==a&&(this._visible=
a,(d.visible=a)&&!this._addedToStage&&(e.add(d),this._addedToStage=!0),null!=b&&e.stage.renderer.withEdgeView(c=>{c.hasObject(d)?c.updateObjectVisibility(d,a):a&&this._addOrUpdateEdgeObject(b,c,!1)}))}get visible(){return this._visible}alignWithElevation(a,b,d,e){null!=this.elevationAligner&&(null!=d&&y.setContextFeature(this.elevationContext.featureExpressionInfoContext,d),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,a.spatialReference,(c,f)=>x.evaluateElevationInfoAtPoint(c,
a,this.elevationContext,b,f),b),this.resetEdgeObject(e))}alignWithAbsoluteElevation(a,b,d){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,(e,c)=>{c.sampledElevation=a;c.verticalDistanceToGround=0;c.z=a},b);this.resetEdgeObject(d)}getCenterObjectSpace(a=u.create()){return q.copy(a,w.getCenter(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(a=m.create()){const b=this.stageObject.boundingVolumeObjectSpace;m.setMin(a,b.min);m.setMax(a,
b.max);return a}computeAttachmentOrigin(a){const b=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)a.render.origin[0]+=b[12],a.render.origin[1]+=b[13],a.render.origin[2]+=b[14],a.render.num++;else for(const d of this.stageObject.geometries)d.computeAttachmentOrigin(k)&&(q.transformMat4(k,k,b),q.add(a.render.origin,a.render.origin,k),a.render.num++)}async getProjectedBoundingBox(a,b,d,e,c){c=this.getBoundingBoxObjectSpace(c);var f=C,h=m.isPoint(c)?1:f.length;for(var g=
0;g<h;g++){const p=f[g];l[0]=c[p[0]];l[1]=c[p[1]];l[2]=c[p[2]];q.transformMat4(l,l,this.stageObject.transformation);n[3*g]=l[0];n[3*g+1]=l[1];n[3*g+2]=l[2]}if(!a(n,0,h))return null;m.empty(c);a=null;this.calculateRelativeScreenBounds&&(a=this.calculateRelativeScreenBounds());for(f=0;f<3*h;f+=3){for(g=0;3>g;g++)c[g]=Math.min(c[g],n[f+g]),c[g+3]=Math.max(c[g+3],n[f+g]);a&&d.push({location:n.slice(f,f+3),screenSpaceBoundingRect:a})}if(b?.service&&"absolute-height"!==this.elevationContext.mode){m.center(c,
k);d="relative-to-scene"===this.elevationContext.mode?"scene":"ground";h=0;if(b.useViewElevation)h=b.service.getElevation(k[0],k[1],d)??0;else try{const p=z.demResolutionForBoundingBox(c,b.service.spatialReference,b);h=await b.service.queryElevation(k[0],k[1],e,p,d)??0}catch(p){}m.offset(c,0,0,-this.alignedSampledElevation+h)}return c}addObjectState(a){a.stateType===v.Object3DState.Highlight&&a.addObject(this.stageObject,this.stageObject.highlight(a.highlightGroupName));a.stateType===v.Object3DState.MaskOccludee&&
a.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(a){a.removeByObject(this.stageObject)}resetEdgeObject(a){const {_edgeState:b,stageObject:d,_stageLayer:e,_visible:c}=this;null!=b&&e.stage.renderer.withEdgeView(f=>{c?this._addOrUpdateEdgeObject(b,f,a):f.removeObject(d)})}_addOrUpdateEdgeObject(a,b,d){a.edgeMaterial.objectTransparency=a.baseMaterial.parameters.transparent?r.Transparency.TRANSPARENT:r.Transparency.OPAQUE;b.addOrUpdateObject3D(this.stageObject,a.edgeMaterial,
a.hasSlicePlane,!d).then(()=>this._stageLayer?.sync())}}const n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],l=u.create(),k=u.create(),C=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];t.Graphics3DObject3DGraphicLayer=B;t.Object3DEdgeState=A;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});