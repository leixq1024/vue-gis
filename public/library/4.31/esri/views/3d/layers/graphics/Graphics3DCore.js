// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../geometry ../../../../renderers/ClassBreaksRenderer ../../../../renderers/DictionaryRenderer ../../../../renderers/DotDensityRenderer ../../../../renderers/HeatmapRenderer ../../../../renderers/PieChartRenderer ../../../../renderers/Renderer ../../../../renderers/SimpleRenderer ../../../../renderers/UniqueValueRenderer ../../../../renderers/support/jsonUtils ../../../../core/Logger ../../../../symbols ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/has ../../../../core/Error ../../../../core/handleUtils ../../../../core/MapUtils ../../../../core/maybe ../../../../core/MemCache ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/decorators/subclass ../../../../core/accessorSupport/diffUtils ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/projection ../../../../geometry/projection/projectBuffer ../../../../geometry/projection/projectVectorToVector ../../../../geometry/projection/projectXYZToVector ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/Layer ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ../../../../layers/support/PromiseQueue ../../../../renderers/support/rendererConversion ../../../../support/arcadeOnDemand ../../../../support/basemapUtils ../../../../symbols/support/defaults3D ../../../../symbols/support/symbolConversion ./defaultSymbolComplexity ./DisplayFeatureLimit ./ElevationQuery ./enums ./featureExpressionInfoUtils ./Graphics3DFeatureStore ./Graphics3DGraphicCreationContext ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./Graphics3DWebStyleSymbol ./GraphicsCorePerformanceInfo ./GraphicStateTracking ./graphicUtils ./interfaces ./Loadable ./SpatialIndex2D ./symbolMemory ../support/StageLayerElevationProvider ../../support/extentUtils ../../webgl-engine/core/shaderLibrary/util/AlphaCutoff ../../webgl-engine/lib/GridLocalOriginFactory ../../webgl-engine/lib/UpdatePolicy ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/lib/WebGLLayer ../../../layers/support/popupUtils ../../../support/PropertiesPool ../../../support/Scheduler ../../../support/Yield ../../../../geometry/Extent ../../../../geometry/Point ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/WebStyleSymbol".split(" "),
function(f,h,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,O,Ya,u,Za,aa,P,$a,C,ba,ca,p,da,Q,x,v,ea,k,fa,K,D,F,ha,R,S,T,E,ia,ja,ka,G,L,U,V,la,ma,na,W,X,oa,pa,w,H,qa,ra,sa,ta,ua,va,wa,xa,Y,ya,za,Aa,Ba,Ca,Da,Ea,t,Fa,Ga,Ha,Ia,I,Ja,Ka,La,Z,Ma,Na){var M;const N=F.create(),n=E.create();f.Graphics3DCore=M=class extends aa{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){this._spatialIndex||(this._spatialIndex=new za.SpatialIndex2D({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,
hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values())));this._spatialIndex.update();return this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?t.UpdatePolicy.ASYNC:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||
this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this.running)}get dataUpdating(){return!!(0<this._graphicsWaitingForSymbol.size||0<this._pendingUpdates.size||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.running||0<this._loadingSymbols)}get running(){return 0<this._pendingUpdates.size||
!!this._spatialIndex?.updating||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){var a=this.owner&&this.owner.view&&this.owner.view.qualitySettings,b=a?.graphics3D.maxTotalNumberOfFeatures??0;const c=
a?.graphics3D.maxNumberOfDrawCalls??0,d=a?.graphics3D.maxTotalNumberOfVertices??0,e=this.averageSymbolComplexity;a=Math.max(a?.graphics3D.minTotalNumberOfFeatures??0,Math.min(b,Math.ceil(d/Math.max(1,e?.verticesPerFeature??1)),e&&0<e.drawCallsPerFeature&&0<c?c/e.drawCallsPerFeature:b));return(b=this._get("displayFeatureLimit"))&&b.maximumTotalNumberOfVertices===d&&b.averageSymbolComplexity===e&&b.maximumNumberOfFeatures===a?b:new oa.DisplayFeatureLimit(d,a,e)}get averageSymbolComplexity(){const a=
X.averageSymbolComplexities(this._symbolComplexities),b=this._get("averageSymbolComplexity");return 0===a.numComplexities||null!=b&&(a.estimated&&(b.verticesPerFeature>=a.verticesPerFeature||b.verticesPerCoordinate>=a.verticesPerCoordinate||b.drawCallsPerFeature>=a.drawCallsPerFeature)||b.verticesPerFeature===a.verticesPerFeature&&b.verticesPerCoordinate===a.verticesPerCoordinate&&b.drawCallsPerFeature===a.drawCallsPerFeature)?b:a}get usedMemory(){const a=null!=this.averageSymbolComplexity&&this.labelsEnabled?
this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,b=this._getSymbolComplexitiesUsed().reduce((g,m)=>g+m.memory.resourceBytes,0);if(null==this._symbolMaterials){this._symbolMaterials=[];for(var c of this._symbols.values())if(null!=c)for(const g of c.symbolLayers)if(g)for(const m of g.materials)m&&this._symbolMaterials.push(m)}const d=this.owner.view._stage.renderer,e=this.owner.view.basemapTerrain.overlayManager.renderer;c=this._symbolMaterials.reduce((g,m)=>g+((d.getMaterialRenderer(m)||
e.getMaterialRenderer(m))?.usedMemory??0),0);return this._usedMemory+a+b+c}get usedMemoryPerGraphic(){return this._usedMemory&&this._numberOfGraphics?this._usedMemory/this._numberOfGraphics*(this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves))):null!=this.averageSymbolComplexity?this.averageSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}get unprocessedMemoryEstimate(){return(this._pendingAdds-
this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(a){if("web-style"===a.type)return a.clone();var b=this._symbolConversionCache.get(a.id);if(null!=b)return b;b=W.to3D(a,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(a),cimFallbackEnabled:!0});
const c=b.symbol||null;null==c&&b.error&&u.getLogger(this).error(b.error.message);this._symbolConversionCache.set(a.id,c);return c}_getSymbolComplexitiesUsedOrRenderer(a){if(null==a)return[];var b=a.getSymbols(),c="backgroundFillSymbol"in a?a.backgroundFillSymbol:null;if(!c&&!b?.length)return[];a=[];c=this._getSymbolComplexityUsedOrRenderer(c);null!=c&&a.push(c);for(const d of b)b=this._getSymbolComplexityUsedOrRenderer(d),null!=b&&a.push(b);return a}_getSymbolComplexityUsedOrRenderer(a){if(null==
a)return null;const b=this._symbols.get(a.id);if(null!=b)return b.complexity;a=this._getConvertedSymbol(a);return null!=a?X.defaultSymbolComplexity(a):null}_getSymbolComplexitiesUsed(){const a=[];this._symbols.forEach(b=>{null!=b&&a.push(b.complexity)});return a}get _objectIdField(){return this.layer.objectIdField}constructor(a){super(a);this._propertiesPool=new Ia.PropertiesPool({computedExtent:Ka},this);this.currentRenderer=this.computedExtent=null;this.rendererHasGeometryOperations=!1;this._graphicStateTracking=
null;this.graphics3DGraphics=new Map;this.stage=this.stageLayer=null;this._graphicsDrapedUids=new Set;this._graphicsBySymbol=new Map;this._symbolConversionCache=new Map;this._symbols=new Map;this._graphicsWithoutSymbol=new Map;this._graphicsWaitingForSymbol=new Map;this._graphicsUpdateId=0;this._frameTaskHandle=I.ImmediateTask;this._dataUpdateQueue=new U.PromiseQueue;this._updateQueue=new U.PromiseQueue;this._suspendSymbolCleanup=!1;this._spatialIndex=this._filterVisibility=this._scaleVisibility=
this._elevationAlignment=this._initializeAbortController=this._elevationInfoChangeAbortController=this._rendererChangeAbortController=this._arcadeOnDemand=null;this.extentPadding=0;this._sharedSymbolResourcesOwnerHandle=this._stageLayerElevationProvider=this._viewElevationProvider=this._objectStates=this._labeler=this._deconflictor=this._featureStore=this._updatingPendingLoadedGraphicsChange=null;this._whenGraphics3DGraphicRequests={};this._pendingUpdates=new Map;this._pendingRemoves=this._pendingAdds=
this._numberOfGraphicsProvidingElevation=this._numberOfGraphics=0;this._applyPendingRemovesFirst=!1;this._loadingSymbols=0;this._pendingUpdatesPool=new Q({allocator:b=>b||new Oa,deallocator:b=>{b.clear();return b}});this._geometryWarningLogged=this._symbolWarningLogged=!1;this._objectIdInvisibleSet=new Set;this._whenSymbolRemoved=new Q;this.preferredUpdatePolicy=t.UpdatePolicy.SYNC;this._forcedUpdatePolicy=null;this.elevationFeatureExpressionEnabled=!0;this.layer=this.owner=null;this.graphicSymbolSupported=
!0;this.getRenderingInfoWithoutRenderer=!1;this.setUidToIdOnAdd=!0;this.hasM=this.hasZ=null;this._usedMemory=0;this._startCreateGraphics=this._visible=!1;this._unusedSymbolsCache=a.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",b=>b.destroy());this.symbolCreationContext=new sa.Graphics3DSymbolCreationContext(a.owner.view.resourceController.scheduler,(b,c)=>this._updateQueue.push(b,c))}initialize(){this._featureStore=new qa.Graphics3DFeatureStore({objectIdField:this.owner.layer?.objectIdField,
hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:c=>this.graphics3DGraphics.forEach(c)});const a=(c,d,e)=>this.spatialIndex.queryGraphicUIDsInExtent(c,d,e),{componentFactories:b}=this;this._elevationAlignment=b.elevationAlignment?.(this,a);this._scaleVisibility=b.scaleVisibility?.(this,a);this._filterVisibility=b.filterVisibility?.({featureStore:this._featureStore,
getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:c=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(w.VisibilityGroup.GRAPHIC,w.VisibilityFlag.FILTER,c(G.getObjectId(d.graphic,this._objectIdField)))),setAllFeaturesVisibility:c=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(w.VisibilityGroup.GRAPHIC,w.VisibilityFlag.FILTER,c)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(c=>c.setVisibilityFlag(w.VisibilityGroup.GRAPHIC,
w.VisibilityFlag.FILTER,!0))});this._deconflictor=b.deconflictor?.(this);this._labeler=b.labeler?.(this,this._scaleVisibility);this._objectStates=b.objectStates?.(this);this._initializeAbortController=new AbortController;this._initializePromise=this._initializeAsync()}async _initializeAsync(){const a=this._initializeAbortController?.signal,b=this.owner.view;this._viewElevationProvider=new pa.ViewElevationProvider(this._viewSpatialReference,b);this._initializeStage(b,this.layer.uid);var c=b.sharedSymbolResources;
this.symbolCreationContext.sharedResources=c;this._sharedSymbolResourcesOwnerHandle=c.addGraphicsOwner(this.owner);null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer);this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataRequester=c.streamDataRequester;this.symbolCreationContext.renderCoordsHelper=b.renderCoordsHelper;this.symbolCreationContext.layer=this.layer;this.symbolCreationContext.graphicsCoreOwner=this.owner;this.symbolCreationContext.localOriginFactory=
new Ea.GridLocalOriginFactory(b.renderSpatialReference);this.symbolCreationContext.elevationProvider=b.elevationProvider;this.symbolCreationContext.notifyGraphicGeometryChanged=d=>this.notifyGraphicGeometryChanged(d);this.symbolCreationContext.notifyGraphicVisibilityChanged=d=>this.notifyGraphicVisibilityChanged(d);c=H.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await H.createContext(c,this._viewSpatialReference,
a,u.getLogger(this));x.throwIfAborted(a);this.symbolCreationContext.screenSizePerspectiveEnabled=b.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled;this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods;if("drapeSourceType"in
this.owner){const {owner:d}=this;this.symbolCreationContext.drapeSourceRenderer=b.basemapTerrain.overlayManager.registerGeometryDrapeSource(d);this.addHandles(ba.makeHandle(()=>b.basemapTerrain.overlayManager.unregisterDrapeSource(d)))}this.addHandles([v.watch(()=>this.suspendedOrOutsideOfView,()=>this._updateQueue.unshift(()=>this._updateLayerVisibility(),null).catch(x.ignoreAbortErrors)),v.watch(()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view?.screenSizePerspectiveEnabled],()=>{const d=
b.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;d!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=d,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())}),v.watch(()=>this.owner.slicePlaneEnabled,d=>this._slicePlaneEnabledChange(!!d)),v.watch(()=>this.owner.view.state?.rasterPixelRatio,()=>this._pixelRatioChange()),v.watch(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,d=>
this._physicalBasedRenderingChange(d)),v.watch(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,d=>this._skipHighSymbolLoDsChange(d)),v.when(()=>b.basemapTerrain?.tilingScheme,d=>{d.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==b.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=b.basemapTerrain.spatialReference);this.hasHandles("loaded-graphics")?this.recreateAllGraphics():this.addHandles([v.on(()=>this.owner?.loadedGraphics,"change",
e=>{this._graphicsCollectionChanged(e);this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics();this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")},{initial:!0}),v.watch(()=>this.effectiveUpdatePolicy,d=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=d);this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===t.UpdatePolicy.ASYNC;d===t.UpdatePolicy.SYNC&&this.runTask(I.noBudget)},v.syncAndInitial)]);this._frameTaskHandle=
b.resourceController.scheduler.registerTask(I.TaskPriority.GRAPHICS_CORE,this);this.layer&&"featureReduction"in this.layer&&this.addHandles(v.watch(()=>this.layer.featureReduction,()=>this._deconflictor?.featureReductionChange()));this.notifyChange("averageSymbolComplexity");this.rendererChange(this.owner.renderer).catch(()=>{});this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}destroy(){this._unusedSymbolsCache.destroy();
this._abortInitialize();this._abortRendererChange();this._abortElevationInfoChange();this._frameTaskHandle.remove();this._frameTaskHandle=I.ImmediateTask;this._dataUpdateQueue.cancelAll();this._updateQueue.cancelAll();this._deconflictor=p.removeMaybe(this._deconflictor);this._labeler=p.removeMaybe(this._labeler);this._elevationAlignment=p.destroyMaybe(this._elevationAlignment);this._scaleVisibility=p.destroyMaybe(this._scaleVisibility);this._filterVisibility=p.destroyMaybe(this._filterVisibility);
this._objectStates=p.destroyMaybe(this._objectStates);this.clear();this._featureStore=p.destroyMaybe(this._featureStore);this._updatingPendingLoadedGraphicsChange=p.removeMaybe(this._updatingPendingLoadedGraphicsChange);this._graphicStateTracking=p.destroyMaybe(this._graphicStateTracking);this.stage&&(this.stageLayer=p.destroyMaybe(this.stageLayer),this.stage=null);this._set("owner",null);for(const a in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[a].reject(new C("graphic:layer-destroyed",
"Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null;this._sharedSymbolResourcesOwnerHandle=p.removeMaybe(this._sharedSymbolResourcesOwnerHandle);this._propertiesPool=p.destroyMaybe(this._propertiesPool);this._pendingUpdatesPool=null;this._symbolConversionCache.clear();this._objectIdInvisibleSet.clear();this._spatialIndex=p.destroyMaybe(this._spatialIndex)}clear(){this._objectStates?.allGraphicsDeleted();null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted();
this.graphics3DGraphics.forEach(a=>a.destroy());this._spatialIndex?.clear();this.graphics3DGraphics.clear();this._usedMemory=this._numberOfGraphics=0;this._updateLayerVisibility();this._symbols.forEach(p.destroyMaybe);this._symbols.clear();this._symbolMaterials=null;this._graphicsBySymbol.clear();this._graphicsWithoutSymbol.clear();this._graphicsWaitingForSymbol.clear();this._pendingUpdates.clear();this._pendingUpdatesPool.clear();this._pendingRemoves=this._pendingAdds=0;this._applyPendingRemovesFirst=
!1;this.notifyChange("dataUpdating");this.notifyChange("running");this.notifyChange("updatingRemaining");this._featureStore.events.emit("changed")}_initializeStage(a,b){this.stage=a._stage;this.stageLayer=new Ga.WebGLLayer(this.stage,{visible:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},b);a=this.stageLayer.events;a.on("transformationChanged",c=>this.notifyGraphicGeometryChanged(c.graphicUid));a.on("shaderTransformationChanged",c=>this.notifyGraphicGeometryChanged(c.graphicUid));
a.on("visibilityChanged",c=>this.notifyGraphicVisibilityChanged(c.graphicUid));a.on("geometryAdded",c=>this.notifyGraphicGeometryChanged(c.object.graphicUid));a.on("geometryRemoved",c=>this.notifyGraphicGeometryChanged(c.object.graphicUid));a.on("attributesChanged",c=>Fa.affectsGeometry(c.attribute)&&this.notifyGraphicGeometryChanged(c.object.graphicUid))}notifyGraphicGeometryChanged(a){null!=this._graphicStateTracking&&null!=a&&(a=this.graphics3DGraphics.get(a))&&this._graphicStateTracking.updateGraphicGeometry(a)}notifyGraphicVisibilityChanged(a){null!=
this._graphicStateTracking&&null!=a&&(a=this.graphics3DGraphics.get(a))&&this._graphicStateTracking.updateGraphicVisibility(a)}_updateLayerVisibility(){var a=this._numberOfGraphics>10*this.displayFeatureLimit.maximumNumberOfFeatures;a=!this.suspendedOrOutsideOfView&&!a;a!==this._visible&&(this._visible=a,this._updateStageLayerVisibility())}_updateStageLayerVisibility(){const a=this._visible&&(null==this.layer.opacity||this.layer.opacity>=Da.alphaCutoff);this.stageLayer.visible!==a&&((this.stageLayer.visible=
a)?this.updateGraphicsVisibilities():this._hideAllGraphics())}getGraphics3DGraphicById(a){return null!=a?this.graphics3DGraphics.get(a):void 0}getGraphics3DGraphicByObjectId(a){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(a):null}_getGraphicObjectID(a,b=this.owner.layer?.objectIdField){return G.getObjectId(a,b)}get graphics3DGraphicsByObjectID(){const a=this.owner.layer?.objectIdField;if(a){var b=new Map;this.graphics3DGraphics.forEach(c=>{if(c){var d=this._getGraphicObjectID(c.graphic,
a);null!=d&&b.set(d,c)}});return b}}get labelsEnabled(){return!!this._labeler?.layerLabelsEnabled()}async updateLabelingInfo(a){const b=this._deconflictor?.labelingInfoChange(a);a=this._labeler?.labelingInfoChange(a);await Promise.allSettled([b,a])}updateVisibilityInfo(){this._deconflictor?.labelingInfoChange();this._labeler?.visibilityInfoChange()}get symbolUpdateType(){if(0<this._pendingUpdates.size)return"unknown";let a=0,b=0;for(const [c,d]of this._symbols)if(null!=d){const e=d.getFastUpdateStatus();
if(0<e.loading)return"unknown";this._graphicsBySymbol.has(c)&&(b+=e.fast,a+=e.slow)}return 0<=b&&0===a?"fast":0<=a&&0===b?"slow":"mixed"}runTask(a){this._dataUpdateQueue.runTask(a);this._updateQueue.runTask(a);this._applyPendingUpdates(a);this.notifyChange("running");this.running||this.notifyChange("dataUpdating");this.notifyChange("updatingRemaining");if(!a.hasProgressed)return Ja.Yield}setObjectIdVisibility(a,b){b?this._objectIdInvisibleSet.delete(a):this._objectIdInvisibleSet.add(a);a=this._findGraphics3DGraphicByObjectId(a);
null!=a&&this._updateUserVisibility(a)}_findGraphics3DGraphicByObjectId(a){return ca.findInMap(this.graphics3DGraphics,b=>this._getGraphicObjectID(b.graphic)===a)}_updateUserVisibility(a){if(null==a)return!1;var b=a.graphic;const c=this._getGraphicObjectID(b);b=b.visible&&!this.owner.suspended&&this.stageLayer.visible&&(null==c||!this._objectIdInvisibleSet.has(c));return a.setVisibilityFlag(w.VisibilityGroup.GRAPHIC,w.VisibilityFlag.USER,b)}_whenGraphics3DGraphic(a){var b=this.graphics3DGraphics.get(a.uid);
if(b)return Promise.resolve(b);if(b=this._whenGraphics3DGraphicRequests[a.uid])return b.promise;b=x.createResolver();this._whenGraphics3DGraphicRequests[a.uid]=b;return b.promise}async _boundsForGraphics3DGraphic(a,b){const c=this._viewSpatialReference,d=this.owner.view.renderSpatialReference,e=this.owner.view.basemapTerrain.spatialReference;a=await a.getProjectedBoundingBox((m,l,r)=>R.projectBuffer(m,d,l,m,c,l,r),(m,l,r)=>R.projectBuffer(m,e,l,m,c,l,r),this._viewElevationProvider?{service:this._viewElevationProvider,
useViewElevation:null!=b?!!b.useViewElevation:!1,minDemResolution:null!=b?b.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,b?.signal);if(!a)return null;b=a.boundingBox;if(a.requiresDrapedElevation){var g=this.symbolCreationContext.elevationProvider;g&&(E.center(b,N),g=g.getElevation(N[0],N[1],0,c,"ground")??0,b[2]=Math.min(b[2],g),b[5]=Math.max(b[5],g))}return{boundingBox:b,screenSpaceObjects:a.screenSpaceObjects}}async whenGraphicBounds(a,b){await v.whenOnce(()=>
this.owner?.loadedGraphics);const c=this.owner.layer?.objectIdField;var d=this.owner.loadedGraphics.find(e=>e===a?!0:null!=c&&null!=e.attributes&&a.attributes&&e.attributes[c]===a.attributes[c]);if(!d)throw new C("internal:graphic-not-part-of-view","Graphic is not part of this view");d=await this._whenGraphics3DGraphic(d);return this._boundsForGraphics3DGraphic(d,b)}computeAttachmentOrigin(a,b){a=this.graphics3DGraphics.get(a.uid);if(!a)return null;var c=a.computeAttachmentOrigin();if(0===c.render.num&&
0===c.draped.num)return null;D.set(z,0,0,0);a=0;if(0<c.render.num){if(!S.projectVectorToVector(c.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,A,b))return null;D.add(z,z,A);a++}if(0<c.draped.num){const [d,e]=c.draped.origin;c=this._viewElevationProvider.getElevation(d,e,"ground")??0;D.set(A,d,e,c);if(!S.projectVectorToVector(A,this._viewElevationProvider.spatialReference,A,b))return null;D.add(z,z,A);a++}1<a&&D.scale(z,z,1/a);return new La({x:z[0],y:z[1],z:z[2],spatialReference:b})}getSymbolLayerSize(a,
b){var c=this._symbols.get(a.id);if(null==c)throw new C("internal:symbol-not-part-of-view","Symbol is not part of this view");a=a.symbolLayers.indexOf(b);if(-1===a)throw new C("internal:missing-symbol-layer","Symbol layer is not in symbol");c=c.getSymbolLayerSize(a);if(null==c)throw new C("internal:missing-size","Symbol layer has no valid size");return c}_graphicsCollectionChanged(a){this._startCreateGraphics&&(this.add(a.added),this.remove(a.removed))}graphicUpdateHandler(a){const b=a.graphic.uid,
c=this.graphics3DGraphics.get(b);if(null!=c||null!=this._graphicsWithoutSymbol.get(b))switch(a.property){case "visible":this._graphicUpdateVisibleHandler(c);break;case "geometry":this._graphicUpdateGeometryHandler(c,a);break;case "symbol":this._graphicUpdateSymbolHandler(c,a);break;case "origin-transform":this._graphicUpdateTransformHandler(c,a)}}_graphicUpdateGeometryHandler(a,b){this._graphicUpdateGeometryOrTransformHandler(a,b,()=>null!=b.newValue&&null!=a&&a.graphics3DSymbol.updateGeometry(a,
b.newValue)&&(this._labeler?.updateGraphicGeometry(a)??!0)?(this._labeler?.setDirty(),!0):!1);const c=b.graphic.geometry;null!=c&&this._expandComputedExtent(c)}_graphicUpdateTransformHandler(a,b){const c=b.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(a,b,()=>null!=b.newValue&&null!=a&&null!=c&&a.graphics3DSymbol.updateTransform(a,c.spatialReference,b.newValue,b.action))}_graphicUpdateGeometryOrTransformHandler(a,b,c){if(null==b.graphic.geometry)this._recreateGraphic(b.graphic);else if(null==
a){if(a=b.graphic.symbol?.id)if(a=this._symbols.get(a),null!=a&&a.loadStatus===ya.LoadStatus.LOADING)return;this._recreateGraphic(b.graphic)}else c()||this._recreateGraphic(a.graphic)}_graphicUpdateSymbolHandler(a,b){var c=b.graphic;const d=null!=a?a.graphics3DSymbol:null!=b.oldValue?this._symbols.get(b.oldValue.id):null;if(null==d||null==b.newValue)this._recreateGraphic(c);else{var e=d.symbol;b=this._getConvertedSymbol(b.newValue);if(null!=b&&(b.type!==e.type||"web-style"===b.type)||"web-style"===
e.type)this._recreateGraphic(c);else{var g=this._graphicsBySymbol.get(e.id);if(g&&1!==g.size)this._recreateGraphic(c);else if(g=K.diff(e,b),null==g)this._updateSymbolMapping(e.id,b);else if(g={diff:g,graphics3DGraphicPatches:[],symbolStatePatches:[]},d.prepareSymbolPatch(g),K.isEmpty(g.diff)){var m=this._getRenderingInfo(c);if(null==m)this._recreateGraphic(c);else{c=d.extentPadding;for(const l of g.symbolStatePatches)l();c!==d.extentPadding&&this._recomputeExtentPadding();if(null!=a)for(const l of g.graphics3DGraphicPatches)l(a,
m);this._updateSymbolMapping(e.id,b)}}else this._recreateGraphic(c)}}}_graphicUpdateVisibleHandler(a){this._updateUserVisibility(a)&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}recreateGraphics(a){this._suspendSymbolCleanup=!0;this.remove(a);this.add(a);this._suspendSymbolCleanup=!1;this.effectiveUpdatePolicy===t.UpdatePolicy.SYNC&&this._cleanupSymbols()}_recreateGraphic(a){this.recreateGraphics([a])}_beginGraphicUpdate(a){const b=this._graphicsUpdateId;this._graphicsUpdateId++;this._graphicsWaitingForSymbol.set(a.uid,
b);1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating");return b}_endGraphicUpdate(a,b){a&&(b&&this._graphicStateTracking?.updateGraphicError(a,b),this._graphicsWaitingForSymbol.delete(a.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let a=0;this._symbols.forEach(b=>{null!=b&&(a=Math.max(a,b.extentPadding))});this._set("extentPadding",a)}_expandComputedExtent(a){var b=a.spatialReference;G.computeAABB(a,
n);a=this._viewSpatialReference;var c=M.tmpVec;!ja.equals(b,a)&&T.projectXYZToVector(n[0],n[1],0,b,c,a)&&(n[0]=c[0],n[1]=c[1],T.projectXYZToVector(n[3],n[4],0,b,c,a),n[3]=c[0],n[4]=c[1]);if(isFinite(n[0])&&isFinite(n[3])&&isFinite(n[1])&&isFinite(n[4])){b=this.computedExtent;c=null;var d=isFinite(n[2])&&isFinite(n[5]),e=d&&(null==b?.zmin||n[2]<b.zmin);d=d&&(null==b?.zmax||n[5]>b.zmax);if(b){if(n[0]<b.xmin||n[1]<b.ymin||n[3]>b.xmax||n[4]>b.ymax||e||d)c=this._propertiesPool.get("computedExtent"),c.xmin=
Math.min(n[0],b.xmin),c.ymin=Math.min(n[1],b.ymin),c.xmax=Math.max(n[3],b.xmax),c.ymax=Math.max(n[4],b.ymax),c.spatialReference=a}else c=this._propertiesPool.get("computedExtent"),c.xmin=n[0],c.ymin=n[1],c.xmax=n[3],c.ymax=n[4],c.spatialReference=a;c&&(e&&(c.zmin=n[2]),d&&(c.zmax=n[5]),this._set("computedExtent",c))}}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}async elevationInfoChange(){this._abortElevationInfoChange();
const a=new AbortController;this._elevationInfoChangeAbortController=a;const b=H.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await H.createContext(b,this._viewSpatialReference,a.signal,u.getLogger(this));x.throwIfAborted(a.signal);this._elevationInfoChangeAbortController=null;this._labeler?.elevationInfoChange();this.forEachGraphics3DSymbol((c,d,e)=>{c.globalPropertyChanged("elevationInfo",d)?d.forEach(g=>
{const m=g.graphic;g=g.labelLayers;for(const l of g)l.graphics3DSymbolLayer.updateGraphicElevationContext(m,l)}):this._recreateSymbol(e)});this.updateStageLayerElevationProvider();this._elevationAlignment?.elevationInfoChange()}updateStageLayerElevationProvider(){if(this._stageLayerElevationProvider){if(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),
this._stageLayerElevationProvider=p.disposeMaybe(this._stageLayerElevationProvider)}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&0<this._numberOfGraphicsProvidingElevation&&(this._stageLayerElevationProvider=new Ba.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear();
null!=this._filterVisibility&&this._filterVisibility.clear();this._labeler?.reset();this._deconflictor?.clear();this._elevationAlignment?.clear();this.stageLayer?.invalidateSpatialQueryAccelerator();this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=p.disposeMaybe(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0;this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(a=
!1){if(this._startCreateGraphics){var {loadedGraphics:b,view:c}=this.owner,d=c.basemapTerrain.tilingScheme&&b?.length?b.toArray():null;!a&&d||this._clearSymbolsAndGraphics();this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this._set("computedExtent",null);d&&(a?this.add(d):this.recreateGraphics(d))}}_recreateSymbol(a){var b=this._graphicsBySymbol.get(a);
const c=[];b&&(b.forEach((d,e)=>{const g=d.usedMemory;this._conditionalRemove(d,e);this._spatialIndex?.remove(d);c.push(d.graphic);d.destroy();this._removeGraphics3DGraphic(e,g);this._updateLayerVisibility();this._featureStore.events.emit("changed")}),this._graphicsBySymbol.set(a,new Map));b=this._symbols.get(a);p.destroyMaybe(b);this._symbols.delete(a);this._symbolMaterials=null;this.add(c)}_recreateGraphicsForSymbol(a){if(a=this._graphicsBySymbol.get(a)){const b=[];a.forEach(c=>b.push(c.graphic));
this.recreateGraphics(b)}}_conditionalRemove(a,b){this._graphicsDrapedUids.delete(b);this._objectStates?.removeGraphic(a);this._labeler?.removeGraphic(a);this._deconflictor?.removeGraphic(a);null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(a)}add(a){a&&0!==a.length&&(this.owner.view.basemapTerrain?.tilingScheme?(this._updatePolicyForGraphics(a)===t.UpdatePolicy.ASYNC?this._addDelayed(a):this._addImmediate(a),this.notifyChange("dataUpdating")):u.getLogger(this).error("#add()",
"Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(a){if(this.effectiveUpdatePolicy===t.UpdatePolicy.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const b of a)if(null!=b.geometry&&"mesh"===b.geometry.type&&!b.geometry.loaded)return t.UpdatePolicy.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(a){this._symbolWarningLogged=this._geometryWarningLogged=!1;for(const b of a)this._addGraphic(b,this._getRenderingInfo(b,u.getLogger(this)),
t.UpdatePolicy.SYNC);this._cleanupSymbols();this._labeler?.setDirty();this._deconflictor?.setDirty()}_addDelayed(a){for(const b of a){a=b.uid;let c=this._pendingUpdates.get(a);c?c.add?c.state!==q.NEW&&c.abortController?.abort():this._pendingAdds++:(c=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(a,c));c.add=b}this.notifyChange("running");this.notifyChange("updatingRemaining");this.notifyChange("dataUpdating")}remove(a){this.effectiveUpdatePolicy===t.UpdatePolicy.ASYNC?
this._removeDelayed(a):this._removeImmediate(a);this.notifyChange("dataUpdating")}_removeImmediate(a){for(const b of a)this._removeGraphic(b);this._cleanupSymbols();this._labeler?.setDirty();this._deconflictor?.setDirty()}_removeDelayed(a){for(const c of a){a=c.uid;var b=this._pendingUpdates.get(a);b?b.add&&(b.remove?b.add=null:this._pendingUpdates.delete(a),b.state===q.LOADING&&b.abortController?.abort(),this._pendingAdds--):(b=this._pendingUpdatesPool.pushNew(),b.remove=c,this._pendingUpdates.set(a,
b),this._pendingRemoves++,this._applyPendingRemovesFirst=!0)}0===this._pendingUpdates.size&&this._finishPendingUpdates();this.notifyChange("running");this.notifyChange("updatingRemaining");this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear();this._cleanupSymbols();(this._pendingAdds||this._pendingRemoves)&&u.getLogger(this).warn("pendingAdds/Removes in inconsistent state!");this._pendingRemoves=this._pendingAdds=0;this._applyPendingRemovesFirst=!1}_applyPendingUpdates(a){this._symbolWarningLogged=
this._geometryWarningLogged=!1;if(0===this._pendingUpdates.size&&this._spatialIndex?.updating)this._spatialIndex.update(),a.madeProgress();else{if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const [b,c]of this._pendingUpdates){if(a.done){this._applyPendingRemovesFirst=!0;break}if(c.remove&&!c.add&&(this._pendingRemoves--,a.madeProgress(),this._removeGraphic(c.remove),c.remove=null,this._pendingUpdates.delete(b),0===this._pendingRemoves))break}}for(const [b,c]of this._pendingUpdates){if(a.done)break;
c.add&&c.state===q.NEW&&this._processPendingUpdateNew(c);let d=this.effectiveUpdatePolicy;!c.remove||c.add&&c.state!==q.READY||(this._pendingRemoves--,a.madeProgress(),this._removeGraphic(c.remove),c.remove=null,d=t.UpdatePolicy.SYNC);if(c.add)switch(c.state){case q.READY:this._addGraphic(c.add,c.renderingInfo,d);c.add=null;this._pendingAdds--;a.madeProgress();break;case q.REJECTED:c.add=null,this._pendingAdds--}null==c.remove&&null==c.add&&this._pendingUpdates.delete(b)}0===this._pendingUpdates.size&&
(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}}_processPendingUpdateNew(a){if(a.add){var b=a.add.geometry;null==b||"mesh"!==b.type||b.loaded?this._processPendingUpdateNewRenderingInfo(a):this._processPendingUpdateNewMesh(a,b)}else a.state=q.READY}async _processPendingUpdateNewMesh(a,b){a.state=q.LOADING;a.abortController=new AbortController;const c=a.abortController.signal;try{await b.load({signal:c})}catch(d){return this._processPendingUpdateNewError(a,
d)}a.abortController=null;this._processPendingUpdateNewRenderingInfo(a)}_processPendingUpdateNewError(a,b){a.abortController=null;x.isAbortError(b)?a.state=q.NEW:a.state=q.REJECTED}async _processPendingUpdateNewRenderingInfo(a){if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)a.renderingInfo=this._getRenderingInfo(a.add,u.getLogger(this));else{a.state=q.LOADING;a.abortController=new AbortController;var b=null;try{b=await this._getRenderingInfoAsync(a.add,{signal:a.abortController.signal})}catch(c){a.abortController=
null;x.isAbortError(c)?a.state=q.NEW:a.state=q.REJECTED;return}null==b?.symbol?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),a.renderingInfo=null):a.renderingInfo=b}a.state=q.READY}_addGraphic(a,b,c){this._graphicsWithoutSymbol.set(a.uid,a);if(null!=b?.symbol&&G.hasGeometry(a)){var d=this.stage.renderView.olidRenderHelper;if(d&&this.setUidToIdOnAdd){const y=ma.isBasemapLayer(this.owner.view.map,
this.layer.uid);d.setUidToObjectAndLayerId(a.objectId,a.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled&&!y&&Ha.hasPopupTemplate(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}var e=this.getOrCreateGraphics3DSymbol(b.symbol,b.renderer);if(null!=e){this._expandComputedExtent(a.geometry);var g=this._beginGraphicUpdate(a),m=new ra.Graphics3DGraphicCreationContext(a,b,this.layer),l=!1,r=y=>{y===e.symbol.id&&(l=!0)};this._whenSymbolRemoved.push(r);var B=()=>{--this._loadingSymbols;
if(!this.destroyed){this._whenSymbolRemoved.removeUnordered(r);if(this._graphicsWaitingForSymbol.get(a.uid)!==g||l||e.destroyed||this.graphicSymbolSupported&&a.symbol&&a.symbol.id!==e.symbol.id)--e.referenced,this._cleanupSymbols();else{const y=this._createGraphics3DGraphic(e,m);this._spatialIndex&&null!=y&&this._spatialIndex.add(y);--e.referenced;this._endGraphicUpdate(a)}this._featureStore.events.emit("changed");this._labeler?.setDirty()}},J=y=>{--this._loadingSymbols;this.destroyed||(this._whenSymbolRemoved.removeUnordered(r),
l||(x.isAbortError(y)?this.add([a]):e.destroyed||this._endGraphicUpdate(a,y)))};++this._loadingSymbols;c===t.UpdatePolicy.ASYNC?e.load(()=>this._dataUpdateQueue.push(B,null).catch(x.ignoreAbortErrors),y=>this._dataUpdateQueue.push(()=>J(y),null).catch(x.ignoreAbortErrors)):e.load(B,J)}}}_removeGraphic(a){a=a.uid;const b=this.graphics3DGraphics.get(a);if(b){b.graphics3DSymbol.onRemoveGraphic(b);const c=b.usedMemory,d=b.isElevationSource;this._conditionalRemove(b,a);this._spatialIndex?.remove(b);this._graphicsBySymbol.get(b.graphics3DSymbol.symbol.id)?.delete(a);
this._graphicsWithoutSymbol.delete(a);this._removeGraphics3DGraphic(a,c,d);b.destroy();this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(a),this._graphicsWaitingForSymbol.delete(a),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(a){if(a instanceof Z||a instanceof Ma){const b=this.symbolCreationContext.layer;return b.labelingInfo?b.labelingInfo.some(c=>c.symbol===a):!1}return!1}_hasValidSymbolCreationContext(a){return a instanceof
Z&&!this._hasLabelingContext(a)?(u.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0}_getRenderingInfo(a,b){const c=a.geometry;if(null==c)return b&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!ha.canProjectWithoutEngine(c.spatialReference,this._viewSpatialReference))return b&&!this._geometryWarningLogged&&
(this._geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&null!=a.symbol)return b&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?L.hydrateGraphic(a,this.layer):a;a=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=
this.currentRenderer)?this.owner.getRenderingInfo(a,this.currentRenderer,this._arcadeOnDemand):{symbol:a.symbol||na.getDefaultSymbol3D(a.geometry)};return null==a?.symbol?(b&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):a}_getRenderingInfoAsync(a,b){if(null==a.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),
null;if(!this.graphicSymbolSupported&&null!=a.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?L.hydrateGraphic(a,this.layer):a;return this.owner.getRenderingInfoAsync(a,this.currentRenderer,this._arcadeOnDemand,b)}_createGraphics3DSymbol(a,b){if(!this._hasValidSymbolCreationContext(a))return null;a=this._getConvertedSymbol(a);
if(!a)return null;let c;null!=b&&"backgroundFillSymbol"in b&&b.backgroundFillSymbol&&(b=W.to3D(b.backgroundFillSymbol,{ignoreDrivers:!0}),null!=b.symbol&&(c=b.symbol.symbolLayers));const d=ta.make(a,this.symbolCreationContext,c);d.load(()=>{const e=d.extentPadding;e>this.extentPadding&&this._set("extentPadding",e);this.notifyChange("averageSymbolComplexity")},()=>{});return d}getOrCreateGraphics3DSymbol(a,b){var c=this._symbols.get(a.id);void 0===c&&(c=this._unusedSymbolsCache.pop(a.id),c=null!=c?
c:a instanceof Na?new ua.Graphics3DWebStyleSymbol(a,d=>this._dataUpdateQueue.push(d,null),d=>this._createGraphics3DSymbol(d,b)):this._createGraphics3DSymbol(a,b),this._symbols.set(a.id,c),this._symbolMaterials=null);null!=c&&++c.referenced;return c}trackGraphicState(a){null==this._graphicStateTracking&&(this._graphicStateTracking=new wa.GraphicStateTracking(this));return this._graphicStateTracking.add(a)}_addGraphics3DGraphic(a){this._usedMemory+=a.usedMemory;this.graphics3DGraphics.set(a.graphic.uid,
a);this._numberOfGraphics++;a.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider());this._updateLayerVisibility()}_removeGraphics3DGraphic(a,b,c=!1){this._usedMemory-=b;this.graphics3DGraphics.delete(a);this._numberOfGraphics--;c&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider());this._updateLayerVisibility()}_createGraphics3DGraphic(a,b){const c=b.graphic;this._graphicsWithoutSymbol.delete(c.uid);if(!this._symbols.has(a.symbol.id))return this.add([c]),
null;if(this.graphics3DGraphics.has(c.uid))return null;b=a.createGraphics3DGraphic(b);if(null==b)return null;this._addGraphics3DGraphic(b);a=a.symbol.id;this._graphicsBySymbol.has(a)||this._graphicsBySymbol.set(a,new Map);this._graphicsBySymbol.get(a).set(c.uid,b);b.isDraped&&this._graphicsDrapedUids.add(c.uid);b.centroid=null;null!=c.geometry&&"point"!==c.geometry.type&&(b.centroid=xa.computeCentroid(c.geometry,this._viewSpatialReference));this._updateUserVisibility(b);null!=this._scaleVisibility&&
this._scaleVisibility.updateVisibility(b);null!=this._filterVisibility&&({defaultVisibility:a}=this._filterVisibility,b.setVisibilityFlag(w.VisibilityGroup.GRAPHIC,w.VisibilityFlag.FILTER,a),a||this._filterVisibility.reapply());this._deconflictor?.addGraphic(b);this._labeler?.addGraphic(b);this._objectStates?.addGraphic(b);b.initialize(this.stageLayer,this.owner);null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(b);if(a=this._whenGraphics3DGraphicRequests[c.uid])delete this._whenGraphics3DGraphicRequests[c.uid],
a.resolve(b);this._symbolMaterials=null;return b}_abortRendererChange(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}async rendererChange(a){this._abortRendererChange();if(a!==this.currentRenderer)if(this._validateRenderer(a),null==a&&this._currentRendererChange(null,!1),V.isSupportedRenderer3D(a))if(a?.arcadeRequired){var b=new AbortController;this._rendererChangeAbortController=b;const {arcadeUtils:c}=await this._ensureArcade();
x.throwIfAborted(b);const d=c.hasGeometryOperations(a);d&&(await c.enableGeometryOperations(),x.throwIfAborted(b));this.effectiveUpdatePolicy===t.UpdatePolicy.ASYNC?await this._updateQueue.push(()=>this._currentRendererChange(a,d),b.signal):this._currentRendererChange(a,d);this._rendererChangeAbortController=null}else this.effectiveUpdatePolicy===t.UpdatePolicy.ASYNC?(this._rendererChangeAbortController=b=new AbortController,await this._updateQueue.push(()=>this._currentRendererChange(a,!1),b.signal),
this._rendererChangeAbortController=null):this._currentRendererChange(a,!1);else this._currentRendererChange(a,!1)}async _ensureArcade(){null==this._arcadeOnDemand&&(this._arcadeOnDemand=await la.loadArcade());return this._arcadeOnDemand}_currentRendererChange(a,b){this.currentRenderer=a;this.rendererHasGeometryOperations=b;this.symbolCreationContext.arcade=this._arcadeOnDemand;b=this.symbolCreationContext.renderer;if(a!==b)if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==
a)this.symbolCreationContext.renderer=null,this.recreateAllGraphicsAndSymbols();else{var c=K.diff(b,a);this._updateUnchangedSymbolMappings(c,a,b);this.symbolCreationContext.renderer=a;null!=c&&("complete"===c.type?this.recreateAllGraphicsAndSymbols():"partial"===c.type&&(this._applyRendererDiff(c,a,b)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}}_diffHasSymbolChange(a){for(const b in a.diff)switch(b){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;
case "uniqueValueGroups":case "authoringInfo":case "fieldDelimiter":delete a.diff[b];break;default:return!0}return!1}_applySymbolSetDiff(a,b,c){a=a||[];b=b||[];const d=[];for(const e of b){const g=this._graphicsBySymbol.get(e.id);g&&g.forEach((m,l)=>{var r=m.graphic,B=this.layer instanceof ka?this.layer:null;const J=this._arcadeOnDemand;if(e!==c.defaultSymbol||c.getSymbol(L.hydrateGraphic(r,B),{arcade:J})!==c.defaultSymbol)B=m.usedMemory,a.length||c.defaultSymbol?d.push(r):this._graphicsWithoutSymbol.set(l,
r),r=this.graphics3DGraphics.get(l),this._conditionalRemove(r,l),m.destroy(),g.delete(l),this._removeGraphics3DGraphic(l,B),this._updateLayerVisibility()});this._whenSymbolRemoved.forAll(m=>m(e.id))}if(a.length||d.length)this._graphicsWithoutSymbol.forEach(e=>d.push(e)),this._graphicsWithoutSymbol.clear(),this.add(d);this._cleanupSymbols();this._labeler?.setDirty();this._deconflictor?.setDirty()}_applyUniqueValueRendererDiff(a,b,c){const d=a.diff.defaultSymbol,e=a.diff.uniqueValueInfos;if(d||e){const g=
e?e.added.map(l=>l.symbol).filter(P.isSome):[],m=e?e.removed.map(l=>l.symbol).filter(P.isSome):[];if(e)for(let l=0;l<e.changed.length;l++)g.push(e.changed[l].newValue.symbol),m.push(e.changed[l].oldValue.symbol);d?(c.defaultSymbol&&m.push(c.defaultSymbol),b.defaultSymbol&&g.push(b.defaultSymbol)):c.defaultSymbol&&g.length&&m.push(b.defaultSymbol);this._applySymbolSetDiff(g,m,b);delete a.diff.defaultSymbol;delete a.diff.uniqueValueInfos;return!0}return!1}_calculateUnchangedSymbolMapping(a,b,c){if("unique-value"!==
b?.type||"unique-value"!==c?.type||null!=a&&"partial"!==a.type)return[];const d=g=>null!=g?g.id:null;var e=a&&a.diff;a=e?.defaultSymbol;if(e=e&&e.uniqueValueInfos)e=e.unchanged.map(g=>({oldId:d(g.oldValue.symbol),newId:d(g.newValue.symbol)}));else{e=[];for(const g of c.uniqueValueInfos??[]){const m=d(g.symbol),l=b.uniqueValueInfos?.find(r=>r.value===g.value);l&&m!==d(l.symbol)&&e.push({oldId:m,newId:d(l.symbol)})}}!a&&c.defaultSymbol&&e.push({oldId:d(c.defaultSymbol),newId:d(b.defaultSymbol)});return e}_updateSymbolMapping(a,
b){const c=null!=b&&b?"string"===typeof b?b:b.id:null;if(null!=a&&a!==c){var d=this._graphicsBySymbol.get(a);this._graphicsBySymbol.delete(a);void 0!==d&&this._graphicsBySymbol.set(c,d);d=this._symbols.get(a);void 0!==d&&(this._symbols.delete(a),this._symbols.set(c,d),this._symbolMaterials=null,null!=d&&(a="string"===typeof b?null:b,null!=a?d.symbol=a:d.symbol.id=c))}}_updateUnchangedSymbolMappings(a,b,c){a=this._calculateUnchangedSymbolMapping(a,b,c);for(const {oldId:d,newId:e}of a)this._updateSymbolMapping(d,
e)}_applyRendererDiff(a,b,c){if(this._diffHasSymbolChange(a))return!1;if(b instanceof O&&c instanceof O&&this._applyUniqueValueRendererDiff(a,b,c)&&0===Object.keys(a.diff).length)return!0;for(const d of this._graphicsBySymbol.keys())if(c=this._symbols.get(d),null!=c)switch(c.applyRendererDiff(a,b)){case Y.ApplyRendererDiffResult.RecreateSymbol:this._recreateSymbol(d);break;case Y.ApplyRendererDiffResult.RecreateGraphics:this._recreateGraphicsForSymbol(d)}return!0}opacityChange(){this._updateStageLayerVisibility();
this.forEachGraphics3DSymbol((a,b)=>a.globalPropertyChanged("opacity",b))}_slicePlaneEnabledChange(a){a!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=a,this.stageLayer.sliceable=a,this.forEachGraphics3DSymbol((b,c)=>b.globalPropertyChanged("slicePlaneEnabled",c)),this._deconflictor?.slicePlaneEnabledChange(),this._labeler?.slicePlaneEnabledChange())}_physicalBasedRenderingChange(a){this.symbolCreationContext.physicalBasedRenderingEnabled=a;this.forEachGraphics3DSymbol((b,
c,d)=>{b.globalPropertyChanged("physicalBasedRenderingEnabled",c)||this._recreateSymbol(d)})}_skipHighSymbolLoDsChange(a){this.symbolCreationContext.skipHighSymbolLods=a;this.forEachGraphics3DSymbol((b,c,d)=>{b.globalPropertyChanged("skipHighSymbolLods",c)||this._recreateSymbol(d)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((a,b,c)=>{a.globalPropertyChanged("pixelRatio",b)||this._recreateSymbol(c)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&
this._updatingPendingLoadedGraphicsChange.remove();this._updatingPendingLoadedGraphicsChange=ea.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(a,b){const c=this.symbolCreationContext.clippingExtent,d=ia.create();Ca.toBoundingRect(a,d,b)?this.symbolCreationContext.clippingExtent=E.fromRect(E.create(),d):this.symbolCreationContext.clippingExtent=null;return!E.equals(this.symbolCreationContext.clippingExtent,c)}modifyGraphics3DGraphicVisibilities(a){if(!this.destroyed){var b=
!1;this.graphics3DGraphics.forEach(c=>{a(c)&&(b=!0)});b&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}}forEachGraphics3DSymbol(a){for(const [b,c]of this._symbols){if(null==c)break;const d=this._graphicsBySymbol.get(b);a(c,d||Pa,b)}}updateGraphicsVisibilities(){null!=this._filterVisibility&&this._filterVisibility.reapply();this.modifyGraphics3DGraphicVisibilities(a=>{const b=this._updateUserVisibility(a);a=null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(a);return b||
a})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(a=>a.setVisibilityFlag(w.VisibilityGroup.GRAPHIC,w.VisibilityFlag.USER,!1))}_validateRenderer(a){const b=()=>`'${this.layer.title?`${this.layer.title}, `:""}id:${this.layer.id}'`;if(a=V.validateTo3D(a,{geometryType:this.layer?.geometryType,logWarning:(c,d)=>u.getLogger(this).warn(c,`Symbology conversion for layer ${b()}: ${d}`)})){const c=`Renderer for layer ${b} is not supported in a SceneView`;u.getLogger(this).warn(c,a.message)}}_cleanupSymbols(){if(!(0<
this._graphicsWaitingForSymbol.size||this._suspendSymbolCleanup)){var a=!1;this._symbols.forEach((b,c)=>{if(!(null==b||0<b.referenced)){var d=this._graphicsBySymbol.get(c);d&&0!==d.size||(this._graphicsBySymbol.delete(c),this._symbols.delete(c),this._symbolMaterials=null,this._unusedSymbolsCache.put(c,b,Aa.getSymbolMemorySize(b),da.MinPriority),a=!0)}});a&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}}get test(){}get performanceInfo(){return new va.GraphicsCorePerformanceInfo(this.graphics3DGraphics.size,
this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};f.Graphics3DCore.tmpVec=F.create();h.__decorate([k.property({readOnly:!0})],f.Graphics3DCore.prototype,"computedExtent",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"currentRenderer",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_frameTaskHandle",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,
"_dataUpdateQueue",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_updateQueue",void 0);h.__decorate([k.property({readOnly:!0})],f.Graphics3DCore.prototype,"_viewSpatialReference",null);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_rendererChangeAbortController",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_elevationInfoChangeAbortController",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_initializeAbortController",void 0);h.__decorate([k.property()],
f.Graphics3DCore.prototype,"_elevationAlignment",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_scaleVisibility",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_filterVisibility",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_initializePromise",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_spatialIndex",void 0);h.__decorate([k.property({readOnly:!0})],f.Graphics3DCore.prototype,"extentPadding",void 0);h.__decorate([k.property()],
f.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_featureStore",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_objectStates",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_loadingSymbols",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_forcedUpdatePolicy",void 0);h.__decorate([k.property({readOnly:!0})],
f.Graphics3DCore.prototype,"effectiveUpdatePolicy",null);h.__decorate([k.property({constructOnly:!0})],f.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0);h.__decorate([k.property({constructOnly:!0})],f.Graphics3DCore.prototype,"owner",void 0);h.__decorate([k.property({constructOnly:!0})],f.Graphics3DCore.prototype,"layer",void 0);h.__decorate([k.property({constructOnly:!0})],f.Graphics3DCore.prototype,"graphicSymbolSupported",void 0);h.__decorate([k.property({constructOnly:!0})],
f.Graphics3DCore.prototype,"getRenderingInfoWithoutRenderer",void 0);h.__decorate([k.property({constructOnly:!0})],f.Graphics3DCore.prototype,"componentFactories",void 0);h.__decorate([k.property({constructOnly:!0})],f.Graphics3DCore.prototype,"setUidToIdOnAdd",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"featureStore",null);h.__decorate([k.property()],f.Graphics3DCore.prototype,"initializePromise",null);h.__decorate([k.property()],f.Graphics3DCore.prototype,"scaleVisibility",null);
h.__decorate([k.property()],f.Graphics3DCore.prototype,"elevationAlignment",null);h.__decorate([k.property()],f.Graphics3DCore.prototype,"objectStates",null);h.__decorate([k.property()],f.Graphics3DCore.prototype,"filterVisibility",null);h.__decorate([k.property({readOnly:!0})],f.Graphics3DCore.prototype,"updating",null);h.__decorate([k.property({readOnly:!0})],f.Graphics3DCore.prototype,"dataUpdating",null);h.__decorate([k.property({readOnly:!0})],f.Graphics3DCore.prototype,"running",null);h.__decorate([k.property({readOnly:!0})],
f.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null);h.__decorate([k.property({readOnly:!0,dependsOn:[]})],f.Graphics3DCore.prototype,"updatingRemaining",null);h.__decorate([k.property({readOnly:!0})],f.Graphics3DCore.prototype,"displayFeatureLimit",null);h.__decorate([k.property({readOnly:!0,dependsOn:[]})],f.Graphics3DCore.prototype,"averageSymbolComplexity",null);h.__decorate([k.property({constructOnly:!0})],f.Graphics3DCore.prototype,"hasZ",void 0);h.__decorate([k.property({constructOnly:!0})],
f.Graphics3DCore.prototype,"hasM",void 0);h.__decorate([k.property()],f.Graphics3DCore.prototype,"_objectIdField",null);f.Graphics3DCore=M=h.__decorate([fa.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],f.Graphics3DCore);var q;(function(a){a[a.NEW=0]="NEW";a[a.LOADING=1]="LOADING";a[a.READY=2]="READY";a[a.REJECTED=3]="REJECTED"})(q||={});class Oa{constructor(){this.renderingInfo=this.add=null;this.state=q.NEW;this.remove=this.abortController=null}clear(){this.renderingInfo=this.add=null;
this.state=q.NEW;this.remove=this.abortController=null}}const z=F.create(),A=F.create(),Pa=new Map;Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});