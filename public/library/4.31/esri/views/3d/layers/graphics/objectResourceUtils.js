// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/devEnvironmentUtils ../../../../core/mathUtils ../../../../core/libs/gl-matrix-2/math/mat3 ../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/FloatArray ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec3 ../../../../chunks/vec4 ../../../../chunks/vec2 ../../../../chunks/vec33 ../../../../chunks/vec43 ../../glTF/DefaultLoadingContext ../../glTF/internal/indexUtils ../../glTF/internal/resourceUtils ../../glTF/internal/TextureTransformUtils ./ProcessedObjectResource ./wosrLoader ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Texture ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../webgl-engine/materials/pbrUtils".split(" "),
function(ca,R,da,X,Y,ea,fa,ha,ia,y,S,T,O,C,E,U,ja,ka,la,ma,na,V,K,oa,Z,aa,L,D,pa,qa,M,W,F,P){function ba(f){const b=f.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return b?{fileType:"gltf",url:b[1],specifiedLodIndex:null!=b[4]?Number(b[4]):null}:f.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:f,specifiedLodIndex:null}:{fileType:"unknown",url:f,specifiedLodIndex:null}}function ra(f,b,g,h,r){const l=f.model,m=[],u=new Map,t=new Map,a=l.lods.length,c=T.empty();l.lods.forEach((v,k)=>{const p=!0===
h.skipHighLods&&(1<a&&0===k||3<a&&1===k)||!1===h.skipHighLods&&null!=r&&k!==r;if(!p||0===k){var n=new oa.ProcessedObjectResource(v.name,v.lodThreshold,[0,0,0]);v.parts.forEach(d=>{const z=p?new W.DefaultMaterial({},h):sa(l,d,n,b,g,u,t,h);var G=z??new W.DefaultMaterial({},h);const A=d.attributes.position.count,x=na.convertPrimitiveToTriangles(d.indices||A,d.primitiveType);var w=O.newFloatArray(3*A);const {typedBuffer:Q,typedBufferStride:H}=d.attributes.position;E.transformMat4(w,Q,d.transform,3,H);
w=[[M.VertexAttribute.POSITION,new L.Attribute(w,x,3,!0)]];if(null!=d.attributes.normal){var e=O.newFloatArray(3*A);const {typedBuffer:q,typedBufferStride:N}=d.attributes.normal;Y.normalFromMat4(I,d.transform);E.transformMat3(e,q,I,3,N);X.hasScaling(I)&&E.normalize(e,e);w.push([M.VertexAttribute.NORMAL,new L.Attribute(e,x,3,!0)])}if(null!=d.attributes.tangent){e=O.newFloatArray(4*A);const {typedBuffer:q,typedBufferStride:N}=d.attributes.tangent;Y.fromMat4(I,d.transform);U.transformMat3(e,q,I,4,N);
X.hasScaling(I)&&E.normalize(e,e,4);w.push([M.VertexAttribute.TANGENT,new L.Attribute(e,x,4,!0)])}if(null!=d.attributes.texCoord0){e=O.newFloatArray(2*A);const {typedBuffer:q,typedBufferStride:N}=d.attributes.texCoord0;ja.normalizeIntegerBuffer(e,q,2,N);w.push([M.VertexAttribute.UV0,new L.Attribute(e,x,2,!0)])}e=d.attributes.color;if(null!=e){const q=new Uint8Array(4*A);4===e.elementCount?e instanceof C.BufferViewVec4f?U.scale(q,e,255):e instanceof C.BufferViewVec4u8?la.copy(q,e):e instanceof C.BufferViewVec4u16&&
U.scale(q,e,1/256):(q.fill(255),e instanceof C.BufferViewVec3f?E.scale(q,e.typedBuffer,255,4,e.typedBufferStride):d.attributes.color instanceof C.BufferViewVec3u8?ka.copy(q,e.typedBuffer,4,d.attributes.color.typedBufferStride):d.attributes.color instanceof C.BufferViewVec3u16&&E.scale(q,e.typedBuffer,1/256,4,e.typedBufferStride));w.push([M.VertexAttribute.COLOR,new L.Attribute(q,x,4,!0)])}d={geometry:new pa.Geometry(G,w),vertexCount:A};const {geometry:J,vertexCount:B}=d;d=J.boundingInfo;null!=d&&
0===k&&(T.expandWithVec3(c,d.bbMin),T.expandWithVec3(c,d.bbMax));null!=z&&(n.stageResources.geometries.push(J),n.numberOfVertices+=B)});p||m.push(n)}});return{engineResources:m,referenceBoundingBox:c}}function sa(f,b,g,h,r,l,m,u){const t=b.material+(b.attributes.normal?"_normal":"")+(b.attributes.color?"_color":"")+(b.attributes.texCoord0?"_texCoord0":"")+(b.attributes.tangent?"_tangent":""),a=f.materials.get(b.material);var c=null!=b.attributes.texCoord0;const v=null!=b.attributes.normal;if(null==
a)return null;a:{switch(a.alphaMode){case "BLEND":var k=D.AlphaDiscardMode.Blend;break a;case "MASK":k=D.AlphaDiscardMode.Mask;break a;case "OPAQUE":case null:case void 0:k=D.AlphaDiscardMode.Opaque;break a}k=void 0}if(!l.has(t)){if(c){var p=(H,e=!1)=>{if(null!=H&&!m.has(H)){const J=f.textures.get(H);if(null!=J){const B=J.data;m.set(H,new qa.Texture(V.isEncodedMeshTexture(B)?B.data:B,{...J.parameters,preMultiplyAlpha:V.isEncodedMeshTexture(B)?!1:e,encoding:V.isEncodedMeshTexture(B)&&null!=B.encoding?
B.encoding:void 0}))}}};p(a.textureColor,k!==D.AlphaDiscardMode.Opaque);p(a.textureNormal);p(a.textureOcclusion);p(a.textureEmissive);p(a.textureMetallicRoughness)}p=a.color[0]**(1/F.colorGamma);const n=a.color[1]**(1/F.colorGamma),d=a.color[2]**(1/F.colorGamma),z=a.emissiveFactor[0]**(1/F.colorGamma),G=a.emissiveFactor[1]**(1/F.colorGamma),A=a.emissiveFactor[2]**(1/F.colorGamma),x=null!=a.textureColor&&c?m.get(a.textureColor):null,w=P.useSchematicPBR({normalTexture:a.textureNormal,metallicRoughnessTexture:a.textureMetallicRoughness,
metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor,emissiveTexture:a.textureEmissive,emissiveFactor:a.emissiveFactor,occlusionTexture:a.textureOcclusion}),Q=null!=a.normalTextureTransform?.scale?a.normalTextureTransform?.scale:ia.ONES;l.set(t,new W.DefaultMaterial({...h,transparent:k===D.AlphaDiscardMode.Blend,customDepthTest:D.DepthTestFunction.Lequal,textureAlphaMode:k,textureAlphaCutoff:a.alphaCutoff,diffuse:[p,n,d],ambient:[p,n,d],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",
cullFace:a.doubleSided?D.CullFaceOptions.None:D.CullFaceOptions.Back,hasVertexColors:!!b.attributes.color,hasVertexTangents:!!b.attributes.tangent,normalType:v?aa.NormalType.Attribute:aa.NormalType.ScreenDerivative,castShadows:!0,receiveShadows:a.receiveShadows,receiveAmbientOcclusion:a.receiveAmbientOcclustion,textureId:null!=x?x.id:void 0,colorMixMode:a.colorMixMode,normalTextureId:null!=a.textureNormal&&c?m.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:null!=x&&!!x.parameters.preMultiplyAlpha,
occlusionTextureId:null!=a.textureOcclusion&&c?m.get(a.textureOcclusion).id:void 0,emissiveTextureId:null!=a.textureEmissive&&c?m.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=a.textureMetallicRoughness&&c?m.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[z,G,A],mrrFactors:w?P.schematicMRRFactors:[a.metallicFactor,a.roughnessFactor,h.mrrFactors[2]],isSchematic:w,colorTextureTransformMatrix:K.getTransformMatrix(a.colorTextureTransform),normalTextureTransformMatrix:K.getTransformMatrix(a.normalTextureTransform),
scale:[Q[0],Q[1]],occlusionTextureTransformMatrix:K.getTransformMatrix(a.occlusionTextureTransform),emissiveTextureTransformMatrix:K.getTransformMatrix(a.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:K.getTransformMatrix(a.metallicRoughnessTextureTransform),...r},u))}b=l.get(t);g.stageResources.materials.push(b);c&&(c=n=>{null!=n&&g.stageResources.textures.push(m.get(n))},c(a.textureColor),c(a.textureNormal),c(a.textureOcclusion),c(a.textureEmissive),c(a.textureMetallicRoughness));
return b}function ta(f,b){for(let r=0;r<f.model.lods.length;++r){var g=f.model.lods[r];for(const l of g.parts){g=l.attributes.normal;if(null==g)return;const m=l.attributes.position,u=m.count,t=S.create(),a=S.create(),c=S.create(),v=new Uint8Array(4*u),k=new Float64Array(3*u),p=fa.invert(ha.create(),l.transform);let n=0,d=0;for(let z=0;z<u;z++){m.getVec(z,a);g.getVec(z,t);y.transformMat4(a,a,l.transform);y.subtract(c,a,b.center);y.divide(c,c,b.radius);const G=c[2];var h=y.length(c);h=Math.min(.45+
.55*h*h,1);y.divide(c,c,b.radius);null!==p&&y.transformMat4(c,c,p);y.normalize(c,c);r+1!==f.model.lods.length&&1<f.model.lods.length&&(-1<G?y.lerp(c,c,t,.2):y.lerp(c,c,t,Math.min(-4*G-3.8,1)));k[n]=c[0];k[n+1]=c[1];k[n+2]=c[2];n+=3;v[d]=255*h;v[d+1]=255*h;v[d+2]=255*h;v[d+3]=255;d+=4}l.attributes.normal=new C.BufferViewVec3f(k);l.attributes.color=new C.BufferViewVec4u8(v)}}}const I=ea.create();R.fetch=async function(f,b){f=ba(da.adjustStaticAGOUrl(f));if("wosr"===f.fileType){f=await (b.cache?b.cache.loadWOSR(f.url,
b):Z.load(f.url,b));const {engineResources:u,referenceBoundingBox:t}=Z.processLoadResult(f,b);return{lods:u,referenceBoundingBox:t,isEsriSymbolResource:!1,isWosr:!0}}if(b.cache)var g=await b.cache.loadGLTF(f.url,b,!!b.usePBR);else({loadGLTF:g}=await new Promise((u,t)=>ca(["../../glTF/loader"],u,t))),g=await g(new ma.DefaultLoadingContext(b.streamDataRequester),f.url,b,b.usePBR);var h=g.model.meta?.ESRI_proxyEllipsoid;const r=g.meta.isEsriSymbolResource&&null!=h&&"EsriRealisticTreesStyle"===g.meta.ESRI_webstyle;
r&&!g.customMeta.esriTreeRendering&&(g.customMeta.esriTreeRendering=!0,ta(g,h));h=!!b.usePBR;const {engineResources:l,referenceBoundingBox:m}=ra(g,g.meta.isEsriSymbolResource?{usePBR:h,isSchematic:!1,treeRendering:r,mrrFactors:P.esriSymbologyMRRFactors}:{usePBR:h,isSchematic:!1,treeRendering:!1,mrrFactors:P.advancedMRRFactors},{...b.materialParameters,treeRendering:r},b,f.specifiedLodIndex);return{lods:l,referenceBoundingBox:m,isEsriSymbolResource:g.meta.isEsriSymbolResource,isWosr:!1}};R.parseUrl=
ba;Object.defineProperty(R,Symbol.toStringTag,{value:"Module"})});