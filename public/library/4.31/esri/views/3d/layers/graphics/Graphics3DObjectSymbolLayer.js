// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../Color ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/typedArrayUtil ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/projection/computeTranslationToOriginAndRotation ../../../../geometry/projection/projectPointToVector ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ../../../../symbols/support/symbolLayerUtils3D ./defaultSymbolComplexity ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./Loadable ./lodResourceUtils ./objectResourceUtils ./pointUtils ./primitiveObjectSymbolUtils ./SymbolComplexity ./webStyleUtils ../support/FastSymbolUpdates ../../webgl-engine/effects/geometry/olidUtils ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/pbrUtils".split(" "),
function(P,N,Z,Q,aa,E,R,p,l,y,ba,ca,t,da,F,S,ea,G,fa,ha,B,H,ia,ja,ka,I,T,la,ma,x,U,J,z,na,v,oa,pa){function V(b,a,c){const d=l.create();switch(c.anchor){case "center":p.copy(d,t.center(b));p.negate(d,d);break;case "top":a=t.center(b);p.set(d,-a[0],-a[1],-b[5]);break;case "bottom":a=t.center(b);p.set(d,-a[0],-a[1],-b[2]);break;case "relative":a=t.center(b);b=t.size(b);c=(c=c.anchorPosition)?l.fromValues(c.x,c.y,c.z):l.ZEROS;p.multiply(d,b,c);p.add(d,d,a);p.negate(d,d);break;default:null!=a?p.negate(d,
a):p.copy(d,l.ZEROS)}return d}class W{constructor(b,a,c,d,e,f,g,h,k,n,m,u){this.lodResources=b;this.lodRenderer=a;this.stageResources=c;this.originalMaterialParameters=d;this.resourceSize=e;this.isEsriSymbolResource=f;this.isWosr=g;this.resourceBoundingBox=h;this.symbolSize=k;this.extentPadding=n;this.physicalBasedRenderingEnabled=m;this.pivotOffset=u}}class qa extends ha.Graphics3DSymbolLayer{getCachedSize(){const [b,a,c]=null!=this._resources?this._resources.symbolSize:[1,1,1];return{width:b,depth:a,
height:c}}constructor(b,a,c,d){super(b,a,c,d);this._resources=null;this._optionalFields=[];this._instanceIndexToGraphicUid=new Map;this._hasLoadedPBRTextures=!1;this._disposeResourceHandles=[];this.skipHighSymbolLodsChanged=!1;this.ensureDrapedStatus(!1);this._hasLoadedPBRTextures=c.physicalBasedRenderingEnabled}async doLoad(b){if(!this._drivenProperties.size){var a=B.validateSymbolLayerSize(this.symbolLayer);if(a)throw Error(a);}this._isPrimitive?(a=(a=this.symbolLayer.resource)&&T.isValidPrimitive(a?.primitive)?
a.primitive:da.defaultPrimitive,this._resources=await this._createResourcesForPrimitive(a,b)):(a=(await ma.getResourceUrlFromSymbolStyle(this.symbol.styleOrigin))?.href??this.symbolLayer.resource?.href,this._resources=await this._createResourcesForUrl(a,b));this.layerOpacityChanged();this.slicePlaneEnabledChanged();this.physicalBasedRenderingChanged();this.complexity=this.computeComplexity()}get extentPadding(){return null!=this._resources?this._resources.extentPadding:0}get _isPrimitive(){return!this.symbolLayer.resource?.href}get lodRenderer(){return this._resources?.lodRenderer}get materials(){return this._resources?.stageResources.materials??
[]}_setMaterialTransparencyParameters(b,a=this.symbolLayer?.material?.color){a=this._getCombinedOpacity(a);const c=1>a||this.needsDrivenTransparentPass;b.transparent=c;b.opacity=a;b.cullFace=c?J.CullFaceOptions.None:J.CullFaceOptions.Back;return b}async _createResourcesForPrimitive(b,a){var c=this.symbolLayer;const d=t.create(F.objectSymbolLayerPrimitiveBoundingBox(b)),e=l.fromArray(t.size(d)),f=l.fromArray(F.objectSymbolLayerSizeWithResourceSize(e,c)),g=p.length(f);var h=this.symbolLayer?.material?.emissiveFactor;
h=h?p.clamp(l.clone(h)):l.ZEROS;var k={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:pa.schematicMRRFactors,ambient:l.ONES,diffuse:l.ONES,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,emissiveFactor:h,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive};h=!!k.usePBR;this._setMaterialTransparencyParameters(k);const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const {screenLength:m,minWorldLength:u,
maxWorldLength:q}=n.verticalOffset;k.verticalOffset={screenLength:Q.pt2px(m),minWorldLength:u||0,maxWorldLength:null!=q?q:Infinity};k.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(k.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._drivenProperties.color?k.externalColor=y.ONES:(c=null!=c.material?c.material.color:null,c=null!=c?N.toUnitRGBA(c):y.ONES,k.externalColor=c);this._fastUpdates=x.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(d,
f,e,null));k.isInstanced=!0;this._fastUpdates?(Object.assign(k,this._fastUpdates.materialParameters),this._optionalFields.push(z.VertexAttribute.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(k.hasInstancedColor=!0,this._optionalFields.push(z.VertexAttribute.COLOR));U.olidEnabled()&&this._optionalFields.push(z.VertexAttribute.OBJECTANDLAYERIDCOLOR);c=new oa.DefaultMaterial(k,this._context);c=T.primitiveLodResources(b,c);if(!c)throw Error(`Unknown object symbol primitive: ${b}`);b=v.materialsFromLodResources(c).map(m=>
({opacity:1,transparent:m.parameters.transparent}));k=await this._createStageResources(c,h,a);a=await this._createLodRenderer(c,a);return new W(c,a,k,b,e,!1,!1,d,f,g,h,null)}async _createResourcesForUrl(b,a){var c={spherical:this._context.spherical,doublePrecisionRequiresObfuscation:this._context.doublePrecisionRequiresObfuscation,materialParameters:{isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,
cache:this._context.sharedResources.objectResourceCache};(this._fastUpdates=x.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)))?(Object.assign(c.materialParameters,this._fastUpdates.materialParameters),this._optionalFields.push(z.VertexAttribute.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(c.materialParameters.hasInstancedColor=!0,this._optionalFields.push(z.VertexAttribute.COLOR));U.olidEnabled()&&this._optionalFields.push(z.VertexAttribute.OBJECTANDLAYERIDCOLOR);
var d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){const {screenLength:r,minWorldLength:K,maxWorldLength:C}=d.verticalOffset;c.materialParameters.verticalOffset={screenLength:Q.pt2px(r),minWorldLength:K||0,maxWorldLength:null!=C?C:Infinity};c.materialParameters.castShadows=!1}d=this._context.physicalBasedRenderingEnabled;c.signal=a;c.usePBR=d;c.skipHighLods=this._context.skipHighSymbolLods;var e=await ka.fetch(b,c);b=e.isEsriSymbolResource;c=e.isWosr;const f=ja.makeLodResources(e.lods),g=
this._context,h=this._getExternalColorParameters(this.symbolLayer.material),k=this._getCombinedOpacity(this.symbolLayer?.material?.color,{hasIntrinsicColor:!0}),n=this.needsDrivenTransparentPass;var m=v.materialsFromLodResources(f);const u=v.materialsFromLodResources(f).map(r=>({opacity:r.parameters.opacity||1,transparent:r.parameters.transparent}));m.forEach(r=>{const K=r.parameters;r.setParameters(h);const C=K.opacity*k;r.setParameters({opacity:C,transparent:1>C||n||K.transparent});g.screenSizePerspectiveEnabled&&
r.setParameters({screenSizePerspective:g.sharedResources.screenSizePerspectiveSettings})});e=e.referenceBoundingBox;const q=l.fromArray(t.size(e)),w=l.fromArray(f.levels[0].pivotOffset),D=l.fromArray(F.objectSymbolLayerSizeWithResourceSize(q,this.symbolLayer)),ra=p.length(D),X=this._fastUpdates;x.updateFastSymbolUpdatesState(X,this._context.renderer,this._fastVisualVariableConvertOptions(e,D,q,w))&&m.forEach(r=>r.setParameters(X.materialParameters));m=await this._createStageResources(f,d,a);a=await this._createLodRenderer(f,
a);return new W(f,a,m,u,q,b,c,e,D,ra,d,w)}_addDisposeResource(b){this._disposeResourceHandles.push(b)}async _createStageResources(b,a,c){const d=this._context.stage,e=v.materialsFromLodResources(b);a!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();d.addMany(e);this._addDisposeResource(()=>d.removeMany(e));const f=v.texturesFromLodResources(b);d.addMany(f);this._addDisposeResource(()=>{f.forEach(h=>h.unload());d.removeMany(f)});await Promise.all(f.map(h=>this._context.stage.schedule(()=>
h.load(d.renderView.renderingContext),c)));Z.throwIfAborted(c);const g=v.geometriesFromLodResources(b);d.addMany(g);this._addDisposeResource(()=>d.removeMany(g));return{materials:e,textures:f,geometries:g}}async _createLodRenderer(b,a){const c=this._context.stage,d=this._fastUpdates,e=new na.LodRenderer({symbol:b,optionalFields:this._optionalFields,metadata:{layerUid:this._context.layer.uid,graphicUid:f=>this._instanceIndexToGraphicUid.get(f),notifyGraphicGeometryChanged:f=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(f)),
notifyGraphicVisibilityChanged:f=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(f))},shaderTransformation:d?{applyTransform:(f,g,h)=>{f.getFeatureAttribute(g,L);E.copy(h,x.evaluateModelTransform(d.materialParameters,L,h))},scaleFactor:(f,g,h)=>{g.getFeatureAttribute(h,L);x.evaluateModelTransformScale(f,d.materialParameters,L)}}:null},this._context.scheduler);e.slicePlaneEnabled=this._context.slicePlaneEnabled;this._addDisposeResource(()=>{c.removeRenderPlugin(e);
e.destroy()});await c.addRenderPlugin(e,a);return e}_getExternalColorParameters(b){const a={};this._drivenProperties.color?a.externalColor=y.ONES:null!=b?.color?a.externalColor=N.toUnitRGBA(b.color):(a.externalColor=y.ONES,a.colorMixMode="ignore");return a}destroy(){super.destroy();this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(b=>b());this._disposeResourceHandles.length=0;this._resources=null}createGraphics3DGraphic(b){const a=b.graphic;if(!this._validateGeometry(a.geometry))return null;
const c=I.placePointOnGeometry(a.geometry);if(null==c)return this.logger.warn(`unsupported geometry type for object symbol: ${a.geometry.type}`),null;const d=this.setGraphicElevationContext(a);return this._createAs3DShape(a,c,b.renderingInfo,d,a.uid,b.layer.uid)}notifyDestroyGraphicLayer(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(null!=this._resources){var b=this._drivenProperties.opacity,a=!this._isPrimitive,c=this._resources.stageResources.materials,
d=this._resources.originalMaterialParameters;for(let f=0;f<c.length;f++){const g=c[f];var e=d[f];const h=this._getCombinedOpacity(this.symbolLayer?.material?.color,{hasIntrinsicColor:a})*e.opacity;e=1>h||b||e.transparent;g.setParameters({opacity:h,transparent:e});this._isPrimitive&&g.setParameters({cullFace:e?J.CullFaceOptions.None:J.CullFaceOptions.Back})}}}layerElevationInfoChanged(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,G.needsElevationUpdates3D)}slicePlaneEnabledChanged(){if(null==
this._resources)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const b of this._resources.stageResources.materials)b.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(null==this._resources)return!0;const {stageResources:b,isWosr:a}=this._resources;for(const c of b.materials)this._isPrimitive?c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):a||c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!1});return!1===this._hasLoadedPBRTextures&&!0===this._context.physicalBasedRenderingEnabled?(this._hasLoadedPBRTextures=!0,!1):!0}applyRendererDiff(b,a){if(null==this._resources)return H.ApplyRendererDiffResult.RecreateSymbol;const {stageResources:{materials:c},lodRenderer:d,resourceBoundingBox:e,symbolSize:f,resourceSize:g,pivotOffset:h}=this._resources;for(const k in b.diff)switch(k){case "visualVariables":if(x.updateFastSymbolUpdatesState(this._fastUpdates,a,this._fastVisualVariableConvertOptions(e,
f,g,h))){for(const n of c)n.setParameters(this._fastUpdates.materialParameters);d.notifyShaderTransformationChanged()}else return H.ApplyRendererDiffResult.RecreateSymbol;break;default:return H.ApplyRendererDiffResult.RecreateSymbol}return H.ApplyRendererDiffResult.FastUpdate}computeComplexity(){if(null==this._resources)return super.computeComplexity();var b=this._resources.lodResources;const a=S.estimateNumVerticesForLods(b.levels),c=e=>Array.from(e.attributes.values()).reduce((f,g)=>f+aa.estimateSize(g.data,
g.indices),0),d=v.geometriesFromLodResources(b).reduce((e,f)=>e+c(f),0);b=v.texturesFromLodResources(b).reduce((e,f)=>e+f.memoryEstimate,0)+d;b={...S.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer),resourceBytes:b};return new la.SymbolComplexity({verticesPerFeature:a,memory:b})}_hasLodRenderer(){return null!=this._resources}_createAs3DShape(b,a,c,d,e,f){if(!this._hasLodRenderer()||null==this._resources)return null;const g=this.getFastUpdateAttrValues(b);b=this._context.clippingExtent;
ca.projectPointToVector(a,A,this._context.elevationProvider.spatialReference);if(null!=b&&!t.containsPoint(b,A))return null;b="absolute-height"!==d.mode;const h=this._computeGlobalTransform(a,d,O,M),k=this._computeLocalTransform(this._resources,this.symbolLayer,c,Y),n=this._resources.lodRenderer.instanceData,m=n.addInstance();this._instanceIndexToGraphicUid.set(m,e);n.setLocalTransform(m,k,!1);n.setGlobalTransform(m,h);g&&n.setFeatureAttribute(m,g);null==this._fastUpdates&&this._hasPerInstanceColor()&&
n.setColor(m,B.mixinColorAndOpacity(c.color,c.opacity,255));(c=this._context.stage.renderView.olidRenderHelper)&&n.setObjectAndLayerIdColor(m,c.getObjectAndLayerIdColor({graphicUid:e,layerUid:f}));e=new fa.Graphics3DLodInstanceGraphicLayer(this,m,ea.perLodInstanceElevationAligner,d);b&&(e.alignedSampledElevation=M.sampledElevation);e.needsElevationUpdates=G.needsElevationUpdates3D(d.mode);I.extendPointGraphicElevationContext(e,a,this._context.elevationProvider);return e}_computeGlobalTransform(b,
a,c,d){G.evaluateElevationInfoAtPoint(b,this._context.elevationProvider,a,this._context.renderCoordsHelper,d);A[0]=b.x;A[1]=b.y;A[2]=d.z;ba.computeTranslationToOriginAndRotation(b.spatialReference,A,c,this._context.renderCoordsHelper.spatialReference);return c}_computeLocalTransform(b,a,c,d){E.identity(d);this._applyObjectRotation(c,!1,d);this._applyObjectRotation(a,!0,d);this._applyObjectScale(b,c,d);this._applyAnchor(b,a,d);return d}_applyObjectScale(b,a,c){this._fastUpdates?.requiresShaderTransformation||
(b=B.computeObjectScale(this._drivenProperties.size&&a.size?a.size:b.symbolSize,b.symbolSize,b.resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||E.scale(c,c,b))}prepareSymbolLayerPatch(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);this._preparePatchColor(b,a)}}updateGeometry(b,a){if(null==this._resources)return!0;const c=a&&I.placePointOnGeometry(a);if(null==c)return!1;a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==
a)return!1;this._computeGlobalTransform(c,b.elevationContext,O,M);"absolute-height"!==b.elevationContext.mode&&(b.alignedSampledElevation=M.sampledElevation);this._resources.lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,O,!0);I.extendPointGraphicElevationContext(b,c,this._context.elevationProvider);return!0}_preparePatchTransform(b,a){if((a.heading||a.tilt||a.roll||a.width||a.height||a.depth||a.anchor||a.anchorPosition)&&null!=this._resources){var c=(q,w,D)=>(null!=q&&"complete"===q.type?
q.newValue:w)??D,d=c(a.heading,this.symbolLayer.heading,0),e=c(a.tilt,this.symbolLayer.tilt,0),f=c(a.roll,this.symbolLayer.roll,0),g=c(a.width,this.symbolLayer.width,void 0),h=c(a.height,this.symbolLayer.height,void 0),k=c(a.depth,this.symbolLayer.depth,void 0),n=c(a.anchor,this.symbolLayer.anchor,void 0);c=c(a.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;delete a.depth;delete a.anchor;delete a.anchorPosition;var m=
{heading:d,tilt:e,roll:f,anchor:n,anchorPosition:c},u=this._resources;this.loadStatus===ia.LoadStatus.LOADED&&b.symbolLayerStatePatches.push(()=>{u.symbolSize=l.fromArray(F.objectSymbolLayerSizeWithResourceSize(u.resourceSize,{width:g,height:h,depth:k,isPrimitive:this.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push((q,w)=>{w=this._computeLocalTransform(u,m,w,Y);u.lodRenderer.instanceData.setLocalTransform(q.instanceIndex,w,!0)})}}_preparePatchColor(b,a){if(a.material&&"partial"===a.material.type&&
(a=a.material.diff,a.color&&"complete"===a.color.type&&null!=a.color.newValue&&null!=a.color.oldValue)){var c=a.color.newValue,d=null!=c?N.toUnitRGBA(c):y.ONES;delete a.color;var e=this._resources;null!=e&&b.graphics3DGraphicPatches.push(f=>{this._hasPerInstanceColor()?(e.lodRenderer.instanceData.setColor(f.instanceIndex,d),f=this._setMaterialTransparencyParameters({},c)):f=this._setMaterialTransparencyParameters({externalColor:d},c);for(const g of e.stageResources.materials)g.setParameters(f)})}}_applyObjectRotation(b,
a,c){if(!this._fastUpdates?.requiresShaderTransformation||!a)return B.computeObjectRotation(b.heading,b.tilt,b.roll,c)}_applyAnchor(b,a,c){this._fastUpdates?.requiresShaderTransformation||(b=V(b.resourceBoundingBox,b.pivotOffset,a))&&E.translate(c,c,b)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(b,a,c,d){const e=null!=b?l.fromArray(t.size(b)):l.ONES;b=null!=b?V(b,d,this.symbolLayer):l.ZEROS;d=this._context.renderCoordsHelper.unitInMeters;
c=B.computeObjectScale(null!=a?a:void 0,a,c,d);const f=l.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new x.ConvertOptions({size:!0,color:!0,rotation:!0,opacity:!1},e,a??l.ONES,d,b,c,f)}}const A=l.create(),Y=R.create(),O=R.create(),L=y.create(),M=new G.SampleElevationInfo;P.Graphics3DObjectSymbolLayer=qa;Object.defineProperty(P,Symbol.toStringTag,{value:"Module"})});