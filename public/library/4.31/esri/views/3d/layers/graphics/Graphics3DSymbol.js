// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/has ../../../../core/promiseUtils ./defaultSymbolComplexity ./Graphics3DGraphic ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCreationContext ./interfaces ./Loadable".split(" "),function(r,p,t,u,C,m,v,w,x,y,n,k){class z extends k.Loadable{set symbol(a){this._symbol=a;a.symbolLayers.forEach((c,b)=>{b=this.symbolLayers[b];null!=b&&(b.symbol=a,b.symbolLayer=c)})}get symbol(){return this._symbol}constructor(a,
c,b){super(c.schedule);this._symbol=a;this._context=c;this._backgroundLayers=b;this._destroyed=!1;this.symbolLayers=[];this._extentPadding=this.referenced=0}async doLoad(a){let c=this._symbol.symbolLayers;this._extentPadding=0;this._backgroundLayers&&(c=this._backgroundLayers.concat(c));const b=c.length;for(;this.symbolLayers.length<c.length;)this.symbolLayers.push(null);this.symbolLayers.length=c.length;const d=[],{make:f}=await new Promise((e,h)=>r(["./Graphics3DSymbolLayerFactory"],e,h));for(let e=
0;e<b;e++){var g=c.at(e);if(!1===g.enabled)continue;l.renderPriority=1-(1+e)/b;l.renderPriorityStep=1/b;l.ignoreDrivers=g.ignoreDrivers;const h=f(this.symbol,g,this._context,l);(g=m.onAbortOrThrow(a,()=>{this.symbolLayers[e]=null;h.destroy()}))&&d.push(g);this.symbolLayers[e]=h}await u.forEach(this.symbolLayers,async(e,h)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[h]=null}});d.forEach(e=>e.remove());m.throwIfAborted(a);
if(this.symbolLayers.length&&!this.symbolLayers.some(e=>!!e))throw Error();}getSymbolLayerSize(a){a=this.symbolLayers[a];return null!=a?a.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(a=>a?.queryForSnapping)}createGraphics3DGraphic(a,c){const b=a.graphic,d=this.symbolLayers.map(f=>f?.createGraphics3DGraphic(a)??null);return new w.Graphics3DGraphic(b,c||this,d,a.layer,this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||
null)}get complexity(){return v.totalSymbolComplexities(this.symbolLayers.map(a=>null!=a?a.complexity:null))}globalPropertyChanged(a,c){const b=this.symbolLayers.length;for(let d=0;d<b;d++){const f=this.symbolLayers[d],g=e=>{e=e.layers[d];return e instanceof x.Graphics3DObject3DGraphicLayer?e:null};if(null!=f&&!f.globalPropertyChanged(a,c,g))return!1}return!0}applyRendererDiff(a,c){return this.loadStatus!==k.LoadStatus.LOADED?n.ApplyRendererDiffResult.RecreateSymbol:this.symbolLayers.reduce((b,d)=>
b!==n.ApplyRendererDiffResult.RecreateSymbol&&null!=d?Math.min(b,d.applyRendererDiff(a,c)):b,n.ApplyRendererDiffResult.FastUpdate)}prepareSymbolPatch(a){if(this.loadStatus!==k.LoadStatus.FAILED&&"partial"===a.diff.type){var c=a.diff.diff;if(c.symbolLayers&&"partial"===c.symbolLayers.type){var b=c.symbolLayers.diff;this.symbolLayers.forEach((d,f)=>{if(null!=d){var g=b[f];if(g){const e={diff:g,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};d.prepareSymbolLayerPatch(e);a.symbolStatePatches.push(...e.symbolLayerStatePatches);
e.graphics3DGraphicPatches.length&&a.graphics3DGraphicPatches.push((h,A)=>{const q=h.layers[f];null!=q&&e.graphics3DGraphicPatches.forEach(B=>B(q,A))})}}})}}}updateGeometry(a,c){return this._updateGeometryOrTransform(a,(b,d)=>b.updateGeometry(d,c))}updateTransform(a,c,b,d){return this._updateGeometryOrTransform(a,(f,g)=>f.updateTransform(g,c,b,d))}_updateGeometryOrTransform(a,c){for(let b=0;b<this.symbolLayers.length;b++){const d=this.symbolLayers[b];if(null==d)continue;const f=a.layers[b];if(!f||
!c(d,f))return!1}return!0}onRemoveGraphic(a){for(let c=0;c<this.symbolLayers.length;c++){const b=this.symbolLayers[c];if(null==b)continue;const d=a.layers[c];if(null!=d)b.onRemoveGraphic(d)}}getFastUpdateStatus(){let a=0,c=0,b=0;this.symbolLayers.forEach(d=>{null!=d&&(d.loadStatus===k.LoadStatus.LOADING?a++:d.isFastUpdatesEnabled()?b++:c++)});return{loading:a,slow:c,fast:b}}async queryForSnapping(a,c,b,d){var f=this.symbolLayers.filter(t.isSome).filter(g=>null!=g.queryForSnapping).map(g=>g.queryForSnapping(a,
c,b,d));f=await Promise.all(f);m.throwIfAborted(d);return f.flat()}destroy(){if(!this.destroyed){super.destroy();for(const a of this.symbolLayers)null!=a&&a.destroy();this.symbolLayers.length=0;this._destroyed=!0}}get destroyed(){return this._destroyed}}const l=new y.Graphics3DSymbolLayerCreationContext;p.Graphics3DSymbol=z;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});