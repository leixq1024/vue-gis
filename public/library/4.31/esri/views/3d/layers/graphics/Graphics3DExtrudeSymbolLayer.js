// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/Error ../../../../core/lang ../../../../core/unitUtils ../../../../chunks/earcut ../../../../core/libs/gl-matrix-2/math/mat3 ../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/projection/computeTranslationToOriginAndRotation ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/DoubleArray ../../../../geometry/support/Indices ../../../../chunks/vec3 ../../../../layers/graphics/data/SnappingCandidate ../../../../renderers/support/renderingInfoUtils ../../../ViewingMode ./elevationAlignmentUtils ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./polygonUtils ../support/edgeUtils ../../support/debugFlags ../../support/ElevationProvider ../../support/renderInfoUtils/polygon ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/ContentObjectType ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryWithMapPositions ../../webgl-engine/lib/Normals ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(W,ib,Ga,X,Ha,Ia,Ja,Ka,ja,Y,v,A,La,Z,S,aa,Ma,ba,Na,Oa,ca,ka,Pa,la,ma,Qa,Ra,Sa,Ta,Ua,Va,da,ea,Wa,Xa,Ya,na,Za,K,oa){function pa(a,b,c,d,g,e){const f=aa.getZeroIndexArray(b.length);b=[[K.VertexAttribute.POSITION,new da.Attribute(d.positions,b,3,!0)],[K.VertexAttribute.NORMALCOMPRESSED,new da.Attribute(d.normals,b,2,!0)],[K.VertexAttribute.COLOR,new da.Attribute(g,f,4,!0)]];return new Xa.Geometry(a,b,d.elevation,Wa.ContentObjectType.Mesh,e,c)}function qa(a,b,c,d,g,e,f,l,B,p,m,k,w){var x=d.index,
y=d.count,q=c.length/3,t=2*d.count;v.copy(H,k);k=0<m?1:-1;x*=3;let n=0,h=3*n,u=y,z=3*u;for(let C=0;C<y;++C){const r=a[x],D=a[x+1],L=a[x+2];w&&(H[0]=r,H[1]=D,H[2]=L,v.normalize(H,H));g[h+0]=r;g[h+1]=D;g[h+2]=L;const O=b[x+0],M=b[x+1],J=b[x+2];e[h+0]=O;e[h+1]=M;e[h+2]=J;f[h+0]=-k*H[0];f[h+1]=-k*H[1];f[h+2]=-k*H[2];l[n]=0;g[z+0]=r+m*H[0];g[z+1]=D+m*H[1];g[z+2]=L+m*H[2];e[z+0]=O;e[z+1]=M;e[z+2]=J;l[u]=m;h+=3;z+=3;x+=3;n+=1;u+=1}b=a=0;t*=3;w=0>m?ra:sa;k=0>m?sa:ra;for(x=0;x<q;++x)p[b]=c[a+w[0]],p[b+1]=
c[a+w[1]],p[b+2]=c[a+w[2]],B[t]=c[a+k[0]]+y,B[t+1]=c[a+k[1]]+y,B[t+2]=c[a+k[2]]+y,b+=3,t+=3,a+=3;c=0;p=2*d.count;y=0;q=d.pathLengths[0];ta(g,e,l,f,c,q,d.count,p,B,y,m);p+=4*q;y+=2*q;c+=q;for(q=1;q<d.pathLengths.length;++q)t=d.pathLengths[q],ta(g,e,l,f,c,t,d.count,p,B,y,m),p+=4*t,y+=2*t,c+=t}function U(a,b,c,d,g,e,f){d[e]=d[f];f*=3;e*=3;a[e]=a[f];a[e+1]=a[f+1];a[e+2]=a[f+2];b[e]=b[f];b[e+1]=b[f+1];b[e+2]=b[f+2];c[e]=g[0];c[e+1]=g[1];c[e+2]=g[2]}function ta(a,b,c,d,g,e,f,l,B,p,m){let k=g,w=g+1,x=g+
f,y=g+f+1,q=l,t=l+1,n=l+2*e;l=l+2*e+1;0>m&&(k=g+f+1,y=g);p*=3;for(let D=0;D<e;++D){D===e-1&&(w=g,0<m?y=g+f:k=g+f);var h=a,u=k,z=w,C=x,r=T;u*=3;z*=3;C*=3;v.set(fa,h[u++],h[u++],h[u++]);v.set(ua,h[z++],h[z++],h[z++]);v.set(va,h[C++],h[C++],h[C++]);v.subtract(wa,ua,fa);v.subtract(xa,va,fa);v.cross(r,xa,wa);v.normalize(r,r);U(a,b,d,c,T,q,k);U(a,b,d,c,T,t,w);U(a,b,d,c,T,n,x);U(a,b,d,c,T,l,y);B[p]=q;B[p+1]=n;B[p+2]=l;B[p+3]=q;B[p+4]=l;B[p+5]=t;p+=6;k++;w++;x++;y++;q+=2;t+=2;n+=2;l+=2}}function ya(a,b,c){var d=
a.getMutableAttribute(K.VertexAttribute.POSITION);const g=a.getMutableAttribute(K.VertexAttribute.NORMALCOMPRESSED).data,{topVertexStart:e,topVertexCount:f,topFaceStart:l,topFaceCount:B}=b;d=d.data;var p=a.attributes.get(K.VertexAttribute.POSITION).indices,m=l+B;a=e+f;b=S.newDoubleArray(3*f);for(var k=0;k<f;++k){var w=3*k;b[w+0]=0;b[w+1]=0;b[w+2]=0}k=$a;w=ab;const x=bb,y=cb,q=H;for(let u=l;u<m;++u){var t=3*u;for(var n=0;3>n;++n){var h=p[t+n];y[n]=h;h*=3;v.set(G,d[h+0],d[h+1],d[h+2]);v.transformMat4(k[n],
G,c)}v.sub(w,k[1],k[0]);v.sub(x,k[2],k[0]);v.cross(q,w,x);v.normalize(q,q);for(t=0;3>t;++t)n=3*(y[t]-e),b[n+0]+=q[0],b[n+1]+=q[1],b[n+2]+=q[2]}for(c=e;c<a;++c)m=3*(c-e),d=b[m+0],p=b[m+1],m=b[m+2],k=Math.sqrt(d*d+p*p+m*m),na.compressNormal(g,c,d/k,p/k,m/k)}const db=["polygon","extent"];class eb extends Pa.Graphics3DSymbolLayer{constructor(a,b,c,d){super(a,b,c,d);this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){var a=la.validateSymbolLayerSize(this._getSymbolSize());if(a)throw new Ga("graphics3dextrudesymbollayer:invalid-size",
a);}var b=this._getCombinedOpacityAndColor(this.symbolLayer?.material?.color);a=A.fromArray(b);b=b[3];const c=1>b||this.needsDrivenTransparentPass;var d=this.symbolLayer?.material?.emissiveFactor;d=d?v.clamp(A.clone(d)):A.ZEROS;a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:b,transparent:c,cullFace:c?ea.CullFaceOptions.None:ea.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,
emissiveFactor:d,offsetTransparentBackfaces:!0,normalType:Va.NormalType.Compressed};this._materials[I.Main]=new oa.DefaultMaterial(a,this._context);this._materials[I.Bottom]=new oa.DefaultMaterial({...a,cullFace:ea.CullFaceOptions.Back},this._context);this._context.stage.addMany(this._materials)}destroy(){super.destroy();this._context.stage.removeMany(this._materials);this._materials.length=0}createGraphics3DGraphic(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,db,this.symbolLayer.type))return null;
const c=this._getVertexOpacityAndColor(a.renderingInfo,255),d=this.setGraphicElevationContext(b);return this._createAs3DShape(b,a.renderingInfo,c,d,b.uid)}layerOpacityChanged(a,b){const c=this._getCombinedOpacity(this.symbolLayer?.material?.color),d=1>c||this.needsDrivenTransparentPass;this._materials[I.Main]?.setParameters({opacity:c,transparent:d});this._materials[I.Bottom]?.setParameters({opacity:c,transparent:d});const g=this._getLayerOpacity();a.forEach(e=>b(e)?.layerOpacityChanged(g,this._context.isAsync))}layerElevationInfoChanged(a,
b){return this.updateGraphics3DGraphicElevationInfo(a,b,ca.needsElevationUpdates3D)}slicePlaneEnabledChanged(a,b){this._materials[I.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});this._materials[I.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});a.forEach(c=>{c=b(c);null!=c&&c.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0}physicalBasedRenderingChanged(){const a={usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!0};this._materials[I.Main]?.setParameters(a);this._materials[I.Bottom]?.setParameters(a);return!0}_getExtrusionSize(a){a=a.size&&this._drivenProperties.size?Na.getDriverAxisSizeValue(a.size,2)??0:this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters}applyRendererDiff(a,b){return this._drivenPropertiesChanged(b)?ma.ApplyRendererDiffResult.RecreateSymbol:ma.ApplyRendererDiffResult.RecreateGraphics}async queryForSnapping(a,b,c,d){b=this._getExtrusionSize(c)*this._context.renderCoordsHelper.unitInMeters/
Ha.getMetersPerVerticalUnitForSR(b);const {objectId:g,target:e}=a;c=X.clone(e);c.z=(c.z??0)+b;switch(a.type){case "edge":const {start:f,end:l}=a;a=X.clone(f);d=X.clone(l);a.z=(a.z??0)+b;d.z=(d.z??0)+b;return[ba.makeEdgeCandidate(g,c,Infinity,a,d)];case "vertex":return[ba.makeVertexCandidate(g,c,Infinity),ba.makeEdgeCandidate(g,e,Infinity,e,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(a,b,c,d,g){var e=Qa.geometryAsPolygon(a.geometry);if(null==e)return null;
if(0===e.rings.length||!e.rings.some(r=>0<r.length))return this._logGeometryValidationWarnings(e.rings,"rings","ExtrudeSymbol3DLayer"),null;a=Ua.geometryToRenderInfo(e,this._context.elevationProvider,this._context.renderCoordsHelper,d);this._logGeometryCreationWarnings(a,e.rings,"rings","ExtrudeSymbol3DLayer");var f=la.computeCentroid(e);if(null==f)return null;var l=[];const B=[],p=Z.create(),m=Y.create(),k=A.create(),w=this._context.renderCoordsHelper.viewingMode===Oa.ViewingMode.Global;w||this._context.renderCoordsHelper.worldUpAtPosition(null,
k);La.computeTranslationToOriginAndRotation(e.spatialReference,[f.x,f.y,0],m,this._context.renderCoordsHelper.spatialReference);e=Y.create();ja.invert(e,m);f=Ka.create();Ja.normalFromMat4(f,e);const {polygons:x,mapPositions:y,position:q}=a,t=new Map;f=this._materials[I.Main];for(const r of x){var n=r.count;if(this._context.clippingExtent&&(Z.fromBuffer(r.mapPositions,p),!Z.intersectsClippingArea(p,this._context.clippingExtent)))continue;var h=Ia.earcut(r.mapPositions,r.holeIndices,3);if(0===h.length)continue;
const D=h.length;var u=6*n,z=aa.newIndexArray(u+D);const L=aa.newIndexArray(D);var C=S.newDoubleArray(3*u);const O=S.newDoubleArray(3*u),M=S.newDoubleArray(3*u);u=S.newDoubleArray(u);const J=this._getExtrusionSize(b);qa(q,y,h,r,C,M,O,u,z,L,J,k,w);Ma.transformMat4(C,C,e);h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:g,layerUid:this._context.layer.uid});C=new fb(C,M,na.compressNormals(O),u);z=pa(f,z,z.length-L.length,C,c,h);n=new gb(n,n,2*r.count,D/3);ya(z,n,m);t.set(z,n);l.push(z,
pa(this._materials[I.Bottom],L,0,C,c,h));B.push(C.heights)}if(0===l.length)return null;b=new Za.Object3D({geometries:l,layerUid:this._context.layer.uid,graphicUid:g,isElevationSource:!0});b.transformation=m;c=(c=Ra.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()}))?new ka.Object3DEdgeState(this._materials[I.Main],c,this._context.slicePlaneEnabled):null;l=new ka.Graphics3DObject3DGraphicLayer(this,b,l,null,null,(r,D,L,O,M)=>{r=r.stageObject;const J=r.geometries,za=J.length;D="absolute-height"!==
D.mode;let Aa=0;const ha=r.transformation,hb=ja.invertOrIdentity(Y.create(),ha);for(let N=0;N<za;N+=2){const Q=J[N];if(!Ya.isGeometryWithMapPositions(Q))continue;var E=Q.getMutableAttribute(K.VertexAttribute.POSITION).data;const Ba=B[N/2],P=new Ta.SamplePosition(Q.mapPositions),Ca=E.length/3;let Da=!1,Ea=0,F=0;for(let Fa=0;Fa<Ca;Fa++){R[0]=E[F];R[1]=E[F+1];R[2]=E[F+2];O(P,V);D&&(Ea+=V.sampledElevation);Sa.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(v.set(G,P.array[P.offset],P.array[P.offset+1],V.z+Ba[F/
3]),null!=L&&M.toRenderCoords(G,L,G)):(v.set(G,E[F],E[F+1],E[F+2]),v.transformMat4(G,G,ha),M.setAltitude(G,V.z+Ba[F/3]));v.transformMat4(G,G,hb);E[F]=G[0];E[F+1]=G[1];E[F+2]=G[2];const ia=.01/M.unitInMeters;if(Math.abs(R[0]-E[F])>=ia||Math.abs(R[1]-E[F+1])>=ia||Math.abs(R[2]-E[F+2])>=ia)Da=!0;P.offset+=3;F+=3}Da&&((E=t.get(Q))&&ya(Q,E,ha),r.geometryVertexAttributeUpdated(J[N],K.VertexAttribute.NORMALCOMPRESSED),Q.invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(J[N],K.VertexAttribute.POSITION),
J[N+1].invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(J[N+1],K.VertexAttribute.POSITION));Aa+=Ea/Ca}return Aa/za},d,c);l.alignedSampledElevation=a.sampledElevation;l.needsElevationUpdates=ca.needsElevationUpdates3D(d.mode);return l}}const T=A.create(),fa=A.create(),ua=A.create(),va=A.create(),wa=A.create(),xa=A.create(),R=A.create(),G=A.create(),H=A.create(),V=new ca.SampleElevationInfo,sa=[0,2,1],ra=[0,1,2],$a=[A.create(),A.create(),A.create()],ab=A.create(),bb=A.create(),cb=[0,0,0];var I;
(function(a){a[a.Main=0]="Main";a[a.Bottom=1]="Bottom"})(I||={});class fb{constructor(a,b,c,d){this.positions=a;this.elevation=b;this.normals=c;this.heights=d}}class gb{constructor(a,b,c,d){this.topVertexStart=a;this.topVertexCount=b;this.topFaceStart=c;this.topFaceCount=d}}W.Graphics3DExtrudeSymbolLayer=eb;W.extrudePolygon=qa;Object.defineProperty(W,Symbol.toStringTag,{value:"Module"})});