// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../core/Error ../../../core/has ../../../core/Logger ../../../core/maybe ../../../core/reactiveUtils ../../../core/scheduling ../../../core/accessorSupport/decorators/property ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../core/libs/gl-matrix-2/math/mat3 ../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../core/libs/gl-matrix-2/math/mat4 ../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../core/libs/gl-matrix-2/factories/quatf64 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../geometry/ellipsoidUtils ../../../geometry/projection/computeTranslationToOriginAndRotation ../../../geometry/projection/localLinearScaleFactors ../../../geometry/projection/projectVectorToVector ../../../geometry/support/buffer/BufferView ../../../layers/ILyr3DWasmPerSceneView ../../../support/elevationInfoUtils ../../ViewingMode ./IntegratedMesh3DTilesViewPerformanceInfo ./interfaces ./LayerView3D ./Lyr3DWasm ./i3s/LayerElevationProvider ./support/lyr3dTypeConversions ./support/Tiles3DIntersectionHandler ../support/ElevationRange ../support/orientedBoundingBox ../webgl-engine/collections/Component/ObjectParameters ../webgl-engine/collections/Component/SourceGeometry ../webgl-engine/collections/Component/Transform ../webgl-engine/collections/Component/Material/ComponentMaterial ../webgl-engine/core/material/RenderTexture ../webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl ../webgl-engine/core/shaderLibrary/util/AlphaCutoff ../webgl-engine/core/shaderLibrary/util/EllipsoidMode ../webgl-engine/lib/Attribute ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/Normals ../webgl-engine/lib/Texture ../webgl-engine/lib/VertexAttribute ../webgl-engine/materials/internal/bufferWriterUtils ../../layers/LayerView ../../support/layerViewUtils".split(" "),
function(E,Q,V,W,X,R,ha,H,A,ia,Y,I,Z,aa,ja,ba,J,ka,la,ma,na,oa,w,h,ca,pa,qa,ra,sa,K,ta,C,ua,va,da,wa,ea,xa,ya,za,fa,Aa,Ba,L,F,Ca,Da,M,Ea,Fa,Ga){var r;(function(b){b[b.API=1]="API";b[b.VerboseAPI=2]="VerboseAPI";b[b.Error=3]="Error"})(r||={});class Ha{constructor(){this.handle=0;this.isVisible=!1;this.components=[];this.cpuMemoryUsage=this.vboMemoryUsage=this.texMemoryUsage=0;this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}A=class extends sa.LayerView3D(Fa){constructor(){super(...arguments);
this.type="integrated-mesh-3dtiles";this._visibleGeometryChangedSchedulerHandle=null;this._wasmLayerId=-1;this.ignoresMemoryFactor=!1;this.drapeTargetType=ra.DrapeTargetType.WithoutRasterImage;this._applySSAO=!V("disable-feature:im-ssao");this._shadeNormals=!!V("enable-feature:im-shading");this._lyrHandleToObjects=new Map;this._initialCullFace=new Map;this._suspendedHandle=null;this._dbgFlags=new Set}initialize(){this._dbgFlags.add(r.Error);this._dbg(r.VerboseAPI,"Tiles3DLayerView3D initialize() called");
if(!this._canProjectWithoutEngine())throw new Q("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const b=K.addLayerViewToWasm(this).then(a=>{this._intersectionHandler=new ua.Tiles3DIntersectionHandler(this);this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler);this._updatingHandles.add(()=>this.slicePlaneEnabled,g=>this._slicePlaneEnabledChange(g));this._elevationProvider=
new ta.LayerElevationProvider({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler});this.view.elevationProvider.register("im",this._elevationProvider);this.view.basemapTerrain.overlayManager.registerDrapeTarget(this);this._wasmLayerId=a;this._memCache=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,g=>this._onRemoveFromCache(g));this.addHandles([R.watch(()=>this.layer.elevationInfo,g=>this._elevationInfoChanged(g))]);this._suspendedHandle=
R.watch(()=>this.suspended,g=>this._wasm?.setEnabled(this,!g),R.initial)}).catch(a=>{K.removeLayerViewFromWasm(this);this._wasmLayerId=-1;if(a===h.invalidLayerView)throw new Q("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(a===h.wasmFailedToInit)throw new Q("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{});});this.addResolvingPromise(b)}destroy(){this._dbg(r.VerboseAPI,"Tiles3DLayerView3D destroy() called");K.removeLayerViewFromWasm(this);
this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null);this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null);this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this);this._lyrHandleToObjects.forEach(b=>
this.freeObject(b));this._lyrHandleToObjects.clear();this._initialCullFace.clear();this._memCache=X.destroyMaybe(this._memCache);this._updatingHandles=X.destroyMaybe(this._updatingHandles);this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??(this._visibleGeometryChangedSchedulerHandle=ha.schedule(()=>
{this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(b){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=b);this.objects.forEach(a=>{const g=this._collection.getMaterial(a);g.commonMaterialParameters.hasSlicePlane=b;g.commonMaterialParameters.cullFace=b?F.CullFaceOptions.None:this._initialCullFace.get(a)})}_elevationInfoChanged(b){this._wasm?.setLayerOffset(this,ca.getElevationOffsetInMeters(b))}get _obbs(){return this.objects.map(b=>
this._collection.getComponentObb(b))}get _wasm(){return K.getLyr3DWasm(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let b=0;this._lyrHandleToObjects.forEach(a=>{a.isVisible&&(b+=a.totalMemory())});return b}get unloadedMemory(){return 0}get cachedMemory(){let b=0;this._lyrHandleToObjects.forEach(a=>{a.isVisible||(b+=a.totalMemory())});return b}get visibleAtCurrentScale(){return Ga.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let b=
0,a=0,g=0,k=0,l=0,c=0;this._lyrHandleToObjects.forEach(m=>{m.isVisible?(b+=m.texMemoryUsage,a+=m.vboMemoryUsage,l++):(g+=m.texMemoryUsage,k+=m.vboMemoryUsage,c++)});return new qa.IntegratedMesh3DTilesViewPerformanceInfo(this.usedMemory,l,c,Math.round(a/1048.576)/1E3,Math.round(b/1048.576)/1E3,Math.round(k/1048.576)/1E3,Math.round(g/1048.576)/1E3)}_canProjectWithoutEngine(){if(this.view.state.viewingMode===pa.ViewingMode.Local){const b=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??
-1;if(3857!==b&&32662!==b)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return ca.getElevationOffsetInMeters(this.layer.elevationInfo)}get elevationRange(){const b=this.fullExtent;return b?.zmin&&b?.zmax?new va.ElevationRange(b.zmin,b.zmax):null}getElevationRange(b){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((b,
a)=>b.concat(a.components),[])}isUpdating(){const b=this._wasm;return 0>this._wasmLayerId||null==b?!1:b.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(b){const a=b.meshData;if(null==a.data)throw Error("meshData.data undefined");a.desc=JSON.parse(a.desc);if(null==a.desc)throw Error("meshData.desc undefined");const g=J.fromArray(a.desc.origin),k=[],l=new Map,c=new Ha;c.handle=b.handle;this._lyrHandleToObjects.set(b.handle,c);b=this.view.basemapTerrain.spatialReference;
let m;if("global"===this.view.viewingMode){var q=aa.create();ma.computeTranslationToOriginAndRotation(la.SphericalECEFSpatialReferenceLike,g,q,b);q=Y.fromMat4(I.create(),q);m=Y.invert(I.create(),q)}else m=q=I.IDENTITY;var t=aa.create();Z.translate(t,t,g);t=Z.getTranslation(J.create(),t);var f=null;const n=J.create();a.desc.obb&&(f=a.desc.obb.quaternion,f=new da.Obb(a.desc.obb.center,a.desc.obb.halfSize,ja.fromValues(f[0],f[1],f[2],f[3])));for(let u=0;u<a.desc.prims.length;u++){var v=a.desc.prims[u];
this._dbg(r.VerboseAPI,JSON.stringify(v));if(null==C.primTypeConversion[v.ptype]||null==a.data){this._dbg(r.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+v.ptype+"). Skipping primitive.");continue}const p=a.desc?.materials&&null!=v.materialId?a.desc.materials[v.materialId]:null,B=null!=p?p.lightingModel:h.Lyr3DLightingModel.Unlit,{positionView:z,positionAttr:D,normalsView:Ia,normalsAttr:S,colorAttr:N,texCoord0Attr:O,indicesView:G}=this.getBufferViews(v,a.data.buffer,q);if(null==
D||null==z||null==G)continue;v=new ea.GeometryParameters(null!=N,null!=O?fa.TextureCoordinateType.Default:fa.TextureCoordinateType.None,null!=Ia,this._shadeNormals,this._applySSAO);const Ja=D.data.length/D.size;var y=(d,x)=>d&&d.data.length/d.size!==Ja?(this._dbg(r.Error,`${x} !== numPos. Skipping primitive.`),!1):!0;if(!y(O,"numTexcoord")||!y(N,"numColors")||!y(S,"normals"))continue;y=ea.createVertexBufferLayout(v);null!=f?f=f.clone():(f=da.compute(D),ba.add(n,f.center,g),f.center=n);if(q!==I.IDENTITY)for(var e=
0;e<z.count;e++)z.getVec(e,n),ba.transformMat3(n,n,q),z.setVec(e,n);const T=y.createBuffer(D.data.length);e=new Map([[M.VertexAttribute.POSITION,D]]);null!=O&&e.set(M.VertexAttribute.UV0,O);null!=N&&e.set(M.VertexAttribute.COLOR,N);null!=S&&e.set(M.VertexAttribute.NORMALCOMPRESSED,S);e.forEach((d,x)=>{null!=d&&Ea.writeDefaultAttribute(x,d,null,null,T,0)});e=new Uint32Array([0,G.typedBuffer.length]);v={vertices:{data:T.buffer,count:T.byteLength/y.stride,layoutParameters:v},positionData:{positions:z.typedBuffer,
indices:G.typedBuffer},indices:G.typedBuffer,componentOffsets:e};c.cpuMemoryUsage+=z.count;c.cpuMemoryUsage+=G.count;y=this.view.renderSpatialReference;e=J.create();const U=[1,1,1];na.localLinearScaleFactors(t,y,U,b)||this._dbg(r.Error,"Unsupported coordinate system for IM overlay");oa.projectVectorToVector(t,y,e,b);const P=this._collection.createObject(new wa.ObjectParameters(ka.fromValues(e[0],e[1],U[0],U[1]),new xa.Transform(t,m),f,v));p&&this._collection.updateMaterial(P,d=>{d.baseColor=p.baseColorFactor;
d.usePBR=B===h.Lyr3DLightingModel.Pbr;d.hasParametersFromSource=!1;d.baseColorTexture=this._getTexture(p.baseColorTex,a,l);d.usePBR&&(d.mrrFactors=[p.metallicFactor,p.roughnessFactor,0],d.emissiveFactor=p.emissiveFactor??[0,0,0],d.metallicRoughnessTexture=this._getTexture(p.metalTex,a,l),d.emissionTexture=this._getTexture(p.emissiveTex,a,l),d.occlusionTexture=this._getTexture(p.occlusionTex,a,l),d.normalTexture=this._getTexture(p.normalTex,a,l));d.objectOpacity=0;d.alphaDiscardMode=F.AlphaDiscardMode.Mask;
var x=[];d.baseColorTexture&&x.push(d.baseColorTexture.loadPromise);d.usePBR&&d.metallicRoughnessTexture&&x.push(d.metallicRoughnessTexture.loadPromise);d.usePBR&&d.emissionTexture&&x.push(d.emissionTexture.loadPromise);d.usePBR&&d.occlusionTexture&&x.push(d.occlusionTexture.loadPromise);d.usePBR&&d.normalTexture&&x.push(d.normalTexture.loadPromise);x=Promise.all(x);k.push(x);x.then(()=>{d.alphaDiscardMode=C.alphaModeConversion[p.alphaMode];d.objectOpacity=1;c.texMemoryUsage+=d.baseColorTexture?.glTexture?.usedMemory||
0;d.usePBR&&(c.texMemoryUsage+=d.metallicRoughnessTexture?.glTexture?.usedMemory||0,c.texMemoryUsage+=d.emissionTexture?.glTexture?.usedMemory||0,c.texMemoryUsage+=d.occlusionTexture?.glTexture?.usedMemory||0,c.texMemoryUsage+=d.normalTexture?.glTexture?.usedMemory||0)});d.commonMaterialParameters.doubleSided=p.isDoubleSided;d.commonMaterialParameters.cullFace=p.faceCulling?C.faceCullingConversion[p.faceCulling]:F.CullFaceOptions.Back;this._initialCullFace.set(P,d.commonMaterialParameters.cullFace);
d.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled;d.componentParameters.castShadows=ya.ComponentParameterSummary.All;d.textureAlphaCutoff=p.alphaCutoff??Aa.alphaCutoff;d.alphaDiscardMode=C.alphaModeConversion[p.alphaMode];d.isIntegratedMesh=!0;d.polygonOffsetEnabled=!1;d.hasOccludees=!1;d.ellipsoidMode=Ba.getEllipsoidMode(this.view.spatialReference)});c.components.push(P);c.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(P)}await Promise.all(k);l.forEach(u=>{c.textures.push(u)});
if(!this._memCache)throw Error("no memCache");this._memCache.put(`${c.handle}`,c,c.totalMemory());return{memUsageBytes:c.totalMemory()}}freeRenderable(b){const a=this._lyrHandleToObjects.get(b);a&&(this.freeObject(a),this._lyrHandleToObjects.delete(b))}freeObject(b){this._memCache&&this._memCache.pop(`${b.handle}`);b.components.forEach(a=>{b.textures.forEach(g=>{this._stage.remove(g)});this._collection.destroyObject(a);this._initialCullFace.delete(a)})}setRenderableVisibility(b,a,g){if(this._memCache){for(var k=
0;k<g;++k){var l=b[k];const m=a[k];if(m){var c=this._lyrHandleToObjects.get(l);c&&(this._visibleGeometryChanged(),c.isVisible=m,c.components.forEach(q=>{this._collection.setObjectVisibility(q,m);this._elevationProvider.objectChanged(this._collection.getComponentObb(q))}),this._memCache.pop(`${l}`))}}for(k=0;k<g;++k){l=b[k];const m=a[k];!m&&(c=this._lyrHandleToObjects.get(l))&&(this._visibleGeometryChanged(),c.isVisible=m,c.components.forEach(q=>{this._collection.setObjectVisibility(q,m);this._elevationProvider.objectChanged(this._collection.getComponentObb(q))}),
this._memCache.put(`${l}`,c,c.totalMemory()))}}}_getTexture(b,a,g){let k=null;if(b&&a.desc?.images&&a.data?.buffer){const c=a.desc.images[b?.imageId];k=g.get(c);if(!k&&c){const m=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,q=c.mipCount?!0:1<m;b=C.wrapModeConversion[b.wrapMode??h.Lyr3DUvWrapMode.None];let t=c.alpha?4:3;var l=new Uint8Array(a.data.buffer,c.data.byteOffset,c.data.byteCount);let f=null,n=a=null;switch(c.format){case h.Lyr3DImageFormat.Raw:c.pixelFormat===h.Lyr3DPixelFormat.R8?
(f=l,t=1,a=""):c.pixelFormat===h.Lyr3DPixelFormat.Rgb8?(f=l,t=3,a=""):c.pixelFormat===h.Lyr3DPixelFormat.Rgba8&&(f=l,t=4,a="");break;case h.Lyr3DImageFormat.Dxt1:f=l;t=3;a=F.TextureEncodingMimeType.DDS_ENCODING;break;case h.Lyr3DImageFormat.Dxt5:f=l;t=4;a=F.TextureEncodingMimeType.DDS_ENCODING;break;case h.Lyr3DImageFormat.Png:a="image/png";n=document.createElement("img");break;case h.Lyr3DImageFormat.Jpeg:a="image/jpeg";n=document.createElement("img");break;case h.Lyr3DImageFormat.Etc2:a="image/ktx";
n=document.createElement("img");break;case h.Lyr3DImageFormat.Astc:this._dbg(r.Error,"Astc texture not supported");break;case h.Lyr3DImageFormat.Pvrtc:this._dbg(r.Error,"Pvrtc texture not supported")}n&&a&&(l=new Blob([l],{type:a}),n.src=URL.createObjectURL(l),f=n);f&&null!=a&&(k=new Da.Texture(f,{mipmap:q,maxAnisotropy:m,encoding:a,wrap:b,components:t,noUnpackFlip:!0,width:c.mip0Width,height:c.mip0Height}),this._stage.add(k),g.set(c,k))}}return k?new za.RenderTexture(this.view._stage.renderView.textures,
k.id):null}getBufferViews(b,a,g){let k,l,c,m,q,t;var f=null;for(let v=0;v<b.atrbs.length;v++){const y=b.atrbs[v],e=y.view,u=e.byteOffset+e.byteCount,p=[...Array(e.byteCount/C.lyr3DTypeToByteSize[e.type]).keys()].map(B=>B);try{switch(y.sem){case h.Lyr3DVtxAtrbSemantic.Position:3!==e.ncomp||e.type!==h.Lyr3DType.F32?this._dbg(r.Error,"[Unsupported Feature] Unsupported view for Position ("+e+")"):(k=new w.BufferViewVec3f(a,e.byteOffset,void 0,u),l=new L.Attribute(k.typedBuffer,p,3));break;case h.Lyr3DVtxAtrbSemantic.Normal:if(3!==
e.ncomp||e.type!==h.Lyr3DType.F32)this._dbg(r.Error,"[Unsupported Feature] Unsupported view for Normal ("+e+")");else{const B=new w.BufferViewVec3f(a,e.byteOffset,void 0,u),z=Ca.compressAndTransformNormals(B.typedBuffer,g);q=new w.BufferViewInt16(z);t=new L.Attribute(q.typedBuffer,p,2)}break;case h.Lyr3DVtxAtrbSemantic.TexCoord:2!==e.ncomp||e.type!==h.Lyr3DType.F32?this._dbg(r.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+e+")"):void 0===m&&(m=new L.Attribute((new w.BufferViewVec2f(a,
e.byteOffset,void 0,u)).typedBuffer,p,2));break;case h.Lyr3DVtxAtrbSemantic.Color:4===e.ncomp?(e.type===h.Lyr3DType.F32&&(f=new w.BufferViewVec4f(a,e.byteOffset,void 0,u)),e.type===h.Lyr3DType.U8&&(f=new w.BufferViewVec4u8(a,e.byteOffset,void 0,u)),e.type===h.Lyr3DType.U16&&(f=new w.BufferViewVec4u16(a,e.byteOffset,void 0,u))):3===e.ncomp&&(e.type===h.Lyr3DType.F32&&(f=new w.BufferViewVec3f(a,e.byteOffset,void 0,u)),e.type===h.Lyr3DType.U8&&(f=new w.BufferViewVec3u8(a,e.byteOffset,void 0,u)),e.type===
h.Lyr3DType.U16&&(f=new w.BufferViewVec3u16(a,e.byteOffset,void 0,u)));null==f?this._dbg(r.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+e+")"):c=new L.Attribute(f.typedBuffer,p,e.ncomp);break;case h.Lyr3DVtxAtrbSemantic.FeatureIndex:break;default:this._dbg(r.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+y.sem+"). Skipping vertex attribute.")}}catch(B){this._dbg(r.VerboseAPI,"Error Creating buffer ("+B+"). Skipping vertex attribute.")}}if(b.index)switch(g=b.index.view,
f=g.byteOffset+g.byteCount,b.index.view.type){case h.Lyr3DType.U16:var n=new w.BufferViewUint16(a,g.byteOffset,void 0,f);break;case h.Lyr3DType.U32:n=new w.BufferViewUint32(a,g.byteOffset,void 0,f);break;default:this._dbg(r.Error,"[Unsupported Feature] index type not supported ("+g.type+").")}if(null==n&&null!=k)for(b=k.count,65535>b?(n=new Uint16Array(b),n=new w.BufferViewUint16(n)):(n=new Uint32Array(b),n=new w.BufferViewUint32(n)),a=0;a<b;a++)n.set(a,a);return{positionView:k,positionAttr:l,colorAttr:c,
texCoord0Attr:m,indicesView:n,normalsView:q,normalsAttr:t}}_onRemoveFromCache(b){this._wasm?.onRenderableEvicted(this,b.handle,b.totalMemory());this.freeRenderable(b.handle)}_dbg(b,a){this._dbgFlags.has(b)&&(b===r.Error?W.getLogger(this).error(a):W.getLogger(this).warn(a))}};E.__decorate([H.property()],A.prototype,"_visibleGeometryChangedSchedulerHandle",void 0);E.__decorate([H.property()],A.prototype,"layer",void 0);E.__decorate([H.property({readOnly:!0})],A.prototype,"visibleAtCurrentScale",null);
E.__decorate([H.property()],A.prototype,"elevationOffset",null);return A=E.__decorate([ia.subclass("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],A)});