// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/asyncUtils","../../../../core/lang","../../../../core/uuid","../../../../layers/support/featureQueryAll"],function(z,F,G,C,H){function A(a,b,c,f,d=null,g=!0){const h=[];a={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:null==c,fieldsIndex:a.fieldsIndex,objectIdField:a.objectIdField,globalIdField:a.globalIdField,featureOrIdentifierList:c};for(const p of b)if(null==p.error){b=p.objectId??-1;c=p.globalId;if(-1===b||g){var e=b;var n=c,k=a;const {gidToFeatureInfo:q,
oidToFeatureInfo:l,fieldsIndex:w,objectIdField:v,globalIdField:r,featureOrIdentifierList:u}=k;if(!k.featuresResolved&&null!=u){for(const t of u){const m={feature:null,oid:-1,gid:null};if("attributes"in t){m.feature=t;const y=t.attributes;if(null!=y)for(const B in y){if(-1!==m.oid&&null!=m.gid)break;const D=w.normalizeFieldName(B);D===v&&(m.oid=y[B]??-1);D===r&&(m.gid=y[B])}}else m.oid=t.objectId??-1,m.gid=t.globalId;null!=m.gid&&q.set(m.gid,m);-1!==m.oid&&l.set(m.oid,m)}k.featuresResolved=!0}e=(-1!==
e?l.get(e):null)??(null!=n?q.get(n):null)}else e=null;e=e??{feature:null,oid:b,gid:c};b={oid:-1===b?e.oid:b,gid:c??e.gid,feature:e.feature,result:p};h.push(b);c=b.gid?C.normalizeGlobalID(b.gid):null;-1===b.oid&&null!=c&&null!=d&&(b.oid=d.get(c)??-1);-1===b.oid&&null!=c&&(e=f.get(c),null==e&&(e={gid:b.gid,edits:[]},f.set(c,e)),e.edits.push(b))}return h}async function I(a,b){a=a.i3sOverrides.layer.associatedLayer;if(null!=a?.globalIdField){var c=a.createQuery(),{objectIdField:f,globalIdField:d}=a;c.where=
Array.from(b.values()).map(({gid:g})=>`${d}='${g}'`).join(" OR ");c.returnGeometry=!1;c.outFields=[f,d];c.cacheHint=!1;a=await F.resultOrAbort(H.queryAllJSON(a,c));if(a.ok){a=a.value.features;for(const g of a)if(c=g.attributes[d],a=g.attributes[f],null!=c&&null!=a&&-1!==a&&(c=b.get(C.normalizeGlobalID(c)),null!=c))for(const h of c.edits)h.oid=a}}}function J(a,b){const c=new Map;b=b.adds;if(!b||0===b.length||null==a.globalIdField)return c;for(const f of b)a=f.oid,b=f.feature,"mesh"===b?.geometry?.type&&
c.set(a,b);return c}function K(a,b){const c=b.updates;if(!c||0===c.length)return new E;const f=new E;b=new Map;for(let d=0;d<a.attributeStorageInfo.length;d++)b.set(a.attributeStorageInfo[d].name,d);a.forEachNode((d,g)=>{for(const p of c){if(null==p.feature)continue;const q=p.feature,l=p.oid,w=g.indexOf(l);for(const v in q.attributes){var h=a.fieldsIndex.normalizeFieldName(v);var e=f;var n=d.index,k=e.get(n);k?e=k:(k=new L,e.set(n,k),e=k);(n=null!=h&&e.get(h))?h=n:(n=[],e.set(h,n),h=n);h.push({featureIndex:w,
featureId:l,value:q.attributes[v]})}}});return f}const M={setAttribute(){},rollback(){},commit(){}};var x;(function(a){a[a.EDITING=0]="EDITING";a[a.ROLLED_BACK=1]="ROLLED_BACK";a[a.COMMITTED=2]="COMMITTED"})(x||={});const L=Map,E=Map;z.createInteractiveEditSession=function(a,b){const c=b.attributes[a.objectIdField];if(null==c)return M;var f=a.sessions.get(c);if(f)return f;const d=G.clone(b.attributes),g=new Set,h=a.i3sOverrides.createInteractiveEditSession(c),e=new Map;let n=x.EDITING;f={setAttribute(k,
p){if(n===x.EDITING){var q=a.fieldsIndex.get(k);if(q){var l=a.attributeStorageInfo.findIndex(r=>r.name===q.name);if(!(0>l)){if(!(k in d))throw Error(`Attribute "${k}" is not an attribute of the edited feature.`);h.setAttribute(l,p);var w=a.attributeStorageInfo[l],v=!1;g.add(k);a.forEachNode((r,u)=>{var t=e.get(r);null==t?(u=u.indexOf(c),e.set(r,u)):u=t;if(-1!==u&&(t=a.getAttributeData(r.index))){const m=t[w.name];m&&(m[u]=p,a.setAttributeData(r.index,t,b),v=!0)}});v&&a.clearMemCache()}}}},rollback(){if(n===
x.EDITING){for(const k of g)this.setAttribute(k,d[k]);h.remove();n=x.ROLLED_BACK;a.sessions.delete(c)}},commit(){n===x.EDITING&&(h.remove(),n=x.COMMITTED,a.sessions.delete(c))}};a.sessions.set(c,f);return f};z.normalizeEditResultsEvent=async function(a,b){const c=new Map,f=A(a,b.addedFeatures,b.edits?.addFeatures,c),d=A(a,b.updatedFeatures,b.edits?.updateFeatures,c);b=A(a,b.deletedFeatures,b.edits?.deleteFeatures,c,b.globalIdToObjectId,!1);0<c.size&&await I(a,c);return{adds:f.filter(g=>-1!==g.oid),
updates:d.filter(g=>-1!==g.oid),deletes:b.filter(g=>-1!==g.oid)}};z.processAttributeEdits=function(a,b){var c=K(a,b);b=J(a,b);if(0!==c.size||0!==b.size){var f=new Map;for(var d=0;d<a.attributeStorageInfo.length;d++)f.set(a.attributeStorageInfo[d].name,d);var g=!1;c.forEach((p,q)=>{const l=a.getAttributeData(q);let w=!1;p.forEach((v,r)=>{const u=null!=l?l[r]:null;r=f.get(r);for(const {featureIndex:t,value:m,featureId:y}of v)u&&(u[t]=m,g=w=!0),a.i3sOverrides.updateAttributeValue(y,r,m)});w&&a.setAttributeData(q,
l,null)});g&&a.clearMemCache();var {fieldsIndex:h,i3sOverrides:e,objectIdField:n,globalIdField:k}=a;c=e.layer.associatedLayer?.infoFor3D;c=new Set(c?[...Object.values(c.assetMapFieldRoles),...Object.values(c.transformFieldRoles)]:[]);for(const [p,q]of b){e.featureAdded(p);({attributes:b}=q);for(const l in b)l!==n&&l!==k&&c.has(l)||(d=h.normalizeFieldName(l),d=null!=d?f.get(d):null,null!=d&&e.updateAttributeValue(p,d,b[l]))}}};z.processGeometryEdits=function(a,b){const c=new Map,f=d=>{for(const {oid:g,
feature:h}of d)d=h?.geometry,"mesh"===d?.type&&c.set(g,d)};f(b.adds);f(b.updates);for(const d of b.deletes)c.set(d.oid,null);for(const [d,g]of c)a.i3sOverrides.updateGeometry(d,g)};Object.defineProperty(z,Symbol.toStringTag,{value:"Module"})});