// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../geometry/projection/projectBoundingSphere ../../../../chunks/sphere ./I3SNode ./I3SUtil ./ValidatedNode ../../support/ElevationRange ../../support/orientedBoundingBox".split(" "),function(F,O,C,L,G,y,r,w,P,Q,H){function A(a,b){return 0>a?-1:0<b?a/b|0:0}function x(a,b){return 0>a?-a-1:0===b?a:a%b}function E(a,b,c){return-1===b?-(a+1):0===c?a:b*c+a}function M(a){if(a)for(let b=0;b<a.length;b++)for(const c of R)if(c[0]===
a[b].metricType)return{lodMetric:c[1],maxError:a[b].maxError};return{lodMetric:r.LodMetric.None,maxError:0}}function S(a){return Math.sqrt(4/Math.PI*a)}class I{constructor(a,b,c,d,e){this.childOffset=a;this.childCount=b;this.visibilityCache=c;this.ref=d;this.node=e;this.useAsHole=0;this.filterImpact=r.NodeFilterImpact.NotChecked;this.traversalState=null;this.parent=-1}invalidateBounds(){this.node?.invalidateServiceBVsInRenderSR();this.ref?.invalidateServiceBVsInRenderSR()}}class J{constructor(a=[],
b=[]){this.nodes=a;this.children=b;this.numNodesWithLoadedChildren=this.lastTraversed=0}}class T{get _useNodePages(){return 0<this._pageSize}constructor(a,b,c,d,e,f,g,h,p,k,q,t,n,l,m,u){this.viewingMode=a;this._layer=b;this._streamDataController=d;this._clientNodeLoader=e;this._viewportQueries=f;this._logger=g;this.holeFilling=h;this._isLoaded=p;this._isReloading=k;this._isSelected=q;this._enable=t;this._needsUpdate=n;this._canRequest=l;this._computeVisibilityObb=m;this._computeNodeFiltering=u;this._dirty=
!0;this._nodePages=new Map;this._clientNodePage=null;this._rootIndex=this._pageSize=0;this._lodMetric=r.LodMetric.None;this._lodConversion=B=>B;this._isEditable=!1;this._urlPrefix="";this._loadingNodes=new Set;this._loadingPages=new Set;this._failedNodes=new Set;this._failedPages=new Set;this._indexMissing=1;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._version=w.addWraparound(0,2);this._visibilityCacheVersion=w.addWraparound(0,2);this._maxLevel=
1;this._featureEstimate={estimate:0,leavesReached:!1};this._unloadedMemoryEstimate=0;this._missingPagesAndNodes=new C({deallocator:null});this._prefetchNodes=new C({deallocator:null});this._updates=new U(this._missingPagesAndNodes);this._imModificationUncategorized=new C({deallocator:null});this.ignoreServiceObb=!1;this.progressiveLoadPenalty=0;this._pageQueue=[];this._newPages=[];this._layerHasFilter=this.layerHasModifications=this.needNodeElevationRange=!1;this._frameNumber=0;this._traverseDescendantsQueue=
[0];this._traverseDescendantsNestingLevel=0;this._isEditable=null!=b.associatedLayer?.infoFor3D;b.serviceUpdateTimeStamp?.lastUpdate&&(this._lastUpdate=`${b.serviceUpdateTimeStamp.lastUpdate}`);this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1;this._init(c)}_init(a){if("page"===a.type){var b=a.rootPage;this._urlPrefix=a.urlPrefix;this._pageSize=a.pageSize;switch(a.lodMetric){case "maxScreenThreshold":this._lodMetric=r.LodMetric.MaxScreenThreshold;break;case "maxScreenThresholdSQ":this._lodMetric=
r.LodMetric.MaxScreenThreshold,this._lodConversion=S}if(this._isEditable){this._rootIndex=-1;var c=x(a.rootIndex,a.pageSize);c=b.nodes[c];c={nodes:[{index:this._rootIndex,children:[a.rootIndex],mesh:void 0,obb:c.obb,lodThreshold:c.lodThreshold}]};this._addPage(A(this._rootIndex,this._pageSize),c);this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=a.rootIndex;this._addPage(A(a.rootIndex,this._pageSize),b);this._updateParentsAndLevel()}else"node"===a.type&&(this._urlPrefix=a.urlPrefix,
b=new J,this._nodePages.set(0,b),this._isEditable?(this._clientNodePage=new J,b={id:"-1",version:null,mbs:a.rootNode.mbs,obb:a.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:a.rootNode.mbs,obb:a.rootNode.obb}]},this._rootIndex=this._makeClientRefNode(new r.NodeBase(b.id,null),-1),(b=this._validateNode(b.id,b))&&this._addNode(b,this._rootIndex)):this._rootIndex=this._makeRefNode(new r.NodeBase(a.rootNode.id,null),-1),(a=
this._validateNode(a.rootNode.id,a.rootNode))&&this._addNode(a,0))}addClientNodeToIndex(a,b){a=new r.NodeBase(a,b);a=this._makeClientRefNode(a,-1);this._linkChildToParentNode(-1,a);this.requestUpdate();return a}removeClientNodeFromIndex(a,b,c){this._destroyClientRefNode(a,b,c);this.requestUpdate()}_loadPage(a){this._loadingPages.add(a);this._streamDataController.request(this._urlPrefix+a,"json").then(b=>{this._pageQueue.push({pageIndex:a,page:b})}).catch(b=>{this._loadingPages.delete(a);L.isAbortError(b)||
(this._failedPages.add(a),this._logger.error("#loadPage()",this._layer,`Error when loading page ${a}`,b))})}_addQueuedPages(a){for(;0<this._pageQueue.length&&!a.done;){const {pageIndex:b,page:c}=this._pageQueue.shift();this._addPage(b,c);this._loadingPages.delete(b);a.madeProgress();this.needNodeElevationRange&&this._newPages.push(b)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(a){if(this.needNodeElevationRange)for(;0<this._newPages.length&&!a.done;)this._nodePages.get(this._newPages.shift())?.nodes.forEach(b=>
{for(b=b.parent;null!=b&&b!==this._rootIndex;){const c=this.getNode(b);c&&!Number.isNaN(c?.elevationRangeMin)&&(c.invalidateElevationRange(),this.invalidateBoundingVolumeCache(b));b=this.getParentIndex(b)}})}_addPage(a,b){const c=[],d=[];b=b.nodes.map((e,f)=>{const g=c.length,h=e.children?e.children.length:0;d.push(this._rootIndex);for(var p=0;p<h;p++)c.push(e.children[p]);const k=`${e.index}`;p=H.Obb.fromJSON(e.obb);const q=y.fromCenterAndRadius(p.center,p.radius);var t=e.mesh?.attribute;const n=
e.mesh?.geometry,l=e.mesh?.material;t={hasSharedResource:!1,isEmpty:null==n,attributes:null!=t?.resource?`${t.resource}`:void 0,geometry:null!=n?.resource?`${n.resource}`:void 0,texture:null!=l?.resource?`${l.resource}`:void 0,geometryDefinition:n?n.definition:-1,materialDefinition:l?l.definition:-1};e=new r.Node(k,E(f,a,this._pageSize),q,h,0,t,this._lastUpdate,this._lodMetric,this._lodConversion(e.lodThreshold),n?n.featureCount:null);e.serviceObbInIndexSR=p;e.visibilityObbInRenderSR=this._computeVisibilityObb(e);
e.vertexCount=n?n.vertexCount:0;return new I(g,h,w.addWraparound(this._visibilityCacheVersion,-2),null,e)});b=new J(b,c);-1===a?this._clientNodePage=b:this._nodePages.set(a,b)}_updateParentsAndLevel(){const a=[],b=(c,d,e)=>{var f=this._getPage(c);if(null!=f){const g=x(c,this._pageSize);f=f.nodes[g];f.parent=null!=d?d:-1;d=f.node;null!=d&&(d.level=e,a.push(c))}};for(b(this._rootIndex,null,0);a.length;){const c=a.pop(),d=this.getNode(c);if(null!=d)for(let e=0;e<d.childCount;e++){const f=this.getChildIndex(d.index,
e);b(f,c,d.level+1);this._maxLevel=Math.max(this._maxLevel,d.level+1)}}}_getPage(a){a=A(a,this._pageSize);return this._getPageFromPageIndex(a)}_getPageFromPageIndex(a){return 0>a?this._clientNodePage:this._nodePages.get(a)}_getNodeInternal(a){const b=this._getPage(a);if(null==b)return null;b.lastTraversed=this._frameNumber;return b.nodes[x(a,this._pageSize)]}_addNode(a,b){a.children&&this.populateChildren(b,a.children);var c=this.getParent(b);const d=null!=c?c.level+1:0;this._maxLevel=Math.max(this._maxLevel,
a.children?d+1:d);const {lodMetric:e,maxError:f}=M(a.lodSelection);c=this._getNodeInternal(b);b=new r.Node(a.id,b,a.mbs,c.childCount,d,a.resources,a.version,e,f,a.numFeatures);c.node=b;a.obb&&(b.serviceObbInIndexSR=H.Obb.fromJSON(a.obb));b.visibilityObbInRenderSR=this._computeVisibilityObb(b);c=c.ref;null!=c&&(null==c.serviceMbsInIndexSR&&(c.serviceMbsInIndexSR=a.mbs),b.shareServiceBVsInRenderSRWith(c),c.visibilityObbInRenderSR=b.visibilityObbInRenderSR);return b}_makeRefNode(a,b){const c=this._nodePages.get(0);
if(-1>b)return this._makeClientRefNode(a,b);if(null==c)return-1;const d=c.nodes.length,e=new I(0,0,w.addWraparound(this._visibilityCacheVersion,-2),a,null);c.nodes.push(e);e.parent=b;a.invalidateServiceBVsInRenderSR();return d}_makeClientRefNode(a,b){const c=this._clientNodePage;if(null==c)return-1;if(0<=b)throw Error("I3SIndex::client side nodes can not be made children of service side nodes.");const d=-(c.nodes.length+1),e=new I(0,0,w.addWraparound(this._visibilityCacheVersion,-2),a,null);c.nodes.push(e);
e.parent=b;a.invalidateServiceBVsInRenderSR();return d}_linkChildToParentNode(a,b){const c=this._clientNodePage;if(!(null==c||0<=a)){var d=x(a,this._pageSize),e=x(b,this._pageSize);d=c.nodes[d];var f=d.childOffset;c.children.splice(d.childOffset+d.childCount,0,b);d.childCount+=1;null!=d.node&&(d.node.childCount+=1);for(const g of c.nodes)g.childOffset>f&&(g.childOffset+=1);c.nodes[e].parent=a;this._updateParentBoundingInformation(a)}}_destroyClientRefNode(a,b,c){const d=this._clientNodePage;if(null!=
d){var e=this.getParentIndex(a);if(null!=e){var f=new Set,g=new Map,h=B=>{var z=x(B,this._pageSize);z=d.nodes[z];if(0<z.childCount)for(var D=z.childOffset;D<z.childOffset+z.childCount;++D)h(d.children[D]);D=z.node?.id??z.ref?.id;if(null==D)throw Error("Node has no id");b(D,B);f.add(z)};h(a);a=d.nodes;var p=d.children,k=d.nodes.map(()=>-1),q=[],t=[];for(var n=0;n<a.length;++n){var l=a[n];if(!f.has(l)){var m=q.length,u=E(n,-1,this._pageSize);m=E(m,-1,this._pageSize);l.node&&(l.node.index=m);k[n]=m;
q.push(l);if(u!==m){l=l.node?.id??l.ref?.id;if(null==l)throw Error("Node has no id");c(l,u,m);g.set(u,m)}}}for(c=0;c<q.length;++c){g=E(c,-1,this._pageSize);n=q[c];u=t.length;for(l=n.childOffset;l<n.childOffset+n.childCount;++l)if(m=p[l],0<=m)t.push(m);else{m=x(m,this._pageSize);const B=a[m];f.has(B)||(t.push(k[m]),B.parent=g)}n.childOffset=u;n.childCount=t.length-u;n.node&&(n.node.childCount=n.childCount)}d.nodes=q;d.children=t;this._updateParentBoundingInformation(k[x(e,this._pageSize)])}}}_updateParentBoundingInformation(a){do{let d=
null;var b=this._clientNodeLoader.indexSR;const e=this._clientNodeLoader.renderSR,f=this._getNodeInternal(a);if(null==f)break;for(let g=0;g<f.childCount;g++){var c=this.getChildIndex(a,g);c=this._getNodeInternal(c);c=null!=c?c.ref||c.node:null;if(null!=c&&0<c.serviceMbsInIndexSR[3])if(null==d)d=y.copy(c.serviceMbsInIndexSR,V);else{const h=W,p=X,k=Y;G.projectBoundingSphere(c.serviceMbsInIndexSR,b,h,e);G.projectBoundingSphere(d,b,p,e);y.union(h,p,k);G.projectBoundingSphere(k,e,d,b)}}b=g=>{null!=g&&
(g.serviceObbInIndexSR=null,null!=d?(g.serviceMbsInIndexSR??(g.serviceMbsInIndexSR=y.create()),y.copy(d,g.serviceMbsInIndexSR)):w.invalidateMbs(g.serviceMbsInIndexSR),g.invalidateServiceBVsInRenderSR(),g.geometryObbInRenderSR=null)};b(f.ref);b(f.node);this.invalidateNodeVisibilityCacheInternal(f);a=this.getParentIndex(a)}while(null!=a)}populateChildren(a,b){var c=this._getNodeInternal(a);const d=this._getPage(a);c.childOffset=d.children.length;c.childCount=b.length;for(c=0;c<b.length;c++){const e=
this._makeRefNode(b[c],a);d.children.push(e)}}getNode(a){a=this._getNodeInternal(a);return null!=a?a.node:null}getIndexById(a){let b;this._forAllNodes((c,d)=>{null!=c.node&&c.node.id===a?b=d:null!=c.ref&&c.ref.id===a&&(b=d)});return b}getNodeById(a){a=this.getIndexById(a);return null!=a&&0<=a?this.getNode(a):null}getChildIndex(a,b){const c=this._getPage(a);if(null==c)return-1;a=c.nodes[x(a,this._pageSize)];return c.children[a.childOffset+b]}getParentIndex(a){const b=this._getPage(a);return null!=
b&&a!==this._rootIndex?b.nodes[x(a,this._pageSize)]?.parent:null}getParent(a){a=this.getParentIndex(a);return null!=a?this.getNode(a):null}isLeaf(a){a=this._getNodeInternal(a);return null!=a&&0===a.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes(a=>{null!=a.node&&(a.node.geometryObbInRenderSR=null)})}invalidateVisibilityCache(){this._visibilityCacheVersion=w.addWraparound(this._visibilityCacheVersion,
2)}invalidateNodeVisibilityCache(a){a=this._getNodeInternal(a);null!=a&&this.invalidateNodeVisibilityCacheInternal(a)}invalidateNodeVisibilityCacheInternal(a){a.visibilityCache=w.addWraparound(this._visibilityCacheVersion,-2)}invalidateBoundingVolumeCache(a){a=this._getNodeInternal(a);null!=a&&(a?.invalidateBounds(),this.invalidateNodeVisibilityCacheInternal(a))}updateElevationChanged(a){const b=this._getNodeInternal(a);null!=b&&(this.needNodeElevationRange?(a=null!=b.node?b.node:b.ref,null!=a&&a.invalidateElevationRange()):
this.invalidateBoundingVolumeCache(a))}invalidateGeometryVisibility(a){if(a=this._getNodeInternal(a)?.node)a.geometryObbInRenderSR=null,a.invalidateServiceBVsInRenderSR()}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,a=>{a.visibilityObbInRenderSR=this._computeVisibilityObb(a);a.geometryObbInRenderSR=null;return!0})}_isElevationRangeUpToDate(a){return this.needNodeElevationRange?(a=a?.node??a?.ref)?a.elevationRangeValid:!0:!0}updateElevationRange(a){this._updateElevationRangeInternal(a,
null)}_updateElevationRangeInternal(a,b){const c=this._getNodeInternal(a);if(!c)return!1;const d=c?.node??c?.ref;if(!d)return!1;if(d.elevationRangeValid)return b?.expandElevationRange(d),!0;const e=new Q.ElevationRange;var f=!1;for(let h=0;h<c.childCount;h++){var g=this.getChildIndex(a,h);g=this._updateElevationRangeInternal(g,e);f=f||!g}(0===c.childCount||f)&&this._viewportQueries.expandElevationRange(d,!c.node?.resources.isEmpty,e);f=d.elevationRangeMax;if(d.elevationRangeMin===e.elevationRangeMin&&
f===e.elevationRangeMax)return b?.expandElevationRange(d),!0;c.node?.setElevationRange(e);c.ref?.setElevationRange(e);this.invalidateBoundingVolumeCache(a);b?.expandElevationRange(d);return!0}isNodeVisible(a){const b=this._getNodeInternal(a);if(null==b)return!0;var c=b.ref;if(null!=c&&!c.serviceMbsInIndexSR)return!0;if(this._isElevationRangeUpToDate(b)&&(b.visibilityCache&-2)===this._visibilityCacheVersion)return 1===(b.visibilityCache&1);const d=b.node,e=this._viewportQueries;if(d){var f=e.ensureElevationAgnosticBoundingVolume(d),
g=e.isElevationAgnosticBoundingVolumeVisible(f);let h=g;this.needNodeElevationRange&&g&&(g=e.getNodeObbInRenderSRIndependentOfElevationOffset(d),null!=g&&(h=e.isObbVisibleIndependentOfElevation(f,g)));if(!h)return b.visibilityCache=this._visibilityCacheVersion+0,!1}this._layerHasFilter&&this._computeNodeFiltering&&(null!=d||null!=c)&&b.filterImpact===r.NodeFilterImpact.NotChecked&&(f=null!=d?d.serviceMbsInIndexSR:null!=c?c.serviceMbsInIndexSR:null,b.filterImpact=null!=f?this._computeNodeFiltering(f):
r.NodeFilterImpact.Unmodified);f=null!=d&&b.filterImpact===r.NodeFilterImpact.Culled;if(f=!(null!=d&&d.imModificationImpact===r.NodeIMModificationImpact.Culled)&&!f)c=!d||c&&!d.visibilityObbInRenderSR?c??null:d,null!=c&&(this.needNodeElevationRange&&this.updateElevationRange(a),f=e.isNodeVisible(c));b.visibilityCache=this._visibilityCacheVersion+(f?1:0);return f}isGeometryVisible(a){if(!this.isNodeVisible(a))return!1;a=this._getNodeInternal(a);return null==a?.node?.geometryObbInRenderSR||this.layerHasModifications&&
a.node.imModificationImpact===r.NodeIMModificationImpact.NotChecked?!0:this._viewportQueries.isGeometryVisible(a.node)}_traverseCoverage(a,b,c,d,e){a=this._getPage(a);if(null!=a&&0!==b.childCount){var f=b.childOffset+b.childCount,g=[];for(b=b.childOffset;b<f;++b){const h=a.children[b],p=this._getNodeInternal(h);null!=p?.node&&this.isGeometryVisible(h)&&g.push(p)}d/=g.length;for(const h of g)a=h.node.index,this._isLoaded(a)||this._isReloading(a)?(e.delta=Math.max(e.delta,c),e.coverage+=d):this._traverseCoverage(a,
h,c+1,d,e)}}useNodeAsHole(a){if("off"===this.holeFilling)return!1;const b=this._getNodeInternal(a);if(null==b)return!1;if("always"===this.holeFilling)return!0;if((b.useAsHole&-2)===this._version)return 1===(b.useAsHole&1);const c={delta:0,coverage:0};this._traverseCoverage(a,b,0,1,c);a=.5>=c.delta*c.coverage;b.useAsHole=this._version+(a?1:0);return a}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune();this._updates.update.prune()}requestUpdate(){this._dirty=
!0;this._indexMissing=1;this._version=w.addWraparound(this._version,2)}imModificationsChanged(a){this.layerHasModifications=a;this._forAllNodes(({node:b})=>{null!=b&&(b.imModificationImpact=r.NodeIMModificationImpact.NotChecked,b.visibilityObbInRenderSR=this._computeVisibilityObb(b),b.hasModifications&&this.invalidateGeometryVisibility(b.index))});this.invalidateVisibilityCache()}layerFilterChanged(a){this._layerHasFilter=a;this._forAllNodes(b=>{null!=b&&(b.filterImpact=r.NodeFilterImpact.NotChecked,
b=b.node,null!=b&&this.invalidateNodeVisibilityCache(b.index))});this.invalidateVisibilityCache()}update(a,b,c){if(this._dirty){0<this._pageQueue.length&&this._addQueuedPages(b);this._invalidateElevationRangeForNewPages(b);this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missingPagesAndNodes.clear();this._prefetchNodes.clear();this._updates.reset(a);v.clear();var d=!0,e=new K,f=new K,g=this._imModificationUncategorized;g.clear();var h=new Set,p=0;this.traverseVisible((k,
q,t)=>{var n=A(k,this._pageSize);if(null==q)k=this._entryPriority(k),Infinity===k&&(k=this._entryPriority(t)),v.set(n,Math.max(k,v.get(n)||0)),this._loadingPages.has(n)||this._failedPages.has(n)||(this._missingPagesAndNodes.push(n),++p),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,k);else{var l=q.node;this._updateNodeFeatureEstimate(l,f);if(null==l)q=this._entryPriority(k),this._loadingNodes.has(k)||this._failedNodes.has(k)||(this._missingPagesAndNodes.push(k),v.set(k,q)),this._maxProcessingPrio=
Math.max(this._maxProcessingPrio,q);else{t=this._getPage(k);if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(n=0;n<q.childCount;n++){const m=t.children[q.childOffset+n],u=this._getNodeInternal(m);null!=u&&!u.node&&!this._loadingNodes.has(m)&&!this._failedNodes.has(m)&&0<=m&&(v.set(m,this._entryPriority(m)),this._prefetchNodes.push(m))}l.failed||l.resources.isEmpty?d&&0<q.childCount&&this._isSelected(l)&&(d=!1):this._isLoaded(k)?(e.known+=l.memory,++e.knownNodes,this._isSelected(l)?
0<q.childCount&&(d=!1):(e.unremoved+=l.memory,d=!1),this._needsUpdate(l)&&(q=this._entryPriority(k),v.set(k,q),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,q),this._updates.update.push(k))):(l.memory&&(e.known+=l.memory,++e.knownNodes),this._isSelected(l)?(0<q.childCount&&(d=!1),l.memory?(e.missing+=l.memory,e.known+=l.memory,++e.knownNodes):++e.missingNodes,a.includes(l.index)?(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(k)),this._updates.cancel=this._updates.cancel.filter(m=>
m!==l.index)):!b.done&&this._enable(l)?b.madeProgress():(q=this._entryPriority(k),v.set(k,q),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,q),this._updates.add.push(k),this.layerHasModifications&&c&&null!=l&&l.imModificationImpact===r.NodeIMModificationImpact.NotChecked&&g.push(k))):this._isReloading(k)&&this._updates.remove.push(k))}}},h);this._frameNumber++;this._missingPagesAndNodes.sort((k,q)=>k-q);this._missingPagesAndNodes.filterInPlace((k,q)=>1>q||this._missingPagesAndNodes.data[q-
1]!==k);this._missingPagesAndNodes.sort((k,q)=>v.get(k)-v.get(q));0<this._missingPagesAndNodes.length&&(this._maxUnloadedPrio=v.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear());this._removeUnusedNodePages(h,p);h=this._updates.add;0<h.length&&this.layerHasModifications&&(0<g.length&&c?.(g),h.filterInPlace(k=>{var q=this._getNodeInternal(k);(q=null==q?.node||q.node.imModificationImpact!==r.NodeIMModificationImpact.Culled)||this.invalidateNodeVisibilityCache(k);return q}));this._unloadedMemoryEstimate=
e.missing-e.unremoved;3<e.knownNodes&&0<e.missingNodes&&(this._unloadedMemoryEstimate+=e.known/e.knownNodes*e.missingNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(f);this._featureEstimate.leavesReached=d;this._updates.add.filterInPlace(k=>v.get(k)>=this._maxUnloadedPrio).sort((k,q)=>v.get(k)-v.get(q));this._updates.update.sort((k,q)=>v.get(k)-v.get(q));this._indexMissing=this._loadingPages.size+this._loadingNodes.size+
this._missingPagesAndNodes.length;this._dirty=0<this._indexMissing;v.clear()}}checkFeatureTarget(a,b){const c=this._viewportQueries.updateScreenSpaceErrorBias(b);let d=b,e=b,f=c,g=10;for(;g--;){const h=new K;this._updateFeatureEstimate(d,h);if(this._computeFeatureEstimate(h)<=a){if(d>=b||0<h.missingNodes||0===g)break;f=d;d=.5*(d+e)}else e=d,d=.5*(d+f)}this._version=w.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(c);return Math.min(b,d)}_removeUnusedNodePages(a,b){if(this._useNodePages){var c=
a.size,d=this._nodePages;b=d.size+this._loadingPages.size+b;if(b>N&&b>c){c=[];for(const [e,f]of d)0!==f.numNodesWithLoadedChildren||a.has(e)||c.push([f.lastTraversed,e]);c.sort((e,f)=>e[0]-f[0]).some(e=>{this._deleteNodePage(e[1]);return d.size<=N})}}}_updateFeatureEstimate(a,b){this._version=w.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible((c,d)=>this._updateNodeFeatureEstimate(null!=d?d.node:void 0,b))}_updateNodeFeatureEstimate(a,b){null!=
a&&!a.failed&&null!=a.numFeatures&&this._isSelected(a)&&(null!=a.numFeatures?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes)}_computeFeatureEstimate(a){let b=a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){this._prefetchNodes.sort((a,b)=>v.get(a)-v.get(b));return this._load(this._prefetchNodes)}_load(a){if(0===a.length||!this._canRequest())return!1;
for(;0<a.length&&this._canRequest();){const b=a.pop();this._useNodePages?0<=b?this._loadPage(b):this._loadNode(b):this._loadNode(b)}return!0}get isLoading(){return 0<this._indexMissing}get isPrefetching(){return 0<this._prefetchNodes.length}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,
this._maxUnloadedPrio)}nodeTraversalState(a){if(null==a)return null;const b=a.index,c=this._getNodeInternal(b);if(!c)return null;let d=c?.traversalState;if(d&&(d.version&-2)===this._version)return d;const e=this._viewportQueries.getLodLevel(a),f=this._viewportQueries.hasLOD(a);let g=!0;f?(a=this.getParentIndex(b),null!=a?(a=this._getNodeInternal(a)?.traversalState,g=!!a&&e>a.lodLevel):g=0<e):g=0===a.childCount;if(d)return d.lodLevel=e,d.isChosen=g,d.version=this._version+1,d;d=new r.NodeTraversalState(f,
g,e,this._version+1);return c.traversalState=d}async _loadNode(a){this._loadingNodes.add(a);var b=this._getNodeInternal(a).ref;if(null==b)this._failedNodes.add(a);else{b=b.id;var c=this._urlPrefix+b,d=()=>{this._loadingNodes.delete(a);0===this._missingPagesAndNodes.length&&0===this._loadingNodes.size&&this.requestUpdate()},e=null;try{e=0<=a?await this._streamDataController.request(c,"json"):await this._clientNodeLoader.loadNodeJSON(b)}catch(f){d();L.isAbortError(f)||(this._logger.error("#loadNode()",
this._layer,"Error loading node: "+c),this._failedNodes.add(a));return}d();b=this._validateNode(b,e);null!=b&&(b.obb&&this.invalidateNodeVisibilityCache(a),b=this._addNode(b,a),this.nodeTraversalState(b))}}_validateNode(a,b){if(null==b||"object"!==typeof b||b.id!==a)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${a}"`),null;if(!Array.isArray(b.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${a}.`),null;
b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${a}"`);var c=b.geometryData;null==c||Array.isArray(c)&&0===c.length||Array.isArray(c)&&1===c.length&&"./geometries/0"===c[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${a}"`);c=b.attributeData;const d=this._layer.attributeStorageInfo;null==c||Array.isArray(c)&&!c.some((h,p)=>h.href!==
`./attributes/${d?.[p]?.key??`f_${p}`}/0`)||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${a}"`);b.featureData&&1<b.featureData.length&&this._logger.warn("#validateNode()",this._layer,`Node ${a} has ${b.featureData.length} bundles. Only the first bundle will be loaded.`);c=b.hasOwnProperty("obb")&&!this.ignoreServiceObb?b.obb:void 0;const e=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]+
1:void 0;var f=h=>{if(null==h)return null;var p=k=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${a}: ${k}`);if("number"===typeof h.id)p(`id ${h.id} is a number instead of a string.`);else if("string"!==typeof h.id||!Array.isArray(h.mbs))return p("Missing or invalid id."),null;if(!Array.isArray(h.mbs))return p(`Invalid bounding volume on reference ${h.id}.`),null;h.href&&h.href!=="../"+h.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${a}"`);
p=new r.NodeBase(`${h.id}`,h.mbs);p.serviceObbInIndexSR=!this.ignoreServiceObb&&h.hasOwnProperty("obb")&&h.obb?H.Obb.fromJSON(h.obb):null;p.visibilityObbInRenderSR=this._computeVisibilityObb(p);return p};f=Array.isArray(b.children)?b.children.map(f).filter(h=>null!=h):null;const g=!0===b.isEmpty;return new P.ValidatedNode(a,b.mbs,c,"string"===typeof b.version?b.version:null,{isEmpty:!(b.featureData?.length??!1)&&g,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?a:void 0,texture:b.textureData&&
0<b.textureData.length?a:void 0,geometry:null!=b.geometryData?a:void 0},f,Array.isArray(b.lodSelection)?b.lodSelection:null,e)}resetFailedNodes(){this._failedNodes.clear();this._failedPages.clear();this._forAllNodes(a=>{null!=a.node&&(a.node.failed=!1)})}_entryPriority(a){var b=this._getNodeInternal(a),c=this.getParentIndex(a);if(null==b||null==c&&null==b.node)return null==c?Infinity:this._entryPriority(c);let d=0;b.node&&null!=c&&(c=this._getNodeInternal(c).traversalState,null!=c&&(d=c.lodLevel));
for(c=this.progressiveLoadPenalty;null!=a;a=this.getParentIndex(a))if(this._isLoaded(a)){c=0;break}b=null!=b.ref?this._viewportQueries.distToPOI(b.ref):null!=b.node?this._viewportQueries.distToPOI(b.node):0;return-b-d*(b+this.progressiveLoadPenalty)+c}traverseVisible(a,b){const c=this._getNodeInternal(this._rootIndex);null==c?a(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,null,c,a,b)}_traverseVisible(a,b,c,d,e){var f=A(a,this._pageSize);e&&e.add(f);if(c.node&&0===c.childCount)this.isGeometryVisible(a)&&
d(a,c,b);else if(this.isNodeVisible(a)&&(d(a,c,b),null!=c.node&&(b=this.nodeTraversalState(c.node),!b?.nodeHasLOD||b.lodLevel!==this._maxLodLevel)))for(f=this._getPageFromPageIndex(f),b=0;b<c.childCount;b++){const h=f.children[c.childOffset+b];var g=this._getNodeInternal(h);g?this._traverseVisible(h,a,g,d,e):(e&&(g=A(h,this._pageSize),e.add(g)),d(h,null,a))}}traverse(a,b){b(a)&&this.traverseDescendants(a,b)}traverseDescendants(a,b){++this._traverseDescendantsNestingLevel;a=a.index;var c=this._pageSize,
d=A(a,c),e=this._getPageFromPageIndex(d);if(null!=e){var f=this._frameNumber,g=this._nodePages;e.lastTraversed=f;a=x(a,c);var h=e.nodes[a];({childCount:a}=h);if(0!==a){a=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0];var p=0,k=[],{childOffset:q,childCount:t}=h;({children:h}=e);a.length=2**Math.ceil(Math.log2(p+t));for(var n=q;n<q+t;++n){var l=h[n];0<=l?(a[p]=l,++p):k.push(l)}if(0<k.length&&(h=this._clientNodePage))for(n=h.children,l=0;l<k.length;){var m=k[l];++l;m=h.nodes[-m-
1];var u=m.node;if(u&&b(u)&&({childCount:u}=m,0!==u))for({childOffset:m}=m,u=m+u;m<u;++m)k.push(n[m])}if(0<p)if(k=0,0<c)for(d*=c,h=e.nodes;k<p;){l=a[k];++k;if(d<=l&&l<d+c)n=e;else{m=l/c|0;n=g.get(m);if(void 0===n)continue;n.lastTraversed=f;e=n;h=e.nodes;d=c*m}l=h[l-d];m=l.node;if(null!=m&&!1!==b(m)&&({childCount:m}=l,0!==m)){a.length<p+m&&(a.length=2**Math.ceil(Math.log2(p+m)));for(;a.length<p+m;)a.length+=a.length;n=n.children;({childOffset:l}=l);for(m=l+m;l<m;++l)a[p]=n[l],++p}}else if(c=g.get(0))for(;k<
p;)if(f=a[k],++k,g=c.nodes[f],(f=g.node)&&b(f)&&({childCount:e}=g,0!==e))for(a.length=Math.max(a.length,2**Math.ceil(Math.log2(p+e))),f=c.children,{childOffset:g}=g,e=g+e;g<e;++g)a[p]=f[g],++p;--this._traverseDescendantsNestingLevel}}}updateChildrenLoaded(a,b){for(a=this.getNode(a);null!=a;){var c=a.childrenLoaded;const d=c+b;a.childrenLoaded=d;c=0===c?1:0===d?-1:0;a=a.index;0!==c&&(this._getPage(a).numNodesWithLoadedChildren+=c);a=this.getParent(a)}}checkChildrenLoadedInvariant(){if(null==this.rootNode)return!0;
const a=[],b=c=>{let d=this._isLoaded(c.index)||this._isReloading(c.index)?1:0;this.traverseDescendants(c,e=>{d+=b(e);return!1});c.childrenLoaded!==d&&a.push(c.index);return d};b(this.rootNode);a.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+a.join(","));return 0<a.length}updateElevationInfo(a,b){this.needNodeElevationRange=b&&!!a&&("relative-to-ground"===a.mode||"relative-to-scene"===a.mode||"on-the-ground"===a.mode);this._viewportQueries.updateElevationInfo(a);
this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes(a=>{a?.invalidateBounds();a.node?.invalidateElevationRange();a.ref?.invalidateElevationRange()})}_forAllNodes(a){if(null!=this._clientNodePage){var b=this._clientNodePage;for(var c=0;c<b.nodes.length;c++)a(b.nodes[c],-(c+1))}for(const [d,e]of this._nodePages)for(b=d*this._pageSize,c=0;c<e.nodes.length;c++)a(e.nodes[c],b+c)}clearCaches(){if(this._useNodePages){const a=this._nodePages,b=new Set;this.traverseVisible(c=>
b.add(A(c,this._pageSize)));for(const [c,d]of a)if(0!==d.numNodesWithLoadedChildren||b.has(c))for(const e of d.nodes)e.traversalState=null;else this._deleteNodePage(c)}}_deleteNodePage(a){this._nodePages.delete(a)}get test(){}}const v=new Map;class U{constructor(a){this.missing=a;this.update=new C({deallocator:null});this.add=new C({deallocator:null});this.remove=new C({deallocator:null});this.cancel=[]}reset(a){this.add.clear();this.update.clear();this.cancel=a}}const R=[["maxScreenThreshold",r.LodMetric.MaxScreenThreshold],
["screenSpaceRelative",r.LodMetric.ScreenSpaceRelative],["removedFeatureDiameter",r.LodMetric.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",r.LodMetric.DistanceRangeFromDefaultCamera]];class K{constructor(){this.unremoved=this.missingNodes=this.missing=this.knownNodes=this.known=0}}const V=y.create(),W=y.create(),X=y.create(),Y=y.create(),N=O("esri-mobile")?100:300;F.I3SIndex=T;F.selectErrorMetric=M;Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});