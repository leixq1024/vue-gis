// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/maybe ../../../../core/PooledArray ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/vec42 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/plane ../../../../geometry/support/ray ./Intersector ./PointHighlights ../../webgl-engine/core/shaderLibrary/ShaderOutput ../../webgl-engine/effects/RenderPlugin ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/RenderSlot ../../webgl-engine/lib/VertexArrayObject ../../webgl-engine/lib/VertexAttribute ../../../../chunks/PointRenderer.glsl ../../webgl-engine/shaders/PointRendererTechnique ../../webgl-engine/shaders/PointRendererTechniqueConfiguration ../../../webgl/BufferObject ../../../webgl/enums ../../../webgl/VertexElementDescriptor".split(" "),
function(A,V,W,da,ea,xa,ya,za,fa,v,I,ha,r,ia,ja,ka,la,B,ma,na,oa,J,N,pa,X,O,qa,ra,Y,E,Z){function P(a,b,c,f,g){if(c.drawScreenSpace)return c.fixedSize*b*f;g=O.getMaxPointSizeScreenspace(g)*b*f;return c.useFixedSizes?Math.min(c.fixedSize/2,g):0<c.screenMinSize?Math.min(Math.max(c.screenMinSize*b*f,a/2),g):Math.min(a/2,g)}function Q(a,b,c,f,g){return c.drawScreenSpace?0:P(a,b,c,f,g)}function aa(a){return null!=a.componentIndex?a.componentIndex:-1}function ba(a){return null!=a.dist&&null!=a.point&&null!=
a.pointId&&null!=a.node}const sa=new Map([["positions",[new Z.VertexElementDescriptor(X.VertexAttribute.POSITION,3,E.DataType.FLOAT,0,12)]],["colors",[new Z.VertexElementDescriptor(X.VertexAttribute.COLOR,3,E.DataType.UNSIGNED_BYTE,0,3,!0)]]]);A.PointRenderer=class extends ma.SyncRenderPlugin{constructor(a){super(a);this.type=J.IntersectorType.PCL;this.isGround=!1;this._passParameters=new O.PointRendererPassParameters;this._highlights=new la.PointHighlights({forEachNode:b=>this.forEachNode(b),addHighlight:(b,
c,f)=>this._addHighlight(b,c,f),removeHighlight:(b,c)=>this._removeHighlight(b,c)});this.produces=new Map([[N.RenderSlot.OPAQUE_MATERIAL,b=>!B.isDepth(b)&&(b!==B.ShaderOutput.Highlight||!this._highlights.empty)],[N.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS,b=>B.isDepth(b)]]);this.layerUid="";this._slicePlaneEnabled=!1;this._configuration=new ra.PointRendererTechniqueConfiguration;this._nodes=new da}initializeRenderContext(a){this._context=a;a.requestRender()}uninitializeRenderContext(){}intersect(a,
b,c,f){const g=I.create(),h=I.create(),k=I.create(),e=I.create(),l=ia.create(),p=a.camera.perScreenPixelRatio/2,C=a.camera.near;v.subtract(h,f,c);const w=1/v.length(h);v.scale(h,h,w);v.negate(k,h);ha.set(l,h[0],h[1],h[2],-v.dot(h,c));const x=new R,y=new R,ca=[],K=r.create(),L=r.create(this._passParameters.clipBox);r.offset(L,-c[0],-c[1],-c[2],L);this._nodes.forAll(d=>{const m=d.splatSize*this._passParameters.scaleFactor;var q=d.obb.minimumDistancePlane(l),n=d.obb.maximumDistancePlane(l);q-=Q(m,q+
C,this._passParameters,p,d.isLeaf);n-=Q(m,n+C,this._passParameters,p,d.isLeaf);q=null!=x.dist&&null!=y.dist&&x.dist<q*w&&y.dist>n*w;if(!(0>n||q)&&(n=P(m,n+C,this._passParameters,p,d.isLeaf),d.obb.intersectRay(c,h,n))){n*=n;d.obb.toAaBoundingBox(K);r.offset(K,-c[0],-c[1],-c[2],K);q=!r.contains(L,K);v.subtract(e,d.origin,c);var ta=d.coordinates.length/3;for(let D=0;D<ta;D++){g[0]=e[0]+d.coordinates[3*D];g[1]=e[1]+d.coordinates[3*D+1];g[2]=e[2]+d.coordinates[3*D+2];if(q&&!r.containsPoint(L,g))continue;
var t=v.dot(g,h),M=v.squaredLength(g)-t*t;if(M>n)continue;var F=t+C;const S=Q(m,F,this._passParameters,p,d.isLeaf);if(0>t-S)continue;F-=S;F=P(m,F,this._passParameters,p,d.isLeaf);if(M>F*F)continue;const G=(t-S)*w;t=z=>{var T=D,H=z.point;null==H&&(H=I.create());H[0]=d.origin[0]+d.coordinates[3*T];H[1]=d.origin[1]+d.coordinates[3*T+1];H[2]=d.origin[2]+d.coordinates[3*T+2];z.point=H;z.dist=G;z.normal=k;z.node=d;z.pointId=D;z.layerUid=this.layerUid;return z};(null==x.dist||G<x.dist)&&(null==b||b(c,f,
G))&&t(x);a.options.store!==J.StoreResults.MIN&&(null==y.dist||G>y.dist)&&(null==b||b(c,f,G))&&t(y);a.options.store!==J.StoreResults.ALL||null!=b&&!b(c,f,G)||(M=new R,ca.push(t(M)))}}});const ua=d=>{const {layerUid:m,node:q,pointId:n}=d;return new ka.PclTarget(d.point,m,n,()=>this.createGraphic(q,n,d.point))},U=(d,m)=>{const q=ua(m);d.set(this.type,q,m.dist,m.normal)};if(ba(x)){var u=a.results.min;(null==u.dist||x.dist<u.dist)&&U(u,x)}ba(y)&&a.options.store!==J.StoreResults.MIN&&(u=a.results.max,
(null==u.dist||y.dist>u.dist)&&U(u,y));if(a.options.store===J.StoreResults.ALL){u=ja.fromPoints(c,f);for(const d of ca){const m=oa.newIntersectorResult(u);U(m,d);a.results.all.push(m)}}}acquireTechniques(a){if(0===this._nodes.length||!(a.output===B.ShaderOutput.Color||B.isDepth(a.output)&&a.bind.slot===N.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS||a.output===B.ShaderOutput.Highlight))return null;this._nodes.forAll(b=>this._initNode(a,b));this._configuration.drawScreenSize=this._passParameters.drawScreenSpace;
this._configuration.useFixedSizes=this._passParameters.useFixedSizes;this._configuration.hasSlicePlane=this._slicePlaneEnabled;this._configuration.hasOccludees=a.bind.hasOccludees;this._configuration.clippingEnabled=this._clippingEnabled;this._configuration.output=a.output;return this._context.techniques.acquire(qa.PointRendererTechnique,this._configuration)}render(a,b){const {rctx:c,bind:f,output:g}=a,h=c.bindTechnique(b,f,this._passParameters),k=g===B.ShaderOutput.Highlight;this._nodes.forAll(e=>
{0!==e.coordinates.length&&(!k||e.highlights&&e.highlights.some(l=>f.highlightGroupName===l.id.highlightGroupName))&&(h.bindDraw(f,this._passParameters,e),c.bindVAO(e.vao),k?this._renderHighlightFragments(a,e):c.drawArrays(E.PrimitiveType.POINTS,0,e.coordinates.length/3))})}_renderHighlightFragments(a,b){const {highlights:c}=b;if(null!=c){var {rctx:f,bind:g}=a,{highlightGroupName:h}=g,k=0,e=c[0].componentIndex,l=e+1;a=()=>{for(;k<c.length&&c[k].id.highlightGroupName!==h;)e=c[k].componentIndex,++k;
l=e+1};a();for(b=(C,w)=>{w-=C;0<w&&f.drawArrays(E.PrimitiveType.POINTS,C,w)};k<c.length;){var p=c[k];p.id.highlightGroupName!==g.highlightGroupName?(b(e,l),++k,a()):(p=p.componentIndex,p!==l&&(b(e,l),e=p),l=p+1,++k)}b(e,l)}}set useFixedSizes(a){this._passParameters.useFixedSizes!==a&&(this._passParameters.useFixedSizes=a,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(a){this._passParameters.scaleFactor!==a&&(this._passParameters.scaleFactor=a,
this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(a){this._passParameters.minSizePx!==a&&(this._passParameters.minSizePx=a,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(a){this._passParameters.useRealWorldSymbolSizes!==a&&(this._passParameters.useRealWorldSymbolSizes=a,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(a){this._passParameters.size!==
a&&(this._passParameters.size=a,this._requestRender())}get size(){return this._passParameters.size}set sizePx(a){this._passParameters.sizePx!==a&&(this._passParameters.sizePx=a,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(a){r.set(this._passParameters.clipBox,a||r.positiveInfinity)}get _clippingEnabled(){return!r.equals(this._passParameters.clipBox,r.positiveInfinity,(a,b)=>a===b)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(a){this._slicePlaneEnabled!==
a&&(this._slicePlaneEnabled=a,this._requestRender())}addNode(a){this._nodes.push(a);this._highlights.nodeAdded(a);this._requestRender()}removeNode(a){let b=null;this._nodes.filterInPlace(c=>c.id===a?(b=c,c.vao=W.disposeMaybe(c.vao),this._highlights.nodeRemoved(c),!1):!0);this._requestRender();return b}forEachNode(a){this._nodes.forAll(a)}removeAll(){this._nodes.forAll(a=>a.vao=W.disposeMaybe(a.vao));this._highlights.removeAll();this._nodes.clear();this._requestRender()}highlight(a,b){return this._highlights.add(a,
b)}_addHighlight(a,b,c){a.addHighlight(b,c);this._requestRender()}_removeHighlight(a,b){a.removeHighlight(b);this._requestRender()}_initNode(a,b){b.vao??(b.vao=new pa.VertexArrayObject(a.rctx,na.Default3D,sa,new Map([["positions",Y.BufferObject.createVertex(a.rctx,E.Usage.STATIC_DRAW,b.coordinates)],["colors",Y.BufferObject.createVertex(a.rctx,E.Usage.STATIC_DRAW,b.rgb)]])))}_requestRender(){this._context&&this._context.requestRender()}};V.__decorate([ea.property({constructOnly:!0})],A.PointRenderer.prototype,
"createGraphic",void 0);A.PointRenderer=V.__decorate([fa.subclass("esri.views.3d.layers.i3s.PointRenderer")],A.PointRenderer);class va extends O.PointRendererDrawParameters{constructor(a,b,c,f,g,h,k,e,l=null){super(c,g,b);this.id=a;this.obb=f;this.coordinates=h;this.rgb=k;this.attributes=e;this.pointIdFilterMap=l;this.highlights=null}addHighlight(a,b){let {highlights:c}=this;null==c&&(this.highlights=c=[]);a=new wa(a,b);c.push(a);a=aa(a);for(b=c.length-1;0<b&&a<aa(c[b-1]);--b)[c[b-1],c[b]]=[c[b],
c[b-1]]}removeHighlight(a){var {highlights:b}=this;null!=b&&(b=b.filter(c=>c.id!==a),0===b.length&&(this.highlights=null),this.highlights=b)}}class R{constructor(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""}}class wa{constructor(a,b){this.componentIndex=a;this.id=b}}A.PointRendererNode=va;A.isPointRendererNode=function(a){return a.hasOwnProperty("splatSize")};Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});