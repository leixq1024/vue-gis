// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../chunks/languageUtils ../../../core/Accessor ../../../core/Collection ../../../core/handleUtils ../../../core/Logger ../../../core/MapUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../layers/buildingSublayers/BuildingGroupSublayer ./BuildingComponentSublayerView3D ./BuildingSublayerView3D ./LayerView3D ./i3s/BuildingFilterUtil ./i3s/I3SUtil ./support/highlightUtils ./support/LayerViewPerformanceInfo ../support/updatingProperties ../../layers/BuildingSceneLayerView ../../support/layerViewUtils".split(" "),
function(h,r,g,t,u,v,w,x,m,n,k,K,L,y,M,z,A,B,C,D,p,E,F,G,H){function I(a,b){const c=new Map,f=a.length;for(let d=0;d<f;d++){const e=a[d],l=b(e,d,a),q=c.get(l);q?q.push(e):c.set(l,[e])}return c}const J=A.BuildingSublayerView3DMixin(g);g=class extends B.LayerView3D(G){constructor(a){super(a);this.type="building-scene-3d";this.sublayerViews=new t;this._abortController=new AbortController;this._loadingComponents=0;this._pendingWhenSublayerViews=new Map;this.ignoresMemoryFactor=!1}get filterExpression(){const a=
this.layer.activeFilterId;var b=null!=a?this.layer.filters.find(c=>c.id===a):null;return(b=null!=b?b.filterBlocks?.find(c=>"solid"===c.filterMode.type):null)?b.filterExpression:null}get filterExpressions(){const a=this.layer.activeFilterId,b=null!=a?this.layer.filters.find(c=>c.id===a):null;return b?.filterBlocks?b.filterBlocks.toArray().map(c=>[c.filterExpression??"",C.parseFilterMode(c)]):[]}get updatingProgressValue(){const a=this.sublayerViews,b=this._loadingComponents+(a?a.length:0);return a.reduce((c,
f)=>c+f.updatingProgress,0)/b}get visibleAtCurrentScale(){return H.isInEffectiveScaleRange(this.layer.effectiveScaleRange,this.view.scale)}isUpdating(){return 0<this._loadingComponents||this.sublayerViews&&this.sublayerViews.some(a=>a.updating)}initialize(){D.checkSpatialReference(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode);this._initializeSubLayerViews(this.layer.sublayers,this)}destroy(){this.sublayerViews&&(this.sublayerViews.forEach(a=>a.destroy()),this.sublayerViews=
null);this._abortController=x.abortMaybe(this._abortController)}_initializeSubLayerViews(a,b){const c=this,f=this.view;a.forEach(d=>{if(!d.isEmpty)if("building-group"===d.type){const e=new J({sublayer:d,view:f,parent:b});this._initializeSubLayerViews(d.sublayers,e)}else"mesh"===d.geometryType&&(this._loadingComponents++,d.load({signal:this._abortController.signal}).then(()=>{const e=new z({sublayer:d,layerView:c,view:f,parent:b});this.sublayerViews.push(e);const l=this._pendingWhenSublayerViews.get(d);
if(l){for(const q of l)q.resolve(e);this._pendingWhenSublayerViews.delete(d)}this.addHandles([n.watch(()=>e.updating,()=>this.notifyChange("updating"),n.syncAndInitial),n.watch(()=>e.updatingProgress,()=>this.notifyChange("updatingProgressValue"),n.syncAndInitial)])}).catch(e=>{m.isAbortError(e)||v.getLogger(this).error(`Error while creating view for sublayer ${d.id}\nLayer: ${this.layer.url}\n`,e)}).then(()=>{this._loadingComponents--;this.notifyChange("updating");this.notifyChange("updatingProgressValue")}))})}getGraphicFromIntersectorTarget(a){for(const b of this.sublayerViews.items)if(b.sublayer.uid===
a.sublayerUid)return b.getGraphicFromIntersectorTarget(a);return null}async fetchPopupFeaturesFromGraphics(a,b){if(0===a.length)return[];var c=I(a,f=>f.sourceLayer);a=[];for(const [f,d]of c)c=this._findComponent(f),null!=c&&a.push(c.fetchPopupFeaturesFromGraphics(d,b));a=await m.allSettledValues(a);m.throwIfAborted(b);return a.flat()}whenGraphicBounds(a){const b=this._findComponent(a.sourceLayer);return null==b?Promise.reject():b.whenGraphicBounds(a)}getAABBFromIntersectorTarget(a){for(const b of this.sublayerViews.items)if(b.sublayer.uid===
a.sublayerUid)return b.getAABBFromIntersectorTarget(a);return null}async whenSublayerView(a){var b=this._findComponent(a);if(null!=b)return b;b=this._pendingWhenSublayerViews.get(a);const c=m.createResolver();b?b.push(c):this._pendingWhenSublayerViews.set(a,[c]);return c.promise}_findComponent(a){return this.sublayerViews.find(b=>a===b.sublayer)}highlight(a,b){if(r.isQuery(a))return p.emptyHighlightHandle;a=p.normalizeHighlightTargetExceptQuery(a);if(0===a.length)return p.emptyHighlightHandle;if(r.isGraphic(a[0])){const c=
new Map;for(const d of a)w.getOrCreateMapValue(c,d.sourceLayer,()=>[]).push(d);const f=[];this.sublayerViews.forEach(d=>{const e=c.get(d.sublayer);e&&f.push(d.highlight(e,b))});return u.handlesGroup(f)}return p.emptyHighlightHandle}get usedMemory(){return this.sublayerViews.reduce((a,b)=>a+b.usedMemory,0)}get unloadedMemory(){return this.sublayerViews.reduce((a,b)=>a+b.unloadedMemory,0)}get performanceInfo(){return new E.LayerViewPerformanceInfo(this.usedMemory)}};h.__decorate([k.property()],g.prototype,
"sublayerViews",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"filterExpression",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"filterExpressions",null);h.__decorate([k.property(F.updatingProgress)],g.prototype,"updatingProgress",void 0);h.__decorate([k.property({readOnly:!0,dependsOn:[]})],g.prototype,"updatingProgressValue",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"visibleAtCurrentScale",null);return g=h.__decorate([y.subclass("esri.views.3d.layers.BuildingSceneLayerView3D")],
g)});