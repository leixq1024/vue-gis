// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../analysis/featureReferenceUtils ../../../core/Accessor ../../../core/has ../../../core/Logger ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../geometry/projection ./AnalysisView3D ./support/projectionUtils ./Viewshed/ViewshedAnalysisVisualization ./Viewshed/ViewshedComputedData ./Viewshed/ViewshedTool ../webgl-engine/lib/Intersector ../webgl-engine/lib/IntersectorInterfaces ../webgl-engine/lib/Viewshed ../../analysis/analysisViewUtils".split(" "),
function(e,q,d,F,w,m,h,f,G,x,n,r,t,y,z,A,B,u,C,D,E,p){d=class extends y.AnalysisView3D(d){constructor(b){super(b);this.type="viewshed-view-3d";this._intersector=this._viewshedRenderer=this._placementTask=this.viewshedComputedDataHandles=this._selectedViewshed=this.tool=this.analysis=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(b){this._unselectOtherViewsheds(b);this._selectedViewshed=b}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}initialize(){const b=
this.view;this._viewshedRenderer=new E.Viewshed({view:b,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed});this._intersector=C.newIntersector(this.view.state.viewingMode);this._intersector.options.hud=!1;this._intersector.options.store=D.StoreResults.MIN;this.viewshedComputedDataHandles=h.mapCollection(()=>this.analysis.viewsheds,c=>{const a=new B.ViewshedComputedData({renderCoordsHelper:b.renderCoordsHelper,viewshed:c}),g=Symbol();this.addHandles([h.watch(()=>({valid:a.isValid(),
canProject:t.canProjectWithoutEngine(a.observer?.spatialReference,this.view.spatialReference)||t.isLoaded()}),({valid:k,canProject:l},v)=>{this.visible&&(k&&l?this._addViewshedsToRenderer(a):v?.valid&&v?.canProject&&this._removeViewshedsFromRenderer(a),l||z.logFailedGeometryProjectionError(this.analysis,a.observer.spatialReference,w.getLogger(this)))},h.initial),h.watch(()=>[b.state.camera,b.slicePlane,a.viewshed.observer,a.targetRenderSpace,a.verticalFieldOfView,a.horizontalFieldOfView,a.feature],
()=>{this._updateObserverFromFeature(b,a)},h.initial)]);return{viewshedComputedData:a,remove:()=>{this.removeHandles(g);this._removeViewshedsFromRenderer(a);a.destroy()}}});this._analysisVisualization=new A.ViewshedAnalysisVisualization({view:b,analysisViewData:this,isDecoration:!this.parent});this.addHandles([h.watch(()=>this.visible,c=>{var a=this.viewshedComputedDataHandles;null!=a&&(c||(this.selectedViewshed=null),a=a.map(g=>g.viewshedComputedData).filter(g=>g.isValid()).toArray(),c?this._addViewshedsToRenderer(a):
this._removeViewshedsFromRenderer(a))}),h.watch(()=>b.renderCoordsHelper,c=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:a})=>a.renderCoordsHelper=c)}),p.connectAnalysisViewToTool(this,u),h.when(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},h.syncAndInitial)])}destroy(){this._placementTask=m.abortMaybe(this._placementTask);p.removeAnalysisViewTool(this);this._analysisVisualization=m.destroyMaybe(this._analysisVisualization);const b=this.viewshedComputedDataHandles;
null!=b&&this._removeViewshedsFromRenderer(b.map(c=>c.viewshedComputedData).toArray())}async createViewsheds(b){this._placementTask=m.abortMaybe(this._placementTask);this._placementTask=p.activateAnalysisViewTool(this,b);null!=this.tool&&this.tool.createViewsheds();return await this._placementTask.promise}_addViewshedsToRenderer(b){this._viewshedRenderer.updateViewsheds({adds:b})}_removeViewshedsFromRenderer(b){this._viewshedRenderer.updateViewsheds({removes:b})}_updateObserverFromFeature(b,c){const a=
c.observerRenderSpace;var g=c.targetRenderSpace;const k=n.copy(r.create(),a);g={observer:a,observerSurfaceNormal:null,observerAdjusted:k,observerFeatureId:q.getFeatureId(c.feature),target:g,targetSurfaceNormal:null,targetAdjusted:n.copy(r.create(),g),targetFeatureId:null};q.updatePointsFromFeatureReference(b,this._intersector,g,l=>Math.min(l,.05*c.farDistanceRenderSpace));c.observerRenderSpaceOverride=n.exactEquals(k,a)?null:k}_unselectOtherViewsheds(b){if(null!=b)for(const c of this.view.tools.items)c!==
this.tool&&c instanceof u&&(c.analysisViewData.selectedViewshed=null)}get test(){}};e.__decorate([f.property({readOnly:!0})],d.prototype,"type",void 0);e.__decorate([f.property({constructOnly:!0,nonNullable:!0})],d.prototype,"analysis",void 0);e.__decorate([f.property()],d.prototype,"tool",void 0);e.__decorate([f.property()],d.prototype,"_selectedViewshed",void 0);e.__decorate([f.property()],d.prototype,"selectedViewshed",null);e.__decorate([f.property()],d.prototype,"selectedViewshedComputedData",
null);e.__decorate([f.property()],d.prototype,"viewshedComputedDataHandles",void 0);e.__decorate([f.property()],d.prototype,"_analysisVisualization",void 0);e.__decorate([f.property()],d.prototype,"_placementTask",void 0);e.__decorate([f.property()],d.prototype,"_viewshedRenderer",void 0);return d=e.__decorate([x.subclass("esri.views.3d.analysis.ViewshedAnalysisView3D")],d)});