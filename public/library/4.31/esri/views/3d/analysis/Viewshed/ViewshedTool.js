// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../../chunks/tslib.es6 ../../../../geometry ../../../../analysis/Viewshed ../../../../core/handleUtils ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/plane ./ViewshedConfiguration ./ViewshedSubTool ../../interactive/Manipulator3D ../../interactive/editingTools/settings ../../interactive/visualElements/ExtendedLineVisualElement ../../interactive/visualElements/LaserlineVisualElement ../../webgl-engine/lib/intersectorUtilsConversions ../../webgl-engine/lib/Material ../../../interactive/AnalysisToolBase ../../../interactive/keybindings ../../../interactive/ToolIntersector ../../../support/screenUtils ../../../../geometry/Point".split(" "),
function(f,e,z,A,X,v,B,h,g,Y,Z,C,D,m,n,r,E,F,G,H,I,J,K,L,M,w,N,O,P){const t=Symbol("interactionVisuals");e=class extends M.AnalysisToolBase{constructor(a){super(a);this.automaticManipulatorSelection=this.removeIncompleteOnCancel=!1;this._stagedViewshedComputedData=this._stagedViewshed=null;this._creationState=!1;this._interactionVisualElements=null;this._settings=new H.Settings({getTheme:()=>this.view.effectiveTheme});this._selectedManipulator=null}initialize(){this._intersector=N.newToolIntersector(this.view.state.viewingMode);
this._createInteractionVisuals();const a=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=h.mapCollection(()=>a,({viewshedComputedData:b})=>{const c=new F.ViewshedSubTool({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:b});return{subTool:c,remove:()=>{this.selectedViewshed===b.viewshed&&(this.selectedViewshed=null);c.destroy()}}});this.addHandles([h.watch(()=>a?.some(b=>b.viewshedComputedData.isValid()),b=>{b&&
this.finishToolCreation()},h.syncAndInitial),h.watch(()=>this._stagedViewshed,b=>{const c=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null==b||null==c?null:this._findSubTool(b)?.viewshedComputedData},h.syncAndInitial),h.watch(()=>this.firstGrabbedManipulator,b=>{if(null!=b)this.selectedViewshed=this._findSubTool(b)?.viewshed,this._selectManipulator(b);else this._selectedSubTool?.onManipulatorSelectionChanged()},h.sync),h.watch(()=>this.view.activeTool,b=>{b!==
this&&null!=b&&(this.selectedViewshed=null)}),h.when(()=>{const b=this.selectedViewshedComputedData;return null==b?null:{subTool:this._selectedSubTool,observer:b.observerRenderSpace,target:b.targetRenderSpace}},b=>{const {subTool:c,observer:d,target:k}=b;c?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(d,!0):c?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(k,!1)},h.initial),h.watch(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),
h.watch(()=>this.selectedViewshed,b=>{const c=this._selectedManipulator,d=this._selectedSubTool;null==b?this._selectManipulator(null):null!=c&&d.hasManipulator(c)||this._selectManipulator(d.discManipulator)},h.initial)])}destroy(){this.subToolHandles=B.destroyMaybe(this.subToolHandles);this.removeHandles(t)}onDeactivate(){this.removeStaged();this._creationState=!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(a){const b=
this._selectedManipulator;b!==a&&(this._selectedManipulator=a,null!=b&&(b.selected=!1),null!=a&&(a.selected=!0),this._findSubTool(b)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(a){this.analysisViewData.selectedViewshed=a}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:a})=>
a.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}createViewsheds(){this.selectedViewshed=null;this._creationState="placing-observer"}onManipulatorSelectionChanged(){this.subToolHandles.forEach(a=>a.subTool.onManipulatorSelectionChanged())}onInputEvent(a){switch(a.type){case "immediate-double-click":this._doubleClickHandler(a);break;case "pointer-move":this._pointerMoveHandler(a);break;case "key-down":w.sketchKeys.cancel===
a.key?this._cancelKeyHandler(a):w.sketchKeys.delete.includes(a.key)&&this._deleteKeyHandler();break;case "hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(a){switch(a.type){case "immediate-click":this._clickPlacementHandler(a)}}_clickPlacementHandler(a){if(this.creating&&!this.hasFocusedManipulators){var b=this._intersectScreen(a,x);if(null!=b){if("placing-observer"===this._creationState){b.mapPoint.z=(b.mapPoint.z??0)+E.creationVerticalOffset;const c=new z({observer:b.mapPoint.clone(),
feature:b.feature});this.analysis.viewsheds.add(c);this._stagedViewshed=c;this._creationState="placing-target";this._updateStagedViewshed(b.scenePoint)}else"placing-target"===this._creationState&&(this._updateStagedViewshed(b.scenePoint),b=this._stagedViewshed,this._creationState="placing-observer",this._stagedViewshed=null,this.selectedViewshed=b);a.stopPropagation()}}}_doubleClickHandler(a){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,a.stopPropagation())}_pointerMoveHandler(a){this.creating&&
(a=this._intersectScreen(a,x),null!=a&&(this._updateInteractionVisualsLocation(a.scenePoint,!1),this._updateStagedViewshed(a.scenePoint)))}_cancelKeyHandler(a){this.creating?this.removeStaged()?(this._creationState="placing-observer",this.selectedViewshed=null,a.stopPropagation()):this._creationState=!1:this.grabbing||(this.selectedViewshed=null,a.stopPropagation())}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer");null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(a){const b=
this._stagedViewshed;var c=this._stagedViewshedComputedData;if(null!=b&&null!=c){var d=this.view,k=c.observerRenderSpace,l=m.sub(Q,a,k);c=m.len(l)*c.metersPerUnit;d=d.renderCoordsHelper.basisMatrixAtPosition(k,R);var q=m.set(S,d[8],d[9],d[10]),u=r.fromPositionAndNormal(k,q,T);a=r.projectPoint(u,a,U);k=m.sub(a,a,k);l=(1E-4>m.len(k)?90:v.rad2deg(m.angle(l,k)))*(0>m.dot(q,l)?-1:1)+90;a=m.set(y,d[4],d[5],d[6]);a=v.rad2deg(m.angle(a,k));d=m.set(y,d[0],d[1],d[2]);c={heading:0>m.dot(k,d)?360-a:a,tilt:l,
farDistance:c};var {heading:p,tilt:V,farDistance:W}=c;b.farDistance=W;b.tilt=V;b.heading=p}}removeStaged(){return null!=this._stagedViewshed?(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0):!1}_intersectScreen(a,b){a=O.createScreenPointArrayFromEvent(a);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(a,this._intersector);a=this._intersector.results.min;const c=b.scenePoint;if(!a.getIntersectionPoint(c))return null;const d=b.mapPoint;d.spatialReference=
this.view.spatialReference;this.view.renderCoordsHelper.fromRenderCoords(c,d);if(null==d)return null;b.feature=K.toGraphic(a,this.view);return b}_createInteractionVisuals(){this.removeHandles(t);const a=this._settings.visualElements,b=new J.LaserlineVisualElement({view:this.view,attached:!1,style:{glowWidth:a.heightPlane.glowWidth,innerWidth:a.heightPlane.innerWidth},isDecoration:!0}),c=new I.ExtendedLineVisualElement({view:this.view,extensionType:a.zVerticalLine.extensionType,attached:!1,innerWidth:1,
writeDepthEnabled:!1,renderOccluded:L.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:b,verticalLine:c};this.addHandles([h.watch(()=>a.zVerticalLine,d=>d.apply(c),h.syncAndInitial),h.watch(()=>a.heightPlane,d=>d.apply(b),h.syncAndInitial),A.makeHandle(()=>{b.destroy();c.destroy();this._interactionVisualElements=null})],t)}updateInteractionVisualsVisibility(a=!1){var b=this.analysisViewData.visible,c=this._selectedSubTool;const d=this.selectedViewshedComputedData,
k=(q,u)=>{const p=this._interactionVisualElements;null!=p&&(p.verticalLine.attached=u,p.laserline.attached=q)};if(this.creating)k(b,!1);else if(null==c||null==d)k(!1,!1);else{var l=c.moveInteractionState;l=a?l.grabbing:l.dragging;c=c.scaleOrientInteractionState;a=a?c.grabbing:c.dragging;b=b&&(l||a);k(b,l);b&&this._updateInteractionVisualsLocation(l?d.observerRenderSpace:d.targetRenderSpace,l)}}_updateInteractionVisualsLocation(a,b){const c=this._interactionVisualElements;if(null!=c){var {laserline:d,
verticalLine:k}=c;d.heightManifoldTarget=a;d.intersectsWorldUpAtLocation=b?a:null;null!=a&&k.setStartEndFromWorldDownAtLocation(a)}}_findSubTool(a){if(null==a)return null;const b=a instanceof G.Manipulator3D?c=>c.subTool.hasManipulator(a):c=>c.subTool.viewshed===a;return this.subToolHandles?.find(b)?.subTool}get test(){}};f.__decorate([g.property({constructOnly:!0})],e.prototype,"view",void 0);f.__decorate([g.property()],e.prototype,"analysisViewData",void 0);f.__decorate([g.property()],e.prototype,
"removeIncompleteOnCancel",void 0);f.__decorate([g.property()],e.prototype,"automaticManipulatorSelection",void 0);f.__decorate([g.property({constructOnly:!0})],e.prototype,"analysis",void 0);f.__decorate([g.property()],e.prototype,"subToolHandles",void 0);f.__decorate([g.property()],e.prototype,"_stagedViewshed",void 0);f.__decorate([g.property()],e.prototype,"_stagedViewshedComputedData",void 0);f.__decorate([g.property()],e.prototype,"_creationState",void 0);f.__decorate([g.property({readOnly:!0})],
e.prototype,"cursor",null);f.__decorate([g.property()],e.prototype,"_selectedManipulator",void 0);f.__decorate([g.property()],e.prototype,"_selectedSubTool",null);f.__decorate([g.property()],e.prototype,"selectedViewshed",null);f.__decorate([g.property()],e.prototype,"selectedViewshedComputedData",null);f.__decorate([g.property()],e.prototype,"stagedViewshed",null);f.__decorate([g.property()],e.prototype,"grabbing",null);f.__decorate([g.property()],e.prototype,"creating",null);f.__decorate([g.property()],
e.prototype,"isPlacingTarget",null);e=f.__decorate([C.subclass("esri.views.3d.analysis.Viewshed.ViewshedTool")],e);const Q=n.create(),S=n.create(),U=n.create(),y=n.create(),R=D.create(),T=r.create(),x={mapPoint:new P,scenePoint:n.create(),feature:null};return e});