// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../Color ../../../../core/Handles ../../../../core/handleUtils ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/boundedPlane ./ViewshedConfiguration ./viewshedToolUtils ../../interactive/Manipulator3D ../../interactive/RenderObject ../../interactive/editingTools/ManipulatorType ../../interactive/editingTools/manipulations/InteractiveManipulation ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/Material ../../webgl-engine/lib/Util ../../webgl-engine/materials/RibbonLineMaterial ../../../interactive/dragEventPipeline ../../../interactive/interfaces".split(" "),
function(m,F,G,H,n,I,u,k,v,t,l,J,w,x,K,y,z,L,M,N,O,P,Q,A){function B(a,b,c,d=10){O.assert(1<d,"createArcPolylineGeometry() needs at least 2 for numVertices");var e=b-a;if(0>=e||0>=c)return[l.fromValues(0,0,.01),l.fromValues(0,0,-.01)];const f=[];e/=d;for(let h=0;h<d;h++){var g=a+h*e;h===d-1&&(g=b);g=l.fromValues(Math.cos(g)*c-c,0,Math.sin(g)*c);f.push(g)}return f}function R(a){switch(a){case "left":return 0;case "bottom":return 1;case "right":return 2;case "top":return 3}}function C(a){return R(a)*
S}function q(a){return"left"===a||"right"===a}function T(a,{observerRenderSpace:b,targetRenderSpace:c,tiltedUpVector:d,rightVector:e,farDistanceRenderSpace:f}){c=t.sub(D,c,b);a=q(a)?e:d;f=t.scale(U,a,f);return J.fromValues(b,c,f)}class V extends L.InteractiveManipulation{constructor(a){super();this._handles=new G;this._tool=a.tool;this._view=a.view;this._focusedArcMaterial=this._createArcMaterial(!0);this._unfocusedArcMaterial=this._createArcMaterial(!1);this._createManipulators();this.forEachManipulator(b=>
this._tool.manipulators.add(b))}destroy(){this._handles=I.destroyMaybe(this._handles);this.forEachManipulator(a=>{this._tool.manipulators.remove(a);a.destroy()});this._manipulators=this._view=this._tool=null}createDragPipeline(a,b){const c=Object.values(this._manipulators);return H.handlesGroup(c.map(({manipulator:d,side:e})=>Q.createManipulatorDragEventPipeline(d,(f,g,h,r,X)=>{r=T(e,b);g=g.next(W=>({...W,manipulatorType:z.ManipulatorType.SCALE,side:e}));g=x.screenToCircleAngle(g,this._view,r,b);
a(f,g,h)})))}updateManipulatorsTransform(a){a.arcCentersPoints(E);this._forEachManipulatorInfo(b=>this._updateArcManipulatorTransform(b,a,E[b.side]))}updateManipulatorVisuals(a){this._forEachManipulatorInfo(b=>this._updateArcManipulatorVisuals(b,a))}_updateArcManipulatorVisuals({manipulator:a,side:b},c){const d=[];if(null!=c){var e=this._unfocusedArcMaterial;const {horizontalFieldOfView:f,verticalFieldOfView:g}=c;c=q(b);b=n.deg2rad(n.clamp((c?g:f)/2,0,15));c=c?1:Math.max(Math.sin(n.deg2rad(90-g/2)),
.1);b=B(-b/2,b/2,c);e=[M.createPolylineGeometry(e,b),b];const [h,r]=e;d.push(new y.RenderObject(h,A.ManipulatorStateFlags.Unfocused),new y.RenderObject(h.instantiate({material:this._focusedArcMaterial}),A.ManipulatorStateFlags.Focused));a.collisionType={type:"line",paths:[r]}}a.renderObjects=d;a.radius=w.viewshedToolManipulatorConfiguration.collisionRadius}_updateArcManipulatorTransform({manipulator:a,side:b},c,d){var e=c.horizontalFieldOfView,f=n.deg2rad(c.verticalFieldOfView/2);e=n.deg2rad(e/2);
const g=q(b);a.renderLocation=d;d=v.create();k.multiply(d,k.fromYRotation(p,n.deg2rad(-90)),d);g||k.multiply(d,k.fromXRotation(p,f),d);const h=c.farDistanceRenderSpace;k.multiply(d,k.fromScaling(p,t.set(D,h,h,h)),d);k.multiply(d,k.fromZRotation(p,C(b)),d);k.multiply(d,x.getViewshedRotationMatrix(c,p),d);g?(f=e,c=c.tiltedUpVector):c=c.rightVector;b=k.fromRotation(p,f*("right"===b||"bottom"===b?-1:1),c);null!=b&&k.multiply(d,b,d);a.modelTransform=d}_createManipulators(){const a=this._createArcManipulator("left"),
b=this._createArcManipulator("right"),c=this._createArcManipulator("top"),d=this._createArcManipulator("bottom");this._manipulators={left:a,right:b,top:c,bottom:d};[[d.manipulator,c.manipulator],[a.manipulator,b.manipulator]].forEach(([e,f])=>{e.metadata={pairedManipulator:f};f.metadata={pairedManipulator:e}})}_createArcManipulator(a){const b=new K.Manipulator3D({view:this._view,autoScaleRenderObjects:!1,worldSized:!0});a={manipulator:b,side:a};this._updateArcManipulatorVisuals(a);this._handles.add(b.events.on("focus-changed",
c=>{c=b.metadata?.pairedManipulator;null!=c&&(c.hovering!==b.hovering&&(c.hovering=b.hovering),c.grabbing!==b.grabbing&&(c.grabbing=b.grabbing))}));return a}_createArcMaterial(a){a=w.viewshedToolManipulatorConfiguration.getFovArcWidth(a);const b=new P.RibbonLineMaterial({renderOccluded:N.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0,width:a});this._handles.add(u.watch(()=>F.toUnitRGBA(this._view.effectiveTheme.accentColor),c=>b.setParameters({color:c}),u.initial));return b}forEachManipulator(a){Object.values(this._manipulators).forEach(({manipulator:b})=>
a(b,z.ManipulatorType.SCALE))}_forEachManipulatorInfo(a){Object.values(this._manipulators).forEach(b=>a(b))}get test(){return{manipulators:this._manipulators}}}const S=Math.PI/2,p=v.create(),D=l.create(),U=l.create(),E={top:l.create(),bottom:l.create(),left:l.create(),right:l.create()};m.FieldOfViewManipulation=V;m.createArcPolylineVertices=B;m.flipSide=function(a){return"left"===a?"right":"right"===a?"left":"top"===a?"bottom":"top"};m.isSideHorizontal=q;m.sideToRad=C;Object.defineProperty(m,Symbol.toStringTag,
{value:"Module"})});