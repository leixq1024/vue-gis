// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/Cyclical ../../../../core/handleUtils ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/projection ../../../ViewingMode ./FieldOfViewManipulation ./ScaleOrientManipulation ./ViewshedConfiguration ./viewshedToolManipulatorUtils ../../interactive/editingTools/manipulations/config ../../interactive/editingTools/manipulations/MoveManipulation ../../../interactive/dragEventPipeline ../../../interactive/editGeometry/EditGeometryOperations".split(" "),
function(m,n,F,G,H,x,I,V,J,t,z,l,q,W,K,y,L,M,N,v,O,A,P,Q,R,w,S){const B=Symbol("dragHandles"),C=Symbol("hideManipulators"),D=Symbol("hideFoVManipulators"),E=Symbol("hideObserverManipulator");m.ViewshedSubTool=class extends F{constructor(a){super(a);this._forceHoveringTestPromise=this._forceHoveringTask=this._scaleOrientManipulation=this._fieldOfViewManipulation=this._observerManipulator=this._moveManipulation=null;this._grabbing=!1;this.viewshedComputedData=null}initialize(){this._moveManipulation=
this._createMoveManipulation();this._fieldOfViewManipulation=new v.FieldOfViewManipulation({view:this.view,tool:this.parentTool});this._scaleOrientManipulation=new O.ScaleOrientManipulation({view:this.view,tool:this.parentTool});this._observerManipulator=new P.ViewshedObserverManipulator(this.view,this.parentTool);this.addHandles([l.watch(()=>this.viewshedComputedData?.observerRenderSpace,a=>{null!=a&&(this._moveManipulation.renderLocation=a,this._observerManipulator.renderLocation=a)},l.syncAndInitial),
l.watch(()=>this.viewshedComputedData?.heading,a=>{a&&(this._moveManipulation.angle=J.deg2rad(90-a))},l.initial),l.watch(()=>{const {viewshedComputedData:a}=this;return{viewshedComputedData:a,observer:a?.observer}},({viewshedComputedData:a,observer:b},c)=>{this._grabbing&&b!==c?.observer||(this.removeHandles(B),a?.isValid()&&this.addHandles([this._buildObserverDragPipeline(a),this._buildFOVDragPipeline(a),this._buildScaleOrientDragPipeline(a)].filter(G.isSome),B))},l.initial),l.watch(()=>{const a=
this.viewshedComputedData;return a?.isValid()?{viewshedCompData:a,target:a.targetRenderSpace,hFOV:a.horizontalFieldOfView,vFOV:a.verticalFieldOfView}:null},a=>{null!=a&&this._fieldOfViewManipulation.updateManipulatorsTransform(a.viewshedCompData)},l.initial),l.watch(()=>{const a=this.viewshedComputedData;return a?.isValid()?{viewshedCompData:a,hFOV:a.horizontalFieldOfView,vFOV:a.verticalFieldOfView,tilt:a.tilt}:null},a=>{null!=a&&this._fieldOfViewManipulation.updateManipulatorVisuals(a.viewshedCompData)},
l.initial),l.watch(()=>{const a=this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??!1),b=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:a&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:a&&(!this.parentTool.creating||b)}},({fovManipulationAvailable:a,nonFOVManipulationAvailable:b})=>{this._moveManipulation.available=b;this._scaleOrientManipulation.available=b;this._observerManipulator.available=b;this._fieldOfViewManipulation.available=
a},l.initial),l.watch(()=>{const a=this.viewshedComputedData;if(!a?.isValid())return null;const {observer:b,target:c,verticalFieldOfView:d,horizontalFieldOfView:k}=a;return{viewshedCompData:a,observer:b,target:c,verticalFieldOfView:d,horizontalFieldOfView:k}},a=>{null!=a&&this._scaleOrientManipulation.updateManipulators(a.viewshedCompData)},l.initial)]);this._forEachManipulator(a=>{const b=this.analysisViewData;this.addHandles([a.events.on("focus-changed",()=>{const c=this._someManipulatorHovering();
c&&this.parentTool.subToolHandles.forEach(({subTool:d})=>{d._resetHoveringTask()});this._someManipulatorSelected()||c||(this._forceHoveringTask=H.createTask(async d=>{await (this._forceHoveringTestPromise??z.after(A.viewshedToolManipulatorConfiguration.hoverTimeoutMilliseconds,d));z.throwIfAborted(d);this._forceHoveringTask=null;this._updateManipulatorVisibility()}))}),a.events.on("grab-changed",c=>{this._grabbing="start"===c.action;"end"===c.action&&b.tool?.updateInteractionVisualsVisibility();this.parentTool.subToolHandles.forEach(({subTool:d})=>
{d!==this&&d._setInteractive(!this._grabbing)});this._setInteractive(d=>d.hasManipulator(a)||!this._grabbing)}),a.events.on("drag",c=>{"start"===c.action&&b.tool?.updateInteractionVisualsVisibility()})])})}destroy(){this._forceHoveringTask=t.abortMaybe(this._forceHoveringTask);this._moveManipulation=t.destroyMaybe(this._moveManipulation);this._fieldOfViewManipulation=t.destroyMaybe(this._fieldOfViewManipulation);this._scaleOrientManipulation=t.destroyMaybe(this._scaleOrientManipulation);this.parentTool.manipulators.remove(this._observerManipulator);
this._observerManipulator=t.destroyMaybe(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(a){const b=this.viewshed;null!=b&&(b.observer=a)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const {dragging:a,grabbing:b}=this._moveManipulation;return{dragging:a,grabbing:b}}get scaleOrientInteractionState(){const {dragging:a,
grabbing:b}=this._scaleOrientManipulation;return{dragging:a,grabbing:b}}_setInteractive(a){const b="boolean"===typeof a;this._forEachManipulation(c=>c.interactive=b?a:a(c))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility();this._someManipulatorSelected()||(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(a){let b=!1;this._forEachManipulator(c=>{b=b||c===a});return b}_someManipulatorSelected(){return this._moveManipulation.selected||
this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new R.MoveManipulation({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Q.discRadiusSmall})}_buildObserverDragPipeline(a){const b=a.observer;if(null==b)return null;const c=this.view.spatialReference;
return this._moveManipulation.createDragPipeline((d,k,g,e,f)=>{e=e.next(w.resetProperties(this,["observer"]));d=M.tryProjectWithZConversion(b,c);if(null==d)return{steps:g,cancel:e};const h=S.EditGeometryOperations.fromGeometry(d,N.viewingModeFromString(this.view.viewingMode));return{steps:g.next(w.dragManipulatedObject({operations:h})).next(r=>{this.observer=h.data.geometry;return r}),cancel:e}},{mode:"absolute-height",offset:0},c,void 0)}_buildFOVDragPipeline(a){let b=0,c=0;return this._fieldOfViewManipulation.createDragPipeline((d,
k,g)=>{if(null==a)return{steps:k,cancel:g};const e=a.viewshed;let f=null;g=g.next(w.resetProperties(a,["horizontalFieldOfView","verticalFieldOfView"]));return{steps:k.next(h=>{if("start"===h.action)return f=null,b=a.horizontalFieldOfView,c=a.verticalFieldOfView,h;const r=h.deltaAngle;if(null==f&&0!==r){var u="bottom"===h.side||"left"===h.side?0<r:0>r;f=v.isSideHorizontal(h.side)?0===b&&u||360===b&&!u:0===c&&u}u=f?v.flipSide(h.side):h.side;let p=0;switch(u){case "left":p=b/2-r;break;case "right":p=
b/2+r;break;case "top":p=c+2*r;break;case "bottom":p=c-2*r}v.isSideHorizontal(u)?(p=x.cyclicalDegrees.normalize(p),e.horizontalFieldOfView=2*(270<p?0:180<p?180:p)):e.verticalFieldOfView=p;return h}),cancel:g}},a)}_buildScaleOrientDragPipeline(a){let b=0,c=0;const d=(k,g)=>(e,f,h)=>{if(null==a)return{steps:f,cancel:h};e=a.viewshed;h=h.next(w.resetProperties(e,[k]));f=f.next(g(e,a));return{steps:f,cancel:h}};return I.handlesGroup([this._scaleOrientManipulation.createHeadingDragPipeline(d("heading",
(k,g)=>e=>{"start"===e.action&&(c=a.heading);k.heading=x.cyclicalDegrees.normalize(c+e.deltaAngle);return e}),a),this._scaleOrientManipulation.createTiltDragPipeline(d("tilt",(k,g)=>e=>{"start"===e.action&&(b=a.tilt);let f=b+e.deltaAngle;-90>f?f=180:270<f&&(f=0);k.tilt=T.clamp(f);return e}),a),this._scaleOrientManipulation.createDistanceDragPipeline(d("farDistance",(k,g)=>e=>{var f=y.sub(U,e.renderEnd,g.observerRenderSpace);const h=y.len(f)*g.metersPerUnit;f=0>y.dot(f,g.targetDirection)?A.viewshedToolManipulatorConfiguration.scaleOrientMinDistance:
h;k.farDistance=f;return e}),a)])}_updateManipulatorVisibility(){const a=this._someManipulatorSelected(),b=null!=this._forceHoveringTask||this._someManipulatorHovering(),c=this._fieldOfViewManipulation.hovering,d=this.parentTool.creating;let k=[];const g=e=>{k.push(e.disableDisplay())};a||!d&&b?this.removeHandles(C):(this._scaleOrientManipulation.forEachManipulator(g),this._moveManipulation.forEachManipulator(g),this.addHandles(k,C),k=[]);a||!d&&b||d&&c?this.removeHandles(D):(this._fieldOfViewManipulation.forEachManipulator(g),
this.addHandles(k,D));a||!d?this.removeHandles(E):this.addHandles(this._observerManipulator.disableDisplay(),E)}_resetHoveringTask(){this._forceHoveringTask=t.abortMaybe(this._forceHoveringTask);this._updateManipulatorVisibility()}_forEachManipulator(a){this._forEachManipulation(b=>{b.forEachManipulator(a)});a(this._observerManipulator)}_forEachManipulation(a){a(this._moveManipulation);a(this._fieldOfViewManipulation);a(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,
fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:a=>{this._forceHoveringTestPromise=a}}}};n.__decorate([q.property({constructOnly:!0})],m.ViewshedSubTool.prototype,"analysis",void 0);n.__decorate([q.property({constructOnly:!0})],m.ViewshedSubTool.prototype,"analysisViewData",void 0);n.__decorate([q.property({constructOnly:!0})],m.ViewshedSubTool.prototype,"parentTool",
void 0);n.__decorate([q.property({constructOnly:!0,nonNullable:!0})],m.ViewshedSubTool.prototype,"view",void 0);n.__decorate([q.property()],m.ViewshedSubTool.prototype,"viewshed",null);n.__decorate([q.property()],m.ViewshedSubTool.prototype,"_grabbing",void 0);n.__decorate([q.property()],m.ViewshedSubTool.prototype,"grabbing",null);n.__decorate([q.property()],m.ViewshedSubTool.prototype,"viewshedComputedData",void 0);n.__decorate([q.property()],m.ViewshedSubTool.prototype,"observer",null);m.ViewshedSubTool=
n.__decorate([K.subclass("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],m.ViewshedSubTool);const U=L.create(),T=new x.Cyclical(0,180);Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});