// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../../chunks/tslib.es6 ../../../../Color ../../../../core/Accessor ../../../../core/has ../../../../core/lang ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ./ViewshedConfiguration ./ViewshedTool ../../interactive/visualElements/LineVisualElement ../../interactive/visualElements/PointVisualElement ../../interactive/visualElements/ViewshedShapeVisualElement ../../webgl-engine/lib/Material ../../webgl-engine/materials/lineStippleUtils".split(" "),
function(r,A,n,J,C,D,p,u,v,K,E,y,B,m,h,t,F,w,G,H,z,I){function x(b,c,g,a,d,e,l=t.arcAnglePerSegment){var f=h.create();m.sub(f,g,c);var k=m.len(f),q=h.create();m.sub(q,a,c);m.normalize(q,q);m.scale(q,q,k);a=m.angle(f,q);k=h.clone(e);"backward"===d&&(m.negate(k,k),a=-(2*Math.PI-a));d=[];l=Math.ceil(Math.abs(a)/l);e=B.create();y.fromRotation(e,a/l,k);a=h.create();m.copy(a,f);f=h.create();m.copy(f,g);for(g=0;g<l;g++)k=h.create(),m.copy(k,f),m.transformMat4(a,a,e),m.add(f,c,a),q=h.create(),m.copy(q,f),
d.push([k,q]);b.geometry=d}n=class extends n{constructor(b){super(b);this.visible=!0;this._viewshedCorners={topLeft:h.create(),topRight:h.create(),bottomLeft:h.create(),bottomRight:h.create()};this._arcCenterPoints={top:h.create(),bottom:h.create(),left:h.create(),right:h.create()};this._parallelCenters={top:h.create(),bottom:h.create()}}initialize(){const b={view:this.view,isDecoration:!0},c={...b,color:this._color,renderOccluded:z.RenderOccludedFlag.OccludeAndTransparent},g={...c,stipplePattern:I.createStipplePatternSimple(2)};
this._observerVisualElement=new G.PointVisualElement({...b,...t.viewshedVisualizationConfiguration.observerPointConfiguration});this._shapeVisualElement=new H.ViewshedShapeVisualElement(b);this._frameLinesVisualElement=new w.LineVisualElement(c);this._leftArcVisualElement=new w.LineVisualElement(c);this._rightArcVisualElement=new w.LineVisualElement(c);this._topArcVisualElement=new w.LineVisualElement(c);this._bottomArcVisualElement=new w.LineVisualElement(c);this._centralLongitude=new w.LineVisualElement(g);
this._centralLatitude=new w.LineVisualElement(g);this.addHandles([u.watch(()=>{const a=this.viewshedComputedData;if(!a?.isValid())return null;const d=this._viewshedCorners,e=this._arcCenterPoints,l=this._parallelCenters;a.cornerPoints(d);a.arcCentersPoints(e);a.parallelCenterPoints(l);return{viewshedComputedData:a,corners:d,arcCenters:e,parallelCenters:l,interactive:this.analysisViewData.interactive,selected:this._selected}},a=>{const d=null!=a;this._forEachVisualElement(e=>e.attached=d);d&&this._updateVisualElements(a)},
{initial:!0,equals:C.equals}),u.watch(()=>{const {viewshedComputedData:a}=this,{horizontalFieldOfView:d,verticalFieldOfView:e}=a??{};return{viewshedComputedData:a,horizontalFieldOfView:d,verticalFieldOfView:e}},({viewshedComputedData:a})=>{const {_shapeVisualElement:d}=this;a!==d.viewshedComputedData&&(d.viewshedComputedData=a);this._shapeVisualElement.recreateGeometry()},u.initial),u.watch(()=>{const {interactive:a}=this.analysisViewData;return{visible:this.visible,selected:a&&this._selected,staged:a&&
this._staged,horFovNot360:360!==this.viewshedComputedData?.horizontalFieldOfView}},({visible:a,selected:d,staged:e,horFovNot360:l})=>{const f=d||e;this._shapeVisualElement.visible=a;this._topArcVisualElement.visible=a;this._bottomArcVisualElement.visible=a;this._frameLinesVisualElement.visible=a&&l;e=a&&(d||l);this._leftArcVisualElement.visible=e;this._rightArcVisualElement.visible=e;this._forEachLineVisualElement(k=>{k.width=f?t.viewshedVisualizationConfiguration.frameWidthSelected:t.viewshedVisualizationConfiguration.frameWidthNotSelected;
k.renderOccluded=d?z.RenderOccludedFlag.OccludeAndTransparent:z.RenderOccludedFlag.Occlude});[this._centralLatitude,this._centralLongitude].forEach(k=>{k.width=2*(f?t.viewshedVisualizationConfiguration.frameWidthSelected:t.viewshedVisualizationConfiguration.frameWidthNotSelected);k.visible=a&&d})},u.initial),u.watch(()=>{const {analysisViewData:{interactive:a,tool:d},_selected:e,visible:l}=this;var f=this.view.activeTool;f=!d?.active&&f instanceof F?f.creating:!1;return{observerVisible:l&&!e&&(!a||
(d?.creating??!1)||f),color:this._color}},({observerVisible:a,color:d})=>{this._observerVisualElement.visible=a;this._forEachLineVisualElement(e=>e.color=d)},u.initial)])}get _color(){const {viewshedComputedData:b,_selected:c,analysisViewData:g}=this;if(null==b)return A.toUnitRGBA(t.viewshedVisualizationConfiguration.frameColor);const a=b.viewshed===g.tool?.stagedViewshed;return A.toUnitRGBA((g.tool?.active||g.interactive)&&(c||a)?this.view.effectiveTheme.accentColor:t.viewshedVisualizationConfiguration.frameColor)}get _selected(){const {viewshedComputedData:b,
analysisViewData:{selectedViewshedComputedData:c}}=this;return null!=b&&b===c}get _staged(){const {analysisViewData:{tool:b},viewshedComputedData:c}=this;return null!=b&&b.creating&&b.stagedViewshed===c?.viewshed}destroy(){this._observerVisualElement=p.destroyMaybe(this._observerVisualElement);this._shapeVisualElement=p.destroyMaybe(this._shapeVisualElement);this._frameLinesVisualElement=p.destroyMaybe(this._frameLinesVisualElement);this._leftArcVisualElement=p.destroyMaybe(this._leftArcVisualElement);
this._rightArcVisualElement=p.destroyMaybe(this._rightArcVisualElement);this._topArcVisualElement=p.destroyMaybe(this._topArcVisualElement);this._bottomArcVisualElement=p.destroyMaybe(this._bottomArcVisualElement);this._centralLongitude=p.destroyMaybe(this._centralLongitude);this._centralLatitude=p.destroyMaybe(this._centralLatitude)}_forEachLineVisualElement(b){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,
this._centralLatitude,this._centralLongitude].forEach(b)}_forEachVisualElement(b){this._forEachLineVisualElement(b);b(this._observerVisualElement);b(this._shapeVisualElement)}_updateVisualElements(b){const {viewshedComputedData:c,corners:g,arcCenters:a,parallelCenters:d}=b;b=h.clone(c.observerRenderSpace);this._observerVisualElement.geometry=c.observer;this._shapeVisualElement.updateTransform();this._updateFrameLines(b,g);this._updateFrameArcs(c,g,d);this._updateCentralHelperArcs(c,a)}_updateFrameLines(b,
c){this._frameLinesVisualElement.geometry=[[b,c.topLeft],[b,c.topRight],[b,c.bottomLeft],[b,c.bottomRight]]}_updateFrameArcs(b,c,g){const {observerRenderSpace:a,rightVector:d,horizontalFieldOfView:e,tiltedUpVector:l}=b;b=D.deg2rad(e);const f=h.create(),k=B.create();y.fromRotation(k,b/2,l);m.transformMat4(f,d,k);x(this._leftArcVisualElement,a,c.bottomLeft,c.topLeft,"forward",f);y.fromRotation(k,-b/2,l);m.set(f,0,0,0);m.transformMat4(f,d,k);x(this._rightArcVisualElement,a,c.bottomRight,c.topRight,"forward",
f);b=180<e?"backward":"forward";x(this._topArcVisualElement,g.top,c.topRight,c.topLeft,b,l);x(this._bottomArcVisualElement,g.bottom,c.bottomRight,c.bottomLeft,b,l)}_updateCentralHelperArcs(b,c){const g=b.observerRenderSpace;x(this._centralLatitude,g,c.right,c.left,180<=b.horizontalFieldOfView?"backward":"forward",b.tiltedUpVector);x(this._centralLongitude,g,c.top,c.bottom,"forward",b.leftVector)}get test(){}};r.__decorate([v.property()],n.prototype,"view",void 0);r.__decorate([v.property()],n.prototype,
"analysisViewData",void 0);r.__decorate([v.property()],n.prototype,"viewshedComputedData",void 0);r.__decorate([v.property()],n.prototype,"visible",void 0);r.__decorate([v.property()],n.prototype,"_color",null);r.__decorate([v.property()],n.prototype,"_selected",null);r.__decorate([v.property()],n.prototype,"_staged",null);return n=r.__decorate([E.subclass("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],n)});