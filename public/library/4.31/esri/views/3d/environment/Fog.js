// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../core/mathUtils ../../../core/reactiveUtils ../../../core/Logger ../../../core/has ../../../core/RandomLCG ../../../core/Error ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../geometry/ellipsoidUtils ../webgl ../../../chunks/Fog.glsl ./FogTechnique ./weather ../webgl-engine/effects/TransparentEnvironment ../webgl-engine/lib/basicInterfaces".split(" "),function(f,r,g,e,
C,D,E,F,t,d,h,u,v,w,l,m,x,n){f.Fog=class extends x.TransparentEnvironment{constructor(a){super(a);this.requireGeometryDepth=!0;this._newParameters=new k;this._oldParameters=new k;this._fadedParameters=new k;this._parameters=this._newParameters;this._passParameters=new w.FogPassParameters;const {view:b,techniques:c}=a;a=u.getReferenceEllipsoid(b.spatialReference);this._planetRadius=a.radius;this._atmosphereRadius=a.radius+a.atmosphereHeight;c.precompile(l.FogTechnique)}toogle(){this.view.environment.atmosphereEnabled&&
this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([e.watch(()=>this.view.environment.atmosphereEnabled,()=>this.toogle(),e.syncAndInitial),e.watch(()=>this.view.environment.weather,()=>this.toogle(),e.syncAndInitial),e.watch(()=>this._updateFogParameters(),()=>{},e.syncAndInitial)]);this.addHandles(e.watch(()=>this._fadeFactor,a=>this._fade(a),e.syncAndInitial))}get _fadeFactor(){return this.view._stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(a){const {_newParameters:b,
_oldParameters:c}=this;1<=a?(this._parameters=b,this._oldParameters.copyFrom(this._newParameters)):0>=a?this._parameters=c:(this._fadedParameters.lerp(c,b,a),this._parameters=this._fadedParameters)}_updateFogParameters(){const a=this.view.environment.weather,b="foggy"===a.type||"snowy"===a.type||"rainy"===a.type;this._newParameters.strength="foggy"===a.type?g.lerp(3E-5,.005,a.fogStrength**3):"snowy"===a.type||"rainy"===a.type?g.lerp(4E-6,2E-4,(a.precipitation??0)**3):0;this._newParameters.amount=
b?1:0;"foggy"!==a.type&&"snowy"!==a.type||d.copy(this._newParameters.color,y);"rainy"===a.type&&d.copy(this._newParameters.color,z);1<=this._fadeFactor&&this._oldParameters.copyFrom(this._newParameters);this.requestRender(n.RenderRequestType.UPDATE)}render(a){a=a.find(({name:A})=>A===v.InternalRenderCategory.TRANSPARENT_ENVIRONMENT);if(0===this._parameters.amount)return a;this._update();if(0>=this._passParameters.amount)return a;const b=this.techniques.acquire(l.FogTechnique);if(!b.compiled)return this.requestRender(n.RenderRequestType.UPDATE),
b.release(),a;const c=this.renderingContext,B=a.getAttachment(c.gl.DEPTH_STENCIL_ATTACHMENT);a.attachDepth(null);c.bindFramebuffer(a.fbo);c.bindTechnique(b,this.bindParameters,this._passParameters);c.screen.draw();a.attachDepth(B);b.release();return a}_update(){var a=this.bindParameters.camera;d.normalize(p,a.eye);const b=Math.max(0,d.dot(p,this.bindParameters.lighting.mainLight.direction)),c=this._parameters.color;d.scale(q,c,.1);d.lerp(this._passParameters.color,q,c,b);a=d.length(a.eye);this._passParameters.atmosphereC=
a**2-this._atmosphereRadius**2;this._passParameters.amount=(1-g.smoothstep(.95*m.heightLimit,1*m.heightLimit,Math.abs(a-this._planetRadius)))*this._parameters.amount;this._passParameters.strength=this._parameters.strength}};f.Fog=r.__decorate([t.subclass("esri.views.3d.environment.Fog")],f.Fog);class k{constructor(){this.color=h.create();this.amount=this.strength=0}copyFrom(a){this.amount=a.amount;this.strength=a.strength;d.copy(this.color,a.color)}lerp(a,b,c){this.amount=g.lerp(a.amount,b.amount,
c);this.strength=g.lerp(a.strength,b.strength,c);d.lerp(this.color,a.color,b.color,c)}}const p=h.create(),q=h.create(),z=h.fromValues(.5,.5,.5),y=h.fromValues(1.5,1.5,1.5);f.FogParameters=k;Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});