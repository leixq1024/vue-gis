// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../geometry ../../../core/Evented ../../../core/has ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../geometry/projection ../../../geometry/projection/projectPointToVector ../../../geometry/support/planetGCSUtils ../../../geometry/support/spatialReferenceUtils ../../ViewingMode ./EnvironmentRenderer ../support/earthUtils ../support/sunUtils ../webgl-engine/lib/Update ../webgl-engine/lighting/Lightsources ../../../geometry/SpatialReference".split(" "),
function(f,h,H,x,I,y,e,l,J,K,z,m,q,A,B,u,C,D,E,v,n,r,t,w){f.EnvironmentManager=class extends x.EventedAccessor{constructor(){super();this._tmpLightParameters=new n.ColorAndIntensity;this._defaultLightParameters=new n.ColorAndIntensity;this._tmpDate=new Date;this._tmpTz={hours:0,minutes:0,seconds:0};this._viewHandlesKey="viewHandles";this._trackingEnabled=!1;this._mainLight=new t.MainLight;this._ambientLight=new t.AmbientLight;this._moonLight=new t.FillLight;this._disableWeather=this._disableProjectionEngineAutoLoad=
!1;this._referencePositionGeographic=this._renderer=null;this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===D.ViewingMode.Global&&C.isEarth(this._view.spatialReference)}get weatherVisible(){return this.weatherEnabled&&this._renderer?.weatherVisible}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){const a=
this._view?.stateManager?.camera?.position?.spatialReference??w.WGS84,d=u.getGCSForPlanet(a);return this._disableProjectionEngineAutoLoad||A.isLoadedOrLoadFor(a,d)}connectView(a){if(!this._renderer){this._renderer=new E.EnvironmentRenderer({view:a});var d=()=>this._updateRenderParameters(),b=()=>this._cameraHandler();this.addHandles([e.watch(()=>a.environment.lighting,c=>this._updateLightingHandler(c),e.sync),e.watch(()=>"virtual"!==a.environment.lighting.type?a.environment.lighting.date:null,c=>
this._lightingDateHandler(c),e.sync),e.watch(()=>a.environment.lighting.directShadowsEnabled,d,e.sync),e.watch(()=>a.qualitySettings.ambientOcclusion,d,e.sync),e.watch(()=>a.qualitySettings.reflections,d,e.sync),e.watch(()=>a.spatialReference,()=>this._resetReferencePosition(!0),e.sync),e.watch(()=>a.environment.weather.type,()=>this._updateLighting(null,r.Update.FadeWithWeather),e.sync),e.watch(()=>this.weatherEnabled,()=>this._updateLighting(null,r.Update.FadeWithWeather),e.sync),e.watch(()=>a.viewingMode,
()=>this._resetReferencePosition(!0),e.syncAndInitial),e.watch(()=>"virtual"!==a.environment.lighting.type?a.environment.lighting.cameraTrackingEnabled:!1,c=>this._updateCameraTracking(c),e.syncAndInitial),e.watch(()=>a.state.camera,b,e.syncAndInitial),e.when(()=>this._canProjectCameraPosition,b,e.sync)],this._viewHandlesKey);this._updateRenderParameters();this._updateLighting();this._cameraHandler();this.notifyChange("updating")}}disconnectView(){this.removeHandles(this._viewHandlesKey);this._resetReferencePosition();
this._renderer=y.destroyMaybe(this._renderer)}_updateLightingHandler(a){this._updateCameraTracking("virtual"!==a.type?a.cameraTrackingEnabled:!1);this._lightingDateHandler("virtual"!==a.type?a.date:null);this._updateRenderParameters()}_updateCameraTracking(a){(this._trackingEnabled=a)?this._cameraHandler():(a=this._view.environment.lighting,"virtual"!==a?.type&&(a.positionTimezoneInfo.autoUpdated=!1))}_lightingDateHandler(a){const d=this._view.environment.lighting;if("virtual"===d?.type)this._updateLighting();
else if(a){if(!d.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(a),null!=this._referencePositionGeographic)){const b=v.positionToTimezoneInfo(this._referencePositionGeographic,this._tmpTz);null!=b&&(d.autoUpdate(null,b),this._trackingEnabled&&(d.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(a)}}_preupdateTracking(a){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(a)}_cameraHandler(a=
null){var d=this._view;if(d.ready&&(d=d.stateManager.camera)){({position:d}=d);var b=u.getGCSForPlanet(d.spatialReference??w.WGS84),c=this._referencePositionGeographic??q.create();B.projectPointToVector(d,c,b)?(this._referencePositionGeographic=c,this.notifyChange("referencePositionGeographic"),this._autoUpdateTimezone(c,a)||this._updateLighting(a)):(this._referencePositionGeographic=null,this._updateLighting())}}_updateLighting(a,d=r.Update.Immediate){var b=this._view,{lighting:c}=b.environment,
k="virtual"===c.type;const p=this._referencePositionGeographic,g=null!=p?this._tmpLightParameters:this._defaultLightParameters;p?(a??=k?null:c.date,n.computeColorAndIntensity(a,p,b.state.viewingMode,this.weatherVisible?b.environment.weather.type:"disabled",b.state.camera,g)):k&&n.computeVirtualLightDirection(b.state.camera,b.state.viewingMode,g.direct.directionToLightSource);a=this._mainLight;b=g.direct;m.scale(a.intensity,b.color,b.intensity*Math.PI);m.copy(a.direction,b.directionToLightSource);
a.specularStrength=g.specularStrength;a.environmentStrength=g.environmentStrength;c=this._ambientLight;m.scale(c.intensity,g.ambient.color,g.ambient.intensity);k=this._moonLight;m.lerp(k.intensity,F,G,g.globalFactor);m.scale(k.intensity,k.intensity,(1-.5*g.globalFactor)*(1-.4*g.noonFactor*(1-g.globalFactor)));m.copy(k.direction,b.directionToLightSource);this._view._stage.renderer.updateLighting([a,c,k],g.noonFactor,g.globalFactor,d);this._updateRenderParameters()}_autoUpdateTimezone(a,d=null){if("virtual"===
this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==a)return!1;const b=this._tmpDate;b.setTime((d||this._view.environment.lighting.date).getTime());a=v.positionToTimezoneInfo(a,this._tmpTz);if(null==a)return!1;var c=this._view.environment.lighting.positionTimezoneInfo;if(!c.autoUpdated)c=a;else if(c.hours===a.hours&&c.minutes===a.minutes&&c.seconds===a.seconds)return!1;const k=b.getUTCHours()-(a.hours-c.hours),p=b.getUTCMinutes()-(a.minutes-c.minutes);
c=b.getUTCSeconds()-(a.seconds-c.seconds);b.setUTCHours(k);b.setUTCMinutes(p);b.setUTCSeconds(c);return d?!1:this._view.environment.lighting.autoUpdate(b,a)}_updateRenderParameters(){const a=this._view._stage;if(a){var d=null==this._referencePositionGeographic||n.computeShadowsEnabled(this._referencePositionGeographic[2],this._view.state.viewingMode);a.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&d,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,
qualitySettings:this._view.qualitySettings})}}_resetReferencePosition(a=!1){this._referencePositionGeographic=null;a&&this._cameraHandler()}get test(){}};h.__decorate([l.property({type:Boolean,readOnly:!0})],f.EnvironmentManager.prototype,"updating",null);h.__decorate([l.property()],f.EnvironmentManager.prototype,"_disableProjectionEngineAutoLoad",void 0);h.__decorate([l.property()],f.EnvironmentManager.prototype,"_disableWeather",void 0);h.__decorate([l.property()],f.EnvironmentManager.prototype,
"weatherEnabled",null);h.__decorate([l.property()],f.EnvironmentManager.prototype,"weatherVisible",null);h.__decorate([l.property()],f.EnvironmentManager.prototype,"referencePositionGeographic",null);h.__decorate([l.property()],f.EnvironmentManager.prototype,"_renderer",void 0);h.__decorate([l.property()],f.EnvironmentManager.prototype,"_referencePositionGeographic",void 0);h.__decorate([l.property()],f.EnvironmentManager.prototype,"_canProjectCameraPosition",null);f.EnvironmentManager=h.__decorate([z.subclass("esri.views.3d.environment.EnvironmentManager")],
f.EnvironmentManager);const F=q.fromValues(.22,.22,.33),G=q.fromValues(.22,.22,.22);Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});