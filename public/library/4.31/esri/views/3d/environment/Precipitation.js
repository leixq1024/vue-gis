// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../geometry/ellipsoidUtils ../webgl ./PrecipitationTechnique ./PrecipitationTechniqueConfiguration ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl/RenderNode ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/VertexArrayObject ../webgl-engine/lib/VertexAttribute ../../webgl/BufferObject ../../webgl/enums ../../webgl/Util".split(" "),
function(f,h,r,t,d,A,l,I,J,K,B,C,m,n,p,u,v,D,E,F,w,x,q,y){function G(a,b){const c=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new F.VertexArrayObject(a,b,new Map([["geometry",u.glLayout(H)]]),new Map([["geometry",x.BufferObject.createVertex(a,q.Usage.STATIC_DRAW,c)]]))}f.Precipitation=class extends D{constructor(a){super(a);this.consumes={required:[m.InternalRenderCategory.TRANSPARENT_ENVIRONMENT]};this.produces=m.InternalRenderCategory.TRANSPARENT_ENVIRONMENT;this._rainSpeed=.1;this._snowSpeed=
.01;this._numParticles=0;this._passParameters=new n.PrecipitationPassParameters;this._configuration=new p.PrecipitationTechniqueConfiguration;const {view:b,type:c,techniques:e}=a;this._configuration.type="rainy"===c?p.PrecipitationType.Rain:p.PrecipitationType.Snow;e.precompile(n.PrecipitationTechnique,this._configuration);this._passParameters.time=0;this._passParameters.radius=C.getReferenceEllipsoid(b.spatialReference).radius;this.addHandles(d.watch(()=>b.environment.weather,g=>{g.type===c&&this.addHandles(d.watch(()=>
g.precipitation,k=>this._adjustParticles(k),d.syncAndInitial))},d.syncAndInitial));this.addHandles(d.watch(()=>b._stage?.renderer.renderContext.bind.clouds.fadeFactor??1,g=>{this._passParameters.opacity=g;1===g&&(this.removeHandles("opacity"),this.addHandles(d.watch(()=>b._stage?.renderer.renderContext.bind.clouds.opacity??1,k=>this._passParameters.opacity=k,d.syncAndInitial),"opacity"))},d.sync),"opacity")}_adjustParticles(a){this._numParticles=25E4*(.5>a?r.lerp(0,.35,2*a):r.lerp(.35,1,2*(a-.5)))}destroy(){this._numParticles=
0;this._vao=t.disposeMaybe(this._vao);this._instanceIdBuffer=t.disposeMaybe(this._instanceIdBuffer)}fadeOut(a){this.removeAllHandles();this.addHandles(d.watch(()=>this.renderContext?.bind.clouds.fadeFactor??1,b=>{this._passParameters.opacity=1-b;1===b&&(this.removeAllHandles(),a())}),"opacity")}updateAnimation(a){a=("rainy"===this.type?this._rainSpeed:this._snowSpeed)*A.secondsFromMilliseconds(a.time)%1E5;if(this._passParameters.time===a)return!1;this._passParameters.time=a;return!0}render(a){const b=
this.renderingContext;this._instanceIdBuffer??(this._instanceIdBuffer=this._createInstanceIndices(b));const c=Math.round(this._numParticles*this._passParameters.opacity);a=a.find(({name:k})=>k===m.InternalRenderCategory.TRANSPARENT_ENVIRONMENT);if(1>c)return a;const e=this.techniques.acquire(n.PrecipitationTechnique,this._configuration);if(!e.compiled)return e.release(),this.requestRender(E.RenderRequestType.UPDATE),a;const g=b.bindTechnique(e,this.bindParameters,this._passParameters);this._vao??
(this._vao=G(b,e.locations));b.bindVAO(this._vao);g.assertCompatibleVertexAttributeLocations(this._vao);y.bindVertexBufferLayout(b,e.locations,this._instanceIdBuffer,z,0);b.drawArraysInstanced(q.PrimitiveType.TRIANGLES,0,3,c);y.unbindVertexBufferLayout(b,e.locations,this._instanceIdBuffer,z);e.release();return a}_createInstanceIndices(a){const b=[];for(let c=0;25E4>c;c++)b.push(c);return x.BufferObject.createVertex(a,q.Usage.STATIC_DRAW,new Float32Array(b))}};h.__decorate([l.property()],f.Precipitation.prototype,
"consumes",void 0);h.__decorate([l.property()],f.Precipitation.prototype,"produces",void 0);h.__decorate([l.property({constructOnly:!0})],f.Precipitation.prototype,"type",void 0);h.__decorate([l.property({constructOnly:!0})],f.Precipitation.prototype,"techniques",void 0);f.Precipitation=h.__decorate([B.subclass("esri.views.3d.environment.Precipitation")],f.Precipitation);const H=v.newLayout().vec3f(w.VertexAttribute.POSITION),z=u.glLayout(v.newLayout().f32(w.VertexAttribute.INSTANCEFEATUREATTRIBUTE),
1);Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});