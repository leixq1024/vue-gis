// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../core/compilerUtils ../../../core/mathUtils ../../../core/signal ../../../core/libs/gl-matrix-2/math/mat4 ../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../geometry/support/axisAngleDegrees ../../../geometry/support/Ellipsoid ./Clouds ./weather".split(" "),function(a,u,v,m,q,n,c,k,h,p,e,l){class w{constructor(){this.startTime=0;this._data=m.signal(null);this._readChannels=e.CloudsTextureChannels.RG;
this.parallax=new r;this.parallaxNew=new r;this._anchorPoint=k.create();this._fadeState=m.signal(a.FadeState.HIDE);this._fadeFactor=m.signal(1)}get data(){return this._data.value}set data(b){this._data.value=b}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case a.FadeState.HIDE:return 0;case a.FadeState.FADE_OUT:return 1-this.fadeFactor;case a.FadeState.FADE_IN:return this.fadeFactor;
case a.FadeState.SHOW:case a.FadeState.CROSS_FADE:return 1}}fade(b,d,f){this.isFading&&1>this.fadeFactor&&(this._fadeFactor.value=f?v.clamp((d-this.startTime)/(1.25*f),0,1):1,1===this.fadeFactor&&this._endFade());this._evaluateState(b,d);this._updateParallax(b)}_evaluateState(b,d){const f=b.relativeElevation;b=this._updateAnchorPoint(b);(f>1.7*l.heightLimit||f<-l.heightLimit||2E5<b)&&0<this.opacity?this._startFade(a.FadeState.HIDE,d):this.isFading||(f>l.heightLimit||f<-.35*l.heightLimit||1E5<b?0<
this.opacity&&this._startFade(a.FadeState.FADE_OUT,d):e.ensureClouds(this.data)&&(0===this.opacity?this._startFade(a.FadeState.FADE_IN,d):this.data.state===e.CubeMapState.Ready&&(this.fadeState===a.FadeState.SHOW?this._startFade(a.FadeState.CROSS_FADE,d):this._startFade(a.FadeState.SHOW,d))))}_updateParallax(b){b=c.squaredLength(b.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(b-p.earth.radius*p.earth.radius,0))/Math.sqrt(b);h.fromPoints(t,this.parallax.anchorPoint,g);q.rotate(this.parallax.transform,
n.IDENTITY,g[3],h.axis(g));h.fromPoints(t,this.parallaxNew.anchorPoint,g);q.rotate(this.parallaxNew.transform,n.IDENTITY,g[3],h.axis(g))}_updateAnchorPoint(b){c.normalize(this._anchorPoint,b.eye);c.scale(this._anchorPoint,this._anchorPoint,p.earth.radius);return this.fadeState===a.FadeState.HIDE&&this.data?.state===e.CubeMapState.Ready?(c.copy(this.parallax.anchorPoint,this._anchorPoint),0):c.length(c.subtract(x,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(b,
d){this._fadeState.value=b;this.startTime=d;switch(b){case a.FadeState.CROSS_FADE:this.requestFade();this._switchReadChannels();c.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case a.FadeState.FADE_IN:this.requestFade();this._switchReadChannels();c.copy(this.parallax.anchorPoint,this._anchorPoint);c.copy(this.parallaxNew.anchorPoint,this._anchorPoint);break;case a.FadeState.FADE_OUT:this.requestFade();break;case a.FadeState.SHOW:this._switchReadChannels();c.copy(this.parallax.anchorPoint,
this._anchorPoint);c.copy(this.parallaxNew.anchorPoint,this._anchorPoint);this._endFade();break;case a.FadeState.HIDE:this._endFade()}}_endFade(){this._fadeFactor.value=1;this.data&&this.data.state!==e.CubeMapState.Ready&&(this.data.state=e.CubeMapState.Idle);switch(this.fadeState){case a.FadeState.CROSS_FADE:c.copy(this.parallax.anchorPoint,this.parallaxNew.anchorPoint);this._fadeState.value=a.FadeState.SHOW;break;case a.FadeState.FADE_IN:this._fadeState.value=a.FadeState.SHOW;break;case a.FadeState.FADE_OUT:this._fadeState.value=
a.FadeState.HIDE;break;case a.FadeState.SHOW:case a.FadeState.HIDE:break;default:u.neverReached(this.fadeState)}}_switchReadChannels(){this.data?.state===e.CubeMapState.Ready&&(this._readChannels=1-this._readChannels,this.data.state=e.CubeMapState.Fading)}get isFading(){return this.fadeState===a.FadeState.FADE_OUT||this.fadeState===a.FadeState.FADE_IN||this.fadeState===a.FadeState.CROSS_FADE}}a.FadeState=void 0;(function(b){b[b.HIDE=0]="HIDE";b[b.FADE_IN=1]="FADE_IN";b[b.SHOW=2]="SHOW";b[b.CROSS_FADE=
3]="CROSS_FADE";b[b.FADE_OUT=4]="FADE_OUT"})(a.FadeState||(a.FadeState={}));class r{constructor(){this.anchorPoint=k.create();this.radiusCurvatureCorrection=0;this.transform=n.create()}}const t=k.fromValues(0,0,1),g=h.create(),x=k.create();a.CloudsParameters=w;Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});