// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/Logger ../../../core/has ../../../core/RandomLCG ../../../core/Error ../../../core/accessorSupport/decorators/subclass ../../../core/libs/gl-matrix-2/math/mat4 ../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../core/libs/gl-matrix-2/math/vec2 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../geometry/ellipsoidUtils ../../../geometry/support/FloatArray ../webgl ./atmosphereUtils ../../../chunks/SimpleAtmosphere.glsl ./SimpleAtmosphereTechnique ./SimpleAtmosphereTechniqueConfiguration ./resources/MarsAtmosphereTexture ../support/mathUtils ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/effects/OpaqueEnvironment ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/DefaultVertexAttributeLocations ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/Util ../webgl-engine/lib/VertexArrayObject ../webgl-engine/lib/VertexAttribute ../../webgl/BufferObject ../../webgl/enums ../../webgl/Texture ../../webgl/TextureDescriptor ../../webgl/Util".split(" "),
function(G,x,u,y,m,ca,da,ea,H,I,J,K,h,v,L,M,N,z,O,n,p,P,Q,R,S,T,A,U,V,B,W,X,Y,q,Z,aa,C){function D(b,c,a,f,d){const g=h.length(b),e=f*Math.sqrt(g*g-f*f)/g,k=d.v1,r=d.v2;h.scale(d.center,b,Math.sqrt(f*f-e*e)/g);h.cross(k,b,c);1>h.squaredLength(k)&&h.cross(k,b,a);h.scale(k,k,e/h.length(k));h.cross(r,k,b);h.scale(r,r,e/h.length(r));return e}const E=-z.innerAtmosphereDepth,ba=Q.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5E3,.51171875],[5E4,.4140625]]);m=class extends T.OpaqueEnvironment{constructor(b){super(b);
this._passParameters=new O.SimpleAtmospherePassParameters;this._configuration=new p.SimpleAtmosphereTechniqueConfiguration;this._vao=null;this._vaoCount=0;this._fadeVao=null;this._fadeVaoCount=0;this._texV1=1;const {view:c,techniques:a}=b;b=L.getReferenceEllipsoid(c.spatialReference);const {outerAtmosphereRimWidth:f,radius:d}=b;this._planetRadius=d;this._innerRimFactor=1+E/d;this._middleRimFactor=1+0/d;this._outerRimFactor=1+f/d;this._texV0=0/f;this._texVScale=this._texV1-this._texV0;a.precompile(n.SimpleAtmosphereTechnique,
this._configuration);this._configuration.geometry=p.SimpleAtmosphereGeometry.Underground;a.precompile(n.SimpleAtmosphereTechnique,this._configuration)}initialize(){this.addHandles(y.watch(()=>this.view.environment.atmosphereEnabled,b=>b?this._enable():this._disable(),y.initial))}destroy(){this._passParameters.texture=u.disposeMaybe(this._passParameters.texture);this._fadeVao=u.disposeMaybe(this._fadeVao);this._vao=u.disposeMaybe(this._vao)}render(b){b=b.find(({name:f})=>f===N.InternalRenderCategory.OPAQUE_ENVIRONMENT);
this._update();const c=this.renderingContext;if(!this._passParameters.texture){var a=new aa.TextureDescriptor;a.wrapMode=q.TextureWrapMode.CLAMP_TO_EDGE;a.flipped=!0;a.width=1;a.height=512;this._passParameters.texture=new Z.Texture(c,a,P.marsAtmosphereTextureSimple)}if(1>this._passParameters.undergroundFadeAlpha){this._vao||(this._vao=this._createRibbon(c),this._vaoCount=C.vertexCount(this._vao,"geometry"));this._configuration.geometry=p.SimpleAtmosphereGeometry.Cone;a=this.techniques.acquire(n.SimpleAtmosphereTechnique,
this._configuration);if(!a.compiled)return a.release(),this.requestRender(A.RenderRequestType.UPDATE),b;c.bindTechnique(a,this.bindParameters,this._passParameters);c.bindVAO(this._vao);c.drawArrays(q.PrimitiveType.TRIANGLES,0,this._vaoCount);a.release()}if(0<this._passParameters.undergroundFadeAlpha){this._fadeVao||(this._fadeVao=V.createQuadVAO(c),this._fadeVaoCount=C.vertexCount(this._fadeVao,"geometry"));this._configuration.geometry=p.SimpleAtmosphereGeometry.Underground;a=this.techniques.acquire(n.SimpleAtmosphereTechnique,
this._configuration);if(!a.compiled)return a.release(),this.requestRender(A.RenderRequestType.UPDATE),b;c.bindTechnique(a,this.bindParameters,this._passParameters);c.bindVAO(this._fadeVao);c.drawArrays(q.PrimitiveType.TRIANGLE_STRIP,0,this._fadeVaoCount);a.release()}return b}_update(){var b=this.bindParameters.camera,c=v.create();const a=this._planetRadius;var f=h.length(b.eye);const d=f-a;this._passParameters.undergroundFadeAlpha=0>d?Math.min(-d/5E3,1):0;var g=a+E,e=a+Math.max(50,d);this._passParameters.innerScale=
e*e/(Math.sqrt(e*e-a*a)*Math.sqrt(e*e-g*g)+a*g)-1;this._passParameters.altitudeFade=z.computeInnerAltitudeFade(d);h.scale(c,b.eye,(a+50)/f);D(c,b.center,b.up,a,this._passParameters.silhouette);c=this._computeScreenRimWidth(b,c,b.up,this._passParameters.silhouette);f=ba(d);g=this._texV0+.001953125*this._texVScale;e=this._texV0+c*f*this._texVScale;50<d&&(D(b.eye,b.center,b.up,a,this._passParameters.silhouette),b=this._computeScreenRimWidth(b,b.eye,b.up,this._passParameters.silhouette),b=x.clamp((b-
1.5)/(c-1.5),0,1),g=this._texV0+.001953125*b*this._texVScale,e=this._texV0+x.lerp(this._texV1,c*f,b)*this._texVScale);K.set(this._passParameters.texV,g,e)}_createRibbon(b){const c=M.newFloatArray(1155),a=new Uint32Array(1920);c[0]=0;c[1]=0;c[2]=-1;for(var f=0;128>f;f++){var d=9*f+3;c[d]=f;c[d+1]=this._innerRimFactor;c[d+2]=-1;c[d+3]=f;c[d+4]=this._middleRimFactor;c[d+5]=0;c[d+6]=f;c[d+7]=this._outerRimFactor;c[d+8]=1;d=3*f+1;var g=127===f?1:d+3,e=15*f;a[e]=d;a[e+1]=d+1;a[e+2]=g+1;a[e+3]=g+1;a[e+4]=
g;a[e+5]=d;a[e+6]=d+1;a[e+7]=d+2;a[e+8]=g+2;a[e+9]=g+2;a[e+10]=g+1;a[e+11]=d+1;a[e+12]=d;a[e+13]=g;a[e+14]=0}f=F.createBuffer(a.length);d=f.position;for(g=0;g<a.length;++g)e=3*a[g],d.set(g,0,c[e]),d.set(g,1,c[e+1]),d.set(g,2,c[e+2]);return new W.VertexArrayObject(b,U.Default3D,new Map([["geometry",R.glLayout(F)]]),new Map([["geometry",Y.BufferObject.createVertex(b,q.Usage.STATIC_DRAW,f.buffer)]]))}_computeScreenRimWidth(b,c,a,f){h.add(l,f.center,f.v2);h.scale(t,l,this._outerRimFactor);I.lookAt(w,
c,l,a);B.project(l,w,b.projectionMatrix,b.viewport,l);B.project(t,w,b.projectionMatrix,b.viewport,t);return h.distance(l,t)/b.height}};m=G.__decorate([H.subclass("esri.views.3d.environment.MarsAtmosphere")],m);const w=J.create(),l=v.create(),t=v.create(),F=S.newLayout().vec3f(X.VertexAttribute.POSITION);return m});