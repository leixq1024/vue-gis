// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/has ../../../../core/MapUtils ../../../../core/PooledArray ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../chunks/sphere ../../terrain/Intersector ../core/shaderLibrary/ShaderOutput ../effects/RenderPlugin ./ChangeSet ./Intersector ./IntersectorInterfaces ./Material ./ModelDirtyTypes ./rendererUtils ./RenderSlot ../materials/renderers/MergedRenderer".split(" "),
function(g,h,w,L,q,x,l,M,N,y,z,A,B,r,C,D,E,n,F,m,G,t,H){function I(a,b,c,e,d,f,k){const u=new B.OverlayTarget(f,k,b);b=v=>{v.set(n.IntersectorType.OVERLAY,u,a.dist,a.normal,a.transformation,c,e)};(null==d.results.min.drapedLayerOrder||c>=d.results.min.drapedLayerOrder)&&(null==d.results.min.dist||d.results.ground.dist<=d.results.min.dist)&&b(d.results.min);d.options.store!==n.StoreResults.MIN&&(null==d.results.max.drapedLayerOrder||c<d.results.max.drapedLayerOrder)&&(null==d.results.max.dist||d.results.ground.dist>
d.results.max.dist)&&b(d.results.max);d.options.store===n.StoreResults.ALL&&(f=E.newIntersectorResult(d.ray),b(f),d.results.all.push(f))}g.SortedRenderGeometryRenderer=class extends w{constructor(a){super(a);this._pending=new J;this._changes=new D.ChangeSet;this._renderers=new Map;this._sortedRenderers=new x;this._geometries=new Map;this._hasWater=this._hasHighlights=!1}destroy(){this._changes.prune();this._renderers.forEach(a=>a.destroy());this._renderers.clear();this._sortedRenderers.clear();this._geometries.clear();
this._pending.clear()}get updating(){return!this._pending.empty||0<this._changes.updates.length}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(const a of this._renderers.values())if(0!==a.numGeometries&&!a.queryRenderOccludedState(F.RenderOccludedFlag.Occlude))return!0;
return!1}get isEmpty(){return!this.updating&&0===this._renderers.size&&0===this._geometries.size}getMaterialRenderer(a){return this._renderers.get(a)}get sortedRenderers(){return this._sortedRenderers}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();let a=!1;G.splitRenderGeometryChangeSetByMaterial(this._changes).forEach((b,c)=>{let e=this._renderers.get(c);!e&&0<b.adds.length&&(e=new H.MergedRenderer({material:c}),e.initializeRenderContext(this.rendererContext.pluginContext,
this._materials),this._renderers.set(c,e),a=!0);e&&(e.modify(b),0===e.numGeometries&&(this._renderers.delete(c),e.destroy(),a=!0))});this._changes.clear();a&&this._updateSortedMaterialRenderers();this._hasHighlights=q.someMap(this._renderers,b=>(b=b.produces.get(t.RenderSlot.DRAPED_MATERIAL))?b(r.ShaderOutput.Highlight):!1);this._hasWater=q.someMap(this._renderers,b=>(b=b.produces.get(t.RenderSlot.DRAPED_WATER))?b(r.ShaderOutput.Normal):!1);this.notifyChange("updating");return!0}addGeometries(a,b){if(0!==
a.length){var c=this._validateRenderGeometries(a);for(var e of c)this._geometries.set(e.id,e);e=this._pending.empty;for(const d of c)this._pending.adds.add(d);e&&this.notifyChange("updating");b===m.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(a)}}removeGeometries(a,b){const c=this._pending.empty,e=this._pending.adds;for(const d of a)e.has(d)?(this._pending.removed.add(d),e.delete(d)):this._pending.removed.has(d)||this._pending.removes.add(d),this._geometries.delete(d.id);c&&!this._pending.empty&&
this.notifyChange("updating");b===m.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(a)}modifyGeometries(a,b){const c=0===this._changes.updates.length;for(const e of a){const d=this._changes.updates.pushNew();d.renderGeometry=this._validateRenderGeometry(e);d.updateType=b}c&&0<this._changes.updates.length&&this.notifyChange("updating");switch(b){case m.DirtyState.TRANSFORMATION:case m.DirtyState.GEOMETRY:return this._notifyGraphicGeometryChanged(a);case m.DirtyState.VISIBILITY:return this._notifyGraphicVisibilityChanged(a)}}updateAnimation(a){let b=
!1;this._sortedRenderers.forAll(c=>b=!!c.updateAnimation&&c.updateAnimation(a)||b);return b}precompile(a){return this._sortedRenderers.reduce((b,c)=>c.precompile(a)||b,!1)}render(a){this._sortedRenderers.forAll(b=>{const c=b.acquireTechniques(a);c&&(b.render(a,c),C.releaseTechniques(c))})}intersect(a,b,c,e,d){for(const f of this._geometries.values()){if(!e(f))continue;this._intersectRenderGeometry(f,c,b,0,a,d);const k=this.rendererContext.longitudeCyclical;k&&(f.boundingSphere[0]-f.boundingSphere[3]<
k.min&&this._intersectRenderGeometry(f,c,b,k.range,a,d),f.boundingSphere[0]+f.boundingSphere[3]>k.max&&this._intersectRenderGeometry(f,c,b,-k.range,a,d));d++}return d}_updateSortedMaterialRenderers(){this._sortedRenderers.clear();let a=0;for(const b of this._renderers.values())b.drapedPriority=a++,this._sortedRenderers.push(b);this._sortedRenderers.sort((b,c)=>c.material?.renderPriority===b.material?.renderPriority?b.drapedPriority-c.drapedPriority:(c.material?.renderPriority||0)-(b.material?.renderPriority||
0))}_processAddsRemoves(){this._changes.adds.clear();this._changes.removes.clear();this._changes.adds.pushArray(Array.from(this._pending.adds));this._changes.removes.pushArray(Array.from(this._pending.removes));this._changes.updates.filterInPlace(({renderGeometry:a})=>!this._pending.has(a));this._pending.clear()}_intersectRenderGeometry(a,b,c,e,d,f){if(a.visible&&a.material.visible){var k=0;e+=a.transformation[12];k=a.transformation[13];p[0]=c[0]-e;p[1]=c[1]-k;a.screenToWorldRatio=this.rendererContext.screenToWorldRatio;
a.material.intersectDraped(a,null,d,p,(u,v,K)=>{I(b,K,f,a.material.renderPriority,d,a.layerUid,a.graphicUid)},b)}}_notifyGraphicGeometryChanged(a){if(null!=this.drapeSource.notifyGraphicGeometryChanged)for(const {graphicUid:c}of a)if(null!=c&&c!==b){this.drapeSource.notifyGraphicGeometryChanged(c);var b=c}}_notifyGraphicVisibilityChanged(a){if(null!=this.drapeSource.notifyGraphicVisibilityChanged)for(const {graphicUid:c}of a)if(null!=c&&c!==b){this.drapeSource.notifyGraphicVisibilityChanged(c);var b=
c}}_validateRenderGeometries(a){for(const b of a)this._validateRenderGeometry(b);return a}_validateRenderGeometry(a){null==a.localOrigin&&(a.localOrigin=this._localOriginFactory.getOrigin(A.getCenter(a.boundingSphere)));return a}get test(){}};h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"drapeSource",void 0);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"updating",null);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"rctx",null);
h.__decorate([l.property({constructOnly:!0})],g.SortedRenderGeometryRenderer.prototype,"rendererContext",void 0);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"_materials",null);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"_localOriginFactory",null);h.__decorate([l.property({readOnly:!0})],g.SortedRenderGeometryRenderer.prototype,"isEmpty",null);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"_renderers",void 0);h.__decorate([l.property()],
g.SortedRenderGeometryRenderer.prototype,"_geometries",void 0);g.SortedRenderGeometryRenderer=h.__decorate([y.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],g.SortedRenderGeometryRenderer);class J{constructor(){this.adds=new Set;this.removes=new Set;this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(a){return this.adds.has(a)||this.removes.has(a)||this.removed.has(a)}clear(){this.adds.clear();this.removes.clear();
this.removed.clear()}}const p=z.create();Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});