// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/PooledArray ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/support/frustum ../../../../chunks/sphere ../../support/mathUtils ./depthRange ./Octree ./Util".split(" "),function(z,L,v,w,A,M,q,x,y,B,p,r,N){function O(a,b,e){var c=b.eye;const f=b.viewForward,d=b.frustum,g=k=>k.visible;var h=e.objectCount;
500>h?(p.set(n,b.near,Math.min(a.near,b.far)),e.forEachInDepthRange(c,f,r.DepthOrder.FRONT_TO_BACK,n,(k,l)=>{C(a,b,k);n.far=a.near;l.setRange(n)},d,g),p.set(n,Math.max(a.far,b.near),b.far),e.forEachInDepthRange(c,f,r.DepthOrder.BACK_TO_FRONT,n,(k,l)=>{C(a,b,k);n.near=a.far;l.setRange(n)},d,g)):(h=Math.max(Math.min(h,500),Math.ceil(.1*h)),c=e.findClosest(f,r.DepthOrder.FRONT_TO_BACK,d,g,h),e=e.findClosest(f,r.DepthOrder.BACK_TO_FRONT,d,g,h),c&&e&&(G(a,b,c.boundingVolumeWorldSpace.bounds),G(a,b,e.boundingVolumeWorldSpace.bounds)))}
function P(a,b,e){u.clear();e.forAll(c=>{c.visible&&0!==c.geometries.length&&u.add(c)});u.empty||(u.sort(b),p.set(n,b.near,Math.min(a.near,b.far)),u.forEachInDepthRange(n,r.DepthOrder.FRONT_TO_BACK,(c,f)=>{f<a.near&&C(a,b,c)}),p.set(n,Math.max(a.far,b.near),b.far),u.forEachInDepthRange(n,r.DepthOrder.BACK_TO_FRONT,(c,f,d)=>{a.far=Math.max(a.far,d)}))}function C(a,b,e){if(e.visible&&x.intersectsSphere(b.frustum,e.boundingVolumeWorldSpace.bounds)){var c=e.transformation,f=Q;e.geometries.forEach(d=>
{v.multiply(f,c,d.transformation);const g=B.maxScale(f);H(a,b,d.boundingInfo,f,g)})}}function H(a,b,e,c,f){if(null!=e){A.transformMat4(y.getCenter(m),e.center,c);var {eye:d,viewForward:g}=b,h=g[0]*(m[0]-d[0])+g[1]*(m[1]-d[1])+g[2]*(m[2]-d[2]);m[3]=e.radius*f;if(!(h-m[3]>a.near&&h+m[3]<a.far)&&x.intersectsSphere(b.frustum,m))if(100<e.radius&&e.getChildren())for(const k of e.getChildren())H(a,b,k,c,f);else D.unionDepthRangeWithAABB(a,b.viewProjectionMatrix,c,e.bbMin,e.bbMax)}}function G(a,b,e){var c=
b.eye;b=b.viewForward;c=(e[0]-c[0])*b[0]+(e[1]-c[1])*b[1]+(e[2]-c[2])*b[2];a.near=Math.min(a.near,c-e[3]);a.far=Math.max(a.far,c+e[3])}function E(a,b){if(0===b)return a[0]>=-a[3];if(1===b)return a[1]>=-a[3];if(2===b)return a[0]<=a[3];if(3===b)return a[1]<=a[3];N.assert(!1)}function I(a,b,e){let c=0;0===e?c=(-a[3]-a[0])/(b[0]-a[0]+b[3]-a[3]):1===e?c=(-a[3]-a[1])/(b[1]-a[1]+b[3]-a[3]):2===e?c=(a[3]-a[0])/(b[0]-a[0]-b[3]+a[3]):3===e&&(c=(a[3]-a[1])/(b[1]-a[1]-b[3]+a[3]));return M.lerp(q.create(),a,b,
c)}class R{constructor(){this._items=new L({allocator:a=>a||{object:null,distance:0,near:0,far:0},deallocator:a=>{a.object=null;a.distance=0;a.near=0;a.far=0;return a}})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(a){this._items.pushNew().object=a}sort(a){const b=a.eye,e=a.viewForward;this._items.forAll(c=>{const f=c.object.boundingVolumeWorldSpace.bounds,d=(f[0]-b[0])*e[0]+(f[1]-b[1])*e[1]+(f[2]-b[2])*e[2];c.distance=d;c.near=d-
f[3];c.far=d+f[3]});this._items.sort((c,f)=>c.distance-f.distance)}forEachInDepthRange(a,b,e){if(b===r.DepthOrder.FRONT_TO_BACK)for(b=0;b<this._items.length;++b){var c=this._items.data[b];c.far<a.near||c.near>a.far||e(c.object,c.near,c.far)}else for(b=this._items.length-1;0<=b;--b)c=this._items.data[b],c.far<a.near||c.near>a.far||e(c.object,c.near,c.far)}}class J{constructor(){this._view=w.create();this._viewProj=w.create();this._frustum=x.create();this._geometries=[];this._near=[];this._far=[];this._nearCandidates=
[];this._farCandidates=[];this._looseRange={near:0,far:0}}compute(a,b){this._reset();v.copy(this._view,a.viewMatrix);v.multiply(this._viewProj,a.projectionMatrix,this._view);x.copy(this._frustum,a.frustum);a=this._view;const e=a[2],c=a[6],f=a[10],d=a[14];b.forAll(k=>{k.forEachGeometry(l=>{if(l.visible&&l.castShadow){var t=l.boundingSphere,K=e*t[0]+c*t[1]+f*t[2]+d,S=K-t[3];t=K+t[3];this._geometries.push(l);this._near.push(-t);this._far.push(-S)}})});b=new p.DepthRange;if(0===this._geometries.length)return b;
for(a=0;a<this._geometries.length;++a)this._near[a]>b.far&&(b.far=this._near[a]),2<this._near[a]&&this._far[a]<b.near&&(b.near=this._far[a]);a=this._looseRange;a.near=Math.max(.5*b.near,2);a.far=2*b.far;var g=0;let h=0;for(let k=0;k<this._geometries.length;++k)this._near[k]<b.near&&(this._near[k]>=a.near?b.near=this._near[k]:this._nearCandidates[g++]=k),this._far[k]>b.far&&(this._far[k]<=a.far?b.far=this._far[k]:this._farCandidates[h++]=k);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return b;
this._nearCandidates.sort((k,l)=>this._near[k]<this._near[l]?-1:this._near[k]>this._near[l]?1:0);this._farCandidates.sort((k,l)=>this._far[k]<this._far[l]?1:this._far[k]>this._far[l]?-1:0);for(a=0;a<this._nearCandidates.length;++a)g=this._nearCandidates[a],this._near[g]<b.near&&(g=this._geometries[g],this._includeNearBoundingInfoRec(g.boundingInfo,g.shaderTransformation,b));for(a=0;a<this._farCandidates.length;++a)g=this._farCandidates[a],this._far[g]>b.far&&(g=this._geometries[g],this._includeFarBoundingInfoRec(g.boundingInfo,
g.shaderTransformation,b));this._reset();return b}_reset(){this._geometries.length=0;this._near.length=0;this._far.length=0;this._nearCandidates.length=0;this._farCandidates.length=0}_includeNearBoundingInfoRec(a,b,e){if(null!=a){var c=a.center;A.transformMat4(y.getCenter(m),c,b);c=B.maxScale(b);var f=m[0],d=m[1],g=m[2];c*=a.radius;var h=this._frustum;if(!(h[0][0]*f+h[0][1]*d+h[0][2]*g+h[0][3]>c||h[1][0]*f+h[1][1]*d+h[1][2]*g+h[1][3]>c||h[2][0]*f+h[2][1]*d+h[2][2]*g+h[2][3]>c||h[3][0]*f+h[3][1]*d+
h[3][2]*g+h[3][3]>c||(f=this._view[2]*f+this._view[6]*d+this._view[10]*g+this._view[14],d=f+c,2>-(f-c)||-d>=e.near)))if(-d>this._looseRange.near)e.near=-d;else{if(100<c&&(c=a.getChildren(),void 0!==c)){for(const k of c)this._includeNearBoundingInfoRec(k,b,e);return}D.unionDepthRangeWithAABB(e,this._viewProj,b,a.bbMin,a.bbMax)}}}_includeFarBoundingInfoRec(a,b,e){if(null!=a){var c=a.radius,f=a.center;A.transformMat4(y.getCenter(m),f,b);var d=B.maxScale(b);f=m[0];var g=m[1],h=m[2];c*=d;d=this._frustum;
if(!(d[0][0]*f+d[0][1]*g+d[0][2]*h+d[0][3]>c||d[1][0]*f+d[1][1]*g+d[1][2]*h+d[1][3]>c||d[2][0]*f+d[2][1]*g+d[2][2]*h+d[2][3]>c||d[3][0]*f+d[3][1]*g+d[3][2]*h+d[3][3]>c||(f=this._view[2]*f+this._view[6]*g+this._view[10]*h+this._view[14]-c,-f<=e.far)))if(-f<this._looseRange.far)e.far=-f;else{if(100<c&&(c=a.getChildren(),void 0!==c)){for(const k of c)this._includeFarBoundingInfoRec(k,b,e);return}D.unionDepthRangeWithAABB(e,this._viewProj,b,a.bbMin,a.bbMax)}}}}class T{constructor(){this._modelViewProj=
w.create();this._clipPosition=[q.create(),q.create(),q.create(),q.create(),q.create(),q.create(),q.create(),q.create()]}unionDepthRangeWithAABB(a,b,e,c,f){var d=this._modelViewProj;v.multiply(d,b,e);b=!1;for(e=0;8>e;++e){var g=this._clipPosition[e],h=0===e||3===e||4===e||7===e?c[0]:f[0],k=0===e||1===e||4===e||5===e?c[1]:f[1];const l=4>e?c[2]:f[2];g[0]=d[0]*h+d[4]*k+d[8]*l+d[12];g[1]=d[1]*h+d[5]*k+d[9]*l+d[13];g[2]=d[2]*h+d[6]*k+d[10]*l+d[14];g[3]=d[3]*h+d[7]*k+d[11]*l+d[15]}for(c=0;12>c;++c){f=[this._clipPosition[F[c][0]],
this._clipPosition[F[c][1]],this._clipPosition[F[c][2]]];for(d=0;4>d;++d)for(e=f,f=[],g=0;g<e.length;++g)h=e[g],k=e[(g+1)%e.length],E(k,d)?(E(h,d)||f.push(I(h,k,d)),f.push(k)):E(h,d)&&f.push(I(h,k,d));d=!0;for(e=0;e<f.length;++e)if(2<=f[e][3]){d=!1;break}if(!d)for(b=!0,d=0;d<f.length;++d)e=f[d][3],Number.isFinite(e)&&(a.near=Math.min(e,a.near),a.far=Math.max(e,a.far))}return b}}const F=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],m=y.create(),Q=
w.create(),n=p.empty(),u=new R,U=new J,D=new T;z.DepthRangeFromRenderGeometries=J;z.depthRangeFromScene=function(a,b,e){let c=0;if(!b.some(d=>{if(!d.material)return!1;c+=d.numGeometries;return 1E4<=c}))return U.compute(a,b);const f=p.empty();e.forAll(d=>{var g=p.union;if(d.visible){var h=p.empty(),k=d.getSpatialQueryAccelerator();k?O(h,a,k):P(h,a,d.objects);d=h}else d=void 0;return g.call(p,f,d)});return f};Object.defineProperty(z,Symbol.toStringTag,{value:"Module"})});