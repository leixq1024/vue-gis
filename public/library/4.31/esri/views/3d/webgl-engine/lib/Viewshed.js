// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Collection ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/sphere ../../webgl ../../webgl/RenderNode ./basicInterfaces ./RenderFeature ./ViewshedShadowMap ../../../../chunks/Viewshed.glsl ../shaders/ViewshedTechnique".split(" "),
function(f,h,D,q,E,l,k,O,P,Q,F,p,x,r,u,G,v,H,y,I,J,K,z){function A(a,c,d){if(null==a)return 0;const {observerRenderSpace:b,targetRenderSpace:g}=a,e=r.distance(d,b);d=r.distance(d,g);return c.pixelSizeAt(e>d?a.observer:a.target)}f.Viewshed=class extends H{get shadowMap(){return this._shadowMap}get hasViewsheds(){return 0<this._viewsheds.length}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(a=>{var c=this.view;a=G.fromCenterAndRadius(a.observerRenderSpace,
a.farDistanceRenderSpace);c=c.ready?c.frustum.intersectsSphere(a):!1;return c})}constructor(a){super(a);this._techniques=null;this._passParameters=new K.ViewshedPassParameters;this._viewsheds=new D;this._shadowMap=null;this.consumes={required:[v.InternalRenderCategory.VIEWSHED],optional:["normals"]};this.produces=v.InternalRenderCategory.VIEWSHED;this.requireGeometryDepth=!0}initialize(){this._shadowMap=new J.ViewshedShadowMap(this.fboCache);this.addHandles([l.watch(()=>this.view.resolutionScale,
a=>{const c=this._shadowMap;c&&(c.settings.textureSizeQuality=a)},l.initial),l.when(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),l.when(()=>this.view._stage.renderView.techniques,a=>this._techniques=a,l.initial),l.watch(()=>this._viewshedsInView.map(a=>[a.observerRenderSpace,a.heading,a.tilt,a.farDistance,a.horizontalFieldOfView,a.verticalFieldOfView]),()=>this.requestRender(y.RenderRequestType.UPDATE),l.sync)])}destroy(){this._shadowMap=E.disposeMaybe(this._shadowMap)}precompile(){if(this.hasViewsheds){this._techniques?.precompile(z.ViewshedTechnique);
for(const a of this._viewshedsInView)if(this._shadowMap?.isActive(a)){this.view._stage.renderer.precompileViewshedShadowMap();break}}}render(a){const c=this.bindParameters,d=this.renderingContext,b=a.find(({name:e})=>e===v.InternalRenderCategory.VIEWSHED);if(!this.hasViewsheds||!c.depth)return b;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap;this._passParameters.normals=a.find(({name:e})=>"normals"===e)?.getTexture();a=this._techniques?.acquire(z.ViewshedTechnique);
if(!a?.compiled)return this.requestRender(y.RenderRequestType.UPDATE),a?.release(),b;const g=this.view._stage.renderer.isFeatureEnabled(I.RenderFeature.HighResolutionViewshed);for(const e of this._viewshedsInView){if(!this._renderShadowCubeMap(c,e,g)||!this._shadowMap?.ready)continue;const n=this._setupViewshedParameters(e,c.camera);d.bindTechnique(a,c,n);d.bindFramebuffer(b.fbo);d.screen.draw()}a.release();this.shadowMap?.dispose();return b}updateViewsheds(a){const c=this._viewsheds,{removes:d,adds:b}=
a;d&&(Array.isArray(d)?c.removeMany(d):c.remove(d));b&&(Array.isArray(b)?(a=b.filter(g=>!c.includes(g)),c.addMany(a)):c.includes(b)||c.add(b))}_renderShadowCubeMap(a,c,d){const b=this._shadowMap;if(!b)return!1;(a=b.start(a.camera,c,d,this._contentPixelRatio,this.view.basemapTerrain.hasStencilEnabledExtents))&&b.faces.forEach(g=>this.view._stage.renderer.renderViewshedShadowMap(g));b.finish();return a}_setupViewshedParameters(a,c){const d=this._shadowMap;if(!d)return this._passParameters;const b=this._passParameters,
g=a.effectiveObserverRenderSpace;b.localOrigin=g;b.observerOffset=r.sub(L,a.observerRenderSpace,a.effectiveObserverRenderSpace);b.fovs=[q.deg2rad(a.horizontalFieldOfView),q.deg2rad(a.verticalFieldOfView)];b.headingAndTilt=[q.deg2rad(a.heading),q.deg2rad(a.tiltParallelToSurface)];b.upVector=a.tiltedUpVector;var e=a.targetRenderSpace;var n=u.create();e=r.sub(n,e,g);b.targetVector=e;e=[];n=[];for(let t=0;t<d.numActiveFaces;t++){p.translate(w,d.viewshedViewMatrices[t],g);e.push(...w);var M=d.viewshedProjectionMatrices[t],
N=w,m=B;const C=u.fromValues(.5,.5,.5);p.fromTranslation(m,C);p.scale(m,m,C);p.mul(m,m,M);p.mul(m,m,N);n.push(...B)}b.viewMatrices=e;b.projectionMatrices=n;b.volumeOffset=this.selectedViewshed?.()===a.viewshed?A(a,this.view,c.eye):0;return b}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};h.__decorate([k.property()],f.Viewshed.prototype,"_techniques",void 0);h.__decorate([k.property()],f.Viewshed.prototype,"selectedViewshed",void 0);h.__decorate([k.property()],
f.Viewshed.prototype,"shadowMap",null);h.__decorate([k.property()],f.Viewshed.prototype,"hasViewsheds",null);h.__decorate([k.property()],f.Viewshed.prototype,"_contentPixelRatio",null);h.__decorate([k.property()],f.Viewshed.prototype,"_viewshedsInView",null);h.__decorate([k.property()],f.Viewshed.prototype,"consumes",void 0);h.__decorate([k.property()],f.Viewshed.prototype,"produces",void 0);f.Viewshed=h.__decorate([F.subclass("esri.views.3d.webgl-engine.lib.Viewshed")],f.Viewshed);const L=u.create(),
w=x.create(),B=x.create();f.computeOffsetScale=A;Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});