// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/tslib.es6 ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/colorUtils ../../../../core/has ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/signal ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/accessorSupport/interfaces ../../../../core/accessorSupport/tracking/Flags ../../../../core/Warning ../../../../core/Error ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../webgl ../../support/debugFlags ../../webgl/formats ../core/FBOCache ../core/renderPasses/RenderPassManager ../core/shaderLibrary/ShaderOutput ../core/shaderLibrary/hud/HUDRenderStyle ../core/shaderLibrary/shading/ScreenSpaceConstants ../effects/RenderNodes ../effects/RenderPlugin ../effects/RenderPluginManager ../effects/blit/Blit ../effects/highlight/Highlight ../effects/transparency/OITBlend ./AnimationTimer ./AnimationTimeStep ./basicInterfaces ./BoundingInfo ./depthRange ./depthRangeUtils ./MainFramebuffer ./Material ./OITPass ./RenderContext ./rendererUtils ./RenderFeature ./RenderPluginInput ./RenderSlot ./ShadowAccumulator ./ShadowMap ./SliceHelper ./edgeRendering/interfaces ../materials/renderers/MergedRenderer ../parts/renderUtils ../statistics/RendererPerformanceInfo ../../../support/RenderState ../../../webgl/enums".split(" "),
function(da,V,N,ea,fa,ha,W,p,ia,v,O,P,Ha,Ia,Ja,Ka,La,E,F,ja,B,k,ka,r,I,la,h,y,ma,na,oa,pa,qa,ra,sa,ta,ua,Q,va,X,wa,xa,ya,D,R,z,C,za,e,Aa,S,Ba,G,Ca,Y,n,Da,t){function Ea(a){return b=>a.immediate.schedule(b)}class L{constructor(a,b,c,f,d,l){this._stage=a;this._techniques=c;this._rctx=f;this._compositingHelper=d;this._requestRender=l;this._pluginsHas={hudElements:!1,water:!1};this._renderers=new Map;this.renderPassManager=new la.RenderPassManager;this._inGlobeView=this._isRendering=!1;this._backgroundColor=
B.fromValues(0,0,0,1);this._sliceHelper=new Ba;this._oitblend=this._blit=null;this._state=O.signal(Da.RenderState.IDLE);this._highQualityTransparencyEnabled=!0;this._hasAnimations=this._ssrEnabled=!1;this._animationTimestep=new ua.AnimationTimeStep;this._loadEdgeViewTask=null;this._edgeViewCallbacks=[];this._reprojectionMatrixVersion=O.signal(0);this._renderHiddenTransparentEdges=()=>{};this._pluginInput=new za.RenderPluginInput;this._releaseNormals=g=>{g.some(({name:q})=>"normals"===q)&&this._pluginInput.release("normals")};
this._debugNeedsDepth=!1;this.fboCache=new I.FBOCache(f);this._renderStateFeatures=O.signal(C.setupFeatureDefaults(!W("disable-feature:high-quality-idle"),a.view.qualityProfile));this._framebuffer=new xa.MainFramebuffer(this.fboCache);this.performanceInfo=new n.RendererPerformanceInfo(this._rctx);this._shadowMap=new S.ShadowMap(this.fboCache,a.viewingMode);this._shadowAccumulator=new Aa.ShadowAccumulator(this.fboCache,c,a,g=>{const q=this.shadowsEnabled;this._shadowMap.enabled=!0;this._ensureBindParametersCamera(g.camera,
g.contentCamera);this._plugins.prepareRender();this._shadowMap.enabled=q},(g,q,A)=>{g.shadowMap.start(g.camera,q,A,!0,this._stage.view.qualitySettings.maximumPixelRatio);this._renderShadowCascades(h.ShaderOutput.Shadow,g.shadowMap);g.shadowMap.finish();g.camera.setGLViewport(this._rctx);this._ensureBindParametersCamera(g.camera,g.contentCamera)},l);this._renderContext=new R.RenderContext(this._rctx,this._shadowMap,c);this._nodes=new na.RenderNodes(this._renderContext);this._plugins=new pa.RenderPluginManager({renderContext:this._renderContext,
techniques:c,materials:b,requestRender:l,controller:a,fbos:this.fboCache,isFeatureEnabled:g=>this.isFeatureEnabled(g)});this._plugins.add(this.renderPassManager);this._handles=[v.watch(()=>this._stage.view.state.camera,()=>l(),v.syncAndInitial),v.watch(()=>ka.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,g=>{this._renderHiddenTransparentEdges=g?()=>this._renderEdges(G.Transparency.TRANSPARENT):()=>{};l()},v.initial),v.watch(()=>this._stage.view.environment.background?.color,g=>{g=g?ha.unitRGBAFromColor(g):
B.ZEROS;ja.set(this._backgroundColor,g[0]*g[3],g[1]*g[3],g[2]*g[3],g[3]);l()},v.syncAndInitial),v.watch(()=>this._stage.view.state.camera.relativeElevation,g=>this._inGlobeView=(g??Infinity)>=ma.distanceFadeEnd,v.syncAndInitial),v.watch(()=>this._bindParameters.clouds.fadeFactor,()=>this._bindParameters.fadeLighting(),v.sync),v.watch(()=>this._bindParameters.clouds.data?.state,()=>this._requestRender(Q.RenderRequestType.UPDATE),v.sync)]}destroy(){this._handles.forEach(a=>a.remove());this._gpuTimerHandle=
p.removeMaybe(this._gpuTimerHandle);this._nodes.destroy();this._framebuffer.dispose();this._shadowMap.dispose();this._shadowAccumulator.dispose();this._loadEdgeViewTask=p.abortMaybe(this._loadEdgeViewTask);this._edgeView=p.destroyMaybe(this._edgeView);this.renderPassManager.dispose();this._releaseFBOs();this._disposeOffscreenBuffers();this.fboCache.destroy();this._plugins.destroy();this._renderers.clear();this._oitblend=this._blit=null;va.BoundingInfo.prune()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(a=
null,b=!W("disable-feature:high-quality-idle")){this._renderStateFeatures.value=C.setupFeatureDefaults(b,a);this._plugins.renderFeatureChanged();this._requestRender()}isFeatureEnabled(a,b=this._state.value){return this._renderStateFeatures.value.get(b,a)??!1}setFeatureEnabled(a,b,c){this._renderStateFeatures.mutate(f=>f.set(b,a,c));this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(C.RenderFeature.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&
(this._ssrEnabled||this.isFeatureEnabled(C.RenderFeature.WaterReflection))}get hasHighlights(){return this._plugins.produces(h.ShaderOutput.Highlight,e.RenderSlot.OPAQUE_MATERIAL,e.RenderSlot.TRANSPARENT_MATERIAL,e.RenderSlot.DRAPED_MATERIAL,e.RenderSlot.HUD_MATERIAL,e.RenderSlot.LABEL_MATERIAL)}get hasHighlightsOnHUD(){return this._plugins.produces(h.ShaderOutput.Highlight,e.RenderSlot.HUD_MATERIAL,e.RenderSlot.LABEL_MATERIAL)}get hasSSAO(){return(this._stage.view.qualitySettings.ambientOcclusion||
this.isFeatureEnabled(C.RenderFeature.SSAO))&&!this._inGlobeView}get hasSMAA(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(C.RenderFeature.Antialiasing)}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(C.RenderFeature.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=p.releaseMaybe(this._bindParameters.ssr.lastFrameColor);this._bindParameters.terrainDepth=p.releaseMaybe(this._bindParameters.terrainDepth);
this._bindParameters.geometryDepth=p.releaseMaybe(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose();this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers();this._bindParameters.depth=p.releaseMaybe(this._bindParameters.depth);this._bindParameters.hudVisibility=p.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||
!this.isCameraFinal}loadEdgeView(){if(this._loadEdgeViewTask)return this._loadEdgeViewTask.promise;this._loadEdgeViewTask=fa.createTask(async a=>{const {EdgeView:b}=await new Promise((f,d)=>da(["./edgeRendering/EdgeView"],f,d));ia.throwIfAborted(a);const c=this._edgeView=new b({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:Ea(this._stage.view.resourceController)});this._handles.push(v.watch(()=>
c.updating,()=>this._requestRender(),v.sync));this._requestRender();this._edgeViewCallbacks.forEach(f=>f(c));this._edgeViewCallbacks.length=0;return c});return this._loadEdgeViewTask.promise}withEdgeView(a){this.loadEdgeView();null==this._edgeView?this._edgeViewCallbacks.push(a):a(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return 0<=this._reprojectionMatrixVersion.value&&E.equals(this._bindParameters.ssr.reprojectionMatrix,F.IDENTITY)}set _reprojectionMatrix(a){ea.update(this._bindParameters.ssr.reprojectionMatrix,
a)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(a){const {_shadowMap:b,_bindParameters:c}=this;void 0!==a.qualitySettings?.reflections&&this._ssrEnabled!==a.qualitySettings.reflections&&(this._ssrEnabled=a.qualitySettings.reflections,this._requestRender());void 0!==a.shadowMap&&this._shadowMap.enabled!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap,this._requestRender());void 0!==a.shadowMapMaxCascades&&b.maxCascades!==a.shadowMapMaxCascades&&
(b.maxCascades=a.shadowMapMaxCascades,this._requestRender());if(null!=a.environment){null!=a.environment.weather&&(this._bindParameters.weather=a.environment.weather,this._bindParameters.weatherVisible=!!a.weatherVisible);const f="virtual"!==a.environment.lighting.type;c.enableFillLights!==f&&(c.enableFillLights=f,this._requestRender())}void 0!==a.highQualityTransparency&&this._highQualityTransparencyEnabled!==a.highQualityTransparency&&(this._highQualityTransparencyEnabled=a.highQualityTransparency,
this._requestRender());void 0!==a.shadowCast&&this._shadowAccumulator.setOptions(a.shadowCast)}set slicePlane(a){this._sliceHelper.plane!==a&&(this._sliceHelper.plane=a,this._requestRender())}get plugins(){return this._plugins}getMaterialRenderer(a){return this._renderers.get(a)}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(a,b){this._isRendering&&console.warn("Renderer.modify called while rendering");
const {adds:c,removes:f,updates:d}=a;if(0!==c.length||0!==f.length||0!==d.length)z.splitRenderGeometryChangeSetByMaterial(a).forEach((l,g)=>{if(!b.done){var q=this._renderers.get(g);null==q&&0<l.adds.length&&(q=new Ca.MergedRenderer({material:g}),q.initializeRenderContext(this._plugins.context),this._plugins.add(q),this._renderers.set(g,q));q&&(q.modify(l),0===q.numGeometries&&(this._renderers.delete(q.material),this._plugins.remove(q),q.destroy()));l.removes.forEach(A=>a.removes.removeUnordered(A));
l.adds.forEach(A=>a.adds.removeUnordered(A));l.updates.forEach(A=>a.updates.removeUnordered(A));b.madeProgress()}}),this.updateHasFlags()}updateHasFlags(){const a=this._pluginsHas;a.hudElements=this._plugins.produces(h.ShaderOutput.Color,e.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,e.RenderSlot.HUD_MATERIAL,e.RenderSlot.LABEL_MATERIAL);a.water=this._plugins.produces(h.ShaderOutput.Normal,e.RenderSlot.DRAPED_WATER);this._bindParameters.hasOccludees=this._plugins.hasOccludees;this._requestRender()}updateAnimation(a,
b){this._animationTimer??(this._animationTimer=new ta.AnimationTimer(a.camera,b));this._animationTimer.advance(a.camera,b,this._animationTimeDilation);null!=a.forcedAnimationTime&&this._animationTimer.forceTime(a.forcedAnimationTime);a=this._hasAnimations;this._hasAnimations=this._plugins.updateAnimation(this._animationTimer);this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations;this._hasAnimations=this.overlay?.updateAnimation(this._animationTimer)||this._hasAnimations;
this._hasAnimations!==a&&(this._gpuTimerHandle=a?p.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo());return this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(a,b,c=z.RendererTarget.Default,f=!1){try{return this._isRendering=!0,this._render(a,b,c,f)}catch(d){console.error(`Exception during rendering: ${d}`)}finally{this._isRendering=
!1}return new Y.RenderSceneResult(this._pluginInput.get("final-color"),null)}_render(a,b,c=z.RendererTarget.Default,f){this.performanceInfo.startFrame();this.fboCache.frameStart();this.fboCache.interactive=c===z.RendererTarget.Default;this._disposeBindBuffers();const d=this._framebuffer,{camera:l,contentCamera:g,mode:q,alignPixelEnabled:A}=a;this._state.value=q;this._bindParameters.overlay=this.overlay?.render(b);this._bindParameters.overlay&&this.performanceInfo.advance(n.PerformanceCategory.OVERLAY);
this._renderContext.time=b;this._bindParameters.oitPass=D.OITPass.NONE;this._bindParameters.alignPixelEnabled=A;this._bindParameters.decorations=!f;this._bindParameters.mainDepth=null;this._bindParameters.viewshedEnabled=this._nodes.produces(k.InternalRenderCategory.VIEWSHED);a=this._nodes.produces("magnifier-color");const T=this._nodes.produces("final-color");this._bindParameters.slicePlane=this._sliceHelper.plane;l.setGLViewport(this._rctx);var m=0<this._nodes.require("emissive")&&this._plugins.hasEmissions,
w=m?h.ShaderOutput.ColorEmission:h.ShaderOutput.Color;m=d.initialize(l.fullWidth,l.fullHeight,this._backgroundColor,m);this.hasReflections?(m?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=m):m?.release();this._ensureBindParametersCamera(l,g);this._plugins.prepareRender();this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!f;m=this._highQualityTransparency&&this._needsTransparentTerrain;const M=this._plugins.produces(h.ShaderOutput.Color,...J);this._precompilePrepasses();
this.performanceInfo.advance(n.PerformanceCategory.PREPARE);var x=this._computeDepthRange(l);this._renderShadowMap(l,this._bindParameters.lighting.mainLight.direction,x);this._ensureBindParametersCamera(l,g);this._pluginInput.set("normals",this._renderNormals());this._renderRemainingGeometryDepth();this._renderShadowAccumulation(x,l,g);this._ensureBindParametersSSR(b);this._precompileShaders(m,M,w);this._renderContext.output=w;d.bind();this._bindParameters.mainDepth=d.depth.attachment;const Z=this.plugins.produces(h.ShaderOutput.Color,
...U);Z&&this._renderOpaqueGeometry();d.update(u=>this._renderNodes(k.RenderCategory.OPAQUE,u,Z));this.fboCache.debugCallback?.("opaque-color",d.color.fbo);d.update(u=>this._renderNodes(k.InternalRenderCategory.OPAQUE_ENVIRONMENT,u));this.fboCache.debugCallback?.(k.InternalRenderCategory.OPAQUE_ENVIRONMENT,d.color.fbo);this._renderTerrainDepth(m);this._setMultipassTerrain(m);this._renderEdges(G.Transparency.OPAQUE);d.bind();this._renderPlugins(e.RenderSlot.VOXEL,n.PerformanceCategory.VOXEL);this._renderHiddenTransparentEdges();
M&&(this._oitEnabled?this._renderOIT(K.Geometry,w):this._renderTransparentGeometry());d.update(u=>this._renderNodes(k.RenderCategory.TRANSPARENT,u,M));this.fboCache.debugCallback?.("transparent-color",d.color.fbo);this._renderGeometryDepth(m);this._renderHUDVisibility();m||this._plugins.render(this._pluginInput,e.RenderSlot.LINE_CALLOUTS);b=c===z.RendererTarget.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this._renderEdges(G.Transparency.TRANSPARENT);if(x=this._needsTransparentTerrain?
this._renderTransparentTerrain():null)this.performanceInfo.advance(n.PerformanceCategory.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(m?this._renderLineCallouts(y.HUDRenderStyle.Occluded):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,x.getTexture())),this._renderHUD(y.HUDRenderStyle.Occluded,d.color,w));this._cullAboveTerrain(!1);x&&(d.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,
x.getTexture()),x.release(),m&&(this._renderEdges(G.Transparency.OPAQUE),M&&(this._oitEnabled?this._renderOIT(K.Geometry,w):this._renderTransparentGeometry(),this.performanceInfo.advance(n.PerformanceCategory.TRANSPARENT)),this._renderEdges(G.Transparency.TRANSPARENT)));this._bindParameters.ssao=p.releaseMaybe(this._bindParameters.ssao);m&&this._renderLineCallouts(y.HUDRenderStyle.NotOccluded);this._setTerrainDepthTest(!1);this._renderTransparentEnvironment();d.update(u=>this._renderNodes(k.InternalRenderCategory.TRANSPARENT_ENVIRONMENT,
u));d.update(u=>this._renderNodes(k.InternalRenderCategory.VIEWSHED,u));d.update(u=>this._renderNodes(k.InternalRenderCategory.LASERLINES,u));d.update(u=>this._renderNodes(k.InternalRenderCategory.OCCLUDED,u));this._pluginInput.set("highlights",this._renderHighlightPrepass());d.update(u=>this._renderNodes(k.RenderCategory.COMPOSITE,u));x=c===z.RendererTarget.Default&&!T&&!(a&&!f&&c===z.RendererTarget.Default);m=this._pluginInput.get(k.RenderCategory.COMPOSITE);x=x?I.defaultWebGLFBO:this.fboCache.acquire(m.fbo.width,
m.fbo.height,k.InternalRenderCategory.ANTIALIASING);m=this._nodes.produces(k.InternalRenderCategory.ANTIALIASING)?this._renderNodes(k.InternalRenderCategory.ANTIALIASING,x):this._blitFBO(m,x,!1);this._pluginInput.set(k.InternalRenderCategory.ANTIALIASING,m);this.hasHighlightsOnHUD?(this._renderHUD(y.HUDRenderStyle.NotOccluded,m,w),m=this._renderNodes(k.InternalRenderCategory.HIGHLIGHTS,m)):(m=this._renderNodes(k.InternalRenderCategory.HIGHLIGHTS,m),this._renderHUD(y.HUDRenderStyle.NotOccluded,m,w));
w=this._renderNodes(k.InternalRenderCategory.MAGNIFIER,m);!a||f||c!==z.RendererTarget.Default||T||this._blitFBO(w);T?(w.attachDepth(d.depth),this._blitFBO(this._renderNodes(k.RenderCategory.FINAL,w)),w.detachDepth()):this._pluginInput.set(k.RenderCategory.FINAL,w);this._pluginInput.release("highlights");if(this.onPostRender)this.onPostRender();this._releaseFBOs();d.releaseDepth();this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera);this.fboCache.frameEnd();this.performanceInfo.finishFrame();
c!==z.RendererTarget.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers());return new Y.RenderSceneResult(this._pluginInput.get("final-color"),b)}_precompileShaders(a,b,c){++this._plugins.context.techniques.precompiling;this._renderContext.output=c;this._precompileOpaqueGeometry();this._setMultipassTerrain(a);this._renderContext.output=h.ShaderOutput.Depth;this._plugins.precompile(e.RenderSlot.TRANSPARENT_TERRAIN);a&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry());
this._renderContext.output=c;this._plugins.precompile(e.RenderSlot.TRANSPARENT_TERRAIN);b&&(this._precompileTransparentGeometry(),this._needsTransparentTerrain&&(this._cullAboveTerrain(!1),this._precompileTransparentGeometry(),this._cullAboveTerrain(a)));this._needsHUDVisibility&&this._plugins.precompile(e.RenderSlot.OCCLUSION_PIXELS);a&&!this._needsHUDVisibility||this._plugins.precompile(e.RenderSlot.LINE_CALLOUTS);this._setMultipassTerrain(!1);this._nodes.precompile(k.InternalRenderCategory.VIEWSHED,
k.InternalRenderCategory.LASERLINES,k.InternalRenderCategory.OCCLUDED,k.RenderCategory.COMPOSITE,k.InternalRenderCategory.MAGNIFIER);this._shadowAccumulator.precompile();this._plugins.precompile(e.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH);--this._plugins.context.techniques.precompiling}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;++this._techniques.precompiling;var a=this._framebufferSize;a=this.fboCache.acquire(a.width,a.height,"olid");a.acquireDepth(r.DepthFormat.DEPTH_STENCIL_TEXTURE);
a=this._nodes.render(a,this._pluginInput);--this._techniques.precompiling;this.performanceInfo.advance(n.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR);return a}finish(a){this._hasAnimations||this._animationTimestep.clear();const b=this.performanceInfo.gpuSamplingEnabled;if((a=a===Q.RenderRequestType.BACKGROUND)||b){const c=a?this.performanceInfo.elapsedTime:0;let f=0;b?f=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();this._animationTimestep.frame(Math.max(c,f),a)}}readMainDepth(a,
b){const {mainDepth:c,camera:f}=this._bindParameters;if(c){var d=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(d.fbo);f.setGLViewport(this._rctx);this._rctx.setScissorRect(a[0],a[1],a[2],a[3]);this._rctx.setScissorTestEnabled(!0);this._rctx.clearFramebuffer(B.ZEROS);this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,c);this._rctx.setScissorTestEnabled(!1);this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,
this._rctx.gl.canvas.width);d.fbo?.readPixels(a[0],a[1],a[2],a[3],t.PixelFormat.RGBA,t.PixelType.UNSIGNED_BYTE,b);d.release()}}readHUDVisibility(a,b,c,f,d){this._bindParameters.hudVisibility?.fbo?.readPixels(a,b,c,f,t.PixelFormat.RGBA,t.PixelType.UNSIGNED_BYTE,d)}readAccumulatedShadow(a){return this._shadowAccumulator.readAccumulatedShadow(a[0],a[1])}_setMultipassTerrain(a){this._setTerrainDepthTest(a);this._cullAboveTerrain(a)}_setTerrainDepthTest(a){this._bindParameters.terrainDepthTest=a}_cullAboveTerrain(a){this._bindParameters.cullAboveTerrain=
a}_renderEdges(a){const b=this._edgeView;if(b?.shouldRender()){var c=this._framebufferSize;c=this.fboCache.acquire(c.width,c.height,"edges");this.renderToTargets(()=>b.render(this._bindParameters,a),c,this._bindParameters.geometryDepth??this._framebuffer.depth,B.ZEROS);this._framebuffer.bind();this._compositingHelper.composite(this._bindParameters,c.getTexture());c.release();this.performanceInfo.advance(a===G.Transparency.OPAQUE?n.PerformanceCategory.OPAQUE_EDGES:n.PerformanceCategory.TRANSPARENT_EDGES)}}_renderShadowMap(a,
b,c){if(this.shadowsEnabled){var f=this._shadowMap;f.start(a,b,c,this.isFeatureEnabled(C.RenderFeature.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio);this._needsShadowHighlight?(this._renderShadowCascades(h.ShaderOutput.ShadowHighlight,this._shadowMap),f.moveSnapshot(S.SnapshotSlot.Highlight),this._renderShadowCascades(h.ShaderOutput.ShadowExcludeHighlight,this._shadowMap),f.copySnapshot(S.SnapshotSlot.ExcludeHighlight),this._renderShadowCascades(h.ShaderOutput.ShadowHighlight,
this._shadowMap)):this._renderShadowCascades(h.ShaderOutput.Shadow);f.finish();a.setGLViewport(this._rctx);this.performanceInfo.advance(n.PerformanceCategory.SHADOW_MAP)}}_precompileShadowCascades(a){for(const b of this._shadowMap.cascades)b.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(b.camera,b.camera),this._precompileAllGeometry(a)}_renderShadowCascades(a,b=this._shadowMap){for(const c of b.cascades)c.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(c.camera,
c.camera),this.renderAllGeometry(a)}get _needsDepth(){return this._plugins.consumes(h.ShaderOutput.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._needsShadowAccumulation||this._debugNeedsDepth}_renderRemainingGeometryDepth(){var a=this._pluginInput.get("normals");const b=this._needsDepth;a?(a=b?a.getAttachment(t.DepthStencilAttachment):null,a?.retain(),this._pluginInput.set(k.InternalRenderCategory.SSAO,this._renderSSAO()),this._renderGeometryWithoutNormalsDepth(b,
a)):this._renderAllGeometryDepth(b)}_renderGeometryWithoutNormalsDepth(a,b){a&&b?(a=this._framebufferSize,a=this.fboCache.acquire(a.width,a.height,"depth"),a.attachDepth(b),b.release(),this._rctx.bindFramebuffer(a.fbo),this._rctx.clear(t.FramebufferBit.STENCIL),this._renderGeometryWithoutNormals(h.ShaderOutput.Depth),p.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=a.obtainDepthTexture(),a.release(),this.performanceInfo.advance(n.PerformanceCategory.DEPTH)):this._bindParameters.depth=
p.releaseMaybe(this._bindParameters.depth)}_renderAllGeometryDepth(a){a?(a=this._framebufferSize,a=this.fboCache.acquire(a.width,a.height,"depth").acquireDepth(r.DepthFormat.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(a.fbo),this._rctx.clear(t.FramebufferBit.DEPTH|t.FramebufferBit.STENCIL),this.renderAllGeometry(h.ShaderOutput.Depth),p.releaseMaybe(this._bindParameters.depth),this._bindParameters.depth=a.obtainDepthTexture(),a.release(),this.performanceInfo.advance(n.PerformanceCategory.DEPTH)):
this._bindParameters.depth=p.releaseMaybe(this._bindParameters.depth)}_renderTerrainDepth(a){if(a){a=this._renderContext.output;this._renderContext.output=h.ShaderOutput.Depth;var b=this._framebufferSize;b=this.fboCache.acquire(b.width,b.height,"terrain depth").acquireDepth(r.DepthFormat.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(b.fbo);this._rctx.clear(t.FramebufferBit.DEPTH|t.FramebufferBit.STENCIL);this._renderTransparentTerrain();p.releaseMaybe(this._bindParameters.terrainDepth);this._bindParameters.terrainDepth=
b.obtainDepthTexture();this._renderContext.output=a;b.release()}else this._bindParameters.terrainDepth=p.releaseMaybe(this._bindParameters.terrainDepth)}_renderGeometryDepth(a){if(a){a=this._renderContext.output;var {width:b,height:c}=this._framebufferSize,f=this.fboCache.acquire(b,c,"geometry depth").acquireDepth(r.DepthFormat.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(f.fbo);this._rctx.clear(t.FramebufferBit.DEPTH|t.FramebufferBit.STENCIL);this._renderOpaqueAndTransparentGeometry(h.ShaderOutput.Depth);
this._renderContext.output=a;p.releaseMaybe(this._bindParameters.geometryDepth);this._bindParameters.geometryDepth=f.obtainDepthTexture();f.release()}else this._bindParameters.geometryDepth=p.releaseMaybe(this._bindParameters.geometryDepth)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowAccumulation}_computeDepthRange(a){if(!this._needsDepthRange)return X.zero;const b=wa.depthRangeFromScene(a,this._plugins.plugins,this._stage.layers);X.union(b,this._plugins.queryDepthRange(a));
b.near=Math.max(a.near,b.near);b.far=Math.min(a.far,b.far);return b}get _normalsRequired(){const a=this._nodes.require("normals","final-color",k.RenderCategory.COMPOSITE,"opaque-color","transparent-color","laserline-color");return(this.hasSSAO?1:0)+a}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(h.ShaderOutput.Normal);this._needsDepth&&this._precompileAllGeometry(h.ShaderOutput.Depth);this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(h.ShaderOutput.ShadowHighlight),
this._precompileShadowCascades(h.ShaderOutput.ShadowExcludeHighlight),this._precompileShadowCascades(h.ShaderOutput.ShadowHighlight)):this._precompileShadowCascades(h.ShaderOutput.Shadow));this._needsShadowAccumulation&&this._precompileAllGeometry(h.ShaderOutput.Shadow)}_renderNormals(){const a=this._normalsRequired;if(0!==a){var b=this._framebufferSize;b=this.fboCache.acquire(b.width,b.height,"normals",r.ColorFormat.RGBA);b.acquireDepth(r.DepthFormat.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(b.fbo);
this._rctx.clearFramebuffer(B.ZEROS,!0,!0);this._renderGeometryWithNormals(h.ShaderOutput.Normal);var c=this._nodes.optional("normals","final-color",k.RenderCategory.COMPOSITE,"opaque-color","transparent-color","viewshed-color");b.retain(a+c-1);this.performanceInfo.advance(n.PerformanceCategory.NORMALS);return b}}_renderSSAO(){const a=this._pluginInput.get("normals");if(this.hasSSAO&&a){I.defaultWebGLFBO.setName(k.InternalRenderCategory.SSAO);var b=this._nodes.render(I.defaultWebGLFBO,this._pluginInput);
this._bindParameters.ssao=b;a.detachDepth();this._pluginInput.release("normals");this.performanceInfo.advance(n.PerformanceCategory.SSAO);return b}a?.detachDepth()}_precompileAllGeometry(a){const b=this._renderContext.output;this._renderContext.output=a;this._precompileOpaqueGeometry();this._precompileTransparentGeometry();this._plugins.precompile(e.RenderSlot.TRANSPARENT_TERRAIN);this._renderContext.output=b}renderAllGeometry(a){this._renderContext.output=a;this._renderOpaqueAndTransparentGeometry(a);
this._renderTransparentTerrain()}precompileSlots(a,...b){for(const c of b)this._bindParameters.slot=c,a.precompile(this._renderContext)}precompileOccludedSlots(a,b){for(const c of b)this._renderContext.renderOccludedMask=c,this.precompileSlots(a,...aa);this._renderContext.renderOccludedMask=R.defaultRenderOccludedMask}renderSlots(a,...b){for(const c of b)this._bindParameters.slot=c,a.forAll(f=>{const d=f.acquireTechniques(this._renderContext);d&&(f.render(this._renderContext,d,this._pluginInput),
oa.releaseTechniques(d))})}renderOccludedSlots(a,b){this._renderContext.renderOccludedMask=b;this.plugins.renderOccludedFlags>ya.RenderOccludedFlag.Occlude&&this._plugins.render(this._pluginInput,e.RenderSlot.OCCLUDED_TERRAIN);this.renderSlots(a,...aa);this._renderContext.renderOccludedMask=R.defaultRenderOccludedMask}renderHUD(a){this._bindParameters.hudRenderStyle=a;this._plugins.render(this._pluginInput,e.RenderSlot.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(h.ShaderOutput.ViewshedShadow)}renderViewshedShadowMap(a){const {camera:b,
contentCamera:c}=this._bindParameters,f=this._renderContext.output;a.setGLViewport(this._rctx);this._ensureBindParametersCamera(a,a);this.renderAllGeometry(h.ShaderOutput.ViewshedShadow);this._ensureBindParametersCamera(b,c);this._bindParameters.camera.setGLViewport(this._rctx);this._renderContext.output=f}_renderOpaqueAndTransparentGeometry(a){this._renderContext.output=a;this._renderOpaqueGeometry();this._renderTransparentGeometry()}_renderGeometryWithNormals(a){this._renderContext.output=a;this._plugins.render(this._pluginInput,
...Fa);this._renderTransparentTerrain()}_renderGeometryWithoutNormals(a){this._renderContext.output=a;this._plugins.render(this._pluginInput,...Ga)}_precompileOpaqueGeometry(){this._plugins.precompile(...U)}_renderOpaqueGeometry(){this._plugins.render(this._pluginInput,...U)}_renderTransparentGeometry(){this._plugins.render(this._pluginInput,...J)}get _needsTransparentTerrain(){return this._plugins.produces(h.ShaderOutput.Color,e.RenderSlot.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){const a=
()=>this._plugins.render(this._pluginInput,e.RenderSlot.TRANSPARENT_TERRAIN);if(h.isColorOrColorEmission(this._renderContext.output)){var b=this._framebufferSize;b=this.fboCache.acquire(b.width,b.height,"transparent terrain");this.renderToTargets(a,b,this._framebuffer.depth,B.ZEROS);return b}a()}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,e.RenderSlot.OCCLUSION_PIXELS)}_renderHUDVisibility(){if(this._needsHUDVisibility){var {width:a,height:b}=this._framebufferSize,
c=this._bindParameters.hudVisibility;if(c?.fbo?.width!==a||c?.fbo?.height!==b)c?.release(),c=this.fboCache.acquire(a,b,"hud visibility",r.ColorFormat.RGBA4),this._bindParameters.hudVisibility=c;c.attachDepth(this._bindParameters.geometryDepth||this._framebuffer.depth);this._rctx.bindFramebuffer(c.fbo);this._rctx.clearFramebuffer([0,1,0,1]);this._plugins.render(this._pluginInput,e.RenderSlot.OCCLUSION_PIXELS);c.detachDepth();this._framebuffer.bind();this.performanceInfo.advance(n.PerformanceCategory.HUD_VISIBILITY)}else this._bindParameters.hudVisibility=
p.releaseMaybe(this._bindParameters.hudVisibility)}_renderLineCallouts(a){this._bindParameters.hudRenderStyle=a;a===y.HUDRenderStyle.Occluded?(a=this._framebufferSize,a=this.fboCache.acquireDepth(r.DepthFormat.DEPTH16_BUFFER,a.width,a.height,"line callouts"),this.renderToTargets(()=>this._plugins.render(this._pluginInput,e.RenderSlot.LINE_CALLOUTS),this._framebuffer.color,a,void 0,!0,!0),a.release()):this._plugins.render(this._pluginInput,e.RenderSlot.LINE_CALLOUTS)}_renderHUD(a,b,c){this._pluginsHas.hudElements&&
(this._oitEnabled?(c=this._renderOIT(K.HUD,c,a),this._rctx.bindFramebuffer(b.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,c.getTexture()),c.release()):a===y.HUDRenderStyle.Occluded?(this._renderContext.output=h.ShaderOutput.Color,b=this._framebufferSize,b=this.fboCache.acquireDepth(r.DepthFormat.DEPTH16_BUFFER,b.width,b.height,"hud"),this.renderToTargets(()=>this._renderHUDElements(a),this._framebuffer.color,b,void 0,!0,!0),b.release()):(this._renderContext.output=
h.ShaderOutput.Color,b.acquireDepth(r.DepthFormat.DEPTH16_BUFFER),this._rctx.bindFramebuffer(b.fbo),this._renderHUDElements(a),b.detachDepth()),this.performanceInfo.advance(a===y.HUDRenderStyle.Occluded?n.PerformanceCategory.HUD_OCCLUDED:n.PerformanceCategory.HUD))}_renderHUDElements(a){this._bindParameters.hudRenderStyle=a;this._plugins.precompile(e.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,e.RenderSlot.HUD_MATERIAL,e.RenderSlot.LABEL_MATERIAL);this._plugins.render(this._pluginInput,e.RenderSlot.LINE_CALLOUTS_HUD_DEPTH,
e.RenderSlot.HUD_MATERIAL,e.RenderSlot.LABEL_MATERIAL)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(h.ShaderOutput.ShadowHighlight,e.RenderSlot.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(this.hasHighlights){var {fboCache:a,_rctx:b,_bindParameters:c}=this,f=this._framebufferSize,d=a.acquire(f.width,f.height,"highlights",r.ColorFormat.RG);d.acquireDepth(r.DepthFormat.DEPTH_STENCIL_TEXTURE);b.bindFramebuffer(d.fbo);b.clearFramebuffer(B.ZEROS,!0);this._renderContext.output=
h.ShaderOutput.Highlight;ra.renderHighlightBuffer(b,a,f,this._stage.view.highlights,c,()=>this._renderHighlightGeometries(),0,()=>b.bindFramebuffer(d.fbo));this.performanceInfo.advance(n.PerformanceCategory.HIGHLIGHTS);return d}}_renderHighlightGeometries(){const a=[e.RenderSlot.TRANSPARENT_MATERIAL,e.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,e.RenderSlot.OPAQUE_MATERIAL,e.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS];0===this._bindParameters.highlightLevel&&a.push(e.RenderSlot.TRANSPARENT_TERRAIN,
e.RenderSlot.INTEGRATED_MESH,e.RenderSlot.OPAQUE_TERRAIN);this._plugins.precompile(...a);this._plugins.render(this._pluginInput,...a);this._rctx.clear(t.FramebufferBit.DEPTH);this._renderHUDElements(y.HUDRenderStyle.Both)}get _needsShadowAccumulation(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(a,b,c){this._needsShadowAccumulation&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,a,b,c)&&this.performanceInfo.advance(n.PerformanceCategory.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){++this._plugins.context.techniques.precompiling;
this._oitEnabled&&h.isColorOrColorEmission(this._renderContext.output)?(this._bindParameters.oitPass=D.OITPass.ColorAlpha,this._plugins.precompile(...J),this._bindParameters.oitPass=D.OITPass.FrontFace,this._plugins.precompile(...J),this._bindParameters.oitPass=D.OITPass.NONE):this._plugins.precompile(...J);--this._plugins.context.techniques.precompiling}_renderOIT(a,b,c=y.HUDRenderStyle.Both){var f=a===K.HUD,d=this._framebufferSize;a=f?this.fboCache.acquire(d.width,d.height,"oit hud composite"):
null;f=f?()=>this._renderHUDElements(c):()=>this._renderTransparentGeometry();const l=this._bindParameters,g=this._renderContext.output;this._renderContext.output=b;l.oitPass=D.OITPass.ColorAlpha;b=this.fboCache.acquire(d.width,d.height,a?"oit hud color alpha":"oit color alpha",r.ColorFormat.RGBA16F);b.acquireColor(t.ColorAttachment.COLOR_ATTACHMENT1,r.ColorFormat.R16F);a||b.attachDepth(this._framebuffer.depth);this._rctx.bindFramebuffer(b.fbo);this._rctx.clearFramebuffer([0,0,0,1]);f();b.detachDepth();
l.oitPass=D.OITPass.FrontFace;d=this.fboCache.acquire(d.width,d.height,a?"oit hud front":"oit front");a?d.acquireDepth(r.DepthFormat.DEPTH16_BUFFER):d.attachDepth(this._framebuffer.depth);this._rctx.bindFramebuffer(d.fbo);this._rctx.clearFramebuffer(B.ZEROS,!!a);f();d.detachDepth();l.oitPass=D.OITPass.NONE;a?(this._rctx.bindFramebuffer(a.fbo),this._rctx.setClearColor(0,0,0,1E-13),this._rctx.clear(t.FramebufferBit.COLOR)):this._framebuffer.bind();this._oitblend??(this._oitblend=new sa.OITBlend(this._techniques));
this._oitblend.blend(this._rctx,b,d,l);a?.detachDepth();d.release();b.release();this._renderContext.output=g;return a}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters);this.performanceInfo.advance(n.PerformanceCategory.APPLY_ACCUMULATED_SHADOWS);this._framebuffer.bind();this._plugins.render(this._pluginInput,e.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH);this.performanceInfo.advance(n.PerformanceCategory.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(a,b){this._plugins.produces(this._renderContext.output,
a)&&(this._plugins.render(this._pluginInput,a),this.performanceInfo.advance(b))}_renderNodes(a,b,c=!1){b.setName(a);this._pluginInput.set(a,b);if(!this._nodes.produces(a))return c&&this.performanceInfo.advance(a),b;b=this._nodes.render(b,this._pluginInput,this._releaseNormals);this.performanceInfo.advance(a);return b}_blitFBO(a,b=I.defaultWebGLFBO,c=!0){this._blit??(this._blit=new qa.Blit(this._techniques));this._blit.blit(this._rctx,a,b,this._bindParameters);this._pluginInput.set(a.name,b);c&&a.release();
return b}_ensureBindParametersCamera(a,b){this._bindParameters.camera=a;this._bindParameters.contentCamera=b}_ensureBindParametersSSR(a){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=a);this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=F.IDENTITY:(E.invert(ba,this._bindParameters.camera.viewMatrix),E.invert(ca,this._bindParameters.camera.projectionMatrix),E.multiply(H,ba,ca),E.multiply(H,this._renderContext.lastFrameCamera.viewMatrix,
H),E.multiply(H,this._renderContext.lastFrameCamera.projectionMatrix,H),this._reprojectionMatrix=H);const b=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=0<b?Math.min(b,a-this._ssrEnableTime)/b:1;1>this._bindParameters.ssr.fadeFactor&&this._requestRender()}else this._reprojectionMatrix=F.IDENTITY,this._ssrEnableTime=null}addRenderNode(a){this._nodes.add(a);this._requestRender()}removeRenderNode(a){this._nodes.remove(a);this._requestRender()}updateLighting(a,b,c,
f){this._bindParameters.updateLighting(a,b,c,f);this._requestRender(Q.RenderRequestType.UPDATE)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(a,b,c,f,d=!1,l=!1){b.attachDepth(c);this._rctx.bindFramebuffer(b.fbo);this._rctx.clearFramebuffer(f,d,l);a();b.detachDepth()}get test(){}}N.__decorate([P.property({readOnly:!0})],L.prototype,"fullResolutionAtmosphere",null);N.__decorate([P.property()],L.prototype,"_edgeView",
void 0);N.__decorate([P.property()],L.prototype,"updating",null);var K;(function(a){a[a.Geometry=0]="Geometry";a[a.HUD=1]="HUD"})(K||={});const Fa=[e.RenderSlot.INTEGRATED_MESH,e.RenderSlot.OPAQUE_TERRAIN,e.RenderSlot.OPAQUE_MATERIAL,e.RenderSlot.TRANSPARENT_MATERIAL],Ga=[e.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS,e.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],U=[e.RenderSlot.INTEGRATED_MESH,e.RenderSlot.OPAQUE_TERRAIN,e.RenderSlot.OPAQUE_MATERIAL,e.RenderSlot.OPAQUE_MATERIAL_WITHOUT_NORMALS],
J=[e.RenderSlot.TRANSPARENT_MATERIAL,e.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],aa=[e.RenderSlot.OPAQUE_MATERIAL,e.RenderSlot.TRANSPARENT_MATERIAL,e.RenderSlot.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],ca=F.create(),ba=F.create(),H=F.create();V.Renderer=L;Object.defineProperty(V,Symbol.toStringTag,{value:"Module"})});