// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/mat3 ../../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../../core/support/UpdatingHandles ../../../../../chunks/sphere ../../../../../chunks/vec33 ../../../../ViewingMode ../../collections/Component/Material/shader/ComponentData.glsl ../../core/util/TwoVectorPosition ../Attribute ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ../VertexArrayObject ../VertexAttribute ./bufferLayouts ./edgeBufferWriters ./EdgeRenderer ./EdgeShaderParameters ./EdgeWorkerHandle ./interfaces ./strokes ./util ../TextureBackedBuffer/BufferManager ../../shaders/sources/edgeRenderer/EdgeUtil.glsl ../../../../webgl/BufferObject ../../../../webgl/enums".split(" "),
function(m,t,X,K,Ba,Y,L,M,N,u,Z,G,aa,H,x,C,ba,O,ca,da,ea,fa,ha,ia,ja,ka,la,ma,I,y,P,w,na,oa,Ca,pa,v,qa,z,Q,R){function S(a){a?.vao&&(a.vao.vertexBuffers.get("instances")?.dispose(),a.vao.disposeVAOOnly(),a.vao=null)}function ra(a){let b=null,c=null;for(const d of a.geometries)if(d.material.supportsEdges){if(!b)b=d.transformation;else if(!K.equals(b,d.transformation))return!1;if(!c&&null!=d.localOrigin)c=d;else if(null!=c?.localOrigin&&null!=d.localOrigin&&c.localOrigin.id!==d.localOrigin.id)return!1}return!0}
function J(a){const {meta:b,buffer:c}=a;a=new Uint8Array(4);for(let d=0;d<b.length;d++){const f=b[d].material,g=b[d].index,e=L.clamp(Math.round(f.size*w.lineWidthFractionFactor),0,255),h=L.clamp(f.extensionLength,-w.extensionLengthOffset,255-w.extensionLengthOffset)+w.extensionLengthOffset,k=255*f.opacity,l=f.color;c.textureBuffer.setData(g,0,255*l[0],255*l[1],255*l[2],255*l[3]);c.textureBuffer.setData(g,1,e,h,f.type,k);ea.encodeElevationOffset(b[d].verticalOffset,a);c.textureBuffer.setData(g,2,a[0],
a[1],a[2],a[3])}}function sa(a,b,c){let d,f;const g=b.camera.perScreenPixelRatio;a.forEachRenderable(e=>{if(null!=e.regular&&e.visible){d??=a.acquireTechnique(b,!1);f??=a.rctx.bindTechnique(d,b,c);var h=T(e.regular.lod.lengths,e.distanceToCamera,g);a.renderRegularEdges(f,e,c,b,h)}},c.transparency);d?.release()}function ta(a,b,c){let d,f;const g=b.camera.perScreenPixelRatio;a.forEachRenderable(e=>{if(null!=e.silhouette&&e.visible){d??=a.acquireTechnique(b,!0);f??=a.rctx.bindTechnique(d,b,c);var h=
T(e.silhouette.lod.lengths,e.distanceToCamera,g);a.renderSilhouetteEdges(f,e,c,b,h)}},c.transparency);d?.release()}function T(a,b,c){b*=c;c=K.binaryIndexOf(a,b,!0);return-1===c?b<a[0]?a.length:0:a.length-c}m.EdgeView=class extends X{constructor(a){super(a);this._updatingHandles=new ba.UpdatingHandles;this._objectEntries=new Map;this._pendingDeletions=new Map;this._renderers=new Map;this._gpuMemoryUsage=0;this._workerAbort=new AbortController;this._tmpModelPosition=C.create();this._localOrigins=new ka.LocalOriginManager(new ia.GridLocalOriginFactory(a.renderSR));
const b=y.VertexLayout.createBuffer(4);for(let c=0;4>c;c++)b.sideness.set(c,0,0===c||3===c?0:1),b.sideness.set(c,1,0===c||1===c?0:1);this._verticesBufferObject=Q.BufferObject.createVertex(a.rctx,R.Usage.STATIC_DRAW,b.buffer)}initialize(){this._worker=new oa.EdgeWorkerHandle(this.schedule);this._componentColorManager=new qa.BufferManager(this.rctx,3)}destroy(){this.destroyed||(this._objectEntries.forEach(a=>this._discardObjectEntry(a)),this._objectEntries.clear(),this._pendingDeletions.forEach(a=>
this._discardObjectEntry(a)),this._pendingDeletions.clear(),this._strokesTexture=M.disposeMaybe(this._strokesTexture),this._componentColorManager=M.destroyMaybe(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject.dispose(),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",ua))}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return 0<this._renderers.size}async addComponentObject(a,
b,c,d,f,g,e){if(this.hasObject(a))return this._getObjectMemoryUsage(a);let h;const k=new U(null,new Promise(l=>h=l),a.obb.center,a.obb.radius);this._objectEntries.set(a,k);a=await this._updatingHandles.addPromise(this._addComponentGeometry(a.transform,k,b,c,d,f,g,e));this.setNeedsRender();h();return a}async addOrUpdateObject3D(a,b,c,d){if(this.destroyed)Y.getLogger(this).warn("Attempt to add an object to a destroyed instance");else{var f=new AbortController,g,e=a.boundingVolumeWorldSpace.bounds;f=
new U(f,new Promise(h=>g=h),O.getCenter(e),O.getRadius(e));(e=this._objectEntries.get(a))&&(this._pendingDeletions.has(a)?this._discardObjectEntry(e):this._pendingDeletions.set(a,e));this._objectEntries.set(a,f);try{e=[];if(1<a.geometries.length&&ra(a))e.push(this._addObjectMergedGeometries(a,f,b,c,d));else for(const h of a.geometries)h.material.supportsEdges&&e.push(this._addGeometry(a,f,h,b,c,d));await this._updatingHandles.addPromise(Promise.all(e));this._removePendingDeletion(a)}catch(h){N.isAbortError(h)?
this._discardObjectEntry(f):this._removePendingDeletion(a)}finally{this.setNeedsRender(),g()}}}removeObject(a){const b=this._objectEntries.get(a);this._objectEntries.delete(a);this._discardObjectEntry(b);this._removePendingDeletion(a)}_removePendingDeletion(a){const b=this._pendingDeletions.get(a);this._pendingDeletions.delete(a);this._discardObjectEntry(b)}async _getObjectEntry(a){a=this._objectEntries.get(a);if(!a)throw Error("no object");await a.loaded;return null==a.loaded?null:a}fastUpdateObject3DEdgesTransform(a){if(this.destroyed)return!1;
var b=this._objectEntries.get(a);if(!b)return!1;var {geometries:c}=a;({renderables:b}=b);if(0===c.length||0===b.length)return!0;if(1<b.length)return!1;[b]=b;var d=b.transform;if(!(d instanceof D))return!1;[c]=c;if(c.localOrigin!==d.origin.origin)return!1;d=H.create();a=this._computeModelTransformWithLocalOrigin(a,c,d);b.transform=new D(d,a);this.setNeedsRender();return!0}_discardObjectEntry(a){a&&(a.abort?.abort(),a.renderables.length&&(a.renderables.forEach(b=>this._removeRenderable(b)),this.setNeedsRender()),
a.loaded=null)}hasObject(a){return this._objectEntries.has(a)}async updateAllComponentOpacities(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));if(null!=a){var c=Array.isArray(b)?d=>b[d]:()=>b;a.renderables.forEach(d=>{const f=d.components.meta.length;for(let g=0;g<f;g++){const e=c(g),h=d.components.meta[g],k=h.index;h.material.opacity=e;d.components.buffer.textureBuffer.setDataElement(k,1,3,255*e)}this._updateTransparency(d)});this.setNeedsRender()}}async _getObjectMemoryUsage(a){return(a=
await this._getObjectEntry(a))?a.renderables.reduce((b,c)=>b+c.statistics.gpuMemoryUsage,0):0}async updateAllComponentMaterials(a,b,c,d){const f=a instanceof la.Object3D,g=v.determineRendererType(b),e=w.EdgeRenderer.getKey(g,c,f);a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&(a.renderables.forEach(h=>{if(e!==h.rendererKey){var k=this._renderers.get(h.rendererKey);const l=this._acquireRenderer(g,c,f);k.removeRenderable(h);--k.refCount;h.rendererKey=e;l.addRenderable(h)}if(Array.isArray(b))for(k=
0;k<b.length;k++)h.components.meta[k].material=b[k];else h.components.meta[0].material=b;d&&J(h.components);this._updateTransparency(h)}),this.setNeedsRender())}async updateAllVerticalOffsets(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&this._updateAllVerticalOffsets(a,b)}_updateAllVerticalOffsets(a,b){a.renderables.forEach(c=>{const d=c.components.meta;for(let f=0;f<d.length;f++)c.components.meta[f].verticalOffset=b?.[f]??0;J(c.components)});this.setNeedsRender()}async updateObjectVisibility(a,
b){if(a=await this._updatingHandles.addPromise(this._getObjectEntry(a)))a.renderables.forEach(c=>c.visible=b),this.setNeedsRender()}render(a,b){if(null!=this._componentColorManager){this._localOrigins.updateViewMatrices(a.camera.viewMatrix);var c=a.camera.viewInverseTransposeMatrix,d=C.create(),f=new fa.TwoVectorPosition,g=0,e=0;this._renderers.forEach(k=>{0===k.refCount?this._renderers.delete(k.key):(++this.techniques.precompiling,k.forEachRenderable(l=>{l.visible&&(g+=l.statistics.averageEdgeLength,
e++,l.regular&&k.acquireTechnique(a,!1).release(),l.silhouette&&k.acquireTechnique(a,!0).release())},b),--this.techniques.precompiling)});this._componentColorManager.garbageCollect();this._componentColorManager.updateTextures();if(0!==e){var h=new na.EdgePassParameters(40*g/e,b);x.set(d,c[3],c[7],c[11]);f.set(d);x.copy(h.transformWorldFromViewTH,f.high);x.copy(h.transformWorldFromViewTL,f.low);G.fromMat4(h.transformViewFromCameraRelativeRS,a.camera.viewMatrix);G.transpose(V,h.transformViewFromCameraRelativeRS);
G.invert(h.transformNormalViewFromGlobal,V);h.transformProjFromView=a.camera.projectionMatrix;this._updateObjectCameraDistances(a);this._renderers.forEach(k=>{sa(k,a,h);ta(k,a,h)})}}}_updateTransparency(a){const b=v.determineEdgeTransparency(a.components.meta),c=v.determineObjectTransparency(a.components.meta);if(b!==a.edgeTransparency||c!==a.objectTransparency)a.edgeTransparency=b,a.objectTransparency=c,this._renderers.get(a.rendererKey).setRenderablesDirty()}_computeModelTransformWithLocalOrigin(a,
b,c){a.getCombinedShaderTransformation(b,c);a=null!=b.localOrigin?this._localOrigins.register(b.localOrigin):this._localOrigins.acquire(x.set(this._tmpModelPosition,c[12],c[13],c[14]));b.localOrigin=a.origin;ja.applyToModelMatrix(a.origin.vec3,c);return a}_createComponentBuffers(a){if(null==this._componentColorManager)return null;const b=[],c=this._componentColorManager.getBuffer(a.length);for(let d=0;d<a.length;d++){const f=a[d],g=c.acquireIndex();b.push({index:g,verticalOffset:0,material:f})}a=
new va(c,b);J(a);return a}_extractEdges(a,b,c,d,f,g,e=g.length){128>e&&(f=!0);return this._worker.process({data:c,indices:g,indicesLength:e,writerSettings:b,skipDeduplicate:d},a,f)}_createRenderable(a,b,c,d,f){var g=h=>new wa(new ma.VertexArrayObject(this.rctx,y.vertexAttributeLocations,new Map([["vertices",y.glVertexLayout],["instances",h===z.EdgeSilhouette.REGULAR?P.RegularEdgeBufferWriter.glLayout:P.SilhouetteEdgeBufferWriter.glLayout]]),new Map([["vertices",this._verticesBufferObject],["instances",
Q.BufferObject.createVertex(this.rctx,R.Usage.STATIC_DRAW,h===z.EdgeSilhouette.REGULAR?a.regular.instancesData.buffer:a.silhouette.instancesData.buffer)]])),h===z.EdgeSilhouette.REGULAR?a.regular.lodInfo:a.silhouette.lodInfo);const e=0<a.regular.lodInfo.lengths.length?g(z.EdgeSilhouette.REGULAR):null;g=0<a.silhouette.lodInfo.lengths.length?g(z.EdgeSilhouette.SILHOUETTE):null;return new E(e,g,{gpuMemoryUsage:(e?.vao.usedMemory??0)+(g?.vao.usedMemory??0),externalMemoryUsage:f,averageEdgeLength:a.averageEdgeLength},
c,v.determineEdgeTransparency(b.meta),v.determineObjectTransparency(b.meta),b,d)}async _addGeometry(a,b,c,d,f,g){if(!(0>=c.edgeIndicesLength)){var e=c.attributes.get(I.VertexAttribute.POSITION),h=H.create();a=this._computeModelTransformWithLocalOrigin(a,c,h);e=new W(e,h,a);return this._addPositionData(b,e,c.edgeIndicesLength,d,f,g)}}async _addPositionData(a,b,c,d,f,g=!1){if(null!=a.loaded){var e=this._createComponentBuffers([d]);if(null!=e){d=this._acquireRenderer(d.type,f,!0);var {modelTransform:h,
origin:k}=b;f=b.position.indices;b=b.position;var l=b.data.length/b.size,p=y.EdgeInputBufferLayout.createBuffer(l);for(let r=0;r<l;r++)p.position.set(r,0,b.data[r*b.size]),p.position.set(r,1,b.data[r*b.size+1]),p.position.set(r,2,b.data[r*b.size+2]);v.fillComponentBufferIndices(e.meta,[0,p.componentIndex.count],p.componentIndex);c=await this._updatingHandles.addPromise(this._extractEdges(a.abort?.signal||this._workerAbort.signal,d.writerSettings,p,!1,g,f,c));null!=a.loaded&&(e=this._createRenderable(c,
e,new D(h,k),d.key,!1),a.renderables.push(e),d.addRenderable(e),this._gpuMemoryUsage+=e.statistics.gpuMemoryUsage)}}}async _addComponentGeometry(a,b,c,d,f,g,e,h){if(null==b.loaded)return 0;const k=this._createComponentBuffers(g);if(null==k)return 0;g=v.determineRendererType(g);e=this._acquireRenderer(g,e||!1,!1);g=y.EdgeInputBufferLayout.createBuffer(c.length/3);ca.copy(g.position.typedBuffer,c,g.position.typedBufferStride,3);v.fillComponentBufferIndices(k.meta,f,g.componentIndex,d);c=await this._updatingHandles.addPromise(this._extractEdges(this._workerAbort.signal,
e.writerSettings,g,!0,!1,d));if(null==b.loaded)return 0;a=this._createRenderable(c,k,a,e.key,!0);b.renderables.push(a);e.addRenderable(a);this._updateAllVerticalOffsets(b,h);return a.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(a,b,c,d,f){const g=new Map;let e=0,h=0,k=null;var l=a.geometries.filter(q=>{if(0>=q.edgeIndicesLength||!q.material.supportsEdges)return!1;!k&&q.localOrigin&&(k=q);const n=q.attributes.get(I.VertexAttribute.POSITION);h+=n.data.length/n.size;e+=q.edgeIndicesLength;
return!0});if(0!==l.length){var p=65536<=h?Uint32Array:Uint16Array,r=e?new p(e):null,A=[],xa=0;l.forEach(q=>{var n=q.attributes.get(I.VertexAttribute.POSITION);const ya=n.indices;let F=g.get(n.data);if(null==F){F=A.length/3;for(let B=0;B<n.data.length;B+=n.size)A.push(n.data[B]),A.push(n.data[B+1]),A.push(n.data[B+2]);g.set(n.data,F)}for(n=0;n<q.edgeIndicesLength;n++)r[xa++]=F+ya[n]});p=k||a.geometries[0];l=H.create();p=this._computeModelTransformWithLocalOrigin(a,p,l);for(let q=0;q<a.geometries.length;q++)a.geometries[q].localOrigin=
p.origin;a=new W(new ha.Attribute(A,r,3),l,p);await this._updatingHandles.addPromise(this._addPositionData(b,a,r.length,c,d,f))}}_acquireRenderer(a,b,c){const d=w.EdgeRenderer.getKey(a,b,c);let f=this._renderers.get(d);null==this._strokesTexture&&(this._strokesTexture=pa.generateStrokesTexture(this.rctx));f||(f=new w.EdgeRenderer(this.rctx,this.techniques,{type:a,hasSlicePlane:b,strokesTexture:this._strokesTexture,legacy:c,spherical:this.viewingMode===da.ViewingMode.Global}),this._renderers.set(d,
f));++f.refCount;return f}_removeRenderable(a){S(a.regular);S(a.silhouette);const b=this._renderers.get(a.rendererKey);if(b){b.removeRenderable(a);--b.refCount;this._localOrigins.release(a.transform.origin);this._gpuMemoryUsage-=a.statistics.externalMemoryUsage?0:a.statistics.gpuMemoryUsage;for(const c of a.components.meta)a.components.buffer.releaseIndex(c.index)}}_updateObjectCameraDistances(a){const b=a.camera.eye,c=a.camera.viewForward,d=C.create();a=f=>{x.sub(d,f.center,b);const g=x.dot(d,c),
e=f.radius,h=g<-e?Infinity:g<e?0:g-e;f.renderables.forEach(k=>k.distanceToCamera=h)};this._objectEntries.forEach(a);this._pendingDeletions.forEach(a)}get test(){}};t.__decorate([u.property({constructOnly:!0})],m.EdgeView.prototype,"rctx",void 0);t.__decorate([u.property({constructOnly:!0})],m.EdgeView.prototype,"renderSR",void 0);t.__decorate([u.property({constructOnly:!0})],m.EdgeView.prototype,"viewingMode",void 0);t.__decorate([u.property({constructOnly:!0})],m.EdgeView.prototype,"techniques",
void 0);t.__decorate([u.property({constructOnly:!0})],m.EdgeView.prototype,"setNeedsRender",void 0);t.__decorate([u.property({constructOnly:!0})],m.EdgeView.prototype,"schedule",void 0);t.__decorate([u.property({readOnly:!0})],m.EdgeView.prototype,"_updatingHandles",void 0);t.__decorate([u.property({readOnly:!0})],m.EdgeView.prototype,"updating",null);m.EdgeView=t.__decorate([Z.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],m.EdgeView);class U{constructor(a,b,c,d){this.abort=a;
this.radius=d;this.renderables=[];const f=a?N.onAbortOrThrow(a.signal,()=>a.abort()):null;this.loaded=b;this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0);this.abort=null;f?.remove()});this.center=C.clone(c)}}class va{constructor(a,b){this.buffer=a;this.meta=b}}class wa{constructor(a,b){this.vao=a;this.lod=b}}class D{constructor(a,b){this.modelMatrix=a;this.origin=b}}class E{constructor(a,b,c,d,f,g,e,h){this.regular=a;this.silhouette=b;this.statistics=c;this.transform=d;this.edgeTransparency=
f;this.objectTransparency=g;this.components=e;this.rendererKey=h;this.distanceToCamera=0;this.visible=!0}}class za extends E{}class Aa extends E{}class W{constructor(a,b,c){this.position=a;this.modelTransform=b;this.origin=c}}const V=aa.create(),ua=()=>Promise.reject();m.LegacyTransform=D;m.RegularRenderable=za;m.Renderable=E;m.SilhouetteRenderable=Aa;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});