// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../webgl/formats ./textureUtils ./ViewshedFaceCamera ../../../webgl/enums".split(" "),function(B,J,w,K,L,M,p,t,u,C,N,D){class O{constructor(){this.textureSizeQuality=1;this.textureSizeModHighQuality=1.3;this.textureSizeModLowQuality=.9;this.textureSizeMultiple=
128;this.toleranceSides=5;this.toleranceBottomTop=10}textureSizeModifier(a){return this.textureSizeQuality*(a?this.textureSizeModHighQuality:this.textureSizeModLowQuality)}textureResizeModulo(a){return Math.ceil(a/this.textureSizeMultiple)*this.textureSizeMultiple}}const x="front left right back top bottom".split(" ");class P{constructor(a){this._fbos=a;this._minTextureSize=16;this._faces={};this._height=this._width=0;this.settings=new O;this._maxTextureSize=Math.min(J("esri-mobile")?4096:16384,a.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture()}get ready(){return null!=
this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const a=this.faces;return 0===a.length?null:a[0].nearFar}get numActiveFaces(){const a=this._faces;let b=0;Object.keys(a).forEach(c=>{a[c]&&(b+=1)});return b}get faces(){const a=this._faces,b=[];for(const c of x){const d=a[c];d&&b.push(d)}return b}get atlasRegions(){return this.faces.map(a=>[a.x/this._width,(a.x+a.width)/this._width,a.y/this._height,(a.y+a.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(a=>
a.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(a=>a.viewMatrix)}_setupFaceCamera(a,b,c,d){const {effectiveObserverRenderSpace:f,tiltedUpVector:h,targetRenderSpace:m,farDistanceRenderSpace:q,horizontalFieldOfView:n,verticalFieldOfView:r}=b,g=t.create();p.sub(g,m,f);const k=t.create(),l=t.create(),y=(Q,R)=>{const v=t.create(),E=M.create();L.fromRotation(E,Q,R);p.transformMat4(v,g,E);p.add(v,f,v);return v};let z=h;const F=Math.min(90,n),G=Math.min(90,Math.max(0,(n-90)/2));b=-45;
let A=45,H=-45,I=45;["top","bottom"].includes(a)||(H=w.clamp(-r/2,-45,45)-this.settings.toleranceBottomTop,I=w.clamp(+r/2,-45,45)+this.settings.toleranceBottomTop);switch(a){case "front":var e=m;b=-F/2;A=F/2;break;case "left":e=y(Math.PI/2,h);b=45-G;break;case "right":e=y(-Math.PI/2,h);A=-45+G;break;case "top":e=p.add(k,f,h);z=p.negate(l,g);break;case "bottom":e=p.sub(k,f,h);z=g;break;case "back":e=y(Math.PI,h)}e=new N.ViewshedFaceCamera({center:e,eye:f,up:z,far:q});e.sectionAnglesDeg=[b-this.settings.toleranceSides,
A+this.settings.toleranceSides,H,I];e.fovY=Math.PI/2;c=e.setViewport(c,d);this._faces[a]=e;return c}isActive(a){return 0<this._computeActiveFaces(a).size}_computeActiveFaces(a){const b=new Set,{horizontalFieldOfView:c,verticalFieldOfView:d}=a;a=-d/2;const f=d/2;if(0===c||0===d)return b;45>=a&&-45<=f&&b.add("front");90<c&&(b.add("left"),b.add("right"));270<c&&b.add("back");f>45-this.settings.toleranceBottomTop&&b.add("top");a<-45+this.settings.toleranceBottomTop&&b.add("bottom");return b}_computeBaseTextureSize(a,
b,c,d){b/=a.pixelRatio;c=this.settings.textureSizeModifier(c);a=C.applyTextureResizeModulo(Math.floor(Math.max(a.fullWidth,a.fullHeight)*b*c));d=w.clamp(a,this._minTextureSize,Math.floor(this._maxTextureSize/d));return C.applyTextureResizeFloorModulo(d)}_ensureFBO(a){const b=this._width,c=this._height;if(this._handle?.fbo?.width!==b||this._handle?.fbo?.height!==c)this._handle?.release(),this._handle=this._fbos.acquire(b,c,"viewshed shadow map",u.ColorFormat.RGBA4);this._handle.acquireDepth(a?u.DepthFormat.DEPTH_STENCIL_TEXTURE:
u.DepthFormat.DEPTH16_BUFFER)}clearFBO(a){const b=this._fbos.rctx;this._ensureFBO(a);b.bindFramebuffer(this._handle?.fbo);b.setClearColor(1,1,1,1);b.clear(D.FramebufferBit.COLOR|D.FramebufferBit.DEPTH)}dispose(){this._handle=K.releaseMaybe(this._handle)}start(a,b,c,d,f=!1){this._faces={};const h=this._computeActiveFaces(b),m=h.size;if(0===m)return!1;const q=this._computeBaseTextureSize(a,d,c,m);let n=0,r=0,g=0;x.filter(k=>h.has(k)).forEach(k=>{if(4>m)var l=0;else l="front"===k||"left"===k,l=4===m?
l?0:1:l||"right"===k?0:1;l>r&&(g=Math.max(g,n),n=0);r=l;n+=this._setupFaceCamera(k,b,[n,l*q],q)});g=Math.max(g,n);this._width=this.settings.textureResizeModulo(g);this._height=(4>m?1:2)*q;this.clearFBO(f);return!0}finish(){this._handle?.detachDepth()}get test(){return{faces:this._faces,faceTypes:x,width:this._width,height:this._height,getFBO:()=>this._fbos.acquire(this._width,this._height,"viewshed shadow map",u.ColorFormat.RGBA4)}}}B.ViewshedShadowMap=P;Object.defineProperty(B,Symbol.toStringTag,
{value:"Module"})});