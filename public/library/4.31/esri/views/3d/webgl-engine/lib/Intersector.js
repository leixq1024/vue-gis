// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/support/ray ../../../ViewingMode ./IntersectorInterfaces ./IntersectorTarget ./intersectorUtils ./verticalOffsetUtils".split(" "),function(u,D,y,d,n,H,I,f,E,m,J,K,z){class L{constructor(a){this.options=new m.IntersectorOptions;
this._results=new M;this.transform=new z.IntersectorTransform;this.tolerance=1E-5;this.verticalOffset=null;this._ray=f.create();this._rayEnd=n.create();this._rayBeginTransformed=n.create();this._rayEndTransformed=n.create();this.viewingMode=null==a?E.ViewingMode.Global:a}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(a,b,c){this.resetWithRay(f.fromPoints(a,b,this._ray),c)}resetWithRay(a,b){this.camera=b;a!==
this._ray&&f.copy(a,this._ray);0!==this.options.verticalOffset?this.viewingMode===E.ViewingMode.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null;d.add(this._rayEnd,this._ray.origin,this._ray.direction);this._results.init(this._ray)}intersect(a=null,b,c,p,h){this.point=b;this.filterPredicate=p;this.tolerance=null==c?1E-5:c;b=z.getVerticalOffsetObject3D(this.verticalOffset);if(a&&0<a.length){const k=h?e=>{h(e)&&this.intersectObject(e)}:
e=>{this.intersectObject(e)};for(const e of a)a=e.getSpatialQueryAccelerator?.(),null!=a?(null!=b?a.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,k,b):a.forEachAlongRay(this._ray.origin,this._ray.direction,k),this.options.selectionMode&&this.options.hud&&a.forEachDegenerateObject(k)):e.objects.forAll(A=>k(A))}this.sortResults()}intersectObject(a){const b=a.geometries;if(b){var c=a.effectiveTransformation,p=z.getVerticalOffsetObject3D(this.verticalOffset);for(const h of b){if(!h.visible)continue;
const {material:k,id:e}=h;if(!k.visible)continue;this.transform.setAndInvalidateLazyTransforms(c,h.transformation);d.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse);d.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const A=this.transform.transform;null!=p&&(p.objectTransform=this.transform);k.intersect(h,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(q,F,G,l,v,N)=>{if(0<=q&&(null==this.filterPredicate||this.filterPredicate(this._ray.origin,
this._rayEnd,q))){var g=l?this._results.hud:this._results,w=l?B=>{const O=new J.HudTarget(a,e,G,N);B.set(m.IntersectorType.HUD,O,q,F,y.IDENTITY,v)}:B=>B.set(m.IntersectorType.OBJECT,{object:a,geometryId:e,triangleNr:G},q,F,A,v);(null==g.min.drapedLayerOrder||v>=g.min.drapedLayerOrder)&&(null==g.min.dist||q<g.min.dist)&&w(g.min);this.options.store!==m.StoreResults.MIN&&(null==g.max.drapedLayerOrder||v<g.max.drapedLayerOrder)&&(null==g.max.dist||q>g.max.dist)&&w(g.max);this.options.store===m.StoreResults.ALL&&
(l?(l=new C(this._ray),w(l),this._results.hud.all.push(l)):(l=new r(this._ray),w(l),this._results.all.push(l)))}})}}}sortResults(a=this._results.all){a.sort((b,c)=>b.dist!==c.dist?(b.dist??0)-(c.dist??0):b.drapedLayerOrder!==c.drapedLayerOrder?(c.drapedLayerOrder??-Number.MAX_VALUE)-(b.drapedLayerOrder??-Number.MAX_VALUE):(c.drapedLayerGraphicOrder??-Number.MAX_VALUE)-(b.drapedLayerGraphicOrder??-Number.MAX_VALUE))}}class M{constructor(){this.min=new r(f.create());this.max=new r(f.create());this.hud=
{min:new C(f.create()),max:new C(f.create()),all:[]};this.ground=new r(f.create());this.all=[]}init(a){this.min.init(a);this.max.init(a);this.ground.init(a);this.all.length=0;this.hud.min.init(a);this.hud.max.init(a);this.hud.all.length=0}}class r{get ray(){return this._ray}get distanceInRenderSpace(){return null!=this.dist?(d.scale(x,this.ray.direction,this.dist),d.length(x)):null}getIntersectionPoint(a){if(!K.isValidIntersectorResult(this))return!1;d.scale(x,this.ray.direction,this.dist);d.add(a,
this.ray.origin,x);return!0}getTransformedNormal(a){d.copy(t,this.normal);t[3]=0;H.transformMat4(t,t,this.transformation);d.copy(a,t);return d.normalize(a,a)}constructor(a){this.intersector=m.IntersectorType.OBJECT;this.normal=n.create();this.transformation=y.create();this._ray=f.create();this.init(a)}init(a){this.drapedLayerGraphicOrder=this.drapedLayerOrder=this.target=this.dist=null;this.intersector=m.IntersectorType.OBJECT;f.copy(a,this._ray)}set(a,b,c,p,h,k,e){this.intersector=a;this.dist=c;
d.copy(this.normal,p??n.UNIT_Z);D.copy(this.transformation,h??y.IDENTITY);this.target=b;this.drapedLayerOrder=k;this.drapedLayerGraphicOrder=e}copy(a){f.copy(a.ray,this._ray);this.intersector=a.intersector;this.dist=a.dist;this.target=a.target;this.drapedLayerOrder=a.drapedLayerOrder;this.drapedLayerGraphicOrder=a.drapedLayerGraphicOrder;d.copy(this.normal,a.normal);D.copy(this.transformation,a.transformation)}}class C extends r{constructor(){super(...arguments);this.intersector=m.IntersectorType.HUD}}
const x=n.create(),t=I.create();u.defaultTolerance=1E-5;u.newIntersector=function(a){return new L(a)};u.newIntersectorResult=function(a){return new r(a)};Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});