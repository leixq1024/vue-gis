// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/floatRGBA ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/time ../../../../core/accessorSupport/decorators/property ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/spatialReferenceUtils ../../../ViewingMode ../../environment/ChapmanAtmosphere ../../environment/CloudsComposition ../../environment/Fog ../../environment/LocalAtmosphere ../../environment/MarsAtmosphere ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/ShaderTechniqueConstructionContext ../core/shaderTechnique/ShaderTechniqueRepository ../effects/geometry/ObjectAndLayerIDRenderNode ../effects/geometry/olidUtils ../effects/geometry/RenderOccludedRenderNode ../effects/haze/Haze ../effects/highlight/Highlight ../effects/highlight/ShadowHighlight ../effects/magnifier/Magnifier ../effects/smaa/SMAA ../effects/ssao/SSAO ../effects/stars/Stars ../lib/basicInterfaces ../lib/CompositingHelper ../lib/GLMaterialRepository ../lib/ObjectAndLayerIdRenderHelper ../lib/Renderer ../lib/RenderingContext ../lib/TextureRepository ../materials/markerTextureRepository ../materials/stippleTextureRepository ../materials/internal/WaterTextureRepository ./contextCache ./renderUtils ./ScreenshotManager ./testUtils ../../../support/RenderState".split(" "),
function(e,g,z,A,B,C,t,l,p,D,E,k,ma,F,u,G,H,I,J,K,L,M,N,O,P,v,Q,R,S,T,U,V,W,X,m,Y,Z,aa,ba,w,ca,da,ea,fa,ha,ia,x,ja,ka){function la(a,d){const b={disabledExtensions:d.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:d.options.debugWebGLExtensions||{},maxAnisotropy:8,newCache:(c,f)=>d.view.resourceController.memoryController.newCache(c,f)};if(ja.contextCache.enabled){let c=y.get(a);if(c)return c.configure(b),c.ref(),c;c=new w.RenderingContext(a,b);y.set(a,c);c.ref();return c}return new w.RenderingContext(a,
b)}e.RenderView=class extends z{constructor(a){super({});this.events=new A;this.waterTextures=new fa.WaterTextureRepository;this.olidRenderHelper=v.olidEnabled()?new aa.ObjectAndLayerIdRenderHelper:null;this._idleSuspend=this._needsRender=this._needsUpdate=!0;this._needsWaterReflectionUpdate=!1;this._lastAnimationUpdate=0;this._container=a.container;this._viewingMode=a.viewingMode;try{this._initializeContext(a)}catch(b){console.error("Failed to initialize context",b);return}const {memoryController:d}=
a.view.resourceController;this.stippleTextures=ea.createStippleTextureRepository(this._rctx,d);this.markerTextures=da.createMarkerTextureRepository(this._rctx,d);this._techniques=new O.ShaderTechniqueRepository(new N.ShaderTechniqueConstructionContext(this._rctx,a.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures));this._textures=new ca.TextureRepository(a,this._techniques,this._rctx);this.addHandles(this._textures.events.on("changed",b=>this.requestRender(b)));this._materials=
new Z.GLMaterialRepository(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender());this._compositingHelper=new Y(this._rctx,this._techniques);this.renderer=new ba.Renderer(a,this._materials,this._techniques,this._rctx,this._compositingHelper,b=>this.requestRender(b));this.addHandles([p.watch(()=>a.view.ready,b=>{b&&this._createRenderNodes(a.view,a.viewingMode)},p.initial),p.watch(()=>this.waterTextures?.updating,()=>this.requestRender(),p.initial),p.watch(()=>a.view.qualityProfile,
b=>this.renderer?.updateRenderFeatures(b),p.syncAndInitial)]);this._screenshotManager=new x.ScreenshotManager(this._rctx,{renderScene:(b,c,f,h)=>this.renderer.render(b,c,f,h),requestRenderScene:b=>this.requestRender(b),prepareOverlay:()=>a.options.screenshot.prepareOverlay(),renderOverlay:(b,c,f)=>a.options.screenshot.renderOverlay(b,c,f)},b=>this.events.emit("force-camera-for-screenshot",b));this._registerFrameTask(a)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&
this._container.removeChild(this._canvas);this._frameTask=l.removeMaybe(this._frameTask);this._techniques=l.destroyMaybe(this._techniques);this._componentObjects=l.destroyMaybe(this._componentObjects);this._screenshotManager=l.destroyMaybe(this._screenshotManager);l.destroyMaybe(this.renderer);this._textures=l.destroyMaybe(this._textures);l.destroyMaybe(this.waterTextures);l.destroyMaybe(this.markerTextures);l.destroyMaybe(this.stippleTextures);this._container=this._canvas=null;this._rctx=l.destroyMaybe(this._rctx)}_createRenderNodes(a,
d){new X.Stars({view:a,techniques:this._techniques});u.isMoon(a.spatialReference)||(d===G.ViewingMode.Local?new K.LocalAtmosphere({view:a,techniques:this._techniques}):u.isMars(a.spatialReference)?new L({view:a,techniques:this._techniques}):(new H.ChapmanAtmosphere({view:a,techniques:this._techniques}),new I.CloudsComposition({view:a,techniques:this._techniques}),new R.Haze({view:a,techniques:this._techniques}),new J.Fog({view:a,techniques:this._techniques})));new W.SSAO({view:a,isEnabled:()=>this.renderer.hasSSAO,
techniques:this._techniques});new V.SMAA({view:a,isEnabled:()=>this.renderer.hasSMAA,techniques:this._techniques});new U.Magnifier({view:a,techniques:this._techniques});new S.Highlight({view:a,techniques:this._techniques});new T.ShadowHighlight({view:a,viewingMode:d,techniques:this._techniques});new Q.RenderOccludedRenderNode({view:a,techniques:this._techniques});v.olidEnabled()&&new P.ObjectAndLayerIDRenderNode({view:a})}requestRender(a=m.RenderRequestType.UPDATE){this._needsRender=!0;a===m.RenderRequestType.UPDATE&&
(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(a){this._idleSuspend!==a&&(this._idleSuspend=a,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(a){return this._screenshotManager.takeScreenshot(a).then(d=>
d[0])}takeScreenshotWithOID(a){a.objectAndLayerIdColor=!0;return this._screenshotManager.takeScreenshot(a)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(a,d,b,c,f,h=f){h=c.constrainWindowSize(d,b,f*c.pixelRatio,h*c.pixelRatio);const q=this._ensureLinearDepthArrayBuffer(h);this.renderer.readMainDepth(h,q);f=Number.MAX_VALUE;for(let r=0;r<h[2]*h[3];r++){var n=c.nearFar;n=B.unpackFloatRGBA(q,4*r)*(n[1]-n[0])+n[0];f>n&&n!==c.nearFar[0]&&n!==c.nearFar[1]&&(f=n)}a&&(a=a.pickDepth(d*
c.pixelRatio,b*c.pixelRatio,c),null!=a&&f>a&&a!==c.nearFar[0]&&a!==c.nearFar[1]&&(f=a));return f===Number.MAX_VALUE?void 0:f}_ensureLinearDepthArrayBuffer(a){a=4*a[2]*a[3];if(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<a)this._tmpDepthBuffer=new Uint8Array(a);return this._tmpDepthBuffer}async reloadShaders(){ia.removeLoadedShaderModules();await this._techniques.reloadAll();this.renderer.overlay?.reloadShaders();this.requestRender()}_registerFrameTask(a){const d=a.view.state;let b=
!1,c=m.RenderRequestType.BACKGROUND,f=!1;this._frameTask=D.addFrameTask({preRender:({time:h})=>{b=this.updating;c=this._needsUpdate?m.RenderRequestType.UPDATE:m.RenderRequestType.BACKGROUND;a.commitSyncLayers();if(E.Milliseconds(h-this._lastAnimationUpdate)>this.renderer.animationTimestep||null!=d.forcedAnimationTime||b||this._needsRender)this.renderer.updateAnimation(d,h)&&this.requestRender(m.RenderRequestType.BACKGROUND),this._lastAnimationUpdate=h},render:({time:h})=>{if((this._needsRender||!this._idleSuspend||
!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&0<d.camera.fullWidth&&0<d.camera.fullHeight){const q=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsWaterReflectionUpdate=this._needsUpdate=this._needsRender=!1;this.renderer.render(d,h);f=!0;q&&this.renderer.hasReflections&&(this.requestRender(m.RenderRequestType.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:h})=>{this._textures.update();const q=new x.ScreenshotContext(d,this.renderer.fboCache);
this._screenshotManager.update(q,h)},finish:()=>{f&&(this.renderer.finish(d.mode===ka.RenderState.IDLE?c:m.RenderRequestType.UPDATE),f=!1)}})}_initializeContext(a){const d=a.options;this._canvas=d.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const b=this._canvas.getContext("webgl2",{alpha:d.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:d.stencil??!0,powerPreference:"high-performance",
preserveDrawingBuffer:d.preserveDrawingBuffer??!1});null==b?t.getLogger(this).error("A WebGL2 context could not be created."):(this._rctx=la(b,a),this._loadShaderOnlyExtensions(),!d.alpha&&this._rctx.contextAttributes.alpha&&t.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&11<=C("safari")&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas))}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}getObjectAndLayerIdColor(a){return this.olidRenderHelper?.getObjectAndLayerIdColor(a)}get componentObjectCollection(){null==
this._componentObjects&&(this._componentObjects=new M.ComponentObjectCollection(this.renderer.renderPassManager,this._viewingMode));return this._componentObjects}set componentObjectCollection(a){this._componentObjects=a}};g.__decorate([k.property({type:Boolean,readOnly:!0})],e.RenderView.prototype,"updating",null);g.__decorate([k.property()],e.RenderView.prototype,"_rctx",void 0);g.__decorate([k.property()],e.RenderView.prototype,"_container",void 0);g.__decorate([k.property()],e.RenderView.prototype,
"_canvas",void 0);g.__decorate([k.property()],e.RenderView.prototype,"stippleTextures",void 0);g.__decorate([k.property()],e.RenderView.prototype,"markerTextures",void 0);g.__decorate([k.property()],e.RenderView.prototype,"waterTextures",void 0);g.__decorate([k.property({readOnly:!0})],e.RenderView.prototype,"olidRenderHelper",void 0);g.__decorate([k.property()],e.RenderView.prototype,"_textures",void 0);g.__decorate([k.property({readOnly:!0})],e.RenderView.prototype,"renderer",void 0);g.__decorate([k.property()],
e.RenderView.prototype,"_screenshotManager",void 0);g.__decorate([k.property()],e.RenderView.prototype,"componentObjectCollection",null);g.__decorate([k.property()],e.RenderView.prototype,"_componentObjects",void 0);g.__decorate([k.property()],e.RenderView.prototype,"_needsUpdate",void 0);g.__decorate([k.property()],e.RenderView.prototype,"_needsWaterReflectionUpdate",void 0);e.RenderView=g.__decorate([F.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView);const y=ha.getContextCache();
Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});