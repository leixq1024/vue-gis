// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../chunks/tslib.es6 ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../support/requestImageUtils ../../../webgl ../../../webgl/formats ../../../webgl/RenderNode ./SMAABlendWeightsTechnique ./SMAABlurTechnique ./SMAAEdgeDetectTechnique ./SMAAPassParameters ../../lib/basicInterfaces ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(C,f,k,u,v,w,l,J,K,L,D,x,m,E,F,y,z,A,G,n,g,H,I){function B(a,c,b,d){const e=new I.TextureDescriptor;e.pixelFormat=b;e.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE;e.width=d.width;e.height=d.height;e.samplingMode=c;return new H.Texture(a,e,d)}f.SMAA=class extends F{constructor(a){super(a);this.produces="disabled";this.consumes={required:[m.InternalRenderCategory.ANTIALIASING],optional:[m.RenderCategory.COMPOSITE]};this._searchTexture=this._areaTexture=null;this._smaaParameters=new G.SMAAPassParameters;
a.techniques.precompile(A.SMAAEdgeDetectTechnique);a.techniques.precompile(y.SMAABlendWeightsTechnique);a.techniques.precompile(z.SMAABlurTechnique)}initialize(){this.addHandles([w.watch(()=>this.isEnabled(),a=>a?this.enable():this.disable(),w.syncAndInitial)])}async enable(){this.produces=m.InternalRenderCategory.ANTIALIASING;if(!(this._abortController||this._areaTexture&&this._searchTexture)){this._abortController=new AbortController;var a=this._abortController.signal;try{const c=await new Promise((b,
d)=>C(["./SMAAData"],b,d));await this._loadTextures(c,a);this.requestRender(n.RenderRequestType.UPDATE)}catch{}this._abortController=null}}async _loadTextures(a,c){v.throwIfAborted(c);const [b,d]=await Promise.allSettled([x.requestImage(a.areaTexture,{signal:c}),x.requestImage(a.searchTexure,{signal:c})]);v.throwIfAborted(c);"fulfilled"===b.status&&"fulfilled"===d.status&&(a=this.renderingContext,this._areaTexture=B(a,g.TextureSamplingMode.LINEAR,g.PixelFormat.RGB,b.value),this._searchTexture=B(a,
g.TextureSamplingMode.NEAREST,g.PixelFormat.LUMINANCE,d.value))}disable(){this.produces="disabled"}destroy(){this._searchTexture=u.disposeMaybe(this._searchTexture);this._areaTexture=u.disposeMaybe(this._areaTexture)}render(a){const c=a.find(({name:p})=>p===m.InternalRenderCategory.ANTIALIASING);if(!this._areaTexture||!this._searchTexture)return this.requestRender(n.RenderRequestType.UPDATE),c;var b=this.techniques.acquire(A.SMAAEdgeDetectTechnique);const d=this.techniques.acquire(y.SMAABlendWeightsTechnique),
e=this.techniques.acquire(z.SMAABlurTechnique);if(!b.compiled||!d.compiled||!e.compiled)return b.release(),d.release(),e.release(),this.requestRender(n.RenderRequestType.UPDATE),c;var h=a.find(({name:p})=>p===m.RenderCategory.COMPOSITE);if(!h)return c;const q=h.fbo.width,r=h.fbo.height;a=this.renderingContext;a.setViewport(0,0,q,r);const t=this.fboCache.acquire(q,r,"smaa edges",E.ColorFormat.RG);a.bindFramebuffer(t.fbo);a.setClearColor(0,0,0,1);a.clear(g.FramebufferBit.COLOR);this._smaaParameters.color=
h.getTexture();h=this.bindParameters;a.bindTechnique(b,h,this._smaaParameters);a.screen.draw();b.release();b=this.fboCache.acquire(q,r,"smaa blend");a.bindFramebuffer(b.fbo);a.setClearColor(0,0,1,1);a.clear(g.FramebufferBit.COLOR);this._smaaParameters.inputTexture=t.getTexture();this._smaaParameters.areaTexture=this._areaTexture;this._smaaParameters.searchTexture=this._searchTexture;a.bindTechnique(d,h,this._smaaParameters);a.screen.draw();d.release();t.release();a.bindFramebuffer(c.fbo);a.setClearColor(0,
1,0,1);a.clear(g.FramebufferBit.COLOR);this._smaaParameters.inputTexture=b.getTexture();a.bindTechnique(e,h,this._smaaParameters);a.screen.draw();e.release();b.release();return c}};k.__decorate([l.property()],f.SMAA.prototype,"produces",void 0);k.__decorate([l.property()],f.SMAA.prototype,"consumes",void 0);k.__decorate([l.property({constructOnly:!0})],f.SMAA.prototype,"isEnabled",void 0);k.__decorate([l.property({constructOnly:!0})],f.SMAA.prototype,"techniques",void 0);k.__decorate([l.property()],
f.SMAA.prototype,"_abortController",void 0);f.SMAA=k.__decorate([D.subclass("esri.views.3d.webgl-engine.effects.smaa.SMAA")],f.SMAA);Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});