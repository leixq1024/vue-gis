// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/vec2 ../../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../webgl ../../../webgl/formats ../../../webgl/RenderNode ./HighlightApplyTechnique ./HighlightDownsampleTechnique ./HighlightPassParameters ./HighlightToSingleTechnique ./SingleHighlightApplyTechnique ./SingleHighlightBlurTechnique ../../lib/basicInterfaces ../../lib/DefaultVertexAttributeLocations ../../lib/DefaultVertexBufferLayouts ../../lib/VertexArrayObject ../../../../../chunks/HighlightDownsample.glsl ../../../../../chunks/SingleHighlightBlur.glsl ../../../../support/HighlightDefaults ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(r,w,V,x,I,E,na,oa,W,y,X,F,z,Y,J,K,Z,L,M,N,A,aa,ba,ca,v,da,t,O,q,ea,fa){function ha(a){const c=new Uint8Array(128);P(a,(b,d)=>{b=b.options;const e=4*d;d=4*d+64;const {color:f}=b,g=b.haloColor??f;c[e+0]=f.r;c[e+1]=f.g;c[e+2]=f.b;c[e+3]=b.fillOpacity*f.a*255;c[d+0]=g.r;c[d+1]=g.g;c[d+2]=g.b;c[d+3]=b.haloOpacity*g.a*255});return c}function P(a,c){var b=Math.min(a.length,t.maximumHighlights),d=t.maximumHighlights;for(--b;0<=b;--b){var e=a.at(b);e&&(e=e.name,Q.includes(e,d)||(--d,Q[d]=e,R[d]=b))}d=
t.maximumHighlights-d;for(b=0;b<d;++b)e=a.at(R[t.maximumHighlights-d+b]),c(e,b)}function S(a){let c=0;const b=Math.min(t.maximumHighlights,a.length);for(let d=0;d<b;++d){const e=a.at(d);if(e){const {name:f,options:g}=e;c+=f.length;const {color:h,fillOpacity:k,haloColor:m,haloOpacity:n}=g;c+=h.r+(m?.r??1)+k+n}}if(a=a.at(0)){const {shadowOpacity:d,shadowDifference:e,shadowColor:f}=a.options;c+=d+e+f.r}return ia++ +(0<=c?0:1)}function T(a){const c=new Set;for(let b=0;b<t.maximumHighlights;++b){const d=
a.at(b)?.name;d&&c.add(d)}return c.size}r.Highlight=class extends Y{constructor(a){super(a);this.produces=F.InternalRenderCategory.HIGHLIGHTS;this.consumes={required:[F.InternalRenderCategory.HIGHLIGHTS,"highlights"]};this.useMultipleHighlights=!!V("enable-feature:multiple-highlights");this._optionsTexture=null;this._downsampleDrawParameters=new v.HighlightDownsampleDrawParameters;this._passParameters=new Z.HighlightPassParameters;this._singleHighlightBlurDrawParameters=new da.SingleHighlightBlurDrawParameters;
this._grid=new ja;a.techniques.precompile(K.HighlightDownsampleTechnique);this.useMultipleHighlights?a.techniques.precompile(J.HighlightApplyTechnique):(a.techniques.precompile(L.HighlightToSingleTechnique),a.techniques.precompile(N.SingleHighlightBlurTechnique),a.techniques.precompile(M.SingleHighlightApplyTechnique))}initialize(){this.addHandles([I.watch(()=>S(this.view.highlights),()=>{this._optionsTexture=x.disposeMaybe(this._optionsTexture);this.requestRender(A.RenderRequestType.UPDATE)},I.initial)])}destroy(){this._passParameters&&
(this._passParameters.highlightOptionsTexture=null);this._grid.coverage=x.releaseMaybe(this._grid.coverage);this._grid.vao=x.disposeMaybe(this._grid.vao);this._optionsTexture=x.releaseMaybe(this._optionsTexture)}_updateOptionsTexture(a){const c=this.renderingContext;var b=this._optionsTexture;null==b&&(b=new fa.TextureDescriptor(16,2),b.internalFormat=q.PixelFormat.RGBA,b.samplingMode=q.TextureSamplingMode.NEAREST,this._optionsTexture=b=new ea.Texture(c,b,null));b.setData(a);this._passParameters.highlightOptionsTexture=
b}render(a){const c=a.find(({name:l})=>l===F.InternalRenderCategory.HIGHLIGHTS),{techniques:b,bindParameters:d,_passParameters:e,renderingContext:f}=this;if(!d.decorations)return c;const g=b.acquire(K.HighlightDownsampleTechnique);if(!g.compiled)return g.release(),this.requestRender(A.RenderRequestType.UPDATE),c;const h=a.find(({name:l})=>"highlights"===l).getTexture();a=()=>{var {highlights:l}=this.view;this._optionsTexture||this._updateOptionsTexture(ha(l));e.highlightOptionsTexture=this._optionsTexture;
this._gridUpdateResources(h);l=this._gridComputeCoverage(g,h,d);g.release();const {horizontalCellCount:p,verticalCellCount:B}=l;e.horizontalCellCount=p;e.verticalCellCount=B;e.coverageTexture=l.coverage?.getTexture();return l};const k=l=>{const p=l.verticalCellCount*l.horizontalCellCount;f.bindVAO(l.vao);f.drawElementsInstanced(q.PrimitiveType.TRIANGLES,6,q.DataType.UNSIGNED_BYTE,0,p)},{camera:m}=d,n=()=>{f.bindFramebuffer(c.fbo);f.setViewport4fv(m.fullViewport)};this.useMultipleHighlights?this._renderMultiple(h,
a,k,n):this._renderSingle(h,a,k,n);e.highlightTexture=null;e.coverageTexture=null;return c}_renderMultiple(a,c,b,d){const {techniques:e,bindParameters:f,_passParameters:g,renderingContext:h}=this,k=e.acquire(J.HighlightApplyTechnique);k.compiled?(c=c(),g.highlightTexture=a,g.pixelRatio=f.camera.pixelRatio,g.maxHighlightLevel=T(this.view.highlights)-1,h.bindTechnique(k,f,g),d(),b(c),k.release()):(k.release(),this.requestRender(A.RenderRequestType.UPDATE))}_renderSingle(a,c,b,d){const {fboCache:e,techniques:f,
bindParameters:g,_passParameters:h,renderingContext:k}=this,m=f.acquire(L.HighlightToSingleTechnique),n=f.acquire(N.SingleHighlightBlurTechnique),l=f.acquire(M.SingleHighlightApplyTechnique);if(l.compiled&&n.compiled&&m.compiled){c=c();var {width:p,height:B}=a.descriptor;h.maxHighlightLevel=T(this.view.highlights)-1;h.highlightTexture=a;({camera:a}=g);var {fullWidth:ka,fullHeight:la,pixelRatio:U}=a;a=Math.ceil(ka/U);var G=Math.ceil(la/U),{_singleHighlightBlurDrawParameters:u}=this;for(let H=0;H<=
h.maxHighlightLevel;++H){h.highlightLevel=H;k.setClearColor(0,0,0,0);const C=e.acquire(p,B,"single highlight",z.ColorFormat.RG);k.bindFramebuffer(C.fbo);k.setViewport(0,0,p,B);k.clear(q.FramebufferBit.COLOR);k.bindTechnique(m,g,h);b(c);u.blurInput=C.getTexture();y.set(u.blurSize,1/a,0);const D=e.acquire(a,G,"single highlight blur h",z.ColorFormat.RG);k.unbindTexture(D.fbo?.colorTexture);k.bindFramebuffer(D.fbo);k.setViewport(0,0,a,G);k.clear(q.FramebufferBit.COLOR);u.blurInput=C.getTexture();y.set(u.blurSize,
1/a,0);k.bindTechnique(n,g,h,u);b(c);C.release();y.set(u.blurSize,0,1/G);h.singleHighlightBlurTexture=D.getTexture();d();k.bindTechnique(l,g,h,u);b(c);D.release()}m.release();n.release();l.release()}else l.release(),n.release(),m.release(),this.requestRender(A.RenderRequestType.UPDATE)}_gridUpdateResources(a){const c=this.renderingContext,b=this._grid,{width:d,height:e}=a.descriptor;b.horizontalCellCount=Math.ceil(d/v.gridCellPixelSize);b.verticalCellCount=Math.ceil(e/v.gridCellPixelSize);b.vao||
(a=O.BufferObject.createIndex(c,q.Usage.STATIC_DRAW,ma),b.vao=new ca.VertexArrayObject(c,aa.Default3D,new Map([["geometry",ba.NoVertex]]),new Map([["geometry",O.BufferObject.createVertex(c,q.Usage.STATIC_DRAW)]]),a))}_gridComputeCoverage(a,c,b){const d=this.renderingContext,e=this._grid;var f=c.descriptor;const g=Math.ceil(f.width/v.gridCellPixelSize);f=Math.ceil(f.height/v.gridCellPixelSize);this._downsampleDrawParameters.input=c;e.coverage?.release();c=this.fboCache.acquire(g,f,"highlight coverage",
z.ColorFormat.RG);e.coverage=c;d.bindFramebuffer(c.fbo);d.bindTechnique(a,b,this._passParameters,this._downsampleDrawParameters);d.setViewport(0,0,g,f);d.screen.draw();return e}get test(){}};w.__decorate([E.property()],r.Highlight.prototype,"produces",void 0);w.__decorate([E.property()],r.Highlight.prototype,"consumes",void 0);w.__decorate([E.property({constructOnly:!0})],r.Highlight.prototype,"techniques",void 0);r.Highlight=w.__decorate([W.subclass("esri.views.3d.webgl-engine.effects.highlight.Highlight")],
r.Highlight);class ja{constructor(){this.vao=this.coverage=null;this.viewportHeight=this.viewportWidth=this.horizontalCellCount=this.verticalCellCount=0}}const Q=Array(t.maximumHighlights),R=Array(t.maximumHighlights);let ia=0;const ma=new Uint8Array([0,1,2,2,1,3]);r.renderHighlightBuffer=function(a,c,b,d,e,f,g=0,h){const {highlightGroupIndices:k}=e;k.clear();const m=[];P(d,p=>{({name:p}=p);k.set(p,m.length);m.push(p)});d=k.size;const {gl:n}=a;y.set(e.highlightMixOrigin,g,0);let l=null;1<d&&(l=c.acquire(b.width,
b.height,"highlight mix",z.ColorFormat.RG),a.bindFramebuffer(l.fbo),a.clearFramebuffer(X.ZEROS));c=l?.getTexture()??null;e.highlightMixTexture=c;h();for(h=0;h<d;++h)0<h&&(a.bindTexture(c,0),n.copyTexSubImage2D(q.TextureType.TEXTURE_2D,0,0,0,g,0,b.width,b.height),a.bindTexture(null,0)),a.clear(q.FramebufferBit.DEPTH),e.highlightLevel=h,e.highlightGroupName=m[h],f();l?.release()};r.trackHighlightOptions=S;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});