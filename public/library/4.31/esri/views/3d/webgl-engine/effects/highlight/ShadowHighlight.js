// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/colorUtils ../../../../../core/mathUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../ViewingMode ../../../webgl ../../../webgl/RenderNode ./ShadowHighlightTechnique ../../lib/basicInterfaces ../../../../support/HighlightDefaults".split(" "),
function(b,f,u,h,d,g,A,B,C,v,k,w,x,l,y,m,r,n){const z=1/512;b.ShadowHighlight=class extends y{constructor(a){super(a);this.produces=l.RenderCategory.COMPOSITE;this.consumes={required:[l.RenderCategory.COMPOSITE,"highlights"]};this._passParameters=new m.ShadowHighlightPassParameters;this._maxOpacity=1;this._shadowDifference=.2;a.techniques.precompile(m.ShadowHighlightTechnique)}initialize(){this.addHandles([d.watch(()=>this.view.highlightOptions.shadowOpacity,a=>{this._passParameters.shadowOpacity=
a??n.defaultShadowOpacity;this._updateOccludedShadowOpacity();this._ensureMaxOpacity()},d.syncAndInitial),d.watch(()=>this.view.highlightOptions.shadowDifference,a=>{this._shadowDifference=a??n.defaultShadowDifference;this._updateOccludedShadowOpacity();this._ensureMaxOpacity()},d.syncAndInitial),d.watch(()=>this.view.highlightOptions.shadowColor,a=>{this._passParameters.shadowColor=u.unitRGBAFromColor(a??n.defaultShadowColor);this._ensureMaxOpacity()},d.syncAndInitial)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=
this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){this._maxOpacity=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity)*this._passParameters.shadowColor[3];this.requestRender(r.RenderRequestType.UPDATE)}render(a){const c=a.find(({name:p})=>p===l.RenderCategory.COMPOSITE),e=this.bindParameters;if(!e.shadowHighlightsVisible||!e.depth||!this._ensureIfVisible(e.camera,e.lighting.mainLight.direction))return c;const q=this.techniques.acquire(m.ShadowHighlightTechnique);
q.compiled?(this._passParameters.highlight=a.find(({name:p})=>"highlights"===p)?.getTexture(),this._passParameters.origin=e.camera.center,a=this.renderingContext,a.bindFramebuffer(c.fbo),a.bindTechnique(q,e,this._passParameters),a.screen.draw()):this.requestRender(r.RenderRequestType.UPDATE);q.release();return c}_ensureIfVisible(a,c){this._passParameters.opacityElevation=1-h.smoothstep(4E4,5E4,a.relativeElevation);a=this.viewingMode===x.ViewingMode.Global?k.normalize(t,a.center):k.set(t,0,0,1);c=
k.dot(a,c);this._passParameters.dayNightTerminator=h.smoothstep(0,1,h.clamp(30*c,0,1));return this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=z}};f.__decorate([g.property()],b.ShadowHighlight.prototype,"produces",void 0);f.__decorate([g.property()],b.ShadowHighlight.prototype,"consumes",void 0);f.__decorate([g.property({constructOnly:!0})],b.ShadowHighlight.prototype,"viewingMode",void 0);f.__decorate([g.property({constructOnly:!0})],b.ShadowHighlight.prototype,
"techniques",void 0);b.ShadowHighlight=f.__decorate([v.subclass("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],b.ShadowHighlight);const t=w.create();Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});