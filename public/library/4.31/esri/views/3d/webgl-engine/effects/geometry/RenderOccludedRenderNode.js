// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/PooledArray ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../webgl ../../../webgl/formats ../../../webgl/RenderNode ../blit/Blit ../../lib/basicInterfaces ../../lib/Material ../../lib/RenderSlot ../../shaders/CompositingTechniqueConfiguration ../../../../webgl/enums".split(" "),
function(g,l,w,q,F,G,H,x,y,r,z,A,B,C,c,m,D,E){g.RenderOccludedRenderNode=class extends A{constructor(b){super(b);this.consumes={required:[r.InternalRenderCategory.OCCLUDED]};this.produces=r.InternalRenderCategory.OCCLUDED;this._blit=new B.Blit(b.view._stage.renderView.techniques,D.BlitMode.PremultipliedAlpha)}precompile(){const b=this.view._stage.renderer;b.plugins.plugins.forAll(d=>{b.precompileSlots(d,m.RenderSlot.OCCLUDED_TERRAIN,m.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL);d.material&&b.precompileOccludedSlots(d,
t)})}render(b){b=b.find(({name:a})=>a===r.InternalRenderCategory.OCCLUDED);const d=this.view._stage.renderer;let f=0;e.clear();d.plugins.plugins.forAll(a=>{a.material&&a.queryRenderOccludedState(c.RenderOccludedFlag.OccludeAndTransparentStencil)&&(f|=c.RenderOccludedFlag.OccludeAndTransparentStencil,e.push(a))});0<e.length&&(d.renderSlots(e,m.RenderSlot.OCCLUDER_MATERIAL),f&c.RenderOccludedFlag.OccludeAndTransparentStencil&&this._renderAndComposite(b,.5,()=>d.renderSlots(e,m.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL),
!1,!1));e.clear();d.plugins.plugins.forAll(a=>{if(a.material){var n=a.queryRenderOccludedState(c.RenderOccludedFlag.OccludeAndTransparent),h=a.queryRenderOccludedState(c.RenderOccludedFlag.Transparent),p=a.queryRenderOccludedState(c.RenderOccludedFlag.Opaque);if(n||h||p)f|=n?c.RenderOccludedFlag.OccludeAndTransparent:h?c.RenderOccludedFlag.Transparent:c.RenderOccludedFlag.Opaque,e.push(a)}});f|=d.plugins.renderOccludedFlags;if(!f)return b;for(const a of t)f&a&&this._renderAndComposite(b,a===c.RenderOccludedFlag.Opaque?
1:.5,()=>d.renderOccludedSlots(e,a),!0,C.StencilBits.OutlineVisualElementMask);e.clear();return b}_renderAndComposite(b,d,f,a,n){const h=this.renderingContext,{width:p,height:u}=b.fbo,k=this.fboCache.acquire(p,u,"tmp color"),v=a?this.fboCache.acquireDepth(z.DepthFormat.DEPTH_STENCIL_TEXTURE,p,u,"tmp depth"):b.getAttachment(E.DepthStencilAttachment);k.attachDepth(v);h.bindFramebuffer(k.fbo);h.clearFramebuffer(y.ZEROS,a,n);f();k.detachDepth();this._blit.blend(h,k,b,this.bindParameters,d);a&&v.release();
k.release()}};l.__decorate([q.property()],g.RenderOccludedRenderNode.prototype,"consumes",void 0);l.__decorate([q.property()],g.RenderOccludedRenderNode.prototype,"produces",void 0);l.__decorate([q.property({constructOnly:!0})],g.RenderOccludedRenderNode.prototype,"techniques",void 0);g.RenderOccludedRenderNode=l.__decorate([x.subclass("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],g.RenderOccludedRenderNode);const e=new w,t=[c.RenderOccludedFlag.OccludeAndTransparent,c.RenderOccludedFlag.Transparent,
c.RenderOccludedFlag.Opaque];Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});