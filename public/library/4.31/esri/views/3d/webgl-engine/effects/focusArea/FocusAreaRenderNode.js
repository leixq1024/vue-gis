// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../webgl/formats ../../../webgl/RenderNode ./FocusAreaColorTechnique ./FocusAreaMaskTechnique ../../lib/DefaultVertexAttributeLocations ../../lib/DefaultVertexBufferLayouts ../../lib/VertexArrayObject ../../../../../chunks/FocusAreaColor.glsl ../../../../../chunks/FocusAreaMask.glsl ../../../../webgl/BufferObject ../../../../webgl/enums".split(" "),
function(d,m,p,F,G,H,v,w,x,t,u,y,z,A,B,C,D,f){d.FocusAreaRenderNode=class extends x{constructor(b){super(b);this.consumes={required:["final-color"]};this.produces="final-color";this.focusAreaGeometries=[];this._vaos=[];this._count=[];this._origins=[];this._colorParameters=new B.FocusAreaColorPassParameters;this._maskParameters=new C.FocusAreaMaskPassParameters;b.techniques.precompile(u.FocusAreaMaskTechnique);b.techniques.precompile(t.FocusAreaColorTechnique)}initialize(){this.setExtrudedVolume()}destroy(){this._vaos.forEach(b=>
b.dispose());this._vaos=[];this._count=[];this._origins=[]}render(b){const c=this.techniques.acquire(u.FocusAreaMaskTechnique),e=this.techniques.acquire(t.FocusAreaColorTechnique),l=this.bindParameters;b=b.find(({name:q})=>"final-color"===q);const k=b?.getTexture();var h=l.camera,g=h.fullViewport[2],n=h.fullViewport[3];h=this.fboCache.acquire(g,n,"focusArea",w.ColorFormat.RGBA);const r=this.fboCache.acquire(g,n,this.produces);if(!c.compiled||!e.compiled||!this._vaos||this.effect===d.FocusAreaEffect.NONE)return this.requestRender(),
c.release(),e.release(),r.release(),h.release(),b;const a=this.renderingContext;h.attachDepth(b.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT));a.bindFramebuffer(h.fbo);a.clear(f.FramebufferBit.COLOR|f.FramebufferBit.STENCIL);a.setViewport(0,0,g,n);a.gl.clearStencil(0);a.gl.clear(a.gl.STENCIL_BUFFER_BIT);a.setClearStencil(0);for(g=0;g<this._vaos.length;g++){n=this._vaos[g];const q=this._count[g];n&&(this._maskParameters.origin=this._origins[g],a.bindTechnique(c,l,this._maskParameters),a.setFaceCullingEnabled(!1),
a.setStencilTestEnabled(!0),a.setStencilWriteMask(255),a.setStencilFunction(f.CompareFunction.ALWAYS,0,255),a.setStencilOpSeparate(f.Face.FRONT,f.StencilOperation.KEEP,f.StencilOperation.INCR_WRAP,f.StencilOperation.KEEP),a.setStencilOpSeparate(f.Face.BACK,f.StencilOperation.KEEP,f.StencilOperation.DECR_WRAP,f.StencilOperation.KEEP),a.setDepthWriteEnabled(!1),a.setColorMask(!1,!1,!1,!1),a.bindVAO(n),a.drawArrays(f.PrimitiveType.TRIANGLES,0,q),a.setFaceCullingEnabled(!1),a.setDepthTestEnabled(!1),
a.setStencilFunction(f.CompareFunction.NOTEQUAL,0,255),a.setStencilWriteMask(0),a.setColorMask(!0,!0,!0,!0),a.drawArrays(f.PrimitiveType.TRIANGLES,0,q))}c.release();a.gl.clear(a.gl.STENCIL_BUFFER_BIT);a.bindFramebuffer(r.fbo);this._colorParameters.color=k;this._colorParameters.focusArea=h.getTexture();this._colorParameters.effect=this.effect;a.bindTechnique(e,l,this._colorParameters);a.screen.draw();h.release();e.release();r.attachDepth(b.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT));return r}setExtrudedVolume(){const b=
this.focusAreaGeometries;this._vaos=[];this._count=[];this._origins=[];for(let l=0;l<b.length;l++){var c=b[l];const k=[],h=c.indicesBottom;this._origins.push(c.origin);for(var e=0;e<h.length;e++)k.push(c.positions[3*(h[e]-1)]),k.push(c.positions[3*(h[e]-1)+1]),k.push(c.positions[3*(h[e]-1)+2]);e=c.indicesExtruded;for(let g=0;g<e.length;g++)k.push(c.positions[3*e[g]]),k.push(c.positions[3*e[g]+1]),k.push(c.positions[3*e[g]+2]);c=new Float32Array(k);c=new A.VertexArrayObject(this.renderingContext,y.Default3D,
new Map([["geometry",z.Pos3]]),new Map([["geometry",D.BufferObject.createVertex(this.renderingContext,f.Usage.STATIC_DRAW,c)]]));this._vaos?.push(c);this._count.push(h.length+e.length)}}};m.__decorate([p.property()],d.FocusAreaRenderNode.prototype,"consumes",void 0);m.__decorate([p.property()],d.FocusAreaRenderNode.prototype,"produces",void 0);m.__decorate([p.property({constructOnly:!0})],d.FocusAreaRenderNode.prototype,"techniques",void 0);m.__decorate([p.property()],d.FocusAreaRenderNode.prototype,
"focusAreaGeometries",void 0);m.__decorate([p.property()],d.FocusAreaRenderNode.prototype,"effect",void 0);d.FocusAreaRenderNode=m.__decorate([v.subclass("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaRenderNode")],d.FocusAreaRenderNode);class E{constructor(b,c,e,l,k){this.positions=b;this.indicesBottom=c;this.indicesExtruded=e;this.height=l;this.origin=k}}d.FocusAreaEffect=void 0;(function(b){b[b.NONE=0]="NONE";b[b.BRIGHT=1]="BRIGHT";b[b.DARK=2]="DARK"})(d.FocusAreaEffect||(d.FocusAreaEffect=
{}));m={none:d.FocusAreaEffect.NONE,bright:d.FocusAreaEffect.BRIGHT,dark:d.FocusAreaEffect.DARK};d.FocusAreaGeometry=E;d.effectsMapping=m;Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});