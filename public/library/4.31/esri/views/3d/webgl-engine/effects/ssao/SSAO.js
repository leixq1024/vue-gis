// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/time ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/vec2 ../../../webgl ../../../webgl/formats ../../../webgl/RenderNode ../../core/shaderLibrary/shading/ScreenSpaceConstants ./SSAOBlurTechnique ./SSAONoiseData ./SSAOParameters ./SSAOTechnique ../../lib/basicInterfaces ../../../../../chunks/SSAO.glsl ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(d,k,E,F,G,t,u,P,Q,R,H,z,w,v,I,x,A,J,B,C,D,K,l,L,M){d.SSAO=class extends I{constructor(b){super(b);this.consumes={required:["normals"]};this.produces=w.InternalRenderCategory.SSAO;this.isEnabled=()=>!1;this._enableTime=t.Milliseconds(0);this._passParameters=new B.SSAOPassParameters;this._drawParameters=new B.BlurDrawParameters}initialize(){const b=Uint8Array.from(atob(J.noiseData),f=>f.charCodeAt(0)),c=new M.TextureDescriptor;c.wrapMode=l.TextureWrapMode.CLAMP_TO_EDGE;c.pixelFormat=l.PixelFormat.RGB;
c.wrapMode=l.TextureWrapMode.REPEAT;c.hasMipmap=!0;c.width=32;c.height=32;this._passParameters.noiseTexture=new L.Texture(this.renderingContext,c,b);this.techniques.precompile(C.SSAOTechnique);this.techniques.precompile(A.SSAOBlurTechnique);this.addHandles(G.watch(()=>this.isEnabled(),()=>this._enableTime=t.Milliseconds(0)))}destroy(){this._passParameters.noiseTexture=F.disposeMaybe(this._passParameters.noiseTexture)}render(b){const c=this.bindParameters;b=b.find(({name:N})=>"normals"===N);var f=
b?.getTexture();const O=b?.getTexture(l.DepthStencilAttachment);var g=this.fboCache;b=c.camera;const m=b.fullViewport[2],n=b.fullViewport[3],p=Math.round(m/2),q=Math.round(n/2);var e=this.techniques.acquire(C.SSAOTechnique);const r=this.techniques.acquire(A.SSAOBlurTechnique);if(!e.compiled||!r.compiled)return this._enableTime=t.Milliseconds(performance.now()),this.requestRender(D.RenderRequestType.UPDATE),e.release(),r.release(),g.acquire(p,q,w.InternalRenderCategory.SSAO,v.ColorFormat.RED);0===
this._enableTime&&(this._enableTime=t.Milliseconds(performance.now()));const a=this.renderingContext;var h=this.view.qualitySettings.fadeDuration,y=E.clamp((x.distanceFadeEnd-b.relativeElevation)/(x.distanceFadeEnd-x.distanceFadeStart),0,1);h=0<h?Math.min(h,performance.now()-this._enableTime)/h:1;y*=h;this._passParameters.normalTexture=f;this._passParameters.depthTexture=O;this._passParameters.projScale=1/b.computeScreenPixelSizeAtDist(1);this._passParameters.intensity=2/K.getRadius(b)**6*y;f=g.acquire(m,
n,"ssao input",v.ColorFormat.RG);a.bindFramebuffer(f.fbo);a.setViewport(0,0,m,n);a.bindTechnique(e,c,this._passParameters,this._drawParameters);a.screen.draw();e.release();e=g.acquire(p,q,"ssao blur",v.ColorFormat.RED);a.bindFramebuffer(e.fbo);this._drawParameters.colorTexture=f.getTexture();z.set(this._drawParameters.blurSize,0,2/n);a.bindTechnique(r,c,this._passParameters,this._drawParameters);a.setViewport(0,0,p,q);a.screen.draw();f.release();g=g.acquire(p,q,w.InternalRenderCategory.SSAO,v.ColorFormat.RED);
a.bindFramebuffer(g.fbo);a.setViewport(0,0,m,n);a.setClearColor(1,1,1,0);a.clear(l.FramebufferBit.COLOR);this._drawParameters.colorTexture=e.getTexture();z.set(this._drawParameters.blurSize,2/m,0);a.bindTechnique(r,c,this._passParameters,this._drawParameters);a.setViewport(0,0,p,q);a.screen.draw();r.release();a.setViewport4fv(b.fullViewport);e.release();1>h&&this.requestRender(D.RenderRequestType.UPDATE);return g}};k.__decorate([u.property()],d.SSAO.prototype,"consumes",void 0);k.__decorate([u.property()],
d.SSAO.prototype,"produces",void 0);k.__decorate([u.property({constructOnly:!0})],d.SSAO.prototype,"techniques",void 0);k.__decorate([u.property({constructOnly:!0})],d.SSAO.prototype,"isEnabled",void 0);d.SSAO=k.__decorate([H.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],d.SSAO);d.blurSizePixels=2;Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});