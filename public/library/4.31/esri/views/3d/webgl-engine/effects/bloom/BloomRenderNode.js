// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../webgl ../../../webgl/RenderNode ../../../../../chunks/BloomComposition.glsl ./BloomCompositionTechniqueConfiguration ./BloomTechnique ../../lib/basicInterfaces ../../../../webgl/enums".split(" "),function(d,n,u,K,L,M,A,v,B,e,C,g,D,p){d.BloomRenderNode=
class extends B{constructor(a){super(a);this.consumes={required:[v.RenderCategory.COMPOSITE,"emissive"]};this.produces=v.RenderCategory.COMPOSITE;this._configuration=new C.BloomCompositionTechniqueConfiguration;this._bloomParameters=new e.BloomCompositionPassParameters;this._blurScale=3.06;this._bloomResults=[]}destroy(){}precompile(){this._configuration.bloomStage=e.BloomCompositionPass.BlurHorizontal;this.techniques.precompile(g.BloomCompositionTechnique,this._configuration);this._configuration.bloomStage=
e.BloomCompositionPass.BlurVertical;this.techniques.precompile(g.BloomCompositionTechnique,this._configuration);this._configuration.bloomStage=e.BloomCompositionPass.Composite;this.techniques.precompile(g.BloomCompositionTechnique,this._configuration)}render(a){a=a.find(({name:b})=>b===v.RenderCategory.COMPOSITE);var f=a.getAttachment(p.ColorAttachment.COLOR_ATTACHMENT1)?.attachment;if(!f)return a;this._configuration.bloomStage=e.BloomCompositionPass.BlurHorizontal;var c=this.techniques.acquire(g.BloomCompositionTechnique,
this._configuration);this._configuration.bloomStage=e.BloomCompositionPass.BlurVertical;const q=this.techniques.acquire(g.BloomCompositionTechnique,this._configuration);this._configuration.bloomStage=e.BloomCompositionPass.Composite;const r=this.techniques.acquire(g.BloomCompositionTechnique,this._configuration);if(!(c.compiled&&q.compiled&&r.compiled))return c.release(),q.release(),r.release(),this.requestRender(D.RenderRequestType.UPDATE),a;var t=a.getTexture();const h=this.renderingContext,x=this.fboCache,
E=this.bindParameters,{fullWidth:y,fullHeight:z}=this.bindParameters.camera,w=(b,F,G,H,I)=>{h.bindFramebuffer(b.fbo);h.setViewport(0,0,G,H);h.setClearColor(0,0,0,0);h.clear(p.FramebufferBit.COLOR);h.bindTechnique(F,E,I);h.screen.draw()};let k=y/2,l=z/2;const J=this._bloomParameters.blurRadius;var m=f;for(f=0;5>f;f++){const b=x.acquire(k,l,"bloomHorizontal");this._bloomParameters.colorTexture=m;w(b,c,k,l,this._bloomParameters);m=x.acquire(k,l,"bloomVertical");this._bloomParameters.colorTexture=b.getTexture();
w(m,q,k,l,this._bloomParameters);b.release();this._bloomResults[f]=m;k/=2;l/=2;m=this._bloomResults[f].getTexture();this._bloomParameters.blurRadius*=this._blurScale}c.release();q.release();c=this.acquireOutputFramebuffer();this._bloomParameters.colorTexture=t;for(t=0;5>t;t++)this._bloomParameters.bloomTexture0=this._bloomResults[0].getTexture(),this._bloomParameters.bloomTexture1=this._bloomResults[1].getTexture(),this._bloomParameters.bloomTexture2=this._bloomResults[2].getTexture(),this._bloomParameters.bloomTexture3=
this._bloomResults[3].getTexture(),this._bloomParameters.bloomTexture4=this._bloomResults[4].getTexture();this._bloomParameters.blurRadius=J;w(c,r,y,z,this._bloomParameters);this._bloomResults.forEach(b=>b.release());r.release();c.attachDepth(a.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT));c.attachColor(a.getAttachment(p.ColorAttachment.COLOR_ATTACHMENT1),p.ColorAttachment.COLOR_ATTACHMENT1);return c}};n.__decorate([u.property()],d.BloomRenderNode.prototype,"consumes",void 0);n.__decorate([u.property()],
d.BloomRenderNode.prototype,"produces",void 0);n.__decorate([u.property({constructOnly:!0})],d.BloomRenderNode.prototype,"techniques",void 0);d.BloomRenderNode=n.__decorate([A.subclass("esri.views.3d.webgl-engine.effects.bloom.BloomRenderNode")],d.BloomRenderNode);Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});