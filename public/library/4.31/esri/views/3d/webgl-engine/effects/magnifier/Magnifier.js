// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/asyncUtils ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/screenUtils ../../../../../core/urlUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../support/requestImageUtils ../../../webgl ../../../webgl/RenderNode ./MagnifierTechnique ../../lib/basicInterfaces ../../lib/DefaultVertexAttributeLocations ../../lib/glUtil3D ../../../../../chunks/Magnifier.glsl ../../../../magnifier/resources ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(f,h,C,x,n,q,r,D,l,L,M,N,E,y,p,F,z,A,G,B,H,I,m,t,J){f.Magnifier=class extends F{constructor(b){super(b);this.produces=p.InternalRenderCategory.MAGNIFIER;this.consumes={required:[p.InternalRenderCategory.MAGNIFIER]};this._imageLoadTask=this._imageSources=null;this._passParameters=new H.MagnifierPassParameters;this._magnifier=this._vao=null;this._tmpScreenPoint=r.createScreenPointArray();this._tmpRenderPoint=r.createRenderScreenPointArray()}initialize(){this.addHandles([q.watch(()=>this.view.magnifier,
b=>this._update(b),q.syncAndInitial)])}_update(b){b!==this._magnifier&&(this.removeAllHandles(),this._magnifier=b,b=()=>{const a=this._validMagnifier;a?(this._loadResources(a),this.produces=p.InternalRenderCategory.MAGNIFIER):this.produces="disabled";this.requestRender()},this._magnifier&&this.addHandles(q.watch(()=>this._magnifier?.version,b)),b())}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&0<this._magnifier?.size?this._magnifier:null}get _factor(){return this._magnifier?.factor||
1}destroy(){this._magnifier=null;null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null);this._disposeTextures();this._vao=n.disposeMaybe(this._vao)}_disposeTextures(){this._passParameters.mask=n.disposeMaybe(this._passParameters.mask);this._passParameters.overlay=n.disposeMaybe(this._passParameters.overlay);this._passParameters.input=n.disposeMaybe(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(z.MagnifierTechnique)}render(b){const a=
this._validMagnifier;b=b.find(({name:K})=>K===p.InternalRenderCategory.MAGNIFIER);if(null==a)return b;if(null==this._imageSources)return this.requestRender(A.RenderRequestType.UPDATE),b;const d=this.renderingContext;var c=Math.ceil(this.camera.pixelRatio*a.size);this._vao??(this._vao=B.createQuadVAO(d,B.Layout.Pos2,G.Default3D,0,1));const g=this.techniques.acquire(z.MagnifierTechnique);this._ensureTextureResources(d,c);if(!g.compiled||!this._passParameters.input)return g.release(),this.requestRender(A.RenderRequestType.UPDATE),
b;c=Math.ceil(1/this._factor*c);const k=this._passParameters.input;k.resize(c,c);r.screenPointObjectToArray(a.position,this._tmpScreenPoint);var e=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),u=this.camera.fullHeight;const v=.5*c,w=.5*c;e[0]=x.clamp(e[0],v,this.camera.fullWidth-v-1);e[1]=x.clamp(e[1],w,u-w-1);u=Math.floor(e[0]-v);e=Math.floor(e[1]-w);d.bindFramebuffer(b.fbo);g.program.bindTexture("textureInput",k);d.gl.copyTexImage2D(k.descriptor.target,0,k.descriptor.pixelFormat,
u,e,c,c,0);this._passParameters.magnifier=a;d.bindTechnique(g,this.bindParameters,this._passParameters);d.bindVAO(this._vao);d.drawArrays(m.PrimitiveType.TRIANGLE_STRIP,0,4);g.release();return b}_loadResources(b){const {maskUrl:a,overlayUrl:d}=b;if(this._imageLoadTask?.maskUrl!==a||this._imageLoadTask?.overlayUrl!==d)this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null;this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:a,overlayUrl:d,task:C.createTask(async c=>
{const g=null==a||null==d?I.loadMagnifierResources(c):null,k=null!=a?y.requestImage(a,{signal:c}):g.then(e=>e.mask);c=null!=d?y.requestImage(d,{signal:c}):g.then(e=>e.overlay);this._imageSources={mask:await k,overlay:await c}})})}_ensureTextureResources(b,a){null==this._imageSources||this._passParameters.size===a&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=a,this._imageSources.overlay.height=
this._imageSources.mask.height=a,a=new J.TextureDescriptor,a.internalFormat=m.PixelFormat.RGBA,a.wrapMode=m.TextureWrapMode.CLAMP_TO_EDGE,a.flipped=!0,a.preMultiplyAlpha=!D.isSVG(this._imageSources.overlay.src)||!b.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new t.Texture(b,a,this._imageSources.overlay),a.pixelFormat=a.internalFormat=m.PixelFormat.ALPHA,a.preMultiplyAlpha=!1,this._passParameters.mask=new t.Texture(b,a,this._imageSources.mask),a.pixelFormat=a.internalFormat=
m.PixelFormat.RGBA,a.flipped=!1,this._passParameters.input=new t.Texture(b,a))}};h.__decorate([l.property()],f.Magnifier.prototype,"produces",void 0);h.__decorate([l.property()],f.Magnifier.prototype,"consumes",void 0);h.__decorate([l.property()],f.Magnifier.prototype,"_imageSources",void 0);h.__decorate([l.property()],f.Magnifier.prototype,"_imageLoadTask",void 0);h.__decorate([l.property({constructOnly:!0})],f.Magnifier.prototype,"techniques",void 0);f.Magnifier=h.__decorate([E.subclass("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],
f.Magnifier);Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});