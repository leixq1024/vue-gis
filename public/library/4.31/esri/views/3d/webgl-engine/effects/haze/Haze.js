// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/Logger ../../../../../core/has ../../../../../core/RandomLCG ../../../../../core/Error ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/vec2 ../../../../../chunks/vec32 ../../../../../chunks/vec42 ../../../../../geometry/support/Ellipsoid ../../../webgl ../../../webgl/formats ../TransparentEnvironment ../../../../../chunks/HazeCompositing.glsl ./HazeCompositingTechnique ./HazeTechnique ./HazeTechniqueConfiguration ../../lib/glUtil3D ../../lib/textureUtils ../../../../webgl/enums".split(" "),
function(l,w,f,x,e,I,J,K,L,y,z,r,A,k,B,C,D,E,t,m,F,u,v,G){l.Haze=class extends D.TransparentEnvironment{constructor(a){super(a);this._compositingPassParameters=new E.HazeCompositingPassParameters;this._passParameters=new m.HazePassParameters;this._hazeConfiguration=new F.HazeTechniqueConfiguration;this._vao=null;this.requireGeometryDepth=!0;this._amount=this._newAmount=this._oldAmount=1;({techniques:a}=a);a.precompile(m.HazeTechnique,this._hazeConfiguration);a.precompile(t.HazeCompositingTechnique);
this._hazeConfiguration.reduced=!0;a.precompile(m.HazeTechnique,this._hazeConfiguration);this._hazeConfiguration.reduced=!1}initialize(){this.addHandles([e.watch(()=>this.view.environment.atmosphereEnabled,a=>a?this._enable():this._disable(),e.syncAndInitial),e.watch(()=>this.view._stage?.renderer.renderContext.bind.clouds.fadeFactor??1,a=>this._fade(a),e.syncAndInitial),e.watch(()=>this.view.environment.weather.type,a=>this._newAmount="rainy"===a?0:1,e.syncAndInitial),e.watch(()=>this.view._stage.renderer?.fullResolutionAtmosphere,
a=>this._hazeConfiguration.reduced=!a,e.syncAndInitial)])}_fade(a){1<=a?this._oldAmount=this._amount=this._newAmount:this._amount=0>=a?this._oldAmount:f.lerp(this._oldAmount,this._newAmount,a)}destroy(){this._vao=x.disposeMaybe(this._vao)}render(a){a=a.find(({name:H})=>H===B.InternalRenderCategory.TRANSPARENT_ENVIRONMENT);if(!this.bindParameters.mainDepth)return a;const b=this.renderingContext;this._vao??(this._vao=u.createQuadVAO(b,u.Layout.Pos2Tex));const d=this.techniques.acquire(m.HazeTechnique,
this._hazeConfiguration);if(!d.compiled)return d.release(),a;const n=a.getAttachment(b.gl.DEPTH_STENCIL_ATTACHMENT);this._update();if(!this._hazeConfiguration.reduced)return a.detachDepth(),b.bindFramebuffer(a.fbo),b.bindTechnique(d,this.bindParameters,this._passParameters),this._renderCommon(b),a.attachDepth(n),d.release(),a;const p=this.techniques.acquire(t.HazeCompositingTechnique);if(!p.compiled)return d.release(),p.release(),a;const q=b.getViewport();var c=this.camera,h=r.length(c.eye)-k.earth.radius;
var g=k.earth.atmosphereHeight;g=h<g?f.lerp(.4,.5,Math.min(1,Math.max(0,h/g))):f.lerp(.5,1,Math.min(1,Math.max(0,(h-g)/(15*g))));h=v.applyTextureResizeModulo(Math.round(g*c.fullViewport[2]));c=v.applyTextureResizeModulo(Math.round(g*c.fullViewport[3]));b.setViewport(0,0,h,c);c=this.fboCache.acquire(h,c,"haze",C.ColorFormat.RGBA);b.bindFramebuffer(c.fbo);b.clearFramebuffer([0,0,0,1],!0,!0);b.bindTechnique(d,this.bindParameters,this._passParameters);this._renderCommon(b);b.setViewport(q.x,q.y,q.width,
q.height);this._compositingPassParameters.color=c.getTexture();a.detachDepth();b.bindFramebuffer(a.fbo);b.bindTechnique(p,this.bindParameters,this._compositingPassParameters);b.screen.draw();a.attachDepth(n);p.release();d.release();c.release();return a}_renderCommon(a){null!=this._vao&&(a.bindVAO(this._vao),a.drawArrays(G.PrimitiveType.TRIANGLE_STRIP,0,4))}_update(){var a=r.squaredLength(this.bindParameters.camera.eye);const b=Math.sqrt(a),d=a-this._passParameters.radii[1]*this._passParameters.radii[1],
n=f.clamp((b-this._passParameters.radii[0])/k.earth.atmosphereHeight,0,1);A.set(this._passParameters.heightParameters,b,a,d,n);a=this.view.basemapTerrain.getLowerBoundRadius();z.set(this._passParameters.radii,a,a+k.earth.atmosphereHeight);this._passParameters.hazeStrength=f.lerp(f.lerp(.6,1,f.smoothstep(9500,10500,b-k.earth.radius)),1,this._amount)}};l.Haze=w.__decorate([y.subclass("esri.views.3d.webgl-engine.effects.haze.Haze")],l.Haze);Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});