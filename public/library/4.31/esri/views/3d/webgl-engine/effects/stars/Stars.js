// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../assets ../../../../../core/asyncUtils ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/reactiveUtils ../../../../../core/has ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/mat4 ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../webgl ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ../OpaqueEnvironment ./StarsTechnique ../../lib/basicInterfaces ../../lib/DefaultVertexAttributeLocations ../../lib/VertexArrayObject ../../lib/VertexAttribute ../../../../webgl/BufferObject ../../../../webgl/enums".split(" "),
function(h,z,A,B,u,C,v,D,k,Q,R,E,l,w,F,G,H,I,q,m,J,K,r,L,x){h.Stars=class extends I.OpaqueEnvironment{constructor(a){super(a);this._loadDataTask=this._starData=null;this._numPoints=0;this._passParameters=new q.StarPassParameters;a.techniques.precompile(q.StarsTechnique)}initialize(){this.addHandles([k.watch(()=>this.view.environment.starsEnabled,a=>a?this._enable():this._disable(),k.initial),k.watch(()=>"virtual"===this.view.environment.lighting.type?null:this.view.environment.lighting.date,a=>this._update(a),
k.syncAndInitial)])}_enable(){super._enable();this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=v.abortMaybe(this._loadDataTask);this._numPoints=0;this._vao=v.disposeMaybe(this._vao);this._starData=null}render(a){a=a.find(({name:g})=>g===F.InternalRenderCategory.OPAQUE_ENVIRONMENT);const c=this.renderingContext;if(this.loading)return this.requestRender(m.RenderRequestType.UPDATE),a;if(!this._starData)return a;
this._vao??(this._vao=this._ensureResources(this._starData,c));const b=this.techniques.acquire(q.StarsTechnique);if(!b.compiled)return this.requestRender(m.RenderRequestType.UPDATE),b.release(),a;c.bindTechnique(b,this.bindParameters,this._passParameters);c.bindVAO(this._vao);c.drawArrays(x.PrimitiveType.POINTS,0,this._numPoints);b.release();return a}_ensureResources(a,c){this._numPoints=a.byteLength/9;const b=new Float32Array(a,0,2*this._numPoints);a=new Uint8Array(a,8*this._numPoints,this._numPoints);
var g=this._numPoints;const n=y.createBuffer(g),t=n.position,p=n.color,M=n.size;for(let e=0;e<g;e++){var d=b[2*e],f=b[2*e+1];t.set(e,0,-Math.cos(d)*Math.sin(f));t.set(e,1,-Math.sin(d)*Math.sin(f));t.set(e,2,-Math.cos(f));d=a[e];d=192<=d?[2.9,d-192]:160<=d?[2.5,d-160]:128<=d?[2,d-128]:96<=d?[1.5,d-96]:64<=d?[1,d-64]:32<=d?[.7,d-32]:[.4,d];f=N[d[1]];f=[parseInt(f.slice(0,2),16),parseInt(f.slice(2,4),16),parseInt(f.slice(4,6),16)];p.set(e,0,255*f[0]);p.set(e,1,255*f[1]);p.set(e,2,255*f[2]);p.set(e,3,
255);M.set(e,d[0])}return new K.VertexArrayObject(c,J.Default3D,new Map([["geometry",G.glLayout(y)]]),new Map([["geometry",L.BufferObject.createVertex(c,x.Usage.STATIC_DRAW,n.buffer)]]))}_update(a){if(a){var c=a.getHours()/12,b=a.getMinutes()/60*(2/24),g=a.getSeconds()/60*(2/1440);c=(c+b+g-.9972222)%2;b=new Date(a.getFullYear(),0,1,11,58,56);g=new Date(a.getFullYear()+1,0,1,11,58,55);a=(+a-+b)/(+g-+b)*2;b=l.copy(this._passParameters.modelMatrix,O);l.rotateZ(b,b,-a*Math.PI);l.multiply(b,P,b);l.rotateZ(b,
b,-c*Math.PI);this.requestRender(m.RenderRequestType.UPDATE)}}_createLoadDataTask(){if(this._starData)return null;const a=B.createTask(async c=>{({data:c}=await A.fetchAsset("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:c}));if(!c)throw new u("stars:no-data-received","Failed to create stars because star catalogue is missing");const b=c.byteLength/9;if(0!==b%1||5E4<b||5E3>b)throw new u("stars:invalid-data","Failed to create stars because star catalogue data is invalid");
this._starData=c});a.promise.catch(c=>{D.isAbortError(c)||C.getLogger(this).error(c)}).then(()=>{this.destroyed||this.requestRender(m.RenderRequestType.UPDATE)});return a}};h.Stars=z.__decorate([E.subclass("esri.views.3d.webgl-engine.effects.stars.Stars")],h.Stars);const N="9bb2ff;9eb5ff;aabfff;bbccff;ccd8ff ;dae2ff;e4e9ff;eeefff;f8f6ff;fff9fb;fff5ef;fff1e5;ffeddb;ffe9d2;ffe6ca;ffe3c3;ffe0bb;ffddb4;ffdaad;ffd6a5;ffd29c;ffcc8f;ffc178;ffa94b;ff7b00".split(";"),P=w.fromValues(1,0,0,0,0,.9174771405229186,
.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),O=w.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),y=H.newLayout().vec3f(r.VertexAttribute.POSITION).vec4u8(r.VertexAttribute.COLOR).f32(r.VertexAttribute.SIZE);Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});