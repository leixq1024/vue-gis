// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/PooledArray","./BufferRange","./DrawCommand"],function(f,k,m,n){function g(){return new k({allocator:a=>a||new n.DrawCommand,deallocator:a=>a})}function h(a,c){const b=a.back();null==b?(a=a.pushNew(),a.first=c.from,a.count=c.numElements):b.first+b.count>=c.from?b.count=c.from-b.first+c.numElements:(a=a.pushNew(),a.first=c.from,a.count=c.numElements)}class l{constructor(){this._numElements=0;this._instances=new Map;this.holes=new k({allocator:a=>a||new m.BufferRange,
deallocator:null});this.hasOccludees=this.hasHiddenInstances=!1;this.drawCommandsDirty=!0;this.highlightGroups=new Set;this.drawCommandsDefault=g();this.drawCommandsHighlights=new Map;this.drawCommandsOccludees=g();this.drawCommandsShadowHighlightRest=g()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return 0<this.highlightGroups.size}resetInstanceSummary(){this.hasOccludees=this.hasHiddenInstances=!1;this.highlightGroups.clear()}updateIfDrawCommandsDirty(a){if(this.drawCommandsDirty){this.resetInstanceSummary();
for(const c of this.instances.values())this.updateDrawState(c);this.updateDrawCommands(a)}}addInstance(a,c){this.deleteInstance(a);this._instances.set(a,c);this._numElements+=c.numElements}deleteInstance(a){const c=this._instances.get(a);c&&(this._numElements-=c.numElements,this._instances.delete(a))}updateInstance(a,c,b){if(a=this._instances.get(a))this._numElements-=a.numElements,a.from=c,a.to=b,this._numElements+=a.numElements}updateDrawState(a){a.isVisible?(a.foreachHighlightGroup(c=>this.highlightGroups.add(c)),
a.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(a){this.drawCommandsDefault.clear();this.drawCommandsHighlights.clear();this.drawCommandsOccludees.clear();this.drawCommandsShadowHighlightRest.clear();this.drawCommandsDirty=!1;if(0!==this._instances.size)if(this.needsMultipleCommands()){a=Array.from(this._instances.values()).sort((b,d)=>b.from===d.from?b.to-d.to:b.from-d.from);var {drawCommandsHighlights:c}=this;for(const b of a)b.isVisible&&(h(b.hasOccludees?
this.drawCommandsOccludees:this.drawCommandsDefault,b),b.hasHighlights?b.foreachHighlightGroup(d=>{let e=c.get(d);e||(e=g(),c.set(d,e));h(e,b)}):h(this.drawCommandsShadowHighlightRest,b))}else{const b=this.drawCommandsDefault.pushNew(),d=this.holes.front();null!=this.vao&&1===this.holes.length&&d.to===Math.floor(this.vao.byteSize/a)?(b.first=0,b.count=d.from):(b.first=Infinity,b.count=0,this._instances.forEach(e=>{b.first=Math.min(b.first,e.from);b.count=Math.max(b.count,e.to)}),b.count-=b.first)}}needsMultipleCommands(){return this.hasOccludees||
this.hasHighlights||this.hasHiddenInstances}}class p extends l{}f.PerBufferData=l;f.PerVaoData=p;f.hasVao=function(a){return null!=a.vao};Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});