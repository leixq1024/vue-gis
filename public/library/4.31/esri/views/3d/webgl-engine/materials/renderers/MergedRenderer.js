// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/NestedMap ../../../../../core/PooledArray ../../../../../core/SetUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/Logger ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/mat4 ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../support/buffer/glUtil ../../core/shaderLibrary/ShaderOutput ../../effects/RenderPlugin ../../lib/GLMaterials ../../lib/ModelDirtyTypes ../../lib/RenderSlot ../../lib/Util ../DrawParameters ./BufferRange ./Instance ./PerBufferData ./PerOriginData".split(" "),
function(A,L,F,fa,R,S,T,U,V,W,ha,X,G,M,Y,z,Z,aa,B,N,H,ba,I,O,P,ca){function da(a,b){const c=a.find(e=>e.numElements>=b);if(null==c)return null;const d=c.from;c.from+=b;c.from>=c.to&&a.removeUnordered(c);return d}function C(a){J.length<a&&(J=new Float32Array(a));return J}function K(a){a*=4;return 1024>=a?1024:262144>a?R.nextHighestPowerOfTwo(a):Math.max(Math.min(262144*Math.ceil(1.5*a/262144),16777216),a)}A.MergedRenderer=class extends Z.SyncRenderPlugin{get _hasAnyHighlight(){return 0<this._highlightGroups.size}constructor(a){super(a);
this._dataByOrigin=new Map;this._drawParameters=new ba.DrawParameters;this._highlightGroups=new Set;this.drapedPriority=0;this._produces=new Map;this._hasOccludees=!1}destroy(){this._glMaterials=S.disposeMaybe(this._glMaterials);this._dataByOrigin.forEach(a=>a.dispose());this._dataByOrigin.clear();this._vaoCache=null}initialize(){this.material.produces.forEach((a,b)=>{this._produces.set(b,c=>0!==this._dataByOrigin.size&&(c!==z.ShaderOutput.Highlight&&c!==z.ShaderOutput.ShadowHighlight||this._hasAnyHighlight)?
a(c):!1)})}initializeRenderContext(a,b){this._glMaterials=new aa.GLMaterials(this.material,b??a.materials);this._bufferWriter=this.material.createBufferWriter();this._vaoCache=a.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,Y.glLayout(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(a){return this.material.queryRenderOccludedState(a)}get numGeometries(){let a=
0;this._dataByOrigin.forEach(b=>a+=b.buffers.reduce((c,d)=>c+=d.instances.size,0));return a}get usedMemory(){let a=0;this._dataByOrigin.forEach(b=>a+=b.buffers.reduce((c,d)=>c+d.vao.usedMemory,0));return a}forEachGeometry(a){this._dataByOrigin.forEach(b=>b.buffers.forEach(c=>c.instances.forEach(({geometry:d})=>a(d))))}modify(a){this._updateGeometries(a.updates);this._addAndRemoveGeometries(a.adds,a.removes);this._updateDrawCommands()}_updateGeometries(a){const b=this._bufferWriter;if(null!=b){var c=
b.vertexBufferLayout.stride/4;for(const e of a){a=e.renderGeometry;const g=this._dataByOrigin.get(a.localOrigin.id)?.findBuffer(a.id);if(null==g)break;const m=g.instances.get(a.id);if(e.updateType&(B.DirtyState.GEOMETRY|B.DirtyState.TRANSFORMATION)){var d=b.elementCount(m.geometry.geometry.attributes)*c;d=C(d);const f=b.vertexBufferLayout.createView(d.buffer);this._writeGeometry(a,f,0);g.vao.vertexBuffers.get("geometry").setSubData(d,m.from*c,0,m.numElements*c)}e.updateType&(B.DirtyState.HIGHLIGHT|
B.DirtyState.OCCLUDEE|B.DirtyState.VISIBILITY)&&(g.drawCommandsDirty=!0)}}}_computeDeltas(a,b){const c=new T.NestedMap;for(var d of a){a=d.localOrigin;if(null==a)continue;let e=c.get(a.id,null);null==e&&(e=new Q(a.vec3),c.set(a.id,null,e));e.changes.push(d)}for(const e of b)b=e.localOrigin,null!=b&&(d=this._dataByOrigin.get(b.id)?.findBuffer(e.id),null!=d&&(a=c.get(b.id,d),null==a&&(a=new Q(b.vec3),c.set(b.id,d,a)),a.changes.push(e)));return c}_addAndRemoveGeometries(a,b){if(null!=this._bufferWriter&&
null!=this._vaoCache){var {_bufferWriter:c,_dataByOrigin:d}=this,e=c.vertexBufferLayout.stride/4,g=this._computeDeltas(a,b);g.forEach((m,f)=>{const u=m.get(null),l=u?.changes??[];g.delete(f,null);let k=d.get(f);m.forEach((n,h)=>{g.delete(f,h);if(null==h)H.assert(!1,"No VAO for removed geometries");else if(h.instances.size===n.changes.length)this._vaoCache.deleteVao(h.vao),F.removeUnordered(k.buffers,h),0===k.buffers.length&&0===l.length&&d.delete(f);else{var p=h.numElements,t=h.vao.byteSize/4,q=l.reduce((w,
v)=>w+c.elementCount(v.geometry.attributes),0),r=n.changes.reduce((w,v)=>w+c.elementCount(v.geometry.attributes),0);p=Math.min((p+q-r)*e,4194304);q=p>t;65536<p&&p<t/2?(n.changes.forEach(({id:w})=>h.deleteInstance(w)),h.instances.forEach(({geometry:w})=>l.push(w)),this._vaoCache.deleteVao(h.vao),F.removeUnordered(k.buffers,h)):q?this._applyAndRebuild(h,l,n):this._applyRemoves(h,n)}});if(0<l.length)for(null==k&&(k=new ca.PerOriginData(u.origin),d.set(f,k)),k.buffers.forEach(n=>this._applyAdds(n,l));0<
l.length;)k.buffers.push(this._applyAndRebuild(new P.PerBufferData,l,null))})}}_updateDrawCommands(){this._highlightGroups.clear();this._hasOccludees=!1;this._dataByOrigin.forEach(a=>{a.buffers.forEach(b=>{b.updateIfDrawCommandsDirty(this._bufferWriter.vertexBufferLayout.stride);b.hasHighlights&&V.addMany(this._highlightGroups,b.highlightGroups);this._hasOccludees=this._hasOccludees||b.hasOccludees})})}_applyAndRebuild(a,b,c){if(c)for(var d of c.changes)a.deleteInstance(d.id);const e=this._bufferWriter;
c=e.vertexBufferLayout.stride;d=c/4;var g=Math.floor(4194304/d);let m=a.numElements;for(;0<b.length;){const k=b.pop();var f=e.elementCount(k.geometry.attributes);if(m+f>g&&0<m){b.push(k);break}m+=f;f=new O.Instance(k,0,0);H.assert(null==a.instances.get(k.id));a.addInstance(k.id,f)}b=m*d;g=C(b);const u=e.vertexBufferLayout.createView(g.buffer);let l=0;a.resetInstanceSummary();a.instances.forEach((k,n)=>{this._writeGeometry(k.geometry,u,l);const h=l;l+=e.elementCount(k.geometry.geometry.attributes);
a.updateInstance(n,h,l);a.updateDrawState(k)});this._vaoCache.deleteVao(a.vao);a.vao=this._vaoCache.newVao(K(b));a.vao.vertexBuffers.get("geometry").setSubData(g,0,0,l*d);a.holes.clear();b=a.holes.pushNew();b.from=l;b.to=Math.floor(a.vao.byteSize/c);a.updateDrawCommands(c);return a}_applyRemoves(a,b){if(0!==b.changes.length&&null!=this._bufferWriter){for(var c of b.changes){var d=c.id;if(b=a.instances.get(d)){a.deleteInstance(d);if(d=x.back()){if(d.to===b.from){d.to=b.to;continue}if(d.from===b.to){d.from=
b.from;continue}}d=x.pushNew();d.from=b.from;d.to=b.to}}I.mergeAdjacentRanges(x);var e=this._bufferWriter.vertexBufferLayout.stride/4;c=x.reduce((f,u)=>Math.max(f,u.numElements),0)*e;var g=C(c);g.fill(0,0,c);var m=a.vao.vertexBuffers.get("geometry");x.forAll(f=>m.setSubData(g,f.from*e,0,f.numElements*e));a.holes.pushArray(x.data,x.length);x.forAll((f,u)=>x.data[u]=null);x.clear();a.drawCommandsDirty=!0}}_applyAdds(a,b){if(0!==b.length&&null!=this._bufferWriter)if(P.hasVao(a)){var c=this._bufferWriter,
d=c.vertexBufferLayout.stride/4,e=a.numElements,g=b.reduce((t,q)=>t+c.elementCount(q.geometry.attributes),0);e=Math.min((e+g)*d,4194304);g=4*e;if(a.vao.byteSize<K(4128768)&&g>a.vao.byteSize)this._applyAndRebuild(a,b,null);else{I.mergeAdjacentRanges(a.holes);var m=[];for(var f of b)g=c.elementCount(f.geometry.attributes),g=da(a.holes,g),m.push(g);var u=a.vao.vertexBuffers.get("geometry"),l=0,k=0,n=0,h=C(e),p=c.vertexBufferLayout.createView(h.buffer);b.forEach((t,q)=>{q=m[q];if(null!=q){if(n!==q){var r=
n-k;0<r&&u.setSubData(h,k*d,0,r*d);k=q;l=0}r=c.elementCount(t.geometry.attributes);this._writeGeometry(t,p,l);l+=r;n=q+r;q=new O.Instance(t,q,q+r);H.assert(null==a.instances.get(t.id));a.addInstance(t.id,q);a.drawCommandsDirty=!0}});f=n-k;0<f&&u.setSubData(h,k*d,0,f*d);F.filterInPlace(b,(t,q)=>null==m[q])}}else this._applyAndRebuild(a,b,null)}_writeGeometry(a,b,c){null!=this._bufferWriter&&(G.copy(y,a.transformation),y[12]-=a.localOrigin.vec3[0],y[13]-=a.localOrigin.vec3[1],y[14]-=a.localOrigin.vec3[2],
G.invert(D,y),G.transpose(D,D),this._bufferWriter.write(y,D,a.geometry.attributes,a.geometry.objectAndLayerIdColor,b,c))}updateAnimation(a){return this.material.update(a)}acquireTechniques(a){if(!this.material.shouldRender(a))return null;const {output:b,bind:c}=a;if(!this.material.produces.get(c.slot)?.(b))return null;const {highlightGroupName:d,slot:e}=c,g=b===z.ShaderOutput.ShadowHighlight,m=b===z.ShaderOutput.Highlight,f=m||g,u=h=>f&&(0===this._highlightGroups.size||m&&!!d&&!h.has(d));if(u(this._highlightGroups))return null;
const l=b===z.ShaderOutput.ShadowExcludeHighlight,k=!(f||l);for(const {buffers:h}of this._dataByOrigin.values())for(const p of h){if(u(p.highlightGroups))continue;var n=g?0<p.drawCommandsHighlights.size:f?d?p.drawCommandsHighlights.get(d):0<p.drawCommandsHighlights.size:((l&&p.needsMultipleCommands()?p.drawCommandsShadowHighlightRest:p.drawCommandsDefault)||null)?.length??!1;const t=k&&p.drawCommandsOccludees||null;if(n||t?.length)if(n=this._glMaterials.load(a.rctx,e,b)?.beginSlot(c))return n}return null}render(a,
b){const {output:c,bind:d}=a,{slot:e,highlightGroupName:g}=d,m=c===z.ShaderOutput.Highlight;if(!m||g){var f=c===z.ShaderOutput.ShadowHighlight,u=m||f,l=c===z.ShaderOutput.ShadowExcludeHighlight,k=!(u||l),n=e===N.RenderSlot.OCCLUDER_MATERIAL||e===N.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL?e:null,{rctx:h}=a;h.runAppleAmdDriverHelper();a=h.bindTechnique(b,d,this.material.parameters);for(const q of this._dataByOrigin.values())for(const r of q.buffers){if(m&&(!r.hasHighlights||!r.drawCommandsHighlights.has(g)))continue;
if(f&&!r.hasHighlights)continue;var p=()=>{const v=[];for(const E of r.drawCommandsHighlights.values())v.push(E);return v},t=u&&!f?r.drawCommandsHighlights.get(g)??null:null;p=f?p():u?t?[t]:ea:l&&r.needsMultipleCommands()?[r.drawCommandsShadowHighlightRest]:[r.drawCommandsDefault];t=p.some(v=>0<v.length);const w=k&&r.drawCommandsOccludees||null;if(t||w?.length){this._drawParameters.origin=q.origin;a.bindDraw(d,this.material.parameters,this._drawParameters);b.ensureAttributeLocations(r.vao);h.bindVAO(r.vao);
if(t)for(const v of p)h.setPipelineState(b.getPipeline(!1,n)),v.forAll(E=>h.drawArrays(b.primitiveType,E.first,E.count));w?.length&&(h.setPipelineState(b.getPipeline(!0,n)),w.forAll(v=>h.drawArrays(b.primitiveType,v.first,v.count)))}}}}get test(){}};L.__decorate([W.property({constructOnly:!0})],A.MergedRenderer.prototype,"material",void 0);A.MergedRenderer=L.__decorate([X.subclass("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],A.MergedRenderer);class Q{constructor(a){this.origin=
a;this.changes=[]}}const y=M.create(),D=M.create(),x=new U({allocator:a=>a||new I.BufferRange,deallocator:null});let J=new Float32Array(65536);const ea=[];A.sizeForVao=K;Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});