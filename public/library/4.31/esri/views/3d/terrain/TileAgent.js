// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/has","./interfaces","./TerrainConst","./tileUtils"],function(m,q,r,y,t){class u{get updating(){return!!this._tileRequested}init(a,d,b,e){this.tile=a;this._layerIdx=d;this._layerClass=b;this._suspended=e;this._tileLayerInfo=a.getLayerInfo(d,b);this._tileRequested=null;a=this._findAncestorWithData();this._setUpsampleTile(a)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,
this),this._tileRequested=null);this._tileLayerInfo=this.tile=null}setSuspension(a){a!==this._suspended&&((this._suspended=a)?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const a=this._findAncestorWithData();this._setUpsampleTile(a);return this._requestNext()}dataArrived(a,d){this._setUpsampleTile(a,d);this._tileRequested=null;a===this.tile?this.tile.updateRenderData(this._layerClass,
r.TextureUpdate.FADING,d):this._requestNext()}dataMissing(){this._tileRequested=null;this._tileLayerInfo.data=null;this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass);this.dispose()}_requestNext(){if(this._suspended)return!0;const a=this._findNextDownload();if(this._tileRequested){if(a===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this);this._tileRequested=null}null!=a?a.requestLayerData(this._layerIdx,this._layerClass,
this)&&(this._tileRequested=a):this._agentDone();return!!this._tileRequested}_findNextDownload(){const a=this._layerIdx,d=this._layerClass;var b=this.tile.surface.layerViewByIndex(a,d);const {minLevel:e,maxLevel:z}=b.dataLevelRange,g=this._desiredMinLevelDelta,A=this._progressiveLevelModulo+g,B=this._scaleRangeEnabled?t.fallsWithinLayerView:()=>!0;let c=this.tile;const h=c.level;let f;const n=this._tileLayerInfo.upsampleInfo,v=n?.tile?.level??-1,C=null!=n?v-h>=g:!1,D=t.getTileMapCache(b),E="vector-tile-3d"===
b.type?b.schemaHelper:null;for(;c&&B(c,b)&&c.level>=e;){const k=c.level,w=h-k,l=c.layerInfo[d][a];if(l.data&&w>=g){(!C||k>v)&&this._setUpsampleTile(c);l.dataInvalidated&&(f=c);break}const p=E?.getLevelRowColumn(c.lij)??c.lij;if("unavailable"!==D?.getAvailability(p[0],p[1],p[2])&&k<=z&&!l.data&&!l.dataMissing){if(!f||c.level===e||0===k%y.progressiveLoadingModulo||h-f.level<g)f=c;if(w>=A)break}c=c.parent}null!=f&&h-f.level<g&&(n?f=null:(b=this._findAncestorWithData(),null!=b&&(this._setUpsampleTile(b),
f=b.layerInfo[d][a].dataInvalidated?b:null)));return f}_findAncestorWithData(){const a=this.tile.elevationLevel,d=this._desiredMinLevelDelta;let b;for(let e=this.tile;e;e=e.parent)if(e.hasLayerData(this._layerIdx,this._layerClass)){if(a-e.level>=d)return e;b=e}return b}_setUpsampleTile(a,d){this._tileLayerInfo.setUpsampleInfo(this.tile,a);this.tile.updateRenderData(this._layerClass,r.TextureUpdate.FADING,d)}get test(){}}class F extends u{constructor(){super(...arguments);this.type="none"}get _desiredMinLevelDelta(){throw x;
}get _progressiveLevelModulo(){throw x;}dispose(){}}const x=Error("Abstract method called on TileAgent");q=new F;m.TileAgent=u;m.tileAgentDone=q;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});