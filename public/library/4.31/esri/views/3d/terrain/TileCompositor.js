// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/maybe ../../../core/libs/gl-matrix-2/factories/vec2f64 ../../2d/engine/imagery/enums ../../2d/engine/vectorTiles/VectorTileRendererHelper3D ./BlendLayersTechnique ./BlendLayersTechniqueConfiguration ./LayerClass ./RasterColorizerTechnique ./RasterColorizerTechniqueConfiguration ./support/MultiSizeFramebuffer ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/core/shaderLibrary/terrain/BaseOpacityMode ../webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput ../webgl-engine/core/shaderLibrary/terrain/PremultipliedAlphaSource ../../../chunks/BlendLayers.glsl ../webgl-engine/lib/BindParameters ../webgl-engine/lib/glUtil3D ../../webgl/enums ../../webgl/Texture ../../webgl/Util".split(" "),
function(v,J,r,K,w,L,x,M,y,z,N,A,t,g,n,k,B,O,C,l,D,P){class Q{constructor(a,b){this._rctx=a;this._techniques=b;this._fbos=[];this._vectorTileHelper=new L.VectorTileRendererHelper3D;this._bindParameters=new O.BindParameters(null);this._blendLayersTechniqueConfig=new M.BlendLayersTechniqueConfiguration;this._current=0;this._lastUsedIds=[];this._lastCreatedBufferId=0;this._onHoldIds=[];this._vaoQuad=C.createQuadVAO(this._rctx,C.Layout.Pos2Tex)}dispose(){this._fbos.forEach(r.disposeMaybe);this._fbos=
null;this._vtFBO=r.disposeMaybe(this._vtFBO);this._vaoQuad=r.disposeMaybe(this._vaoQuad);this._vectorTileHelper=r.disposeMaybe(this._vectorTileHelper)}updateHeading(a){this._vectorTileHelper?.updateHeading(a)}_acquireBlendLayersTechnique(a,b,d,e=k.PremultipliedAlphaSource.Off,c=B.BackgroundMode.BelowLayer){this._blendLayersTechniqueConfig.output=b;this._blendLayersTechniqueConfig.blendMode=a;this._blendLayersTechniqueConfig.baseOpacityMode=d;this._blendLayersTechniqueConfig.premultipliedSource=e;
this._blendLayersTechniqueConfig.background=c;this._techniques.precompile(x.BlendLayersTechnique,this._blendLayersTechniqueConfig);return this._techniques.acquire(x.BlendLayersTechnique,this._blendLayersTechniqueConfig)}drawBackground(a,b){b=this._acquireBlendLayersTechnique(t.LayerBlendMode.Normal,b?n.BlendLayersOutput.ColorComposite:n.BlendLayersOutput.GridComposite,g.BaseOpacityMode.NotRequired,k.PremultipliedAlphaSource.Off,B.BackgroundMode.Only);a=this._rctx.bindTechnique(b,this._bindParameters,
a);this._render(a);b.release()}_render(a){this._rctx.bindVAO(this._vaoQuad);a.assertCompatibleVertexAttributeLocations(this._vaoQuad);this._rctx.drawArrays(l.PrimitiveType.TRIANGLE_STRIP,0,P.vertexCount(this._vaoQuad,"geometry"))}drawGroup(a,b,d,e,c=k.PremultipliedAlphaSource.On){b===n.BlendLayersOutput.Composite&&(a.fboTexture=this._fbos[this.getLastOnHoldId()].get(d).colorTexture);a.texture=this.currentFBO(d).colorTexture;this.closeGroup(d);b=this._acquireBlendLayersTechnique(e,b,1>a.baseOpacity?
g.BaseOpacityMode.Required:g.BaseOpacityMode.NotRequired,c);a=this._rctx.bindTechnique(b,this._bindParameters,a);this._render(a);b.release()}drawImageData(a,b,d,e,c=k.PremultipliedAlphaSource.Off){if(null!=a.texture){var f=1>a.baseOpacity?g.BaseOpacityMode.Required:g.BaseOpacityMode.NotRequired;a.fboTexture=b===n.BlendLayersOutput.GroupBackgroundComposite||e===t.LayerBlendMode.Normal&&f===g.BaseOpacityMode.NotRequired&&c===k.PremultipliedAlphaSource.Off?null:this.switch(d).colorTexture;b=this._acquireBlendLayersTechnique(e,
b,f,c);a=this._rctx.bindTechnique(b,this._bindParameters,a);this._render(a);b.release()}}drawRasterData(a,b,d,e,c){var f=c.sourceLayerInfo.data;if(f.source&&(c.tile.surface.layerViewByIndex(c.layerIndex,y.LayerClass.MAP).ensureSymbolizerParameters(f),f.bind(this._rctx))){var p=1>a.baseOpacity?g.BaseOpacityMode.Required:g.BaseOpacityMode.NotRequired;a.fboTexture=e===t.LayerBlendMode.Normal&&p===g.BaseOpacityMode.NotRequired?null:this.switch(d).colorTexture;b=this._acquireRasterColorizerTechnique(f,
b,e,p);f.opacity=a.opacity;f=f.getUniforms();f.scale=c.scale;f.offset=c.offset;f.backgroundColor=a.backgroundColor;f.fboTexture=a.fboTexture;f.baseOpacity=a.baseOpacity;a=this._rctx.bindTechnique(b,this._bindParameters,f);this._render(a);b.release()}}_acquireRasterColorizerTechnique(a,b,d,e){const c=a.symbolizerParameters,f=["stretch","lut","hillshade"].indexOf(c.type);null==this._rasterColorizerConfig&&(this._rasterColorizerConfig=new N.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),
this._rctx.gl.getExtension("OES_texture_float"));this._rasterColorizerConfig.output=b;this._rasterColorizerConfig.blendMode=d;this._rasterColorizerConfig.baseOpacityMode=e;this._rasterColorizerConfig.colorizerType=f;this._rasterColorizerConfig.applyColormap=!!c.colormap;this._rasterColorizerConfig.requireBilinearWithNN=a.isBilinearWithStretchColorRamp;this._rasterColorizerConfig.stretchType=a.hasStretchTypeNone()?w.RasterColorizerStretchType.Noop:w.RasterColorizerStretchType.PerBand;this._techniques.precompile(z.RasterColorizerTechnique,
this._rasterColorizerConfig);return this._techniques.acquire(z.RasterColorizerTechnique,this._rasterColorizerConfig)}drawVectorData(a,b,d,e,c,f,p,E){const m=this._rctx,F=c.sourceLayerInfo.data,h=c.tile.surface.layerViewByIndex(c.layerIndex,y.LayerClass.MAP);var q=1>a.baseOpacity?g.BaseOpacityMode.Required:g.BaseOpacityMode.NotRequired;const G=q===g.BaseOpacityMode.Required||1>a.opacity||e!==t.LayerBlendMode.Normal||b!==n.BlendLayersOutput.Composite,H=G?k.PremultipliedAlphaSource.On:k.PremultipliedAlphaSource.Off;
q=this._acquireBlendLayersTechnique(e,b,q,H);m.setPipelineState(q.getPipeline());let u=null,I=null;G?(I=this.currentFBO(d),null==this._vtFBO&&(this._vtFBO=new A.MultiSizeFramebuffer(this._rctx)),u=this._vtFBO.get(d),m.bindFramebuffer(u),this._clearCurrentFBO()):E&&m.clear(l.FramebufferBit.DEPTH);try{this._vectorTileHelper.renderBackground(m,c.sourceLod,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/c.scale),c.offset,p,f,h.contentZoom),F&&this._vectorTileHelper.renderContent(m,c.sourceLod,
F,c.vtlNeighborInfos,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/c.scale),c.offset,p,f,h.contentZoom)}catch(R){J.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",R)}q.release();return u?(m.bindFramebuffer(I),a.texture=u.colorTexture,a.offset=K.ZEROS,a.scale=1,this.drawImageData(a,b,d,e,H),E):!0}copyFBOToTexture(a){const b=this._rctx,d=b.bindTexture(a.texture,D.Texture.TEXTURE_UNIT_FOR_UPDATES),e=a.descriptor;b.gl.copyTexImage2D(l.TextureType.TEXTURE_2D,
0,e.pixelFormat,0,0,e.width,e.height,0);a.generateMipmap();b.bindTexture(d,D.Texture.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255);this._rctx.setClearColor(0,0,0,0);this._rctx.setClearDepth(1);this._rctx.setClearStencil(0);this._rctx.clear(l.FramebufferBit.COLOR|l.FramebufferBit.DEPTH|l.FramebufferBit.STENCIL)}_initFBO(a,b,d){this._rctx.bindFramebuffer(a);d&&(this._rctx.setViewport(0,0,b,b),this._clearCurrentFBO())}ensureBuffer(a){this._lastUsedIds.length=0;this._lastUsedIds.push(1);
this._lastCreatedBufferId=1;this._onHoldIds.length=0;this.bind(a)}bind(a,b=0,d=!0){this._current=b;if(b>=this._fbos.length)for(let e=this._fbos.length;e<=b;e++)this._fbos.push(new A.MultiSizeFramebuffer(this._rctx));this._initFBO(this._fbos[b].get(a),a,d)}_bindNextFreeBuffer(a){0<this._lastUsedIds.length?this.bind(a,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(a,this._lastCreatedBufferId))}openGroup(a){this._onHoldIds.push(this._current);this._bindNextFreeBuffer(a)}switch(a){const b=
this.currentFBO(a),d=this._current;this._bindNextFreeBuffer(a);this._lastUsedIds.push(d);return b}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(a){const b=this._current;this._bindNextFreeBuffer(a);this._lastUsedIds.push(b);this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(a){return this._fbos[this._current].get(a)}}v.TileCompositor=Q;Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});