// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../Color ../../../core/has ../../../core/maybe ../../../core/MemCachePool ../../../core/ObjectPool ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/buffer/BufferView ../../ViewingMode ./interfaces ./LayerClass ./OverlayContent ./OverlayRenderer ./PatchRenderData ./RenderOrder ./TerrainAttributesCache ./terrainUtils ./TileRenderer ./TileUpdate ./tileUtils ./TransparencyMode ../webgl-engine/collections/Component/ComponentIntersectionData ../webgl-engine/core/shaderLibrary/ShaderOutput ../webgl-engine/core/shaderLibrary/terrain/TileBlendInput ../webgl-engine/effects/RenderPlugin ../webgl-engine/lib/Attribute ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/Intersector ../webgl-engine/lib/IntersectorInterfaces ../webgl-engine/lib/Material ../webgl-engine/lib/RayIntersections ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/screenSizePerspectiveUtils ../webgl-engine/lib/VertexAttribute ../webgl-engine/lib/verticalOffsetUtils ../webgl-engine/materials/DrawParameters ../../../chunks/Terrain.glsl ../webgl-engine/shaders/TerrainTechnique ../webgl-engine/shaders/TerrainTechniqueConfiguration ../../webgl/enums".split(" "),
function(m,q,ma,na,W,oa,pa,X,t,Ma,Na,qa,ra,J,x,Y,Z,sa,aa,N,ta,C,ba,ua,ca,va,wa,xa,K,O,E,da,e,L,P,ya,Q,za,Aa,M,ea,R,y,Ba,Ca,fa,Da,Ea,Fa,Ga,S){const T=Z.create();m.TerrainRenderer=class extends P.SyncRenderPlugin{get _isGlobal(){return this._stage.viewingMode===aa.ViewingMode.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(a,b,d,c,h){super({});this._overlayRenderer=a;this._stage=b;this._allTiles=d;this._ellipsoidRadius=c;this.type=
M.IntersectorType.TERRAIN;this.isGround=!0;this._tileSize=256;this._passParameters=new Ea.TerrainPassParameters;this._drawParameters=new Da.DrawParameters;this._renderDataPool=new pa(ua.PatchRenderData);this._visiblePatchesByOrigin=new Map;this._allPatchesByOrigin=new Map;this._patchSortingDirty=this._patchesByOriginDirty=!0;this._tileIterator=new O.IteratorPreorder;this._inViewshed=this._castShadows=!1;this._tileRenderer=this._emptyTex=null;this._stencilEnabledLayerExtents=[];this._numOriginsRendered=
this._numTilesCulled=this._numTilesRendered=0;this.renderOccludedFlags=ea.RenderOccludedFlag.Occlude;this.produces=new Map([[y.RenderSlot.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===E.TransparencyMode.Opaque],[y.RenderSlot.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===E.TransparencyMode.Transparent||this.transparency===E.TransparencyMode.InvisibleWithDraped)],[y.RenderSlot.OCCLUDED_TERRAIN,()=>this._produces()]]);this._configuration=new Ga.TerrainTechniqueConfiguration(b.viewingMode===
aa.ViewingMode.Global);this._tileTextureCache=new oa.MemCachePool((n,f)=>h.newCache(n,f),"TileTexture");this.tileGeometryCache=new va.TerrainAttributesCache(h)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this);this.addHandles(X.watch(()=>this._overlayRenderer.rendersOccludedDraped,a=>{this.renderOccludedFlags=a?ba.overlayRenderOccludedFlag:ea.RenderOccludedFlag.Occlude;this.setNeedsRender()},X.sync))}destroy(){this._stage.removeRenderPlugin(this);this._tileTextureCache.destroy();
this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?P.ConsumesDepth:P.ConsumesNone}set renderingDisabled(a){this._set("renderingDisabled",!!a);this.setDirty()}set visible(a){this._set("visible",!!a);this.setDirty()}updateHeading(a){this._tileRenderer?.updateHeading(a)}set transparency(a){this._configuration.transparencyMode!==a&&(this._configuration.transparencyMode=a,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(a){this._configuration.tileBorders!==
a&&(this._configuration.tileBorders=a,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(a){this._configuration.visualizeNormals!==a&&(this._configuration.visualizeNormals=a,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(a){this._configuration.backfaceCullingEnabled!==a&&(this._configuration.backfaceCullingEnabled=
a,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(a){this._set("renderOrder",a);this._setSortingDirty()}get layerUid(){return fa.terrainId}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(a){this._configuration.hasSlicePlane!==a&&(this._configuration.hasSlicePlane=a,this.setNeedsRender())}set textureFadingEnabled(a){this._configuration.textureFadingEnabled!==a&&(this._configuration.textureFadingEnabled=a,this.setNeedsRender())}set pbrMode(a){this._configuration.pbrMode!==
a&&(this._configuration.pbrMode=a,this.setNeedsRender())}setDebugScreenSizePerspective(a){this._configuration.screenSizePerspective!==a&&(this._configuration.screenSizePerspective=a,this.setNeedsRender())}setRootTiles(a){this._rootTiles=a;this.setDirty()}setStencilEnabledLayerExtents(a){this._stencilEnabledLayerExtents=a;this._setSortingDirty()}setTileSize(a){this._tileSize=a;null!=this._tileRenderer&&(this._tileRenderer.tileSize=a);this.setDirty()}_ensureRenderData(a){a.renderData||(a.renderData=
this._renderDataPool.acquire(),a.renderData.init(a,this._getLocalOriginOfTile(a)))}loadTile(a){this._ensureRenderData(a);this.updateTileGeometryState(a);this.reuseTextureFromParent(a)||this.updateTileTexture(a,K.TileUpdate.TEXTURE_FADING)}reuseTextureFromParent(a){const b=a.parent;if(!b)return!1;const d=Y.fromValues(a.lij[2]&1?.5:0,a.lij[1]&1?0:.5,.5,.5);return b.renderData?.reuseTexture(a.renderData,d)??!1}updateTileTexture(a,b){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(a,b===
K.TileUpdate.TEXTURE_FADING?N.TextureUpdate.FADING:N.TextureUpdate.UNFADED),this.setNeedsRender(),a.resetPendingUpdate(b))}updateTileGeometryState(a){for(const b of a.layerInfo[ta.LayerClass.ELEVATION])b.pendingUpdates&=~K.TileUpdate.GEOMETRY;a.resetPendingUpdate(K.TileUpdate.GEOMETRY);(a=a.renderData.updateGeometryState())&&this.setDirty();return a}updateGeometryIfNeeded(a){a.loaded&&a.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(a){const b=a.renderData;b&&(b.releaseGeometry(),this._renderDataPool.release(b),
b.clear(),a.renderData=null,a.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(a){const b=Math.max(0,7*Math.floor((a.level-3)/7));if(this._isGlobal&&0===b)return x.ZEROS;for(;a.parent&&a.level>b;)a=a.parent;return a.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(a){this._get("wireframe")!==a&&(this._set("wireframe",a),this.setNeedsRender())}setDirty(a=Q.RenderRequestType.UPDATE){this._patchesByOriginDirty=
!0;this._context.requestRender(a)}_setSortingDirty(a=Q.RenderRequestType.UPDATE){this._patchSortingDirty=!0;this._context.requestRender(a)}setNeedsRender(a=Q.RenderRequestType.UPDATE){this._context.requestRender(a)}initializeRenderContext(a){this._context=a;this._tileRenderer=new xa.TileRenderer(this._rctx,this._tileSize,this._techniques,this._tileTextureCache);this.updateTileBackground();this._emptyTex=za.createEmptyTexture(this._rctx)}uninitializeRenderContext(){this._emptyTex=W.disposeMaybe(this._emptyTex);
this._tileRenderer=W.disposeMaybe(this._tileRenderer)}intersect(a,b,d,c){if(!(!this._rootTiles||a.options.selectOpaqueTerrainOnly&&a.options.selectionMode&&this.transparency!==E.TransparencyMode.Opaque)){var h=Ha,n=Ia;J.subtract(h,c,d);J.set(n,1/h[0],1/h[1],1/h[2]);var f=a.results.min,g=a.results.max,u=a.results.ground,v=a.options.store===M.StoreResults.MIN,F=!!a.results.ground.target,r=fa.getVerticalOffsetTerrain(a.verticalOffset),D=a.tolerance,G,U=v&&null!=f.dist?f.dist:Infinity,z=a.options,ha=
z.normalRequired||!z.backfacesTerrain,ia=new R.MeshIntersectionOptions(!1,ha),La=A=>{var B=A.renderData;if(B?.vao){var k=B.geometry;Z.set(T,k.boundingBox);var p=B.localOrigin;null!=r&&(r.localOrigin=p,r.applyToAabb(T));H[0]=d[0]-p[0];H[1]=d[1]-p[1];H[2]=d[2]-p[2];if(R.intersectAabbInvDirBefore(T,H,n,D,U)){var I=(l,ja,w)=>{l.set(this.type,A,ja,w,ra.IDENTITY);U=v&&null!=f.dist?f.dist:Infinity};B=(l,ja,w)=>{(!ha||null!=w)&&0<=l&&(z.backfacesTerrain||0>J.dot(w,h))&&(z.invisibleTerrain||!z.selectionMode||
null==b||b(d,c,l))&&((null==u.dist||l<u.dist)&&I(u,l,w),z.isFiltered||(z.store===M.StoreResults.ALL&&(null==G?(G=Aa.newIntersectorResult(a.ray),I(G,l,w),a.results.all.push(G)):l<G.dist&&I(G,l,w)),(null==f.dist||l<f.dist)&&I(f,l,w),z.store!==M.StoreResults.MIN&&(null==g.dist||l>g.dist)&&I(g,l,w)))};var V=Ja;J.subtract(V,c,p);var {indices:ka,indexCount:Ka}=k;k=k.vertexAttributes;p=k.getField(Ca.VertexAttribute.POSITION,sa.BufferViewVec3f);k=new ya.Vertices(p.typedBuffer,3,k.stride/4);p=Ka/3;if(!r&&
p>da.componentMinimalSizeForIntersectionData){const l=A.renderData;null==l.intersectionData&&(l.intersectionData=new da.ComponentIntersectionData(ka,0,p,k));l.intersectionData.intersectRay(H,V,ia,B)}else R.intersectTriangles(H,V,0,p,ka,k,r,ia,B)}}},la=this._rootTiles;null!=la&&(()=>{const A=this._tileIterator;A.reset(la);const B=a.options.invisibleTerrain;for(let k=A.next();k;k=A.next())!(k.visible||B&&k.intersectsClippingArea)||null==r&&!k.intersectsRay(d,h,D,U)||F&&this._useStencilForTile(k)?A.skipSubtree():
La(k)})()}}processScaleRangeQueries(a,b){if(!b.done)for(this._updatePatchGroups();a.updating&&!b.done;){a.prepare();for(const d of this._visiblePatchesByOrigin.values())for(const c of d)null!=c.renderData?.textureReference&&a.queriesForTile(c);a.process();b.madeProgress()}}acquireTechniques(a){var b=!!na("enable-feature:terrain-shadows")&&a.bind.shadowMap.enabled;b!==this._castShadows&&(this._castShadows=b,this._patchesByOriginDirty=!0);b=a.bind.viewshedEnabled;this._inViewshed!==b&&(this._inViewshed=
b,this._patchesByOriginDirty=!0);if(a.bind.slot===y.RenderSlot.OCCLUDED_TERRAIN){if(0===(a.renderOccludedMask&ba.overlayRenderOccludedFlag))return null}else if(a.bind.slot!==(this.transparency===E.TransparencyMode.Opaque?y.RenderSlot.OPAQUE_TERRAIN:y.RenderSlot.TRANSPARENT_TERRAIN))return null;if(this.transparency===E.TransparencyMode.Invisible)return null;this._configuration.screenSpaceReflections=this._configuration.cloudReflections=this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=
!1;this._configuration.overlayMode=this._overlayRenderer.mode;switch(a.output){case e.ShaderOutput.Color:case e.ShaderOutput.ColorEmission:return this._configuration.screenSpaceReflections=null!=a.bind.ssr.lastFrameColor,this._configuration.cloudReflections=null!=a.bind.clouds.data,this._configuration.receiveShadows=a.bind.shadowMap.ready,this._configuration.receiveAmbientOcclusion=null!=a.bind.ssao,this._acquireTechnique(a.output,a.bind.slot===y.RenderSlot.OCCLUDED_TERRAIN);case e.ShaderOutput.Shadow:case e.ShaderOutput.ShadowExcludeHighlight:return this._castShadows?
this._acquireTechnique(e.ShaderOutput.Shadow,!1):null;case e.ShaderOutput.ViewshedShadow:return this._inViewshed?this._acquireTechnique(e.ShaderOutput.ViewshedShadow,!1):null;case e.ShaderOutput.Depth:case e.ShaderOutput.Normal:return this._acquireTechnique(a.output,!1);case e.ShaderOutput.ObjectAndLayerIdColor:return this._acquireTechnique(e.ShaderOutput.ObjectAndLayerIdColor,!1);case e.ShaderOutput.Highlight:return this._overlayRenderer.hasHighlights?this._acquireTechnique(e.ShaderOutput.Highlight,
!1):null}return null}render(a,b){this._updatePatchGroups();b.useStencil=!1;switch(a.output){case e.ShaderOutput.Color:case e.ShaderOutput.ColorEmission:this._renderMaterialPass(a,b,a.bind.slot===y.RenderSlot.OCCLUDED_TERRAIN?C.OverlayContent.Occluded:C.OverlayContent.Color);break;case e.ShaderOutput.Depth:case e.ShaderOutput.Normal:this._renderAuxiliaryPass(a,b,C.OverlayContent.Color,this._visiblePatchesByOrigin);break;case e.ShaderOutput.Highlight:this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(C.OverlayContent.Highlight)&&
this._renderAuxiliaryPass(a,b,C.OverlayContent.Highlight,this._visiblePatchesByOrigin);break;case e.ShaderOutput.Shadow:case e.ShaderOutput.ShadowExcludeHighlight:case e.ShaderOutput.ViewshedShadow:this._renderAuxiliaryPass(a,b,null,this._allPatchesByOrigin);break;case e.ShaderOutput.ObjectAndLayerIdColor:this._renderAuxiliaryPass(a,b,C.OverlayContent.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(a){if(null!=this._tileRenderer){var b=this._tileRenderer;if(null!=a){a=ma.toUnitRGBA(a);
var d=x.fromValues(a[0]||0,a[1]||0,a[2]||0)}b.setBackground(d);this._allTiles.forAll(c=>b.updateTileTexture(c,N.TextureUpdate.FADING));this._configuration.tileBlendInput=b.backgroundIsGrid?L.TileBlendInput.GridComposite:null!=b.backgroundColor?L.TileBlendInput.ColorComposite:L.TileBlendInput.LayerOnly;this.setNeedsRender()}}_updatePatchGroups(){this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0);if(this._patchSortingDirty&&this.renderOrder!==
ca.RenderOrder.NONE){const a=Array.from(this._visiblePatchesByOrigin.values()),b=this._stencilEnabledLayerExtents;for(const d of a)O.sortTiles(this.renderOrder,d,b);a.sort((d,c)=>O.compareTiles(d[0],c[0],this.renderOrder));this._visiblePatchesByOrigin=new Map(a.map(d=>[d[0].renderData.localOrigin,d]));this._patchSortingDirty=!1}}_rebuildPatchGroups(){const a=this._rootTiles;if(null!=a){a[0]?.surface.checkAllTilesWaterproofness();this._visiblePatchesByOrigin.clear();this._allPatchesByOrigin.clear();
for(const b of a)this._rebuildPatchGroupsForRootTile(b)}}_rebuildPatchGroupsForRootTile(a){const b=this._tileIterator;for(b.resetOne(a);!b.done;){a=b.next();var d=a.renderData;if(d){d=d.localOrigin;if(this._castShadows||this._inViewshed){var c=this._allPatchesByOrigin.get(d);c||(c=[],this._allPatchesByOrigin.set(d,c));c.push(a)}a.visible?(c=this._visiblePatchesByOrigin.get(d),c||(c=[],this._visiblePatchesByOrigin.set(d,c)),c.push(a),b.skipSubtree()):(this._numTilesCulled++,b.skipSubtree())}else this._numTilesCulled++}}_useStencilForTile(a){for(const b of this._stencilEnabledLayerExtents)if(a.intersectsExtent(b))return!0;
return!1}_renderAuxiliaryPass(a,b,d,c){const h=a.rctx;this._passParameters.overlayContent=d;h.bindTechnique(b,a.bind,this._passParameters);const n=0<this._stencilEnabledLayerExtents.length;c.forEach(f=>{this._drawParameters.origin=f[0].renderData.localOrigin;b.program.bindDraw(a.bind,this._passParameters,this._drawParameters);for(let g=0;g<f.length;g++)this._renderPatch(a,b,f[g],S.PrimitiveType.TRIANGLES,n,d)});a.rctx.bindVAO(null)}_renderMaterialPass(a,b,d){var {rctx:c}=a;this._passParameters.overlayContent=
d;c.bindTechnique(b,a.bind,this._passParameters);this._numOriginsRendered=this._numTilesCulled=this._numTilesRendered=0;var h=a.bind.camera;c=b.program;this._configuration.screenSizePerspective&&this.pointsOfInterest&&Ba.getSettings(this._stage.viewingMode,this._ellipsoidRadius).update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:h.fovY});h=0<this._stencilEnabledLayerExtents.length;const n=d===C.OverlayContent.Occluded;n&&(c.bindTexture("tex",this._emptyTex),c.setUniform3fv("textureOpacities",
x.ZEROS),c.setUniform4fv("texOffsetAndScale",Y.ZEROS));var f=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:x.ZEROS;this._configuration.tileBlendInput===L.TileBlendInput.ColorComposite&&c.setUniform3fv("backgroundColor",f);f=this.wireframe?S.PrimitiveType.LINES:S.PrimitiveType.TRIANGLES;this._configuration.textureFadingEnabled&&c.bindTexture("texNext",this._emptyTex);var g=this._visiblePatchesByOrigin;for(const u of g.values()){this._drawParameters.origin=u[0].renderData.localOrigin;
b.program.bindDraw(a.bind,this._passParameters,this._drawParameters);this._numOriginsRendered++;for(const v of u){g=v.renderData;const F=g.textureReference;if(null!=F){if(!n){c.setUniform4fv("texOffsetAndScale",F.offsetAndScale);c.bindTexture("tex",F.texture.texture);const r=g.textureFadeFactor,D=1>r?g.nextTextureReference:null;this._configuration.textureFadingEnabled&&null!=D&&1>r?(c.setUniform1f("fadeFactor",r),c.setUniform4fv("nextTexOffsetAndScale",D.offsetAndScale),c.setUniform3fv("nextTexOpacities",
D.opacities),c.bindTexture("texNext",D.texture.texture)):c.setUniform1f("fadeFactor",1);g.textureIsFading&&this.setNeedsRender();c.setUniform3fv("textureOpacities",F.opacities)}this._renderPatch(a,b,v,f,h,d);v.renderOrder=this._numTilesRendered;this._numTilesRendered++}}}a.rctx.bindVAO(null)}_renderPatch(a,b,d,c,h,n){const f=d.renderData,g=f.vao,u=g?.indexBuffer;if(g&&null!=u){var v=b.program;null==n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(v,f.overlay);h&&(b.useStencil=this._useStencilForTile(d),
a.rctx.setPipelineState(b.getPipeline()));b=f.geometry.indexCount;a.rctx.bindVAO(g);v.assertCompatibleVertexAttributeLocations(g);a.rctx.drawElements(c,b,u.indexType,0)}else wa.enableTerrainInternalChecks&&console.error("Rendered tile with no indices: ",d.lij," : ",f)}_bindOverlayPatchData(a,b){a.setUniform4fv("overlayTexOffset",b.offsets);a.setUniform4fv("overlayTexScale",b.scales)}_acquireTechnique(a,b){this._configuration.output=a;this._configuration.renderOccluded=b;return this._techniques.acquire(Fa.TerrainTechnique,
this._configuration)}get test(){}};q.__decorate([t.property({readOnly:!0})],m.TerrainRenderer.prototype,"_isGlobal",null);q.__decorate([t.property()],m.TerrainRenderer.prototype,"renderOccludedFlags",void 0);q.__decorate([t.property({value:!1})],m.TerrainRenderer.prototype,"renderingDisabled",null);q.__decorate([t.property({value:!0})],m.TerrainRenderer.prototype,"visible",null);q.__decorate([t.property()],m.TerrainRenderer.prototype,"renderPatchBorders",null);q.__decorate([t.property()],m.TerrainRenderer.prototype,
"visualizeNormals",null);q.__decorate([t.property()],m.TerrainRenderer.prototype,"cullBackFaces",null);q.__decorate([t.property({value:ca.RenderOrder.FRONT_TO_BACK})],m.TerrainRenderer.prototype,"renderOrder",null);q.__decorate([t.property()],m.TerrainRenderer.prototype,"wireframe",null);m.TerrainRenderer=q.__decorate([qa.subclass("esri.views.3d.terrain.TerrainRenderer")],m.TerrainRenderer);const Ha=x.create(),Ia=x.create(),H=x.create(),Ja=x.create();Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});