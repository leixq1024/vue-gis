// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../core/has ../../../core/maybe ../../../core/libs/gl-matrix-2/math/vec2 ../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../layers/support/layerUtils ./BlendLayersTechnique ./interfaces ./LayerClass ./NeighborIndex ./TerrainData ./terrainUtils ./TextureFader ./TextureReference ./TileCompositor ./TileRenderInfo ./TileTexture ./TileUpdate ./tileUtils ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput ../webgl-engine/lib/glUtil3D ../../webgl/enums ../../webgl/Texture ../../webgl/TextureDescriptor".split(" "),
function(K,ma,R,S,T,U,A,da,L,B,y,ea,v,V,M,fa,ha,W,H,X,Y,w,ia,F,N,ja){function O(a,b,c){f.layerIndex=b;f.vtlNeighborInfos.clear();const d=a.layerInfo[B.LayerClass.MAP][b];S.set(f.offset,0,0);f.tile=a;f.scale=1;f.sourceLod=a.lij;f.sourceLayerInfo=d;f.isVTLBackground=c;if(d.data)return c&&a.forEachLoadedNeighbor((n,C)=>{if(n.level===a.level){var l=n.layerInfo[B.LayerClass.MAP][b];if(v.isVectorTilePerLayerInfo(l)&&d.data!==l.data){var p=f.vtlNeighborInfos.pushNew();p.offset=x[C];p.sourceLod=n.lij;p.sourceLayerInfo=
l}}}),f;const e=d.upsampleInfo,r=e?.tile?.layerInfo[B.LayerClass.MAP][b];return r?(f.tile=e.tile,S.copy(f.offset,e.offset),f.scale=e.scale,f.sourceLod=e.tile.lij,f.sourceLayerInfo=r,f):c?f:null}function ka(a){a=a.sourceLayerInfo.data;return a.source?"nearest"===a.interpolation:!1}function Z(a){let b="normal"!==a.blendMode;A.isGroupLayer(a.parent)&&(b=Z(a.parent)||b);return b}function aa(a,b){A.isGroupLayer(a.parent)&&aa(a.parent,b);const c=a.uid;if(null!=c&&""!==c){const d=I.get(c);d?d.start=b:I.set(c,
new ba(b,b,a.blendMode,a.opacity,w.BlendLayersOutput.Composite,1))}}class ba{constructor(a,b,c,d,e,r){this.start=a;this.end=b;this.blendMode=c;this.opacity=d;this.output=e;this.baseOpacity=r}}class la{constructor(a,b,c,d){this._rctx=a;this.tileSize=b;this._techniques=c;this._cache=d;this._passParameters=new da.BlendLayersPassParameters;this._backgroundColor=this._backgroundTexture=null;this._backgroundDirty=!1;this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy;this._compositor=new fa.TileCompositor(this._rctx,
this._techniques);this._ensureBackgroundTexture(this.tileSize)}dispose(){this._compositor=R.disposeMaybe(this._compositor);this._backgroundTexture=R.releaseMaybe(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(a){this._compositor?.updateHeading(a)}updateTileTexture(a,b){if(a.renderData){var c=a.surface,d=c.baseOpacity,e=0,r=0,n=this.tileSize,C=!1,l=!1,p=c.view.state.contentPixelRatio,t=!1;I.clear();
G.length=0;for(var z=a.layerInfo[B.LayerClass.MAP],h=0,D=null;h<z.length;h++){const k=c.layerViewByIndex(h,B.LayerClass.MAP),q=k.layer;var m=!X.fallsWithinLayerView(a,k),g=q.opacity;const P=k.fullOpacity;l=l||A.isBaseLayer(q);if(v.isBlendableLayerView(k)){var u="normal"!==k.layer.blendMode;if(A.isGroupLayer(q.parent)){const E=q.parent.uid;null!=E&&""!==E&&(u=Z(q.parent)||u)}u&&(t=u,C=!1)}if(!m&&0!==g||t){if(++r,m=v.isVectorTileLayerView(k),g=O(a,h,m))z[h].pendingUpdates&=~(H.TileUpdate.TEXTURE_NOFADING&
H.TileUpdate.TEXTURE_FADING),A.isGroupLayer(q.parent)&&(u=q.parent.uid,null!=u&&""!==u&&aa(q.parent,h)),m?n=Math.max(n,this.tileSize*p):1===d&&1===P&&(k.isOpaque||this._dataToTexture(g)&&g.sourceLayerInfo.data.descriptor.isOpaque)&&(C=!0),++e,null===D&&(D=h)}else z[h].pendingUpdates&=~(H.TileUpdate.TEXTURE_NOFADING&H.TileUpdate.TEXTURE_FADING)}d=n/this.tileSize;c=this._ensureBackgroundTexture(this.tileSize);0===e||null===D?(e=a.renderData,b=b===L.TextureUpdate.FADING&&null!=e.textureReference&&(a.surface.view.layerViewManager.updating||
0<r)?V.ActivationTime.Delayed:V.ActivationTime.Immediate,e.setTextureReference(new M.TextureReference(c,L.TextureUpdate.FADING,ca,a.surface.baseOpacity,0,1),b)):1===e&&!t&&this._useLayerTexture(a,D)||this._composeLayers(a,b,h-1,l,n,d,!C||t,I,t)}}_ensureBackgroundTexture(a){null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(a,!1),this._backgroundDirty=!0);this._backgroundDirty&&(this._compositor.bind(a),this._passParameters.offset=T.ZEROS,this._passParameters.scale=1,this._passParameters.opacity=
1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1);return this._backgroundTexture}_useLayerTexture(a,b){var c=a.surface.layerViewByIndex(b,B.LayerClass.MAP),d=A.isBaseLayer(c.layer);const e=d?a.surface.baseOpacity:1;d=d?1:a.surface.baseOpacity;c=c.fullOpacity;b=O(a,b,!1);return this._dataToTexture(b)?
(a.renderData.setTextureReference(new M.TextureReference(b.sourceLayerInfo.data,L.TextureUpdate.FADING,U.fromValues(b.offset[0],b.offset[1],b.scale,b.scale),e,d,c)),!0):!1}_composeLayers(a,b,c,d,e,r,n,C,l){this._compositor.ensureBuffer(e);const p=a.surface.baseOpacity;let t=!1,z=F.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,h=!1,D=0;for(let k=c;0<=k;k--){c=a.surface.layerViewByIndex(k,B.LayerClass.MAP);var m=c.layer,g=v.isVectorTileLayerView(c);g=O(a,k,g);const q=m.opacity,P=!X.fallsWithinLayerView(a,
c);if(!g||(0===q||P)&&!l)continue;const E=!A.isBaseLayer(m)&&!t;E&&(t=!0);let Q=!1;C.forEach(J=>{J.start===k&&(J.output=d?w.BlendLayersOutput.Composite:n&&E?this.backgroundIsGrid?w.BlendLayersOutput.GridComposite:w.BlendLayersOutput.ColorComposite:w.BlendLayersOutput.Composite,J.baseOpacity=E?p:1,G.push(J),this._compositor.openGroup(e),Q=!0)});m=0===D;m=Q?w.BlendLayersOutput.GroupBackgroundComposite:n&&m?this.backgroundIsGrid?w.BlendLayersOutput.GridComposite:w.BlendLayersOutput.ColorComposite:w.BlendLayersOutput.Composite;
c=Y.blendModeFromString[v.isBlendableLayerView(c)?c.layer.blendMode:"normal"];this._passParameters.baseOpacity=E&&!Q&&1>p?p:1;this._passParameters.opacity=q;v.isVectorTileRenderInfo(g)?h=this._compositor.drawVectorData(this._passParameters,m,e,c,g,r,this.tileSize,h):v.isImageryTileRenderInfo(g)?(this._compositor.drawRasterData(this._passParameters,m,e,c,g),ka(g)&&(z=F.TextureSamplingMode.NEAREST)):this._dataToTexture(g)&&(this._passParameters.texture=g.sourceLayerInfo.data.texture,this._passParameters.offset=
g.offset,this._passParameters.scale=g.scale,this._compositor.drawImageData(this._passParameters,m,e,c));for(;0<G.length&&G[G.length-1].end===k;)c=G.pop(),this._passParameters.baseOpacity=c.baseOpacity,this._passParameters.opacity=c.opacity,this._passParameters.offset=T.ZEROS,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,c.output,e,Y.blendModeFromString[c.blendMode]);D++}a=a.renderData;const u=l||t&&1>p;l=a.ensureTexture(e,u,b,()=>this._buildTexture(e,u,z));this._compositor.copyFBOToTexture(l);
this._compositor.unbind();a.setTextureReference(new M.TextureReference(l,b,ca,t?1:p,0,1))}_dataToTexture(a){if(v.isImageSourceRenderInfo(a)){const b=a.sourceLayerInfo;b.data=this._buildTexture(b.data,!0);a.tile.setMemoryDirty()}return v.isTextureTileRenderInfo(a)}setBackground(a){this._backgroundColor!==a&&(this._backgroundColor=a,this._backgroundDirty=!0)}_buildTexture(a,b,c=F.TextureSamplingMode.LINEAR_MIPMAP_LINEAR){if(null==a)return null;const d=new ja.TextureDescriptor;d.wrapMode=F.TextureWrapMode.CLAMP_TO_EDGE;
d.samplingMode=c;d.maxAnisotropy=this._maxAnisotropy;d.preMultiplyAlpha=!0;d.flipped=!0;d.hasMipmap=!0;b||(d.pixelFormat=F.PixelFormat.RGB);b=this._rctx;let e;if("number"===typeof a)d.width=d.height=a,e=this._buildTileTexture(d,a);else if(ea.isImageWithType(a))d.isOpaque=a.isOpaque,d.isOpaque&&(d.pixelFormat=F.PixelFormat.RGB),e=this._buildTileTexture(d,a.element.width,a.element);else try{d.width=a.width,d.height=a.height,e=this._buildTileTexture(d,a.width,a)}catch(r){e=new W(ia.createEmptyTexture(b)),
console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}a=b.bindTexture(e.texture,N.Texture.TEXTURE_UNIT_FOR_UPDATES);e.generateMipmap();b.bindTexture(a,N.Texture.TEXTURE_UNIT_FOR_UPDATES);return e}_buildTileTexture(a,b,c){return(b=this._cache.pop(`${b} ${a.pixelFormat}`))?(b.retain(),b.texture.setData(c),b):new W(new N.Texture(this._rctx,a,c),this._cache)}get test(){}}const I=new Map,G=[],f=new ha.TileRenderInfo,ca=U.fromValues(0,0,1,1),x=[];x[y.NeighborIndex.NORTH]=
[0,-1];x[y.NeighborIndex.NORTH_EAST]=[-1,-1];x[y.NeighborIndex.EAST]=[-1,0];x[y.NeighborIndex.SOUTH_EAST]=[-1,1];x[y.NeighborIndex.SOUTH]=[0,1];x[y.NeighborIndex.SOUTH_WEST]=[1,1];x[y.NeighborIndex.WEST]=[1,0];x[y.NeighborIndex.NORTH_WEST]=[1,-1];K.GroupInfo=ba;K.TileRenderer=la;Object.defineProperty(K,Symbol.toStringTag,{value:"Module"})});