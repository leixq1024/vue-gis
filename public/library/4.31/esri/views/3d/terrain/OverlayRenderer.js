// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../core/Evented ../../../core/has ../../../core/MapUtils ../../../core/maybe ../../../core/PooledArray ../../../core/reactiveUtils ../../../core/SetUtils ../../../core/accessorSupport/decorators/property ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../core/libs/gl-matrix-2/math/mat4 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../layers/interfaces ../support/debugFlags ./interfaces ./Overlay ./OverlayContent ./OverlayRenderTargets ../webgl/RenderCamera ../webgl-engine/core/shaderLibrary/ShaderOutput ../webgl-engine/core/shaderLibrary/terrain/Overlay.glsl ../../../chunks/TextureOnly.glsl ../webgl-engine/effects/RenderPlugin ../webgl-engine/effects/highlight/Highlight ../webgl-engine/lib/GLMaterialRepository ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/Material ../webgl-engine/lib/OITPass ../webgl-engine/lib/RenderContext ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/ShadowMap ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/TextureTechnique ../webgl-engine/lib/TextureTechniqueConfiguration ../webgl-engine/lib/Update ../webgl-engine/lib/UpdatePolicy ../webgl-engine/lighting/Lightsources ../../../chunks/OverlayCompositing.glsl ../webgl-engine/shaders/OverlayCompositingTechnique ../../support/Scheduler ../../webgl/enums ../../webgl/Texture ../../webgl/TextureDescriptor".split(" "),
function(h,m,L,ka,v,E,M,p,z,n,la,ma,N,F,O,P,q,A,u,G,k,Q,R,t,w,S,T,H,U,V,W,X,x,r,Y,Z,I,aa,ba,ca,da,ea,J,K,B,fa,ha){h.OverlayRenderer=class extends T.SyncRenderPlugin{constructor(a){super(a);this._renderTargets=this._overlays=null;this._overlayParameters=new ea.OverlayCompositingPassParameters;this._hasWater=this.hasHighlights=!1;this._renderers=new Map;this._sortedDrapeSourceRenderersDirty=!1;this._sortedRenderers=new M;this._passParameters=new S.TextureOnlyPassParameters;this._materials=null;this._screenToWorldRatio=
1;this._localOriginFactory=null;this.unloadedMemory=0;this.ignoresMemoryFactor=!1;this._camera=new R;this.worldToPCSRatio=1;this.events=new L;this.longitudeCyclical=null;this.produces=new Map([[r.RenderSlot.DRAPED_MATERIAL,b=>b!==t.ShaderOutput.Highlight||this.hasHighlights],[r.RenderSlot.DRAPED_WATER,()=>this._hasWater]]);this._hasDrapedRasterSource=this._hasDrapedFeatureSource=this._hasTargetWithoutRasterImage=!1}initialize(){const {view:a}=this,{_stage:b}=a,c=b.renderer.fboCache,{waterTextures:d,
textures:f}=b.renderView;this._renderContext=new x.OverlayRenderContext(this._rctx,new Y.ShadowMap(c,a.state.viewingMode));this.addHandles([p.watch(()=>d.updating,()=>this.events.emit("content-changed"),p.syncAndInitial),p.watch(()=>this.spatialReference,l=>this._localOriginFactory=new V.GridLocalOriginFactory(l),p.syncAndInitial),p.on(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),p.watch(()=>H.trackHighlightOptions(this.view.highlights),()=>this._sortedDrapeSourceRenderersDirty=
!0,p.syncAndInitial)]);this._materials=new U.GLMaterialRepository(f,this._techniques,()=>{this.notifyChange("rendersOccludedDraped");this.events.emit("content-changed");this.notifyChange("updating");this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));const {_bindParameters:e,_camera:g}=this;e.slot=r.RenderSlot.DRAPED_MATERIAL;e.mainDepth=null;g.near=1;g.far=1E4;g.relativeElevation=null;e.camera=this._camera;e.oitPass=X.OITPass.NONE;e.updateLighting([new da.AmbientLight(P.ones())],
0,0,ba.Update.Immediate);this.addHandles(this.view.resourceController.scheduler.registerTask(K.TaskPriority.STAGE,this))}destroy(){this._renderers.forEach(a=>a.destroy());this._renderers.clear();this._passParameters.texture=E.disposeMaybe(this._passParameters.texture);this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this.view._stage.renderView.renderingContext}get _techniques(){return this.view._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(a){this._pluginContext=
a;this._techniques.precompile(J.OverlayCompositingTechnique)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||v.someMap(this._renderers,a=>a.updating)}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMaterialRenderer(a){for(const b of this._renderers.values()){const c=b.getMaterialRenderer(a);if(c)return c}return null}get layers(){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();
return this._sortedRenderers.map(a=>a.drapeSource.layer).filter(a=>!!a)}createGeometryDrapeSourceRenderer(a){return this.createDrapeSourceRenderer(a,Z.SortedRenderGeometryRenderer)}createDrapeSourceRenderer(a,b,c){const d=this._renderers.get(a);null!=d&&d.destroy();b=new b({...c,rendererContext:this,drapeSource:a});this._renderers.set(a,b);this._sortedDrapeSourceRenderersDirty=!0;"fullOpacity"in a&&this.addHandles(p.watch(()=>a.fullOpacity,()=>this.events.emit("content-changed")),a);return b}removeDrapeSourceRenderer(a){if(null!=
a){var b=this._renderers.get(a);null!=b&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(a),this.removeHandles(a),b.destroy())}}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(a){this._hasTargetWithoutRasterImage=this._overlays?z.someSet(a,b=>b.drapeTargetType===q.DrapeTargetType.WithoutRasterImage):!1}ensureDrapeSources(a){this._overlays?(this._hasDrapedFeatureSource=
z.someSet(a,b=>b.drapeSourceType===q.DrapeSourceType.Features),this._hasDrapedRasterSource=z.someSet(a,b=>b.drapeSourceType===q.DrapeSourceType.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(a,b,c=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new Q.OverlayRenderTargets(this.view._stage.renderer.fboCache),
this._overlays=[new G.Overlay,new G.Overlay]);this.ensureDrapeTargets(a);this.ensureDrapeSources(b);this._bindParameters.overlayStretch=c}disposeOverlays(){this._overlays=null;this._renderTargets=E.disposeMaybe(this._renderTargets);this.events.emit("textures-disposed")}getTexture(a){if(null!=a)return a===k.OverlayContent.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(k.OverlayContent.Color):this._renderTargets?.getTexture(a)}get running(){return this.updating}runTask(a){this._processDrapeSources(a,
()=>!0)}_processDrapeSources(a,b){let c=!1;for(const [d,f]of this._renderers){if(a.done)break;(d.destroyed||b(d))&&f.commitChanges()&&(c=!0,a.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,c=!0,this._updateSortedDrapeSourceRenderers());c&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=v.someMap(this._renderers,
d=>d.hasHighlights),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(K.noBudget,a=>a.updatePolicy===ca.UpdatePolicy.SYNC)}get isEmpty(){return A.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE?!1:!v.someMap(this._renderers,a=>!a.isEmpty)}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const a=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=y;++this._techniques.precompiling;const b=this._sortedRenderers.some(({renderer:c})=>
c.precompile(this._renderContext));--this._techniques.precompiling;this._renderContext.renderOccludedMask=a;return b}renders(a){if(A.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&a!==k.OverlayContent.Occluded&&a!==k.OverlayContent.Highlight)return!0;++this._techniques.precompiling;a=this._sortedRenderers.some(({renderer:b})=>b.precompile(this._renderContext));--this._techniques.precompiling;return a}get mode(){return this.isEmpty?w.OverlayMode.Disabled:this._renderTargets?.getTexture(k.OverlayContent.WaterNormal)?
w.OverlayMode.EnabledWithWater:this._renderTargets?.getTexture(k.OverlayContent.Color)?w.OverlayMode.Enabled:w.OverlayMode.Disabled}updateAnimation(a){let b=!1;this._renderers.forEach(c=>b=c.updateAnimation(a)||b);return b}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(a){if(this._renderTargets){this._bindParameters.alignPixelEnabled=a.alignPixelEnabled;this._bindParameters.highlightGroupName=null;++this._techniques.precompiling;for(const b of this._renderTargets.targets)if(b.content!==
k.OverlayContent.ColorNoRasterImage||this._needsColorWithoutRasterImage)a=b.output,this._renderContext.output=a,this._bindParameters.slot=a===t.ShaderOutput.Normal?r.RenderSlot.DRAPED_WATER:r.RenderSlot.DRAPED_MATERIAL,b.content===k.OverlayContent.Occluded&&(this._renderContext.renderOccludedMask=y),this._sortedRenderers.forAll(({drapeSource:c,renderer:d})=>{b.content===k.OverlayContent.ColorNoRasterImage&&c.drapeSourceType===q.DrapeSourceType.RasterImage||d.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=
x.defaultRenderOccludedMask;--this._techniques.precompiling}}drawOverlays(a){if(this._overlays&&this._renderTargets){for(var b of this._overlays)this.longitudeCyclical?b.setupGeometryViewsCyclical(this.longitudeCyclical):b.setupGeometryView();this._bindParameters.alignPixelEnabled=a.alignPixelEnabled;for(const c of this._renderTargets.targets){if(c.content===k.OverlayContent.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;b=this._drawTarget(u.OverlayIndex.INNER,c,a);const d=this._drawTarget(u.OverlayIndex.OUTER,
c,a);(b||d)&&c.fbo.generateMipMap()}}}_drawTarget(a,b,c){var d=this._overlays[a],f=d.canvasGeometries;if(0===f.numViews)return!1;({contentPixelRatio:c}=c);this._screenToWorldRatio=c*d.mapUnitsPerPixel/this._bindParameters.overlayStretch;var e=b.output;if(this.isEmpty||e===t.ShaderOutput.Normal&&!this.hasWater||!d.hasSomeSizedView())return!1;const {_rctx:g,_bindParameters:l}=this;this._camera.pixelRatio=d.pixelRatio*c;this._renderContext.output=e;l.screenToWorldRatio=this._screenToWorldRatio;l.screenToPCSRatio=
this._screenToWorldRatio*this.worldToPCSRatio;l.slot=e===t.ShaderOutput.Normal?r.RenderSlot.DRAPED_WATER:r.RenderSlot.DRAPED_MATERIAL;b.content===k.OverlayContent.Occluded&&(this._renderContext.renderOccludedMask=y);l.highlightGroupName=null;if(!this.renders(b.content))return this._renderContext.renderOccludedMask=x.defaultRenderOccludedMask,!1;({resolution:e}=d);c=a===u.OverlayIndex.INNER?0:e;g.setViewport(c,0,e,e);this._bindTargetFBO(b);a===u.OverlayIndex.INNER&&(g.setClearColor(0,0,0,0),g.clear(B.FramebufferBit.COLOR));
if(A.debugFlags.OVERLAY_DRAW_DEBUG_TEXTURE&&b.content!==k.OverlayContent.Occluded&&b.content!==k.OverlayContent.Highlight){this._techniques.precompile(I.TextureTechnique,C);e=this._techniques.acquire(I.TextureTechnique,C);for(let D=0;D<f.numViews;D++)this._setViewParameters(f.extents[D],d),this._ensureDebugPatternResources(d.resolution,ia[a]),g.bindTechnique(e,l,this._passParameters),g.screen.draw();e.release()}b.output===t.ShaderOutput.Highlight?({fboCache:d}=this.view._stage.renderer,f=this._resolution,
H.renderHighlightBuffer(g,d,{width:f,height:f},this.view.highlights,l,()=>this._renderAllGeometry(a,b),c,()=>this._bindTargetFBO(b))):this._renderAllGeometry(a,b);g.bindFramebuffer(null);this._renderContext.renderOccludedMask=x.defaultRenderOccludedMask;return!0}_renderAllGeometry(a,b){const c=this._overlays[a],d=c.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:f,renderer:e})=>{if(b.content!==k.OverlayContent.ColorNoRasterImage||f.drapeSourceType!==q.DrapeSourceType.RasterImage){var {fullOpacity:g}=
f;f=null!=g&&1>g&&b.output===t.ShaderOutput.Color&&this._bindTemporaryFBO();for(let l=0;l<d.numViews;l++)this._setViewParameters(d.extents[l],c),e.render(this._renderContext);f&&(this._bindTargetFBO(b),this._overlayParameters.texture=f.getTexture(),this._overlayParameters.opacity=g,this._overlayParameters.overlayIndex=a,e=this._techniques.acquire(J.OverlayCompositingTechnique),this._rctx.bindTechnique(e,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),e.release(),f.release())}})}_bindTargetFBO(a){const b=
this._resolution;a.fbo.bind(this._rctx,2*b,b)}_bindTemporaryFBO(){var a=this._resolution;const b=this.view._stage.renderer.fboCache;a=b.acquire(2*a,a,"overlay tmp");b.rctx.bindFramebuffer(a.fbo);b.rctx.clear(B.FramebufferBit.COLOR);return a}get _resolution(){return this._overlays?.[u.OverlayIndex.INNER].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(a,b,c,d){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let f=0;for(const {renderer:e}of this._sortedRenderers)f=
e.intersect?.(a,b,c,d,f)??f}_updateSortedDrapeSourceRenderers(){this._sortedRenderers.clear();if(0!==this._renderers.size){var a=this.view.map.allLayers,b=a.length;this._renderers.forEach((c,d)=>{const f=a.indexOf(d.layer),e=0<=f;this._sortedRenderers.push(new ja(d,c,b*(d.renderGroup??(e?q.DrapedRenderGroup.MapLayer:q.DrapedRenderGroup.ViewLayer))+(e?f:0)))});this._sortedRenderers.sort((c,d)=>c.index-d.index)}}_setViewParameters(a,b){const c=this._camera;c.viewport=[0,0,b.resolution,b.resolution];
F.ortho(c.projectionMatrix,0,a[2]-a[0],0,a[3]-a[1],c.near,c.far);F.fromTranslation(c.viewMatrix,[-a[0],-a[1],0])}_updateHasWater(){const a=v.someMap(this._renderers,b=>b.hasWater);a!==this._hasWater&&(this._hasWater=a,this.events.emit("has-water"))}_ensureDebugPatternResources(a,b){O.set(this._passParameters.color,b[0],b[1],b[2]);if(!this._passParameters.texture){b=new Uint8Array(a*a*4);var c=0;for(let d=0;d<a;d++)for(let f=0;f<a;f++){const e=Math.floor(f/10),g=Math.floor(d/10);2>e||2>g||10*e>a-20||
10*g>a-20?(b[c++]=255,b[c++]=255,b[c++]=255,b[c++]=255):(b[c++]=255,b[c++]=255,b[c++]=255,e&1&&g&1?b[c++]=f&1^d&1?0:255:b[c++]=e&1^g&1?0:128)}a=new ha.TextureDescriptor(a);a.samplingMode=B.TextureSamplingMode.NEAREST;this._passParameters.texture=new fa.Texture(this._rctx,a,b)}}get test(){}};m.__decorate([n.property()],h.OverlayRenderer.prototype,"hasHighlights",void 0);m.__decorate([n.property()],h.OverlayRenderer.prototype,"_sortedDrapeSourceRenderersDirty",void 0);m.__decorate([n.property({constructOnly:!0})],
h.OverlayRenderer.prototype,"view",void 0);m.__decorate([n.property({readOnly:!0})],h.OverlayRenderer.prototype,"_techniques",null);m.__decorate([n.property()],h.OverlayRenderer.prototype,"worldToPCSRatio",void 0);m.__decorate([n.property()],h.OverlayRenderer.prototype,"spatialReference",void 0);m.__decorate([n.property({type:Boolean,readOnly:!0})],h.OverlayRenderer.prototype,"updating",null);m.__decorate([n.property()],h.OverlayRenderer.prototype,"isEmpty",null);m.__decorate([n.property({readOnly:!0})],
h.OverlayRenderer.prototype,"rendersOccludedDraped",null);h.OverlayRenderer=m.__decorate([N.subclass("esri.views.3d.terrain.OverlayRenderer")],h.OverlayRenderer);class ja{constructor(a,b,c){this.drapeSource=a;this.renderer=b;this.index=c}}const ia=[[1,.5,.5],[.5,.5,1]],y=W.RenderOccludedFlag.OccludeAndTransparent,C=new aa.TextureTechniqueConfiguration;C.hasAlpha=!0;h.drapedZ=-2;h.overlayRenderOccludedFlag=y;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});