// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../Camera ../../../core/Cyclical ../../../core/Logger ../../../core/mathUtils ../../../core/promiseUtils ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../geometry/ellipsoidUtils ../../../geometry/Point ../../../geometry/projection ../../../geometry/SpatialReference ../../../geometry/projection/projectPointToVector ../../../geometry/projection/projectVectorToPoint ../../../geometry/projection/projectVectorToVector ../../ViewingMode ../camera/intersectionUtils ../../../chunks/cameraUtilsPlanar ../../../chunks/cameraUtilsSpherical ./earthUtils ./ElevationProvider ../../support/spatialReferenceSupport".split(" "),
function(k,E,N,ia,v,t,p,w,F,m,G,O,H,z,P,I,ja,ka,la,ma,Q,na){function x(a){return a.spatialReference??O.WGS84}function r({state:a}){return a.isGlobal?la.cameraUtilsSpherical:ka.cameraUtilsPlanar}function R(a,b){if(null==b)return null;var c=a.renderSpatialReference;const d=r(a).headingTiltToDirectionUp,e=w.create();if(!H.projectPointToVector(b.position,e,c))return null;c=d(e,b.heading,b.tilt);p.scale(c.direction,c.direction,a.state.camera.distance);p.add(c.direction,c.direction,e);a=ja.cameraOnContentAlongViewDirection(a,
e,c.direction,c.up);a.fov=v.deg2rad(b.fov);a.row=b.layout.row;a.rows=b.layout.rows;a.column=b.layout.column;a.columns=b.layout.columns;return a}function C(a,b){const {camera:c}=a.state;({unitInMeters:a}=a.renderCoordsHelper);const d=c.width/2/c.pixelRatio;b/=a;return d/(96*39.37/b)/Math.tan(c.fovX/2)}function S(a,b){const {camera:c}=a.state;({unitInMeters:a}=a.renderCoordsHelper);return oa/(c.width/2/c.pixelRatio/(b*Math.tan(c.fovX/2)))*a}function T(a,b,c,d){b=d.levelAtScale(b);a=D(a,c.eye,c.viewForward,
c.up).tilt;return d.scaleAtLevel(Math.max(b-2*((90<a?180-a:a)/90)**2,0))}function J(a,b,c){a=c.levelAtScale(a);return c.scaleAtLevel(a+2*((90<b?180-b:b)/90)**2)}function U(a,b,c){const d=a.basemapTerrain?.tilingScheme;if(!d)return 0;null==c&&(c=((c=a.pointsOfInterest?.cameraOnSurface?.renderLocation)&&a.renderCoordsHelper?.getAltitude(c))??0);var e=F.getReferenceEllipsoid(a.spatialReference).radius;e=a.state.viewingMode===I.ViewingMode.Local?b.eye[2]:p.length(b.eye)-e;c=S(a,Math.abs(e-c));return T(a,
c,b,d)}function V(a,b,c){return(b=R(a,b))?U(a,b,c):0}async function W(a,b,c,d,e,f){b=await K(a,d.heading,d.tilt,b,c,e,f);t.throwIfAborted(f);return X(a,b,d.fov,f)}function D(a,b,c,d,e){return r(a).directionToHeadingTilt(b,c,d,e)}function Y(a,b){return!!(a.basemapTerrain&&a.renderCoordsHelper.fromRenderCoords(b,A,a.spatialReference)&&a.elevationProvider&&(Q.getElevationAtPoint(a.elevationProvider,A)??0)>A[2]-1)}async function pa(a,b,c){if(Y(a,b))return!0;const {elevationProvider:d,spatialReference:e,
renderCoordsHelper:f}=a;if(null==d||!f.fromRenderCoords(b,A,e))return!1;const [h,g,l]=A;a=await d.queryElevation(h,g,l,e,"ground",c)??0;t.throwIfAborted(c);return a>l-1}async function qa(a,b,c){const d=w.create();if(null==b)return p.copy(d,a.state.camera.center);if(b instanceof m){const {renderSpatialReference:e,basemapTerrain:f,elevationProvider:h}=a,g=b.spatialReference;await H.projectPointToVectorAsync(b,d,e,0,{signal:c});t.throwIfAborted(c);null==b.z&&null!=f&&null!=h&&(b=await h.queryElevation(b.x,
b.y,b.z??0,g,"ground",c),t.throwIfAborted(c),null!=b&&a.renderCoordsHelper.setAltitude(d,b));return d}return p.copy(d,b)}function ra(a,b){const c=w.create();if(null==b)return p.copy(c,a.state.camera.center);if(b instanceof m){if(!H.projectPointToVector(b,c,a.renderSpatialReference))return null;const {basemapTerrain:d,elevationProvider:e}=a;null==b.z&&null!=d&&null!=e&&(b=Q.getElevationAtPoint(e,b),null!=b&&a.renderCoordsHelper.setAltitude(c,b));return c}return p.copy(c,b)}function B(a,b,c,d,e,f){const h=
d instanceof m?d:null;d=ra(a,d);return Z(a,b,c,h,d,e,f)}async function K(a,b,c,d,e,f,h){const g=d instanceof m?d:null;d=await qa(a,d,h);t.throwIfAborted(h);return aa(a,b,c,g,d,e,f,h)}function Z(a,b,c,d,e,f,h){if(null==e||!d&&(d=new m({spatialReference:x(a)}),!z.projectVectorToPoint(e,a.renderSpatialReference,d)))return null;const g=ba(a,b,c,e,f,h);if(ca(a,c,h)&&Y(a,g.eye)){const {tilt:l,mode:u}=da(a,c,e,f);return Z(a,b,l,d,e,f,u)}return{...g,center:w.clone(e)}}async function aa(a,b,c,d,e,f,h,g){d||
(d=new m({spatialReference:x(a)}),await z.projectVectorToPointAsync(e,a.renderSpatialReference,d,{signal:g})||(d=null));t.throwIfAborted(g);const l=ba(a,b,c,e,f,h);if(ca(a,c,h)&&await pa(a,l.eye,g)){t.throwIfAborted(g);const {tilt:u,mode:n}=da(a,c,e,f);return aa(a,b,u,d,e,f,n,g)}return{...l,center:w.clone(e)}}function ba(a,b,c,d,e,f){e=Math.max(e,a.state.constraints.minimumPoiDistance);var h=c;c=e;let g=0;if(f=f===k.OrientationMode.ADJUST)f=a.pointsOfInterest.centerOnSurfaceFrequent.distance,f=8<
Math.log(c/f)/Math.LN2?!0:5<p.distance(d,a.pointsOfInterest.centerOnSurfaceFrequent.renderLocation)/(Math.tan(.5*a.state.camera.fov)*f);f?(b=0,h=r(a).eyeTiltToLookAtTilt(h,d,c),a.state.constraints.tilt?(f=a.state.constraints.tilt(c),f.max=Math.min(f.max,.5*Math.PI),g=Math.min(h,f.min*(1-.7)+.7*f.max)):g=h):g=r(a).eyeTiltToLookAtTilt(h,d,c);h=g=a.state.constraints.clampTilt(c,g);c=h=r(a).lookAtTiltToEyeTilt(h,d,c);a=r(a).eyeForCenterWithHeadingTilt;return a(d,e,b,c)}function ca(a,b,c){const d=a.map.ground.navigationConstraint;
return c===k.OrientationMode.ADJUST&&a.state.isGlobal&&0<b&&(null==d||"stay-above"===d.type)}function da(a,b,c,d){{let f=r(a).eyeTiltToLookAtTilt(b,c,d);if(a.state.constraints.tilt){var e=a.state.constraints.tilt(d);f=Math.min(f,.5*Math.PI);e=e.min*(1-.7)+.7*f}else e=f}a=r(a).lookAtTiltToEyeTilt(e,c,d);return{tilt:a,mode:1>b-a?k.OrientationMode.LOCKED:k.OrientationMode.ADJUST}}function ea(a,b){const {state:c,spatialReference:d}=a;a=b.spatialReference;return c.isGlobal&&na.isSpatialReferenceSupported(a,
I.ViewingMode.Global)||c.isLocal&&d.equals(a)}function fa(a,b){let c;if(a.state.isGlobal){const f=new m(b.xmin,b.ymin,b.spatialReference),h=new m(b.xmax,b.ymax,b.spatialReference),g=b.spatialReference.isGeographic?sa:ta;var d=new m({x:g.center(f.x,h.x),y:(h.y+f.y)/2,z:null!=b.zmax&&null!=b.zmin?(b.zmax+b.zmin)/2:void 0,spatialReference:b.spatialReference});const l=F.getReferenceEllipsoid(b.spatialReference);var e=ma.getGreatCircleSpanAt(d,f,h);c=e.lon;e=e.lat;g.diff(f.x,h.x)>g.range/2&&(c+=l.halfCircumference);
c=Math.min(c,l.halfCircumference);e=Math.min(e,l.halfCircumference)}else d=a.renderSpatialReference??b.spatialReference,d.equals(b.spatialReference)||(b=G.project(b,d)),c=b.xmax-b.xmin,e=b.ymax-b.ymin,d=new m({x:b.xmin+.5*c,y:b.ymin+.5*e,z:null!=b.zmax&&null!=b.zmin?(b.zmax+b.zmin)/2:void 0,spatialReference:d});a=a.state.camera;return{center:d,distance:Math.max(1/Math.tan(a.fovX/2)*c*.5,1/Math.tan(a.fovY/2)*e*.5,1/Math.tan(a.fov/2)*(null!=b.zmax&&null!=b.zmin?b.zmax-b.zmin:0)*.5)/1}}function L(a,
b,c,d){if(null==b)return null;const e=a.renderSpatialReference;a=new m({spatialReference:x(a)});if(!z.projectVectorToPoint(b.eye,e,a))return null;d??=new E;d.position=a;d.heading=b.heading;d.tilt=b.tilt;d.fov=c;return d}async function X(a,b,c,d){const e=a.renderSpatialReference;a=new m({spatialReference:x(a)});await z.projectVectorToPointAsync(b.eye,e,a,{signal:d});t.throwIfAborted(d);return new E(a,b.heading,b.tilt,c)}const M=()=>ia.getLogger("esri.views.3d.support.cameraUtils"),oa=96*39.37,ua={heading:0,
tilt:0},A=w.create(),ta=new N.Cyclical(-2.0037508342788905E7,2.0037508342788905E7),sa=new N.Cyclical(-180,180);k.OrientationMode=void 0;(function(a){a[a.LOCKED=0]="LOCKED";a[a.ADJUST=1]="ADJUST"})(k.OrientationMode||(k.OrientationMode={}));const y=w.create();k.applyTiltAdjustToScale=T;k.directionToHeadingTilt=D;k.distanceToScale=S;k.externalCameraToScale=V;k.externalToInternal=R;k.fromCenterDistanceAsync=W;k.fromCenterDistanceSync=function(a,b,c,d,e,f){b=B(a,d.heading,d.tilt,b,c,e);return L(a,b,d.fov,
f)};k.fromCenterScale=async function(a,b,c,d,e,f){c=C(a,c);return W(a,b,c,d,e,f)};k.fromExtentAsync=async function(a,b,c,d,e,f){b=ea(a,b)?b:await G.projectWithZConversion(b,a.spatialReference,{signal:f});t.throwIfAborted(f);const {center:h,distance:g}=fa(a,b);c=await K(a,c,d,h,g,e,f);t.throwIfAborted(f);return X(a,c,a.camera.fov,f)};k.fromExtentSync=function(a,b,c,d,e,f){let h;try{h=ea(a,b)?b:G.project(b,a.spatialReference)}catch(u){return null}const {center:g,distance:l}=fa(a,h);b=B(a,c,d,g,l,e);
return null==b?null:L(a,b,a.camera.fov,f)};k.getObserverForPointAtDistanceAsync=K;k.getObserverForPointAtDistanceSync=B;k.getViewSR=x;k.headingTiltToDirectionUp=function(a,b,c,d,e){return r(a).headingTiltToDirectionUp(b,c,d,e)};k.internalCameraToScale=U;k.internalToExternal=function(a,b,c){const d=a.renderSpatialReference,e=D(a,b.eye,b.viewForward,b.up,ua);a=x(a);P.projectVectorToVector(b.eye,d,y,a)||(a=O.WGS84,P.projectVectorToVector(b.eye,d,y,a));null==c?c=new E(new m(y,a),e.heading,e.tilt,v.rad2deg(b.fov)):
(c.position.x=y[0],c.position.y=y[1],c.position.z=y[2],c.position.spatialReference=a,c.heading=e.heading,c.tilt=e.tilt,c.fov=v.rad2deg(b.fov));c.layout.row=b.row;c.layout.rows=b.rows;c.layout.column=b.column;c.layout.columns=b.columns;return c};k.removeTiltAdjustFromScale=J;k.scaleErrorThreshold=1;k.scaleToDistance=C;k.scaleToTargetDistance=function(a,b,c,d,e){if(0===b)return 0;var f=p.distance(c.eye,d);const h=a.basemapTerrain?.tilingScheme;if(!h)return M().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),
f;var g=f;const l=D(a,c.eye,c.viewForward,c.up),u=90<l.tilt;if(a.state.viewingMode===I.ViewingMode.Local)b=J(b,l.tilt,h),a=(C(a,b)-Math.abs(c.eye[2]-e[2]))/Math.cos(v.deg2rad(l.tilt)),g=u?g-a:g+a;else{var n=Infinity;let ha=0;f=B(a,l.heading,l.tilt,d,f,k.OrientationMode.ADJUST);if(!f)return g;for(e=p.length(e);1<n&&100>ha;){n=p.length(f.eye);var q=v.deg2rad(u?180-f.tilt:f.tilt);g=Math.sin(q)*n;n*=Math.cos(q);q=J(b,f.tilt,h);q=C(a,q);q=u?e-q:e+q;g=v.asinClamped(g/q);g=Math.cos(g)*q-n;f=p.distance(f.eye,
d);g=u?f-g:f+g;f=B(a,l.heading,l.tilt,d,g,k.OrientationMode.ADJUST);n=L(a,f,v.rad2deg(c.fov));if(!f||!n)break;q=F.getReferenceEllipsoid(a.spatialReference).radius;n=V(a,n,e-q);n=Math.abs(b-n);++ha}}return g};k.scaleToZoom=function(a,b){if(a=a.basemapTerrain?.tilingScheme)return a.levelAtScale(b);M().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")};k.toArea=function(a,b){return r(a).toArea(a,b)};k.toExtent=function(a,b,c){var d=a.renderSpatialReference;const e=new m({spatialReference:x(a)});
if(!z.projectVectorToPoint(c,d,e))return null;const f=Math.tan(b.fovX/2);d=Math.tan(b.fovY/2);b=p.dist(b.eye,c);c=2*b*f;d*=2*b;return r(a).toExtent(a,e,c,d)};k.zoomToScale=function(a,b){if(a=a.basemapTerrain?.tilingScheme)return a.scaleAtLevel(b);M().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")};Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});