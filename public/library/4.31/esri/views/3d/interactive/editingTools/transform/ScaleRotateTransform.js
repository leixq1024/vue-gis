// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/colorUtils ../../../../../core/Cyclical ../../../../../core/Evented ../../../../../core/has ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/mat4 ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../../geometry/support/plane ../../../../../geometry/support/ray ../../../../../geometry/support/vectorStacks ../../Manipulator3D ../../manipulatorUtils ../../RenderObject ../dragEventPipeline3D ../ManipulatorType ../manipulations/config ../../../webgl-engine/lib/basicInterfaces ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Material ../../../webgl-engine/materials/ColorMaterial ../../../../interactive/dragEventPipeline ../../../../interactive/interfaces".split(" "),
function(w,B,V,W,X,Y,qa,I,Z,G,aa,ba,E,ra,sa,ca,F,da,u,J,K,L,p,ea,fa,x,ha,ia,c,ja,O,ka,la,ma,A){function na(a,b){var e=u.subtract(p.sv3d.get(),b.renderStart,a.origin);a=u.subtract(p.sv3d.get(),b.renderEnd,a.origin);e=u.length(e);a=u.length(a);return 0===e?0:a/e}function oa(a,b,e,d){const {renderStart:l,renderEnd:v}=a;var m=M(l,d,p.sv3d.get());a=M(v,d,p.sv3d.get());if(u.squaredDistance(m,a)<c.dragThresholdPx*c.dragThresholdPx)return null;const k=u.subtract(p.sv3d.get(),l,e);b=u.cross(p.sv3d.get(),k,
K.getNormal(b));b=u.add(p.sv3d.get(),l,b);e=M(e,d,p.sv3d.get());d=M(b,d,p.sv3d.get());b=u.subtract(p.sv3d.get(),d,m);d=u.subtract(p.sv3d.get(),m,e);m=L.wrap(m,b);d=L.wrap(e,d);return L.distance2(m,a)<L.distance2(d,a)?"rotate":"scale"}function M(a,b,e){b.projectToScreen(a,P);return u.set(e,P[0],P[1],0)}function R(a,b){let e=null,d=1;const l=()=>d;return{start:()=>{d=a.getScale();e=a.getScale;a.getScale=l;b()},update:v=>{d+=((d+1)/2-d)*Math.min(v*c.ringResetAnimationSpeedFactor,1);b();return.01>Math.abs(d-
1)?H.STOP:H.CONTINUE},destroy:()=>{e&&(a.getScale=e);b()}}}function pa(a,b,e){let d=0,l=null;const v=()=>!1;return{start:()=>{l=a.getFocused;a.getFocused=v;d=0;b()},update:m=>{d+=m;return!l?.()||d>=e.delayMs?H.STOP:H.CONTINUE},destroy:()=>{l&&(a.getFocused=l);b()}}}var f;(function(a){a.ScaleIn=A.ManipulatorStateCustomFlags.Custom2;a.ScaleOut=A.ManipulatorStateCustomFlags.Custom3;a.RotateLeft=A.ManipulatorStateCustomFlags.Custom4;a.RotateRight=A.ManipulatorStateCustomFlags.Custom5;a.Unlocked=A.ManipulatorStateCustomFlags.Custom7;
a.DelayedFocused=A.ManipulatorStateCustomFlags.Custom8;a.TouchInput=A.ManipulatorStateCustomFlags.Custom12})(f||={});w.ScaleRotateTransform=class extends V{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(a){this._ringManipulator.location=a}set elevationAlignedLocation(a){this._ringManipulator.elevationAlignedLocation=a}get grabbing(){return this._ringManipulator.grabbing}set interactive(a){this._ringManipulator.interactive=a}get updating(){return!!this._activeAnimation}constructor(a){super(a);
this._activeAnimation=this._scaleRotateDragData=this.mode=null;this._ringIndicatorDelayMs=c.ringIndicatorDelayMs;this.events=new Y;this.getFocused=()=>this._ringManipulator.focused;this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this.adapter.scale:1}initialize(){this._createManipulator();this._updateDragState();this._updateManipulatorTransform();this.addHandles([G.watch(()=>{const {adapter:a}=this;return[a.angle,a.scale]},()=>this._updateManipulatorTransform())])}destroy(){this._activeAnimation?.frameTask.remove();
this._activeAnimation=null;this.tool.manipulators.remove(this._ringManipulator);this._ringManipulator=null}startAnimation(a){this.cancelActiveAnimation();a.start();const b=aa.addFrameTask({update:({deltaTime:e})=>{a.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...a,frameTask:b}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove();this._activeAnimation=Z.destroyMaybe(this._activeAnimation)}forEachManipulator(a){a(this._ringManipulator,ia.ManipulatorType.SCALE_ROTATE)}_createManipulator(){const a=
this._createRingManipulator();this._ringManipulator=a;this.tool.manipulators.add(a);const b=this.tool.object,e=ma.createManipulatorDragEventPipeline(a,(d,l,v)=>{this._scaleRotateDragData=null;const m=this.adapter.startInteraction(),k={mode:"none",origin:J.clone(d.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=k;this._updateDragState();const z=p.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(d.renderLocation,z);l.next(ha.screenToRenderPlane(this.tool.view,
K.fromPositionAndNormal(d.renderLocation,z,K.create()))).next(g=>{var h=K.getNormal(g.plane);h=fa.calculateInputRotationTransform(g.renderStart,g.renderEnd,k.origin,h);var n=X.cyclicalPI.shortestSignedDiff(k.angle,h);k.angleDir=I.clamp(k.angleDir+n,-c.rotateIndicatorDirectionBuffer,c.rotateIndicatorDirectionBuffer);k.angle=h;n=na(k,g);k.scaleDir=I.clamp(k.scaleDir+(n-this.adapter.scale),-c.scaleIndicatorDirectionBuffer,c.scaleIndicatorDirectionBuffer);this._onScaleChanged();if("none"===k.mode){const r=
this.mode||oa(g,g.plane,k.origin,this.tool.view.state.camera);if(null!=r){switch(r){case "rotate":this.tool.events.emit("rotate-start",{object:b,angle:0});this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]});break;case "scale":this.tool.events.emit("scale-start",{object:b,xScale:1,yScale:1}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]})}k.mode=r}}switch(k.mode){case "rotate":m.state.angle=k.initialAngle+h;break;case "scale":m.state.scale=
n,this._onScaleChanged()}this._updateDragState();this._updateManipulatorTransform();switch(g.action){case "start":case "update":switch(k.mode){case "rotate":this.tool.events.emit("rotate",{object:b,angle:I.rad2deg(k.angle)});break;case "scale":this.tool.events.emit("scale",{object:b,xScale:n,yScale:n})}break;case "end":switch(k.mode){case "rotate":this.tool.events.emit("rotate-stop",{object:b,angle:I.rad2deg(k.angle)});break;case "scale":this.tool.events.emit("scale-stop",{object:b,xScale:n,yScale:n})}}"end"===
g.action&&(this.startAnimation(R(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),m.done());return g});v.next(()=>{m.cancel();if(null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case "rotate":this.tool.events.emit("rotate-stop",{object:b,angle:0});break;case "scale":this.tool.events.emit("scale-stop",{object:b,xScale:1,yScale:1})}this.startAnimation(R(this,()=>this._onScaleChanged()));this._scaleRotateDragData=null;this._updateDragState()}})});
this.addHandles([e,a.events.on("focus-changed",d=>{"focus"===d.action?this.startAnimation(pa(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),a.events.on("immediate-click",d=>{d.stopPropagation()}),G.watch(()=>this.tool.object.visible,d=>this._ringManipulator.available=d,G.initial)])}_onScaleChanged(){this.events.emit("scale-changed");this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(f.DelayedFocused,
this.getFocused())}_updateDragState(){this._ringManipulator.updateStateEnabled(f.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode));if(null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case "rotate":this._ringManipulator.updateStateEnabled(f.ScaleIn|f.ScaleOut,!1);this._ringManipulator.updateStateEnabled(f.RotateLeft,0>this._scaleRotateDragData.angleDir);this._ringManipulator.updateStateEnabled(f.RotateRight,0<=this._scaleRotateDragData.angleDir);
break;case "scale":this._ringManipulator.updateStateEnabled(f.RotateLeft|f.RotateRight,!1),this._ringManipulator.updateStateEnabled(f.ScaleIn,0>this._scaleRotateDragData.scaleDir),this._ringManipulator.updateStateEnabled(f.ScaleOut,0<=this._scaleRotateDragData.scaleDir)}else this._ringManipulator.updateStateEnabled(f.ScaleIn|f.ScaleOut|f.RotateLeft|f.RotateRight,!1)}_updateManipulatorTransform(){const a=F.fromRotation(p.sm4d.get(),this.adapter.angle,J.fromValues(0,0,1));if(null!=a){var b=this.getScale();
b=F.fromScaling(p.sm4d.get(),u.set(p.sv3d.get(),b,b,b));this._ringManipulator.modelTransform=F.multiply(p.sm4d.get(),b,a)}}_createRingManipulator(){var a=(t,C,N)=>{const S=[],T=Math.ceil(c.geometrySegments*(C-t)/(2*Math.PI));for(let Q=0;Q<T+1;Q++){const U=t+Q*(C-t)/T;S.push(J.fromValues(N*Math.cos(U),N*Math.sin(U),0))}return S};const b=this._createMaterial(1);var e=(t,C,N=b)=>O.createPathExtrusionGeometry(N,[[-C/2,0],[C/2,0],[C/2,c.ringHeight/2],[-C/2,c.ringHeight/2]],t,[],[],!1),d=a(0,2*Math.PI,
c.ringRadius),l=e(d,c.ringThickness),v=[],m=[];const k=[];for(var z=0;2>z;z++){var g=z*Math.PI-Math.PI/4,h=Math.PI/2-c.rotateIndicatorArcLength,n=g+h;g=g+Math.PI/2-h;h=a(n,g,c.innerIndicatorRadius);var r=e(h,c.indicatorThickness);k.push(h);k.push(a(n,g,c.outerIndicatorRadius-c.ringThickness/2));v.push(r);m.push(r.instantiate());for(r=0;2>r;r++){var D=0===r,q=da.create();if(D){F.scale(q,q,[1,-1,1]);F.rotate(q,q,-n,[0,0,1]);var y=Math.round(c.rotateIndicatorArrowPlacementPercentage*(h.length-1));q[12]=
h[y][0];q[13]=h[y][1];q[14]=h[y][2]}else F.rotate(q,q,g,[0,0,1]),y=Math.round((1-c.rotateIndicatorArrowPlacementPercentage)*(h.length-1)),q[12]=h[y][0],q[13]=h[y][1],q[14]=h[y][2];y=O.createExtrudedTriangle(b,c.rotateIndicatorArrowTipLength,0,c.rotateIndicatorArrowTipRadius,c.ringHeight);O.transformInPlace(y,q);(D?v:m).push(y)}}z=[];for(n=0;2>n;n++)g=n*Math.PI-Math.PI/4,h=Math.PI/2-c.scaleIndicatorArcLength,g=a(g+h,g+Math.PI/2-h,c.outerIndicatorRadius),z.push(e(g,c.indicatorThickness));D=this._createMaterial(.66);
n=this._createMaterial(.5);h=this._createMaterial(.33);g=a(0,2*Math.PI,c.ringRadius+c.scaleIndicatorOffset1);r=a(0,2*Math.PI,c.ringRadius+c.scaleIndicatorOffset2);g=e(g,c.indicatorThickness,D);r=e(r,c.indicatorThickness,h);q=a(0,2*Math.PI,c.ringRadius-c.scaleIndicatorOffset1);a=a(0,2*Math.PI,c.ringRadius-c.scaleIndicatorOffset2);D=e(q,c.indicatorThickness,D);e=e(a,c.indicatorThickness,h);l=[new x.RenderObject(l,f.DelayedFocused),new x.RenderObject(l.instantiate({material:n}),A.ManipulatorStateFlags.None)];
this.mode&&"scale"!==this.mode||(l=l.concat([...z.map(t=>new x.RenderObject(t,f.DelayedFocused|f.Unlocked)),new x.RenderObject(g,f.DelayedFocused|f.ScaleIn),new x.RenderObject(r,f.DelayedFocused|f.ScaleIn),new x.RenderObject(D,f.DelayedFocused|f.ScaleOut),new x.RenderObject(e,f.DelayedFocused|f.ScaleOut)]));this.mode&&"rotate"!==this.mode||(l=l.concat([...m.map(t=>new x.RenderObject(t.instantiate(),f.DelayedFocused|f.Unlocked)),...v.map(t=>new x.RenderObject(t,f.DelayedFocused|f.RotateLeft)),...m.map(t=>
new x.RenderObject(t,f.DelayedFocused|f.RotateRight))]));d=[d,...k];return new ea.Manipulator3D({view:this.tool.view,renderObjects:l,autoScaleRenderObjects:!1,worldOriented:!0,radius:c.ringThickness,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:this.tool.object.elevationInfo,collisionType:{type:"ribbon",paths:d,direction:J.fromValues(0,0,1)}})}_createMaterial(a){const b=new la.ColorMaterial({cullFace:ja.CullFaceOptions.Back,renderOccluded:ka.RenderOccludedFlag.Transparent,isDecoration:!0});
this.addHandles(G.watch(()=>W.multiplyOpacityToUnitRGBA(this.tool.view.effectiveTheme.accentColor,a),e=>b.setParameters({color:e}),G.initial));return b}get test(){}};B.__decorate([E.property({constructOnly:!0})],w.ScaleRotateTransform.prototype,"tool",void 0);B.__decorate([E.property({constructOnly:!0})],w.ScaleRotateTransform.prototype,"adapter",void 0);B.__decorate([E.property({constructOnly:!0})],w.ScaleRotateTransform.prototype,"sketchOptions",void 0);B.__decorate([E.property()],w.ScaleRotateTransform.prototype,
"mode",void 0);B.__decorate([E.property()],w.ScaleRotateTransform.prototype,"_activeAnimation",void 0);B.__decorate([E.property()],w.ScaleRotateTransform.prototype,"updating",null);w.ScaleRotateTransform=B.__decorate([ca.subclass("esri.views.3d.interactive.editingTools.transform.ScaleRotateTransform")],w.ScaleRotateTransform);var H;(function(a){a[a.CONTINUE=0]="CONTINUE";a[a.STOP=1]="STOP"})(H||={});const P=ba.createScreenPointArray();Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});