// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../core/libs/gl-matrix-2/math/vec2 ../../../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../../../chunks/vec32 ../../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../../../chunks/boundedPlane ../../../../../../geometry/support/plane ../../../../../../geometry/support/vectorStacks ../../../../analysis/Slice/ResizeManipulator ../../../../analysis/Slice/sliceToolUtils ../../dragEventPipeline3D ../../ManipulatorType ./extentUtils ../../../../support/geometryUtils/ray ../../../../../interactive/dragEventPipeline ../../../../../interactive/editGeometry/interfaces ../../../../../interactive/editGeometry/operations/UpdateVertices ../../../../../interactive/tooltip/infos/ExtentScaleTooltipInfo".split(" "),
function(u,x,z,g,A,v,B,p,C,q,D,E,F,G,H,y,I,J){class K{get _object(){return this._tool.object}get _operations(){return this._object.operations}get zMax(){if(!this._zMaxDirty||!this._operations)return this._zMax;var a=this._operations.data;if(a.geometry.hasZ){const c=a.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const b of a.components)for(const d of b.vertices)a=c.getZ(d.pos)??0,this._zMax=Math.max(a,this._zMax)}else this._zMax=0;this._zMaxDirty=!1;return this._zMax}constructor(a,c,b){this._tool=
a;this._bounds=c;this._preserveAspectRatioStep=b;this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}];this._displayBoundsStart=v.create();this._zMax=this._displayBoundsMarginStart=0;this._zMaxDirty=!0;const d=this._tool,n=d.view;this.resizeManipulators=this._resizeHandles.map(k=>{const e=new C.ResizeManipulator(n,k);d.addHandles([e.events.on("grab-changed",f=>this._onResizeGrab(f)),
this._createResizeDragPipeline(e,k)]);return e});d.manipulators.addMany(this.resizeManipulators);this._operations&&d.addHandles(this._operations.data.on("change",()=>{"resize"!==d.inputState?.type&&(this._zMaxDirty=!0)}))}destroy(){this.forEachManipulator(a=>{this._tool.manipulators.remove(a);a.destroy()})}forEachManipulator(a){this.resizeManipulators.forEach(c=>a(c,E.ManipulatorType.SCALE))}updateManipulators(a,c){this.resizeManipulators.forEach((b,d)=>{q.updateResizeHandle(b,this._resizeHandles[d],
a,c)})}getUpdatedTooltipInfo(){if(!this.resizeManipulators.some(b=>b.focused))return null;const a=this._tooltipInfo??(this._tooltipInfo=new J.ExtentScaleTooltipInfo({sketchOptions:this._tool.sketchOptions})),c=F.mapPlaneAutoSize2D(this._bounds.mapBounds,this.zMax,this._bounds.spatialReference);c&&(a.xSize=c.xSize,a.ySize=c.ySize);this.resizeManipulators.some(b=>b.dragging)||(a.xScale=1,a.yScale=1);return a}_onResizeGrab({action:a,screenPoint:c}){const b=this._tool,d=this._bounds;"start"===a&&c&&(a=
G.fromScreenNormalized(b.view.state.camera,c),B.intersectRay(d.displayBounds.plane,a,p.sv3d.get())&&(d.backupMapBounds(),v.copy(d.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=d.displayBoundsMargin,b.inputState={type:"resize"}))}_createResizeDragPipeline(a,c){const {_tool:b,_object:d}=this;return H.createManipulatorDragEventPipeline(a,(n,k,e)=>{null!=b.inputState&&(k.next(f=>{"start"===f.action&&b.events.emit("scale-start",{object:d,xScale:1,yScale:1});return f}).next(D.screenToRenderPlane(b.view,
this._displayBoundsStart.plane)).next(f=>({...f,handle:c})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._resizeDragUpdateGeometry()).next(f=>{var h=this._tooltipInfo;h&&(h.xScale=f.factor1,h.yScale=f.factor2);h={object:d,xScale:f.factor1,yScale:f.factor2};switch(f.action){case "start":case "update":b.events.emit("scale",h);break;case "end":b.inputState=null,b.events.emit("scale-stop",h)}return f}),e.next(()=>{null!=b.inputState&&b.events.emit("scale-stop",
{object:d,xScale:1,yScale:1});b.cancel()}))})}_resizeDragRenderPlaneToFactors(){const a=this._bounds;return c=>{const b=this._displayBoundsStart,d=c.handle.direction,n=a.displayBoundsMargin,k=this._displayBoundsMarginStart;var e=g.copy(p.sv3d.get(),b.origin);g.scaleAndAdd(e,e,b.basis1,-d[0]);g.scaleAndAdd(e,e,b.basis2,-d[1]);const f=g.subtract(p.sv3d.get(),c.renderEnd,e),h=g.subtract(p.sv3d.get(),c.renderStart,e),L=q.isDiagonalResizeHandle(c.handle);e=q.calculateDiagonalResizeHandleScale(b);const M=
q.calculateDiagonalResizeHandleScale(a.displayBounds)/e;e=(l,w)=>{if(0===l)return 1;let m=g.length(w),r=.5*l*g.dot(w,f)/m;const t=0>r?-1:1;L&&(l=m-.5*l*g.dot(w,h)/m,r+=l*t*M);l=m<1.5*k?1:1E-6;m=Math.max(m-k,1E-6);0<t&&(r-=n);return t*Math.max(r/m*t,l)};return{...c,factor1:e(d[0],b.basis1),factor2:e(d[1],b.basis2)}}}_resizeDragUpdateGeometry(){const a=this._bounds;return c=>{var b=g.copy(A.create(),a.mapBoundsStart.origin);g.scaleAndAdd(b,b,a.mapBoundsStart.basis1,-c.handle.direction[0]);g.scaleAndAdd(b,
b,a.mapBoundsStart.basis2,-c.handle.direction[1]);const d=x.set(z.create(),a.mapBoundsStart.basis1[0],a.mapBoundsStart.basis1[1]);x.normalize(d,d);const n="start"===c.action?y.AccumulationBehavior.NEW_STEP:y.AccumulationBehavior.ACCUMULATE_STEPS;this._operations&&(b=this._operations.scale(b,d,c.factor1,c.factor2,n,I.AccumulationType.REPLACE),v.copy(a.mapBoundsStart,a.mapBounds),a.updateMapBoundsFromOperation(b));return c}}}u.ExtentScale=K;u.scaleEpsilon=1E-6;Object.defineProperty(u,Symbol.toStringTag,
{value:"Module"})});