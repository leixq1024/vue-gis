// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ./tslib.es6 ./Geometry ./SimpleGeometryCursor ./QuadraticBezier ./Transformation2D ./GeometryCleaner-k94LXQsr ./OperatorGeneralize".split(" "),function(O,L,t,H,k,p,P,Q){function E(a,b,c,e,f,d){return{m_from:a.clone(),m_to:b.clone(),m_center:c.clone(),m_next:f,m_type:e}}function I(a,b,c,e,f){return{m_from:a.clone(),m_to:b.clone(),m_next:c,m_type:4,m_center:new p.Point2D}}function J(a){k.setWeakSimple(a,0);return a}function M(a,b){return a.isEmpty()?!0:Math.min(a.width(),a.height())>
b}function R(a,b,c,e,f,d,g,h){var l=a.getXY(c),n=a.getXY(e);if(l.equals(n))return-1;var m=.25*g,q=.25*g;g=new p.Point2D;g.setSub(n,l);var w=g.length();w=w*w*.25;var x=d*d-w;if(x<=w)return-1;var r=Math.sqrt(x);g.normalize();x=g.clone();x.rightPerpendicularThis();var u=w/r;g=u<=q;var v=p.Point2D.lerp(n,l,.5);w=x.clone();w.scaleAddThis(Math.max(0,u-m),v);x.negate().scaleAddThis(r,v);r=3.61*p.sqr(d-q);u=w.sub(l);v=w.sub(n);q=!1;d=0;m=p.makePrimitiveArray(64,0);t.geometryReleaseAssert(h===m.length);for(h=
a.getPrevVertexEx(e,f);h!==c;){if(1===a.getUserIndex(h,b))return-1;if(a.getXY(h).equals(n)){var y=a.getPrevVertexEx(h,f);a.removeVertex(h,!1);h=y}else break}h=new p.Point2D;y=l.clone();m[d++]=1;for(let z=a.getNextVertexEx(c,f);z!==e;){if(1===a.getUserIndex(z,b))return-1;var B=a.getXY(z);if(B.equals(y))B=a.getNextVertexEx(z,f),a.removeVertex(z,!1),z=B;else{m[d++]=0;var D=new p.Point2D;D.setSub(B,l);if(0>D.dotProduct(x))return 0;if(p.Point2D.sqrDistance(B,l)>r||p.Point2D.sqrDistance(B,n)>r)q=!0;D=0;
0<=B.sub(l).crossProduct(u)&&(D=1);0>=B.sub(n).crossProduct(v)&&(D|=2);if(0===D)return 0;m[d-1]=D;h.assign(y);y.assign(B);z=a.getNextVertexEx(z,f)}}if(1===d)return 0;t.geometryReleaseAssert(d<m.length);m[d++]=2;b=!0;for(let z=1,C=0;z<d;z++)if(m[z]!==m[z-1]&&(C++,b=3>C&&(1===C&&3===m[z]||2===C&&2===m[z]),!b))return 0;if(2<d&&b&&(3===d||!q)){l=0;c=a.getNextVertexEx(c,f);g||(a.setXY(c,w),c=a.getNextVertexEx(c,f));for(;c!==e;)g=a.getNextVertexEx(c,f),a.removeVertex(c,!1),c=g,++l;return l}t.geometryReleaseAssert(3!==
d);if(q&&3<d)return 0;b=l.clone();l=l.clone();n=1;x=-1;h=c;q=0;for(d=1;h!==e;)if(h=a.getNextVertexEx(h,f),r=m[d++],0===r){if(h===e)break}else{u=a.getXY(h);if(-1!==x){if(0!==(x&n&r&3)){a.removeVertex(c,!0);q++;c=h;l.setCoordsPoint2D(u);n=r;continue}if(3===n&&0!==x&&0!==r)if(l.setCoordsPoint2D(w),g||l.equals(b)){a.removeVertex(c,!0);q++;c=h;l.setCoordsPoint2D(u);n=r;continue}else a.setXY(c,l)}x=n;b.setCoordsPoint2D(l);c=h;n=r;l.setCoordsPoint2D(u)}return q}function S(a,b,c,e){c=-1;const f=new p.Point2D,
d=new p.Point2D,g=new p.Point2D;for(let h=0,l=a.getPathSize(e),n=a.getFirstVertex(e);h<l;++h){-1===c&&(a.queryXY(n,d),c=a.getPrevVertex(n),-1!==c&&(a.queryXY(c,f),g.setSub(d,f),g.normalize()));e=a.getNextVertex(n);if(-1===e)break;const m=a.getXY(e),q=m.sub(d);q.normalize();-1!==c&&-.99>q.dotProduct(g)&&1E-7>Math.abs(q.crossProduct(g))&&a.setUserIndex(n,b,1);c=n;n=e;f.assign(d);d.assign(m);g.assign(q)}}function T(a,b,c,e,f,d,g){e={stack:[],error:void 0,hasError:!1};try{const h=a.getFirstPath(b),l=
a.createUserIndex();L.__addDisposableResource(e,p.makeScopedCall(()=>{a.removeUserIndex(l)},!1),!1);S(a,l,b,h);for(b=0;100>b;++b){if(0===a.getPathSize(h))return 1;let n=a.getFirstVertex(h),m=a.getPathSize(h);if(3>m)return 1;a.isClosedPath(h)||--m;let q=0,w=!1;for(let x=0;x<m&&n!==k.nullHandle;x++){let r=0,u=n;for(let v=1,y=Math.min(64,m-x);v<y;v++)if(u=a.getNextVertexEx(u,c),1<v){const B=R(a,l,n,u,c,f,g,64);if(-1===B)break;r+=B;m-=B}q+=r;if(w=0<r){const v=a.getPrevVertexEx(n,c);if(-1!==v){n=v;m++;
continue}}n=a.getNextVertexEx(n,c)}if(0===q)break}a.filterClosePoints(d,!1,!1,!1,-1);return 1}catch(h){e.error=h,e.hasError=!0}finally{L.__disposeResources(e)}}function K(a,b,c,e){for(let f=0,d=a.getPathCount();f<d;f++){const g=a.getXY(a.getPathStart(f));g.x!==c.xmin&&g.x!==c.xmax&&b.addPath(a,f,e)}}class U{getOperatorType(){return 10104}accelerateGeometry(a,b,c){return!1}canAccelerateGeometry(a){return!1}supportsCurves(){return!0}isSimple(a,b,c,e,f){return 5===k.isSimpleOGC(a,b,c,e,f)}executeMany(a,
b,c,e){return new V(a,b,c,e)}execute(a,b,c,e){a=new H.SimpleGeometryCursor([a]);(b=this.executeMany(a,b,c,e).next())||t.throwInternalErrorException("null output");return b}}class V extends H.GeometryCursor{constructor(a,b,c,e){super();a||t.throwInvalidArgumentException("");this.m_progressTracker=e;this.m_bForceSimplify=c;this.m_index=-1;this.m_inputGeometryCursor=a;this.m_spatialReference=b}next(){const a=this.m_inputGeometryCursor.next();return a?(t.throwIfMesh(a),this.m_index=this.m_inputGeometryCursor.getGeometryID(),
this.simplify(a)):null}getGeometryID(){return this.m_index}tock(){return!1}getRank(){return 1}simplify(a){a||t.throwInvalidArgumentException("");return k.simplifyOGC(a,this.m_spatialReference,this.m_bForceSimplify,this.m_progressTracker)}}var A;(function(a){a[a.enumDummy=256]="enumDummy";a[a.enumLine=1]="enumLine";a[a.enumArc=2]="enumArc";a[a.enumMiter=8]="enumMiter";a[a.enumBevel=16]="enumBevel";a[a.enumJoinMask=26]="enumJoinMask";a[a.enumConnectionMask=27]="enumConnectionMask"})(A||={});class W extends H.GeometryCursor{constructor(a,
b,c,e,f,d,g,h,l,n){super();this.m_index=0;this.m_bufferedPolygon=null;this.m_y=this.m_x=0;this.m_progressTracker=n;this.m_parent=a;this.m_mp=b;this.m_distance=c;this.m_spatialReference=e;this.m_densifyDist=h;this.m_maxVertexInCompleteCircle=l;this.m_joins=f;this.m_caps=d;this.m_miterLimit=g}next(){for(var a=new k.Point;;){if(this.m_index===this.m_mp.getPointCount())return null;if(1===this.m_caps)return this.m_index=this.m_mp.getPointCount(),new k.Polygon({vd:this.m_mp.getDescription()});this.m_mp.getPointByVal(this.m_index,
a);this.m_index++;if(!a.isEmpty())break}var b=!1;null===this.m_bufferedPolygon&&(this.m_x=a.getX(),this.m_y=a.getY(),this.m_bufferedPolygon=this.m_parent.buffer(a,this.m_distance,this.m_spatialReference,this.m_joins,this.m_caps,this.m_miterLimit,this.m_densifyDist,this.m_maxVertexInCompleteCircle),b=!0);let c;c=this.m_index<this.m_mp.getPointCount()?this.m_bufferedPolygon.clone():this.m_bufferedPolygon;if(!b){b=new p.Transformation2D;const e=a.getX()-this.m_x;a=a.getY()-this.m_y;b.setShiftCoords(e,
a);c.applyTransformation(b)}k.setWeakSimple(c,0);return c}getGeometryID(){return 0}getRank(){t.geometryReleaseAssert(0);return-1}tock(){return!0}}class X extends H.GeometryCursor{constructor(a){super();this.m_currentPathIndex=0;this.m_polyline=a}next(){if(!this.m_polyline)return null;var a=this.m_polyline.getImpl(),b=a.getPathCount();if(this.m_currentPathIndex<b){b=this.m_currentPathIndex;this.m_currentPathIndex++;if(!a.isClosedPathInXYPlane(b))for(var c=a.getXY(a.getPathEnd(b)-1);this.m_currentPathIndex<
a.getPathCount();){const e=a.getXY(a.getPathStart(this.m_currentPathIndex));if(a.isClosedPathInXYPlane(this.m_currentPathIndex))break;if(!e.equals(c))break;c=a.getXY(a.getPathEnd(this.m_currentPathIndex)-1);this.m_currentPathIndex++}if(0===b&&this.m_currentPathIndex===this.m_polyline.getPathCount())return a=this.m_polyline,this.m_polyline=null,a;c=new k.Polyline({vd:this.m_polyline.getDescription()});c.addPath(this.m_polyline,b,!0);for(b+=1;b<this.m_currentPathIndex;b++)c.addSegmentsFromPath(this.m_polyline,
b,0,a.getSegmentCountPath(b),!1);this.m_currentPathIndex===this.m_polyline.getPathCount()&&(this.m_polyline=null);return c}return null}getGeometryID(){return 0}getRank(){t.geometryReleaseAssert(0);return-1}tock(){return!0}}class Y extends H.GeometryCursor{constructor(a,b,c){super();this.m_geometry=null;this.m_index=0;this.m_bufferer=a;this.m_geoms=b;this.m_index=0;this.m_bFilter=c}next(){if(null===this.m_geometry&&(this.m_index=0,this.m_geometry=this.m_geoms.next(),!this.m_geometry))return null;var a=
this.m_geometry.getImpl();if(this.m_index<a.getPathCount())return a=this.m_index,this.m_index++,this.m_bufferer.bufferPolylinePath(this.m_geometry,a,this.m_bFilter);this.m_geometry=null;return this.next()}getGeometryID(){return 0}getRank(){t.geometryReleaseAssert(0);return-1}tock(){return!0}}class Z extends H.GeometryCursor{constructor(a){super();this.m_index=0;this.m_bufferer=a}next(){const a=this.m_bufferer.m_geometry;if(this.m_index<a.getPathCount()){const b=this.m_index,c=a.calculateRingArea2D(this.m_index);
t.geometryReleaseAssert(0<c);for(this.m_index++;this.m_index<a.getPathCount()&&!(0<a.calculateRingArea2D(this.m_index));)this.m_index++;return 0===b&&this.m_index===a.getPathCount()?this.m_bufferer.bufferPolygonImpl(a,0,a.getPathCount()):this.m_bufferer.bufferPolygonImpl(a,b,this.m_index)}return null}getGeometryID(){return 0}getRank(){t.geometryReleaseAssert(0);return-1}tock(){return!0}}class aa{constructor(a){this.m_geometry=null;this.m_bufferCommands=[];this.m_originalGeomType=t.GeometryType.enumUnknown;
this.m_circleTemplateSize=this.m_maxVertexInCompleteCircle=-1;this.m_oldCircleTemplateSize=0;this.m_spatialReference=null;this.m_tolerance=new k.CombinedTolerance(0,0);this.m_smallTolerance=new k.CombinedTolerance(0,0);this.m_filterTolerance=0;this.m_densifyDist=-1;this.m_distance=Number.NaN;this.m_absDistanceReversed=this.m_absDistance=0;this.m_dA=-1;this.m_miterLimit=4;this.m_caps=this.m_joins=0;this.m_bFilter=this.m_bOutputLoops=this.m_bRoundBuffer=!0;this.m_circleTemplate=[];this.m_leftStack=
[];this.m_middleStack=[];this.m_helperLine1=new k.Line;this.m_helperLine2=new k.Line;this.m_helperArray=[];this.m_progressCounter=0;this.m_densificator=k.Densificator$1.constructDefault(a);this.m_progressTracker=a}buffer(a,b,c,e,f,d,g,h){a||t.throwInvalidArgumentException("Geometry.Bufferer.Impl.Buffer");0>g&&t.throwInvalidArgumentException("Geometry.Bufferer.Impl.Buffer");t.isMesh(a.getGeometryType())&&t.throwNotImplementedException("Unsupported geometry type.");if(a.isEmpty())return new k.Polygon({vd:a.getDescription()});
this.m_joins=e;this.m_caps=f;this.m_bRoundBuffer=!1;this.m_miterLimit=d;this.m_originalGeomType=a.getGeometryType();t.isArea(this.m_originalGeomType)?this.m_bRoundBuffer=0===this.m_joins:t.isPoint(this.m_originalGeomType)?this.m_bRoundBuffer=0===this.m_caps:t.isLinear(this.m_originalGeomType)&&(this.m_bRoundBuffer=0===this.m_joins&&0===this.m_caps);this.m_bFilter=this.m_bRoundBuffer;this.m_geometry=P.clean(a);if(this.m_geometry.isEmpty())return new k.Polygon({vd:a.getDescription()});a=new k.Envelope2D;
this.m_geometry.queryLooseEnvelope(a);0<b&&a.inflateCoords(b,b);this.m_tolerance=k.calculateToleranceFromGeometryForOp(c,a,!0);this.m_smallTolerance=k.calculateToleranceFromGeometryForOp(null,a,!0);0>=h&&(h=96);this.m_spatialReference=c;this.m_distance=b;this.m_absDistance=Math.abs(this.m_distance);this.m_absDistanceReversed=0!==this.m_absDistance?1/this.m_absDistance:0;Number.isNaN(g)||0===g?g=1E-5*this.m_absDistance:g>.5*this.m_absDistance&&(g=.5*this.m_absDistance);12>h&&(h=12);c=Math.abs(b)*(1-
Math.cos(Math.PI/h));c>g?g=c:0!==b&&(c=Math.PI/Math.acos(1-g/Math.abs(b)),c<h-1&&(h=Math.trunc(c),12>h&&(h=12,g=Math.abs(b)*(1-Math.cos(Math.PI/h)))));this.m_densifyDist=g;this.m_maxVertexInCompleteCircle=h;this.m_filterTolerance=this.m_bRoundBuffer?Math.min(this.m_smallTolerance.total(),.25*this.m_densifyDist):0;this.m_circleTemplateSize=this.calcN();this.m_circleTemplateSize!==this.m_oldCircleTemplateSize&&(this.m_circleTemplate.length=0,this.m_oldCircleTemplateSize=this.m_circleTemplateSize);0<
this.m_densifyDist&&t.hasNonLinearSegments(this.m_geometry)&&(this.m_geometry=this.m_densificator.densifyEx(this.m_geometry,0,this.m_densifyDist,0,0!==this.m_joins,p.intMax()));b=this.bufferImpl();this.m_geometry=null;return b}generateCircleTemplate(){if(!this.m_circleTemplate.length){var a=Math.trunc((this.m_circleTemplateSize+3)/4),b=.5*Math.PI/a;this.m_dA=b;this.m_circleTemplate.length=4*a;var c=Math.cos(b);b=Math.sin(b);var e=p.Point2D.construct(0,1);for(let f=0;f<a;f++)this.m_circleTemplate[f+
0*a]=p.Point2D.construct(e.y,-e.x),this.m_circleTemplate[f+1*a]=p.Point2D.construct(-e.x,-e.y),this.m_circleTemplate[f+2*a]=p.Point2D.construct(-e.y,e.x),this.m_circleTemplate[f+3*a]=e.clone(),e.rotateReverse(c,b)}}bufferImpl(){var a=this.m_geometry.getGeometryType();if(t.isSegment(a))return a=new k.Polyline({vd:this.m_geometry.getDescription()}),a.addSegment(this.m_geometry,!0),this.m_geometry=a,this.bufferImpl();if(this.m_distance<=this.m_tolerance.total())if(t.isArea(a)){if(0>this.m_distance&&
(a=new k.Envelope2D,this.m_geometry.queryEnvelope(a),a.width()<=2*this.m_absDistance||a.height()<=2*this.m_absDistance))return new k.Polygon({vd:this.m_geometry.getDescription()})}else return new k.Polygon({vd:this.m_geometry.getDescription()});switch(this.m_geometry.getGeometryType()){case t.GeometryType.enumPoint:return this.bufferPoint();case t.GeometryType.enumMultiPoint:return this.bufferMultiPoint();case t.GeometryType.enumPolyline:return this.bufferPolyline();case t.GeometryType.enumPolygon:return this.bufferPolygon();
case t.GeometryType.enumEnvelope:return this.bufferEnvelope();default:t.throwInternalErrorException("")}}bufferPolyline(){if(this.isDegenerateGeometry(this.m_geometry)){var a=new k.Point;this.m_geometry.getPointByVal(0,a);var b=new k.Envelope2D;this.m_geometry.queryEnvelope(b);a.setXY(b.getCenter());return this.bufferDegeneratePath(a,!0)}b=this.m_geometry;a=this.m_geometry.getDescription();this.m_geometry=null;b=new X(b);b=0===this.m_joins?(new Q.OperatorGeneralize).executeMany(b,.25*this.m_densifyDist,
!1,this.m_progressTracker):b;b=this.m_bRoundBuffer?(new U).executeMany(b,null,!0,this.m_progressTracker):b;b=new Y(this,b,this.m_bFilter);b=(new k.OperatorUnion).executeMany(b,this.m_spatialReference,this.m_progressTracker,2);b=(new k.OperatorSimplify).executeMany(b,this.m_spatialReference,!1,this.m_progressTracker).next();return null!==b?b:new k.Polygon({vd:a})}bufferPolygon(){if(0===this.m_distance)return this.m_geometry;this.generateCircleTemplate();var a=(new k.OperatorSimplify).execute(this.m_geometry,
null,!1,this.m_progressTracker);if(0>this.m_distance){this.m_geometry=a;if(this.m_geometry.isEmpty())return this.m_geometry;a=this.m_geometry;a=this.bufferPolygonImpl(a,0,a.getPathCount());return(new k.OperatorSimplify).execute(a,this.m_spatialReference,!1,this.m_progressTracker)}this.m_geometry=a;if(this.isDegenerateGeometry(this.m_geometry)){a=new k.Point;this.m_geometry.getPointByVal(0,a);const b=new k.Envelope2D;this.m_geometry.queryEnvelope(b);a.setXY(b.getCenter());return this.bufferDegeneratePath(a,
!0)}a=new Z(this);a=(new k.OperatorUnion).executeMany(a,this.m_spatialReference,this.m_progressTracker,2);a=(new k.OperatorSimplify).executeMany(a,this.m_spatialReference,!1,this.m_progressTracker).next();return null!==a?a:new k.Polygon({vd:this.m_geometry.getDescription()})}bufferPolygonImpl(a,b,c){const e=a.getImpl();for(var f=new k.Polygon({vd:a.getDescription()});b<c;b++)if(!(1>e.getPathSize(b))){var d=e.calculateRingArea2D(b),g=new k.Envelope2D;e.queryPathEnvelope(b,g);if(0<this.m_distance)if(0<
d)this.isDegeneratePath(e,b)?(d=new k.Point,e.getPointByVal(e.getPathStart(b),d),d.setXY(g.getCenter()),f.add(this.bufferDegeneratePath(d,!0),!1)):(g=new k.Polyline({vd:a.getDescription()}),d=g.getImpl(),k.isPathConvex(this.m_geometry,b)?(g=this.bufferConvexPath(a,b),f.add(g,!1)):(this.bufferClosedPath(this.m_geometry,b,d,this.m_bRoundBuffer,1),g=this.bufferCleanup(g),f.add(g,!1)));else{if(!(g.width()+this.m_tolerance.total()<=2*this.m_absDistance||g.height()+this.m_tolerance.total()<=2*this.m_absDistance)){d=
new k.Polyline({vd:a.getDescription()});var h=d.getImpl();this.bufferClosedPath(this.m_geometry,b,h,this.m_bRoundBuffer,1);if(!d.isEmpty()){var l=Math.max(1,this.m_absDistance);g=g.clone();g.inflateCoords(l,l);h.addEnvelope(g,!1);d=this.bufferCleanup(d);f.reserve(f.getPointCount()+d.getPointCount()-4);K(d,f,g,!0)}}}else if(0<d)g.width()+this.m_tolerance.total()<=2*this.m_absDistance||g.height()+this.m_tolerance.total()<=2*this.m_absDistance||(g=new k.Polyline({vd:a.getDescription()}),d=g.getImpl(),
this.bufferClosedPath(this.m_geometry,b,d,this.m_bRoundBuffer,-1),g.isEmpty()||(l=new k.Envelope2D,d.queryLooseEnvelope(l),h=Math.max(1,this.m_absDistance),l=l.clone(),l.inflateCoords(h,h),d.addEnvelope(l,!1),g=this.bufferCleanup(g),K(g,f,l,!0)));else{g=new k.Polyline({vd:a.getDescription()});d=g.getImpl();this.bufferClosedPath(this.m_geometry,b,d,this.m_bRoundBuffer,-1);g=this.bufferCleanup(g);for(let n=0,m=g.getPathCount();n<m;n++)f.addPath(g,n,!0)}}if(0<this.m_distance)return 1<f.getPathCount()?
this.bufferCleanup(f):J(f);a=new k.Envelope2D;f.queryLooseEnvelope(a);if(f.isEmpty())return J(f);c=Math.max(1,this.m_absDistance);a=a.clone();a.inflateCoords(c,c);f.addEnvelope(a,!1);c=this.bufferCleanup(f);f=new k.Polygon;f=new k.Polygon({vd:c.getDescription()});K(c,f,a,!1);return J(f)}bufferPoint(){return this.bufferPointImpl(this.m_geometry)}bufferPointImpl(a){const b=new k.Polygon({vd:a.getDescription()});return 0===this.m_caps?(this.addCircle(b.getImpl(),a),this.setStrongSimple(b)):2===this.m_caps?
(this.addSquare(b.getImpl(),a),this.setStrongSimple(b)):b}bufferDegeneratePath(a,b){const c=new k.Polygon({vd:a.getDescription()});return b&&0===this.m_joins||!b&&0===this.m_caps?(this.addCircle(c.getImpl(),a),this.setStrongSimple(c)):b||2!==this.m_caps?c:(this.addSquare(c.getImpl(),a),this.setStrongSimple(c))}bufferMultiPoint(){const a=new W(this,this.m_geometry,this.m_distance,this.m_spatialReference,this.m_joins,this.m_caps,this.m_miterLimit,this.m_densifyDist,this.m_maxVertexInCompleteCircle,
this.m_progressTracker);return(new k.OperatorUnion).executeMany(a,this.m_spatialReference,this.m_progressTracker,2).next()}bufferEnvelope(){var a=new k.Polygon({vd:this.m_geometry.getDescription()});if(0>=this.m_distance){if(0===this.m_distance)a.addEnvelope(this.m_geometry,!1),M(this.m_geometry,this.m_tolerance.total())&&(a=this.setStrongSimple(a));else{var b=new k.Envelope;this.m_geometry.queryEnvelope(b);b.inflateCoords(this.m_distance,this.m_distance);a.addEnvelope(b,!1);M(b,this.m_tolerance.total())&&
(a=this.setStrongSimple(a))}return a}if(1===this.m_joins)return b=new k.Envelope({copy:this.m_geometry}),b.inflateCoords(this.m_absDistance,this.m_absDistance),a.addEnvelope(b,!1),a;b=this.m_geometry.clone();if(0===b.width()||0===b.height()){if(0===b.width()&&0===b.height())return a=new k.Point({vd:this.m_geometry.getDescription()}),b.queryCornerByVal(0,a),this.m_geometry=a,this.bufferImpl();a=new k.Polyline({vd:this.m_geometry.getDescription()});const c=new k.Point;b.queryCornerByVal(0,c);a.startPathPoint(c);
b.queryCornerByVal(2,c);a.lineToPoint(c);this.m_geometry=a;return this.bufferImpl()}a.addEnvelope(this.m_geometry,!1);this.m_geometry=a;return this.bufferConvexPath(a,0)}bufferConvexPath(a,b){this.generateCircleTemplate();const c=a.hasAttribute(10),e=new k.Polygon({vd:a.getDescription()}),f=e.getImpl();e.reserve((this.m_circleTemplate.length/10+4)*a.getPathSize(b));const d=new p.Point2D,g=new p.Point2D,h=new p.Point2D,l=new p.Point2D(0,0),n=new p.Point2D,m=new p.Point2D,q=a.getImpl(),w=a.getPathSize(b),
x=a.getPathStart(b);for(let y=0,B=a.getPathSize(b);y<B;y++){var r=q.getXY(x+y);a=q.getXY(x+(y+1)%w);var u=q.getXY(x+(y+2)%w);n.setSub(a,r);0===n.length()&&t.throwInternalErrorException("");var v=c&&0!==(q.getAttributeAsInt(10,(y+1)%w,0)&1);n.normalize();b=n.clone();n.leftPerpendicularThis();n.scale(this.m_absDistance);d.setAdd(n,r);g.setAdd(n,a);0===y?f.startPath(d):f.lineTo(d);f.lineTo(g);m.setSub(u,a);0===m.length()&&t.throwInternalErrorException("");m.normalize();r=m.clone();m.leftPerpendicularThis();
m.scale(this.m_absDistance);h.setAdd(m,a);u=A.enumArc;v=v?0:this.m_joins;2===v?u=A.enumBevel:1===v?(v=-b.crossProduct(r),l.setSub(b,r),l.scale(this.m_absDistance/v),l.length()<this.m_miterLimit*this.m_absDistance?(l.addThis(a),u=A.enumMiter):u=A.enumBevel):l.assign(a);this.addJoin(u,f,l,g,h,!1,!1)}return J(e)}bufferPolylinePath(a,b,c){this.generateCircleTemplate();var e=a.getImpl();if(1>e.getPathSize(b))return null;let f;f=this.m_bRoundBuffer?e.isClosedPathInXYPlane(b):e.isClosedPath(b);if(this.isDegeneratePath(e,
b)&&0<this.m_distance)return a=new k.Point,e.getPointByVal(e.getPathStart(b),a),c=new k.Envelope2D,e.queryPathEnvelope(b,c),a.setXY(c.getCenter()),this.bufferDegeneratePath(a,f);const d=new k.Polyline({vd:a.getDescription()});d.reserve((Math.trunc(this.m_circleTemplate.length/10)+4)*e.getPathSize(b));e=d.getImpl();f?2!==this.bufferClosedPath(a,b,e,c,1)&&this.bufferClosedPath(a,b,e,c,-1):this.bufferOpenPath(a,b,e,c);return this.bufferCleanup(d)}progress_(){}bufferCleanup(a,b=!1){return k.planarSimplify(a,
b?this.m_tolerance:this.m_smallTolerance,!0,!b,-1,this.m_progressTracker,0,!1)}calcN(){if(0===this.m_densifyDist)return this.m_maxVertexInCompleteCircle;const a=1-this.m_densifyDist*Math.abs(this.m_absDistanceReversed);let b=4;b=-1>a?4:2*Math.PI/Math.acos(a)+.5;4>b?b=4:b>this.m_maxVertexInCompleteCircle&&(b=this.m_maxVertexInCompleteCircle);return Math.trunc(b)}addJoin(a,b,c,e,f,d,g){this.generateCircleTemplate();d&&(b.startPath(e),d=!1);if(a!==A.enumBevel)if(a===A.enumMiter)c=c.clone(),b.lineTo(c);
else{d=new p.Point2D;d.setSub(e,c);d.scale(this.m_absDistanceReversed);a=new p.Point2D;a.setSub(f,c);a.scale(this.m_absDistanceReversed);d=Math.atan2(d.y,d.x)/this.m_dA;0>d&&(d=this.m_circleTemplate.length+d);d=this.m_circleTemplate.length-d;a=Math.atan2(a.y,a.x)/this.m_dA;0>a&&(a=this.m_circleTemplate.length+a);a=this.m_circleTemplate.length-a;a<d&&(a+=this.m_circleTemplate.length);a=Math.trunc(a);d=Math.ceil(d);var h=this.m_circleTemplate[d%this.m_circleTemplate.length].clone();h.scaleAddThis(this.m_absDistance,
c);var l=10*this.m_tolerance.total();h.sub(e).length()<l&&(d+=1);h=this.m_circleTemplate[a%this.m_circleTemplate.length].clone();h.scaleAddThis(this.m_absDistance,c);h.sub(f).length()<l&&--a;e=a-d;e++;for(let n=0,m=d%this.m_circleTemplate.length;n<e;n++,m=(m+1)%this.m_circleTemplate.length)h=this.m_circleTemplate[m].clone(),h.scaleAddThis(this.m_absDistance,c),b.lineTo(h),this.progress_()}g&&b.lineTo(f)}bufferClosedPath(a,b,c,e,f){const d=new k.EditShape;a=d.addPathFromMultiPath(a,b,!0);return this.bufferClosedPathImpl(d,
a,c,e,f)}bufferClosedPathImpl(a,b,c,e,f){var d=a.getFirstVertex(a.getFirstPath(b)),g=new k.Point;a.queryPoint(d,g);a.filterClosePoints(this.m_filterTolerance,!1,!1,!1,-1);if(2>a.getPointCount(b)){if(0>f)return 0;this.m_bRoundBuffer&&this.addCircle(c,g);return 2}t.geometryReleaseAssert(a.getFirstPath(b)!==k.nullHandle);t.geometryReleaseAssert(a.getFirstVertex(a.getFirstPath(b))!==k.nullHandle);d=a.getXY(a.getFirstVertex(a.getFirstPath(b)));const h=new p.Transformation2D;h.setShift(d.negate());a.applyTransformation(h);
if(e&&(e=T(a,b,f,!0,this.m_absDistance,this.m_filterTolerance,this.m_densifyDist),t.geometryReleaseAssert(1===e),2>a.getPointCount(b))){if(0>f)return 0;this.addCircle(c,g);return 2}g=0!==this.m_joins&&a.getVertexDescription().hasAttribute(10);this.m_bufferCommands.length=0;var l=a.getFirstPath(b);b=a.getFirstVertex(l);var n=1===f?a.getPrevVertex(b):a.getNextVertex(b);e=1===f?a.getNextVertex(b):a.getPrevVertex(b);var m=!0;const q=new p.Point2D,w=new p.Point2D,x=new p.Point2D,r=new p.Point2D,u=new p.Point2D,
v=new p.Point2D,y=new p.Point2D,B=new p.Point2D,D=this.m_absDistance;l=a.getPathSize(l);const z=new p.Point2D(0,0);for(let G=0;G<l;G++){w.assign(a.getXY(e));m&&(q.assign(a.getXY(b)),x.assign(a.getXY(n)),v.setSub(q,x),v.normalize(),B.leftPerpendicularOther(v),B.scale(D),r.setAdd(B,q));var C=g&&0!==(a.getAttributeAsDbl(10,b,0)&1);u.setSub(w,q);u.normalize();y.leftPerpendicularOther(u);y.scale(D);n=new p.Point2D;n.setAdd(q,y);m=v.crossProduct(u);var F=v.dotProduct(u);0>m||0>F&&m<Math.abs(F)*Number.EPSILON*
8?(F=!1,C=C?0:this.m_joins,1===C?(m=-m,z.setSub(v,u),z.scale(this.m_absDistance/m),z.length()<this.m_miterLimit*this.m_absDistance&&(z.addThis(q),F=!0),this.m_bufferCommands.push(E(r,n,z,F?A.enumMiter:A.enumBevel,this.m_bufferCommands.length+1))):this.m_bufferCommands.push(E(r,n,q,0===C?A.enumArc:A.enumBevel,this.m_bufferCommands.length+1))):r.equals(n)||(this.m_bufferCommands.push(I(r,q,this.m_bufferCommands.length+1)),this.m_bufferCommands.push(I(q,n,this.m_bufferCommands.length+1)));m=new p.Point2D;
m.setAdd(w,y);this.m_bufferCommands.push(E(n,m,q,A.enumLine,this.m_bufferCommands.length+1));r.setCoordsPoint2D(m);B.setCoordsPoint2D(y);x.setCoordsPoint2D(q);q.setCoordsPoint2D(w);v.setCoordsPoint2D(u);n=b;b=e;m=!1;e=1===f?a.getNextVertex(b):a.getPrevVertex(b)}this.m_bufferCommands.at(-1).m_next=0;this.processBufferCommands(c);h.setShift(d);c.applyTransformationToPath(h,c.getPathCount()-1);return 1}bufferOpenPath(a,b,c,e){if(this.m_bRoundBuffer){var f=new k.Polyline({vd:a.getDescription()});f.addPath(a,
b,!1);f.addSegmentsFromPath(a,b,0,a.getSegmentCountPath(b),!1);return this.bufferClosedPath(f,0,c,e,1)}f=0;var d=new k.Polyline({vd:a.getDescription()});e=new p.Point2D(0,0);f=new k.EditShape;a=f.addPathFromMultiPath(a,b,!1);b=f.getFirstVertex(f.getFirstPath(a));var g=new k.Point;f.queryPoint(b,g);e.assign(g.getXY());f.filterClosePoints(0,!1,!1,!1,-1);if(2>f.getPointCount(a))return this.m_bRoundBuffer&&this.addCircle(c,g),2;a=f.getGeometry(f.getFirstGeometry());d.addPath(a,0,!1);f=d.getPointCount()-
1;d.addSegmentsFromPath(a,0,0,a.getSegmentCountPath(0)-1,!1);a=new k.EditShape;b=a.addPathFromMultiPath(d,0,!0);t.geometryReleaseAssert(a.getFirstPath(b)!==k.nullHandle);t.geometryReleaseAssert(a.getFirstVertex(a.getFirstPath(b))!==k.nullHandle);d=new p.Transformation2D;d.setShift(e.negate());a.applyTransformation(d);this.m_bufferCommands.length=0;var h=a.getFirstPath(b);b=0!==this.m_joins&&a.getVertexDescription().hasAttribute(10);g=a.getFirstVertex(h);var l=a.getPrevVertex(g);let n=a.getNextVertex(g);
var m=!0;const q=new p.Point2D,w=new p.Point2D,x=new p.Point2D,r=new p.Point2D,u=new p.Point2D,v=new p.Point2D,y=new p.Point2D,B=new p.Point2D,D=this.m_absDistance;h=a.getPathSize(h);const z=new p.Point2D(0,0);for(let G=0;G<h;G++){var C=!1;if(0===G||G===f)C=!0;w.assign(a.getXY(n));m&&(q.assign(a.getXY(g)),x.assign(a.getXY(l)),v.setSub(q,x),v.normalize(),B.leftPerpendicularOther(v),B.scale(D),r.setAdd(B,q));var F=b&&0!==(a.getAttributeAsDbl(10,g,0)&1);u.setSub(w,q);u.normalize();y.leftPerpendicularOther(u);
y.scale(D);l=new p.Point2D;l.setAdd(q,y);m=v.crossProduct(u);const N=v.dotProduct(u);0>m||0>N&&m<Math.abs(N)*Number.EPSILON*8?C?0===this.m_caps?this.m_bufferCommands.push(E(r,l,q,A.enumArc,this.m_bufferCommands.length+1)):1===this.m_caps?this.m_bufferCommands.push(E(r,l,q,A.enumLine,this.m_bufferCommands.length+1)):(C=u.mul(this.m_absDistance).negate(),m=C.clone(),C.addThis(r),m.addThis(l),this.m_bufferCommands.push(E(r,C,q,A.enumLine,this.m_bufferCommands.length+1)),this.m_bufferCommands.push(E(C,
m,q,A.enumLine,this.m_bufferCommands.length+1)),this.m_bufferCommands.push(E(m,l,q,A.enumLine,this.m_bufferCommands.length+1))):(C=!1,F=F?0:this.m_joins,1===F?(m=-m,z.setSub(v,u),z.scale(this.m_absDistance/m),z.length()<this.m_miterLimit*this.m_absDistance&&(z.addThis(q),C=!0),this.m_bufferCommands.push(E(r,l,z,C?A.enumMiter:A.enumBevel,this.m_bufferCommands.length+1))):this.m_bufferCommands.push(E(r,l,q,0===F?A.enumArc:A.enumBevel,this.m_bufferCommands.length+1))):r.equals(l)||(this.m_bufferCommands.push(I(r,
q,this.m_bufferCommands.length+1)),this.m_bufferCommands.push(I(q,l,this.m_bufferCommands.length+1)));C=new p.Point2D;C.setAdd(w,y);this.m_bufferCommands.push(E(l,C,q,A.enumLine,this.m_bufferCommands.length+1));r.setCoordsPoint2D(C);B.setCoordsPoint2D(y);x.setCoordsPoint2D(q);q.setCoordsPoint2D(w);v.setCoordsPoint2D(u);l=g;g=n;m=!1;n=a.getNextVertex(g)}this.m_bufferCommands.at(-1).m_next=0;this.processBufferCommands(c);d.setShift(e);c.applyTransformationToPath(d,c.getPathCount()-1);return 1}processBufferCommands(a){const b=
this.cleanupBufferCommands();let c=!0,e=b+1;for(let f=b;e!==b;f=e){const d=this.m_bufferCommands[f];e=-1!==d.m_next?d.m_next:(f+1)%this.m_bufferCommands.length;d.m_type&&(c&&(a.startPath(d.m_from),c=!1),d.m_type&A.enumJoinMask?this.addJoin(d.m_type,a,d.m_center,d.m_from,d.m_to,!1,!0):a.lineTo(d.m_to))}}cleanupBufferCommands(){this.m_helperArray=p.makeObjectArray(p.Point2D,9);let a=0;for(let c=0,e=this.m_bufferCommands.length;c<e;){var b=this.m_bufferCommands[c];if(b.m_type&A.enumConnectionMask){a=
c;break}c=b.m_next}b=a+1;for(let c=a;b!==a;c=b){const e=this.m_bufferCommands[c];b=e.m_next;let f=1,d=null;for(;b!==c;){d=this.m_bufferCommands[b];if(d.m_type&A.enumConnectionMask)break;b=d.m_next;f++}1!==f&&(e.m_type&d.m_type)===A.enumLine&&(this.m_helperLine1.setStartXY(e.m_from),this.m_helperLine1.setEndXY(e.m_to),this.m_helperLine2.setStartXY(d.m_from),this.m_helperLine2.setEndXY(d.m_to),1===this.m_helperLine1.intersect(this.m_helperLine2,this.m_helperArray,null,null,this.m_smallTolerance.total())&&
(e.m_to.assign(this.m_helperArray[0]),d.m_from.assign(this.m_helperArray[0]),e.m_next=b))}return a}isDegeneratePath(a,b){if(1===a.getPathSize(b))return!0;if(0===this.m_joins&&0===this.m_caps){const c=new k.Envelope2D;a.queryPathEnvelope(b,c);if(Math.max(c.width(),c.height())<.5*this.m_densifyDist)return!0}return!1}isDegenerateGeometry(a){if(0===this.m_joins&&0===this.m_caps){const b=new k.Envelope2D;a.queryEnvelope(b);if(Math.max(b.width(),b.height())<.5*this.m_densifyDist)return!0}return!1}addCircle(a,
b){b=b.getXY();if(0!==this.m_circleTemplate.length){var c=this.m_circleTemplate[0].clone();c.scaleAddThis(this.m_absDistance,b);a.startPath(c);for(let g=1,h=this.m_circleTemplate.length;g<h;g++)c=this.m_circleTemplate[g].clone(),c.scaleAddThis(this.m_absDistance,b),a.lineTo(c)}else{c=Math.trunc((this.m_circleTemplateSize+3)/4);var e=.5*Math.PI/c;a.reserve(4*c);var f=Math.cos(e);e=Math.sin(e);for(let g=3;0<=g;g--){const h=p.Point2D.construct(0,this.m_absDistance);switch(g){case 0:for(var d=0;d<c;d++)a.lineToCoords(h.x+
b.x,h.y+b.y),h.rotateReverse(f,e);break;case 1:for(d=0;d<c;d++)a.lineToCoords(-h.y+b.x,h.x+b.y),h.rotateReverse(f,e);break;case 2:for(d=0;d<c;d++)a.lineToCoords(-h.x+b.x,-h.y+b.y),h.rotateReverse(f,e);break;default:for(a.startPathCoords(h.y+b.x,-h.x+b.y),d=1;d<c;d++)h.rotateReverse(f,e),a.lineToCoords(h.y+b.x,-h.x+b.y)}this.progress_()}}}addSquare(a,b){const c=new k.Envelope({vd:b.getDescription()});c.setCoords(b.getX(),b.getY(),b.getX(),b.getY());c.inflateCoords(this.m_absDistance,this.m_absDistance);
a.addEnvelope(c,!1)}setStrongSimple(a){a.getImpl().setIsSimple(4,this.m_tolerance.total());a.getImpl().updateOGCFlagsProtected();return a}}O.Bufferer=aa});