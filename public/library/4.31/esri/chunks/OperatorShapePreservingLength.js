// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["exports","./Geometry","./QuadraticBezier","./Transformation2D"],function(L,y,f,t){function D(){return{m_pGcs:new t.Point2D,m_xyz:new f.Point3D,m_factor:Number.NaN,m_geoLength:Number.NaN,setValues:M,setLength:N,assign:O}}function M(a,b,d,e){this.m_factor=a;this.m_pGcs.assign(b);this.m_xyz.assign(e);this.m_geoLength=d}function N(a){this.m_geoLength=a}function O(a){this.m_pGcs.assign(a.m_pGcs);this.m_xyz.assign(a.m_xyz);this.m_factor=a.m_factor;this.m_geoLength=a.m_geoLength}function z(a,b,
d){const e=new f.Point3D;e.setSub(b,d);b=e.length();return 2*a*Math.asin(b/(2*a))}class P{getOperatorType(){return 10315}supportsCurves(){return!0}accelerateGeometry(a,b,d){return!1}canAccelerateGeometry(a){return!1}_ExecuteShapePreservingLength(a,b,d,e,g){a.hasNonLinearSegments()&&(a=(new f.OperatorDensify).execute(a,0,b.getTolerance(0),0,g));if(b.isPannable()){var c=90;let r=-90;1===d.getUnit().getUnitToBaseFactor()&&(c*=Math.PI/180,r*=Math.PI/180);if(2===b.getCoordinateSystemType()){var n=null;
const h=[0,0,0,0];n=b.getPECoordSys();h[0]=0;h[1]=c;h[2]=0;h[3]=r;f.peCSTransformations.geogToProj(n,2,h);c=h[1];r=h[3]}n=new f.Envelope2D;a.queryEnvelope(n);n.ymin=r;n.ymax=c;a=(new f.OperatorClip).execute(a,n,b,g)}else c=b.getPCSHorizon(),a=(new f.OperatorIntersection).execute(a,c,b,g),a===c&&(a=a.clone());return a.isEmpty()?0:this._ExecuteIterativeApproach(a,b,d,e,1,g)}_ExecuteIterativeApproach(a,b,d,e,g,c){c=f.makeSpheroidData();d.querySpheroidData(c);e=c.majorSemiAxis;c=c.e2;d=d.getUnit().getUnitToBaseFactor();
const n=t.makeStructArray(D,40),r=Array(40),h=D(),m=D();const k=[0,0,0,0],F=b.getPECoordSys(),A=new t.Point2D,B=new t.Point2D,u=new t.Point2D,v=new t.Point2D,w=new t.Point2D;let G=0;for(a=a.querySegmentIterator();a.nextPath();)for(;a.hasNextSegment();){const E=a.nextSegment();A.assign(E.getStartXY());B.assign(E.getEndXY());2===b.getCoordinateSystemType()?(k[0]=A.x,k[1]=A.y,k[2]=B.x,k[3]=B.y,f.peCSTransformations.projToGeog(F,2,k),u.x=k[0]*d,u.y=k[1]*d,v.x=k[2]*d,v.y=k[3]*d):(u.setCoordsPoint2D(A),
v.setCoordsPoint2D(B),u.scale(d),v.scale(d));var p=new f.Point3D;var l=new f.Point3D;p.assign(f.curvToCart(e,c,u));l.assign(f.curvToCart(e,c,v));var q=z(e,p,l);h.setValues(0,u,Number.NaN,p);m.setValues(1,v,q,l);p=g;n[0].assign(m);r[0]=g;for(l=0;;){128<l&&y.throwInternalErrorException("iterations exceeded");const H=.5*(h.m_factor+m.m_factor);q=E.getCoord2D(H);2===b.getCoordinateSystemType()?(k[0]=q.x,k[1]=q.y,f.peCSTransformations.projToGeog(F,1,k),w.x=k[0]*d,w.y=k[1]*d):(w.setCoordsPoint2D(q),w.scale(d));
u.setCoordsPoint2D(h.m_pGcs);v.setCoordsPoint2D(m.m_pGcs);const C=new f.Point3D;C.assign(f.curvToCart(e,c,w));const I=z(e,h.m_xyz,C),J=z(e,m.m_xyz,C);q=m.m_geoLength;Number.isNaN(q)&&(q=z(e,h.m_xyz,m.m_xyz));const x=I+J,K=p===g&&20<=x&&Math.abs(x-q)>1E-8*(q+x);if(40>l+2&&(K||0<Math.abs(x-q)&&0<p))m.setLength(J),n[l].assign(m),m.setValues(H,w,I,C),n[++l].assign(m),K?(p=g,r[l]=g):(p--,r[l-1]=p,r[l]=p);else{G+=x;if(0===l)break;h.assign(m);m.assign(n[--l]);p=r[l]}}}return G}execute(a,b,d){b&&0!==b.getCoordinateSystemType()||
y.throwInvalidArgumentException("");if(a.isEmpty()||1>a.getDimension())return 0;let e=null;const g=b.getGCS();g!==b&&(e=f.createEx(b,g,null));var c=a.getGeometryType();return c===y.GeometryType.enumEnvelope?(c=new f.Polygon,c.addEnvelope(a,!1),this._ExecuteShapePreservingLength(c,b,g,e,d)):y.isSegment(c)?(c=new f.Polyline,c.addSegment(a,!0),this._ExecuteShapePreservingLength(c,b,g,e,d)):this._ExecuteShapePreservingLength(a,b,g,e,d)}}L.OperatorShapePreservingLength=P});