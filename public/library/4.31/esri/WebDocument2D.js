// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require ./chunks/tslib.es6 ./kernel ./Map ./Viewpoint ./core/arrayUtils ./core/Collection ./core/Error ./core/Loadable ./core/loadAll ./core/Logger ./core/maybe ./core/MultiOriginJSONSupport ./core/Promise ./core/promiseUtils ./core/reactiveUtils ./core/urlUtils ./core/accessorSupport/decorators/property ./core/has ./core/accessorSupport/decorators/reader ./core/accessorSupport/decorators/subclass ./core/accessorSupport/decorators/writer ./core/accessorSupport/read ./geometry/SpatialReference ./portal/PortalItem ./portal/support/portalItemUtils ./support/MapFloorInfo ./time/TimeExtent ./webdoc/interfaces ./webdoc/RangeInfo ./webdoc/Widgets ./webdoc/support/thumbnailUtils ./webdoc/support/webdocLoadUtils ./webdoc/support/writeUtils ./webmap/ApplicationProperties ./webmap/Bookmark ./webmap/InitialViewProperties ./webmap/Version ./webmap/background/ColorBackground".split(" "),
function(A,f,B,d,p,C,D,E,F,G,t,H,I,J,K,L,q,g,ba,u,M,k,N,v,O,P,Q,w,m,x,R,S,T,U,V,W,r,n,y){const z=D.ofType(W),X=new Map([["image/jpeg","jpeg"],["image/jpg","jpg"],["image/png","png"],["image/gif","gif"]]),Y=P.typeKeyword.JSAPI;d=class extends I.MultiOriginJSONMixin(F.LoadableMixin(J.EsriPromiseMixin(d))){constructor(a){super(a);this._isAuthoringAppVersionSetByUser=this._isAuthoringAppSetByUser=!1;this._updateFromPromise=this._thumbnailFilename=null;this.resourceReferences={portalItem:null,paths:[]};
this.applicationProperties=null;this.bookmarks=new z;this.floorInfo=null;this.initialViewProperties=new r;this.widgets=this.sourceVersion=this.portalItem=null;this._debouncedSaveOperations=K.debounce(async(b,c,e)=>{const {save:h,saveAs:l}=await new Promise((Z,aa)=>A(["./webdoc/support/webdocSaveUtils"],Z,aa));switch(b){case m.SaveOperationType.SAVE:return h(this.context,this,c);case m.SaveOperationType.SAVE_AS:return l(this.context,this,e,c)}});this.authoringApp=this.authoringAppVersion=null;this._isAuthoringAppSetByUser=
this._isAuthoringAppVersionSetByUser=!1}destroy(){this.portalItem=H.destroyMaybe(this.portalItem)}initialize(){this.when().catch(a=>{t.getLogger(this).error("#load()","Failed to load web map",a)});if(this.resourceInfo){let a;try{a=this._validateJSON(this.resourceInfo)}catch(b){this.addResolvingPromise(Promise.reject(b));return}this.read(a)}}set authoringApp(a){this._isAuthoringAppSetByUser=!0;this._set("authoringApp",a)}writeAuthoringApp(a,b){b.authoringApp=a&&this._isAuthoringAppSetByUser?a:Y}set authoringAppVersion(a){this._isAuthoringAppVersionSetByUser=
!0;this._set("authoringAppVersion",a)}writeAuthoringAppVersion(a,b){b.authoringAppVersion=a&&this._isAuthoringAppVersionSetByUser?a:B.version}readInitialViewProperties(a,b){a=new r;b.background&&(a.background=y.fromJSON(b.background));var c=b.initialState?.timeExtent;c&&(a.timeExtent=w.fromArray(c));if(c=b.initialState?.viewpoint)c.rotation&&n.Version.parse(b.version||"","webmap").lessThan(2,20)&&"ArcGIS Pro"===b.authoringApp&&(c.rotation*=-1),a.viewpoint=p.fromJSON(c);b.mapRangeInfo&&(a.rangeInfo=
x.fromJSON(b.mapRangeInfo));b.spatialReference&&(a.spatialReference=v.fromJSON(b.spatialReference));b.timeZone&&(a.timeZone=b.timeZone);return a}writeInitialViewProperties(a,b,c,e){if(a){a.background?.color&&(b.background=a.background.write({},e));var {timeExtent:h,viewpoint:l}=a;if(l||h)c={},l&&(c.viewpoint=l.write({},e)),h&&(c.timeExtent=h.toArray()),b.initialState=c;a.rangeInfo&&(b.mapRangeInfo=a.rangeInfo.toJSON(e));a.spatialReference&&(b.spatialReference=a.spatialReference.write({},e));b.timeZone=
a.timeZone}}writeLayers(a,b,c,e){b[c]=this._writeLayers(a,e,"operational-layers")}readSourceVersion(a,b){const [c,e]=b.version.split(".");return new n.Version(parseInt(c,10),parseInt(e,10))}writeSourceVersion(a,b,c){b[c]=`${this.context.currentVersion.major}.${this.context.currentVersion.minor}`}writeTables(a,b,c,e){a=this._writeLayers(a,e,"tables");a.length&&(b[c]=a)}get thumbnailUrl(){return this.portalItem?.thumbnailUrl||null}set thumbnailUrl(a){a?(this._override("thumbnailUrl",a),this._thumbnailFilename=
this._generateCustomThumbnailFilename(a)):this._clearThumbnailOverride()}get updatingFromView(){return!!this._updateFromPromise}load(a){this.addResolvingPromise(T.loadFromSource(this.context,this));return Promise.resolve(this)}loadAll(){return G.loadAll(this,a=>{a(this.ground,this.basemap,this.layers,this.tables)})}read(a,b){b={...b,origin:this.context.origin};const c=this._getAuthoringPropsState();N.readLoadable(this,a,e=>super.read(a,e),b);this._restoreAuthoringPropsFromState(c)}write(a,b){if("loaded"!==
this.loadStatus)throw a=new E("webmap:not-loaded","Web map must be loaded before it can be serialized"),t.getLogger(this).error("#toJSON()","Web map must be loaded before it can be serialized",this.loadError||this.loadStatus),a;this._removeDanglingLayerRefs();b={...b,origin:this.context.origin,restrictedWebMapWriting:!0,webmap:this};return super.write(a,b)}async save(a){return this._debouncedSaveOperations(m.SaveOperationType.SAVE,a)}async saveAs(a,b){return this._debouncedSaveOperations(m.SaveOperationType.SAVE_AS,
b,a)}async updateFrom(a,b){this._updateFromPromise=a=this._updateFromInternal(a,b);await a;a===this._updateFromPromise&&(this._updateFromPromise=null)}getLayerJSONFromResourceInfo(a){const b=this.resourceInfo;return this._collectAllLayersJSON([...(b?.baseMap?.baseMapLayers||[]),...(b?.operationalLayers||[]),...(this.basemap?.resourceInfo?.data?.baseMapLayers||[])]).find(c=>c.id===a.id)}async updateItemThumbnail(){this.thumbnailUrl&&this._isOverridden("thumbnailUrl")&&(await this.portalItem?.updateThumbnail({thumbnail:this.thumbnailUrl,
filename:this._thumbnailFilename}),this._clearThumbnailOverride())}getThumbnailState(){let a=this.thumbnailUrl;a&&=this._isOverridden("thumbnailUrl")?a:q.addQueryParameter(a,"w","8192");return{thumbnailUrl:a,filename:this._thumbnailFilename}}restoreThumbnailFromState(a){this.thumbnailUrl=a.thumbnailUrl;this._thumbnailFilename=a.filename}_collectAllLayersJSON(a){return a.reduce((b,c)=>{b.push(c);"GroupLayer"===c.layerType&&(b=b.concat(this._collectAllLayersJSON(c.layers||[])));return b},[])}_writeLayers(a,
b,c){b={...b,layerContainerType:c};return a.map(e=>U.getLayerJSON(e,"tables"===c?null:this.getLayerJSONFromResourceInfo(e),b)).filter(C.isSome).toArray()}_validateJSON(a){const b=n.Version.parse(a.version||"","webmap");this.context.currentVersion.validate(b);a.version=`${b.major}.${b.minor}`;return a}_removeDanglingLayerRefs(){var a=this.applicationProperties,b=a?.viewing?.search;const c=e=>this.allLayers.some(h=>h.id===e);b?.layers&&(b.layers=b.layers.filter(e=>c(e.id)));b?.tables&&(b.tables=b.tables.filter(e=>
this.tables.some(h=>h.id===e.id)));a&&(b=a.editing?.locationTracking,b?.info&&!c(b.info.layerId)&&(a.editing=null));(a=("presentation"in this?this.presentation:null)?.slides)&&a.forEach(e=>{e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter(h=>c(h.id)))})}async _updateFromInternal(a,b){b??={};await L.whenOnce(()=>a.ready);this._updateInitialViewProperties(a,b);if(a.map===this)for(const c of a.allLayerViews)"visible"in c&&"visible"in c.layer&&c._isOverridden("visible")&&(c.layer.visible=c.visible),
"featureEffect"in c&&"featureEffect"in c.layer&&c._isOverridden("featureEffect")&&(c.layer.featureEffect=c.featureEffect);await this._updateThumbnailUrl(a,b)}_updateInitialViewProperties(a,b){b.backgroundExcluded||(this.initialViewProperties.background=a.background?.clone());this.initialViewProperties.spatialReference=a.spatialReference?.clone();this.initialViewProperties.timeZone=a.timeZone;b.viewpointExcluded||(this.initialViewProperties.viewpoint=new p({rotation:a.rotation,scale:b.scalePreserved?
a.scale:null,targetGeometry:this._getViewExtent(a)}));if(!b.widgetsExcluded)for(const c of a.persistableViewModels)c.updateWebDocument(this)}_getViewExtent(a){const b=a.center.clone().normalize();a=a.extent.clone();const c=a.width/2;a.xmin=b.x-c;a.xmax=b.x+c;return a}async _updateThumbnailUrl(a,b){b.thumbnailExcluded||(b=S.getOptimalThumbnailSize(a,b.thumbnailSize),a=await a.takeScreenshot({format:"png",width:b.width,height:b.height}),this._setAutoGeneratedThumbnail(a.dataUrl))}_setAutoGeneratedThumbnail(a){this.thumbnailUrl=
a;this._thumbnailFilename=null}_clearThumbnailOverride(){this._clearOverride("thumbnailUrl");this.clear("thumbnailUrl","user");this._thumbnailFilename=null}_generateCustomThumbnailFilename(a){if(q.isDataProtocol(a)){a=(a=q.dataComponents(a)?.mediaType)&&X.get(a.toLowerCase())||null;const b=`thumbnail${Date.now()}`;return a?`${b}.${a}`:b}return null}_getAuthoringPropsState(){return{authoringApp:this.authoringApp,authoringAppVersion:this.authoringAppVersion,isAuthoringAppSetByUser:this._isAuthoringAppSetByUser,
isAuthoringAppVersionSetByUser:this._isAuthoringAppVersionSetByUser}}_restoreAuthoringPropsFromState(a){a.isAuthoringAppSetByUser?this.authoringApp=a.authoringApp:this._isAuthoringAppSetByUser=!1;a.isAuthoringAppVersionSetByUser?this.authoringAppVersion=a.authoringAppVersion:this._isAuthoringAppVersionSetByUser=!1}};f.__decorate([g.property()],d.prototype,"_updateFromPromise",void 0);f.__decorate([g.property({type:V,json:{write:!0}})],d.prototype,"applicationProperties",void 0);f.__decorate([g.property({type:String,
json:{write:{allowNull:!0,ignoreOrigin:!0}}})],d.prototype,"authoringApp",null);f.__decorate([k.writer("authoringApp")],d.prototype,"writeAuthoringApp",null);f.__decorate([g.property({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],d.prototype,"authoringAppVersion",null);f.__decorate([k.writer("authoringAppVersion")],d.prototype,"writeAuthoringAppVersion",null);f.__decorate([g.property({type:z,json:{write:{overridePolicy(a){return{enabled:!!(a&&0<a.length),ignoreOrigin:!0}}}}})],d.prototype,
"bookmarks",void 0);f.__decorate([g.property({type:Q,json:{name:"mapFloorInfo",write:!0}})],d.prototype,"floorInfo",void 0);f.__decorate([g.property({type:r,nonNullable:!0,json:{read:{source:"background initialState.timeExtent initialState.viewpoint mapRangeInfo spatialReference timeZone".split(" ")},write:{ignoreOrigin:!0,target:{background:{type:y},"initialState.timeExtent":{type:w},"initialState.viewpoint":{type:p},mapRangeInfo:{type:x},spatialReference:{type:v},"timeZone:":{type:String}}}}})],
d.prototype,"initialViewProperties",void 0);f.__decorate([u.reader("initialViewProperties")],d.prototype,"readInitialViewProperties",null);f.__decorate([k.writer("initialViewProperties")],d.prototype,"writeInitialViewProperties",null);f.__decorate([g.property({json:{read:!1,write:{target:"operationalLayers",ignoreOrigin:!0}}})],d.prototype,"layers",void 0);f.__decorate([k.writer("layers")],d.prototype,"writeLayers",null);f.__decorate([g.property({type:O})],d.prototype,"portalItem",void 0);f.__decorate([g.property()],
d.prototype,"resourceInfo",void 0);f.__decorate([g.property({readOnly:!0,type:n.Version,json:{read:{source:"version"},write:{allowNull:!0,ignoreOrigin:!0,target:"version",isRequired:!0}}})],d.prototype,"sourceVersion",void 0);f.__decorate([u.reader("sourceVersion")],d.prototype,"readSourceVersion",null);f.__decorate([k.writer("sourceVersion")],d.prototype,"writeSourceVersion",null);f.__decorate([g.property({json:{read:!1,write:{ignoreOrigin:!0}}})],d.prototype,"tables",void 0);f.__decorate([k.writer("tables")],
d.prototype,"writeTables",null);f.__decorate([g.property()],d.prototype,"thumbnailUrl",null);f.__decorate([g.property()],d.prototype,"updatingFromView",null);f.__decorate([g.property({type:R,json:{write:!0}})],d.prototype,"widgets",void 0);return d=f.__decorate([M.subclass("esri.WebDocument2D")],d)});