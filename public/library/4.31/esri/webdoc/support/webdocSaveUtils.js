// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require exports ../../core/Error ../../core/MultiOriginJSONSupport ../../core/reactiveUtils ../../core/urlUtils ../../core/accessorSupport/originUtils ../../geometry/SpatialReference ../../geometry/support/spatialReferenceUtils ../../geometry/support/webMercatorUtils ../../layers/support/arcgisLayerUrl ../../layers/support/layerUtils ../../portal/Portal ../../portal/PortalItem ../../portal/support/jsonContext ../../portal/support/portalItemUtils ../../rest/geometryService/project ../../rest/support/ProjectParameters ../../support/basemapUtils ./resourceUtils ./saveUtils".split(" "),
function(F,k,l,G,n,t,H,I,J,K,L,p,M,N,O,e,P,Q,q,u,m){async function r(b,a){a=O.createForItemWrite(a,"web-map",!0);b=b.write({},a);await Promise.all(a.resources.pendingOperations);return{json:b,jsonContext:a}}function R(b,a){if(!a.portalItem)throw new l(`${b.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");v(b,a.portalItem)}function v(b,a){if(a.type!==b.itemType)throw new l(`${b.name}:portal-item-wrong-type`,`Portal item needs to have type "${b.itemType}"`);}async function w(b,
a){if(!a.basemap?.baseLayers.length)throw new l(`${b.name}:save`,"Map does not have a valid basemap with a base layer.");let c=null;await n.whenOnce(()=>{const d=q.findSpatialReference(a.initialViewProperties,a.basemap);c=d.spatialReference;return!d.updating});if(!J.equals(c,a.initialViewProperties.spatialReference))throw new l(`${b.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:a.initialViewProperties.spatialReference,actual:c});}function S(b,
a){a=N.from(a);a.id&&(a=a.clone(),a.id=null);a.type||(a.type=b.itemType);a.portal||(a.portal=M.getDefault());v(b,a);return a}function x(b){const a=[];b.basemap&&a.push(b.basemap.load());b.ground&&a.push(b.ground.load());return Promise.allSettled(a).then(()=>{})}async function y(b,a){a.extent=await T(b.portalItem,b.initialViewProperties.viewpoint.targetGeometry);await U(b,a)}async function V(b,a){e.removeTypeKeyword(a,"CollectorDisabled");e.removeTypeKeyword(a,"FieldMapsDisabled");e.removeTypeKeyword(a,
e.typeKeyword.METADATA);e.removeTypeKeyword(a,"OfflineDisabled");e.removeTypeKeyword(a,"Offline Map Areas");e.removeTypeKeyword(a,"Workforce Dispatcher");e.removeTypeKeyword(a,"Workforce Project");e.removeTypeKeyword(a,"Workforce Worker");await y(b,a)}async function U(b,a){e.addTypeKeyword(a,W);await X(b);Y(b,a);Z(b,a);aa(b,a);ba(b,a);ca(b,a);da(b,a);a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter((c,d,f)=>f.indexOf(c)===d))}function X(b){b=b.allLayers.concat(b.allTables).map(a=>a.load()).toArray();
return Promise.allSettled(b).then(()=>{})}function z(b){return b.allLayers.concat(b.allTables).some(a=>a.loaded&&p.isLayerWithFeatureLayerSource(a)&&a.capabilities.operations.supportsEditing&&a.editingEnabled&&("subtype-group"!==a.type||a.sublayers.some(c=>c.editingEnabled)))}function ea(b){return b.allLayers.concat(b.allTables).filter(a=>"group"!==a.type).every(a=>{var c;if(c=a.loaded)(c=p.isLayerWithFeatureLayerSource(a)&&a.capabilities.operations.supportsSync)||(c=(p.isFeatureCollectionLayer(a)||
"map-notes"===a.type||"route"===a.type)&&!a.portalItem),c||=("tile"===a.type||"vector-tile"===a.type)&&(a.capabilities.operations.supportsExportTiles||fa(a)||q.isDeveloperBasemapLayer(a))&&!("vector-tile"===a.type&&1<Object.keys(a.sourceNameToSource).length)&&a.spatialReference.equals(b.initialViewProperties.spatialReference);return c})}function Y(b,a){e.hasTypeKeyword(a,"CollectorDisabled")||e.hasTypeKeyword(a,"Workforce Project")||e.hasTypeKeyword(a,"Workforce Worker")||e.hasTypeKeyword(a,"Workforce Dispatcher")||
!z(b)?e.removeTypeKeyword(a,"Collector"):e.addTypeKeyword(a,"Collector")}function Z(b,a){z(b)?e.addTypeKeyword(a,"Data Editing"):e.removeTypeKeyword(a,"Data Editing")}function aa(b,a){!e.hasTypeKeyword(a,"OfflineDisabled")&&ea(b)?e.addTypeKeyword(a,"Offline"):e.removeTypeKeyword(a,"Offline")}function ba(b,a){q.hasDeveloperBasemapLayer(b.basemap)?e.addTypeKeyword(a,A):e.removeTypeKeyword(a,A)}function ca(b,a){b.utilityNetworks?.length?e.addTypeKeyword(a,"UtilityNetwork"):e.removeTypeKeyword(a,"UtilityNetwork")}
function da(b,a){b.ipsInfo?e.addTypeKeyword(a,"IPS"):e.removeTypeKeyword(a,"IPS")}async function T(b,a){a=a.clone().normalize();let c;if(1<a.length)for(const d of a)c?d.width>c.width&&(c=d):c=d;else c=a[0];return ha(b,c)}async function ha(b,a){var c=a.spatialReference;if(c.isWGS84)return a.clone();if(c.isWebMercator)return K.webMercatorToGeographic(a);({getGeometryServiceURL:c}=await new Promise((d,f)=>F(["../../portal/support/geometryServiceUtils"],d,f)));b=await c(b);a=new Q({geometries:[a],outSpatialReference:I.WGS84});
return(await P.project(b,a))[0]}function fa(b){return"tile"===b.type?L.isServerOrServicesAGOLUrl(b.url)&&ia.some(a=>b.url?.toLowerCase().includes("/"+a+"/")):!1}async function ja(b,a,c,d,f){await c.update({data:d});B(b,a,c,d,f)}async function ka(b,a,c,d,f,g){var h=a.portalItem;h={item:h,authenticated:!(!h?.id||!h.portal.user)};const C=c.portal;await C.signIn();const {copyAllowed:la,itemReloaded:ma}=await D(h,C);h.authenticated||(h.authenticated=ma);if(!la)throw new l(`${b.name}:save-as-copy-not-allowed`,
"Owner of this map does not allow others to save a copy");g=await E(c,h,d,g);a.portalItem=c;B(b,a,c,d,f);return g}async function D(b,a){const {item:c,authenticated:d}=b;if(c?.id&&c.typeKeywords?.includes("useOnly")){if(c.portal.portalHostname!==a.portalHostname)return{copyAllowed:!1,itemReloaded:!1};d||await c.reload();return{copyAllowed:"admin"===c.itemControl||"update"===c.itemControl,itemReloaded:!0}}return{copyAllowed:!0,itemReloaded:!1}}async function E(b,a,c,d){var f=b.portal;({item:a}=a);const {folder:g,
copyAllResources:h}=d;d=!1;h&&a?.id&&t.hasSameCanonicalPortal(a.portal.url,f.url)&&2023<=parseInt(a.portal.currentVersion,10)&&({total:d}=await a.fetchResources(),d=!!d);d?(f=await a.copy({copyResources:"all",folder:g}),b.id=f.id,b.portal=f.portal,f=b.toJSON(),await b.load(),b.read(f),await b.update({data:c})):await f.user.addItem({item:b,folder:g,data:c});return d}function B(b,a,c,d,f){G.MultiOriginJSONSupport.prototype.read.call(a,{version:d.version,authoringApp:d.authoringApp,authoringAppVersion:d.authoringAppVersion},
{origin:b.origin,ignoreDefaults:!0,url:c.itemUrl?t.urlToObject(c.itemUrl):void 0});H.updateOrigins(f);a.resourceInfo=d}const ia="NatGeo_World_Map Ocean_Basemap USA_Topo_Maps World_Imagery World_Street_Map World_Terrain_Base World_Topo_Map World_Hillshade Canvas/World_Light_Gray_Base Canvas/World_Light_Gray_Reference Canvas/World_Dark_Gray_Base Canvas/World_Dark_Gray_Reference Ocean/World_Ocean_Base Ocean/World_Ocean_Reference Reference/World_Boundaries_and_Places Reference/World_Reference_Overlay Reference/World_Transportation".split(" ").map(b=>
b.toLowerCase()),W=e.typeKeyword.JSAPI,A=e.typeKeyword.DEVELOPER_BASEMAP;k.createJSON=r;k.initializeNewItem=E;k.isCopyAllowed=D;k.save=async function(b,a,c){c??={};R(b,a);await n.whenOnce(()=>!a.updatingFromView);await a.load();await x(a);await m.beforeSave(a);await w(b,a);const d=a.portalItem,{json:f,jsonContext:g}=await r(a,d);m.evaluateWriteErrors(g,{errorName:`${b.name}:save`},c);await y(a,d);await ja(b,a,d,f,g);await Promise.all([a.updateItemThumbnail(),u.saveResources(a.resourceReferences,g)]);
return d};k.saveAs=async function(b,a,c,d){d??={};c=S(b,c);await n.whenOnce(()=>!a.updatingFromView);await a.load();await x(a);await m.beforeSave(a);await w(b,a);const {json:f,jsonContext:g}=await r(a,c);m.evaluateWriteErrors(g,{errorName:`${b.name}:save`},d);await V(a,c);const h=a.getThumbnailState();await ka(b,a,c,f,g,d)&&(a.resourceReferences.portalItem=c);a.restoreThumbnailFromState(h);await Promise.all([a.updateItemThumbnail(),u.saveResources(a.resourceReferences,g)]);return c};Object.defineProperty(k,
Symbol.toStringTag,{value:"Module"})});