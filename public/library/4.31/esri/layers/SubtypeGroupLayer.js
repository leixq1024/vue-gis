// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require ../chunks/tslib.es6 ../core/Clonable ../core/Collection ../core/Error ../core/loadAll ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/reactiveUtils ../core/sql ../core/urlUtils ../core/accessorSupport/decorators/property ../core/has ../core/Logger ../core/RandomLCG ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ./Layer ./mixins/APIKeyMixin ./mixins/ArcGISService ./mixins/BlendLayer ./mixins/CustomParametersMixin ./mixins/EditBusLayer ./mixins/FeatureLayerBase ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/featureLayerUtils ./support/fieldProperties ./support/fieldUtils ./support/subtypeGroupLayerUtils ./support/SubtypeSublayer ./support/TimeInfo ./support/versionUtils ../rest/support/Query ../webdoc/interfaces".split(" "),
function(u,f,d,r,l,z,A,t,v,B,w,h,n,Z,aa,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,g,S,T,x,p,U,V,W,q){function y(a,b){return new l("layer:unsupported",`Layer (${a.title}, ${a.id}) of type '${a.declaredClass}' ${b}`,{layer:a})}n=S.defineFieldProperties();d=class extends K.FeatureLayerBase(J.EditBusLayer(H.BlendLayer(P.TemporalLayer(O.ScaleRangeLayer(N.RefreshableLayer(G.ArcGISService(L.OperationalLayer(M.PortalLayer(A.MultiOriginJSONMixin(I.CustomParametersMixin(F.APIKeyMixin(d.ClonableMixin(E))))))))))))){constructor(...a){super(...a);
this._sublayerLookup=new Map;this.outFields=this.fieldsIndex=this.fields=null;this.sublayers=new (r.ofType(p));this.useUniqueColorsForSublayers=!0;this.supportedSourceTypes=new Set(["Feature Layer"]);this.timeInfo=null;this.title="Layer";this.type="subtype-group";this._debouncedSaveOperations=t.debounce(async(b,c,k)=>{const {save:e,saveAs:m}=await new Promise((X,Y)=>u(["./save/featureLayerUtils"],X,Y));switch(b){case q.SaveOperationType.SAVE:return e(this,c);case q.SaveOperationType.SAVE_AS:return m(this,
k,c)}});this.addHandles(v.watch(()=>this.sublayers,(b,c)=>this._handleSublayersChange(b,c),v.sync))}destroy(){this.source?.destroy()}normalizeCtorArgs(a,b){return"string"===typeof a?{url:a,...b}:a}load(a){const b=null!=a?a.signal:null,c=this.loadFromPortal({supportedTypes:["Feature Service"]},a).catch(t.throwIfAbortError).then(async()=>{if(!this.url)throw new l("subtype-grouplayer:missing-url-or-source","SubtypeGroupLayer must be created with either a url or a portal item");if(null==this.layerId)throw new l("subtype-grouplayer:missing-layerid",
"layerId is required for a SubtypeGroupLayer created with url");return this._initLayerProperties(await this.createGraphicsSource(b))}).then(()=>g.ensureLayerCredential(this,"load",a));this.addResolvingPromise(c);return Promise.resolve(this)}get createQueryVersion(){this.commitProperty("definitionExpression");this.commitProperty("timeExtent");this.commitProperty("timeOffset");this.commitProperty("geometryType");this.commitProperty("gdbVersion");this.commitProperty("historicMoment");this.commitProperty("returnZ");
this.commitProperty("capabilities");this.commitProperty("returnM");return(this._get("createQueryVersion")??0)+1}get editingEnabled(){return this.loaded&&null!=this.capabilities&&this.capabilities.operations.supportsEditing&&this.userHasEditingPrivileges}get effectiveEditingEnabled(){return g.computeEffectiveEditingEnabled(this)}get parsedUrl(){const a=w.urlToObject(this.url);null!=a&&null!=this.layerId&&(a.path=w.join(a.path,this.layerId.toString()));return a}set source(a){this._get("source")!==a&&
this._set("source",a)}readTitleFromService(a,{name:b}){return this.url?Q.titleFromUrlAndName(this.url,b):b}async addAttachment(a,b){a=await g.addAttachment(this,a,b,"SubtypeGroupLayer");this.lastEditsEventDate=new Date;return a}async updateAttachment(a,b,c){a=await g.updateAttachment(this,a,b,c,"SubtypeGroupLayer");this.lastEditsEventDate=new Date;return a}async applyEdits(a,b){return g.applyEdits(this,a,b)}on(a,b){return super.on(a,b)}async createGraphicsSource(a){const {default:b}=await t.whenOrAbort(new Promise((c,
k)=>u(["./graphics/sources/FeatureLayerSource"],e=>c(Object.freeze(Object.defineProperty({__proto__:null,default:e},Symbol.toStringTag,{value:"Module"}))),k)),a);return(new b({layer:this,supportedSourceTypes:this.supportedSourceTypes})).load({signal:a})}createQuery(){const a=g.createQuery(this),b=this.sublayers.map(c=>c.subtypeCode);a.where=B.sqlAnd(`${this.subtypeField} IN (${b.join(",")})`,this.definitionExpression);return a}async deleteAttachments(a,b){a=await g.deleteAttachments(this,a,b,"SubtypeGroupLayer");
this.lastEditsEventDate=new Date;return a}async fetchRecomputedExtents(a){return g.fetchRecomputedExtents(this,a,"SubtypeGroupLayer")}findSublayerForFeature(a){const b=this.fieldsIndex.get(this.subtypeField);return this.findSublayerForSubtypeCode(a.attributes[b.name])}findSublayerForSubtypeCode(a){return this._sublayerLookup.get(a)}getFieldDomain(a,b){if(!b?.excludeImpliedDomains){const c=g.computeDomainFromSubtypes(this,a);if(c)return c}return(b=g.getFeatureSubtype(this,b?.feature))?(b=b.domains?.[a],
"inherited"===b?.type?this._getLayerDomain(a):b):this._getLayerDomain(a)}getField(a){return this.fieldsIndex.get(a)}loadAll(){return z.loadAll(this,a=>{a(this.sublayers)})}async queryAttachments(a,b){return g.queryAttachments(this,a,b,"SubtypeGroupLayer")}async queryFeatures(a,b){const c=await this.load();a=W.from(a)??c.createQuery();const k=a.outFields??[];k.includes(this.subtypeField)||(k.push(this.subtypeField),a.outFields=k);b=await c.source.queryFeatures(a,b);if(b?.features)for(const e of b.features)e.layer=
e.sourceLayer=this.findSublayerForFeature(e);return b}async queryObjectIds(a,b){return g.queryObjectIds(this,a,b,"SubtypeGroupLayer")}async queryFeatureCount(a,b){return g.queryFeatureCount(this,a,b,"SubtypeGroupLayer")}async queryExtent(a,b){return g.queryExtent(this,a,b,"SubtypeGroupLayer")}async queryRelatedFeatures(a,b){return g.queryRelatedFeatures(this,a,b,"SubtypeGroupLayer")}async queryRelatedFeaturesCount(a,b){return g.queryRelatedFeaturesCount(this,a,b,"SubtypeGroupLayer")}async save(a){return this._debouncedSaveOperations(q.SaveOperationType.SAVE,
a)}async saveAs(a,b){return this._debouncedSaveOperations(q.SaveOperationType.SAVE_AS,b,a)}write(a,b){const {origin:c,layerContainerType:k,messages:e}=b;if(this.isTable){if("web-scene"===c||"web-map"===c&&"tables"!==k)return e?.push(y(this,"using a table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&"web-map"===c&&"tables"===k)return e?.push(y(this,"using a non-table source cannot be written to tables in web maps")),null;return this.sublayers?.length?super.write(a,
b):(e?.push(new l("web-document-write:invalid-property",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' has invalid value for 'sublayers' property. 'sublayers' collection should contain at least one sublayer`,{layer:this})),null)}serviceSupportsSpatialReference(a){return this.loaded?V.serviceSupportsSpatialReference(this,a):!1}_getLayerDomain(a){return(a=this.fieldsIndex.get(a))?a.domain:null}async _initLayerProperties(a){this._set("source",a);({sourceJSON:a}=a);a&&(this.sourceJSON=
a,this.read(a,{origin:"service",url:this.parsedUrl}));if(!this.subtypes?.length)throw new l("subtype-grouplayer:missing-subtypes","SubtypeGroupLayer must be created using a layer with subtypes");this._verifyFields();T.fixTimeInfoFields(this.timeInfo,this.fieldsIndex)}async hasDataChanged(){return g.hasDataChanged(this)}_verifyFields(){const a=this.parsedUrl?.path??"undefined";this.objectIdField||console.log("SubtypeGroupLayer: 'objectIdField' property is not defined (url: "+a+")");this.isTable||-1!==
a.search(/\/FeatureServer\//i)||this.fields?.some(b=>"geometry"===b.type)||console.log("SubtypeGroupLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+a+")")}_handleSublayersChange(a,b){b&&(b.forEach(c=>{c.parent=null}),this.removeHandles("sublayers-owner"),this._sublayerLookup.clear());a&&(a.forEach(c=>{c.parent=this;this._sublayerLookup.set(c.subtypeCode,c)}),this.addHandles([a.on("after-add",({item:c})=>
{c.parent=this;this._sublayerLookup.set(c.subtypeCode,c)}),a.on("after-remove",({item:c})=>{c.parent=null;this._sublayerLookup.delete(c.subtypeCode)})],"sublayers-owner"))}};f.__decorate([h.property({readOnly:!0})],d.prototype,"createQueryVersion",null);f.__decorate([h.property({readOnly:!0})],d.prototype,"editingEnabled",null);f.__decorate([h.property({readOnly:!0})],d.prototype,"effectiveEditingEnabled",null);f.__decorate([h.property({...n.fields,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],
d.prototype,"fields",void 0);f.__decorate([h.property(n.fieldsIndex)],d.prototype,"fieldsIndex",void 0);f.__decorate([h.property(R.id)],d.prototype,"id",void 0);f.__decorate([h.property({type:["show","hide","hide-children"],json:{origins:{"portal-item":{read:!1,write:!1}}}})],d.prototype,"listMode",void 0);f.__decorate([h.property({value:"SubtypeGroupLayer",type:["SubtypeGroupLayer"],json:{origins:{"portal-item":{name:"layerType",write:{enabled:!0,ignoreOrigin:!0}}}}})],d.prototype,"operationalLayerType",
void 0);f.__decorate([h.property(n.outFields)],d.prototype,"outFields",void 0);f.__decorate([h.property({readOnly:!0})],d.prototype,"parsedUrl",null);f.__decorate([h.property({clonable:!1})],d.prototype,"source",null);f.__decorate([h.property({type:r.ofType(p),json:{origins:{service:{read:{source:"subtypes",reader(a,b,c){let k=null;if(this.useUniqueColorsForSublayers){const e=x.getSymbolWithColorSupport(b,c);k=e?x.createSimpleRenderersWithUniqueColors(a.length,e):null}a=a.map(({code:e},m)=>{e=new p({subtypeCode:e});
e.read(b,c);(m=k?.[m])&&e.read({drawingInfo:{renderer:m.toJSON()}},c);return e});return new (r.ofType(p))(a)}}}},name:"layers",write:{ignoreOrigin:!0}}})],d.prototype,"sublayers",void 0);f.__decorate([h.property()],d.prototype,"useUniqueColorsForSublayers",void 0);f.__decorate([h.property({type:U})],d.prototype,"timeInfo",void 0);f.__decorate([h.property({json:{origins:{"portal-item":{write:{enabled:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}}}})],d.prototype,"title",void 0);f.__decorate([C.reader("service",
"title",["name"])],d.prototype,"readTitleFromService",null);f.__decorate([h.property({json:{read:!1}})],d.prototype,"type",void 0);return d=f.__decorate([D.subclass("esri.layers.SubtypeGroupLayer")],d)});