// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../core/Collection ../../core/handleUtils ../../core/LRUCache ../../core/MapUtils ../../core/MultiOriginJSONSupport ../../core/ReactiveMap ../../core/reactiveUtils ../../core/signal ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/RandomLCG ../../core/has ../../core/accessorSupport/decorators/subclass ../Layer ../mixins/BlendLayer ../mixins/ScaleRangeLayer ../support/commonProperties ../support/OrderByInfo ../../statistics/utils".split(" "),
function(d,r,l,t,m,b,u,v,w,e,x,E,F,y,z,A,B,n,C,p){b=class extends B.ScaleRangeLayer(A.BlendLayer(b.MultiOriginJSONMixin(z))){constructor(a){super(a);this._layerCache=new t.LRUCache(20,c=>c.destroy());this._oidToReference=new u;this._layerToReference=new Map;this.legendEnabled=!0;this.layers=new r;this.maximumVisibleSublayers=10;this.opacity=1;this.parent=null;this.persistenceEnabled=!0;this.title="Layers in view";this.type="catalog-dynamic-group";this.visible=!0}initialize(){this.addHandles([this.layers.on("after-add",
({item:a})=>{a.parent=this}),this.layers.on("after-remove",({item:a})=>{a.parent=null}),v.watch(()=>this._orderBy,()=>{this._updateLayerSortValues();this._sortAllLayers()})])}load(a){this.addResolvingPromise(this.parent.load());return Promise.resolve(this)}destroy(){this._layerCache.destroy();this._oidToReference.clear();this._layerToReference.clear()}get _orderBy(){return this.parent?this.parent.orderBy?.find(a=>!a.valueExpression&&a.field)??new C({field:this.parent.objectIdField}):null}get _referenceComparator(){const a=
this._orderBy;if(!this.parent||!a)return()=>0;const c=this.parent.fieldsIndex.get(a.field),g=p.getAttributeComparator(c?.toJSON().type,"descending"===a.order),h=p.getAttributeComparator("esriFieldTypeOID","descending"===a.order);return(k,f)=>g(f.sortValue,k.sortValue)||h(f.objectId,k.objectId)}get fullExtent(){return this.parent?.fullExtent??null}get updating(){return m.someMap(this._oidToReference,({pending:a})=>null!=a)}acquireLayer(a){if(this.destroyed)return l.makeHandle();const c=this._getLayerReference(a);
c.count++;return l.makeHandle(()=>{c.count--;c.count||this._destroyLayerReference(c)})}_getLayerReference(a){const c=a.getObjectId();return m.getOrCreateMapValue(this._oidToReference,c,()=>{var g=a.getObjectId();const h=`${g}`,k=a.getAttribute(this.parent.itemSourceField),f=new D(a,g,k);if(g=this._layerCache.pop(h))return this._addLayer(f,g),f;f.pending=this.parent.createLayerFromFootprint(a).then(q=>{f.count?this._addLayer(f,q):(this.destroyed||this._layerCache.get(h)||this._layerCache.put(h,q),
f.layer=null)}).catch(()=>{}).finally(()=>{f.pending=null});return f})}_destroyLayerReference(a){a.layer&&(this._layerToReference.delete(a.layer),this.layers.remove(a.layer),this.destroyed?a.layer.destroy():this._layerCache.put(`${a.objectId}`,a.layer),a.layer=null);this._oidToReference.delete(a.objectId)}_addLayer(a,c){a.layer=c;c.persistenceEnabled=!1;this._layerToReference.set(c,a);this._updateLayerSortValue(a);this.layers.add(c);this._sortAllLayers()}_updateLayerSortValues(){for(const a of this._layerToReference.values())this._updateLayerSortValue(a)}_updateLayerSortValue(a){this._orderBy&&
(a.sortValue=a.footprint.getAttribute(this._orderBy.field))}_sortAllLayers(){this.layers.sort((a,c)=>this._referenceComparator(this._layerToReference.get(a),this._layerToReference.get(c)))}};d.__decorate([e.property()],b.prototype,"_orderBy",null);d.__decorate([e.property({readOnly:!0})],b.prototype,"_referenceComparator",null);d.__decorate([e.property(n.legendEnabled)],b.prototype,"legendEnabled",void 0);d.__decorate([e.property({type:["show","hide","hide-children"],json:{write:!0}})],b.prototype,
"listMode",void 0);d.__decorate([e.property({readOnly:!0})],b.prototype,"fullExtent",null);d.__decorate([e.property({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],b.prototype,"id",void 0);d.__decorate([e.property({readOnly:!0})],b.prototype,"layers",void 0);d.__decorate([e.property({type:x.Integer,range:{min:0,max:50},json:{write:!0,default:10}})],b.prototype,"maximumVisibleSublayers",void 0);d.__decorate([e.property(n.opacity)],b.prototype,"opacity",
void 0);d.__decorate([e.property({clonable:!1})],b.prototype,"parent",void 0);d.__decorate([e.property({type:String,nonNullable:!0,json:{write:{ignoreOrigin:!0,isRequired:!0}}})],b.prototype,"title",void 0);d.__decorate([e.property({json:{read:!1}})],b.prototype,"type",void 0);d.__decorate([e.property({readOnly:!0})],b.prototype,"updating",null);d.__decorate([e.property({type:Boolean,json:{name:"visibility",write:!0}})],b.prototype,"visible",void 0);b=d.__decorate([y.subclass("esri.layers.catalog.CatalogDynamicGroupLayer")],
b);class D{constructor(a,c,g){this.footprint=a;this.objectId=c;this.itemSource=g;this.count=0;this.layer=null;this.sortValue=void 0;this._pending=w.signal(null)}get pending(){return this._pending.value}set pending(a){this._pending.value=a}}return b});