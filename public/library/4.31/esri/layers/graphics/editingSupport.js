// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../Graphic ../../core/Collection ../../core/Error ../../core/lang ../../core/Logger ../../core/promiseUtils ../../core/urlUtils ../../core/uuid ../../geometry/support/normalizeUtils ../../geometry/support/spatialReferenceUtils ../mixins/EditBusLayer ../support/fieldUtils ../support/infoFor3D ../support/layerUtils".split(" "),function(l,D,E,g,F,G,H,I,J,K,p,u,L,M,q){function v(a){return"object"===typeof a&&null!=a&&"objectId"in a&&!!a.objectId}function w(a){return"object"===typeof a&&
null!=a&&"globalId"in a&&!!a.globalId}async function N(a,b,e,d){await a.load();if(null==b?.applyEdits)throw new g(`${a.type}-layer:no-editing-support`,"Layer source does not support applyEdits capability",{layer:a});if(!q.getEffectiveEditingEnabled(a))throw new g(`${a.type}-layer:editing-disabled`,"Editing is disabled for layer",{layer:a});const {edits:f,options:c}=await O(a,e,d);return f.addFeatures?.length||f.updateFeatures?.length||f.deleteFeatures?.length||f.addAttachments?.length||f.updateAttachments?.length||
f.deleteAttachments?.length?{edits:f,results:await b.applyEdits(f,c)}:{edits:f,results:{addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}}async function O(a,b,e){const d=q.getEffectiveLayerCapabilities(a),f=null!=a.infoFor3D;x(b,d,e,!(!b||!(b.addFeatures||b.updateFeatures||b.deleteFeatures)),!(!b||!(b.addAttachments||b.updateAttachments||b.deleteAttachments)),`${a.type}-layer`);if(!d.data.isVersioned&&
e?.gdbVersion)throw new g(`${a.type}-layer:invalid-parameter`,"'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'");if(!d.editing.supportsRollbackOnFailure&&e?.rollbackOnFailureEnabled)throw new g(`${a.type}-layer:invalid-parameter`,"This layer does not support 'rollbackOnFailureEnabled' parameter. See: 'capabilities.editing.supportsRollbackOnFailure'");const c={...e};null!=c.rollbackOnFailureEnabled||d.editing.supportsRollbackOnFailure||(c.rollbackOnFailureEnabled=
!0);c.rollbackOnFailureEnabled||"original-and-current-features"!==c.returnServiceEditsOption||(!1===c.rollbackOnFailureEnabled&&G.getLogger("esri.layers.graphics.editingSupport").warn(`${a.type}-layer:invalid-parameter`,"'original-and-current-features' is valid for 'returnServiceEditsOption' only when 'rollBackOnFailure' is true, but 'rollBackOnFailure' was set to false. 'rollBackOnFailure' has been overwritten and set to true."),c.rollbackOnFailureEnabled=!0);if(!d.editing.supportsReturnServiceEditsInSourceSpatialReference&&
c.returnServiceEditsInSourceSR)throw new g(`${a.type}-layer:invalid-parameter`,"This layer does not support 'returnServiceEditsInSourceSR' parameter. See: 'capabilities.editing.supportsReturnServiceEditsInSourceSpatialReference'");if(c.returnServiceEditsInSourceSR&&"original-and-current-features"!==c.returnServiceEditsOption)throw new g(`${a.type}-layer:invalid-parameter`,"'returnServiceEditsInSourceSR' is valid only when 'returnServiceEditsOption' is set to 'original-and-current-features'");b=y(b,
d,`${a.type}-layer`);const k=e?.globalIdUsed||f,m=a.fields.filter(h=>"big-integer"===h.type||"oid"===h.type&&8<=(h.length||0));if(k){const {globalIdField:h}=a;if(null==h)throw new g(`${a.type}-layer:invalid-parameter`,"Layer does not specify a global id field.");b.addFeatures.forEach(n=>{({attributes:n}=n);null==n[h]&&(n[h]=J.generateBracedUUID())})}b.addFeatures.forEach(h=>{r(h,a,k,m);z(h,a)});b.updateFeatures.forEach(h=>{r(h,a,k,m);z(h,a);const n=q.getEffectiveLayerCapabilities(a);if("geometry"in
h&&null!=h.geometry&&!n?.editing.supportsGeometryUpdate)throw new g(`${a.type}-layer:unsupported-operation`,"Layer does not support geometry updates.");});b.deleteFeatures.forEach(h=>{r(h,a,k,m)});b.addAttachments.forEach(h=>A(h,a));b.updateAttachments.forEach(h=>A(h,a));f&&await P(b,a);return{edits:await B(b),options:c}}function r(a,b,e,d){if(e){if("attributes"in a&&!a.attributes[b.globalIdField])throw new g(`${b.type}-layer:invalid-parameter`,`Feature should have '${b.globalIdField}' when 'globalIdUsed' is true`);
if(!("attributes"in a||a.globalId))throw new g(`${b.type}-layer:invalid-parameter`,"`'globalId' of the feature should be passed when 'globalIdUsed' is true");}if(d.length&&"attributes"in a)for(const f of d)if(e=a.attributes[f.name],void 0!==e&&!L.isValidFieldValue(f,e))throw new g(`${b.type}-layer:invalid-parameter`,`Big-integer field '${f.name}' of the feature must be less than ${Number.MAX_SAFE_INTEGER}`,{feature:a});if("geometry"in a&&null!=a.geometry){if(a.geometry.hasZ&&!1===b.capabilities?.data.supportsZ)throw new g(`${b.type}-layer:z-unsupported`,
"Layer does not support z values while feature has z values.");if(a.geometry.hasM&&!1===b.capabilities?.data.supportsM)throw new g(`${b.type}-layer:m-unsupported`,"Layer does not support m values while feature has m values.");}}function z(a,b){if("geometry"in a&&"mesh"===a.geometry?.type&&null!=b.infoFor3D&&null!=b.spatialReference){({geometry:a}=a);const {spatialReference:e,vertexSpace:d}=a;a=b.spatialReference;const f="local"===d.type,c=p.isGeographic(a),k=p.equals(a,e),m=k||p.isWGS84(a)&&(p.isWGS84(e)||
p.isWebMercator(e));if(!(f&&c&&m||!f&&!c&&k))throw new g(`${b.type}-layer:mesh-unsupported`,`Uploading a mesh with a ${d.type} vertex space and a spatial reference wkid:${e.wkid} to a layer with a spatial reference wkid:${a.wkid} is not supported.`);}}function A(a,b){const {feature:e,attachment:d}=a;if(!e||"attributes"in e&&!e.attributes[b.globalIdField])throw new g(`${b.type}-layer:invalid-parameter`,"Attachment should have reference to a feature with 'globalId'");if(!("attributes"in e||e.globalId))throw new g(`${b.type}-layer:invalid-parameter`,
"Attachment should have reference to 'globalId' of the parent feature");if(!d.globalId)throw new g(`${b.type}-layer:invalid-parameter`,"Attachment should have 'globalId'");if(!d.data&&!d.uploadId)throw new g(`${b.type}-layer:invalid-parameter`,"Attachment should have 'data' or 'uploadId'");if(!(d.data instanceof File&&d.data.name||d.name))throw new g(`${b.type}-layer:invalid-parameter`,"'name' is required when attachment is specified as Base64 encoded string using 'data'");if(!b.capabilities?.editing.supportsUploadWithItemId&&
d.uploadId)throw new g(`${b.type}-layer:invalid-parameter`,"This layer does not support 'uploadId' parameter. See: 'capabilities.editing.supportsUploadWithItemId'");if("string"===typeof d.data&&(a=I.dataComponents(d.data))&&!a.isBase64)throw new g(`${b.type}-layer:invalid-parameter`,"Attachment 'data' should be a Blob, File or Base64 encoded string");}async function B(a){const b=a.addFeatures??[],e=a.updateFeatures??[];var d=b.concat(e).map(k=>k.geometry);d=await K.normalizeCentralMeridian(d);const f=
b.length,c=e.length;d.slice(0,f).forEach((k,m)=>b[m].geometry=k);d.slice(f,f+c).forEach((k,m)=>e[m].geometry=k);return a}function C(a){return{addFeatures:Array.from(a?.addFeatures??[]),updateFeatures:Array.from(a?.updateFeatures??[]),deleteFeatures:a&&E.isCollection(a.deleteFeatures)?a.deleteFeatures.toArray():a.deleteFeatures||[],addAttachments:a.addAttachments||[],updateAttachments:a.updateAttachments||[],deleteAttachments:a.deleteAttachments||[]}}function y(a,b,e){a=C(a);if(a.addFeatures?.length&&
!b.operations.supportsAdd)throw new g(`${e}:unsupported-operation`,"Layer does not support adding features.");if(a.updateFeatures?.length&&!b.operations.supportsUpdate)throw new g(`${e}:unsupported-operation`,"Layer does not support updating features.");if(a.deleteFeatures?.length&&!b.operations.supportsDelete)throw new g(`${e}:unsupported-operation`,"Layer does not support deleting features.");a.addFeatures=a.addFeatures.map(t);a.updateFeatures=a.updateFeatures.map(t);a.addAssetFeatures=[];return a}
function x(a,b,e,d,f,c){if(!a||!d&&!f)throw new g(`${c}:missing-parameters`,"'addFeatures', 'updateFeatures', 'deleteFeatures', 'addAttachments', 'updateAttachments' or 'deleteAttachments' parameter is required");if(!b.editing.supportsGlobalId&&e?.globalIdUsed)throw new g(`${c}:invalid-parameter`,"This layer does not support 'globalIdUsed' parameter. See: 'capabilities.editing.supportsGlobalId'");if(!b.editing.supportsGlobalId&&f)throw new g(`${c}:invalid-parameter`,"'addAttachments', 'updateAttachments' and 'deleteAttachments' are applicable only if the layer supports global ids. See: 'capabilities.editing.supportsGlobalId'");
if(!e?.globalIdUsed&&f)throw new g(`${c}:invalid-parameter`,"When 'addAttachments', 'updateAttachments' or 'deleteAttachments' is specified, globalIdUsed should be set to true");}function t(a){const b=new D;a.attributes||(a.attributes={});b.geometry=a.geometry;b.attributes=a.attributes;return b}async function P(a,b){const {infoFor3D:e}=b;if(null!=e){if(!M.isGlbSupportedEditFormat(e))throw new g(`${b.type}-layer:binary-gltf-asset-not-supported`,"3DObjectFeatureLayer requires binary glTF (.glb) support for updating mesh geometry.");
a.addAssetFeatures??(a.addAssetFeatures=[]);({addAssetFeatures:b}=a);for(const d of a.addFeatures??[])"mesh"===d?.geometry?.type&&b.push(d);for(const d of a.updateFeatures??[])"mesh"===d?.geometry?.type&&b.push(d)}}l.applyEdits=async function(a,b,e,d={}){var f="gdbVersion"in a?a.gdbVersion:null;f=d.gdbVersion??f;u.isEditBusLayer(a)&&a.url?f=u.emitApplyEditsEvent(a.url,a.layerId,f,"original-and-current-features"===d.returnServiceEditsOption):(f=H.createResolver(),f.promise.then(c=>{(c.addedFeatures.length||
c.updatedFeatures.length||c.deletedFeatures.length||c.addedAttachments.length||c.updatedAttachments.length||c.deletedAttachments.length)&&a.emit("edits",c)}),a.emit("apply-edits",{result:f.promise}));try{const {results:c,edits:k}=await N(a,b,e,d);b=h=>h.filter(n=>!n.error).map(F.clone);const m={edits:k,addedFeatures:b(c.addFeatureResults),updatedFeatures:b(c.updateFeatureResults),deletedFeatures:b(c.deleteFeatureResults),addedAttachments:b(c.addAttachmentResults),updatedAttachments:b(c.updateAttachmentResults),
deletedAttachments:b(c.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:c.editMoment?new Date(c.editMoment):null,globalIdToObjectId:d.globalIdToObjectId};c.editedFeatureResults?.length&&(m.editedFeatures=c.editedFeatureResults);f.resolve(m);return c}catch(c){throw f.reject(c),c;}};l.checkEditingCapabilities=x;l.isFeatureIdentifierArrayWithGlobalId=function(a){return a.every(w)};l.isFeatureIdentifierArrayWithObjectId=function(a){return a.every(v)};l.isFeatureIdentifierWithGlobalId=
w;l.isFeatureIdentifierWithObjectId=v;l.normalizeCollections=C;l.normalizeEdits=y;l.normalizeGeometries=B;l.shallowCloneFeature=t;l.uploadAssets=function(a,b,e,d){if(null==b?.applyEdits)throw new g(`${a.type}-layer:no-editing-support`,"Layer source does not support applyEdits capability",{layer:a});if(!b.uploadAssets)throw new g(`${a.type}-layer:no-asset-upload-support`,"Layer source does not support uploadAssets capability",{layer:a});return b.uploadAssets(e,d)};Object.defineProperty(l,Symbol.toStringTag,
{value:"Module"})});