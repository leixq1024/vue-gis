// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../core/arrayUtils ../../../core/Error ../../../core/JSONSupport ../../../core/lang ../../../core/maybe ../../../core/promiseUtils ../../../core/unitUtils ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../geometry/support/normalizeUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./attributeSupport ./geometryUtils ./projectionSupport ./QueryEngineCache ./QueryEngineCapabilities ./QueryEngineResult ./queryUtils ./queryValidationUtils ./spatialQuerySupport ./timeSupport ../../support/FieldsIndex ../../../views/support/Scheduler".split(" "),
function(D,M,R,S,E,F,p,G,T,B,H,U,C,N,q,V,W,I,y,X,Y,n,t,J,z,O,Z,P){function K(a){if(z.canQueryWithRBush(a)){if(C.isExtent(a))return[H.fromValues(Math.min(a.xmin,a.xmax),Math.min(a.ymin,a.ymax),Math.max(a.xmin,a.xmax),Math.max(a.ymin,a.ymax))];if(C.isPolygon(a))return a.rings.map(b=>H.fromValues(Math.min(b[0][0],b[2][0]),Math.min(b[0][1],b[2][1]),Math.max(b[0][0],b[2][0]),Math.max(b[0][1],b[2][1])))}return[U.getBoundsXY(H.create(),a)]}class aa{constructor(a,b=null,c,d,e){this.attributes=a;this.geometry=
c;this.centroid=d;this.filterFlags=e;this.groupId=-1;this.displayId=b}}class ba{constructor(a){this._cache=new X.QueryEngineCache;this._changeHandle=null;this.capabilities={query:Y.queryCapabilities};this.geometryType=a.geometryType;this.hasM=!!a.hasM;this.hasZ=!!a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.featureStore=a.featureStore;this.aggregateAdapter=a.aggregateAdapter;this._changeHandle=this.featureStore.events.on("changed",
()=>this.clearCache());this.timeInfo=a.timeInfo;this.fieldsIndex=S.isSerializable(a.fieldsIndex)?a.fieldsIndex:Z.fromJSON(a.fieldsIndex);this.availableFields=!a.availableFields||1===a.availableFields.length&&"*"===a.availableFields[0]?new Set(this.fieldsIndex.fields.map(b=>b.name)):new Set(a.availableFields.map(b=>this.fieldsIndex.get(b)?.name).filter(b=>null!=b));a.scheduler&&a.priority&&(this._frameTask=a.scheduler.registerTask(a.priority))}destroy(){this._frameTask=F.removeMaybe(this._frameTask);
this.clearCache();F.destroyMaybe(this._cache);this._changeHandle=F.removeMaybe(this._changeHandle)}get featureAdapter(){return this.featureStore.featureAdapter}clearCache(){this._cache.clear();this._fullExtentPromise=this._timeExtentPromise=this._allFeaturesPromise=null}async executeQuery(a,b){b=p.signalFromSignalOrOptions(b);try{return await (await this._executeQuery(a,{},b)).createQueryResponse()}catch(c){if(c!==t.queryEngineEmptyResult)throw c;return(new n.QueryEngineResult([],a,this)).createQueryResponse()}}async executeQueryForCount(a=
{},b){b=p.signalFromSignalOrOptions(b);try{return(await this._executeQuery(a,{returnGeometry:!1,returnCentroid:!1,outSR:null},b)).createQueryResponseForCount()}catch(c){if(c!==t.queryEngineEmptyResult)throw c;return 0}}async executeQueryForExtent(a,b){b=p.signalFromSignalOrOptions(b);const c=a.outSR;try{const d=await this._executeQuery(a,{returnGeometry:!0,returnCentroid:!1,outSR:null},b),e=d.size;if(!e)return{count:0,extent:null};const f=await this._getBounds(d.items,d.spatialReference,c||this.spatialReference);
return{count:e,extent:f}}catch(d){if(d===t.queryEngineEmptyResult)return{count:0,extent:null};throw d;}}async executeQueryForIds(a,b){return this.executeQueryForIdSet(a,b).then(c=>Array.from(c))}async executeQueryForIdSet(a,b){b=p.signalFromSignalOrOptions(b);try{const c=await this._executeQuery(a,{returnGeometry:!0,returnCentroid:!1,outSR:null},b),d=c.items,e=new Set;await this._reschedule(()=>{for(const f of d)e.add(c.featureAdapter.getObjectId(f))},b);return e}catch(c){if(c===t.queryEngineEmptyResult)return new Set;
throw c;}}async executeQueryForSnapping(a,b){const c=p.signalFromSignalOrOptions(b),{point:d,distance:e,returnEdge:f,vertexMode:h}=a;if(!f&&"none"===h)return{candidates:[]};let l=E.clone(a.query);l=await this._schedule(()=>t.normalizeQueryLike(l,this.definitionExpression,this.spatialReference),c);l=await this._reschedule(()=>J.validateQuery(l,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),c);(b=!q.equals(d.spatialReference,
this.spatialReference))&&await y.checkProjectionSupport(d.spatialReference,this.spatialReference);var g="number"===typeof e?e:e.x,k="number"===typeof e?e:e.y;g={xmin:d.x-g,xmax:d.x+g,ymin:d.y-k,ymax:d.y+k,spatialReference:d.spatialReference};g=b?y.project(g,this.spatialReference):g;if(!g)return{candidates:[]};k=(await N.normalizeCentralMeridian(C.fromJSON(d),null,{signal:c}))[0];const u=(await N.normalizeCentralMeridian(C.fromJSON(g),null,{signal:c}))[0];if(null==k||null==u)return{candidates:[]};
const m=new n.QueryEngineResult(await this._reschedule(()=>this._searchFeatures(K(u.toJSON())),c),l,this);await this._reschedule(()=>this._executeObjectIdsQuery(m),c);await this._reschedule(()=>this._executeTimeQuery(m),c);await this._reschedule(()=>this._executeAttributesQuery(m),c);await this._reschedule(()=>this._executeGeometryQueryForSnapping(m,c),c);k=k.toJSON();k=b?y.project(k,this.spatialReference):k;return m.createSnappingResponse({...a,point:k,distance:b?Math.max(g.xmax-g.xmin,g.ymax-g.ymin)/
2:e},d.spatialReference)}async executeQueryForLatestObservations(a,b){b=p.signalFromSignalOrOptions(b);if(!this.timeInfo?.trackIdField)throw new R("unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:a,timeInfo:this.timeInfo});try{const c=await this._executeQuery(a,{},b);await this._reschedule(()=>this._filterLatest(c),b);return await c.createQueryResponse()}catch(c){if(c!==t.queryEngineEmptyResult)throw c;return(new n.QueryEngineResult([],a,this)).createQueryResponse()}}async executeQueryForSummaryStatistics(a=
{},b,c){c=p.signalFromSignalOrOptions(c);const {field:d,normalizationField:e,valueExpression:f}=b;return(await this._executeQueryForStatistics(a,{field:d,normalizationField:e,valueExpression:f},c)).createSummaryStatisticsResponse(b)}async executeQueryForUniqueValues(a={},b,c){c=p.signalFromSignalOrOptions(c);const {field:d,field2:e,field3:f,valueExpression:h}=b;return(await this._executeQueryForStatistics(a,{field:d,field2:e,field3:f,valueExpression:h},c)).createUniqueValuesResponse(b)}async executeQueryForClassBreaks(a=
{},b,c){c=p.signalFromSignalOrOptions(c);const {field:d,normalizationField:e,valueExpression:f}=b;return(await this._executeQueryForStatistics(a,{field:d,normalizationField:e,valueExpression:f},c)).createClassBreaksResponse(b)}async executeQueryForHistogram(a={},b,c){c=p.signalFromSignalOrOptions(c);const {field:d,normalizationField:e,valueExpression:f}=b;return(await this._executeQueryForStatistics(a,{field:d,normalizationField:e,valueExpression:f},c)).createHistogramResponse(b)}async fetchRecomputedExtents(a){a=
p.signalFromSignalOrOptions(a);this._timeExtentPromise||(this._timeExtentPromise=O.getTimeExtent(this.timeInfo,this.featureStore));const [b,c]=await Promise.all([this._getFullExtent(),this._timeExtentPromise]);p.throwIfAborted(a);return{fullExtent:b,timeExtent:c}}async _getBounds(a,b,c){const d=B.set(B.create(),B.negativeInfinity);await this.featureStore.forEachBounds(a,e=>B.expandWithAABB(d,e));a={xmin:d[0],ymin:d[1],xmax:d[3],ymax:d[4],spatialReference:I.cleanFromGeometryEngine(this.spatialReference)};
this.hasZ&&isFinite(d[2])&&isFinite(d[5])&&(a.zmin=d[2],a.zmax=d[5],a.hasZ=!0);b=y.project(a,b,c);b.spatialReference=I.cleanFromGeometryEngine(c);0===b.xmax-b.xmin&&(c=G.getMetersPerUnitForSR(b.spatialReference),b.xmin-=c,b.xmax+=c);0===b.ymax-b.ymin&&(c=G.getMetersPerUnitForSR(b.spatialReference),b.ymin-=c,b.ymax+=c);this.hasZ&&null!=b.zmin&&null!=b.zmax&&0===b.zmax-b.zmin&&(c=G.getMetersPerUnitForSR(b.spatialReference),b.zmin-=c,b.zmax+=c);return b}_getFullExtent(){this._fullExtentPromise||(this._fullExtentPromise=
"getFullExtent"in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getAllFeatures().then(a=>this._getBounds(a,this.spatialReference,this.spatialReference)));return this._fullExtentPromise}async _schedule(a,b){return null!=this._frameTask?this._frameTask.schedule(a,b):a(P.noBudget)}async _reschedule(a,b){return null!=this._frameTask?this._frameTask.reschedule(a,b):a(P.noBudget)}async _getAllFeaturesQueryEngineResult(a){return new n.QueryEngineResult(await this._getAllFeatures(),
a,this)}async _getAllFeatures(){if(null==this._allFeaturesPromise){const c=[];this._allFeaturesPromise=(async()=>{await this.featureStore.forEach(d=>c.push(d))})().then(()=>c)}const a=this._allFeaturesPromise,b=await a;return a===this._allFeaturesPromise?b.slice():this._getAllFeatures()}async _executeQuery(a,b,c){a=E.clone(a);a=await this._schedule(()=>t.normalizeQuery(a,this.definitionExpression,this.spatialReference),c);a=await this._reschedule(()=>J.validateQuery(a,{availableFields:this.availableFields,
fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),c);a={...a,...b};const d=await this._reschedule(()=>this._executeSceneFilterQuery(a,c),c),e=await this._reschedule(()=>this._executeGeometryQuery(a,d,c),c);await this._reschedule(()=>this._executeAggregateIdsQuery(e),c);await this._reschedule(()=>this._executeObjectIdsQuery(e),c);await this._reschedule(()=>this._executeTimeQuery(e),c);await this._reschedule(()=>this._executeAttributesQuery(e),c);return e}async _executeSceneFilterQuery(a,
b){if(null==a.sceneFilter)return null;const {outSR:c,returnGeometry:d,returnCentroid:e}=a;var f=this.featureStore.featureSpatialReference,h=a.sceneFilter.geometry;const l=null==f||q.equals(f,h.spatialReference)?h:y.project(h,f);if(!l)return null;f=d||e;f=q.isValid(c)&&!q.equals(this.spatialReference,c)&&f?async m=>this._project(m,c):m=>m;const g=this.featureAdapter;h=await this._reschedule(()=>this._searchFeatures(K(l)),b);if("disjoint"===a.sceneFilter.spatialRelationship){if(!h.length)return null;
const m=new Set;for(var k of h)m.add(g.getObjectId(k));const w=await this._reschedule(()=>this._getAllFeatures(),b);k=await this._reschedule(async()=>{const A=await z.getSpatialQueryOperator("esriSpatialRelDisjoint",l,this.geometryType,this.hasZ,this.hasM),v=await this._runSpatialFilter(w,x=>!m.has(g.getObjectId(x))||A(g.getGeometry(x)),b);return new n.QueryEngineResult(v,a,this)},b);return f(k)}if(!h.length)return new n.QueryEngineResult([],a,this);if(this._canExecuteSinglePass(l,a))return f(new n.QueryEngineResult(h,
a,this));const u=await z.getSpatialQueryOperator("esriSpatialRelContains",l,this.geometryType,this.hasZ,this.hasM);k=await this._runSpatialFilter(h,m=>u(g.getGeometry(m)),b);return f(new n.QueryEngineResult(k,a,this))}async _executeGeometryQuery(a,b,c){if(null!=b&&0===b.items.length)return b;a=null!=b?b.query:a;const {geometry:d,outSR:e,spatialRel:f,returnGeometry:h,returnCentroid:l}=a;var g=this.featureStore.featureSpatialReference;const k=!d||null==g||q.equals(g,d.spatialReference)?d:y.project(d,
g),u=h||l,m=q.isValid(e)&&!q.equals(this.spatialReference,e),w=null==b?this._getCacheKey(a):null;g=w?this._cache.get(w):null;if(null!=g)return new n.QueryEngineResult(g,a,this);g=async r=>{m&&u&&await this._project(r,e);w&&this._cache.put(w,r.items);return r};if(!k)return g(null!=b?b:await this._getAllFeaturesQueryEngineResult(a));const A=this.featureAdapter;let v=await this._reschedule(()=>this._searchFeatures(K(d)),c);if("esriSpatialRelDisjoint"===f){if(!v.length)return g(null!=b?b:await this._getAllFeaturesQueryEngineResult(a));
const r=new Set;for(var x of v)r.add(A.getObjectId(x));const L=null!=b?b.items:await this._reschedule(()=>this._getAllFeatures(),c);x=await this._reschedule(async()=>{const ca=await z.getSpatialQueryOperator(f,k,this.geometryType,this.hasZ,this.hasM),da=await this._runSpatialFilter(L,Q=>!r.has(A.getObjectId(Q))||ca(A.getGeometry(Q)),c);return new n.QueryEngineResult(da,a,this)},c);return g(x)}if(null!=b){const r=new M.PositionHint;v=v.filter(L=>0<=M.indexOf(b.items,L,b.items.length,r))}if(!v.length)return g=
new n.QueryEngineResult([],a,this),w&&this._cache.put(w,g.items),g;if(this._canExecuteSinglePass(k,a))return g(new n.QueryEngineResult(v,a,this));const ea=await z.getSpatialQueryOperator(f,k,this.geometryType,this.hasZ,this.hasM);x=await this._runSpatialFilter(v,r=>ea(A.getGeometry(r)),c);return g(new n.QueryEngineResult(x,a,this))}async _executeGeometryQueryForSnapping(a,b){const {query:c}=a,{spatialRel:d}=c;if(a?.items?.length&&c.geometry&&d){var e=await z.getSpatialQueryOperator(d,c.geometry,this.geometryType,
this.hasZ,this.hasM);b=await this._runSpatialFilter(a.items,f=>e(f.geometry),b);a.items=b}}_executeAggregateIdsQuery(a){if(0!==a.items.length&&a.query.aggregateIds?.length&&null!=this.aggregateAdapter){var b=new Set;for(const d of a.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(d).forEach(e=>b.add(e));var c=this.featureAdapter.getObjectId;a.items=a.items.filter(d=>b.has(c(d)))}}_executeObjectIdsQuery(a){if(0!==a.items.length&&a.query.objectIds?.length){var b=new Set(a.query.objectIds),
c=this.featureAdapter.getObjectId;a.items=a.items.filter(d=>b.has(c(d)))}}_executeTimeQuery(a){if(0!==a.items.length){var b=O.getTimeOperator(this.timeInfo,a.query.timeExtent,this.featureAdapter);null!=b&&(a.items=a.items.filter(b))}}_executeAttributesQuery(a){if(0!==a.items.length){var b=W.getWhereClause(a.query.where,this.fieldsIndex);if(b){if(!b.isStandardized)throw new TypeError("Where clause is not standardized");a.items=a.items.filter(c=>b.testFeature(c,this.featureAdapter))}}}async _runSpatialFilter(a,
b,c){if(!b)return a;if(null==this._frameTask)return a.filter(h=>b(h));let d=0;const e=[],f=async h=>{for(;d<a.length;){const l=a[d++];b(l)&&(e.push(l),h.madeProgress());h.done&&await this._reschedule(g=>f(g),c)}};return this._reschedule(h=>f(h),c).then(()=>e)}_filterLatest(a){const {trackIdField:b,startTimeField:c,endTimeField:d}=this.timeInfo,e=d||c,f=new Map,h=this.featureAdapter.getAttribute;for(const l of a.items){const g=h(l,b),k=h(l,e),u=f.get(g);(!u||k>h(u,e))&&f.set(g,l)}a.items=Array.from(f.values())}_getCacheKey(a){const {geometry:b,
spatialRel:c,returnGeometry:d,returnCentroid:e,outSR:f,resultType:h,cacheHint:l}=a;if("tile"!==h&&!l)return null;a=d||e;return q.isValid(f)&&!q.equals(this.spatialReference,f)&&a?JSON.stringify([b,c,f]):JSON.stringify([b,c])}_canExecuteSinglePass(a,b){({spatialRel:b}=b);return z.canQueryWithRBush(a)&&("esriSpatialRelEnvelopeIntersects"===b||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===b||"esriSpatialRelContains"===b))}async _project(a,b){if(!b||q.equals(this.spatialReference,
b))return a;const c=this.featureAdapter;let d=void 0;try{const e=await this._getFullExtent();d=T.getTransformation(this.spatialReference,b,e)}catch{}b=await y.projectMany(a.items.map(e=>I.getGeometry(this.geometryType,this.hasZ,this.hasM,c.getGeometry(e))),this.spatialReference,b,d);a.items=b.map((e,f)=>c.cloneWithGeometry(a.items[f],V.convertFromGeometry(e,this.hasZ,this.hasM)));return a}async _searchFeatures(a){const b=new Set;await Promise.all(a.map(c=>this.featureStore.forEachInBounds(c,d=>b.add(d))));
a=Array.from(b.values());b.clear();return a}async _executeQueryForStatistics(a,b,c){a=E.clone(a);try{a=await this._schedule(()=>t.normalizeQuery(a,this.definitionExpression,this.spatialReference),c);a=await this._reschedule(()=>J.validateStatisticsQuery(a,b,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),c);const d=await this._reschedule(()=>this._executeSceneFilterQuery(a,c),c),e=await this._reschedule(()=>
this._executeGeometryQuery(a,d,c),c);await this._reschedule(()=>this._executeAggregateIdsQuery(e),c);await this._reschedule(()=>this._executeObjectIdsQuery(e),c);await this._reschedule(()=>this._executeTimeQuery(e),c);await this._reschedule(()=>this._executeAttributesQuery(e),c);return e}catch(d){if(d!==t.queryEngineEmptyResult)throw d;return new n.QueryEngineResult([],a,this)}}}D.Feature=aa;D.QueryEngine=ba;Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});