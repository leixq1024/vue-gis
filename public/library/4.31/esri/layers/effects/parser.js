// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["exports","../../colorUtils","../../core/Error","./effects","./utils"],function(X,P,x,H,Y){function I(c,g,k,n){c=Error.call(this,c);Object.setPrototypeOf&&Object.setPrototypeOf(c,I.prototype);c.expected=g;c.found=k;c.location=n;c.name="SyntaxError";return c}function S(c,g,k){k=k||" ";if(c.length>g)return c;g-=c.length;k+=k.repeat(g);return c+k.slice(0,g)}function za(c,g){function k(l,a){return{type:"literal",text:l,ignoreCase:a}}function n(l,a,e){return{type:"class",parts:l,inverted:a,ignoreCase:e}}
function t(l){return{type:"other",description:l}}function w(l){var a=J[l];if(!a){if(l>=J.length)var e=J.length-1;else for(e=l;!J[--e];);a=J[e];for(a={line:a.line,column:a.column};e<l;)10===c.charCodeAt(e)?(a.line++,a.column=1):a.column++,e++;J[l]=a}return a}function z(l,a,e){e=w(l);var h=w(a);return{source:Aa,start:{offset:l,line:e.line,column:e.column},end:{offset:a,line:h.line,column:h.column}}}function f(l){d<B||(d>B&&(B=d,Q=[]),Q.push(l))}function q(){m++;var l=d;u();if(c.substr(d,4)===Z){var a=
Z;d+=4}else a=b,0===m&&f(Ba);a!==b?(u(),p=l,l=[]):(d=l,l=b);m--;l===b&&0===m&&f(Ca);if(l===b)if(l=[],a=v(),a!==b)for(;a!==b;)l.push(a),a=v();else l=b;return l}function v(){var l=d;u();m++;var a=d;var e=aa();if(e!==b){if(40===c.charCodeAt(d)){var h=Da;d++}else h=b,0===m&&f(Ea);h!==b?(p=a,a=e):(d=a,a=b)}else d=a,a=b;m--;a===b&&(e=b,0===m&&f(Fa));if(a!==b){u();e=d;h=K();if(h!==b){var y=[];var r=d;var M=u();if(44===c.charCodeAt(d)){var D=ba;d++}else D=b,0===m&&f(ca);D===b&&(D=null);var T=u();var N=K();
N!==b?r=M=[M,D,T,N]:(d=r,r=b);for(;r!==b;)y.push(r),r=d,M=u(),44===c.charCodeAt(d)?(D=ba,d++):(D=b,0===m&&f(ca)),D===b&&(D=null),T=u(),N=K(),N!==b?r=M=[M,D,T,N]:(d=r,r=b);p=e;e=0<y.length?[h].concat(Ga(y,3)):[h]}else d=e,e=b;e===b&&(e=null);u();41===c.charCodeAt(d)?(h=Ha,d++):(h=b,0===m&&f(Ia));h!==b?(u(),p=l,l={type:"function",name:a,parameters:e||[]}):(d=l,l=b)}else d=l,l=b;return l}function K(){var l=d;m++;var a=d;u();var e=A();if(e!==b){if(37===c.charCodeAt(d)){var h=Ja;d++}else h=b,0===m&&f(Ka);
h!==b?(p=a,a={value:e,unit:"%"}):(d=a,a=b)}else d=a,a=b;m--;a===b&&0===m&&f(La);a===b&&(m++,a=d,u(),e=A(),e!==b?(c.substr(d,2)===da?(h=da,d+=2):(h=b,0===m&&f(Ma)),h!==b?(p=a,a={value:e,unit:"px"}):(d=a,a=b)):(d=a,a=b),a===b&&(a=d,u(),e=A(),e!==b?(c.substr(d,2)===ea?(h=ea,d+=2):(h=b,0===m&&f(Na)),h!==b?(p=a,a={value:e,unit:"cm"}):(d=a,a=b)):(d=a,a=b),a===b&&(a=d,u(),e=A(),e!==b?(c.substr(d,2)===fa?(h=fa,d+=2):(h=b,0===m&&f(Oa)),h!==b?(p=a,a={value:e,unit:"mm"}):(d=a,a=b)):(d=a,a=b),a===b&&(a=d,u(),
e=A(),e!==b?(c.substr(d,2)===ha?(h=ha,d+=2):(h=b,0===m&&f(Pa)),h!==b?(p=a,a={value:e,unit:"in"}):(d=a,a=b)):(d=a,a=b),a===b&&(a=d,u(),e=A(),e!==b?(c.substr(d,2)===ia?(h=ia,d+=2):(h=b,0===m&&f(Qa)),h!==b?(p=a,a={value:e,unit:"pt"}):(d=a,a=b)):(d=a,a=b),a===b&&(a=d,u(),e=A(),e!==b?(c.substr(d,2)===ja?(h=ja,d+=2):(h=b,0===m&&f(Ra)),h!==b?(p=a,a={value:e,unit:"pc"}):(d=a,a=b)):(d=a,a=b)))))),m--,a===b&&0===m&&f(Sa),a===b&&(m++,a=d,e=A(),e!==b?(c.substr(d,3)===ka?(h=ka,d+=3):(h=b,0===m&&f(Ta)),h!==b?(p=
a,a={value:e,unit:"deg"}):(d=a,a=b)):(d=a,a=b),a===b&&(a=d,e=A(),e!==b?(c.substr(d,3)===la?(h=la,d+=3):(h=b,0===m&&f(Ua)),h!==b?(p=a,a={value:e,unit:"rad"}):(d=a,a=b)):(d=a,a=b),a===b&&(a=d,e=A(),e!==b?(c.substr(d,4)===ma?(h=ma,d+=4):(h=b,0===m&&f(Va)),h!==b?(p=a,a={value:e,unit:"grad"}):(d=a,a=b)):(d=a,a=b),a===b&&(a=d,e=A(),e!==b?(c.substr(d,4)===na?(h=na,d+=4):(h=b,0===m&&f(Wa)),h!==b?(p=a,a={value:e,unit:"turn"}):(d=a,a=b)):(d=a,a=b)))),m--,a===b&&(e=b,0===m&&f(Xa)),a===b&&(m++,a=d,u(),e=A(),
e!==b?(p=a,a={value:e,unit:null}):(d=a,a=b),m--,a===b&&0===m&&f(Ya))));a!==b&&(p=l,a={type:"quantity",value:a.value,unit:a.unit});l=a;if(l===b){l=d;m++;a=d;35===c.charCodeAt(d)?(e=Za,d++):(e=b,0===m&&f($a));if(e!==b){e=[];h=c.charAt(d);oa.test(h)?d++:(h=b,0===m&&f(pa));if(h!==b)for(;h!==b;)e.push(h),h=c.charAt(d),oa.test(h)?d++:(h=b,0===m&&f(pa));else e=b;e!==b?(p=a,a={type:"hex",value:c.substring(p,d)}):(d=a,a=b)}else d=a,a=b;a===b&&(a=d,e=v(),e!==b&&(p=a,e={type:"function",value:e}),a=e,a===b&&
(a=d,e=aa(),e!==b&&(p=a,e={type:"named",value:c.substring(p,d)}),a=e));m--;a===b&&(e=b,0===m&&f(ab));a!==b&&(p=l,a={type:"color",colorType:a.type,value:a.value});l=a}return l}function u(){m++;var l=[];var a=c.charAt(d);qa.test(a)?d++:(a=b,0===m&&f(ra));for(;a!==b;)l.push(a),a=c.charAt(d),qa.test(a)?d++:(a=b,0===m&&f(ra));m--;a=b;0===m&&f(bb);return l}function aa(){m++;var l=d;var a=[];var e=c.charAt(d);sa.test(e)?d++:(e=b,0===m&&f(ta));if(e!==b)for(;e!==b;)a.push(e),e=c.charAt(d),sa.test(e)?d++:(e=
b,0===m&&f(ta));else a=b;a!==b&&(p=l,a=c.substring(p,d));l=a;m--;l===b&&(a=b,0===m&&f(cb));return l}function A(){var l=d;var a=c.charAt(d);ua.test(a)?d++:(a=b,0===m&&f(va));a===b&&(a=null);var e=d;a=[];var h=c.charAt(d);E.test(h)?d++:(h=b,0===m&&f(F));for(;h!==b;)a.push(h),h=c.charAt(d),E.test(h)?d++:(h=b,0===m&&f(F));46===c.charCodeAt(d)?(h=db,d++):(h=b,0===m&&f(eb));if(h!==b){var y=[];var r=c.charAt(d);E.test(r)?d++:(r=b,0===m&&f(F));if(r!==b)for(;r!==b;)y.push(r),r=c.charAt(d),E.test(r)?d++:(r=
b,0===m&&f(F));else y=b;y!==b?e=a=[a,h,y]:(d=e,e=b)}else d=e,e=b;if(e===b)if(e=[],a=c.charAt(d),E.test(a)?d++:(a=b,0===m&&f(F)),a!==b)for(;a!==b;)e.push(a),a=c.charAt(d),E.test(a)?d++:(a=b,0===m&&f(F));else e=b;if(e!==b){a=d;101===c.charCodeAt(d)?(h=fb,d++):(h=b,0===m&&f(gb));if(h!==b){y=c.charAt(d);ua.test(y)?d++:(y=b,0===m&&f(va));y===b&&(y=null);r=[];e=c.charAt(d);E.test(e)?d++:(e=b,0===m&&f(F));if(e!==b)for(;e!==b;)r.push(e),e=c.charAt(d),E.test(e)?d++:(e=b,0===m&&f(F));else r=b;r!==b?a=h=[h,
y,r]:(d=a,a=b)}else d=a,a=b;a===b&&(a=null);p=l;l=parseFloat(c.substring(p,d))}else d=l,l=b;return l}function Ga(l,a){return l.map(function(e){return e[a]})}g=void 0!==g?g:{};var b={},Aa=g.grammarSource,G={start:q},wa=q,Z="none",Ha=")",ba=",",Da="(",Ja="%",da="px",ea="cm",fa="mm",ha="in",ia="pt",ja="pc",ka="deg",la="rad",ma="grad",na="turn",Za="#",db=".",fb="e",qa=/^[ \t\n\r]/,sa=/^[a-z\-]/,oa=/^[0-9a-fA-F]/,ua=/^[+\-]/,E=/^[0-9]/,Ca=t("none"),Ba=k("none",!1),Ia=k(")",!1),ca=k(",",!1),bb=t("whitespace"),
ra=n([" ","\t","\n","\r"],!1,!1),Fa=t("function"),Ea=k("(",!1),cb=t("identifier"),ta=n([["a","z"],"-"],!1,!1),La=t("percentage"),Ka=k("%",!1),Sa=t("length"),Ma=k("px",!1),Na=k("cm",!1),Oa=k("mm",!1),Pa=k("in",!1),Qa=k("pt",!1),Ra=k("pc",!1),Xa=t("angle"),Ta=k("deg",!1),Ua=k("rad",!1),Va=k("grad",!1),Wa=k("turn",!1),Ya=t("number"),ab=t("color"),$a=k("#",!1),pa=n([["0","9"],["a","f"],["A","F"]],!1,!1),va=n(["+","-"],!1,!1),F=n([["0","9"]],!1,!1),eb=k(".",!1),gb=k("e",!1),d=g.peg$currPos|0,p=d,J=[{line:1,
column:1}],B=d,Q=g.peg$maxFailExpected||[],m=g.peg$silentFails|0;if(g.startRule){if(!(g.startRule in G))throw Error("Can't start parsing from rule \""+g.startRule+'".');wa=G[g.startRule]}G=wa();if(g.peg$library)return{peg$result:G,peg$currPos:d,peg$FAILED:b,peg$maxFailExpected:Q,peg$maxFailPos:B};if(G!==b&&d===c.length)return G;G!==b&&d<c.length&&f({type:"end"});throw function(l,a,e){return new I(I.buildMessage(l,a),l,a,e)}(Q,B<c.length?c.charAt(B):null,B<c.length?z(B,B+1):z(B,B));}function xa(c){let g;
if(!c)return[];try{g=za(c)}catch(k){throw new x("effect:invalid-syntax","Invalid effect syntax",{value:c,error:k});}return g.map(k=>hb(k))}function hb(c){try{switch(c.name){case "grayscale":case "sepia":case "saturate":case "invert":case "brightness":case "contrast":var g=1;L(c.parameters,1);1===c.parameters.length&&(g=C(c.parameters[0]));return new H.ColorMatrixEffect(c.name,g);case "opacity":return g=1,L(c.parameters,1),1===c.parameters.length&&(g=C(c.parameters[0])),new H.OpacityEffect(g);case "hue-rotate":g=
0;L(c.parameters,1);if(1===c.parameters.length){var k=c.parameters[0];if("quantity"!==k.type||!(0===k.value&&null===k.unit||k.unit&&null!=U[k.unit]))throw new x("effect:type-error",`Expected <angle>, Actual: ${R(k)}`,{term:k});g=k.value*U[k.unit]||0}return new H.HueRotateEffect(g);case "blur":return g=0,L(c.parameters,1),1===c.parameters.length&&(g=V(c.parameters[0]),O(g,c.parameters[0])),new H.BlurEffect(g);case "drop-shadow":const f=[];let q=null;for(const v of c.parameters)if("color"===v.type){f.length&&
Object.freeze(f);if(q)throw new x("effect:type-error","Accepts only one color",{});a:{k=void 0;var n=v;switch(n.colorType){case "hex":q=P.hex2rgba(n.value);break a;case "named":q=ya(n.value);break a;case "function":g=n.value;L(g.parameters,4);if(ib.test(g.name))k=[C(g.parameters[0]),C(g.parameters[1]),C(g.parameters[2]),g.parameters[3]?C(g.parameters[3]):1];else if(jb.test(g.name)){n=P;var t=n.hsla2rgba,w=g.parameters[0],z=w;if("quantity"!==z.type||null!==z.unit)throw new x("effect:type-error",`Expected <double>, Actual: ${R(z)}`,
{term:z});O(w.value,w);k=t.call(n,w.value,C(g.parameters[1]),C(g.parameters[2]),g.parameters[3]?C(g.parameters[3]):1)}else throw new x("effect:syntax-error",`Invalid color function '${g.name}'`,{colorFunction:g});q=k;break a}q=void 0}}else{const K=V(v);if(Object.isFrozen(f))throw new x("effect:type-error","\x3clength\x3e parameters not consecutive",{lengths:f});f.push(K);3===f.length&&O(K,v)}if(2>f.length||3<f.length)throw new x("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${f.length}}`,
{lengths:f});return new H.DropShadowEffect(f[0],f[1],f[2]||0,q||ya("black"));case "bloom":return g=1,w=t=0,L(c.parameters,3),c.parameters[0]&&(g=C(c.parameters[0])),c.parameters[1]&&(t=V(c.parameters[1]),O(t,c.parameters[1])),c.parameters[2]&&(w=C(c.parameters[2])),new H.BloomEffect(g,t,w)}}catch(f){throw f.details.filter=c,f;}throw new x("effect:unknown-effect",`Effect '${c.name}' is not supported`,{effect:c});}function L(c,g){if(c.length>g)throw new x("effect:type-error",`Function supports up to ${g} parameters, Actual: ${c.length}`,
{parameters:c});}function R(c){if("color"===c.type)return"\x3ccolor\x3e";if(c.unit){if(c.unit in W)return"\x3clength\x3e";if(c.unit in U)return"\x3cangle\x3e";if("%"===c.unit)return"\x3cpercentage\x3e"}return"\x3cdouble\x3e"}function O(c,g){if(0>c)throw new x("effect:type-error",`Negative values are not allowed, Actual: ${c}`,{term:g});}function C(c){if("quantity"!==c.type||null!==c.unit&&"%"!==c.unit)throw new x("effect:type-error",`Expected <double> or <percentage>, Actual: ${R(c)}`,{term:c});const g=
c.value;O(g,c);return"%"===c.unit?.01*g:g}function V(c){if("quantity"!==c.type||!(0===c.value&&null===c.unit||c.unit&&null!=W[c.unit]))throw new x("effect:type-error",`Expected <length>, Actual: ${R(c)}`,{term:c});return c.value*W[c.unit]||0}function ya(c){if(!P.isNamedColor(c))throw new x("effect:unknown-color",`color '${c}' isn't valid`,{namedColor:c});return P.getNamedColorCopy(c)}(function(c,g){function k(){this.constructor=c}k.prototype=g.prototype;c.prototype=new k})(I,Error);I.prototype.format=
function(c){var g="Error: "+this.message;if(this.location){var k=null,n;for(n=0;n<c.length;n++)if(c[n].source===this.location.source){k=c[n].text.split(/\r\n|\n|\r/g);break}c=this.location.start;n=this.location.source&&"function"===typeof this.location.source.offset?this.location.source.offset(c):c;var t=this.location.source+":"+n.line+":"+n.column;if(k){var w=this.location.end,z=S("",n.line.toString().length," ");k=k[c.line-1];w=(c.line===w.line?w.column:k.length+1)-c.column||1;g+="\n --\x3e "+t+
"\n"+z+" |\n"+n.line+" | "+k+"\n"+z+" | "+S("",c.column-1," ")+S("",w,"^")}else g+="\n at "+t}return g};I.buildMessage=function(c,g){function k(f){return f.charCodeAt(0).toString(16).toUpperCase()}function n(f){return f.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(q){return"\\x0"+k(q)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(q){return"\\x"+k(q)})}function t(f){return f.replace(/\\/g,
"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(q){return"\\x0"+k(q)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(q){return"\\x"+k(q)})}function w(f){return z[f.type](f)}var z={literal:function(f){return'"'+n(f.text)+'"'},class:function(f){var q=f.parts.map(function(v){return Array.isArray(v)?t(v[0])+"-"+t(v[1]):t(v)});return"["+(f.inverted?"^":"")+q.join("")+"]"},
any:function(){return"any character"},end:function(){return"end of input"},other:function(f){return f.description}};return"Expected "+function(f){f=f.map(w);var q,v;f.sort();if(0<f.length){for(v=q=1;q<f.length;q++)f[q-1]!==f[q]&&(f[v]=f[q],v++);f.length=v}switch(f.length){case 1:return f[0];case 2:return f[0]+" or "+f[1];default:return f.slice(0,-1).join(", ")+", or "+f[f.length-1]}}(c)+" but "+(g?'"'+n(g)+'"':"end of input")+" found."};const U={deg:1,grad:.9,rad:180/Math.PI,turn:360},W={px:1,cm:96/
2.54,mm:96/2.54/10,in:96,pc:16,pt:96/72},ib=/^rgba?/i,jb=/^hsla?/i;X.parse=function(c){if(!c||0===c.length)return null;if("string"===typeof c)return(c=xa(c))&&0!==c.length?c:null;c=c.map(g=>{if(!Number.isFinite(g.scale)||0>=g.scale)throw new x("effect:invalid-scale","scale must be finite and greater than 0",{stop:g});return{scale:g.scale,effects:xa(g.value)}});c.sort((g,k)=>k.effects.length-g.effects.length);for(let g=0;g<c.length-1;g++){if(!Y.canInterpolateEffects(c[g].effects,c[g+1].effects))throw new x("effect:interpolation-impossible",
"Cannot interpolate by scale between 2 lists of mixed effects",{a:c[g].effects,b:c[g+1].effects});Y.normalizeEffects(c[g].effects,c[g+1].effects)}c.sort((g,k)=>k.scale-g.scale);return c};Object.defineProperty(X,Symbol.toStringTag,{value:"Module"})});