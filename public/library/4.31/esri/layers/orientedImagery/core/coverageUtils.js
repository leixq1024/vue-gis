// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../../geometry ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../core/libs/gl-matrix-2/math/mat3 ../../../chunks/vec32 ../../../geometry/Circle ../../../geometry/Mesh ../../../geometry/projection ../../../geometry/support/Ellipsoid ../../../geometry/support/MeshComponent ../../../geometry/support/MeshVertexAttributes ../../../geometry/support/plane ../../../geometry/support/spatialReferenceUtils ../transformations/utils ../../../geometry/Polygon ../../../geometry/SpatialReference ../../../geometry/Multipoint".split(" "),
function(E,la,X,Y,p,Z,r,M,L,aa,ba,ca,N,K,da,l,O,Q,ea){function fa(a,b,c,g,d,f,e,m,h,n,k=0,q=0){a=Z.transpose(Y.create(),l.createRotationMatrixFromHPR([a,b,k??0]));const {cameraHeight:u,cameraPitch:x,farDistance:y,location:w,horizontalFieldOfView:F,nearDistance:z,verticalFieldOfView:G}={cameraHeight:c,cameraPitch:b,farDistance:d,location:g,horizontalFieldOfView:m,nearDistance:q,verticalFieldOfView:e};b=R(w);var A=!1===90<=x+G/2;q=2*Math.tan(G*v/2)*z;k=2*Math.tan(F*v/2)*z;const H=2*Math.tan(G*v/2)*
y,I=2*Math.tan(F*v/2)*y;let J;var D=[0,0,-1];D=l.transformMat3(D,a);J=l.scaleAndAddWithFactor([w.x,w.y,u],D,y,b);A&&(J[2]=0);D=l.scaleAndAddWithFactor([w.x,w.y,u],D,z,b);let B=[0,1,0];B=l.transformMat3(B,a);let C=[1,0,0];C=l.transformMat3(C,a);let t=[];A=[];z?(A=[{faces:[4,0,3,4,7,3]},{faces:[5,1,2,5,6,2]},{faces:[4,0,1,4,5,1]},{faces:[6,2,3,6,7,3]}],t=t.concat(r.add(p.zeros(),D,r.sub(p.zeros(),l.scaleWithFactor(B,q/2,b),l.scaleWithFactor(C,k/2,b)))),t=t.concat(r.add(p.zeros(),D,r.add(p.zeros(),l.scaleWithFactor(B,
q/2,b),l.scaleWithFactor(C,k/2,b)))),t=t.concat(r.sub(p.zeros(),D,r.sub(p.zeros(),l.scaleWithFactor(B,q/2,b),l.scaleWithFactor(C,k/2,b)))),t=t.concat(r.sub(p.zeros(),D,r.add(p.zeros(),l.scaleWithFactor(B,q/2,b),l.scaleWithFactor(C,k/2,b))))):(t=[w.x,w.y,u],A=[{faces:[0,1,2,0,2,3,0,3,4,0,4,1]}]);t=t.concat(r.add(p.zeros(),J,r.sub(p.zeros(),l.scaleWithFactor(B,H/2,b),l.scaleWithFactor(C,I/2,b))));t=t.concat(r.add(p.zeros(),J,r.add(p.zeros(),l.scaleWithFactor(B,H/2,b),l.scaleWithFactor(C,I/2,b))));t=
t.concat(r.sub(p.zeros(),J,r.sub(p.zeros(),l.scaleWithFactor(B,H/2,b),l.scaleWithFactor(C,I/2,b))));t=t.concat(r.sub(p.zeros(),J,r.add(p.zeros(),l.scaleWithFactor(B,H/2,b),l.scaleWithFactor(C,I/2,b))));b=new N.MeshVertexAttributes({position:Float64Array.from(t)});b=new L({vertexAttributes:b,components:A,spatialReference:w.spatialReference});q=l.transformMat3([0,0,-1],a);const {x:ha,y:ia}=g;q=l.scaleAndAddWithFactor([ha,ia,c],q,d,f);e=2*Math.tan(e*v/2)*d;d*=2*Math.tan(m/h*v/2);m=l.transformMat3([0,
1,0],a);h=l.transformMat3([1,0,0],a);m=l.scaleWithFactor(m,e/2,f);h=l.scaleWithFactor(h,d/2,f);d=r.sub(p.zeros(),m,h);m=r.add(p.zeros(),m,h);d=[r.add(p.zeros(),q,d),r.add(p.zeros(),q,m),r.sub(p.zeros(),q,d),r.sub(p.zeros(),q,m)];c=S(d,c,g,f);c.push(c[0]);n.addRing(c);return b}function S(a,b,c,g){return a.map(d=>{{var f=Math.sqrt((d[2]-b)**2+(Math.sqrt((d[0]-c.x)**2+(d[1]-c.y)**2)/g)**2)*g;const n=l.scaleWithFactor(r.sub(p.zeros(),[d[0],d[1],d[2]],[c.x,c.y,b]),1/f,1/g);var e=b/(b-d[2]);f=(1-e)*c.x+
e*d[0];var m=(1-e)*c.y+e*d[1];e=(1-e)*b+e*d[2];var h=Math.sqrt((e-b)**2+(Math.sqrt((f-c.x)**2+(m-c.y)**2)/g)**2)*g;h=l.scaleWithFactor(r.sub(p.zeros(),[f,m,e],[c.x,c.y,b]),1/h,1/g);d=Math.sign(n[0])!==Math.sign(h[0])&&Math.sign(n[1])!==Math.sign(h[1])&&Math.sign(n[2])!==Math.sign(h[2])||0<=d[2]?[d[0],d[1],0]:[f,m,e]}return d})}function R(a){return a&&da.isWebMercator(a?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*a.y/ba.earth.radius))):1}async function ja(a,b,c,g,d,f,e,m,h){{const z=
T(a),G=T(a,"near");if(z){b=b.length;for(let A=0;A<b;A++){var n=Array.from(c[A]);n=[n[0]-g[0],n[1]-g[1],n[2]-(g[2]??d)];var k=g,q=n,u=A,x=G;if(x){var y=p.zeros();K.intersectRay(x.coefficients,{origin:k,direction:q},y)&&x.vertexPositions.splice(3*u,3,...y)}k=g;q=A;const {coefficients:H,vertexPositions:I}=z;u=p.zeros();K.intersectRay(H,{origin:k,direction:n},u)&&I.splice(3*q,3,...u)}c={farPlane:z,nearPlane:G}}else c=void 0}if(c){var {farPlane:w,nearPlane:F}=c;a=await P([...(F?.vertexPositions??a.slice(0,
3)),...w.vertexPositions],e,m,h);e=a.length/3;return new L({vertexAttributes:new N.MeshVertexAttributes({position:a}),components:U(f?V(e,!0):W(e,!0)),spatialReference:m})}}async function ka(a,b,c,g,d,f,e,m){let h=e?[]:[a[0],a[1],a[2]],n=[];for(const k of b)e?(b=l.projectiveTransform([k[0],k[1],1],[[0,0,1],[c,0,1],[c,g,1],[0,g,1]],[[a[0],a[1],a[2]],[a[3],a[4],a[5]],[a[6],a[7],a[8]],[a[9],a[10],a[11]]]),h=h.concat(...b),b=l.projectiveTransform([k[0],k[1],1],[[0,0,1],[c,0,1],[c,g,1],[0,g,1]],[[a[12],
a[13],a[14]],[a[15],a[16],a[17]],[a[18],a[19],a[20]],[a[21],a[22],a[23]]]),n=n.concat(...b)):(b=l.projectiveTransform([k[0],k[1],1],[[0,0,1],[c,0,1],[c,g,1],[0,g,1]],[[a[3],a[4],a[5]],[a[6],a[7],a[8]],[a[9],a[10],a[11]],[a[12],a[13],a[14]]]),h=h.concat(...b));h=h.concat(n);a=await P(h,d,f,m);c=a.length/3;return new L({vertexAttributes:new N.MeshVertexAttributes({position:a}),components:U(e?V(c,!0):W(c,!0)),spatialReference:f})}async function P(a,b,c,g){if(b.equals(c))return a;a=a.reduce((d,f,e)=>
{e=Math.floor(e/3);d[e]||(d[e]=[]);d[e].push(f);return d},[]);({points:b}=await aa.projectWithZConversion(new ea(a,b),c,g));X.throwIfAborted(g);return b.flat()}function T(a,b="far"){const c=K.create();switch(b){case "far":b=Array.from(15===a.length?a.slice(3):a.slice(12));if(K.fromArray(c,b,!0))return{coefficients:c,vertexPositions:b};break;case "near":if(b=Array.from(a.slice(0,12)),15!==a.length&&K.fromArray(c,b,!0))return{coefficients:c,vertexPositions:b}}}function W(a,b=!1){if(3>a||b&&3>a-1)throw Error("Invalid number of vertices");
const c=[];a=b?a-2:a-1;for(b=0;b<a;b++)c.push({faces:new Uint32Array([0,b+1,b+2])});return c}const v=Math.PI/180,V=(a,b=!1)=>{if(b&&4>=a-2||4>=a||0!==a%2)throw Error("Invalid number of vertices");const c=[],g=a/2,d=Math.round((b?a-2:a)/2);for(let f=0;f<d;f++){const e=f+g,m=b?e+1:e,h=m%a;c.push({faces:new Uint32Array([f,(b?e:m+1)%a,h,f,f+1,h])})}return c},U=a=>a.map(b=>new ca(b));E.checkIfPolygonContainsSelectedPoint=function(a,b){return a.contains(b)};E.computePolygonForInspection=function(a){const {spatialReference:b,
x:c,y:g}=a.geometry,{cameraHeading:d,cameraPitch:f,farDistance:e,nearDistance:m}=a;var h=R(a.geometry);a=new O({spatialReference:b});const n=Math.abs(1.44*e*h);h=Math.abs(1.44*m*h);if(20>f||null==d)h=n;const k=[];k[0]={x:c+n*Math.sin((d-45)*v),y:g+n*Math.cos((d-45)*v)};k[1]={x:c+n*Math.sin((d+45)*v),y:g+n*Math.cos((d+45)*v)};k[2]={x:c+h*Math.sin((d+135)*v),y:g+h*Math.cos((d+135)*v)};k[3]={x:c+h*Math.sin((d+225)*v),y:g+h*Math.cos((d+225)*v)};a.addRing([[k[0].x,k[0].y,0],[k[1].x,k[1].y,0],[k[2].x,k[2].y,
0],[k[3].x,k[3].y,0],[k[0].x,k[0].y,0]]);return a};E.createCoveragePolygon=function(a){if(a.isSpherical){const {geometry:n,farDistance:k,objectId:q,nearDistance:u,cameraHeight:x}=a;var b=l.getWebMercatorScalingFactor(n.y,n.spatialReference);a=new M({center:n.clone(),radius:k*b});a.imageID=q;if(u){var c=new M({center:n.clone(),radius:u*b});a.addRing(c.rings[0])}c=n.clone();c.z=x-k*b;b=L.createSphere(c,{size:2*k*b});b.imageID=q;a={polygon:a,frustum:b}}else{const {horizontalFieldOfView:n,verticalFieldOfView:k,
geometry:q,cameraHeading:u}=a;b=l.getWebMercatorScalingFactor(q.y,q.spatialReference);c=a.cameraPitch;let x=a.cameraRoll??0;var g=150;150<n&&(c=90,x=0,g=5);g=Math.ceil(n/g);var d=g;var f=u,e=n,m=[];if(0===d%2)for(var h=0;h<d/2;h++)m.push(f-e/d*(h+.5),f+e/d*(h+.5));else for(m.push(f),h=1;h<d/2;h++)m.push(f-e/d*h,f+e/d*h);m.sort();d=m;f=a.farDistance?a.farDistance*b:a.cameraHeight*b/Math.cos(c*v);90<=a.cameraPitch+k/2&&(f=(a.farDistance||20)*b);e=new O({spatialReference:q?.spatialReference});e.imageID=
a.objectId;m=null;for(const y of d)m=fa(y,c,a.cameraHeight,q,f,b,k,n,g,e,x,a.nearDistance);m.imageID=a.objectId;a={polygon:e,frustum:m}}return a};E.limitZToGround=S;E.projectVertices=P;E.resizePolygon=function(a,b){b=1+b/100;if("esri.geometry.Circle"===a.declaredClass){const {radius:g,center:d}=a;b=new M({radius:g*b,center:d});1<a.rings.length&&b.addRing(a.rings[1]);return b}if("esri.geometry.Polygon"===a.declaredClass){const g=new O({spatialReference:a.spatialReference}),d=a.centroid;if(d){const f=
[];for(let e=0;e<a.rings[0].length;e++){var c=Math.sqrt((d.x-a.rings[0][e][0])**2+(d.y-a.rings[0][e][1])**2);const m=l.scaleWithFactor(r.sub(p.zeros(),[a.rings[0][e][0],a.rings[0][e][1],0],[d.x,d.y,0]),1/c,1);c=l.scaleAndAddWithFactor([d.x,d.y,0],m,c*b,1);f.push({x:c[0],y:c[1]})}g.addRing([[f[0].x,f[0].y,0],[f[1].x,f[1].y,0],[f[2].x,f[2].y,0],[f[3].x,f[3].y,0],[f[0].x,f[0].y,0]])}return g}return a};E.updateFrustum=async function(a,b,c){const {cameraHeight:g,cameraLocation:d,cameraPitch:f,frustumVertices:e,
horizontalFieldOfView:m,imageHeight:h,imageWidth:n,inSRS:k,outSRS:q,verticalFieldOfView:u,cameraRoll:x,options:y}=c;c=new Q(k);const w=new Q(q),F=l.computeHFOVAndVFOV(m,u,x??0),z=15<e.length;return 90<=f+F.vfov/2?await ka(e,a,n,h,c,w,z,y):await ja(e,a,b,d,g,z,c,w,y)};Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})});