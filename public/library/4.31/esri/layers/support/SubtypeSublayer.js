// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../PopupTemplate ../../renderers/ClassBreaksRenderer ../../renderers/DictionaryRenderer ../../renderers/DotDensityRenderer ../../renderers/HeatmapRenderer ../../renderers/PieChartRenderer ../../renderers/Renderer ../../renderers/SimpleRenderer ../../renderers/UniqueValueRenderer ../../renderers/support/jsonUtils ../../core/Logger ../../core/Clonable ../../core/has ../../core/Error ../../core/Identifiable ../../core/lang ../../core/Loadable ../../core/MultiOriginJSONSupport ../../core/object ../../core/sql ../../core/accessorSupport/decorators/property ../../core/accessorSupport/decorators/reader ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/decorators/writer ../../form/FormTemplate ../../geometry/SpatialReference ./commonProperties ./featureLayerUtils ./FeatureTemplate ./fieldProperties ./fieldUtils ./LabelClass ./labelingInfo ./subtypeGroupLayerUtils ../../rest/support/Query ../../support/popupUtils ../../symbols/support/defaults ../../tables/AttributeTableTemplate".split(" "),
function(e,M,A,fa,ha,ia,ja,ka,F,la,ma,N,d,na,y,O,t,P,Q,R,G,f,z,S,T,U,V,v,H,I,W,J,X,Y,B,Z,aa,C,ba){function w(a){const c=a.json.write;"object"===typeof c?c.ignoreOrigin=!0:a.json.write={ignoreOrigin:!0};return a}function ca(a){switch(a){case "point":case "multipoint":return C.defaultPointSymbol2D.clone();case "polyline":return C.defaultPolylineSymbol2D.clone();case "polygon":case "multipatch":return C.defaultPolygonSymbol2D.clone();default:return null}}function da(a,c){return c?"unique-value"===a?.type&&
null!=a.field&&a.field.toLowerCase()===c.toLowerCase()&&!a.field2&&!a.field3&&!a.valueExpression:!1}function K(a,c){return null==a?null:c.subtypes?.find(b=>b.code===a)}A=W.defineFieldProperties();let ea=0;d=class extends Q.MultiOriginJSONMixin(d.ClonableMixin(O.IdentifiableMixin(P))){constructor(a){super(a);this.charts=this.attributeTableTemplate=null;this.editingEnabled=!0;this.formTemplate=this.fieldsIndex=this.fieldOverrides=null;this.id=`${Date.now().toString(16)}-subtype-sublayer-${ea++}`;this.type=
"subtype-sublayer";this.labelsVisible=!0;this.labelingInfo=null;this.layerType="ArcGISFeatureLayer";this.legendEnabled=!0;this.listMode="show";this.maxScale=this.minScale=0;this.opacity=1;this.parent=null;this.popupEnabled=!0;this.title=this.templates=this.subtypeCode=this.popupTemplate=null;this.visible=!0}load(a){J.fixRendererFields(this.renderer,this.fieldsIndex);return Promise.resolve(this)}get capabilities(){return this.parent?.capabilities}get effectiveCapabilities(){return this.parent?.effectiveCapabilities}get effectiveEditingEnabled(){const {parent:a}=
this;return a?a.effectiveEditingEnabled&&this.editingEnabled:this.editingEnabled}get elevationInfo(){return this.parent?.elevationInfo}writeFieldOverrides(a,c,b){const {fields:g,parent:h}=this;let k;if(g){k=[];let n=0;g.forEach(({name:u,alias:x,editable:l,visible:q})=>{if(q&&(q=h?.fields?.find(D=>D.name===u))){var p={name:u},r=!1;x!==q.alias&&(p.alias=x,r=!0);l!==q.editable&&(p.editable=l,r=!0);k.push(p);r&&n++}});0===n&&k.length===g.length&&(k=null)}else k=t.clone(a);k?.length&&R.setDeepValue(b,
k,c)}get fields(){const {parent:a,fieldOverrides:c,subtypeCode:b}=this;var g=a?.fields;if(!a||!g?.length)return null;const {subtypes:h,subtypeField:k}=a;var n=h?.find(q=>q.code===b);const u=n?.defaultValues;n=n?.domains;const x=[];for(const q of g){g=q.clone();const {name:p}=g;var l=c?.find(r=>r.name===p);g.visible=!c||!!l;if(l){const {alias:r,editable:D}=l;r&&(g.alias=r);!1===D&&(g.editable=!1)}l=u?.[p]??null;g.defaultValue=p===k?b:l;l=n?.[p]??null;g.domain=p===k?null:l?"inherited"===l.type?g.domain:
l.clone():null;x.push(g)}return x}get floorInfo(){return this.parent?.floorInfo}get geometryType(){return this.parent?.geometryType}get effectiveScaleRange(){const {minScale:a,maxScale:c}=this;return{minScale:a,maxScale:c}}get objectIdField(){this.parent||N.getLogger(this).error(m("objectIdField"));return this.parent?.objectIdField}get defaultPopupTemplate(){return this.createPopupTemplate()}get relationships(){return this.parent?.relationships}set renderer(a){J.fixRendererFields(a,this.fieldsIndex);
this._override("renderer",a)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const {parent:a}=this;return a&&!a.isTable&&"mesh"!==a.geometryType?new F({symbol:ca(a.geometryType)}):null}readRendererFromService(a,c,b){if("Table"===c.type)return null;b=B.rendererReader(c.drawingInfo?.renderer,c,b);a=void 0;const {subtypeCode:g}=this;null!=g&&da(b,c.subtypeField)?(c=b.uniqueValueInfos?.find(({value:h})=>{h="number"===typeof h?String(h):h;return h===String(g)}))&&(a=new F({symbol:c.symbol})):
"simple"!==b?.type||b.visualVariables?.length||(a=b);return a}readRenderer(a,c,b){if((a=c?.layerDefinition?.drawingInfo?.renderer)&&!a.visualVariables?.some(g=>"rotationInfo"!==g.type))return B.rendererReader(a,c,b)||void 0}get spatialReference(){return this.parent?.spatialReference??V.WGS84}get subtypeField(){return this.parent?.subtypeField}readTemplatesFromService(a,c){a=this.subtypeCode;let b=null;switch(c.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":b="point";break;case "esriGeometryPolyline":b=
"line";break;case "esriGeometryPolygon":case "esriGeometryMultiPatch":b="polygon";break;default:b=null}const g={};var h=K(a,c);if(null!=h){({defaultValues:h}=h);for(const k in h)g[k]=h[k]}g[c.subtypeField]=a;return[new I({name:"New Feature",drawingTool:b,prototype:{attributes:g}})]}readTitleFromService(a,c){a=K(this.subtypeCode,c);return null!=a?a.name:null}get url(){return this.parent?.url}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}async addAttachment(a,c){const {parent:b}=
this;if(!b)throw m("addAttachment");if(a.getAttribute(b.subtypeField)!==this.subtypeCode)throw new y("subtype-sublayer:addAttachment","The feature provided does not belong to this SubtypeSublayer");return b.addAttachment(a,c)}async updateAttachment(a,c,b){const {parent:g}=this;if(!g)throw m("updateAttachment");if(a.getAttribute(g.subtypeField)!==this.subtypeCode)throw new y("subtype-sublayer:updateAttachment","The feature provided does not belong to this SubtypeSublayer");return g.updateAttachment(a,
c,b)}async deleteAttachments(a,c){const {parent:b}=this;if(!b)throw m("deleteAttachments");if(a.getAttribute(b.subtypeField)!==this.subtypeCode)throw new y("subtype-sublayer:deleteAttachments","The feature provided does not belong to this SubtypeSublayer");return b.deleteAttachments(a,c)}async applyEdits(a,c){if(!this.parent)throw m("applyEdits");return this.parent.applyEdits(a,c)}createPopupTemplate(a){let c=this;const {parent:b,fields:g,title:h}=this;if(b){const {displayField:k,editFieldsInfo:n,
objectIdField:u}=b;c={displayField:k,editFieldsInfo:n,fields:g,objectIdField:u,title:h}}return aa.createPopupTemplate(c,a)}createQuery(){if(!this.parent)throw m("createQuery");const a=H.createQuery(this.parent);a.where=G.sqlAnd(`${this.parent.subtypeField}=${this.subtypeCode}`,this.parent.definitionExpression);return a}getField(a){return this.fieldsIndex.get(a)}getFieldDomain(a,c){return!c?.excludeImpliedDomains&&this.parent&&(c=H.computeDomainFromSubtypes(this.parent,a))?c:this._getLayerDomain(a)}async queryAttachments(a,
c){const b=await this.load();if(!b.parent)throw m("queryAttachments");const g=a.clone();g.where=L(g.where,b.parent.subtypeField,b.subtypeCode);return b.parent.queryAttachments(a,c)}async queryFeatureCount(a,c){const b=await this.load();if(!b.parent)throw m("queryFeatureCount");return b.parent.queryFeatureCount(E(b.parent,b,a),c)}async queryFeatures(a,c){const b=await this.load();if(!b.parent)throw m("queryFeatures");return b.parent.queryFeatures(E(b.parent,b,a),c)}async queryObjectIds(a,c){const b=
await this.load();if(!b.parent)throw m("queryObjectIds");return b.parent.queryObjectIds(E(b.parent,b,a),c)}async queryRelatedFeatures(a,c){const b=await this.load();if(!b.parent)throw m("queryRelatedFeatures");return b.parent.queryRelatedFeatures(a,c)}async queryRelatedFeaturesCount(a,c){const b=await this.load();if(!b.parent)throw m("queryRelatedFeaturesCount");return b.parent.queryRelatedFeaturesCount(a,c)}_getLayerDomain(a){return(a=this.fieldsIndex.get(a))?a.domain:null}};e.__decorate([f.property({type:ba,
json:{name:"attributeTableInfo",write:{ignoreOrigin:!0}}})],d.prototype,"attributeTableTemplate",void 0);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,"capabilities",null);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,"effectiveCapabilities",null);e.__decorate([f.property({json:{write:{ignoreOrigin:!0}}})],d.prototype,"charts",void 0);e.__decorate([f.property({type:Boolean,nonNullable:!0,json:{name:"enableEditing",write:{ignoreOrigin:!0}}})],d.prototype,
"editingEnabled",void 0);e.__decorate([f.property({type:Boolean,readOnly:!0})],d.prototype,"effectiveEditingEnabled",null);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,"elevationInfo",null);e.__decorate([f.property({json:{name:"layerDefinition.fieldOverrides",origins:{service:{read:!1}},write:{ignoreOrigin:!0,allowNull:!0}}})],d.prototype,"fieldOverrides",void 0);e.__decorate([T.writer("fieldOverrides")],d.prototype,"writeFieldOverrides",null);e.__decorate([f.property({...A.fields,
readOnly:!0,json:{read:!1}})],d.prototype,"fields",null);e.__decorate([f.property(A.fieldsIndex)],d.prototype,"fieldsIndex",void 0);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,"floorInfo",null);e.__decorate([f.property({type:U,json:{name:"formInfo",write:{ignoreOrigin:!0}}})],d.prototype,"formTemplate",void 0);e.__decorate([f.property({type:String,clonable:!1,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],d.prototype,"id",void 0);e.__decorate([f.property({readOnly:!0,
json:{read:!1}})],d.prototype,"geometryType",null);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,"type",void 0);e.__decorate([f.property(w(t.clone(v.labelsVisible)))],d.prototype,"labelsVisible",void 0);e.__decorate([f.property({type:[X],json:{name:"layerDefinition.drawingInfo.labelingInfo",origins:{service:{read:!1}},read:{reader:Y.reader},write:{ignoreOrigin:!0}}})],d.prototype,"labelingInfo",void 0);e.__decorate([f.property({type:["ArcGISFeatureLayer"],readOnly:!0,json:{read:!1,
write:{ignoreOrigin:!0}}})],d.prototype,"layerType",void 0);e.__decorate([f.property(w(t.clone(v.legendEnabled)))],d.prototype,"legendEnabled",void 0);e.__decorate([f.property({type:["show","hide"]})],d.prototype,"listMode",void 0);e.__decorate([f.property((()=>{const a=t.clone(v.minScale);a.json.origins.service.read=!1;return w(a)})())],d.prototype,"minScale",void 0);e.__decorate([f.property((()=>{const a=t.clone(v.maxScale);a.json.origins.service.read=!1;return w(a)})())],d.prototype,"maxScale",
void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"effectiveScaleRange",null);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,"objectIdField",null);e.__decorate([f.property({type:Number,range:{min:0,max:1},nonNullable:!0,json:{write:{ignoreOrigin:!0}}})],d.prototype,"opacity",void 0);e.__decorate([f.property({clonable:!1})],d.prototype,"parent",void 0);e.__decorate([f.property(w(t.clone(v.popupEnabled)))],d.prototype,"popupEnabled",void 0);e.__decorate([f.property({type:M,
json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],d.prototype,"popupTemplate",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"defaultPopupTemplate",null);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,"relationships",null);e.__decorate([f.property({types:B.supportedRendererTypes,json:{write:{target:"layerDefinition.drawingInfo.renderer",ignoreOrigin:!0}}})],d.prototype,"renderer",null);e.__decorate([z.reader("service","renderer",["drawingInfo.renderer","subtypeField",
"type"])],d.prototype,"readRendererFromService",null);e.__decorate([z.reader("renderer",["layerDefinition.drawingInfo.renderer"])],d.prototype,"readRenderer",null);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,"spatialReference",null);e.__decorate([f.property({type:Number,json:{origins:{service:{read:!1}},write:{ignoreOrigin:!0}}})],d.prototype,"subtypeCode",void 0);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,"subtypeField",null);e.__decorate([f.property({type:[I],
json:{name:"layerDefinition.templates",write:{ignoreOrigin:!0}}})],d.prototype,"templates",void 0);e.__decorate([z.reader("service","templates",["geometryType","subtypeField","subtypes","type"])],d.prototype,"readTemplatesFromService",null);e.__decorate([f.property({type:String,json:{write:{ignoreOrigin:!0}}})],d.prototype,"title",void 0);e.__decorate([z.reader("service","title",["subtypes"])],d.prototype,"readTitleFromService",null);e.__decorate([f.property({readOnly:!0,json:{read:!1}})],d.prototype,
"url",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"userHasUpdateItemPrivileges",null);e.__decorate([f.property({type:Boolean,nonNullable:!0,json:{name:"visibility",write:{ignoreOrigin:!0}}})],d.prototype,"visible",void 0);d=e.__decorate([S.subclass("esri.layers.support.SubtypeSublayer")],d);const E=(a,c,b)=>{if(!b)return c.createQuery();b=Z.from(b);b.where=L(b.where,a.subtypeField,c.subtypeCode);return b},L=(a,c,b)=>{const g=new RegExp(`${c}\\s*=\\s*\\d+`);c=`${c}=${b}`;a=a??"";return g.test(a)?
a.replace(g,c):G.sqlAnd(c,a)},m=a=>new y(`This sublayer must have a parent SubtypeGroupLayer in order to use ${a}`);return d});