// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/arrayUtils","../DimensionalDefinition"],function(m,y,n){function q(b,a,c){const f=a.shift();0===c.length&&c.push({sliceId:-1,multidimensionalDefinition:[]});const d=c.length;for(let e=0;e<d;e++){const h=c.shift().multidimensionalDefinition;f.values?.forEach(g=>{c.push({sliceId:-1,multidimensionalDefinition:[...h,{variableName:b,dimensionName:f.name,values:[g]}]})})}a.length&&q(b,a,c)}function r(b,a){return Array.isArray(b)?a[0]===a[1]?b[0]===a[0]||b[1]===a[0]:b[0]>=
a[0]&&b[0]<=a[1]&&b[1]>=a[0]&&b[1]<=a[1]:b>=a[0]&&b<=a[1]}function z(b,a){return b[0]<=a[0]&&b[1]>=a[0]||b[0]<=a[1]&&b[1]>=a[1]||b[0]>=a[0]&&b[1]<=a[1]}function t(b){return 1===b.length?[b[0],b[0]]:[b[0],b[b.length-1]]}function u(b,a,c){if(!a?.subsetDefinitions?.length)return b;if(c){const {variables:d}=a;if(d.length&&!d.includes(c))return null;a=a.subsetDefinitions.find(e=>e.dimensionName===b.name&&e.variableName===c);if(!a?.values?.length)return b;a=t(a.values)}else a=a.dimensions.find(({name:d})=>
d===b.name)?.extent;const f=a;if(!f?.length)return b;a=b.values.filter(d=>r(d,f));return{...b,extent:[...f],values:a}}function p(b,a,c){if(!a?.subsetDefinitions?.length)return!1;const {variables:f}=a;if(f.length&&b.some(({variableName:d})=>d&&!f.includes(d)))return!0;for(let d=0;d<b.length;d++){const e=b[d],h=a.subsetDefinitions.find(g=>(""===e.variableName||g.variableName===e.variableName)&&g.dimensionName===e.dimensionName);if(h?.values.length){const g=t(h.values);if(!e.isSlice&&2===e.values.length&&
!Array.isArray(e.values[0])&&e.values[0]!==e.values[1]&&c){if(!z(e.values,g))return!0}else if(e.values.some(k=>!r(k,g)))return!0}}return!1}function A(b,a){var c=b.dimensions.find(({name:h})=>"StdTime"===h);if(null==c||null==a.start&&null==a.end)return a;a=a.clone();const {start:f,end:d}=a.toJSON(),e=f===d?[f]:null!=f&&null!=d?[f,d]:[f??d];if(2===e.length&&c?.extent.length&&(e[0]=Math.max(e[0],c.extent[0]),e[1]=Math.min(e[1],c.extent[1]??c.extent[0]),e[1]<e[0]))return null;c=new n({variableName:"",
dimensionName:"StdTime",isSlice:1===e.length,values:e});if(p([c],b,!0))return null;a.start=new Date(e[0]);a.end=new Date(e[1]??e[0]);return a}function v(b,a={}){const {multidimensionalInfo:c,keyProperties:f}=b;if(null==c)return null;const {variableName:d,multidimensionalSubset:e,multidimensionalDefinition:h}=a;b=null!=h?h[0]?.variableName:null;const g=d||b||f?.DefaultVariable;({variables:b}=c);e?.variables?.length&&(b=b.filter(({name:k})=>e.variables.includes(k)));return g?b.find(({name:k})=>k===
g)??b[0]:b[0]}function B(b,a){var {values:c}=a;if(c?.length){a=Array.isArray(c[0]);var f=Array.isArray(b);return a!==f?-1:a&&f?c.findIndex(e=>e[0]===b[0]&&e[1]===b[1]):c.indexOf(b)}({extent:f}=a);if(Array.isArray(b)||!f||b<f[0]||b>f[1])return-1;c=a.interval||1;if("ISO8601"!==a.unit)return Math.round((b-f[0])/c);f=f[0];let d=-1;switch(a.intervalUnit?.toLowerCase()||"days"){case "seconds":d=Math.round((b-f)/1E3/c);break;case "minutes":d=Math.round((b-f)/6E4/c);break;case "hours":d=Math.round((b-f)/
36E5/c);break;case "days":d=Math.round((b-f)/864E5/c);break;case "months":a=(new Date(b)).getUTCFullYear()-(new Date(f)).getUTCFullYear();c=(new Date(f)).getUTCMonth();f=(new Date(b)).getUTCMonth();d=0===a?f-c:f+11-c+12*(a-1);break;case "years":d=Math.round(((new Date(b)).getUTCFullYear()-(new Date(f)).getUTCFullYear())/c);break;case "decades":d=Math.round(((new Date(b)).getUTCFullYear()-(new Date(f)).getUTCFullYear())/10/c)}return d}function w(b){var a=b.values?.length;if(a)return a;const {extent:c,
unit:f}=b;a=b.interval||1;var d=c?c[1]-c[0]:0;if("ISO8601"!==f)return Math.round(d/a);switch(b.intervalUnit?.toLowerCase()??"seconds"){case "seconds":a=Math.round(d/1E3/a);break;case "minutes":a=Math.round(d/6E4/a);break;case "hours":a=Math.round(d/36E5/a);break;case "days":a=Math.round(d/864E5/a);break;case "months":c?(b=(new Date(c[1])).getUTCFullYear()-(new Date(c[0])).getUTCFullYear(),a=(new Date(c[0])).getUTCMonth(),d=(new Date(c[1])).getUTCMonth(),a=0===b?d-a+1:d+11-a+12*(b-1)+1):a=0;break;
case "years":a=c?Math.round(((new Date(c[1])).getUTCFullYear()-(new Date(c[0])).getUTCFullYear())/a):0;break;case "decades":a=c?Math.round(((new Date(c[1])).getUTCFullYear()-(new Date(c[0])).getUTCFullYear())/10/a):0;break;default:a=0}return a}function x(b,a,c,f){const d=[];let e=b;for(b=new Date(b);e<=a;)switch(d.push(e),f){case "decades":b.setUTCFullYear(b.getUTCFullYear()+10*c);e=b.getTime();break;case "years":b.setUTCFullYear(b.getUTCFullYear()+c);e=b.getTime();break;case "months":b.setUTCMonth(b.getUTCMonth()+
c);e=b.getTime();break;case "days":e+=864E5*c;break;case "hours":e+=36E5*c;break;case "minutes":e+=6E4*c;break;case "seconds":e+=1E3*c}1===d.length?d[1]=a:d[d.length-1]=a;return d}m.createSlices=function(b,a){const c=[];let f=0;(a?b.variables.filter(d=>d.name.toLowerCase()===a.toLowerCase()):[...b.variables].sort((d,e)=>d.name>e.name?1:-1)).forEach(d=>{const e=[],h=[...d.dimensions].sort((g,k)=>g.name>k.name?-1:1);q(d.name,h,e);e.forEach(g=>{c.push({...g,sliceId:f++})})});return c};m.getDefaultMultidimensionalDefinition=
function(b,a={}){var c=v(b,a);if(!c)return null;b=[];const {dimensions:f,name:d}=c;if(0===f.length)return[new n({variableName:d,dimensionName:"",values:[],isSlice:!0})];for(c=0;c<f.length;c++){const e=u(f[c],a.multidimensionalSubset,d);if(!e)return null;const {values:h,extent:g}=e;let k=h?.[0]??g?.[0];"stdz"===e.name.toLowerCase()&&!e.hasRanges&&g&&Math.abs(g[1])<=Math.abs(g[0])&&(k=h?.length?h[h.length-1]:g[1]);b.push(new n({variableName:d,dimensionName:e.name,values:[k],isSlice:a.useRangeForRangedDimensionInfo?
!!e.hasRanges:!0}))}return b};m.getDefaultVariableInfo=v;m.getDimensionValues=function(b){if(2!==b.extent?.length||!b.interval)return[];const {extent:[a,c],interval:f}=b;if("ISO8601"===b.unit)return b=b.intervalUnit?.toLowerCase()??"days","decades years months days hours minutes seconds".split(" ").includes(b)?x(a,c,f,b):[];const d=Math.round((c-a)/f);return Array.from({length:d},(e,h)=>h===d-1?c:a+h*f)};m.getSliceIds=function(b,a,c){let f=b;a&&(a=[...a].sort((d,e)=>d.dimensionName<e.dimensionName?
-1:1),a.forEach(({dimensionName:d,values:e,isSlice:h})=>{e.length&&(f=f.filter(g=>{g=g.multidimensionalDefinition.find(l=>l.dimensionName===d);if(null==g)return!1;const k=g.values[0];return"number"===typeof k?"number"===typeof e[0]?e.includes(k):e.some(l=>l[0]<=k&&l[1]>=k):"number"===typeof e[0]?e.some(l=>k[0]<=l&&k[1]>=l):h?e.some(l=>l[0]===k[0]&&l[0]===k[1]):e.some(l=>l[0]>=k[0]&&l[0]<=k[1]||l[1]>=k[0]&&l[1]<=k[1]||l[0]<k[0]&&l[1]>k[1])}))}));if(f.length&&null!=c?.start&&null!=c.end){const d=c.start.getTime(),
e=c.end.getTime(),h=f[0].multidimensionalDefinition.findIndex(g=>"StdTime"===g.dimensionName);-1<h&&(f=f.filter(g=>{g=g.multidimensionalDefinition[h].values[0];return d<=g&&e>=g}))}return f.map(d=>d.sliceId)};m.getSliceIndex=function(b,a){let c=0;var f=b[0].variableName;a=[...a.variables].sort((e,h)=>e.name>h.name?1:-1);for(var d=0;d<a.length;d++){const e=a[d],h=[...e.dimensions].sort((g,k)=>g.name>k.name?-1:1);if(e.name!==f)c+=h.map(g=>w(g)).reduce((g,k)=>g*k);else{f=h.map(g=>w(g));a=h.length;for(let g=
0;g<a;g++){d=b.find(k=>k.dimensionName===h[g].name);if(null==d)return null;d=B(d.values[0],h[g]);if(-1===d)return null;f.shift();c=g===a-1?c+d:c+d*f.reduce((k,l)=>k*l)}break}}return c};m.getSubsetVariablesFromMdInfo=function(b,a){if(null==a||null==b)return null;a=a.variables.map(c=>({...c}));b?.variables?.length&&(a=a.filter(({name:c})=>b.variables.includes(c)),a.forEach(c=>{c.dimensions=c.dimensions.map(f=>u(f,b,c.name)).filter(y.isSome)}));return a};m.getTimeDimensionValues=x;m.hasExcludedVariableOrDimension=
p;m.intersectMultimensionalSubset=function(b,a){if(null==b)return{isOutside:!1};const {geometry:c,timeExtent:f,multidimensionalDefinition:d}=a;a=null;if(null!=f&&(a=A(b,f),null==a))return{isOutside:!0};const {areaOfInterest:e}=b;if(e&&c){const h="point"===c.type?c:"extent"===c.type?c.center:"polygon"===c.type?c.centroid:null;if(h&&!e.contains(h))return{isOutside:!0}}return null!=d&&d.length&&p(d,b,!0)?{isOutside:!0}:{isOutside:!1,intersection:{geometry:c,timeExtent:a,multidimensionalDefinition:d}}};
m.isMultiSliceOrRangeDefinition=function(b){return b?.length?b.some(a=>{if(null==a.values)return!0;const c=a.values.length;return 0===c||1<c||!a.isSlice&&Array.isArray(a.values[0])}):!1};Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});