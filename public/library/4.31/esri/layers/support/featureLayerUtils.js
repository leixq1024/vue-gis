// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("require exports ../../kernel ../../symbols ../../core/asyncUtils ../../core/Error ../../core/jsonMap ../../core/sql ../../core/uuid ../../core/accessorSupport/extensions/serializableProperty/reader ./CodedValue ./CodedValueDomain ./featureQueryAll ./fieldUtils ./layerUtils ../../renderers/SimpleRenderer ../../renderers/UniqueValueRenderer ../../rest/support/AttachmentQuery ../../rest/support/Query ../../rest/support/RelationshipQuery".split(" "),function(t,g,m,D,E,h,p,F,G,H,u,v,I,w,J,K,L,
M,n,x){function q(a,b,c){const {attributes:d}=b,{objectIdField:e}=a;return a.capabilities?.data?.supportsAttachment?b?d?e&&d[e]?Promise.resolve():Promise.reject(new h(c,`feature is missing the identifying attribute ${e}`)):Promise.reject(new h(c,"'attributes' are required on a feature to query attachments")):Promise.reject(new h(c,"A feature is required to add/delete/update attachments")):Promise.reject(new h(c,"this layer doesn't support attachments"))}function y(a,b){return b?w.isStringField({type:b})&&
"number"===typeof a?`${a}`:w.isIntegerField({type:b})&&"string"===typeof a?Number.parseInt(a,10):a:a}async function l(a){return(await a.load()).source}async function z(a,b){if(m.id&&!m.id.findCredential(a)){var c;try{const d=await J.getOwningPortalUrl(a,b);d&&(c=await m.id.checkSignInStatus(`${d}/sharing`))}catch(d){}if(c)try{await m.id.getCredential(a,{signal:null!=b?b.signal:null})}catch(d){}}}async function A(a,b,c){if(null==b)return null;const d=[],{objectIdField:e}=a;b.forEach(f=>{let k=null;
"attributes"in f?({attributes:f}=f,k={globalId:f[c],objectId:null!=f[e]&&-1!==f[e]?f[e]:null}):k={globalId:f.globalId,objectId:null!=f.objectId&&-1!==f.objectId?f.objectId:null};null!=k.globalId&&(null!=k.objectId&&-1!==k.objectId||d.push(k.globalId))});if(0===d.length)return null;b=a.createQuery();b.where=d.map(f=>`${c}='${f}'`).join(" OR ");b.returnGeometry=!1;b.outFields=[e,c];b.cacheHint=!1;b=await E.resultOrAbort(I.queryAllJSON(a,b));if(!b.ok)return null;a=new Map;b=b.value.features;for(const f of b){b=
f.attributes[c];const k=f.attributes[e];null!=b&&null!=k&&-1!==k&&a.set(G.normalizeGlobalID(b),k)}return a}function B(a){return a.sourceJSON?.isMultiServicesView||N(a)}function N(a){return!!a.sourceJSON?.capabilities?.toLowerCase().split(",").map(b=>b.trim()).includes("map")}p=new p.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});const r=H.createTypeReader({types:D.symbolTypesRenderer});
g.addAttachment=async function(a,b,c,d){const e=await l(a);await q(a,b,d);if(!e.addAttachment)throw new h(d,"Layer source does not support addAttachment capability");return e.addAttachment(b,c)};g.applyEdits=async function(a,b,c){const {applyEdits:d}=await new Promise((f,k)=>t(["../graphics/editingSupport"],f,k));a=await a.load();let e=c;"feature"===a.type&&a.infoFor3D&&null!=b.deleteFeatures&&null!=a.globalIdField&&(e={...e,globalIdToObjectId:await A(a,b.deleteFeatures,a.globalIdField)});return d(a,
a.source,b,c)};g.computeDomainFromSubtypes=function(a,b){const {fieldsIndex:c,subtypeField:d}=a,{name:e,type:f}=c.get(b)??{};return e?(d&&c.get(d)?.name)===e&&a.subtypes?.length&&(a=a.subtypes.map(k=>new u.CodedValue({code:y(k.code,f),name:k.name})),a?.length)?new v({codedValues:a}):null:null};g.computeDomainFromTypes=function(a,b){const {fieldsIndex:c}=a,{name:d,type:e}=c.get(b)??{};return d?("typeIdField"in a?c.get(a.typeIdField)?.name:null)===d&&"types"in a&&a.types?.length?(a=a.types.map(f=>new u.CodedValue({code:y(f.id,
e),name:f.name})),new v({codedValues:a})):null:null};g.computeEffectiveEditingEnabled=function(a){return B(a)?!1:a.userHasUpdateItemPrivileges||a.editingEnabled};g.createDefaultRenderer=function(a,b){if(a.defaultSymbol)return a.types?.length?new L({defaultSymbol:r(a.defaultSymbol,a,b),field:a.typeIdField,uniqueValueInfos:a.types.map(c=>({id:c.id,symbol:r(c.symbol,c,b)}))}):new K({symbol:r(a.defaultSymbol,a,b)})};g.createQuery=function(a){const b=new n,c=a.capabilities?.data,d=a.capabilities?.query;
b.historicMoment=a.historicMoment;b.gdbVersion=a.gdbVersion;b.returnGeometry=!0;d&&(b.compactGeometryEnabled=d.supportsCompactGeometry,b.defaultSpatialReferenceEnabled=d.supportsDefaultSpatialReference);c&&(c.supportsZ&&null!=a.returnZ&&(b.returnZ=a.returnZ),c.supportsM&&null!=a.returnM&&(b.returnM=a.returnM));b.outFields=["*"];const {timeOffset:e,timeExtent:f}=a;b.timeExtent=null!=e&&null!=f?f.offset(-e.value,e.unit):f||null;b.multipatchOption="multipatch"===a.geometryType?"xyFootprint":null;return b};
g.deleteAttachments=async function(a,b,c,d){const e=await l(a);await q(a,b,d);if(!e.deleteAttachments)throw new h(d,"Layer source does not support deleteAttachments capability");return e.deleteAttachments(b,c)};g.ensureCredentialIfSignedIn=z;g.ensureLayerCredential=async function(a,b,c){const d=a.parsedUrl?.path;d&&a.authenticationTriggerEvent===b&&await z(d,c)};g.fetchRecomputedExtents=async function(a,b,c){a=(await a.load({signal:b?.signal})).source;if(!a.fetchRecomputedExtents)throw new h(c,"Layer source does not support fetchUpdates capability");
return a.fetchRecomputedExtents(b)};g.geometryTypeKebabDict=p;g.getFeatureSubtype=function(a,b){const {subtypes:c,subtypeField:d}=a;if(!b?.attributes||!c?.length||!d)return null;const e=b.attributes[d];return null==e?null:c.find(f=>f.code===e)};g.getFeatureType=function(a,b,c){if(!b||!c||!a)return null;const d=c.getAttribute(b);return null==d?null:a.find(e=>{({id:e}=e);return null!=e&&e.toString()===d.toString()})??null};g.getGlobalIdToObjectIdMap=A;g.hasDataChanged=async function(a){const b=a.source;
if(b?.refresh)try{const {dataChanged:c,updates:d}=await b.refresh();null!=d&&(a.sourceJSON={...a.sourceJSON,...d},a.read(d,{origin:"service",url:a.parsedUrl}));if(c)return!0}catch{}if(a.definitionExpression)try{return(await F.parseWhereClause(a.definitionExpression,a.fieldsIndex)).hasDateFunctions}catch{}return!1};g.isLayerCacheStale=function(a){let b=a.sourceJSON?.cacheMaxAge;if(!b)return!1;a=a.editingInfo?.lastEditDate?.getTime();if(null==a)return!0;b*=1E3;return Date.now()-a<b};g.queryAttachments=
async function(a,b,c,d){b=M.from(b);await a.load();c=a.source;a=a.capabilities;if(!a?.data?.supportsAttachment)throw new h(d,"this layer doesn't support attachments");const {attachmentTypes:e,objectIds:f,globalIds:k,num:O,size:P,start:Q,where:C}=b;if(!a?.operations?.supportsQueryAttachments&&(0<e?.length||0<k?.length||0<P?.length||O||Q||C))throw new h(d,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",b);if(!(f?.length||k?.length||C))throw new h(d,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",
b);if(!c.queryAttachments)throw new h(d,"Layer source does not support queryAttachments capability",b);return c.queryAttachments(b)};g.queryExtent=async function(a,b,c,d){const e=await l(a);if(!e.queryExtent)throw new h(d,"Layer source does not support queryExtent capability");return e.queryExtent(n.from(b)??a.createQuery(),c)};g.queryFeatureCount=async function(a,b,c,d){const e=await l(a);if(!e.queryFeatureCount)throw new h(d,"Layer source does not support queryFeatureCount capability");return e.queryFeatureCount(n.from(b)??
a.createQuery(),c)};g.queryObjectIds=async function(a,b,c,d){const e=await l(a);if(!e.queryObjectIds)throw new h(d,"Layer source does not support queryObjectIds capability");return e.queryObjectIds(n.from(b)??a.createQuery(),c)};g.queryRelatedFeatures=async function(a,b,c,d){a=await l(a);if(!a.queryRelatedFeatures)throw new h(d,"Layer source does not support queryRelatedFeatures capability");return a.queryRelatedFeatures(x.from(b),c)};g.queryRelatedFeaturesCount=async function(a,b,c,d){a=await l(a);
if(!a.queryRelatedFeaturesCount)throw new h(d,"Layer source does not support queryRelatedFeaturesCount capability");return a.queryRelatedFeaturesCount(x.from(b),c)};g.readGlobalIdField=function(a){const {globalIdField:b,fields:c}=a;if(b)return b;if(c)for(const d of c)if("esriFieldTypeGlobalID"===d.type)return d.name};g.readObjectIdField=function(a){const {objectIdField:b,fields:c}=a;if(b)return b;if(c)for(const d of c)if("esriFieldTypeOID"===d.type)return d.name};g.readVersion=function(a){return a.currentVersion?
a.currentVersion:a.hasOwnProperty("capabilities")||a.hasOwnProperty("drawingInfo")||a.hasOwnProperty("hasAttachments")||a.hasOwnProperty("htmlPopupType")||a.hasOwnProperty("relationships")||a.hasOwnProperty("timeInfo")||a.hasOwnProperty("typeIdField")||a.hasOwnProperty("types")?10:9.3};g.supportsQueryOnly=B;g.updateAttachment=async function(a,b,c,d,e){const f=await l(a);await q(a,b,e);if(!f.updateAttachment)throw new h(e,"Layer source does not support updateAttachment capability");return f.updateAttachment(b,
c,d)};g.uploadAssets=async function(a,b,c){const {uploadAssets:d}=await new Promise((e,f)=>t(["../graphics/editingSupport"],e,f));a=await a.load();return d(a,a.source,b,c)};g.validateBinsQuery=function(a,b,c){b=b?.queryBins;if(!b)throw new h(c,"Layer source does not support binning");switch(a.binParameters.type){case "auto-interval":if(!b.supportsAutoInterval)throw new h(c,"Layer source does not support auto-interval binning");break;case "date":if(!b.supportsDate)throw new h(c,"Layer source does not support date binning");
break;case "fixed-boundaries":if(!b.supportsFixedBoundaries)throw new h(c,"Layer source does not support fixed-boundaries binning");break;case "fixed-interval":if(!b.supportsFixedInterval)throw new h(c,"Layer source does not support fixed-interval binning");}b=b?.supportedStatistics;if(a.outStatistics&&b){const d=new Map([["count","count"],["sum","sum"],["min","min"],["max","max"],["avg","avg"],["stddev","stddev"],["var","var"],["percentile-continuous","percentileContinuous"],["percentile-discrete",
"percentileDiscrete"],["centroid-aggregate","centroid"],["convex-hull-aggregate","convexHull"],["envelope-aggregate","envelope"]]);for(const {statisticType:e}of a.outStatistics)if((a=d.get(e))&&!b[a])throw new h(c,`Layer source does not support ${e} statistic type`);}};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});