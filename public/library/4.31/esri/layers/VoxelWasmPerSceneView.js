// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("../chunks/tslib.es6 ../request ../core/has ../core/Logger ../core/promiseUtils ../core/reactiveUtils ../core/timeUtils ../core/accessorSupport/decorators/property ../core/RandomLCG ../core/accessorSupport/decorators/subclass ../chunks/vec32 ../core/libs/gl-matrix-2/factories/vec3f64 ../geometry/support/coordinateSystem ../geometry/support/frustum ../libs/vxl/enums ../libs/vxl/VxlModule ../views/ViewingMode ../views/3d/layers/VoxelGraphic ../views/3d/layers/i3s/Intersector ../views/3d/state/Frustum ../views/3d/support/RenderCoordsHelper ../views/3d/webgl-engine/effects/RenderPlugin ../views/3d/webgl-engine/lib/Intersector ../views/3d/webgl-engine/lib/IntersectorInterfaces ../views/3d/webgl-engine/lib/RenderFeature ../views/3d/webgl-engine/lib/RenderSlot ../views/webgl/enums".split(" "),
function(B,C,A,x,F,y,D,G,z,H,I,J,K,v,u,L,M,N,O,P,Q,R,S,E,T,U,w){var k;(function(a){a[a.Lifetime=1]="Lifetime";a[a.RequestResponse=2]="RequestResponse";a[a.Rendering=3]="Rendering";a[a.Error=4]="Error"})(k||={});z=class extends R.SyncRenderPlugin{constructor(a){super(a);this._havePreparedWithAllLayers=this._textureFloatLinearAvailable=this._halfIntTexturesAvailable=!1;this._vxl=this._vxlPromise=this._renderPluginContext=null;this._moreToLoad=this._pluginIsActive=!1;this._viewportHeight=this._viewportWidth=
-1;this._newLayers=[];this._layers=new Map;this._renderTargetToRestore=this._rctx=null;this._lastFrameWasStationary=!1;this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536];this._wasmMemBlocks=new Map;this._dbgFlags=new Set;this._captureFrustum=!1;this._frustum=null;this._frustumRenderableId=-1;this._renderCoordsHelper=null;this.produces=new Map([[U.RenderSlot.VOXEL,()=>!!this._vxl&&"local"===this.view.viewingMode]]);this.type=E.IntersectorType.VOXEL;this.slicePlaneEnabled=!0;this.isGround=
!1;this.layerUid=[]}_dbg(a,b){this._dbgFlags.has(a)&&(a===k.Error?x.getLogger(this).error(b):x.getLogger(this).warn(b))}_removeRenderPlugin(){this._pluginIsActive&&this.view._stage&&(this._dbg(k.Lifetime,"--removeRenderPlugin--"),this.view._stage.removeRenderPlugin(this));this._pluginIsActive=!1}initialize(){this._dbg(k.Lifetime,"--initialize--");for(const a of this._wasmMemBlockSizes)this._wasmMemBlocks.set(a,0);this.addHandles([y.watch(()=>this.view.ready,a=>{a&&"local"===this.view.viewingMode?
(this._dbg(k.Lifetime,"view ready status changed to ready on a local view, calling addRenderPlugin"),this.view._stage.addRenderPlugin(this),this._pluginIsActive=!0):(this._dbg(k.Lifetime,"view ready status changed, not ready or not a local view!"),this._removeRenderPlugin())},y.initial),y.watch(()=>this.view?.qualityProfile,a=>{this._dbg(k.Rendering,"qualityProfile changed to "+a);this._vxl&&this._vxl.set_quality(this._toWasmQuality(a))},y.initial),y.watch(()=>this.view?.timeExtent,()=>{if(this._vxl){const a=
this._getTimeArgs(this.view?.timeExtent);this._dbg(k.Rendering,"sceneView timeExtent changed to useTime\x3d"+a.hasTime+" st\x3d"+a.startTime+" et\x3d"+a.endTime);this._vxl.set_scene_time_extent(a.startTime,a.endTime,a.hasTime);this._renderPluginContext.requestRender()}},y.initial),y.watch(()=>this.view?.stationary,a=>{this._vxl&&a&&!this._lastFrameWasStationary&&this._renderPluginContext.requestRender()})])}initializeRenderContext(a){this._dbg(k.Lifetime,"--initializeRenderContext--");const b=a.renderContext.rctx;
this._renderPluginContext=a;this._rctx=a.renderContext.rctx;this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16;this._textureFloatLinearAvailable=this._rctx.capabilities.textureFloatLinear;this._initializeWasm(b.gl)}uninitializeRenderContext(){this._rctx=this._renderPluginContext=null;this._dbg(k.Lifetime,"--uninitializeRenderContext--")}_restoreFramebuffer(){if(this._renderTargetToRestore){var a=this._renderTargetToRestore.fbo;this._rctx?(this._rctx.bindFramebuffer(a,!0),a=this._renderTargetToRestore.viewport,
this._rctx.setViewport(a.x,a.y,a.width,a.height)):this._dbg(k.Error,"no context in restoreFramebuffer!")}}_bindPreviousDepthToSlot(a,b){var c=!!this._renderTargetToRestore;if(!this._rctx||!c)return 0;c=this._renderTargetToRestore.fbo.depthStencilTexture;if(!c)return this._dbg(k.Error,"no depth/stencil texture exists!"),0;0===b?this._rctx.bindTexture(null,a,!0):this._rctx.bindTexture(c,a,!0);return 1}_modifyResourceCount(a,b,c){this._rctx?1===c?this._rctx.instanceCounter.increment(a,b):this._rctx.instanceCounter.decrement(a,
b):this._dbg(k.Error,"modifyAllocation callback has no rendering context!")}_setBlendState(a,b,c,d){this._rctx?(this._rctx.setBlendingEnabled(1===a),this._rctx.setBlendFunction(b,c),this._rctx.setBlendEquation(d)):this._dbg(k.Error,"setBlendState callback has no rendering context!")}_setFrontFace(a){this._rctx?this._rctx.setFrontFace(a):this._dbg(k.Error,"setFrontFace callback has no rendering context!")}_setDepthStencilStateFunction(a,b,c){this._rctx?(this._rctx.setDepthFunction(c),this._rctx.setDepthTestEnabled(1===
a),this._rctx.setDepthWriteEnabled(1===b),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(w.CompareFunction.ALWAYS,0,255),this._rctx.setStencilOpSeparate(w.Face.FRONT,w.StencilOperation.KEEP,w.StencilOperation.INCR,w.StencilOperation.KEEP),this._rctx.setStencilOpSeparate(w.Face.BACK,w.StencilOperation.KEEP,w.StencilOperation.DECR,w.StencilOperation.KEEP)):this._dbg(k.Error,"setDepthStencilStateFunction callback has no rendering context!")}_setRasterizerState(a){if(this._rctx)switch(a){case u.WasmCullMode.None:this._rctx.setFaceCullingEnabled(!1);
break;case u.WasmCullMode.Back:this._rctx.setCullFace(w.Face.BACK);this._rctx.setFaceCullingEnabled(!0);break;case u.WasmCullMode.Front:this._rctx.setCullFace(w.Face.FRONT),this._rctx.setFaceCullingEnabled(!0)}else this._dbg(k.Error,"setRasterizerState callback has no rendering context!")}_setViewport(a,b,c,d){this._rctx?this._rctx.setViewport(a,b,c,d):this._dbg(k.Error,"setViewport callback has no rendering context!")}_updateMemoryUsage(){this._layers.forEach((a,b)=>{a.needMemoryUsageUpdate&&(b=
this._vxl.estimate_memory_usage(b),0<=b&&(a.needMemoryUsageUpdate=!1,a.layerView.setUsedMemory(b)))})}_syncRequestsResponses(){this._layers.forEach((a,b)=>{const c=[];a.responses.forEach((e,g)=>{c.push(g);this._dbg(k.RequestResponse,"responding for requestID:"+g+" size:"+e.size);this._vxl.respond(b,g,e);if(e.requestType===u.VoxelRequestType.TreeIndex||e.requestType===u.VoxelRequestType.Section)a.needMemoryUsageUpdate=!0});const d=a.responses;for(var f of c)d.delete(f);f=this._vxl.get_new_requests(b);
const q=a.abortController.signal;for(const e in f){a.outstandingRequestCount+=1;1===a.outstandingRequestCount&&a.layerView.updatingFlagChanged();const g=f[e],n={responseType:"array-buffer",signal:q,query:{...a.layerView.layer.customParameters,token:a.layerView.layer.apiKey}};this._dbg(k.RequestResponse,"making requestID:"+e+" url:"+g.url);C(g.url,n).then(l=>{--a.outstandingRequestCount;0===a.outstandingRequestCount&&a.layerView.updatingFlagChanged();this._dbg(k.RequestResponse,"have response for requestID:"+
e);let r=0;if(0<l.data.byteLength){r=this._vxl._malloc(l.data.byteLength);const p=new Uint8Array(this._vxl.HEAPU8.buffer,r,l.data.byteLength),h=new Uint8Array(l.data);for(let t=0;t<l.data.byteLength;++t)p[t]=h[t]}d.set(+e,{responseType:g.responseType,ptr:r,size:l.data.byteLength,success:!0,requestType:g.requestType})}).catch(l=>{--a.outstandingRequestCount;0===a.outstandingRequestCount&&a.layerView.updatingFlagChanged();F.isAbortError(l)||(this._dbg(k.Error,`requestID:${e} failed, error=${l.toString()}`),
d.set(+e,{responseType:g.responseType,ptr:0,size:0,success:!1,requestType:g.requestType}))})}})}updateWasmCamera(a){this._vxl.set_projection_matrix.apply(this._vxl,a.projectionMatrix);this._vxl.set_view_matrix.apply(this._vxl,a.viewMatrix);this._vxl.set_near_far(a.near,a.far)}isUpdating(a){return!this._vxl&&this._vxlPromise?!0:(a=this._layers.get(a))?0<a.outstandingRequestCount:!1}getLayerTimes(a){const b=[];this._layers.forEach((c,d)=>{if(c.layerView.wasmLayerId===a.wasmLayerId)for(c=this._vxl.get_layer_epoch_times(d,
a.layer.currentVariableId),d=0;d<c.length;++d)b.push(c[d])});return b}getCurrentLayerTimeIndex(a){let b=0;this._layers.forEach((c,d)=>{c.layerView.wasmLayerId===a.wasmLayerId&&(b=this._vxl.get_layer_current_time_id(d))});return b}setEnabled(a,b){this._layers.forEach((c,d)=>{c.layerView.wasmLayerId===a.wasmLayerId&&(this._vxl.set_enabled(d,b),c.needMemoryUsageUpdate=!0,this._renderPluginContext.requestRender())})}setIsInScaleRange(a,b){const c=this._layers.get(a.wasmLayerId);c&&b!==c.isInScaleRange&&
(c.isInScaleRange=b,this._vxl.set_is_in_scale_range(a.wasmLayerId,b),c.needMemoryUsageUpdate=!b,this._renderPluginContext.requestRender())}setStaticSections(a,b){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.StaticSections,staticSections:b},!0)}setCurrentVariable(a,b){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.CurrentVariable,currentVariable:b},!0)}setRenderMode(a,b){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.RenderMode,renderMode:b},!0)}setVerticalExaggerationAndOffset(a,
b,c,d){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.ExaggerationAndOffset,volStyleDesc:{volumeId:b,verticalExaggeration:c,verticalOffset:d}},!0)}setVariableStyles(a,b){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.VariableStyles,variableStyles:b},!0)}setVolumeStyles(a,b){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.VolumeStyles,volumeStyles:b},!0)}setEnableDynamicSections(a,b){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.ContainerVisibility,containerIsVisible:b,container:u.ContainerType.DynamicSections},
!0)}setEnableIsosurfaces(a,b){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.ContainerVisibility,containerIsVisible:b,container:u.ContainerType.Isosurfaces},!0)}setEnableSections(a,b){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.ContainerVisibility,containerIsVisible:b,container:u.ContainerType.StaticSections},!0)}setAnalysisSlice(a,b,c,d){return this._doMaskedUIUpdate(a,{mask:u.UpdateFlags.AnalysisSlice,analysisSlice:{point:c,normal:d,enabled:b}},!0)}updateLayerTimeProperties(a){if(this._vxl){var b=
this._layers.get(a.wasmLayerId);if(b){b=b.layerView.layer;let c=0;b.timeOffset&&(c=D.convertTime(b.timeOffset.value,b.timeOffset.unit,"seconds"));const d=this._getTimeArgs(b.timeExtent);this._vxl.set_layer_time_properties(a.wasmLayerId,d.startTime,d.endTime,d.hasTime,b.useViewTime,c);this._renderPluginContext.requestRender()}}}_doMaskedUIUpdate(a,b,c){if(!this._vxl)return!1;let d=!1;this._layers.forEach((f,q)=>{f.layerView.wasmLayerId===a.wasmLayerId&&(f={str:JSON.stringify(b),byteCount:0,ptr:0,isReusable:!1},
this._allocateBlock(f)&&(d=1===this._vxl.handle_masked_ui_update(q,f.ptr,f.byteCount),f.isReusable||this._vxl._free(f.ptr)))});d&&c&&this._renderPluginContext.requestRender();return d}_addTriangleToWasmBuffer(a,b,c,d,f){a[3*b]=c[0];a[3*b+1]=c[1];a[3*b+2]=c[2];b+=1;a[3*b]=d[0];a[3*b+1]=d[1];a[3*b+2]=d[2];b+=1;a[3*b]=f[0];a[3*b+1]=f[1];a[3*b+2]=f[2];return b+1}_addNormalToWasmBuffer(a,b,c){a[3*b]=c[0];a[3*b+1]=c[1];a[3*b+2]=c[2];return b+1}_doCaptureFrustum(){if(this._vxl){var a=this._vxl._malloc(108*
Float32Array.BYTES_PER_ELEMENT),b=new Float32Array(this._vxl.HEAPF32.buffer,a,108),c=this._vxl._malloc(36*Float32Array.BYTES_PER_ELEMENT),d=new Float32Array(this._vxl.HEAPF32.buffer,c,36),f=this._frustum.points[v.PointIndex.NEAR_BOTTOM_LEFT],q=this._frustum.points[v.PointIndex.NEAR_BOTTOM_RIGHT],e=this._frustum.points[v.PointIndex.NEAR_TOP_RIGHT],g=this._frustum.points[v.PointIndex.NEAR_TOP_LEFT],n=this._frustum.points[v.PointIndex.FAR_BOTTOM_LEFT],l=this._frustum.points[v.PointIndex.FAR_BOTTOM_RIGHT],
r=this._frustum.points[v.PointIndex.FAR_TOP_RIGHT],p=this._frustum.points[v.PointIndex.FAR_TOP_LEFT],h=0,t=this._frustum.planes[v.PlaneIndex.NEAR];var m=this._addTriangleToWasmBuffer(b,0,e,q,f);h=this._addNormalToWasmBuffer(d,h,t);m=this._addTriangleToWasmBuffer(b,m,f,g,e);h=this._addNormalToWasmBuffer(d,h,t);t=this._frustum.planes[v.PlaneIndex.FAR];m=this._addTriangleToWasmBuffer(b,m,n,l,r);h=this._addNormalToWasmBuffer(d,h,t);m=this._addTriangleToWasmBuffer(b,m,r,p,n);h=this._addNormalToWasmBuffer(d,
h,t);t=this._frustum.planes[v.PlaneIndex.TOP];m=this._addTriangleToWasmBuffer(b,m,r,e,g);h=this._addNormalToWasmBuffer(d,h,t);m=this._addTriangleToWasmBuffer(b,m,g,p,r);h=this._addNormalToWasmBuffer(d,h,t);t=this._frustum.planes[v.PlaneIndex.BOTTOM];m=this._addTriangleToWasmBuffer(b,m,f,q,l);h=this._addNormalToWasmBuffer(d,h,t);m=this._addTriangleToWasmBuffer(b,m,l,n,f);h=this._addNormalToWasmBuffer(d,h,t);t=this._frustum.planes[v.PlaneIndex.LEFT];m=this._addTriangleToWasmBuffer(b,m,g,f,n);h=this._addNormalToWasmBuffer(d,
h,t);m=this._addTriangleToWasmBuffer(b,m,n,p,g);h=this._addNormalToWasmBuffer(d,h,t);f=this._frustum.planes[v.PlaneIndex.RIGHT];m=this._addTriangleToWasmBuffer(b,m,e,r,l);h=this._addNormalToWasmBuffer(d,h,f);m=this._addTriangleToWasmBuffer(b,m,l,q,e);h=this._addNormalToWasmBuffer(d,h,f);-1!==this._frustumRenderableId&&this._vxl.remove_generic_mesh(this._frustumRenderableId);this._frustumRenderableId=this._vxl.add_generic_mesh(a,108,c,36,255,0,0,64);this._vxl._free(a);this._vxl._free(c);this._captureFrustum=
!1;this._renderPluginContext.requestRender()}}captureFrustum(){null===this._renderCoordsHelper&&(this._renderCoordsHelper=Q.RenderCoordsHelper.create(M.ViewingMode.Local,K.renderSRFromViewSR(!1,this.view.spatialReference)));null===this._frustum&&(this._frustum=new P.Frustum(this._renderCoordsHelper));this._captureFrustum=!0;null!==this._renderPluginContext&&this._renderPluginContext.requestRender()}toggleFullVolumeExtentDraw(a){this._vxl&&this._layers.forEach((b,c)=>{b.layerView.wasmLayerId===a.wasmLayerId&&
(this._vxl.toggle_full_volume_extent_draw(c),this._renderPluginContext.requestRender())})}dropQueryRenderTarget(){this._vxl&&this._vxl.drop_query_rt()}addVoxelLayer(a){if(!this._vxl){const b={layerView:a,resolveCallback:null,rejectCallback:null};a=new Promise((c,d)=>{b.resolveCallback=c;b.rejectCallback=d});this._newLayers.push(b);return a}a=this._addVoxelLayer(a);return 0>a?Promise.reject(-1):Promise.resolve(a)}removeVoxelLayer(a){if(!this._vxl){var b=this._newLayers.findIndex(d=>a.uid===d.layerView.uid);
0<=b&&(this._newLayers[b].resolveCallback(-1),this._newLayers.splice(b,1));b=this._newLayers.length;0===b&&(this._dbg(k.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy());return b}let c=-1;this._layers.forEach((d,f)=>{d.layerView.wasmLayerId===a.wasmLayerId&&(c=f,d.abortController.abort(),this._vxl.remove_layer(c),d=this.layerUid.indexOf(a.layer.uid),-1!==d&&this.layerUid.splice(d,1))});0<=c&&this._layers.delete(c);b=this._layers.size;0===
b&&(this._dbg(k.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy());return b}_getBlockSize(a){for(const b of this._wasmMemBlockSizes)if(a<b)return b;return-1}_allocateBlock(a){a.byteCount=this._vxl.lengthBytesUTF8(a.str)+1;const b=this._getBlockSize(a.byteCount);0>b?(a.isReusable=!1,a.ptr=this._vxl._malloc(a.byteCount)):(a.isReusable=!0,a.ptr=this._wasmMemBlocks.get(b),0===a.ptr&&(a.ptr=this._vxl._malloc(b),this._wasmMemBlocks.set(b,a.ptr)));
return 0!==a.ptr?(this._vxl.stringToUTF8(a.str,a.ptr,a.byteCount),!0):!1}_getTimeArgs(a){let b=-Number.MAX_VALUE,c=Number.MAX_VALUE,d=!1;null!=a&&(a.isAllTime?d=!0:(null!=a.start&&(d=!0,b=a.start.getTime()/1E3),null!=a.end&&(d=!0,c=a.end.getTime()/1E3)));return{startTime:b,endTime:c,hasTime:d}}_addVoxelLayer(a){var b=a.layer,c=-1;c=b.getConfiguration();if(1>c.length)return-1;var d={str:c,byteCount:0,ptr:0,isReusable:!1};if(!this._allocateBlock(d))return-1;c=this._getTimeArgs(b.timeExtent);const f=
this.view.spatialReference.isWGS84&&b.spatialReference.isWGS84?111319.49079327357:1;let q=0;b.timeOffset&&(q=D.convertTime(b.timeOffset.value,b.timeOffset.unit,"seconds"));c=this._vxl.add_layer(b.serviceRoot,d.ptr,d.byteCount,f,f,c.startTime,c.endTime,c.hasTime,b.useViewTime,q,this._toWasmQuality(this.view.qualityProfile));d.isReusable||this._vxl._free(d.ptr);if(0<=c){b.test?.constantUpscaling&&(this._setUpscalingLimits(0,.25,.25),this._setUpscalingLimits(1,.5,.5),this._setUpscalingLimits(2,.75,.75));
b=new AbortController;this._layers.set(c,{layerView:a,responses:new Map,outstandingRequestCount:0,abortController:b,needMemoryUsageUpdate:!1,isInScaleRange:!0});this.layerUid.push(a.layer.uid);if(!this._halfIntTexturesAvailable||A("mac")){b=[];d="";for(var e of a.layer.variables)if("Int16"===e.renderingFormat.type||"UInt16"===e.renderingFormat.type)b.push(e.name),e.id===a.layer.currentVariableId&&(d=e.name);""!==d&&x.getLogger(this).error("#addVoxelLayer_error()",a.layer,`The voxel layer '${a.layer.title}' cannot render the current variable '${d}' in this browser`);
0<b.length&&x.getLogger(this).warn("#addVoxelLayer_warning()",a.layer,`The voxel layer '${a.layer.title}' cannot render the variables '${b.toString()}' in this browser`)}if(!this._textureFloatLinearAvailable){e=[];b="";for(const g of a.layer.variables)"Float32"===g.renderingFormat.type&&(e.push(g.name),g.id===a.layer.currentVariableId&&(b=g.name));""!==b&&x.getLogger(this).error("#addVoxelLayer_error()",a.layer,`The voxel layer '${a.layer.title}' cannot render the current variable '${b}' in this browser`);
0<e.length&&x.getLogger(this).warn("#addVoxelLayer_warning()",a.layer,`The voxel layer '${a.layer.title}' cannot render the variables '${e.toString()}' in this browser`)}A("esri-mobile")&&x.getLogger(this).warnOnce("Mobile support differs across devices. Voxel layer might not display as expected.");return c}return-1}prepareRender(a){if(this._vxl){var b=a.bind.camera.viewForward;a=a.bind.camera.eye;this._vxl.update_camera_pos_and_direction(a[0],a[1],a[2],b[0],b[1],b[2]);b=this._vxl.cull();this._dbg(k.RequestResponse,
"missingResourceCount\x3d"+b);this._moreToLoad=0<b;this._havePreparedWithAllLayers=0===this._newLayers.length;this._updateMemoryUsage()}}acquireTechniques(){return[]}render(a){if(this._vxl){for(var b of this._newLayers){const c=this._addVoxelLayer(b.layerView);-1===c?b.rejectCallback(-1):b.resolveCallback(c)}this._newLayers=[];if(0===this._layers.size)this._dbg(k.Error,"No voxel layers but RenderPlugin instance is being asked to render!");else{this._lastFrameWasStationary=this.view.stationary;this._syncRequestsResponses();
this._beforeDraw();this._vxl.begin_color_frame(!this.view._stage.renderer.isFeatureEnabled(T.RenderFeature.HighResolutionVoxel),a.bind.lighting.mainLight.direction[0],a.bind.lighting.mainLight.direction[1],a.bind.lighting.mainLight.direction[2]);b=this._renderTargetToRestore.viewport;if(b.width!==this._viewportWidth||b.height!==this._viewportHeight)this._viewportWidth=b.width,this._viewportHeight=b.height,this._vxl.set_viewport(b.width,b.height),this._layers.forEach(c=>{c.needMemoryUsageUpdate=!0});
0===b.x&&0===b.y||this._dbg(k.Error,"Unsupported viewport parameters detected!");this.updateWasmCamera(a.bind.camera);this._captureFrustum&&(this._frustum.update(a.bind.camera),this._doCaptureFrustum());this._vxl.draw();this._afterDraw();(this._moreToLoad||!this._havePreparedWithAllLayers&&0<this._layers.size)&&this._renderPluginContext.requestRender()}}}destroy(){this._dbg(k.Lifetime,"--destroy--");this._vxl&&(this._layers.forEach(a=>{a.abortController.abort()}),this._wasmMemBlocks.forEach(a=>{0!==
a&&this._vxl._free(a)}),this._vxl.uninitialize_voxel_wasm(),this._removeRenderPlugin(),this._vxl=null)}_initializeWasm(a){if(this._vxl)return Promise.resolve();this._vxlPromise||(this._vxlPromise=L.loadVoxelWASM(a).then(b=>{this._vxl=b;this._vxlPromise=null;if(0>=this._newLayers.length)this._dbg(k.Lifetime," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),this.destroy();else{b=this._getTimeArgs(this.view?.timeExtent);var c=this._vxl.addFunction(this._restoreFramebuffer.bind(this),
"v"),d=this._vxl.addFunction(this._setBlendState.bind(this),"viiii"),f=this._vxl.addFunction(this._setFrontFace.bind(this),"vi"),q=this._vxl.addFunction(this._setRasterizerState.bind(this),"vi"),e=this._vxl.addFunction(this._setDepthStencilStateFunction.bind(this),"viii"),g=this._vxl.addFunction(this._setViewport.bind(this),"viiii"),n=this._vxl.addFunction(this._bindPreviousDepthToSlot.bind(this),"iii"),l=this._vxl.addFunction(this._modifyResourceCount.bind(this),"viii"),r=this._halfIntTexturesAvailable&&
!A("mac");this._vxl.initialize_voxel_wasm(c,d,f,q,e,g,n,l,b.startTime,b.endTime,b.hasTime,r,this._textureFloatLinearAvailable);this._renderPluginContext&&this._renderPluginContext.requestRender()}}).catch(()=>{for(const b of this._newLayers)b.rejectCallback(-2);this._dbg(k.Error," WASM failed to download, removing RenderPlugin and destroying");this.destroy()}));return this._vxlPromise}pickDepth(a,b,c){if(!this._vxl||!this._rctx||0===this._layers.size)return null;const d=c.viewport[3]-b;if(0>a||a>
c.viewport[2]||0>b||b>c.viewport[3])return this._dbg(k.Error,`[js] pickDepth: outOfRange, screenXY=[${a.toFixed(0)}, ${d.toFixed(0)}]]`),null;this._beforeDraw();b=c.viewForward;const f=c.eye;this._vxl.update_camera_pos_and_direction(f[0],f[1],f[2],b[0],b[1],b[2]);this.updateWasmCamera(c);this._vxl.begin_frame();a=this._vxl.pick_depth(a,d);this._afterDraw();return a.success?a.distanceToCamera:null}pickObject(a,b,c,d){if(!this._vxl||!this._rctx||0===this._layers.size)return null;a=Math.round(a);b=Math.round(b);
if(0>a||a>c.viewport[2]||0>b||b>c.viewport[3])return this._dbg(k.Error,`[js] pickObject: outOfRange, screenXY=[${a}, ${b}], vp=[${c.viewport.toString()}]`),null;this._beforeDraw();const f=c.viewForward,q=c.eye;this._vxl.update_camera_pos_and_direction(q[0],q[1],q[2],f[0],f[1],f[2]);this.updateWasmCamera(c);this._vxl.begin_frame();c=null;0===d.length?c=this._vxl.pick_object(a,b,0,0):(d={str:JSON.stringify({layerIds:d}),byteCount:0,ptr:0,isReusable:!1},this._allocateBlock(d)&&(c=this._vxl.pick_object(a,
b,d.ptr,d.byteCount),d.isReusable||this._vxl._free(d.ptr)));this._afterDraw();return c}async getOtherFieldPopupValues(a,b){for(const r of a){var c=r.gpuResult;if(c){var d=this._layers.get(c.layerId);if(d&&d.layerView.layer.url){var f=d.layerView.layer,q={responseType:"array-buffer",signal:d.abortController.signal,query:{...d.layerView.layer.customParameters,token:d.layerView.layer.apiKey}},e=c.voxelSpacePosition;e=[Math.floor(e[0]/32),Math.floor(e[1]/32),Math.floor(e[2]/32)];e=[e[0]&-4,e[1]&-4,e[2]&
-4];var g=0;if(c.epochTime){d=this._vxl.get_layer_epoch_times(d.layerView.wasmLayerId,f.currentVariableId);for(var n=0;n<d.length;++n)if(d[n]===c.epochTime/1E3){g=n;break}}n=[];d={varIds:[],ptrs:[],sizes:[]};for(const p of b){var l=f.variables.findIndex(h=>h.name===p);-1!==l&&(l=f.variables.getItemAt(l)?.id,null!=l&&(n.push(C(`${f.url}/variables/${l}/${g}/bundles/0/${e[0]}-${e[1]}-${e[2]}`,q).then(h=>h.data)),d.varIds.push(l)))}f=await Promise.allSettled(n);q=f.length;for(e=0;e<q;++e)g=f[e],"fulfilled"===
g.status?(g=g.value,n=this._vxl._malloc(g.byteLength),(new Uint8Array(this._vxl.HEAPU8.buffer,n,g.byteLength)).set(new Uint8Array(g)),d.ptrs.push(n),d.sizes.push(g.byteLength)):d.varIds.splice(e,1);c=this._vxl.get_other_field_popup_values(c,d);for(f=0;f<d.ptrs.length;++f)this._vxl._free(d.ptrs[f]);if(c.continuousValues)for(const p in c.continuousValues)r.attributes[p]=c.continuousValues[p];if(c.uniqueValues)for(const p in c.uniqueValues)r.attributes[p]=c.uniqueValues[p]}}}return a}_beforeDraw(){this._renderTargetToRestore=
{fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};this._rctx.setPolygonOffsetFillEnabled(!1);this._rctx.setScissorTestEnabled(!1);this._rctx.setColorMask(!0,!0,!0,!0)}_afterDraw(){this._renderTargetToRestore.fbo=null;this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit());this._rctx.externalVertexArrayObjectUpdate();this._rctx.externalVertexBufferUpdate();this._rctx.externalProgramUpdate()}intersect(a,b,c,
d,f){if(this._vxl&&this._rctx&&0!==this._layers.size&&a.options.selectionMode&&!a.options.isFiltered){if(null==f||0>f[0]||f[0]>a.camera.viewport[2]||0>f[1]||f[1]>a.camera.viewport[3])return this._dbg(k.Error,`[js] VoxelWasmPerScene.intersect: outOfRange, screenXY=[${f[0].toFixed(0)}, ${f[1].toFixed(0)}]`),null;var q=[];this._layers.forEach(n=>{a.options.filteredLayerUids.includes(n.layerView.layer.uid)&&q.push(n.layerView.wasmLayerId)});var e=this.pickObject(f[0],f[1],a.camera,q);if(null!=e&&-1!==
e.layerId){var g=this._layers.get(e.layerId);if(g){const n=g.layerView.layer.uid;b=e.distanceToCamera;c=I.distance(c,d);const l=b/c,r=J.create();r[0]=e.worldX;r[1]=e.worldY;r[2]=e.worldZ;const p={},h=g.layerView.layer;c=h.variables.findIndex(m=>m.id===h.currentVariableId);0<=c&&(c=h.variables.getItemAt(c),null!=c&&(null!=e.continuousValue?p[c.name]=e.continuousValue:null!=e.uniqueValueLabel&&null!=e.uniqueValue?p[c.name]=`${e.uniqueValueLabel} (${e.uniqueValue})`:null!=e.uniqueValue&&(p[c.name]=`${e.uniqueValue}`),
0<c.description.length?p["Voxel.CurrentVariable"]=c.description:0<c.name?.length&&(p["Voxel.CurrentVariable"]=c.name)));p["Voxel.Position"]=`[${e.voxelSpacePosition.toString()}]`;null!=e.epochTime&&null!=e.nativeTime&&null!=e.nativeTimeUnits&&(p["Voxel.LocalTime"]=new Date(e.epochTime),p["Voxel.SourceTime"]=`${e.nativeTime.toLocaleString()} ${e.nativeTimeUnits}`);null!=e.depth&&(p["Voxel.Depth"]=e.depth);const t=e.faceNormal;p["Voxel.WorldPosition"]=`[${r[0]}, ${r[1]}, ${r[2]}]`;c=m=>{const V=new O.VoxelTarget(r,
n,()=>this._createVoxelGraphic(g.layerView.layer,p,e));m.set(this.type,V,l,t)};d=a.results;b=a.options.store===E.StoreResults.ALL;(null==d.min.dist||l<d.min.dist)&&c(d.min);(null==d.max.dist||l>d.max.dist)&&c(d.max);b&&(d=S.newIntersectorResult(a.ray),c(d),a.results.all.push(d))}}}}_createVoxelGraphic(a,b,c){return new N.VoxelGraphic({layer:a,sourceLayer:a,attributes:b,gpuResult:c})}_toWasmQuality(a){switch(a){case "low":return 0;case "medium":return 1;case "high":return 2}}_setUpscalingLimits(a,
b,c){this._vxl&&this._vxl.set_upscaling_limits(a,b,c)}};B.__decorate([G.property({constructOnly:!0})],z.prototype,"view",void 0);return z=B.__decorate([H.subclass("esri.layers.VoxelWasmPerSceneView")],z)});