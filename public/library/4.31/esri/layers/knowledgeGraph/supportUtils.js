// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.31/esri/copyright.txt for details.
//>>built
define("exports ../../geometry ../../Graphic ../../request ../../symbols ../../core/Error ../../core/MapUtils ../GraphicsLayer ../graphics/featureConversionUtils ../graphics/OptimizedGeometry ./layerUtils ./SessionMemoryStorage ../../libs/linkchartlayout/LinkChartLayout ../../rest/knowledgeGraphService ../../rest/knowledgeGraph/GraphQueryStreaming ../../rest/knowledgeGraph/ProtoFeatureCollection ../../rest/knowledgeGraph/wasmInterface/knowledgeWasmAccess ../../rest/knowledgeGraph/wasmInterface/WasmDataModelWrapperInterfaces ../../rest/knowledgeGraph/wasmInterface/WasmSerializedLayerData ../../rest/knowledgeGraph/wasmInterface/wasmToFeatureFactories ../../symbols/CIMSymbol ../../geometry/Polyline ../../symbols/SimpleFillSymbol ../../geometry/Polygon ../../symbols/TextSymbol ../../geometry/Point".split(" "),
function(p,ca,y,F,da,u,G,P,Q,R,S,T,z,H,I,q,x,J,v,U,V,W,X,Y,Z,aa){async function K(b){var a=await x.getWasmInterface();const e=new a.MapOfObjectIdentifierSets;for(const [c,h]of b.namedTypeDefinitions){if(!h.members||h.useAllData)continue;b=h.members.keys();let d=!1,k=!0;const g=new a.ObjectIdArray,f=new a.StringArray,l=new a.GlobalIdArray,m=new a.IdentifierArray,n=new a.ObjectIdentifierSet;for(const t of b)k&&(d=!isNaN(Number(t)),k=!1),d?g.add_objectid(Number(t)):(f.add_string(t),l.add_globalid(t)),
m.add_identifier(t);n.set_oid_array(g);n.set_string_array(f);n.set_globalid_array(l);n.set_identifier_array(m);g.delete();f.delete();l.delete();m.delete();e.put_identifier_set(c,n);n.delete()}a=new a.MapOfObjectIdentifierSetsEncoder;try{a.set_map_of_identifier_sets(e);a.encode();const c=a.get_encoding_result();if(0!==c.error.error_code)throw new u("knowledge-graph:layer-support-utils",c.error.error_message);const h=structuredClone(c.get_byte_buffer());a.delete();return h}finally{e.delete()}}function A(b,
a,e,c,h,d){b.version="";const k=new a.QueryResult,g=new a.FeatureResult,f="entities"===c?q.ProtoOutboundEntityFeatureCollectionAttributionIndexes:q.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes;g.unique_id_field={name:f[f.ELEMENTUID],isSystemMaintained:!1};g.globalid_field_name=f[f.ELEMENTUID];g.geohash_field_name="";g.geometry_properties={shapeAreaFieldName:"",shapeLengthFieldName:"",units:""};g.spatial_reference={wkid:4326,latestWkid:4326,vcsWkid:0,latestVcsWkid:0,wkt:""};g.exceeded_transfer_limit=
!1;g.has_z=!1;g.has_m=!1;g.transform={quantizeOriginPosition:{value:v.WasmQuantizeOriginPositionTypeCode.upperLeft},scale:{xScale:1E-9,yScale:1E-9,mScale:1E-4,zScale:1E-4},translate:{xTranslate:-400,yTranslate:-400,mTranslate:-1E5,zTranslate:-1E5}};for(var l of Object.keys(f).filter(n=>isNaN(Number(n)))){const n=new a.Field;n.name=l;n.alias=l;n.sql_type={value:v.SqlTypeCode.sqlTypeBigInt};if("entities"===c)switch(l){case f[f.ELEMENTUID]:case f[f.TYPENAME]:n.field_type={value:J.EsriFieldTypes.esriFieldTypeString}}else switch(l){case f[f.ELEMENTUID]:case f[f.TYPENAME]:case q.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes[q.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes.FROMUID]:case q.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes[q.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes.TOUID]:n.field_type=
{value:J.EsriFieldTypes.esriFieldTypeString}}n.domain="";g.add_field(n);n.delete()}l=new Map;for(var m of h.dataModel.entityTypes)l.set(m.name,"entities");for(const n of h.dataModel.relationshipTypes)l.set(n.name,"relationships");for(const [n,t]of e.namedTypeDefinitions)if(c===l.get(n))for(const r of t.members.values()){e=new a.Feature;for(const L of Object.keys(f).filter(ba=>isNaN(Number(ba))))if("entities"===c)switch(L){case f[f.ELEMENTUID]:e.add_attribute(r.id,a.esriFieldType.esriFieldTypeString);
break;case f[f.TYPENAME]:e.add_attribute(n,a.esriFieldType.esriFieldTypeString)}else switch(L){case f[f.ELEMENTUID]:e.add_attribute(r.id,a.esriFieldType.esriFieldTypeString);break;case q.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes[q.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes.FROMUID]:e.add_attribute(d.has(r.id)?d.get(r.id)[0]:"",a.esriFieldType.esriFieldTypeString);break;case q.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes[q.ProtoOutboundRelationshipFeatureCollectionAttributionIndexes.TOUID]:e.add_attribute(d.has(r.id)?
d.get(r.id)[1]:"",a.esriFieldType.esriFieldTypeString);break;case f[f.TYPENAME]:e.add_attribute(n,a.esriFieldType.esriFieldTypeString)}let w;r.linkChartLocation&&"x"in r.linkChartLocation?w=Q.convertFromGeometry(r.linkChartLocation):r.linkChartLocation&&(w=r.linkChartLocation);if(r.linkChartLocation&&w){h=new a.FeatureCollectionGeometry;m=!1;switch(c){case "entities":h.geometry_type=a.esriGeometryType.esriGeometryPoint;m=!0;break;case "relationships":h.geometry_type=a.esriGeometryType.esriGeometryPolyline}h.coords=
new Float64Array(w.coords);h.lengths=new Uint32Array(m?[1]:w.lengths);e.set_compressed_geometry(h);h.delete()}g.add_feature(e);e.delete()}switch(c){case "entities":g.geometry_type=a.esriGeometryType.esriGeometryPoint;break;case "relationships":g.geometry_type=a.esriGeometryType.esriGeometryPolyline}k.set_feature_result(g);b.set_query_result(k);g.delete();k.delete();return b}async function B(b){b=await (await F(b,{responseType:"array-buffer"})).data;return M(b)}async function M(b){const a=new ((await x.getWasmInterface()).FeatureCollectionDecoder);
b=a.decode(new Uint8Array(b));if(0!==b.error_code)throw new u("knowledge-graph:layer-support-utils",b.error_message);b=a.get_feature_collection();b=U.wasmToProtoFeatureCollection(b);a.delete();return b}async function C(b){b=await (await F(b,{responseType:"array-buffer"})).data;return N(new Uint8Array(b))}async function N(b){const a=new ((await x.getWasmInterface()).MapOfObjectIdentifierSetsDecoder);var e=a.decode(new Uint8Array(b));b=new Map;if(0!==e.error_code)throw new u("knowledge-graph:layer-support-utils",
e.error_message);e=a.get_map_of_identifier_sets();const c=e.keys,h=c.size();for(let f=0;f<h;f++){const l=c.get(f);var d=e.query_identifier_set(l);const m=[];if(d.id_array_type.value===v.IdArrayType.GLOBALID_ARRAY){d=d.get_globalid_array();var k=d.count();for(var g=0;g<k;g++)m.push(d.get_globalid_at(g))}else if(d.id_array_type.value===v.IdArrayType.IDENTIFIER_ARRAY)for(d=d.get_identifier_array(),k=d.count(),g=0;g<k;g++)m.push(d.get_identifier_at(g).toString());else if(d.id_array_type.value===v.IdArrayType.STRING_ARRAY)for(d=
d.get_string_array(),k=d.count(),g=0;g<k;g++)m.push(d.get_string_at(g));else if(d.id_array_type.value===v.IdArrayType.OID_ARRAY)for(d=d.get_oid_array(),k=d.count(),g=0;g<k;g++)m.push(d.get_objectid_at(g).toString());else throw new u("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");b.set(l,m)}a.delete();return b}function D(b,a){if(!b?.queryResult?.featureResult)return a;const e=b.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const c of b.queryResult.featureResult.features){b=
G.getOrCreateMapValue(a.namedTypeDefinitions,c.attributes[e[q.ProtoInboundFeatureCollectionAttributionNames.TYPENAME]],()=>({useAllData:!1,members:new Map}));const h=c.attributes[e[q.ProtoInboundFeatureCollectionAttributionNames.ELEMENTUID]];if(0<c.compressedGeometry?.coords?.length){let d=c.compressedGeometry.lengths;"esriGeometryPoint"===c.compressedGeometry.geometryType&&(d=[]);b.members.set(h,{id:h,linkChartLocation:new R(d,c.compressedGeometry.coords)})}else b.members.set(h,{id:h})}return a}
function E(b,a){for(const [e,c]of b){b=G.getOrCreateMapValue(a.namedTypeDefinitions,e,()=>({useAllData:!1,members:new Map}));for(const h of c)b.members.has(h)||b.members.set(h,{id:h})}return a}const O=(b,a)=>{a.set_feature_collection(b);a.encode();b=a.get_encoding_result();if(0!==b.error.error_code)throw new u("knowledge-graph:layer-support-utils",b.error.error_message);return b.get_byte_buffer()};p.addFeatureCollectionToInclusionDefinition=D;p.addIdMapToInclusionDefinition=E;p.deserializeFeatureCollection=
M;p.deserializeIdCollectionMap=N;p.extentToInBoundsRings=function(b){if(!b.spatialReference.isWGS84)throw new u("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");return b.clone().normalize().map(a=>[[a.xmin,a.ymin],[a.xmin,a.ymax],[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]])};p.fetchAndConvertSerializedKgIdMap=async function(b,a){a??=!1;const e={generateAllSublayers:a,namedTypeDefinitions:new Map};await C(b).then(c=>{E(c,e)});
return e};p.fetchAndConvertSerializedLinkChart=async function(b){const a=[],e={generateAllSublayers:!1,namedTypeDefinitions:new Map};b.entitiesUrl&&a.push(B(b.entitiesUrl).then(c=>{D(c,e)}));b.relationshipsUrl&&a.push(B(b.relationshipsUrl).then(c=>{D(c,e)}));b.idCollectionsUrl&&a.push(C(b.idCollectionsUrl).then(c=>{E(c,e)}));await Promise.all(a);return e};p.fetchAndDeserializeFeatureCollection=B;p.fetchAndDeserializeIdCollectionMap=C;p.getChronologicalOverlay=b=>{const a=[];var e={type:"CIMGeometricEffectCut",
beginCut:3,endCut:3};for(var c of b.chronologicalAuxiliaryGraphics?.lines??[]){var h={type:"CIMSolidStroke",enable:!0,width:c.width,color:[c.color.r,c.color.g,c.color.b,Math.round(c.color.a/100*255)],effects:0<c.dashPattern.length?[{type:"CIMGeometricEffectDashes",dashTemplate:c.dashPattern,lineDashEnding:"NoConstraint"},e]:[e]},d={type:"CIMVectorMarker",enable:!0,size:10,frame:{xmin:-5,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[-2.06,
-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:[c.color.r,c.color.g,c.color.b,Math.round(c.color.a/100*255)]}]}}],markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineEnd",offsetAlongLine:0}};h=new V({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:c.arrowheadSizeAtEnd?[h,d]:[h]}}});for(const f of c.elements)d=new W({paths:[[[f.origin.x,f.origin.y],[f.destination.x,f.destination.y]]]}),a.push(new y({geometry:d,
symbol:h}))}for(var k of b.chronologicalAuxiliaryGraphics?.polygons??[]){e=new X({color:[k.color.r,k.color.g,k.color.b,k.color.a/100],style:"solid",outline:null});for(var g of k.elements)c=new Y({rings:[g.points.map(f=>[f.x,f.y])]}),a.push(new y({geometry:c,symbol:e}))}for(const f of b.chronologicalAuxiliaryGraphics?.texts??[]){b="middle";k="center";switch(f.direction?.value){case z.Direction2D.left:k="right";break;case z.Direction2D.right:k="left";break;case z.Direction2D.bottom:b="bottom"}for(const l of f.elements)g=
new Z({color:[f.color.r,f.color.g,f.color.b,f.color.a/100],text:l.str,font:{size:f.height,weight:"bold"},verticalAlignment:b,horizontalAlignment:k}),e=new aa({x:l.anchor.x,y:l.anchor.y}),a.push(new y({geometry:e,symbol:g}))}return new P({graphics:a,listMode:"hide",title:"ESRI__ChronologicalLayoutOverlay",id:"ESRI__ChronologicalLayoutOverlay"})};p.getDefaultChronologicalOverlayLayerId=()=>"ESRI__ChronologicalLayoutOverlay";p.getRelationshipEndNodeIds=async function(b,a){const e=[],c=new Map,h=[];if(a.dataModel?.relationshipTypes)for(const d of a.dataModel.relationshipTypes)d.name&&
c.set(d.name,[]);for(const d of b)c.has(d.typeName)&&c.get(d.typeName)?.push(d.id);for(const [d,k]of c)1>k.length||(b=new I({openCypherQuery:`MATCH (n)-[r:${d}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:k}}),h.push(H.executeQueryStreaming(a,b).then(async g=>{for(g=g.resultRowsStream.getReader();;){const {done:f,value:l}=await g.read();if(f)break;for(const m of l)e.push({id:m[0],typeName:m[1]}),e.push({id:m[2],typeName:m[3]})}})));await Promise.all(h);
return e};p.getRelationshipEndNodeMap=async function(b,a){const e=new Map,c=new Map,h=[];if(a.dataModel?.relationshipTypes)for(const d of a.dataModel.relationshipTypes)d.name&&c.set(d.name,[]);for(const d of b)c.has(d.typeName)&&c.get(d.typeName)?.push(d.id);for(const [d,k]of c)1>k.length||(b=new I({openCypherQuery:`MATCH (n)-[r:${d}]->(m) WHERE id(r) in $ids RETURN id(r), id(n), id(m)`,bindParameters:{ids:k}}),h.push(H.executeQueryStreaming(a,b).then(async g=>{for(g=g.resultRowsStream.getReader();;){const {done:f,
value:l}=await g.read();if(f)break;for(const m of l)e.set(m[0],[m[1],m[2]])}})));await Promise.all(h);return e};p.loadRecordsIntoLocalCache=(b,a)=>{const e=new Map;for(const c of[...(a.entityTypes??[]),...(a.relationshipTypes??[])])for(const h of c.properties??[])h.geometryType&&"esriGeometryNull"!==h.geometryType&&e.set(c.name,h.name??"");a=T.getInstance();for(const c of b)a.writeToStore([c],S.systemOidFieldName,e.get(c.typeName??"")??"")};p.serializeInclusionDefinitionToAllPbf=async function(b,
a,e){const c=await x.getWasmInterface(),h=new c.FeatureCollection,d=new c.FeatureCollection;try{A(h,c,b,"entities",a,e);A(d,c,b,"relationships",a,e);const k=new c.FeatureCollectionEncoder,g=new c.FeatureCollectionEncoder,f=O(h,k),l=structuredClone(f),m=O(d,g),n=structuredClone(m),t={entitiesFC:l,relationshipsFC:n,idCollections:await K(b)};k.delete();g.delete();return t}finally{h.delete(),d.delete()}};p.serializeInclusionDefinitionToIdCollectionsMapPbf=K;p.setFeatureCollectionProperties=A;Object.defineProperty(p,
Symbol.toStringTag,{value:"Module"})});