/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import{g as t,u as i}from"../../../chunks/featureReferenceUtils.js";import s from"../../../core/Accessor.js";import{i as r,equals as o,h as a}from"../../../core/lang.js";import{L as n}from"../../../chunks/Logger.js";import{d as l,a as c,c as h,f as d}from"../../../chunks/maybe.js";import{watch as p,initial as u,syncAndInitial as m,mapCollection as v,sync as f,when as w}from"../../../core/reactiveUtils.js";import{property as g}from"../../../core/accessorSupport/decorators/property.js";import{subclass as _}from"../../../core/accessorSupport/decorators/subclass.js";import{m as b,n as V,i as y,u as j,d as M,j as S,g as D,s as k,f as T,b as O,k as C,y as x,c as P,o as R,e as A}from"../../../chunks/vec3.js";import{c as F,f as E,a as U,e as H,z}from"../../../chunks/vec3f64.js";import{tryProjectWithZConversion as L,canProjectWithoutEngine as I,isLoaded as B}from"../../../geometry/projection.js";import{A as N}from"../../../chunks/AnalysisView3D.js";import{L as W,l as G}from"../../../chunks/LineVisualElement.js";import{h as q,m as Q,d as X}from"../../../chunks/handleUtils.js";import K from"../../../Color.js";import{d as Y,r as J,c as Z}from"../../../chunks/mathUtils.js";import{f as $,F as ee,D as te,z as ie,B as se,m as re,b as oe,A as ae,x as ne,q as le,s as ce}from"../../../chunks/mat4.js";import{c as he,I as de}from"../../../chunks/mat4f64.js";import{C as pe,R as ue}from"../../../chunks/basicInterfaces.js";import{R as me}from"../../../chunks/Material.js";import"../../../geometry.js";import ve from"../../../analysis/Viewshed.js";import{g as fe,o as we,c as ge,p as _e}from"../../../chunks/plane.js";import{c as be}from"../../../chunks/asyncUtils.js";import{c as Ve,C as ye}from"../../../chunks/Cyclical.js";import{after as je,throwIfAborted as Me}from"../../../core/promiseUtils.js";import{v as Se}from"../../../chunks/ViewingMode.js";import De from"../../../core/Handles.js";import{f as ke}from"../../../chunks/boundedPlane.js";import{b as Te,a as Oe,R as Ce,M as xe,c as Pe}from"../../../chunks/RenderObject.js";import{a as Re,d as Ae}from"../../../chunks/dragEventPipeline3D.js";import{l as Fe,m as Ee}from"../../../chunks/cameraUtils.js";import{I as Ue,M as He,d as ze,a as Le,b as Ie}from"../../../chunks/MoveManipulation.js";import{c as Be,i as Ne,g as We,d as Ge}from"../../../chunks/GeometryUtil.js";import{a as qe}from"../../../chunks/Util.js";import{R as Qe}from"../../../chunks/RibbonLineMaterial.js";import{c as Xe,e as Ke,r as Ye,d as Je}from"../../../chunks/InteractiveToolBase.js";import{a as Ze}from"../../../chunks/interfaces.js";import{e as $e}from"../../../chunks/ray.js";import{o as et}from"../../../chunks/sliceToolConfig.js";import{C as tt}from"../../../chunks/ColorMaterial.js";import"../../../chunks/tracking.js";import"../../../core/Error.js";import{E as it}from"../../../chunks/EditGeometryOperations.js";import{S as st}from"../../../chunks/settings.js";import{a as rt}from"../../../chunks/ExtendedLineVisualElement.js";import{L as ot}from"../../../chunks/LaserlineVisualElement.js";import{t as at}from"../../../chunks/intersectorUtilsConversions.js";import{A as nt}from"../../../chunks/AnalysisToolBase.js";import{s as lt}from"../../../chunks/keybindings.js";import{n as ct}from"../../../chunks/ToolIntersector.js";import{a as ht}from"../../../chunks/screenUtils2.js";import dt from"../../../geometry/Point.js";import{P as pt}from"../../../chunks/PointVisualElement.js";import{O as ut}from"../../../chunks/Object3DVisualElement.js";import{A as mt}from"../../../chunks/Attribute.js";import{G as vt,a6 as ft,N as wt,S as gt,a7 as _t,R as bt,X as Vt,h as yt,b as jt,P as Mt,a3 as St,k as Dt,l as kt}from"../../../chunks/StencilUtils.js";import{V as Tt}from"../../../chunks/VertexAttribute.js";import{c as Ot}from"../../../chunks/lineStippleUtils.js";import{n as Ct}from"../../../chunks/Intersector3.js";import{S as xt}from"../../../chunks/intersectorUtils.js";import Pt from"../../../core/Collection.js";import{h as Rt}from"../../../chunks/sphere.js";import{InternalRenderCategory as At}from"../webgl.js";import Ft from"../webgl/RenderNode.js";import{N as Et,R as Ut}from"../../../chunks/NormalFromDepth.glsl.js";import{C as Ht,D as zt}from"../../../chunks/SceneLighting.js";import{c as Lt,b as It}from"../../../chunks/vec4f64.js";import Bt from"../webgl/RenderCamera.js";import{j as Nt}from"../../../chunks/enums.js";import{S as Wt,B as Gt}from"../../../chunks/ScreenSpacePass.glsl.js";import{C as qt}from"../../../chunks/CameraSpace.glsl.js";import{N as Qt,g as Xt}from"../../../chunks/interfaces3.js";import{a as Kt,F as Yt,c as Jt}from"../../../chunks/Matrix4PassUniform.js";import{R as Zt,M as $t}from"../../../chunks/Matrix4sPassUniform.js";import{m as ei,d as ti,p as ii}from"../../../chunks/renderState.js";import{c as si,r as ri,a as oi}from"../../../chunks/analysisViewUtils.js";import"../../../chunks/metadata.js";import"../../../chunks/utils.js";import"../../../chunks/ObservableBase.js";import"../../../core/scheduling.js";import"../../../config.js";import"../../../chunks/ensureType.js";import"../../../core/Evented.js";import"../../../chunks/shared.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/common.js";import"../../../chunks/unitUtils.js";import"../../../chunks/jsonMap.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../core/JSONSupport.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../chunks/reader.js";import"../../../geometry/SpatialReference.js";import"../../../chunks/writer.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/coordsUtils.js";import"../../../chunks/Axis.js";import"../../../chunks/extentUtils.js";import"../../../chunks/boundsUtils.js";import"../../../chunks/aaBoundingRect.js";import"../../../geometry/Polyline.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/geodesicConstants.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../core/Promise.js";import"../../../chunks/ElevationProvider.js";import"../../../chunks/dehydratedFeatureUtils.js";import"../../../chunks/line.js";import"../../../chunks/vec2.js";import"../../../chunks/vec2f64.js";import"../../../chunks/aaBoundingBox.js";import"../../../chunks/Indices.js";import"../../../chunks/colorUtils.js";import"../../../chunks/typeUtils.js";import"../../../geometry/support/jsonUtils.js";import"../../../core/Clonable.js";import"../../../chunks/mat3.js";import"../../../chunks/mat3f64.js";import"../../../chunks/quatf64.js";import"../../../chunks/mathUtils2.js";import"../../../chunks/lineSegment.js";import"../../../chunks/vec4.js";import"../../../chunks/Intersector.js";import"../../../chunks/Intersector2.js";import"../../../chunks/compilerUtils.js";import"../../../chunks/screenUtils.js";import"../../../chunks/computeTranslationToOriginAndRotation.js";import"../../../chunks/hydratedFeatures.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../layers/support/fieldUtils.js";import"../../../core/sql.js";import"../../../intl.js";import"../../../chunks/date.js";import"../../../chunks/locale.js";import"../../../chunks/datetime.js";import"../../../chunks/number.js";import"../../../chunks/substitute.js";import"../../../chunks/messages.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../chunks/enumeration.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../core/Identifiable.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../symbols.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils4.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../chunks/opacityUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils5.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../symbols/Font.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../chunks/persistableUrlUtils.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../portal/Portal.js";import"../../../core/Loadable.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/SimpleMarkerSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/dehydratedPoint.js";import"../../../chunks/elevationInfoUtils.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../chunks/ray2.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/graphicUtils.js";import"../../../chunks/meshVertexSpaceUtils.js";import"../../../geometry/support/MeshGeoreferencedVertexSpace.js";import"../../../geometry/support/MeshLocalVertexSpace.js";import"../../../chunks/BufferView.js";import"../../../chunks/InterleavedLayout.js";import"../../../chunks/types.js";import"../../../chunks/AlphaCutoff.js";import"../../../chunks/RayIntersections.js";import"../../../chunks/VertexColor.glsl.js";import"../../../chunks/VertexPosition.glsl.js";import"../../../chunks/Matrix3DrawUniform.js";import"../../../chunks/BindType.js";import"../../../chunks/ShaderTechniqueConfiguration.js";import"../../../chunks/verticalOffsetUtils.js";import"../../../chunks/orientedBoundingBox.js";import"../../../chunks/quat.js";import"../../../chunks/spatialReferenceEllipsoidUtils.js";import"../../../Camera.js";import"../../../CameraLayout.js";import"../../../chunks/projectPointToVector.js";import"../../../chunks/projectVectorToPoint.js";import"../../../chunks/projectVectorToVector.js";import"../../../chunks/frustum.js";import"../../../chunks/earthUtils.js";import"../../../chunks/spatialReferenceSupport.js";import"../../../chunks/vec3f32.js";import"../../../chunks/sdfPrimitives.js";import"../../../chunks/doublePrecisionUtils.js";import"../../../chunks/floatRGBA.js";import"../../../chunks/Octree.js";import"../../../chunks/RgbaFloatEncoding.glsl.js";import"../../../chunks/Texture.js";import"../../../chunks/GLObjectType.js";import"../../../chunks/TriangleMaterial.js";import"../../../chunks/geometry2dUtils.js";import"../../../chunks/EngineVisualElement.js";import"../../../chunks/GridLocalOriginFactory.js";import"../../../chunks/MergedRenderer.js";import"../../../chunks/NestedMap.js";import"../../../chunks/glUtil.js";import"../../../chunks/VertexElementDescriptor.js";import"../../../chunks/VisualElement.js";import"../../../chunks/RenderGeometry.js";import"../../../chunks/debugFlags2.js";import"../../../core/signal.js";import"../../../chunks/axisAngleDegrees.js";import"../../../chunks/weather.js";import"../environment/CloudyWeather.js";import"../environment/FoggyWeather.js";import"../environment/RainyWeather.js";import"../environment/SnowyWeather.js";import"../environment/SunnyWeather.js";import"../../../chunks/Float4DrawUniform.js";import"../../../chunks/HighlightDefaults.js";import"../../../chunks/VertexArrayObject2.js";import"../../../chunks/VertexArrayObject.js";import"../../../chunks/BufferObject.js";import"../../../chunks/HUDRenderStyle.js";import"../../../chunks/Scheduler.js";import"../../../chunks/debugFlags.js";import"../../../chunks/Blit.js";import"../../../chunks/InputManager.js";import"../../../chunks/Queue.js";import"../../../chunks/ElevationContext.js";import"../../../chunks/HUDMaterial.js";import"../../../chunks/HUDVisibility.glsl.js";import"../../../chunks/VerticalOffset.glsl.js";import"../../../chunks/GLTextureMaterial.js";import"../../../chunks/triangle.js";import"../../../chunks/requestImageUtils.js";import"../../../chunks/NormalAttribute.glsl.js";const ai=Y(2),ni=new class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=4,this.fovFocusedArcWidth=2*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=2/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}},li=new class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new K([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:K.toUnitRGBA(new K([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:me.Occlude,cullFace:pe.Back,writeDepth:!1}}};function ci({tiltedUpVector:e,rightVector:t,observerRenderSpace:i},s){const r=Te(e,t,i,s);return r[12]=0,r[13]=0,r[14]=0,r}function hi(e,t,i,s){const r=F(),o=fe(i.plane),a=function(e,t){const i=pi;e.renderCoordsHelper.toRenderCoords(e.camera.position,i);const s=Fe(e,i,e.camera.heading,e.camera.tilt,Ee()).direction;return J(j(s,t))-90}(t,o);let n;if(Math.abs(a)>ni.viewAngleThreshold)n=e.next(Re(t,i.plane));else{const r=we(s.targetRenderSpace,i.basis1,ge()),o=V(pi,i.basis1),a=V(ui,i.basis2);n=e.next(Re(t,r)).next((e=>{const t=e=>{const t=M(S(mi,e,i.origin),a),r=Math.acos(Z(t/s.farDistanceRenderSpace,-1,1)),n=Math.sin(r)*s.farDistanceRenderSpace;return D(F(),i.origin,D(F(),k(mi,o,n),k(vi,a,t)))},r=t(e.renderStart),n=t(e.renderEnd);return{...e,renderStart:r,renderEnd:n}}))}return n.next((e=>{"start"===e.action&&y(r,e.renderStart);const t=J(Oe(r,e.renderEnd,i.origin,o));return{...e,deltaAngle:t}}))}function di(e,t,i,s){return $(fi,i,s),b(e,t,fi)}const pi=F(),ui=F(),mi=F(),vi=F(),fi=he();class wi extends Ue{constructor(e){super(),this._handles=new De,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles=l(this._handles),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const i=Object.values(this._manipulators);return q(i.map((({manipulator:i,side:s})=>Xe(i,((i,r,o,a,n)=>{const l=function(e,{observerRenderSpace:t,targetRenderSpace:i,tiltedUpVector:s,rightVector:r,farDistanceRenderSpace:o}){const a=S(Vi,i,t),n=gi(e)?r:s,l=k(yi,n,o);return ke(t,a,l)}(s,t),c=hi(r.next((e=>({...e,manipulatorType:He.SCALE,side:s}))),this._view,l,t);e(i,c,o)})))))}updateManipulatorsTransform(e){e.arcCentersPoints(ji),this._forEachManipulatorInfo((t=>this._updateArcManipulatorTransform(t,e,ji[t.side])))}updateManipulatorVisuals(e){this._forEachManipulatorInfo((t=>this._updateArcManipulatorVisuals(t,e)))}_updateArcManipulatorVisuals({manipulator:e,side:t},i){const s=[];if(null!=i){const[r,o]=function(e,t,i){const{horizontalFieldOfView:s,verticalFieldOfView:r}=t,o=gi(e),a=Y(Z((o?r:s)/2,0,15)),n=function(e,t,i,s=10){qe(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const r=t-e;if(r<=0||i<=0){const e=.01;return[E(0,0,e),E(0,0,-e)]}const o=[],a=r/s;for(let r=0;r<s;r++){let n=e+r*a;r===s-1&&(n=t);const l=Math.cos(n)*i,c=Math.sin(n)*i,h=E(l-i,0,c);o.push(h)}return o}(-a/2,a/2,o?1:Math.max(Math.sin(Y(90-r/2)),.1));return[Be(i,n),n]}(t,i,this._unfocusedArcMaterial);s.push(new Ce(r,Ze.Unfocused),new Ce(r.instantiate({material:this._focusedArcMaterial}),Ze.Focused)),e.collisionType={type:"line",paths:[o]}}e.renderObjects=s,e.radius=ni.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:t},i,s){const r=i.horizontalFieldOfView,o=Y(i.verticalFieldOfView/2),a=Y(r/2),n=gi(t);e.renderLocation=s;const l=he(),c=e=>{re(l,e,l)};c(ee(bi,Y(-90))),n||c(te(bi,o));const h=i.farDistanceRenderSpace;let d,p;c(ie(bi,T(Vi,h,h,h))),c(se(bi,function(e){return function(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}(e)*_i}(t))),c(ci(i,bi)),n?(d=a,p=i.tiltedUpVector):(p=i.rightVector,d=o),d*="right"===t||"bottom"===t?-1:1;const u=$(bi,d,p);null!=u&&c(u),e.modelTransform=l}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:s},[[s.manipulator,i.manipulator],[e.manipulator,t.manipulator]].forEach((([e,t])=>{e.metadata={pairedManipulator:t},t.metadata={pairedManipulator:e}}))}_createArcManipulator(e){const t=new xe({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:t,side:e};return this._updateArcManipulatorVisuals(i),this._handles.add(t.events.on("focus-changed",(e=>{const i=t.metadata?.pairedManipulator;null!=i&&(i.hovering!==t.hovering&&(i.hovering=t.hovering),i.grabbing!==t.grabbing&&(i.grabbing=t.grabbing))}))),i}_createArcMaterial(e){const t=ni.getFovArcWidth(e),i=new Qe({renderOccluded:me.OccludeAndTransparent,isDecoration:!0,width:t});return this._handles.add(p((()=>K.toUnitRGBA(this._view.effectiveTheme.accentColor)),(e=>i.setParameters({color:e})),u)),i}forEachManipulator(e){Object.values(this._manipulators).forEach((({manipulator:t})=>e(t,He.SCALE)))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach((t=>e(t)))}get test(){return{manipulators:this._manipulators}}}function gi(e){return"left"===e||"right"===e}const _i=Math.PI/2,bi=he(),Vi=F(),yi=F(),ji={top:F(),bottom:F(),left:F(),right:F()};class Mi extends xe{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:ni.collisionRadius}),this._handles=new De,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),i=[E(0,0,0),E(0,0,1)],s=Ne(t,i,e,16,!1),r=Ne(t,i,e*et,16,!1),o=Si(!1,t,e),a=Si(!0,t,e),n=he();oe(n,i[i.length-1]),ae(n,n,te(Di,Math.PI/2)),ae(n,n,ee(Di,Math.PI/2)),o.transformation=n,a.transformation=n,this.renderObjects=[new Ce(s,Ze.Unfocused),new Ce(r,Ze.Focused),new Ce(o,Ze.Unfocused),new Ce(a,Ze.Focused)];const l=E(0,ni.getScaleOrientArrowTipLength(!0),0),c=b(l,l,n),h=[...i,c];this.collisionType={type:"line",paths:[h]}}_createMaterial(){const e=new tt({cullFace:pe.Back,renderOccluded:me.OccludeAndTransparent,isDecoration:!0});return this._handles.add(p((()=>K.toUnitRGBA(this.view.effectiveTheme.accentColor)),(t=>e.setParameters({color:t})),u)),e}}function Si(e,t,i){const s=ni.getScaleOrientArrowTipLength(e);let r=2*i;e&&(r*=et);const o=s/2;return We(t,s,o,o,r,0)}const Di=he();class ki extends Ue{constructor(e){super(),this._handles=new De,this._tool=e.tool,this._view=e.view;const t=ni.scaleOrientHandleRadius;this._manipulatorHeading=new Mi(this._view,t),this._manipulatorTilt=new Mi(this._view,t),this._manipulatorDistance=new Mi(this._view,t),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return Xe(this._manipulatorHeading,((i,s,r,o,a)=>{const n=this._view,{tiltParallelToSurface:l,farDistanceRenderSpace:c,upVector:h,observerRenderSpace:d,targetRenderSpace:p,rightVector:u}=t,m=Math.sin(Y(l))*c,v=D(Ci,d,k(xi,h,m)),f=S(xi,p,v),w=k(Pi,u,O(f)),g=hi(s,n,ke(v,f,w),t).next((e=>({...e,manipulatorType:He.ROTATE})));e(i,g,r)}))}createTiltDragPipeline(e,t){return Xe(this._manipulatorTilt,((i,s,r,o,a)=>{const{observerRenderSpace:n,farDistanceRenderSpace:l,upVector:c,targetDirection:h}=t,d=M(h,c),p=C(Ci,h,c,-d);k(p,V(p,p),l);const u=k(xi,c,l),m=ke(n,p,u),v=hi(s,this._view,m,t).next((e=>({...e,manipulatorType:He.ROTATE})));e(i,v,r)}))}createDistanceDragPipeline(e,t){return Xe(this._manipulatorDistance,((i,s,r,o,a)=>{const n=$e(t.observerRenderSpace,t.targetDirection),l=s.next(Ke(this._view,i.location)).next(Ae(this._view,n)).next((e=>({...e,manipulatorType:He.SCALE})));e(i,l,r)}))}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=he(),s=e=>{re(i,e,i)},r=ni.scaleOrientSize*(ze/Le);s(ie(Ti,T(Ci,r,r,r))),s(ci(e,Ti));const o=ni.scaleOrientHandleRadius*et*r,a=k(Ci,e.targetDirection,o);s(oe(Ti,a));const n=se(Ti,-Ri);ae(n,n,ee(Oi,-Ri)),this._manipulatorHeading.modelTransform=ae(he(),i,n);const l=ee(Ti,Ri);ae(l,l,se(Oi,Math.PI)),this._manipulatorTilt.modelTransform=re(he(),i,l),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,He.ROTATE),e(this._manipulatorTilt,He.ROTATE),e(this._manipulatorDistance,He.SCALE)}}const Ti=he(),Oi=he(),Ci=F(),xi=F(),Pi=F(),Ri=Math.PI/2;class Ai extends xe{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:ni.observerSize,interactive:!1}),this._handles=new De;const i=Pe(this._color);this.renderObjects=[new Ce(Ge(i,ni.observerSize,32,32))],t.manipulators.add(this),this._handles.add([p((()=>this._color),(e=>{i.setParameters({color:e})}),u)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return K.toUnitRGBA(this.view.effectiveTheme.accentColor)}}e([g()],Ai.prototype,"_color",null);const Fi=Symbol("dragHandles"),Ei=Symbol("hideManipulators"),Ui=Symbol("hideFoVManipulators"),Hi=Symbol("hideObserverManipulator");let zi=class extends s{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new wi({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new ki({view:this.view,tool:this.parentTool}),this._observerManipulator=new Ai(this.view,this.parentTool),this.addHandles([p((()=>this.viewshedComputedData?.observerRenderSpace),(e=>{null!=e&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)}),m),p((()=>this.viewshedComputedData?.heading),(e=>{e&&(this._moveManipulation.angle=Y(90-e))}),u),p((()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}}),(({viewshedComputedData:e,observer:t},i)=>{this._grabbing&&t!==i?.observer||(this.removeHandles(Fi),e?.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(r),Fi))}),u),p((()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)}),u),p((()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)}),u),p((()=>{const e=this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??!1),t=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||t)}}),(({fovManipulationAvailable:e,nonFOVManipulationAvailable:t})=>{this._moveManipulation.available=t,this._scaleOrientManipulation.available=t,this._observerManipulator.available=t,this._fieldOfViewManipulation.available=e}),u),p((()=>{const e=this.viewshedComputedData;if(!e?.isValid())return null;const{observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}=e;return{viewshedCompData:e,observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}}),(e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)}),u)]),this._forEachManipulator((e=>{const t=this.analysisViewData;this.addHandles([e.events.on("focus-changed",(()=>{const e=this._someManipulatorHovering();e&&this.parentTool.subToolHandles.forEach((({subTool:e})=>{e._resetHoveringTask()})),this._someManipulatorSelected()||e||(this._forceHoveringTask=be((async e=>{await(this._forceHoveringTestPromise??je(ni.hoverTimeoutMilliseconds,e)),Me(e),this._forceHoveringTask=null,this._updateManipulatorVisibility()})))})),e.events.on("grab-changed",(i=>{this._grabbing="start"===i.action,"end"===i.action&&t.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach((({subTool:e})=>{e!==this&&e._setInteractive(!this._grabbing)})),this._setInteractive((t=>t.hasManipulator(e)||!this._grabbing))})),e.events.on("drag",(e=>{"start"===e.action&&t.tool?.updateInteractionVisualsVisibility()}))])}))}destroy(){this._forceHoveringTask=c(this._forceHoveringTask),this._moveManipulation=l(this._moveManipulation),this._fieldOfViewManipulation=l(this._fieldOfViewManipulation),this._scaleOrientManipulation=l(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=l(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;null!=t&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t="boolean"==typeof e;this._forEachManipulation((i=>i.interactive=t?e:e(i)))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),this._someManipulatorSelected()||(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator((i=>{t=t||i===e})),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Ie({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:ze})}_buildObserverDragPipeline(e){const t=e.observer;if(null==t)return null;const i=this.view.spatialReference;return this._moveManipulation.createDragPipeline(((e,s,r,o,a)=>{o=o.next(Ye(this,["observer"]));const n=L(t,i);if(null==n)return{steps:r,cancel:o};const l=it.fromGeometry(n,Se(this.view.viewingMode));return{steps:r.next(Je({operations:l})).next((e=>(this.observer=l.data.geometry,e))),cancel:o}}),{mode:"absolute-height",offset:0},i,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline(((s,r,o)=>{if(null==e)return{steps:r,cancel:o};const a=e.viewshed;let n=null;o=o.next(Ye(e,["horizontalFieldOfView","verticalFieldOfView"]));const l=r.next((s=>{if("start"===s.action)return n=null,t=e.horizontalFieldOfView,i=e.verticalFieldOfView,s;const r=s.deltaAngle;if(null==n&&0!==r){const e="bottom"===s.side||"left"===s.side?r>0:r<0;n=gi(s.side)?0===t&&e||360===t&&!e:0===i&&e}const o=n?function(e){return"left"===e?"right":"right"===e?"left":"top"===e?"bottom":"top"}(s.side):s.side;let l=0;switch(o){case"left":l=t/2-r;break;case"right":l=t/2+r;break;case"top":l=i+2*r;break;case"bottom":l=i-2*r}return gi(o)?(l=Ve.normalize(l),l=l>270?0:l>180?180:l,a.horizontalFieldOfView=2*l):a.verticalFieldOfView=l,s}));return{steps:l,cancel:o}}),e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const s=(t,i)=>(s,r,o)=>{if(null==e)return{steps:r,cancel:o};const a=e.viewshed;return o=o.next(Ye(a,[t])),{steps:r=r.next(i(a,e)),cancel:o}};return q([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",((t,s)=>s=>("start"===s.action&&(i=e.heading),t.heading=Ve.normalize(i+s.deltaAngle),s))),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",((i,s)=>s=>{"start"===s.action&&(t=e.tilt);let r=t+s.deltaAngle;return r<-90?r=180:r>270&&(r=0),i.tilt=Ii.clamp(r),s})),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",((e,t)=>i=>{const s=S(Li,i.renderEnd,t.observerRenderSpace),r=O(s)*t.metersPerUnit,o=M(s,t.targetDirection)<0?ni.scaleOrientMinDistance:r;return e.farDistance=o,i})),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=null!=this._forceHoveringTask||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating;let r=[];const o=e=>{r.push(e.disableDisplay())};e||!s&&t?this.removeHandles(Ei):(this._scaleOrientManipulation.forEachManipulator(o),this._moveManipulation.forEachManipulator(o),this.addHandles(r,Ei),r=[]),e||!s&&t||s&&i?this.removeHandles(Ui):(this._fieldOfViewManipulation.forEachManipulator(o),this.addHandles(r,Ui)),e||!s?this.removeHandles(Hi):this.addHandles(this._observerManipulator.disableDisplay(),Hi)}_resetHoveringTask(){this._forceHoveringTask=c(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation((t=>{t.forEachManipulator(e)})),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};e([g({constructOnly:!0})],zi.prototype,"analysis",void 0),e([g({constructOnly:!0})],zi.prototype,"analysisViewData",void 0),e([g({constructOnly:!0})],zi.prototype,"parentTool",void 0),e([g({constructOnly:!0,nonNullable:!0})],zi.prototype,"view",void 0),e([g()],zi.prototype,"viewshed",null),e([g()],zi.prototype,"_grabbing",void 0),e([g()],zi.prototype,"grabbing",null),e([g()],zi.prototype,"viewshedComputedData",void 0),e([g()],zi.prototype,"observer",null),zi=e([_("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],zi);const Li=F(),Ii=new ye(0,180),Bi=Symbol("interactionVisuals");let Ni=class extends nt{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creationState=!1,this._interactionVisualElements=null,this._settings=new st({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=ct(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=v((()=>e),(({viewshedComputedData:e})=>{const t=new zi({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:t,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),t.destroy()}}})),this.addHandles([p((()=>e?.some((e=>e.viewshedComputedData.isValid()))),(e=>{e&&this.finishToolCreation()}),m),p((()=>this._stagedViewshed),(e=>{const t=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null!=e&&null!=t?this._findSubTool(e)?.viewshedComputedData:null}),m),p((()=>this.firstGrabbedManipulator),(e=>{if(null!=e){const t=this._findSubTool(e)?.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()}),f),p((()=>this.view.activeTool),(e=>{e!==this&&null!=e&&(this.selectedViewshed=null)})),w((()=>{const e=this.selectedViewshedComputedData;return null==e?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}}),(e=>{const{subTool:t,observer:i,target:s}=e;t?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(i,!0):t?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(s,!1)}),u),p((()=>this.creating),(()=>this.updateInteractionVisualsVisibility())),p((()=>this.selectedViewshed),(e=>{const t=this._selectedManipulator,i=this._selectedSubTool;null==e?this._selectManipulator(null):null!=t&&i.hasManipulator(t)||this._selectManipulator(i.discManipulator)}),u)])}destroy(){this.subToolHandles=l(this.subToolHandles),this.removeHandles(Bi)}onDeactivate(){this.removeStaged(),this._creationState=!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){const t=this._selectedManipulator;t!==e&&(this._selectedManipulator=e,null!=t&&(t.selected=!1),null!=e&&(e.selected=!0),this._findSubTool(t)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some((({subTool:e})=>e.grabbing))}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}createViewsheds(){this.selectedViewshed=null,this._creationState="placing-observer"}onManipulatorSelectionChanged(){this.subToolHandles.forEach((e=>e.subTool.onManipulatorSelectionChanged()))}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":lt.cancel===e.key?this._cancelKeyHandler(e):lt.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,Yi);if(null!=t){if("placing-observer"===this._creationState){t.mapPoint.z=(t.mapPoint.z??0)+1.5;const e=new ve({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if("placing-target"===this._creationState){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._creationState="placing-observer",this._stagedViewshed=null,this.selectedViewshed=e}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,Yi);null!=t&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){if(this.creating){if(this.removeStaged())return this._creationState="placing-observer",this.selectedViewshed=null,void e.stopPropagation();this._creationState=!1}else if(!this.grabbing)return this.selectedViewshed=null,void e.stopPropagation()}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:s,tilt:r,farDistance:o}=function(e,t,i){const s=t.observerRenderSpace,r=S(Wi,i,s),o=O(r)*t.metersPerUnit,a=e.renderCoordsHelper.basisMatrixAtPosition(s,Xi),n=T(Gi,a[8],a[9],a[10]),l=we(s,n,Ki),c=_e(l,i,qi),h=S(c,c,s),d=(O(h)<1e-4?90:J(j(r,h)))*(M(n,r)<0?-1:1)+90,p=T(Qi,a[4],a[5],a[6]),u=J(j(p,h)),m=T(Qi,a[0],a[1],a[2]);return{heading:M(h,m)<0?360-u:u,tilt:d,farDistance:o}}(this.view,i,e);t.farDistance=o,t.tilt=r,t.heading=s}removeStaged(){return null!=this._stagedViewshed&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}_intersectScreen(e,t){const i=ht(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,r=t.scenePoint;if(!s.getIntersectionPoint(r))return null;const o=t.mapPoint;return o.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,o),null==o?null:(t.feature=at(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(Bi);const e=this._settings.visualElements,t=new ot({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new rt({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:me.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([p((()=>e.zVerticalLine),(e=>e.apply(i)),m),p((()=>e.heightPlane),(e=>e.apply(t)),m),Q((()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null}))],Bi)}updateInteractionVisualsVisibility(e=!1){const t=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,r=this.selectedViewshedComputedData,o=(e,t)=>{const i=this._interactionVisualElements;null!=i&&(i.verticalLine.attached=t,i.laserline.attached=e)};if(t)return void o(i,!1);if(null==s||null==r)return void o(!1,!1);const a=s.moveInteractionState,n=e?a.grabbing:a.dragging,l=s.scaleOrientInteractionState,c=e?l.grabbing:l.dragging,h=i&&(n||c);if(o(h,n),h){const e=n?r.observerRenderSpace:r.targetRenderSpace;this._updateInteractionVisualsLocation(e,n)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(null==i)return;const{laserline:s,verticalLine:r}=i;s.heightManifoldTarget=e,s.intersectsWorldUpAtLocation=t?e:null,null!=e&&r.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){if(null==e)return null;const t=e instanceof xe?t=>t.subTool.hasManipulator(e):t=>t.subTool.viewshed===e;return this.subToolHandles?.find(t)?.subTool}get test(){}};e([g({constructOnly:!0})],Ni.prototype,"view",void 0),e([g()],Ni.prototype,"analysisViewData",void 0),e([g()],Ni.prototype,"removeIncompleteOnCancel",void 0),e([g()],Ni.prototype,"automaticManipulatorSelection",void 0),e([g({constructOnly:!0})],Ni.prototype,"analysis",void 0),e([g()],Ni.prototype,"subToolHandles",void 0),e([g()],Ni.prototype,"_stagedViewshed",void 0),e([g()],Ni.prototype,"_stagedViewshedComputedData",void 0),e([g()],Ni.prototype,"_creationState",void 0),e([g({readOnly:!0})],Ni.prototype,"cursor",null),e([g()],Ni.prototype,"_selectedManipulator",void 0),e([g()],Ni.prototype,"_selectedSubTool",null),e([g()],Ni.prototype,"selectedViewshed",null),e([g()],Ni.prototype,"selectedViewshedComputedData",null),e([g()],Ni.prototype,"stagedViewshed",null),e([g()],Ni.prototype,"grabbing",null),e([g()],Ni.prototype,"creating",null),e([g()],Ni.prototype,"isPlacingTarget",null),Ni=e([_("esri.views.3d.analysis.Viewshed.ViewshedTool")],Ni);const Wi=F(),Gi=F(),qi=F(),Qi=F(),Xi=he(),Ki=ge(),Yi={mapPoint:new dt,scenePoint:F(),feature:null},Ji=Ni;class Zi extends ut{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new tt({...li.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(null==e)return;const t=he(),i=e.farDistanceRenderSpace;ie(t,E(i,i,i)),ci(e,rs),ae(t,rs,t),oe(rs,this._viewshedComputedData.observerRenderSpace),ae(t,rs,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachExternalMaterial(e){null!=this._material&&e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:i}=this;if(null==i||null==t||!i.isValid())return;const s=function(e,t){const{horizontalFieldOfView:i,verticalFieldOfView:s}=t,r=T(es,0,0,1),o=T(ts,0,1,0),a=T(is,1,0,0);di(r,r,Y(s/2),o),di(r,r,Y(i/2),a);const n=e=>Math.ceil(Math.abs(e)/ai)+1,l=Y(i),c=y(ss,a),h=n(l),d=$i(-l/(h-1)),p=$(rs,d,c),u=Y(-s),m=n(u),v=$i(u/(m-1)),f=y(ts,o),w=$(os,Y(i)/2,a);b(f,f,w);const g=os,_=[],V=y(is,r);for(let e=0;e<h;e++){$(g,v,f);for(let t=0;t<m;t++){const i=3*(t*h+e);_[i]=V[0],_[i+1]=V[1],_[i+2]=V[2],b(V,V,g)}b(f,f,p),b(r,r,p),y(V,r)}const j=h*m;_[3*j]=0,_[3*j+1]=0,_[3*j+2]=0;const M=[];for(let e=0;e<h-1;e++)for(let t=0;t<m-1;t++){const i=6*(t*(h-1)+e);M[i]=t*h+e,M[i+1]=(t+1)*h+e,M[i+2]=t*h+e+1,M[i+3]=t*h+e+1,M[i+4]=(t+1)*h+e,M[i+5]=(t+1)*h+e+1}const S=[M];if(360!==i&&0!==s){const e=[],t=[];for(let i=0;i<m-1;i++){const s=3*i;e[s]=j,e[s+1]=(i+1)*h,e[s+2]=i*h,t[s]=j,t[s+1]=i*h+h-1,t[s+2]=(i+1)*h+h-1}S.push(e,t)}if(180!==s&&0!==i){const e=[],t=[];for(let i=0;i<h-1;i++){const s=3*i;e[s]=j,e[s+1]=i,e[s+2]=i+1,t[s]=j,t[s+1]=i+(m-1)*h+1,t[s+2]=i+(m-1)*h}S.push(e,t)}return S.map((t=>{const i=[[Tt.POSITION,new mt(_,t,3,!0)]];return new vt(e,i)}))}(t,i);s.forEach((t=>e.addGeometry(t)))}}function $i(e){return isNaN(e)?1:e}const es=F(),ts=F(),is=F(),ss=F(),rs=he(),os=he();let as=class extends s{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:F(),topRight:F(),bottomLeft:F(),bottomRight:F()},this._arcCenterPoints={top:F(),bottom:F(),left:F(),right:F()},this._parallelCenters={top:F(),bottom:F()}}initialize(){const e={view:this.view,isDecoration:!0},t={...e,color:this._color,renderOccluded:me.OccludeAndTransparent},i={...t,stipplePattern:Ot(2)};this._observerVisualElement=new pt({...e,...li.observerPointConfiguration}),this._shapeVisualElement=new Zi(e),this._frameLinesVisualElement=new W(t),this._leftArcVisualElement=new W(t),this._rightArcVisualElement=new W(t),this._topArcVisualElement=new W(t),this._bottomArcVisualElement=new W(t),this._centralLongitude=new W(i),this._centralLatitude=new W(i),this.addHandles([p((()=>{const e=this.viewshedComputedData;if(!e?.isValid())return null;const t=this._viewshedCorners,i=this._arcCenterPoints,s=this._parallelCenters;return e.cornerPoints(t),e.arcCentersPoints(i),e.parallelCenterPoints(s),{viewshedComputedData:e,corners:t,arcCenters:i,parallelCenters:s,interactive:this.analysisViewData.interactive,selected:this._selected}}),(e=>{const t=null!=e;this._forEachVisualElement((e=>e.attached=t)),t&&this._updateVisualElements(e)}),{initial:!0,equals:o}),p((()=>{const{viewshedComputedData:e}=this,{horizontalFieldOfView:t,verticalFieldOfView:i}=e??{};return{viewshedComputedData:e,horizontalFieldOfView:t,verticalFieldOfView:i}}),(({viewshedComputedData:e})=>{const{_shapeVisualElement:t}=this;e!==t.viewshedComputedData&&(t.viewshedComputedData=e),this._shapeVisualElement.recreateGeometry()}),u),p((()=>{const{interactive:e}=this.analysisViewData;return{visible:this.visible,selected:e&&this._selected,staged:e&&this._staged,horFovNot360:360!==this.viewshedComputedData?.horizontalFieldOfView}}),(({visible:e,selected:t,staged:i,horFovNot360:s})=>{const r=t||i;this._shapeVisualElement.visible=e,this._topArcVisualElement.visible=e,this._bottomArcVisualElement.visible=e,this._frameLinesVisualElement.visible=e&&s;const o=e&&(t||s);this._leftArcVisualElement.visible=o,this._rightArcVisualElement.visible=o,this._forEachLineVisualElement((e=>{e.width=r?li.frameWidthSelected:li.frameWidthNotSelected,e.renderOccluded=t?me.OccludeAndTransparent:me.Occlude})),[this._centralLatitude,this._centralLongitude].forEach((i=>{i.width=2*(r?li.frameWidthSelected:li.frameWidthNotSelected),i.visible=e&&t}))}),u),p((()=>{const{analysisViewData:{interactive:e,tool:t},_selected:i,visible:s}=this,r=this.view.activeTool,o=!t?.active&&r instanceof Ji&&r.creating;return{observerVisible:s&&!i&&(!e||(t?.creating??!1)||o),color:this._color}}),(({observerVisible:e,color:t})=>{this._observerVisualElement.visible=e,this._forEachLineVisualElement((e=>e.color=t))}),u)])}get _color(){const{viewshedComputedData:e,_selected:t,analysisViewData:i}=this;if(null==e)return K.toUnitRGBA(li.frameColor);const s=i.tool?.active||i.interactive,r=e.viewshed===i.tool?.stagedViewshed,o=s&&(t||r)?this.view.effectiveTheme.accentColor:li.frameColor;return K.toUnitRGBA(o)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return null!=e&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return null!=e&&e.creating&&e.stagedViewshed===t?.viewshed}destroy(){this._observerVisualElement=l(this._observerVisualElement),this._shapeVisualElement=l(this._shapeVisualElement),this._frameLinesVisualElement=l(this._frameLinesVisualElement),this._leftArcVisualElement=l(this._leftArcVisualElement),this._rightArcVisualElement=l(this._rightArcVisualElement),this._topArcVisualElement=l(this._topArcVisualElement),this._bottomArcVisualElement=l(this._bottomArcVisualElement),this._centralLongitude=l(this._centralLongitude),this._centralLatitude=l(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:r}=e,o=U(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(o,i),this._updateFrameArcs(t,i,r),this._updateCentralHelperArcs(t,s)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:s,rightVector:r,horizontalFieldOfView:o,tiltedUpVector:a}=e,n=Y(o),l=F(),c=he();$(c,n/2,a),b(l,r,c),ns(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",l),$(c,-n/2,a),T(l,0,0,0),b(l,r,c),ns(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",l);const h=o>180?"backward":"forward";ns(this._topArcVisualElement,i.top,t.topRight,t.topLeft,h,a),ns(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,h,a)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";ns(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),ns(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}};function ns(e,t,i,s,r,o,a=ai){const n=F();S(n,i,t);const l=O(n),c=F();S(c,s,t),V(c,c),k(c,c,l);let h=j(n,c);const d=U(o);"backward"===r&&(x(d,d),h=-(2*Math.PI-h));const p=[],u=Math.ceil(Math.abs(h)/a),m=he();$(m,h/u,d);const v=F();y(v,n);const f=F();y(f,i);for(let e=0;e<u;e++){const e=F();y(e,f),b(v,v,m),D(f,t,v);const i=F();y(i,f),p.push([e,i])}e.geometry=p}e([g()],as.prototype,"view",void 0),e([g()],as.prototype,"analysisViewData",void 0),e([g()],as.prototype,"viewshedComputedData",void 0),e([g()],as.prototype,"visible",void 0),e([g()],as.prototype,"_color",null),e([g()],as.prototype,"_selected",null),e([g()],as.prototype,"_staged",null),as=e([_("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],as);const ls=as;let cs=class extends s{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=v((()=>this.analysisViewData.viewshedComputedDataHandles),(({viewshedComputedData:t})=>{const i=new ls({view:this.view,viewshedComputedData:t,analysisViewData:e});return{visualization:i,remove:()=>i.destroy()}}));this._viewshedVisualizations=t,this.addHandles([X(t),p((()=>this.visible),(e=>this._viewshedVisualizations.forEach((({visualization:t})=>t.visible=e))),u)])}get test(){}};var hs;e([g({constructOnly:!0})],cs.prototype,"analysisViewData",void 0),e([g({constructOnly:!0,nonNullable:!0})],cs.prototype,"view",void 0),e([g({constructOnly:!0})],cs.prototype,"isDecoration",void 0),e([g()],cs.prototype,"visible",null),cs=e([_("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],cs);let ds=hs=class extends s{constructor(e){super(e),this.observerRenderSpaceOverride=null}get observer(){return this.viewshed.observer??new dt}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,F())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const e=S(F(),this.targetRenderSpace,this.observerRenderSpace);return V(e,e)}get tiltedUpVector(){const e=di(F(),this.upVector,-Y(this.tiltParallelToSurface),this.leftVector);return V(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,he())}get upVector(){const e=this._basis;return E(e[8],e[9],e[10])}get northVector(){const e=this._basis;return E(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=di(F(),this.northVector,-Y(this.heading),e);return P(t,e,t)}get rightVector(){return x(F(),this.leftVector)}clone(){return new hs({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:s,targetRenderSpace:r}=this,o=S(ps,r,s);return di(o,o,-Y(t),this.leftVector),di(o,o,-Y(e),this.tiltedUpVector),D(i,o,s)}cornerPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-t,i,e.topLeft),this.pointOnSphere(t,i,e.topRight),this.pointOnSphere(-t,-i,e.bottomLeft),this.pointOnSphere(t,-i,e.bottomRight)}arcCentersPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,e.top),this.pointOnSphere(0,-i,e.bottom),this.pointOnSphere(-t,0,e.left),this.pointOnSphere(t,0,e.right)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(Y(this.verticalFieldOfView/2)),s=k(ps,this.tiltedUpVector,i);D(e.top,t,s),S(e.bottom,t,s)}renderSpaceToPoint(e,t){const i=ps;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new dt(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=H(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}_computeTargetRenderSpace(e){const{leftVector:t,northVector:i,upVector:s}=this,r=this.farDistanceRenderSpace,o=F();return k(o,i,r),di(o,o,-Y(this.heading),s),di(o,o,-Y(this.tiltParallelToSurface),t),D(o,e,o),o}};e([g()],ds.prototype,"renderCoordsHelper",void 0),e([g()],ds.prototype,"viewshed",void 0),e([g()],ds.prototype,"observerRenderSpaceOverride",void 0),e([g()],ds.prototype,"observer",null),e([g()],ds.prototype,"effectiveObserverRenderSpace",null),e([g()],ds.prototype,"effectiveObserver",null),e([g()],ds.prototype,"effectiveTargetRenderSpace",null),e([g()],ds.prototype,"farDistance",null),e([g()],ds.prototype,"farDistanceRenderSpace",null),e([g()],ds.prototype,"heading",null),e([g()],ds.prototype,"tilt",null),e([g()],ds.prototype,"feature",null),e([g()],ds.prototype,"tiltParallelToSurface",null),e([g()],ds.prototype,"horizontalFieldOfView",null),e([g()],ds.prototype,"verticalFieldOfView",null),e([g()],ds.prototype,"observerRenderSpace",null),e([g()],ds.prototype,"target",null),e([g()],ds.prototype,"targetRenderSpace",null),e([g()],ds.prototype,"targetDirection",null),e([g()],ds.prototype,"tiltedUpVector",null),e([g()],ds.prototype,"_basis",null),e([g()],ds.prototype,"upVector",null),e([g()],ds.prototype,"northVector",null),e([g()],ds.prototype,"leftVector",null),e([g()],ds.prototype,"rightVector",null),e([g()],ds.prototype,"isValid",null),e([g()],ds.prototype,"metersPerUnit",null),ds=hs=e([_("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],ds);const ps=F();let us=class extends Bt{constructor(){super(...arguments),this.sectionAngles=Lt()}get sectionAnglesDeg(){return It(this.sectionAngles.map((e=>J(e))))}set sectionAnglesDeg(e){this.sectionAngles=It(e.map((e=>Y(e))))}get projectionMatrix(){return ae(he(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];qe(e<=t),qe(i<=s);const r=2*Math.tan(this.fovX/2),o=2*Math.tan(this.fovY/2),a=Math.tan(e),n=Math.tan(t),l=Math.tan(i),c=n-a,h=Math.tan(s)-l,d=r/c,p=o/h,u=-(a+c/2)/r*2,m=-(l+h/2)/o*2,v=he();oe(v,[u,m,0]);const f=he();ie(f,[d,p,1]);const w=he();return ae(w,f,v)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};e([g()],us.prototype,"sectionAngles",void 0),e([g()],us.prototype,"sectionAnglesDeg",null),e([g()],us.prototype,"projectionMatrix",null),e([g()],us.prototype,"sectionMatrix",null),e([g()],us.prototype,"_sectionRatioX",null),us=e([_("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],us);class ms{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const vs=["front","left","right","back","top","bottom"];class fs{constructor(e){this._fbos=e,this._minTextureSize=16,this._faces={},this._width=0,this._height=0,this.settings=new ms,this._maxTextureSize=Math.min(a("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture()}get ready(){return null!=this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const e=this.faces;return 0===e.length?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach((i=>{e[i]&&(t+=1)})),t}get faces(){const e=this._faces,t=[];for(const i of vs){const s=e[i];s&&t.push(s)}return t}get atlasRegions(){return this.faces.map((e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height]))}get viewshedProjectionMatrices(){return this.faces.map((e=>e.projectionMatrix))}get viewshedViewMatrices(){return this.faces.map((e=>e.viewMatrix))}_setupFaceCamera(e,t,i,s){const{effectiveObserverRenderSpace:r,tiltedUpVector:o,targetRenderSpace:a,farDistanceRenderSpace:n,horizontalFieldOfView:l,verticalFieldOfView:c}=t,h=F();S(h,a,r);const d=F(),p=F(),u=(e,t)=>{const i=F(),s=he();return $(s,e,t),b(i,h,s),D(i,r,i),i};let m,v=o;const f=Math.min(90,l),w=Math.min(90,Math.max(0,(l-90)/2));let g=-45,_=45,V=-45,y=45;if(!["top","bottom"].includes(e)){const e=e=>Z(e,-45,45);V=e(-c/2)-this.settings.toleranceBottomTop,y=e(+c/2)+this.settings.toleranceBottomTop}switch(e){case"front":m=a,g=-f/2,_=f/2;break;case"left":m=u(Math.PI/2,o),g=45-w;break;case"right":m=u(-Math.PI/2,o),_=-45+w;break;case"top":m=D(d,r,o),v=x(p,h);break;case"bottom":m=S(d,r,o),v=h;break;case"back":m=u(Math.PI,o)}const j=new us({center:m,eye:r,up:v,far:n});j.sectionAnglesDeg=[g-this.settings.toleranceSides,_+this.settings.toleranceSides,V,y],j.fovY=Math.PI/2;const M=j.setViewport(i,s);return this._faces[e]=j,M}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:i,verticalFieldOfView:s}=e,r=-s/2,o=s/2;return 0===i||0===s||(r<=45&&o>=-45&&t.add("front"),i>90&&(t.add("left"),t.add("right")),i>270&&t.add("back"),o>45-this.settings.toleranceBottomTop&&t.add("top"),r<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize(e,t,i,s){const r=t/e.pixelRatio,o=this.settings.textureSizeModifier(i),a=Math.max(e.fullWidth,e.fullHeight),n=wt(Math.floor(a*r*o)),l=Math.floor(this._maxTextureSize/s),c=Z(n,this._minTextureSize,l);return ft(c)}_ensureFBO(e){const t=this._width,i=this._height;this._handle?.fbo?.width===t&&this._handle?.fbo?.height===i||(this._handle?.release(),this._handle=this._fbos.acquire(t,i,"viewshed shadow map",Ht.RGBA4));const s=e?zt.DEPTH_STENCIL_TEXTURE:zt.DEPTH16_BUFFER;this._handle.acquireDepth(s)}clearFBO(e){const t=this._fbos.rctx;this._ensureFBO(e),t.bindFramebuffer(this._handle?.fbo),t.setClearColor(1,1,1,1),t.clear(Nt.COLOR|Nt.DEPTH)}dispose(){this._handle=h(this._handle)}start(e,t,i,s,r=!1){this._faces={};const o=this._computeActiveFaces(t),a=o.size;if(0===a)return!1;const n=this._computeBaseTextureSize(e,s,i,a);let l=0,c=0,h=0;return vs.filter((e=>o.has(e))).forEach((e=>{const i=function(e,t){if(t<4)return 0;const i="front"===e||"left"===e;return 4===t?i?0:1:i||"right"===e?0:1}(e,a);i>c&&(h=Math.max(h,l),l=0),c=i;const s=i*n;l+=this._setupFaceCamera(e,t,[l,s],n)})),h=Math.max(h,l),this._width=this.settings.textureResizeModulo(h),this._height=(a<4?1:2)*n,this.clearFBO(r),!0}finish(){this._handle?.detachDepth()}get test(){return{faces:this._faces,faceTypes:vs,width:this._width,height:this._height,getFBO:()=>this._fbos.acquire(this._width,this._height,"viewshed shadow map",Ht.RGBA4)}}}class ws extends Qt{constructor(){super(...arguments),this.localOrigin=z()}}function gs(e){e.include(qt),e.fragment.uniforms.add(new Kt("inverseViewMatrix",((e,t)=>{const i=ne(he(),t.camera.viewMatrix,e.localOrigin);return le(i,i)}))).code.add(Xt`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}class _s extends ws{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=de.flat(),this.viewMatrices=de.flat(),this.volumeOffset=0}}const bs=he(),Vs=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:_s,build:function(){const e=new gt,t=e.fragment;return e.include(Wt),e.include(gs),e.include(_t),e.include(Et),t.include(bt),t.include(Zt),e.include(Vt),t.uniforms.add(new yt("depthTexture",((e,t)=>t.depth?.attachment)),new Kt("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new Kt("inverseViewNormalMatrix",((e,t)=>le(bs,t.camera.viewInverseTransposeMatrix))),new Yt("viewshedObserverOffset",(e=>e.observerOffset)),new Yt("viewshedTargetVector",(e=>e.targetVector)),new Yt("viewshedUpVector",(e=>e.upVector)),new jt("viewshedFOVs",(e=>e.fovs)),new jt("viewshedHeadingAndTilt",(e=>e.headingAndTilt)),new jt("viewshedNearFar",(e=>e.shadowMap.nearFar??[1,100])),new Jt("viewshedVolumeOffset",(e=>e.volumeOffset)),new yt("viewshedShadowMap",(e=>e.shadowMap.depthTexture)),new $t("viewshedProjectionMatrices",(e=>e.projectionMatrices),6),new $t("viewshedViewMatrices",(e=>e.viewMatrices),6),new Mt("viewshedNumFaces",(e=>e.shadowMap.numActiveFaces)),new St("viewshedAtlasRegions",(e=>e.shadowMap.atlasRegions.flat()),24),new yt("normalMap",((e,t)=>e.normals)),new Gt("useNormalMap",((e,t)=>null!=e.normals))),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(Xt`vec3 normalFromTexture() {
vec4 norm4 = texture(normalMap, uv);
vec3 nNormal = vec3(-1.0) + 2.0 * norm4.xyz;
return normalize((inverseViewNormalMatrix * vec4(nNormal, 1.0)).xyz);
}`).code.add(Xt`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return rgba4ToFloat(textureAtlasLookup(viewshedShadowMap, uv, atlasRegion));
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec3 viewingDir = normalize(localPosition);
if(useNormalMap) {
vec3 normal = normalFromTexture();
return dot(normal, viewingDir);
}
vec3 cameraSpacePosition = reconstructPosition(gl_FragCoord.xy, linearDepth);
vec3 normal = normalFromDepth(depthTexture, cameraSpacePosition, gl_FragCoord.xy, uv);
normal = (inverseViewNormalMatrix * vec4(normal, 1.0)).xyz;
return dot(normal, viewingDir);
}`),t.main.add(Xt`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = useNormalMap ? -0.01 : -0.04;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),e}},Symbol.toStringTag,{value:"Module"}));class ys extends Dt{constructor(e,t,i){super(e,t,new kt(Vs,(()=>Promise.resolve().then((()=>Vs)))),i)}initializePipeline(){return ei({colorWrite:ti,blending:ii})}}let js=class extends Ft{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter((e=>function(e,t){const i=Rt(t.observerRenderSpace,t.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(i)}(this.view,e)))}constructor(e){super(e),this._techniques=null,this._passParameters=new _s,this._viewsheds=new Pt,this._shadowMap=null,this.consumes={required:[At.VIEWSHED],optional:["normals"]},this.produces=At.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new fs(this.fboCache),this.addHandles([p((()=>this.view.resolutionScale),(e=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=e)}),u),w((()=>!this.hasViewsheds),(()=>this._shadowMap?.dispose())),w((()=>this.view._stage.renderView.techniques),(e=>this._techniques=e),u),p((()=>this._viewshedsInView.map((e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]))),(()=>this.requestRender(ue.UPDATE)),f)])}destroy(){this._shadowMap=d(this._shadowMap)}precompile(){if(this.hasViewsheds){this._techniques?.precompile(ys);for(const e of this._viewshedsInView)if(this._shadowMap?.isActive(e))return void this.view._stage.renderer.precompileViewshedShadowMap()}}render(e){const t=this.bindParameters,i=this.renderingContext,s=e.find((({name:e})=>e===At.VIEWSHED));if(!this.hasViewsheds||!t.depth)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=e.find((({name:e})=>"normals"===e))?.getTexture();const r=this._techniques?.acquire(ys);if(!r?.compiled)return this.requestRender(ue.UPDATE),r?.release(),s;const o=this.view._stage.renderer.isFeatureEnabled(Ut.HighResolutionViewshed);for(const e of this._viewshedsInView){if(!this._renderShadowCubeMap(t,e,o)||!this._shadowMap?.ready)continue;const a=this._setupViewshedParameters(e,t.camera);i.bindTechnique(r,t,a),i.bindFramebuffer(s.fbo),i.screen.draw()}return r.release(),this.shadowMap?.dispose(),s}updateViewsheds(e){const t=this._viewsheds,{removes:i,adds:s}=e;if(i&&(Array.isArray(i)?t.removeMany(i):t.remove(i)),s)if(Array.isArray(s)){const e=s.filter((e=>!t.includes(e)));t.addMany(e)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(e,t,i){const s=this._shadowMap;if(!s)return!1;const r=this.view.basemapTerrain.hasStencilEnabledExtents,o=s.start(e.camera,t,i,this._contentPixelRatio,r);return o&&s.faces.forEach((e=>this.view._stage.renderer.renderViewshedShadowMap(e))),s.finish(),o}_setupViewshedParameters(e,t){const i=this._shadowMap;if(!i)return this._passParameters;const s=this._passParameters,r=e.effectiveObserverRenderSpace;s.localOrigin=r,s.observerOffset=S(Ss,e.observerRenderSpace,e.effectiveObserverRenderSpace),s.fovs=[Y(e.horizontalFieldOfView),Y(e.verticalFieldOfView)],s.headingAndTilt=[Y(e.heading),Y(e.tiltParallelToSurface)],s.upVector=e.tiltedUpVector;const o=function(e,t){const i=F();return S(i,e,t)}(e.targetRenderSpace,r);s.targetVector=o;const a=new Array,n=new Array;for(let e=0;e<i.numActiveFaces;e++)ne(Ds,i.viewshedViewMatrices[e],r),a.push(...Ds),Ms(i.viewshedProjectionMatrices[e],Ds,ks),n.push(...ks);return s.viewMatrices=a,s.projectionMatrices=n,s.volumeOffset=this.selectedViewshed?.()===e.viewshed?function(e,t,i){if(null==e)return 0;const{observerRenderSpace:s,targetRenderSpace:r}=e,o=R(i,s)>R(i,r)?e.observer:e.target;return t.pixelSizeAt(o)}(e,this.view,t.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Ms(e,t,i){const s=E(.5,.5,.5);return oe(i,s),ce(i,i,s),ae(i,i,e),ae(i,i,t),i}e([g()],js.prototype,"_techniques",void 0),e([g()],js.prototype,"selectedViewshed",void 0),e([g()],js.prototype,"shadowMap",null),e([g()],js.prototype,"hasViewsheds",null),e([g()],js.prototype,"_contentPixelRatio",null),e([g()],js.prototype,"_viewshedsInView",null),e([g()],js.prototype,"consumes",void 0),e([g()],js.prototype,"produces",void 0),js=e([_("esri.views.3d.webgl-engine.lib.Viewshed")],js);const Ss=F(),Ds=he(),ks=he();let Ts=class extends(N(s)){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this._placementTask=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}initialize(){const e=this.view;this._viewshedRenderer=new js({view:e,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed}),this._intersector=Ct(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=xt.MIN,this.viewshedComputedDataHandles=v((()=>this.analysis.viewsheds),(t=>{const i=new ds({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([p((()=>({valid:i.isValid(),canProject:I(i.observer?.spatialReference,this.view.spatialReference)||B()})),(({valid:e,canProject:t},s)=>{this.visible&&(e&&t?this._addViewshedsToRenderer(i):s?.valid&&s?.canProject&&this._removeViewshedsFromRenderer(i),t||G(this.analysis,i.observer.spatialReference,n.getLogger(this)))}),u),p((()=>[e.state.camera,e.slicePlane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature]),(()=>{this._updateObserverFromFeature(e,i)}),u)]),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}})),this._analysisVisualization=new cs({view:e,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([p((()=>this.visible),(e=>{const t=this.viewshedComputedDataHandles;if(null==t)return;e||(this.selectedViewshed=null);const i=t.map((e=>e.viewshedComputedData)).filter((e=>e.isValid())).toArray();e?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)})),p((()=>e.renderCoordsHelper),(e=>{this.viewshedComputedDataHandles?.forEach((({viewshedComputedData:t})=>t.renderCoordsHelper=e))})),si(this,Ji),w((()=>this.interactive),(()=>{this._unselectOtherViewsheds(this.selectedViewshed)}),m)])}destroy(){this._placementTask=c(this._placementTask),ri(this),this._analysisVisualization=l(this._analysisVisualization);const e=this.viewshedComputedDataHandles;null!=e&&this._removeViewshedsFromRenderer(e.map((e=>e.viewshedComputedData)).toArray())}async createViewsheds(e){return this._placementTask=c(this._placementTask),this._placementTask=oi(this,e),null!=this.tool&&this.tool.createViewsheds(),await this._placementTask.promise}_addViewshedsToRenderer(e){this._viewshedRenderer.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderer.updateViewsheds({removes:e})}_updateObserverFromFeature(e,s){const r=s.observerRenderSpace,o=s.targetRenderSpace,a=y(F(),r),n={observer:r,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:t(s.feature),target:o,targetSurfaceNormal:null,targetAdjusted:y(F(),o),targetFeatureId:null};i(e,this._intersector,n,(e=>Math.min(e,.05*s.farDistanceRenderSpace))),s.observerRenderSpaceOverride=A(a,r)?null:a}_unselectOtherViewsheds(e){if(null!=e)for(const e of this.view.tools.items)e!==this.tool&&e instanceof Ji&&(e.analysisViewData.selectedViewshed=null)}get test(){}};e([g({readOnly:!0})],Ts.prototype,"type",void 0),e([g({constructOnly:!0,nonNullable:!0})],Ts.prototype,"analysis",void 0),e([g()],Ts.prototype,"tool",void 0),e([g()],Ts.prototype,"_selectedViewshed",void 0),e([g()],Ts.prototype,"selectedViewshed",null),e([g()],Ts.prototype,"selectedViewshedComputedData",null),e([g()],Ts.prototype,"viewshedComputedDataHandles",void 0),e([g()],Ts.prototype,"_analysisVisualization",void 0),e([g()],Ts.prototype,"_placementTask",void 0),e([g()],Ts.prototype,"_viewshedRenderer",void 0),Ts=e([_("esri.views.3d.analysis.ViewshedAnalysisView3D")],Ts);const Os=Ts;export{Os as default};
