/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Map.js";import i,{y as s}from"../core/Accessor.js";import{c as o}from"../chunks/asyncUtils.js";import r from"../core/Collection.js";import{C as a}from"../chunks/CollectionFlattener.js";import n from"../core/Error.js";import l from"../core/Evented.js";import p,{f as h}from"../core/Handles.js";import{m as c}from"../chunks/handleUtils.js";import{q as u,i as d}from"../core/lang.js";import y from"../core/Loadable.js";import{L as m}from"../chunks/Logger.js";import{r as g,a as f,d as _}from"../chunks/maybe.js";import{EsriPromiseMixin as v}from"../core/Promise.js";import{createResolver as w,createAbortError as b,isAbortError as j,onAbort as M,throwIfAborted as k,c as T,isAborted as S,after as V}from"../core/promiseUtils.js";import{on as R,watch as I,syncAndInitial as E,whenOnce as L,when as C,sync as x}from"../core/reactiveUtils.js";import{g as P,property as F}from"../core/accessorSupport/decorators/property.js";import{subclass as O}from"../core/accessorSupport/decorators/subclass.js";import{O as D,G as H,o as U}from"../chunks/GraphicsCollection.js";import{U as A}from"../chunks/UpdatingHandles.js";import q from"../geometry/Extent.js";import z from"../geometry/HeightModelInfo.js";import N from"../geometry/SpatialReference.js";import{f as W}from"../chunks/unitUtils.js";import G from"../time/TimeExtent.js";import{s as Z,n as B}from"../chunks/date.js";import K from"./BasemapView.js";import{s as $,g as Q}from"../chunks/ensureType.js";import{schedule as J}from"../core/scheduling.js";import{d as X}from"../chunks/collectionUtils2.js";import Y from"./Magnifier.js";import{r as ee}from"../chunks/collectionUtils.js";import{R as te}from"../chunks/ReactiveMap.js";import{u as ie,w as se}from"../chunks/layerUtils.js";import oe from"../rest/support/Query.js";import{i as re}from"../chunks/selectionUtils.js";import ae from"./Theme.js";import{V as ne}from"../chunks/InputManager.js";import{e as le,V as pe}from"../chunks/ViewEvents.js";import{E as he}from"../chunks/interfaces.js";import{c as ce}from"../chunks/mathUtils.js";import{c as ue}from"../chunks/screenUtils.js";import{c as de}from"../chunks/screenUtils2.js";import ye from"./input/Input.js";import me from"./navigation/Navigation.js";import{d as ge,s as fe}from"../chunks/heightModelInfoUtils.js";import{V as _e}from"../chunks/ViewingMode.js";import{p as ve}from"../chunks/projectionUtils.js";import"../Basemap.js";import"../request.js";import"../config.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"../chunks/utils.js";import"../chunks/metadata.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../chunks/loadAll.js";import"../chunks/writer.js";import"../portal/Portal.js";import"../chunks/reader.js";import"../chunks/locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../chunks/jsonMap.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/persistableUrlUtils.js";import"../chunks/messages.js";import"../support/BasemapStyle.js";import"../chunks/writeUtils.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../Ground.js";import"../Color.js";import"../chunks/colorUtils.js";import"../chunks/compilerUtils.js";import"../chunks/enumeration.js";import"../chunks/opacityUtils.js";import"../chunks/editableLayers.js";import"../layers/catalog/catalogUtils.js";import"../chunks/basemapUtils.js";import"../chunks/utils2.js";import"../chunks/mat4.js";import"../chunks/common.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Identifiable.js";import"../chunks/timeUtils.js";import"../chunks/datetime.js";import"../support/TablesMixin.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils4.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../chunks/vec3f64.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils5.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/DataLayerSource.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/FullTextSearch.js";import"../chunks/spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../chunks/Queue.js";import"../core/signal.js";import"../chunks/IViewEvents.js";import"./input/gamepad/GamepadSettings.js";import"./input/gamepad/GamepadInputDevice.js";import"../chunks/a11yUtils.js";import"./navigation/gamepad/GamepadSettings.js";import"../chunks/arcgisLayerUrl.js";import"../geometry/projection.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";let we=class extends D{constructor(e){super(e),this.addHandles(this.on("before-add",(e=>{null!=e.item&&e.item.parent===this.owner&&(m.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),e.preventDefault())})))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};we=e([O("esri.support.AnalysesCollection")],we);class be{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=w(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,M(this._controller.signal,(()=>{const t=new n("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(t)}))}tryRecycle(e){if(!this.done||!this.layerView||!("tryRecycleWith"in this.layerView))return null;const t=this.layer.type,i=this._controller.signal;for(let s=0;s<e.length;s++){const o=e[s];if(o.type!==t)continue;const r=this.layerView.tryRecycleWith(o,{signal:i});if(r){e.splice(s,1),this.layer=o;const t=this.layerView,i=t.view;return this.promise=Promise.race([r.then((()=>(k(this._controller.signal),o.emit("layerview-destroy",{view:i,layerView:t}),i.emit("layerview-destroy",{view:i,layerView:t}),o.emit("layerview-create",{view:i,layerView:t}),i.emit("layerview-create",{view:i,layerView:t}),t))),new Promise(((e,t)=>M(this._controller.signal,(()=>t(b())))))]),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(e){const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:t,view:i}=this;this._map=i.map;try{let s,o;if(await t.load({signal:e}),t.prefetchResources&&await t.prefetchResources({signal:e}),function(e){return"createLayerView"in e&&null!=e.createLayerView}(t))s=await t.createLayerView(i,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(t))throw new n("layer:view-not-supported","No layerview implementation was found");const o=await this.layerViewImporter.importLayerView(t);k(e),s="default"in o?new o.default({layer:t,view:i}):new o({layer:t,view:i})}const r=()=>{o=g(o),s.destroyed||s.destroy(),s.layer=null,s.parent=null,s.view=null,this.done=!0};o=M(e,r),k(e);try{await s.when()}catch(e){throw r(),e}const a=this._map?.allLayers?.includes(t);if(!a)return r(),void this._deferred.reject(new n("view:no-layerview-for-layer","The layer has been removed from the map",{layer:t}));this.layerView=s,t.emit("layerview-create",{view:i,layerView:s}),i.emit("layerview-create",{layer:t,layerView:s}),this.done=!0,this._deferred.resolve(s)}catch(e){t.emit("layerview-create-error",{view:i,error:e}),i.emit("layerview-create-error",{layer:t,error:e}),this.done=!0,this._deferred.reject(new n("layerview:create-error","layerview creation failed",{layer:t,error:e}))}}}let je=class extends i{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new A,this.supportsGround=!0,this._preloadLayerViewModules=()=>{const e=this.view.map?.allLayers;if(e)for(const t of e)this.layerViewImporter.hasLayerViewModule(t)&&this.layerViewImporter.importLayerView(t)},this._reschedule=()=>this.destroyed?Promise.reject():(null==this._workPromise&&(this._workPromise=w(),this._workPromise.promise.catch((()=>{}))),this.removeHandles("reschedule"),this.addHandles(J(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{if(this.destroyed)return;const e=this.view.map;if(this._map!==e&&(this.clear(),this._map=e),null==this._workPromise)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const t=new Set,i=[],s=this.view.ready,o=e=>{if(null!=e)for(const r of e)if(r){t.add(r);const e=this._layerLayerViewInfoMap.get(r);e&&s?e.start():e||this._recyclingInfoMap.has(r)||i.push(r),"layers"in r&&r.layers&&o(r.layers)}};for(const e of this._rootCollectionNames)o(P(this,e));for(const[e,s]of this._layerLayerViewInfoMap)if(!t.has(e)){this._layerLayerViewInfoMap.delete(s.layer);const e=s.tryRecycle(i);e?(this.notifyChange("updating"),this._recyclingInfoMap.set(s.layer,s),e.then((()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(s.layer),this._layerLayerViewInfoMap.set(s.layer,s),this._reschedule()})).catch((()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(s.layer),s.destroy(),this._reschedule()}))):s.destroy()}for(const[e,i]of this._recyclingInfoMap)t.has(e)||(this.notifyChange("updating"),this._recyclingInfoMap.delete(i.layer),i.destroy());for(const e of i)this._createLayerView(e);this._refreshCollections();const r=[e?.ground?.layers,e?.basemap?.baseLayers,e?.basemap?.referenceLayers,e?.layers].filter((e=>!!e));t.forEach((e=>"layers"in e&&r.push(e.layers))),this.addHandles(r.map((e=>this._watchUpdatingTracking.addOnCollectionChange((()=>e),this._reschedule))),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.addHandles([R((()=>this.view?.map?.allLayers),"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),I((()=>{const e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]}),(()=>this._reschedule()),E)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),X(this._recyclingInfoMap),X(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,null!=this._workPromise&&(this._workPromise.reject(b()),this._workPromise=null)}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return null!=this._workPromise||this._watchUpdatingTracking.updating||$(this._layerLayerViewInfoMap,(e=>!e.done))||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){this.destroyed||(X(this._layerLayerViewInfoMap),this._refreshCollections())}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new n("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}isCreatingLayerViewsForLayer(e,t){this.commitProperty("updatingRemaining");const i=this._layerLayerViewInfoMap.get(e);if(!i?.done)return!0;const s=i.layerView;return!(!s||!t||s.parent===t)||!!(i.done&&s&&"layers"in e&&e.layers?.length)&&e.layers.some((e=>this.isCreatingLayerViewsForLayer(e,s)))}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(P(this,e),P(this,t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let s=0;for(const r of e){const e=this._layerLayerViewInfoMap.get(r);if(!e?.layerView)continue;const a=e.layerView;a.layer=r,a.parent=i,t.at(s)!==a&&t.splice(s,0,a),"layers"in r&&null!=(o=a)&&"object"==typeof o&&"layerViews"in o&&this._populateLayerViewsOwners(r.layers,a.layerViews,a),s+=1}var o;s<t.length&&t.splice(s,t.length)}_createLayerView(e){e.load().catch((()=>{})),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new be(e,this.view,this.layerViewImporter);t.promise.then((()=>this._refreshCollections()),(t=>{t&&(j(t)||"cancelled:layerview-create"===t.name)||m.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:t}),this._refreshCollections()})),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};e([F()],je.prototype,"_workPromise",void 0),e([F({readOnly:!0})],je.prototype,"_watchUpdatingTracking",void 0),e([F({readOnly:!0})],je.prototype,"_layersToLayerViews",null),e([F({readOnly:!0})],je.prototype,"_rootCollectionNames",null),e([F()],je.prototype,"layerViewImporter",void 0),e([F()],je.prototype,"supportsGround",void 0),e([F({readOnly:!0})],je.prototype,"updating",null),e([F({readOnly:!0})],je.prototype,"updatingRemaining",null),e([F({constructOnly:!0})],je.prototype,"view",void 0),je=e([O("esri.views.LayerViewManager")],je);const Me=je;let ke=class extends l.EventedAccessor{constructor(e){super(e),this._selectionMap=new te,this._sources=new r,this._trashCan=[],this._layerEditHandles=new r,this._vizTaskId=0,this.showHighlight=!0}initialize(){this.addHandles([I((()=>[this.view,this.showHighlight]),(()=>this._refreshVisualization())),R((()=>this.sources),"change",(e=>{const t=this._selectionMap;for(const i of e.removed)t.delete(i);this._refreshListeners(),this._refreshVisualization()}),{onListenerAdd:()=>this._refreshListeners()})]);const e=new r;this.view.when().then((()=>{this.view.map&&(this.view.map.allLayers.flatten((e=>"sublayers"in e&&e.sublayers?e.sublayers:null)).forEach((t=>{(re(t)&&!ie(t)||se(t))&&e.add(t)})),this.sources=e)}))}destroy(){this._layerEditHandles.drain(g)}get selections(){return Array.from(this._selectionMap.entries()).map((e=>{const[t,i]=e;return{layer:t,selection:[...i.selection]}}))}get count(){let e=0;for(const t of this._selectionMap.values())e+=t.selection.length;return e}get hasSelection(){return this.count>0}get sources(){return this._sources}set sources(e){ee(e,this._sources)}async getSelectedFeatures(e,t={},i="layerView"){const{view:s,selections:o}=this,r=(void 0!==e?o.filter((t=>e.includes(t.layer))):o).filter((e=>e.selection.length>0)).map((async e=>{const{layer:o,selection:r}=e,a=se(o)?o.parent:o;if(null==a||!Se(a))return null;if("layer"===i)return Re(a,r,t);if(Te(a))return null;const n=await s.whenLayerView(a).catch((()=>null));return n?Re(n,r,t):null}));return(await Promise.all(r)).filter((e=>null!=e))}updateSelection(e){const t=new Map;for(const[e,i]of this._selectionMap)t.set(e,[...i.selection]);let i=!1;const s=e.current.concat(e.added);for(const e of s){const s=e.sourceLayer,o=e.getObjectId();if(this.sources.includes(s)&&(re(s)||se(s))&&null!==o){const e=Q(t,s,(()=>[]));e.includes(o)||(e.push(o),i=!0)}}for(const s of e.removed){const e=s.sourceLayer,o=s.getObjectId();if(this.sources.includes(e)&&(re(e)||se(e))&&null!==o){const s=t.get(e),r=s?.indexOf(o);void 0!==r&&r>=0&&(s?.splice(r,1),i=!0)}}if(i){const{_selectionMap:e,_trashCan:i}=this,s=[];for(const[o,r]of t){const t=e.get(o);void 0!==t&&i.push(t),e.set(o,{selection:r}),s.push({layer:o,selection:r,...u(void 0!==t?t.selection:[],r)})}this._onSelectionChange(s)}}setSelection(e,t){this._setSelection(e,t)}getSelection(e){const t=this._selectionMap.get(e);return t?.selection}appendToSelection(e,t){const i=this._selectionMap.get(e),s=void 0!==i?[...i.selection]:[];for(const e of t)s.includes(e)||s.push(e);this._setSelection(e,s)}removeFromSelection(e,t){const i=this._selectionMap.get(e);if(!i)return;const s=[];for(const e of i.selection)t.includes(e)||s.push(e);this._setSelection(e,s)}toggleInSelection(e,t){const i=this._selectionMap.get(e);if(!i||0===i.selection.length)return void this._setSelection(e,t);const o=new Set(i.selection),r=new Set(t),a=s(o,r);this._setSelection(e,Array.from(a))}clear(){const e=this._selectionMap.values();this._trashCan.push(...e);const t=[];for(const[e,i]of this._selectionMap.entries())t.push({layer:e,added:[],removed:[...i.selection],selection:[]});this._selectionMap.clear(),this._onSelectionChange(t)}_onSelectionChange(e){this._refreshVisualization(),this.emit("selection-change",{view:this.view,changes:e})}_refreshVisualization(){if(null==this.view||null==this.sources)return;for(this._vizTaskId++;this._trashCan.length>0;){const e=this._trashCan.pop();e?.highlightHandle?.remove()}const{sources:e,view:t,_selectionMap:i,showHighlight:s}=this,o=this._vizTaskId;for(const r of e){const e=i.get(r),a=se(r)?r.parent:r;if(null!=a&&Se(a)){if(Te(a))continue;t.whenLayerView(a).then((t=>{e?.highlightHandle?.remove(),null!=e&&s&&o===this._vizTaskId&&"highlight"in t&&"function"==typeof t.highlight&&e.selection.length>0&&(e.highlightHandle=t.highlight(e.selection,"selection"))})).catch((()=>{e?.highlightHandle?.remove()}))}}}_refreshListeners(){this._layerEditHandles.drain(g);for(const e of this.sources){const t=se(e)?e.parent:e;if(null!=t&&re(t)){const i=t.on("edits",(t=>{this._handleEditChanges(t,e)}));this._layerEditHandles.push(i)}}}_handleEditChanges(e,t){if(void 0!==e.deletedFeatures&&e.deletedFeatures.length>0&&this._selectionMap.has(t)){const i=e.deletedFeatures.filter((e=>null==e.error)).map((e=>e.objectId)).filter(d);this.removeFromSelection(t,i)}}_setSelection(e,t){if(!this.sources.includes(e))throw new Error(`Cannot set selection on layer ${e.title} because it is not in 'sources'`);const i=this._selectionMap.get(e);if(void 0===i||!Ve(i,{selection:t})){void 0!==i&&this._trashCan.push(i),this._selectionMap.set(e,{selection:[...t]});const s={layer:e,selection:[...t],...u(void 0!==i?i.selection:[],t)};this._onSelectionChange([s])}}};e([F({readOnly:!0,nonNullable:!0})],ke.prototype,"selections",null),e([F({readOnly:!0,nonNullable:!0})],ke.prototype,"count",null),e([F({constructOnly:!0,nonNullable:!0})],ke.prototype,"view",void 0),e([F({readOnly:!0,nonNullable:!0})],ke.prototype,"hasSelection",null),e([F()],ke.prototype,"showHighlight",void 0),e([F()],ke.prototype,"sources",null),ke=e([O("esri.views.SelectionManager")],ke);const Te=e=>se(e)?!0===e.parent?.isTable:e.isTable,Se=e=>void 0!==e?.when,Ve=(e,t)=>{if(null==e&&null==t)return!0;if(null!=e&&null==t||null==e&&null!=t)return!1;if(null!=e&&null!=t&&null!=e.selection&&null!=t.selection){const i=[...e.selection],s=[...t.selection];if(i.length!==s.length)return!1;i.sort(),s.sort();for(let e=0;e<i.length;e++)if(i[e]!==s[e])return!1}return!0},Re=async(e,t,i={})=>{let s;if(void 0===e.layer){const o=e;s=void 0===o?null:await o.queryFeatures(new oe({...i,objectIds:t})).then((e=>({data:e,layer:o})))}else{const o=e;s=void 0===o?null:await o.queryFeatures(new oe({...i,objectIds:t})).then((t=>({data:t,layer:e.layer})))}return s},Ie=ke;function Ee(e){return e.visible&&null!=e.getEditableFlag&&e.getEditableFlag(he.USER)&&e.getEditableFlag(he.MANAGER)}class Le{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._externallyDragging=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":Pe(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0?this._stopDrag=!0:"start"===e.action?this._externallyDragging=!0:"end"===e.action&&(this._externallyDragging=!1),this._stopDrag&&(i(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!Fe(e))break;const s=de(e),o=xe(s,e.pointerType,t.forEachTool);if(null==o)break;const r=o.manipulator,a=o.tool;null==r||null==a||!r.interactive||r.grabbable&&r.grabbableForEvent(e)||!r.grabbing||r.dragging||this._releaseManipulatorBeforeDragging(r,e,t),null!=r&&null!=a&&r.interactive&&r.grabbable&&r.grabbableForEvent(e)&&!r.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:r,tool:a,start:s,pointerType:e.pointerType}),1===this._grabbedManipulators.size&&null==t.activeTool&&(this._revertToNullActiveTool=!0,t.setActiveTool(o.tool)),r.grabbing=!0,r.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:s}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!Fe(e))break;const s=this._grabbedManipulators.get(e.pointerId),o=s?.manipulator,r=s?.tool;if(null==o||null==r)break;const a=de(e);a.x=ce(a.x,0,t.view.width),a.y=ce(a.y,0,t.view.height);const n=s.start,l=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(o.dragging=!0,l?o.events.emit("drag",{action:"update",start:n,screenPoint:a}):o.events.emit("drag",{action:"start",start:n,screenPoint:a,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:r,manipulator:o,start:n}));break;case"end":o.dragging=!1,l&&o.events.emit("drag",{action:"end",start:n,screenPoint:a}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const s=de(e),o=xe(s,e.pointerType,t.forEachTool);if(e.native.shiftKey||t.forEachTool((e=>{if((null==o||o.tool!==e||e.automaticManipulatorSelection)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.onManipulatorSelectionChanged&&e.onManipulatorSelectionChanged()}})),null==o)break;const{manipulator:r,tool:a}=o;if(!r.interactive)break;r.selectable&&a.automaticManipulatorSelection&&(r.selected=!r.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());const n=e.native.shiftKey;r.events.emit("immediate-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:n,stopPropagation:i}),Oe(r,i);break}case"click":{const s=de(e),o=xe(s,e.pointerType,t.forEachTool),r=o?.manipulator;if(null==r||!r.interactive)break;const a=e.native.shiftKey;r.events.emit(e.type,{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a}),i();break}case"double-click":{const s=de(e),o=xe(s,e.pointerType,t.forEachTool),r=null!=o?o.manipulator:null;if(null==r||!r.interactive)break;const a=e.native.shiftKey;r.events.emit("double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),Oe(r,i);break}case"immediate-double-click":{const s=de(e),o=xe(s,e.pointerType,t.forEachTool),r=null!=o?o.manipulator:null;if(null==r||!r.interactive)break;const a=e.native.shiftKey;r.events.emit("immediate-double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),"mouse"===e.pointerType&&Oe(r,i);break}}this._onFocusChange(t.forEachTool)}_releaseManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:de(t)}),this._grabbedManipulators.forEach((({manipulator:t},i)=>{t===e&&this._grabbedManipulators.delete(i)})),this._afterManipulatorRelease(i.setActiveTool)}_handlePointerEnd(e,t){const i=this._grabbedManipulators.get(e.pointerId)?.manipulator;null!=i&&i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:de(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorRelease(t.setActiveTool))}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=Ce(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=Ce(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const t=new Set,i=new Set;this._grabbedManipulators.forEach((({tool:e})=>{t.add(e)})),this._hoveredManipulators.forEach((({tool:e})=>{i.add(e)})),e((e=>{e.hasGrabbedManipulators=t.has(e),e.hasHoveredManipulators=i.has(e);const s=this._grabbedManipulators.values(),o=h(s,(({tool:t})=>t===e));e.firstGrabbedManipulator=null!=o?o.manipulator:null}))}clearPointers(e,{forEachTool:t,setActiveTool:i},s=!0,o){const r=(t,i)=>t===e&&(null==o||o===i);this._grabbedManipulators.forEach((({tool:e,manipulator:t,pointerType:i},s)=>{r(e,t)&&(this._grabbedManipulators.delete(s),t.grabbing=!1,t.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:i}))})),this._draggedManipulators.forEach((({tool:e,manipulator:t},i)=>{r(e,t)&&(this._draggedManipulators.delete(i),t.dragging=!1,t.events.emit("drag",{action:"cancel"}))})),s&&this._hoveredManipulators.forEach((({tool:e,manipulator:t},i)=>{r(e,t)&&(this._hoveredManipulators.delete(i),t.hovering=!1)})),this._afterManipulatorRelease(i),this._onFocusChange(t)}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach(((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition(ue(t.x,t.y),i,t.pointerType,e)}))}handleHoverEvent(e,t){const i=e.type;"pointer-up"!==i&&"immediate-click"!==i&&"pointer-move"!==i||!Pe(e.pointerType)||("pointer-up"!==i&&this._externallyDragging?this._clearHoveredManipulatorStates(e.pointerId):this._updateHoveredStateForPointerAtScreenPosition(de(e),e.pointerId,e.pointerType,t))}_updateHoveredStateForPointerAtScreenPosition(e,t,i,s){let o=xe(e,i,s);const r=this._hoveredManipulators.get(t)?.manipulator;null==o||o.manipulator.interactive||(o=null),null!=o&&r===o.manipulator||(null!=r&&(r.hovering=!1),null!=o?(o.manipulator.hovering=!0,this._hoveredManipulators.set(t,o)):this._hoveredManipulators.delete(t),this._onFocusChange(s))}_afterManipulatorRelease(e){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}_clearHoveredManipulatorStates(e){this._hoveredManipulators.forEach((({manipulator:t},i)=>{e===i&&(this._hoveredManipulators.delete(e),t.hovering=!1)}))}}function Ce(e){for(const{manipulator:t}of e.values())if(null!=t&&t.interactive){if(t.grabbing&&t.grabCursor)return t.grabCursor;if(t.cursor)return t.cursor}return null}function xe(e,t,i){let s=null;return i((i=>{if(null==i.manipulators||!Ee(i))return!1;const o=i.manipulators.intersect(e,t);return null!=o&&(s={tool:i,manipulator:o},!0)})),s}function Pe(e){return"mouse"===e}function Fe(e){return"mouse"!==e.pointerType||0===e.button}function Oe(e,t){e?.consumesClicks&&t()}const De="attached",He="tools";let Ue=class extends i{constructor(e){super(e),this._updatingHandles=new A,this._clock=T,this._manipulatorState=new Le,this.tools=new r,this.cursor=null,this._interacting=!1,this._interactingTimeout=1e3,this._interactingTimeoutHandle=null,this._forEachTool=e=>{for(const t of this.tools.items)if(e(t))return}}initialize(){var e;this.addHandles([this.view.on(le,(e=>{this._handleInputEvent(e)}),ne.TOOL),...(e=this.tools,[e.on("before-add",(t=>{const i=t.item;if(null==i||e.includes(i))return m.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()})),e.on("after-remove",(e=>{const t=e.item;t.active&&(t.view.activeTool=null),t.destroy()}))]),this.tools.on("before-add",(({item:e})=>{this._updateToolEditableFlag(e)})),this.tools.on("before-remove",(({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this.activeTool=null,this.tools.drain((e=>e.destroy())),this._clearInteractingTimeout(),this._interacting=!1,this._updatingHandles.destroy()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(null!=e&&!this.view.ready)return void m.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const t=this.activeTool;this._set("activeTool",e),null!=t&&t.deactivate(),null!=e&&e.activate(),this._removeIncompleteTools(e);for(const e of this.tools){this._updateToolEditableFlag(e);const t=Ee(e);null!=this.activeTool&&t||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!t)}this._updateCursor()}get updating(){return this._updatingHandles.updating||this.tools.some((e=>e.updating))}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeoutHandle=g(this._interactingTimeoutHandle)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutHandle=this._clock.setTimeout((()=>this._interacting=!1),this._interactingTimeout)}attach(){"3d"===this.view.type?this.addHandles([I((()=>{const{state:e}=this.view;return"camera"in e&&e.camera}),(()=>this._forEachManipulator((e=>e.onViewChange())))),this.view.elevationProvider?.on("elevation-change",(e=>this._forEachManipulator((t=>t.onElevationChange(e)))))],De):this.addHandles(I((()=>this.view.extent),(()=>this._forEachManipulator((e=>e.onViewChange())))))}detach(){this.activeTool=null,this.tools.removeAll(),this.removeHandles(De),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){this._forEachTool((t=>{t.manipulators&&t.manipulators.forEach((({manipulator:i})=>e(i,t)))}))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};null!=this.activeTool?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool((e=>{!t&&e.visible&&e.handleInputEvent(i)})),!t&&"key-down"===e.type&&"Escape"===e.key&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),t||null==this.activeTool||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor(),"pointer-move"===e.type&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.removeHandles(He),this._forEachTool((e=>{if(e instanceof i){const t=I((()=>[e.cursor,e.visible,e.editable]),(()=>{Ee(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}));this.addHandles(t,He)}e.manipulators&&this.addHandles([e.manipulators.on("after-remove",(t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)})),e.manipulators.on("change",(()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}))],He)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){e.setEditableFlag?.(he.MANAGER,null==this.activeTool||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;null==e&&this._forEachTool((t=>!(null==t.cursor||!t.visible||(e=t.cursor,0)))),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter((t=>(null==e||t!==e)&&!t.created&&t.removeIncompleteOnCancel)).forEach((e=>{this.tools.remove(e)}))}get test(){}};e([F({constructOnly:!0,nonNullable:!0})],Ue.prototype,"view",void 0),e([F({value:null})],Ue.prototype,"activeTool",null),e([F({readOnly:!0,type:r})],Ue.prototype,"tools",void 0),e([F({readOnly:!0})],Ue.prototype,"cursor",void 0),e([F({readOnly:!0})],Ue.prototype,"updating",null),e([F()],Ue.prototype,"_interacting",void 0),e([F({readOnly:!0})],Ue.prototype,"interacting",null),Ue=e([O("esri.views.ToolViewManager")],Ue);let Ae=class extends i{constructor(e){super(e),this.required={extent:!1,heightModelInfo:!1,tileInfo:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=f(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference??this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return null==this.userSpatialReference||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){const e=this.map?.(),t=[];return null!=this.priorityCollection&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};let e;if(this._collectLayers(this.mapCollections,(t=>{const i=this._getSupportedSpatialReferences(t);if(i.length>0){const t=this._narrowDownSpatialReferenceCandidates(e,i);null!=t&&(e=t)}return 1===e?.length}))&&1!==e?.length)return{updating:!0};const t=this._pickSpatialReferenceCandidate(e);return{spatialReference:t?.spatialReference??null,viewingMode:t?.viewingMode??null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};const e=this.map?.(),t=this.spatialReference;if(!t)return{updating:this._spatialReferenceTask.updating};let i;const s=this._collectLayers([{parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers}],(e=>!(!("tileInfo"in e)||!e.tileInfo?.spatialReference.equals(t)||(i=e,0))),(e=>"tileInfo"in e));return i?{tileInfo:i.tileInfo,updating:!1}:{updating:s}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};let e={};const t=this._collectLayers(this.mapCollections,(t=>{const i=ge(t);return!!i&&(e={heightModelInfo:i,vcsWkid:t.spatialReference?.vcsWkid,latestVcsWkid:t.spatialReference?.latestVcsWkid},!0)}),(e=>fe(e)));return{...e,updating:t}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=[],t=this._collectLayers(this.mapCollections,(t=>{const i="fullExtents"in t&&t.fullExtents||(null!=t.fullExtent?[t.fullExtent]:[]),s=this.requiresExtentInSpatialReference?null:i[0],o=i.find((e=>e.spatialReference.equals(this.spatialReference)))??s;if(o)return e.push({extent:o,layer:t}),!0;if(this._getSupportedSpatialReferences(t).length>0)for(const s of i)e.push({extent:s,layer:t});return!1}));return{candidates:e,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(null==e||0===e.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),s=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&s.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:null!=this._projectExtentTask.task&&!this._projectExtentTask.task.finished}:(null!=this._projectExtentTask.task&&(this._projectExtentTask.task=f(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:s.clone(),task:o((async e=>{try{const t=await ve(i.extent,s,"portalItem"in i.layer?i.layer.portalItem:void 0,e);this._projectExtentTask={...this._projectExtentTask,task:null,output:t}}catch(t){if(S(e))return;this._projectExtentTask={...this._projectExtentTask,task:null}}}))},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(null==e)return t;const i=new Array;for(const s of e)for(const e of t){if(!s.spatialReference.equals(e.spatialReference))continue;const t=ze(s.viewingMode,e.viewingMode);if(!1!==t){i.push({spatialReference:s.spatialReference,viewingMode:t});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return null==e||e.length<1?t?{spatialReference:t,viewingMode:null}:null:(null!=t&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))&&(e=e.filter((({spatialReference:e})=>e.equals(t)))),e.length>1&&e.some((({viewingMode:e})=>e!==_e.Local))&&(e=e.filter((({viewingMode:e})=>e!==_e.Local))),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const i=[];for(const s of t){const t=this.getSpatialReferenceSupport(s,e);if(null!=t){const e=t.constraints??[{spatialReference:s,viewingMode:null}];for(const{spatialReference:t,viewingMode:s}of e)this.requiresExtentInSpatialReference&&null!=this.userSpatialReference&&!t.equals(this.userSpatialReference)||i.push({spatialReference:t,viewingMode:s})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find((({extent:e})=>t.equals(e.spatialReference)))||e[0]}_collectLayers(e,t,i=()=>!0){if("loaded"!==this._loadMaybe(this.map?.()))return!0;const s=new qe(i,t);for(const t of e)if(this._collectCollection(t,s),s.done||s.preloading===this.sourcePreloadCount)break;return s.updating}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers)if(t.layerFilter(i)){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":if(t.updating||(t.done=t.pushLayer(i)),t.done||t.preloading===this.sourcePreloadCount)break;"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.done||t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&null!=e.loadStatus?"not-loaded"===e.loadStatus?(e.load().catch((e=>{j(e)})),"loading"):e.loadStatus:"loaded"}};e([F()],Ae.prototype,"required",void 0),e([F({constructOnly:!0})],Ae.prototype,"map",void 0),e([F({constructOnly:!0})],Ae.prototype,"getSpatialReferenceSupport",void 0),e([F()],Ae.prototype,"defaultSpatialReference",void 0),e([F()],Ae.prototype,"userSpatialReference",void 0),e([F()],Ae.prototype,"sourcePreloadCount",void 0),e([F()],Ae.prototype,"priorityCollection",void 0),e([F()],Ae.prototype,"requiresExtentInSpatialReference",void 0),e([F()],Ae.prototype,"suspended",void 0),e([F({readOnly:!0})],Ae.prototype,"ready",null),e([F({readOnly:!0})],Ae.prototype,"heightModelInfoReady",null),e([F({readOnly:!0})],Ae.prototype,"spatialReference",null),e([F({readOnly:!0})],Ae.prototype,"extent",null),e([F({readOnly:!0})],Ae.prototype,"heightModelInfo",null),e([F({readOnly:!0})],Ae.prototype,"vcsWkid",null),e([F({readOnly:!0})],Ae.prototype,"latestVcsWkid",null),e([F({readOnly:!0})],Ae.prototype,"viewingMode",null),e([F({readOnly:!0})],Ae.prototype,"tileInfo",null),e([F({readOnly:!0})],Ae.prototype,"mapCollections",null),e([F({readOnly:!0})],Ae.prototype,"_spatialReferenceTask",null),e([F({readOnly:!0})],Ae.prototype,"_tileInfoTask",null),e([F({readOnly:!0})],Ae.prototype,"_heightModelInfoTask",null),e([F({readOnly:!0})],Ae.prototype,"_extentCandidatesTask",null),e([F()],Ae.prototype,"_extentTask",null),e([F()],Ae.prototype,"_projectExtentTask",void 0),Ae=e([O("esri.views.support.DefaultsFromMap")],Ae);class qe{constructor(e,t){this.layerFilter=e,this.pushLayer=t,this.preloading=-1,this.updating=!1,this.done=!1}}function ze(e,t){return null!=e?null!=t?e===t&&e:e:t}var Ne;let We=Ne=class extends(l.EventedMixin(v(i))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.handles=new p,this.updatingHandles=new A,this.allLayerViews=new a({getCollections:()=>[this.basemapView?.baseLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:Be}),this.groundView=null,this.basemapView=null,this.fatalError=null,this.graphics=new H,this.analyses=new we,this.typeSpecificPreconditionsReady=!0,this.layerViews=new r,this.magnifier=new Y,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new ye,this.navigation=new me,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new pe(this),this.persistableViewModels=new r,this._isValid=!1,this._readyCycleForced=!1,this._lockedSpatialReference=null,this._userTimeZone=null,this._lockedTimeZone=null,this._userTimeExtent=null,this._lockedTimeExtent=null,this.theme=null,this.handles.add(I((()=>this.preconditionsReady),(e=>{const t=this.ready;if(e?(this._lockedSpatialReference=this.spatialReference,this._lockedTimeZone=this.timeZone,this._lockedTimeExtent=this.timeExtent,Ne.views.add(this)):(this._lockedSpatialReference=null,Ne.views.remove(this)),this.notifyChange("spatialReference"),!e&&t)this.toolViewManager?.detach(),null!=this.analysisViewManager&&this.analysisViewManager.detach(),this.layerViewManager?.clear(),this._teardown();else if(e&&!t){try{this._startup()}catch(e){return void queueMicrotask((()=>{this.fatalError=new n("startup-error",null,e)}))}null!=this.analysisViewManager&&this.analysisViewManager.attach(),this.toolViewManager.attach()}}),x))}initialize(){this.addResolvingPromise(Promise.all([this.loadAsyncDependencies(),this.validate()]).then((()=>(this._isValid=!0,L((()=>this.ready)))))),this.basemapView=new K({view:this}),this.layerViewManager=new Me({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new Ue({view:this}),this._setupSpatialReferenceLogger(),this.selectionManager=new Ie({view:this}),this.addHandles([I((()=>this.initialExtentRequired),(e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e}),E),I((()=>this.ready),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)}),x),I((()=>this._userSpatialReference),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)}),E)])}_setupSpatialReferenceLogger(){let e=null;this.addHandles([I((()=>this.defaultsFromMap?.ready),(t=>{const i=this.map?.allLayers.length>0;if(t&&!this.spatialReference&&i){if(null!=e)return;const t=c((()=>e=f(e)));e=o((async t=>{try{await V(this.spatialReferenceWarningDelay,null,t)}catch{return}finally{e=null}m.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})),this.addHandles(t,"spatial-reference-logger-task")}else this.removeHandles("spatial-reference-logger-task")}),{sync:!0})])}destroy(){this.destroyed||(Ne.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=_(this.graphics),this.analyses=_(this.analyses),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),_(this.analysisViewManager),this.toolViewManager=_(this.toolViewManager),this.layerViewManager=_(this.layerViewManager),this.selectionManager=_(this.selectionManager),this.basemapView=_(this.basemapView),this.groundView?.destroy(),this.layerViews?.forEach((e=>e.destroy())),this.layerViews.length=0,this.invalidate(),this._emitter.clear(),this.handles.destroy(),this.map=_(this.map),this.updatingHandles.destroy())}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return m.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Ae({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:(e,t)=>this.getSpatialReferenceSupport(e,t),...this.defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||y.isLoadable(this.map)&&!this.map.loaded||0===this.width||0===this.height||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._lockedSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&(m.getLogger(this).warn("#map","The provided map is already destroyed",{map:e}),e=null),y.isLoadable(e)&&e.load().catch((()=>{})),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._lockedSpatialReference=null),this._set("map",e))}get spatialReference(){const e=this._userSpatialReference||this._lockedSpatialReference||this.getDefaultSpatialReference()||null;if(e&&this.defaultsFromMap?.required?.heightModelInfo){const t=e.clone();return t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid,t}return e}set spatialReference(e){const t=!W(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get timeExtent(){return this._userTimeExtent??this._lockedTimeExtent??this.getDefaultTimeExtent()??null}set timeExtent(e){this._userTimeExtent=e}get timeZone(){return this._userTimeZone??this._lockedTimeZone??this.getDefaultTimeZone()??Z}set timeZone(e){this._userTimeZone=e,B(e)||m.getLogger(this).warn("#timeZone",`the parsed value '${e}' may not be a valid IANA time zone`)}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){return this.toolViewManager?.cursor??this._cursor??"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}get effectiveTheme(){return this.theme??new ae}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}getDefaultTimeZone(){return null}getDefaultTimeExtent(){return null}importLayerView(e){throw new n("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}async loadAsyncDependencies(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return null!=this.getSpatialReferenceSupport(e)}when(e,t){return this.isResolved()&&!this.ready&&m.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(C((()=>this.destroyed||!1===this.preconditionsReady),(()=>this._readyCycleForced=!1),{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}};We.views=new r,e([F()],We.prototype,"_userSpatialReference",void 0),e([F()],We.prototype,"activeTool",null),e([F({readOnly:!0})],We.prototype,"allLayerViews",void 0),e([F()],We.prototype,"groundView",void 0),e([F()],We.prototype,"animation",null),e([F()],We.prototype,"basemapView",void 0),e([F()],We.prototype,"center",null),e([F()],We.prototype,"defaultsFromMapSettings",null),e([F()],We.prototype,"defaultsFromMap",null),e([F()],We.prototype,"fatalError",void 0),e([F({type:q})],We.prototype,"extent",null),e([F(U(H,"graphics"))],We.prototype,"graphics",void 0),e([F(U(we,"analyses"))],We.prototype,"analyses",void 0),e([F({readOnly:!0,type:z})],We.prototype,"heightModelInfo",null),e([F({readOnly:!0})],We.prototype,"interacting",null),e([F({readOnly:!0})],We.prototype,"navigating",null),e([F({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_lockedSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],We.prototype,"preconditionsReady",null),e([F({readOnly:!0})],We.prototype,"typeSpecificPreconditionsReady",void 0),e([F({type:r,readOnly:!0})],We.prototype,"layerViews",void 0),e([F()],We.prototype,"resolution",null),e([F({type:Y})],We.prototype,"magnifier",void 0),e([F({value:null,type:t})],We.prototype,"map",null),e([F()],We.prototype,"padding",void 0),e([F({readOnly:!0})],We.prototype,"ready",void 0),e([F({type:N})],We.prototype,"spatialReference",null),e([F()],We.prototype,"spatialReferenceWarningDelay",void 0),e([F()],We.prototype,"stationary",null),e([F({readOnly:!0})],We.prototype,"supportsGround",void 0),e([F({type:G})],We.prototype,"timeExtent",null),e([F({type:String,nonNullable:!0})],We.prototype,"timeZone",null),e([F()],We.prototype,"tools",null),e([F()],We.prototype,"toolViewManager",void 0),e([F({readOnly:!0})],We.prototype,"type",void 0),e([F({type:Number})],We.prototype,"scale",void 0),e([F({readOnly:!0})],We.prototype,"updating",void 0),e([F({readOnly:!0})],We.prototype,"initialExtentRequired",void 0),e([F({readOnly:!0})],We.prototype,"initialExtent",null),e([F()],We.prototype,"cursor",null),e([F({readOnly:!0})],We.prototype,"input",void 0),e([F({type:me,nonNullable:!0})],We.prototype,"navigation",void 0),e([F()],We.prototype,"layerViewManager",void 0),e([F()],We.prototype,"analysisViewManager",void 0),e([F()],We.prototype,"selectionManager",void 0),e([F()],We.prototype,"width",void 0),e([F()],We.prototype,"height",void 0),e([F({readOnly:!0})],We.prototype,"resizing",void 0),e([F({value:null,readOnly:!0})],We.prototype,"size",null),e([F({readOnly:!0})],We.prototype,"suspended",void 0),e([F({readOnly:!0})],We.prototype,"viewEvents",void 0),e([F({readOnly:!0})],We.prototype,"persistableViewModels",void 0),e([F()],We.prototype,"_isValid",void 0),e([F()],We.prototype,"_readyCycleForced",void 0),e([F()],We.prototype,"_lockedSpatialReference",void 0),e([F()],We.prototype,"_userTimeZone",void 0),e([F()],We.prototype,"_lockedTimeZone",void 0),e([F()],We.prototype,"_userTimeExtent",void 0),e([F()],We.prototype,"_lockedTimeExtent",void 0),e([F({type:ae})],We.prototype,"theme",void 0),e([F({readOnly:!0,type:ae})],We.prototype,"effectiveTheme",null),We=Ne=e([O("esri.views.View")],We);const Ge=globalThis.$arcgis;Ge&&!Ge.views&&Object.defineProperty(Ge,"views",{configurable:!1,enumerable:!0,writable:!1,value:We.views});const Ze=We;function Be(e){return e.layerViews}export{we as A,Ze as default};
