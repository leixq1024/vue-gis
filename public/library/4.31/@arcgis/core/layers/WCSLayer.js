/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Error.js";import{M as s}from"../chunks/MultiOriginJSONSupport.js";import{watch as o}from"../core/reactiveUtils.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{L as i}from"../chunks/Logger.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import a from"./Layer.js";import{BlendLayer as p}from"./mixins/BlendLayer.js";import{CustomParametersMixin as l}from"./mixins/CustomParametersMixin.js";import{B as m,ImageryTileMixin as c}from"./mixins/ImageryTileMixin.js";import{OperationalLayer as u}from"./mixins/OperationalLayer.js";import{PortalLayer as h}from"./mixins/PortalLayer.js";import{RefreshableLayer as d}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as j}from"./mixins/ScaleRangeLayer.js";import{TemporalLayer as f}from"./mixins/TemporalLayer.js";import{p as g}from"../chunks/commonProperties2.js";import y from"./support/Field.js";import"../geometry.js";import{i as b}from"../chunks/crsUtils.js";import{getCapabilities as v,describeCoverage as k,s as w}from"./ogc/wcsUtils.js";import C from"./support/DimensionalDefinition.js";import{g as I}from"../chunks/RasterSymbolizer.js";import{h as x}from"../chunks/vectorFieldUtils.js";import S from"../geometry/Extent.js";import{createPopupTemplate as R}from"../support/popupUtils.js";import"../config.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../chunks/metadata.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../core/JSONSupport.js";import"../chunks/asyncUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"../chunks/ensureType.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../time/TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/date.js";import"../chunks/jsonMap.js";import"../chunks/locale.js";import"../chunks/datetime.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../geometry/SpatialReference.js";import"../chunks/unitUtils.js";import"../chunks/assets.js";import"../geometry/Geometry.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/utils2.js";import"../chunks/screenUtils.js";import"../chunks/mat4.js";import"../chunks/common.js";import"../rasterRenderers.js";import"../renderers/ClassBreaksRenderer.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../chunks/enumeration.js";import"./support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../chunks/messages.js";import"../symbols/Symbol.js";import"../Color.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils4.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../chunks/vec3f64.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils5.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../chunks/compilerUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties.js";import"../symbols/support/jsonUtils.js";import"../chunks/layerUtils.js";import"../chunks/defaults.js";import"../chunks/defaultsJSON.js";import"../chunks/RendererLegendOptions.js";import"../renderers/FlowRenderer.js";import"../renderers/RasterColormapRenderer.js";import"../renderers/support/ColormapInfo.js";import"../chunks/colorRampUtils.js";import"../chunks/colorUtils2.js";import"../chunks/vec4.js";import"../chunks/vec4f64.js";import"../renderers/RasterShadedReliefRenderer.js";import"../renderers/RasterStretchRenderer.js";import"../chunks/stretchRendererUtils.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils.js";import"../renderers/VectorFieldRenderer.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/simplify.js";import"../chunks/utils9.js";import"../chunks/utils10.js";import"../chunks/utils12.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils7.js";import"../chunks/enums2.js";import"../chunks/LRUCache.js";import"../chunks/MemCache.js";import"./support/PixelBlock.js";import"../chunks/pixelRangeUtils.js";import"../chunks/arcgisLayerUrl.js";import"./support/MultidimensionalSubset.js";import"./support/RasterFunction.js";import"../chunks/RasterJobHandler.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"./support/TileInfo.js";import"./support/LOD.js";import"../chunks/TileKey.js";import"./support/RasterInfo.js";import"./support/RasterBandInfo.js";import"./support/RasterSensorInfo.js";import"../chunks/multidimensionalUtils.js";import"../chunks/RawBlockCache.js";import"../chunks/rasterProjectionHelper.js";import"../geometry/projection.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/QueueProcessor.js";import"../chunks/ReactiveMap.js";import"../core/signal.js";import"../chunks/rasterFunctionHelper.js";import"./support/rasterFunctionConstants.js";import"../chunks/stretchUtils.js";import"../chunks/focalStatUtils.js";import"../rest/support/FeatureSet.js";import"../chunks/domains.js";import"./support/CodedValueDomain.js";import"./support/Domain.js";import"./support/InheritedDomain.js";import"./support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/rasterRendererHelper.js";import"../chunks/generateRendererUtils.js";import"../rest/support/ImageHistogramParameters.js";import"./support/MosaicRule.js";import"../chunks/dataUtils.js";import"../chunks/layerContainerType.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../tables/AttributeTableTemplate.js";import"../tables/elements/AttributeTableGroupElement.js";import"../tables/elements/AttributeTableElement.js";import"../tables/support/elements.js";import"../tables/elements/AttributeTableAttachmentElement.js";import"../tables/elements/AttributeTableFieldElement.js";import"../tables/elements/AttributeTableRelationshipElement.js";import"../chunks/_commonjsHelpers.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"./support/TimeInfo.js";import"../time/TimeInterval.js";import"../chunks/xmlUtilities.js";function T(e,t,s=0){const o="--"+t.boundary,r=[];for(let e=0;e<o.length;e++)r.push(o.charCodeAt(e));const i=[],n="\n--"+t.boundary+"--";for(let e=0;e<n.length;e++)i.push(n.charCodeAt(e));const a=[10],p=[13,10],l=[],m=r.length,c=new Uint8Array(e,s),u=Math.min(5e4,c.length-m);let h=0,d=0;for(let e=0;e<u;e++){for(d=0;d<m&&c[e+d]===r[d];d++);d===m&&(h&&l.push(U(c.subarray(h,e),t)),e+=m-1,c[e+1]===a[0]?e+=1:c[e+1]===p[0]&&c[e+2]===p[1]&&(e+=2),h=e+1)}const j=i.length;for(let e=c.length-j-10;e<c.length-j;e++){for(d=0;d<j&&c[e+d]===i[d];d++);if(d===j){l.push(U(c.subarray(h,e),t));break}}return l}function U(e,t){const s=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split("\n"),o=Math.min(s.length,7),r={contentDisposition:"inline"};let i=0;for(let n=0;n<o;n++)if(s[n].length<4)i=i+s[n].length+1;else if("content"===s[n].slice(0,7).toLowerCase()){i=i+s[n].length+1;const e=s[n].indexOf(":");if(-1===e)continue;const t=s[n].slice(0,e).trim(),o=s[n].slice(e+1).trim();switch(t.toLowerCase()){case"content-type":r.contentType=o;break;case"content-description":r.contentDescription=o;break;case"content-transfer-encoding":r.contentTransferEncoding=o;break;case"content-id":r.contentID=o;break;case"content-disposition":r.contentDisposition=o;break;case"content-location":r.contentLocation=o}}else{if(r.contentDisposition.toLowerCase().includes("inline")&&s[n].length>=4&&r.contentType?.toLowerCase().indexOf("image")>-1){let t=!0,s=e.subarray(i,e.length);if(r.contentType.toLowerCase().indexOf("tif")>0){if("base64"===r.contentTransferEncoding){let e="";const t=s;for(let s=0;s<t.length;s+=65535){const o=t.subarray(s,s+65535>t.length-1?t.length-1:s+65535);e+=String.fromCharCode.apply(null,o)}const o=atob(e);s=new Uint8Array(o.length);for(let e=0;e<s.length;e++)s[e]=o.charCodeAt(e)}t=73===s[0]&&73===s[1]||77===s[0]&&77===s[1]}if(t){let t=s.buffer;"base64"!==r.contentTransferEncoding&&(t=new ArrayBuffer(e.length-i),s=new Uint8Array(t),s.set(e.subarray(i,e.length))),r.contentData=t}break}if((""===t.start||r.contentID===t.start)&&r.contentType){if(r.contentType.includes("text")||r.contentType.includes("xml")){r.contentData=String.fromCharCode.apply(null,e.subarray(i,e.length));break}r.contentData=e.subarray(i,e.length)}}return r}const L=["nearest neighbor","bilinear","bicubic"],P=["nearest","linear","cubic"],D="response is not a supported multipart/related mediaType with inline tiff,  switching to compatibility mode",$=new Set(["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"]);let A=class extends m{constructor(){super(...arguments),this.datasetFormat="WCSServer",this.tileType="Raster"}async fetchRawTile(e,s,o,r={}){if(this.isBlockOutside(e,s,o))return null;const{nativePixelSize:i,spatialReference:n}=this.rasterInfo,a=2**e,p=i.x*a,l=i.y*a,{blockWidth:m,blockHeight:c}=this.getBlockWidthHeight(e),{origin:u}=this.rasterInfo.storageInfo.tileInfo,h=this.getTileExtent({x:p,y:l},s,o,u,n,[m,c]),d=this.rasterInfo.extent,j=h.xmax>d.xmax,f=h.ymin<d.ymin,g=j||f;let y=h,b=m,v=c;if(g&&(y=h.clone().intersection(d),null!=y&&(j&&(b=Math.floor((y.xmax-y.xmin)/p),y.xmax=y.xmin+p*b),f&&(v=Math.floor((y.ymax-y.ymin)/l),y.ymin=y.ymax-l*v))),null==y||b<=1||v<=1)return null;const k=await this._getCoverage(y,b,v,a,r);if(!k)return null;const{coverageDescription:w}=this.coverageInfo;let{noDataValue:C,multidimensionalInfo:I}=this.rasterInfo;const{multidimensionalDefinition:S}=r;if(null!=I&&null!=S&&S.length){const e=S[0].variableName;if("2.0"===w.version){const t=w.rangeType[0].find((t=>t.name===e));C=t?.nilValue}else if("1.1"===w.version){const t=w.range.find((t=>t.identifier===e));C=t?.nullValues}}const R=await this.decodePixelBlock(k,{width:b,height:v,planes:null,pixelType:null,noDataValue:Array.isArray(C)?C[0]:C});if(null==R)return null;if(R&&(R.width!==b||R.height!==v))throw new t("wcsraster-fetch",`the response has unexpected dimension width: ${R.width}, height: {pixelBlock.height}`);return g?x(R,{x:0,y:0},{width:c,height:c}):R}async _open(e){const{customFetchParameters:s}=this.ioConfig,o=e?.signal,r=await v(this.url,{version:this.version,customParameters:s,signal:o});if(this.capabilities=r,!this.version){let e=r.version.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=r.version:(e=r.supportedVersions.find((e=>"2.0.1"===e))||r.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||r.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||r.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}if(!$.has(this.version))throw new t("wcsraster-open",`unsupported WCS version ${this.version}`);const{gridCoverages:i}=r;if(!i.length)throw new t("wcsraster-open","cannot find rectified grid coverages");null==this.coverageId&&(this.coverageId=i[0].id);const n=i.find((e=>e.id===this.coverageId));if(null==n)throw new t("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);const a=await k(this.url,{coverageIds:[this.coverageId],version:this.version,customParameters:s,signal:o});this.coverageInfo=a[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=n.lonLatEnvelope,this.coverageInfo.supportedInterpolations=w(r.supportedInterpolations)),this.datasetName=this.coverageInfo.title;const{rasterInfo:p}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(p,512,512),this._set("rasterInfo",p),null==p.spatialReference)throw new t("wcsraster-open",`coverage without spatial reference is not supported: ${this.coverageId}`);const{pixelType:l,bandCount:m}=await this._getPixelTypeAndBandCount(o);p.pixelType=l,1===p.bandCount&&m>1&&(p.bandCount=m),this.updateTileInfo()}async _getPixelTypeAndBandCount(e){const{pixelSize:s,extent:o,multidimensionalInfo:r}=this.rasterInfo,n=o.center,a=new S({xmin:n.x-s.x,xmax:n.x+s.x,ymin:n.y-s.y,ymax:n.y+s.y,spatialReference:o.spatialReference});let p=[];if(null!=r){const e=r.variables[0];p=[],e.dimensions.forEach((t=>{p.push(new C({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent?.[0]:t.values?.[0],isSlice:!0}))}))}const{coverageDescription:l}=this.coverageInfo,m={interpolation:"nearest",multidimensionalDefinition:p,signal:e},{version:c}=l,{ioConfig:u}=this,h="2.0"===c&&null==u.allowAnyMediaType||"1.1"===c&&null==u.use2GridOffsets;let d;try{d=await this._getCoverage(a,2,2,1,m,!0)}catch(e){if(!h)throw e;if("1.1"===c){if(!e.details?.isResolutionMismatch)throw e;u.use2GridOffsets=!0}}if(!d&&h&&("2.0"===c&&(u.allowAnyMediaType=!0),d=await this._getCoverage(a,2,2,1,m),d&&i.getLogger(this).warn("wcsraster:getcoverage",D)),!d)throw new t("wcsraster-open","unable to determine pixel type");const j=await this.decodePixelBlock(d,{width:2,height:2,planes:null,pixelType:null});if(null==j)throw new t("wcsraster-open","unable to determine pixel type");return{pixelType:j.pixelType,bandCount:j.getPlaneCount()??0}}async _getCoverage(e,s,o,r,n,a=!1){const{coverageDescription:p}=this.coverageInfo,{version:l}=p,m="2.0"===l?this._getCoverage201Parameters(e,s,o,r,n,p):"1.1"===l?this._getCoverage110Parameters(e,s,o,n,p):this._getCoverage100Parameters(e,s,o,n),c="2.0"===l?await this.request(this._constructWCS201Url(m),{signal:n.signal,responseType:"array-buffer"}):await this.request(this.url,{query:m,signal:n.signal,responseType:"array-buffer"});if("1.0"===l)return c.data;if("2.0"===l&&!1!==this.ioConfig.allowAnyMediaType&&"tiff"===I(c.data))return a&&(this.ioConfig.allowAnyMediaType=!0,i.getLogger(this).warn("wcsraster:getcoverage",D)),c.data;const u=function(e){const t=function(e){const t=e.getHeader?.("Content-Type")?.split(";");if(!t)return null;if(!(t[0].trim()??"").startsWith("multipart/"))return null;const s={boundary:"",start:"",type:""};for(let e=1;e<t.length;e++){const o=t[e].indexOf("=");if(o>0){const r=t[e].slice(0,o).trim(),i=t[e].slice(o+1).trim();s[r]=i.startsWith('"')?i.slice(1,-1):i}}return s}(e);return t?{isMultipart:!0,data:t.boundary?T(e.data,t,0):null}:{isMultipart:!1,data:null}}(c);if(u.isMultipart&&u.data){const e=u.data.find((e=>e.contentType?.toLowerCase().includes("image")&&null!=e.contentData));return a&&"base64"===e?.contentTransferEncoding&&i.getLogger(this).warn("wcsraster:getcoverage","response is base64 encoded which may impact layer display performance"),e?.contentData}const h=new Uint8Array(c.data,0,Math.min(c.data.byteLength,2e3)),d=String.fromCharCode.apply(null,h).toLowerCase().includes("exception"),j=d&&String.fromCharCode.apply(null,h).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");if(d)throw new t("wcsraster:getcoverage","server returns an exception",{isResolutionMismatch:j});throw new t("wcsraster:getcoverage","response is not a supported multipart mediaType with inline tiff")}_getInterpolationIndex(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0:0}_getCoverage100Parameters(e,t,s,o){const r=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,i=e.spatialReference.wkid,n=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"GEOTIFF",{bandIds:a,interpolation:p}=o,l=this._getInterpolationIndex(p),m=a?a.map((e=>this.coverageInfo.bandNames[e])):null,c=L[l],{multidimensionalDefinition:u}=o;let h;if(null!=u&&null!=this.rasterInfo.multidimensionalInfo){const e=u.find((e=>"StdTime"===e.dimensionName));let t=e?.values;t&&t.length>0&&(Array.isArray(t[0])&&(t=t[0]),h=t.map((e=>M(e))).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:n,crs:`EPSG:${i}`,bbox:r,width:t,height:s,time:h,interpolation:c,band:m?.join(",")}}_getCoverage110Parameters(e,t,s,o,r){const{multidimensionalDefinition:i,bandIds:n,interpolation:a}=o,p=e.spatialReference.wkid,l=`urn:ogc:def:crs:EPSG::${p}`,m=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",c=this._getInterpolationIndex(a),u=P[c],h=null==a||0===this.coverageInfo.supportedInterpolations?.indexOf(a),d=r.domain.spatialDomain,j=d.origin.x<=d.envelope.xmin&&d.origin.y<=d.envelope.ymin,f=e.width/t,g=e.height/s*(j?1:-1),y=j?[e.xmin,e.ymin]:[e.xmin,e.ymax],v=d.useEPSGAxis&&b(p),k=v?`${y[1]},${y[0]}`:`${y[0]},${y[1]}`,w=this.ioConfig.use2GridOffsets,C=v?w?`${g},${f}`:`${g},0,0,${f}`:w?`${f},${g}`:`${f},0,0,${g}`,I=f/2,x=e.xmin+I,S=e.xmax-I,R=Math.abs(g)/2,T=e.ymin+R,U=e.ymax-R,L=v?`${T},${x},${U},${S},${l}`:`${x},${T},${S},${U},${l}`,D=r.range.find((e=>e.axis.some((e=>e.identifier.toLowerCase().includes("band")))));let $,A=D&&u&&n?h?`${D.identifier}[${D.axis[0].identifier}[${n.join(",")}]]`:`${D.identifier}:${u}[${D.axis[0].identifier}[${n.join(",")}]]`:null;if(null!=i&&i.length)for(let e=0;e<i.length;e++){let t=i[e].values;const s=i[e].dimensionName?.toLowerCase(),o=i[e].variableName?.toLowerCase();if(t.length>0)if(Array.isArray(t[0])&&(t=t[0]),"stdtime"===s)$=t.map((e=>M(e))).join(",");else{const e=r.range.find((e=>e.identifier.toLowerCase()===o));if(e){const o=e.axis.find((e=>e.identifier.toLowerCase()===s));o&&(A=h?e.identifier+"["+o.identifier+"["+t.join(",")+"]]":e.identifier+":"+u+"["+o.identifier+"["+t.join(",")+"]]")}}}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:m,crs:`EPSG:${p}`,boundingbox:L,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:k,gridOffsets:C,gridBaseCRS:l,timeSequence:$,rangeSubset:A}}_getCoverage201Parameters(e,t,s,o,r,i){const{multidimensionalDefinition:n,interpolation:a}=r,p=this._getInterpolationIndex(a);let l=null;const{supportedInterpolations:m}=this.capabilities;if(m?.length)switch(p){case 0:l=m.find((e=>e.toLowerCase().includes("nearest")));break;case 1:l=m.find((e=>e.toLowerCase().includes("linear")));break;case 2:l=m.find((e=>e.toLowerCase().includes("cubic")||e.toLowerCase().includes("quadratic")))}const c=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",{bandNames:u}=this.coverageInfo,{boundedBy:h,domainSet:d,rangeType:j}=i,f=h.isEastFirst?0:1,g=1-f,{axisLabels:y}=h,b=y[f],v=y[g],k=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,w=k,C=[];C.push(`${b}(${e.xmin},${e.xmax})`),C.push(`${v}(${e.ymin},${e.ymax})`);const I=[];if(y.length>2)for(let e=2;e<y.length;e++){const t=d.origin[e];if(y[e].toLowerCase().includes("time")){let s=t.toString();h.uomLabels?.[e].toLowerCase().includes("ole")&&(I.push(y[e]),s=M(t,!0)),C.push(y[e]+",http://www.opengis.net("+s+")")}else C.push(y[e]+",http://www.opengis.net("+t+")")}let x=null;if(null!=n&&n.length){const e=[];j.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let s=0;s<n.length;s++){const o=y.find((e=>e===n[s].dimensionName)),r=e.find((e=>e===n[s].variableName));if(t.includes(r)||t.push(r),o){let e=n[s].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=o.toLowerCase().includes("time")?e.map((e=>M(e))).join(","):e.join(",");const s=C.findIndex((e=>0===e.indexOf(o+",http://www.opengis.net")));-1===s&&C.push(o+",http://www.opengis.net("+t+")"),-1===s||C[s].includes("("+t+")")||C.splice(s,1,o+",http://www.opengis.net("+t+")")}}}t.length&&(x=t.join(","))}else u?.length>=2&&(x=(r.bandIds?r.bandIds.map((e=>u[e])):u).join(","));const S=C.join("&subset="),R=!i.domainSet.hasSameAxisLabelsAsBoundedBy&&!1!==this.ioConfig.allowScaleFactor,T=R?null:`${b}(${t}),${v}(${s})`,U=R?1/o:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:x,interpolation:l,scaleSize:T,scaleFactor:U,subset:S,format:c,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:k,subsettingcrs:w}}_constructWCS201Url(e){const t={...this.ioConfig.customFetchParameters,...e},s=[];return Object.keys(t).forEach((e=>{const o=t[e];null!=o&&("subset"===e?"string"==typeof o&&o.split("&subset=").forEach((e=>{e&&s.push(`subset=${encodeURIComponent(e)}`)})):s.push(`${e}=${encodeURIComponent(o)}`))})),`${encodeURI(this.url)}?${s.join("&")}`}};function M(e,t=!1){return(t?new Date(24*(e-25569)*60*60*1e3):new Date(e)).toISOString()}e([r({type:String,json:{write:!0}})],A.prototype,"datasetFormat",void 0),e([r({readOnly:!0})],A.prototype,"tileType",void 0),e([r({type:String,json:{write:!0}})],A.prototype,"version",void 0),e([r({type:String,json:{write:!0}})],A.prototype,"coverageId",void 0),A=e([n("esri.layers.support.rasterDatasets.WCSRaster")],A);const E=A,O=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]);let V=class extends(p(j(u(h(l(c(f(d(s(a)))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=null!=e?e.signal:null;return this.addResolvingPromise(this._openRaster(t)),Promise.resolve(this)}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){return[new y({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})]}createPopupTemplate(e){return R({fields:this.rasterFields,title:this.title},e)}async _openRaster(e){const s=new E({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters}});if(await s.open({signal:e}),!s.rasterInfo)throw s.destroy(),new t("wcs-layer:load","cannot load resources on "+this.url);const{rasterInfo:r}=s;this._set("serviceRasterInfo",r),this._set("spatialReference",r.spatialReference),null==this.title&&this.setAtOrigin("title",s.datasetName,"service"),null==this.coverageId&&this.setAtOrigin("coverageId",s.coverageInfo.id,"service"),null==this.version&&s.version&&this.setAtOrigin("version",s.version,"service"),this.setAtOrigin("tileInfo",s.rasterInfo.storageInfo.tileInfo,"service");const{multidimensionalInfo:i}=r;if(null!=i){const e=i.variables[0].dimensions.find((({name:e})=>"StdTime"===e));if(e){let t=e.extent?.[0]??e.values[0];Array.isArray(t)&&(t=t[0]);let s=e.extent?.[1]??e.values[e.values.length-1];Array.isArray(s)&&(s=s[1]);const o=O.has(e.intervalUnit?.toLowerCase())?e.intervalUnit?.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:t,end:s},timeZone:null,interval:o?{value:e.interval,unit:o}:null})}}this.raster=s,this._configDefaultSettings(),this.addHandles(o((()=>this.customParameters),(e=>this.raster.ioConfig.customFetchParameters=e)))}};e([r({type:String,nonNullable:!0,json:{write:!0}})],V.prototype,"coverageId",void 0),e([r()],V.prototype,"coverageInfo",null),e([r()],V.prototype,"version",void 0),e([r()],V.prototype,"isReference",void 0),e([r()],V.prototype,"raster",void 0),e([r({readOnly:!0})],V.prototype,"type",void 0),e([r(g)],V.prototype,"popupEnabled",void 0),e([r()],V.prototype,"popupTemplate",void 0),e([r({readOnly:!0})],V.prototype,"defaultPopupTemplate",null),e([r({readOnly:!0,type:[y]})],V.prototype,"fields",void 0),e([r({readOnly:!0,type:[y]})],V.prototype,"rasterFields",null),V=e([n("esri.layers.WCSLayer")],V);const F=V;export{F as default};
