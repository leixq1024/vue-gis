/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{r as t,d as r}from"../../../chunks/mathUtils.js";import{z as s,c as e}from"../../../chunks/vec3f64.js";import{j as o,g as i,o as n}from"../../../chunks/vec3.js";import{webMercatorToGeographic as a}from"../../../geometry/support/webMercatorUtils.js";import"../../../geometry.js";import{u as p}from"../../../chunks/languageUtils.js";import m from"../../../core/Error.js";import{isSerializable as l}from"../../../core/JSONSupport.js";import{L as c}from"../../../chunks/Logger.js";import{c as u}from"../../../chunks/mat3f64.js";import{c as j,f as h}from"../../../chunks/mat4f64.js";import{b as f}from"../../../chunks/vec4f64.js";import{t as y,m as d}from"../../../chunks/mat3.js";import{q as g,A as k}from"../../../chunks/mat4.js";import{projectWithZConversion as b}from"../../../geometry/projection.js";import{b as I,h as S}from"../../../chunks/unitUtils.js";import{a as R}from"../../../chunks/vec32.js";import{C as M,i as v,a as w}from"../../../chunks/ElevationSourceDefinitions.js";import{isAbortError as L,waitTick as U}from"../../../core/promiseUtils.js";import{d as C}from"../../../chunks/aaBoundingRect.js";import T from"../../ElevationLayer.js";import A from"../../ImageryLayer.js";import"../../ImageryTileLayer.js";import{TileElevationSampler as x}from"../../support/ElevationSampler.js";import{E}from"../../../chunks/ElevationTile.js";import{E as P}from"../../../chunks/LercDecoder.js";import O from"../../support/RasterFunction.js";import F from"../../support/TileInfo.js";import{T as D}from"../../../chunks/TileKey.js";import V from"../../../request.js";import"../../../core/lang.js";import"../../../config.js";import"../../../geometry/Polygon.js";import"../../../geometry/Polyline.js";import"../../../chunks/normalizeUtilsCommon.js";import N from"../../../geometry/SpatialReference.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../geometry/Multipoint.js";import z from"../../../geometry/Point.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../rest/support/FindImagesParameters.js";import"../../../rest/support/FindImagesResult.js";import"../../../rest/support/ImageAngleParameters.js";import"../../../rest/support/ImageAngleResult.js";import"../../../rest/support/ImageAreaParameters.js";import"../../../rest/support/ImageAreaResult.js";import"../../../rest/support/ImageBoundaryParameters.js";import"../../../rest/support/ImageBoundaryResult.js";import"../../../rest/support/ImageDistanceParameters.js";import"../../../rest/support/ImageDistanceResult.js";import"../../../rest/support/ImageGPSInfoParameters.js";import"../../../rest/support/ImageGPSInfoResult.js";import"../../../rest/support/ImageHeightParameters.js";import"../../../rest/support/ImageHeightResult.js";import"../../../rest/support/ImageHistogramParameters.js";import"../../../rest/support/ImageIdentifyParameters.js";import"../../../rest/support/ImageIdentifyResult.js";import"../../../rest/support/ImagePixelLocationParameters.js";import"../../../rest/support/ImagePixelLocationResult.js";import"../../../rest/support/ImagePointParameters.js";import"../../../rest/support/ImagePointResult.js";import"../../../rest/support/ImageSampleParameters.js";import"../../../rest/support/ImageSampleResult.js";import"../../../rest/support/ImageToMapMultirayParameters.js";import"../../../rest/support/ImageToMapParameters.js";import"../../../rest/support/ImageUrlParameters.js";import"../../../rest/support/ImageUrlResult.js";import"../../../rest/support/MapToImageParameters.js";import"../../../rest/support/MeasureAreaFromImageResult.js";import"../../../rest/support/MeasureFromImageParameters.js";import"../../../rest/support/MeasureLengthFromImageResult.js";import{f as H}from"../../../chunks/requestPresets.js";import"../../../chunks/common.js";import"../../../chunks/tslib.es6.js";import"../../../core/Accessor.js";import"../../../core/Handles.js";import"../../../chunks/maybe.js";import"../../../core/accessorSupport/decorators/subclass.js";import"../../../chunks/metadata.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/tracking.js";import"../../../chunks/ensureType.js";import"../../../core/accessorSupport/decorators/property.js";import"../../../chunks/ObservableBase.js";import"../../../core/scheduling.js";import"../../../chunks/writer.js";import"../../../chunks/jsonMap.js";import"../../../chunks/assets.js";import"../../../chunks/typeUtils.js";import"../../../geometry/support/jsonUtils.js";import"../../../chunks/reader.js";import"../../../chunks/zmUtils.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../chunks/coordsUtils.js";import"../../../chunks/Axis.js";import"../../../chunks/extentUtils.js";import"../../../chunks/boundsUtils.js";import"../../../chunks/TimeOnly.js";import"../../../chunks/UnknownTimeZone.js";import"../../../chunks/datetime.js";import"../../../chunks/locale.js";import"../../../chunks/ImmutableArray.js";import"../../../chunks/shared2.js";import"../../support/Field.js";import"../../../chunks/enumeration.js";import"../../../chunks/domains.js";import"../../support/CodedValueDomain.js";import"../../support/Domain.js";import"../../support/InheritedDomain.js";import"../../support/RangeDomain.js";import"../../../chunks/fieldType.js";import"../../../chunks/number2.js";import"../../../rest/support/Query.js";import"../../../chunks/DataLayerSource.js";import"../../../chunks/FullTextSearch.js";import"../../../core/Clonable.js";import"../../../chunks/spatialRelationships.js";import"../../../rest/support/StatisticDefinition.js";import"../../../time/TimeExtent.js";import"../../../chunks/timeUtils.js";import"../../../chunks/date.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/geodesicConstants.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../chunks/MultiOriginJSONSupport.js";import"../../../geometry/HeightModelInfo.js";import"../../Layer.js";import"../../../core/Evented.js";import"../../../core/Identifiable.js";import"../../../core/Loadable.js";import"../../../core/Promise.js";import"../../mixins/ArcGISCachedService.js";import"../../../chunks/TileInfoTilemapCache.js";import"../../../chunks/TilemapCache.js";import"../../../chunks/ByteSizeUnit.js";import"../../../chunks/LRUCache.js";import"../../../chunks/MemCache.js";import"../../../core/reactiveUtils.js";import"../../../chunks/asyncUtils.js";import"../../../core/Collection.js";import"../../../chunks/shared.js";import"../../support/LOD.js";import"../../../chunks/ArcGISService.js";import"../../../chunks/arcgisLayerUrl.js";import"../../../chunks/persistableUrlUtils.js";import"../../mixins/OperationalLayer.js";import"../../../chunks/layerContainerType.js";import"../../../chunks/commonProperties2.js";import"../../../chunks/ElevationInfo.js";import"../../support/fieldUtils.js";import"../../../core/sql.js";import"../../../intl.js";import"../../../chunks/number.js";import"../../../chunks/substitute.js";import"../../../chunks/messages.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../tables/AttributeTableTemplate.js";import"../../../tables/elements/AttributeTableGroupElement.js";import"../../../tables/elements/AttributeTableElement.js";import"../../../tables/support/elements.js";import"../../../tables/elements/AttributeTableAttachmentElement.js";import"../../../tables/elements/AttributeTableFieldElement.js";import"../../../tables/elements/AttributeTableRelationshipElement.js";import"../../../chunks/opacityUtils.js";import"../../mixins/PortalLayer.js";import"../../../chunks/layerUtils.js";import"../../../portal/Portal.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../portal/PortalItem.js";import"../../../portal/PortalItemResource.js";import"../../../portal/PortalRating.js";import"../../../chunks/portalItemUtils.js";import"../../../chunks/WorkerHandle.js";import"../../../core/workers/workers.js";import"../../../core/workers/Connection.js";import"../../../chunks/Queue.js";import"../../../core/workers/RemoteClient.js";import"../../../PopupTemplate.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../Color.js";import"../../../chunks/colorUtils.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import"../../../popup/support/UtilityNetworkAssociationType.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../mixins/ArcGISImageService.js";import"../../../Graphic.js";import"../../../symbols.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils4.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/screenUtils.js";import"../../../chunks/materialUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils5.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../chunks/aaBoundingBox.js";import"../../../symbols/Font.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/SimpleMarkerSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../rasterRenderers.js";import"../../../renderers/ClassBreaksRenderer.js";import"../../../renderers/Renderer.js";import"../../../renderers/support/AuthoringInfo.js";import"../../../renderers/support/AuthoringInfoVisualVariable.js";import"../../../chunks/colorRamps.js";import"../../../rest/support/AlgorithmicColorRamp.js";import"../../../rest/support/ColorRamp.js";import"../../../rest/support/MultipartColorRamp.js";import"../../../renderers/mixins/VisualVariablesMixin.js";import"../../../renderers/visualVariables/ColorVariable.js";import"../../../renderers/visualVariables/VisualVariable.js";import"../../../renderers/visualVariables/support/ColorStop.js";import"../../../renderers/visualVariables/OpacityVariable.js";import"../../../renderers/visualVariables/support/OpacityStop.js";import"../../../renderers/visualVariables/RotationVariable.js";import"../../../renderers/visualVariables/SizeVariable.js";import"../../../renderers/visualVariables/support/SizeStop.js";import"../../../chunks/sizeVariableUtils.js";import"../../../chunks/visualVariableUtils.js";import"../../../chunks/compilerUtils.js";import"../../../renderers/support/ClassBreakInfo.js";import"../../../chunks/commonProperties.js";import"../../../symbols/support/jsonUtils.js";import"../../../chunks/defaults.js";import"../../../chunks/defaultsJSON.js";import"../../../chunks/RendererLegendOptions.js";import"../../../renderers/FlowRenderer.js";import"../../../renderers/RasterColormapRenderer.js";import"../../../renderers/support/ColormapInfo.js";import"../../../chunks/colorRampUtils.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/vec4.js";import"../../../renderers/RasterShadedReliefRenderer.js";import"../../../renderers/RasterStretchRenderer.js";import"../../../chunks/stretchRendererUtils.js";import"../../../renderers/UniqueValueRenderer.js";import"../../../chunks/diffUtils.js";import"../../../renderers/support/UniqueValue.js";import"../../../renderers/support/UniqueValueClass.js";import"../../../renderers/support/UniqueValueGroup.js";import"../../../renderers/support/UniqueValueInfo.js";import"../../../chunks/styleUtils.js";import"../../../renderers/VectorFieldRenderer.js";import"../../../geometry/support/normalizeUtils.js";import"../../../chunks/simplify.js";import"../../../chunks/utils9.js";import"../../../chunks/utils10.js";import"../../../chunks/vectorFieldUtils.js";import"../../support/PixelBlock.js";import"../../../chunks/pixelRangeUtils.js";import"../../../chunks/utils12.js";import"../../../chunks/jsonUtils.js";import"../../../chunks/parser.js";import"../../../chunks/utils2.js";import"../../../symbols/support/cimSymbolUtils.js";import"../../../chunks/utils7.js";import"../../../chunks/enums2.js";import"../../support/DimensionalDefinition.js";import"../../support/MosaicRule.js";import"../../support/FieldsIndex.js";import"../../../chunks/imageBitmapUtils.js";import"../../support/MultidimensionalSubset.js";import"../../support/RasterInfo.js";import"../../support/RasterBandInfo.js";import"../../support/RasterSensorInfo.js";import"../../../chunks/RasterJobHandler.js";import"../../../chunks/multidimensionalUtils.js";import"../../../chunks/RasterSymbolizer.js";import"../../../chunks/_commonjsHelpers.js";import"../../../chunks/stretchUtils.js";import"../../../chunks/rasterRendererHelper.js";import"../../../chunks/generateRendererUtils.js";import"../../../rest/imageService.js";import"../../../rest/support/ImageInspectionInfo.js";import"../../../rest/support/CameraInfoMixin.js";import"../../../rest/support/BaseImageMeasureParameters.js";import"../../../rest/support/BaseImageMeasureResult.js";import"../../../rest/support/CameraInfo.js";import"../../../rest/support/ImageGPSInfo.js";import"../../../rest/support/FeatureSet.js";import"../../../rest/support/ImageSample.js";import"../../../chunks/fetchRasterInfo.js";import"../../../chunks/executeForIds.js";import"../../../chunks/query.js";import"../../../chunks/pbfQueryUtils.js";import"../../../chunks/pbf.js";import"../../../chunks/OptimizedGeometry.js";import"../../../chunks/OptimizedFeature.js";import"../../../chunks/OptimizedFeatureSet.js";import"../../../chunks/queryZScale.js";import"../../../chunks/executeQueryJSON.js";import"../../../chunks/dataUtils.js";import"../../mixins/BlendLayer.js";import"../../mixins/CustomParametersMixin.js";import"../../mixins/RasterPresetRendererMixin.js";import"../../../renderers/support/RasterPresetRenderer.js";import"../../mixins/RefreshableLayer.js";import"../../mixins/ScaleRangeLayer.js";import"../../mixins/TemporalLayer.js";import"../../support/TimeInfo.js";import"../../../time/TimeInterval.js";import"../../../chunks/versionUtils.js";import"../../../support/popupUtils.js";import"../../../chunks/interfaces2.js";import"../../mixins/ImageryTileMixin.js";import"../../../chunks/RawBlockCache.js";import"../../../chunks/rasterProjectionHelper.js";import"../../../chunks/QueueProcessor.js";import"../../../chunks/ReactiveMap.js";import"../../../core/signal.js";import"../../../chunks/rasterFunctionHelper.js";import"../../support/rasterFunctionConstants.js";import"../../../chunks/focalStatUtils.js";import"../../../chunks/xmlUtilities.js";import"../../../chunks/GCSShiftTransform.js";import"../../../chunks/ElevationSamplerData.js";const q=120,B=[21,36,51,60],G=3.5,W=["FAR_WEST","FAR_NORTH","FAR_EAST","FAR_SOUTH","WEST","NORTH","EAST","SOUTH","NEAR_WEST","NEAR_NORTH","NEAR_EAST","NEAR_SOUTH"],Y=23.937554159486076,_=96.06244584051393,Q={EAST:[Y,Y,_,Y,60,Y],NORTH:[Y,_,Y,Y,Y,60],SOUTH:[_,Y,_,_,_,60],WEST:[_,_,Y,_,60,_]},J=-999;function X(t){return"3d"===t?.type}function $(t){return"esri.Graphic"===t?.declaredClass}function K(t){if(!t)return!1;if(!URL.canParse(t))return!1;const{pathname:r}=new URL(t);return/.*\.(tiff|tif|mrf)$/i.test(r??"")}function Z(t){return Math.abs(t)>=135?"WEST":t<-45&&t>-135?"SOUTH":t<=45?"EAST":"NORTH"}function tt(t,r){const s=t/r*B[2];return s<=B[0]?"NEAR":s<=B[1]?"":"FAR"}function rt(t){return"string"==typeof t&&t.length?t:function(t){return t&&t.url&&t.datasetFormat?t:null}(t)}const st=t=>r=>r.layer===t;function et(t){return"NoAttachmentError"===t?.name}const ot=t=>`${t}:missing-property`,it=(t,r)=>`Property ${r} is missing in ${t}`,nt=(t="esri.widgets.OrientedImageryViewer",r)=>{throw c.getLogger(t).error(r),r},at=async(t,r)=>{try{const s=await V(t,{...r,method:"head"});return s?.getHeader?.("Content-Type")}catch(t){return c.getLogger("esri.widgets.OrientedImagery").error("failed to fetch Content-Type",t),null}};function pt(t){return"feature"===t.type}async function mt(t,r,s){if(!r.extent||!r.url)throw nt("esri.layer.orientedImagery.transformations",new m("update-elevation:missing-property","both extent and url are required to create a sampler",r));const e=await ut(r);if(!e)throw nt("esri.layers.orientedImagery.transformations",new m("update-elevation:elevation-source","could not create a sampler using provided elevation source",r));return lt(t,e,s)}async function lt(t,r,s){await U(s);const e=function(t,r){return async s=>{let e=s.clone();const o=s.spatialReference.equals(t.spatialReference)?e:await b(s,t.spatialReference,r),i=t.queryElevation(o);return i&&(e=s.spatialReference.equals(t.spatialReference)?i.clone():await b(i,s.spatialReference,r)),e.z=e.z??1,e}}(r,s),o=Array.isArray(t)?t:[t];return await Promise.all(o.map(e))}var ct;!function(t){t[t.DYNAMIC=0]="DYNAMIC",t[t.ELEVATION=1]="ELEVATION",t[t.IMAGE=2]="IMAGE"}(ct||(ct={}));const ut=async(t,r)=>{let s;const{extent:e,rasterFunction:o,url:i,lod:n}=t;try{s=await async function(t){await U(void 0);const r=await H(t),{tileInfo:s,cacheType:e}=r;if(!r.hasOwnProperty("bandCount")||!r.hasOwnProperty("pixelSizeX"))throw new m("elevation-source:invalid-service-url",`ElevationSource URL expects an elevation 3D image service but given ${t}`);return s?"LERC"!==s?.format?.toUpperCase()||e&&"elevation"!==e.toLowerCase()?ct.IMAGE:ct.ELEVATION:ct.DYNAMIC}(i)}catch(t){if(L(t))return;c.getLogger("esri.layers.orientedImagery.transformations").error("updateElevationUsingElevationSource",t)}switch(s){case ct.DYNAMIC:return await async function(t,r,s,e){const o=s?new O({functionName:s}):void 0,i=new A({url:t,rasterFunction:o,format:"lerc"});await i.load(e);let n,a=512,p=512;const m=r.width/r.height;m>1?(p/=m,n=r.height/p):(a*=m,n=r.width/a);const l=await i.fetchImage(r,a,p,e),c=F.create({scales:[n],size:512,spatialReference:r.spatialReference}),u=new D(null,0,0,0,C(r)),j=new P(l.pixelData.pixelBlock.pixels[0],a,p,0),h=new E(u,j);return new x(h,c,void 0)}(i,e,o,r);case ct.ELEVATION:return await async function(t,r,s,e){const o=new T(t);let i;try{const{tileInfo:t}=await o.load(),n=(s&&t.lodAt(Math.min(t.lods.length-1,s))?.resolution)??"finest-contiguous";i=await o.createElevationSampler(r,{...e,demResolution:n})}catch(t){if(L(t))return;c.getLogger(o).error(t)}finally{o.destroy()}return i}(i,e,n,r);default:return}};async function jt(t,r,s){return await U(s),t.map((t=>(t.z=r,t)))}const ht=new z({x:0,y:0,z:0,spatialReference:N.WebMercator}),ft=1e3,yt=114,dt=120,gt=50;function kt(t,r,s){const[e,o,i,n]=r,[a,p,m,l]=s;bt(e,o,i,n);const c=bt(a,p,m,l),u=It(e,o,i,n),h=It(a,p,m,l),f=g(j(),u),y=k(j(),f,h),[d,b,I,S]=function(t,r){const[s,e,o]=t,i=[0,0,0,0];return i[0]=s*r[0]+e*r[1]+o*r[2]+r[3],i[1]=s*r[4]+e*r[5]+o*r[6]+r[7],i[2]=s*r[8]+e*r[9]+o*r[10]+r[11],i[3]=0===(n=s*r[12]+e*r[13]+o*r[14]+r[15])?1:n,i;var n}(t,y);return[d/S,b/S,c?0:I/S]}function bt(t,r,s,e){return 0===t[2]&&0===r[2]&&0===s[2]&&0===e[2]&&(t[2]=r[2]=s[2]=e[2]=1,!0)}function It(t,r,s,e){const o=function(t,r){const[s,e,o,i]=t,n=new Array(4);return n[0]=s*r[0]+e*r[1]+o*r[2]+i*r[3],n[1]=s*r[4]+e*r[5]+o*r[6]+i*r[7],n[2]=s*r[8]+e*r[9]+o*r[10]+i*r[11],n[3]=s*r[12]+e*r[13]+o*r[14]+i*r[15],n}(f([...e,1]),g(new Array(16),h(t[0],r[0],s[0],0,t[1],r[1],s[1],0,t[2],r[2],s[2],0,1,1,1,1))),i=o[0],n=o[1],a=o[2],p=j();return p[0]=i*t[0],p[1]=n*r[0],p[2]=a*s[0],p[3]=0,p[4]=i*t[1],p[5]=n*r[1],p[6]=a*s[1],p[7]=0,p[8]=i*t[2],p[9]=n*r[2],p[10]=a*s[2],p[11]=0,p[12]=i,p[13]=n,p[14]=a,p[15]=1,p}function St(t,r,e,o,i=s()){return i[0]=t[0]+r[0]*e,i[1]=t[1]+r[1]*e,i[2]=t[2]+r[2]*(e/o),i}function Rt(t,r,e){const o=s();return o[0]=t[0]*r,o[1]=t[1]*r,o[2]=t[2]*(r/e),o}function Mt(t,r){const[e,o,i]=t,n=s();return n[0]=e*r[0]+o*r[3]+i*r[6],n[1]=e*r[1]+o*r[4]+i*r[7],n[2]=e*r[2]+o*r[5]+i*r[8],n}function vt(t,s,e,o=!0){if(!Number.isFinite(t))throw new m("InvalidRotationAngle","Please specify a valid angle for rotation");const i=e*(o?r(t):t),n=Math.cos(i),a=Math.sin(i),p=u();switch(s){case 0:p[4]=n,p[5]=-a,p[7]=a,p[8]=n;break;case 1:p[0]=n,p[2]=a,p[6]=-a,p[8]=n;break;case 2:p[0]=n,p[1]=-a,p[3]=a,p[4]=n;break;default:throw new m("InvalidRotationAxis","Please specify either 0, 1 or 2 for X, Y or Z axis respectively")}return p}const wt=[[2,-1],[0,1],[2,-1]],Lt=[[0,1],[1,1],[2,1]];function Ut(t,r,s=!0){if(3!==t?.length||3!==r?.length)throw new m("InvalidRotationAngles","Please specify three angles with config for rotation");const e=u();for(let o=0;o<3;o++){const[i,n]=r[o],a=vt(t[o],i,n,s);d(e,a,e)}return e}function Ct(t,r=!0){return Ut(t,wt,r)}function Tt(t,s,e){const o=Math.sin(r(e)),i=Math.cos(r(e)),n=[[t,0],[t,s],[0,s]];n.forEach(((t,r)=>{n[r]=[i*t[0]-o*t[1],o*t[0]+i*t[1]]}));const a=Math.min(0,n[0][0],n[1][0],n[2][0]),p=Math.max(0,n[0][0],n[1][0],n[2][0]),m=Math.min(0,n[0][1],n[1][1],n[2][1]),l=Math.max(0,n[0][1],n[1][1],n[2][1]);return{hfov:Math.abs(p-a),vfov:Math.abs(l-m)}}function At(s,e){const o=Number(s[0]),i=Number(s[1]),n=Number(s[2]),[a,p,m,l]=e,c=r(a),u=r(p),j=m/Math.sqrt(1-l*Math.sin(c)**2),h=o/j,f=i/j,y=n/j,d=Math.cos(c)-Math.sin(c)*f+Math.cos(c)*y,g=Math.sin(c)+Math.cos(c)*f+Math.sin(c)*y,k=Math.sqrt(d**2+h**2),b=l*j*Math.sin(c),I=(t,r=5)=>{if(0===r)return t;const s=I(t,r-1);return Math.atan(g/k-(b-l*(m/Math.sqrt(1-l*Math.sin(s)**2))*Math.sin(s))/(j*k))},S=I(c),R=Math.atan(o/(j*d))+u,M=t(S);return[t(R),M,o/(Math.cos(S)*Math.sin(R-u))-m/Math.sqrt(1-l*Math.sin(S)**2)]}function xt(t,r,s){const e=360/r,o=180/s;return{heading:(t.x-r/2)*e,pitch:90-(t.y-s/2)*o}}function Et(r,s,e,o=500){const{heading:i,pitch:n}=function(r,s){const e=t(Math.acos(-r.z/s));return{heading:t(Math.atan2(r.x,r.y)),pitch:e}}(r,o);return Pt(i,n,s,e)}function Pt(t,r,s,e){return{x:s/2+t/(360/s),y:e-r/(180/e),heading:t,pitch:r}}function Ot(t,s,e=500){return[e*(Math.sin(r(t))*Math.sin(r(s))),e*(Math.cos(r(t))*Math.sin(r(s))),e*Math.cos(r(180-s))]}async function Ft(r,s,e){const o=await b(s,r.spatialReference,e);let i=t(Math.atan2(o.y-r.y,o.x-r.x));return i=i>=0&&i<=90?90-i:i>90&&i<=180?360-i+90:90+Math.abs(i),i}function Dt(t,r,s){const e=Math.cos(s),o=Math.sin(s),i=[1,0,0,1,0,0],n=i[0]*e+i[2]*o,a=i[1]*e+i[3]*o,p=-i[0]*o+i[2]*e,m=-i[1]*o+i[3]*e;return i[0]=n,i[1]=a,i[2]=p,i[3]=m,[t*i[0]+r*i[2]+i[4],t*i[1]+r*i[3]+i[5]]}const Vt=t=>t.toArray(),Nt=(...t)=>t.some((t=>t));function zt(t,r){if(Nt(0===t.length,t.some((({x:t,y:r})=>Nt(null==t,null==r))),!r.hasZ))throw new Error("Input pixels must have x, y and camera location must have z value")}function Ht(t,r){if(t.some((t=>null==t.z))||null==r.z)throw new Error("Input points and camera location must have z value")}function qt(t){if(9!==t?.length)throw new Error("Rotation matrix is not provided or is not a valid 3x3 matrix")}function Bt(t,r){return I(r)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*t/S.radius))):1}const Gt=t=>r=>new z(r,t),Wt=t=>null!=t&&"queryExtent"in t;function Yt(t,r,e,o){return[[-r,-r],[+r,-r],[+r,+r],[-r,+r]].map((([r,i])=>kt(R(s(),e,[r,i,0]),o,t)))}function _t(t,r){if(null==t)return null;const s=parseFloat(`${t}`);return isNaN(s)?null:s}function Qt(t,r,s){const{cameraHeight:e,cameraPitch:o,cameraRoll:i,elevation:n,farDistance:a,horizontalFieldOfView:p,location:m,verticalFieldOfView:l}=t,c=n??(m.z??0)-e;return{...Xt(t,r,s),averageElevation:c,cameraPitch:o,cameraRoll:i??0,farDistance:a,horizontalFieldOfView:p,verticalFieldOfView:l}}function Jt(t,r,s){const{cameraHeading:e,cameraHeight:o,elevation:i,farDistance:n,horizontalFieldOfView:a,location:p,verticalFieldOfView:m}=t;return{averageElevation:i??(p.z??0)-o,cameraLocation:p,cameraHeading:e,farDistance:n,horizontalFieldOfView:a,imageHeight:s,imageWidth:r,verticalFieldOfView:m}}function Xt(t,r,s){const{a0:e,a1:o,a2:i,b0:n,b1:a,b2:p,cameraHeading:m,cameraOrientation:l,cameraPitch:c,cameraRoll:u,focalLength:j,horizontalFieldOfView:h,location:f,matrix:y,principalX:d,principalY:g,radial:k,tangential:b,verticalFieldOfView:I}=t,{affines:S,focalLength:R}=function({a0:t,a1:r,a2:s,b0:e,b1:o,b2:i},n,a,p){const m=[t??n/2-.5,r,s??0,e??a/2-.5,o??0,i].map(_t);var l;return null!=p&&null!=(l=m)[1]&&null!=l[5]?{affines:m,focalLength:p}:{affines:[n/2-.5,1,0,a/2-.5,0,-1]}}({a0:e,a1:o,a2:i,b0:n,b1:a,b2:p},r,s,j),M=y??function(t,r,s,e){return er(e)?function(t,r=!0){return Ut(t,Lt,r)}([e.omega,e.phi,e.kappa]):or(e)?Ct([e.heading,e.pitch,e.roll]):Ct([t,r,s??0])}(m,c,u,l),v=null!=d&&null!=g?[d,g]:void 0;return{affineTransformations:l?.affineTransformations??S,cameraLocation:f.clone(),focalLength:l?.focalLength??R,horizontalFieldOfView:h,imageHeight:s,imageWidth:r,principalOffsetPoint:l?.principalOffsetPoint??v,radialDistortionCoefficients:l?.radialDistortionCoefficients??k,rotationMatrix:M,tangentialDistortionCoefficients:l?.tangentialDistortionCoefficients??b,verticalFieldOfView:I}}const $t=t=>null!=t&&"elevationSample"in t&&null!=t.elevationSample,Kt=t=>v(t?.elevationSource)&&null!=t?.extent,Zt=async(t,r)=>null!=r&&($t(r)||(t=>w(t?.elevationSource))(r))?r:Kt(r)?{elevationSample:await ut({...l(r.elevationSource)?r.elevationSource.toJSON():r.elevationSource,extent:r.extent}),elevationSource:new M({constantElevation:t})}:{elevationSource:new M({constantElevation:t})},tr=t=>p(t?.heading)&&p(t?.pitch),rr=(t,r)=>[[-t,-r],[t,-r],[t,r],[-t,r]];function sr(t){const{cameraLocation:e,farDistance:n,horizontalFieldOfView:a,rotationMatrix:p,scalingFactor:m,verticalFieldOfView:l}=t,c=u();y(c,p);const j=2*Math.tan(r(l)/2)*n*m,h=2*Math.tan(r(a)/2)*n*m,f=Mt([0,0,-1],c),d=St([e.x,e.y,e.z],f,t.farDistance*m,m),g=Mt([0,1,0],c),k=Mt([1,0,0],c),b=Rt(g,j/2,m),I=Rt(k,h/2,m),S=o(s(),b,I),R=i(s(),b,I);return[i(s(),d,S),i(s(),d,R),o(s(),d,S),o(s(),d,R)]}const er=t=>2===t?.type,or=t=>1===t?.type;var ir;function nr(t,r){const{cameraLocation:s,pointsToTransform:i,scalingFactor:n}=function(t,r,s){const e=Array.isArray(t)||"items"in t?t:[t];Ht(e,r),mr(e,r),qt(s);const o=Bt(r.y,r.spatialReference);return{pointsToTransform:e.map((t=>t.toArray())),scalingFactor:o,cameraLocation:r.toArray()}}(t,r.cameraLocation,r.rotationMatrix),a=new Array;return function(t,r,s){const{affineTransformations:i,cameraLocation:n,focalLengthX:a,focalLengthY:p,principalOffsetPoint:m,radialDistortionCoefficients:l,rotationMatrix:c,scalingFactor:u,tangentialDistortionCoefficients:j}=s;for(const s of t){const t=e();o(t,s,n),t[0]=t[0]/u,t[1]=t[1]/u;const h=-a*((c[0]*t[0]+c[3]*t[1]+c[6]*t[2])/(c[2]*t[0]+c[5]*t[1]+c[8]*t[2])),f=-p*((c[1]*t[0]+c[4]*t[1]+c[7]*t[2])/(c[2]*t[0]+c[5]*t[1]+c[8]*t[2])),y=h*h+f*f;let d=0,g=0,k=0,b=0,I=0,S=0,R=0;l&&(d=l[0]??0,g=l[1]??0,k=l[2]??0),j&&(b=j[0],I=j[1]),m&&(S=m[0]??0,R=m[1]??0);const M=1+d*y+g*y*y+k*y*y*y;let v=h*M+b*(y+2*h**2)+2*I*h*f,w=f*M+I*(y+2*f**2)+2*b*h*f;v+=S,w+=R;const L=Number(i[0])+Number(i[1])*v+Number(i[2])*w,U=Number(i[3])+Number(i[4])*v+Number(i[5])*w;r.push({x:L,y:U})}}(i,a,{...r,cameraLocation:s,scalingFactor:n,...lr(r)}),Array.isArray(t)?a:a[0]}function ar(t,r,s){return nr(t?r.map((t=>a(t))):r,s).map((t=>({...t,z:1})))}function pr(r,s){const{cameraHeading:e,imageHeight:o,imageWidth:i}=s,{cameraLocation:a,pointsToTransform:p}=function(t,r){const s=Array.isArray(t)||"items"in t?t:[t];return Ht(s,r),mr(s,r),{pointsToTransform:s.map((t=>t.toArray())),cameraLocation:r.toArray()}}(r,s.cameraLocation),m=new Array;for(const r of p){const s=n(a,r),p=(t(Math.atan2(r[0]-a[0],r[1]-a[1]))-e)%360,l=t(Math.acos((a[2]-r[2])/s));m.push(Pt(p,l,i,o))}return Array.isArray(r)?m:m[0]}function mr(t,r){if(t.some((t=>!t.spatialReference.equals(r.spatialReference))))throw new Error("Input points and camera location must have the same spatial reference")}function lr(t){if(function(t){return null!=t?.focalLength}(t))return{focalLengthX:t.focalLength,focalLengthY:t.focalLength};const{imageWidth:s,imageHeight:e,horizontalFieldOfView:o,verticalFieldOfView:i}=t;return{focalLengthX:s/(2*Math.tan(r(o)/2)),focalLengthY:e/(2*Math.tan(r(i)/2))}}!function(t){t[t.CLOCKWISE=-1]="CLOCKWISE",t[t.COUNTERCLOCKWISE=1]="COUNTERCLOCKWISE"}(ir||(ir={}));export{X as $,Q as A,G as B,q as C,B as D,At as E,Ct as F,Mt as G,ft as H,Et as I,nt as J,ot as K,it as L,dt as M,gt as N,yt as O,rt as P,et as Q,at as R,Ft as S,K as T,J as U,st as V,W,Zt as X,Qt as Y,Jt as Z,ut as _,Kt as a,Xt as a0,$ as a1,Z as a2,tt as a3,mt as b,Pt as c,jt as d,Wt as e,St as f,Yt as g,kt as h,$t as i,qt as j,Bt as k,sr as l,Tt as m,Gt as n,Nt as o,Vt as p,ht as q,tr as r,Rt as s,xt as t,lt as u,zt as v,Ot as w,nr as worldToImage,pr as worldToImagePanoramic,ar as worldToImageWithLTPFlag,rr as x,pt as y,Dt as z};
