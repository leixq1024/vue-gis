/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import e from"../request.js";import r from"../core/Error.js";import{L as s}from"../chunks/Logger.js";import{r as o}from"../chunks/mathUtils.js";import{M as i}from"../chunks/MultiOriginJSONSupport.js";import{throwIfAbortError as n}from"../core/promiseUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{a as p,g as l,m as c,i as u,v as h,w as j,j as y}from"../chunks/vec3.js";import{f,c as d}from"../chunks/vec3f64.js";import{W as g}from"../chunks/unitUtils.js";import k from"../geometry/Extent.js";import b from"../geometry/SpatialReference.js";import{p as x}from"../chunks/projectBuffer.js";import v from"./Layer.js";import{APIKeyMixin as A}from"./mixins/APIKeyMixin.js";import{A as U}from"../chunks/ArcGISService.js";import{CustomParametersMixin as E}from"./mixins/CustomParametersMixin.js";import{OperationalLayer as S}from"./mixins/OperationalLayer.js";import{PortalLayer as L}from"./mixins/PortalLayer.js";import{ScaleRangeLayer as T}from"./mixins/ScaleRangeLayer.js";import{e as w,u as I}from"../chunks/commonProperties2.js";import{l as P,e as M,f as _}from"../chunks/elevationInfoUtils.js";import"../config.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../chunks/metadata.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../core/scheduling.js";import"../chunks/ensureType.js";import"../chunks/common.js";import"../chunks/jsonMap.js";import"../chunks/assets.js";import"../geometry/Geometry.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/geodesicConstants.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Evented.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../time/TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/datetime.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/persistableUrlUtils.js";import"../chunks/layerContainerType.js";import"../chunks/asyncUtils.js";import"../chunks/layerUtils.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../geometry/projection.js";import"../chunks/SimpleObservable.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/ElevationInfo.js";import"./support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../chunks/messages.js";import"../chunks/unitConversionUtils.js";import"../chunks/lengthUtils.js";import"../tables/AttributeTableTemplate.js";import"../tables/elements/AttributeTableGroupElement.js";import"../tables/elements/AttributeTableElement.js";import"../tables/support/elements.js";import"../tables/elements/AttributeTableAttachmentElement.js";import"../tables/elements/AttributeTableFieldElement.js";import"../tables/elements/AttributeTableRelationshipElement.js";import"../chunks/opacityUtils.js";let R=class extends(U(S(L(T(i(E(A(v)))))))){constructor(t){super(t),this.operationalLayerType="IntegratedMesh3DTilesLayer",this.spatialReference=new b({wkid:4326,vcsWkid:115700}),this.fullExtent=new k(-180,-90,180,90,this.spatialReference),this.url=null,this.type="integrated-mesh-3dtiles",this.path=null,this.minScale=0,this.maxScale=0}set elevationInfo(t){this._set("elevationInfo",t),this._validateElevationInfo()}_verifyArray(t,e){if(!Array.isArray(t)||t.length<e)return!1;for(const e of t)if("number"!=typeof e)return!1;return!0}_initFullExtent(t){const e=t.root?.boundingVolume;if(!e)return;if(e.box){const t=e?.box;if(t[3]>7972671&&t[7]>7972671&&t[11]>7945940)return}const r=t.root?.transform,s=d();if(e.region&&this._verifyArray(e.region,6)){const t=e.region,r=o(t[0]),s=o(t[1]),i=t[4],n=o(t[2]),a=o(t[3]),m=t[5];this.fullExtent=new k({xmin:r,ymin:s,zmin:i,xmax:n,ymax:a,zmax:m,spatialReference:this.spatialReference})}else if(e.sphere&&this._verifyArray(e.sphere,4)){const t=e.sphere,o=f(t[0],t[1],t[2]),i=t[3]/Math.sqrt(3),n=d();p(n,o,f(i,i,i));const a=d();if(l(a,o,f(i,i,i)),r&&this._verifyArray(r,16)){const t=r;c(s,n,t),u(n,s),c(s,a,t),u(a,s)}x(n,g,0,n,b.WGS84,0),x(a,g,0,a,b.WGS84,0);const m=d(),y=d();h(m,n,a),j(y,n,a),this.fullExtent=new k({xmin:m[0],ymin:m[1],zmin:m[2],xmax:y[0],ymax:y[1],zmax:y[2],spatialReference:this.spatialReference})}else if(e.box&&this._verifyArray(e.box,12)){const t=e.box,s=f(t[0],t[1],t[2]),o=f(t[3],t[4],t[5]),i=f(t[6],t[7],t[8]),n=f(t[9],t[10],t[11]),a=[];for(let t=0;t<8;++t)a.push(d());if(l(a[0],s,o),l(a[0],a[0],i),l(a[0],a[0],n),y(a[1],s,o),l(a[1],a[1],i),l(a[1],a[1],n),l(a[2],s,o),y(a[2],a[2],i),l(a[2],a[2],n),y(a[3],s,o),y(a[3],a[3],i),l(a[3],a[3],n),l(a[4],s,o),l(a[4],a[4],i),y(a[4],a[4],n),y(a[5],s,o),l(a[5],a[5],i),y(a[5],a[5],n),l(a[6],s,o),y(a[6],a[6],i),y(a[6],a[6],n),y(a[7],s,o),y(a[7],a[7],i),y(a[7],a[7],n),r&&this._verifyArray(r,16)){const t=r;for(let e=0;e<8;++e)c(a[e],a[e],t)}const m=f(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),p=f(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let t=0;t<8;++t)x(a[t],g,0,a[t],b.WGS84,0),h(p,p,a[t]),j(m,m,a[t]);this.fullExtent=new k({xmin:p[0],ymin:p[1],zmin:p[2],xmax:m[0],ymax:m[1],zmax:m[2],spatialReference:this.spatialReference})}}async load(t){return this.addResolvingPromise(this._doLoad(t)),this}async _doLoad(t){const s=null!=t?t.signal:null;try{await this.loadFromPortal({supportedTypes:["3DTiles Service"],validateItem:t=>{if(t.typeKeywords?.includes("IntegratedMesh"))return!0;throw new r("portal:invalid-layer-item-type","Invalid layer item, expected '${expectedType}' ",{expectedType:"3DTiles Service containing IntegratedMesh"})}},t)}catch(t){n(t)}if(this.url){const t=e(this.url,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:s}).then((t=>{this._initFullExtent(t.data)}),(t=>{n(t)}));await t}}async fetchAttributionData(){return this.load().then((()=>({})))}_validateElevationInfo(){const t=this.elevationInfo,e="Integrated mesh 3d tiles layers";P(s.getLogger(this),M(e,"absolute-height",t)),P(s.getLogger(this),_(e,t))}};t([a({type:["IntegratedMesh3DTilesLayer"]})],R.prototype,"operationalLayerType",void 0),t([a({type:b})],R.prototype,"spatialReference",void 0),t([a({type:k})],R.prototype,"fullExtent",void 0),t([a(w)],R.prototype,"elevationInfo",null),t([a({type:["show","hide"]})],R.prototype,"listMode",void 0),t([a(I)],R.prototype,"url",void 0),t([a({readOnly:!0})],R.prototype,"type",void 0),t([a({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],R.prototype,"path",void 0),t([a({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:!1,write:!1}}}})],R.prototype,"minScale",void 0),t([a({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:!1,write:!1}}}})],R.prototype,"maxScale",void 0),R=t([m("esri.layers.IntegratedMesh3DTilesLayer")],R);const N=R;export{N as default};
