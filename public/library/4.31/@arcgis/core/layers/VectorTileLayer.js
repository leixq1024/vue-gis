/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import e from"../request.js";import{c as r}from"../chunks/asyncUtils.js";import s from"../core/Error.js";import{x as i,I as o,clone as l}from"../core/lang.js";import{M as n}from"../chunks/MultiOriginJSONSupport.js";import{throwIfAborted as a,isAbortError as p,isAborted as u,onAbort as c,throwIfAbortError as m}from"../core/promiseUtils.js";import{urlToObject as h,objectToQuery as y,addQueryParameters as d,isAbsolute as f,join as g,isProtocolRelative as j,removeTrailingSlash as S,normalize as x,removeFile as w,getAppBaseUrl as b,p as v}from"../core/urlUtils.js";import{property as _}from"../core/accessorSupport/decorators/property.js";import{L as k}from"../chunks/Logger.js";import{r as U}from"../chunks/reader.js";import{subclass as I}from"../core/accessorSupport/decorators/subclass.js";import{w as T}from"../chunks/writer.js";import R from"../geometry/Extent.js";import P from"../geometry/SpatialReference.js";import L from"./Layer.js";import{APIKeyMixin as O}from"./mixins/APIKeyMixin.js";import{ArcGISCachedService as A}from"./mixins/ArcGISCachedService.js";import{A as E}from"../chunks/ArcGISService.js";import{BlendLayer as C}from"./mixins/BlendLayer.js";import{CustomParametersMixin as M}from"./mixins/CustomParametersMixin.js";import{OperationalLayer as D}from"./mixins/OperationalLayer.js";import{PortalLayer as N}from"./mixins/PortalLayer.js";import{RefreshableLayer as q}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as B}from"./mixins/ScaleRangeLayer.js";import F from"./support/TileInfo.js";import{T as z}from"../chunks/TilemapCache.js";import{w as V,a as $}from"../chunks/unitUtils.js";import{geographicToWebMercator as K}from"../geometry/support/webMercatorUtils.js";import{T as G}from"../chunks/TileKey2.js";import{d as W}from"../chunks/maybe.js";import{g as J}from"../chunks/ensureType.js";import{a as Q}from"../chunks/jsonContext.js";import{e as H}from"../chunks/persistableUrlUtils.js";import Y from"../geometry/Point.js";import X from"./support/LOD.js";import{S as Z}from"../chunks/StyleRepository.js";import{g as tt}from"../chunks/capabilities2.js";import"../config.js";import"../kernel.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/metadata.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../core/scheduling.js";import"../geometry/Geometry.js";import"../chunks/jsonMap.js";import"../chunks/assets.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Evented.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../time/TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/datetime.js";import"../chunks/TileInfoTilemapCache.js";import"../chunks/TileKey.js";import"../chunks/ByteSizeUnit.js";import"../chunks/LRUCache.js";import"../chunks/MemCache.js";import"../core/reactiveUtils.js";import"../core/Collection.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/utils2.js";import"../chunks/screenUtils.js";import"../chunks/mat4.js";import"../chunks/common.js";import"../chunks/layerContainerType.js";import"../chunks/commonProperties2.js";import"../chunks/ElevationInfo.js";import"./support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../chunks/messages.js";import"../chunks/unitConversionUtils.js";import"../chunks/lengthUtils.js";import"../tables/AttributeTableTemplate.js";import"../tables/elements/AttributeTableGroupElement.js";import"../tables/elements/AttributeTableElement.js";import"../tables/support/elements.js";import"../tables/elements/AttributeTableAttachmentElement.js";import"../tables/elements/AttributeTableFieldElement.js";import"../tables/elements/AttributeTableRelationshipElement.js";import"../chunks/opacityUtils.js";import"../chunks/layerUtils.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../geometry/projection.js";import"../chunks/vec3f64.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/StyleDefinition.js";import"../chunks/enums2.js";import"../chunks/enums3.js";import"../chunks/GeometryUtils.js";import"../chunks/enums.js";import"../chunks/VertexElementDescriptor.js";import"../Color.js";import"../chunks/colorUtils2.js";import"../chunks/vec4.js";import"../chunks/vec4f64.js";import"../chunks/unitBezier.js";import"../chunks/definitions.js";let et=null;class rt{constructor(t,e){this._spriteSource=t,this._maxTextureSize=e,this.devicePixelRatio=1,this._spriteImageFormat="png",this._isRetina=!1,this._spritesData={},this.image=null,this.width=null,this.height=null,this.loadStatus="not-loaded","url"===t.type&&t.spriteFormat&&(this._spriteImageFormat=t.spriteFormat),t.pixelRatio&&(this.devicePixelRatio=t.pixelRatio),this.baseURL=t.spriteUrl}get spriteNames(){const t=[];for(const e in this._spritesData)t.push(e);return t.sort(),t}getSpriteInfo(t){return this._spritesData?this._spritesData[t]:null}async load(t){if(this.baseURL){this.loadStatus="loading";try{await this._loadSprites(t),this.loadStatus="loaded"}catch{this.loadStatus="failed"}}else this.loadStatus="failed"}async _loadSprites(t){this._isRetina=this.devicePixelRatio>1.15;const{width:e,height:r,data:i,json:o}=await this._getSpriteData(this._spriteSource,t),l=Object.keys(o);if(!l||0===l.length||!i)return this._spritesData=this.image=null,void(this.width=this.height=0);this._spritesData=o,this.width=e,this.height=r;const n=Math.max(this._maxTextureSize,4096);if(e>n||r>n){const t=`Sprite resource for style ${this.baseURL} is bigger than the maximum allowed of ${n} pixels}`;throw k.getLogger("esri.layers.support.SpriteSource").error(t),new s("SpriteSource",t)}let a;for(let t=0;t<i.length;t+=4)a=i[t+3]/255,i[t]=i[t]*a,i[t+1]=i[t+1]*a,i[t+2]=i[t+2]*a;this.image=i}async _getSpriteData(t,r){if("image"===t.type){let e,r;if(this.devicePixelRatio<1.15){if(!t.spriteSource1x)throw new s("SpriteSource","no image data provided for low resolution sprites!");e=t.spriteSource1x.image,r=t.spriteSource1x.json}else{if(!t.spriteSource2x)throw new s("SpriteSource","no image data provided for high resolution sprites!");e=t.spriteSource2x.image,r=t.spriteSource2x.json}return"width"in e&&"height"in e&&"data"in e&&(i(e.data)||o(e.data))?{width:e.width,height:e.height,data:new Uint8Array(e.data),json:r}:{...st(e),json:r}}const l=h(this.baseURL),n=l.query?"?"+y(l.query):"",a=this._isRetina?"@2x":"",p=`${l.path}${a}.${this._spriteImageFormat}${n}`,u=`${l.path}${a}.json${n}`,[c,m]=await Promise.all([e(u,r),e(p,{responseType:"image",...r})]);return{...st(m.data),json:c.data}}}function st(t){const e=document.createElement("canvas"),r=e.getContext("2d");e.width=t.width,e.height=t.height,r.drawImage(t,0,0,t.width,t.height);const s=r.getImageData(0,0,t.width,t.height);return{width:t.width,height:t.height,data:new Uint8Array(s.data)}}class it{constructor(t){this.url=t}destroy(){this._tileIndexPromise=null}async fetchTileIndex(){return this._tileIndexPromise||(this._tileIndexPromise=e(this.url).then((t=>t.data.index))),this._tileIndexPromise}async dataKey(t,e){const r=await this.fetchTileIndex();return a(e),this._getIndexedDataKey(r,t)}_getIndexedDataKey(t,e){const r=[e];if(e.level<0||e.row<0||e.col<0||e.row>>e.level>0||e.col>>e.level>0)return null;let s=e;for(;0!==s.level;)s=new G(s.level-1,s.row>>1,s.col>>1,s.world),r.push(s);let i,o,l=t,n=r.pop();if(1===l)return n;for(;r.length;)if(i=r.pop(),o=(1&i.col)+((1&i.row)<<1),l){if(0===l[o]){n=null;break}if(1===l[o]){n=i;break}n=i,l=l[o]}return n}}class ot{constructor(t,e){this._tilemap=t,this._tileIndexUrl=e}destroy(){this._tilemap=W(this._tilemap),this._tileIndexPromise=null}async fetchTileIndex(t){return this._tileIndexPromise||(this._tileIndexPromise=e(this._tileIndexUrl,{query:{...t?.query}}).then((t=>t.data.index))),this._tileIndexPromise}dataKey(t,e){const{level:r,row:s,col:i}=t,o=new G(t);return this._tilemap.fetchAvailabilityUpsample(r,s,i,o,e).then((()=>(o.world=t.world,o))).catch((t=>{if(p(t))throw t;return null}))}}class lt{constructor(t){this._tileUrl=t,this._promise=null,this._abortController=null,this._abortOptions=[]}getData(t){(null==this._promise||u(this._abortController?.signal))&&(this._promise=this._makeRequest(this._tileUrl));const e=this._abortOptions;return e.push(t),c(t,(()=>{e.every((t=>u(t)))&&this._abortController.abort()})),this._promise.then((t=>l(t)))}async _makeRequest(t){this._abortController=new AbortController;const{data:r}=await e(t,{responseType:"array-buffer",signal:this._abortController.signal});return r}}const nt=new Map;class at{constructor(t,e,r){this.tilemap=null,this.tileInfo=null,this.capabilities=null,this.fullExtent=null,this.initialExtent=null,this.name=t,this.sourceUrl=e;const s=h(this.sourceUrl),i=l(r),o=i.tiles;if(s)for(let t=0;t<o.length;t++){const e=h(o[t]);e&&(f(e.path)||(e.path=g(s.path,e.path)),o[t]=d(e.path,{...s.query,...e.query}))}this.tileServers=o;const n=r.capabilities&&r.capabilities.split(",").map((t=>t.toLowerCase().trim())),a=!0===r?.exportTilesAllowed,p=!0===n?.includes("tilemap"),u=a&&r.hasOwnProperty("maxExportTilesCount")?r.maxExportTilesCount:0;this.capabilities={operations:{supportsExportTiles:a,supportsTileMap:p},exportTiles:a?{maxExportTilesCount:+u}:null},this.tileInfo=F.fromJSON(i.tileInfo);const c=r.tileMap?d(g(s.path,r.tileMap),s.query??{}):null;p?(this.type="vector-tile",this.tilemap=new ot(new z({layer:{parsedUrl:s,tileInfo:this.tileInfo},minLOD:i.minLOD??this.tileInfo.lods[0].level,maxLOD:i.maxLOD??this.tileInfo.lods[this.tileInfo.lods.length-1].level}),c)):c&&(this.tilemap=new it(c)),this.fullExtent=R.fromJSON(r.fullExtent),this.initialExtent=R.fromJSON(r.initialExtent)}destroy(){this.tilemap?.destroy()}async getRefKey(t,e){return this.tilemap?this.tilemap.dataKey(t,e):t}requestTile(t,e,r,s){return function(t,e,r,s,i){const o=h(t),l=o.query;if(l)for(const[t,i]of Object.entries(l))switch(i){case"{x}":l[t]=s.toString();break;case"{y}":l[t]=r.toString();break;case"{z}":l[t]=e.toString()}const n=o.path;return function(t,e){return J(nt,t,(()=>new lt(t))).getData(e).finally((()=>nt.delete(t)))}(d(n.replaceAll(/\{z\}/gi,e.toString()).replaceAll(/\{y\}/gi,r.toString()).replaceAll(/\{x\}/gi,s.toString()),{...o.query}),i)}(this.tileServers[e%this.tileServers.length],t,e,r,s)}isCompatibleWith(t){const e=this.tileInfo,r=t.tileInfo;if(!e.spatialReference.equals(r.spatialReference))return!1;if(!e.origin.equals(r.origin))return!1;if(Math.round(e.dpi)!==Math.round(r.dpi))return!1;const s=e.lods,i=r.lods,o=Math.min(s.length,i.length);for(let t=0;t<o;t++){const e=s[t],r=i[t];if(e.level!==r.level||Math.round(e.scale)!==Math.round(r.scale))return!1}return!0}}function pt(...t){let e;for(const r of t)if(null!=r)if(j(r)){if(e){const t=e.split("://")[0];e=t+":"+r.trim()}}else e=f(r)?r:g(e,r);return e?S(e):void 0}async function ut(t,r,s,i,o){let l,n,p;if(a(o),"string"==typeof s){const t=x(s);p=await e(t,{...o,responseType:"json",query:{f:"json",...o?.query}}),p.ssl&&(l&&(l=l.replace(/^http:/i,"https:")),n&&(n=n.replace(/^http:/i,"https:"))),l=t,n=t}else null!=s&&(p={data:s},l=s.jsonUrl||null,n=i);const u=p?.data;if(mt(u))return t.styleUrl=l||null,async function(t,e,r,s){const i=r?w(r):b();t.styleBase=i,t.style=e,e["sprite-format"]&&"webp"===e["sprite-format"].toLowerCase()&&(t.spriteFormat="webp");const o=[];if(e.sources&&e.sources.esri){const r=e.sources.esri;r.url?await ut(t,"esri",pt(i,r.url),void 0,s):o.push(ut(t,"esri",r,i,s))}for(const r of Object.keys(e.sources))"esri"!==r&&"vector"===e.sources[r].type&&(e.sources[r].url?o.push(ut(t,r,pt(i,e.sources[r].url),void 0,s)):e.sources[r].tiles&&o.push(ut(t,r,e.sources[r],i,s)));await Promise.all(o)}(t,u,n,o);if(!mt(u))return t.sourceUrl?ht(t,u,n,!1,r,o):(t.sourceUrl=l||null,ht(t,u,n,!0,r,o));throw new Error("You must specify the URL or the JSON for a service or for a style.")}function ct(t){return"object"==typeof t&&!!t&&"tilejson"in t&&null!=t.tilejson}function mt(t){return!!t&&"sources"in t&&!!t.sources}async function ht(t,e,r,s,i,o){const n=r?S(r)+"/":b(),a=function(t){const e=512;if(function(t){return t.hasOwnProperty("tileInfo")}(t)){const r=t?.tileInfo;return null!=r&&(null==r.rows&&(r.rows=e),null==r.cols&&(r.cols=e)),t}const r={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100,latestWkid:3857}};let s=null;if(ct(t)){const{bounds:e}=t;if(e){const t=K({x:e[0],y:e[1],spatialReference:l(V)}),r=K({x:e[2],y:e[3],spatialReference:l(V)});s={xmin:t.x,ymin:t.y,xmax:r.x,ymax:r.y,spatialReference:l($)}}}null===s&&(s=r);let i=78271.51696400007,o=295828763.7957775;const n=[],a=t.hasOwnProperty("maxzoom")&&null!=t.maxzoom?+t.maxzoom:22;for(let t=0;t<=a;t++)n.push({level:t,scale:o,resolution:i}),i/=2,o/=2;return{capabilities:"TilesOnly",initialExtent:s,fullExtent:r,minScale:0,maxScale:0,tiles:t.tiles,tileInfo:{rows:e,cols:e,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:n,spatialReference:l($)}}}(e),p=new at(i,d(n,o?.query??{}),a);if(!s&&t.primarySourceName in t.sourceNameToSource){const e=t.sourceNameToSource[t.primarySourceName];if(!e.isCompatibleWith(p))return;null!=p.fullExtent&&(null!=e.fullExtent?e.fullExtent.union(p.fullExtent):e.fullExtent=p.fullExtent.clone()),e.tileInfo&&p.tileInfo&&e.tileInfo.lods.length<p.tileInfo.lods.length&&(e.tileInfo=p.tileInfo)}if(s&&(t.sourceBase=n,t.source=e,t.validatedSource=a,t.primarySourceName=i),t.sourceNameToSource[i]=p,!ct(t)&&"defaultStyles"in e&&!t.style){if(null==e.defaultStyles)throw new Error;return"string"==typeof e.defaultStyles?ut(t,"",pt(n,e.defaultStyles,"root.json"),void 0,o):ut(t,"",e.defaultStyles,pt(n,"root.json"),o)}}const yt=1e-6;function dt(t,e){if(t===e)return!0;if(null==t&&null!=e)return!1;if(null!=t&&null==e)return!1;if(null==t||null==e)return!1;if(!t.spatialReference.equals(e.spatialReference)||t.dpi!==e.dpi)return!1;const r=t.origin,s=e.origin;if(Math.abs(r.x-s.x)>=yt||Math.abs(r.y-s.y)>=yt)return!1;let i,o;t.lods[0].scale>e.lods[0].scale?(i=t,o=e):(o=t,i=e);for(let t=i.lods[0].scale;t>=o.lods[o.lods.length-1].scale-yt;t/=2)if(Math.abs(t-o.lods[0].scale)<yt)return!0;return!1}function ft(t,e){if(t===e)return t;if(null==t&&null!=e)return e;if(null!=t&&null==e)return t;if(null==t||null==e)return null;const r=t.size[0],s=t.format,i=t.dpi,o=new Y({x:t.origin.x,y:t.origin.y}),l=t.spatialReference,n=t.lods[0].scale>e.lods[0].scale?t.lods[0]:e.lods[0],a=t.lods[t.lods.length-1].scale<=e.lods[e.lods.length-1].scale?t.lods[t.lods.length-1]:e.lods[e.lods.length-1],p=n.scale,u=n.resolution,c=a.scale,m=[];let h=p,y=u,d=0;for(;h>c;)m.push(new X({level:d,resolution:y,scale:h})),d++,h/=2,y/=2;return new F({size:[r,r],dpi:i,format:s||"pbf",origin:o,lods:m,spatialReference:l})}let gt=class extends(C(B(q(A(E(D(N(M(O(n(L))))))))))){constructor(...t){super(...t),this._spriteSourceMap=new Map,this.currentStyleInfo=null,this.isReference=null,this.operationalLayerType="VectorTileLayer",this.path=null,this.refreshInterval=0,this.style=null,this.tilemapCache=null,this.type="vector-tile",this.url=null}normalizeCtorArgs(t,e){return"string"==typeof t?{url:t,...e}:t}destroy(){if(this.sourceNameToSource)for(const t of Object.values(this.sourceNameToSource))t?.destroy();this.primarySource?.destroy(),this._spriteSourceMap.clear()}async prefetchResources(t){await this.loadSpriteSource(globalThis.devicePixelRatio||1,t)}load(t){const r=this.loadFromPortal({supportedTypes:["Vector Tile Service"],supportsData:!1},t).catch(m).then((async()=>{if(!this.portalItem?.id)return;const r=`${this.portalItem.itemCdnUrl}/resources/styles/root.json`;(await e(r,{...t,query:{f:"json",...this.customParameters,token:this.apiKey}})).data&&this.read({url:r},Q(this.portalItem,"portal-item"))})).catch(m).then((()=>this._loadStyle(t)));return this.addResolvingPromise(r),Promise.resolve(this)}get attributionDataUrl(){const t=this.currentStyleInfo,e=t?.serviceUrl&&h(t.serviceUrl);if(!e)return null;const r=this._getDefaultAttribution(e.path);return r?d(r,{...this.customParameters,token:this.apiKey}):null}get capabilities(){const t=this.primarySource;return t?t.capabilities:{operations:{supportsExportTiles:!1,supportsTileMap:!1},exportTiles:null}}get fullExtent(){return this.primarySource?.fullExtent||null}get initialExtent(){return this.primarySource?.initialExtent||null}get parsedUrl(){return this.serviceUrl?h(this.serviceUrl):null}get serviceUrl(){return this.currentStyleInfo?.serviceUrl||null}get spatialReference(){return this.tileInfo?.spatialReference??null}get styleUrl(){return this.currentStyleInfo?.styleUrl||null}writeStyleUrl(t,e){t&&j(t)&&(t=`https:${t}`);const r=v(t);e.styleUrl=H(t,r)}get tileInfo(){const t=[];for(const e in this.sourceNameToSource)t.push(this.sourceNameToSource[e]);let e=this.primarySource?.tileInfo||new F;if(t.length>1)for(let r=0;r<t.length;r++)dt(e,t[r].tileInfo)&&(e=ft(e,t[r].tileInfo));return e}readTilemapCache(t,e){const r=e.capabilities?.includes("Tilemap");return r?new z({layer:this}):null}readVersion(t,e){return e.version?parseFloat(e.version):parseFloat(e.currentVersion)}async loadSpriteSource(t=1,e){if(!this._spriteSourceMap.has(t)){const r=tt().maxTextureSize,s=this.currentStyleInfo?.spriteUrl?d(this.currentStyleInfo.spriteUrl,{...this.customParameters,token:this.apiKey}):null,i=new rt({type:"url",spriteUrl:s,pixelRatio:t,spriteFormat:this.currentStyleInfo?.spriteFormat},r);await i.load(e),this._spriteSourceMap.set(t,i)}return this._spriteSourceMap.get(t)}async setSpriteSource(t,e){if(!t)return null;const r=tt().maxTextureSize,s=t.spriteUrl,i=s?d(s,{...this.customParameters,token:this.apiKey}):null;if(!i&&"url"===t.type)return null;const o=new rt(t,r);try{await o.load(e);const r=t.pixelRatio||1;return this._spriteSourceMap.clear(),this._spriteSourceMap.set(r,o),i&&this.currentStyleInfo&&(this.currentStyleInfo.spriteUrl=i),this.emit("spriteSource-change",{spriteSource:o}),o}catch(t){m(t)}return null}async loadStyle(t,e){const s=t||this.style||this.url;return this._loadingTask&&"string"==typeof s&&this.url===s||(this._loadingTask?.abort(),this._loadingTask=r((t=>(this._spriteSourceMap.clear(),this._getSourceAndStyle(s,{signal:t}))),e)),this._loadingTask.promise}getStyleLayerId(t){return this.styleRepository.getStyleLayerId(t)}getStyleLayerIndex(t){return this.styleRepository.getStyleLayerIndex(t)}getPaintProperties(t){return l(this.styleRepository?.getPaintProperties(t))}setPaintProperties(t,e){const r=this.styleRepository.isPainterDataDriven(t);this.styleRepository.setPaintProperties(t,e);const s=this.styleRepository.isPainterDataDriven(t);this.emit("paint-change",{layer:t,paint:e,isDataDriven:r||s})}getStyleLayer(t){return l(this.styleRepository.getStyleLayer(t))}setStyleLayer(t,e){this.styleRepository.setStyleLayer(t,e),this.emit("style-layer-change",{layer:t,index:e})}deleteStyleLayer(t){this.styleRepository.deleteStyleLayer(t),this.emit("delete-style-layer",{layer:t})}getLayoutProperties(t){return l(this.styleRepository.getLayoutProperties(t))}setLayoutProperties(t,e){this.styleRepository.setLayoutProperties(t,e),this.emit("layout-change",{layer:t,layout:e})}setStyleLayerVisibility(t,e){this.styleRepository.setStyleLayerVisibility(t,e),this.emit("style-layer-visibility-change",{layer:t,visibility:e})}getStyleLayerVisibility(t){return this.styleRepository.getStyleLayerVisibility(t)}write(t,e){return e?.origin&&!this.styleUrl?(e.messages&&e.messages.push(new s("vectortilelayer:unsupported",`VectorTileLayer (${this.title}, ${this.id}) with style defined by JSON only are not supported`,{layer:this})),null):super.write(t,e)}getTileUrl(t,e,r){return null}async _getSourceAndStyle(t,e){if(!t)throw new Error("invalid style!");const r=await async function(t,e){const r={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[s,i]="string"==typeof t?[t,null]:[null,t.jsonUrl];return await ut(r,"esri",t,i,e),{layerDefinition:r.validatedSource,url:s,serviceUrl:r.sourceUrl,style:r.style,styleUrl:r.styleUrl,spriteUrl:r.style.sprite&&pt(r.styleBase,r.style.sprite),spriteFormat:r.spriteFormat,glyphsUrl:r.style.glyphs&&pt(r.styleBase,r.style.glyphs),sourceNameToSource:r.sourceNameToSource,primarySourceName:r.primarySourceName}}(t,{...e,query:{...this.customParameters,token:this.apiKey}});"webp"===r.spriteFormat&&(await function(){if(et)return et;const t="UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA";return et=new Promise((e=>{const r=new Image;r.onload=()=>{r.onload=r.onerror=null,e(r.width>0&&r.height>0)},r.onerror=()=>{r.onload=r.onerror=null,e(!1)},r.src="data:image/webp;base64,"+t})),et}()||(r.spriteFormat="png")),this._set("currentStyleInfo",{...r}),"string"==typeof t?(this.url=t,this.style=null):(this.url=null,this.style=t),this._set("sourceNameToSource",r.sourceNameToSource),this._set("primarySource",r.sourceNameToSource[r.primarySourceName]),this._set("styleRepository",new Z(r.style)),this.read(r.layerDefinition,{origin:"service"}),this.emit("load-style")}_getDefaultAttribution(t){const e=t.match(/^https?:\/\/(?:basemaps|basemapsbeta|basemapsdev)(?:-api)?\.arcgis\.com(\/[^/]+)?\/arcgis\/rest\/services\/([^/]+(\/[^/]+)*)\/vectortileserver/i),r=["OpenBasemap_v2","OpenBasemap_GCS_v2","OpenStreetMap_v2","OpenStreetMap_Daylight_v2","OpenStreetMap_Export_v2","OpenStreetMap_FTS_v2","OpenStreetMap_GCS_v2","World_Basemap","World_Basemap_v2","World_Basemap_Export_v2","World_Basemap_GCS_v2","World_Basemap_WGS84","World_Contours_v2","World_Hillshade_v2"];if(!e)return;const s=e[2]&&e[2].toLowerCase();if(!s)return;const i=e[1]||"";for(const t of r)if(t.toLowerCase().includes(s))return x(`//static.arcgis.com/attribution/Vector${i}/${t}`)}async _loadStyle(t){return this._loadingTask?.promise??this.loadStyle(null,t)}};t([_({readOnly:!0})],gt.prototype,"attributionDataUrl",null),t([_({type:["show","hide"]})],gt.prototype,"listMode",void 0),t([_({json:{read:!0,write:!0}})],gt.prototype,"blendMode",void 0),t([_({readOnly:!0,json:{read:!1}})],gt.prototype,"capabilities",null),t([_({readOnly:!0})],gt.prototype,"currentStyleInfo",void 0),t([_({json:{read:!1},readOnly:!0,type:R})],gt.prototype,"fullExtent",null),t([_({json:{read:!1},readOnly:!0,type:R})],gt.prototype,"initialExtent",null),t([_({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],gt.prototype,"isReference",void 0),t([_({type:["VectorTileLayer"]})],gt.prototype,"operationalLayerType",void 0),t([_({readOnly:!0})],gt.prototype,"parsedUrl",null),t([_({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],gt.prototype,"path",void 0),t([_({type:Number,json:{write:!1,origins:{"web-map":{write:!1},"web-scene":{write:!1},"portal-item":{write:!1}}}})],gt.prototype,"refreshInterval",void 0),t([_()],gt.prototype,"style",void 0),t([_({readOnly:!0})],gt.prototype,"serviceUrl",null),t([_({type:P,readOnly:!0})],gt.prototype,"spatialReference",null),t([_({readOnly:!0})],gt.prototype,"styleRepository",void 0),t([_({readOnly:!0})],gt.prototype,"sourceNameToSource",void 0),t([_({readOnly:!0})],gt.prototype,"primarySource",void 0),t([_({type:String,readOnly:!0,json:{write:{ignoreOrigin:!0},origins:{"web-document":{write:{ignoreOrigin:!0,isRequired:!0}}}}})],gt.prototype,"styleUrl",null),t([T(["portal-item","web-document"],"styleUrl")],gt.prototype,"writeStyleUrl",null),t([_({json:{read:!1,origins:{service:{read:!1}}},readOnly:!0,type:F})],gt.prototype,"tileInfo",null),t([_()],gt.prototype,"tilemapCache",void 0),t([U("service","tilemapCache",["capabilities","tileInfo"])],gt.prototype,"readTilemapCache",null),t([_({json:{read:!1},readOnly:!0,value:"vector-tile"})],gt.prototype,"type",void 0),t([_({json:{origins:{"web-document":{read:{source:"styleUrl"}},"portal-item":{read:{source:"url"}}},write:!1,read:!1}})],gt.prototype,"url",void 0),t([_({readOnly:!0})],gt.prototype,"version",void 0),t([U("version",["version","currentVersion"])],gt.prototype,"readVersion",null),gt=t([I("esri.layers.VectorTileLayer")],gt);const jt=gt;export{jt as default};
