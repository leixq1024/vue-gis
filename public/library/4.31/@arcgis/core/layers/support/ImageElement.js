/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../request.js";import o from"../../core/Error.js";import{g as s}from"../../chunks/imageUtils.js";import{isAbsolute as r,isDataProtocol as i,isBlobProtocol as n,dataToBlob as m,join as p}from"../../core/urlUtils.js";import{g as c}from"../../chunks/uuid.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/Logger.js";import{r as l}from"../../chunks/reader.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import{w as h}from"../../chunks/writer.js";import j,{m as g,a as d}from"./MediaElementBase.js";import{g as f}from"../../chunks/resourceExtension.js";import{f as y,a as k,i as v,M as b}from"../../chunks/persistableUrlUtils.js";import"../../config.js";import"../../kernel.js";import"../../core/promiseUtils.js";import"../../chunks/handleUtils.js";import"../../chunks/maybe.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/ensureType.js";import"../../core/Identifiable.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../chunks/MultiOriginJSONSupport.js";import"./ControlPointsGeoreference.js";import"../../core/Clonable.js";import"../../chunks/perspectiveUtils.js";import"../../chunks/mat3.js";import"../../chunks/mat3f64.js";import"../../chunks/vec2.js";import"../../chunks/common.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/screenUtils.js";import"../../chunks/vec2f64.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/assets.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Polygon.js";import"../../geometry/Extent.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/zmUtils.js";import"../../geometry/projection.js";import"../../chunks/SimpleObservable.js";import"../../geometry/Multipoint.js";import"../../geometry/Polyline.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/GeoreferenceBase.js";import"../../geometry.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"./CornersGeoreference.js";import"./ExtentAndRotationGeoreference.js";let U=class extends j{constructor(t){super(t),this.animationOptions=null,this.content=null,this.image=null,this.type="image",this.image=null}load(){const t=this.image;if("string"==typeof t){const e=s(t).then((t=>{this._set("content",t)}));this.addResolvingPromise(e)}else if(t instanceof HTMLImageElement){const e=t.decode().then((()=>{this._set("content",t)}));this.addResolvingPromise(e)}else t?this._set("content",t):this.addResolvingPromise(Promise.reject(new o("image-element:invalid-image-type","Invalid image type",{image:t})));return Promise.resolve(this)}get contentWidth(){return null==this.content?0:this.content instanceof HTMLImageElement?this.content.naturalWidth:this.content.width}get contentHeight(){return null==this.content?0:this.content instanceof HTMLImageElement?this.content.naturalHeight:this.content.height}readImage(t,e,o){return y(e.url,o)}writeImage(t,o,s,a){if(null==t)return;const l=a?.portalItem,u=a?.resources;if(!l||!u)return void("string"==typeof t&&(o[s]=k(t,a)));const h=function(t){return"string"==typeof t&&!i(t)&&!n(t)}(t)?t:null;if(h){if(null==v(h))return void(o[s]=h);const t=k(h,{...a,verifyItemRelativeUrls:a?.verifyItemRelativeUrls?{writtenUrls:a.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},b.NO);if(l&&t&&!r(t))return u.toKeep.push({resource:l.resourceFromPath(t),compress:!1}),void(o[s]=t)}o[s]="<pending>",u.pendingOperations.push(async function(t){return"string"==typeof t?i(t)?m(t):(await e(t,{responseType:"blob"})).data:new Promise((e=>function(t){if(t instanceof HTMLCanvasElement)return t;const e=t instanceof HTMLImageElement?t.naturalWidth:t.width,o=t instanceof HTMLImageElement?t.naturalHeight:t.height,s=document.createElement("canvas"),r=s.getContext("2d");return s.width=e,s.height=o,t instanceof HTMLImageElement?r.drawImage(t,0,0,t.width,t.height):t instanceof ImageData&&r.putImageData(t,0,0),s}(t).toBlob(e)))}(t).then((t=>{const e=function(t,e){const o=c(),s=`${p("media",o)}.${f({type:"blob",blob:t})}`;return e.resourceFromPath(s)}(t,l);o[s]=e.itemRelativeUrl,u.toAdd.push({resource:e,content:{type:"blob",blob:t},compress:!1,finish:t=>{this.image=t.url}})})))}};t([a()],U.prototype,"animationOptions",void 0),t([a({readOnly:!0})],U.prototype,"content",void 0),t([a({readOnly:!0})],U.prototype,"contentWidth",null),t([a({readOnly:!0})],U.prototype,"contentHeight",null),t([a(g)],U.prototype,"image",void 0),t([l("image",["url"])],U.prototype,"readImage",null),t([h("image")],U.prototype,"writeImage",null),t([a(d)],U.prototype,"type",void 0),U=t([u("esri.layers.support.ImageElement")],U);const I=U;export{I as default};
