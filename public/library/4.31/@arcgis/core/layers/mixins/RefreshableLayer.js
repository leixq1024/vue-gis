/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../core/lang.js";import{L as r}from"../../chunks/Logger.js";import{debounce as t,ignoreAbortErrors as s}from"../../core/promiseUtils.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import{cast as n}from"../../core/accessorSupport/decorators/cast.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import{e as i}from"../../chunks/layerContainerType.js";import c from"../../core/Collection.js";import{sync as h}from"../../core/reactiveUtils.js";import{a as m}from"../../core/Accessor.js";import"../../config.js";import"../../chunks/handleUtils.js";import"../../core/Error.js";import"../../chunks/maybe.js";import"../../chunks/ensureType.js";import"../../chunks/utils.js";import"../../chunks/metadata.js";import"../../chunks/tracking.js";import"../../core/Evented.js";import"../../core/Handles.js";import"../../chunks/ObservableBase.js";import"../../core/scheduling.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/asyncUtils.js";const p=new c,f=new WeakMap;function l(e,r){return Number.isFinite(e)&&Number.isFinite(r)?r<=0?e:l(r,e%r):0}let u=0,d=0;function j(){const e=Date.now();let r=!1;for(const t of p){const s=t.deref();s?s.refreshInterval&&e-(f.get(s)??0)+5>=6e4*s.refreshInterval&&(f.set(s,e),s.refresh(e)):r=!0}if(r)for(let e=p.length-1;e>=0;e--)p.at(e).deref()||p.removeAt(e)}function v(e){return null!=e&&"object"==typeof e&&"refreshTimestamp"in e&&"refresh"in e}m((()=>{const e=Date.now();let r=0;for(const t of p){const s=t.deref();s&&(r=l(Math.round(6e4*s.refreshInterval),r),s.refreshInterval?f.get(s)||f.set(s,e):f.delete(s))}if(r!==d){if(d=r,clearInterval(u),0===d)return void(u=0);u=setInterval(j,d)}}),h);const y=c=>{let h=class extends c{constructor(...e){super(...e),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=t((()=>this.hasDataChanged())),this.when().then((()=>{var e;this.destroyed||null!=(e=this)&&"object"==typeof e&&"refreshInterval"in e&&"refresh"in e&&p.push(new WeakRef(this))}),(()=>{}))}destroy(){!function(e){const r=p.find((r=>r.deref()===e));r&&p.remove(r)}(this)}castRefreshInterval(e){return e>=.1?e:e<=0?0:.1}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(e=Date.now()){s(this._debounceHasDataChanged()).then((r=>{r&&this._set("refreshTimestamp",e),this.emit("refresh",{dataChanged:r})}),(e=>{r.getLogger(this).error(e),this.emit("refresh",{dataChanged:!1,error:e})}))}async hasDataChanged(){return!0}get test(){}};return e([o({type:Number,json:{write:!0,origins:{"web-scene":{write:{enabled:!0,layerContainerTypes:i}}}}})],h.prototype,"refreshInterval",void 0),e([n("refreshInterval")],h.prototype,"castRefreshInterval",null),e([o({readOnly:!0})],h.prototype,"refreshTimestamp",void 0),e([o({readOnly:!0})],h.prototype,"refreshParameters",null),h=e([a("esri.layers.mixins.RefreshableLayer")],h),h};export{y as RefreshableLayer,v as isRefreshableLayer};
