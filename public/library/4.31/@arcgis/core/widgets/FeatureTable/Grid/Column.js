/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Evented.js";import{watch as n,when as i,initial as o}from"../../../core/reactiveUtils.js";import{property as s}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/lang.js";import"../../../chunks/Logger.js";import{subclass as r}from"../../../core/accessorSupport/decorators/subclass.js";import{a as l}from"../../../chunks/columnUtils.js";import{l as a}from"../../../chunks/componentsUtils.js";import{a as c}from"../../../chunks/uriUtils.js";import{r as d,b as u}from"../../../chunks/widgetUtils.js";import"../../../core/Accessor.js";import"../../../core/Handles.js";import"../../../chunks/maybe.js";import"../../../chunks/metadata.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/ObservableBase.js";import"../../../chunks/tracking.js";import"../../../core/scheduling.js";import"../../../core/promiseUtils.js";import"../../../core/Error.js";import"../../../config.js";import"../../../chunks/ensureType.js";import"../../../chunks/asyncUtils.js";import"../../../core/Collection.js";import"../../../chunks/shared.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../core/JSONSupport.js";const p="esri-column",m={contentFull:`${p}__content--full`,sorter:`${p}__sorter`,headerContent:`${p}__header-content`,headerDescription:`${p}__header-description`,headerLabel:`${p}__header-label`,headerMenuIcon:`${p}__header-menu-icon`},h={action:"EsriFeatureTableActionColumn",attachments:"EsriFeatureTableAttachmentsColumn",relationship:"EsriFeatureTableRelationshipColumn"},f=()=>Promise.all([a({"action-bar":()=>import("../../../chunks/calcite-action-bar.js")}),Promise.all([a({input:()=>import("../../../chunks/calcite-input.js"),option:()=>import("../../../chunks/calcite-option.js"),select:()=>import("../../../chunks/calcite-select.js"),"input-date-picker":()=>import("../../../chunks/calcite-input-date-picker.js"),"input-time-picker":()=>import("../../../chunks/calcite-input-time-picker.js")}),a({action:()=>import("../../../chunks/calcite-action.js"),button:()=>import("../../../chunks/calcite-button.js"),dropdown:()=>import("../../../chunks/calcite-dropdown.js"),"dropdown-item":()=>import("../../../chunks/calcite-dropdown-item.js"),"dropdown-group":()=>import("../../../chunks/calcite-dropdown-group.js"),icon:()=>import("../../../chunks/calcite-icon.js")})])]);function b(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"id"in e&&"load"in e&&"objectIdField"in e&&"type"in e&&"when"in e}function y(e){return b(e)&&"queryAttachments"in e}function g(e){return y(e)&&"addAttachment"in e&&"deleteAttachments"in e&&"updateAttachment"in e}function v(e){return b(e)&&"editingEnabled"in e&&"applyEdits"in e}function C(e){return b(e)&&"relationships"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e}function E(e){return null!=e&&"object"==typeof e&&"type"in e&&"map-image"===e.type}function k(e,t,{relatedTableId:n}){if(!t?.map)return;const i="scene"===e.type&&e.associatedLayer?e.associatedLayer.url:e.url,o=t=>!(!C(t)||t===e)&&("sublayer"===t.type&&t.layer?.url===e.url?t.id===n:i===t.url&&t.layerId===n);if("sublayer"===e.type&&E(e.parent)){const t=t=>C(t)&&t!==e&&t.id===n,i=e.parent,o=i.sublayers?.find(t)||i.subtables?.find(t);if(C(o))return o}const s=[...t.map.allLayers,...t.map.allTables];let r=null;for(const e of s)if(E(e)){const t=e.sublayers?.find(o)||e.subtables?.find(o);if(t){r=t;break}}else if(o(e)){r=e;break}return C(r)?r:void 0}function j(e,t){return null!=e&&Number.isInteger(e)&&e>-1&&e<t}function I(e){return null==e||0===e.trim().length}function x(e,t){return(e.relationships??[]).filter((e=>!(e.id===t&&"one-to-one"===e.cardinality))).map((({id:e})=>({relationshipId:e})))}function w(e,t){return e.relationships?.find((({id:e})=>e===t))}function _(e,t){return null==t?null:e?.fields?.find((e=>t.toLowerCase()===e.name?.toLowerCase()))}function F(e,t){return t?.some((t=>!(!l(t)||!F(e,t.columns))||t.fieldName===e))??!1}let L=class extends t.EventedAccessor{constructor(e){super(e),this._menuIsOpen=!1,this.autoWidth=!1,this.cellValueFormatFunction=({root:e,rowData:t,value:n})=>{const{formatFunction:i}=this,o=d.sanitize(n);if(i&&t){const{index:n,item:{attachments:s,feature:r,relatedRecords:l}}=t;return i({attachments:s,column:this,feature:r,index:n,relatedRecords:l,value:o,virtualIndex:this.getVirtualRowIndex(e)})}return o},this.description=null,this.direction=null,this.fieldName=null,this.flexGrow=1,this.footerRenderFunction=null,this.formatFunction=null,this.frozen=!1,this.frozenToEnd=!1,this.grid=null,this.headerRenderFunction=e=>{const{root:t}=e,n=this.createHeaderContent();this.removeCellContent(t),t.appendChild(n)},this.hidden=!1,this.icon=null,this.initialSortPriority=null,this.label=null,this.menuConfig=null,this.messages=null,this.messagesCommon=null,this.messagesURIUtils=null,this.renderFunction=({root:e,rowData:t})=>{const n=this.getCellValue(t),i=this.cellValueFormatFunction({root:e,rowData:t,value:n});let o=null;if(o=i instanceof HTMLElement?i:c(this.messagesURIUtils,i),this.removeCellContent(e),o instanceof HTMLElement)e.removeAttribute("title"),e.appendChild(o);else if(null!=o){const t=o.toString();e.innerHTML=t,e.title=t}},this.resizable=!0,this.sortable=!1,this.store=null,this.tableTimeZone=null,this.textAlign="start",this.textWrap=!1,this.timeZone=null,this.visibleElements=null,this.width=200}initialize(){const{fieldName:e}=this;this._set("sortElement",this.createSortElement()),this.sortElement.setAttribute("path",e),this.addHandles([n((()=>this.direction),(e=>{const{sortElement:t}=this;this.sortable&&t&&(e?this.sortElement.direction!==e&&t.setAttribute("direction",e):t.removeAttribute("direction"))})),i((()=>this.grid?.isReady&&this.sortElement),(()=>{const{direction:e,grid:t,hidden:n,sortElement:i}=this;n&&e&&i&&t&&!t.hasSorter(i)&&t.addSorter(i)}),o),n((()=>this.timeZone),(()=>this.grid?.requestContentUpdate())),n((()=>this.hidden),(()=>this.closeMenu())),n((()=>this.fieldName),(e=>{const{sortElement:t}=this;t&&t.path!==e&&t.setAttribute("path",e)})),n((()=>this.effectiveLabel),(e=>{const{sortElement:t}=this;t&&t.textContent!==e&&(t.setAttribute("title",e),t.textContent=e)}))])}get _headerRequiresTextContainer(){return!(!this.sortable&&""===this.effectiveLabel&&null==this.effectiveDescription)}get customMenuItems(){return this.menuConfig?.items?.map((({disabled:e,hidden:t,icon:n,iconClass:i,label:o,selected:s,clickFunction:r})=>this.createCalciteDropdownItem({disabled:e,hidden:t,iconClass:i,iconStart:n,selected:s,textContent:o,onclick:e=>r(e)})))??[]}get defaultMenuItems(){if(!this.sortable)return[];const e=this.messages,t=[],n=this.visibleElements?.columnMenuItems;if(!1!==n?.sortAscending){const n=this.createCalciteDropdownItem({iconStart:"sort-ascending-arrow",textContent:e?.sortAsc,onclick:()=>this.direction="asc"});t.push(n)}if(!1!==n?.sortDescending){const n=this.createCalciteDropdownItem({iconStart:"sort-descending-arrow",textContent:e?.sortDesc,onclick:()=>this.direction="desc"});t.push(n)}return t}get effectiveDescription(){const{description:e}=this;return I(e)?null:d.sanitize(e)}get effectiveLabel(){return d.sanitize(this.label||this.fieldName)}get iconNode(){const{icon:e}=this;return e?this.createCalciteIcon({icon:e}):null}set invalid(e){this._set("invalid",e),this.grid?.generateCellPartNames()}get invalid(){return this._get("invalid")??!1}get menu(){const{customMenuItems:e,defaultMenuItems:t,menuConfig:n}=this,i=!!n?.open,o=this.createCalciteAction({icon:n?.icon??"ellipsis",text:this.messages?.menu??"",slot:"trigger"}),s=document.createElement("calcite-dropdown");if(s.maxItems=n?.maxItems??4,s.placement="top-end",s.overlayPositioning="fixed",s.scale=n?.scale??"m",i&&(s.open=i,this._menuIsOpen=!0),s.appendChild(o),s.addEventListener("calciteDropdownOpen",(()=>this._menuIsOpen=!0)),s.addEventListener("calciteDropdownClose",(()=>this._menuIsOpen=!1)),s.onkeydown=this._stopPropagationOnSelect,s.addEventListener("mousewheel",(e=>{e.stopPropagation()})),t.length){const e=s.appendChild(document.createElement("calcite-dropdown-group"));e.selectionMode="none",e.append(...t)}if(e.length){const t=s.appendChild(document.createElement("calcite-dropdown-group"));t.selectionMode=n?.selectionMode??"none",t.append(...e)}return s}get menuItems(){return[...this.defaultMenuItems,...this.customMenuItems]}get menuIsOpen(){return this._menuIsOpen}get menuIsVisible(){return!(!1===this.visibleElements?.columnMenus||!this.menuItems.length)}closeMenu(){this.menu.open=!1}createSortElement(){const{effectiveLabel:e,direction:t,fieldName:n,initialSortPriority:i}=this,o=document.createElement("vaadin-grid-sorter");return o.classList.add(m.sorter),o.setAttribute("path",n),o.setAttribute("title",e),o.textContent=e,t&&o.setAttribute("direction",t),null!=i&&(o._initialOrder=i),o.addEventListener("direction-changed",(()=>{this.direction!==o.direction&&this._set("direction",o.direction)})),o}createCalciteAction(e){const t=document.createElement("calcite-action"),{alignment:n,appearance:i,className:o,disabled:s,icon:r,label:l,scale:a,slot:c,text:d,textEnabled:u,onclick:p}=e;return t.alignment=n??"center",t.appearance=i??"transparent",t.className=o??"",t.disabled=!!s,t.icon=r??"",t.label=l??"",t.scale=a??"s",t.slot=c??"",t.text=t.title=d??"",t.textEnabled=!!u,t.onclick=p??null,t}createCalciteButton(e){const t=document.createElement("calcite-button"),{alignment:n,appearance:i,className:o,disabled:s,iconEnd:r,iconFlipRtl:l,kind:a,loading:c,onclick:d,scale:u,textContent:p,title:m,width:h}=e;return t.alignment=n??"center",t.className=o??"",t.scale=u??"s",t.appearance=i??"transparent",t.disabled=!!s,t.iconEnd=r??"",l&&(t.iconFlipRtl=l),t.kind=a??"brand",t.loading=!!c,t.textContent=p??"",m&&(t.title=m),t.width=h??"auto",t.onclick=d??null,t}createCalciteDropdownItem(e){const t=document.createElement("calcite-dropdown-item"),{disabled:n,hidden:i,iconClass:o,iconStart:s,textContent:r,onclick:l,selected:a}=e,c=r??"";if(o&&!s){const e=document.createElement("span"),n=document.createElement("span");n.classList.add(m.headerMenuIcon,o),e.textContent=e.title=c,e.insertBefore(n,e.firstChild),t.appendChild(e)}else t.iconStart=s??"",t.textContent=t.title=c;return t.disabled=!!n,t.hidden="function"==typeof i?i():!!i,t.selected=!!a,l&&(t.addEventListener("calciteDropdownItemSelect",l),t.onkeydown=this._stopPropagationOnSelect),t}createCalciteIcon(e){const{effectiveLabel:t}=this,{icon:n,scale:i,textLabel:o}=e,s=document.createElement("calcite-icon"),r=o??t;return s.icon=n,s.scale=i??"s",s.textLabel=r,s.title=r,s}createHeaderContent(){const{effectiveDescription:e,effectiveLabel:t,iconNode:n}=this,i=document.createElement("div");if(i.classList.add(m.headerContent),n&&i.appendChild(n),!this._headerRequiresTextContainer)return i;const o=i.appendChild(document.createElement("div"));return this.sortable?o.appendChild(this.sortElement):""!==t&&o.appendChild(this._createHeaderTextElement(t,m.headerLabel)),null!=e&&!1!==this.visibleElements?.columnDescriptions&&o.appendChild(this._createHeaderTextElement(e,m.headerDescription)),this.menuIsVisible&&i.appendChild(this.menu),i}getCellValue(e){return e?.item.feature.attributes?.[this.fieldName]}getVirtualRowIndex(e){const t=this.grid?.getRowContainingNode(e);return t?.parentElement?[...t.parentElement.children].indexOf(t):-1}removeCellContent(e){if(e&&e.firstChild)try{for(;e?.firstChild;)e?.removeChild(e.firstChild)}catch(e){}}openMenu(){this.menuIsVisible&&(this.menu.open=!0,u(this.menuItems[0]))}sort(){this.sortable&&this.sortElement?.click()}_stopPropagationOnSelect(e){"Enter"!==e.key&&" "!==e.key||e.stopPropagation()}_createHeaderTextElement(e,t){const n=document.createElement("span"),i=e??"";n.classList.add(t);const o=n.appendChild(document.createElement("span"));return o.textContent=i,o.setAttribute("title",i),n}};e([s()],L.prototype,"_headerRequiresTextContainer",null),e([s()],L.prototype,"_menuIsOpen",void 0),e([s()],L.prototype,"autoWidth",void 0),e([s()],L.prototype,"cellValueFormatFunction",void 0),e([s()],L.prototype,"customMenuItems",null),e([s()],L.prototype,"defaultMenuItems",null),e([s()],L.prototype,"description",void 0),e([s()],L.prototype,"direction",void 0),e([s()],L.prototype,"effectiveDescription",null),e([s()],L.prototype,"effectiveLabel",null),e([s({constructOnly:!0})],L.prototype,"fieldName",void 0),e([s()],L.prototype,"flexGrow",void 0),e([s()],L.prototype,"footerRenderFunction",void 0),e([s()],L.prototype,"formatFunction",void 0),e([s()],L.prototype,"frozen",void 0),e([s()],L.prototype,"frozenToEnd",void 0),e([s()],L.prototype,"grid",void 0),e([s()],L.prototype,"iconNode",null),e([s()],L.prototype,"invalid",null),e([s()],L.prototype,"headerRenderFunction",void 0),e([s()],L.prototype,"hidden",void 0),e([s()],L.prototype,"icon",void 0),e([s({constructOnly:!0})],L.prototype,"initialSortPriority",void 0),e([s()],L.prototype,"label",void 0),e([s()],L.prototype,"menu",null),e([s()],L.prototype,"menuItems",null),e([s()],L.prototype,"menuConfig",void 0),e([s()],L.prototype,"menuIsOpen",null),e([s()],L.prototype,"menuIsVisible",null),e([s()],L.prototype,"messages",void 0),e([s()],L.prototype,"messagesCommon",void 0),e([s()],L.prototype,"messagesURIUtils",void 0),e([s()],L.prototype,"renderFunction",void 0),e([s()],L.prototype,"resizable",void 0),e([s()],L.prototype,"sortable",void 0),e([s({readOnly:!0})],L.prototype,"sortElement",void 0),e([s()],L.prototype,"store",void 0),e([s()],L.prototype,"tableTimeZone",void 0),e([s()],L.prototype,"textAlign",void 0),e([s()],L.prototype,"textWrap",void 0),e([s()],L.prototype,"timeZone",void 0),e([s()],L.prototype,"visibleElements",void 0),e([s()],L.prototype,"width",void 0),L=e([r("esri.widgets.FeatureTable.Grid.Column")],L);const A=L;export{C as a,b,m as c,y as d,A as default,E as e,w as f,x as g,j as h,I as i,g as j,v as k,f as l,k as m,F as n,_ as o,h as u};
