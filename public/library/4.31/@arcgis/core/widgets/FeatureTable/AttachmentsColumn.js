/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{R as e}from"../../chunks/ReactiveMap.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/Logger.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import{i as o,a as i}from"../../chunks/attachmentUtils.js";import a,{c as r}from"./Grid/Column.js";import{r as c}from"../../chunks/widgetUtils.js";import"../../chunks/tracking.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/SimpleObservable.js";import"../../chunks/ObservableBase.js";import"../../chunks/ensureType.js";import"../../chunks/metadata.js";import"../../core/Error.js";import"../../config.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../core/Evented.js";import"../../core/reactiveUtils.js";import"../../chunks/asyncUtils.js";import"../../core/Collection.js";import"../../chunks/shared.js";import"../../chunks/columnUtils.js";import"../../chunks/componentsUtils.js";import"../../chunks/uriUtils.js";const l="esri-attachments-column",h={contentContainer:`${l}__content`,showAttachmentsButton:`${l}__button`};let m=class extends a{constructor(t){super(t),this._buttonElements=new e,this._thumbnailElements=new e,this.attachmentsViewEnabled=!0,this.cellValueFormatFunction=({root:t,rowData:e})=>{const{_showAttachmentsViewEnabled:n,formatFunction:s}=this,o=this.getCellValue(e);if(s&&e){const{index:n,item:{attachments:i,feature:a,relatedRecords:r}}=e;return s({attachments:i,column:this,feature:a,index:n,relatedRecords:r,value:o,virtualIndex:this.getVirtualRowIndex(t)})}if(!e)return o;const{index:i,item:{attachments:a,objectId:r}}=e,c=`(${o})`;if(!this.thumbnailsEnabled&&!n)return o;const l=document.createElement("span");l.textContent=l.title=c;let m=null;if(this.thumbnailsEnabled&&(m=this._createOrSyncThumbnails(r,a??[])),this._showAttachmentsViewEnabled){const t=document.createElement("div");m&&t.appendChild(m),t.appendChild(l);const e=this._createOrSyncShowAttachmentsButton(r,i);return e.appendChild(t),e}const u=document.createElement("div");return u.classList.add(h.contentContainer),m&&u.appendChild(m),u.appendChild(l),u},this.icon="attachment",this.layer=null,this.onShowAttachments=null,this.sortable=!1,this.store=null,this.textAlign="center",this.thumbnailAppearance="image",this.thumbnailCount=8,this.thumbnailIconScale="m",this.thumbnailsEnabled=!0}get _showAttachmentsViewEnabled(){return!(!this.attachmentsViewEnabled||!this.onShowAttachments)}get _supportsResize(){return!!this.store?.supportsResizeAttachments}get effectiveLabel(){return c.sanitize(this.label??(this.messages?.attachments||this.fieldName))}getCellValue(t){return t?.item?.attachments?.length??0}_createOrSyncThumbnails(t,e){const n=document.createElement("div"),s=this._thumbnailElements.get(t);return s?.length&&s.length===e.length?s.forEach((t=>n.appendChild(t))):this._thumbnailElements.set(t,this._createThumbnailElements(e,n)),n}_createOrSyncShowAttachmentsButton(t,e){const n=this._buttonElements.get(t);if(n)return n.textContent="",n.onclick=n=>this._onShowAttachmentsClick({index:e,objectId:t,event:n}),n;const s=this.createCalciteButton({alignment:"icon-end-space-between",className:`${h.showAttachmentsButton} ${r.contentFull}`,iconEnd:"chevron-right",iconFlipRtl:"both",scale:this.thumbnailIconScale,textContent:"",title:this.messages?.viewAttachments,width:"full",onclick:n=>this._onShowAttachmentsClick({index:e,objectId:t,event:n})});return this._buttonElements.set(t,s),s}_createThumbnailAnchor({name:t,url:e},n){const s=document.createElement("a");return s.href=`${e}`,s.download=t,s.rel="noreferrer",s.target="_blank",s.appendChild(n),s}_createThumbnailElements(t,e){const{thumbnailAppearance:n,thumbnailCount:s,thumbnailIconScale:a}=this,r=[],c=Math.min(s,t.length),l=!this.onShowAttachments,h="image"===n;for(let n=0;n<c;n++){const s=t[n],{name:c,contentType:m}=s,u=o(m)&&h?this._createThumbnailImage(s):this.createCalciteIcon({icon:i(m),scale:a,textLabel:c}),p=l?this._createThumbnailAnchor(s,u):u;e&&e.appendChild(p),r.push(p)}return r}_createThumbnailImage(t){const{name:e,size:n,url:s}=t,o=document.createElement("img"),i=`${s}${s?.includes("?")?"&":"?"}${this._supportsResize?"w=24":""}&fs=${n}`;return o.alt=this.messages?.attachmentThumbnail??e,o.src=i,o.title=e,o}_onShowAttachmentsClick({index:t,objectId:e,event:n}){n.preventDefault(),n.stopPropagation(),this.onShowAttachments?.({index:t,objectId:e})}};t([n()],m.prototype,"_showAttachmentsViewEnabled",null),t([n()],m.prototype,"_buttonElements",void 0),t([n()],m.prototype,"_supportsResize",null),t([n()],m.prototype,"_thumbnailElements",void 0),t([n()],m.prototype,"attachmentsViewEnabled",void 0),t([n()],m.prototype,"cellValueFormatFunction",void 0),t([n()],m.prototype,"effectiveLabel",null),t([n()],m.prototype,"icon",void 0),t([n()],m.prototype,"layer",void 0),t([n()],m.prototype,"onShowAttachments",void 0),t([n({readOnly:!0})],m.prototype,"sortable",void 0),t([n()],m.prototype,"store",void 0),t([n()],m.prototype,"textAlign",void 0),t([n()],m.prototype,"thumbnailAppearance",void 0),t([n()],m.prototype,"thumbnailCount",void 0),t([n()],m.prototype,"thumbnailIconScale",void 0),t([n()],m.prototype,"thumbnailsEnabled",void 0),m=t([s("esri.widgets.FeatureTable.AttachmentsColumn")],m);const u=m;export{u as default};
