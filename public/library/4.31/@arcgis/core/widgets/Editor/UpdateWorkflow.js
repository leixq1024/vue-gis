/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Graphic.js";import s from"../../core/Error.js";import{a as r,m as i}from"../../chunks/handleUtils.js";import{L as o}from"../../chunks/Logger.js";import{d as a,a as n}from"../../chunks/maybe.js";import{isAborted as p,createResolver as l,onAbort as m,createAbortError as c,throwIfAborted as u,debounce as d}from"../../core/promiseUtils.js";import{Q as h}from"../../chunks/Queue.js";import{watch as j,whenOnce as y,when as k,sync as f}from"../../core/reactiveUtils.js";import w,{p as g}from"../../core/Accessor.js";import{property as b}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{subclass as v}from"../../core/accessorSupport/decorators/subclass.js";import{i as S}from"../../chunks/editableLayers.js";import{u as M,v as F}from"../../chunks/layerUtils.js";import C from"../../views/draw/support/HighlightHelper.js";import{V as I}from"../../chunks/InputManager.js";import{S as U}from"../../chunks/SketchOptions.js";import _,{w as V,f as A,g as E,s as R,i as x,u as P,a as L,c as W,b as T,d as D,e as O}from"./CreateFeaturesWorkflow.js";import H from"../../layers/GraphicsLayer.js";import{p as G}from"../../chunks/elevationInfoUtils.js";import{h as B}from"../../chunks/layerViewUtils.js";import{Edits as z}from"./Edits.js";import q from"./Workflow.js";import N from"../FeatureForm/FeatureFormViewModel.js";import Q from"../Sketch/SketchViewModel.js";import Z from"./UpdateWorkflowData.js";import{c as J}from"../../chunks/featureUtils.js";import{g as K}from"../../chunks/templateUtils.js";import"../../geometry.js";import"../../chunks/ensureType.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../chunks/utils.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../config.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../chunks/vec3f64.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../chunks/asyncUtils.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/layerUtils2.js";import"../../chunks/utils3.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../chunks/utils2.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../core/signal.js";import"../../views/interactive/sketch/SketchLabelOptions.js";import"../../views/interactive/sketch/SketchTooltipOptions.js";import"../../chunks/SketchTooltipVisibleElements.js";import"../../views/interactive/sketch/SketchValueOptions.js";import"../../chunks/angularMeasurementUtils.js";import"../../chunks/Cyclical.js";import"../../chunks/quantityUtils.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../chunks/vec3.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../chunks/projectPointToVector.js";import"../../geometry/projection.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/dehydratedPoint.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/uuid.js";import"../../chunks/helpMessageUtils.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./CreateFeaturesWorkflowData.js";import"../../chunks/ReactiveMap.js";import"../../chunks/diffUtils.js";import"../../chunks/drapedUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils12.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils7.js";import"../../chunks/enums2.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/styleUtils.js";import"../../chunks/GraphicState.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/GraphicsCollection.js";import"../../layers/Layer.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../layers/mixins/BlendLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/UpdatingHandles.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../form/support/elements.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../chunks/Input.js";import"../../form/elements/inputs/attachments/support/inputs.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils8.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../chunks/formUtils.js";import"../../chunks/arcgisLayerUrl.js";import"../../layers/support/Subtype.js";import"../../chunks/featureFormUtils.js";import"../FeatureForm/FieldInput.js";import"../FeatureForm/EditableInput.js";import"../FeatureForm/InputBase.js";import"../../chunks/formUtils2.js";import"../../arcade.js";import"../../chunks/TimeOnly.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/Version2.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/OverrideHelper.js";import"../../chunks/quantizationUtils.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties2.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/support/elements.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../chunks/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../chunks/portalItemUtils.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/AlphaCutoff.js";import"../../chunks/interfaces2.js";import"../FeatureForm/GroupInput.js";import"../FeatureForm/RelationshipInput.js";import"../../chunks/FeatureRelationshipViewModel.js";import"../../chunks/ReactiveSet.js";import"../../chunks/isSupportedObject.js";import"../../chunks/keybindings.js";import"../../chunks/SnappingManager.js";import"../../chunks/normalizedPoint.js";import"../../chunks/Settings2.js";import"../../chunks/RightAngleSnappingHint.js";import"../../views/interactive/snapping/SnappingOptions.js";import"../../chunks/snappingUtils.js";import"../../chunks/plane.js";import"../../chunks/mat3f64.js";import"../../chunks/mat4f64.js";import"../../chunks/quatf64.js";import"../../chunks/mathUtils2.js";import"../../chunks/sphere.js";import"../../chunks/ray.js";import"../../chunks/mat3.js";import"../../chunks/geometry2dUtils.js";import"../../chunks/utils6.js";import"../../chunks/Version.js";import"../../chunks/viewUtils.js";import"../../chunks/screenUtils2.js";var $;let X=$=class extends w{constructor(t){super(t),this.editorItem=null,this.edits=null,this.parent=null,this.relatedRecordCallbacks=null,this.viewModel=null}get attachmentsCapabilities(){const t=this.editorItem.capabilities.update.attachments.enabled;return{editing:!0,operations:{add:t,update:t,delete:t}}}get formTemplate(){return this.editorItem.formTemplate}static async create(t){const e=$._makeConstructorProps(t);return new $(e)}static _makeConstructorProps(t){const{feature:e,parent:r,relatedRecordCallbacks:i,viewModel:o}=t,a=o.editorItems.find((t=>t.layer===e.layer));if(!a)throw new s("no-editorItem-found","The EditorViewModel provided did not have an EditorItem associated with the specified Graphic's layer");return{editorItem:a,edits:new z({feature:e}),parent:r,relatedRecordCallbacks:i,viewModel:o}}};t([b()],X.prototype,"attachmentsCapabilities",null),t([b({constructOnly:!0})],X.prototype,"editorItem",void 0),t([b()],X.prototype,"edits",void 0),t([b()],X.prototype,"formTemplate",null),t([b()],X.prototype,"parent",void 0),t([b()],X.prototype,"relatedRecordCallbacks",void 0),t([b()],X.prototype,"viewModel",void 0),X=$=t([v("esri.widgets.Editor.UpdateRecordWorkflowData")],X);const Y=X;var tt;let et=tt=class extends Y{constructor(t){super(t),this.sketchOptions=null,this.snappingManager=null}static async create(t){const{feature:e,snappingManager:r,viewModel:i}=t,o=t.sketchOptions??new U,{view:a}=i;if(!a)throw new s("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const n=await V(a,e.layer);return new tt({...tt._makeConstructorProps(t),layerView:n,sketchOptions:o,snappingManager:r})}};t([b()],et.prototype,"layerView",void 0),t([b({constructOnly:!0})],et.prototype,"sketchOptions",void 0),t([b()],et.prototype,"snappingManager",void 0),et=tt=t([v("esri.widgets.Editor.UpdateFeatureWorkflowData")],et);const st=et;var rt;const it={exit:Symbol()};let ot=rt=class extends q{constructor(t){super(t),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){const{data:t}=this,{edits:e}=t,{view:o}=t.viewModel,a=e.feature,n=new AbortController;this.addHandles(r(n)),this._updatingHandles.addPromise(A(a,t.viewModel.view.spatialReference,n.signal).then((t=>{p(n)||(this._onFullFeatureLoaded(t),this._initializeFeatureFormViewModel())}),(t=>this.cancel({force:!0,error:new s("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:t}})})))),o&&(this._highlightHelper=new C({view:o}),this.addHandles(i((()=>this._highlightHelper?.removeAll()))))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get shouldShowAttachments(){return this.editorItem.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return this.editorItem.capabilities.update.attachments.enabled}get reliesOnOwnerAdminPrivileges(){const t=this.editorItem.capabilities;return t.update.reliesOnOwnerAdminPrivileges||t.delete.reliesOnOwnerAdminPrivileges}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel()}exit(t){this.removeHandles(it.exit)}async start(){return await super.start(),null}_configureAttachmentsViewModel(){const{data:t,fullFeature:e}=this,{attachmentsCapabilities:s,viewModel:r}=t,{attachmentsViewModel:o}=r;o.set({capabilities:s,graphic:e,filesEnabled:!1,mode:"view"}),this.addHandles([i((()=>o.fileInfos.removeAll())),j((()=>o.mode),(t=>{switch(t){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}))],it.exit)}_initializeFeatureFormViewModel(){const{edits:t,formTemplate:e,viewModel:{view:s}}=this.data,r=this._featureFormViewModel=new N({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:e,highlightHelper:this._highlightHelper,map:s?.map,spatialReference:s.spatialReference,timeZone:s?.timeZone});r.relatedRecordCallbacks={...this.data.relatedRecordCallbacks,showAllRelatedRecords:t=>r.relationshipId=t.relationshipId};const{initialFeature:i}=t;i&&r.overrideInitialFeature(i),this.addHandles([r.on("value-change",(()=>{t.updateAttributes(r.getValues()),this.fullFeature.attributes=t.feature.attributes})),j((()=>s?.timeZone),(t=>r.timeZone=t))])}_onFullFeatureLoaded(t){this.fullFeature=t;const{edits:e}=this.data;e.updateAttributes(t.attributes),e.trackChanges()}static async create(t){const e=new rt({data:await Y.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}static _createWorkflowSteps(t){const{attachmentsViewModel:e}=t.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){e.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){e.mode="view"}}]}};var at;ot._onCommitFactory=t=>async e=>{const{edits:s}=e,{feature:r}=s;if(!r)return;const i=r.sourceLayer,o=r.clone();if(!s.attributesModified||s.stagedForDelete){const t=i.objectIdField;if(o.attributes={[t]:r.getAttribute(t)},"scene"===i.type&&null!=i.infoFor3D){const t=i.associatedLayer?.globalIdField;null!=t&&o.setAttribute(t,r.getAttribute(t))}}s.geometryModified&&!s.stagedForDelete||(o.geometry=null);const a=s.stagedForDelete?"deleteFeatures":"updateFeatures";await t(i,{[a]:[o]})},t([b()],ot.prototype,"editorItem",null),t([b()],ot.prototype,"featureFormViewModel",null),t([b()],ot.prototype,"fullFeature",void 0),t([b()],ot.prototype,"hasPendingEdits",null),t([b()],ot.prototype,"layer",null),t([b()],ot.prototype,"parent",null),t([b()],ot.prototype,"parentLayer",null),t([b()],ot.prototype,"shouldShowAttachments",null),t([b()],ot.prototype,"shouldAllowAttachmentEditing",null),t([b()],ot.prototype,"reliesOnOwnerAdminPrivileges",null),ot=rt=t([v("esri.widgets.Editor.UpdateRecordWorkflow")],ot);const nt={...it,highlights:Symbol(),sketchGraphics:Symbol(),sketchViewModel:Symbol(),waitingForTool:Symbol()};let pt=at=class extends ot{constructor(t){super(t),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._sketchViewModel=null,this._webStyleCache=new Map}destroy(){this._layerViewEditSession?.rollback()}async commit(){this.removeHandles(nt.sketchGraphics);try{const t=this.data.edits.stagedForDelete;await super.commit();const e=this._layerViewEditSession;t?e?.rollback():e?.commit()}catch(t){throw await this._configureSketchViewModel(),new s("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:t})}}async start(){return await super.start(),await this._initializeSketchViewModel()}_initializeFeatureFormViewModel(){super._initializeFeatureFormViewModel(),this.addHandles([this._featureFormViewModel.on("value-change",(t=>{this._layerViewEditSession?.setAttribute(t.fieldName,t.value)})),j((()=>this._featureFormViewModel.feature?.sourceLayer),(t=>this._sketchGraphicClone.sourceLayer=t))])}_configureHighlight(){const{edits:t,layerView:e}=this.data;B(e)&&this.addHandles(e.highlight(t.feature),nt.highlights)}async _configureSketchViewModel(){const t=this._sketchViewModel;if(!t)return;const{data:e,_featureFormViewModel:s,_sketchGraphicClone:r}=this,{edits:i,viewModel:o}=e,a=i.feature,{view:n}=o,p=E(a),l=await R({feature:a,featureClone:r,visualVariableAttributes:p,sketchViewModel:t,view:n,onUpdate:({geometry:t,attributes:e},r)=>{if(i.updateAttributes(e),i.updateGeometry(t),s.feature&&(s.feature.geometry=t),null!=p.rotation){const{field:t}=p.rotation;s.setValue(t,e[t])}if(null!=p.size){const{field:t}=p.size;s.setValue(t,e[t])}("undo"===r.type||"redo"===r.type||"update"===r.type&&null!=r.toolEventInfo&&x(r.toolEventInfo.type))&&s.notifyFeatureGeometryChanged()},addUpdatingPromise:t=>{this._updatingHandles.addPromise(t)},addHandle:t=>{this.addHandles(t,nt.waitingForTool)},webStyleCache:this._webStyleCache});this.addHandles(l,nt.sketchGraphics),t.addHandles(l)}async _initializeSketchViewModel(){const{data:t,_sketchGraphicClone:e}=this,s=t.edits.feature,{capabilities:r,layer:o}=t.editorItem,{view:n}=t.viewModel;if(this.removeHandles([nt.highlights,nt.sketchGraphics,nt.sketchViewModel,nt.waitingForTool]),!r.update.geometry||"3d"===n?.type&&G(o.elevationInfo))return{enter:async()=>{this.hasHandles(nt.highlights)||this._configureHighlight()},exit:()=>this.removeHandles([nt.highlights])};const p=new H({elevationInfo:o.elevationInfo,internal:!0,listMode:"hide"}),l=new Q({allowDeleteKey:!1,layer:p,sketchOptions:t.sketchOptions,snappingManager:t.snappingManager,updateOnGraphicClick:!1,view:n});return this._sketchViewModel=l,n?.map.add(p),this.addHandles(i((()=>{n?.destroyed||n?.map.remove(p),p.destroy(),this._sketchViewModel=a(l)})),nt.sketchViewModel),await P(e,this._webStyleCache,"2d"===n?.type?n.scale:null),this.addHandles([await L(l,s,e)]),{enter:async()=>{this.hasHandles(nt.sketchGraphics)||await this._configureSketchViewModel()},exit:()=>this.removeHandles([nt.sketchGraphics]),viewModel:l}}_onFullFeatureLoaded(t){super._onFullFeatureLoaded(t);const e=this._sketchGraphicClone=W(t),{edits:s,layerView:r}=this.data;s.updateGeometry(t.geometry),s.trackChanges(),T(r)&&(this._layerViewEditSession=r.createInteractiveEditSession(e))}static async create(t){const e=new at({data:await st.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}get test(){}};var lt;t([b()],pt.prototype,"_layerViewEditSession",void 0),t([b()],pt.prototype,"_sketchGraphicClone",void 0),t([b()],pt.prototype,"_sketchViewModel",void 0),pt=at=t([v("esri.widgets.Editor.UpdateFeatureWorkflow")],pt);const mt="esri.widgets.Editor.UpdateWorkflow";let ct=lt=class extends q{constructor(t){super(t),this._workflowStack=new h(g),this._sketchStack=new h(g),this.data=void 0,this.type="update"}get activeEditorItem(){return this.activeWorkflow?.data.editorItem??void 0}get activeFeatureFormViewModel(){return this.activeWorkflow?.featureFormViewModel}get activeSketchViewModel(){return this._sketchStack.peek()?.viewModel}get activeWorkflow(){return this._workflowStack.last()}get updating(){return this._updatingHandles.updating||!!this.activeWorkflow?.updating}get hasPreviousStep(){return this._stepIndex>0||this.nestedWorkflowCount>1||null!=this.activeWorkflow?.featureFormViewModel.relationshipId||"view"!==this.data.viewModel.attachmentsViewModel.mode}get hasUpdatableCandidates(){const{candidates:t,viewModel:e}=this.data;return t.some((({layer:t})=>e.findEditorItemForLayer(t)?.supportsUpdateWorkflow))}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditorItem?.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return!!this.activeEditorItem?.capabilities.update.attachments.enabled}get hasPendingEdits(){return Array.from(this._workflowStack).some((t=>t.hasPendingEdits))}get helpMessage(){return this.activeWorkflow?.helpMessage?this.activeWorkflow.helpMessage:"awaiting-feature-to-update"===this.stepId?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditorItem?.hasInvalidFormTemplate}async back(t=()=>Promise.resolve(!0)){const{activeWorkflow:e}=this;if(null==e?.featureFormViewModel.relationshipId)if(e){if(e.hasPendingEdits&&!await t())return;e.hasPreviousStep?await e.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else e.featureFormViewModel.relationshipId=null}async cancelActiveWorkflow(t){await(this.activeWorkflow?.cancel(t)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack((t=>t.commit())),await super.commit()}static create(t){const{viewModel:e,snappingManager:s,startAt:r,addAttachmentsCallback:i,applyEditsCallback:o}=t,a=t.sketchOptions??new U,n=new lt({data:new Z({addAttachmentsCallback:i,applyEditsCallback:o,sketchOptions:a,snappingManager:s,viewModel:e}),onCommit:async()=>{}});return n._set("steps",this._createWorkflowSteps(n,r)),n}async save(){this.nestedWorkflowCount>1?(await(this.activeWorkflow?.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(t){try{const e=await this._createNestedCreateFeaturesWorkflow(t);await this._pushWorkflow(e)}catch(t){throw new s("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}}async startUpdating(t){try{const e=await this._createNestedUpdateWorkflow(t);await this._pushWorkflow(e)}catch(t){throw new s("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:t})}}async deleteActiveFeature(){const{activeWorkflow:t}=this;if(!t)throw new s("editor:nothing-to-delete","There is no feature to delete");ht(t)?await t.deleteAndCommit():await t.cancel(),1===this.nestedWorkflowCount?await this.reset():await this._popWorkflow()}async cancelAll(){await this._drainWorkflowStack((t=>t.cancel({force:!0})))}async _createNestedCreateFeaturesWorkflow(t){const{relatedLayer:e}=t,{addAttachmentsCallback:r,applyEditsCallback:i,sketchOptions:o,snappingManager:a,viewModel:n}=this.data;if(!S(e))throw new s("editor:unsupported-layer","Editing is not supported on the provided layer");const p=this._getCreationInfoForNestedCreateFeaturesWorkflow(t),l=p.template||p.initialFeature?"creating-features":"awaiting-feature-creation-info",m="create-features"!==this.activeWorkflow?.type?this.activeWorkflow:void 0;return _.create({addAttachmentsCallback:r,applyEditsCallback:i,creationInfo:p,isNested:!0,parent:m,sketchOptions:o,snappingManager:a,startAt:l,viewModel:n})}_getCreationInfoForNestedCreateFeaturesWorkflow(t){const{relatedLayer:r}=t;if(!S(r)||M(r))throw new s("editor:unsupported-layer","Editing is not supported on the provided layer");const i={layer:r,maxFeatures:1},o=this._makeRelatedRecordAttributes(t),a=K(r);return a?.length>0?(i.attributeOverrides=o,1===a.length&&(i.template=a[0])):i.initialFeature=new e({sourceLayer:r,attributes:o}),i}async _createNestedUpdateWorkflow(t){const e=F(t.sourceLayer)?ot:pt,{applyEditsCallback:s,sketchOptions:r,snappingManager:i,viewModel:o}=this.data,a="create-features"!==this.activeWorkflow?.type?this.activeWorkflow:void 0,n=await e.create({feature:t,parent:a,sketchOptions:r,snappingManager:i,viewModel:o,applyEdits:s,relatedRecordCallbacks:{addRelatedRecord:async t=>await this.startCreatingRelatedRecord(t),editRelatedRecord:async({relatedFeature:t})=>await this.startUpdating(t)}});return await y((()=>!n.updating)),n}async _drainWorkflowStack(t){const e=this._workflowStack,s=[];for(;e.length>0;){const r=e.pop();this._sketchStack.pop();const i=t(r).then((()=>r.destroy()));this._updatingHandles.addPromise(i),s.push(i)}await Promise.all(s)}_makeRelatedRecordAttributes(t){const{parentFeature:e,relatedLayer:s,relationshipId:r}=t;if(!J(e))return;const i=s.relationships?.find((t=>t.id===r));if(!i)return void dt("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if("origin"===i.role)return void dt("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const o=e.sourceLayer;i.relatedTableId!==o.layerId&&dt("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const a=o.relationships?.find((t=>t.id===r));if(!a)return void dt("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const n=ut(o,a),p=e.getAttribute(n);p||dt("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field.");const l=ut(s,i);return{[l]:p}}async _popWorkflow(){this._workflowStack.pop()?.destroy(),this._sketchStack.pop();const t=await this._reconcileWorkflowStack();if(t.failureCount>0)throw new s("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",t)}async _pushWorkflow(t){const e=this._workflowRequiresSketchViewModel(t);this.activeWorkflow?.exit({removeSketchHandles:e});const r=this._sketchStack,i=await(t?.start()),o=r.peek();i?(o?.exit(),r.push(i)):r.push(this._cloneSketchController(o)),this._workflowStack.push(t);const a=await this._reconcileWorkflowStack();if(a.failureCount>0)throw new s("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",a)}async _reconcileWorkflowStack(){const t=this._workflowStack,e=this._sketchStack;try{const s=t.peek();return await(s?.enter()),await(e.peek()?.enter()),{activeWorkflow:s,failureCount:0}}catch(s){t.pop().destroy(),e.pop();const{activeWorkflow:r,failureCount:i}=await this._reconcileWorkflowStack();return{activeWorkflow:r,failureCount:i+1}}}_cloneSketchController(t){return{enter:t?.enter??(async()=>{}),exit:t?.exit??(async()=>{}),viewModel:t?.viewModel}}_workflowRequiresSketchViewModel(t){const{type:e}=t;return"update-feature"===e||"create-features"===e&&!F(t.data.creationInfo?.layer)}static _createWorkflowSteps(t,e="awaiting-feature-to-update"){const{data:r}=t;return D(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],e,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:e}=r.viewModel,s=r.viewModel.view;s.activeTool=null;let o=null;t.addHandles(i((()=>{o=n(o)})),this.id),r.rootFeature=null,r.candidates=[];const a=s.on("immediate-click",(async i=>{const a=l();t._updatingHandles.addPromise(a.promise);try{e.location=i.mapPoint,e.visible=!0,o?.abort();const{editorItems:a}=r.viewModel;o=new AbortController;const n=await i.async((()=>new Promise(((t,e)=>{m(o?.signal,(()=>e(c()))),t(O(a,s,i,o?.signal))}))));if(u(o),r.candidates=n.filter((t=>"fulfilled"===t.status)).flatMap((t=>t.value)).filter((t=>!t.isAggregate)),e.visible=1===r.candidates.length,0===r.candidates.length)return;i.stopPropagation(),1===r.candidates.length?(r.rootFeature=r.candidates[0],t.go("editing-existing-feature").catch((()=>{})).then((()=>e.visible=!1))):t.next()}finally{a.resolve()}}),I.TOOL),p=k((()=>null!=s.activeTool),(()=>t.cancel({force:!0})),{once:!0});s.focus(),t.addHandles([a,p],this.id)},async tearDown(){0===r.candidates.length&&(r.viewModel.spinnerViewModel.visible=!1),t.removeHandles(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){r.rootFeature=null;const{view:e}=r.viewModel;if(!e)return;const s=new C({view:e});t.addHandles([j((()=>r.rootFeature),((t,e)=>{s.remove(e),s.add(t)}),f),i((()=>s.removeAll()))],this.id)},async tearDown(){t.removeHandles(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:e,viewModel:r}=t.data;if(!e)throw new s("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await t.startUpdating(e),r.spinnerViewModel.visible=!1;const i=d((async()=>{await y((()=>!t.updating)),t.previous()}));t.addHandles([j((()=>t.nestedWorkflowCount),((t,e)=>{0===t&&0!==e&&i()}),f)],this.id)},async tearDown(){await t.cancelAll(),t.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){r.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){r.viewModel.attachmentsViewModel.mode="view"}})})}};function ut(t,{keyField:e}){return t.getField(e)?.name??e}t([b()],ct.prototype,"activeEditorItem",null),t([b()],ct.prototype,"activeFeatureFormViewModel",null),t([b()],ct.prototype,"activeSketchViewModel",null),t([b()],ct.prototype,"activeWorkflow",null),t([b()],ct.prototype,"updating",null),t([b()],ct.prototype,"data",void 0),t([b()],ct.prototype,"hasPreviousStep",null),t([b()],ct.prototype,"hasUpdatableCandidates",null),t([b()],ct.prototype,"nestedWorkflowCount",null),t([b()],ct.prototype,"shouldShowAttachments",null),t([b()],ct.prototype,"shouldAllowAttachmentEditing",null),t([b()],ct.prototype,"hasPendingEdits",null),t([b()],ct.prototype,"helpMessage",null),t([b()],ct.prototype,"reliesOnOwnerAdminPrivileges",null),t([b()],ct.prototype,"hasInvalidFormTemplate",null),ct=lt=t([v(mt)],ct);const dt=(t,e)=>o.getLogger(mt).warn(`editor:${t}`,e,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),ht=t=>!!t&&/update-/.test(t.type),jt=ct;export{jt as default};
