/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{S as t,k as r}from"../core/Accessor.js";import{b as s}from"../chunks/domUtils.js";import o from"../core/Evented.js";import{debounce as i,throwIfNotAbortError as n,i as a,o as d}from"../core/promiseUtils.js";import{clone as c}from"../core/lang.js";import{L as l}from"../chunks/Logger.js";import{d as h}from"../chunks/maybe.js";import{EsriPromiseMixin as p}from"../core/Promise.js";import{watch as u,when as m,syncAndInitial as g}from"../core/reactiveUtils.js";import{g as v}from"../chunks/uuid.js";import{property as f}from"../core/accessorSupport/decorators/property.js";import{cast as y}from"../core/accessorSupport/decorators/cast.js";import{subclass as j}from"../core/accessorSupport/decorators/subclass.js";import{r as _}from"../chunks/tracking.js";import{d as k}from"../chunks/projector.js";import{e as b}from"../chunks/componentsUtils.js";import{w,i as R,p as S,a as E}from"../chunks/jsxWidgetSupport.js";import{g as P,h as N,j as I,c as L,k as F}from"../chunks/widgetUtils.js";import{o as C}from"../chunks/locale.js";import{f as H}from"../chunks/messages.js";import"../chunks/date.js";import"../chunks/jsonMap.js";import"../config.js";import"../chunks/datetime.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"../core/JSONSupport.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../core/Handles.js";import"../chunks/metadata.js";import"../chunks/ObservableBase.js";import"../core/scheduling.js";import"../chunks/ensureType.js";import"../chunks/assets.js";import"../chunks/asyncUtils.js";import"../core/Collection.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";const T={handleInterceptedEvent:(e,t,r,s)=>(e.scheduleRender(),t.properties[`on${s.type}`].apply(t.properties.bind||r,[s]))},U={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(e,t,r)=>{"-"===t.charAt(0)?e.style.setProperty(t,r):e.style[t]=r}},A=(e,t,r=!1)=>{let s=e;return t.forEach(((e,o)=>{const i=s?.children?(n=t=>t.domNode===e,s.children.find(n)):void 0;var n;r&&!i&&o!==t.length-1||(s=i)})),s},O=new Set;var $;let x=0;function z(e,t){const r=Object.prototype.hasOwnProperty;for(const s in t)r.call(t,s)&&r.call(e,s)&&(null!=e[s]&&null!=t[s]&&"object"==typeof e[s]&&"object"==typeof t[s]?z(e[s],t[s]):e[s]=t[s]);return e}const B=(e=>{let t;const r={...T,...e},s=(e=>({...U,...e}))(r),o=s.performanceLogger;let i,n=!0,a=!1;const d=[],c=[],l=(e,i,n)=>{let a;s.eventHandlerInterceptor=(e,s,i,n)=>function(e){let s;o("domEvent",e);const i=((e,t)=>{const r=[];for(;e&&e!==t;)r.push(e),e=e.parentNode;return r})(e.currentTarget,a.domNode),n=i.some((e=>customElements.get(e?.tagName?.toLowerCase())));if(e.eventPhase!==Event.CAPTURING_PHASE&&n){const t=e.composedPath(),r=t.slice(t.indexOf(e.currentTarget),t.indexOf(a.domNode)).reverse();s=A(a.getLastRender(),r,!0)}else i.reverse(),s=A(a.getLastRender(),i);let d;return s&&(d=r.handleInterceptedEvent(t,s,this,e)),o("domEventProcessed",e),d},r.postProcessProjectionOptions?.(s);const l=n();a=e(i,l,s),s.eventHandlerInterceptor=void 0,d.push(a),c.push(n),r.afterFirstVNodeRendered&&r.afterFirstVNodeRendered(a,l)};let h=()=>{if(i=void 0,n){n=!1,o("renderStart",void 0);for(let e=0;e<d.length;e++){const t=c[e]();o("rendered",void 0);try{d[e].update(t)}catch(e){console.error(e)}o("patched",void 0)}o("renderDone",void 0),n=!0}};return r.modifyDoRenderImplementation&&(h=r.modifyDoRenderImplementation(h,d,c)),t={renderNow:h,scheduleRender:()=>{i||a||(i=requestAnimationFrame(h))},stop:()=>{i&&(cancelAnimationFrame(i),i=void 0),a=!0},resume:()=>{a=!1,n=!0,t.scheduleRender()},append:(e,t)=>{l(k.append,e,t)},insertBefore:(e,t)=>{l(k.insertBefore,e,t)},merge:(e,t)=>{l(k.merge,e,t)},replace:(e,t)=>{l(k.replace,e,t)},detach:e=>{for(let t=0;t<c.length;t++)if(c[t]===e)return c.splice(t,1),d.splice(t,1)[0];throw new Error("renderFunction was not found")}},t})({postProcessProjectionOptions(e){const t=e.eventHandlerInterceptor,r=/capture$/i;e.eventHandlerInterceptor=(e,s,o,i)=>{const n=t?.(e,s,o,i),a=r.test(e);if(!((e=e.replace(r,"")).toLowerCase()in o)||a){const t=e[2].toLowerCase()+e.slice(3),r=e=>n?.call(o,e);o.addEventListener(t,r,a);const s=()=>o.removeEventListener(t,r,a),d=i.afterRemoved;i.afterRemoved=e=>{d?.(e),s()}}return n}},handleInterceptedEvent(e,t,r,s){const{eventPhase:o,type:i}=s,n=o===Event.CAPTURING_PHASE;let a=`on${i}${n?"capture":""}`;const d=t.properties;(d&&a in d||(a=`on${i[0].toUpperCase()}${i.slice(1)}${n?"Capture":""}`,d&&a in d))&&(F(),e.scheduleRender(),d[a].call(d.bind||r,s))}});let D=!1,W=class extends(p(o.EventedAccessor)){constructor(e,r){super(e,r),this._attached=!1,this._projector=B,this._readyForTrueRender=!1,this.key=this,this.autoRenderingEnabled=!0,this._loadLocale=i((async()=>{if(this._messageBundleProps?.length){const e=await Promise.allSettled(this._messageBundleProps.map((async({bundlePath:e,propertyName:t})=>{if(this.destroyed)return;let r=await H(e);this.uiStrings&&Object.keys(this.uiStrings)&&(r=z(c(r),this.uiStrings)),this[t]=r})));if(this.destroyed)return;for(const t of e)"rejected"===t.status&&l.getLogger(this).error("widget-intl:locale-error",this.declaredClass,t.reason)}await this.loadLocale()})),b();const s="esri-widget-uid-"+v(),o=this.render.bind(this);this._trackingTarget=new t((()=>{this.autoRenderingEnabled&&this.scheduleRender()}));const n=()=>({vnodeSelector:"div",properties:{key:`${s}-hidden`,class:"",styles:{display:"none"}},domNode:null,children:void 0,text:void 0}),a=()=>{if(!this._readyForTrueRender||this.destroyed)return null;const e=o()??n(),t=e.properties??={};if(t.key??=s,R(e.vnodeSelector)){if(!this.visible)return n()}else this.visible?t.styles||(t.styles={}):(t.class="",t.styles={display:"none"}),t.styles.display??="";let r=0;return e.children?.forEach((e=>{R(e.vnodeSelector)||(e.properties??={},e.properties.key??=`${this.id}--${r++}`)})),S(this,e)};this.render=()=>{if(D)return a();let e=P(this)??null;if(e)return e;this._trackingTarget.clear(),D=!0;try{e=_(this._trackingTarget,a)}catch(e){throw l.getLogger(this).error(e),e}finally{D=!1}return e&&N(this,e),e};const d=this.beforeFirstRender();var h;d?this._resourcesFetch=d.then((()=>{this._readyForTrueRender=!0,this._postInitialize()})):(this._resourcesFetch=Promise.resolve().then((()=>{this._postInitialize()})),this._readyForTrueRender=!0),this.addResolvingPromise(this._resourcesFetch),h=this._resourcesFetch,O.add(h),h.finally((()=>O.delete(h)))}normalizeCtorArgs(e,t){const r={...e};return t&&(r.container=t),r}postInitialize(){}beforeFirstRender(){const e=this.loadDependencies();return this._messageBundleProps?.length||e?Promise.all([e,this._loadLocale()]).then((()=>{})).catch(n):null}loadDependencies(){return null}loadLocale(){return null}destroy(){this.destroyed||(h(this._trackingTarget),h(this.viewModel),this._detach(this.container),this._set("container",null),this._emitter.clear(),this.render=()=>null,this._projector=null,I(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return s(e)}get domNode(){return this.container}set domNode(e){this.container=e}get icon(){return null}set icon(e){this._overrideIfSome("icon",e)}get id(){return this._get("id")||this.container?.id||Date.now().toString(16)+"-widget-"+x++}set id(e){e&&this._set("id",e)}get label(){return this.declaredClass.split(".").pop()}set label(e){this._overrideIfSome("label",e)}get renderable(){return this._resourcesFetch}get visible(){return this._get("visible")}set visible(e){this._set("visible",e)}get[($=E,w)](){return{projector:this._projector}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(I(this),this._projector.scheduleRender())}own(e){r(l.getLogger(this),"`Widget.own()` is deprecated in favor of 'Widget.addHandles()'",{replacement:"Widget.addHandles()",version:"4.28"}),this.addHandles(e)}classes(...e){return L.apply(this,e)}renderNow(){I(this),this._projector.renderNow()}_postInitialize(){if(this.destroyed)return;this.scheduleRender(),this._delegatedEventNames?.length&&this.addHandles(u((()=>this.viewModel),((e,t)=>{t&&this.removeHandles("delegated-events"),e&&a(e)&&this.addHandles(this._delegatedEventNames.map((t=>d(e,t,(e=>{this.emit(t,e)})))),"delegated-events")}),g)),this.postInitialize();const e=async()=>{await this._loadLocale().catch(n),this.scheduleRender()};this.addHandles([C(e),u((()=>this.uiStrings),e),m((()=>this.container),(e=>{this.destroyed||this._attach(e)}),{initial:!0,once:!0})])}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){this._attached&&(this._projector.detach(this.render),this._attached=!1),e?.parentNode?.removeChild(e)}};W[$]=!0,W.vnodeSelector="div",e([f()],W.prototype,"_readyForTrueRender",void 0),e([f({value:null})],W.prototype,"container",null),e([y("container")],W.prototype,"castContainer",null),e([f()],W.prototype,"icon",null),e([f()],W.prototype,"id",null),e([f()],W.prototype,"label",null),e([f()],W.prototype,"renderable",null),e([f()],W.prototype,"uiStrings",void 0),e([f()],W.prototype,"viewModel",void 0),e([f({value:!0})],W.prototype,"visible",null),e([f()],W.prototype,"key",void 0),e([f()],W.prototype,"children",void 0),e([f()],W.prototype,"afterCreate",void 0),e([f()],W.prototype,"afterUpdate",void 0),e([f()],W.prototype,"afterRemoved",void 0),W=e([j("esri.widgets.Widget")],W);const M=W;export{M as default};
