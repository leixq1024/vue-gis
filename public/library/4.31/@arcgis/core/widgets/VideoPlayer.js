/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{clone as t}from"../core/lang.js";import{watch as i,whenOnce as s,initial as o,syncAndInitial as r}from"../core/reactiveUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"../chunks/Logger.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import{f as n}from"../chunks/date.js";import c from"../Color.js";import"../geometry.js";import m from"../Viewpoint.js";import p from"../core/Accessor.js";import d from"../core/Evented.js";import{EsriPromiseMixin as u}from"../core/Promise.js";import h from"../layers/support/ExtentAndRotationGeoreference.js";import{M as g}from"../chunks/MediaElementView.js";import k from"../layers/support/VideoElement.js";import{DOMContainer as j}from"../views/DOMContainer.js";import{l as y}from"../chunks/viewpointUtils.js";import{V as v}from"../chunks/ViewStateManager.js";import{O as f}from"../chunks/Overlay.js";import{O as w}from"../chunks/OverlayContainer.js";import b from"../geometry/SpatialReference.js";import _ from"../geometry/Extent.js";import M from"./Slider.js";import x from"./Widget.js";import{l as V}from"../chunks/componentsUtils.js";import{g as C}from"../chunks/globalCss.js";import"../chunks/widgetUtils.js";import{m as S}from"../chunks/messageBundle.js";import{t as U}from"../chunks/jsxFactory.js";import O from"./VideoPlayer/VideoPlayerViewModel.js";import"../chunks/asyncUtils.js";import"../chunks/maybe.js";import"../core/promiseUtils.js";import"../chunks/handleUtils.js";import"../core/Error.js";import"../config.js";import"../core/Collection.js";import"../core/scheduling.js";import"../chunks/ensureType.js";import"../chunks/tracking.js";import"../chunks/utils.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/ObservableBase.js";import"../core/Handles.js";import"../chunks/metadata.js";import"../chunks/jsonMap.js";import"../chunks/locale.js";import"../chunks/datetime.js";import"../chunks/colorUtils.js";import"../chunks/mathUtils.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../chunks/unitUtils.js";import"../chunks/assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/writer.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../Camera.js";import"../CameraLayout.js";import"../core/Clonable.js";import"../chunks/Cyclical.js";import"../chunks/screenUtils.js";import"../chunks/common.js";import"../geometry/projection.js";import"../chunks/vec3f64.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/GeoreferenceBase.js";import"../chunks/normalizeUtilsSync.js";import"../chunks/normalizeUtilsCommon.js";import"../layers/support/MediaElementBase.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../chunks/MultiOriginJSONSupport.js";import"../layers/support/ControlPointsGeoreference.js";import"../chunks/perspectiveUtils.js";import"../chunks/mat3.js";import"../chunks/mat3f64.js";import"../chunks/vec2.js";import"../chunks/vec3.js";import"../chunks/vec2f64.js";import"../layers/support/CornersGeoreference.js";import"../chunks/persistableUrlUtils.js";import"../chunks/domUtils.js";import"../chunks/UpdatingHandles.js";import"../chunks/projector.js";import"../chunks/mat2d.js";import"../chunks/mat2df64.js";import"../geometry/support/normalizeUtils.js";import"../chunks/simplify.js";import"../chunks/utils9.js";import"../chunks/utils10.js";import"../views/2d/ViewState.js";import"../chunks/mat2df32.js";import"../chunks/mat3f32.js";import"../chunks/vec2f32.js";import"../chunks/enums2.js";import"../chunks/DisplayObject.js";import"../chunks/utils24.js";import"../chunks/grouping.js";import"../chunks/enums.js";import"../chunks/Texture.js";import"../chunks/GLObjectType.js";import"../chunks/vec3f32.js";import"../chunks/featureTechniqueUtils.js";import"../chunks/definitions.js";import"../chunks/WGLContainer.js";import"../chunks/dataViewUtils.js";import"../chunks/Program.js";import"../chunks/BufferObject.js";import"../chunks/VertexElementDescriptor.js";import"../chunks/BoundingBox.js";import"../chunks/VertexArrayObject.js";import"../chunks/WGLBrushVTLSymbol.js";import"../chunks/TiledDisplayObject.js";import"../chunks/TileKey2.js";import"../chunks/StyleDefinition.js";import"../chunks/config.js";import"../chunks/ShaderCompiler.js";import"../chunks/ProgramTemplate.js";import"../chunks/Container.js";import"../chunks/EffectView.js";import"../chunks/parser.js";import"../chunks/utils2.js";import"../chunks/mat4.js";import"../chunks/earcut.js";import"../chunks/featureConversionUtils.js";import"../chunks/aaBoundingBox.js";import"../chunks/OptimizedFeature.js";import"../chunks/OptimizedGeometry.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/clippingUtils.js";import"../chunks/Technique.js";import"../chunks/GraphShaderModule.js";import"../chunks/BindType.js";import"../chunks/Util.js";import"../chunks/vec4.js";import"../chunks/vec4f64.js";import"../intl.js";import"../chunks/number.js";import"../chunks/substitute.js";import"../chunks/messages.js";import"./Slider/SliderViewModel.js";import"../chunks/uuid.js";import"../chunks/jsxWidgetSupport.js";import"../chunks/videoUtils.js";import"../layers/support/TelemetryData.js";import"../layers/support/VideoTimeExtent.js";const D=new c("#000");let T;function P(e,t){const[i,s]=e,[o,r]=t,l=o/r,a=s*l,n=i/l;return i/s>=1?l>=1?a<=i?[a,s]:[i,n]:n<=s?[i,n]:[a,s]:l>=1?n<=s?[i,n]:[a,s]:a<=i?[a,s]:[i,n]}function E(e,t){const i=e&&y(e,t);return new m({targetGeometry:e.center,scale:i})}function B(e){return new _({xmin:0,ymin:0,xmax:e[0],ymax:e[1],spatialReference:{wkid:0}})}let $=class extends p{};$=e([a("esri.views.VideoView.Base")],$);let z=class extends(j(d.EventedMixin(u($)))){constructor(e){super(e),this.stateManager=new v,this._isValid=!1,this.layer=null,this.ready=!1,this.addHandles([i((()=>this.preconditionsReady),(e=>{e?this._startup():this._teardown()})),i((()=>this.layer),(()=>this.addResolvingPromise(s((()=>this.ready)))),o)])}initialize(){this.addResolvingPromise(async function(){const[,{Stage:e}]=await Promise.all([import("../chunks/webglDeps.js"),import("../chunks/mapViewDeps.js")]);T=e}().then((()=>(this._isValid=!0,s((()=>this.ready))))))}destroy(){this._teardown()}get state(){return this.stateManager.state}get preconditionsReady(){return!(!this._isValid||0===this.width||0===this.height||0===this.videoWidth||0===this.videoHeight)}get videoHeight(){return this.layer?.videoHeight||0}get videoWidth(){return this.layer?.videoWidth||0}_startup(){if(!this.layer)return;const e=P(this.size,[this.videoWidth,this.videoHeight]),t=B(e),s=E(t,e);this._mediaElementView=new g({element:new k({video:this.layer.videoElement,georeference:new h({extent:t}),autoplay:!1}),spatialReference:new b({wkid:0})}),this.stateManager.startup(s,this.size,s.targetGeometry.spatialReference);const o=new T(this.surface,{renderingOptions:{samplingMode:"dynamic",edgeLabelsVisible:!0,labelsAnimationTime:125,labelCollisionsEnabled:!0},backgroundColor:D});this.stage=o,this.addHandles([i((()=>this.state.id),(()=>o.state=this.state),r),this.on("resize",(({width:e,height:t})=>{if(this._mediaElementView){const i=P([e,t],[this.videoWidth,this.videoHeight]),s=B(i);this._mediaElementView.element.georeference=new h({extent:s}),this.stateManager.viewpoint=E(s,i),this.stateManager.resize(e,t)}}))],"video-view");const l=new f(this._mediaElementView);this.overlayContainer=new w,this.overlayContainer.addChild(l),this.stage.addChild(this.overlayContainer),this._set("ready",!0)}_teardown(){this.stage.destroy(),this.stage=null,this._mediaElementView=null,this.overlayContainer.removeAllChildren(),this.overlayContainer=null,this.removeHandles("video-view"),this._set("ready",!1),this.stateManager.teardown()}};e([l()],z.prototype,"stateManager",void 0),e([l({readOnly:!0})],z.prototype,"state",null),e([l()],z.prototype,"_isValid",void 0),e([l()],z.prototype,"layer",void 0),e([l({readOnly:!0})],z.prototype,"preconditionsReady",null),e([l({readOnly:!0})],z.prototype,"ready",void 0),e([l({readOnly:!0})],z.prototype,"videoHeight",null),e([l({readOnly:!0})],z.prototype,"videoWidth",null),z=e([a("esri.views.VideoView")],z);const G=z,L="esri-video-player",q={base:L,color:`${L}__color-block`,colorActive:`${L}__color-block__active`,colorPicker:`${L}__color-picker`,playerActions:`${L}__actions`,playerControls:`${L}__controls`,playerTimecode:`${L}__timecode`,playerToolbar:`${L}__toolbar`,progress:`${L}__progress`,rangeSlider:`${L}__range-slider`,settings:`${L}__settings`,settingsFlow:`${L}__settings-flow`,slider:`${L}__slider`,sliderProgressContainer:`${L}__slider-progress-container`,videoView:`${L}__video-view`},H="esri-metadata-table",I={table:H,data:`${H}__data`,emptyState:`${H}__empty-state`};function A({viewModel:e,messages:t}){const{metadata:i}=e;return i?U("calcite-block",{heading:t.metadata,open:!0},U("calcite-accordion",{appearance:"solid",selectionMode:"single"},U("calcite-accordion-item",{heading:t.missionInfo},U("div",{class:I.table},Object.keys(i.missionInfo).map((e=>[U("div",{class:I.data},e),U("div",{class:I.data},i.missionInfo[e])])))),U("calcite-accordion-item",{heading:t.platformInfo},U("div",{class:I.table},Object.keys(i.platformInfo).map((e=>[U("div",{class:I.data},e),U("div",{class:I.data},i.platformInfo[e])])))),U("calcite-accordion-item",{heading:t.frameInfo},U("div",{class:I.table},Object.keys(i.frameInfo).map((e=>[U("div",{class:I.data},e),U("div",{class:I.data},i.frameInfo[e])])))))):U("calcite-tile",{class:I.emptyState,description:t.metadataDescription,heading:t.metadataNotLoaded})}function F({viewModel:e,messages:t}){const{state:i,playing:s}=e,o="not-ready"===i||"waiting"===i,r=s?t.pause:t.play,l=U("calcite-action",{active:s,alignment:"center",bind:e,disabled:o,icon:s?"pause-f":"play-f",key:"play",onclick:s?e.pause:e.play,scale:"s",text:r,title:r}),a=t.reverse,n=U("calcite-action",{alignment:"center",bind:e,disabled:o,icon:"reverse-f",key:"reverse",onclick:e.seekBackward,scale:"s",text:a,title:a}),c=t.forward,m=U("calcite-action",{alignment:"center",bind:e,disabled:o,icon:"forward-f",key:"forward",onclick:e.seekForward,scale:"s",text:c,title:c}),p=t.beginning,d=U("calcite-action",{alignment:"center",bind:e,disabled:o,icon:"beginning-f",key:"beginning",onclick:e.seekToBeginning,scale:"s",text:p,title:p}),u=t.end,h=U("calcite-action",{alignment:"center",bind:e,disabled:o,icon:"end-f",key:"end",onclick:e.seekToEnding,scale:"s",text:u,title:u});return U("calcite-action-bar",{class:q.playerActions,expandDisabled:!0,layout:"horizontal",scale:"s"},[d,n,l,m,h])}const R={active:null,speed:"1x",quality:"Auto",color:null},W=new c([255,127,0]);let N=null;function J({viewModel:e,settings:t,messages:i}){const{state:s}=e,o="not-ready"===s||"waiting"===s,r=U("calcite-flow-item",{heading:i.playbackSpeed,key:"playback-speed",onCalciteFlowItemBack:()=>{t.active=null}},U("calcite-list",{selectionMode:"single-persist"},[{label:"0.25x",value:.25},{label:"0.5x",value:.5},{label:"1x",value:1},{label:"1.5x",value:1.5},{label:"2x",value:2}].map((({label:i,value:s})=>U("calcite-list-item",{key:i,label:i,onclick:()=>{t.speed=i,e.changePlaybackSpeed(s)},selected:i===t.speed}))))),l=U("calcite-flow-item",{heading:i.quality,key:`Quality (${t.quality})`,onCalciteFlowItemBack:()=>{t.active=null}},U("calcite-list",{selectionMode:"single-persist"},["Auto"].map((e=>U("calcite-list-item",{key:e,label:e,onclick:()=>{t.quality=e},selected:e===t.quality}))))),a=U("calcite-flow-item",{heading:i.graphics,key:`Graphics (${t.color})`,onCalciteFlowItemBack:()=>{t.active=null,t.color=N?new c(N):null,t.color&&e.changeGraphicsColor(t.color)}},U("calcite-block",{heading:i.color,open:!0},U("calcite-color-picker",{channelsDisabled:!0,format:"hex",savedDisabled:!0,scale:"s",value:t.color?.toHex()??W.toHex(),onCalciteColorPickerChange:e=>{N=e.target.value?.toString()}})));return U("div",{class:q.settings},U("calcite-popover",{autoClose:!0,label:i.settings,overlayPositioning:"fixed",placement:"top-end",pointerDisabled:!0,referenceElement:"settings-action",scale:"s"},U("calcite-flow",{class:q.settingsFlow,key:"root-flow"},U("calcite-flow-item",{closable:!1,heading:"Settings",key:"root-flow-item"},U("calcite-list",null,U("calcite-list-item",{key:`Speed (${t.speed})`,label:i.speed,onclick:()=>{t.active="speed"}},U("div",{slot:"content-end"},U("calcite-chip",{scale:"s",value:t.speed},t.speed)),U("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})),U("calcite-list-item",{key:`Quality (${t.quality})`,label:i.quality,onclick:()=>{t.active="quality"}},U("div",{slot:"content-end"},U("calcite-chip",{scale:"s",value:t.quality},t.quality)),U("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})),U("calcite-list-item",{key:`Graphics (${t.color})`,label:i.graphics,onclick:()=>{t.active="color"}},U("calcite-color-picker-swatch",{color:t.color?.toString()??W.toString(),scale:"s",slot:"content-end"}),U("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})))),"speed"===t.active?r:null,"quality"===t.active?l:null,"color"===t.active?a:null)),U("calcite-action",{alignment:"center",bind:e,disabled:o,icon:"sliders",id:"settings-action",key:"settings",scale:"s",slot:"trigger",text:i.settings}))}function Q(e){return"none"===e.followingMode?"circle-disallowed":"follow-sensor"===e.followingMode?"zoom-to-object":"follow-frame"===e.followingMode?"follow":"video"}function K({viewModel:e,messages:t,settings:i,toggleMetadata:s}){const{state:o}=e,r="not-ready"===o||"waiting"===o,l=U("div",null,U("calcite-popover",{autoClose:!0,label:t.layers,overlayPositioning:"fixed",placement:"top-end",pointerDisabled:!0,referenceElement:"layers-action",scale:"s"},U("calcite-panel",{heading:t.layers},U("calcite-list",{selectionMode:"multiple"},U("calcite-list-item",{label:t.sensor,onclick:()=>{e.toggleSensorDisplay()},selected:!!e.layer?.telemetryDisplay?.sensorLocation}),U("calcite-list-item",{label:t.sightLine,onclick:()=>{e.toggleSensorSightLineDisplay()},selected:!!e.layer?.telemetryDisplay?.lineOfSight}),U("calcite-list-item",{label:t.sensorTrail,onclick:()=>{e.toggleSensorTrailDisplay()},selected:!!e.layer?.telemetryDisplay?.sensorTrail}),U("calcite-list-item",{label:t.frameCenter,onclick:()=>{e.toggleFrameCenterDisplay()},selected:!!e.layer?.telemetryDisplay?.frameCenter}),U("calcite-list-item",{label:t.frameOutline,onclick:()=>{e.toggleFrameOutlineDisplay()},selected:!!e.layer?.telemetryDisplay?.frameOutline}),U("calcite-list-item",{label:t.frame,onclick:()=>{e.toggleFrameDisplay()},selected:!!e.layer?.telemetryDisplay?.frame})))),U("calcite-action",{alignment:"center",bind:e,disabled:r,icon:"layers",id:"layers-action",key:"layers",scale:"s",slot:"trigger",text:t.layers})),a=U("div",null,U("calcite-popover",{autoClose:!0,label:t.follow,overlayPositioning:"fixed",placement:"top-end",pointerDisabled:!0,referenceElement:"follow-action",scale:"s"},U("calcite-panel",{heading:t.follow},U("calcite-list",{selectionMode:"single-persist"},U("calcite-list-item",{label:t.none,onclick:()=>{e.followingMode="none"}},U("calcite-icon",{icon:"circle-disallowed",scale:"s",slot:"content-start"})),U("calcite-list-item",{label:t.sensor,onclick:()=>{e.followingMode="follow-sensor"}},U("calcite-icon",{icon:"zoom-to-object",scale:"s",slot:"content-start"})),U("calcite-list-item",{label:t.frame,onclick:()=>{e.followingMode="follow-frame"}},U("calcite-icon",{icon:"follow",scale:"s",slot:"content-start"})),U("calcite-list-item",{label:t.video,onclick:()=>{e.followingMode="follow-both"},selected:!0},U("calcite-icon",{icon:"video",scale:"s",slot:"content-start"}))))),U("calcite-action",{alignment:"center",bind:e,disabled:r,icon:Q(e),id:"follow-action",key:"follow",scale:"s",slot:"trigger",text:t.follow})),n=U(J,{messages:t,settings:i,viewModel:e}),c=U("calcite-action",{alignment:"center",bind:e,disabled:r,icon:"feature-details",key:"metadata",onclick:s,scale:"s",text:t.metadata});return U("calcite-action-bar",{class:q.playerControls,expandDisabled:!0,layout:"horizontal",scale:"s"},[l,a,n,c])}let X=class extends x{constructor(e,i){super(e,i),this._settings=t(R),this._metadataVisible=!1,this._slider=new M({visibleElements:{labels:!1,rangeLabels:!1},min:0,max:100,values:[0],thumbsConstrained:!1}),this.videoView=new G({container:document.createElement("div")}),this.viewModel=new O}initialize(){this.addHandles([i((()=>this.viewModel.layer),(()=>{this.videoView.layer=this.viewModel.layer}),o),this._slider.on(["thumb-change","thumb-drag"],(({value:e})=>{const t=e*this.viewModel.duration/100;this.viewModel.seekTo(t)}))])}loadDependencies(){return Promise.all([V({action:()=>import("../chunks/calcite-action.js"),"action-bar":()=>import("../chunks/calcite-action-bar.js")}),Promise.all([V({action:()=>import("../chunks/calcite-action.js"),"action-bar":()=>import("../chunks/calcite-action-bar.js"),panel:()=>import("../chunks/calcite-panel.js"),popover:()=>import("../chunks/calcite-popover.js"),list:()=>import("../chunks/calcite-list.js"),"list-item":()=>import("../chunks/calcite-list-item.js"),icon:()=>import("../chunks/calcite-icon.js")}),V({action:()=>import("../chunks/calcite-action.js"),flow:()=>import("../chunks/calcite-flow.js"),"flow-item":()=>import("../chunks/calcite-flow-item.js"),icon:()=>import("../chunks/calcite-icon.js"),list:()=>import("../chunks/calcite-list.js"),"list-item":()=>import("../chunks/calcite-list-item.js"),popover:()=>import("../chunks/calcite-popover.js"),block:()=>import("../chunks/calcite-block.js"),"color-picker":()=>import("../chunks/calcite-color-picker.js"),chip:()=>import("../chunks/calcite-chip.js"),"color-picker-swatch":()=>import("../chunks/calcite-color-picker-swatch.js")})]),V({accordion:()=>import("../chunks/calcite-accordion.js"),"accordion-item":()=>import("../chunks/calcite-accordion-item.js"),block:()=>import("../chunks/calcite-block.js"),tile:()=>import("../chunks/calcite-tile.js")}),V({progress:()=>import("../chunks/calcite-progress.js"),panel:()=>import("../chunks/calcite-panel.js"),scrim:()=>import("../chunks/calcite-scrim.js")})])}get icon(){return"video-web"}set icon(e){this._overrideIfSome("icon",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){return U("div",{class:this.classes(q.base,C.widget)},U("calcite-panel",{heading:this.layer?.title||"Video Player"},this._renderLoadingScrim(),this._renderBuffering(),this._renderVideoSection(),this._renderActionBar(),this._renderMetadataSection()))}_renderLoadingScrim(){const{state:e}=this.viewModel;return this.videoView.ready?null:U("calcite-scrim",{loading:"error"!==e},"error"===e?this.messages.errorLoadingLayer:null)}_renderBuffering(){const{currentTime:e,buffered:t,duration:i}=this.viewModel,s=t/(i||1),o=e/(i||1);return this.viewModel.ended||s>o?null:U("calcite-progress",{type:"indeterminate"})}_renderVideoSection(){const{buffered:e,currentTime:t,duration:i}=this.viewModel,s=this.videoView.container;if(!s)return null;s.className=q.videoView;const o=e/(i||1),r=t/(i||1);return this._slider.values=[100*r],U("section",{afterCreate:Z,bind:s},U("div",{class:q.sliderProgressContainer},U("progress",{class:q.progress,max:"1",value:`${o}`}),U("div",{class:q.slider},this._slider.render())))}_renderActionBar(){return U("div",{class:q.playerToolbar},U(F,{messages:this.messages,viewModel:this.viewModel}),U("div",{class:q.playerTimecode},Y(this.viewModel.currentTime)," / ",Y(this.viewModel.duration)),U(K,{messages:this.messages,settings:this._settings,toggleMetadata:()=>this._metadataVisible=!this._metadataVisible,viewModel:this.viewModel}))}_renderMetadataSection(){return this._metadataVisible?U(A,{messages:this.messages,viewModel:this.viewModel}):null}};function Y(e){return n(1e3*Math.round(e),{minute:"2-digit",second:"2-digit"})}function Z(e){e.prepend(this)}e([l()],X.prototype,"_settings",void 0),e([l()],X.prototype,"icon",null),e([l()],X.prototype,"layer",null),e([l(),S("esri/widgets/VideoPlayer/t9n/VideoPlayer")],X.prototype,"messages",void 0),e([l()],X.prototype,"videoView",void 0),e([l({type:O})],X.prototype,"viewModel",void 0),e([l()],X.prototype,"view",null),X=e([a("esri.widgets.VideoPlayer")],X);const ee=X;export{ee as default};
