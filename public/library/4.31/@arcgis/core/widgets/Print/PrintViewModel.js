/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../geometry.js";import e from"../../request.js";import{clone as o,i as s}from"../../core/lang.js";import i from"../../core/Collection.js";import r from"../../core/Error.js";import{J as a}from"../../chunks/jsonMap.js";import l from"../../core/Loadable.js";import{isAbortError as p}from"../../core/promiseUtils.js";import{R as n}from"../../chunks/ReactiveMap.js";import{watch as m,initial as u}from"../../core/reactiveUtils.js";import{c as h}from"../../chunks/screenUtils.js";import{y as c,n as d,g as y,a3 as f}from"../../chunks/unitUtils.js";import{property as j}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/Logger.js";import{subclass as v}from"../../core/accessorSupport/decorators/subclass.js";import{f as b,c as k}from"../../chunks/date.js";import{a as T}from"../../chunks/locale.js";import g from"../../portal/Portal.js";import w from"../../portal/PortalQueryParams.js";import{r as I}from"../../core/urlUtils.js";import{execute as _,getTasks as S,a as x,f as O}from"../../rest/print.js";import U from"../../rest/support/PrintParameters.js";import C from"../../rest/support/PrintTemplate.js";import{d as P}from"../../chunks/viewpointUtils.js";import{V as L}from"../../chunks/InputManager.js";import D from"../../core/Accessor.js";import"../../chunks/widgetUtils.js";import{t as E}from"../../chunks/jsxFactory.js";import F,{f as M}from"./CustomTemplate.js";import H from"./TemplateOptions.js";import W from"../../geometry/Extent.js";import R from"../../geometry/SpatialReference.js";import"../../chunks/ensureType.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/reader.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/metadata.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../config.js";import"../../chunks/assets.js";import"../../kernel.js";import"../../chunks/writer.js";import"../../geometry/Multipoint.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../core/Promise.js";import"../../chunks/asyncUtils.js";import"../../chunks/datetime.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../chunks/floorFilterUtils.js";import"../../chunks/visualVariableUtils.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../chunks/vec3f64.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/compilerUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/utils9.js";import"../../rest/geoprocessor.js";import"../../rest/geoprocessor/GPOptions.js";import"../../rest/support/JobInfo.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils10.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../layers/support/MapImage.js";import"../../rest/support/ArealUnit.js";import"../../chunks/networkEnums.js";import"../../rest/support/DataFile.js";import"../../rest/support/FeatureSet.js";import"../../rest/support/LinearUnit.js";import"../../rest/support/ParameterValue.js";import"../../rest/support/RasterData.js";import"../../rest/support/GPMessage.js";import"../../chunks/layerViewUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../Viewpoint.js";import"../../Camera.js";import"../../CameraLayout.js";import"../../chunks/Cyclical.js";import"../../chunks/common.js";import"../../chunks/mat2d.js";import"../../chunks/mat2df64.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../geometry/projection.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/Queue.js";import"../../core/signal.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/MD5.js";let $=class extends D{constructor(t){super(t),this.strokeDash=[],this.strokeWidth=2,this.strokeColor=[0,0,0,1],this.strokeBackgroundColor=[0,0,0,0],this.fillColor=[0,0,0,0],this.backgroundFillColor=[0,0,0,.5],this.visible=!0,this.isDecoration=!1,this.boxWidth=0,this.boxHeight=0,this.backgroundWidth=0,this.backgroundHeight=0,this.padding={left:0,top:0,right:0,bottom:0}}get _strokeStyle(){return`rgba(${this.strokeColor.join()})`}get _strokeBackgroundStyle(){return`rgba(${this.strokeBackgroundColor.join()})`}get _fillStyle(){return`rgba(${this.fillColor.join()})`}get _backgroundFillStyle(){return`rgba(${this.backgroundFillColor.join()})`}render(){const{backgroundWidth:t,backgroundHeight:e,boxWidth:o,boxHeight:s,padding:i}=this,r=i.left,a=i.top,l=this.x??r+t/2-o/2,p=this.y??a+e/2-s/2,n=l+o,m=p+s;return E("div",{classes:{"esri-box-overlay-item":!0},styles:{left:"0px",top:"0px",width:"100%",height:"100%",visibility:this.visible?"visible":"hidden"}},E("svg",{styles:{width:"100%",height:"100%"}},E("path",{d:`M ${r} ${a} L ${t+r} ${a} L ${t+r} ${e+a} L ${r} ${e+a} Z M ${l} ${p} L ${l} ${m} L ${n} ${m} L ${n} ${p} Z`,fill:this._backgroundFillStyle,stroke:this._strokeBackgroundStyle,"stroke-width":this.strokeWidth}),E("rect",{fill:this._fillStyle,height:s,stroke:this._strokeStyle,"stroke-dasharray":this.strokeDash.join(" ")||void 0,"stroke-width":this.strokeWidth,width:o,x:l,y:p})))}renderCanvas(){}};t([j()],$.prototype,"strokeDash",void 0),t([j()],$.prototype,"strokeWidth",void 0),t([j()],$.prototype,"strokeColor",void 0),t([j()],$.prototype,"strokeBackgroundColor",void 0),t([j()],$.prototype,"fillColor",void 0),t([j()],$.prototype,"backgroundFillColor",void 0),t([j()],$.prototype,"visible",void 0),t([j()],$.prototype,"isDecoration",void 0),t([j()],$.prototype,"boxWidth",void 0),t([j()],$.prototype,"boxHeight",void 0),t([j()],$.prototype,"backgroundWidth",void 0),t([j()],$.prototype,"backgroundHeight",void 0),t([j()],$.prototype,"x",void 0),t([j()],$.prototype,"y",void 0),t([j()],$.prototype,"padding",void 0),t([j({readOnly:!0})],$.prototype,"_strokeStyle",null),t([j({readOnly:!0})],$.prototype,"_strokeBackgroundStyle",null),t([j({readOnly:!0})],$.prototype,"_fillStyle",null),t([j({readOnly:!0})],$.prototype,"_backgroundFillStyle",null),$=t([v("esri.views.overlay.BoxOverlayItem")],$);const A=$,V=[30,144,255,255],B=[237,211,23,255],G=[216,48,32,255],z=new Set(["GISProfessionalStdUT","GISProfessionalAdvUT"]),q=/(\/GPServer\/).+/i,J=new a({inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers"}),N=i.ofType(F);function Q(t,e,o){e&&e.visible!==o&&t.layoutOptions&&(t.layoutOptions.elementOverrides?t.layoutOptions.elementOverrides[e.name]={visible:o}:t.layoutOptions.elementOverrides={[e.name]:{visible:o}})}let Z=class extends l{constructor(t){super(t),this._serviceTemplateCustomTextElements=null,this._templateIdToCustomTemplate=new n,this._isFreeHand=!1,this._freeHandWidth=0,this._freehandHeight=0,this._asyncPrintTaskUrl=null,this._layoutInfoTaskUrl=null,this.allowedFormats="all",this.allowedLayouts="all",this.browseTemplates=new N,this.defaultTemplates=new N,this.error=null,this.extraParameters=null,this.includeDefaultTemplates=!0,this.outSpatialReference=null,this.portal=g.getDefault(),this.portalTemplateIds=[],this.printServiceTemplates=new N,this.defaultTemplate=null,this.showPrintAreaEnabled=!1,this.printServiceUrl=null,this.printTimeout=12e4,this.templatesInfo=null,this.updateDelay=1e3,this.view=null,this.templateCustomTextElements=null,this.templateOptions=new H}initialize(){this.addHandles([m((()=>[this.showPrintAreaEnabled,this.view]),(()=>{this.showPrintAreaEnabled?this._enablePrintPreview():(this.removeHandles("overlay-handler"),this.view?.overlay?.removeItem(this._getOverlayItem()))})),m((()=>[this.templateOptions.layout,this.templateOptions.layoutItem]),(()=>{this.loaded&&this._processTemplateOptions()}))])}destroy(){this.removeHandles("overlay-handler"),this.view&&(this._overlayItem&&(this.view.overlay?.removeItem(this._overlayItem),this._overlayItem.destroy(),this._overlayItem=null),this.view=null)}get effectivePrintServiceUrl(){return this.printServiceUrl??null}get effectiveTemplateCustomTextElements(){if(!this._serviceTemplateCustomTextElements)return{};const t=o(this._serviceTemplateCustomTextElements);return this.templateCustomTextElements&&Object.keys(this.templateCustomTextElements).forEach((e=>{const o=t[e];if(o){const t=this.templateCustomTextElements?.[e];o.forEach((e=>{const[o]=Object.entries(e)[0];t?.forEach((t=>{const[s,i]=Object.entries(t)[0];o===s&&(e[o]=i)}))}))}})),Object.freeze(t)}get state(){return"loading"===this.loadStatus?"initializing":"failed"===this.loadStatus||this.error?"error":"loaded"===this.loadStatus&&this.view?.ready?"ready":"disabled"}async load(t){return this.addResolvingPromise(this._loadResources(t).catch((t=>this.error=t))),this}async print(t){const{view:e,extraParameters:o,updateDelay:s,outSpatialReference:i}=this;if(!e)throw new r("print:view-required","view is not set");!function(t){if(t.layoutOptions??={},t.layoutOptions.customTextElements??=[],!t.layoutOptions.customTextElements.find((t=>"date"in t))){const{customTextElements:e}=t.layoutOptions;let o=b(Date.now(),k("short-date"));"ar"===T()&&(o="‏"+o),e.push({date:o})}}(t);const a=this._getOverlayItem(),l=t.scalePreserved||!this.showPrintAreaEnabled?void 0:P(new W,e.viewpoint,"map-only"===t.layout?[t.exportOptions.width,t.exportOptions.height]:[a.boxWidth,a.boxHeight]),p=new U({view:e,template:t,extent:l,extraParameters:o,updateDelay:s,outSpatialReference:i});try{const e=!!t.layoutItem?.id&&(this.portalTemplateIds.includes(t.layoutItem.id)||this.browseTemplates.some((e=>e.layoutItem?.id===t.layoutItem?.id)));return await _(e&&this._asyncPrintTaskUrl?this._asyncPrintTaskUrl:this.effectivePrintServiceUrl,p,{timeout:this.printTimeout})}catch(t){throw new r("print:export-error","An error occurred while exporting the web map.",{error:t})}}toPrintTemplate({attributionEnabled:t,author:e,copyright:o,customTextElements:s,dpi:i,forceFeatureAttributes:a,format:l,height:p,id:n,includeTables:m,layout:u,layoutItem:h,legendEnabled:c,northArrowEnabled:d,scale:y,scaleEnabled:f,title:j,width:v}){if(!u&&!h)throw new r("print:layout-required","layout is not set");const b=new C({attributionVisible:t,forceFeatureAttributes:a,format:l,includeTables:m,layout:u,layoutItem:h,layoutOptions:{authorText:e||"",copyrightText:o||"",customTextElements:s,titleText:j||""},outScale:y??0,scalePreserved:f});if(v&&(b.exportOptions.width=v),p&&(b.exportOptions.height=p),i&&(b.exportOptions.dpi=i),b.layoutOptions){c||(b.layoutOptions.legendLayers=[]);const t=this.getLayoutTemplateById(n)?.mapSurroundInfoOptions;if(t){Q(b,t.northArrow[0],d);const e=t.scaleBar;for(const t of e)Q(b,t,f)}}return b}getLayoutTemplateById(t){return t?this._templateIdToCustomTemplate.get(t):null}async addPortalTemplate(t){if(!this.portal||!t?.id)return;try{t.loaded||await t.load()}catch{return void this.applyTemplate(this.defaultTemplate)}const e=new F({type:"browse-template",layoutInfoTaskUrl:this._layoutInfoTaskUrl,label:t.title,layoutItem:t});this._templateIdToCustomTemplate.set(e.id,e),this.browseTemplates.add(e)}removePortalTemplate(t){t.layoutItem&&this.templateOptions.id===t.layoutItem.id&&(this.defaultTemplate?this.applyTemplate(this.defaultTemplate):this.templateOptions.reset()),this.browseTemplates.remove(t),this._templateIdToCustomTemplate.delete(t.id)}async applyTemplate(t){if(!t)return void this.templateOptions.reset();!t.layout||!this.templatesInfo||this.templatesInfo.layout.choiceList.includes(t.layout)||(this.defaultTemplate?t=this.defaultTemplate:this.templateOptions.reset());const e=t.layout?this.effectiveTemplateCustomTextElements[t.layout]:null;await this.templateOptions.applyTemplate(t,e)}async _loadResources(t){if(this.destroyed)return;await this._loadUrls(t);const[e,o]=await Promise.all([this._getLayoutToLayoutTemplateInfos(t),this._getPrintServiceTemplatesInfo(t)]);await this._loadAllTemplates(e,o,t),this._processPrintServiceTemplatesInfo(o),await this._processTemplateOptions(),this._updateOverLayItem()}async _processTemplateOptions(){const{layout:t,layoutItem:e}=this.templateOptions;if("map-only"!==t&&!this.templateOptions.id)if(e?.id){try{e.loaded||await e.load()}catch{return void this.applyTemplate(this.defaultTemplate)}let t=this._templateIdToCustomTemplate.get(e.id);t||(t=new F({label:e.title,layoutItem:e,layoutInfoTaskUrl:this._layoutInfoTaskUrl}),this._templateIdToCustomTemplate.set(t.id,t)),await this.applyTemplate(t)}else if(t){const t=this.defaultTemplates.find((t=>t.layout===this.templateOptions.layout))??this.printServiceTemplates.find((t=>t.layout===this.templateOptions.layout));await this.applyTemplate(t??this.defaultTemplate)}}async _loadPortal(t){try{await this.portal.load(t)}catch(t){throw new r("print:could-not-load-portal","Cannot load print resource information from portal",{error:t,url:this.effectivePrintServiceUrl})}}async _loadUrls(t){if(this.printServiceUrl)this._set("effectivePrintServiceUrl",this.printServiceUrl),await this._updateLayoutInfoTaskUrl(this.effectivePrintServiceUrl);else{await this._loadPortal(t);const{printTask:e,asyncPrintTask:o,layoutInfoTask:s}=this.portal?.helperServices??{};this._set("effectivePrintServiceUrl",e?.url),this._asyncPrintTaskUrl=o?.url,await this._updateLayoutInfoTaskUrl(s?.url||this.effectivePrintServiceUrl)}const e=this.effectivePrintServiceUrl?.toLowerCase().split("/");if(!e?.includes("gpserver"))throw new r("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl})}async _updateLayoutInfoTaskUrl(t,e){if(!t)return;const o=(await S(t,e)).find((t=>t.includes("Get Layout Templates Info")));o&&(this._layoutInfoTaskUrl=t.replace(q,`$1${encodeURI(o)}`))}_getPortalDefaultTemplates(t,e){return this.portal?.helperServices?.printTask?.templates?.filter((t=>"map_only"!==t.layout.toLowerCase()&&(!e||e.includes(x(t.layout)))))?.map((e=>{const o=F.fromJSON(e);if(o.type="default-template",o.layoutInfoTaskUrl=this._layoutInfoTaskUrl,o.layout){const e=t.get(o.layout);e&&o.setLayoutTemplateInfo(e)}return o}))??[]}async _getPortalCustomTemplates(t){if(this.printServiceUrl||!this.portal)return[];const{layoutGroupQuery:e,user:o}=this.portal,s=I.test(this.portal.url),i=o?.userLicenseTypeId,r=i&&z.has(i);if(!e||s&&!r)return[];const a=new w({query:e,disableExtraQuery:!0}),l=await this.portal.queryGroups(a,t);if(!l.total)return[];const p=l.results[0],n=new w({num:100,query:"type:Layout",sortField:p.sortField,sortOrder:p.sortOrder??void 0}),m=(await p.queryItems(n,t)).results;return m.length?m.map((t=>(this.portalTemplateIds.push(t.id),new F({type:"default-template",label:t.title,layoutItem:t,layoutInfoTaskUrl:this._layoutInfoTaskUrl})))):[]}async _loadAllTemplates(t,e,o){let s=!1;const i=e?.layout?.choiceList;if(this.includeDefaultTemplates&&this.portal&&!this.printServiceUrl){const e=this._getPortalDefaultTemplates(t,i);s=!!e.length,this.defaultTemplates.addMany(e);const r=await this._getPortalCustomTemplates(o);this.defaultTemplates.addMany(r);for(const t of this.defaultTemplates)this._templateIdToCustomTemplate.set(t.id,t)}s||t.forEach(((t,e)=>{if(!i||i.includes(e)){const o=new F({type:"print-service-template",layout:e,layoutInfoTaskUrl:this._layoutInfoTaskUrl});o.setLayoutTemplateInfo(t),this.printServiceTemplates.add(o),this._templateIdToCustomTemplate.set(o.id,o)}}))}_processPrintServiceTemplatesInfo(t){this._set("templatesInfo",t);const e=t?.layout?.defaultValue;if(e&&"map-only"!==e){const t=this.defaultTemplates.find((t=>t.layout===e))??this.printServiceTemplates.find((t=>t.layout===e))??this.defaultTemplates.at(0)??this.printServiceTemplates.at(0);this._set("defaultTemplate",t)}}async _getLayoutToLayoutTemplateInfos(t){const e=await M(this._layoutInfoTaskUrl,void 0,t),o=new Map,s={};for(const t of e){const e=x(t.layoutTemplate);o.set(e,t),s[e]=t.layoutOptions.customTextElements}return this._serviceTemplateCustomTextElements=Object.freeze(s),o}async _getPrintServiceTemplatesInfo(t){let o;try{({data:o}=await e(this.effectivePrintServiceUrl,{...t,query:{f:"json"},timeout:this.printTimeout}))}catch(t){throw p(t)?t:new r("print:unavailable-service-info","Can't fetch templates info from service",{error:t})}const{parameters:s}=o,i=s.find((({name:t})=>"Format"===t)),a=s.find((({name:t})=>"Layout_Template"===t));return{format:this._getFormat(i),layout:this._getLayout(a)}}_getFormat(t){const e="all"===this.allowedFormats?t.choiceList:t.choiceList.filter((t=>"string"!=typeof this.allowedFormats&&this.allowedFormats.some((e=>new RegExp(`\\b${e}\\b`,"i").test(t))))),o=(e.length?e:t.choiceList).map((t=>O.fromJSON(t))).filter(s),i=O.fromJSON(t.defaultValue),r=o.some((t=>new RegExp(`\\b${i}\\b`,"i").test(t)))?i:o[0];return{choiceList:o,defaultValue:r}}_getLayout(t){const e=t.choiceList.filter((t=>"map_only"!==t.toLowerCase())),o="all"===this.allowedLayouts?e:e.filter((t=>this.allowedLayouts.includes(x(t)))),i=(o.length?o:e).map(x).filter(s),r=x(t.defaultValue),a=i.includes(r)?r:i.find((t=>/(?=.*letter)(?=.*landscape)/i.test(t)))??i.find((t=>/(?=.*a4)(?=.*landscape)/i.test(t)))??i[0];return{choiceList:i,defaultValue:a}}_getOverlayItem(){return this._overlayItem||(this._overlayItem=new A({strokeDash:[5],strokeWidth:2,strokeColor:[30,144,255,255]})),this._overlayItem}_enablePrintPreview(){if(!this.view?.overlay)return;const t=this.templateOptions,e=this._getOverlayItem();this.addHandles([m((()=>[t.width,t.height,t.scaleEnabled,t.scale,t.layout,t.layoutItem,t.id,t.state,this.view?.scale,this.view?.size,this.view?.state.paddedViewState.size,this.view?.state.padding,this.loaded]),(()=>this._updateOverLayItem()),u),this.view?.on("drag",["Shift"],(t=>this._handleDrag(t)),L.WIDGET),this.view?.on("key-down",["Escape"],(()=>this._resetDrag()),L.WIDGET)],"overlay-handler"),this.view.overlay.addItem(e)}_updateOverLayItem(){if(!this.view)return;const t=this.templateOptions,e=this._getOverlayItem(),o=t.layoutItem?.id??t.layout,s=this.view,i=s.spatialReference,[r,a]=s.state.paddedViewState.size,l=s.state.padding;let p=0,n=0;if("map-only"===o)null!=t.width&&null!=t.height&&(p=t.width,n=t.height);else if(o){const e=t.id?this._templateIdToCustomTemplate.get(t.id):null,{webMapFrameSize:o,pageUnits:s}=e?.layoutTemplateInfo??{};let l=!1;if(o&&s)if(this._isFreeHand){const t=o[0]/o[1];p=this._freeHandWidth,n=this._freehandHeight,p>n?n=p/t:p=n*t}else{const t=J.fromJSON(s.toLowerCase()),e=i.unit;c(t)===c(e)?(p=d(o[0],t,e),n=d(o[1],t,e)):(l=!0,p=o[0],n=o[1])}if(!this._isFreeHand)if(t.scaleEnabled&&t.scale){const e=l?Math.min(r/p,a/n):y(i)*f*t.dpi;p*=e,n*=e}else if(0===p||0===n)p=r,n=a;else{const t=(r-.1*r)/p,e=(a-.1*a)/n,o=Math.min(t,e);p*=o,n*=o}}const{scaleEnabled:m,scale:u}=t,h=m&&u?u/this.view.scale:1;if(e.boxWidth=p*h||r,e.boxHeight=n*h||a,l&&(e.padding=l),e.backgroundWidth=r??0,e.backgroundHeight=a??0,"loading"===this.loadStatus)e.strokeColor=B;else if("loaded"===this.loadStatus)switch(this.templateOptions.state){case"pending":e.strokeColor=B;break;case"ready":e.strokeColor=V;break;case"error":e.strokeColor=G}}_resetDrag(){this._isFreeHand=!1,this._updateOverLayItem()}_handleDrag(t){switch(t.action){case"start":this._start();break;case"update":this._update(t);break;case"end":this._end()}t.stopPropagation()}_start(){this._isFreeHand=!0}_update(t){const e=this._getOverlayItem(),{x:o,y:s}=t,{x:i,y:r}=t.origin;o>i?(e.x=i,e.boxWidth=o-i):(e.x=o,e.boxWidth=i-o),s>r?(e.y=r,e.boxHeight=s-r):(e.y=s,e.boxHeight=r-s)}_end(){const t=this._getOverlayItem();if(!this.view||null==t.x||null==t.y)return;const e=this.view,o=e.toMap(h(t.x+.5*t.boxWidth,t.y+.5*t.boxHeight));t.x=null,t.y=null,e.goTo({center:o}),this._freeHandWidth=t.boxWidth,this._freehandHeight=t.boxHeight,"map-only"===this.templateOptions.layout&&(this.templateOptions.width=this._freeHandWidth,this.templateOptions.height=this._freehandHeight),this.templateOptions.scale=this.view.scale,this._updateOverLayItem()}};t([j()],Z.prototype,"_serviceTemplateCustomTextElements",void 0),t([j()],Z.prototype,"_templateIdToCustomTemplate",void 0),t([j()],Z.prototype,"allowedFormats",void 0),t([j()],Z.prototype,"allowedLayouts",void 0),t([j({type:N})],Z.prototype,"browseTemplates",void 0),t([j({type:N})],Z.prototype,"defaultTemplates",void 0),t([j()],Z.prototype,"error",void 0),t([j()],Z.prototype,"extraParameters",void 0),t([j()],Z.prototype,"includeDefaultTemplates",void 0),t([j({readOnly:!0})],Z.prototype,"effectivePrintServiceUrl",null),t([j()],Z.prototype,"effectiveTemplateCustomTextElements",null),t([j({type:R})],Z.prototype,"outSpatialReference",void 0),t([j({type:g})],Z.prototype,"portal",void 0),t([j()],Z.prototype,"portalTemplateIds",void 0),t([j({type:N})],Z.prototype,"printServiceTemplates",void 0),t([j({readOnly:!0})],Z.prototype,"defaultTemplate",void 0),t([j()],Z.prototype,"showPrintAreaEnabled",void 0),t([j()],Z.prototype,"printServiceUrl",void 0),t([j()],Z.prototype,"printTimeout",void 0),t([j({readOnly:!0})],Z.prototype,"state",null),t([j({readOnly:!0})],Z.prototype,"templatesInfo",void 0),t([j()],Z.prototype,"updateDelay",void 0),t([j()],Z.prototype,"view",void 0),t([j()],Z.prototype,"templateCustomTextElements",void 0),t([j({type:H})],Z.prototype,"templateOptions",void 0),Z=t([v("esri.widgets.Print.PrintViewModel")],Z);const K=Z;export{K as default};
