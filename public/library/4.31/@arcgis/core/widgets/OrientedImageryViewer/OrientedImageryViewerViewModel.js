/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../geometry.js";import t from"../../Graphic.js";import"../../symbols.js";import{i as r,e as i,equalsShallow as s}from"../../core/lang.js";import{c as o}from"../../chunks/asyncUtils.js";import a from"../../core/Collection.js";import{d as n}from"../../core/Accessor.js";import l from"../../core/Error.js";import p from"../../core/Evented.js";import{JSONSupport as m,isSerializable as c}from"../../core/JSONSupport.js";import{L as u}from"../../chunks/Logger.js";import{c as h,r as d,d as g}from"../../chunks/mathUtils.js";import{d as y,a as f}from"../../chunks/maybe.js";import{EsriPromise as j}from"../../core/Promise.js";import{throwIfNotAbortError as v,throwIfAborted as w,isAbortError as b,waitTick as k}from"../../core/promiseUtils.js";import{R as I}from"../../chunks/ReactiveMap.js";import{watch as _,syncAndInitial as F,sync as M,when as S,initial as P,on as R}from"../../core/reactiveUtils.js";import{sqlAnd as C}from"../../core/sql.js";import{h as x,b as V,g as O}from"../../chunks/unitUtils.js";import{property as A}from"../../core/accessorSupport/decorators/property.js";import{subclass as L}from"../../core/accessorSupport/decorators/subclass.js";import{U}from"../../chunks/UpdatingHandles.js";import{union as T}from"../../geometry/geometryEngineAsync.js";import{projectWithZConversion as D}from"../../geometry/projection.js";import{i as z}from"../../chunks/coordsUtils.js";import{geographicToWebMercator as H}from"../../geometry/support/webMercatorUtils.js";import G from"../../layers/GraphicsLayer.js";import E,{c as B,a as N,b as W,g as q,C as Z,o as J,d as $}from"../../layers/OrientedImageryLayer.js";import{ClonableMixin as Q}from"../../core/Clonable.js";import{cast as K}from"../../core/accessorSupport/decorators/cast.js";import{e as X}from"../../chunks/enumeration.js";import{r as Y}from"../../chunks/reader.js";import{w as ee}from"../../chunks/writer.js";import{g as te}from"../../chunks/zscale.js";import{E as re,k as ie,F as se,G as oe,f as ae,s as ne,m as le,h as pe,H as me,q as ce,I as ue,J as he,K as de,L as ge,M as ye,N as fe,O as je,P as ve,Q as we,R as be,S as ke,t as Ie,T as _e,U as Fe,V as Me,W as Se,p as Pe,X as Re,e as Ce,Y as xe,Z as Ve,_ as Oe,$ as Ae,D as Le,worldToImagePanoramic as Ue,a0 as Te,worldToImage as De,a1 as ze,w as He,a2 as Ge,o as Ee,a3 as Be}from"../../layers/orientedImagery/transformations/worldToImage.js";import Ne,{d as We}from"../../geometry/Point.js";import qe from"../../rest/support/Query.js";import Ze from"../../geometry/Extent.js";import{c as Je}from"../../chunks/mat3f64.js";import{z as $e}from"../../chunks/vec3f64.js";import{t as Qe}from"../../chunks/mat3.js";import{j as Ke,g as Xe}from"../../chunks/vec3.js";import Ye from"../../geometry/Circle.js";import et from"../../geometry/Mesh.js";import tt from"../../geometry/support/MeshComponent.js";import{M as rt}from"../../chunks/MeshVertexAttributes.js";import{i as it,c as st,J as ot}from"../../chunks/plane.js";import at from"../../geometry/Polygon.js";import nt from"../../geometry/SpatialReference.js";import lt from"../../geometry/Multipoint.js";import{a as pt,i as mt}from"../../chunks/ElevationSourceDefinitions.js";import{imageToWorld as ct,imageToWorldPanoramic as ut,u as ht}from"../../layers/orientedImagery/transformations/imageToWorld.js";import{a as dt}from"../../chunks/floorFilterUtils.js";import gt from"../../rest/support/AttachmentQuery.js";import{s as yt}from"../../chunks/drawUtils.js";import{V as ft}from"../../chunks/InputManager.js";import jt from"../../Camera.js";import vt from"../../views/SceneView.js";import wt from"../Widget.js";import bt from"../../Ground.js";import kt from"../../Map.js";import It from"../../request.js";import{J as _t}from"../../chunks/jsonMap.js";import Ft from"../Zoom.js";import Mt from"../Zoom/ZoomViewModel.js";import St from"../../geometry/support/MeshMaterial.js";import Pt from"../../geometry/support/MeshTexture.js";import Rt from"../../symbols/MeshSymbol3D.js";import Ct from"../../symbols/FillSymbol3DLayer.js";import{g as xt}from"../../chunks/globalCss.js";import"../../chunks/widgetUtils.js";import{v as Vt}from"../../chunks/vmEvent.js";import{t as Ot}from"../../chunks/jsxFactory.js";import At from"../../symbols/CIMSymbol.js";import Lt from"../../symbols/SimpleMarkerSymbol.js";import Ut from"../../symbols/SimpleFillSymbol.js";import Tt from"../../symbols/PointSymbol3D.js";import Dt from"../../symbols/IconSymbol3DLayer.js";import zt from"../../symbols/ObjectSymbol3DLayer.js";import Ht from"../../views/MapView.js";import{rotate as Gt,intersect as Et,nearestCoordinate as Bt}from"../../geometry/geometryEngine.js";import Nt from"../../layers/ImageryTileLayer.js";import Wt from"../../layers/support/RasterFunction.js";import{convolutionKernel as qt}from"../../layers/support/rasterFunctionConstants.js";import Zt from"../../layers/support/TileInfo.js";import{p as Jt}from"../../chunks/viewpointUtils.js";import $t from"../../symbols/SimpleLineSymbol.js";import Qt from"../../geometry/Polyline.js";import"../../chunks/ensureType.js";import"../../geometry/Geometry.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../config.js";import"../../chunks/assets.js";import"../../core/urlUtils.js";import"../../kernel.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/zmUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../PopupTemplate.js";import"../../layers/support/fieldUtils.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/GraphicsCollection.js";import"../../layers/Layer.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/utils2.js";import"../../chunks/mat4.js";import"../../chunks/common.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/layerUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/Version2.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/OverrideHelper.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/utils7.js";import"../../chunks/enums2.js";import"../../chunks/quantizationUtils.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../form/support/elements.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../chunks/Input.js";import"../../form/elements/inputs/attachments/support/inputs.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils8.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../chunks/formUtils.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../chunks/arcgisLayerUrl.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../chunks/EditBusLayer.js";import"../../chunks/uuid.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties2.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/support/elements.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../layers/support/Subtype.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../chunks/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/portalItemUtils.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/AlphaCutoff.js";import"../../chunks/interfaces2.js";import"../../chunks/languageUtils.js";import"../../chunks/TimeOnly.js";import"../../chunks/ImmutableArray.js";import"../../chunks/shared2.js";import"../../chunks/number2.js";import"../../chunks/mat4f64.js";import"../../chunks/vec32.js";import"../../layers/ElevationLayer.js";import"../../layers/mixins/ArcGISCachedService.js";import"../../chunks/TileInfoTilemapCache.js";import"../../chunks/TilemapCache.js";import"../../chunks/ByteSizeUnit.js";import"../../chunks/TileKey.js";import"../../layers/support/LOD.js";import"../../chunks/LercDecoder.js";import"../../chunks/WorkerHandle.js";import"../../layers/ImageryLayer.js";import"../../layers/mixins/ArcGISImageService.js";import"../../rasterRenderers.js";import"../../renderers/FlowRenderer.js";import"../../renderers/RasterColormapRenderer.js";import"../../renderers/support/ColormapInfo.js";import"../../chunks/colorRampUtils.js";import"../../renderers/RasterShadedReliefRenderer.js";import"../../renderers/RasterStretchRenderer.js";import"../../chunks/stretchRendererUtils.js";import"../../renderers/VectorFieldRenderer.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils9.js";import"../../chunks/utils10.js";import"../../chunks/vectorFieldUtils.js";import"../../layers/support/PixelBlock.js";import"../../chunks/pixelRangeUtils.js";import"../../chunks/utils12.js";import"../../symbols/support/cimSymbolUtils.js";import"../../layers/support/DimensionalDefinition.js";import"../../layers/support/MosaicRule.js";import"../../chunks/imageBitmapUtils.js";import"../../layers/support/MultidimensionalSubset.js";import"../../layers/support/RasterInfo.js";import"../../layers/support/RasterBandInfo.js";import"../../layers/support/RasterSensorInfo.js";import"../../chunks/RasterJobHandler.js";import"../../chunks/multidimensionalUtils.js";import"../../chunks/RasterSymbolizer.js";import"../../chunks/_commonjsHelpers.js";import"../../chunks/stretchUtils.js";import"../../chunks/rasterRendererHelper.js";import"../../chunks/generateRendererUtils.js";import"../../rest/imageService.js";import"../../rest/support/FindImagesParameters.js";import"../../rest/support/FindImagesResult.js";import"../../rest/support/ImageInspectionInfo.js";import"../../rest/support/CameraInfoMixin.js";import"../../rest/support/ImageAngleParameters.js";import"../../rest/support/ImageAngleResult.js";import"../../rest/support/ImageAreaParameters.js";import"../../rest/support/BaseImageMeasureParameters.js";import"../../rest/support/ImageAreaResult.js";import"../../rest/support/BaseImageMeasureResult.js";import"../../rest/support/ImageBoundaryParameters.js";import"../../rest/support/ImageBoundaryResult.js";import"../../rest/support/ImageDistanceParameters.js";import"../../rest/support/ImageDistanceResult.js";import"../../rest/support/ImageGPSInfoParameters.js";import"../../rest/support/ImageGPSInfoResult.js";import"../../rest/support/CameraInfo.js";import"../../rest/support/ImageGPSInfo.js";import"../../rest/support/ImageHeightParameters.js";import"../../rest/support/ImageHeightResult.js";import"../../rest/support/ImageHistogramParameters.js";import"../../rest/support/ImageIdentifyParameters.js";import"../../rest/support/ImageIdentifyResult.js";import"../../rest/support/ImagePixelLocationParameters.js";import"../../rest/support/ImagePixelLocationResult.js";import"../../rest/support/ImagePointParameters.js";import"../../rest/support/ImagePointResult.js";import"../../rest/support/ImageSampleParameters.js";import"../../rest/support/ImageSampleResult.js";import"../../rest/support/ImageSample.js";import"../../rest/support/ImageToMapMultirayParameters.js";import"../../rest/support/ImageToMapParameters.js";import"../../rest/support/ImageUrlParameters.js";import"../../rest/support/ImageUrlResult.js";import"../../rest/support/MapToImageParameters.js";import"../../rest/support/MeasureAreaFromImageResult.js";import"../../rest/support/MeasureFromImageParameters.js";import"../../rest/support/MeasureLengthFromImageResult.js";import"../../chunks/fetchRasterInfo.js";import"../../chunks/executeForIds.js";import"../../chunks/query.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/executeQueryJSON.js";import"../../chunks/dataUtils.js";import"../../layers/mixins/RasterPresetRendererMixin.js";import"../../renderers/support/RasterPresetRenderer.js";import"../../layers/support/ElevationSampler.js";import"../../chunks/ElevationTile.js";import"../../chunks/ElevationSamplerData.js";import"../../chunks/requestPresets.js";import"../../layers/mixins/ImageryTileMixin.js";import"../../chunks/RawBlockCache.js";import"../../chunks/rasterProjectionHelper.js";import"../../chunks/QueueProcessor.js";import"../../core/signal.js";import"../../chunks/rasterFunctionHelper.js";import"../../chunks/focalStatUtils.js";import"../../chunks/xmlUtilities.js";import"../../chunks/GCSShiftTransform.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/axisAngleDegrees.js";import"../../chunks/quat.js";import"../../chunks/quatf64.js";import"../../geometry/support/MeshGeoreferencedVertexSpace.js";import"../../geometry/support/MeshLocalVertexSpace.js";import"../../geometry/support/MeshTransform.js";import"../../chunks/meshVertexSpaceUtils.js";import"../../chunks/triangulationUtils.js";import"../../chunks/earcut.js";import"../../chunks/Indices.js";import"../../chunks/deduplicate.js";import"../../chunks/projectPointToVector.js";import"../../chunks/vertexSpaceConversion.js";import"../../chunks/spatialReferenceEllipsoidUtils.js";import"../../chunks/computeTranslationToOriginAndRotation.js";import"../../chunks/BufferView.js";import"../../chunks/vec2.js";import"../../chunks/vec42.js";import"../../chunks/External.js";import"../../chunks/infoFor3D.js";import"../../chunks/imageUtils.js";import"../../geometry/support/MeshTextureTransform.js";import"../../geometry/support/MeshMaterialMetallicRoughness.js";import"../../chunks/meshProperties.js";import"../../chunks/vec2f64.js";import"../../chunks/mathUtils2.js";import"../../chunks/ray.js";import"../../chunks/sphere.js";import"../../chunks/deepClone.js";import"../../CameraLayout.js";import"../../chunks/Cyclical.js";import"../../Viewpoint.js";import"../../chunks/domUtils.js";import"../../chunks/projectBoundingRect.js";import"../../chunks/boundedPlane.js";import"../../chunks/lineSegment.js";import"../../chunks/RenderCoordsHelper.js";import"../../chunks/projectVectorToPoint.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/dehydratedPoint.js";import"../../chunks/dehydratedFeatureUtils.js";import"../../chunks/ViewingMode.js";import"../../chunks/scaleUtils.js";import"../../views/View.js";import"../../chunks/CollectionFlattener.js";import"../../views/BasemapView.js";import"../../chunks/collectionUtils2.js";import"../../views/Magnifier.js";import"../../chunks/selectionUtils.js";import"../../views/Theme.js";import"../../chunks/ViewEvents.js";import"../../chunks/IViewEvents.js";import"../../chunks/interfaces.js";import"../../chunks/screenUtils2.js";import"../../views/input/Input.js";import"../../views/input/gamepad/GamepadSettings.js";import"../../views/input/gamepad/GamepadInputDevice.js";import"../../views/navigation/Navigation.js";import"../../chunks/a11yUtils.js";import"../../views/navigation/gamepad/GamepadSettings.js";import"../../chunks/heightModelInfoUtils.js";import"../../chunks/projectionUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../chunks/editableLayers.js";import"../../layers/catalog/catalogUtils.js";import"../../chunks/basemapUtils.js";import"../../support/LayersMixin.js";import"../../support/TablesMixin.js";import"../../views/BreakpointsOwner.js";import"../../views/DOMContainer.js";import"../../chunks/projector.js";import"../../views/GroundView.js";import"../../chunks/cameraUtils.js";import"../../chunks/Intersector3.js";import"../../chunks/intersectorUtils.js";import"../../chunks/verticalOffsetUtils.js";import"../../chunks/orientedBoundingBox.js";import"../../chunks/Attribute.js";import"../../chunks/frustum.js";import"../../chunks/earthUtils.js";import"../../chunks/ElevationProvider.js";import"../../chunks/spatialReferenceSupport.js";import"../../chunks/TerrainConst.js";import"../../views/PopupView.js";import"../../views/ViewAnimation.js";import"../../chunks/RenderGeometry.js";import"../../chunks/GridLocalOriginFactory.js";import"../../chunks/Material.js";import"../../chunks/interfaces3.js";import"../../chunks/VertexAttribute.js";import"../../chunks/StencilUtils.js";import"../../chunks/Util.js";import"../../chunks/triangle.js";import"../../chunks/basicInterfaces.js";import"../../chunks/Matrix4PassUniform.js";import"../../chunks/BindType.js";import"../../chunks/ShaderTechniqueConfiguration.js";import"../../chunks/debugFlags2.js";import"../../chunks/requestImageUtils.js";import"../../chunks/enums.js";import"../../chunks/Texture.js";import"../../chunks/GLObjectType.js";import"../../chunks/renderState.js";import"../../chunks/RibbonLineMaterial.js";import"../../chunks/sdfPrimitives.js";import"../../chunks/doublePrecisionUtils.js";import"../../chunks/floatRGBA.js";import"../../chunks/Octree.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/types.js";import"../../chunks/RgbaFloatEncoding.glsl.js";import"../../chunks/SceneLighting.js";import"../../chunks/NormalAttribute.glsl.js";import"../../chunks/VertexPosition.glsl.js";import"../../chunks/Matrix3DrawUniform.js";import"../../views/3d/webgl/RenderCamera.js";import"../../chunks/weather.js";import"../../views/3d/environment/CloudyWeather.js";import"../../views/3d/environment/FoggyWeather.js";import"../../views/3d/environment/RainyWeather.js";import"../../views/3d/environment/SnowyWeather.js";import"../../views/3d/environment/SunnyWeather.js";import"../../chunks/ScreenSpacePass.glsl.js";import"../../chunks/Float4DrawUniform.js";import"../../chunks/MergedRenderer.js";import"../../chunks/NestedMap.js";import"../../chunks/glUtil.js";import"../../chunks/VertexElementDescriptor.js";import"../../views/3d/webgl.js";import"../../views/3d/webgl/RenderNode.js";import"../../chunks/HighlightDefaults.js";import"../../chunks/VertexArrayObject2.js";import"../../chunks/VertexArrayObject.js";import"../../chunks/BufferObject.js";import"../../chunks/HUDRenderStyle.js";import"../../chunks/Intersector.js";import"../../chunks/Scheduler.js";import"../../chunks/debugFlags.js";import"../../chunks/vec3f32.js";import"../../chunks/Program.js";import"../../chunks/ShadowCastVisualizeTechniqueConfiguration.js";import"../../views/3d/environment/SunLighting.js";import"../../webscene/SunLighting.js";import"../../views/3d/environment/VirtualLighting.js";import"../../webscene/VirtualLighting.js";import"../../webscene/Environment.js";import"../../chunks/lightingTypes.js";import"../../webscene/background/Background.js";import"../../webscene/background/ColorBackground.js";import"../../chunks/ElevationUpdateEvent.js";import"../../chunks/ElevationContext.js";import"../../chunks/hydratedFeatures.js";import"../../chunks/graphicUtils.js";import"../../chunks/vec2f32.js";import"../../chunks/RayIntersections.js";import"../../chunks/HUDVisibility.glsl.js";import"../../chunks/VerticalOffset.glsl.js";import"../../chunks/dehydratedFeatures.js";import"../../chunks/featureConversionUtils.js";import"../../chunks/edgeUtils.js";import"../../chunks/DecodeSymbolColor.glsl.js";import"../../chunks/GeometryUtil.js";import"../../chunks/LodResources.js";import"../../chunks/DefaultMaterial.js";import"../../chunks/GLTextureMaterial.js";import"../../chunks/VertexColor.glsl.js";import"../../chunks/Matrix4sPassUniform.js";import"../../chunks/CameraSpace.glsl.js";import"../../chunks/WebGLRequirements.js";import"../../chunks/capabilities2.js";import"../../chunks/ray2.js";import"../../chunks/viewpointUtils2.js";import"../../chunks/NormalFromDepth.glsl.js";import"../../views/ui/UI.js";import"../../chunks/themeUtils.js";import"../../chunks/unitFormatUtils.js";import"../../chunks/quantityUtils.js";import"../../chunks/messageBundle.js";import"../../chunks/ZoomMomentumEstimator.js";import"../../chunks/HUDMaterial.js";import"../../chunks/labelFormatUtils.js";import"../../chunks/NormalUtils.glsl.js";import"../../chunks/fontUtils.js";import"../../chunks/LodRenderer.js";import"../../chunks/Intersector2.js";import"../../chunks/FeaturePipelineRenderManager.js";import"../../chunks/elevationInfoUtils.js";import"../../chunks/hitTest.js";import"../../chunks/LayerConstants.js";import"../../chunks/intersectorUtilsConversions.js";import"../../chunks/ElevationRange.js";import"../../chunks/HighlightOptions.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/terrainUtils.js";import"../../views/3d/support/SceneViewPerformanceInfo.js";import"../../chunks/LayerViewPerformanceInfo.js";import"../../views/3d/support/LayerPerformanceInfo.js";import"../../chunks/vec33.js";import"../../chunks/wosrLoader.js";import"../../chunks/ElevationQueryTileCache.js";import"../../chunks/Normals.js";import"../../chunks/TileStrategy.js";import"../../chunks/TileKey2.js";import"../../chunks/mat3f32.js";import"../../chunks/RenderableTile.js";import"../../chunks/config.js";import"../../chunks/StyleDefinition.js";import"../../chunks/enums3.js";import"../../chunks/GeometryUtils.js";import"../../chunks/TiledDisplayObject.js";import"../../chunks/DisplayObject.js";import"../../chunks/resources.js";import"../../chunks/ShaderTechniqueRepository.js";import"../../chunks/Blit.js";import"../../views/3d/webgl/ManagedFBO.js";import"../../chunks/testSVGPremultipliedAlpha.js";import"../../chunks/RenderingContext.js";import"../../chunks/ProgramCache.js";import"../../chunks/screenshotUtils.js";import"../../chunks/layerViewUtils.js";import"../../views/ui/DefaultUI.js";import"../Attribution.js";import"../Attribution/AttributionViewModel.js";import"../../chunks/accessibleHandler.js";import"../../chunks/componentsUtils.js";import"../../chunks/jsxWidgetSupport.js";import"../Compass.js";import"../Compass/CompassViewModel.js";import"../../chunks/duration.js";import"../../chunks/utils22.js";import"../support/GoTo.js";import"../NavigationToggle.js";import"../NavigationToggle/NavigationToggleViewModel.js";import"../../views/View2D.js";import"../../chunks/ViewStateManager.js";import"../../views/2d/ViewState.js";import"../../chunks/mat2d.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2df64.js";import"../../chunks/unitBezier.js";import"../../chunks/rbush.js";import"../../chunks/quickselect.js";import"../../chunks/Tile.js";import"../../chunks/util2.js";import"../../chunks/definitions.js";import"../../chunks/featureTechniqueUtils.js";import"../../chunks/clippingUtils.js";import"../../chunks/highlightGroupUtils.js";import"../../chunks/Timeline.js";import"../../chunks/utils6.js";import"../../chunks/Version.js";import"../../webmap/background/ColorBackground.js";import"../../chunks/geometryEngineBase.js";import"../../chunks/hydrated.js";let Kt=class{static getCameraOrientation(e){return B(e)}static register(e,t,r){N.set(e,{desc:t,constructor:r})}};Kt=e([L("esri.layers.orientedImagery.core.cameraOrientationFactory")],Kt);const Xt=Kt,Yt=e=>({cast:e=>{const t=parseFloat(e);return Number.isFinite(t)?t:void 0},json:{name:e,write:{writer:(e,t,r)=>{t[r]=Number.isFinite(e)?e:void 0}}}}),er=e=>({cast:e=>"string"==typeof e?e.split(";").map(Number):e,json:{default:e,write:{writer:(e,t,r)=>{t[r]=e?.join(";")}}}});let tr=class extends(Q(m)){constructor(e){super(e),this.cameraOrientation=null,this.elevation=null,this.elevationSource=null,this.name=null,this.sourceMap=null}read(e,t){const r={},{attributes:i,layer:s,geometry:o}=e,a={};for(const e in i)r[e.toLowerCase()]=i[e],a[e.toLowerCase()]=e;super.read({geometry:o,layer:s??{},sourceMap:a,...r},t)}write(e,t){const r=super.write(e,t),{sourceMap:i}=this;if(!i||!r)return r;const s={};for(const e in r){const t=i[e.toLowerCase()];t&&(s[t]=r[e])}return s}readCameraHeading(e,t){const{cameraheading:r,camheading:i,layer:s}=t;return r??i??s.cameraHeading}readCameraHeight(e,t){const{cameraheight:r,avghtag:i,layer:s}=t;return r??i??s.cameraHeight}readCamOffset(e,t){const{cameraoffset:r,camoffset:i}=t;return r?.split(";").map(Number)??i?.split(";").map(Number)??null}writeCameraOffset(e,t){e&&(t.cameraOffset=e.join(";"))}readCameraOrientation(e,t){const{cameraorientation:r,camori:i}=t;return r??i}readCameraPitch(e,t){const{camerapitch:r,campitch:i,layer:s}=t;return r??i??s.cameraPitch}readCameraRoll(e,t){const{cameraroll:r,camroll:i,layer:s}=t;return r??i??s.cameraRoll}readDepthImage(e,t){const{depthimage:r,depthimg:i,layer:s}=t,o=r??i??null,{depthImagePathPrefix:a,depthImagePathSuffix:n}=s??{};return W(o,a,n)}readElevationSource(e,t){const{elevationsource:r,layer:i}=t,{demPathSuffix:s,demPathPrefix:o}=i;if(r){const e=this._parseIfJSON(r);return q(e,o,s)}return i.effectiveElevationSource}readFarDistance(e,t){const{fardistance:r,fardist:i,layer:s}=t;return r??i??s.farDistance}readHFOV(e,t){const{horizontalfieldofview:r,hfov:i,layer:s}=t;return r??i??s.horizontalFieldOfView}readImageURL(e,t){const{imagepath:r,layer:i}=t;r||function(e,t){throw new l("exposure-point:missing-attribute-value","a value for imagePath is missing in attribute table",{exposurePoint:t})}(0,this);const{imagePathPrefix:s,imagePathSuffix:o}=i;return W(r,s,o)}readImageRotation(e,t){const{imagerotation:r,imgrot:i,layer:s}=t;return r??i??s.imageRotation}get isHorizontal(){return"horizontal"===this.orientedImageryType}get isInspection(){return"inspection"===this.orientedImageryType}get isNadir(){return"nadir"===this.orientedImageryType}get isOblique(){return"oblique"===this.orientedImageryType}get isSpherical(){return"360"===this.orientedImageryType}get location(){const{cameraOrientation:e,cameraHeight:t,elevation:r}=this;if(e){const{type:t,x:r,y:i,z:s,horizontalWKID:o,verticalWKID:a}=e,n="number"==typeof o?{wkid:o}:{wkt:o};if(t===Z.LTP){const{latitude:t,longitude:r,ellipsoidRadius:i,squaredEccentricity:s,properties:o}=e,{x:a,y:n,z:l}=o;return new Ne(re([a,n,l],[t,r,i,s]))}const l=new Ne({x:r,y:i,z:s,spatialReference:n}),p=a?te("point",{wkid:a},n):null;return p&&p(l),l}if("number"!=typeof t)throw function(){throw new l("exposure-point:missing-default-value","a value for cameraHeight is missing in default properties")}();const i=this.geometry.clone();return i.z=i.hasZ?i.z:(r??0)+t,i}set matrix(e){if(!e||9!==e.length)return u.getLogger(this).warn("Ignoring rotation matrix because it doesn't have 9 values",{value:e}),void this._set("matrix",null);this._set("matrix",e)}readNearDistance(e,t){const{neardistance:r,neardist:i,layer:s}=t;return r??i??s.nearDistance}readOrientationAccuracy(e,t){const{accuracy:r,orientationaccuracy:i}=t;return i?.split(";").map(Number)??r?.split(";").map(Number)??null}writeOrientationAccuracy(e,t){e&&(t.orientationAccuracy=e.join(";"))}readOIType(e,t){const{orientedimagerytype:r,oitype:i,camerapitch:s,campitch:o,layer:a}=t,n=J.read(r??i??a.orientedImageryType),l=s??o??a.cameraPitch;return"oblique"===n?l<10?"nadir":"oblique":n}set radial(e){if(e)if("string"!=typeof e)this._set("radial",e);else{const[t,r,i]=e.split(";").map(Number);this._set("radial",[t??0,r??0,i??0])}else this._set("radial",[0,0,0])}set tangential(e){if(e)if("string"!=typeof e)this._set("tangential",e);else{const[t,r]=e.split(";").map(Number);this._set("tangential",[t??0,r??0])}else this._set("tangential",[0,0])}readVFOV(e,t){const{verticalfieldofview:r,vfov:i,layer:s}=t;return r??i??s.verticalFieldOfView}_parseIfJSON(e){let t=null;try{t=JSON.parse(e)}catch(t){u.getLogger(this).error("couldn't parse the given elevation source JSON",e,t)}return t}};e([A(Yt())],tr.prototype,"a0",void 0),e([A(Yt())],tr.prototype,"a1",void 0),e([A(Yt())],tr.prototype,"a2",void 0),e([A({type:Date,json:{write:{enabled:!0,target:"acquisitionDate"},name:"acquisitiondate"}})],tr.prototype,"acquisitionDate",void 0),e([A(Yt())],tr.prototype,"b0",void 0),e([A(Yt())],tr.prototype,"b1",void 0),e([A(Yt())],tr.prototype,"b2",void 0),e([A({type:Number,json:{write:!0,read:{source:["cameraheading","camheading","layer.cameraHeading"]}}})],tr.prototype,"cameraHeading",void 0),e([Y("cameraHeading")],tr.prototype,"readCameraHeading",null),e([A({type:Number,json:{write:!0}})],tr.prototype,"cameraHeight",void 0),e([Y("cameraHeight",["cameraheight","avghtag","layer.cameraHeight"])],tr.prototype,"readCameraHeight",null),e([A()],tr.prototype,"cameraOffset",void 0),e([Y("cameraOffset",["cameraoffset","camoffset"])],tr.prototype,"readCamOffset",null),e([ee("cameraOffset")],tr.prototype,"writeCameraOffset",null),e([A({json:{write:{writer:(e,t,r)=>{t[r]=e.toString()}}},type:$}),K((e=>e?Xt.getCameraOrientation(e):null))],tr.prototype,"cameraOrientation",void 0),e([Y("cameraOrientation",["cameraorientation","camori"])],tr.prototype,"readCameraOrientation",null),e([A({type:Number,json:{write:!0}})],tr.prototype,"cameraPitch",void 0),e([Y("cameraPitch",["camerapitch","campitch","layer.cameraPitch"])],tr.prototype,"readCameraPitch",null),e([A({type:Number,json:{write:!0}})],tr.prototype,"cameraRoll",void 0),e([Y("cameraRoll",["cameraroll","camroll","layer.cameraRoll"])],tr.prototype,"readCameraRoll",null),e([A({json:{write:!0},type:String})],tr.prototype,"depthImage",void 0),e([Y("depthImage",["depthimage","depthimg"])],tr.prototype,"readDepthImage",null),e([A({type:Number,json:{write:!0}})],tr.prototype,"elevation",void 0),e([A({json:{write:!0},clonable:"reference"})],tr.prototype,"elevationSource",void 0),e([Y("elevationSource",["elevationsource","layer.effectiveElevationSource"])],tr.prototype,"readElevationSource",null),e([A({json:{name:"exposurestationid",write:{target:"exposureStationId"}},type:String})],tr.prototype,"exposureStationId",void 0),e([A({type:Number,json:{write:!0}})],tr.prototype,"farDistance",void 0),e([Y("farDistance",["fardistance","fardist","layer.farDistance"])],tr.prototype,"readFarDistance",null),e([A(Yt("focallength"))],tr.prototype,"focalLength",void 0),e([A({type:Ne,json:{name:"geometry"}})],tr.prototype,"geometry",void 0),e([A({type:Number,json:{write:!0}})],tr.prototype,"horizontalFieldOfView",void 0),e([Y("horizontalFieldOfView",["horizontalfieldofview","hfov","layer.horizontalFieldOfView"])],tr.prototype,"readHFOV",null),e([A({json:{write:!0},type:String})],tr.prototype,"imagePath",void 0),e([Y("imagePath",["imagepath"])],tr.prototype,"readImageURL",null),e([A({type:Number,json:{write:!0}})],tr.prototype,"imageRotation",void 0),e([Y("imageRotation",["imagerotation","imgrot","layer.imageRotation"])],tr.prototype,"readImageRotation",null),e([A()],tr.prototype,"isHorizontal",null),e([A()],tr.prototype,"isInspection",null),e([A()],tr.prototype,"isNadir",null),e([A()],tr.prototype,"isOblique",null),e([A()],tr.prototype,"isSpherical",null),e([A()],tr.prototype,"location",null),e([A(er())],tr.prototype,"matrix",null),e([A({json:{write:!0},type:String})],tr.prototype,"name",void 0),e([A({type:Number,json:{write:!0}})],tr.prototype,"nearDistance",void 0),e([Y("nearDistance",["neardistance","neardist","layer.nearDistance"])],tr.prototype,"readNearDistance",null),e([A({json:{write:!0,name:"objectid"},type:Number})],tr.prototype,"objectId",void 0),e([A()],tr.prototype,"orientationAccuracy",void 0),e([Y("orientationAccuracy",["accuracy","orientationaccuracy"])],tr.prototype,"readOrientationAccuracy",null),e([ee("orientationAccuracy")],tr.prototype,"writeOrientationAccuracy",null),e([X(J)],tr.prototype,"orientedImageryType",void 0),e([Y("orientedImageryType",["orientedimagerytype","oitype","layer.orientedImageryType"])],tr.prototype,"readOIType",null),e([A({type:Number,json:{write:!0}})],tr.prototype,"principalX",void 0),e([A({type:Number,json:{write:!0}})],tr.prototype,"principalY",void 0),e([A(er([0,0,0]))],tr.prototype,"radial",null),e([A({type:Number,json:{name:"sortorder",write:{target:"sortOrder"}}})],tr.prototype,"sortOrder",void 0),e([A({type:Object})],tr.prototype,"sourceMap",void 0),e([A(er([0,0]))],tr.prototype,"tangential",null),e([A({type:Number,json:{write:!0}})],tr.prototype,"verticalFieldOfView",void 0),e([Y("verticalFieldOfView",["verticalfieldofview","vfov","layer.verticalFieldOfView"])],tr.prototype,"readVFOV",null),tr=e([L("esri.layers.orientedImagery.core.ExposurePoint")],tr);const rr=tr,ir={},sr=Math.PI/180;function or(e){return e.isSpherical?function(e){const{geometry:t,farDistance:r,objectId:i,nearDistance:s,cameraHeight:o}=e,a=ie(t.y,t.spatialReference),n=new Ye({center:t.clone(),radius:r*a});if(n.imageID=i,s){const e=new Ye({center:t.clone(),radius:s*a});n.addRing(e.rings[0])}const l=t.clone();l.z=o-r*a;const p=et.createSphere(l,{size:2*r*a});return p.imageID=i,{polygon:n,frustum:p}}(e):function(e){const{horizontalFieldOfView:t,verticalFieldOfView:r,geometry:i,cameraHeading:s}=e,o=ie(i.y,i.spatialReference);let a=e.cameraPitch,n=e.cameraRoll??0,l=150;t>150&&(a=90,n=0,l=5);const p=Math.ceil(t/l),m=function(e,t,r){const i=[];if(e%2==0)for(let s=0;s<e/2;s++)i.push(t-r/e*(s+.5),t+r/e*(s+.5));else{i.push(t);for(let s=1;s<e/2;s++)i.push(t-r/e*s,t+r/e*s)}return i.sort(),i}(p,s,t);let c=e.farDistance?e.farDistance*o:e.cameraHeight*o/Math.cos(a*sr);e.cameraPitch+r/2>=90&&(c=(e.farDistance||20)*o);const u=new at({spatialReference:i?.spatialReference});u.imageID=e.objectId;let h=null;for(const s of m)h=ar(s,a,e.cameraHeight,i,c,o,r,t,p,u,n,e.nearDistance);return h.imageID=e.objectId,{polygon:u,frustum:h}}(e)}function ar(e,t,r,i,s,o,a,n,l,p,m=0,c=0){const u=Qe(Je(),se([e,t,m??0])),h=function(e,t){const{cameraHeight:r,cameraPitch:i,farDistance:s,location:o,horizontalFieldOfView:a,nearDistance:n,verticalFieldOfView:l}=e,p=lr(o),m=i+l/2>=90==0,c=2*Math.tan(l*sr/2)*n,u=2*Math.tan(a*sr/2)*n,h=2*Math.tan(l*sr/2)*s,d=2*Math.tan(a*sr/2)*s;let g,y;y=[0,0,-1],y=oe(y,t),g=ae([o.x,o.y,r],y,s,p),m&&(g[2]=0);const f=ae([o.x,o.y,r],y,n,p);let j=[0,1,0];j=oe(j,t);let v=[1,0,0];v=oe(v,t);let w=[],b=[];n?(b=[{faces:[4,0,3,4,7,3]},{faces:[5,1,2,5,6,2]},{faces:[4,0,1,4,5,1]},{faces:[6,2,3,6,7,3]}],w=w.concat(Xe($e(),f,Ke($e(),ne(j,c/2,p),ne(v,u/2,p)))),w=w.concat(Xe($e(),f,Xe($e(),ne(j,c/2,p),ne(v,u/2,p)))),w=w.concat(Ke($e(),f,Ke($e(),ne(j,c/2,p),ne(v,u/2,p)))),w=w.concat(Ke($e(),f,Xe($e(),ne(j,c/2,p),ne(v,u/2,p))))):(w=[o.x,o.y,r],b=[{faces:[0,1,2,0,2,3,0,3,4,0,4,1]}]),w=w.concat(Xe($e(),g,Ke($e(),ne(j,h/2,p),ne(v,d/2,p)))),w=w.concat(Xe($e(),g,Xe($e(),ne(j,h/2,p),ne(v,d/2,p)))),w=w.concat(Ke($e(),g,Ke($e(),ne(j,h/2,p),ne(v,d/2,p)))),w=w.concat(Ke($e(),g,Xe($e(),ne(j,h/2,p),ne(v,d/2,p))));const k=new rt({position:Float64Array.from(w)});return new et({vertexAttributes:k,components:b,spatialReference:o.spatialReference})}({cameraHeight:r,cameraPitch:t,farDistance:s,location:i,horizontalFieldOfView:n,nearDistance:c,verticalFieldOfView:a},u),d=oe([0,0,-1],u),{x:g,y}=i,f=ae([g,y,r],d,s,o),j=2*Math.tan(a*sr/2)*s,v=2*Math.tan(n/l*sr/2)*s,w=oe([0,1,0],u),b=oe([1,0,0],u),k=ne(w,j/2,o),I=ne(b,v/2,o),_=Ke($e(),k,I),F=Xe($e(),k,I),M=function(e,t,r,i){return e.map((e=>function(e,t,r,i){{const s=Math.sqrt((e[2]-t)**2+(Math.sqrt((e[0]-r.x)**2+(e[1]-r.y)**2)/i)**2)*i,o=ne(Ke($e(),[e[0],e[1],e[2]],[r.x,r.y,t]),1/s,1/i),a=t/(t-e[2]),n={x:(1-a)*r.x+a*e[0],y:(1-a)*r.y+a*e[1],z:(1-a)*t+a*e[2]},l=Math.sqrt((n.z-t)**2+(Math.sqrt((n.x-r.x)**2+(n.y-r.y)**2)/i)**2)*i,p=ne(Ke($e(),[n.x,n.y,n.z],[r.x,r.y,t]),1/l,1/i);return nr(o[0],p[0])&&nr(o[1],p[1])&&nr(o[2],p[2])||e[2]>=0?[e[0],e[1],0]:[n.x,n.y,n.z]}}(e,t,r,i)))}([Xe($e(),f,_),Xe($e(),f,F),Ke($e(),f,_),Ke($e(),f,F)],r,i,o);return M.push(M[0]),p.addRing(M),h}function nr(e,t){return Math.sign(e)!==Math.sign(t)}function lr(e){return e&&V(e?.spatialReference)?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*e.y/x.radius))):1}async function pr(e,t,r){const{cameraHeight:i,cameraLocation:s,cameraPitch:o,frustumVertices:a,horizontalFieldOfView:n,imageHeight:l,imageWidth:p,inSRS:m,outSRS:c,verticalFieldOfView:u,cameraRoll:h,options:d}=r,g=new nt(m),y=new nt(c),f=le(n,u,h??0),j=a.length>15;return o+f.vfov/2>=90?await async function(e,t,r,i,s,o,a,n){let l,p=a?new Array:[e[0],e[1],e[2]],m=new Array;for(const s of t)a?(l=pe([s[0],s[1],1],[[0,0,1],[r,0,1],[r,i,1],[0,i,1]],[[e[0],e[1],e[2]],[e[3],e[4],e[5]],[e[6],e[7],e[8]],[e[9],e[10],e[11]]]),p=p.concat(...l),l=pe([s[0],s[1],1],[[0,0,1],[r,0,1],[r,i,1],[0,i,1]],[[e[12],e[13],e[14]],[e[15],e[16],e[17]],[e[18],e[19],e[20]],[e[21],e[22],e[23]]]),m=m.concat(...l)):(l=pe([s[0],s[1],1],[[0,0,1],[r,0,1],[r,i,1],[0,i,1]],[[e[3],e[4],e[5]],[e[6],e[7],e[8]],[e[9],e[10],e[11]],[e[12],e[13],e[14]]]),p=p.concat(...l));p=p.concat(m);const c=await ur(p,s,o,n),u=fr(c);return new et({vertexAttributes:new rt({position:c}),components:yr(a?dr(u,!0):gr(u,!0)),spatialReference:o})}(a,e,p,l,g,y,j,d):await async function(e,t,r,i,s,o,a,n,l){const p=function(e,t,r,i,s){const o=hr(e),a=hr(e,"near");if(!o)return;const n=t.length;for(let e=0;e<n;e++){const t=Array.from(r[e]),n=[t[0]-i[0],t[1]-i[1],t[2]-(i[2]??s)];cr(i,n,e,a),mr(i,n,e,o)}return{farPlane:o,nearPlane:a}}(e,t,r,i,s);if(!p)return;const{farPlane:m,nearPlane:c}=p,u=await ur([...c?.vertexPositions??e.slice(0,3),...m.vertexPositions],a,n,l),h=fr(u);return new et({vertexAttributes:new rt({position:u}),components:yr(o?dr(h,!0):gr(h,!0)),spatialReference:n})}(a,e,t,s,i,j,g,y,d)}function mr(e,t,r,i){const{coefficients:s,vertexPositions:o}=i,a=$e();it(s,{origin:e,direction:t},a)&&o.splice(3*r,3,...a)}function cr(e,t,r,i){if(!i)return;const s=$e();it(i.coefficients,{origin:e,direction:t},s)&&i.vertexPositions.splice(3*r,3,...s)}async function ur(e,t,r,i){if(t.equals(r))return e;const s=e.reduce(((e,t,r)=>{const i=Math.floor(r/3);return e[i]||(e[i]=new Array),e[i].push(t),e}),new Array),{points:o}=await D(new lt(s,t),r,i);return w(i),o.flat()}function hr(e,t="far"){const r=st();let i;switch(t){case"far":if(i=Array.from(15===e.length?e.slice(3):e.slice(12)),ot(r,i,!0))return{coefficients:r,vertexPositions:i};break;case"near":if(i=Array.from(e.slice(0,12)),15===e.length||!ot(r,i,!0))return;return{coefficients:r,vertexPositions:i}}}const dr=(e,t=!1)=>{if(t&&e-2<=4||e<=4||e%2!=0)throw new Error("Invalid number of vertices");const r=[],i=e/2,s=Math.round((t?e-2:e)/2);for(let o=0;o<s;o++){const s=o+i,a=t?s+1:s,n=a%e,l=(t?s:a+1)%e;r.push({faces:new Uint32Array([o,l,n,o,o+1,n])})}return r};function gr(e,t=!1){if(e<3||t&&e-1<3)throw new Error("Invalid number of vertices");const r=[],i=t?e-2:e-1;for(let e=0;e<i;e++)r.push({faces:new Uint32Array([0,e+1,e+2])});return r}const yr=e=>e.map((e=>new tt(e))),fr=e=>e.length/3;let jr=class extends(Q(m)){constructor(e){super(e),this.maxFOV=0,this.minFOV=0,this.view=null,this.zoomFactor=5}get canZoomIn(){return!!this.view&&(0===this.minFOV||this.view.camera.fov>this.minFOV)}get canZoomOut(){return!!this.view&&(0===this.maxFOV||this.view.camera.fov<this.maxFOV)}};e([A({type:Boolean,readOnly:!0})],jr.prototype,"canZoomIn",null),e([A({type:Boolean,readOnly:!0})],jr.prototype,"canZoomOut",null),e([A({type:Number})],jr.prototype,"maxFOV",void 0),e([A({type:Number})],jr.prototype,"minFOV",void 0),e([A({type:vt})],jr.prototype,"view",void 0),e([A({type:Number})],jr.prototype,"zoomFactor",void 0),jr=e([L("esri.widgets.PanoramicViewer.PanoramicZoomConditions")],jr);const vr=jr;let wr=class extends Mt{constructor(e){super(e),this.panoramicZoomConditions=new vr,this.zoomTo=e=>{this.view.camera.fov=this.constrainFOV(e),this.view.camera=this.view.camera.clone()}}initialize(){this.addHandles([_((()=>[this.view?.ready,this.panoramicZoomConditions]),(()=>{this.view?.ready&&(this.panoramicZoomConditions.view=this.view,this.zoomTo(this.view.camera.fov))}),F),_((()=>[this.panoramicZoomConditions.maxFOV,this.panoramicZoomConditions.minFOV]),(([e,t])=>{null!=e&&null!=t&&this.zoomTo(this.view.camera.fov)}),M)])}get canZoomIn(){return this.panoramicZoomConditions.canZoomIn}get canZoomOut(){return this.panoramicZoomConditions.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){this._set("view",e)}constrainFOV(e){const{maxFOV:t,minFOV:r}=this.panoramicZoomConditions;return h(e,r,t)}zoomIn(){if(!this.canZoomIn)return;const e=this.view.camera.fov-this.panoramicZoomConditions.zoomFactor;this.zoomTo(e)}zoomOut(){if(!this.canZoomOut)return;const e=this.view.camera.fov+this.panoramicZoomConditions.zoomFactor;this.zoomTo(e)}};e([A()],wr.prototype,"canZoomIn",null),e([A()],wr.prototype,"canZoomOut",null),e([A({type:vr})],wr.prototype,"panoramicZoomConditions",void 0),e([A()],wr.prototype,"state",null),e([A({type:vt})],wr.prototype,"view",null),wr=e([L("esri.widgets.PanoramicViewer.PanoramicZoomViewModel")],wr);const br=wr;function kr(e,t){return 2*d(Math.atan(Math.tan(g(e/2))*Math.sqrt(t**2+1)))}const Ir="navigation",_r="fov-constraint";let Fr=class extends p.EventedAccessor{constructor(e){super(e),this._startPosition=null,this._targetPosition=null,this._graphics=new G({elevationInfo:{mode:"relative-to-ground"}}),this._imageGraphic=null,this._loadController=null,this._map=new kt({ground:new bt({opacity:0,navigationConstraint:null}),layers:new a([this._graphics])}),this._zoomViewModel=null,this.autoLoad=!1,this.clickAction="none",this.imageSize=null,this.imageSource=null,this.pitch=90,this.state="ready",this.yaw=0,this._addNavigationHandles=()=>{this.imageRenderer.basemapTerrain.suspended=!0,this.imageRenderer.constraints.tilt.max=180,this.removeHandles(Ir),this.addHandles([this.imageRenderer.on("mouse-wheel",this._handleWheel),this.imageRenderer.on("double-click",this._handleDoubleClick),this.imageRenderer.on("drag",this._handleDrag),this.imageRenderer.on("key-down",(e=>{const t=e.key;["+","-","Shift","_","=","ArrowUp","ArrowDown","ArrowRight","ArrowLeft"].includes(t)&&e.stopPropagation()}))],Ir)},this._addHFOVHandles=()=>{this.removeHandles(_r),this.addHandles(_((()=>[this.maxHFOV,this.minHFOV]),(()=>{this._zoomViewModel&&(this._zoomViewModel.panoramicZoomConditions=new vr({view:this.imageRenderer,maxFOV:this.maxHFOV,minFOV:this.minHFOV}))}),F),_r)},this._addZoomHandles=()=>{this._zoomViewModel=new br({view:this.imageRenderer,panoramicZoomConditions:new vr({maxFOV:this.maxHFOV,minFOV:this.minHFOV})});const e=new Ft({viewModel:this._zoomViewModel});this.imageRenderer.ui.add(e,"top-left"),this._addHFOVHandles()},this._cancelLoadWithController=()=>{this._loadController?.abort(),this._loadController=null},this._handleDoubleClick=e=>{e.stopPropagation(),e.native.ctrlKey?this._zoomOut():this._zoomIn()},this._handleDrag=e=>{e.stopPropagation();const{action:t,x:r,y:i}=e;switch(t){case"start":this._startPosition=this._targetPosition={x:r,y:i};break;case"update":this._targetPosition={x:r,y:i},this._updateCameraHeadingAndTilt()}},this._handleImageClick=e=>{if("image-loaded"===this.state&&this.imageRenderer.ready)switch(this.clickAction){case"emit":e.stopPropagation(),this.emit("click",e);break;case"hittest":e.stopPropagation(),e.async((async()=>{const t=await this.imageRenderer.hitTest(e.screenPoint,{include:this._graphics});this.emit("hittest-response",t)}));break;case"pixel-location":{if(e.stopPropagation(),!this.imageSize||!e.mapPoint)return void this.emit("pixel-location",null);const t=ue(e.mapPoint,this.imageSize[0],this.imageSize[1]);this.emit("pixel-location",{...t,spatialReference:nt.WebMercator});break}}},this._handleWheel=e=>{const t=e.deltaX??e.native.deltaX;e.stopPropagation(),t>0||e.deltaY>0?this._zoomOut():this._zoomIn()},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._zoomIn=()=>this._zoomViewModel?.zoomIn(),this._zoomOut=()=>this._zoomViewModel?.zoomOut(),this.addGraphic=(e,t)=>"image-loaded"===this.state&&!this._graphics.graphics.includes(e)&&(this._graphics.graphics.add(e,t),!0),this.addManyGraphics=e=>{if("image-loaded"!==this.state)return!1;const t=e.filter((e=>!this._graphics.graphics.includes(e)));return this._graphics.graphics.addMany(t),!0},this.clearGraphics=()=>{this._graphics.graphics.removeAll()},this.clearImage=()=>{this.imageSize=null,this._removeImageSphere()},this.removeGraphic=e=>!("image-loaded"!==this.state||!this._graphics.graphics.includes(e)||(this._graphics.remove(e),0)),this.removeManyGraphics=e=>{if("image-loaded"!==this.state)return!1;const t=e.filter((e=>this._graphics.graphics.includes(e)));return this._graphics.removeMany(t),!0},this._imageRenderer=new vt({map:this._map,viewingMode:"local",camera:{position:ce},environment:{atmosphereEnabled:!1,starsEnabled:!1,lighting:{type:"virtual"}},popupEnabled:!1,spatialReference:nt.WebMercator,ui:{components:["attribution"]}})}initialize(){this.state="initialized",this.addHandles([_((()=>this.imageSource),(()=>{this.imageSource&&this.autoLoad&&this._loadWithController()}),F),_((()=>this.fov),(()=>{this._reloadCamera()}),F),_((()=>this.yaw),(e=>{this.camera.heading=e,this._reloadCamera()}),F),_((()=>this.pitch),(e=>{this.camera.tilt=e,this._reloadCamera()}),F),S((()=>this.imageRenderer.ready),(()=>{this._addNavigationHandles(),this._addZoomHandles()}),F),_((()=>this.clickAction),(e=>{this.removeHandles("image-click-action"),"none"!==e&&this.addHandles(this.imageRenderer.on("click",this._handleImageClick))}),F)],"default")}get camera(){return this.imageRenderer.camera}set camera(e){e&&(this.imageRenderer.camera=e.clone())}get fov(){return this.camera.fov}set fov(e){Number.isFinite(e)&&this._zoomViewModel?.zoomTo(e)}get hfov(){const{fov:e}=this.camera,{size:[t,r]}=this.imageRenderer,i=t/r,s=Math.atan(i);return 2*d(Math.atan(Math.tan(g(e/2))*Math.sin(s)))}get imageRenderer(){return this._imageRenderer}get maxHFOV(){const{size:[e,t]}=this.imageRenderer;return kr(ye,e/t)}get minHFOV(){const{size:[e,t]}=this.imageRenderer;return kr(fe,e/t)}get vfov(){const{fov:e}=this.camera,{size:[t,r]}=this.imageRenderer,i=t/r,s=Math.atan(i);return 2*d(Math.atan(Math.tan(g(e/2))*Math.cos(s)))}async _loadImageInternal(e,t){let r;this.state="image-loading";try{r=(await It(e,{responseType:"image",...t})).data}catch(e){throw b(e)?this.state="image-load-aborted":this.state="image-load-error",e}return this._updateImageSphere(r,t)}_reloadCamera(){this.camera=this.camera.clone()}_removeImageSphere(){this._imageGraphic&&(this._graphics.remove(this._imageGraphic),this._imageGraphic=y(this._imageGraphic)),this.state="ready",this.imageSize=null}_updateCameraHeadingAndTilt(){if(!this._startPosition||!this._targetPosition)return;const e=this.camera.heading+(this._startPosition.x-this._targetPosition.x)/this.imageRenderer.width*this.camera.fov;this.yaw=(e+360)%360;const t=this.camera.tilt-(this._startPosition.y-this._targetPosition.y)/this.imageRenderer.height*this.imageRenderer.camera.tilt;this.pitch=Math.min(179.5,Math.max(.5,t)),this._startPosition=this._targetPosition}async _updateImageSphere(e,r){await k(r);const{size:[i,s]}=this.imageRenderer;var o;return this._imageGraphic=(o=function(e,t=ce,r=me){const i=t.clone();i.z=-me/2;const s=et.createSphere(i,{size:r,densificationFactor:2,vertexSpace:"georeferenced",material:new St({colorTexture:new Pt({data:e})})});if(s.components[0].trustSourceNormals=!0,s.vertexAttributes.uv){const e=s.vertexAttributes.uv.length??0;for(let t=0;t<e;t++)s.vertexAttributes.uv[2*t+0]=1-s.vertexAttributes.uv[2*t+0],s.vertexAttributes.uv[2*t+1]=s.vertexAttributes.uv[2*t+1]}return s.centerAt(i),s}(e),new t({geometry:o,symbol:new Rt({symbolLayers:new a([new Ct])})})),this._graphics.add(this._imageGraphic),this.fov=kr(je,i/s),this.state="image-loaded",this.imageSize=[e.width,e.height],this._imageGraphic.geometry}async loadImage(e){return this._removeImageSphere(),this.imageSource?this._loadImageInternal(this.imageSource,e):he(this.declaredClass,new l(de("panoramic-viewer"),ge("PanoramicViewerViewModel","imageSource")))}};e([A()],Fr.prototype,"_graphics",void 0),e([A()],Fr.prototype,"_imageGraphic",void 0),e([A()],Fr.prototype,"_imageRenderer",void 0),e([A()],Fr.prototype,"_loadController",void 0),e([A()],Fr.prototype,"_map",void 0),e([A()],Fr.prototype,"_zoomViewModel",void 0),e([A({type:Boolean})],Fr.prototype,"autoLoad",void 0),e([A({type:jt})],Fr.prototype,"camera",null),e([X(new _t({emit:"emit",hittest:"hittest",none:"none","pixel-location":"pixel-location"}))],Fr.prototype,"clickAction",void 0),e([A({type:Number})],Fr.prototype,"fov",null),e([A({readOnly:!0})],Fr.prototype,"hfov",null),e([A({readOnly:!0})],Fr.prototype,"imageRenderer",null),e([A()],Fr.prototype,"imageSize",void 0),e([A()],Fr.prototype,"imageSource",void 0),e([A({readOnly:!0})],Fr.prototype,"maxHFOV",null),e([A({readOnly:!0})],Fr.prototype,"minHFOV",null),e([A({type:Number})],Fr.prototype,"pitch",void 0),e([A()],Fr.prototype,"state",void 0),e([A({readOnly:!0})],Fr.prototype,"vfov",null),e([A({type:Number})],Fr.prototype,"yaw",void 0),Fr=e([L("esri.widgets.PanoramicViewer.PanoramicViewerViewModel")],Fr);const Mr=Fr;let Sr=class extends wt{constructor(e){super(e),this.viewModel=new Mr,this._afterContainerCreate=e=>{this.imageRenderer.container=e},this.addGraphic=(e,t)=>{this.viewModel.addGraphic(e,t)},this.addManyGraphics=e=>{this.viewModel.addManyGraphics(e)},this.clearGraphics=()=>{this.viewModel.clearGraphics()},this.clearImage=()=>{this.viewModel.clearImage()},this.loadImage=e=>this.viewModel.loadImage(e),this.removeGraphic=e=>{this.viewModel.removeGraphic(e)},this.removeManyGraphics=e=>{this.viewModel.removeManyGraphics(e)}}get autoLoad(){return this.viewModel.autoLoad}set autoLoad(e){this.viewModel.autoLoad=e}get camera(){return this.viewModel.camera}set camera(e){e&&(this.viewModel.camera=e)}get clickAction(){return this.viewModel.clickAction}set clickAction(e){this.viewModel.clickAction=e}get fov(){return this.camera.fov}set fov(e){this.viewModel.fov=e}get hfov(){return this.viewModel.hfov}get icon(){return"i360-view"}set icon(e){this._overrideIfSome("icon",e)}get imageRenderer(){return this.viewModel.imageRenderer}get imageSize(){return this.viewModel.imageSize}get imageSource(){return this.viewModel.imageSource}set imageSource(e){this.viewModel.imageSource=e}get pitch(){return this.viewModel.pitch}set pitch(e){this.viewModel.pitch=e}get state(){return this.viewModel.state}get vfov(){return this.viewModel.vfov}get yaw(){return this.viewModel.yaw}set yaw(e){this.viewModel.yaw=e}render(){return Ot("div",{afterCreate:this._afterContainerCreate,bind:this,class:this.classes(xt.widget,"esri-panoramic-viewer")})}};e([A({type:Boolean})],Sr.prototype,"autoLoad",null),e([A({type:jt})],Sr.prototype,"camera",null),e([A()],Sr.prototype,"clickAction",null),e([A({type:Number})],Sr.prototype,"fov",null),e([A({readOnly:!0,type:Number})],Sr.prototype,"hfov",null),e([A()],Sr.prototype,"icon",null),e([A({readOnly:!0,type:vt})],Sr.prototype,"imageRenderer",null),e([A({readOnly:!0})],Sr.prototype,"imageSize",null),e([A()],Sr.prototype,"imageSource",null),e([A({type:Number})],Sr.prototype,"pitch",null),e([A({readOnly:!0})],Sr.prototype,"state",null),e([A({readOnly:!0,type:Number})],Sr.prototype,"vfov",null),e([Vt(["click","hittest-response","pixel-location"]),A({type:Mr})],Sr.prototype,"viewModel",void 0),e([A({type:Number})],Sr.prototype,"yaw",null),Sr=e([L("esri.widgets.PanoramicViewer")],Sr);const Pr=Sr,Rr=new Lt({size:15,style:"circle",color:[255,102,102,.5],outline:null}),Cr=new Lt({size:10,style:"circle",color:[0,128,192,.5],outline:null}),xr=new Ut({style:"solid",color:[0,128,192,.5],outline:null}),Vr=new Ut({style:"solid",color:[255,102,102,.5],outline:null}),Or=new Lt({size:10,style:"diamond",color:[255,102,102],outline:null}),Ar=new Tt({symbolLayers:new a([new Dt({size:10,material:{color:"red"},resource:{primitive:"x"},outline:{color:"black",size:1}})])}),Lr=new Tt({symbolLayers:new a([new zt({width:9,height:9,depth:9,material:{color:[255,102,102]},resource:{primitive:"diamond"},castShadows:!1})])}),Ur=new At({data:{type:"CIMSymbolReference",symbol:{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,size:10,frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[0,1.4142135623730951],[3.585786437626905,5],[5,3.585786437626905],[1.4142135623730951,0],[5,-3.585786437626905],[3.585786437626905,-5],[0,-1.4142135623730951],[-3.585786437626905,-5],[-5,-3.585786437626905],[-1.4142135623730951,0],[-5,3.585786437626905],[-3.585786437626905,5],[0,1.4142135623730951]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,width:1,color:[0,0,0,100]},{type:"CIMSolidFill",enable:!0,color:[255,0,0,255]}]}}]}]}}}),Tr=new Rt({symbolLayers:new a([new Ct({material:{color:[255,102,102,.5]},edges:null})])}),Dr=new Rt({symbolLayers:new a([new Ct({material:{color:[0,128,192,.25]},edges:null})])});let zr=class extends p.EventedAccessor{constructor(e){super(e),this._imageChanged=!1,this._panConstraint=null,this._image=null,this._loadController=null,this._overlays=new G({blendMode:"source-atop"}),this._map=new kt,this.autoLoad=!1,this.clickAction="none",this.error=null,this.imageSource=null,this.imageRotation=0,this.state="ready",this._cancelLoadWithController=()=>{this._loadController?.abort(),this._loadController=null},this._createImageHandles=()=>{this.removeHandles("enhancements-handle"),this.addHandles(_((()=>[this.brightness,this.contrast,this.sharpness]),(([e,t,r])=>{this.image?.loaded&&(this.image.effect=`contrast(${10*(t+10)}%) brightness(${10*(e+10)}%)`,this.sharpenImage(this.image,r))}),F))},this._createPanConstraint=()=>{const{image:e,imageRenderer:t}=this,r=r=>{if(!(e&&t&&r.targetGeometry&&e.serviceRasterInfo))return r;const{extent:i}=e.serviceRasterInfo,{constraints:s,rotation:o,width:a,height:n}=t,{extent:l}=Gt(at.fromExtent(i),o),{width:p,height:m}=l,c=r.targetGeometry.clone(),u=s.scaleToZoom(r.scale),h=1/2**u,d=a/n;let g=h*p,y=h*m;u&&(p/a>m/n?y=g/d:g=y*d);const f=l.clone();return f.xmin+=g/2,f.xmax-=g/2,f.ymin+=y/2,f.ymax-=y/2,r.targetGeometry=Bt(f,c).coordinate,this.state="image-loaded",r};return{constrain:r,applyPanConstraint:r}},this._createResizeHandles=e=>{e.removeHandles("resize"),e.addHandles(_((()=>{if(!this.imageRenderer.ready)return;const{extent:t}=e.serviceRasterInfo,{width:r,height:i,rotation:s}=this.imageRenderer,{extent:o}=Gt(at.fromExtent(t),s),{width:a,height:n}=o;return Math.max(a/r,n/i)}),(e=>{if(!this.imageRenderer||null==e)return;const{constraints:t,scale:r,spatialReference:i}=this.imageRenderer,s=t.minScale,o=Jt(i),a=.25*o,n=o*e;let l=n;const p=[];for(;l>a;)p.push(l),l/=2;p.push(l);const{lods:m}=Zt.create({scales:p});if(t.set({minScale:n,lods:m}),this._imageChanged)return this.imageRenderer.scale=n,void(this._imageChanged=!1);this.imageRenderer.scale=Math.abs(r-s)<=1e-6?n:r}),F),"resize")},this._loadImageInternal=(e,t={})=>{this.clearImage(),this.error=null,this._imageChanged=!0,this.state="image-loading";const r="string"==typeof e,i=r?void 0:e.datasetFormat,s=r?e:e.url,{customParameters:o,options:a}=t;return this._image=new Nt({ioConfig:{skipExtensions:["aux.xml","jgw"],skipMapInfo:!0,datasetFormat:i},url:s,customParameters:o}),this._image.when((e=>{this._updatePanConstraint(),this._createResizeHandles(e),this._map.add(e),this.state="image-loaded"}),(t=>{b(t)?this.state="image-load-aborted":(this.state="image-load-error",this.error=t,u.getLogger(this).error(`error occurred while loading image ${r?e:JSON.stringify(e)}`,t),this.imageSource=null)})),this._image.load(a)},this._loadWithController=()=>{this._cancelLoadWithController(),this._loadController=new AbortController,this.loadImage(this._loadController)},this._updatePanConstraint=()=>{this._panConstraint&&this.imageRenderer.constraints.customConstraints.remove(this._panConstraint),this._panConstraint=this._createPanConstraint(),this.imageRenderer.constraints.customConstraints.add(this._panConstraint)},this.addGraphic=(e,t)=>{this._overlays.graphics.add(e,t)},this.addManyGraphics=e=>{this._overlays.addMany(e)},this.clearGraphics=()=>{this._overlays.graphics.removeAll()},this.clearImage=()=>{this.image&&(this._map.layers.remove(this.image),this._image=y(this._image))},this.loadImage=e=>{const{customParameters:t,imageSource:r}=this;return r?this._loadImageInternal(r,{customParameters:t,options:e}):he(this.declaredClass,new l(de("image-viewer"),ge("ImageViewerViewModel","imageSource")))},this.removeGraphic=e=>{this._overlays.remove(e)},this.removeManyGraphics=e=>{this._overlays.removeMany(e)},this._imageRenderer=new Ht({constraints:{snapToZoom:!0,rotationEnabled:!1},map:this._map,popupEnabled:!1,spatialReference:nt.WebMercator,ui:{components:["zoom"]}})}initialize(){this.state="initialized",this.addHandles([_((()=>this.imageSource),(e=>{e&&this.autoLoad&&this._loadWithController()}),F),_((()=>this.image?.loaded),(()=>{this._createImageHandles()})),_((()=>this.imageRotation),(()=>{this._rotateImage()})),_((()=>this.imageRenderer.map),((e,t)=>{t?.layers.remove(this._overlays),e?.layers.add(this._overlays)}),P),_((()=>this.imageRenderer.map.allLayers.length),(e=>{e&&this.imageRenderer.map.layers.reorder(this._overlays,e-1)}),F),_((()=>this.clickAction),(e=>{this.removeHandles("click-handle"),"none"!==e&&this.addHandles(this.imageRenderer.on("click",(t=>{if(this.image?.loaded&&this.imageRenderer.ready)switch(e){case"emit":t.stopPropagation(),this.emit("click",t);break;case"hittest":t.stopPropagation(),t.async((async()=>{const e=await this.imageRenderer.hitTest(t.screenPoint,{include:this._overlays});this.emit("hittest-response",e)}));break;case"pixel-location":{if(t.stopPropagation(),!this.image?.serviceRasterInfo||!t.mapPoint)return void this.emit("pixel-location",null);const{extent:e,pixelSize:r}=this.image.serviceRasterInfo,i=(t.mapPoint.x-e.xmin)*r.x,s=(e.ymax-t.mapPoint.y)*r.y,o=new Ne({x:i,y:s,spatialReference:e.spatialReference});this.emit("pixel-location",o);break}}})))}),F)])}get brightness(){return this._get("brightness")??0}set brightness(e){this._set("brightness",h(e,-10,10))}get contrast(){return this._get("contrast")??0}set contrast(e){this._set("contrast",h(e,-10,10))}get image(){return this._image}get imagePointsInView(){const{extent:e,ready:t}=this.imageRenderer,r=this.imageRotation,i=this.image?.fullExtent,s=this.image?.serviceRasterInfo,o=!0===this._imageRenderer.allLayerViews.find((({layer:e})=>e===this.image))?.attached;if(!(t&&e&&i&&s&&o))return null;const a=Gt(at.fromExtent(e),r),n=at.fromExtent(i),l=Et(a,n),{rings:p}=l;return p.flat().map((([e,t])=>({x:(e-s.extent.xmin)*s.pixelSize.x,y:(s.extent.ymax-t)*s.pixelSize.y})))}get imageSize(){const{image:e}=this;if(!e?.raster)return null;const{width:t,height:r}=e.raster.rasterInfo;return[t,r]}get imageRenderer(){return this._imageRenderer}get imageView(){return this.imageRenderer.allLayerViews.find((e=>e.layer===this.image))}get sharpness(){return this._get("sharpness")??0}set sharpness(e){this._set("sharpness",h(e,0,1))}_rotateImage(){this.imageRenderer.constraints.rotationEnabled=!0,this.imageRenderer.rotation=this.imageRotation,this.imageRenderer.constraints.rotationEnabled=!1}sharpenImage(e,t){if(!t)return void(e.rasterFunction=null);const r=[0,-1*t,0,-1*t,4*t+1,-1*t,0,-1*t,0],i=new Wt({functionName:"Convolution",functionArguments:{type:qt.userDefined,cols:3,rows:3,kernel:r,convolutionType:qt.userDefined}});e.rasterFunction=i}};e([A()],zr.prototype,"_image",void 0),e([A()],zr.prototype,"_imageRenderer",void 0),e([A()],zr.prototype,"_loadController",void 0),e([A()],zr.prototype,"_overlays",void 0),e([A()],zr.prototype,"_map",void 0),e([A({type:Boolean})],zr.prototype,"autoLoad",void 0),e([A({type:Number})],zr.prototype,"brightness",null),e([A()],zr.prototype,"clickAction",void 0),e([A({type:Number})],zr.prototype,"contrast",null),e([A({type:Object})],zr.prototype,"customParameters",void 0),e([A({type:l})],zr.prototype,"error",void 0),e([A({readOnly:!0})],zr.prototype,"image",null),e([A({readOnly:!0})],zr.prototype,"imagePointsInView",null),e([A({readOnly:!0})],zr.prototype,"imageSize",null),e([A({cast:ve})],zr.prototype,"imageSource",void 0),e([A({readOnly:!0})],zr.prototype,"imageRenderer",null),e([A({type:Number})],zr.prototype,"imageRotation",void 0),e([A()],zr.prototype,"imageView",null),e([A({type:Number})],zr.prototype,"sharpness",null),e([A()],zr.prototype,"state",void 0),zr=e([L("esri.widgets.OrientedImageryViewer.components.ImageViewerViewModel")],zr);const Hr=zr;let Gr=class extends wt{constructor(){super(...arguments),this.viewModel=new Hr,this._afterContainerCreate=e=>{this.imageRenderer.container=e},this.addGraphic=(e,t)=>{this.viewModel.addGraphic(e,t)},this.addManyGraphics=e=>{this.viewModel.addManyGraphics(e)},this.clearGraphics=()=>{this.viewModel.clearGraphics()},this.clearImage=()=>{this.viewModel.clearImage()},this.loadImage=async e=>this.viewModel.loadImage(e),this.removeGraphic=e=>{this.viewModel.removeGraphic(e)},this.removeManyGraphics=e=>{this.viewModel.removeManyGraphics(e)}}get autoLoad(){return this.viewModel.autoLoad}set autoLoad(e){this.viewModel.autoLoad=e}get brightness(){return this.viewModel.brightness}set brightness(e){this.viewModel.brightness=e}get clickAction(){return this.viewModel.clickAction}set clickAction(e){this.viewModel.clickAction=e}get contrast(){return this.viewModel.contrast}set contrast(e){this.viewModel.contrast=e}get customParameters(){return this.viewModel.customParameters}set customParameters(e){this.viewModel.customParameters=e}get error(){return this.viewModel.error}get imageSize(){const e=this.viewModel.image?.serviceRasterInfo;return e?[e.width,e.height]:[0,0]}get imagePointsInView(){return this.viewModel.imagePointsInView}get imageRenderer(){return this.viewModel.imageRenderer}get imageRotation(){return this.viewModel.imageRotation}set imageRotation(e){this.viewModel.imageRotation=e}get imageSource(){return this.viewModel.imageSource}set imageSource(e){this.viewModel.imageSource=e}get sharpness(){return this.viewModel.sharpness}set sharpness(e){this.viewModel.sharpness=e}get state(){return this.viewModel.state}render(){return Ot("div",{afterCreate:this._afterContainerCreate,bind:this,class:this.classes(xt.widget,"esri-image-viewer")})}};e([A({type:Boolean})],Gr.prototype,"autoLoad",null),e([A({type:Number}),A()],Gr.prototype,"brightness",null),e([A()],Gr.prototype,"clickAction",null),e([A({type:Number})],Gr.prototype,"contrast",null),e([A({type:Object})],Gr.prototype,"customParameters",null),e([A({readOnly:!0})],Gr.prototype,"error",null),e([A()],Gr.prototype,"imageSize",null),e([A({readOnly:!0})],Gr.prototype,"imagePointsInView",null),e([A({readOnly:!0,type:Ht})],Gr.prototype,"imageRenderer",null),e([A()],Gr.prototype,"imageRotation",null),e([A()],Gr.prototype,"imageSource",null),e([Vt(["click","hittest-response","pixel-location"]),A({type:Hr})],Gr.prototype,"viewModel",void 0),e([A({type:Number})],Gr.prototype,"sharpness",null),e([A({readOnly:!0})],Gr.prototype,"state",null),Gr=e([L("esri.widgets.OrientedImageryViewer.components.ImageViewer")],Gr);const Er=Gr,Br="view-click",Nr="image-click",Wr="interaction-handles",qr=new Set(["JPG","JPEG"]),Zr=/\.(\w+)$/;let Jr=class extends(p.EventedMixin(j)){constructor(e){super(e),this.additionalFeatures=new a,this.additionalCameraLocations=new a,this.additionalFootprints=new a,this.bestFeatureAngle=0,this.bestFeatureCurrentFootprint=null,this.bestFeatureFootprint=null,this.coverageFrustums=new a,this.coveragePolygons=new a,this.currentBestFeature=null,this.currentBestFeatureLocation=null,this.currentCoverageVisible=!0,this.determineWorkflowForFeature=async(e,t,r)=>{const{currentBestFeature:i,selectedPoint:s,view:o}=this;if(o?.closePopup(),i&&s){this._initialCurrentCoverageUpdate=!0;try{await this._updatePointsAndPolygons(r),await this._loadImage(r)}catch(e){b(e)||(this.loadImageError(e),u.getLogger(this).error("#loadIImage()","error occured while loading image",e))}}},this.disabled=!1,this.displayMessage={key:"onLoadMessage",type:"info"},this.features=new a,this.isAdditionalCoverageVisible=!1,this.isAdditionalPointSourcesVisible=!1,this.layer=null,this.localPort=null,this.mapImageConversionToolState=!1,this.navigatorCurrentBestFeature=null,this.overlayedCameraLocations=new a,this.overlayedMapFeatures=new I,this.pointSources=new a,this.previousFeatureAngle=0,this.selectedPoint=null,this.shouldShowSelectedImage=!1,this.updateFootprint=async(e,t)=>{"image-loaded"===this.state&&await(this._adapter?.updateFootprint(e,t))},this.updateFootprintPanorama=async(e,t)=>{await(this._adapter?.updateFootprintPanorama(e,t))},this._adapter=null,this._highlightedFeatureHandle=null,this._imageViewer=new Er,this._initialCurrentCoverageUpdate=!0,this._overlays=new G({listMode:"hide",internal:!0,elevationInfo:{mode:"absolute-height"}}),this._panoramicViewer=new Pr,this._referencePointOnGround=null,this._referencePointOnImage=null,this._sectorData=null,this._updatingHandles=new U,this._clickTask=null,this._crossSymbol=null,this.footprintExtent=null,this._featureChangedTask=null,this._openPopupTask=null,this._suitabilities=null,this._transformController=new AbortController,this._updateFootprintTask=null,this.highlight=e=>{if(!this._overlaysView)return;this.removeHighlight();const t=this.additionalFootprints.find((({attributes:{imageID:t}})=>t===Number(e)));this._highlightedFeatureHandle=t?this._overlaysView?.highlight(t):null},this.loadImageFromSource=async(e,t)=>this._updatingHandles.addPromise(this._loadImageFromSourceInternal(e,t)),this.loadImageViewer=e=>{this._imageViewer.container=e},this.loadPanoramicViewer=e=>{this._panoramicViewer.container=e},this.removeHighlight=()=>this._highlightedFeatureHandle?.remove(),this.toggleImageAttributes=()=>{f(this._openPopupTask),this._openPopupTask=o((async e=>{const{currentBestFeature:r,popupEnabled:i,layer:s,view:o}=this;if(o?.closePopup(),!(o&&r&&i&&s))return;const{attributes:a,geometry:n}=r,l=new t({geometry:n,attributes:a.toJSON(),layer:s});w(e),await o.openPopup({features:[l],location:a.location.clone()})}))},this._createViewClickHandle=()=>{if(this.removeHandles(Br),"disabled"===this.state||null==this.view)return;const e=this.mapImageConversionToolState&&"image-loaded"===this.state?this._mapImageConversionToolViewClickHandler:this._viewClickHandler;this.addHandles(this.view.on("click",e,ft.WIDGET),Br)},this._createImageClickHandle=()=>{this.removeHandles(Nr);const{mapImageConversionToolState:e,mode:t,activeViewer:r,currentBestFeature:i,footprintExtent:s}=this,a=r?.imageSize;if(!(e&&"none"!==t&&a&&s&&i))return;r.clickAction="pixel-location";let n=null;const l=R((()=>r),"pixel-location",(e=>{this.plotReferencePointOnImage(e),n?.abort(),n=o((async r=>{if(!e)return;const s=await this.getMapPoint(e,{feature:i,imageSize:a,mode:t}).then((e=>{const t=this.view?.spatialReference;return Ee(!t,e.spatialReference.equals(t))?e:D(e,t)}));w(r),this.plotReferencePointOnGround(s)}))}));this.addHandles(l,Nr)},this._getImageSourceFromAttachment=async(e,t,r)=>{const i=new gt({objectIds:[t]}),s=await e.queryAttachments(i,r),o=s[`${t}`]?.[0],a=o?.url;if(!a)throw new l("NoAttachmentError","no attachments found",{[e.objectIdField]:t,layer:e});return{datasetFormat:o.contentType.split("/")[1].toUpperCase(),url:a}},this._loadAdapter=async e=>{const{view:t}=this;if(t)switch(t.type){case"2d":{const{default:t}=await import("../../chunks/OrientedImageryViewerViewModelAdapter2D.js");w(e),this._adapter=new t(this);break}case"3d":{const{default:t}=await import("../../chunks/OrientedImageryViewerViewModelAdapter3D.js");w(e),this._adapter=new t(this);break}}else this._adapter=null},this._loadImage=async e=>{const{currentBestFeature:t,layer:r,mode:i}=this;if(this.clearGraphics(),!r||!t||"none"===i)return;const{attributes:s}=t,{imagePath:o,imageRotation:a,cameraHeading:n,cameraRoll:l,cameraPitch:p,objectId:m,cameraOrientation:c,location:h}=s,d=(l??0)+(a??0),g=h.spatialReference.isWGS84&&4!==c?.type?H(h):new Ne(h);let y=o;if("FA"===o)try{y=await this._getImageSourceFromAttachment(r,m,e)}catch(e){if(b(e))return;return we(e)?(u.getLogger(this).error(e),void this.setMessage("noAttachment","error",`${r.objectIdField}: ${m}`)):(u.getLogger(this).error(e,{[r.objectIdField]:m,layer:r}),void this.setMessage("imageLoadError","error",`query-attachments-failed:${r.objectIdField} ${m}`))}try{await this.loadImageFromSource(y,{imageRotation:d,options:e,pitch:p,yaw:n,mode:i,cameraLocation:g}),w(e),await this.transformAndPlotSelectedLocation(e)}catch(e){b(e)||this.loadImageError(e)}},this._loadImageFromSourceInternal=async(e,t)=>{const{mode:r,imageRotation:i,options:s}=t,o="string"==typeof e,a=o?e:e.url,{pathname:n,searchParams:l}=new URL(a);let p=o?n.match(Zr)?.[1]:e.datasetFormat;if(!p){const e=await be(a,{...t.options});p=e?.split("/")[1]??"UNKNOWN FORMAT"}switch(r){case"default":this._imageViewer.imageSource={datasetFormat:p.toUpperCase(),url:a.split("?")[0]},this._imageViewer.customParameters=Object.fromEntries(l),this._imageViewer.imageRotation=i??0,await this._imageViewer.loadImage(s);break;case"panoramic":if(qr.has(p.toUpperCase())){const{selectedPoint:e}=this,{pitch:r,yaw:i,cameraLocation:o,viewAngle:n}=t;this._panoramicViewer.imageSource=a;let l=i??0;"number"==typeof n?l=n-l:o&&e&&(l=await ke(o,e)-l),this._panoramicViewer.pitch=r??0,this._panoramicViewer.yaw=l,await this._panoramicViewer.loadImage(s)}else this.setMessage("unsupportedPanoramicImageryError","error",void 0,{datasetFormat:p})}},this._mapImageConversionToolViewClickHandler=e=>{e.stopPropagation(),e.preventDefault(),e.mapPoint&&this.plotMapPoint(e.mapPoint)},this._viewClickHandler=e=>{this._clickTask?.abort(),this._clickTask=o((async t=>{const{pointerType:r,button:i,mapPoint:s}=e;if(("mouse"!==r||0===i)&&s)return e.stopPropagation(),e.preventDefault(),this._updatingHandles.addPromise(this.loadBestImage(s,{signal:t}))}))},this.plotSelectedPointOnImage=async(e,r)=>{if(await k(r),!e)return;const i=new Ne({...c(e)?e.toJSON():e});if("default"===this.mode)i.x-=.5,i.y=.5-i.y,i.spatialReference=this._imageViewer.imageRenderer.spatialReference.clone(),this._crossSymbol=new t({geometry:i,symbol:Ur}),this._imageViewer.addGraphic(this._crossSymbol,0);else if("panoramic"===this.mode){const{imageSize:r}=this._panoramicViewer;if(!r)return;const[i,s]=r,{heading:o,pitch:a}=Ie(e,i,s),n=He(o,a);this._crossSymbol=new t({geometry:new Ne(n,nt.WebMercator),symbol:Ar}),this._panoramicViewer.addGraphic(this._crossSymbol,0)}},this.handleSectorClick=this.handleSectorClick.bind(this),this.searchBestImage=this.searchBestImage.bind(this),this.transformAndPlotReferencePointOnImage=this.transformAndPlotReferencePointOnImage.bind(this),this.updateSuitabilities=this.updateSuitabilities.bind(this),this.selectBestFeature=this.selectBestFeature.bind(this)}initialize(){this.addHandles([_((()=>this.view),(()=>{this.load()}),F),_((()=>this.view?.map),((e,t)=>{t?.layers.remove(this._overlays),e?.layers.add(this._overlays)}),P),_((()=>this.view?.map?.allLayers?.length),(e=>{e&&this.view?.map?.layers.reorder(this._overlays,e-1)}),P),_((()=>[this.state,this.mapImageConversionToolState,this.view]),(()=>{this._createViewClickHandle(),this._createImageClickHandle()}),F),_((()=>this.bestFeatureAngle),((e,t)=>{this.previousFeatureAngle=t??0}),F),_((()=>this.currentBestFeature),(async(e,t)=>{f(this._featureChangedTask),this._featureChangedTask=o((async r=>this.determineWorkflowForFeature.apply(this,[e,t,{signal:r}]))),await this._featureChangedTask.promise}),{sync:!0}),_((()=>this.mode),(e=>{switch(this.removeHandles(Wr),e){case"default":this.addHandles(_((()=>this._imageViewer.imagePointsInView),(e=>{e&&(f(this._updateFootprintTask),this._updateFootprintTask=o((async t=>{await this.updateFootprint(e,{signal:t})})))}),{...F,equals:(e,t)=>i(e,t,s)}),Wr);break;case"panoramic":this.addHandles(_((()=>{const{currentBestFeature:e,state:t}=this,{imageSize:r,vfov:i,hfov:s,pitch:o,yaw:a}=this._panoramicViewer;return e&&r&&"image-loading"!==t?[i,s,a,o]:null}),(e=>{if(!e||"image-loading"===this.state)return;const[t,r,i,s]=e;f(this._updateFootprintTask),this._updateFootprintTask=o((async e=>{await this.updateFootprintPanorama({verticalFieldOfView:t,horizontalFieldOfView:r,yaw:i,pitch:s},{signal:e})}))}),{...F,equals:(e,t)=>i(e,t,s)}),Wr)}}),F),_((()=>[this.brightness,this.contrast,this.sharpness]),(()=>{const{_imageViewer:e,brightness:t,contrast:r,mode:i,sharpness:s}=this;"default"===i&&(e.brightness=t,e.contrast=r,e.sharpness=s)}),F)])}destroy(){this._updateFootprintTask=f(this._updateFootprintTask),this._clickTask=f(this._clickTask),this.coverageFrustums.destroy(),this.coveragePolygons.destroy(),this.pointSources.destroy(),this.additionalFootprints.destroy(),this.additionalCameraLocations.destroy(),this.bestFeatureFootprint=y(this.bestFeatureFootprint),this.bestFeatureCurrentFootprint=y(this.bestFeatureCurrentFootprint),this._crossSymbol=y(this._crossSymbol),this._referencePointOnGround=y(this._referencePointOnGround),this._referencePointOnImage=y(this._referencePointOnImage),this._overlays&&this.view?.map?.remove(this._overlays),this._overlays.destroy()}get activeLayer(){return n(u.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer}set activeLayer(e){n(u.getLogger(this),"activeLayer",{replacement:"layer"}),this.layer=e}get activeViewer(){const{_imageViewer:e,_panoramicViewer:t,mode:r}=this;switch(r){case"default":return e;case"panoramic":return t;default:return null}}get brightness(){return this._get("brightness")??0}set brightness(e){this._set("brightness",h(e,-10,10))}get contrast(){return this._get("contrast")??0}set contrast(e){this._set("contrast",h(e,-10,10))}get featureCount(){return this.features?.length??0}get imageGalleryEnabled(){return _e(this.currentBestFeature?.attributes.imagePath.trim())}get imageLoaded(){return n(u.getLogger(this),"imageLoaded",{replacement:'Use OrientedImageryViewer.state === "image-loaded"',version:"4.29",warnOnce:!0}),"image-loaded"===this.state}get invalidCameraHeading(){return this.currentBestFeature?.attributes?.cameraHeading===Fe}get imagePointsInView(){const{mode:e,_imageViewer:t}=this;return"default"===e?t.imagePointsInView:null}get layerView(){const{layer:e,view:t}=this;if(e&&t)return t.allLayerViews.find(Me(e))}get layerFloorFilterClause(){const{layerView:e}=this;return e?dt(e):null}get mode(){const e=this.currentBestFeature?.attributes;if(!e)return"none";const{horizontalFieldOfView:t,isSpherical:r}=e;return 360===t||r?"panoramic":"default"}get popupEnabled(){return!0===this.layer?.popupEnabled}get referencePoint(){return this._referencePointOnGround?.geometry}get sectorData(){const{_sectorData:e}=this;return e?Se.map((t=>e[t])):null}get sharpness(){return this._get("sharpness")??0}set sharpness(e){this._set("sharpness",h(e,0,1))}get state(){const{mode:e,disabled:t}=this;if(t)return"disabled";if(!this.isFulfilled())return"loading";if(this.isRejected())return"error";if(this._updatingHandles.updating)return"image-loading";if("error"===this.displayMessage?.type)return"image-load-error";switch(e){case"default":return this._imageViewer.state;case"panoramic":return this._panoramicViewer.state}return"ready"}get thumbnails(){const{features:e}=this;return e?new a(e.map((({attributes:{imagePath:e,objectId:t,cameraRoll:r,imageRotation:i}})=>{const s=e.trim();return _e(s)?{url:s,objectId:t,rotation:(r??0)+(i??0)}:null})).filter(r)):null}set view(e){this._set("view",e)}get _overlaysView(){return this.view?.layerViews.find((({layer:e})=>e===this._overlays))}filterByFootprints(e,t){const r=[],i=[],s=[];return e.forEach((e=>{const{layer:{coveragePercent:o},attributes:a}=e;let n;const l=O(e.geometry.spatialReference);a.cameraHeight/=l,a.farDistance/=l,a.nearDistance/=l,pt(a.elevationSource)&&(a.elevationSource.constantElevation/=l);const{polygon:p,frustum:m}=or(a);if(n=p.clone(),a.isInspection&&(n=function(e){const{spatialReference:t,x:r,y:i}=e.geometry,{cameraHeading:s,cameraPitch:o,farDistance:a,nearDistance:n}=e,l=lr(e.geometry),p=new at({spatialReference:t}),m=Math.abs(1.44*a*l);let c=Math.abs(1.44*n*l);(o<20||null==s)&&(c=m);const u=[];return u[0]={x:r+m*Math.sin((s-45)*sr),y:i+m*Math.cos((s-45)*sr)},u[1]={x:r+m*Math.sin((s+45)*sr),y:i+m*Math.cos((s+45)*sr)},u[2]={x:r+c*Math.sin((s+135)*sr),y:i+c*Math.cos((s+135)*sr)},u[3]={x:r+c*Math.sin((s+225)*sr),y:i+c*Math.cos((s+225)*sr)},p.addRing([[u[0].x,u[0].y,0],[u[1].x,u[1].y,0],[u[2].x,u[2].y,0],[u[3].x,u[3].y,0],[u[0].x,u[0].y,0]]),p}(a)),o&&(n=function(e,t){const r=1+t/100;if("esri.geometry.Circle"===e.declaredClass){const{radius:t,center:i}=e,s=new Ye({radius:t*r,center:i});return e.rings.length>1&&s.addRing(e.rings[1]),s}if("esri.geometry.Polygon"===e.declaredClass){const t=new at({spatialReference:e.spatialReference}),i=e.centroid;if(i){const s=[];for(let t=0;t<e.rings[0].length;t++){const o=Math.sqrt((i.x-e.rings[0][t][0])**2+(i.y-e.rings[0][t][1])**2),a=ne(Ke($e(),[e.rings[0][t][0],e.rings[0][t][1],0],[i.x,i.y,0]),1/o,1),n=ae([i.x,i.y,0],a,o*r,1);s.push({x:n[0],y:n[1]})}t.addRing([[s[0].x,s[0].y,0],[s[1].x,s[1].y,0],[s[2].x,s[2].y,0],[s[3].x,s[3].y,0],[s[0].x,s[0].y,0]])}return t}return e}(n,o)),function(e,t){return e.contains(t)}(n,t)){s.push(e);const{geometry:t,objectId:o,cameraHeight:n,cameraHeading:l}=a,c=t.clone();c.z=n,c.imageID=o,this.pointSources.push(c),l!==Fe&&(r.push(p),m&&i.push(m))}})),{features:s,polygons:r,frustums:i}}handleSectorClick(e){if(isNaN(e))return;const t=this._sectorData?.[Se[e]];t?.length&&this._updateCurrentBestFeature(t.at(0))}handleFeatureClick(e){const{sector:t,featureIndexInSector:r}=e;if(isNaN(r))return;const i=this._sectorData?.[t];i?.length&&this._updateCurrentBestFeature(i.at(r))}async load(e){return this.addResolvingPromise(this._loadAdapter(e).catch((e=>{if(!b(e))throw e}))),this}async loadBestImage(e,t){return this.view?.closePopup(),this.displayMessage=null,this.selectedPoint=e.spatialReference.isGeographic?H(e):e.clone(),this.features.removeAll(),this.currentBestFeature=null,this.additionalFeatures.removeAll(),this.additionalFootprints.removeAll(),this.additionalCameraLocations.removeAll(),this.bestFeatureCurrentFootprint=y(this.bestFeatureCurrentFootprint),this._overlays?.removeAll(),this._fetchFeaturesWithController(e,t)}loadImageError(e){u.getLogger(this).error("oriented-imagery-viewer:load-image",e),this.setMessage("imageLoadError","error",e.message)}async overlayCameraLocations(e){const{activeViewer:r,currentBestFeature:i,overlayedCameraLocations:s,layer:o,mode:a,state:n}=this,l=r?.imageSize;if(!l||!i||!o||"none"===a||n.includes("loading"))return;const{polygon:p}=or(i.attributes);if(r.removeManyGraphics(s.toArray()),s.removeAll(),e){const{features:e}=await o.queryFeatures({where:`${o.objectIdField} <> ${i.attributes.objectId}`,geometry:p,returnGeometry:!0,outFields:[o.objectIdField]}),n=await Promise.all(e.map((async e=>{const{attributes:r,geometry:s}=e,o=await this.getPixels(s,{feature:i,imageSize:l,mode:a}),n=Cr.clone();return n.outline=new $t({color:[0,0,0],width:1}),new t({attributes:r,symbol:n,geometry:o})})));s.addMany(n),r.addManyGraphics(s.toArray())}}overlayGraphicsOnImage(e,t){this.overlayedMapFeatures.set(e,t),this.activeViewer?.addManyGraphics(t.toArray())}async overlayMapFeatures(e,i=!1){const{activeViewer:s,currentBestFeature:o,mode:n,state:l}=this,p=s?.imageSize;if(!p||!o||"none"===n||l.includes("loading"))return;const{polygon:m}=or(o.attributes),{features:c}=await e.queryFeatures({geometry:m,returnGeometry:!0,outFields:[e.objectIdField]}),u=new a((await Promise.all(c.map((async r=>{const{attributes:s,geometry:a}=r,l=r.symbol?.clone()??e.renderer?.getSymbol(r).clone();switch(a?.type){case"point":{const r=await this.getPixels(a,{feature:o,imageSize:p,mode:n});return new t({attributes:s,layer:e,symbol:l,geometry:r,visible:e.visible&&i})}case"polygon":{const{rings:r,spatialReference:m}=a,c=r.map((e=>e.map((([e,t,r])=>new Ne({x:e,y:t,z:r,spatialReference:m}))))),u=await Promise.all(c.map((async e=>this.getPixels(e,{feature:o,imageSize:p,mode:n}).then((e=>e.map(Pe))))));return new t({attributes:s,layer:e,symbol:l,geometry:new at({rings:u,spatialReference:nt.WebMercator}),visible:e.visible&&i})}case"polyline":{const{paths:r,spatialReference:m}=a,c=r.map((e=>e.map((([e,t,r])=>new Ne({x:e,y:t,z:r,spatialReference:m}))))),u=await Promise.all(c.map((async e=>this.getPixels(e,{feature:o,imageSize:p,mode:n}).then((e=>e.map(Pe))))));return new t({attributes:s,layer:e,symbol:l,geometry:new Qt({paths:u,spatialReference:nt.WebMercator}),visible:e.visible&&i})}case"multipoint":{const{points:r,spatialReference:m}=a,c=r.map((([e,t,r])=>new Ne({x:e,y:t,z:r,spatialReference:m}))),u=await this.getPixels(c,{feature:o,imageSize:p,mode:n}).then((e=>e.map(Pe)));return new t({attributes:s,layer:e,symbol:l,geometry:new lt({points:u,spatialReference:nt.WebMercator}),visible:e.visible&&i})}}return null})))).filter(r));this.overlayGraphicsOnImage(`${e.id}`,u)}async getPixels(e,t){const{imageSize:r,mode:i}=t,s=(await this.worldToImage(Array.isArray(e)?e:[e])).map((e=>{if("default"===i)return new Ne({x:e.x-.5,y:.5-e.y,spatialReference:nt.WebMercator});const[t,s]=r,{heading:o,pitch:a}=Ie(e,t,s),n=He(o,a);return new Ne(n,nt.WebMercator)}));return Array.isArray(e)?s:s[0]}async getMapPoint(e,t){const{feature:r,mode:i,imageSize:s}=t,{elevationSample:o,attributes:a}=r,{elevationSource:n,location:l,elevation:p,cameraHeight:m}=a;let c=l.clone();c.spatialReference.isGeographic&&(c=await D(c,nt.WebMercator));const u=await Re(p??(l.z??0)-m,{elevationSample:o,elevationSource:n,extent:this.footprintExtent});let h;if("elevationSample"in u&&Ce(u.elevationSample)&&(r.elevationSample=u.elevationSample),"default"===i){const t=xe(a,s[0],s[1]);h=await ct(Array.isArray(e)?e:[e],{...t,cameraLocation:c},u)}else{const t=Ve(a,s[0],s[1]);h=await ut(Array.isArray(e)?e:[e],{...t,cameraLocation:c},u)}return Array.isArray(e)?h:h[0]}async plotMapPoint(e){return this.plotReferencePoint(e),this.transformAndPlotReferencePointOnImage({feature:this.currentBestFeature,selectedLocation:e,options:{signal:this._transformController?.signal}})}plotReferencePointOnGround(e){this._referencePointOnGround&&(this._overlays?.remove(this._referencePointOnGround),this._referencePointOnGround.destroy()),null!=e&&(this._referencePointOnGround=new t({geometry:new Ne({...e.toJSON()}),symbol:Or}),this.view?this._overlays?.add(this._referencePointOnGround):this.emit("plot-ground-point",{data:{point:this._referencePointOnGround?.geometry}}))}plotReferencePointOnImage(e){if("image-loaded"===this.state)switch(this.clearReferencePointOnImage(),this.mode){case"default":{const r=c(e)?e.toJSON():e;r.x-=.5,r.y=.5-r.y,this._referencePointOnImage=new t({geometry:new Ne({spatialReference:this._imageViewer.imageRenderer.spatialReference.clone(),...r}),symbol:Or}),this._imageViewer.addGraphic(this._referencePointOnImage,0);break}case"panoramic":{const{imageSize:r}=this._panoramicViewer;if(!r)return;const[i,s]=r,{heading:o,pitch:a}=Ie(e,i,s),n=He(o,a);this._referencePointOnImage=new t({geometry:new Ne(n,nt.WebMercator),symbol:Lr}),this._panoramicViewer.addGraphic(this._referencePointOnImage,0);break}}}removeAllOverlayMapFeatures(){this.overlayedMapFeatures.forEach((e=>{this._imageViewer.removeManyGraphics(e.toArray())})),this.overlayedMapFeatures.clear()}removeOverlayedGraphicsOnImage(e){const t=this.overlayedMapFeatures.get(e);t?.length&&(this.activeViewer?.removeManyGraphics(t.toArray()),this.overlayedMapFeatures.delete(e))}resetImage(){switch(this.setMessage("onLoadMessage","info"),this.mode){case"default":this._imageViewer.clearImage(),this._imageViewer.clearGraphics();break;case"panoramic":this._panoramicViewer.clearGraphics()}this._clickTask=f(this._clickTask)}async searchBestImage(e,t){try{const r=await async function(e,t){const{point:r,queryParams:i}=e;if(null==r)return null;const s={};let o=e.layerInstanceOrURL;const a=r.spatialReference.isGeographic?H(r.clone()):r.clone();if(s.outSpatialReference=a.spatialReference,i&&(s.maxRecordCountFactor=i.maxRecordCountFactor??5,s.outFields=i.outFields??["*"],s.where=i.where??"1=1",s.returnGeometry=i.returnGeometry??!0,s.outSpatialReference=i.outSpatialReference),"string"==typeof o&&(ir.layer&&ir.layer.url===o?o=ir.layer:(ir.layer?.destroy(),o=ir.layer=new E({url:o}))),o)try{await o.load();const e=o,r=function(e,t){const r=e.x-t,i=e.x+t,s=e.y-t,o=e.y+t;return new Ze({xmin:r,xmax:i,ymin:s,ymax:o,spatialReference:e.spatialReference})}(a,i?.maximumDistance??e.maximumDistance??1e3);s.returnZ=e.hasZ;const n=new qe({geometry:r,...s}),l=await e.queryFeatures(n,t);return function(e){return t=>{const{features:r,spatialReference:i}=t;return r.forEach((t=>{t.geometry&&(t.geometry.spatialReference=i);const r=rr.fromJSON({...t.toJSON(),layer:e});r&&(t.attributes=r),t.layer=e,t.spatialReference=i})),t}}(e)(l)}catch(e){v(e)}return null}(e,t);r&&await this._processFeatureResponse(r,e.point,{signal:t?.signal})}catch(e){b(e)||(this.setMessage("imageLoadError","error",e.message),u.getLogger(this).error("error occurred while finding best image",e))}}selectBestFeature(e){this.currentBestFeature=this.features?.find((({attributes:t})=>t.objectId===Number(e)))}setAdditionalCameraLocationsVisibility(e){this.additionalCameraLocations.forEach((t=>{t.visible=e}))}setAdditionalCoverageVisibility(e){this.additionalFootprints.forEach((t=>{t.visible=e}))}setCurrentCoverageVisibility(e){this.bestFeatureCurrentFootprint&&(this.bestFeatureCurrentFootprint.visible=e),this.currentBestFeatureLocation&&(this.currentBestFeatureLocation.visible=e)}setMapImageConversionToolState(e){this.mapImageConversionToolState=e}toggleAllOverlayMapFeatures(e){this.overlayedMapFeatures.forEach((t=>{this._toggleVisiblity(t,e)}))}toggleOverlayMapFeatures(e,t){const r=this.overlayedMapFeatures.get(e);r&&this._toggleVisiblity(r,t)}async transformAndPlotReferencePointOnImage(e){const{selectedLocation:t,options:r}=e;let i=!1,s=!1;const o=this.bestFeatureFootprint?.geometry;switch(o?.type){case"polygon":{const e=t.spatialReference.equals(o.spatialReference)?t:await D(t,o.spatialReference);i=o.contains(e);break}case"mesh":{const e=t.spatialReference.equals(o.spatialReference)?t:await D(t,o.spatialReference);s=o.extent.contains(e);break}}if(!i&&!s)return void this.clearReferencePointOnImage();const a=await this.worldToImage(t,r);if(a)return w(r),this.plotReferencePointOnImage(a),{x:a.x,y:a.y};this.clearReferencePointOnImage()}updateSuitabilities(e){e.sort(((e,t)=>e.suitability-t.suitability)),this._suitabilities=e;const t=this._suitabilities.map((({feature:e})=>e));this._initialCurrentCoverageUpdate=!0,this._updateFeatures(t),this._groupFeaturesBySectors()}async _fetchFeatures(e,t){if(!this.view)return;const r=this.layer;if(r){const i={include:r},s=this.view.toScreen(e);if(!s)return;const o=await this.view.hitTest(s,i);return this._processHitTestResults(r,o,t)}}async _fetchFeaturesWithController(e,t){try{await this._fetchFeatures(e,t)}catch(e){if(b(e))return;this.setMessage("imageLoadError","error"),u.getLogger(this).error("error occurred while fetching features",e)}}_groupFeaturesBySectors(){const{_suitabilities:e,additionalFeatures:t,currentBestFeature:r,features:i,invalidCameraHeading:s}=this;if(!e||!t||!r||!i||s)return void(this._sectorData=null);this._sectorData={};for(const e of Se)this._sectorData[e]=new a;const o=e.map(((e,t)=>({...e,featureIndex:t})));o.sort(((e,t)=>e.trueSuitability-t.trueSuitability));const n=o.map((({distance:e})=>e)),l=Math.max(...n);o.forEach((e=>{const{distance:t,angle:r,featureIndex:s}=e,o=t/l*Le[2],a=Be(t,l),n=Ge(r);if(!this._sectorData)return;const p=Le[3]+o*Math.sin(r*Math.PI/180),m=Le[3]+o*Math.cos(r*Math.PI/180);let c;const u=i.at(s),h=u===this.currentBestFeature,d=this.currentBestFeature?.attributes.cameraPitch&&this.currentBestFeature?.attributes.cameraPitch<5;if(h&&d)c=-90;else{const e=p-Le[3],t=m-Le[3],r=t/Math.sqrt(e**2+t**2);let i=180*Math.acos(r)/Math.PI;(e<0&&t<0||e<0&&t>0)&&(i*=-1),c=i}const g=""===a?n:`${a}_${n}`;h&&(c===this.bestFeatureAngle?this.previousFeatureAngle=c:this.bestFeatureAngle=c,this.navigatorCurrentBestFeature=d?null:{x:p,y:m,direction:n});const y=this._sectorData[g];y.add({angle:r,featureIndex:s,x:p,y:m,objectID:u.attributes.objectId,sector:g,featureIndexInSector:y.length})}))}async _processFeatureResponse(e,t,r){const{features:i}=e;if(!i?.length)return this.setMessage("noImageError","error"),void(this.currentBestFeature=null);this.coveragePolygons.removeAll(),this.coverageFrustums.removeAll(),this.pointSources.removeAll();const{features:s,polygons:o,frustums:a}=this.filterByFootprints(i,t);if(!s.length)return this.setMessage("noImageError","error"),void(this.currentBestFeature=null);let n;if(this.coveragePolygons.addMany(o),this.coverageFrustums.addMany(a),o[0]){let e=new at({spatialReference:o[0].spatialReference});for(const t of o)e=await T(e,t);const t=[];for(const{geometry:r}of s)e.contains(r)||t.push([r.x,r.y]);if(t.sort(((e,t)=>+z([e,t]))),e.addRing(t),this.footprintExtent=yt(e.extent,2,2),this.view?.supportsGround)try{n=await this.view.map.ground.createElevationSampler(this.footprintExtent,r)}catch(e){b(e)||u.getLogger(this).error(e)}}if((n||s[0].attributes.elevationSource)&&this.footprintExtent){const e=s[0].attributes.elevationSource;mt(e)&&!n&&(n=await Oe({extent:this.footprintExtent,lod:e.lod,url:e.url,rasterFunction:e.rasterFunction}));const r=await Re((s[0].attributes.location.z??0)-s[0].attributes.cameraHeight,{elevationSample:n,elevationSource:e,extent:this.footprintExtent}),[i,...o]=await ht([t,...s.map((e=>e.attributes.geometry.clone()))],r);s[0].elevationSample=n??r.elevationSample,t.elevation=i.z,s.forEach(((e,t)=>{e.attributes.elevation=o[t].z}))}s[0].elevationSample&&s.forEach((e=>{e.elevationSample=s[0].elevationSample})),this._suitabilities=function(e){const{camera:t,features:r,selectedPoint:i}=e;if(!r.length)return[];e.currentImage??={attributes:{cameraHeading:0,cameraPitch:0}};const s=function(e,t,r){return t.z??=0,t.elevation??=0,i=>{const{hfovWeight:s,vfovWeight:o,distanceWeight:a}=function(e,t){const r="isOblique"in e?e:new rr(e),{isOblique:i,isSpherical:s,isNadir:o}=r;return s?{hfovWeight:"2d"===t?0:1,vfovWeight:"2d"===t?0:.6,distanceWeight:"2d"===t?1:.5}:o?{hfovWeight:.25,vfovWeight:1,distanceWeight:1}:i?{hfovWeight:1,vfovWeight:.25,distanceWeight:1}:{hfovWeight:1,vfovWeight:1,distanceWeight:1}}(i.attributes,e?"3d":"2d"),n=i.attributes,{cameraHeight:l,cameraHeading:p,cameraPitch:m,farDistance:c,horizontalFieldOfView:u,verticalFieldOfView:h,isOblique:d}=n,g=n.geometry,y=180*Math.atan2(g.y-t.y,g.x-t.x)/Math.PI,f=We(t,g);let j,v,w=u,b=h,k=!1;e?(j=e.heading,v=e.tilt,w=180,b=180,k=!0):!d||m<10?(j=p,v=m,k=!1):(j=r.attributes.cameraHeading,v=m,k=!0,w=180),j>180&&(j-=360);let I=1;g.spatialReference.isWebMercator&&(I=1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*g.y/x.radius))));const _=Math.sqrt((Math.sqrt((t.x-g.x)**2+(t.y-g.y)**2)/I)**2+((t.z??0)-(t.elevation??0)-l)**2),F=90-180*Math.atan2(t.y-g.y,t.x-g.x)/Math.PI;let M=(Math.abs(F-j)>180?Math.abs(360-Math.abs(F-j)):Math.abs(F-j))/w;M=4*M+1;const S=180*Math.acos((n.cameraHeight-(t.z??0)+(t.elevation??0))/_)/Math.PI;let P=Math.abs(S-v)/b;P=4*P+1;let R=_/Math.sqrt(c**2+l**2);R=4*R+1;const C=s*M+o*P+a*R;let V;if(k){const e=p>180?p-360:p;V=s*((Math.abs(F-e)>180?Math.abs(360-Math.abs(F-e)):Math.abs(F-e))/u*4+1)+o*(Math.abs(S-m)/h*4+1)+a*R}else V=C;return{suitability:C,trueSuitability:V,feature:i,angle:y,distance:f,verticalAngle:Math.abs(180*Math.atan(f/l)/Math.PI)}}}(t,i,e.currentImage);return r.map(s)}({features:s,selectedPoint:t,camera:Ae(this.view)?this.view.camera:null,currentImage:this.currentBestFeature}),this.updateSuitabilities(this._suitabilities)}async _processHitTestResults(e,t,r){const{screenPoint:i,results:[s]}=t,o="graphic"===s?.type&&this.shouldShowSelectedImage,a=s?.mapPoint??this.view?.toMap(i);if(!a)return;const{layerFloorFilterClause:n}=this,l=C("1=1",C(e.definitionExpression,n)),p=a.spatialReference.isGeographic?1:O(a.spatialReference),m={layerInstanceOrURL:e,point:a,queryParams:{where:l,maximumDistance:e.maximumDistance?e.maximumDistance/p:void 0,objectIds:o?[s.graphic.getAttribute(e.objectIdField)]:void 0}};await this.searchBestImage(m,r)}_toggleVisiblity(e,t){e.forEach((e=>{e.visible=t}))}_updateFeatures(e){if(!e.length)return this.currentBestFeature=null,void this.additionalFeatures.removeAll();this.features.removeAll(),this.features.addMany(e),e.length>1?this.additionalFeatures.addMany(e.slice(1)):this.additionalFeatures.removeAll(),this.currentBestFeature=e[0]}async _updatePointsAndPolygons(e){const{pointSources:r,currentBestFeature:i,currentCoverageVisible:s,isAdditionalPointSourcesVisible:o}=this;if(i&&(this.additionalFootprints.removeAll(),this.additionalCameraLocations.removeAll(),this.bestFeatureCurrentFootprint&&(this.bestFeatureCurrentFootprint.destroy(),this.bestFeatureCurrentFootprint=null,this.bestFeatureFootprint=null),!this.invalidCameraHeading)){await(this._adapter?.createFootprints(e)),w(e);for(const e of r)e.imageID===i.attributes.objectId?this.currentBestFeatureLocation=new t({attributes:{imageID:e.imageID},geometry:e,symbol:Rr,visible:s}):this.additionalCameraLocations.push(new t({attributes:{imageID:e.imageID},geometry:e,symbol:Cr,visible:o}))}}_updateCurrentBestFeature(e){if(!e)return;this.currentBestFeature=this.features?.at(e.featureIndex);const t=this.currentBestFeature?.attributes.cameraPitch&&this.currentBestFeature?.attributes.cameraPitch<5;let r;if(t)r=-90;else{const t=e.x-Le[3],i=e.y-Le[3],s=i/Math.sqrt(t**2+i**2);let o=180*Math.acos(s)/Math.PI;(t<0&&i<0||t<0&&i>0)&&(o*=-1),r=o}r===this.bestFeatureAngle?this.previousFeatureAngle=r:this.bestFeatureAngle=r,this.navigatorCurrentBestFeature=t?null:{x:e.x,y:e.y,direction:e.sector.includes("_")?e.sector.split("_")[1]:e.sector}}clearGraphics(){this._imageViewer.clearGraphics(),this._panoramicViewer.clearGraphics()}clearReferencePointOnImage(){this._referencePointOnImage&&(this._imageViewer.removeGraphic(this._referencePointOnImage),this._panoramicViewer.removeGraphic(this._referencePointOnImage),this._referencePointOnImage=y(this._referencePointOnImage))}plotReferencePoint(e){"mapPoint"in e?this.plotReferencePointOnGround(e.mapPoint):this.plotReferencePointOnGround(e)}setMessage(e,t,r,i){this.displayMessage={key:e,type:t,data:r,map:i}}async transformAndPlotSelectedLocation(e){const{currentBestFeature:t,invalidCameraHeading:r,selectedPoint:i,state:s}=this;if(this._crossSymbol&&(this._panoramicViewer.removeGraphic(this._crossSymbol),this._imageViewer.removeGraphic(this._crossSymbol),this._crossSymbol=y(this._crossSymbol)),!i||!t||"image-loaded"!==s||r)return;let o;try{o=await this.worldToImage(i,e),w(e),await this.plotSelectedPointOnImage(o,e)}catch(e){b(e)||u.getLogger(this).error("failed to transform map point to pixel, cross symbol will not be plotted on image",{error:e,selectedPoint:i,feature:t})}}async worldToImage(e,t){const{footprintExtent:r}=this,{imageSize:i}=this.activeViewer;if("none"===this.mode||!this.currentBestFeature||!i||!r)return;const{attributes:{location:s,elevationSource:o,cameraHeading:a,elevation:n,cameraHeight:l},elevationSample:p}=this.currentBestFeature;let m=s.clone();const c=await Re(n??(s.z??0)-l,{elevationSample:p,elevationSource:o});this.currentBestFeature.elevationSample=c.elevationSample;const u=Array.isArray(e)?e:[e];let h,d=await Promise.all(u.map((e=>new Promise((t=>{if(!e.hasZ)return t(ht(e,c));t(e)})))));if(s.spatialReference.isGeographic&&(m=await D(m,nt.WebMercator,t)),d=await Promise.all(d.map((async e=>m.spatialReference.equals(e.spatialReference)?e:await D(e,m.spatialReference,t)))),w(t),"panoramic"===this.mode)h=Ue(d,{imageHeight:i[1],imageWidth:i[0],cameraHeading:a,cameraLocation:m});else{const e=Te(this.currentBestFeature.attributes,i[0],i[1]);h=De(d,{...e,cameraLocation:m})}return Array.isArray(e)?h:h[0]}updateCurrentCoveragePolygon(e){const{additionalFootprints:r,additionalCameraLocations:i,currentBestFeature:s,currentBestFeatureLocation:o,currentCoverageVisible:a,selectedPoint:n,view:l,_adapter:p}=this,{attributes:{objectId:m},elevationSample:c}=s;if(this._initialCurrentCoverageUpdate){if(this._overlays?.removeAll(),this._initialCurrentCoverageUpdate=!1,this.bestFeatureCurrentFootprint=y(this.bestFeatureCurrentFootprint),e&&!this.invalidCameraHeading&&(e.visible=a,this.bestFeatureCurrentFootprint=e),l){const e=[...r,...i,this.bestFeatureCurrentFootprint,o].filter(ze);l.supportsGround&&c&&p?.updateGroundElevation&&p.updateGroundElevation(e,c),n&&e.push(new t({geometry:n.clone(),symbol:Ur.clone(),attributes:{imageID:m}})),this._overlays.graphics.addMany(e)}}else if(l){if(this.invalidCameraHeading)return;this.bestFeatureCurrentFootprint&&(this._overlays?.remove(this.bestFeatureCurrentFootprint),this.bestFeatureCurrentFootprint=y(this.bestFeatureCurrentFootprint));const t=this.bestFeatureCurrentFootprint&&this._overlays?this._overlays.graphics.indexOf(this.bestFeatureCurrentFootprint):-1;e&&(this.bestFeatureCurrentFootprint=e,l?.supportsGround&&c&&p?.updateGroundElevation&&p.updateGroundElevation([e],c),e.visible=this.currentCoverageVisible,this._overlays?.graphics.add(this.bestFeatureCurrentFootprint,t>=0?t:this._overlays.graphics.length-1))}}};e([A()],Jr.prototype,"activeLayer",null),e([A({readOnly:!0})],Jr.prototype,"activeViewer",null),e([A()],Jr.prototype,"additionalFeatures",void 0),e([A({type:a.ofType(t)})],Jr.prototype,"additionalCameraLocations",void 0),e([A({type:a.ofType(t)})],Jr.prototype,"additionalFootprints",void 0),e([A()],Jr.prototype,"bestFeatureAngle",void 0),e([A()],Jr.prototype,"bestFeatureCurrentFootprint",void 0),e([A({type:t})],Jr.prototype,"bestFeatureFootprint",void 0),e([A({type:Number})],Jr.prototype,"brightness",null),e([A({type:Number})],Jr.prototype,"contrast",null),e([A()],Jr.prototype,"coverageFrustums",void 0),e([A()],Jr.prototype,"coveragePolygons",void 0),e([A()],Jr.prototype,"currentBestFeature",void 0),e([A()],Jr.prototype,"currentBestFeatureLocation",void 0),e([A()],Jr.prototype,"currentCoverageVisible",void 0),e([A({json:{write:!1}})],Jr.prototype,"determineWorkflowForFeature",void 0),e([A()],Jr.prototype,"disabled",void 0),e([A()],Jr.prototype,"displayMessage",void 0),e([A({readOnly:!0})],Jr.prototype,"featureCount",null),e([A()],Jr.prototype,"features",void 0),e([A({readOnly:!0})],Jr.prototype,"imageGalleryEnabled",null),e([A({readOnly:!0})],Jr.prototype,"imageLoaded",null),e([A({readOnly:!0})],Jr.prototype,"invalidCameraHeading",null),e([A()],Jr.prototype,"imagePointsInView",null),e([A()],Jr.prototype,"isAdditionalCoverageVisible",void 0),e([A()],Jr.prototype,"isAdditionalPointSourcesVisible",void 0),e([A()],Jr.prototype,"layer",void 0),e([A()],Jr.prototype,"layerView",null),e([A({readOnly:!0})],Jr.prototype,"layerFloorFilterClause",null),e([A({type:Number})],Jr.prototype,"localPort",void 0),e([A()],Jr.prototype,"mapImageConversionToolState",void 0),e([A({readOnly:!0,value:"none"})],Jr.prototype,"mode",null),e([A()],Jr.prototype,"navigatorCurrentBestFeature",void 0),e([A({type:a.ofType(t)})],Jr.prototype,"overlayedCameraLocations",void 0),e([A()],Jr.prototype,"overlayedMapFeatures",void 0),e([A()],Jr.prototype,"pointSources",void 0),e([A({readOnly:!0})],Jr.prototype,"popupEnabled",null),e([A()],Jr.prototype,"previousFeatureAngle",void 0),e([A()],Jr.prototype,"referencePoint",null),e([A({readOnly:!0})],Jr.prototype,"sectorData",null),e([A()],Jr.prototype,"selectedPoint",void 0),e([A({type:Number})],Jr.prototype,"sharpness",null),e([A()],Jr.prototype,"shouldShowSelectedImage",void 0),e([A({readOnly:!0})],Jr.prototype,"state",null),e([A({readOnly:!0})],Jr.prototype,"thumbnails",null),e([A()],Jr.prototype,"updateFootprint",void 0),e([A()],Jr.prototype,"updateFootprintPanorama",void 0),e([A({value:null})],Jr.prototype,"view",null),e([A()],Jr.prototype,"_adapter",void 0),e([A()],Jr.prototype,"_highlightedFeatureHandle",void 0),e([A()],Jr.prototype,"_imageViewer",void 0),e([A()],Jr.prototype,"_initialCurrentCoverageUpdate",void 0),e([A()],Jr.prototype,"_overlays",void 0),e([A({readOnly:!0})],Jr.prototype,"_overlaysView",null),e([A()],Jr.prototype,"_panoramicViewer",void 0),e([A()],Jr.prototype,"_referencePointOnGround",void 0),e([A()],Jr.prototype,"_referencePointOnImage",void 0),e([A()],Jr.prototype,"_sectorData",void 0),e([A({readOnly:!0})],Jr.prototype,"_updatingHandles",void 0),e([A()],Jr.prototype,"footprintExtent",void 0),Jr=e([L("esri.widgets.OrientedImageryViewer.OrientedImageryViewerViewModel")],Jr);const $r=Jr;export{Vr as a,ur as b,Tr as c,Dr as d,$r as default,or as e,xr as p,pr as u};
