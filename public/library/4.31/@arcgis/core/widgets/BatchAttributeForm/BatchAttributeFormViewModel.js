/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{c as t}from"../../chunks/asyncUtils.js";import r from"../../core/Collection.js";import s from"../../core/Error.js";import o from"../../core/Evented.js";import{g as i}from"../../chunks/ensureType.js";import{a as n}from"../../chunks/maybe.js";import{throwIfAborted as p}from"../../core/promiseUtils.js";import{R as a}from"../../chunks/ReactiveMap.js";import{on as l,watch as u,sync as m}from"../../core/reactiveUtils.js";import{property as c}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{n as d,L as y}from"../../chunks/Logger.js";import{subclass as h}from"../../core/accessorSupport/decorators/subclass.js";import{U as j}from"../../chunks/UpdatingHandles.js";import f from"../../core/Accessor.js";import{t as b}from"../../chunks/tracking.js";import{S as g}from"../../chunks/SimpleObservable.js";import{createArcadeProfile as v,createArcadeExecutor as k}from"../../arcade.js";import{d as x,b as F,a as I}from"../../chunks/formUtils.js";import{isNumericField as E,isStringField as w,isTimeOnlyField as S,getLowerCaseEditTrackingFields as _,isFieldVisibleByDefault as A}from"../../layers/support/fieldUtils.js";import{i as T}from"../../chunks/utils3.js";import{F as L}from"../../chunks/formUtils2.js";import{Clonable as V}from"../../core/Clonable.js";import"../../chunks/handleUtils.js";import"../../core/scheduling.js";import"../../config.js";import"../../chunks/shared.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/ObservableBase.js";import"../../Graphic.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../chunks/messages.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../chunks/vec3f64.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/TimeOnly.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../chunks/lengthUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/layerUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/RendererLegendOptions.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/Version2.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/OverrideHelper.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/common.js";import"../../chunks/vec4f64.js";import"../../chunks/utils7.js";import"../../chunks/enums2.js";import"../../chunks/quantizationUtils.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../form/support/elements.js";import"../../form/elements/AttachmentElement.js";import"../../form/elements/inputs/attachments/AttachmentInput.js";import"../../chunks/Input.js";import"../../form/elements/inputs/attachments/support/inputs.js";import"../../form/elements/inputs/attachments/AudioInput.js";import"../../chunks/utils8.js";import"../../form/elements/inputs/attachments/DocumentInput.js";import"../../form/elements/inputs/attachments/ImageInput.js";import"../../form/elements/inputs/attachments/SignatureInput.js";import"../../form/elements/inputs/attachments/VideoInput.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../layers/Layer.js";import"../../time/TimeExtent.js";import"../../chunks/timeUtils.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../chunks/arcgisLayerUrl.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/utils2.js";import"../../chunks/mat4.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../chunks/EditBusLayer.js";import"../../chunks/uuid.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties2.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../tables/AttributeTableTemplate.js";import"../../tables/elements/AttributeTableGroupElement.js";import"../../tables/elements/AttributeTableElement.js";import"../../tables/support/elements.js";import"../../tables/elements/AttributeTableAttachmentElement.js";import"../../tables/elements/AttributeTableFieldElement.js";import"../../tables/elements/AttributeTableRelationshipElement.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../layers/support/Subtype.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../chunks/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/portalItemUtils.js";import"../../geometry/projection.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../layers/support/TimeInfo.js";import"../../time/TimeInterval.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../chunks/AlphaCutoff.js";import"../../chunks/interfaces2.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";const U=new WeakMap;class C{constructor(){this._observables=new Map}get(e,t,r){const s=i(this._observables,t,(()=>new g));return b(s),Reflect.get(e,t)}set(e,t,r,s){return Reflect.set(e,t,r),this._observables.get(t)?.notify(),!0}}let P=class extends f{constructor(e){super(e);const t=e.original.attributes??{};var r;this.attributes=!(r={...t})||"__accessor__"in r?r:i(U,r,(()=>new Proxy(r,new C)))}get geometry(){return this.original.geometry}get layer(){return this.original.sourceLayer??this.original.layer}getAttribute(e){return this.attributes[e]??null}setAttribute(e,t){this.attributes[e]=t}};function M(e){return new P({original:e})}e([c()],P.prototype,"attributes",void 0),e([c()],P.prototype,"geometry",null),e([c()],P.prototype,"layer",null),e([c({constructOnly:!0})],P.prototype,"original",void 0),P=e([h("esri.widgets.BatchAttributeForm.ReactiveGraphic")],P);const $=v("form-calculation");class B{constructor(){this._executors=new Map,this._executorPromises=new Map}async getArcadeExecutor(e){return this._executors.has(e)?this._executors.get(e):this._executorPromises.has(e)?this._executorPromises.get(e):this._createExecutor(e)}async _createExecutor(e){try{const t=k(e,$);this._executorPromises.set(e,t);const r=await t;return this._executors.set(e,r),r}finally{this._executorPromises.delete(e)}}}function R(e){return"field"===e.type}function D(e){return"group"===e.type}let O=class extends f{constructor(e){super(e),this.template=null}get allFieldInputs(){const e=new r;for(const t of this.inputs)R(t)?e.add(t):D(t)&&e.addMany(t.inputs.filter(R));return e}get description(){return this.template?.description??null}get hasInvalidHiddenInputs(){return this.invalidHiddenInputs.length>0}get invalidHiddenInputs(){return this.inputs.filter((e=>!e.valid&&!e.visible))}get title(){return this.template?.title??null}};e([c()],O.prototype,"allFieldInputs",null),e([c()],O.prototype,"description",null),e([c()],O.prototype,"inputs",void 0),e([c()],O.prototype,"hasInvalidHiddenInputs",null),e([c()],O.prototype,"invalidHiddenInputs",null),e([c()],O.prototype,"template",void 0),e([c()],O.prototype,"title",null),O=e([h("esri.widgets.BatchAttributeForm.inputs.BatchFormInputs")],O);let H=class extends f{constructor(e){super(e),this.existsInAllLayers=!0,this.features=new r}get description(){return this.template.description}get featuresHaveSameCalculatedVisibility(){return!0}get label(){return this.template.label}get layers(){return Array.from(new Set(this.features.map((e=>e.layer))))}get visible(){return this._visible}get _evaluatedVisibilityExpression(){return null}get _visible(){return!!this.existsInAllLayers&&!1!==this.featuresHaveSameCalculatedVisibility&&(null==this._evaluatedVisibilityExpression||this._evaluatedVisibilityExpression)}};e([c()],H.prototype,"description",null),e([c()],H.prototype,"existsInAllLayers",void 0),e([c()],H.prototype,"features",void 0),e([c()],H.prototype,"featuresHaveSameCalculatedVisibility",null),e([c()],H.prototype,"label",null),e([c()],H.prototype,"layers",null),e([c({constructOnly:!0})],H.prototype,"template",void 0),e([c()],H.prototype,"visible",null),e([c()],H.prototype,"_evaluatedVisibilityExpression",null),e([c()],H.prototype,"_visible",null),H=e([h("esri.widgets.BatchAttributeForm.inputs.InputBase")],H);let N=class extends H{constructor(){super(...arguments),this.editType="NA"}get editable(){return this._evaluatedEditableExpression??!0}get _evaluatedEditableExpression(){return null}};e([c()],N.prototype,"editable",null),e([c()],N.prototype,"editType",void 0),e([c()],N.prototype,"_evaluatedEditableExpression",null),N=e([h("esri.widgets.BatchAttributeForm.inputs.EditableInput")],N);let q=class extends N{constructor(e){super(e),this.group=null,this.type="field",this.userHasChangedValue=!1}get dataType(){const{field:e}=this;return E(e)?L.Number:w(e)?L.Text:T(e)||S(e)?L.Date:L.Unsupported}get distinctValues(){if(this.featuresHaveSameValue)return[this.value];const e=new Set;for(const t of this.features)e.add(t.getAttribute(this.fieldName));return Array.from(e)}get editable(){return!!this.field.editable&&(this._evaluatedEditableExpression??!0)}get featuresHaveSameValue(){const{fieldName:e}=this,t=this.features.at(0)?.getAttribute(e);return this.features.every((r=>r.getAttribute(e)===t))}get field(){return this.template.field}get fieldName(){return this.field.name}get isSubtypeField(){return this.layers.some((e=>{if(e&&"subtypeField"in e){const{subtypeField:t,fieldsIndex:r}=e;return(r.get(t)?.name??t)===this.fieldName}return!1}))}get maxLength(){if(this.dataType===L.Date)return;const e=this.field.length,{input:t}=this.template;if(!t||!x(t))return e;const r=t.maxLength;return"number"!=typeof r?e:"number"!=typeof e?r:Math.min(e,r)}get minLength(){if(this.dataType===L.Date)return;const{input:e}=this.template;if(!e||!x(e))return;const t=e.minLength;if("number"!=typeof t)return;const r=this.field.length;return"number"==typeof r&&t>r?void 0:t}get required(){if(!this.editable)return!1;if(!this.field.nullable||this.isSubtypeField)return!0;const e=this.visible&&!1!==this.group?.visible,t=this._evaluatedRequiredExpression;return!(!e||null==t)&&t}get valid(){return!0}get value(){return this.featuresHaveSameValue?this.features.at(0)?.getAttribute(this.fieldName)??null:"esri_BatchAttributeForm_different_values"}get visible(){return!!this.field.visible&&this._visible}get _evaluatedRequiredExpression(){return null}async setValueFromExpressionManager(e){}async setValueFromUser(e){this.userHasChangedValue=!0,this._setValue(e)}_setValue(e){const{fieldName:t}=this;for(const r of this.features)r.setAttribute(t,e)}};e([c()],q.prototype,"dataType",null),e([c()],q.prototype,"distinctValues",null),e([c()],q.prototype,"editable",null),e([c()],q.prototype,"featuresHaveSameValue",null),e([c()],q.prototype,"field",null),e([c()],q.prototype,"fieldName",null),e([c()],q.prototype,"group",void 0),e([c()],q.prototype,"isSubtypeField",null),e([c()],q.prototype,"maxLength",null),e([c()],q.prototype,"minLength",null),e([c()],q.prototype,"required",null),e([c({readOnly:!0})],q.prototype,"type",void 0),e([c()],q.prototype,"userHasChangedValue",void 0),e([c()],q.prototype,"valid",null),e([c()],q.prototype,"value",null),e([c()],q.prototype,"visible",null),q=e([h("esri.widgets.BatchAttributeForm.inputs.FieldInput")],q);let G=class extends H{constructor(e){super(e),this.inputs=[],this.type="group"}initialize(){for(const e of this.inputs)e.group=this}get valid(){return this.inputs.every((e=>e.valid))}get visible(){return!1!==this._evaluatedVisibilityExpression&&this.inputs.some((e=>e.visible))}};function z(e){return"field"===e.type}function Q(e){return"group"===e.type}function J(e,t){const s=new r(e.elements.map((e=>W(e,t))));return new O({inputs:s,template:e})}function W(e,t){const r=new Set(e.layers),o=t.filter((e=>r.has(e.layer)));if(z(e))return function(e,t){return new q({features:t,template:e})}(e,o);if(Q(e))return function(e,t){const r=e.elements.map((e=>W(e,t)));return new G({features:t,inputs:r,template:e})}(e,o);throw new s("batch-attribute-form:unsupported-element-template","The type of form element template provided is not supported")}e([c()],G.prototype,"inputs",void 0),e([c({readOnly:!0})],G.prototype,"type",void 0),e([c()],G.prototype,"valid",null),e([c()],G.prototype,"visible",null),G=e([h("esri.widgets.BatchAttributeForm.inputs.GroupInput")],G);let Z=class extends f{constructor(e){super(e),this.description=null,this.title=null}get elementsInCommon(){const e=this.layers.length;return this.elements.filter((t=>t.layers.length===e))}get layers(){const e=new Set(this.elements.flatMap((e=>e.layers)));return Array.from(e)}};e([c()],Z.prototype,"description",void 0),e([c()],Z.prototype,"elements",void 0),e([c()],Z.prototype,"elementsInCommon",null),e([c()],Z.prototype,"layers",null),e([c()],Z.prototype,"title",void 0),Z=e([h("esri.widgets.BatchAttributeForm.templates.BatchFormTemplate")],Z);const K=Z;async function X({element:e,expressionInfos:t,provider:r}){const s={};if(e.visibilityExpression){const o=t.get(e.visibilityExpression);s.visibilityExpression=o?await r.getArcadeExecutor(o.expression):void 0}if("editableExpression"in e&&e.editableExpression){const o=t.get(e.editableExpression);s.editableExpression=o?await r.getArcadeExecutor(o.expression):void 0}if("requiredExpression"in e&&e.requiredExpression){const o=t.get(e.requiredExpression);s.requiredExpression=o?await r.getArcadeExecutor(o.expression):void 0}if("valueExpression"in e&&e.valueExpression){const o=t.get(e.valueExpression);s.valueExpression=o?await r.getArcadeExecutor(o.expression):void 0}return s}const Y="";function ee(e){return z(e)?d(`${te(r=e)}.${function(e){const t=e.name,r=e.alias??Y;return`${t}.${r===t?Y:r}.${e.nullable}.${e.type}.${e.length??Y}.${e.defaultValue??Y}.${e.description??Y}.${e.editable}.${e.visible}`}(r.field)}.${t=r.domain,t?"coded-value"===t.type?function(e){const{type:t}=e;return`${t}.${e.codedValues.map((({code:e,name:t})=>`${se(e)}.${t}`)).sort().join(".")}`}(t):"range"===t.type?function(e){const{maxValue:t,minValue:r,type:s}=e;return`${s}.${r}.${t}`}(t):JSON.stringify(t):Y}.${r.hint??Y}.${function(e){if(!e)return Y;const{type:t}=e;if(function(e){return"barcode-scanner"===e.type}(e))return t??Y;if(function(e){return"combo-box"===e.type}(e)||function(e){return"radio-buttons"===e.type}(e)){const{showNoValueOption:r}=e;return`${t}.${r}.${e.noValueOptionLabel??Y}`}if(function(e){return"date-picker"===e.type}(e))return`${t}.${re(e)}`;if(function(e){return"datetime-picker"===e.type}(e)){const r=e.min?.getTime(),s=e.max?.getTime(),{includeTime:o}=e;return`${t}.${r}.${s}.${o}`}if(function(e){return"datetimeoffset-picker"===e.type}(e)){const r=re(e),{includeTimeOffset:s,timeResolution:o}=e;return`${t}.${r}.${s}.${o}`}if(function(e){return"switch"===e.type}(e)){const{offValue:r,onValue:s}=e;return`${t}.${se(r)}.${se(s)}`}if(function(e){return"text-area"===e.type}(e)||function(e){return"text-box"===e.type}(e))return`${t}.${e.minLength?.toString()??Y}.${e.maxLength?.toString()??Y}`;if(function(e){return"time-picker"===e.type}(e)){const r=re(e),{timeResolution:s}=e;return`${t}.${r}.${s}`}return JSON.stringify(e)}(r.input)}`):Q(e)?d(function(e){const t=te(e);let r=Y;for(const t of e.elements)r+="."+ee(t).toString();return`${t}${r}`}(e)):d(JSON.stringify(e));var t,r}function te(e){return`${e.label??Y}.${e.description??Y}`}function re(e){return`${e.min??Y}.${e.max??Y}`}function se(e){return"number"==typeof e?`num:${e}`:e}let oe=class extends V{constructor(e){super(e),this.description=null,this.label=null,this._expressionExecutorsByLayer=new a}get elementId(){return ee(this)}get layers(){return Array.from(this._expressionExecutorsByLayer.keys())}addLayer(e,t=null){this._expressionExecutorsByLayer.set(e,t)}foldIn(e){for(const t of e.layers)this.addLayer(t,e.getExpressionExecutorsForLayer(t))}getExpressionExecutorsForLayer(e){return this._expressionExecutorsByLayer.get(e)??null}};e([c()],oe.prototype,"description",void 0),e([c({readOnly:!0})],oe.prototype,"elementId",null),e([c()],oe.prototype,"label",void 0),e([c({readOnly:!0})],oe.prototype,"layers",null),e([c({readOnly:!0})],oe.prototype,"type",void 0),e([c({clonable:e=>new a(Array.from(e))})],oe.prototype,"_expressionExecutorsByLayer",void 0),oe=e([h("esri.widgets.BatchAttributeForm.templates.ElementTemplateBase")],oe);let ie=class extends oe{constructor(e){super(e),this.domain=null,this.hint=null,this.input=null,this.type="field"}get fieldName(){return this.field.name}};e([c({clonable:"reference"})],ie.prototype,"domain",void 0),e([c({clonable:"reference",constructOnly:!0})],ie.prototype,"field",void 0),e([c()],ie.prototype,"fieldName",null),e([c()],ie.prototype,"hint",void 0),e([c()],ie.prototype,"input",void 0),e([c()],ie.prototype,"type",void 0),ie=e([h("esri.widgets.BatchAttributeForm.templates.FieldElementTemplate")],ie);let ne=class extends oe{constructor(e){super(e),this.type="group"}foldIn(e){const{elements:t}=this,r=e.elements;if(t.length!==r.length)throw new s("unable-to-fold-in","Unable to fold in the given GroupElementTemplate because it has a different number of child elements");for(const s of e.layers){this.addLayer(s,e.getExpressionExecutorsForLayer(s));for(let e=0;e<t.length;e++)t.at(e).foldIn(r.at(e))}}};async function pe(e,t){return null!=e.formTemplate?async function(e,t){const r=e.formTemplate;if(!r)return ae(e,t);const s=function(e){return new Map(e?.map((e=>[e.name,e])))}(r.expressionInfos),o={description:r.description,elements:new Array,title:r.title},{elements:i}=r;if(!i)return new K(o);const{arcadeExecutorProvider:n}=t;for(const t of i)try{o.elements.push(await le(t,{arcadeExecutorProvider:n,expressionInfos:s,layer:e}))}catch(e){y.getLogger("esri.widgets.BatchAttributeForm.templates.templateUtils").warn(e)}return new K(o)}(e,t):ae(e,t)}async function ae(e,{arcadeExecutorProvider:t}){const r=new Set(_(e)),s={arcadeExecutorProvider:t,editTrackingFields:r,layer:e},o=[];for(const t of e.fields)me(t,e,r)&&o.push(ue(t,s));const i=await Promise.all(o);return new K({elements:i})}async function le(e,t){if(F(e))return async function(e,{arcadeExecutorProvider:t,expressionInfos:r,layer:o}){const{fieldsIndex:i}=o,{description:n,domain:p,fieldName:a,hint:l,input:u,label:m}=e;if(null==a||!i.has(a))throw new s("batch-attribute-form:invalid-form-element",`Field element with label '${m}' does not refer to a valid field`);const c={description:n,domain:p,field:i.get(a),hint:l,input:u,label:m},d=new ie(c),y=await X({element:e,expressionInfos:r,provider:t});return d.addLayer(o,y),d}(e,t);if(I(e))return async function(e,t){const{arcadeExecutorProvider:r,expressionInfos:s,layer:o}=t,{description:i,label:n}=e,p={description:i,elements:[],label:n};for(const r of e.elements)try{p.elements.push(await le(r,t))}catch{continue}const a=new ne(p),l=await X({element:e,expressionInfos:s,provider:r});return a.addLayer(o,l),a}(e,t);throw new s("batch-attribute-form:unsupported-element-type",`Form elements of type ${e.type} are not supported`)}async function ue(e,{arcadeExecutorProvider:t,layer:r}){const s=new ie({field:e,label:e.alias??e.name}),o={};return e.editable&&r.userHasUpdateItemPrivileges&&(o.editableExpression=await t.getArcadeExecutor("true")),s.addLayer(r,o),s}function me(e,t,r){return!r.has(e.name.toLowerCase())&&A(e,t)}e([c({constructOnly:!0})],ne.prototype,"elements",void 0),e([c()],ne.prototype,"type",void 0),ne=e([h("esri.widgets.BatchAttributeForm.templates.GroupElementTemplate")],ne);let ce=class extends o.EventedAccessor{constructor(e){super(e),this.activeFeatureIndex=-1,this.disabled=!1,this.editType="NA",this.features=new r,this.userHasChangedValues=!1,this._arcadeExecutorProvider=new B,this._activeFormInputsByFieldName=new Map,this._emptyForm=new O({inputs:new r}),this._emptyFormTemplate=new K({elements:[]}),this._featureFormMap=new Map,this._prepareTask=null,this._updatingHandles=new j,this._layerTemplateMap=new a,this._workingFeatures=new r,this.sharedForm=this._emptyForm,this.sharedFormTemplate=this._emptyFormTemplate}initialize(){this.addHandles([l((()=>this.features),"after-changes",(()=>this._prepare()),{onListenerAdd:()=>this._prepare(),sync:!0}),u((()=>this.activeForm),(()=>this._activeFormInputsByFieldName.clear()),m)]),this._prepare()}destroy(){this._prepareTask=n(this._prepareTask),this._workingFeatures.destroyAll(),this._emptyForm.destroy(),this._emptyFormTemplate.destroy()}get activeFeature(){const e=this.activeFeatureIndex;return e<0?null:this.features.at(e)}get activeForm(){if("batch"===this.mode)return this.sharedForm;const e=this._workingFeatures.at(this.activeFeatureIndex);if(!e)return this._emptyForm;const t=this._featureFormMap.get(e);if(t)return t;const r=this._makeBatchFormInputsForFeature(e);return r!==this._emptyForm&&this._featureFormMap.set(e,r),r}get activeFormIsValid(){return!0}get allHiddenErrors(){const e=this.hiddenIndividualFormErrors,t=this.hiddenSharedFormErrors;return Array.from(new Set([...e,...t]))}get hiddenIndividualFormErrors(){if("batch"===this.mode)return[];const e=[];return this.activeForm.inputs.forEach((t=>{!1!==t.visible||t.valid||e.push(t)})),e}get hiddenSharedFormErrors(){const e=[];return this.sharedForm?.inputs.forEach((t=>{!1!==t.visible||t.valid||e.push(t)})),e}get status(){const e=this._prepareTask;return null==e?"not-loaded":e.finished?null!=e.error?"failed":"loaded":"loading"}get submittable(){return this.valid,!0}get updating(){return this._updatingHandles.updating}get valid(){return!0}get layers(){const e=new Set;return this.features.forEach((t=>{const r=t.sourceLayer??t.layer;e.add(r)})),Array.from(e)}get mode(){return this.activeFeatureIndex>-1?"single":"batch"}getValues(e){const t=this._workingFeatures.find((({original:t})=>t===e));if(!t)throw new s("feature-not-found","The given feature is not present in the BatchAttributeForm");return{...t.attributes}}setFieldInputValue(e,t){e.setValueFromUser(t),this.emit("value-change",{features:e.features.toArray().map((e=>e.original)),fieldName:e.fieldName,name:"value-change",value:t})}setValue(e,t){const r=i(this._activeFormInputsByFieldName,e,(()=>{const t=this.activeForm.allFieldInputs.find((t=>t.fieldName===e));if(!t)throw new s("no-FieldInput-found",`Cannot set the value of field '${e}' because there is no FieldInput representing it`);return t}));this.setFieldInputValue(r,t)}validate(){return!1}getCodedValueOptions(e){return e.codedValues.map((({name:e,code:t})=>({name:e,value:t})))}_makeBatchFormInputsForFeature(e){const t=this._layerTemplateMap.get(e.layer);return t?J(t,new r([e])):this._emptyForm}async _prepare(){this._prepareTask=n(this._prepareTask),this._updateWorkingFeatures();const{layers:e}=this;if(0===e.length)return;const r=t((async t=>{p(t);const r=new Map;for(const t of e){const e=await pe(t,{arcadeExecutorProvider:this._arcadeExecutorProvider});this._layerTemplateMap.set(t,e);for(const t of e.elements){const{elementId:e}=t;r.has(e)?r.get(e).foldIn(t):r.set(e,t.clone())}}const s=new K({elements:Array.from(r.values())});this.sharedFormTemplate=s,this.sharedForm=J(s,this._workingFeatures)}));this._updatingHandles.addPromise(r.promise),this._prepareTask=r}_updateWorkingFeatures(){this._workingFeatures.destroyAll();const{features:e}=this;0!==e.length&&this._workingFeatures.addMany(e.map(M))}};e([c({readOnly:!0})],ce.prototype,"activeFeature",null),e([c()],ce.prototype,"activeFeatureIndex",void 0),e([c({readOnly:!0})],ce.prototype,"activeForm",null),e([c()],ce.prototype,"activeFormIsValid",null),e([c()],ce.prototype,"disabled",void 0),e([c()],ce.prototype,"editType",void 0),e([c()],ce.prototype,"features",void 0),e([c()],ce.prototype,"hiddenIndividualFormErrors",null),e([c()],ce.prototype,"updating",null),e([c()],ce.prototype,"valid",null),e([c()],ce.prototype,"layers",null),e([c()],ce.prototype,"mode",null),e([c()],ce.prototype,"sharedForm",void 0),e([c()],ce.prototype,"sharedFormTemplate",void 0),e([c()],ce.prototype,"userHasChangedValues",void 0),e([c()],ce.prototype,"_arcadeExecutorProvider",void 0),e([c()],ce.prototype,"_prepareTask",void 0),e([c()],ce.prototype,"_layerTemplateMap",void 0),e([c()],ce.prototype,"_workingFeatures",void 0),ce=e([h("esri.widgets.BatchAttributeForm.BatchAttributeFormViewModel")],ce);const de=ce;export{R as a,de as default,D as i};
