/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{h as t,clone as i}from"../../core/lang.js";import{property as r}from"../../core/accessorSupport/decorators/property.js";import{L as s}from"../../chunks/Logger.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import l from"./SearchSource.js";import"../../intl.js";import n from"../../core/Error.js";import{m as a}from"../../chunks/maybe.js";import{g as u}from"../../chunks/unitUtils.js";import c from"../../geometry/Polygon.js";import{c as d,s as p}from"../../chunks/geometryUtils2.js";import{F as m}from"../../chunks/FullTextSearch.js";import{s as h}from"../../chunks/substitute.js";import{f}from"../../chunks/date.js";import"../../chunks/ensureType.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../config.js";import"../../chunks/tracking.js";import"../../core/Identifiable.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObservableBase.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../chunks/number.js";import"../../chunks/locale.js";import"../../chunks/messages.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/assets.js";import"../../chunks/jsonMap.js";import"../../chunks/datetime.js";import"../../chunks/writer.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/zmUtils.js";import"../../geometry.js";import"../../geometry/Multipoint.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/scaleUtils.js";import"../../core/Clonable.js";const g=/https?:\/\/services.*\.arcgis\.com/i,y=/(?:\{([^}]+)\})/g,j=()=>s.getLogger("esri.widgets.Search.support.layerSearchUtils");function F(e,t){const{filter:i,withinViewEnabled:r}=e,s=t?.extent,o=i?.geometry;return o??(r&&s?s:void 0)}function x(e){return e&&e.includes("*")}async function v(e){e&&await e.load()}function S(e){return!(!e.fullText&&!e.where)}function w(e,t){const i=e?.indexes;return!(!i||!t?.length)&&i.filter((e=>"FullText"===e.indexType)).some((e=>{const i=e.fields?.split(",").map((e=>e.trim().toLowerCase()))||[];return t.every((e=>i.includes(e.toLowerCase())))}))}function b({text:e,searchFields:t}){return e.trim().split(" ").filter((e=>!!e.trim())).map((e=>new m({onFields:t,searchTerm:e,searchType:"prefix"})))}function k(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function T(e){return e?.capabilities?.query?.supportsPagination??!1}function $(e){return e.displayField||e.layer.displayField||(t=e.layer,t?.fieldsIndex?.fields?.find((e=>"string"===e.type))?.name??"");var t}function I(e,t){return!(!e||!t?.length)&&t.every((t=>L(e,t)))}function L(e,t){return!!e.getField(t)}function E(e){return e.replaceAll("'","''")}function R(e,t){const i=t?.where;return i?`(${e}) AND (${i})`:e}function M({searchTerm:e,layer:i,searchFields:r,filter:s,exactMatch:o,query:l,type:n}){const{definitionExpression:u,url:c}=i;let d="";return!l.fullText&&e&&r&&r.forEach((r=>{const l=i.getField(r),u=i.getFieldDomain?.(r,{excludeImpliedDomains:t("esri-widget-legacy-field-domain-calculation")}),p=u&&"coded-value"===u.type?function({codedValues:e},t,i){return a(e??[],(e=>{const r=e.name,s=i?r:r.toLowerCase();return(i?t:t.toLowerCase())===s?e.code.toString():null}))??null}(u,e,o):null,m=p||e||null;if(null!==m){const e=function({currentTerm:e,field:t,filter:i,exactMatch:r,url:s,type:o}){const l=t?.type,n=t?.name;if("string"===l||"date"===l||"global-id"===l){const t=g.test(s??""),l=t&&function(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}(e)?"N":"";return R(r&&"search"===o?`${n} = ${l}'${e}'`:t?`${n} LIKE ${l}'${e}%'`:`LOWER(${n}) LIKE ${l}'${e.toLowerCase()}%'`,i)}if("oid"===l||"small-integer"===l||"integer"===l||"single"===l||"double"===l){const t=Number(e);return isNaN(t)?null:R(`${n} = ${t}`,i)}return R(`${n} = ${e}`,i)}({currentTerm:m,field:l,filter:s,exactMatch:o,url:c,type:n});e&&(d+=function(e,t){return e?` OR (${t})`:`(${t})`}(d,e))}})),u&&d?`(${u}) AND (${d})`:u||d}function U(e,i,r){const s=e.sourceLayer,{attributes:o}=e,l=s.getFieldDomain?.(r,{feature:e,excludeImpliedDomains:t("esri-widget-legacy-field-domain-calculation")});if(i)return h(i,o);if(r&&o){const e=s.getField(r),t=(n=o)[a=r]??n[Object.keys(n).find((e=>e.toLowerCase()===a.toLowerCase()))];return null==t?"":l&&"coded-value"===l.type?function(e,t){let i=null;const{codedValues:r}=e;return r&&r.length&&r.some((e=>e.code===t&&(i=e.name,!0))),i}(l,t)??"":"date"===e?.type?f(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}var n,a;return""}var C;let _=C=class extends l{constructor(e){super(e),this.displayField=null,this.exactMatch=null,this.orderByFields=null,this.searchFields=null,this.searchTemplate=null,this.suggestionTemplate=null,this.getResults=(e,t)=>function(e,t){const{exactMatch:r=!1,location:s,maxResults:o,spatialReference:l,source:a,sourceIndex:m,suggestResult:h,view:f}=e,{layer:g,filter:y,zoomScale:R}=a,C=f?.scale,_=F(a,f),q=t?.signal;return v(g).then((()=>{const e=g.popupTemplate;return e?e.getRequiredFields(g.fieldsIndex):null})).then((e=>{const{objectIdField:t,returnZ:F}=g,v=$(a);if(!L(g,v))throw j().error("invalid-field: displayField is invalid."),new n("getResults():invalid-field","displayField is invalid.");const D=e?.length?e:[v],N=a.outFields||D,A=x(N);if(N.includes(t)||A||N.push(t),g.floorInfo?.floorField&&N.push(g.floorInfo.floorField),!A&&!I(g,N))throw j().error("invalid-field: outField is invalid."),new n("getResults():invalid-field","outField is invalid.");const B=g.createQuery(),{orderByFields:O}=a;if(O&&(B.orderByFields=O),l){B.outSpatialReference=l;const e=1/u(l);e&&(B.maxAllowableOffset=e)}const G="mesh"===g.geometryType||"multipatch"===g.geometryType,V=g.capabilities?.data?.supportsZ&&!G;if(B.returnZ=V&&!1!==F,B.returnGeometry=!0,B.multipatchOption=G?"xyFootprint":null,N&&(B.outFields=N),s)B.geometry=s;else if(h.key)B.objectIds=[h.key];else{const e=a.searchFields||[v];if(!I(g,e))throw j().error("invalid-field: search field is invalid."),new n("getResults():invalid-field","search field is invalid.");T(g)&&(B.num=o),_&&(B.geometry=_);const t=h.text?.trim();if(!t)return[];const i=h.text,{prefix:s="",suffix:l=""}=a,u=E(`${s}${i}${l}`);k(g)&&w(g,e)&&!r&&i&&(B.fullText=b({text:i,searchFields:e}));const c=M({searchTerm:u,layer:g,searchFields:e,filter:y,exactMatch:r,query:B,type:"search"});if(B.where=c,!S(B))return[]}return g.queryFeatures(B,{signal:q}).then((e=>function(e,t,r,s,o,l,n){return e.features.map((e=>function(e,t,r,s,o,l,n){const a=e.clone(),u=e.sourceLayer,m=u?.objectIdField,h=m?e.attributes[m]:null,f=U(e,r.searchTemplate,o);null!=l&&function(e){return null!=e&&null!=e.minScale&&null!=e.maxScale}(u)&&(u.minScale&&u.minScale<l?l=u.minScale:u.maxScale&&u.maxScale>l&&(l=u.maxScale));const g=a.geometry?d(a.geometry,t??void 0,l??void 0):void 0,y="number"==typeof n&&g?p(i(g),t??void 0,n):g,j=e.clone();return null!=y&&(j.geometry=c.fromExtent(y)),{extent:y,target:j,feature:a,key:h,name:f,sourceIndex:s}}(e,t,r,s,o,l,n)))}(e,f,a,m,v,C,R)))}))}({source:this,...e},t),this.getSuggestions=(e,t)=>function(e,t){const{source:i,spatialReference:r,view:s,suggestTerm:o,maxSuggestions:l,sourceIndex:a,exactMatch:u}=e,{layer:c,filter:d}=i,p=t?.signal,m=F(i,s);return v(c).then((()=>{if(!T(c))return[];const e=$(i),t=i.searchFields||[e],s=[];i.suggestionTemplate?i.suggestionTemplate.replaceAll(y,((e,t)=>(s.push(t),e))):s.push(e);const h=x(s);s.includes(c.objectIdField)||h||s.push(c.objectIdField);const f=L(c,e),g=h||I(c,s),F=I(c,t);if(!f)throw j().error("invalid-field: displayField is invalid."),new n("getSuggestions():invalid-field","displayField is invalid.");if(!g)throw j().error("invalid-field: outField is invalid."),new n("getSuggestions():invalid-field","outField is invalid.");if(!F)throw j().error("invalid-field: search field is invalid."),new n("getSuggestions():invalid-field","search field is invalid.");const v=c.createQuery(),{orderByFields:R}=i;if(R&&(v.orderByFields=R),v.outSpatialReference=r,v.returnGeometry=!1,v.num=l,v.outFields=s,m&&(v.geometry=m),!o.trim())return[];const{prefix:C="",suffix:_=""}=i,q=E(`${C}${o}${_}`);k(c)&&w(c,t)&&!u&&o&&(v.fullText=b({text:o,searchFields:t}));const D=M({searchTerm:q,layer:c,searchFields:t,filter:d,exactMatch:u,query:v,type:"suggest"});return v.where=D,S(v)?c.queryFeatures(v,{signal:p}).then((t=>function(e,t,i,r){return e.features.map((e=>function(e,t,i,r){const s=e.sourceLayer,{attributes:o}=e,{objectIdField:l}=s,n=l?o[l]:null;return{text:U(e,t.suggestionTemplate,r),key:n,sourceIndex:i}}(e,t,i,r)))}(t,i,a,e))):[]}))}({source:this,...e},t)}set layer(e){this._set("layer",e),e&&e.load().catch((()=>{}))}get name(){return this._getLayerTitle()??""}set name(e){this._overrideIfSome("name",e)}clone(){return new C({autoNavigate:this.autoNavigate,filter:this.filter,maxResults:this.maxResults,maxSuggestions:this.maxSuggestions,minSuggestCharacters:this.minSuggestCharacters,outFields:this.outFields?i(this.outFields):null,placeholder:this.placeholder,popupEnabled:this.popupEnabled,prefix:this.prefix,resultGraphicEnabled:this.resultGraphicEnabled,resultSymbol:this.resultSymbol?this.resultSymbol.clone():null,suggestionsEnabled:this.suggestionsEnabled,suffix:this.suffix,withinViewEnabled:this.withinViewEnabled,displayField:this.displayField,exactMatch:this.exactMatch,layer:this.layer,searchFields:this.searchFields?i(this.searchFields):null,suggestionTemplate:this.suggestionTemplate,zoomScale:this.zoomScale})}_getFirstStringField(){return this.layer.fieldsIndex?.fields.find((e=>"string"===e.type))?.name??""}_getDisplayField(){return this.displayField||this.layer.displayField||this._getFirstStringField()}_getSearchFieldsString(){const{layer:e,searchFields:t}=this;return e.loaded?`: ${(t||[this._getDisplayField()]).map((t=>{const i=e.getField(t);return i?.alias||t})).join(", ")}`:""}_getLayerTitle(){const{layer:e}=this;if(!e)return;const{title:t}=e;return t?`${t}${this._getSearchFieldsString()}`:void 0}};e([r({json:{read:{source:"field.name"},write:{target:"field.name"}}})],_.prototype,"displayField",void 0),e([r({json:{read:{source:"field.exactMatch"},write:{target:"field.exactMatch"}}})],_.prototype,"exactMatch",void 0),e([r({value:null})],_.prototype,"layer",null),e([r()],_.prototype,"name",null),e([r({type:[String],json:{write:!0}})],_.prototype,"orderByFields",void 0),e([r()],_.prototype,"searchFields",void 0),e([r()],_.prototype,"searchTemplate",void 0),e([r()],_.prototype,"suggestionTemplate",void 0),_=C=e([o("esri.widgets.Search.LayerSearchSource")],_);const q=_;export{q as default};
