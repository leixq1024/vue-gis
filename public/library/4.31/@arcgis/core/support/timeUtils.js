/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{i as t,clone as e}from"../core/lang.js";import{k as n}from"../core/Accessor.js";import{L as i}from"../chunks/Logger.js";import{o as s}from"../chunks/timeUtils.js";import r from"../time/TimeExtent.js";import{i as o}from"../chunks/utils6.js";import{W as m}from"../chunks/tagSymbols.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"../chunks/metadata.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/tracking.js";import"../chunks/ensureType.js";import"../config.js";import"../core/Error.js";import"../core/accessorSupport/decorators/property.js";import"../chunks/ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../chunks/date.js";import"../chunks/jsonMap.js";import"../chunks/locale.js";import"../chunks/datetime.js";import"../chunks/tslib.es6.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../chunks/Version.js";import"../chunks/Version2.js";function l(t){return void 0!==t.timeInfo}async function u(e,n){if(0===e.length)return r.allTime;await Promise.all(e.map((t=>t.load({signal:n}))));const i=e.filter(l),s=e.filter((t=>!l(t)&&null!=t.visibilityTimeExtent));if(0===i.length&&0===s.length)return r.allTime;const o=[],m=[];for(const t of i)"feature"!==t?.type&&"map-image"!==t?.type||!t.timeInfo?.hasLiveData?m.push(t):o.push(t);const u=t=>null==t||t.isAllTime,a=[...m.map((t=>{const e=t.timeInfo?.fullTimeExtent,{visibilityTimeExtent:n}=t;return e?.intersection(n)??n})),...s.map((t=>t.visibilityTimeExtent))];if(a.some(u))return r.allTime;const c=o.map((async t=>{const e=(await t.fetchRecomputedExtents({signal:n}))?.timeExtent??t.timeInfo?.fullTimeExtent,{visibilityTimeExtent:i}=t;return e?.intersection(i)??i})),p=(await Promise.allSettled(c)).map((t=>"fulfilled"===t.status?t.value:null));if(p.some(u))return r.allTime;const f=[...p,...a].filter(t);return 0===f.length?r.allTime:f.reduce(((t,e)=>t.union(e)))}async function a(t,e){return n(i.getLogger("esri.support.timeUtils.getTimeSliderSettingsFromWebMap"),"`timeUtils.getTimeSliderSettingsFromWebMap` is deprecated in favor of 'timeUtils.getTimeSliderSettingsFromWebDocument'",{replacement:"timeUtils.getTimeSliderSettingsFromWebDocument",version:"4.30",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-support-timeUtils.html#getTimeSliderSettingsFromWebDocument",warnOnce:!0}),null!=t&&o(t)?await c(t,e):null}async function c(t,n){if(!o(t)&&!function(t){return null!=t&&"object"==typeof t&&m in t}(t))return null;await t.load({signal:n});const i=t?.widgets?.timeSlider;if(!i)return null;const s=await async function(t,e){return t.widgets?.timeSlider?.fullTimeExtent??u(t.allLayers,e)}(t,n),l=i.loop,a=function(t){const e=t.numThumbs??2,n=t.currentTimeExtent;if(n){const{start:t,end:i}=n;return null!=t&&null!=i&&t.getTime()===i.getTime()?"instant":2===e?"time-window":null==t||0===t.getTime()?"cumulative-from-start":"cumulative-from-end"}return 2===e?"time-window":"cumulative-from-start"}(i),c=i.stopDelay??2e3,p=function(t){const{numStops:n,stopInterval:i,stops:s}=t;return s?{dates:e(s)}:i?{interval:i.clone()}:{count:n??5}}(i),f=function(t,e){const n=t.currentTimeExtent;if(!n)return null;const{start:i,end:s}=n,o=i??s??null;switch(e){case"time-window":return new r({start:i,end:s});case"cumulative-from-start":return new r({start:null,end:o});case"cumulative-from-end":return new r({start:o,end:null});case"instant":return new r({start:o,end:o})}}(i,a);return{fullTimeExtent:s,loop:l,mode:a,playRate:c,stops:p,timeExtent:f}}function p(t){if(!t)return t;const{start:e,end:n}=t;return new r({start:null!=e?s(e,-e.getTimezoneOffset(),"minutes"):e,end:null!=n?s(n,-n.getTimezoneOffset(),"minutes"):n})}function f(t){if(!t)return t;const{start:e,end:n}=t;return new r({start:null!=e?s(e,e.getTimezoneOffset(),"minutes"):e,end:null!=n?s(n,n.getTimezoneOffset(),"minutes"):n})}export{u as getTimeExtentFromLayers,c as getTimeSliderSettingsFromWebDocument,a as getTimeSliderSettingsFromWebMap,f as toLocalTimeExtent,p as toUTCTimeExtent};
