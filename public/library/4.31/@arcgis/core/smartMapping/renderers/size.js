/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../../renderers/ClassBreaksRenderer.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/Logger.js";import{d as i}from"../../chunks/colorUtils2.js";import s from"../../core/Error.js";import{p as r,t}from"../../chunks/screenUtils.js";import{a as n}from"../../chunks/ensureType.js";import{f as o}from"../../chunks/messages.js";import a from"../../renderers/support/AuthoringInfo.js";import l,{A as m}from"../../renderers/support/AuthoringInfoVisualVariable.js";import{setLabelsForClassBreaks as p}from"../../renderers/support/utils.js";import u,{S as c,c as d}from"../../renderers/visualVariables/SizeVariable.js";import{T as y}from"../../chunks/sizeVariableUtils.js";import{a as f}from"../../chunks/ageUnit.js";import{b as h,e as b,o as j,d as v,h as z,u as w,v as g,g as S,m as k,p as x,n as T,q as V,a as E}from"../../chunks/utils19.js";import{a as U}from"../../chunks/extentUtils.js";import{s as I}from"../../chunks/spatialStatistics.js";import{v as O}from"../../chunks/binningUtils.js";import{b as B,f as F,c as R,g as D}from"../../chunks/layerUtils3.js";import C from"../heuristics/sizeRange.js";import{g as M,c as q,u as P,a as L}from"../../chunks/referenceSizeUtils.js";import{i as G,k as A,s as N,u as Q,p as $,g as W,a as H,b as J,h as Z,e as K,c as X}from"../../chunks/regenerateUtils.js";import{verifyDates as Y,supportedAgeUnits as _}from"../statistics/support/ageUtils.js";import{d as ee,b as ie,i as se}from"../../chunks/utils3.js";import{cloneScheme as re,getSchemes as te}from"../symbology/size.js";import{k as ne}from"../../chunks/utils12.js";import"../../chunks/tslib.es6.js";import"../../symbols.js";import"../../core/accessorSupport/decorators/subclass.js";import"../../core/lang.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/tracking.js";import"../../config.js";import"../../symbols/CIMSymbol.js";import"../../core/accessorSupport/decorators/property.js";import"../../chunks/enumeration.js";import"../../chunks/jsonMap.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../layers/support/fieldUtils.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/ObservableBase.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/datetime.js";import"../../chunks/number.js";import"../../chunks/substitute.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../core/JSONSupport.js";import"../../chunks/assets.js";import"../../chunks/mathUtils.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../geometry/Polyline.js";import"../../chunks/boundsUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../chunks/vec3f64.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../core/Clonable.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../core/reactiveUtils.js";import"../../chunks/asyncUtils.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/layerUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/RendererLegendOptions.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/visualVariableUtils.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/content/UtilityNetworkAssociationsContent.js";import"../../popup/support/UtilityNetworkAssociationType.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/compilerUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/Version2.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/OverrideHelper.js";import"../../chunks/utils7.js";import"../../chunks/enums2.js";import"../../chunks/quantizationUtils.js";import"../../chunks/vec4.js";import"../../chunks/common.js";import"../../chunks/vec4f64.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../chunks/numberUtils.js";import"../../chunks/colorRampUtils2.js";import"../../chunks/utils15.js";import"../../chunks/timeUtils.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../chunks/utils2.js";import"../../chunks/mat4.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../symbols/support/cimSymbolUtils.js";import"../statistics/summaryStatisticsForAge.js";import"../statistics/summaryStatistics.js";import"../../chunks/utils13.js";import"../../chunks/utils11.js";import"../../chunks/generateRendererUtils.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/utils9.js";import"../../chunks/executeQuery.js";import"../../chunks/infoFor3D.js";import"../../chunks/DataLayerSource.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/executeQueryJSON.js";import"../../chunks/query.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils10.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/pbf.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../rest/support/Query.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../time/TimeExtent.js";import"../../chunks/executeQueryPBF.js";import"../../chunks/featureConversionUtils.js";import"../../chunks/BinsQuery.js";import"../../chunks/queryUtils.js";import"../../geometry/projection.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/projectionSupport.js";import"../../chunks/json.js";import"../statistics/support/predominanceUtils.js";import"../../chunks/statsWorker.js";import"../../chunks/utils16.js";import"../../chunks/viewpointUtils.js";import"../../Viewpoint.js";import"../../Camera.js";import"../../CameraLayout.js";import"../../chunks/Cyclical.js";import"../../chunks/mat2d.js";import"../../chunks/mat2df64.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../chunks/PointSizeSplatAlgorithm.js";import"../../chunks/scaleUtils.js";import"../statistics/classBreaks.js";import"../../views/support/colorUtils.js";import"../heuristics/scaleRange.js";import"../../chunks/symbologyUtils.js";import"../../chunks/utils20.js";function oe(e){let i=0;for(const s of e)i+=s;return i/e.length}function ae(e,i){const s=i??oe(e),r=e.reduce(((e,i)=>e+(i-s)**2),0);return Math.sqrt(r/e.length)}async function le(e){const i=await async function(e){const{view:i}=e;if(!(e&&i&&e.layer))throw new s("reference-size:missing-parameters","'view' and 'layer' parameters are required");e.forBinning&&O(e,"reference-size");const{layer:r,...t}=e,n=e.forBinning?B:F,o=R(r,n,e.forBinning);if(!o)throw new s("reference-size:invalid-parameters","'reference-size' must be one of these types: "+D(n).join(", "));const a={layerAdapter:o,...t,view:i};await i.when();const l=null!=a.signal?{signal:a.signal}:null;if(await o.load(l),!e.forBinning&&"polygon"!==o.geometryType)throw new s("reference-size:not-supported",`reference-size is not supported for geometryType: ${o.geometryType}`);return a}(e),t=await i.layerAdapter.getSampleFeatures({sampleSize:-1,returnGeometry:!0,...i},"json");if(!t?.length)throw new s("reference-size:insufficient-info","No features are available to calculate statistics");return async function(e,i){const{view:t}=i;if(i.forBinning){const i=e[Math.floor(e.length/2)].geometry,n=U(i);if(!n)throw new s("reference-size:insufficient-info","Extent is invalid");const o=Math.abs(n.xmax-n.xmin),a=Math.abs(n.ymax-n.ymin),l=Math.min(o,a);return{size:r(l/t.resolution),isGrid:!0}}const{isGrid:n,avgSize:o}=await async function(e,i){const r=await I({features:e,geometryType:i});if(!(r&&"avgSize"in r&&r.avgSize))throw new s("reference-size:insufficient-info","average polygon size is invalid");const t=r.avgSize,n=[],o=[];for(const i of e){const e=U(i.geometry);if(!e){n.push(0),o.push(0);continue}const s=Math.abs(e.xmax-e.xmin),r=Math.abs(e.ymax-e.ymin);n.push(s/r),o.push(Math.sqrt(s*r))}const a=Number(oe(n).toFixed(2)),l=Number(ae(n,a).toFixed(2)),m=ae(o),p=Number((m/t).toFixed(2));return{isGrid:l<=.1&&a>=.75&&a<=1.25&&p<=.1,avgSize:t}}(e,i.layerAdapter.geometryType);return{size:r((n?.9*o:.75*o)/t.resolution),isGrid:n}}(t,i)}const me=2**53-1;async function pe(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new s("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new s("size-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");if("reference-size"===e.theme&&!e.view&&!e.field)throw new s("size-visual-variable:missing-parameters","'view' and 'field' are required when 'theme' is 'reference-size'");if("reference-size"===e.theme&&e.valueExpression)throw new s("size-visual-variable:missing-parameters","'valueExpression' is not supported when 'theme' is 'reference-size'");e.forBinning&&O(e,"size-visual-variable");const i={...e},r=e.forBinning?B:F,t=R(i.layer,r,e.forBinning);if(!t)throw new s("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+D(r).join(", "));"height"===i.axis&&(i.sizeOptimizationEnabled=!1);const n=null!=i.signal?{signal:i.signal}:null;await t.load(n);const o=t.geometryType;if("mesh"===o)throw new s("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(i.worldScale){if("polyline"===o||"polygon"===o)throw new s("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!i.view||"3d"!==i.view.type)throw new s("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true")}if("reference-size"===i.theme&&!e.forBinning&&"polygon"!==o)throw new s("size-visual-variable:invalid-parameters","Reference size is only supported for polygon layers");const a=await ee({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression}),l=g(t,a,"size-visual-variable:invalid-parameters");if(l)throw l;return await ce(i),{...i,layer:t}}async function ue(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new s("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.sqlExpression&&!e.view)throw new s("size-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&O(e,"size-continuous-renderer");const i={...e};i.symbolType=i.symbolType||"2d",i.defaultSymbolEnabled??=!0;const r=e.forBinning?B:F,t=R(i.layer,r,e.forBinning);if(!t)throw new s("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+D(r).join(", "));const n=null!=i.signal?{signal:i.signal}:null;await t.load(n);const o=t.geometryType,a=i.symbolType.includes("3d");if(i.outlineOptimizationEnabled="reference-size"!==i.theme&&"polygon"===o&&i.outlineOptimizationEnabled,"mesh"===o)throw new s("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(a&&("polyline"===o||"polygon"===o))throw new s("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.includes("3d-volumetric")&&(!i.view||"3d"!==i.view.type))throw new s("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");if("reference-size"===i.theme&&!e.forBinning&&"polygon"!==o)throw new s("size-continuous-renderer:invalid-parameters","Reference size is only supported for polygon layers");const l=await ee({field:i.field,normalizationField:i.normalizationField,valueExpression:i.valueExpression}),m=g(t,l,"size-continuous-renderer:invalid-parameters");if(m)throw m;return await ce(i),{...i,layer:t}}async function ce(e){const i=e.layer;if(("polygon"===i.geometryType||e.forBinning)&&e.view&&e.field&&!e.valueExpression&&(!e.theme||"reference-size"===e.theme)){try{e.referenceSizeResult=e.referenceSizeResult??await le({layer:i,view:e.view,filter:e.filter,forBinning:e.forBinning,signal:e.signal})}catch{}!e.theme&&e.referenceSizeResult?.isGrid&&(e.theme="reference-size"),e.referenceSizeOptions?.symbolStyle||(e.referenceSizeOptions?e.referenceSizeOptions.symbolStyle="circle":e.referenceSizeOptions={symbolStyle:"circle"})}}async function de(e){if(!e||!e.layer||!e.field&&!e.valueExpression)throw new s("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new s("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&O(e,"size-class-breaks-renderer");const i={...e};i.symbolType=i.symbolType||"2d",i.defaultSymbolEnabled??=!0,i.classificationMethod??="equal-interval",i.normalizationType=ie(i);const r=e.forBinning?B:F,t=R(i.layer,r,e.forBinning);if(!t)throw new s("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+D(r).join(", "));if(!(null!=i.minValue&&null!=i.maxValue||null==i.minValue&&null==i.maxValue))throw new s("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");const n=null!=i.signal?{signal:i.signal}:null;await t.load(n);const o=t.geometryType,a=i.symbolType.includes("3d");if(i.outlineOptimizationEnabled="polygon"===o&&i.outlineOptimizationEnabled,"mesh"===o)throw new s("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(a&&("polyline"===o||"polygon"===o))throw new s("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.includes("3d-volumetric")&&(!i.view||"3d"!==i.view.type))throw new s("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const l=await ee({field:i.field,normalizationField:i.normalizationField}),m=g(t,l,"size-class-breaks-renderer:invalid-parameters");if(m)throw m;return{...i,layer:t}}function ye(e){const i={...e};delete i.basemap,delete i.sizeScheme,delete i.legendOptions,delete i.symbolType,delete i.defaultSymbolEnabled;const s=i;return s.analyzeData=!(null!=i.minValue&&null!=i.maxValue),s}function fe(e){const i={...e},s=!!i.symbolType?.includes("3d-volumetric"),r=i;return r.worldScale=s,s&&(r.axis="3d-volumetric-uniform"===i.symbolType?"all":"height"),delete i.symbolType,delete i.defaultSymbolEnabled,r}async function he(e){if(!(e&&e.layer&&e.view&&e.startTime&&e.endTime))throw new s("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");const i={...e};i.symbolType??="2d",i.defaultSymbolEnabled??=!0;const r=R(i.layer,F);if(!r)throw new s("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+D(F).join(", "));const t=null!=i.signal?{signal:i.signal}:null;await r.load(t);const n=r.geometryType,o=i.symbolType.includes("3d");if(i.outlineOptimizationEnabled="polygon"===n&&i.outlineOptimizationEnabled,"mesh"===n)throw new s("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(o&&("polyline"===n||"polygon"===n))throw new s("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.includes("3d-volumetric")&&(!i.view||"3d"!==i.view.type))throw new s("size-age-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");const a=Y(r,i.startTime,i.endTime,"size-age-renderer:invalid-parameters");if(a)throw a;if(i.unit&&!_.includes(i.unit))throw new s("size-age-renderer:invalid-unit",`Supported units are: ${_.join(", ")}`);return{...i,layer:r}}async function be(e){let i=e.sizeScheme,s=null,r=null;const t=await E(e.basemap,e.view);if(s=null!=t.basemapId?t.basemapId:null,r=null!=t.basemapTheme?t.basemapTheme:null,i)return{scheme:re(i),basemapId:s,basemapTheme:r};const n=te({basemapTheme:r,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view});return n&&(i=n.primaryScheme,s=n.basemapId,r=n.basemapTheme),{scheme:i,basemapId:s,basemapTheme:r}}function je(e,i){switch(i){case"point":case"multipoint":{const i=e;return[d(i.minSize),d(i.maxSize)]}case"polyline":{const i=e;return[d(i.minWidth),d(i.maxWidth)]}case"polygon":{const i=e;return[d(i.marker.minSize),d(i.marker.maxSize)]}}}function ve(e,i){e.transformationType===y.ClampedLinear&&"below"===i&&e.flipSizes()}function ze(e,i){if("reference-size"===i.theme&&null!=e.min&&null!=e.max&&null!=e.avg&&null!=e.stddev){const i=100,s=0,r=0,t=1,n=e.avg,o=e.min,a=e.max,l=e.stddev,m=0!==n?l/n:0,p=o>r&&o<t&&a<2*t&&m<.5,u=o>s&&o<i&&a<2*i&&m<.5;return{minDataValue:p?r:u?s:o,maxDataValue:p?t:u?i:n+2*l,defaultValuesUsed:!1}}const{theme:s,field:r}=i,t=i.layer,n=r&&"function"!=typeof r?t.getField(r):null,o=se(n);return S(e,s,o,"above"===s||"below"===s)}async function we(i,s,r,t,n){const a=await o("esri/smartMapping/t9n/smartMapping"),l=n.layer,m=n.field,p=l.geometryType,u=n.defaultSymbolEnabled,c=re(i.sizeScheme),d="polygon"===p,y=d?c.marker:c,f=d?c.background:null,h=d?"point":p,b=s?.opacity,j=i.isGrid,v="reference-size"===n.theme,z=v?[]:i.visualVariables.map((e=>e.clone()));s?.visualVariables?.length&&z.push(...s.visualVariables.map((e=>e.clone())));const w=v?q({view:n.view,field:m,normalizationField:t,sizeStops:M(i.visualVariables[0]),sizeByScaleEnabled:j||!!n.sizeOptimizationEnabled}):null;return{renderer:new e({backgroundFillSymbol:!j&&f?k(p,{type:n.symbolType,color:f.color,outline:x(f,p,b)}):null,classBreakInfos:[{minValue:-me,maxValue:me,symbol:w?L({type:n.referenceSizeOptions?.symbolStyle||"circle",color:y.color,primitiveOverrides:w}):k(h,{type:n.symbolType,color:y.color,size:T(y,h),outline:x(y,h,b)})}],defaultLabel:u?a.other:null,defaultSymbol:u&&!v?k(h,{type:n.symbolType,color:y.noDataColor,size:T(y,h,!0),outline:x(y,h,b)}):null,field:m,normalizationField:t,normalizationType:r,valueExpression:n.valueExpression,valueExpressionTitle:n.valueExpressionTitle,visualVariables:z,authoringInfo:i.authoringInfo?.clone()}),visualVariables:i.visualVariables.map((e=>e.clone())),statistics:i.statistics,defaultValuesUsed:i.defaultValuesUsed,isGrid:j,sizeScheme:re(i.sizeScheme),basemapId:i.basemapId,basemapTheme:i.basemapTheme}}async function ge(e){const i=await pe(e),{view:r,field:t,valueExpression:o,minValue:p,maxValue:d,layer:y,normalizationField:f,signal:j,statistics:v,filter:z}=i,w=f?"field":void 0,[g,S]=await Promise.all([v??h({layer:y,field:t,valueExpression:o,sqlExpression:i.sqlExpression,sqlWhere:i.sqlWhere,normalizationType:w,normalizationField:f,filter:z,minValue:p,maxValue:d,view:r,signal:j}),i.sizeOptimizationEnabled?C({view:r,layer:y,signal:j,filter:z}).catch(b):null]);return async function(e,i,r,t){const{theme:o,field:p,normalizationField:d,minValue:y,maxValue:f,axis:h}=e,b=e.layer.geometryType,j=await be({basemap:e.basemap,geometryType:b,sizeScheme:e.sizeScheme,worldScale:e.worldScale,view:e.view}),v=j.scheme;if(!v)throw new s("size-visual-variable:insufficient-info","Unable to find size scheme");const z=await async function(e,i,s,r,t){return"reference-size"===s&&i?[1,i.size]:e?[e.minSize,e.maxSize]:je(r,t)}(r,t,o,v,b),{minDataValue:w,maxDataValue:g,defaultValuesUsed:S}=ze(i,e),k=[],x="height"===h,T=x?h:void 0,E=z[0];let U=z[1];if(x&&"number"==typeof E&&"number"==typeof U){const e=V({minSize:E,maxSize:U},T);k.push(new u({axis:"width-and-depth",minSize:e.minSize})),U=e.maxSize}const I=new u({field:p??void 0,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,valueUnit:"unknown",normalizationField:d,axis:T,minSize:E,maxSize:U,minDataValue:w,maxDataValue:g,legendOptions:n(c,e.legendOptions)});ve(I,o),k.unshift(I);const O=new l("reference-size"===o?{type:"size",field:e.field,normalizationField:e.normalizationField,sizeStops:M(I).map((({label:e,size:i,value:s})=>new m({label:e,size:i,value:s}))),theme:o,referenceSizeScale:t?.isGrid||e.sizeOptimizationEnabled?e?.view?.scale:void 0,referenceSizeSymbolStyle:e.referenceSizeOptions?.symbolStyle,minSliderValue:null!=y?y:i.min,maxSliderValue:null!=f?f:i.max}:{type:"size",theme:o,minSliderValue:null!=y?y:i.min,maxSliderValue:null!=f?f:i.max}),B=new a({visualVariables:[O]});return{basemapId:j.basemapId,basemapTheme:j.basemapTheme,visualVariables:k,statistics:i,isGrid:t?.isGrid,defaultValuesUsed:S,sizeScheme:re(v),authoringInfo:B}}(i,g,S,i.referenceSizeResult)}async function Se(e){const{view:i,filter:r,renderer:t,signal:n,creatorParameters:o}=await async function(e){const i="regenerate-size-visual-variables";$(e,i);const r=await W(e),t=H(r);if(!t||!["size-continuous","univariate-color-size","color-size","relationship-size","type-size"].includes(t))throw new s(`${i}:invalid-parameters`,"Renderer is invalid");const n=A(r,"size");if(!n)throw new s(`${i}:invalid-parameters`,"Renderer does not have a size visual variable authoringInfo");const o=n.theme,a="reference-size"===o,l=r.visualVariables?.find(G);if(!l&&!a)throw new s(`${i}:invalid-parameters`,"Renderer does not have a size visual variable");let m=n.field,p=n.normalizationField,u=null,c=null;m||(l?.field?(m=l.field,p=l.normalizationField):r.field?(m=r.field,p=r.normalizationField):(u=l?.valueExpression??r.valueExpression,c=l?.valueExpressionTitle??r.valueExpressionTitle));const{layer:d,forBinning:y,filter:f,view:h,signal:b}=e,j=J(r),v=await pe({layer:d,field:m,valueExpression:u,valueExpressionTitle:c,normalizationField:p,theme:o,sizeOptimizationEnabled:j,forBinning:y,filter:f,view:h,signal:b});return{...e,creatorParameters:v,renderer:r}}(e),{field:a,normalizationField:l,valueExpression:p,theme:c,layer:d,sizeOptimizationEnabled:y,referenceSizeResult:f,valueExpressionTitle:j}=o,v=l?"field":void 0,[z,w]=await Promise.all([h({layer:d,field:a,valueExpression:p,normalizationField:l,normalizationType:v,filter:r,view:i,signal:n}),y?C({view:i,layer:d,signal:n,filter:r}).catch(b):null]),g=function(e,i,s){return"reference-size"===s&&i?[1,i.size]:e?[e.minSize,e.maxSize]:null}(w,f,c),{minDataValue:S,maxDataValue:k}=ze(z,{theme:c,layer:d,field:a}),x=t.visualVariables?.find(G),T=(x?.stops?null:x)??new u({field:a??void 0,valueExpression:p,valueExpressionTitle:j,valueUnit:"unknown",normalizationField:l});g&&(T.minSize=g[0],T.maxSize=g[1]),T.minDataValue=S,T.maxDataValue=k,ve(T,c);const V=A(t,"size");return V.minSliderValue=z.min,V.maxSliderValue=z.max,"reference-size"===c&&(V.sizeStops=M(T).map((({label:e,size:i,value:s})=>new m({label:e,size:i,value:s}))),V.referenceSizeScale=f?.isGrid||y?i?.scale:void 0),{visualVariables:"reference-size"===c?[]:[T],isGrid:!!f?.isGrid,authoringInfo:t.authoringInfo?.clone(),statistics:z}}async function ke(e){const i=await ue(e),s={layer:i.layer,view:i.view,filter:i.filter,signal:i.signal},[r,t]=await Promise.all([ge(fe(i)),i.outlineOptimizationEnabled?j(s).catch(b):null]),n=i.normalizationField;return we(r,t,n?"field":void 0,n,i)}async function xe(e){const{renderer:i,view:r,signal:t,filter:n,creatorParameters:o,forBinning:a}=await async function(e){const i="regenerate-size-continuous-renderer";$(e,i);const r=await W(e),t=H(r);if(!t||!["size-continuous","univariate-color-size"].includes(t))throw new s(`${i}:invalid-parameters`,"Renderer is invalid");const{authoringInfo:n,field:o,normalizationField:a,valueExpression:l,valueExpressionTitle:m}=r,p=n?.visualVariables.find((e=>"size"===e.type)),u=p.theme,{layer:c,forBinning:d,filter:y,view:f,signal:h}=e,b=Z(r),j=J(r),v=await ue({layer:c,field:o,valueExpression:l,valueExpressionTitle:m,normalizationField:a,theme:u,outlineOptimizationEnabled:b,sizeOptimizationEnabled:j,forBinning:d,filter:y,view:f,signal:h});return{...e,creatorParameters:v,renderer:r}}(e),{layer:l,outlineOptimizationEnabled:m,theme:p,referenceSizeResult:u}=o,[c,d]=await Promise.all([Se({...e,referenceSizeResult:u}),m?j({layer:l,view:r,filter:n,signal:t}).catch(b):null]),y=c.isGrid,f="reference-size"===p;N(i,c.visualVariables,K),N(i,d?.visualVariables,X),Q(i,c.authoringInfo,"size");const h=c.statistics;return f?{renderer:await Te({layer:l,renderer:i,view:r,forBinning:a,sizeStops:A(i,"size","reference-size")?.sizeStops,isGrid:y}),isGrid:y,statistics:h}:{renderer:i,statistics:h}}async function Te(e){const{layer:r,referenceSizeOptions:t,renderer:n,sizeScheme:o,sizeStops:l,typeScheme:p,view:u,isGrid:c}=await async function(e){if(!e||!(e.layer&&e.view&&e.sizeStops))throw new s("update-renderer-with-reference-size:missing-parameters","'layer', 'view and 'sizeStops' parameters are required");const{view:i,forBinning:r}=e,t=e.forBinning?B:F,n=R(e.layer,t,e.forBinning);if(!n)throw new s("update-renderer-with-reference-size:invalid-parameters","'layer' must be one of these types: "+D(t).join(", "));const o=n.layer;let a=e.renderer;if(!a)if(e.forBinning){if(!("featureReduction"in o&&o.featureReduction&&"renderer"in o.featureReduction&&o.featureReduction.renderer)||"class-breaks"!==o.featureReduction.renderer.type&&"unique-value"!==o.featureReduction.renderer.type)throw new s("update-renderer-with-reference-size:invalid-parameters","Feature reduction renderer is not supported");a=o.featureReduction.renderer}else{if(!("renderer"in o)||!o.renderer||"class-breaks"!==o.renderer.type&&"unique-value"!==o.renderer.type)throw new s("update-renderer-with-reference-size:invalid-parameters","Renderer is not supported");a=o.renderer}const l=a.authoringInfo;if(!l||!l?.visualVariables?.some((e=>"reference-size"===e.theme)))throw new s("update-renderer-with-reference-size:invalid-parameters","'renderer.authoringInfo.visualVariables' should have an authoringInfoVisualVariable with 'theme' set to 'reference-size'");const m=e.isGrid??(await le({view:i,layer:o,forBinning:r}))?.isGrid;return{...e,isGrid:m,renderer:a,layer:n}}(e),d=n.clone();d.authoringInfo??=new a;const y=d.authoringInfo.visualVariables.find((e=>"reference-size"===e.theme)),f=e.field??y?.field,h=e.normalizationField??y?.normalizationField;if(!f)throw new s("update-renderer-with-reference-size:invalid-parameters","'field' parameter or authoring info with 'field' is required.");const b=q({view:u,field:f,normalizationField:h,sizeStops:l,sizeByScaleEnabled:c||!!e.sizeOptimizationEnabled}),j=t?.symbolStyle||y?.referenceSizeSymbolStyle||"circle";if("class-breaks"===d.type){const e="polygon"===("geometryType"in r?r.geometryType:null)&&o&&"marker"in o?o.marker:null;d.classBreakInfos.forEach((i=>{const s=e?.color??ne(i.symbol,1);"cim"===i.symbol.type?P(i.symbol,{type:j,color:s,primitiveOverrides:b}):s&&(i.symbol=L({type:j,color:s,primitiveOverrides:b}))}))}else if("unique-value"===d.type){const e=d.uniqueValueGroups,s="polygon"===("geometryType"in r?r.geometryType:null)&&p&&"colors"in p?p.colors:null,t=s?i(s,d.uniqueValueInfos?.length??0):null;let n=0;if(e){for(const i of e)for(const e of i.classes??[]){const i=t?t[n]:ne(e.symbol,1);"cim"===e.symbol?.type?P(e.symbol,{type:j,color:i,primitiveOverrides:b}):i&&(e.symbol=L({type:j,color:i,primitiveOverrides:b})),n++}d.uniqueValueGroups=e}}return y&&(y.field=f,y.normalizationField=h,y.sizeStops=l.map((({label:e,size:i,value:s})=>new m({label:e,size:i,value:s}))),y.referenceSizeScale=c||e.sizeOptimizationEnabled?u.scale:void 0,y.referenceSizeSymbolStyle=j),d}async function Ve(i){const s=await de(i);return async function(i,s){const r=await o("esri/smartMapping/t9n/smartMapping"),n=i.layer,l=i.defaultSymbolEnabled,m=n.geometryType,u="polygon"===m,c=i.symbolType?.includes("3d-volumetric"),d=await be({basemap:i.basemap,geometryType:m,sizeScheme:i.sizeScheme,worldScale:c,view:i.view}),y=d.scheme,{result:f,outlineResult:h}=s,b=f?.classBreakInfos??[],j=i.classificationMethod,v=i.normalizationType,z=u?y.marker:y,w=u?y.background:null,g=u?"point":m,S=je(z,g),E=c?V({minSize:S[0],maxSize:S[1]},"height"):null,U=function(e,i){const s=t(e.minSize),r=(t(e.maxSize)-s)/(i>=4?i-1:i),n=[];for(let e=0;e<i;e++)n.push(s+r*e);return n}({minSize:S[0],maxSize:E?E.maxSize:S[1]},b.length),I=h?.opacity,O=new e({backgroundFillSymbol:w&&k(m,{type:i.symbolType,color:w.color,outline:x(w,m,I)}),classBreakInfos:b.map(((e,s)=>({minValue:e.minValue,maxValue:e.maxValue,symbol:k(g,{type:i.symbolType,color:z.color,size:U[s],widthAndDepth:E?.minSize,outline:x(z,g,I)}),label:e.label}))),defaultLabel:l?r.other:null,defaultSymbol:l?k(g,{type:i.symbolType,color:z.noDataColor,size:T(z,g,!0),widthAndDepth:E?.minSize,outline:x(z,g,I)}):null,field:i.field,valueExpression:i.valueExpression,valueExpressionTitle:i.valueExpressionTitle,normalizationType:v,normalizationField:i.normalizationField,normalizationTotal:"percent-of-total"===v?f?.normalizationTotal:void 0,legendOptions:i.legendOptions,authoringInfo:new a({type:"class-breaks-size",classificationMethod:j,standardDeviationInterval:i.standardDeviationInterval})});return"standard-deviation"!==j&&p({classBreakInfos:O.classBreakInfos,classificationMethod:j,normalizationType:v,round:!0}),h?.visualVariables?.length&&(O.visualVariables=h.visualVariables.map((e=>e.clone()))),{renderer:O,sizeScheme:re(y),classBreaksResult:f,defaultValuesUsed:!!s.defaultValuesUsed,basemapId:d.basemapId,basemapTheme:d.basemapTheme}}(s,await v(ye(s),s.outlineOptimizationEnabled))}async function Ee(e){const{renderer:i,creatorParameters:r}=await async function(e){const i="regenerate-size-class-breaks-renderer";await $(e,i);const r=await W(e);if("size-class-breaks"!==H(r))throw new s(`${i}:invalid-parameters`,"Renderer is invalid");const{authoringInfo:t,field:n,normalizationField:o,normalizationType:a,normalizationTotal:l,valueExpression:m,valueExpressionTitle:p}=r,{classificationMethod:u,standardDeviationInterval:c}=t,d=r.classBreakInfos.length,{layer:y,forBinning:f,filter:h,view:b,signal:j}=e,v=Z(r),z=await de({layer:y,field:n,valueExpression:m,valueExpressionTitle:p,normalizationType:a,normalizationField:o,normalizationTotal:l,classificationMethod:u,standardDeviationInterval:c,numClasses:d,outlineOptimizationEnabled:v,forBinning:f,filter:h,view:b,signal:j});return{...e,creatorParameters:z,renderer:r}}(e),{outlineOptimizationEnabled:t,normalizationType:n,classificationMethod:o}=r,{result:a,outlineResult:l}=await v(ye(r),t),m=a.classBreakInfos;if(r.numClasses!==m.length)throw new s("regenerate-class-breaks-renderer:invalid-parameters","The number of class breaks generated does not match the number of class breaks in the renderer.");return i.classBreakInfos.forEach(((e,i)=>{e.minValue=m[i].minValue,e.maxValue=m[i].maxValue,e.label=m[i].label})),i.normalizationTotal="percent-of-total"===n?a.normalizationTotal:void 0,"standard-deviation"!==o&&p({classBreakInfos:i.classBreakInfos,classificationMethod:o,normalizationType:n,round:!0}),N(i,l?.visualVariables,X),{renderer:i}}async function Ue(e){const i=await he(e),{defaultSymbolEnabled:s,view:r,startTime:t,endTime:n,symbolType:o,minValue:a,maxValue:l,signal:m,filter:p,layer:u}=i,[c,d]=await Promise.all([i.unit?{unit:i.unit,statistics:null,valueExpression:null}:await f({view:r,layer:u,startTime:t,endTime:n,minValue:a,maxValue:l,signal:m,filter:p}),i.outlineOptimizationEnabled?j({layer:u,view:r,filter:p,signal:m}).catch(b):null]),{unit:y,statistics:h}=c,{valueExpression:v,title:g}=await z(i,y),S=await ge(fe({layer:u,basemap:i.basemap,valueExpression:v,symbolType:o,statistics:h,legendOptions:{title:g},theme:i.theme,sizeScheme:i.sizeScheme,sizeOptimizationEnabled:i.sizeOptimizationEnabled,view:i.view,minValue:a,maxValue:l,filter:p,signal:m})),k={layer:u,valueExpression:v,defaultSymbolEnabled:s,symbolType:o},x=await we(S,d,null,null,k),T=x.renderer.authoringInfo?.visualVariables;return T?.forEach((e=>w(e,t,n,y))),{...x,unit:y}}async function Ie(e){const{renderer:i,creatorParameters:r}=await async function(e){const i="regenerate-size-age-renderer";await $(e,i);const r=await W(e);if("size-age"!==H(r))throw new s(`${i}:invalid-parameters`,"Renderer is invalid");const{authoringInfo:t}=r,n=t?.visualVariables.find((e=>"size"===e.type)),o=n.startTime,a=n.endTime,l=n.units,m=n.theme,{layer:p,filter:u,view:c,signal:d}=e,y=Z(r),f=J(r),h=await he({layer:p,startTime:o,endTime:a,unit:l,theme:m,outlineOptimizationEnabled:y,sizeOptimizationEnabled:f,filter:u,view:c,signal:d});return{...e,creatorParameters:h,renderer:r}}(e),{layer:t,outlineOptimizationEnabled:n,sizeOptimizationEnabled:o,startTime:a,endTime:l,theme:m,view:p,signal:u,filter:c}=r,[d,y]=await Promise.all([f({view:p,layer:t,startTime:a,endTime:l,signal:u,filter:c}),n?j({layer:t,view:p,filter:c,signal:u}).catch(b):null]),{unit:h,statistics:v}=d,{valueExpression:g,title:S}=await z(r,h),k=await ge(fe({layer:t,valueExpression:g,statistics:v,legendOptions:{title:S},sizeOptimizationEnabled:o,theme:m,view:p,filter:c,signal:u}));N(i,k.visualVariables,K),N(i,y?.visualVariables,X),i.authoringInfo=k.authoringInfo.clone();const x=i.authoringInfo?.visualVariables;return x?.forEach((e=>w(e,a,l,h))),{renderer:i}}export{Ue as createAgeRenderer,Ve as createClassBreaksRenderer,ke as createContinuousRenderer,ge as createVisualVariables,Ie as regenerateAgeRenderer,Ee as regenerateClassBreaksRenderer,xe as regenerateContinuousRenderer,Se as regenerateVisualVariables,Te as updateRendererWithReferenceSize};
