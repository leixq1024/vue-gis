/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{a as e,c as t}from"./mat3f32.js";import{c as s,f as o}from"./config.js";import{a as i,R as l,T as n}from"./StyleDefinition.js";import{B as r}from"./enums3.js";import{i as c}from"./GeometryUtils.js";import{T as a}from"./TiledDisplayObject.js";class h{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}}class y{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function u(e,t,s,o,i,l){const n=s-i;if(n>=0)return(t>>n)+(o-(l<<n))*(e>>n);const r=-n;return t-(l-(o<<r))*(e>>r)<<r}class f{constructor(e,t,s){this._rows=Math.ceil(t/s),this._columns=Math.ceil(e/s),this._cellSize=s,this.cells=new Array(this._rows);for(let e=0;e<this._rows;e++){this.cells[e]=new Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[e][t]=[]}}getCell(e,t){const s=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),o=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[s]&&this.cells[s][o]||null}getCellSpan(e,t,s,o){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(o/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function m(e,t,s,o,i,l,n){const r=t[o++];for(let c=0;c<r;c++){const r=new h(l,n);r.xTile=t[o++],r.yTile=t[o++],r.hash=t[o++],r.priority=t[o++],r.featureIndex=t[o++];const c=t[o++];for(let e=0;e<c;e++){const e=t[o++],i=t[o++],l=t[o++],n=t[o++],c=!!t[o++],a=t[o++],h=s[o++],y=s[o++],u=t[o++],f=t[o++];r.colliders.push({xTile:e,yTile:i,dxPixels:l,dyPixels:n,hard:c,partIndex:a,width:u,height:f,minLod:h,maxLod:y})}const a=e[o++];for(let t=0;t<a;t++)r.textVertexRanges.push([e[o++],e[o++]]);const y=e[o++];for(let t=0;t<y;t++)r.iconVertexRanges.push([e[o++],e[o++]]);i.push(r)}return o}function d(e,t,s){for(const[o,i]of e.symbols)b(e,t,s,i,o)}function b(e,t,s,o,i){const l=e.layerData.get(i);if(l.type===r.SYMBOL){for(const t of o){const o=t.unique;let i;if(t.selectedForRendering){const t=o.parts[0],l=t.startOpacity,n=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===n;const r=s?Math.floor(127*l)|n<<7:n?255:0;i=r<<24|r<<16|r<<8|r}else i=0;for(const[e,s]of t.iconVertexRanges)for(let t=e;t<e+s;t+=4)l.iconOpacity[t/4]=i;if(t.selectedForRendering){const t=o.parts[1],l=t.startOpacity,n=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===n;const r=s?Math.floor(127*l)|n<<7:n?255:0;i=r<<24|r<<16|r<<8|r}else i=0;for(const[e,s]of t.textVertexRanges)for(let t=e;t<e+s;t+=4)l.textOpacity[t/4]=i}l.lastOpacityUpdate=t,l.opacityChanged=!0}}function _(e,t,s,o){const i=e.colliders;let l,n,r,a;for(const h of i)if(e.unique.show&&e.unique.parts[h.partIndex].show&&(l=h.xScreen-o[0]+h.dxScreen,n=h.yScreen-o[1]+h.dyScreen,r=l+h.width,a=n+h.height,c(s,t.x,t.y,l,n,r,a)))return!0;return!1}function p(e,t,s,o,i,r){const{iconRotationAlignment:c,textRotationAlignment:a,iconTranslate:h,iconTranslateAnchor:y,textTranslate:u,textTranslateAnchor:f}=o;let m=0;for(const o of e.colliders){const[e,d]=0===o.partIndex?h:u,b=0===o.partIndex?y:f,_=o.minLod<=r&&r<=o.maxLod;m+=_?0:1,o.enabled=_,o.xScreen=o.xTile*i[0]+o.yTile*i[3]+i[6],o.yScreen=o.xTile*i[1]+o.yTile*i[4]+i[7],b===n.MAP?(o.xScreen+=s*e-t*d,o.yScreen+=t*e+s*d):(o.xScreen+=e,o.yScreen+=d),l.VIEWPORT===(0===o.partIndex?c:a)?(o.dxScreen=o.dxPixels,o.dyScreen=o.dyPixels):(o.dxScreen=s*(o.dxPixels+o.width/2)-t*(o.dyPixels+o.height/2)-o.width/2,o.dyScreen=t*(o.dxPixels+o.width/2)+s*(o.dyPixels+o.height/2)-o.height/2)}e.colliders.length>0&&m===e.colliders.length&&(e.unique.show=!1)}class g{constructor(t,o,i,l,n,r){this._symbols=t,this._styleRepository=l,this._zoom=n,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new f(o,i,s),this._si=Math.sin(Math.PI*r/180),this._co=Math.cos(Math.PI*r/180);for(const s of t)for(const t of s.symbols)this._allNeededMatrices.has(t.tile)||this._allNeededMatrices.set(t.tile,e(t.tile.transforms.tileUnitsToPixels))}work(e){const t=this._gridIndex;function s(e){const s=e.xScreen+e.dxScreen,o=e.yScreen+e.dyScreen,i=s+e.width,l=o+e.height,[n,r,c,a]=t.getCellSpan(s,o,i,l);for(let e=r;e<=a;e++)for(let r=n;r<=c;r++){const n=t.cells[e][r];for(const e of n){const t=e.xScreen+e.dxScreen,n=e.yScreen+e.dyScreen,r=t+e.width,c=n+e.height;if(!(i<t||s>r||l<n||o>c))return!0}}return!1}const o=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const t=this._symbols[this._currentLayerCursor],i=this._getProperties(t.styleLayerUID);for(;this._currentSymbolCursor<t.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-o>e)return!1;const l=t.symbols[this._currentSymbolCursor];if(!l.unique.show)continue;p(l,this._si,this._co,i,this._allNeededMatrices.get(l.tile),this._zoom);const n=l.unique;if(!n.show)continue;const{iconAllowOverlap:r,iconIgnorePlacement:c,textAllowOverlap:a,textIgnorePlacement:h}=i;for(const e of l.colliders){if(!e.enabled)continue;const t=n.parts[e.partIndex];t.show&&!(e.partIndex?a:r)&&s(e)&&(e.hard?n.show=!1:t.show=!1)}if(n.show)for(const e of l.colliders){if(!e.enabled)continue;if(e.partIndex?h:c)continue;if(!n.parts[e.partIndex].show)continue;const t=e.xScreen+e.dxScreen,s=e.yScreen+e.dyScreen,o=t+e.width,i=s+e.height,[l,r,a,y]=this._gridIndex.getCellSpan(t,s,o,i);for(let t=r;t<=y;t++)for(let s=l;s<=a;s++)this._gridIndex.cells[t][s].push(e)}}}return!0}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const s=this._zoom,o=this._styleRepository.getStyleLayerByUID(e),n=o.getLayoutValue("symbol-placement",s)!==i.POINT;let r=o.getLayoutValue("icon-rotation-alignment",s);r===l.AUTO&&(r=n?l.MAP:l.VIEWPORT);let c=o.getLayoutValue("text-rotation-alignment",s);c===l.AUTO&&(c=n?l.MAP:l.VIEWPORT);const a=o.getPaintValue("icon-translate",s),h=o.getPaintValue("icon-translate-anchor",s),y=o.getPaintValue("text-translate",s),u=o.getPaintValue("text-translate-anchor",s),f={iconAllowOverlap:o.getLayoutValue("icon-allow-overlap",s),iconIgnorePlacement:o.getLayoutValue("icon-ignore-placement",s),textAllowOverlap:o.getLayoutValue("text-allow-overlap",s),textIgnorePlacement:o.getLayoutValue("text-ignore-placement",s),iconRotationAlignment:r,textRotationAlignment:c,iconTranslateAnchor:h,iconTranslate:a,textTranslateAnchor:u,textTranslate:y};return this._styleProps.set(e,f),f}}function S(e,t){if(e.priority-t.priority)return e.priority-t.priority;const s=e.tile.key,o=t.tile.key;return s.world-o.world?s.world-o.world:s.level-o.level?s.level-o.level:s.row-o.row?s.row-o.row:s.col-o.col?s.col-o.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}class x{get running(){return this._running}constructor(e,t,s,o,i,l){this._visibleTiles=e,this._symbolRepository=t,this._createCollisionJob=s,this._assignTileSymbolsOpacity=o,this._symbolLayerSorter=i,this._isLayerVisible=l,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}return this._running=!1,!0}_createSelectionJob(){const e=this._symbolRepository.uniqueSymbols;for(let t=0;t<e.length;t++){const s=e[t];for(let e=0;e<s.uniqueSymbols.length;e++){const t=s.uniqueSymbols[e];for(const e of t.tileSymbols)e.selectedForRendering=!1}}const t=[];let s=0,o=0;const i=this._isLayerVisible,l=this._symbolLayerSorter;return{work:function(l){let n;const r=performance.now();for(;o<e.length;o++,s=0){const c=e[o],a=c.styleLayerUID;if(!i(a)){t[o]||(t[o]={styleLayerUID:a,symbols:[]});continue}t[o]=t[o]||{styleLayerUID:a,symbols:[]};const h=t[o];for(;s<c.uniqueSymbols.length;s++){if(n=c.uniqueSymbols[s],s%100==99&&performance.now()-r>l)return!1;let e=null,t=!1,o=!1;for(const s of n.tileSymbols)if(!o||!t){const i=s.tile;(!e||i.isCoverage||i.neededForCoverage&&!t)&&(e=s,(i.neededForCoverage||i.isCoverage)&&(o=!0),i.isCoverage&&(t=!0))}if(e.selectedForRendering=!0,o){h.symbols.push(e),n.show=!0;for(const e of n.parts)e.show=!0}else n.show=!1}}for(const e of t)e.symbols.sort(S);return!0},get sortedSymbols(){return t.sort(l)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,t=this._visibleTiles;let s=0;function o(t,s){for(const e of t.symbols.values())w(e,s);e(t,s);for(const e of t.childrenTiles)o(e,s)}return{work(e){const i=performance.now();for(;s<t.length;s++){if(performance.now()-i>e)return!1;const l=t[s];null==l.parentTile&&o(l,performance.now())}return!0}}}}function w(e,t){for(const s of e){const e=s.unique;for(const s of e.parts){const i=s.targetOpacity>.5?1:-1;s.startOpacity+=i*((t-s.startTime)/o),s.startOpacity=Math.min(Math.max(s.startOpacity,0),1),s.startTime=t,s.targetOpacity=e.show&&s.show?1:0}}}class T{constructor(e,t,s){this.tileCoordRange=e,this._visibleTiles=t,this._createUnique=s,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(e,t){this._uniqueSymbolLayerArray=null;let s=this._tiles.get(e.id);s||(s={symbols:new Map},this._tiles.set(e.id,s));const o=new Map;if(t)for(const e of t)s.symbols.has(e)&&(o.set(e,s.symbols.get(e)),s.symbols.delete(e));else for(const[t,i]of e.layerData)s.symbols.has(t)&&(o.set(t,s.symbols.get(t)),s.symbols.delete(t));this._removeSymbols(o);const i=e.symbols,l=new Map;for(const[e,t]of i){let o=t.length;if(o>=32){let i=this.tileCoordRange;do{i/=2,o/=4}while(o>8&&i>64);const n=new f(this.tileCoordRange,this.tileCoordRange,i);l.set(e,{flat:t,index:n}),s.symbols.set(e,{flat:t,index:n});for(const e of t)n.getCell(e.xTile,e.yTile).push(e)}else l.set(e,{flat:t}),s.symbols.set(e,{flat:t})}this._addSymbols(e.key,i)}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[t,s]of this._tiles){const o=new Map;for(const t of e)s.symbols.has(t)&&(o.set(t,s.symbols.get(t)),s.symbols.delete(t));this._removeSymbols(o),0===s.symbols.size&&this._tiles.delete(t)}}removeTile(e){this._uniqueSymbolLayerArray=null;const t=this._tiles.get(e.id);if(!t)return;const s=new Map;for(const[o,i]of e.symbols)t.symbols.has(o)&&(s.set(o,t.symbols.get(o)),t.symbols.delete(o));this._removeSymbols(s),0===t.symbols.size&&this._tiles.delete(e.id)}querySymbols(e,t,s,o){const i=[],l=this.uniqueSymbols;for(const o of l){const l=o.styleLayerUID,n=o.uniqueSymbols;for(const o of n){const n=o.tileSymbols.find((e=>e.selectedForRendering));n&&_(n,e,t*(window.devicePixelRatio||1),s)&&i.push({vtlSymbol:n,styleLayerUID:l,tileKey:n.tile.key})}}return i}_removeSymbols(e){for(const[t,{flat:s}]of e)for(const e of s){const s=e.unique,o=s.tileSymbols,i=o.length-1;for(let t=0;t<i;t++)if(o[t]===e){o[t]=o[i];break}if(o.length=i,0===i){const e=this._uniqueSymbolsReferences.get(t);e.delete(s),0===e.size&&this._uniqueSymbolsReferences.delete(t)}e.unique=null}}_addSymbols(e,t){if(0===t.size)return;const s=this._visibleTiles;for(const o of s)o.parentTile||o.key.world!==e.world||o.key.level===e.level&&!o.key.equals(e)||this._matchSymbols(o,e,t);for(const[e,s]of t)for(const t of s)if(null==t.unique){const s=this._createUnique();t.unique=s,s.tileSymbols.push(t);let o=this._uniqueSymbolsReferences.get(e);o||(o=new Set,this._uniqueSymbolsReferences.set(e,o)),o.add(s)}}_matchSymbols(e,t,s){if(e.key.level>t.level){const s=e.key.level-t.level;if(e.key.row>>s!==t.row||e.key.col>>s!==t.col)return}if(t.level>e.key.level){const s=t.level-e.key.level;if(t.row>>s!==e.key.row||t.col>>s!==e.key.col)return}if(t.equals(e.key)){for(const o of e.childrenTiles)this._matchSymbols(o,t,s);return}const o=new Map;for(const[i,l]of s){const s=[];for(const o of l){const i=u(this.tileCoordRange,o.xTile,t.level,t.col,e.key.level,e.key.col),l=u(this.tileCoordRange,o.yTile,t.level,t.row,e.key.level,e.key.row);i>=0&&i<this.tileCoordRange&&l>=0&&l<this.tileCoordRange&&s.push({symbol:o,xTransformed:i,yTransformed:l})}const n=[],r=20+(e.key.level<t.level?1:1<<e.key.level-t.level),c=this._tiles.get(e.id).symbols.get(i);if(c){const e=c.flat;for(const t of s){let s,o=!1;const i=t.xTransformed,l=t.yTransformed;s=null!=c.index?c.index.getCell(i,l):e;const a=t.symbol,h=a.hash;for(const e of s)if(h===e.hash&&Math.abs(i-e.xTile)<=r&&Math.abs(l-e.yTile)<=r){const t=e.unique;a.unique=t,t.tileSymbols.push(a),o=!0;break}o||n.push(a)}}n.length>0&&o.set(i,n)}for(const s of e.childrenTiles)this._matchSymbols(s,t,o)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,t=new Array(e.size);let s,o=0;for(const[i,l]of e){const e=new Array(l.size);s=0;for(const t of l)e[s++]=t;t[o]={styleLayerUID:i,uniqueSymbols:e},o++}return t}}class M extends a{_createTransforms(){return{displayViewScreenMat3:t(),tileMat3:t()}}}export{g as C,M as R,T as S,y as V,x as a,m as d,d as w};
