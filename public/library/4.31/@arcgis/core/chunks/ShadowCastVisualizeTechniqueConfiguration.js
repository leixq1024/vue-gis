/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{l as t,c as e}from"./mathUtils.js";import{f as n,l as i,d as o,h as a,r}from"./mat4.js";import{c}from"./mat4f64.js";import{m as s,h as l}from"./vec2.js";import{f as u,c as d}from"./vec2f64.js";import{f,l as m,n as h,s as g,m as b,g as p,i as y}from"./vec3.js";import{f as v,a as A,c as M}from"./vec3f64.js";import{V as N}from"./ViewingMode.js";import{b as T}from"./mathUtils2.js";import{_ as w}from"./tslib.es6.js";import{p as P,S as x}from"./ShaderTechniqueConfiguration.js";var O=Math.PI,E=Math.sin,I=Math.cos,z=Math.tan,G=Math.asin,S=Math.atan2,j=Math.acos,D=O/180,H=864e5,L=2440588,R=2451545,U={dec:0,ra:0};function _(t){return new Date((t+.5-L)*H)}function F(t){return function(t){return t.valueOf()/H-.5+L}(t)-R}var C=23.4397*D;function V(t,e){return S(E(t)*I(C)-z(e)*E(C),I(t))}function k(t,e){return G(E(e)*I(C)+I(e)*E(C)*E(t))}function q(t,e,n){return S(E(t),I(t)*E(e)-z(n)*I(e))}function B(t,e,n){return G(E(e)*E(n)+I(e)*I(n)*I(t))}function J(t,e){return D*(280.16+360.9856235*t)-e}function K(t){return D*(357.5291+.98560028*t)}function Q(t){return D*(1.9148*E(t)+.02*E(2*t)+3e-4*E(3*t))}function W(t,e){return t+e+102.9372*D+O}function X(t,e){var n=K(t),i=W(n,Q(n));return e||(e={dec:0,ra:0}),e.dec=k(i,0),e.ra=V(i,0),e}var Y={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(t,e,n,i){var o=D*-n,a=D*e,r=F(t),c=X(r,U),s=J(r,o)-c.ra;return i||(i={azimuth:0,altitude:0}),i.azimuth=q(s,a,c.dec),i.altitude=B(s,a,c.dec),i}},Z=[[-.83,"sunrise","sunset"]];Y.addTime=function(t,e,n){Z.push([t,e,n])};var $=9e-4;function tt(t,e,n){return $+(t+e)/(2*O)+n}function et(t,e,n){return R+t+.0053*E(e)-.0069*E(2*n)}function nt(t){var e=D*(134.963+13.064993*t),n=D*(93.272+13.22935*t),i=D*(218.316+13.176396*t)+6.289*D*E(e),o=5.128*D*E(n),a=385001-20905*I(e);return{ra:V(i,o),dec:k(i,o),dist:a}}Y.getTimes=function(t,e,n){var i=D*-n,o=D*e,a=function(t,e){return Math.round(t-$-e/(2*O))}(F(t),i),r=tt(0,i,a),c=K(r),s=Q(c),l=W(c,s),u=k(l,0),d=et(r,c,l);function f(t){var e=function(t,e,n){return j((E(t)-E(e)*E(n))/(I(e)*I(n)))}(t,o,u);return et(tt(e,i,a),c,l)}var m,h,g,b,p,y,v,A={solarNoon:_(d),nadir:_(d-.5),polarException:Y.PolarException.NORMAL};for(m=0,h=Z.length;m<h;m+=1)p=d-((b=f((g=Z[m])[0]*D))-d),A[g[1]]=_(p),A[g[2]]=_(b);return A.polarException=(y=Z[0][0]*D,(v=(E(y)-E(o)*E(u))/(I(o)*I(u)))<-1?Y.PolarException.MIDNIGHT_SUN:v>1?Y.PolarException.POLAR_NIGHT:Y.PolarException.NORMAL),A},Y.getMoonPosition=function(t,e,n){var i=D*-n,o=D*e,a=F(t),r=nt(a),c=J(a,i)-r.ra,s=B(c,o,r.dec);return s+=.017*D/z(s+10.26*D/(s+5.1*D)),{azimuth:q(c,o,r.dec),altitude:s,distance:r.dist}},Y.getMoonFraction=function(t){var e=F(t),n=X(e),i=nt(e),o=149598e3,a=j(E(n.dec)*E(i.dec)+I(n.dec)*I(i.dec)*I(n.ra-i.ra)),r=S(o*E(a),i.dist-o*I(a));return(1+I(r))/2};const it={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class ot{constructor(t,e){this.direct=t,this.ambient=e}}function at(n,i,o,a,r,c){f(c.ambient.color,1,1,1),c.ambient.intensity=it.global.ambient,f(c.direct.color,1,1,1),c.direct.intensity=it.global.direct;const u=i[2],h=e((Math.abs(u)-it.local.altitude)/(it.global.altitude-it.local.altitude),0,1);let g;if(c.globalFactor=h,null!=n&&(g=Y.getTimes(n,i[1],i[0])),h<1){let e;if(null!=n)e=function(t,e,n){const i=t.valueOf();let o,a;e.polarException===Y.PolarException.MIDNIGHT_SUN?(o=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):e.polarException===Y.PolarException.POLAR_NIGHT?(o=i-2,a=i-1):(o=e.sunrise.valueOf(),a=e.sunset.valueOf());const r=a-o,c=o+r/2,u=r/4,f=c-u,h=c+u,g=.06*r,b=o-g/2,p=o+g/2,v=a-g/2,A=a+g/2,N=d(),T=M(),w=M();let P="";if(i<b||i>A)s(N,wt),y(T,bt),y(w,At),P="night";else if(i<p){const t=(i-b)/(p-b);l(N,wt,Pt,t),m(T,bt,pt,t),m(w,At,Mt,t),P="sun rising"}else if(i<f){const t=(i-p)/(f-p);l(N,Pt,xt,t),m(T,pt,yt,t),m(w,Mt,Nt,t),P="early morning"}else if(i<c){const t=(i-f)/(c-f);l(N,xt,Ot,t),m(T,yt,vt,t),m(w,Nt,Tt,t),P="late morning"}else if(i<h){const t=(i-c)/(h-c);l(N,Ot,Et,t),m(T,vt,It,t),m(w,Tt,zt,t),P="early afternoon"}else if(i<v){const t=(i-h)/(v-h);l(N,Et,Gt,t),m(T,It,St,t),m(w,zt,jt,t),P="late afternoon"}else if(i<A){const t=(i-v)/(A-v);l(N,Gt,wt,t),m(T,St,bt,t),m(w,jt,At,t),P="sun setting"}let x=0;switch(n){case"rainy":case"foggy":x=.8;break;case"snowy":x=.5}x>0&&(gt(T,x),gt(w,x));const O=ht(n);return{direct:{intensity:N[0]*O.direct,color:T},ambient:{intensity:N[1]*O.ambient,color:w},timeOfDay:P}}(n,g,a);else{const t=ht(a);e={direct:{intensity:it.local.directAtNoon*t.direct,color:v(1,1,1)},ambient:{intensity:it.local.ambientAtNoon*t.ambient,color:v(1,1,1)},timeOfDay:"early afternoon"}}m(c.ambient.color,e.ambient.color,c.ambient.color,h),c.ambient.intensity=t(e.ambient.intensity,c.ambient.intensity,h),m(c.direct.color,e.direct.color,c.direct.color,h),c.direct.intensity=t(e.direct.intensity,c.direct.intensity,h),c.specularStrength="rainy"===a||"snowy"===a||"foggy"===a?0:1,c.environmentStrength="rainy"===a?.7:"snowy"===a||"foggy"===a?.75:1}c.noonFactor=null!=n?function(t,n){const i=t.valueOf();let o,a;n.polarException===Y.PolarException.MIDNIGHT_SUN?(o=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=o+432e6):n.polarException===Y.PolarException.POLAR_NIGHT?(o=i-2,a=i-1):(o=n.sunrise.valueOf(),a=n.sunset.valueOf());const r=o+(a-o)/2;return 1-e(Math.abs(i-r)/432e5,0,1)}(n,g):1,null!=n?ct(n,i,o,c.direct.directionToLightSource):rt(r,o,c.direct.directionToLightSource)}function rt(t,e,i){e===N.Global?h(Lt,t.eye):f(Lt,0,0,1),g(Rt,t.viewForward,-1);const o=T(Rt,Lt),a=Math.max(o-2*_t,0),r=.85*a/(a+1),c=Math.max(_t,o-_t-r);n(Ht,-c,t.viewRight),b(i,Rt,Ht),p(i,i,g(Ut,t.viewRight,Ft)),h(i,i)}function ct(t,n,c,s){const l=mt,u=i(ft);if(c===N.Global)Y.getPosition(t,0,0,l),f(s,0,0,-1),o(u,u,-l.azimuth),a(u,u,-l.altitude),b(s,s,u);else{const i=it.planarDirection,a=i.globalAngles,c=n[2];let d=(Math.abs(c)-i.localAltitude)/(i.globalAltitude-i.localAltitude);d=e(d,0,1),d<1?(Y.getPosition(t,n[1],n[0],l),l.azimuth=(1-d)*l.azimuth+d*a.azimuth,l.altitude=(1-d)*l.altitude+d*a.altitude):(l.azimuth=a.azimuth,l.altitude=a.altitude),f(s,0,-1,0),r(u,u,-l.azimuth),o(u,u,-l.altitude),b(s,s,u)}}function st(t,e){if(e===N.Global)return!0;const n=it.planarDirection;return Math.abs(t)<n.localAltitude}function lt(t,e,n,i,o){const a=t.getTime(),r=e.getTime()-a,c=Math.floor(r/n)+1,s=new Array(c);for(let t=0;t<c;++t)Dt.setTime(a+n*t),s[t]=M(),ct(Dt,i,o,s[t]);return s}const ut=v(.5773502691896258,-.5773502691896258,.5773502691896258);class dt{constructor(){this.ambient={color:v(1,1,1),intensity:.55},this.direct={color:v(1,1,1),intensity:.55,directionToLightSource:A(ut)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const ft=c(),mt={azimuth:0,altitude:0};function ht(t){switch(t){case"disabled":case"sunny":case"cloudy":return new ot(1,1);case"rainy":return new ot(.4,1.2);case"snowy":return new ot(.5,1.3);case"foggy":return new ot(.2,1.6)}}function gt(t,e){const n=(t[0]+t[1]+t[2])/3;t[0]+=(n-t[0])*e,t[1]+=(n-t[1])*e,t[2]+=(n-t[2])*e}const bt=v(.01,.01,.01),pt=v(1,.6,.5),yt=v(1,.98,.98),vt=v(1,1,1),At=v(.8,.8,1),Mt=v(.8,.8,1),Nt=v(.98,.98,1),Tt=v(1,1,1),wt=u(.01,it.local.ambientAtNight),Pt=u(it.local.directAtTwilight,it.local.ambientAtTwilight),xt=u(.9*it.local.directAtNoon,it.local.ambientAtNoon),Ot=u(it.local.directAtNoon,it.local.ambientAtNoon),Et=xt,It=yt,zt=Nt,Gt=Pt,St=pt,jt=Mt,Dt=new Date(0),Ht=c(),Lt=M(),Rt=M(),Ut=M(),_t=.25,Ft=.2;var Ct;!function(t){t[t.Gradient=0]="Gradient",t[t.Threshold=1]="Threshold",t[t.COUNT=2]="COUNT"}(Ct||(Ct={}));class Vt extends x{constructor(){super(...arguments),this.visualization=Ct.Gradient,this.bandsEnabled=!1}}w([P({count:Ct.COUNT})],Vt.prototype,"visualization",void 0),w([P()],Vt.prototype,"bandsEnabled",void 0);export{dt as C,Y as S,Ct as a,at as b,lt as c,rt as d,st as e,Vt as f};
