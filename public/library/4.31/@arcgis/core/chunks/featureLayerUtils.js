/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{id as t}from"../kernel.js";import{symbolTypesRenderer as e}from"../symbols.js";import{a as r}from"./asyncUtils.js";import n from"../core/Error.js";import{J as o}from"./jsonMap.js";import{parseWhereClause as s}from"../core/sql.js";import{n as a}from"./uuid.js";import{c as i}from"../core/accessorSupport/decorators/subclass.js";import u,{C as c}from"../layers/support/CodedValueDomain.js";import{q as l}from"./featureQueryAll.js";import{isStringField as p,isIntegerField as d}from"../layers/support/fieldUtils.js";import{f}from"./layerUtils.js";import y from"../renderers/SimpleRenderer.js";import m from"../renderers/UniqueValueRenderer.js";import h from"../rest/support/AttachmentQuery.js";import w from"../rest/support/Query.js";import b from"../rest/support/RelationshipQuery.js";const g=new o({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function I(t,e,r,o){const s=await J(t);if(await j(t,e,o),!s.addAttachment)throw new n(o,"Layer source does not support addAttachment capability");return s.addAttachment(e,r)}function j(t,e,r){const{attributes:o}=e,{objectIdField:s}=t;return t.capabilities?.data?.supportsAttachment?e?o?s&&o[s]?Promise.resolve():Promise.reject(new n(r,`feature is missing the identifying attribute ${s}`)):Promise.reject(new n(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new n(r,"A feature is required to add/delete/update attachments")):Promise.reject(new n(r,"this layer doesn't support attachments"))}async function F(t,e,r,o,s){const a=await J(t);if(await j(t,e,s),!a.updateAttachment)throw new n(s,"Layer source does not support updateAttachment capability");return a.updateAttachment(e,r,o)}async function q(t,e,r){const{applyEdits:n}=await import("./editingSupport.js"),o=await t.load();let s=r;return"feature"===o.type&&o.infoFor3D&&null!=e.deleteFeatures&&null!=o.globalIdField&&(s={...s,globalIdToObjectId:await K(o,e.deleteFeatures,o.globalIdField)}),n(o,o.source,e,r)}async function x(t,e,r){const{uploadAssets:n}=await import("./editingSupport.js"),o=await t.load();return n(o,o.source,e,r)}async function A(t,e,r,o){const s=await J(t);if(await j(t,e,o),!s.deleteAttachments)throw new n(o,"Layer source does not support deleteAttachments capability");return s.deleteAttachments(e,r)}async function v(t,e,r){const o=(await t.load({signal:e?.signal})).source;if(!o.fetchRecomputedExtents)throw new n(r,"Layer source does not support fetchUpdates capability");return o.fetchRecomputedExtents(e)}async function S(t,e,r,o){e=h.from(e),await t.load();const s=t.source,a=t.capabilities;if(!a?.data?.supportsAttachment)throw new n(o,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:u,globalIds:c,num:l,size:p,start:d,where:f}=e;if(!a?.operations?.supportsQueryAttachments&&(i?.length>0||c?.length>0||p?.length>0||l||d||f))throw new n(o,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e);if(!(u?.length||c?.length||f))throw new n(o,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);if(!s.queryAttachments)throw new n(o,"Layer source does not support queryAttachments capability",e);return s.queryAttachments(e)}async function O(t,e,r,o){const s=await J(t);if(!s.queryObjectIds)throw new n(o,"Layer source does not support queryObjectIds capability");return s.queryObjectIds(w.from(e)??t.createQuery(),r)}async function P(t,e,r,o){const s=await J(t);if(!s.queryFeatureCount)throw new n(o,"Layer source does not support queryFeatureCount capability");return s.queryFeatureCount(w.from(e)??t.createQuery(),r)}async function E(t,e,r,o){const s=await J(t);if(!s.queryExtent)throw new n(o,"Layer source does not support queryExtent capability");return s.queryExtent(w.from(e)??t.createQuery(),r)}async function L(t,e,r,o){const s=await J(t);if(!s.queryRelatedFeatures)throw new n(o,"Layer source does not support queryRelatedFeatures capability");return s.queryRelatedFeatures(b.from(e),r)}async function C(t,e,r,o){const s=await J(t);if(!s.queryRelatedFeaturesCount)throw new n(o,"Layer source does not support queryRelatedFeaturesCount capability");return s.queryRelatedFeaturesCount(b.from(e),r)}async function R(t){const e=t.source;if(e?.refresh)try{const{dataChanged:r,updates:n}=await e.refresh();if(null!=n&&(t.sourceJSON={...t.sourceJSON,...n},t.read(n,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await s(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function M(t){const e=new w,r=t.capabilities?.data,n=t.capabilities?.query;e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,n&&(e.compactGeometryEnabled=n.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=t.returnZ&&(e.returnZ=t.returnZ),r.supportsM&&null!=t.returnM&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:o,timeExtent:s}=t;return e.timeExtent=null!=o&&null!=s?s.offset(-o.value,o.unit):s||null,e.multipatchOption="multipatch"===t.geometryType?"xyFootprint":null,e}function D(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeGlobalID"===t.type)return t.name}function G(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeOID"===t.type)return t.name}function Q(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}function V(t,e){const{subtypes:r,subtypeField:n}=t;if(!e?.attributes||!r?.length||!n)return null;const o=e.attributes[n];return null==o?null:r.find((t=>t.code===o))}function T(t,e){const{fieldsIndex:r,subtypeField:n}=t,{name:o,type:s}=r.get(e)??{};if(!o)return null;if((n&&r.get(n)?.name)===o&&t.subtypes?.length){const e=t.subtypes.map((t=>new c({code:k(t.code,s),name:t.name})));if(e?.length)return new u({codedValues:e})}return null}function U(t,e){const{fieldsIndex:r}=t,{name:n,type:o}=r.get(e)??{};if(!n)return null;if(("typeIdField"in t?r.get(t.typeIdField)?.name:null)===n&&"types"in t&&t.types?.length){const e=t.types.map((t=>new c({code:k(t.id,o),name:t.name})));return new u({codedValues:e})}return null}function k(t,e){return e?p({type:e})&&"number"==typeof t?`${t}`:d({type:e})&&"string"==typeof t?Number.parseInt(t,10):t:t}async function J(t){return(await t.load()).source}async function N(e,r){if(!t)return;if(t.findCredential(e))return;let n;try{const o=await f(e,r);o&&(n=await t.checkSignInStatus(`${o}/sharing`))}catch(t){}if(n)try{const n=null!=r?r.signal:null;await t.getCredential(e,{signal:n})}catch(t){}}async function $(t,e,r){const n=t.parsedUrl?.path;n&&t.authenticationTriggerEvent===e&&await N(n,r)}function Z(t){return!X(t)&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}const B=i({types:e});function H(t,e){if(t.defaultSymbol)return t.types?.length?new m({defaultSymbol:B(t.defaultSymbol,t,e),field:t.typeIdField,uniqueValueInfos:t.types.map((t=>({id:t.id,symbol:B(t.symbol,t,e)})))}):new y({symbol:B(t.defaultSymbol,t,e)})}function z(t){let e=t.sourceJSON?.cacheMaxAge;if(!e)return!1;const r=t.editingInfo?.lastEditDate?.getTime();return null==r||(e*=1e3,Date.now()-r<e)}async function K(t,e,n){if(null==e)return null;const o=[],{objectIdField:s}=t;if(e.forEach((t=>{let e=null;if("attributes"in t){const{attributes:r}=t;e={globalId:r[n],objectId:null!=r[s]&&-1!==r[s]?r[s]:null}}else e={globalId:t.globalId,objectId:null!=t.objectId&&-1!==t.objectId?t.objectId:null};null!=e.globalId&&(null!=e.objectId&&-1!==e.objectId||o.push(e.globalId))})),0===o.length)return null;const i=t.createQuery();i.where=o.map((t=>`${n}='${t}'`)).join(" OR "),i.returnGeometry=!1,i.outFields=[s,n],i.cacheHint=!1;const u=await r(l(t,i));if(!u.ok)return null;const c=new Map,p=u.value.features;for(const t of p){const e=t.attributes[n],r=t.attributes[s];null!=e&&null!=r&&-1!==r&&c.set(a(e),r)}return c}function W(t,e,r){if(!e||!r||!t)return null;const n=r.getAttribute(e);return null==n?null:t.find((t=>{const{id:e}=t;return null!=e&&e.toString()===n.toString()}))??null}function X(t){return t.sourceJSON?.isMultiServicesView||function(t){return!!t.sourceJSON?.capabilities?.toLowerCase().split(",").map((t=>t.trim())).includes("map")}(t)}function Y(t,e,r){const o=e?.queryBins;if(!o)throw new n(r,"Layer source does not support binning");switch(t.binParameters.type){case"auto-interval":if(!o.supportsAutoInterval)throw new n(r,"Layer source does not support auto-interval binning");break;case"date":if(!o.supportsDate)throw new n(r,"Layer source does not support date binning");break;case"fixed-boundaries":if(!o.supportsFixedBoundaries)throw new n(r,"Layer source does not support fixed-boundaries binning");break;case"fixed-interval":if(!o.supportsFixedInterval)throw new n(r,"Layer source does not support fixed-interval binning")}const s=o?.supportedStatistics;if(t.outStatistics&&s){const e=new Map([["count","count"],["sum","sum"],["min","min"],["max","max"],["avg","avg"],["stddev","stddev"],["var","var"],["percentile-continuous","percentileContinuous"],["percentile-discrete","percentileDiscrete"],["centroid-aggregate","centroid"],["convex-hull-aggregate","convexHull"],["envelope-aggregate","envelope"]]);for(const{statisticType:o}of t.outStatistics){const t=e.get(o);if(t&&!s[t])throw new n(r,`Layer source does not support ${o} statistic type`)}}}export{z as A,X as B,Q as C,K as D,q as a,Z as b,H as c,I as d,$ as e,M as f,W as g,R as h,A as i,v as j,T as k,V as l,O as m,P as n,E as o,L as p,S as q,C as r,N as s,U as t,F as u,D as v,G as w,x,Y as y,g as z};
