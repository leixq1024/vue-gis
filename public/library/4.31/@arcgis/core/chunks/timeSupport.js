/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{f as t,g as r,a as n,h as i}from"../geometry/Extent.js";import{isPolygon as s,isExtent as l,getJsonType as o}from"../geometry/support/jsonUtils.js";import{m as u}from"./unitUtils.js";import{r as a,h as c,i as p,j as f,k as m,q as y,l as R,m as S}from"./featureConversionUtils.js";import{O as h}from"./OptimizedGeometry.js";import{c as d}from"./projectionSupport.js";const g=new h,G=new h,I=new h,P={esriGeometryPoint:c,esriGeometryPolyline:p,esriGeometryPolygon:f,esriGeometryMultipoint:m};function v(e,t,r,n=e.hasZ,i=e.hasM){if(null==t)return null;const s=e.hasZ&&n,l=e.hasM&&i;if(r){const o=y(I,t,e.hasZ,e.hasM,"esriGeometryPoint",r,n,i);return c(o,s,l)}return c(t,s,l)}function N(e,t,r,n,i,s,l=t,o=r){const u=t&&l,c=r&&o,p=null!=n?"coords"in n?n:n.geometry:null;if(null==p)return null;if(i){let n=R(G,p,t,r,e,i,l,o);return s&&(n=y(I,n,u,c,e,s)),P[e]?.(n,u,c)??null}if(s){const n=y(I,p,t,r,e,s,l,o);return P[e]?.(n,u,c)??null}return a(g,p,t,r,l,o),P[e]?.(g,u,c)??null}function j(e){return e&&w in e?JSON.parse(JSON.stringify(e,M)):e}const w="_geVersion",M=(e,t)=>e!==w?t:void 0;function E(e,t){return e?t?4:3:t?3:2}function b(e,t,r,n,i){if(!e)return!1;const s=E(t,r),{coords:l,lengths:o}=e;let u=!1,a=0;for(const e of o)u=T(u,l,s,a,e,n,i),a+=e*s;return u}function T(e,t,r,n,i,s,l){let o=e,u=n;for(let e=n,a=n+i*r;e<a;e+=r){u=e+r,u===a&&(u=n);const i=t[e],c=t[e+1],p=t[u],f=t[u+1];(c<l&&f>=l||f<l&&c>=l)&&i+(l-c)/(f-c)*(p-i)<s&&(o=!o)}return o}const C="unsupported-query",A={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},O={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},q={esriGeometryPoint:!0,esriGeometryMultiPatch:!1,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},x={esriGeometryPoint:!0,esriGeometryMultiPatch:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};function F(e,o,u,a,c){if(s(o)&&"esriGeometryPoint"===u&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=S(new h,o,!1,!1);return Promise.resolve((t=>function(e,t,r,n){return b(e,!1,!1,n.coords[0],n.coords[1])}(e,0,0,t)))}if(s(o)&&"esriGeometryMultipoint"===u){const t=S(new h,o,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((e=>function(e,t,r,n,i,s){const l=E(i,s),{coords:o,lengths:u}=n;if(!u)return!1;for(let t=0,r=0;t<u.length;t++,r+=l)if(!b(e,!1,!1,o[r],o[r+1]))return!1;return!0}(t,0,0,e,a,c)))}if(l(o)&&"esriGeometryPoint"===u&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((e=>n(o,N(u,a,c,e))));if(l(o)&&"esriGeometryMultipoint"===u&&"esriSpatialRelContains"===e)return Promise.resolve((e=>i(o,N(u,a,c,e))));if(l(o)&&"esriSpatialRelIntersects"===e){const e=function(e){return"mesh"===e?t:r(e)}(u);return Promise.resolve((t=>e(o,N(u,a,c,t))))}return import("./geometryEngineJSON.js").then((e=>e.g)).then((t=>{const r=t[A[e]].bind(null,o.spatialReference,o);return e=>r(N(u,a,c,e))}))}async function U(t,r,n){const{spatialRel:i,geometry:s}=t;if(s){if(null==(l=i)||!0!==O[l])throw new e(C,"Unsupported query spatial relationship",{query:t});var l;if(u(s.spatialReference)&&u(n)){if(!function(e){return null!=e&&!0===q[o(e)]}(s))throw new e(C,"Unsupported query geometry type",{query:t});if(!function(e){return null!=e&&!0===x[e]}(r))throw new e(C,"Unsupported layer geometry type",{query:t});if(t.outSR)return d(t.geometry?.spatialReference,t.outSR)}}}function J(e){if(l(e))return!0;if(s(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}async function V(e,t){if(!e)return null;const r=t.featureAdapter,{startTimeField:n,endTimeField:i}=e;let s=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(n&&i)await t.forEach((e=>{const t=r.getAttribute(e,n),o=r.getAttribute(e,i);null==t||isNaN(t)||(s=Math.min(s,t)),null==o||isNaN(o)||(l=Math.max(l,o))}));else{const e=n||i;await t.forEach((t=>{const n=r.getAttribute(t,e);null==n||isNaN(n)||(s=Math.min(s,n),l=Math.max(l,n))}))}return{start:s,end:l}}function Z(e,t,r){if(!t||!e)return null;const{startTimeField:n,endTimeField:i}=e;if(!n&&!i)return null;const{start:s,end:l}=t;if(null===s&&null===l)return null;if(void 0===s&&void 0===l)return()=>!1;const o=r.getAttributeAsTimestamp?.bind(r)??r.getAttribute.bind(r);return n&&i?function(e,t,r,n,i){return null!=n&&null!=i?s=>{const l=e(s,t),o=e(s,r);return(null==l||l<=i)&&(null==o||o>=n)}:null!=n?t=>{const i=e(t,r);return null==i||i>=n}:null!=i?r=>{const n=e(r,t);return null==n||n<=i}:void 0}(o,n,i,s,l):function(e,t,r,n){return null!=r&&null!=n&&r===n?n=>e(n,t)===r:null!=r&&null!=n?i=>{const s=e(i,t);return null!=s&&s>=r&&s<=n}:null!=r?n=>{const i=e(n,t);return null!=i&&i>=r}:null!=n?r=>{const i=e(r,t);return null!=i&&i<=n}:void 0}(o,n||i,s,l)}export{N as a,U as b,j as c,V as d,F as e,J as f,Z as g,v as t};
