/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{c as t,J as s}from"../core/lang.js";import{n as r}from"./mathUtils.js";import{f as i}from"./maybe.js";import{N as n}from"./NestedMap.js";import{P as a}from"../core/scheduling.js";import o,{f as h}from"../core/Accessor.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as u}from"../core/accessorSupport/decorators/subclass.js";import{c,i as m,t as d}from"./mat4.js";import{c as f}from"./mat4f64.js";import{g}from"./glUtil.js";import{S as p}from"./Matrix4PassUniform.js";import{a as y}from"./basicInterfaces.js";import{i as _}from"./StencilUtils.js";import{a as w}from"./Util.js";import{c as b}from"./vec3f64.js";import{V as v}from"./SceneLighting.js";var E,C;!function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(E||(E={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(C||(C={}));const O={required:[]},A={required:[p.Depth]};class D extends o{precompile(e){const t=this.acquireTechniques(e);return I(t),null!=t}consumes(){return O}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}modify(e){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}queryRenderOccludedState(e){return!1}}class H extends D{}class S extends D{}function I(e){Array.isArray(e)?e.forEach((e=>e?.release())):e?.release()}class M{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,s){const r=this._material.produces.get(t);if(!r?.(s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,t,s));const i=this._map.get(s);if(null!=i){if(i.ensureResources(e)===y.LOADED)return i;this._repository.requestRender()}return null}}class G extends v{constructor(e=b()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}}class R{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function x(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let s=!0;for(;s;){s=!1;for(let r=0;r<e.length;++r){const i=e.data[r],n=t.get(i.to);if(!n)return;i.to=n.to,t.delete(n.from),e.removeUnordered(n),s=!0}}}class B extends R{constructor(e,t,s){super(t,s),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}foreachHighlightGroup(e){this.isVisible&&this.geometry.foreachHighlightGroup(e)}get hasOccludees(){return null!=this.geometry.occludees}}class L{constructor(){this.first=0,this.count=0}}class T{constructor(){this._numElements=0,this._instances=new Map,this.holes=new a({allocator:e=>e||new R,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightGroups=new Set,this.drawCommandsDefault=N(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=N(),this.drawCommandsShadowHighlightRest=N()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightGroups.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightGroups.clear()}updateIfDrawCommandsDirty(e){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const e of this.instances.values())this.updateDrawState(e);this.updateDrawCommands(e)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,s){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=s,this._numElements+=r.numElements)}updateDrawState(e){e.isVisible?(e.foreachHighlightGroup((e=>this.highlightGroups.add(e))),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlights.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),s=this.holes.front();return null!=this.vao&&1===this.holes.length&&s.to===Math.floor(this.vao.byteSize/e)?(t.first=0,void(t.count=s.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from)),{drawCommandsHighlights:s}=this;for(const e of t)e.isVisible&&(V(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e),e.hasHighlights?e.foreachHighlightGroup((t=>{let r=s.get(t);r||(r=N(),s.set(t,r)),V(r,e)})):V(this.drawCommandsShadowHighlightRest,e))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function N(){return new a({allocator:e=>e||new L,deallocator:e=>e})}function V(e,t){const s=e.back();if(null==s){const s=e.pushNew();return s.first=t.from,void(s.count=t.numElements)}if(i=t,(r=s).first+r.count>=i.from){const e=t.from-s.first+t.numElements;s.count=e}else{const s=e.pushNew();s.first=t.from,s.count=t.numElements}var r,i}class j{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}let z=class extends H{get _hasAnyHighlight(){return this._highlightGroups.size>0}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new G,this._highlightGroups=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=i(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==p.Highlight&&t!==p.ShadowHighlight||this._hasAnyHighlight))&&e(t)))}))}initializeRenderContext(e,t){this._glMaterials=new M(this.material,t??e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,g(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((({geometry:t})=>e(t)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null==t)return;const s=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,i=this._dataByOrigin.get(e.localOrigin.id),n=i?.findBuffer(e.id);if(null==n)return;const a=n.instances.get(e.id);if(r.updateType&(C.GEOMETRY|C.TRANSFORMATION)){const r=Z(t.elementCount(a.geometry.geometry.attributes)*s),i=t.vertexBufferLayout.createView(r.buffer);this._writeGeometry(e,i,0),n.vao.vertexBuffers.get("geometry").setSubData(r,a.from*s,0,a.numElements*s)}r.updateType&(C.HIGHLIGHT|C.OCCLUDEE|C.VISIBILITY)&&(n.drawCommandsDirty=!0)}}_computeDeltas(e,t){const s=new n;for(const t of e){const e=t.localOrigin;if(null==e)continue;let r=s.get(e.id,null);null==r&&(r=new P(e.vec3),s.set(e.id,null,r)),r.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const r=this._dataByOrigin.get(t.id),i=r?.findBuffer(e.id);if(null==i)continue;let n=s.get(t.id,i);null==n&&(n=new P(t.vec3),s.set(t.id,i,n)),n.changes.push(e)}return s}_addAndRemoveGeometries(e,s){if(null==this._bufferWriter||null==this._vaoCache)return;const{_bufferWriter:r,_dataByOrigin:i}=this,n=r.vertexBufferLayout.stride/4,a=this._computeDeltas(e,s);a.forEach(((e,s)=>{const o=e.get(null),h=o?.changes??[];a.delete(s,null);let l=i.get(s);if(e.forEach(((e,o)=>{if(a.delete(s,o),null==o)return void w(!1,"No VAO for removed geometries");if(o.instances.size===e.changes.length)return this._vaoCache.deleteVao(o.vao),t(l.buffers,o),void(0===l.buffers.length&&0===h.length&&i.delete(s));const u=o.numElements,c=o.vao.byteSize/4,m=h.reduce(((e,t)=>e+r.elementCount(t.geometry.attributes)),0),d=e.changes.reduce(((e,t)=>e+r.elementCount(t.geometry.attributes)),0),f=Math.min((u+m-d)*n,Q),g=f>c;f>F&&f<c/2?(e.changes.forEach((({id:e})=>o.deleteInstance(e))),o.instances.forEach((({geometry:e})=>h.push(e))),this._vaoCache.deleteVao(o.vao),t(l.buffers,o)):g?this._applyAndRebuild(o,h,e):this._applyRemoves(o,e)})),h.length>0)for(null==l&&(l=new j(o.origin),i.set(s,l)),l.buffers.forEach((e=>this._applyAdds(e,h)));h.length>0;)l.buffers.push(this._applyAndRebuild(new T,h,null))}))}_updateDrawCommands(){this._highlightGroups.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.updateIfDrawCommandsDirty(this._bufferWriter.vertexBufferLayout.stride),e.hasHighlights&&h(this._highlightGroups,e.highlightGroups),this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,s){if(s)for(const t of s.changes)e.deleteInstance(t.id);const r=this._bufferWriter,i=r.vertexBufferLayout.stride,n=i/4,a=Math.floor(Q/n);let o=e.numElements;for(;t.length>0;){const s=t.pop(),i=r.elementCount(s.geometry.attributes);if(o+i>a&&o>0){t.push(s);break}o+=i;const n=new B(s,0,0);w(null==e.instances.get(s.id)),e.addInstance(s.id,n)}const h=o*n,l=Z(h),u=r.vertexBufferLayout.createView(l.buffer);let c=0;e.resetInstanceSummary(),e.instances.forEach(((t,s)=>{this._writeGeometry(t.geometry,u,c);const i=c;c+=r.elementCount(t.geometry.geometry.attributes),e.updateInstance(s,i,c),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao($(h)),e.vao.vertexBuffers.get("geometry").setSubData(l,0,0,c*n),e.holes.clear();const m=e.holes.pushNew();return m.from=c,m.to=Math.floor(e.vao.byteSize/i),e.updateDrawCommands(i),e}_applyRemoves(e,t){if(0===t.changes.length||null==this._bufferWriter)return;for(const s of t.changes){const t=s.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const i=Y.back();if(i){if(i.to===r.from){i.to=r.to;continue}if(i.from===r.to){i.from=r.from;continue}}const n=Y.pushNew();n.from=r.from,n.to=r.to}x(Y);const s=this._bufferWriter.vertexBufferLayout.stride/4,r=Y.reduce(((e,t)=>Math.max(e,t.numElements)),0)*s,i=Z(r);i.fill(0,0,r);const n=e.vao.vertexBuffers.get("geometry");Y.forAll((e=>n.setSubData(i,e.from*s,0,e.numElements*s))),e.holes.pushArray(Y.data,Y.length),Y.forAll(((e,t)=>Y.data[t]=null)),Y.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null==this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const r=this._bufferWriter,i=r.vertexBufferLayout.stride/4,n=e.numElements,a=t.reduce(((e,t)=>e+r.elementCount(t.geometry.attributes)),0),o=Math.min((n+a)*i,Q),h=4*o;if(e.vao.byteSize<$(Q-F)&&h>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);x(e.holes);const l=new Array;for(const s of t){const t=r.elementCount(s.geometry.attributes),i=U(e.holes,t);l.push(i)}const u=e.vao.vertexBuffers.get("geometry");let c=0,m=0,d=0;const f=Z(o),g=r.vertexBufferLayout.createView(f.buffer);t.forEach(((t,s)=>{const n=l[s];if(null==n)return;if(d!==n){const e=d-m;e>0&&u.setSubData(f,m*i,0,e*i),m=n,c=0}const a=r.elementCount(t.geometry.attributes);this._writeGeometry(t,g,c),c+=a,d=n+a;const o=new B(t,n,n+a);w(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0}));const p=d-m;p>0&&u.setSubData(f,m*i,0,p*i),s(t,((e,t)=>null==l[t]))}_writeGeometry(e,t,s){null!=this._bufferWriter&&(c(W,e.transformation),W[12]-=e.localOrigin.vec3[0],W[13]-=e.localOrigin.vec3[1],W[14]-=e.localOrigin.vec3[2],m(q,W),d(q,q),this._bufferWriter.write(W,q,e.geometry.attributes,e.geometry.objectAndLayerIdColor,t,s))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:s}=e,r=this.material.produces.get(s.slot);if(!r?.(t))return null;const{highlightGroupName:i,slot:n}=s,a=t===p.ShadowHighlight,o=t===p.Highlight,h=o||a,l=e=>h&&(0===this._highlightGroups.size||o&&!!i&&!e.has(i));if(l(this._highlightGroups))return null;const u=t===p.ShadowExcludeHighlight,c=!(h||u);for(const{buffers:r}of this._dataByOrigin.values())for(const o of r){if(l(o.highlightGroups))continue;const r=a?o.drawCommandsHighlights.size>0:h?i?o.drawCommandsHighlights.get(i):o.drawCommandsHighlights.size>0:((u&&o.needsMultipleCommands()?o.drawCommandsShadowHighlightRest:o.drawCommandsDefault)||null)?.length??!1,m=c&&o.drawCommandsOccludees||null;if(r||m?.length){const r=this._glMaterials.load(e.rctx,n,t),i=r?.beginSlot(s);if(i)return i}}return null}render(e,t){const{output:s,bind:r}=e,{slot:i,highlightGroupName:n}=r,a=s===p.Highlight;if(a&&!n)return;const o=s===p.ShadowHighlight,h=a||o,l=s===p.ShadowExcludeHighlight,u=!(h||l),c=i===_.OCCLUDER_MATERIAL||i===_.TRANSPARENT_OCCLUDER_MATERIAL?i:null,{rctx:m}=e;m.runAppleAmdDriverHelper();const d=m.bindTechnique(t,r,this.material.parameters);for(const e of this._dataByOrigin.values())for(const s of e.buffers){if(a&&(!s.hasHighlights||!s.drawCommandsHighlights.has(n)))continue;if(o&&!s.hasHighlights)continue;const i=()=>{const e=[];for(const t of s.drawCommandsHighlights.values())e.push(t);return e},f=h&&!o?s.drawCommandsHighlights.get(n)??null:null,g=o?i():h?f?[f]:ee:(l&&s.needsMultipleCommands()?[s.drawCommandsShadowHighlightRest]:[s.drawCommandsDefault])||ee,p=g.some((e=>e.length>0)),y=u&&s.drawCommandsOccludees||null;if(p||y?.length){if(this._drawParameters.origin=e.origin,d.bindDraw(r,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(s.vao),m.bindVAO(s.vao),p)for(const e of g)m.setPipelineState(t.getPipeline(!1,c)),e.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count)));y?.length&&(m.setPipelineState(t.getPipeline(!0,c)),y.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count))))}}}get test(){}};e([l({constructOnly:!0})],z.prototype,"material",void 0),z=e([u("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],z);class P{constructor(e){this.origin=e,this.changes=new Array}}function U(e,t){const s=e.find((e=>e.numElements>=t));if(null==s)return null;const r=s.from;return s.from+=t,s.from>=s.to&&e.removeUnordered(s),r}const W=f(),q=f(),Y=new a({allocator:e=>e||new R,deallocator:null}),F=65536,k=4*F,J=1024,K=16777216,Q=K/4;let X=new Float32Array(F);function Z(e){return X.length<e&&(X=new Float32Array(e)),X}function $(e){const t=4*e;return t<=J?J:t<k?r(t):Math.max(Math.min(Math.ceil(1.5*t/k)*k,K),t)}const ee=[];export{S as A,A as C,E as D,M as G,z as M,H as S,C as a,G as b,O as c,I as r,$ as s};
