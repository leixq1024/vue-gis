/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import r from"../core/Accessor.js";import{m as t}from"./handleUtils.js";import{c as s}from"./maybe.js";import"./Logger.js";import{h as i}from"../core/lang.js";import"../core/Error.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import{O as n}from"./vec3f64.js";import{O as o}from"./vec4f64.js";import{V as d}from"./ViewingMode.js";import{L as l,n as c}from"./LodRenderer.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import{g as h}from"./glUtil.js";import{S as m}from"./Matrix4PassUniform.js";import{S as f,b as p,G as g,s as _}from"./MergedRenderer.js";import{i as y}from"./StencilUtils.js";import{throwIfAborted as w}from"../core/promiseUtils.js";import{V as R}from"./VertexAttribute.js";import{m as v,t as b,L as I,a as G,b as x}from"./LodResources.js";import{c as M,r as L,d as C}from"./sdfPrimitives.js";import{C as S}from"./basicInterfaces.js";import{D,s as P}from"./DefaultMaterial.js";import{H as T}from"./HUDMaterial.js";let j=class extends f{constructor(e){super(e),this._hasHighlights=!1,this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new p,this._bufferWriter=null}get produces(){return this._produces}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach(((e,r)=>{this._produces.set(r,(r=>!!(r!==m.Highlight&&r!==m.ShadowHighlight||this._hasHighlights)&&e(r)))}))}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const r of e)this.removeRenderGeometry(r)}acquireTechniques(e){const r=this.material;if(!r.shouldRender(e))return null;const{output:t,bind:s}=e,i=r.produces.get(s.slot);if(!i?.(t))return null;if((t===m.Highlight||t===m.ShadowHighlight)&&!this._hasHighlights)return null;const a=this._glMaterials.load(e.rctx,s.slot,t);return a?.beginSlot(s)}render(e,r){const t=this._renderGeometries;if(0===t.size)return;const{bind:s}=e,i=s.slot===y.OCCLUDER_MATERIAL||s.slot===y.TRANSPARENT_OCCLUDER_MATERIAL?s.slot:null,a=e.rctx;a.runAppleAmdDriverHelper(),a.bindTechnique(r,s,this.material.parameters);const n=r.program;for(const[e,o]of t)this._drawParameters.origin=o.localOrigin,n.bindDraw(s,this.material.parameters,this._drawParameters),r.ensureAttributeLocations(o.vao),a.bindVAO(o.vao),a.setPipelineState(r.getPipeline(!1,i)),a.drawArrays(r.primitiveType,0,o.numElements)}initializeRenderContext(e,r){this._glMaterials=new g(this.material,e.materials);const t=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,h(this._bufferWriter.vertexBufferLayout));this._vaoCache=t}uninitializeRenderContext(){}addRenderGeometry(e,r,t){this.removeRenderGeometry(e);const s=this._bufferWriter.vertexBufferLayout.stride,i=this._vaoCache.newVao(_(r.data.byteLength));i.vertexBuffers.get("geometry").setSubData(new Uint8Array(r.data),0,0,r.elementCount*s);const a={localOrigin:t,vao:i,numElements:r.elementCount};return this._renderGeometries.set(e,a),a}removeRenderGeometry(e){const r=this._renderGeometries.get(e);null!=r&&(this._vaoCache.deleteVao(r.vao),this._renderGeometries.delete(e))}};e([u({constructOnly:!0})],j.prototype,"material",void 0),j=e([a("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],j);let E=class{constructor(e){this._optionalFields=new Array,this._instanceIndexToFeatureId=new Map,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=e.layerUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}async doLoad(e,r,t){i("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(R.OBJECTANDLAYERIDCOLOR);const s=function(e,r){const t=r.levels.map((r=>{const t=r.components.map((r=>{const t=e(r.materialId);if(!function(e){return null!=e&&"materialType"in e&&"default"===e.materialType}(t))throw new Error("LodRenderer only supports DefaultMaterial");const s=t.createBufferWriter(),i={material:t,vertexBufferLayout:s.vertexBufferLayout,buffer:r.renderGeometryBuffer.data,elementCount:r.renderGeometryBuffer.elementCount,boundingInfo:r.boundingInfo};return new I(i)}));return new G(t,r.minScreenSpaceRadius)}));return new x(t)}((e=>r(e)),e),a=this.view._stage,n=v(s);a.addMany(n),this._addDisposeResource((()=>a.removeMany(n)));const o=b(s);a.addMany(o),this._addDisposeResource((()=>{o.forEach((e=>e.unload())),a.removeMany(o)})),await Promise.all(o.map((e=>this.view._stage.schedule((()=>e.load(a.renderView.renderingContext)),t)))),w(t);const d=await this._createLodRenderer(s,t);this._lodRendererResources={lodRenderer:d,materials:n,textures:o}}addInstances(e){const r=this._lodRendererResources;if(null==r)return;const{featureIds:t,localTransforms:s,globalTransforms:i}=e,a=r.lodRenderer;if(null==a)return;const n=a.instanceData,o=t.length;for(let e=0;e<o;++e){const r=t[e],a=n.addInstance(),o=n.view,d=16*e;o.localTransform.copyFromTypedBuffer(a,s,d),o.globalTransform.copyFromTypedBuffer(a,i,d),n.updateModelTransform(a),n.setVisible(a,!0),this._instanceIndexToFeatureId.set(a,r),this._featureIdToInstanceIndex.set(r,a)}}removeInstances(e){const r=this._lodRendererResources;if(null==r)return;const t=r?.lodRenderer,s=t.instanceData,i=this._instanceIndexToFeatureId,a=this._featureIdToInstanceIndex,n=e.length;for(let r=0;r<n;++r){const t=e[r],n=a.get(t);null!=n&&(s.removeInstance(n),i.delete(n),a.delete(t))}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createLodRenderer(e,r){const t=this.view._stage,s={layerUid:this.layerUid,graphicUid:e=>1,notifyGraphicGeometryChanged:e=>1,notifyGraphicVisibilityChanged:e=>1},i=new l({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:null},this.scheduler);return i.slicePlaneEnabled=!1,this._addDisposeResource((()=>{t.removeRenderPlugin(i),i.destroy()})),await t.addRenderPlugin(i,r),i}};E=e([a("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],E);let A=class extends r{constructor(e){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.view=e.view,this.layerUid=e.layerUid}initialize(){}destroy(){}async executeRenderCommands(e){for(const r of e)switch(r.id){case"create-material":await this._createMaterial(r);break;case"create-direct-renderer":await this._createDirectRenderer(r);break;case"add-direct-renderer-geometry":await this._addDirectRendererGeometry(r);break;case"remove-direct-renderer-geometry":await this._removeDirectRendererGeometry(r);break;case"create-lod-renderer":await this._createLodRenderer(r);break;case"add-lod-instances":await this._addLodInstances(r);break;case"remove-lod-instances":await this._removeLodInstances(r)}}async _createMaterial(e){const{view:r}=this,{sharedSymbolResources:i}=r;if(null==i)throw new Error("No shared symbol resources found!");const{textures:a}=i,l=r.state.viewingMode===d.Global;let c=null;switch(e.type){case"default":c=function(e,r,t){const s={usePBR:r.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:P,ambient:n,diffuse:n,hasSlicePlane:r.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:r.castShadows,offsetTransparentBackfaces:!r.isPrimitive};return function(e){const r=e.opacity??1,t=r<1;e.transparent=t,e.opacity=r,e.cullFace=t?S.None:S.Back}(s),s.screenSizePerspective=e.screenSizePerspectiveSettings,s.externalColor=o,s.isInstanced=!0,new D(s,{spherical:t,doublePrecisionRequiresObfuscation:!0})}(i,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:r._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},l);break;case"hud":{const[e,r]=B(a,l);this.addHandles([t((()=>s(r)))]),c=e}break;default:throw new Error(`unable to create unknown material type ${e.type}`)}this._materials.set(e.materialId,c)}_getMaterial(e){return this._materials.get(e)}async _createDirectRenderer(e){const r=e.materialId,t=this._getMaterial(r);if(null==t)throw new Error(`material not found ${r}`);const{view:s}=this,i=new j({material:t});this._directRenderers.set(r,i),s._stage.addRenderPlugin(i),s._stage.renderView.renderer.updateHasFlags()}async _addDirectRendererGeometry(e){const r=e.renderGeometryId,t=e.materialId;null!=this._renderGeometries.get(r)&&await this._removeDirectRendererGeometry({renderGeometryId:r});const s=this._directRenderers.get(t);if(null==s)return void console.error("no renderer assigned to provided material");const i=s.addRenderGeometry(r,e.renderGeometryBuffer,e.localOrigin);this._renderGeometries.set(r,{renderGeometry:i,materialId:t}),this.view._stage.renderView.requestRender()}async _removeDirectRendererGeometry(e){const r=e.renderGeometryId,t=this._renderGeometries.get(r);if(null==t)return;const s=t.materialId,i=this._directRenderers.get(s);null!=i?i.removeRenderGeometry(e.renderGeometryId):console.error("no renderer assigned to provided material")}async _createLodRenderer(e){const r=new E({view:this.view,layerUid:this.layerUid}),t=new AbortController;await r.doLoad(e.lodRenderGeometry,(e=>this._getMaterial(e)),t.signal),this._lodRenderers.set(e.lodRendererId,r)}async _addLodInstances(e){const r=this._lodRenderers.get(e.lodRendererId);if(null==r)throw new Error("no lod renderer assigned to provided lod renderer Id");r.addInstances(e.data)}async _removeLodInstances(e){const r=this._lodRenderers.get(e.lodRendererId);if(null==r)throw new Error("no lod renderer assigned to provided lod renderer Id");r.removeInstances(e.featureIds)}};function B(e,r){const t={anchorPosition:c.center,occlusionTest:!0,hasSlicePlane:!1},s=t;if(s.color=[1,0,0,1],s.outlineColor=[0,0,0,1],s.outlineSize=1,null!=e){const r=e.fromData("circle-icon",(()=>M("circle")));s.textureId=r.texture.id,s.textureIsSignedDistanceField=!0,s.sampleSignedDistanceFieldTexelCenter=L("circle")}return s.distanceFieldBoundingBox=U,[new T(t,r),null]}A=e([a("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],A);const U=[C/2,C/2,1-C/2,1-C/2];export{A as F,B as c};
