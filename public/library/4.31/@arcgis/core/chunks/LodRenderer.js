/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{m as t,g as e}from"./vec2.js";import{f as i,Z as s}from"./vec2f64.js";import{c as r}from"./mathUtils.js";import{d as n}from"./debugFlags2.js";import{_ as a}from"./tslib.es6.js";import{K as o,L as h,M as l,i as c}from"../core/lang.js";import d from"../core/Error.js";import{s as _}from"./ensureType.js";import{d as u}from"./maybe.js";import{isAborted as f,throwIfAborted as g}from"../core/promiseUtils.js";import{property as m}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as p}from"../core/accessorSupport/decorators/subclass.js";import{c as y}from"./mat4f64.js";import{f as I,m as S,a as b,d as T}from"./vec3.js";import{c as L}from"./vec3f64.js";import{c as R,f as v}from"./vec4f64.js";import{g as x}from"./glUtil.js";import{n as A}from"./InterleavedLayout.js";import E from"../views/3d/webgl/RenderCamera.js";import{S as C}from"./Matrix4PassUniform.js";import{G as M,A as O}from"./MergedRenderer.js";import{a as D,D as w,e as F}from"./Material.js";import{I as N,S as H}from"./intersectorUtils.js";import{O as U}from"./Octree.js";import{i as B}from"./StencilUtils.js";import{a as z}from"./Util.js";import{V as j}from"./VertexAttribute.js";import G from"../core/Accessor.js";import P from"../core/Evented.js";import{f as V,i as W,t as k}from"./mat3.js";import{c as q}from"./mat3f64.js";import{m as Y}from"./mat4.js";import{b as X,d as J,c as $,o as K,k as Z,h as Q,a as tt,i as et,l as it}from"./BufferView.js";import{d as st,e as rt}from"./mathUtils2.js";import{B as nt}from"./BufferObject.js";import{U as at}from"./enums.js";import{w as ot,b as ht,g as lt}from"./sphere.js";import{k as ct,e as dt,p as _t,v as ut}from"./aaBoundingBox.js";import{a as ft}from"./Intersector3.js";import{V as gt}from"./VertexArrayObject2.js";import{L as mt}from"./Intersector2.js";import{e as pt}from"./sdfPrimitives.js";import{b as yt}from"./DefaultMaterial.js";import{T as It,n as St}from"./Scheduler.js";import{b as bt,u as Tt}from"./Texture.js";function Lt(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}function Rt(t){const{size:e}=t.definition,i=t.fontString(e);let s=vt.get(i);if(!s){const r=Lt(At,0,0).getContext("2d");t.setFontProperties(r,e);const n=r.measureText(Et);s=new xt(n.actualBoundingBoxAscent,n.actualBoundingBoxDescent),vt.set(i,s)}return s}const vt=new Map;class xt{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(t,e){this.maxAscent=t,this.maxDescent=e}}const At={canvas:null},Et=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})(),Ct=1;class Mt{constructor(t,e,i,s){this.text=t,this._alignment=e,this._parameters=i,this._maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${t}--${this._parameters.key}-${this._alignment}`,this._lines=t.replaceAll(" ","Â ").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let t=this._metrics.firstLineAscent;for(let e=0;e<this._lines.length-1;e++)t+=this._lineSpacing;return t+=this._metrics.lastLineDescent,Math.ceil(t+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const t=Lt(wt,Nt,Nt).getContext("2d"),e=this._parameters.definition.pixelRatio,i=this._fontSize*e;this._parameters.setFontProperties(t,i);let s=2*this._haloSize;const r=this._parameters.definition.font;"italic"!==r.style&&"oblique"!==r.style&&"bold"!==r.weight&&"bolder"!==r.weight||(s+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let n=0,a=0,o=0,h=0,l=0;this._lines.forEach(((i,r)=>{const c=t.measureText(i),d=c.width/e,_=d+s;this._textWidths.push(d),this._lineWidths.push(_),n=Math.max(n,_),h=Math.max(h,c.actualBoundingBoxAscent/e),l=Math.max(l,c.actualBoundingBoxDescent/e),0===r&&(a=c.actualBoundingBoxAscent/e),r===this._lines.length-1&&(o=c.actualBoundingBoxDescent/e)}));const c=Rt(this._parameters),d=Math.max(h,c.maxAscent),_=Math.max(l,c.maxDescent),u=a,f="underline"===this._parameters.definition.font.decoration?_:o,g=n;this._metricsCached=new Ut(u,f,d,_,g)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*Ft}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,1)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const t=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(t,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case Dt.Left:return this._horizontalPadding;case Dt.Center:return(this.displayWidth-this._lineWidths[t])/2;case Dt.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[t]}}render(t,e,i){t.save();const s=e/=this.renderPixelRatio,r=i/=this.renderPixelRatio,a=this._haloSize,o=this._firstLineYOffset+this._metrics.firstLineAscent;e+=a,i+=o;const h=this._haloSize>0;h&&this._renderHalo(t,s,r,a,o),this._parameters.setFontProperties(t,this._renderedFontSize);for(let s=0;s<this._lines.length;++s){const r=this._lines[s],n=this._getLineXOffset(s);h&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,r,e+n,i),this._renderLineDecoration(t,e+n,i,this._textWidths[s])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,r,e+this._getLineXOffset(s),i),this._renderLineDecoration(t,e+n,i,this._textWidths[s]),i+=this._lineSpacing}if(n.TEXT_SHOW_BASELINE){t.strokeStyle=Ht,t.setLineDash([2,2]),t.lineWidth=1;let e=r+o;for(let i=0;i<this._lines.length;++i)this._drawLine(t,[s,e],[s+this.displayWidth,e]),e+=this._lineSpacing}if(n.TEXT_SHOW_BORDER&&(t.strokeStyle=Ht,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[s,r],[this.displayWidth,this.displayHeight])),this._hasBackground){const e=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,s,r,e),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,e,i,s,r=!1){if("none"===this._parameters.definition.font.decoration||0===s)return;const n=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":i+=2*n;break;case"line-through":i-=.33*this._midLineAscent}const a=r?this._haloSize:0;t.strokeStyle=r?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(n+2*a),t.beginPath(),t.moveTo(this._toRenderUnit(e-a),this._toRenderUnit(i)),t.lineTo(this._toRenderUnit(e+s+a),this._toRenderUnit(i)),t.stroke()}_roundedRect(t,e,i,s){e=this._toRenderUnit(e),i=this._toRenderUnit(i);const n=this.renderedWidth,a=this.renderedHeight;0!==s?(s=r(s,0,Math.floor(a/2)),t.beginPath(),t.moveTo(e,i+s),t.arcTo(e,i,e+s,i,s),t.lineTo(e+n-s,i),t.arcTo(e+n,i,e+n,i+s,s),t.lineTo(e+n,i+a-s),t.arcTo(e+n,i+a,e+n-s,i+a,s),t.lineTo(e+s,i+a),t.arcTo(e,i+a,e,i+a-s,s),t.closePath()):t.rect(e,i,n,a)}_renderHalo(t,e,i,s,r){const n=this.renderedWidth,a=this.renderedHeight,o=Lt(wt,Math.max(n,Nt),Math.max(a,Nt)),h=o.getContext("2d");h.clearRect(0,0,n,a),this._parameters.setFontProperties(h,this._renderedFontSize),h.fillStyle=this._parameters.haloStyle,h.strokeStyle=this._parameters.haloStyle;const l=this._renderedHaloSize<3;h.lineJoin=l?"miter":"round",l?this._renderHaloEmulated(h,s,r):this._renderHaloNative(h,s,r);let c=r;for(let t=0;t<this._lines.length;++t){const e=this._getLineXOffset(t);this._renderLineDecoration(h,s+e,c,this._textWidths[t],!0),c+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(o,0,0,n,a,this._toRenderUnit(e),this._toRenderUnit(i),n,a),t.globalAlpha=1}_renderHaloEmulated(t,e,i){for(let s=0;s<this._lines.length;++s){const r=this._lines[s],n=this._getLineXOffset(s);for(const[s,a]of Ot)this._fillText(t,r,e+n+this._haloSize*s,i+this._haloSize*a);i+=this._lineSpacing}}_renderHaloNative(t,e,i){const s=2*this._haloSize;for(let r=0;r<this._lines.length;++r){const n=this._lines[r],a=this._getLineXOffset(r),o=5,h=.1;for(let r=0;r<o;r++){const l=1-(o-1)*h+r*h;t.lineWidth=this._toRenderUnit(l*s),this._strokeText(t,n,e+a,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,e,i,s){t.fillText(e,this._toRenderUnit(i),this._toRenderUnit(s))}_strokeText(t,e,i,s){t.strokeText(e,this._toRenderUnit(i),this._toRenderUnit(s))}_drawLine(t,e,i){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.stroke()}_drawBox(t,e,i){const s=this._toRenderUnit(e[0]),r=this._toRenderUnit(e[1]),n=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),o=Math.floor(s)+.5,h=Math.ceil(s+n)-.5,l=Math.floor(r)+.5,c=Math.ceil(r+a)-.5;t.beginPath(),t.moveTo(o,l),t.lineTo(h,l),t.lineTo(h,c),t.lineTo(o,c),t.lineTo(o,l),t.stroke()}}const Ot=[];{const t=16;for(let e=0;e<360;e+=360/t)Ot.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}var Dt;!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(Dt||(Dt={}));const wt={canvas:null},Ft=.2,Nt=512,Ht="rgb(255, 0, 255, 0.5)";class Ut{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(t,e,i,s,r){this.firstLineAscent=t,this.lastLineDescent=e,this.maxLineAscent=i,this.maxLineDescent=s,this.displayWidth=r}}const Bt=Object.freeze({left:0,center:.5,right:1}),zt=Object.freeze({"bottom-left":i(0,0),bottom:i(.5,0),"bottom-right":i(1,0),left:i(0,.5),center:i(.5,.5),right:i(1,.5),"top-left":i(0,1),top:i(.5,1),"top-right":i(1,1)});function jt(t){switch(t){case"left":return Dt.Left;case"right":return Dt.Right;default:return Dt.Center}}function Gt(t){switch(t){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function Pt(t){switch(t){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function Vt(t,e){switch(e){case"bottom":return"left"===t?"bottom-left":"right"===t?"bottom-right":"bottom";case"center":return t;case"top":return"left"===t?"top-left":"right"===t?"top-right":"top"}}function Wt(t){return"middle"===t?"center":t}function kt(i,r){switch(i){case"top":return e(r,0,1);case"bottom":return e(r,0,-1);default:return t(r,s)}}class qt{constructor(t,e,i){this._elementSize=e,this._buffer=nt.createVertex(t,at.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(t,e,i,s=0){const r=new Uint8Array(this.array,t*this.elementSize,(e-t)*this.elementSize);new Uint8Array(i.array,s*this.elementSize).set(r)}transferAll(){this._buffer.setData(this._array)}transferRange(t,e){const i=t*this._elementSize,s=e*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,s)}resize(t){const e=t*this._elementSize,i=new ArrayBuffer(e);this._array&&(t>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,t*this._elementSize))),this._array=i,this._buffer.setSize(e),this._capacity=t}}class Yt{constructor(t){this.modelOriginHi=t.getField(j.INSTANCEMODELORIGINHI,X),this.modelOriginLo=t.getField(j.INSTANCEMODELORIGINLO,X),this.model=t.getField(j.INSTANCEMODEL,J),this.modelNormal=t.getField(j.INSTANCEMODELNORMAL,J),this.featureAttribute=t.getField(j.INSTANCEFEATUREATTRIBUTE,$),this.color=t.getField(j.INSTANCECOLOR,K),this.objectAndLayerIdColor=t.getField(j.INSTANCEOBJECTANDLAYERIDCOLOR,K)}}class Xt{constructor(t,e){this._rctx=t,this._instanceBufferLayout=e,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,e=this._tailIndex;return t>=e?t-e:t+this._capacity-e}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){z(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){z(this._updating,"not updating"),this.size<o*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){z(this._updating,"not updating"),this.isFull&&this._grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),z(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){z(this._updating,"not updating"),z(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex)}_grow(){const t=Math.max(Jt,Math.floor(this._capacity*h));this._resize(t)}_shrink(){const t=Math.max(Jt,Math.floor(this._capacity*l));this._resize(t)}_resize(t){if(z(this._updating,"not updating"),t===this._capacity)return;const e=new qt(this._rctx,this._instanceBufferLayout.stride,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const t=this.size,i=this._compactInstances(e);z(i===t,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=e,this._view=new Yt(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(t){const e=this._headIndex,i=this._tailIndex;return i<e?(this._buffer.copyRange(i,e,t),e-i):i>e?(this._buffer.copyRange(i,this._capacity,t),e>0&&this._buffer.copyRange(0,e,t,this._capacity-i),e+(this._capacity-i)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}_transferRange(t,e){t<e?this._buffer.transferRange(t,e):t>e&&(e>0&&this._buffer.transferRange(0,e),this._buffer.transferRange(t,this._capacity))}}const Jt=64;var $t;!function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"}($t||($t={}));class Kt{constructor(t){this.localTransform=t.getField(j.LOCALTRANSFORM,Z),this.globalTransform=t.getField(j.GLOBALTRANSFORM,Z),this.modelOrigin=t.getField(j.MODELORIGIN,Q),this.model=t.getField(j.INSTANCEMODEL,J),this.modelNormal=t.getField(j.INSTANCEMODELNORMAL,J),this.modelScaleFactors=t.getField(j.MODELSCALEFACTORS,tt),this.boundingSphere=t.getField(j.BOUNDINGSPHERE,et),this.featureAttribute=t.getField(j.FEATUREATTRIBUTE,$),this.color=t.getField(j.COLOR,K),this.objectAndLayerIdColor=t.getField(j.OBJECTANDLAYERIDCOLOR,K),this.state=t.getField(j.STATE,it),this.lodLevel=t.getField(j.LODLEVEL,it)}}let Zt=class extends G{constructor(t,e){super(t),this.events=new P,this._capacity=0,this._size=0,this._next=0,this._highlightGroupMap=new Map,this._highlightGroupMapPrev=new Map,this._layout=function(t){let e=A().mat4f64(j.LOCALTRANSFORM).mat4f64(j.GLOBALTRANSFORM).vec4f64(j.BOUNDINGSPHERE).vec3f64(j.MODELORIGIN).mat3f(j.INSTANCEMODEL).mat3f(j.INSTANCEMODELNORMAL).vec2f(j.MODELSCALEFACTORS);return t.includes(j.FEATUREATTRIBUTE)&&(e=e.vec4f(j.FEATUREATTRIBUTE)),t.includes(j.COLOR)&&(e=e.vec4u8(j.COLOR)),t.includes(j.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(j.OBJECTANDLAYERIDCOLOR)),e=e.u8(j.STATE).u8(j.LODLEVEL),e}(e),this._capacity=Jt,this._buffer=this._layout.createBuffer(this._capacity),this._view=new Kt(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,$t.ALLOCATED),this._size++,this.events.emit("instances-changed"),t}removeInstance(t){const e=this._view.state;z(t>=0&&t<this._capacity&&!!(e.get(t)&$t.ALLOCATED),"invalid instance handle"),this._getStateFlag(t,$t.ACTIVE)?this._setStateFlags(t,$t.REMOVE):this.freeInstance(t),this.events.emit("instances-changed")}freeInstance(t){const e=this._view.state;z(t>=0&&t<this._capacity&&!!(e.get(t)&$t.ALLOCATED),"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,i=!0){this._view.localTransform.setMat(t,e),i&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,i=!0){this._view.globalTransform.setMat(t,e),i&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){const e=this._view,i=Qt,s=te;e.localTransform.getMat(t,ee),e.globalTransform.getMat(t,ie);const r=Y(ie,ie,ee);I(i,r[12],r[13],r[14]),e.modelOrigin.setVec(t,i),V(s,r),e.model.setMat(t,s);const n=st(Qt,r);n.sort(),e.modelScaleFactors.set(t,0,n[1]),e.modelScaleFactors.set(t,1,n[2]),W(s,s),k(s,s),e.modelNormal.setMat(t,s),this._setStateFlags(t,$t.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){const i=this._view;i.model.getMat(t,te),i.modelOrigin.getVec(t,Qt),e[0]=te[0],e[1]=te[1],e[2]=te[2],e[3]=0,e[4]=te[3],e[5]=te[4],e[6]=te[5],e[7]=0,e[8]=te[6],e[9]=te[7],e[10]=te[8],e[11]=0,e[12]=Qt[0],e[13]=Qt[1],e[14]=Qt[2],e[15]=1}applyShaderTransformation(t,e){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){this._view.localTransform.getMat(t,e),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(Qt,this,t),e*=Math.max(Qt[0],Qt[1],Qt[2])),e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);var i,s,r;return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(Qt,this,t),e*=(i=Qt[0],s=Qt[1],r=Qt[2],Math.max(Math.min(i,s),Math.min(Math.max(i,s),r)))),e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}setObjectAndLayerIdColor(t,e){this._view.objectAndLayerIdColor.setVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this._setStateFlag(t,$t.VISIBLE,e),this.events.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,$t.VISIBLE)}setHighlight(t,e,i){let s=this._highlightGroupMap.get(t);e?(s||(s=new Set,this._highlightGroupMap.set(t,s)),s.add(i)&&(this._setStateFlag(t,$t.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed"))):s?.delete(i)&&(0===s.size&&(this._highlightGroupMap.delete(t),this._setStateFlag(t,$t.HIGHLIGHT,!1)),this.events.emit("instance-highlight-changed"))}getHighlight(t){return this._getStateFlag(t,$t.HIGHLIGHT)}foreachHighlightGroupPrev(t,e){this._highlightGroupMapPrev.get(t)?.forEach(e),this._highlightGroupMapPrev.delete(t)}foreachHighlightGroup(t,e){const i=this._highlightGroupMap.get(t);i?.forEach(e),i?this._highlightGroupMapPrev.set(t,new Set(i)):this._highlightGroupMapPrev.delete(t)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let i=0;i<this._capacity;++i)this.getState(i)&t&&++e;return e}_setStateFlags(t,e){const i=this._view.state;e=i.get(t)|e,i.set(t,e)}_clearStateFlags(t,e){const i=this._view.state;e=i.get(t)&~e,i.set(t,e)}_setStateFlag(t,e,i){i?this._setStateFlags(t,e):this._clearStateFlags(t,e)}_getStateFlag(t,e){return!!(this._view.state.get(t)&e)}_grow(){this._capacity=Math.max(Jt,Math.floor(this._capacity*h)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new Kt(this._buffer)}_findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&$t.ALLOCATED;)e=e+1===this._capacity?0:e+1;return this._next=e+1===this._capacity?0:e+1,e}};a([m({constructOnly:!0})],Zt.prototype,"shaderTransformation",void 0),a([m()],Zt.prototype,"_size",void 0),a([m({readOnly:!0})],Zt.prototype,"size",null),Zt=a([p("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],Zt);const Qt=L(),te=q(),ee=y(),ie=y();class se extends U{constructor(t,e){super((t=>ot(this._instanceData.view.boundingSphere.getVec(t,this._tmpSphere))),{maximumDepth:25}),this._instanceData=t,this._boundingSphere=e,this._tmpSphere=ht(),this._tmpMat4=y()}addInstance(t){const e=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);S(lt(this._tmpSphere),this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*rt(i),e.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}}class re{constructor(t,e){this._worldSpaceRadius=t,this._minScreenSpaceRadii=e}selectLevel(t,e,i){const s=i.computeScreenPixelSizeAt(t),r=this._worldSpaceRadius*e/s;let n=0;for(let t=1;t<this._minScreenSpaceRadii.length;++t)r>=this._minScreenSpaceRadii[t]&&(n=t);return n}}class ne{constructor(t,e){const i=t.renderContext.rctx,s=e.geometry;let r=null;r=s instanceof D?function(t,e,i,s=null){const r=t.createBufferWriter(),n=r.vertexBufferLayout,a=r.elementCount(e),o=n.createBuffer(a);return r.write(null,null,e,s,o,0),{material:t,vertexBufferLayout:n,buffer:o.buffer,elementCount:a,boundingInfo:i}}(s.material,s.attributes,s.boundingInfo):s;const n=r.material;this._materials=t.materials,n.setParameters({instancedDoublePrecision:!0}),this.geometry=s,this.material=n,this.glMaterials=new M(n,this._materials),this.vertexBufferLayout=r.vertexBufferLayout,this.vbo=nt.createVertex(i,at.STATIC_DRAW,r.buffer),this.vao=new gt(i,w,new Map([["geometry",x(r.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=r.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(t,e,i,s,r,n,a,o){if(!(this.geometry instanceof D))return;const h=this.geometry.id;this.material.intersect(this.geometry,t.transform.transform,t,i,s,((i,s,l,c,d)=>{if(i>=0){if(null!=e&&!e(t.rayBegin,t.rayEnd,i))return;const c=new mt(n.layerUid,n.graphicUid(r),h,l,a,o);if((null==t.results.min.drapedLayerOrder||d>=t.results.min.drapedLayerOrder)&&(null==t.results.min.dist||i<t.results.min.dist)&&t.results.min.set(N.LOD,c,i,s,t.transform.transform,d),t.options.store!==H.MIN&&(null==t.results.max.drapedLayerOrder||d>=t.results.max.drapedLayerOrder)&&(null==t.results.max.dist||i>t.results.max.dist)&&t.results.max.set(N.LOD,c,i,s,t.transform.transform,d),t.options.store===H.ALL){const e=ft(t.results.min.ray);e.set(N.LOD,c,i,s,t.transform.transform,d),t.results.all.push(e)}}}))}}class ae{static async create(t,e,i){const s=await Promise.allSettled(e.components.map((e=>t.controller.schedule((()=>new ne(t,e)),i)))),r=s.map((t=>"fulfilled"===t.status?t.value:null)).filter(c);if(f(i)||r.length!==s.length){r.forEach((t=>t.destroy())),g(i);for(const t of s)if("rejected"===t.status)throw t.reason}return new ae(e.minScreenSpaceRadius,r)}constructor(t,e){this.minScreenSpaceRadius=t,this.components=e}destroy(){this.components.forEach((t=>t.destroy()))}intersect(t,e,i,s,r,n,a){this.components.forEach((o=>o.intersect(t,e,i,s,r,n,this.boundingSphere,a)))}get boundingBox(){if(null==this._boundingBox){const t=ct();this.components.forEach((e=>{null!=e.boundingInfo&&(dt(t,e.boundingInfo.bbMin),dt(t,e.boundingInfo.bbMax))})),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const t=this.boundingBox,e=L();_t(t,e),this._boundingSphere={center:e,radius:.5*ut(t)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((t,e)=>t+e.triangleCount),0)}}let oe=class extends O{constructor(t,e){super(t),this.type=N.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new E,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[B.OPAQUE_MATERIAL,t=>this._produces(t)],[B.TRANSPARENT_MATERIAL,t=>!!this._hasTransparentLevels()&&this._produces(t)]]),this._instanceData=new Zt({shaderTransformation:t.shaderTransformation},t.optionalFields),this.addHandles(e.registerTask(It.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function(t){let e=A().vec3f(j.INSTANCEMODELORIGINHI).vec3f(j.INSTANCEMODELORIGINLO).mat3f(j.INSTANCEMODEL).mat3f(j.INSTANCEMODELNORMAL);return null!=t&&t.includes("featureAttribute")&&(e=e.vec4f(j.INSTANCEFEATUREATTRIBUTE)),null!=t&&t.includes("color")&&(e=e.vec4u8(j.INSTANCECOLOR)),null!=t&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(j.INSTANCEOBJECTANDLAYERIDCOLOR)),e}(this.optionalFields),this._glInstanceBufferLayout=x(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)})),this._instanceData.events.on("instance-visibility-changed",(({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _allRenderInstanceData(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDataMap)t.push(e[1]);return t}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this.baseMaterial.hasEmissions}get usedMemory(){return this._allRenderInstanceData.reduce(((t,e)=>e.reduce(((t,e)=>t+e.usedMemory),t)),0)}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach(((t,i)=>{const s=this._allRenderInstanceData[0][i].size+this._allRenderInstanceData[1][i].size,r=t.triangleCount;e.push({renderedInstances:s,renderedTriangles:s*r,trianglesPerInstance:r})})),{totalInstances:t,renderedInstances:e.reduce(((t,e)=>t+e.renderedInstances),0),renderedTriangles:e.reduce(((t,e)=>t+e.renderedTriangles),0),levels:e}}_createRenderInstanceDataArray(t=[]){const{rctx:e}=this._context.renderContext;return this.symbol.levels.map((i=>{t.push(new Xt(e,this._instanceBufferLayout))})),t}async initializeRenderContext(t,e){this._context=t,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const i=await Promise.allSettled(this.symbol.levels.map((i=>ae.create(t,i,e)))),s=i.map((t=>"fulfilled"===t.status?t.value:null)).filter(c);if(f(e)||s.length!==i.length){s.forEach((t=>t.destroy())),g(e);for(const t of i)if("rejected"===t.status)throw t.reason}this._levels=s,this._levelSelector=(t=>{const e=t.baseBoundingSphere.radius,i=t.levels.map((t=>t.minScreenSpaceRadius));return new re(e,i)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((t=>t.destroy())),this._defaultRenderInstanceData.forEach((t=>t.destroy())),this._highlightRenderInstanceDataMap.forEach((t=>t.forEach((t=>t.destroy()))))}_hasTransparentLevels(){return this._levels.some((t=>t.components.some((t=>{const e=t.material.produces.get(B.TRANSPARENT_MATERIAL);return e?.(C.Color)}))))}hasHighlights(){return _(this._highlightRenderInstanceDataMap,(t=>t.some((t=>t.size>0))))}_produces(t){return t!==C.Highlight&&t!==C.ShadowHighlight||this.hasHighlights()}prepareRender(t){if(!n.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(St),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const i=new Array,s=this.levels;return e.forEach((e=>s.forEach((({components:s},r)=>s.forEach((s=>i.push(this._beginComponent(t,e[r],s)))))))),i}render(t,e){const i=this._getInstanceDatas(t);if(!i||null==e)return;let s=0;t.rctx.bindVAO();const r=this.levels;i.forEach((i=>r.forEach((({components:r},n)=>r.forEach((r=>this._renderComponent(t,e[s++],i[n],r,n)))))))}_getInstanceDatas(t){const{output:e,bind:i}=t,s=e===C.Highlight,r=!s&&e!==C.ShadowHighlight,n=e!==C.ShadowExcludeHighlight;if(r)return n?this._allRenderInstanceData:[this._defaultRenderInstanceData];if(n){if(s){const{highlightGroupName:t}=i;if(!t)return null;const e=this._highlightRenderInstanceDataMap.get(t);return e?[e]:null}const t=[];for(const e of this._highlightRenderInstanceDataMap)t.push(e[1]);return t}return null}intersect(t,e,i,s){if(!this.baseMaterial.visible||null==this._octree)return;const r=L();b(r,s,i);const n=r=>{this._instanceData.getCombinedModelTransform(r,de),t.transform.set(de),S(_e,i,t.transform.inverse),S(ue,s,t.transform.inverse);const n=this._instanceData.getState(r),a=this._instanceData.getLodLevel(r),o=this._levels.length;z(!!(n&$t.ACTIVE),"invalid instance state"),z(a>=0&&a<o,"invaid lod level"),this._levels[a].intersect(t,e,_e,ue,r,this.metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(n):this._octree.forEachAlongRay(i,r,n)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const t=this._instanceData,e=t.view?.state;if(!e)return null;this._octreeCached=new se(t,this.baseBoundingSphere);for(let i=0;i<t.capacity;++i)e.get(i)&$t.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=u(this._octreeCached)}queryDepthRange(t){if(null==this._octree)return{near:1/0,far:-1/0};const e=t.viewForward,i=this._octree.findClosest(e,U.DepthOrder.FRONT_TO_BACK,t.frustum),s=this._octree.findClosest(e,U.DepthOrder.BACK_TO_FRONT,t.frustum);if(null==i||null==s)return{near:1/0,far:-1/0};const r=t.eye,n=this._instanceData.view;n.boundingSphere.getVec(i,ce),b(ce,ce,r);const a=T(ce,e)-ce[3];n.boundingSphere.getVec(s,ce),b(ce,ce,r);const o=T(ce,e)+ce[3];return{near:Math.max(t.near,a),far:Math.min(t.far,o)}}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((t=>t.forEach((t=>t.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:i,_levelSelector:s}=this;this._allRenderInstanceData.forEach((t=>t.forEach((t=>t.beginUpdate()))));const r=this._instanceData,n=r.view;let a=r.size;const o=r.capacity;let h=this._instanceIndex;const l=Math.ceil(o/500);for(let c=0;c<a&&!t.done;++c){h===this._cycleStartIndex&&this._startUpdateCycle();const c=n.state.get(h);let _=0;if(!(c&$t.ALLOCATED)){h=h+1===o?0:h+1,a++;continue}const u=n.lodLevel.get(h);if(c&$t.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[u].freeTail(),c&$t.HIGHLIGHT_ACTIVE&&r.foreachHighlightGroupPrev(h,(t=>{const e=this._highlightRenderInstanceDataMap.get(t);if(!e)throw new d("Internal error in lodRenderer");e[u].freeTail()})),c&$t.REMOVE)r.freeInstance(h);else if(c&$t.VISIBLE){let t=0;e&&(n.modelOrigin.getVec(h,le),t=s.selectLevel(le,r.getCombinedMedianScaleFactor(h),i)),_=c&~($t.ACTIVE|$t.TRANSFORM_CHANGED),t>=0&&(c&$t.HIGHLIGHT?(r.foreachHighlightGroup(h,(e=>{let i=this._highlightRenderInstanceDataMap.get(e);if(i||(i=this._createRenderInstanceDataArray(),i.forEach((t=>t.beginUpdate())),this._highlightRenderInstanceDataMap.set(e,i)),t>=i.length)throw new d(`LodRenderer internal error - missing lodLevel ${t}`);he(i[t],n,h)})),_|=$t.HIGHLIGHT_ACTIVE):(he(this._defaultRenderInstanceData[t],n,h),_|=$t.DEFAULT_ACTIVE)),n.state.set(h,_),n.lodLevel.set(h,t)}else _=c&~($t.ACTIVE|$t.TRANSFORM_CHANGED),n.state.set(h,_);if(null!=this._octreeCached){const t=!!(c&$t.ACTIVE),e=!!(_&$t.ACTIVE);!t&&e?this._octreeCached.addInstance(h):t&&!e?this._octreeCached.removeInstance(h):t&&e&&c&$t.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(h),this._octreeCached.addInstance(h))}h=h+1===o?0:h+1,h%l==0&&t.madeProgress()}this._instanceIndex=h,this._allRenderInstanceData.forEach((t=>t.forEach((t=>t.endUpdate())))),this._context.requestRender()}_beginComponent(t,e,i){if(0===e.size)return null;const s=i.glMaterials.load(t.rctx,t.bind.slot,t.output);return s?.beginSlot(t.bind)}_renderComponent(t,e,i,s,r){if(!e)return;const{bind:a,rctx:o}=t;o.runAppleAmdDriverHelper();const h=o.bindTechnique(e,a,s.material.parameters,ge);o.bindVAO(s.vao),e.ensureAttributeLocations(s.vao),n.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===C.Color&&(h.setUniform4fv("externalColor",fe[Math.min(r,fe.length-1)]),h.setUniform1i("colorMixMode",F.replace));const l=i.capacity,c=i.headIndex,d=i.tailIndex,_=i.firstIndex,u=this._glInstanceBufferLayout,f=(t,r)=>{bt(o,w,i.buffer,u,t),o.drawArraysInstanced(e.primitiveType,0,s.vertexCount,r-t),Tt(o,w,i.buffer,u)};s.material.parameters.transparent&&null!=_?c>d?(z(_>=d&&_<=c,"invalid firstIndex"),f(_,c),f(d,_)):c<d&&(_<=c?(z(_>=0&&_<=c,"invalid firstIndex"),f(_,c),f(d,l),f(0,_)):(z(_>=d&&_<=l,"invalid firstIndex"),f(_,l),f(0,c),f(d,_))):c>d?f(d,c):c<d&&(f(0,c),f(d,l)),o.bindVAO(null)}};function he(t,e,i){const s=t.allocateHead();var r,n,a,o;r=e,n=i,a=t.view,o=s,pt(r.modelOrigin,n,a.modelOriginHi,a.modelOriginLo,o),a.model.copyFrom(o,r.model,n),a.modelNormal.copyFrom(o,r.modelNormal,n),r.color&&a.color&&a.color.copyFrom(o,r.color,n),r.objectAndLayerIdColor&&a.objectAndLayerIdColor&&a.objectAndLayerIdColor.copyFrom(o,r.objectAndLayerIdColor,n),r.featureAttribute&&a.featureAttribute&&a.featureAttribute.copyFrom(o,r.featureAttribute,n)}a([m({constructOnly:!0})],oe.prototype,"symbol",void 0),a([m({constructOnly:!0})],oe.prototype,"optionalFields",void 0),a([m({constructOnly:!0})],oe.prototype,"metadata",void 0),a([m({constructOnly:!0})],oe.prototype,"shaderTransformation",void 0),a([m()],oe.prototype,"_instanceData",void 0),a([m()],oe.prototype,"_cycleStartIndex",void 0),a([m({readOnly:!0})],oe.prototype,"_enableLevelSelection",null),a([m()],oe.prototype,"_updateCyclesWithStaticCamera",void 0),a([m({readOnly:!0})],oe.prototype,"running",null),oe=a([p("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],oe);const le=L(),ce=R(),de=y(),_e=L(),ue=L(),fe=[v(1,0,1,1),v(0,0,1,1),v(0,1,0,1),v(1,1,0,1),v(1,0,0,1)],ge=new yt;export{oe as L,Mt as T,Wt as a,Rt as b,Vt as c,Ct as d,Gt as e,Pt as f,Lt as g,Bt as h,zt as n,jt as t,kt as v};
