/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Accessor.js";import{h as r,i}from"../core/lang.js";import{d as s}from"./handleUtils.js";import{allSettledValues as o,throwIfAborted as a}from"../core/promiseUtils.js";import{watch as n,syncAndInitial as l,mapCollectionAsync as p,sync as u}from"../core/reactiveUtils.js";import{g as c,A as d}from"./unitUtils.js";import{property as m}from"../core/accessorSupport/decorators/property.js";import{L as y}from"./Logger.js";import{subclass as g}from"../core/accessorSupport/decorators/subclass.js";import{p as h}from"./vec2.js";import{r as f,i as j}from"./vec3.js";import{c as S}from"./vec3f64.js";import{g as v}from"./common.js";import{U as w}from"./UpdatingHandles.js";import{a as b}from"./elevationInfoUtils.js";import{i as _,s as F,V as R,c as x}from"./snappingUtils.js";import{d as U,m as E,a as C}from"./normalizedPoint.js";import{sqlAnd as L}from"../core/sql.js";import M from"../layers/support/FeatureFilter.js";import{a as I}from"./floorFilterUtils.js";import{u as T,a as V}from"./layerUtils.js";import{c as H}from"./layerViewUtils.js";import{a as O}from"./RightAngleSnappingHint.js";import{R as P,O as D,v as G,F as A,E as z,D as N}from"./SnappingManager.js";import"../core/Handles.js";import"./maybe.js";import"./metadata.js";import"./utils.js";import"./ObservableBase.js";import"./tracking.js";import"../core/scheduling.js";import"../core/Error.js";import"../config.js";import"./asyncUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"./ensureType.js";import"./shared.js";import"./SimpleObservable.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./mathUtils.js";import"./vec2f64.js";import"./vec4.js";import"./vec4f64.js";import"./geodesicConstants.js";import"../geometry/support/geodesicUtils.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./plane.js";import"./mat3f64.js";import"./mat4f64.js";import"./quatf64.js";import"./mathUtils2.js";import"./sphere.js";import"./mat4.js";import"./ray.js";import"./mat3.js";import"./geometry2dUtils.js";import"./timeUtils.js";import"./date.js";import"./locale.js";import"./datetime.js";import"./dehydratedPoint.js";import"../rest/support/Query.js";import"./enumeration.js";import"./DataLayerSource.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./FullTextSearch.js";import"../core/Clonable.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"./InputManager.js";import"./Queue.js";import"../core/signal.js";import"./keybindings.js";import"./utils6.js";import"./Version.js";import"./Version2.js";import"../geometry/projection.js";import"./projectBuffer.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./Settings2.js";import"../Color.js";import"./colorUtils.js";import"../views/interactive/snapping/SnappingOptions.js";import"../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./screenUtils.js";import"./viewUtils.js";let k=class extends t{set attributeRulesEnabled(e){this._set("attributeRulesEnabled",e),e&&this.loadRules()}get layerView(){return this.view?.allLayerViews?.find((e=>e.layer===this.layer))}get valid(){const{_valid:e,snappingSource:t,layer:r}=this;return!(!t||!r)&&e}get subtypeFilter(){const{layer:e,snappingSource:t}=this;if(!T(e)||!e.subtypes?.length||!t)return{mode:"not-in-use",filter:null};const r=t.layerSource.sublayerSources.filter((e=>e.enabled&&e.layer.visible&&H(this.view?.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale))).map((e=>e.layer.subtypeCode));if(!r.length)return{mode:"none-visible",filter:null};if(r.length===e.subtypes.length)return{mode:"all-visible",filter:null};const i=e.fieldsIndex.get(e.subtypeField)?.name??e.subtypeField;return 1===r.length?{mode:"in-use",filter:`${i} = ${r.getItemAt(0)}`}:{mode:"in-use",filter:`${i} IN (${r.join(", ")})`}}get floorFilter(){const{view:e,layer:t}=this;return e&&t?I({view:e,layer:t}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);const{layer:e,snappingSource:t}=this;if("refresh"in e){const r=e;this.addHandles(r.on("refresh",(()=>t.refresh())))}this.loadRules(),this.addHandles([n((()=>t.updating),(e=>t.layerSource.updating=e),l),n((()=>t.availability),(e=>t.layerSource.availability=e),l)])}getFetchCandidatesParameters(e,t,i){if(!this.valid)return[];const{layer:s,layerView:o,floorFilter:a,rulesTable:n,subtypeFilter:l}=this,p={distance:i,mode:this.view?.type??"2d",point:e,coordinateHelper:t.coordinateHelper,returnEdge:!0,vertexMode:"all",filter:o&&"filter"in o?o.filter:null};if(a&&(p.filter=$(p.filter,a)),"not-in-use"!==l.mode&&"all-visible"!==l.mode){if("none-visible"===l.mode)return[];p.filter?p.filter.where=L(p.filter.where,l.mode):p.filter=new M({where:l.filter})}if(!this.attributeRulesEnabled)return[p];const u=t.feature,c="subtype-sublayer"===u?.sourceLayer?.type?u.sourceLayer.parent:u?.sourceLayer;if(n&&u&&_(this.view?.map)&&(V(s)||T(s))&&s.layerId&&(V(c)||T(c))&&this.view.map.utilityNetworks?.find((e=>e.isUtilityLayer(c)))){if("loaded"!==n.loadStatus)return[];const e=[],t=s.layerId,i=n.getFeatureSQL(c,u)?.[t];if(!i)return[];const o=i.anyVertex;let a=i.endVertex;return a&&o&&a===o&&(a=""),a&&e.push({...p,returnEdge:!1,vertexMode:"ends",filter:$(p.filter,a)}),o&&e.push({...p,returnEdge:r("snapping-include-edges-when-applying-any-vertex-rule")??!1,vertexMode:"all",filter:$(p.filter,o)}),e}return[p]}async loadRules(){this._valid=null;const{layer:e,view:t,attributeRulesEnabled:r}=this;if(r&&e&&t&&_(t?.map)&&(V(e)||T(e)))try{await Promise.allSettled(t.map.utilityNetworks?.map((e=>e.load()))??[]);const r=t.map.utilityNetworks?.find((t=>t.isUtilityLayer(e)));r&&(this.rulesTable=await r.getRulesTable(),await(this.rulesTable?.load()))}catch(t){return this._valid=!1,void y.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}this._valid=!0}remove(){this.destroy()}destroy(){this.snappingSource?.destroy()}};function $(e,t){return null==e?new M({where:t}):e.where?new M({where:L(e.where,t)}):new M({where:t})}e([m({constructOnly:!0})],k.prototype,"layer",void 0),e([m({constructOnly:!0})],k.prototype,"snappingSource",void 0),e([m({constructOnly:!0})],k.prototype,"view",void 0),e([m({value:!1})],k.prototype,"attributeRulesEnabled",null),e([m()],k.prototype,"layerView",null),e([m()],k.prototype,"rulesTable",void 0),e([m()],k.prototype,"valid",null),e([m()],k.prototype,"subtypeFilter",null),e([m()],k.prototype,"floorFilter",null),e([m()],k.prototype,"_valid",void 0),k=e([g("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],k);let q=class extends t{get updating(){return this._snappingSources.some((e=>null==e?.valid||!0===e.valid&&!0===e.snappingSource?.updating))||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=O.FEATURE,this._updatingHandles=new w,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=p((()=>this.options?._effectiveFeatureSources),((e,t)=>this._createSourceInfo(e,t)));this._snappingSources=e,this.addHandles([s(e),n((()=>({rulesEnabled:!!this.options?.attributeRulesEnabled,sources:this._snappingSources.filter(i)})),(({rulesEnabled:e,sources:t})=>{for(const r of t)r.attributeRulesEnabled=e}),u)])}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,r,i){if(!(t&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];const s=[],n=this._computeScreenSizeDistanceParameters(e,r);for(const t of this._snappingSources){if(!t?.valid||!t.snappingSource?.layerSource?.enabled||t.layerView?.suspended)continue;const o=t.getFetchCandidatesParameters(e,r,n);for(const e of o)s.push(t.snappingSource.fetchCandidates(e,i).then((e=>e.filter((e=>!this._candidateIsExcluded(t.snappingSource,e,r.excludeFeature))))))}const l=(await o(s)).flat();return this._addRightAngleCandidates(l,e,n,r),a(i),F(e,l),l}_addRightAngleCandidates(e,t,r,i){const s=null!=i.vertexHandle?i.vertexHandle.rightEdge?.rightVertex?.pos:null!=i.editGeometryOperations&&"polygon"===i.editGeometryOperations.data.type?i.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,o=null!=i.vertexHandle?i.vertexHandle.leftEdge?.leftVertex?.pos:null!=i.editGeometryOperations?i.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:a}=this,n=U(s,a,i),l=U(o,a,i),p=e.length;for(let i=0;i<p;i++)this._addRightAngleCandidate(e[i],l,t,r,e),this._addRightAngleCandidate(e[i],n,t,r,e)}_addRightAngleCandidate(e,t,r,i,s){if(null==t||!function(e){return(e instanceof z||e instanceof N)&&!function({constraint:{start:e,end:t}}){const r=f(e,t),i=h(C(e),C(t));return r<v()||i/r<X}(e)}(e))return;const o=e.constraint.closestTo(t),a=(o[0]-r[0])/i.x,n=(o[1]-r[1])/i.y,{start:l,end:p}=e.constraint;if(a*a+n*n<=1){const r=h(C(o),C(l))>h(C(o),C(p))?l:p,i=new P({targetPoint:E(o),otherVertex:t,otherVertexType:D.NEXT,previousVertex:r,constraint:new R(t,o),objectId:e.objectId,isDraped:e.isDraped,domain:O.FEATURE});s.push(i)}}_computeScreenSizeDistanceParameters(e,t){let r=null!=this.options?this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:r,y:r,z:r,distance:r}:"2d"===this.view.type?(r*=this.view.resolution,{x:r,y:r,z:r,distance:r}):this._computeScreenSizeDistanceParameters3D(e,r,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,r,i){const{spatialReference:s}=i;r.renderCoordsHelper.toRenderCoords(e,s,Q);const o=r.state.camera.computeScreenPixelSizeAt(Q),a=o*r.renderCoordsHelper.unitInMeters,n=a/c(s),l=a/d(s),p=t*n,u=t*l,m=G(e,s,b,r),y=m?B(m,e,n,0,0,r,i):0,g=m?B(m,e,0,n,0,r,i):0,h=m?B(m,e,0,0,l,r,i):0;return{x:0===y?0:p/y,y:0===g?0:p/g,z:0===h?0:u/h,distance:o*t}}_candidateIsExcluded(e,t,r){if(null==r)return!1;const i=this._getCandidateObjectId(t);if(null==i)return!1;const s=e.layerSource.layer;return"graphics"===s.type?r.uid===i:r.sourceLayer===s&&!(!r.attributes||!("objectIdField"in s))&&r.attributes[s.objectIdField]===i}_getCandidateObjectId(e){return e instanceof A?e.objectId:null}async _createSourceInfo(e,t){const r=e.layer;r.loaded||(await r.load(),a(t));const{view:i}=this,s=await this._createFeatureSnappingSourceType(e);return a(t),new k(null==s?{}:{snappingSource:s,view:i,layer:r})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return null==t||"3d"!==t.type?null:new((await this._getSourceModule("scene")).SceneLayerSnappingSource)({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source?.type){case"feature-layer":case"oriented-imagery":return new((await this._getSourceModule("featureService")).FeatureServiceSnappingSource)({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return"mesh"===e.layer.geometryType?null:new((await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource)({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new((await this._getSourceModule("graphics")).GraphicsSnappingSource)({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new((await this._getSourceModule("notes")).GraphicsSnappingSource)({getGraphicsLayers:()=>e.layer.sublayers?.toArray()??[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(null==t.loader){const t=this._loadSourceModule(e),r={module:null,loader:t};this._sourceModules[e]=r;const i=await t,s={module:i,loader:t};return this._sourceModules[e]=s,i}return null==t.module?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(import("./FeatureServiceSnappingSource.js"));case"featureCollection":return t.addPromise(import("./FeatureCollectionSnappingSource.js"));case"graphics":case"notes":return t.addPromise(import("./GraphicsSnappingSource.js"));case"scene":return t.addPromise(import("./SceneLayerSnappingSource.js"))}}get test(){}};function B(e,t,r,i,s,o,{spatialReference:a}){const n=j(J,t);n[0]+=r,n[1]+=i,n[2]+=s;const l=G(n,a,b,o);return l?x(l,e):1/0}e([m({constructOnly:!0})],q.prototype,"spatialReference",void 0),e([m({constructOnly:!0})],q.prototype,"view",void 0),e([m()],q.prototype,"options",void 0),e([m({readOnly:!0})],q.prototype,"updating",null),e([m()],q.prototype,"_snappingSources",void 0),q=e([g("esri.views.interactive.snapping.FeatureSnappingEngine")],q);const Q=S(),J=S(),X=1e-4;export{q as FeatureSnappingEngine};
