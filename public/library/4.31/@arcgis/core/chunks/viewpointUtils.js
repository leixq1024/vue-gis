/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import t from"../Viewpoint.js";import e from"../core/Collection.js";import{d as n}from"./mathUtils.js";import{m as r,l as a,g as o,f as i}from"./unitUtils.js";import{t as s}from"./common.js";import{f as c,r as u,s as f,t as l,a as m,b as y,i as p}from"./mat2d.js";import{c as g}from"./mat2df64.js";import{n as x,e as h,g as b,s as d,i as w,j,d as G,l as R,k as A,a as S,t as k,m as v}from"./vec2.js";import{c as M,f as z}from"./vec2f64.js";import C from"../geometry/Extent.js";import F from"../geometry/Geometry.js";import N from"../geometry/Point.js";import{isLoaded as q,canProjectWithoutEngine as I,load as V,project as L}from"../geometry/projection.js";import P from"../geometry/SpatialReference.js";import{getClosestDenormalizedXToReference as E,getDenormalizedExtent as U}from"../geometry/support/normalizeUtils.js";const O=180/Math.PI;function Q(t){return t.wkid?t:t.spatialReference||P.WGS84}function T(t,e){return e.type?b(t,e.x,e.y):v(t,e)}function B(t){return o(t)}function D(t,e,r=0){let a=t.width,o=t.height;if(0!==r){const e=n(r),i=Math.abs(Math.cos(e)),s=Math.abs(Math.sin(e));a=t.width*i+t.height*s,o=t.width*s+t.height*i}const i=Math.max(1,e[0]),s=Math.max(1,e[1]);return Math.max(a/i,o/s)*rt(t.spatialReference)}async function W(t,n,r,a){let o,i;if(!t)return null;if(Array.isArray(t)&&!t.length)return null;if(e.isCollection(t)&&(t=t.toArray()),Array.isArray(t)&&t.length&&"object"==typeof t[0]){const e=t.every((t=>"attributes"in t)),o=t.some((t=>!t.geometry));let i=t;if(e&&o&&n&&n.allLayerViews){const e=new Map;for(const n of t){const t=n.layer,r=e.get(t)||[],a=n.attributes[t.objectIdField];null!=a&&r.push(a),e.set(t,r)}const r=[];e.forEach(((t,e)=>{const a=n.allLayerViews.find((t=>t.layer.id===e.id));if(a&&"queryFeatures"in a){const n=e.createQuery();n.objectIds=t,n.returnGeometry=!0,r.push(a.queryFeatures(n))}}));const a=await Promise.all(r),o=[];for(const t of a)if(t&&t.features&&t.features.length)for(const e of t.features)null!=e.geometry&&o.push(e.geometry);i=o}for(const t of i)a=await W(t,n,r,a);return a}if(Array.isArray(t)&&2===t.length&&"number"==typeof t[0]&&"number"==typeof t[1])o=new N(t);else if(t instanceof F)o=t;else if("geometry"in t)if(t.geometry)o=t.geometry;else if(t.layer){const e=t.layer,r=n.allLayerViews.find((t=>t.layer.id===e.id));if(r&&"queryFeatures"in r){const n=e.createQuery();n.objectIds=[t.attributes[e.objectIdField]],n.returnGeometry=!0;const a=await r.queryFeatures(n);o=a?.features?.[0]?.geometry}}if(null==o)return null;switch(o.type){case"point":i=new C({xmin:o.x,ymin:o.y,xmax:o.x,ymax:o.y,spatialReference:o.spatialReference});break;case"extent":case"multipoint":case"polygon":case"polyline":i=U(o);break;default:i=o.extent}if(!i)return null;q()||I(i.spatialReference,r)||await V();const s=L(i,r);if(!s)return null;if(a){const t=s.center,e=t.clone();e.x=E(t.x,a.center.x,r),e.x!==t.x&&s.centerAt(e),a=a.union(s)}else a=s;return a}function H(t,e){const n=Q(t);return i(n,e)||n.imageCoordinateSystem||e.imageCoordinateSystem?t:L(t,e)}async function J(e,n){if(!e||!n)return new t({targetGeometry:new N,scale:0,rotation:0});let r=n.spatialReference;const{constraints:a,padding:o,viewpoint:s,size:c}=n,u=[o?c[0]-o.left-o.right:c[0],o?c[1]-o.top-o.bottom:c[1]];let f=null;e instanceof t?f=e:e.viewpoint?f=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(f=e.target);let l=null;f?.targetGeometry?l=f.targetGeometry:e instanceof C?l=e:e instanceof F?l=await W(e,n,r):e&&(l=await W(e.center,n,r)||await W(e.target,n,r)||await W(e,n,r)),!l&&s?.targetGeometry?l=s.targetGeometry:!l&&n.extent&&(l=n.extent),r||(r=Q(n.spatialReference||n.extent||l)),q()||i(l.spatialReference,r)||I(l.spatialReference,r)||await V();const m=H(l,r),y="center"in m?m.center:m;!1!==n.pickClosestTarget&&"point"===y.type&&"point"===s.targetGeometry?.type&&(y.x=E(y.x,s.targetGeometry.x,y.spatialReference));let p=0;f?p=f.rotation:e.hasOwnProperty("rotation")?p=e.rotation:s&&(p=s.rotation);let g=0;g=null!=f?.targetGeometry&&"point"===f.targetGeometry.type?f.scale:"scale"in e&&e.scale?e.scale:"zoom"in e&&-1!==e.zoom&&a&&a.effectiveLODs?a.zoomToScale(e.zoom):Array.isArray(l)||"point"===l.type||"extent"===l.type&&0===l.width&&0===l.height?s.scale:D(H(l.extent,r),u,p);const x=function(t){if(t&&(!Array.isArray(t)||"number"!=typeof t[0])&&("object"==typeof t||Array.isArray(t)&&"object"==typeof t[0])){if("layer"in t&&null!=t.layer?.minScale&&null!=t.layer.maxScale){const e=t.layer;return{min:e.minScale,max:e.maxScale}}if(Array.isArray(t)&&t.length&&t.every((t=>"layer"in t))){let e=0,n=0;for(const r of t){const t=r.layer;t?.minScale&&t.maxScale&&(e=t.minScale<e?t.minScale:e,n=t.maxScale>n?t.maxScale:n)}return e&&n?{min:e,max:n}:null}}}(e.target??e);x&&(x.min&&x.min<g?g=x.min:x.max&&x.max>g&&(g=x.max));let h=new t({targetGeometry:y,scale:g,rotation:p});return a&&(h=a.fit(h),a.constrainByGeometry(h),a.rotationEnabled||(h.rotation=s.rotation)),h}function K(t,e){const n=t.targetGeometry,r=e.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function X(t,e,n){return n?b(t,.5*(e[0]-n.right+n.left),.5*(e[1]-n.bottom+n.top)):h(t,e,.5)}const Y=function(){const t=M();return function(e,n,r){const a=n.targetGeometry;T(t,a);const o=.5*tt(n);return e.xmin=t[0]-o*r[0],e.ymin=t[1]-o*r[1],e.xmax=t[0]+o*r[0],e.ymax=t[1]+o*r[1],e.spatialReference=a.spatialReference,e}}();function Z(t,e,n,r,a){return lt(t,e,n.center),t.scale=D(n,r),a?.constraints?.constrain(t),t}const $=function(){const t=M();return function(e,n,r){return A(e,function(t,e){return h(t,e,.5)}(e,n),X(t,n,r))}}(),_=function(){const t=g(),e=M();return function(n,r,a,o){const i=tt(r),s=nt(r);return b(e,i,i),y(t,e),u(t,t,s),l(t,t,$(e,a,o)),l(t,t,[0,o.top-o.bottom]),b(n,t[4],t[5])}}();function tt(t){return t.scale*et(t.targetGeometry?.spatialReference)}function et(t){return null!=t&&r(t)?1/(39.37*B(t)*96):1}function nt(t){return s(t.rotation)||0}function rt(t){return r(t)?39.37*B(t)*96:1}const at=function(){const t=M(),e=M(),n=M();return function(r,a,o,i,s,m){return x(t,a),h(e,o,.5*m),b(n,1/i*m,-1/i*m),c(r,e),s&&u(r,r,s),f(r,r,n),l(r,r,t),r}}(),ot=function(){const t=M();return function(e,n,r,a){const o=tt(n),i=nt(n);return T(t,n.targetGeometry),at(e,t,r,o,i,a)}}(),it=function(){const t=M();return function(e,n,r,a){const o=tt(n);return T(t,n.targetGeometry),at(e,t,r,o,0,a)}}();function st(t){const e=a(t);return e?e.valid[1]-e.valid[0]:0}function ct(t,e){return Math.round(st(t)/e)}const ut=function(){const t=M(),e=M(),n=[0,0,0];return function(r,a,o){d(t,r,a),w(t,t),d(e,r,o),w(e,e),j(n,t,e);let i=Math.acos(G(t,e)/(R(t)*R(e)))*O;return n[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),ft=function(){const t=M();return function(e,n,r,a){const o=e.targetGeometry;return K(e,n),_(t,n,r,a),o.x+=t[0],o.y+=t[1],e}}(),lt=function(t,e,n){K(t,e);const r=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,t},mt=function(){const t=M();return function(e,n,r,a,o){o||(o="center"),A(t,r,a),h(t,t,.5);const i=t[0],s=t[1];switch(o){case"center":b(t,0,0);break;case"left":b(t,-i,0);break;case"top":b(t,0,s);break;case"right":b(t,i,0);break;case"bottom":b(t,0,-s);break;case"top-left":b(t,-i,s);break;case"bottom-left":b(t,-i,-s);break;case"top-right":b(t,i,s);break;case"bottom-right":b(t,i,-s)}return jt(e,n,t),e}}();function yt(t,e,n){return K(t,e),t.rotation+=n,t}function pt(t,e,n){return K(t,e),t.rotation=n,t}const gt=function(){const t=M();return function(e,n,r,a,o){return K(e,n),isNaN(r)||0===r||(dt(t,a,n,o),e.scale=n.scale*r,wt(t,t,e,o),jt(e,e,b(t,t[0]-a[0],a[1]-t[1]))),e}}();function xt(t,e,n){return K(t,e),t.scale=n,t}const ht=function(){const t=M();return function(e,n,r,a,o,i){return K(e,n),isNaN(r)||0===r||(dt(t,o,n,i),e.scale=n.scale*r,e.rotation+=a,wt(t,t,e,i),jt(e,e,b(t,t[0]-o[0],o[1]-t[1]))),e}}(),bt=function(){const t=M(),e=M();return function(n,r,a,o,i,s,c){return $(e,s,c),S(t,i,e),o?ht(n,r,a,o,t,s):gt(n,r,a,t,s)}}(),dt=function(){const t=g();return function(e,n,r,a){return k(e,n,function(t,e,n){return ot(t,e,n,1),p(t,t)}(t,r,a))}}(),wt=function(){const t=g();return function(e,n,r,a){return k(e,n,ot(t,r,a,1))}}(),jt=function(){const t=M(),e=g();return function(n,r,a){K(n,r);const o=tt(r),i=n.targetGeometry;return m(e,nt(r)),f(e,e,z(o,o)),k(t,a,e),i.x+=t[0],i.y+=t[1],n}}();export{at as a,tt as b,K as c,Y as d,ot as e,it as f,st as g,ct as h,ft as i,lt as j,xt as k,D as l,ut as m,mt as n,et as o,rt as p,$ as q,pt as r,Z as s,jt as t,ht as u,X as v,yt as w,bt as x,J as y};
