/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{J as t}from"./jsonMap.js";import{L as i}from"./Logger.js";import{k as o,n as e}from"./definitions.js";import{_ as l}from"./tslib.es6.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import{V as n}from"./HighlightOptions.js";import{T as h}from"./enums.js";import{a,T as u}from"./Texture.js";import{g as d}from"./featureTechniqueUtils.js";const p=1,g=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],c=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var f;let y=f=class extends n{constructor(t){super(t),this.haloWidth=2.1,this.haloBlur=.8/this.haloWidth}equals(t){return super.equals(t)&&this.haloWidth===t.haloWidth&&this.haloBlur===t.haloBlur}get optionsKey(){return`${this.color};${this.haloColor};${this.haloOpacity};${this.fillOpacity};${this.haloWidth};${this.haloBlur}`}clone(){return new f({color:this.color.clone(),haloColor:this.haloColor?.clone(),haloOpacity:this.haloOpacity,fillOpacity:this.fillOpacity,haloWidth:this.haloWidth,haloBlur:this.haloBlur})}};l([s()],y.prototype,"haloWidth",void 0),l([s()],y.prototype,"haloBlur",void 0),y=f=l([r("esri.views.2d.support.HighlightOptions")],y);const m=y,C=()=>i.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient"),v=[0,0,0,0];class O{constructor(){this.type="single",this._highlightOptions=new m,this._convertedHighlightOptions={fillColor:[0,0,0,0],outlineColor:[0,0,0,0],outlinePosition:0,outlineWidth:0,innerHaloWidth:0,outerHaloWidth:0},this._optionsShadeTexKey="",this._texelData=new Uint8Array(1024),this._minMaxDistance=[0,0]}setHighlightOptions(t){this._highlightOptions=t}applyHighlightOptions(t,i){this._updateGradientTexture(t),t.bindTexture(this._shadeTex,o),i.setUniform2fv("u_minMaxDistance",this._minMaxDistance)}destroy(){this._shadeTex?.dispose(),this._shadeTex=null}getReasonsWithGradients(){return[{activeReasons:(1<<e)-1,activeGradient:this}]}_updateGradientTexture(t){const{optionsKey:i}=this._highlightOptions;if(i===this._optionsShadeTexKey)return;var o,e;this._optionsShadeTexKey=i,o=this._highlightOptions,(e=this._convertedHighlightOptions).fillColor[0]=o.color.r/255,e.fillColor[1]=o.color.g/255,e.fillColor[2]=o.color.b/255,e.fillColor[3]=o.color.a,o.haloColor?(e.outlineColor[0]=o.haloColor.r/255,e.outlineColor[1]=o.haloColor.g/255,e.outlineColor[2]=o.haloColor.b/255,e.outlineColor[3]=o.haloColor.a):(e.outlineColor[0]=e.fillColor[0],e.outlineColor[1]=e.fillColor[1],e.outlineColor[2]=e.fillColor[2],e.outlineColor[3]=e.fillColor[3]),e.fillColor[3]*=o.fillOpacity,e.outlineColor[3]*=o.haloOpacity,e.fillColor[0]*=e.fillColor[3],e.fillColor[1]*=e.fillColor[3],e.fillColor[2]*=e.fillColor[3],e.outlineColor[0]*=e.outlineColor[3],e.outlineColor[1]*=e.outlineColor[3],e.outlineColor[2]*=e.outlineColor[3],e.outlineWidth=(1-o.haloBlur)*o.haloWidth,e.outerHaloWidth=o.haloBlur*o.haloWidth/2,e.innerHaloWidth=o.haloBlur*o.haloWidth/2,e.outlinePosition=0;const l=this._convertedHighlightOptions,s=l.outlinePosition-l.outlineWidth/2-l.outerHaloWidth,r=l.outlinePosition-l.outlineWidth/2,n=l.outlinePosition+l.outlineWidth/2,d=l.outlinePosition+l.outlineWidth/2+l.innerHaloWidth,p=1*Math.sqrt(Math.PI/2),g=Math.abs(s)>p?Math.round(10*(Math.abs(s)-p))/10:0,c=Math.abs(d)>p?Math.round(10*(Math.abs(d)-p))/10:0;let f;g&&!c?C().error("The outer rim of the highlight is "+g+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!g&&c?C().error("The inner rim of the highlight is "+c+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):g&&c&&C().error("The highlight is "+Math.max(g,c)+"px away from the edge of the feature; consider reducing some width values.");const y=[void 0,void 0,void 0,void 0];function m(t,i,o){y[0]=(1-o)*t[0]+o*i[0],y[1]=(1-o)*t[1]+o*i[1],y[2]=(1-o)*t[2]+o*i[2],y[3]=(1-o)*t[3]+o*i[3]}const{_texelData:O}=this;for(let t=0;t<256;++t)f=s+t/255*(d-s),f<s?(y[0]=0,y[1]=0,y[2]=0,y[3]=0):f<r?m(v,l.outlineColor,(f-s)/(r-s)):f<n?[y[0],y[1],y[2],y[3]]=l.outlineColor:f<d?m(l.outlineColor,l.fillColor,(f-n)/(d-n)):[y[0],y[1],y[2],y[3]]=l.fillColor,O[4*t]=255*y[0],O[4*t+1]=255*y[1],O[4*t+2]=255*y[2],O[4*t+3]=255*y[3];if(this._minMaxDistance[0]=s,this._minMaxDistance[1]=d,!this._shadeTex){const i=new a;i.wrapMode=h.CLAMP_TO_EDGE,i.width=256,i.height=1,this._shadeTex=new u(t,i)}this._shadeTex.updateData(0,0,0,256,1,this._texelData)}}class x{constructor(){this.type="multi",this.gradients=[]}setHighlightOptions(t){for(let i=0;i<t.length;i++)this.gradients[i]||(this.gradients[i]=new O),this.gradients[i].setHighlightOptions(t[i].options);for(let i=t.length+1;i<this.gradients.length;i++)this.gradients[i].destroy();this.gradients.length=t.length}destroy(){for(const t of this.gradients)t.destroy()}getReasonsWithGradients(){let t=1;const i=[];for(let o=0;o<this.gradients.length;o++){const e=this.gradients[o];i.push({activeReasons:t,activeGradient:e}),t<<=1}return i}}const _=new t({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch",mesh:"mesh"});function w(t){return _.toJSON(t)}function W(t,i,o){const e=[],l=[];let s=0,r=0;for(const n of t){const t=r;let h=n[0][0],a=n[0][1];e[r++]=h,e[r++]=a;let u=0;for(let t=1;t<n.length;++t){const i=h,o=a;h=n[t][0],a=n[t][1],u+=a*i-h*o,e[r++]=h,e[r++]=a}i(u/2),u>0?(t-s>0&&(o(s,t,e,l),s=t),l.length=0):u<0&&t-s>0?l.push(.5*(t-s)):r=t}r-s>0&&o(s,r,e,l)}function T(t){const{bandCount:i,attributeTable:o,colormap:e,pixelType:l}=t.raster.rasterInfo;return 1===i&&(null!=o||null!=e||"u8"===l||"s8"===l)}function G(t,i){return null==i?(t?.destroy(),null):("single"===t?.type&&Array.isArray(i)&&(t.destroy(),t=null),"multi"!==t?.type||Array.isArray(i)||(t.destroy(),t=null),t||(t=Array.isArray(i)?new x:new O),Array.isArray(i)?"multi"===t.type&&t.setHighlightOptions(i):"single"===t.type&&t.setHighlightOptions(i),t)}function H(t,i,o,e){const{painter:l,highlightGradient:s}=t,{highlight:r}=l.effects;if(!s)return;const n=t.passOptions,h=s.getReasonsWithGradients();for(let s=0;s<h.length;s++){const n={...t,passOptions:{type:"highlight",activeGradient:null!=e?h[e].activeGradient:h[s].activeGradient,activeReasons:h[s].activeReasons,stepType:"burn",highlightAll:i}};if(r.bind(n),o(n),s<h.length-1){let l=0;for(let t=s+1;t<h.length;t++)l|=h[t].activeReasons;o({...t,passOptions:{type:"highlight",activeGradient:null!=e?h[e].activeGradient:h[s].activeGradient,activeReasons:l,stepType:"clear",highlightAll:i}})}const a={...t,passOptions:{type:"highlight",activeGradient:null!=e?h[e].activeGradient:h[s].activeGradient,activeReasons:h[s].activeReasons,stepType:"draw",highlightAll:i}};l.setPipelineState(d(t)),l.updatePipelineState(t.context),r.draw(a),r.unbind()}t.passOptions=n}export{m as H,W as a,T as b,G as c,g as d,c as e,H as r,p as s,w as t};
