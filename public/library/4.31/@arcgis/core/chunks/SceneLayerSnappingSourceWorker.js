/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{throwIfAborted as s}from"../core/promiseUtils.js";import"./Logger.js";import"../core/lang.js";import"../core/Error.js";import{subclass as o}from"../core/accessorSupport/decorators/subclass.js";import{k as e,o as i,g as r}from"./vec3.js";import{c as n,a as c}from"./vec3f64.js";import{c as m,f as p,b as a}from"./lineSegment.js";import{b as d,g as u,d as j}from"./sphere.js";import{O as h}from"./Octree.js";import{d as l}from"./edgeProcessing.js";import"./handleUtils.js";import"./maybe.js";import"../config.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./ensureType.js";import"./common.js";import"./mathUtils.js";import"./ray.js";import"../core/scheduling.js";import"./mat3.js";import"./mat3f64.js";import"./plane.js";import"./mat4f64.js";import"./quatf64.js";import"./vec2f64.js";import"./vec4f64.js";import"./mathUtils2.js";import"./mat4.js";import"./vec4.js";import"./Axis.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"./frustum.js";import"./Util.js";import"./deduplicate.js";import"./Indices.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./vec2.js";import"./types.js";import"./VertexAttribute.js";import"./bufferLayouts.js";import"./glUtil.js";import"./enums.js";import"./VertexElementDescriptor.js";import"./Normals.js";function g(t,s,o){const n=d(),c=u(n);return e(c,c,t,.5),e(c,c,s,.5),n[3]=i(c,t),r(c,c,o),n}let f=class{constructor(){this._idToComponent=new Map,this._components=new h((t=>t.bounds)),this._edges=new h((t=>t.bounds)),this._tmpLineSegment=m(),this._tmpP1=n(),this._tmpP2=n(),this._tmpP3=n(),this.remoteClient=null}async fetchCandidates(t,o){await Promise.resolve(),s(o),await this._ensureEdgeLocations(t,o);const e=[];return this._edges.forEachNeighbor((s=>(this._addCandidates(t,s,e),e.length<1e3)),t.bounds),{result:{candidates:e}}}async _ensureEdgeLocations(t,s){const o=[];if(this._components.forEachNeighbor((t=>{if(null==t.info){const{id:s,uid:e}=t;o.push({id:s,uid:e})}return!0}),t.bounds),!o.length)return;const e={components:o},i=await this.remoteClient.invoke("fetchAllEdgeLocations",e,s??{});for(const t of i.components)this._setFetchEdgeLocations(t)}async add(t){const s=new v(t.id,t.bounds);return this._idToComponent.set(s.id,s),this._components.add([s]),{result:{}}}async remove(t){const s=this._idToComponent.get(t.id);if(s){const t=[];this._edges.forEachNeighbor((o=>(o.component===s&&t.push(o),!0)),s.bounds),this._edges.remove(t),this._components.remove([s]),this._idToComponent.delete(s.id)}return{result:{}}}_setFetchEdgeLocations(t){const s=this._idToComponent.get(t.id);if(null==s||t.uid!==s.uid)return;const o=l.createView(t.locations),e=new Array(o.count),i=n(),r=n();for(let n=0;n<o.count;n++){o.position0.getVec(n,i),o.position1.getVec(n,r);const c=g(i,r,t.origin),m=new y(s,n,c);e[n]=m}this._edges.add(e);const{objectIds:c,origin:m}=t;s.info={locations:o,objectIds:c,origin:m}}_addCandidates(t,s,o){const{info:e}=s.component,{origin:i,objectIds:n}=e,c=e.locations,m=c.position0.getVec(s.index,this._tmpP1),p=c.position1.getVec(s.index,this._tmpP2);r(m,m,i),r(p,p,i);const a=n[c.componentIndex.get(s.index)];this._addEdgeCandidate(t,a,m,p,o),b(t,a,m,o),b(t,a,p,o)}_addEdgeCandidate(t,s,o,e,r){if(!t.returnEdge)return;const n=u(t.bounds),m=p(o,e,this._tmpLineSegment),d=a(m,n,this._tmpP3);j(t.bounds,d)&&r.push({type:"edge",objectId:s,target:c(d),distance:i(n,d),start:c(o),end:c(e)})}};f=t([o("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],f);const _=f;function b(t,s,o,e){if(!t.returnVertex||!j(t.bounds,o))return;const r=u(t.bounds);e.push({type:"vertex",objectId:s,target:c(o),distance:i(r,o)})}class v{constructor(t,s){this.id=t,this.bounds=s,this.info=null,this.uid=++v.uid}}v.uid=0;class y{constructor(t,s,o){this.component=t,this.index=s,this.bounds=o}}export{_ as default};
