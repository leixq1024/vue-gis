/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{f as e}from"./vec3f64.js";import{N as t}from"./interfaces3.js";import{g as a}from"../core/Accessor.js";import{V as r}from"./VertexAttribute.js";import{e as s}from"../core/lang.js";import{l as i,d as n,c}from"./mathUtils.js";import{d as l}from"./boundedPlane.js";import{l as o,m as u,b as m}from"./sphere.js";import{V as p}from"./ViewingMode.js";class d{constructor(){this.id=a()}}var h;!function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Mesh=2]="Mesh",e[e.Line=3]="Line",e[e.Point=4]="Point",e[e.Material=5]="Material",e[e.Texture=6]="Texture",e[e.COUNT=7]="COUNT"}(h||(h={}));const f=new Map([[r.POSITION,0],[r.NORMAL,1],[r.NORMALCOMPRESSED,1],[r.UV0,2],[r.COLOR,3],[r.COLORFEATUREATTRIBUTE,3],[r.SIZE,4],[r.TANGENT,4],[r.CENTEROFFSETANDDISTANCE,5],[r.SYMBOLCOLOR,5],[r.FEATUREATTRIBUTE,6],[r.INSTANCEFEATUREATTRIBUTE,6],[r.INSTANCECOLOR,7],[r.OBJECTANDLAYERIDCOLOR,7],[r.INSTANCEOBJECTANDLAYERIDCOLOR,7],[r.ROTATION,8],[r.INSTANCEMODEL,8],[r.INSTANCEMODELNORMAL,12],[r.INSTANCEMODELORIGINHI,11],[r.INSTANCEMODELORIGINLO,15]]);function O(e,t){return new C(e,T,t)}function v(e,t){const{curvatureDependent:a,scaleStart:r,scaleFallOffRange:s}=T;return new C(e,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:E.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:E.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:s,minPixelSize:E.minPixelSize},t)}function _(e,t,a){const r=a.parameters;return M.scale=Math.min(r.divisor/(t-r.offset),1),M.factor=function(e){return Math.abs(e*e*e)}(e),M}function g(e,t){return i(e*Math.max(t.scale,t.minScaleFactor),e,t.factor)}function A(e,t,a,r){r.scale=function(e,t,a){const r=_(e,t,a);return r.minScaleFactor=0,g(1,r)}(e,t,a),r.factor=0,r.minScaleFactor=a.minScaleFactor}function F(e,t,a=[0,0]){const r=Math.min(Math.max(t.scale,t.minScaleFactor),1);return a[0]=e[0]*r,a[1]=e[1]*r,a}class C{get minScaleFactor(){return null!=this._fontHeight?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(e,t,a,r={camera:{distance:0,fovY:0},divisor:0,offset:0},s){this._viewingMode=e,this._description=t,this._ellipsoidRadius=a,this.parameters=r,this._fontHeight=s,this._viewingMode===p.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return!(this.parameters&&this.parameters.camera.fovY===e.fovY&&this.parameters.camera.distance===e.distance||(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),0))}overrideFontHeight(e){return e!==this._fontHeight?new C(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,t,a){const{scaleStart:r,scaleFallOffRange:s}=this._description,{fovY:i,distance:n}=e,c=this._calculateCurvatureDependentParameters(e,t),l=this._coverageCompensation(e,t,c),{tiltAngle:o,scaleFallOffFactor:u}=c,m=Math.sin(o)*n,p=.5*Math.PI-o-i*(.5-r*l),d=m/Math.cos(p),h=p+i*s*l,f=(d-u*(m/Math.cos(h)))/(1-u);return a.camera.fovY=e.fovY,a.camera.distance=e.distance,a.offset=f,a.divisor=d-f,a}_calculateCurvatureDependentParametersLocal(e,t,a=N){return a.tiltAngle=this._description.curvatureDependent.min.tiltAngle,a.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,a}_calculateCurvatureDependentParametersGlobal(e,t,a=N){const r=this._description.curvatureDependent,s=1+e.distance/t,n=Math.sqrt(s*s-1),[l,o]=[r.min.curvature,r.max.curvature],u=c((n-l)/(o-l),0,1),[m,p]=[r.min,r.max];return a.tiltAngle=i(m.tiltAngle,p.tiltAngle,u),a.scaleFallOffFactor=i(m.scaleFallOffFactor,p.scaleFallOffFactor,u),a}_surfaceCoverageCompensationLocal(e,t,a){return l(a.tiltAngle,e.fovY)}_surfaceCoverageCompensationGlobal(e,t,a){return o(R,t),u(R,a.tiltAngle,e.distance,e.fovY)}}const T={curvatureDependent:{min:{curvature:n(10),tiltAngle:n(12),scaleFallOffFactor:.5},max:{curvature:n(70),tiltAngle:n(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},E={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14},M={scale:0,factor:0,minScaleFactor:0},N={tiltAngle:0,scaleFallOffFactor:0},R=m();function S(e,t,a,r,s){let i=(a.screenLength||0)*e.pixelRatio;null!=s&&(i=function(e,t,a,r){return g(e,_(t,a,r))}(i,r,t,s));const n=i*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return c(n*t,a.minWorldLength||0,null!=a.maxWorldLength?a.maxWorldLength:1/0)}function D(e,t){let a=!1;for(const r in t){const i=t[r];void 0!==i&&(Array.isArray(i)?Array.isArray(e[r])&&s(i,e[r])||(e[r]=i.slice(),a=!0):e[r]!==i&&(a=!0,e[r]=i))}return a}const L={multiply:1,ignore:2,replace:3,tint:4};class P extends d{constructor(t,a){super(),this.type=h.Material,this.supportsEdges=!1,this._renderPriority=0,this.vertexAttributeLocations=f,this._pp0=e(0,0,1),this._pp1=e(0,0,0),this._parameters=new a,D(this._parameters,t),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(e){return!1}setParameters(e,t=!0){D(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this._parametersChanged())}validateParameters(e){}shouldRender(e){return this.visible&&this.isVisibleForOutput(e.output)&&(!this.parameters.isDecoration||e.bind.decorations)&&!!(this.parameters.renderOccluded&e.renderOccludedMask)}isVisibleForOutput(e){return!0}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this._parametersChanged())}_parametersChanged(){this.repository?.materialChanged(this)}queryRenderOccludedState(e){return this.visible&&this.parameters.renderOccluded===e}get hasEmissions(){return!1}intersectDraped(e,t,a,r,s,i){return this._pp0[0]=this._pp1[0]=r[0],this._pp0[1]=this._pp1[1]=r[1],this.intersect(e,t,a,this._pp0,this._pp1,s)}}var x;!function(e){e[e.None=0]="None",e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"}(x||(x={}));class I extends t{constructor(){super(...arguments),this.renderOccluded=x.Occlude,this.isDecoration=!1}}export{h as C,f as D,P as M,x as R,d as a,I as b,g as c,F as d,L as e,v as f,O as g,A as p,D as u,S as v};
