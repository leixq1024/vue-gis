/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{C as t}from"./CIMResourceManager.js";import{C as e,a as s,T as r}from"./CIMSymbolHelper.js";import{O as o}from"./OverrideHelper.js";import{m as i}from"./utils7.js";import"./fontUtils.js";import"../config.js";import"../core/lang.js";import"./imageUtils.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"./Logger.js";import"../core/JSONSupport.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"./BidiEngine.js";import"./screenUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./boundsUtils.js";import"../symbols/Font.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./zmUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polyline.js";import"./OptimizedGeometry.js";import"./GeometryUtils.js";import"./enums2.js";import"../geometry.js";import"./typeUtils.js";import"./definitions.js";import"./shapingUtils.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2.js";import"./common.js";import"./vec2f32.js";import"./Rect.js";import"./BoundingBox.js";import"./defaults.js";import"../symbols/SimpleFillSymbol.js";import"../Color.js";import"./colorUtils.js";import"./enumeration.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/Symbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/TextSymbol.js";import"./defaultsJSON.js";import"./colorUtils2.js";import"./vec4.js";import"./vec4f64.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./datetime.js";import"./number.js";import"./substitute.js";import"./messages.js";import"./quantizationUtils.js";const m=96/72;class a{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new t}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,s,r,m,a,l,n,c,j){if(!t)return null;const{data:y}=t;if(!y||"CIMSymbolReference"!==y.type||!y.symbol)return null;const{symbol:h}=y;l||(l=i(h));const g=await o.resolveSymbolOverrides(y,s,this._spatialReference,a,l,n,c),u=this._cimResourceManager,d=[];e.fetchResources(g,u,d),e.fetchFonts(g,u,d),d.length>0&&await Promise.all(d);const{width:b,height:S}=r,w=p(l,b,S,m),f=e.getEnvelope(g,w,u);if(!f)return null;f.x===1/0&&(f.x=b+2),f.y===1/0&&(f.y=-S/2),f.width===-1/0&&(f.width=b),f.height===-1/0&&(f.height=S);let M=1,U=0,v=0;switch(h.type){case"CIMPointSymbol":case"CIMTextSymbol":{let t=1;f.width>b&&(t=b/f.width);let e=1;f.height>S&&(e=S/f.height),"preview"===m&&(f.width<b&&(t=b/f.width),f.height<S&&(e=S/f.height)),M=Math.min(t,e),U=f.x+f.width/2,v=f.y+f.height/2}break;case"CIMLineSymbol":{(j||f.height>S)&&(M=S/f.height),v=f.y+f.height/2;const t=f.x*M+b/2,e=(f.x+f.width)*M+b/2,{paths:s}=w;s[0][0][0]-=t/M,s[0][2][0]-=(e-b)/M}break;case"CIMPolygonSymbol":{U=f.x+f.width/2,v=f.y+f.height/2;const t=f.x*M+b/2,e=(f.x+f.width)*M+b/2,s=f.y*M+S/2,r=(f.y+f.height)*M+S/2,{rings:o}=w;t<0&&(o[0][0][0]-=t,o[0][3][0]-=t,o[0][4][0]-=t),s<0&&(o[0][0][1]+=s,o[0][1][1]+=s,o[0][4][1]+=s),e>b&&(o[0][1][0]-=e-b,o[0][2][0]-=e-b),r>S&&(o[0][2][1]+=r-S,o[0][3][1]+=r-S)}}const x={type:"cim",data:{type:"CIMSymbolReference",symbol:g}};return this.rasterize(x,b,S,U,v,M,l,1,w)}rasterize(t,e,o,a,l,n,c,j=0,y=null){const{data:h}=t;if(!h||"CIMSymbolReference"!==h.type||!h.symbol)return null;const{symbol:g}=h,u=this._canvas,d=(window.devicePixelRatio||1)*m;u.width=e*d,u.height=o*d,c||(c=i(g)),y||(y=p(c,e,o,"legend")),u.width+=2*j,u.height+=2*j;const b=u.getContext("2d",{willReadFrequently:!0}),S=r.createIdentity();return S.translate(-a,-l),S.scale(n*d,-n*d),S.translate(e*d/2+j,o*d/2+j),b.clearRect(0,0,u.width,u.height),new s(b,this._cimResourceManager,S,!0).drawSymbol(g,y),b.getImageData(0,0,u.width,u.height)}}function p(t,e,s,r){const o=-e/2+1,i=e/2-1,m=s/2-1,a=-s/2+1;switch(t){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[o,0],[0,0],[i,0]]]};default:return"legend"===r?{rings:[[[o,m],[i,0],[i,a],[o,a],[o,m]]]}:{rings:[[[o,m],[i,m],[i,a],[o,a],[o,m]]]}}}export{a as CIMSymbolRasterizer};
