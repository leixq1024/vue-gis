/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Evented.js";import{throwIfAborted as r}from"../core/promiseUtils.js";import{watch as s,initial as o}from"../core/reactiveUtils.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./Logger.js";import{subclass as n}from"../core/accessorSupport/decorators/subclass.js";import a from"../geometry/SpatialReference.js";import{Q as l}from"./QueryEngine.js";import m from"../rest/support/Query.js";import p from"../core/Accessor.js";import{c as d}from"./asyncUtils.js";import{R as c}from"./ReactiveMap.js";import{P as u,B as h}from"./PooledRBush.js";import{g as f}from"./centroid.js";import{O as j}from"./OptimizedGeometry.js";import{t as y,v as g}from"./aaBoundingRect.js";import{f as _}from"./query.js";import b from"../core/Error.js";import{P as w}from"./pbf.js";import{c as I,e as R}from"./vec3f64.js";import{f as C,c as S,s as x}from"./aaBoundingBox.js";import{n as v}from"./quantizationUtils.js";import T from"../layers/support/FieldsIndex.js";import{a as E,b as O}from"./pbfQueryUtils.js";import{V as A}from"./ViewingMode.js";import{a as M,c as D}from"./Indices.js";import{c as F}from"./FeaturePipelineRenderManager.js";import{c as U,i as B,t as P,l as L,s as N}from"./mat4.js";import{c as G}from"./mat4f64.js";import{a4 as k,a5 as V}from"./StencilUtils.js";import{V as Q}from"./VertexAttribute.js";import{D as z}from"./DefaultMaterial.js";import{p as q}from"./projectBuffer.js";import{p as W}from"./projectVectorToVector.js";import{c as Y}from"./computeTranslationToOriginAndRotation.js";import{o as J,b as H}from"./symbolLayerUtils3D.js";import{b as Z}from"./graphicUtils.js";import{j as X}from"./GeometryUtil.js";import{A as $}from"./Attribute.js";import{R as K}from"./RenderCoordsHelper.js";import"./handleUtils.js";import"../core/Handles.js";import"../config.js";import"./maybe.js";import"./ensureType.js";import"./utils.js";import"./metadata.js";import"./ObservableBase.js";import"./tracking.js";import"../core/scheduling.js";import"../core/Collection.js";import"./shared.js";import"./SimpleObservable.js";import"../core/JSONSupport.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./writer.js";import"../geometry/projection.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"./mathUtils.js";import"../geometry/Polyline.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./geodesicConstants.js";import"../geometry/support/jsonUtils.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./simplify.js";import"../geometry.js";import"./typeUtils.js";import"./utils9.js";import"./utils10.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./LRUCache.js";import"./MemCache.js";import"../core/sql/WhereClause.js";import"./TimeOnly.js";import"./UnknownTimeZone.js";import"./datetime.js";import"./locale.js";import"./fieldType.js";import"./timeSupport.js";import"./projectionSupport.js";import"./json.js";import"./QueryEngineCapabilities.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./number.js";import"./substitute.js";import"./messages.js";import"./utils13.js";import"./screenUtils.js";import"./timeUtils.js";import"./heatmapUtils.js";import"./vec4.js";import"./common.js";import"./vec4f64.js";import"./utils3.js";import"./basemapUtils.js";import"../Basemap.js";import"./collectionUtils.js";import"../core/Loadable.js";import"../core/Promise.js";import"./loadAll.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./persistableUrlUtils.js";import"../support/BasemapStyle.js";import"./writeUtils.js";import"./layerUtils.js";import"./utils2.js";import"./colorUtils.js";import"./utils11.js";import"./generateRendererUtils.js";import"./enumeration.js";import"./SnappingCandidate.js";import"./queryUtils.js";import"./Scheduler.js";import"../core/signal.js";import"./debugFlags.js";import"./DataLayerSource.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./FullTextSearch.js";import"../core/Clonable.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"./quickselect.js";import"./queryZScale.js";import"./LodRenderer.js";import"./vec2.js";import"./vec2f64.js";import"./debugFlags2.js";import"./vec3.js";import"./glUtil.js";import"./enums.js";import"./VertexElementDescriptor.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./types.js";import"./Util.js";import"../views/3d/webgl/RenderCamera.js";import"./frustum.js";import"./ray.js";import"./mat3.js";import"./mat3f64.js";import"./plane.js";import"./quatf64.js";import"./mathUtils2.js";import"./Matrix4PassUniform.js";import"./BindType.js";import"./MergedRenderer.js";import"./NestedMap.js";import"./basicInterfaces.js";import"./SceneLighting.js";import"./compilerUtils.js";import"./NormalAttribute.glsl.js";import"./interfaces3.js";import"./VertexPosition.glsl.js";import"./Matrix3DrawUniform.js";import"./Material.js";import"./boundedPlane.js";import"./lineSegment.js";import"./sphere.js";import"./intersectorUtils.js";import"./Octree.js";import"./BufferObject.js";import"./Texture.js";import"./GLObjectType.js";import"./Intersector3.js";import"./verticalOffsetUtils.js";import"./orientedBoundingBox.js";import"./quat.js";import"./spatialReferenceEllipsoidUtils.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./Intersector2.js";import"./sdfPrimitives.js";import"./doublePrecisionUtils.js";import"./floatRGBA.js";import"./LodResources.js";import"./HUDMaterial.js";import"./HUDVisibility.glsl.js";import"./VerticalOffset.glsl.js";import"./ScreenSpacePass.glsl.js";import"./HUDRenderStyle.js";import"./AlphaCutoff.js";import"./GLTextureMaterial.js";import"./RayIntersections.js";import"./RgbaFloatEncoding.glsl.js";import"./Float4DrawUniform.js";import"./renderState.js";import"./ShaderTechniqueConfiguration.js";import"./triangle.js";import"./lengthUtils.js";import"./requestImageUtils.js";import"./VertexColor.glsl.js";import"./DecodeSymbolColor.glsl.js";import"./Matrix4sPassUniform.js";import"../views/3d/webgl.js";import"../views/3d/webgl/RenderNode.js";import"./CameraSpace.glsl.js";import"./projectPointToVector.js";import"./dehydratedPoint.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"./hydratedFeatures.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./vec3f32.js";import"./projectVectorToPoint.js";import"./dehydratedFeatureUtils.js";class ee{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){const r=this._bufferWriter;let s=null;if(e.transformation&&t)U(te,e.transformation),te[12]-=t[0],te[13]-=t[1],te[14]-=t[2],s=te;else{if(t)throw new Error("not implemented");e.transformation&&(s=e.transformation)}let o=null;s&&(B(re,te),P(re,re),o=re);const i=e.attributes,n=r.elementCount(i),a=r.vertexBufferLayout.stride/4;n>Math.floor(se/a)&&console.warn("geometry with very large number of elements encountered");const l=r.vertexBufferLayout.createBuffer(n);return r.write(s,o,i,e.objectAndLayerIdColor,l,0),{data:l.buffer,elementCount:n}}}const te=G(),re=G(),se=4194304;class oe{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){const t=this._context,r=t.generateId("material");switch(e){case"default":{const e=new z({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),s=new ee(e);t.registerRenderGeometryBufferWriter(r,s)}break;case"hud":{const e=F(null,this._context.globalViewingMode)[0],s=new ee(e);t.registerRenderGeometryBufferWriter(r,s)}}return this._commands.push({id:"create-material",type:e,materialId:r}),r}createDirectRenderer(e){const t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,r){const s=t.materialId,o=this._context.getRenderGeometryBufferWriter(s);if(null==o)throw new Error(`no bufferwriter found for material ${s}`);const i=o.createBuffer(t,r);this._transferables.add(i.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:s,renderGeometryBuffer:i,localOrigin:r})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){const t=this._context.generateId("lod-renderer"),r={levels:e.levels.map((e=>({components:e.components.map((e=>{const t=e.attributes.get(Q.POSITION);if(!t||0===t.indices.length)throw new Error("positions attribute expected");const r=M(t.indices.length/3),s=new k(r,3,t),o=this._context.getRenderGeometryBufferWriter(e.materialId);if(null==o)throw new Error("writer not found");const i=o.createBuffer(e,null);return this._transferables.add(i.data),{materialId:e.materialId,renderGeometryBuffer:i,boundingInfo:{bbMax:s.bbMax,bbMin:s.bbMin}}})),minScreenSpaceRadius:e.minScreenSpaceRadius})))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:r}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}async dispatch(){const e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),this._context.dispatchRenderCommands(e,t)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}}let ie=class extends p{constructor(e){super(e),this._removing=0,this._tiles=new c}destroy(){for(const e of this._tiles.values())e.remove();this._tiles.clear()}get updating(){if(this._removing>0)return!0;for(const e of this._tiles.values())if(!e.finished)return!0;return!1}async onTileTreeChange(e){const{added:t,removed:r}=e,s=this._tiles,o=[];for(const e of r){const t=s.get(e);null!=t&&(t.abort(),s.delete(e),o.push({tileId:e}))}for(const e of t)s.has(e.id)||s.set(e.id,d((t=>this._addTile(e,t))));await this._removeTiles(o)}async _addTile(e,t){const s=await this.addTile(e,t);return r(t),s}async _removeTiles(e){this._removing++,await this.removeTiles(e),this._removing--}};e([i()],ie.prototype,"updating",null),e([i({constructOnly:!0})],ie.prototype,"addTile",void 0),e([i({constructOnly:!0})],ie.prototype,"removeTiles",void 0),e([i()],ie.prototype,"_removing",void 0),ie=e([n("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],ie);class ne{constructor(e,t){this._index=e,this._view=t}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new ae(this._index,this._view,e)}}class ae extends ne{constructor(e,t,r){super(e,t),this._geometryOverride=r}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return f(new j,this._geometryOverride,e.hasZ,e.hasM)}}class le{constructor(){this._storedTiles=new Map,this._pageBounds=new Map,this.events=new t,this.featureAdapter=me.shared}addTile(e){this._storedTiles.set(e.descriptor.id,e);for(const t of e.pages)this._addPage(t)}removeTile(e){const t=this._storedTiles,r=t.get(e);if(null!=r){t.delete(e);for(const e of r.pages)this._removePage(e)}}_addPage(e){const{featureCount:t}=e;if(0===t)return;const r=new u(9,(t=>e.getBounds(t))),s=new Array;for(let e=0;e<t;++e)s[e]=e;r.load(s),this._pageBounds.set(e,r),this.events.emit("changed")}_removePage(e){this._pageBounds.delete(e),this.events.emit("changed")}clear(){this._storedTiles.clear(),this._pageBounds.clear(),this.events.emit("changed")}forEach(e){for(const[t,r]of this._pageBounds)r.all((r=>e(new ne(r,t))))}forEachInBounds(e,t){pe.minX=e[0],pe.minY=e[1],pe.maxX=e[2],pe.maxY=e[3];for(const[e,r]of this._pageBounds)r.search(pe,(r=>t(new ne(r,e))))}forEachBounds(e,t){for(const r of e)t(r.getBoundingBox())}getFullExtent(e){let t=1/0,r=1/0,s=-1/0,o=-1/0;for(const e of this._pageBounds.values()){const{minX:i,minY:n,maxX:a,maxY:l}=e.toJSON();t=Math.min(t,i),r=Math.min(r,n),s=Math.min(s,a),o=Math.min(o,l)}return{xmin:t,ymin:r,xmax:s,ymax:o,spatialReference:e}}}class me{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}}me.shared=new me;const pe=new h;class de{constructor(e,t){this.descriptor=e,this.pages=t}}class ce{constructor(e){const t=new w(new Uint8Array(e),new DataView(e));this._reader=t,this._index=function(e){for(;e.next();){if(2===e.tag())return ue(e.getMessage());e.skip()}fe()}(t)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){const{_index:{fieldsIndex:r,attributeIndices:s}}=this,o=r.get(t)?.index;if(null==o)return;const i=s[e*r.fields.length+o],n=this._reader;return n.move(i),je(n)}getAttributeAsTimestamp(e,t){const r=this.getAttribute(e,t);return"string"==typeof r?new Date(r).getTime():"number"==typeof r||null==r?r:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:r}}=this,s=e*t.fields.length,o=this._reader,i={};for(const e of t.fields){const t=r[s+e.index];o.move(t),i[e.name]=je(o)}return i}getCoordinates(e,t,r=0){const s=this._reader,{transform:o,featureIndices:i}=this._index,{scale:n,translate:a}=o;s.move(i[e]),this._readCoordinates(n,a,t,r)}getOptimizedGeometry(e){const t=I();return this.getCoordinates(e,t),new j([],t)}getCentroid(e,{hasZ:t,hasM:r}){this.getCoordinates(e,ye);const[s,o,i]=ye,n=[s,o];return t&&(n[3]=i),r&&(n[t?4:3]=0),new j([],n)}getBounds(e){this.getCoordinates(e,ye);const[t,r]=ye,s=new h;return s.minX=t,s.minY=r,s.maxX=t,s.maxY=r,s}getBoundingBox(e){this.getCoordinates(e,ye);const[t,r,s]=ye;return C(t,r,s,t,r,s)}readAllObjectIds(e,t=0){const r=this._reader,{_index:s,featureCount:o}=this,{objectIdFieldName:i,attributeIndices:n,fieldsIndex:a}=s,l=a.get(i).index,m=a.fields.length;for(let s=0;s<o;++s){const o=n[s*m+l];r.move(o),e[t++]=je(r)}return t}readAllCoordinates(e,t=0){const r=this._reader,{transform:s,featureIndices:o}=this._index,{scale:i,translate:n}=s;for(const s of o)r.move(s),t=this._readCoordinates(i,n,e,t);return t}_readCoordinates([e,t,r],[s,o,i],n,a){const l=this._reader,m=l.getLength(),p=l.pos()+m;for(;l.pos()<p&&l.next();)switch(l.tag()){case 2:{const m=l.getLength(),p=l.pos()+m;for(;l.pos()<p&&l.next();)3===l.tag()?(l.getUInt32(),n[a++]=s+e*l.getSInt64(),n[a++]=o+t*l.getSInt64(),n[a++]=i+r*l.getSInt64()):l.skip();break}default:l.skip()}return a}}function ue(e){for(;e.next();){if(1===e.tag())return he(e.getMessage());e.skip()}fe()}function he(e){let t,r,s=!1,o=!1,i=0;const n=new Array,a=new Array,l=new Array;for(;e.next();)switch(e.tag()){case 1:r=e.getString();break;case 7:0!==e.getEnum()&&fe();break;case 9:s=e.getBool()??!1;break;case 12:t=v(e.processMessage(O));break;case 13:{const t=e.processMessage(E);t.index=i++,n.push(t);break}case 15:{a.push(e.pos());const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r&&e.next();)1===e.tag()?(l.push(e.pos()),e.skip()):e.skip();break}case 10:o=e.getBool()??!1;break;default:e.skip()}const m=new T(n);return null!=t&&o&&null!=r&&m.has(r)||fe(),{transform:t,exceededTransferLimit:s,fieldsIndex:m,objectIdFieldName:r,featureIndices:a,attributeIndices:l}}function fe(){const e=new b("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(e),e}function je(e){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}const ye=I();class ge{constructor(e,t,r,s,o){this.spatialReference=e,this.url=r,this.objectIdField=s,this.capabilities=o;const{supportsMaxRecordCountFactor:i,maxRecordCount:n}=this.capabilities.query,a=i?4:1,l=(n??8e3)*a;this._pageSize=Math.min(8e3,l);const m=t.clone();m.cacheHint=!0,m.resultType="tile",m.outSpatialReference=e,m.returnGeometry=!0,m.returnZ=!0,m.maxRecordCountFactor=a,m.num=this._pageSize,m.outFields=[s],this._baseQuery=m}async fetch(e,t){const{spatialReference:s}=this,o=y(e.extent,s),i=this._baseQuery.clone();i.geometry=o;const n=new Array;let a=0,l=!1,m=1;for(;!l;){const e=[];for(let r=0;r<m;++r)e.push(this._fetchPage(i,a++,t));const s=await Promise.all(e);r(t);for(const e of s){const t=0!==e.featureCount;l||=!e.exceededTransferLimit||!t,t&&n.push(e)}m=Math.min(m+1,4)}return new de(e,n)}async _fetchPage(e,t,s){const o=e.clone();o.start=t*this._pageSize;const i=(await _(this.url,o,{signal:s})).data;return r(s),new ce(i)}}class _e{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===A.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new oe(this)}async dispatchRenderCommands(e,t){this._dispatchRenderCommandsCallback(e,t)}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}}var be;async function we(e,t){const{numFeatures:r,tile:s,partitionInfo:o}=e,{pages:i}=s;if(0===i.length||0===r)return new Uint32Array;const n=new Uint32Array(r);if(o){const e=i.reduce(((e,{featureCount:t})=>e+t),0),t=new Uint32Array(e);let s=0;for(const e of i)s=e.readAllObjectIds(t,s);const a=o.tileIndices;for(let e=0;e<r;++e){const r=t[a[e]];n[e]=r}}else{let e=0;for(const t of i)e=t.readAllObjectIds(n,e)}return n}async function Ie(e,t){const{numFeatures:r,tile:s,partitionInfo:o}=e,{pages:i}=s;if(0===i.length||0===r)return new Float64Array;const n=new Float64Array(3*r);if(o){const e=i.reduce(((e,{featureCount:t})=>e+t),0),t=new Float64Array(3*e);let s=0;for(const e of i)s=e.readAllCoordinates(t,s);const a=o.tileIndices;for(let e=0;e<r;++e){const r=a[e],s=t[3*r+0],o=t[3*r+1],i=t[3*r+2];n[3*e+0]=s,n[3*e+1]=o,n[3*e+2]=i}}else{let e=0;for(const t of i)e=t.readAllCoordinates(n,e)}return n}async function Re(e,t){await e.provision([be.GEOMETRY_MAP_COORDINATES],t);const{numFeatures:r,tile:s,mapCoordinates:o}=e,{pages:i}=s;if(0===i.length||0===r)return new Float64Array;const n=t.viewSpatialReference,a=t.renderSpatialReference,l=new Float64Array(3*r);if(!q(o,n,0,l,a,0,r))throw new Error("Failed to project coordinates");return l}async function Ce(e,t){const r=t.viewSpatialReference,s=t.renderSpatialReference,o=e.tile.descriptor.extent,i=g(o),n=I();return W([i[0],i[1],0],r,n,s),n}!function(e){e[e.OBJECT_ID=0]="OBJECT_ID",e[e.PARTITION_ID=1]="PARTITION_ID",e[e.GEOMETRY_MAP_COORDINATES=2]="GEOMETRY_MAP_COORDINATES",e[e.GEOMETRY_RENDER_COORDINATES=3]="GEOMETRY_RENDER_COORDINATES",e[e.TILE_CENTER_RENDER_COORDINATES=4]="TILE_CENTER_RENDER_COORDINATES"}(be||(be={}));class Se{constructor(e,t,r=null){this._tile=e,this._numFeatures=t,this._partitionInfo=r}get partitionInfo(){return this._partitionInfo}get tile(){return this._tile}get numFeatures(){return this._numFeatures}get tileId(){return this._tile.descriptor.id}get objectIds(){if(null==this._objectIds)throw new Error("objectIds haven't been provisioned yet");return this._objectIds}get partitionIds(){if(null==this._partitionIds)throw new Error("partitionIds haven't been provisioned yet");return this._partitionIds}get mapCoordinates(){if(null==this._mapCoordinates)throw new Error("mapCoordinates haven't been provisioned yet");return this._mapCoordinates}get renderCoordinates(){if(null==this._renderCoordinates)throw new Error("renderCoordinates haven't been provisioned yet");return this._renderCoordinates}get tileCenterRenderCoordinates(){if(null==this._tileCenterRenderCoordinates)throw new Error("tileCenterRenderCoordinates hasn't been provisioned yet");return this._tileCenterRenderCoordinates}async provision(e,t){for(const r of e)switch(r){case be.OBJECT_ID:if(this._objectIds)return;this._objectIds=await we(this);break;case be.PARTITION_ID:if(this._partitionIds)return;this._partitionIds=new Uint32Array(this._numFeatures);break;case be.GEOMETRY_MAP_COORDINATES:if(this._mapCoordinates)return;this._mapCoordinates=await Ie(this);break;case be.GEOMETRY_RENDER_COORDINATES:if(this._renderCoordinates)return;this._renderCoordinates=await Re(this,t);break;case be.TILE_CENTER_RENDER_COORDINATES:if(this._tileCenterRenderCoordinates)return;this._tileCenterRenderCoordinates=await Ce(this,t);break;default:throw new Error("not implemented")}}dispose(){if(this.partitions){for(const e of this.partitions)e.dispose();this.partitions=void 0}}}function xe(e){const t=new Map;for(const[r,s]of e)t.set(r,{...s,indices:D(s.indices)});return t}function ve(e,t){let r=e.get(t);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:V(r.data)},e.set(t,r)),r}const Te=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];let Ee=class extends p{constructor(e){super(),this._context=e,this.lodRendererId=null,this._loaded=!1}get loaded(){return this._loaded}async load(e){const t=function(e,t){switch(e){case"cone":return((e,r,s=!1)=>({levels:Te.map((e=>{const o=xe(r(e.tesselation));return s&&function(e){const t=e,r=t.get(Q.POSITION).data,s=t.get(Q.NORMAL).data;if(s){const t=ve(e,Q.NORMAL).data;for(let e=0;e<s.length;e+=3){const r=s[e+1];t[e+1]=-s[e+2],t[e+2]=r}}if(r){const t=ve(e,Q.POSITION).data;for(let e=0;e<r.length;e+=3){const s=r[e+1];t[e+1]=-r[e+2],t[e+2]=s}}}(o),{components:[{attributes:o,objectAndLayerIdColor:void 0,transformation:null,materialId:t}],minScreenSpaceRadius:e.minScreenSpaceRadius}}))}))(0,(e=>X(1,.5,e,!1)),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}("cone",e.createMaterial("default"));this.lodRendererId=e.createLodRenderer(t),this._loaded=!0}async add(e,t){if(null==this.lodRendererId)throw new Error("expected lod renderer id to not be null");await this._provisionFeatureData(e);const r=e.numFeatures,s=S(J("cone")),o=R(x(s)),i=R(H(o,{isPrimitive:!0,width:100,depth:null,height:null})),n=new Float64Array(16*r),a=new Float64Array(16*r),l=e.mapCoordinates;for(let e=0;e<r;++e){const t=e,r=l[3*e+0],s=l[3*e+1],m=l[3*e+2],p=this._computeGlobalTransform(r,s,m,this._context.viewSpatialReference,Me),d=this._computeLocalTransform(i,o,Ae);this._writeMatrixToTypedBuffer(n,t,d),this._writeMatrixToTypedBuffer(a,t,p)}const m={featureIds:new Uint32Array(e.objectIds),localTransforms:n,globalTransforms:a};t.addLodInstances(this.lodRendererId,m)}async remove(e,t){if(null==this.lodRendererId)return;const r=new Uint32Array(e.objectIds);t.removeLodInstances(this.lodRendererId,r)}async _provisionFeatureData(e){await e.provision([be.GEOMETRY_MAP_COORDINATES,be.OBJECT_ID],this._context)}_writeMatrixToTypedBuffer(e,t,r){let s=16*t;for(let t=0;t<16;t++)e[s++]=r[t]}_computeGlobalTransform(e,t,r,s,o){return Oe[0]=e,Oe[1]=t,Oe[2]=r,Y(s,Oe,o,this._context.renderSpatialReference),o}_computeLocalTransform(e,t,r){return L(r),this._applyObjectScale(e,t,r),r}_applyObjectScale(e,t,r){const s=Z(e,e,t,this._context.renderCoordsHelper.unitInMeters);1===s[0]&&1===s[1]&&1===s[2]||N(r,r,s)}};Ee=e([n("esri.views.3d.layers.graphics.pipeline.symbolization.TestObjectSymbol")],Ee);const Oe=I(),Ae=G(),Me=G();let De=class extends p{constructor(e){super(),this._context=e,this.materialId=null,this._loaded=!1}get loaded(){return this._loaded}async load(e){this.materialId=e.createMaterial("hud"),e.createDirectRenderer(this.materialId),this._loaded=!0}async add(e,t){if(null==this.materialId)throw new Error("expected material not to be null");await this._provisionFeatureData(e);const{numFeatures:r,tileId:s,renderCoordinates:o,tileCenterRenderCoordinates:i}=e,n=new Float64Array([0,0,1]),a=new Float64Array([255,255,255,255]),l=new Float64Array([24,24]),m=new Float64Array([0,0,0,1]),p=new Float64Array([0,0]),d=new Float64Array([0]),c=new Uint32Array(r);for(let e=0;e<r;++e)c[e]=e;const u=new Uint32Array(r);for(let e=0;e<r;++e)u[e]=0;const h=new $(o,c,3,!0),f=new $(n,u,3,!0),j=new $(p,u,2,!0),y=new $(a,u,4,!0),g=new $(d,u,1,!0),_=new $(l,u,2,!0),b=new $(m,u,4,!0),w={attributes:xe([[Q.POSITION,h],[Q.NORMAL,f],[Q.UV0,j],[Q.COLOR,y],[Q.ROTATION,g],[Q.SIZE,_],[Q.CENTEROFFSETANDDISTANCE,b]]),objectAndLayerIdColor:void 0,transformation:G(),materialId:this.materialId};t.addDirectRendererGeometry(s,w,i)}async remove(e,t){t.removeDirectRendererGeometry(e.tileId)}async _provisionFeatureData(e){await e.provision([be.GEOMETRY_RENDER_COORDINATES,be.TILE_CENTER_RENDER_COORDINATES],this._context)}};De=e([n("esri.views.3d.layers.graphics.pipeline.symbolization.TestSymbol")],De);class Fe{constructor(e){this._symbols=new Map,this._context=e}async load(){this._symbols.set(0,new De(this._context)),this._symbols.set(1,new Ee(this._context))}async add(e,t){await this._provisionFeatureData(e,this._context);const r=this._partition(e);await Promise.all(r.map((async e=>{const r=await this._provisionSymbol(e.partitionInfo?.index,t);r&&await r.add(e,t)})))}async remove(e,t){const r=e.partitions;if(!r)throw new Error("partitioned featureset expected");await Promise.all(r.map((async e=>{const r=await this._provisionSymbol(e.partitionInfo?.index,t);r&&await r.remove(e,t)})))}async _provisionFeatureData(e,t){await e.provision([be.PARTITION_ID,be.OBJECT_ID],t)}async _provisionSymbol(e,t){if(null==e)return null;const r=this._symbols.get(e);return r?(r.loaded||await r.load(t),r):null}_partition(e){const{numFeatures:t,objectIds:r,partitionIds:s}=e,o=[[],[]];for(let e=0;e<t;++e){const t=r[e]%2;o[t].push(e),s[e]=t}return e.partitions=o.filter((e=>e.length>0)).map(((t,r)=>{const s=t.length,o={index:r,tileIndices:new Uint32Array(t)};return new Se(e.tile,s,o)})),e.partitions}}class Ue{constructor(e){this._tileFeatureData=new Map,this._context={viewSpatialReference:e.viewSpatialReference,renderSpatialReference:e.renderSpatialReference,renderCoordsHelper:K.create(e.viewingMode,e.renderSpatialReference)}}async add(e,t){this._featureRenderer||(this._featureRenderer=new Fe(this._context),await this._featureRenderer.load());const r=this._addTileFeatureData(e);await this._featureRenderer.add(r,t)}async remove(e,t){const r=this._getFeatureSetFromTileId(e);r&&(this._featureRenderer&&this._featureRenderer.remove(r,t),this._removeTileFeatureData(e))}_getFeatureSetFromTileId(e){return this._tileFeatureData.get(e)}_addTileFeatureData(e){const t=e.descriptor.id,r=e.pages.reduce(((e,{featureCount:t})=>e+t),0),s=new Se(e,r);return this._tileFeatureData.set(t,s),s}_removeTileFeatureData(e){const t=this._tileFeatureData.get(e);t&&(t.dispose(),this._tileFeatureData.delete(e))}}let Be=class extends t.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureStore=new le,this._tileManager=new ie({addTile:(e,t)=>this._addTile(e,t),removeTiles:e=>this._removeTiles(e)}),this._renderCommandContext=null,this._fetcher=null,this._symbolizer=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager.destroy()}async setup({viewSpatialReference:e,renderSpatialReference:t,viewingMode:r,baseQuery:i,url:n,objectIdField:p,capabilities:d,fieldsIndex:c,timeInfo:u}){this._renderCommandContext=new _e({viewingMode:r,dispatchRenderCommandsCallback:(e,t)=>this.remoteClient.invoke("dispatchRenderCommands",e,{transferList:t})});const h=a.fromJSON(e),f=a.fromJSON(t);return this._fetcher=new ge(h,m.fromJSON(i),n,p,d),this._symbolizer=new Ue({viewSpatialReference:h,renderSpatialReference:f,viewingMode:r}),this._queryEngine=new l({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:p,fieldsIndex:c,availableFields:[p],spatialReference:e,featureStore:this._featureStore,timeInfo:u}),this._defaultQueryJSON=new m({outSpatialReference:h}).toJSON(),this.addHandles(s((()=>this.updating),(async e=>{this.emit("notify-updating",{updating:e})})),o),Le}async executeQuery(e,t){return{result:await this._queryEngine.executeQuery(this._ensureQuery(e),t)}}async executeQueryForIds(e,t){const r=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(e),t);return{result:Array.from(r)}}async executeQueryForCount(e,t){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(e),t)}}async executeQueryForExtent(e,t){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t)}}async executeQueryForLatestObservations(e,t){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(e),t)}}async onTileTreeChange(e){return await this._tileManager.onTileTreeChange(e),Le}async _addTile(e,t){const s=await this._fetcher.fetch(e,t);r(t),this._featureStore.addTile(s);const o=this._renderCommandContext.createEncoder();return await this._symbolizer.add(s,o),await o.dispatch(),s}async _removeTiles(e){const t=this._renderCommandContext.createEncoder(),r=this._featureStore,s=this._symbolizer;for(const o of e)r.removeTile(o.tileId),await s.remove(o.tileId,t);await t.dispatch()}_ensureQuery(e){return e??this._defaultQueryJSON}};e([i()],Be.prototype,"updating",null),Be=e([n("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],Be);const Pe=Be,Le={result:void 0};export{Pe as default};
