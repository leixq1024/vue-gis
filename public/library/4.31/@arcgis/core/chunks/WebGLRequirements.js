/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{M as t,S as e,m as i,addFrameTask as n}from"../core/scheduling.js";import{g as o}from"./common.js";import{d as s}from"./mathUtils.js";import{s as a}from"./vec3.js";import{m as r}from"./handleUtils.js";import{h}from"../core/lang.js";import{d as c,r as l}from"./maybe.js";import d from"../views/input/gamepad/GamepadInputDevice.js";import{b as u}from"./screenUtils2.js";import{I as m}from"./InputManager.js";import{c as p}from"./screenUtils.js";import{c as _}from"../core/promiseUtils.js";import g from"../core/Error.js";import{g as f}from"./capabilities2.js";const v=t=>t*t,P=t=>1-v(1-t),w=t=>t*t*t,x=t=>1-w(1-t),b=t=>t<.5?w(2*t)/2:(x(2*(t-.5))+1)/2,D=t=>t*t*t*t,S=t=>1-D(1-t),y=t=>t*t*t*t*t,k=t=>1-y(1-t),M=t=>1-Math.cos(t*Math.PI/2),C=t=>1-M(1-t),T=t=>2**(10*(t-1)),F=t=>1-T(1-t),E=t=>-(Math.sqrt(1-t*t)-1),Z=t=>1-E(1-t);function z(t){const e=2*(t-Math.sqrt((t-1)*t)),i=e/2/t;return n=>n<i?t*n*n:e*n-e+1}function A(t,e){return(i,n)=>i<e?e*t(i/e,n):1-t((1-i)/(1-e),n)*(1-e)}const L=A(z(1),1),W=A(z(1),0),I=A(z(1),.5),N=A(z(2),1),U=A(z(2),0),q=A(z(2),.5),G=A(z(3),1),H=A(z(3),0),j=A(z(3),.5),O=A(z(4),1),R=A(z(4),0),B=A(z(4),.5),$={linear:t=>t,"in-quad":v,"out-quad":P,"in-out-quad":t=>t<.5?v(2*t)/2:(P(2*(t-.5))+1)/2,"in-coast-quad":L,"out-coast-quad":W,"in-out-coast-quad":I,"in-cubic":w,"out-cubic":x,"in-out-cubic":b,"in-coast-cubic":N,"out-coast-cubic":U,"in-out-coast-cubic":q,"in-quart":D,"out-quart":S,"in-out-quart":t=>t<.5?D(2*t)/2:(S(2*(t-.5))+1)/2,"in-coast-quart":G,"out-coast-quart":H,"in-out-coast-quart":j,"in-quint":y,"out-quint":k,"in-out-quint":t=>t<.5?y(2*t)/2:(k(2*(t-.5))+1)/2,"in-coast-quint":O,"out-coast-quint":R,"in-out-coast-quint":B,"in-sine":M,"out-sine":C,"in-out-sine":t=>t<.5?M(2*t)/2:(C(2*(t-.5))+1)/2,"in-expo":T,"out-expo":F,"in-out-expo":t=>t<.5?T(2*t)/2:(F(2*(t-.5))+1)/2,"in-circ":E,"out-circ":Z,"in-out-circ":t=>t<.5?E(2*t)/2:(Z(2*(t-.5))+1)/2};class K{constructor(){this.pan=0,this.rotate=0,this.fov=0,this.sourceZoom=0,this.targetZoom=0}}const Y={desiredScreenFlow:2,minDuration:t(500),maxDuration:t(8e3)},V={...Y,maxDuration:t(4e3)};class X{constructor(t){this._createCamera=t,this.compared=new K,this.segmentStart=0,this.segmentEnd=1,this.settings={desiredScreenFlow:Y.desiredScreenFlow},this.source=t(),this.target=t()}clone(){const t=new X(this._createCamera);return t.copyFrom(this),t}copyFrom(t){this.update(t.source,t.target,t.settings)}update(t,e,i){this.source!==t&&this.source.copyFrom(t),this.target!==e&&this.target.copyFrom(e),this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=i.desiredScreenFlow??Y.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(t){const e=this.target.pixelsPerPanAtZoom(t);return this.halfWindowSize/e}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>o()}get hasFov(){return Math.abs(this.compared.fov)>o()}get hasRotate(){return this.compared.rotate>o()}}let J=class{constructor(){this.segments=new Array}get time(){return this.segments.reduce(((t,i)=>e(t+i.time)),e(0))}interpolateComponentsAt(t,e){t=Math.min(Math.max(t,0),1),t*=this.time;let i=0,n=0;const o=this.definition,s=this.segments.reduce(((t,e)=>t||e.definition.hasZoom),!1);for(let a=0;a<this.segments.length;a++){const r=this.segments[a],h=r.definition;if(t<=r.time||a===this.segments.length-1){if(this.segmentInterpolateComponentsAt(r,0===r.time?0:t/r.time,e),o.hasPan&&!isNaN(e.pan)&&isFinite(o.compared.pan)?e.pan=(i+h.compared.pan*e.pan)/o.compared.pan:e.pan=1,o.hasRotate&&!isNaN(e.rotate)&&isFinite(o.compared.rotate)?e.rotate=(n+h.compared.rotate*e.rotate)/o.compared.rotate:e.rotate=1,s&&!isNaN(e.zoom)&&isFinite(h.compared.targetZoom)){const{sourceZoom:t,targetZoom:i}=h.compared,n=e.zoom*(i-t)+t,o=this.segments[0].definition.compared.sourceZoom,s=this.segments[this.segments.length-1].definition.compared.targetZoom,a=Math.abs(i-o)>Math.abs(t-o)?i:t;e.zoomOffset=a-s,e.zoom=(n-o)/(a-o)}else e.zoom=1;return e}t-=r.time,i+=h.compared.pan,n+=h.compared.rotate}}segmentInterpolateComponentsAt(t,e,i){t.interpolateComponentsAt(e,i)}};class Q{get time(){return this._time}constructor(t){t&&this.update(t)}update(t){t&&(this.definition?this.definition.copyFrom(t):this.definition=t.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const t=this.definition,e=t.compared,i=e.sourceZoom,n=e.targetZoom;this._zoomSign=i>n?1:-1,this._panPixelsAtSource=e.pan*t.source.pixelsPerPanAtZoom(i);const o=(t.source.pixelsPerRotate()+t.target.pixelsPerRotate())/2;this._rotatePixels=e.rotate*o}_updatePixelFlow(){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom,{hasZoom:n,hasPan:o,hasRotate:s}=this.definition;let a=0,r=0;n&&(o&&(a=(i/t-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),s&&(r=this._zoomSign*(Math.log(t/i)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const h=this.definition.desiredPixelFlow;if(n&&o&&s){const t=a+r+a*r;this._zoomPixelFlow=a*r/t*h,this._panPixelFlow=r/t*h,this._rotatePixelFlow=a/t*h}else if(n&&o){const t=1+a;this._zoomPixelFlow=a/t*h,this._panPixelFlow=1/t*h}else if(n&&s){const t=1+r;this._zoomPixelFlow=r/t*h,this._rotatePixelFlow=1/t*h}else if(o&&s){const t=this._panPixelsAtSource/this._rotatePixels,e=1+t;this._panPixelFlow=t/e*h,this._rotatePixelFlow=1/e*h}else o?this._panPixelFlow=h:n?this._zoomPixelFlow=h:s&&(this._rotatePixelFlow=h);if(this._time=e(Math.max(this.rotateTime,this.zoomTime,this.panTime)),this.fovTime>this._time){const t=this.fovTime/this._time;this._time=this.fovTime,this._zoomPixelFlow/=t,this._panPixelFlow/=t,this._rotatePixelFlow/=t}}get rotateTime(){return this.definition.hasRotate?e(this._rotatePixels/this._rotatePixelFlow):e(0)}get zoomTime(){return this.definition.hasZoom?e(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):e(0)}get fovTime(){return this.definition.hasFov?e(Math.abs(this.definition.compared.fov)/tt):e(0)}get panTime(){if(!this.definition.hasPan)return e(0);if(this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,i=t*this._panPixelsAtSource;return e(Math.log(i*(this._zoomPixelFlow/this._panPixelFlow)+1)/(t*this._zoomPixelFlow))}return e(this._panPixelsAtSource/this._panPixelFlow)}_interpolateComponentsZoom(t){if(0===t||1===t)return t;if(this.definition.hasZoom){const e=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(e*(e/i)**-t-e)/(i-e)}return t}_interpolateComponentsFov(t){if(0===t)return this.definition.segmentStart;if(1===t)return this.definition.segmentEnd;if(this.definition.hasFov){const{segmentStart:e,segmentEnd:i}=this.definition;return e+t*(i-e)}return this.definition.segmentStart}_interpolateComponentsPan(t){if(0===t||1===t)return t;if(this.definition.hasPan&&this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(e*t*this._time)-1))/(e*Math.LN2)}return t}_interpolateComponentsRotate(t){return t}interpolateComponentsAt(t,e){t=Math.min(Math.max(t,0),1),e.zoom=this._interpolateComponentsZoom(t),e.pan=this._interpolateComponentsPan(t),e.rotate=this._interpolateComponentsRotate(t),e.zoomOffset=0,e.fov=this._interpolateComponentsFov(t)}}const tt=s(45);function et(t,e,i){const n=e-t.compared.sourceZoom,o=t.halfWindowPanAtZoom(n);return-t.halfWindowSize*(i.ascensionFactor*Math.LN2*t.compared.pan+o)*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2*o)}function it(t,e,i){const n=1/e,o=Math.log(t.compared.sourceZoom*n),s=1/t.desiredPixelFlow,a=1/Math.LN2,r=e-t.compared.sourceZoom,h=1/r,c=(i.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(r))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*n*s*a*h*c-t.halfWindowSize*o*s*a*h+t.halfWindowSize*o*s*a*c/(r*r)}function nt(t,e,i){const n=e-t.compared.sourceZoom,o=1/n,s=1/e,a=Math.log(t.compared.sourceZoom*s),r=(i.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(n))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*o*(-2*o*s*r+2*o*a+2*s-2*a*r/(n*n)-r/(e*e))/(t.desiredPixelFlow*Math.LN2)}function ot(t,e){return-t.halfWindowSize*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2)}function st(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function at(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function rt(t,e,i){return t.halfWindowSize*(-t.halfWindowPanAtZoom(e)-i.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*t.halfWindowPanAtZoom(-e+t.compared.targetZoom))}function ht(t,e,i){const n=Math.log(e/t.compared.targetZoom),o=1/t.desiredPixelFlow,s=1/Math.LN2,a=-e+t.compared.targetZoom,r=1/a,h=(-t.halfWindowPanAtZoom(e)-i.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return-t.halfWindowSize*n*o*s*r+t.halfWindowSize*n*o*s*h/(a*a)+t.halfWindowSize*o*s*r*h/e}function ct(t,e,i){const n=e-t.compared.targetZoom,o=1/n,s=1/e,a=Math.log(e/t.compared.targetZoom),r=(t.halfWindowPanAtZoom(e)+i.descensionFactor*Math.LN2*t.compared.pan-t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*o*(-2*o*s*r-2*o*a+2*s+2*a*r/(n*n)-r/(e*e))/(t.desiredPixelFlow*Math.LN2)}function lt(t,e){return t.halfWindowSize*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2)}function dt(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function ut(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}class mt extends J{constructor(t,e){super(),this._preallocSegments=[new Q,new Q,new Q],this._ascensionSegment=null,this._descensionSegment=null,this.update(t,e)}update(t,e){if(!t)return;this.definition?this.definition.copyFrom(t):this.definition=t.clone();const i=e?.apex?function(t,e){let i=function(t,e){const i=Math.max(t.compared.sourceZoom,t.compared.targetZoom),n=t.source.zoomAtPixelsPerPan(t.desiredPixelFlow/t.compared.pan)/2;return n<i?null!=e.maximumDistance?i+(e.maximumDistance-i)/2:1.5*i:e.maximumDistance?Math.min(e.maximumDistance,n):n}(t,e);const n={ascensionFactor:null!=e.ascensionFactor?e.ascensionFactor:.5,descensionFactor:null!=e.descensionFactor?e.descensionFactor:.5},o=0===n.ascensionFactor,s=0===n.descensionFactor,a=o?ot:et,r=o?st:it,h=o?at:nt,c=s?lt:rt,l=s?dt:ht,d=s?ut:ct,u=e=>a(t,e,n)+function(t,e,i){return-t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e))}(t,e,n)+c(t,e,n),m=e=>r(t,e,n)+function(t,e,i){return t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e))}(t,e,n)+l(t,e,n),p=e=>h(t,e,n)+function(t,e,i){return-2*t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e*e))}(t,e,n)+d(t,e,n);let _=u(i);const g=function(t){const e=t.compared.sourceZoom-t.compared.targetZoom;if(0===e)return t.compared.pan*t.halfWindowSize/(t.desiredPixelFlow*t.halfWindowPanAtZoom(t.compared.sourceZoom));const i=Math.LN2*t.compared.pan,n=e,o=t.halfWindowPanAtZoom(n),s=t.halfWindowSize*Math.log(t.compared.sourceZoom/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*o);return t.compared.sourceZoom<=t.compared.targetZoom?s*(i-o):s*(i+o)}(t);let f;const v=e.maximumIterations||20,P=null!=e.maximumDistance?e.maximumDistance:1/0;for(f=0;f<v;f++){const n=e.desiredSlope??1e-6;let o=m(i);Math.abs(o)>n&&(o+=n);const s=o/p(i);if(isNaN(s)||i>=P&&s<0){if(!isFinite(P))return null;i=P,_=u(i);break}if(i-=s,i<t.compared.sourceZoom||i<t.compared.targetZoom)return null;const a=u(i);if(Math.abs(a-_)/_<=.005)break;_=a}return _>.7*g||i<t.compared.sourceZoom||i<t.compared.targetZoom?null:i}(t,e.apex):null;this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,i?this._updateWithApex(i,e?.apex):this._updateWithoutApex()}segmentInterpolateComponentsAt(t,e,i){t.interpolateComponentsAt(e,i),t===this._ascensionSegment?i.zoom=P(i.zoom):t===this._descensionSegment&&(i.zoom=v(i.zoom))}_updateWithApex(t,e){const[i,n,o]=this._preallocSegments,s=e?.ascensionFactor??.5,a=Math.min(1-s,null!=e?.ascensionFactor&&null!=e.descensionFactor?e.descensionFactor:.5),r=1-s-a;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=t,i.definition.compared.pan=this.definition.compared.pan*s,i.definition.compared.rotate=this.definition.compared.rotate*s,i.definition.segmentEnd=s,i.update(),this._ascensionSegment=i,this.segments.push(i),r>0&&(n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.copyFrom(this.definition),n.definition.compared.sourceZoom=t,n.definition.compared.targetZoom=t,n.definition.compared.pan=this.definition.compared.pan*r,n.definition.compared.rotate=this.definition.compared.rotate*r,n.definition.segmentStart=i.definition.segmentEnd,n.definition.segmentEnd=i.definition.segmentEnd+r,n.update(),this.segments.push(n)),o.definition?o.definition.copyFrom(this.definition):o.definition=this.definition.clone(),o.definition.compared.sourceZoom=t,o.definition.compared.pan=this.definition.compared.pan*a,o.definition.compared.rotate=this.definition.compared.rotate*a,o.definition.segmentStart=s+r,o.update(),this._descensionSegment=o,this.segments.push(o)}_updateWithoutApex(){const[t]=this._preallocSegments;t.update(this.definition),this.segments.push(t)}}const pt=new class{constructor(){this.pan=0,this.rotate=0,this.zoom=0,this.fov=0,this.zoomOffset=0}};let _t=class{get time(){return this._time}get isLinear(){return 1===this.path.segments.length}constructor(e){this._time=t(0),this._easing=I,this.definition=new X(e),this.path=new mt}update(t,n,o){this.definition.update(t,n,o),this.path.update(this.definition,o),this._time=this._applyTimeSettings(i(isFinite(this.path.time)?this.path.time:e(0)),o),this._easing=o.easing??(this._time>=1e3?I:F)}cameraAt(t,e){t=Math.min(Math.max(0,t),1),t=this._normalizedEasing(t);const i=this.path.interpolateComponentsAt(t,pt);e.interpolate(this.definition.source,this.definition.target,i)}_normalizedEasing(t){const e=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(t,this._time)-e)/(i-e)}_applyTimeSettings(e,i){const n=null!=i.speedFactor?i.speedFactor:1,o=i.minDuration??Y.minDuration/n,s=i.maxDuration??Y.maxDuration/n;return null!=i.duration?i.duration:t(Math.min(Math.max(e/n,o),s))}};function gt(t,e){switch(e){case"primary":return"touch"===t.pointerType||0===t.button;case"secondary":return"touch"!==t.pointerType&&2===t.button;case"tertiary":return"touch"!==t.pointerType&&1===t.button}}function ft(t,e){if("touch"===t.pointerType)return!1;switch(e){case"primary":return 0===t.button;case"secondary":return 2===t.button;case"tertiary":return 1===t.button}}class vt{constructor(t){this._callbacks=t,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(t){const e=t.data,i=e.pointers.size;switch(e.action){case"start":this._currentCount=i,this._emitStart(t);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(t);break;case"update":this._emitUpdate(t);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(t);break;case"end":this._emitEnd(t),this._currentCount=0}this._previousEvent=t}_emitStart(t){this._startEvent=t,this._callbacks.condition?.(this._currentCount,t)&&this._callbacks.start(this._currentCount,t,this._startEvent)}_emitUpdate(t){this._callbacks.condition?.(this._currentCount,t)&&this._callbacks.update(this._currentCount,t,this._startEvent)}_emitEnd(t){this._callbacks.condition?.(this._currentCount,t)&&this._callbacks.end(this._currentCount,t,this._startEvent),this._startEvent=null}}function Pt(t){let e=t*t;return t<0&&(e*=-1),e}function wt(t){return t.translation[0]=0,t.translation[1]=0,t.translation[2]=0,t.heading=0,t.tilt=0,t}function xt(t,e,i){const n=i,o=t.state,s=t.device,r="forward-down"===e.tiltDirection?1:-1;return"standard"===s.deviceType?(n.translation[0]=Pt(o.axes[0]),n.translation[1]=Pt(o.axes[1]),n.translation[2]=Pt(o.buttons[7])-Pt(o.buttons[6]),n.heading=Pt(o.axes[2]),n.tilt=Pt(o.axes[3])):"spacemouse"===s.deviceType&&(n.translation[0]=1.2*Pt(o.axes[0]),n.translation[1]=1.2*Pt(o.axes[1]),n.translation[2]=2*-Pt(o.axes[2]),n.heading=1.2*Pt(o.axes[5]),n.tilt=1.2*Pt(o.axes[3])),n.tilt*=r,a(n.translation,n.translation,1),n}function bt(t,e){const i=e;return i.translation[0]=t[1]-t[0],i.translation[1]=t[3]-t[2],i.translation[2]=t[4]-t[5],i.heading=t[7]-t[6],i.tilt=t[8]-t[9],i.zoom=t[10]-t[11],i}function Dt(t){return 0===t.translation[0]&&0===t.translation[1]&&0===t.translation[2]&&0===t.heading&&0===t.tilt&&0===t.zoom}function St(t){const e=()=>t("visible"===document.visibilityState);return document.addEventListener("visibilitychange",e),r((()=>document.removeEventListener("visibilitychange",e)))}function yt(t){const e=t.native;return e?{buttons:e.buttons.map((t=>t.pressed?t.value||1:0)),axes:e.axes.map((e=>function(t,e){const i=Math.abs(t);return i<e?0:Math.sign(t)*(i-e)/(1-e)}(e,t.axisThreshold)))}:{buttons:[],axes:[]}}class kt{constructor(t,e){this._element=t,this._input=e,this._hasEventListeners=!1,this._onConnectGamepad=t=>{this._connectGamepad(t.gamepad)},this._onDisconnectGamepad=t=>{const e=t.gamepad,i=e.index,n=this._inputDevices[i];n&&(this._emitGamepadEvent(e,yt(n),!1),this._inputDevices.splice(i,1),this._latestUpdate.splice(i,1),this._input.gamepad.devices.remove(n),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const i="getGamepads"in window.navigator,n=window.isSecureContext;this.supported=i&&n,this.supported&&(Ct((t=>this._connectGamepad(t))),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(t){this._hasEventListeners!==t&&(this._hasEventListeners=t,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(t){this._callback=t}_connectGamepad(t){const e=new d(t);"unknown"!==e.deviceType&&(this._inputDevices[t.index]=e,this._input.gamepad.devices.add(e)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){null==this._frameTask&&(this._frameTask=n({update:()=>this._readGamepadState()}))}_stopPolling(){null!=this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const t=document.hasFocus(),e=this._element.contains(document.activeElement),i="document"===this._input.gamepad.enabledFocusMode&&!t||"view"===this._input.gamepad.enabledFocusMode&&!e;Ct((t=>{const e=this._inputDevices[t.index];if(!e)return;const n=this._latestUpdate[t.index],o=yt(e),s=i||function(t){for(let e=0;e<t.axes.length;e++)if(0!==t.axes[e])return!1;for(let e=0;e<t.buttons.length;e++)if(0!==t.buttons[e])return!1;return!0}(o);if(n){if(n.timestamp===t.timestamp)return;if(!n.active&&s)return;if(function(t,e){if(t.axes.length!==e.axes.length)return!1;if(t.buttons.length!==e.buttons.length)return!1;for(let i=0;i<t.axes.length;i++)if(t.axes[i]!==e.axes[i])return!1;for(let i=0;i<t.buttons.length;i++)if(t.buttons[i]!==e.buttons[i])return!1;return!0}(n.state,o))return}this._emitGamepadEvent(t,o,!s)}))}_emitGamepadEvent(t,e,i){const n=this._latestUpdate[t.index],o=n&&n.active;if(!o&&!i)return;const s=!o&&i?"start":o&&i?"update":"end";this._latestUpdate[t.index]={timestamp:t.timestamp,state:e,active:i},this._callback&&this._callback({device:this._inputDevices[t.index],state:e,action:s})}}function Mt(t){if(!t)return!1;if(!t.connected)return!1;for(let e=0;e<t.axes.length;e++)if(isNaN(t.axes[e]))return!1;return!0}function Ct(t){for(const e of navigator.getGamepads())Mt(e)&&t(e)}const Tt=h("edge"),Ft=h("chrome"),Et=h("ff"),Zt=h("safari"),zt="esri-view-surface",At={touchNone:`${zt}--touch-none`,touchPan:`${zt}--touch-pan`};class Lt{constructor(t,e){this._input=e,this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=t,t.getAttribute("tabindex")||t.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new kt(t,this._input),this._gamepadSource.onEvent=t=>this._callback("gamepad",t)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach((t=>{this._releasePointerCaptureSafe(t)})),this._gamepadSource=c(this._gamepadSource),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(t){this._browserTouchPanningEnabled=t,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(t){this._callback=t}set activeEvents(t){for(const e in this._active)if(!t||!t.has(e)){const t=this._active[e];this._element.removeEventListener(Wt[e],t),delete this._active[e]}t&&t.forEach((t=>{if(!this._active[t]&&Wt[t]){const e=(this._eventHandlers[t]||this._handleDefault).bind(this,t);this._element.addEventListener(Wt[t],e),this._active[t]=e}})),this._gamepadSource.hasEventListeners=t?.has("gamepad")??!1}setPointerCapture(t,e){e?this._setPointerCatpureSafe(t.pointerId):(this._releasePointerCaptureSafe(t.pointerId),this._activePointerCaptures.delete(t.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?At.touchNone:At.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?At.touchPan:At.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(At.touchNone),this._element.classList.remove(At.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCatpureSafe(t){try{this._element.setPointerCapture(t),this._activePointerCaptures.add(t)}catch{}}_releasePointerCaptureSafe(t){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(t))return;this._element.releasePointerCapture(t)}catch(t){}}_updateNormalizedPointerLikeEvent(t,e){const i=u(this._element,t);return Lt.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),e.x=i.x,e.y=i.y,e}_handleKey(t,e){const{key:i}=e;i&&"key-up"===t&&this._keyDownState.delete(i);const n={native:e,key:i,repeat:!!i&&this._keyDownState.has(i)};i&&"key-down"===t&&this._keyDownState.add(n.key),this._callback(t,n)}_handlePointer(t,e){const i=this._updateNormalizedPointerLikeEvent(e,{native:e,x:0,y:0,pointerType:e.pointerType,button:e.button,buttons:e.buttons,eventId:this._eventId++});this._callback(t,i)}_handlePointerPreventDefault(t,e){const i=this._updateNormalizedPointerLikeEvent(e,{native:e,x:0,y:0,pointerType:e.pointerType,button:e.button,buttons:e.buttons,eventId:this._eventId++});e.preventDefault(),this._callback(t,i)}_getDeltaFromTrackpadOrMouseWheel(t){return t.shiftKey&&h("mac")&&0===t.deltaY?t.deltaX:t.deltaY}_handleMouseWheel(t,e){let i=this._getDeltaFromTrackpadOrMouseWheel(e);switch(e.deltaMode){case 0:Tt&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}Tt?i*=.7:Ft||Zt?i*=.6:Et&&(i*=1.375);const n=Math.abs(i);if(n>100){const t=.02;i=i/n*200/(1+Math.exp(-t*(n-100)))}const o=this._updateNormalizedPointerLikeEvent(e,{native:e,x:0,y:0,deltaY:i});this._callback(t,o)}_handlePointerCaptureLost(t,e){this._activePointerCaptures.delete(e.pointerId),this._handleDefault(t,e)}_handleDefault(t,e){const i={native:e};e.preventDefault(),this._callback(t,i)}_preventAltKeyDefault(t){"Alt"===t.key&&t.preventDefault()}_preventMultiTouchPanning(t){t.touches.length>1&&t.preventDefault()}}Lt.test={disableSubpixelCoordinates:!1};const Wt={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class It extends m{constructor(){super(!0),this.registerIncoming("context-menu",(t=>t.data.native.preventDefault()))}}const Nt={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500,maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};function Ut(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}function qt(t){const{native:e}=t,{pointerId:i,button:n,pointerType:o}=e;return"mouse"===o?`${i}:${n}`:`${o}`}class Gt extends m{constructor(t){super(!1),this._navigationTouch=t,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(t,e,i,n){return{action:t,pointerType:this._pointerType,button:this._mouseButton,buttons:e.buttons,timestamp:n,pointers:Ot(this._activePointerMap),pointer:e,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(t){const e=t.native.pointerId,i=jt(this._activePointerMap).angle,n={event:t,initialAngle:0,lastAngle:0};this._activePointerMap.set(e,n);const o=Rt(n,Ht(this._activePointerMap));n.initialAngle=o,n.lastAngle=o,this._updatePointerAngles(i)}_updatePointer(t){if(t&&null==t.x&&null==t.y)return;const e=t.native.pointerId,i=this._activePointerMap.get(e);i?i.event=t:this._addPointer(t)}_removePointer(t){const e=jt(this._activePointerMap).angle;this._activePointerMap.delete(t),this._updatePointerAngles(e)}_updatePointerAngles(t){const e=jt(this._activePointerMap);this._activePointerMap.forEach((i=>{i.initialAngle=Rt(i,e)-t,i.lastAngle=Rt(i,e)-t}))}_emitEvent(t,e,i){const n=jt(this._activePointerMap);this._drag.emit(this._createPayload(t,e,n,i),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const i=e.data.native.pointerId,n=t(e.timestamp);this._activePointerMap.get(i)&&(1===this._activePointerMap.size?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,n),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(i)):(this._removePointer(i),this._emitEvent("removed",e.data,t(e.timestamp))))}_handlePointerDrag(e){const i=e.data,n=i.currentEvent,o=t(e.timestamp);switch(i.action){case"start":case"update":this._isDragging?this._activePointerMap.has(n.native.pointerId)?(this._updatePointer(n),!this._isCurrentDragSuppressed&&this._emitEvent("update",n,o)):(this._addPointer(n),this._emitEvent("added",n,o),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(n),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",n,o))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&"touch"===this._pointerType&&1===this._activePointerMap.size}}function Ht(t){const e=[];return t.forEach((t=>{e.push(p(t.event.x,t.event.y))})),function(t,e){if(e?(e.radius=0,e.center.x=0,e.center.y=0):e={radius:0,center:p()},0===t.length)return e;if(1===t.length)return e.center.x=t[0].x,e.center.y=t[0].y,e;if(2===t.length){const[i,n]=t,[o,s]=[n.x-i.x,n.y-i.y];return e.radius=Math.sqrt(o*o+s*s)/2,e.center.x=(i.x+n.x)/2,e.center.y=(i.y+n.y)/2,e}let i=0,n=0;for(let e=0;e<t.length;e++)i+=t[e].x,n+=t[e].y;i/=t.length,n/=t.length;const o=t.map((t=>t.x-i)),s=t.map((t=>t.y-n));let a=0,r=0,h=0,c=0,l=0,d=0,u=0;for(let t=0;t<o.length;t++){const e=o[t],i=s[t],n=e*e,m=i*i;a+=n,r+=m,h+=e*i,c+=n*e,l+=m*i,d+=e*m,u+=i*n}const m=.5*(c+d),_=.5*(l+u),g=a*r-h*h,f=(m*r-_*h)/g,v=(a*_-h*m)/g,P=p(f+i,v+n);return{radius:Math.sqrt(f*f+v*v+(a+r)/t.length),center:P}}(e)}function jt(t){const e=Ht(t);let i=0;return t.forEach((t=>{let n=Rt(t,e),o=n-t.lastAngle;for(;o>Math.PI;)o-=2*Math.PI;for(;o<-Math.PI;)o+=2*Math.PI;n=t.lastAngle+o,t.lastAngle=n;const s=n-t.initialAngle;i+=s})),i/=t.size||1,{angle:i,radius:e.radius,center:e.center}}function Ot(t){const e=new Map;return t.forEach(((t,i)=>e.set(i,t.event))),e}function Rt(t,e){const i=t.event,n=i.x-e.center.x,o=i.y-e.center.y;return Math.atan2(o,n)}var Bt;!function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right",t[t.Back=3]="Back",t[t.Forward=4]="Forward",t[t.Undefined=-1]="Undefined"}(Bt||(Bt={}));class $t extends m{constructor(t=Nt.maximumDoubleClickDelay,e=Nt.maximumDoubleClickDistance,i=Nt.maximumDoubleTouchDelay,n=Nt.maximumDoubleTouchDistance,o=_){super(!1),this._maximumDoubleClickDelay=t,this._maximumDoubleClickDistance=e,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=n,this._clock=o,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach((t=>{t.immediateDoubleClick&&t.immediateDoubleClick.timeoutHandle.remove()})),super.onUninstall()}_handlePointerDown(t){const e=t.data,i=qt(e);if(!this._pointerState.has(i)){const t={downButton:e.native.button,x:e.x,y:e.y,immediateDoubleClick:null};this._pointerState.set(i,t),this.startCapturingPointer(e.native)}}_handlePointerUp(t){const e=t.data,i=qt(e),n=this._pointerState.get(i);if(n&&n.downButton===e.native.button){const i=n.immediateDoubleClick,o="touch"===t.data.native.pointerType?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;i?(i.timeoutHandle.remove(),Ut(i,t.data)>o?this._startImmediateDoubleClick(t,n):(this._immediateDoubleClick.emit(t.data,void 0,i.modifiers),this._removeState(e))):Ut(n,t.data)>o?this._removeState(e):this._startImmediateDoubleClick(t,n)}}_startImmediateDoubleClick(t,e){const i="touch"===t.data.native.pointerType?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay;e.immediateDoubleClick={x:t.data.x,y:t.data.y,modifiers:t.modifiers,timeoutHandle:this._clock.setTimeout((()=>this._removeState(t.data)),i)}}_removeState(t){const e=qt(t);this._pointerState.delete(e),this.stopCapturingPointer(t.native),this.refreshHasPendingInputs()}}class Kt extends m{constructor(t=Nt.maximumClickDelay,e=Nt.movementUntilMouseDrag,i=Nt.movementUntilPenDrag,n=Nt.movementUntilTouchDrag,o=Nt.holdDelay,s=_){super(!1),this._maximumClickDelay=t,this._movementUntilMouseDrag=e,this._movementUntilPenDrag=i,this._movementUntilTouchDrag=n,this._holdDelay=o,this._clock=s,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",(t=>this._handlePointerDown(t))),this.registerIncoming("pointer-up",(t=>this._handlePointerLoss(t,"pointer-up"))),this.registerIncoming("pointer-capture-lost",(t=>this._handlePointerLoss(t,"pointer-capture-lost"))),this.registerIncoming("pointer-cancel",(t=>this._handlePointerLoss(t,"pointer-cancel"))),this._moveHandle=this.registerIncoming("pointer-move",(t=>this._handlePointerMove(t))),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach((t=>{t.holdTimeout=l(t.holdTimeout)})),super.onUninstall()}_handlePointerDown(t){const e=t.data,i=e.native.pointerId;let n=null;0===this._pointerState.size&&(n=this._clock.setTimeout((()=>{const e=this._pointerState.get(i);if(e){if(!e.isDragging){const i=e.previousEvent;this._pointerHold.emit(i,void 0,t.modifiers),e.holdEmitted=!0}e.holdTimeout=null}}),this._holdDelay));const o={startEvent:e,previousEvent:e,startTimestamp:t.timestamp,isDragging:!1,downButton:e.native.button,holdTimeout:n,modifiers:new Set};this._pointerState.set(i,o),this.startCapturingPointer(e.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(t)}_handlePointerMove(t){const e=t.data,i=e.native.pointerId,n=this._pointerState.get(i);n&&(n.isDragging?this._pointerDrag.emit(Yt("update",n,e),void 0,n.modifiers):function(t,e){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}(e,n.startEvent)>this._getDragThreshold(e.native.pointerType)&&this._startDragging(t),n.previousEvent=e)}_getDragThreshold(t){switch(t){case"touch":return this._movementUntilTouchDrag;case"pen":return this._movementUntilPenDrag;default:return this._movementUntilMouseDrag}}_startDragging(t){const e=t.data,i=e.native.pointerId;this._pointerState.forEach((n=>{null!=n.holdTimeout&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging||(n.modifiers=t.modifiers,n.isDragging=!0,i===n.startEvent.native.pointerId?this._pointerDrag.emit(Yt("start",n,e)):this._pointerDrag.emit(Yt("start",n,n.previousEvent),t.timestamp))}))}_handlePointerLoss(t,e){const i=t.data,n=i.native.pointerId,o=this._pointerState.get(n);o&&(null!=o.holdTimeout&&(o.holdTimeout.remove(),o.holdTimeout=null),o.isDragging?this._pointerDrag.emit(Yt("end",o,"pointer-up"===e?i:o.previousEvent),void 0,o.modifiers):"pointer-up"===e&&o.downButton===i.native.button&&t.timestamp-o.startTimestamp<=this._maximumClickDelay&&!o.holdEmitted&&this._immediateClick.emit(i),this._pointerState.delete(n),this.stopCapturingPointer(i.native),0===this._pointerState.size&&this._moveHandle.pause())}}function Yt(t,e,i){return{action:t,startEvent:e.startEvent,previousEvent:e.previousEvent,currentEvent:i}}class Vt extends m{constructor(t=Nt.maximumDoubleClickDelay,e=Nt.maximumDoubleClickDistance,i=Nt.maximumDoubleTouchDelay,n=Nt.maximumDoubleTouchDistance,o=_){super(!1),this._maximumDoubleClickDelay=t,this._maximumDoubleClickDistance=e,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=n,this._clock=o,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",(t=>this._handleImmediateClick(t))),this.registerIncoming("pointer-down",(t=>this._handlePointerDown(t)))}onUninstall(){this._pointerState.forEach((t=>t.doubleClickTimer=l(t.doubleClickTimer)))}get hasPendingInputs(){for(const t of this._pointerState.values())if(null!=t.doubleClickTimer)return!0;return!1}_clearDoubleClickTimer(t,e){const i=this._pointerState.get(t);i&&(i.doubleClickTimer=l(i.doubleClickTimer),e&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(t),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(t){const e=this._pointerState.get(t);1===e.pointerDownCount&&this._click.emit(e.event.data,void 0,e.event.modifiers),e.doubleClickTimer=null,this._pointerState.delete(t),this.refreshHasPendingInputs()}_handleImmediateClick(t){const e=t.data,{pointerType:i}=e.native,n=function(t){const{pointerId:e,pointerType:i,button:n}=t.native;return"mouse"===i?`${e}:${n}`:`${i}`}(e);if(!this._pointerState.has(n))return void this._startClick(t);const o=this._pointerState.get(n),{data:s,modifiers:a}=o.event,r="touch"===i?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;Ut(s,e)>r?(this._clearDoubleClickTimer(n,!0),this._startClick(t)):(this._clearDoubleClickTimer(n,!1),2===o.pointerDownCount&&this._doubleClick.emit(s,void 0,a))}_handlePointerDown(t){const e=qt(t.data),i=this._pointerState.get(e);i&&(i.pointerDownCount+=1)}_startClick(t){const{data:e}=t,{native:{pointerType:i}}=e,n=qt(e),o="touch"===i?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay,s=this._clock.setTimeout((()=>this._doubleClickTimeoutExceeded(n)),o);this._pointerState.set(n,{event:t,doubleClickTimer:s,pointerDownCount:1}),this.refreshHasPendingInputs()}}function Xt(t){const e=f();return e.available?"3d"===t&&e.majorPerformanceCaveat?new g("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist."):e.supportsHighPrecisionFragment?e.supportsVertexShaderSamplers?null:new g("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new g("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new g("webgl:required","WebGL2 is required but not supported.",(new Error).stack)}export{_t as A,Lt as B,vt as D,$ as E,$t as I,Kt as P,Vt as S,xt as a,Nt as b,Gt as c,V as d,gt as e,It as f,qt as g,Xt as h,Dt as i,b as j,F as k,ft as l,Ut as m,bt as n,St as o,wt as r};
