/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../core/Error.js";import{a as t}from"./screenUtils.js";import{m as n}from"./timeUtils.js";import s from"../geometry/SpatialReference.js";import{q as i}from"./quantizationUtils.js";import{d as o,l as r}from"./unitUtils.js";import{isTimeOnlyField as l,l as a,isNumericField as u,numericTypes as f}from"../layers/support/fieldUtils.js";import{c,e as m}from"./heatmapUtils.js";import{i as d}from"./utils3.js";import{p,a as h}from"./utils11.js";import $ from"../geometry/Point.js";let y=null;const g=/^(?<hh>([0-1][0-9])|([2][0-3])):(?<mm>[0-5][0-9])(:(?<ss>[0-5][0-9]))?([.](?<ms>\d+))?$/;function j(e,t,n,s){const l=o(n)?r(n):null,a=l?Math.round((l.valid[1]-l.valid[0])/t.scale[0]):null;return e.map((e=>{const n=new $(e.geometry);return i(t,n,n),e.geometry=l?function(e,t,n){return e.x<0?e.x+=t:e.x>n&&(e.x-=t),e}(n,a??0,s[0]):n,e}))}function x(e,n=18,s,i,o){const r=new Float64Array(i*o);n=Math.round(t(n));let l=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;const u=c(s);for(const{geometry:t,attributes:s}of e){const{x:e,y:f}=t,c=Math.max(0,e-n),d=Math.max(0,f-n),p=Math.min(o,f+n),h=Math.min(i,e+n),$=+u(s);for(let t=d;t<p;t++)for(let s=c;s<h;s++){const o=t*i+s,u=m(s-e,t-f,n)*$,c=r[o]+=u;l=Math.min(l,c),a=Math.max(a,c)}}return{min:l,max:a}}function w(e){const t=g.exec(e);if(!t)return null;const{hh:s,mm:i,ss:o,ms:r}=t.groups;return Number(s)*n.hours+Number(i)*n.minutes+Number(o)*n.seconds+Number(r||0)}async function b(e,t,n=!0){if(!t)return[];const{field:i,field2:o,field3:r,fieldDelimiter:u,fieldInfos:f,timeZone:c}=e,m=i&&f?.find((e=>e.name.toLowerCase()===i.toLowerCase())),$=!!m&&l(m),g=!!m&&d(m),j=e.valueExpression,x=e.normalizationType,b=e.normalizationField,I=e.normalizationTotal,F=[],N=e.viewInfoParams;let v=null,E=null;if(j){if(!y){const{arcadeUtils:e}=await a();y=e}y.hasGeometryOperations(j)&&await y.enableGeometryOperations(),v=y.createFunction(j),E=N?y.getViewInfo({viewingMode:N.viewingMode,scale:N.scale,spatialReference:new s(N.spatialReference)}):null}const U=e.fieldInfos,M=t[0]&&"declaredClass"in t[0]&&"esri.Graphic"===t[0].declaredClass||!U?null:{fields:U};return t.forEach((e=>{const t=e.attributes;let s;if(j){const t=M?{...e,layer:M}:e,n=y.createExecContext(t,E,c);s=y.executeFunction(v,n)}else t&&(s=t[i],o?(s=`${p(s)}${u}${p(t[o])}`,r&&(s=`${s}${u}${p(t[r])}`)):"string"==typeof s&&n&&(g?s=s?new Date(s).getTime():null:$&&(s=s?w(s):null)));if(x&&"number"==typeof s&&isFinite(s)){const e=t&&parseFloat(t[b]);s=h(s,x,e,I)}F.push(s)})),F}function I(e){const t=e.field,n=e.normalizationType,s=e.normalizationField;let i;return"field"===n?i="(NOT "+s+" = 0)":"log"!==n&&"natural-log"!==n&&"square-root"!==n||(i=`(${t} > 0)`),i}function F(e,t,n){const s=null!=t?e+" >= "+t:"",i=null!=n?e+" <= "+n:"";let o="";return o=s&&i?E(s,i):s||i,o?"("+o+")":""}function N(t,n,s,i){let o;return n?n.name!==t.objectIdField&&i.includes(n.type)||(o=new e(s,"'field' should be one of these types: "+i.join(","))):o=new e(s,"'field' is not defined in the layer schema"),o}function v(t,n,s){let i;return n?n.name!==t.objectIdField&&u(n)||(i=new e(s,"'field' should be one of these numeric types: "+f.join(","))):i=new e(s,"'field' is not defined in the layer schema"),i}function E(e,t){let n=null!=e?e:"";return null!=t&&t&&(n=n?"("+n+") AND ("+t+")":t),n}function U(t,n){if(t&&"intersects"!==t.spatialRelationship)return new e(n,"Only 'intersects' spatialRelationship is supported for featureFilter")}function M(t,n,s){const i=function(e){const t=e.layer;return e.fields.filter((e=>!t.getField(e)))}({layer:t,fields:n});if(i.length)return new e(s,"Unknown fields: "+i.join(", ")+". You can only use fields defined in the layer schema");const o=function(e){const t=e.layer;return e.fields.filter((e=>{const n=t.getFieldUsageInfo(e);return!n||!n.supportsStatistics}))}({layer:t,fields:n});return o.length?new e(s,"Unsupported fields: "+o.join(", ")+". You can only use fields that can be fetched i.e. AdapterFieldUsageInfo.supportsStatistics must be true"):void 0}function T(e,t,n){const s=[],i=[],o=[],r=[],l=[];e.forEach(((e,t)=>{const a=e.field?"field":"expression",u=e.field||e.valueExpression;e.field?(l.push(u),i.push(`var ${a}${t} = Number($feature["${u}"]);`)):(s.push(`function getValueForExpr${t}() {\n  ${u} \n}`),i.push(`var ${a}${t} = Number(getValueForExpr${t}());`)),n||o.push(`${a}${t} = IIf(${a}${t} < 0, 0, ${a}${t});`),r.push(`${a}${t}`)}));const a=s.length?null:l.reduce(((e,t)=>`${e} + ${t}`));let u=null;return t||n?t?n||a&&(u=`(( ${a} ) >= 0)`):a&&(u=`(( ${a} ) <> 0)`):a&&(u=`(( ${a} ) > 0)`),{valueExpression:[s.length?s.join("\n"):"",i.join("\n"),o.join("\n"),`var total = ${r.join(" + ")};`,"return total;"].filter(Boolean).join("\n\n"),sqlExpression:a,sqlWhere:u}}export{I as a,b,x as c,v as d,U as e,N as f,F as g,T as h,E as m,j as q,w as t,M as v};
