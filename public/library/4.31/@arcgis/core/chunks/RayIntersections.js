/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{V as t}from"./VertexAttribute.js";import{o as e,p as n}from"./mat4.js";import{o,c as s,B as i,a as f,D as r,b as c}from"./BufferView.js";import{a}from"./Util.js";import{j as l,f as u,i as d,c as p,n as h}from"./vec3.js";import{c as y}from"./vec3f64.js";import{c as b,y as g,z as m}from"./aaBoundingBox.js";import{C as M}from"./Material.js";function B(t,e,n,o=1){const{data:s,indices:i}=t,f=e.typedBuffer,r=e.typedBufferStride,c=i.length;if(n*=r,1===o)for(let t=0;t<c;++t)f[n]=s[i[t]],n+=r;else for(let t=0;t<c;++t){const e=s[i[t]];for(let t=0;t<o;t++)f[n]=e,n+=r}}function O(t,e,n){const{data:o,indices:s}=t,i=e.typedBuffer,f=e.typedBufferStride,r=s.length;n*=f;for(let t=0;t<r;++t){const e=2*s[t];i[n]=o[e],i[n+1]=o[e+1],n+=f}}function R(t,e,n,o){const{data:s,indices:i}=t,f=e.typedBuffer,r=e.typedBufferStride,c=i.length;if(n*=r,null==o||1===o)for(let t=0;t<c;++t){const e=3*i[t];f[n]=s[e],f[n+1]=s[e+1],f[n+2]=s[e+2],n+=r}else for(let t=0;t<c;++t){const e=3*i[t];for(let t=0;t<o;++t)f[n]=s[e],f[n+1]=s[e+1],f[n+2]=s[e+2],n+=r}}function T(t,e,n,o=1){const{data:s,indices:i}=t,f=e.typedBuffer,r=e.typedBufferStride,c=i.length;if(n*=r,1===o)for(let t=0;t<c;++t){const e=4*i[t];f[n]=s[e],f[n+1]=s[e+1],f[n+2]=s[e+2],f[n+3]=s[e+3],n+=r}else for(let t=0;t<c;++t){const e=4*i[t];for(let t=0;t<o;++t)f[n]=s[e],f[n+1]=s[e+1],f[n+2]=s[e+2],f[n+3]=s[e+3],n+=r}}function v(t,e,n){const o=t.typedBuffer,s=t.typedBufferStride;e*=s;for(let t=0;t<n;++t)o[e]=0,o[e+1]=0,o[e+2]=0,o[e+3]=0,e+=s}function N(t,n,o,s,i=1){if(!n)return void R(t,o,s,i);const{data:f,indices:r}=t,c=o.typedBuffer,a=o.typedBufferStride,l=r.length,u=n[0],d=n[1],p=n[2],h=n[4],y=n[5],b=n[6],g=n[8],m=n[9],M=n[10],B=n[12],O=n[13],T=n[14];s*=a;let v=0,N=0,S=0;const x=e(n)?t=>{v=f[t]+B,N=f[t+1]+O,S=f[t+2]+T}:t=>{const e=f[t],n=f[t+1],o=f[t+2];v=u*e+h*n+g*o+B,N=d*e+y*n+m*o+O,S=p*e+b*n+M*o+T};if(1===i)for(let t=0;t<l;++t)x(3*r[t]),c[s]=v,c[s+1]=N,c[s+2]=S,s+=a;else for(let t=0;t<l;++t){x(3*r[t]);for(let t=0;t<i;++t)c[s]=v,c[s+1]=N,c[s+2]=S,s+=a}}function S(t,o,s,i,f=1){if(!o)return void R(t,s,i,f);const{data:r,indices:c}=t,a=o,l=s.typedBuffer,u=s.typedBufferStride,d=c.length,p=a[0],h=a[1],y=a[2],b=a[4],g=a[5],m=a[6],M=a[8],B=a[9],O=a[10],T=!n(a),v=1e-6,N=.999999;i*=u;let S=0,x=0,I=0;const E=e(a)?t=>{S=r[t],x=r[t+1],I=r[t+2]}:t=>{const e=r[t],n=r[t+1],o=r[t+2];S=p*e+b*n+M*o,x=h*e+g*n+B*o,I=y*e+m*n+O*o};if(1===f)if(T)for(let t=0;t<d;++t){E(3*c[t]);const e=S*S+x*x+I*I;if(e<N&&e>v){const t=1/Math.sqrt(e);l[i]=S*t,l[i+1]=x*t,l[i+2]=I*t}else l[i]=S,l[i+1]=x,l[i+2]=I;i+=u}else for(let t=0;t<d;++t)E(3*c[t]),l[i]=S,l[i+1]=x,l[i+2]=I,i+=u;else for(let t=0;t<d;++t){if(E(3*c[t]),T){const t=S*S+x*x+I*I;if(t<N&&t>v){const e=1/Math.sqrt(t);S*=e,x*=e,I*=e}}for(let t=0;t<f;++t)l[i]=S,l[i+1]=x,l[i+2]=I,i+=u}}function x(t,e,n,o,s=1){const{data:i,indices:f}=t,r=n.typedBuffer,c=n.typedBufferStride,a=f.length;if(o*=c,e!==i.length||4!==e)if(1!==s)if(4!==e)for(let t=0;t<a;++t){const e=3*f[t];for(let t=0;t<s;++t)r[o]=i[e],r[o+1]=i[e+1],r[o+2]=i[e+2],r[o+3]=255,o+=c}else for(let t=0;t<a;++t){const e=4*f[t];for(let t=0;t<s;++t)r[o]=i[e],r[o+1]=i[e+1],r[o+2]=i[e+2],r[o+3]=i[e+3],o+=c}else{if(4===e){for(let t=0;t<a;++t){const e=4*f[t];r[o]=i[e],r[o+1]=i[e+1],r[o+2]=i[e+2],r[o+3]=i[e+3],o+=c}return}for(let t=0;t<a;++t){const e=3*f[t];r[o]=i[e],r[o+1]=i[e+1],r[o+2]=i[e+2],r[o+3]=255,o+=c}}else{r[o]=i[0],r[o+1]=i[1],r[o+2]=i[2],r[o+3]=i[3];const t=new Uint32Array(n.typedBuffer.buffer,n.start),e=c/4,f=t[o/=4];o+=e;const l=a*s;for(let n=1;n<l;++n)t[o]=f,o+=e}}function I(t,e,n,o,s=1){const i=e.typedBuffer,f=e.typedBufferStride;if(o*=f,1===s)for(let e=0;e<n;++e)i[o]=t[0],i[o+1]=t[1],i[o+2]=t[2],i[o+3]=t[3],o+=f;else for(let e=0;e<n;++e)for(let e=0;e<s;++e)i[o]=t[0],i[o+1]=t[1],i[o+2]=t[2],i[o+3]=t[3],o+=f}function E(e,n,s,i,f,r,c){for(const a of s.fields.keys()){const s=e.get(a),l=s?.indices;if(s&&l)L(a,s,i,f,r,c);else if(a===t.OBJECTANDLAYERIDCOLOR&&null!=n){const s=e.get(t.POSITION)?.indices;if(s){const t=s.length;I(n,r.getField(a,o),t,c)}}}}function L(e,l,u,d,p,h){switch(e){case t.POSITION:{a(3===l.size);const t=p.getField(e,c);a(!!t,`No buffer view for ${e}`),t&&N(l,u,t,h);break}case t.NORMAL:{a(3===l.size);const t=p.getField(e,c);a(!!t,`No buffer view for ${e}`),t&&S(l,d,t,h);break}case t.NORMALCOMPRESSED:{a(2===l.size);const t=p.getField(e,r);a(!!t,`No buffer view for ${e}`),t&&O(l,t,h);break}case t.UV0:{a(2===l.size);const t=p.getField(e,f);a(!!t,`No buffer view for ${e}`),t&&O(l,t,h);break}case t.COLOR:case t.SYMBOLCOLOR:{const t=p.getField(e,o);a(!!t,`No buffer view for ${e}`),a(3===l.size||4===l.size),!t||3!==l.size&&4!==l.size||x(l,l.size,t,h);break}case t.COLORFEATUREATTRIBUTE:{const t=p.getField(e,i);a(!!t,`No buffer view for ${e}`),a(1===l.size),t&&1===l.size&&function(t,e,n){const{data:o,indices:s}=t,i=e.typedBuffer,f=e.typedBufferStride,r=s.length,c=o[0];n*=f;for(let t=0;t<r;++t)i[n]=c,n+=f}(l,t,h);break}case t.TANGENT:{a(4===l.size);const t=p.getField(e,s);a(!!t,`No buffer view for ${e}`),t&&function(t,e,o,s,i=1){if(!e)return void T(t,o,s,i);const{data:f,indices:r}=t,c=e,a=o.typedBuffer,l=o.typedBufferStride,u=r.length,d=c[0],p=c[1],h=c[2],y=c[4],b=c[5],g=c[6],m=c[8],M=c[9],B=c[10],O=!n(c),R=1e-6,v=.999999;if(s*=l,1===i)for(let t=0;t<u;++t){const e=4*r[t],n=f[e],o=f[e+1],i=f[e+2],c=f[e+3];let u=d*n+y*o+m*i,T=p*n+b*o+M*i,N=h*n+g*o+B*i;if(O){const t=u*u+T*T+N*N;if(t<v&&t>R){const e=1/Math.sqrt(t);u*=e,T*=e,N*=e}}a[s]=u,a[s+1]=T,a[s+2]=N,a[s+3]=c,s+=l}else for(let t=0;t<u;++t){const e=4*r[t],n=f[e],o=f[e+1],c=f[e+2],u=f[e+3];let T=d*n+y*o+m*c,N=p*n+b*o+M*c,S=h*n+g*o+B*c;if(O){const t=T*T+N*N+S*S;if(t<v&&t>R){const e=1/Math.sqrt(t);T*=e,N*=e,S*=e}}for(let t=0;t<i;++t)a[s]=T,a[s+1]=N,a[s+2]=S,a[s+3]=u,s+=l}}(l,u,t,h);break}case t.PROFILERIGHT:case t.PROFILEUP:case t.PROFILEVERTEXANDNORMAL:case t.FEATUREVALUE:{a(4===l.size);const t=p.getField(e,s);a(!!t,`No buffer view for ${e}`),t&&T(l,t,h)}}}class w{constructor(t){this.vertexBufferLayout=t}elementCount(e){return e.get(t.POSITION).indices.length}write(t,e,n,o,s,i){E(n,o,this.vertexBufferLayout,t,e,s,i)}}class z{constructor(t=!1,e=!0){this.isVerticalRay=t,this.normalRequired=e}}const A=b();function F(e,n,o,s,i,f){if(!e.visible)return;const r=l(tt,s,o),c=(t,e,n)=>{f(t,n,e,!1)},u=new z(!1,n.options.normalRequired);if(e.boundingInfo){a(e.type===M.Mesh);const t=n.tolerance;q(e.boundingInfo,o,r,t,i,u,c)}else{const n=e.attributes.get(t.POSITION),s=n.indices;U(o,r,0,s.length/3,s,n.data,n.stride,i,u,c)}}const V=y();function q(t,e,n,o,s,i,f){if(null==t)return;const r=u(V,1/(c=n)[0],1/c[1],1/c[2]);var c;if(g(A,t.bbMin),m(A,t.bbMax),null!=s&&s.applyToAabb(A),Q(A,e,r,o)){const{primitiveIndices:r,position:c}=t,a=r?r.length:c.indices.length/3;if(a>Z){const r=t.getChildren();if(void 0!==r){for(const t of r)q(t,e,n,o,s,i,f);return}}!function(t,e,n,o,s,i,f,r,c,a,l){const u=t[0],d=t[1],p=t[2],h=e[0],y=e[1],b=e[2],{normalRequired:g}=a;for(let t=0;t<o;++t){const e=r[t],n=3*e,o=f*s[n];let a=i[o],m=i[o+1],M=i[o+2];const B=f*s[n+1];let O=i[B],R=i[B+1],T=i[B+2];const v=f*s[n+2];let N=i[v],S=i[v+1],x=i[v+2];null!=c&&([a,m,M]=c.applyToVertex(a,m,M,t),[O,R,T]=c.applyToVertex(O,R,T,t),[N,S,x]=c.applyToVertex(N,S,x,t));const I=O-a,E=R-m,L=T-M,w=N-a,z=S-m,A=x-M,F=y*A-z*b,V=b*w-A*h,q=h*z-w*y,k=I*F+E*V+L*q;if(Math.abs(k)<=_)continue;const C=u-a,P=d-m,U=p-M,$=C*F+P*V+U*q;if(k>0){if($<0||$>k)continue}else if($>0||$<k)continue;const D=P*L-E*U,G=U*I-L*C,H=C*E-I*P,J=h*D+y*G+b*H;if(k>0){if(J<0||$+J>k)continue}else if(J>0||$+J<k)continue;const X=(w*D+z*G+A*H)/k;X>=0&&l(X,e,g?Y(I,E,L,w,z,A,j):null)}}(e,n,0,a,c.indices,c.data,c.stride,r,s,i,f)}}const j=y();function k(t,e,n,o,s,i,f,r,c){const{data:a,stride:u}=i;U(t,l(tt,e,t),n,o,s,a,u,f,r,c)}function C(t,e,n,o,s,i,f,r,c,a=null,l=0){const u=t[0],d=t[1],p=t[2],h=e[0],y=e[1],b=e[2];for(let t=n;t<o;++t){const e=l+(a?a[t]:t),n=3*e,o=f*s[n],g=i[o],m=i[o+1],M=i[o+2],B=f*s[n+1],O=i[B],R=i[B+1],T=i[B+2],v=f*s[n+2],N=O-g,S=R-m,x=T-M,I=i[v]-g,E=i[v+1]-m,L=i[v+2]-M,w=y*L-E*b,z=b*I-L*h,A=h*E-I*y,F=N*w+S*z+x*A;if(Math.abs(F)<=_)continue;const V=u-g,q=d-m,k=p-M,C=V*w+q*z+k*A;if(F>0){if(C<0||C>F)continue}else if(C>0||C<F)continue;const P=q*x-S*k,U=k*N-x*V,$=V*S-N*q,D=h*P+y*U+b*$;if(F>0){if(D<0||C+D>F)continue}else if(D>0||C+D<F)continue;const G=(I*P+E*U+L*$)/F;G>=0&&c(G,e,r?Y(N,S,x,I,E,L,j):null)}}function P(t,e,n,o,s,i,f,r,c,a,l,u=null,d=0){const p=t[0],h=t[1],y=t[2],b=e[0],g=e[1],m=e[2];for(let t=n;t<o;++t){const e=d+(u?u[t]:t),n=3*e,o=f*s[n],M=i[o],B=i[o+1],O=i[o+2],R=f*s[n+1],T=i[R],v=i[R+1],N=i[R+2],S=f*s[n+2],x=i[S],I=i[S+1],E=i[S+2],L=O-c,w=r/Math.sqrt(M*M+B*B+L*L),z=M+M*w,A=B+B*w,F=O+L*w,V=N-c,q=r/Math.sqrt(T*T+v*v+V*V),k=T+T*q,C=v+v*q,P=N+V*q,U=E-c,$=r/Math.sqrt(x*x+I*I+U*U),D=k-z,G=C-A,H=P-F,J=x+x*$-z,X=I+I*$-A,K=E+U*$-F,Q=g*K-X*m,W=m*J-K*b,Z=b*X-J*g,tt=D*Q+G*W+H*Z;if(Math.abs(tt)<=_)continue;const et=p-z,nt=h-A,ot=y-F,st=et*Q+nt*W+ot*Z;if(tt>0){if(st<0||st>tt)continue}else if(st>0||st<tt)continue;const it=nt*H-G*ot,ft=ot*D-H*et,rt=et*G-D*nt,ct=b*it+g*ft+m*rt;if(tt>0){if(ct<0||st+ct>tt)continue}else if(ct>0||st+ct<tt)continue;const at=(J*it+X*ft+K*rt)/tt;at>=0&&l(at,e,a?Y(D,G,H,J,X,K,j):null)}}function U(t,e,n,o,s,i,f,r,c,a){const p=e,h=et,y=Math.abs(p[0]),b=Math.abs(p[1]),g=Math.abs(p[2]),m=y>=b?y>=g?0:2:b>=g?1:2,M=m,B=p[M]<0?2:1,O=(m+B)%3,R=(m+(3-B))%3,T=p[O]/p[M],v=p[R]/p[M],N=1/p[M],S=$,x=D,I=G,{normalRequired:E}=c;for(let e=n;e<o;++e){const n=3*e,o=f*s[n];u(h[0],i[o+0],i[o+1],i[o+2]);const c=f*s[n+1];u(h[1],i[c+0],i[c+1],i[c+2]);const p=f*s[n+2];u(h[2],i[p+0],i[p+1],i[p+2]),r&&(d(h[0],r.applyToVertex(h[0][0],h[0][1],h[0][2],e)),d(h[1],r.applyToVertex(h[1][0],h[1][1],h[1][2],e)),d(h[2],r.applyToVertex(h[2][0],h[2][1],h[2][2],e))),l(S,h[0],t),l(x,h[1],t),l(I,h[2],t);const y=S[O]-T*S[M],b=S[R]-v*S[M],g=x[O]-T*x[M],m=x[R]-v*x[M],B=I[O]-T*I[M],L=I[R]-v*I[M],w=B*m-L*g,z=y*L-b*B,A=g*b-m*y;if((w<0||z<0||A<0)&&(w>0||z>0||A>0))continue;const F=w+z+A;if(0===F)continue;const V=w*(N*S[M])+z*(N*x[M])+A*(N*I[M]);if(V*Math.sign(F)<0)continue;const q=V/F;q>=0&&a(q,e,E?H(h):null)}}const $=y(),D=y(),G=y();function Y(t,e,n,o,s,i,f){return u(J,t,e,n),u(X,o,s,i),p(f,J,X),h(f,f),f}function H(t){return l(J,t[1],t[0]),l(X,t[2],t[0]),p(j,J,X),h(j,j),j}const J=y(),X=y();function K(t,e,n){return u(n,1/(e[0]-t[0]),1/(e[1]-t[1]),1/(e[2]-t[2]))}function Q(t,e,n,o){return W(t,e,n,o,1/0)}function W(t,e,n,o,s){const i=(t[0]-o-e[0])*n[0],f=(t[3]+o-e[0])*n[0];let r=Math.min(i,f),c=Math.max(i,f);const a=(t[1]-o-e[1])*n[1],l=(t[4]+o-e[1])*n[1];if(c=Math.min(c,Math.max(a,l)),c<0)return!1;if(r=Math.max(r,Math.min(a,l)),r>c)return!1;const u=(t[2]-o-e[2])*n[2],d=(t[5]+o-e[2])*n[2];return c=Math.min(c,Math.max(u,d)),!(c<0)&&(r=Math.max(r,Math.min(u,d)),!(r>c)&&r<s)}const Z=1e3,_=1e-7,tt=y(),et=[y(),y(),y()];export{w as D,z as M,L as a,N as b,S as c,x as d,T as e,v as f,I as g,E as h,F as i,k as j,Q as k,W as l,C as m,P as n,K as o,B as w};
