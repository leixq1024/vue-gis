/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../Camera.js";import{C as t,b as n}from"./Cyclical.js";import{L as r}from"./Logger.js";import{r as i,a as o,d as a,b as s,l as c,c as l}from"./mathUtils.js";import{throwIfAborted as u}from"../core/promiseUtils.js";import{i as f,r as m,s as p,a as d,g as h,d as T,h as R,p as g,n as _,c as y,m as M,k as E,f as A,y as I,o as O,l as v,B as S,I as w}from"./vec3.js";import{c as F,f as N,Z as x,a as b}from"./vec3f64.js";import{t as j}from"./unitUtils.js";import P from"../geometry/Point.js";import{projectWithZConversion as C,project as L}from"../geometry/projection.js";import H from"../geometry/SpatialReference.js";import{p as D,a as U}from"./projectPointToVector.js";import{p as G,a as z}from"./projectVectorToPoint.js";import{p as B}from"./projectVectorToVector.js";import{V as k}from"./ViewingMode.js";import{s as q}from"./aaBoundingRect.js";import{n as J}from"./Intersector3.js";import"../geometry.js";import{B as W,d as X,f as V,C as K}from"./mat4.js";import{c as Y}from"./mat4f64.js";import{a as Z,c as Q,f as $}from"./vec2f64.js";import ee from"../geometry/Extent.js";import{i as te}from"./coordsUtils.js";import{P as ne,h as re,l as ie,k as oe,m as ae,i as se,n as ce,o as le,d as ue,p as fe,e as me}from"./frustum.js";import{v as pe}from"./vec2.js";import{w as de}from"./ray.js";import{w as he,c as Te,f as Re}from"./lineSegment.js";import{e as ge,o as _e,c as ye,j as Me,F as Ee,I as Ae,G as Ie,g as Oe}from"./plane.js";import ve from"../geometry/Polygon.js";import{s as Se,g as we}from"./vec4.js";import{c as Fe}from"./vec4f64.js";import{g as Ne}from"./common.js";import{l as xe,m as be,b as je}from"./sphere.js";import{geographicToWebMercator as Pe}from"../geometry/support/webMercatorUtils.js";import{g as Ce,a as Le}from"./earthUtils.js";import{a as He}from"./mathUtils2.js";import{g as De}from"./ElevationProvider.js";import{i as Ue}from"./spatialReferenceSupport.js";function Ge(e,t,n,r){return null!=e.renderCoordsHelper.fromRenderCoords(t.eye,Je,r)&&q(n,Je)}function ze(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function Be(e,t,n,r){const i=e.state.camera.clone();t&&n&&r&&(i.eye=t,i.center=n,i.up=r),function(e,t,n){let r=qe[e.viewingMode];r||(r=J(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,qe[e.viewingMode]=r);const{isGlobal:i}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,n)||ke(e,t.origin,n))||!(!e.renderCoordsHelper.intersectManifold(t,0,n)||ke(e,t.origin,n))||!!i&&function(e,t,n){const r=T(e.origin,e.origin)-n*n,i=r>0?Math.sqrt(r)/3:1;return p(t,e.direction,i/R(e.direction)),h(t,t,e.origin),!0}(t,n,j(e.spatialReference).radius)}(e,i.ray,We)||f(We,i.center);const o=e.state.constraints,a=o.minimumPoiDistance;if(m(i.eye,We)<a){const t=o.collision.enabled;f(Xe,i.viewForward),p(Xe,Xe,a),t?i.eye=d(Je,We,Xe):h(We,i.eye,Xe);const n=e.renderCoordsHelper,r=n.getAltitude(i.eye),s=o.collision.elevationMargin;t&&r<s&&(d(Xe,We,i.eye),i.eye=n.setAltitude(Je,s,i.eye),h(We,i.eye,Xe))}return i.center=We,i}function ke(e,t,n){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const r=ze(e,t),i=e.stateManager.constraintsManager.nearFarHeuristic,{far:o}=i.compute(t,n,e.renderDataExtent,r,Ve),a=o*o;return m(t,n)>a}const qe={},Je=F(),We=F(),Xe=F(),Ve={near:0,far:0};function Ke(e,t,n,r){const i=function(e,t){const n=t===$e.LEFT||t===$e.RIGHT?0:1,r=e[t],i=t===$e.LEFT||t===$e.BOTTOM?Ze.MIN:Ze.MAX,o=0===n?1:0;return(e,t,a)=>{if(t[n]<r&&a[n]<r)return i===Ze.MIN?Qe.OUTSIDE:Qe.INSIDE;if(t[n]>r&&a[n]>r)return i===Ze.MIN?Qe.INSIDE:Qe.OUTSIDE;const s=(a[o]-t[o])/(a[n]-t[n]),c=t[o]+s*(r-t[n]);return e[n]=r,e[o]=c,(t[n]<r?1:-1)*i>0?Qe.OUTSIDE_IN:Qe.INSIDE_OUT}}(n,r);if(e.length=0,t.length){i(et,t[0],t[0])===Qe.INSIDE&&Ye(e,t[0]);for(let n=0;n<t.length;n++){const r=t[n===t.length-1?0:n+1];switch(i(et,t[n],r)){case Qe.INSIDE:Ye(e,r);break;case Qe.INSIDE_OUT:Ye(e,Z(et));break;case Qe.OUTSIDE_IN:Ye(e,Z(et)),Ye(e,r);case Qe.OUTSIDE:}}}}function Ye(e,t){0!==e.length&&pe(e.at(-1),t)||e.push(t)}var Ze,Qe,$e;!function(e){e[e.MIN=1]="MIN",e[e.MAX=-1]="MAX"}(Ze||(Ze={})),function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INSIDE=1]="INSIDE",e[e.OUTSIDE_IN=2]="OUTSIDE_IN",e[e.INSIDE_OUT=3]="INSIDE_OUT"}(Qe||(Qe={})),function(e){e[e.LEFT=0]="LEFT",e[e.BOTTOM=1]="BOTTOM",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP"}($e||($e={}));const et=Q();class tt{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=re(),this._points=ie(),this.lines=new Array(12),this._origin=F(),this._direction=F(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:F(),endpoint:null}}update(e){oe(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),f(this._origin,e.eye),f(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)f(this._points[t],e[t]);ae(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return se(this.frustum,e)}intersectsRay(e){return ce(this.frustum,e)}intersectsLineSegment(e,t){return le(this.frustum,e,t)}intersectsPoint(e){return ue(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const n=t+4;rt(this.lines[t],e[t],e[n]),rt(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),rt(this.lines[t+8],e[n],3===t?e[4]:e[n+1])}}}var nt;function rt(e,t,n){e.origin=t,e.endpoint=n,g(e.direction,t,n)}tt.planePointIndices=fe,tt.nearFarLineIndices=[[ne.NEAR_BOTTOM_LEFT,ne.FAR_BOTTOM_LEFT],[ne.NEAR_BOTTOM_RIGHT,ne.FAR_BOTTOM_RIGHT],[ne.NEAR_TOP_RIGHT,ne.FAR_TOP_RIGHT],[ne.NEAR_TOP_LEFT,ne.FAR_TOP_LEFT]],function(e){e[e.NEAR_FAR_BOTTOM_LEFT=0]="NEAR_FAR_BOTTOM_LEFT",e[e.NEAR_FAR_BOTTOM_RIGHT=1]="NEAR_FAR_BOTTOM_RIGHT",e[e.NEAR_FAR_TOP_RIGHT=2]="NEAR_FAR_TOP_RIGHT",e[e.NEAR_FAR_TOP_LEFT=3]="NEAR_FAR_TOP_LEFT",e[e.NEAR_BOTTOM=4]="NEAR_BOTTOM",e[e.NEAR_RIGHT=5]="NEAR_RIGHT",e[e.NEAR_TOP=6]="NEAR_TOP",e[e.NEAR_LEFT=7]="NEAR_LEFT",e[e.FAR_BOTTOM=8]="FAR_BOTTOM",e[e.FAR_RIGHT=9]="FAR_RIGHT",e[e.FAR_TOP=10]="FAR_TOP",e[e.FAR_LEFT=11]="FAR_LEFT"}(nt||(nt={}));const it=F(),ot=F();function at(){return{direction:F(),up:F()}}function st(e,t,n,r,a){let s=_(it,e),c=T(s,r);const l=c>0;c=Math.abs(c),c>.99&&(c=Math.abs(T(t,r)),c<.99?(f(s,t),l&&p(s,s,-1)):s=null);let u=0;if(s){p(ot,r,T(r,s)),d(s,s,ot);const e=T(s,a)/(R(s)*R(a));y(ot,s,a),u=(T(ot,r)>0?1:-1)*i(o(e))}const m=i(o(-T(r,e)/R(e)));return n?(n.heading=u,n.tilt=m,n):{heading:u,tilt:m}}function ct(e,t,n,r){d(lt,n,t),ge(r,he(t,lt),e)||e===n||f(e,n)}const lt=F(),ut=N(0,1,0),ft=N(0,0,1),mt=Y(),pt=F(),dt=F();function ht(e,t,n,r=at()){const{direction:i,up:o}=r;return W(mt,-a(t)),X(mt,mt,a(n)),M(i,ft,mt),p(i,i,-1),M(o,ut,mt),r}function Tt(e,t,n,r,i){const o=t.lines[nt.FAR_LEFT].direction,a=(i-n.getAltitude(r))/o[2];E(e,r,o,a)}const Rt=F(),gt=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){return st(t,n,r,ft,ut)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i=ht(0,n,r),o=F();return p(o,i.direction,-t),h(o,o,e),{up:i.up,eye:o,heading:n,tilt:r}},eyeTiltToLookAtTilt:function(e){return a(e)},headingTiltToDirectionUp:ht,lookAtTiltToEyeTilt:function(e){return i(e)},toArea:function(e,t){const n=e.frustum,{renderCoordsHelper:r}=e,i=r.getAltitude(t),o=e.spatialReference,a=e.state.camera.eye,s=[],c=n.planes[me.FAR];for(let e=0;e<4;e++){const t=n.lines[e];r.intersectInfiniteManifold(de(t.origin,t.direction),i,Rt)||Tt(Rt,n,r,t.endpoint,i),ct(Rt,a,Rt,c),s.push($(Rt[0],Rt[1]))}return function(e,t,n){const r=e.map((e=>(A(Rt,e[0],e[1],0),t.fromRenderCoords(Rt,Rt,n),[Rt[0],Rt[1]])));return r.length<=2?new ve({spatialReference:n}):(r.push(r[0].slice()),te(r)||r.reverse(),new ve({rings:[r],spatialReference:n}))}(function(e,t){const n=[],r=[];return Ke(n,e,t,$e.LEFT),Ke(r,n,t,$e.BOTTOM),Ke(n,r,t,$e.RIGHT),Ke(r,n,t,$e.TOP),r}(s,r.extent),r,o)},toExtent:function(e,t,n,r,i){const o=e.renderSpatialReference,a=e.spatialReference??t.spatialReference;return D(t,pt,o),D(t,dt,o),pt[0]-=n/2,dt[0]+=n/2,pt[1]-=r/2,dt[1]+=r/2,B(pt,o,pt,a),B(dt,o,dt,a),i?(i.xmin=pt[0],i.ymin=pt[1],i.xmax=dt[0],i.ymax=dt[1],i.spatialReference=a):i=new ee(pt[0],pt[1],dt[0],dt[1],a),i}},Symbol.toStringTag,{value:"Module"}));function _t(e,t,n){e.worldUpAtPosition(t,yt),d(Mt,n,t);const r=R(Mt);return 0===r?0:o(T(Mt,yt)/r)}const yt=F(),Mt=F(),Et=N(0,0,1),At=_(F(),N(1,1,1)),It=new t(-180,180),Ot=Y(),vt=F(),St=F();function wt(e,t,n,r=at()){y(vt,e,Et),0===T(vt,vt)&&y(vt,e,At),V(Ot,-a(t),e),K(Ot,Ot,-a(n),vt);const{up:i,direction:o}=r;return y(i,vt,e),_(i,i),M(i,i,Ot),_(o,e),I(o,o),M(o,o,Ot),r}function Ft(e){const t=e[1];e[1]=-e[2],e[2]=t}function Nt(e,t){const n=wt(t,e.heading,e.tilt);return e.up=n.up,e}function xt(e,t){const n=[],r=[],i=Ne();for(let o=0;o<e.length;o++){const a=e[o],s=o===e.length-1?e[0]:e[o+1],c=Re(a,s,Ut),l=Ee(t,c.origin,c.vector,Ae.NONE,Ht);switch(l){case Ie.INSIDE:n.push(a);break;case Ie.OUTSIDE:r.push(a);break;case Ie.INTERSECTS_INSIDE_OUT:case Ie.INTERSECTS_OUTSIDE_IN:{const[e,o,s]=l===Ie.INTERSECTS_INSIDE_OUT?[1,n,r]:[-1,r,n],c=Oe(t),u=E(F(),Ht,c,e*i),f=E(F(),Ht,c,e*-i);o.push(a),o.push(u),s.push(f)}}}const o=[];return n.length&&o.push(n),r.length&&o.push(r),o}const bt={minCurvature:a(5),maxCurvature:a(50),minSamples:1,maxSamples:6},jt=N(1,0,0),Pt=N(0,1,0),Ct=F(),Lt=F(),Ht=F(),Dt=je(),Ut=Te(),Gt=Fe(),zt=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){const i=vt,o=St;return _(i,e),y(St,i,Et),0===T(St,St)&&y(St,i,At),y(o,St,i),st(t,n,r,i,o)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i={eye:F(),up:null,tilt:r,heading:n},o=vt;o[0]=e[0],o[1]=e[2],o[2]=-e[1];const c=t,l=a(n),u=a(r),f=Math.sin(l),m=Math.cos(l),d=Math.sin(u),h=Math.cos(u),T=R(o);let g;if(Math.abs(u)<1e-8)g=c+T;else{const e=T/d,t=s(c/e),n=Math.PI-u-t;g=e*Math.sin(n)}const _=h*c,y=c*c*(d*d),M=m*m*y,E=g-_,A=E*E,I=M*(M+A-o[1]*o[1]);if(I<0)return p(i.eye,o,g/T),i.tilt=0,Nt(i,e);const O=Math.sqrt(I),v=o[1]*E,S=M+A;let w;if(w=m>0?-O+v:O+v,Math.abs(S)<1e-8)return T<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=c):p(i.eye,o,g/T),i.tilt=0,Ft(i.eye),Nt(i,e);i.eye[1]=w/S;const N=f*f*y,x=d*c,b=m*x*i.eye[1],j=i.eye[1]*i.eye[1],P=1-j,C=Math.sqrt(P),L=M*j+N-2*b*C*E+P*A;return Math.abs(L)<1e-8?(p(i.eye,o,g/T),i.tilt=0,Ft(i.eye),Nt(i,e)):(i.eye[0]=(P*(g*o[0]-_*o[0])-x*C*(o[0]*i.eye[1]*m+o[2]*f))/L,i.eye[2]=(P*(g*o[2]-_*o[2])-x*C*(o[2]*i.eye[1]*m-o[0]*f))/L,p(i.eye,i.eye,g),Ft(i.eye),Nt(i,e))},eyeTiltToLookAtTilt:function(e,t,n){const r=a(e),i=R(t);return s(n/(i/Math.sin(r)))+r},headingTiltToDirectionUp:wt,lookAtTiltToEyeTilt:function(e,t,n){const r=R(t),o=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),a=s(n/(o/Math.sin(e)));return i(e-a)},toArea:function(e,t){const n=e.frustum,{renderCoordsHelper:r}=e,i=r.getAltitude(t),o=e.spatialReference,a=r.referenceEllipsoid.radius,s=e.state.camera,u=s.eye,f=1+O(u,t)/(a+i),m=Math.sqrt(f*f-1),{minCurvature:p,maxCurvature:d,minSamples:h,maxSamples:T}=bt,R=function(e){const{renderCoordsHelper:t,state:{camera:n}}=e,{center:r,eye:i}=n,o=Math.abs(t.getAltitude(r)),a=Math.abs(Math.PI/2-_t(t,r,i));return xe(Dt,t.referenceEllipsoid.radius+o),be(Dt,a,n.distance,n.fovY)}(e),g=l((m-p)/(d-p),0,1),_=Math.round(c(h,T,g)),y=s.aboveGround,M=n.planes[me.FAR],E=[],A=_e(x,jt,ye()),I=_e(x,Pt,ye());Se(Gt,0,0,0,0);for(let e=0;e<4;e++){const t=e===nt.NEAR_FAR_BOTTOM_RIGHT&&!y||e===nt.NEAR_FAR_TOP_LEFT&&y?1-R:0,o=e===nt.NEAR_FAR_BOTTOM_RIGHT&&y||e===nt.NEAR_FAR_TOP_LEFT&&!y?R:1,a=n.lines[e],s=n.lines[3===e?0:e+1];for(let n=0;n<_;n++){const l=n/_,f=e===nt.NEAR_FAR_BOTTOM_RIGHT?1-(1-l)**2:e===nt.NEAR_FAR_TOP_LEFT?l**2:l,m=0===n?0:c(t,o,f),p=v(Lt,a.origin,s.origin,m),d=He(a.direction,s.direction,m,Ct);r.intersectManifoldClosestSilhouette(de(p,d),i,Ht),ct(Ht,u,Ht,M),E.push(b(Ht)),0!==E.length&&S(E.at(-1),Ht);const h=(Me(A,Ht)?1:0)|(Me(I,Ht)?2:0);Gt[h]=1}}E.length>2&&S(E[0],E.at(-1));const w=function(e,t,n){const r=2*Ne();return e.map((e=>{const i=[];let o=!1;for(const a of e)t.fromRenderCoords(a,Ht,n),Math.abs(a[0])<r&&Math.abs(a[1])<r?(i.push([null,Ht[1]]),i.push([null,Ht[1]]),o=!0):i.push([Ht[0],Ht[1]]);if(o)for(let e=0;e<i.length;e++){const t=i[e];if(null!=t[0])continue;const n=i[e+1],r=i.at(0===e?-1:e-1);t[0]=r[0],e++;const o=i.at(e===i.length-1?0:e+1);n[0]=o[0]}return i.push(i[0]),te(i)||i.reverse(),i}))}(we(Gt)>1?function(e,t){const n=[];for(const r of e)n.push(...xt(r,t));return n}(xt(E,A),I):[E],r,o);return new ve({rings:w,spatialReference:o})},toExtent:function(e,t,r,o,s){let c,l,u,f;const m=t.latitude,p=j(e.spatialReference).radius,d=t.longitude,h=Ce(m,r,p)/2;c=d-h,l=d+h;const T=a(m),R=(1+Math.sin(T))/(1-Math.sin(T)),g=(R+1)*Math.tan(o/p/2),_=g*g;function y(e){const t=Math.PI/2;return(e=n.normalize(e,-t))>t&&(e=Math.PI-e),e}if(u=1.5*Math.PI-2*Math.atan(.5*(g+Math.sqrt(4*R+_))),f=u+o/p,u=y(u),f=y(f),f<u){const e=f;f=u,u=e}if(u=Math.max(i(u),-90),f=Math.min(i(f),90),l=It.monotonic(c,l),l-c>180){const e=(l-c-180)/2;c+=e,l-=e}const M=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:H.WGS84;return s?(s.xmin=c,s.ymin=u,s.xmax=l,s.ymax=f,s.spatialReference=M):s=new ee(c,u,l,f,M),e.spatialReference&&e.spatialReference.isWebMercator&&Pe(s,!1,s),s}},Symbol.toStringTag,{value:"Module"})),Bt=()=>r.getLogger("esri.views.3d.support.cameraUtils"),kt=96*39.37,qt={heading:0,tilt:0},Jt=F(),Wt=new t(-20037508.342788905,20037508.342788905),Xt=new t(-180,180);var Vt;function Kt(e){return e.spatialReference??H.WGS84}function Yt({state:e}){return e.isGlobal?zt:gt}function Zt(e,t,n,r,i){return Yt(e).headingTiltToDirectionUp(t,n,r,i)}function Qt(e,t){if(null==t)return null;const n=e.renderSpatialReference,r=Yt(e).headingTiltToDirectionUp,i=F();if(!D(t.position,i,n))return null;const o=r(i,t.heading,t.tilt);p(o.direction,o.direction,e.state.camera.distance),h(o.direction,o.direction,i);const s=Be(e,i,o.direction,o.up);return s.fov=a(t.fov),s.row=t.layout.row,s.rows=t.layout.rows,s.column=t.layout.column,s.columns=t.layout.columns,s}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(Vt||(Vt={}));const $t=F();function en(t,n,r){const o=t.renderSpatialReference,a=mn(t,n.eye,n.viewForward,n.up,qt);let s=Kt(t);return B(n.eye,o,$t,s)||(s=H.WGS84,B(n.eye,o,$t,s)),null==r?r=new e(new P($t,s),a.heading,a.tilt,i(n.fov)):(r.position.x=$t[0],r.position.y=$t[1],r.position.z=$t[2],r.position.spatialReference=s,r.heading=a.heading,r.tilt=a.tilt,r.fov=i(n.fov)),r.layout.row=n.row,r.layout.rows=n.rows,r.layout.column=n.column,r.layout.columns=n.columns,r}function tn(e,t){const{camera:n}=e.state,{unitInMeters:r}=e.renderCoordsHelper;return n.width/2/n.pixelRatio/(96*39.37/(t/=r))/Math.tan(n.fovX/2)}function nn(e,t){const{camera:n}=e.state,{unitInMeters:r}=e.renderCoordsHelper,i=t*Math.tan(n.fovX/2),o=n.width/2/n.pixelRatio;return kt/(o/i)*r}function rn(e,t,n,r){const i=r.levelAtScale(t),o=an(mn(e,n.eye,n.viewForward,n.up).tilt),a=Math.max(i-o,0);return r.scaleAtLevel(a)}function on(e,t,n){const r=n.levelAtScale(e),i=an(t);return n.scaleAtLevel(r+i)}function an(e){return 2*((e>90?180-e:e)/90)**2}function sn(e,t,n){const r=Qt(e,t);return r?function(e,t,n){const r=e.basemapTerrain?.tilingScheme;if(!r)return 0;if(null==n){const t=e.pointsOfInterest?.cameraOnSurface?.renderLocation;n=(t&&e.renderCoordsHelper?.getAltitude(t))??0}const i=j(e.spatialReference).radius,o=e.state.viewingMode===k.Local?t.eye[2]:R(t.eye)-i;return rn(e,nn(e,Math.abs(o-n)),t,r)}(e,r,n):0}function cn(e,t,n,r,o){if(0===t)return 0;const c=O(n.eye,r),l=e.basemapTerrain?.tilingScheme;if(!l)return Bt().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),c;let u=c;const f=mn(e,n.eye,n.viewForward,n.up),m=f.tilt>90;if(e.state.viewingMode===k.Local){const r=(tn(e,on(t,f.tilt,l))-Math.abs(n.eye[2]-o[2]))/Math.cos(a(f.tilt));u=m?u-r:u+r}else{let p=1/0,d=0,h=dn(e,f.heading,f.tilt,r,c,Vt.ADJUST);if(!h)return u;const T=R(o);for(;p>1&&d<100;){const o=R(h.eye),c=m?180-h.tilt:h.tilt,g=a(c),_=Math.sin(g)*o,y=Math.cos(g)*o,M=tn(e,on(t,h.tilt,l)),E=m?T-M:T+M,A=s(_/E),I=Math.cos(A)*E-y,v=O(h.eye,r);u=m?v-I:v+I,h=dn(e,f.heading,f.tilt,r,u,Vt.ADJUST);const S=bn(e,h,i(n.fov));if(!h||!S)return u;const w=sn(e,S,T-j(e.spatialReference).radius);p=Math.abs(t-w),++d}}return u}async function ln(e,t,n,r,i,o){return fn(e,t,tn(e,n),r,i,o)}function un(e,t,n,r,i,o){return bn(e,dn(e,r.heading,r.tilt,t,n,i),r.fov,o)}async function fn(e,t,n,r,i,o){const a=await hn(e,r.heading,r.tilt,t,n,i,o);return u(o),jn(e,a,r.fov,o)}function mn(e,t,n,r,i){return Yt(e).directionToHeadingTilt(t,n,r,i)}function pn(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,Jt,e.spatialReference)&&e.elevationProvider&&(De(e.elevationProvider,Jt)??0)>Jt[2]-1)}function dn(e,t,n,r,i,o){const a=r instanceof P?r:null,s=function(e,t){const n=F();if(null==t)return f(n,e.state.camera.center);if(t instanceof P){if(!D(t,n,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:i}=e;if(null==t.z&&null!=r&&null!=i){const r=De(i,t);null!=r&&e.renderCoordsHelper.setAltitude(n,r)}return n}return f(n,t)}(e,r);return Tn(e,t,n,a,s,i,o)}async function hn(e,t,n,r,i,o,a){const s=r instanceof P?r:null,c=await async function(e,t,n){const r=F();if(null==t)return f(r,e.state.camera.center);if(t instanceof P){const{renderSpatialReference:i,basemapTerrain:o,elevationProvider:a}=e,s=t.spatialReference;if(await U(t,r,i,0,{signal:n}),u(n),null==t.z&&null!=o&&null!=a){const i=await a.queryElevation(t.x,t.y,t.z??0,s,"ground",n);u(n),null!=i&&e.renderCoordsHelper.setAltitude(r,i)}return r}return f(r,t)}(e,r,a);return u(a),Rn(e,t,n,s,c,i,o,a)}function Tn(e,t,n,r,i,o,a){if(null==i)return null;if(!r&&(r=new P({spatialReference:Kt(e)}),!G(i,e.renderSpatialReference,r)))return null;const s=gn(e,t,n,i,o,a);if(_n(e,n,a)&&pn(e,s.eye)){const{tilt:a,mode:s}=yn(e,n,i,o);return Tn(e,t,a,r,i,o,s)}return Mn(s,i)}async function Rn(e,t,n,r,i,o,a,s){r||(r=new P({spatialReference:Kt(e)}),await z(i,e.renderSpatialReference,r,{signal:s})||(r=null)),u(s);const c=gn(e,t,n,i,o,a);if(_n(e,n,a)&&await async function(e,t,n){if(pn(e,t))return!0;const{elevationProvider:r,spatialReference:i,renderCoordsHelper:o}=e;if(null==r||!o.fromRenderCoords(t,Jt,i))return!1;const[a,s,c]=Jt,l=await r.queryElevation(a,s,c,i,"ground",n)??0;return u(n),l>c-1}(e,c.eye,s)){u(s);const{tilt:a,mode:c}=yn(e,n,i,o);return Rn(e,t,a,r,i,o,c,s)}return Mn(c,i)}function gn(e,t,n,r,i,o){const a=function(e,t,n,r,i,o){let a=0;return o===Vt.ADJUST&&wn(e,r,i)?(t=0,a=function(e,t,n,r){const i=xn(e,r,t,n);if(!e.state.constraints.tilt)return i;const o=e.state.constraints.tilt(t);o.max=Math.min(o.max,.5*Math.PI);const a=o.min*(1-Fn)+o.max*Fn;return Math.min(i,a)}(e,i,n,r)):a=xn(e,r,i,n),a=e.state.constraints.clampTilt(i,a),{heading:t,tilt:n=Nn(e,r,i,a)}}(e,t,n,r,i=Math.max(i,e.state.constraints.minimumPoiDistance),o);return(0,Yt(e).eyeForCenterWithHeadingTilt)(r,i,a.heading,a.tilt)}function _n(e,t,n){const r=e.map.ground.navigationConstraint;return n===Vt.ADJUST&&e.state.isGlobal&&t>0&&(null==r||"stay-above"===r.type)}function yn(e,t,n,r){const i=Nn(e,n,r,function(e,t,n,r){let i=xn(e,r,t,n);if(!e.state.constraints.tilt)return i;const o=e.state.constraints.tilt(t);return i=Math.min(i,.5*Math.PI),o.min*(1-Fn)+i*Fn}(e,r,t,n));return{tilt:i,mode:t-i<1?Vt.LOCKED:Vt.ADJUST}}function Mn(e,t){return{...e,center:b(t)}}function En(e,t){const{state:n,spatialReference:r}=e,i=t.spatialReference;return n.isGlobal&&Ue(i,k.Global)||n.isLocal&&r.equals(i)}function An(e,t){let n,r,i;if(e.state.isGlobal){const e=new P(t.xmin,t.ymin,t.spatialReference),o=new P(t.xmax,t.ymax,t.spatialReference),a=t.spatialReference.isGeographic?Xt:Wt;n=new P({x:a.center(e.x,o.x),y:(o.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const s=j(t.spatialReference),c=Le(n,e,o);r=c.lon,i=c.lat,a.diff(e.x,o.x)>a.range/2&&(r+=s.halfCircumference),r=Math.min(r,s.halfCircumference),i=Math.min(i,s.halfCircumference)}else{const o=e.renderSpatialReference??t.spatialReference;o.equals(t.spatialReference)||(t=L(t,o)),r=t.xmax-t.xmin,i=t.ymax-t.ymin;const a=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;n=new P({x:t.xmin+.5*r,y:t.ymin+.5*i,z:a,spatialReference:o})}const o=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,a=e.state.camera,s=1/Math.tan(a.fovX/2),c=1/Math.tan(a.fovY/2),l=1/Math.tan(a.fov/2);return{center:n,distance:Math.max(.5*r*s,.5*i*c,.5*o*l)/1}}async function In(e,t,n,r,i,o){const a=En(e,t)?t:await C(t,e.spatialReference,{signal:o});u(o);const{center:s,distance:c}=An(e,a),l=await hn(e,n,r,s,c,i,o);return u(o),jn(e,l,e.camera.fov,o)}function On(e,t,n,r,i,o){let a;try{a=En(e,t)?t:L(t,e.spatialReference)}catch(e){return null}const{center:s,distance:c}=An(e,a),l=dn(e,n,r,s,c,i);return null==l?null:bn(e,l,e.camera.fov,o)}function vn(e,t,n){const r=e.renderSpatialReference,i=new P({spatialReference:Kt(e)});if(!G(n,r,i))return null;const o=Math.tan(t.fovX/2),a=Math.tan(t.fovY/2),s=w(t.eye,n),c=2*s*o*1,l=2*s*a*1;return Yt(e).toExtent(e,i,c,l)}function Sn(e,t){return Yt(e).toArea(e,t)}function wn(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>8)return!0;const i=t,o=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return O(i,o)/(Math.tan(.5*e.state.camera.fov)*r)>5}const Fn=.7;function Nn(e,t,n,r){return Yt(e).lookAtTiltToEyeTilt(r,t,n)}function xn(e,t,n,r){return Yt(e).eyeTiltToLookAtTilt(r,t,n)}function bn(t,n,r,i){if(null==n)return null;const o=t.renderSpatialReference,a=new P({spatialReference:Kt(t)});return G(n.eye,o,a)?(i??=new e,i.position=a,i.heading=n.heading,i.tilt=n.tilt,i.fov=r,i):null}async function jn(t,n,r,i){const o=t.renderSpatialReference,a=new P({spatialReference:Kt(t)});return await z(n.eye,o,a,{signal:i}),u(i),new e(a,n.heading,n.tilt,r)}function Pn(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);Bt().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Cn(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);Bt().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}export{tt as F,Vt as O,fn as a,On as b,un as c,nn as d,Qt as e,In as f,Kt as g,Be as h,en as i,ln as j,mn as k,Zt as l,at as m,ze as n,Ge as o,Sn as p,rn as q,Pn as r,tn as s,vn as t,dn as u,_t as v,cn as w,Cn as z};
