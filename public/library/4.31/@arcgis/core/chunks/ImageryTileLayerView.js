/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../Graphic.js";import r from"../core/Error.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"./Logger.js";import{subclass as i}from"../core/accessorSupport/decorators/subclass.js";import{c as s}from"./timeSupport2.js";import{g as n,p as o}from"./rasterProjectionHelper.js";import{a as l}from"./popupUtils.js";const u=u=>{let c=class extends u{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return s(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){try{return this.layer.loaded?n(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(e){try{return!this.layer.loaded||!!o(this.layer.serviceRasterInfo,e)}catch{return!1}}async fetchPopupFeaturesAtLocation(e,a){const{layer:i}=this;if(!e)throw new r("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:s}=i,n=l(i,a);if(!s||null==n)return[];const o=[],{value:u,magdirValue:c,processedValue:p}=await i.identify(e,{timeExtent:this.timeExtent,signal:a?.signal});let m="";if(u?.length){m="imagery-tile"===i.type&&i.hasStandardTime()&&null!=u[0]?u.map((e=>i.getStandardTimeValue(e))).join(", "):u.join(", ");const e={ObjectId:0},r="Raster.ServicePixelValue";e[r]="imagery-tile"===i.type&&"Function"===i.raster.datasetFormat?p?.join(", "):m,e[r+".Raw"]=m;const a=i.raster?.rasterInfo??i.serviceRasterInfo,s=a?.attributeTable;if(null!=s){const{fields:t,features:a}=s,i=t.find((({name:e})=>"value"===e.toLowerCase())),n=e[r],o=i?a.find((e=>String(e.attributes[i.name])===n)):null;if(o)for(const t in o.attributes)o.attributes.hasOwnProperty(t)&&(e[this._rasterFieldPrefix+t]=o.attributes[t])}const n=a?.dataType;"vector-magdir"!==n&&"vector-uv"!==n||(e["Raster.Magnitude"]=c?.[0],e["Raster.Direction"]=c?.[1]);const l=new t({geometry:this.fullExtent?.clone(),attributes:e,layer:i,sourceLayer:i});o.push(l)}return o}_getFullExtent(){return o(this.layer.serviceRasterInfo,this.view.spatialReference)}};return e([a()],c.prototype,"fullExtent",null),e([a()],c.prototype,"layer",void 0),e([a({readOnly:!0})],c.prototype,"timeExtent",null),e([a()],c.prototype,"tileInfo",void 0),e([a({readOnly:!0})],c.prototype,"hasTilingEffects",null),e([a()],c.prototype,"datumTransformation",null),c=e([i("esri.views.layers.ImageryTileLayerView")],c),c};export{u as I};
