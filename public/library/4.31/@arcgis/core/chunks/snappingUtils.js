/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{i as t,e}from"../core/lang.js";import{f as s,b as n}from"./mathUtils.js";import{s as r,c as i,d as o,b as a,k as c,l as u,h as f,g as h,p as l,q as d}from"./vec2.js";import{c as p,f as m,Z as g}from"./vec2f64.js";import{j as L,d as y,k as _,f as E,i as P,o as k,a as A,c as M,C as N,e as j,r as w,q as x,n as v,F as T}from"./vec3.js";import{c as R,a as q,f as z,d as b}from"./vec3f64.js";import{s as I,d as D}from"./vec4.js";import{c as O}from"./vec4f64.js";import{t as S}from"./geodesicConstants.js";import{directGeodeticSolver as C,inverseGeodeticSolver as F,InverseGeodeticSolverResult as H}from"../geometry/support/geodesicUtils.js";import{c as Y,j as Z,o as G,C as U,D as V,z as J,p as Q,g as X,l as K}from"./plane.js";import{e as B,h as W,j as $,p as tt,g as et}from"./sphere.js";import{t as st}from"./mathUtils2.js";import{e as nt,g as rt,b as it,a as ot,f as at,c as ct,d as ut}from"./normalizedPoint.js";import{g as ft}from"./common.js";import{L as ht,i as lt}from"./geometry2dUtils.js";import{watch as dt,syncAndInitial as pt}from"../core/reactiveUtils.js";import{l as mt}from"../core/Accessor.js";import{sqlAnd as gt}from"../core/sql.js";import{a as Lt}from"./timeUtils.js";import{m as yt}from"./dehydratedPoint.js";import _t from"../rest/support/Query.js";import{V as Et}from"./InputManager.js";import{a as Pt}from"./keybindings.js";import{i as kt}from"./utils6.js";function At({start:t,end:e,type:s},n,c){const u=[],f=r(Ct,e,t),h=r(Ft,t,n),l=i(f),d=2*o(f,h),m=d*d-4*l*(i(h)-c*c);if(0===m){const e=-d/(2*l);(s===Ot.PLANE||e>=0)&&u.push(a(p(),t,f,e))}else if(m>0){const e=Math.sqrt(m),n=(-d+e)/(2*l);(s===Ot.PLANE||n>=0)&&u.push(a(p(),t,f,n));const r=(-d-e)/(2*l);(s===Ot.PLANE||r>=0)&&u.push(a(p(),t,f,r))}return u}function Mt(t,e){const s=t.start,n=t.end,i=r(Ct,n,s),a=E(Yt,-i[1],i[0],0),u=e.start,f=e.end,h=L(Zt,f,u),l=y(h,a),d=E(Gt,s[0],s[1],0),p=L(Ut,d,u),m=y(p,a),g=ft();if(Math.abs(l)<g)return Math.abs(m),[];const P=_(Vt,u,h,m/l);if(e.type===ht.RAY){const t=L(Jt,P,u);if(y(t,h)<-g)return[]}if(t.type===Ot.HALF_PLANE){const t=c(Ft,P,s);if(o(t,i)<-g)return[]}return[q(P)]}function Nt(t,e){return Rt(zt(Xt,0,t),zt(Kt,0,e)).map((([t,e])=>m(t,e)))}function jt(t,e,s){return xt(t,zt(Xt,t[2],e),s)}function wt(t,e,s,n=R()){const i=r(Ct,t,e),o=u(i);return a(n,e,i,0===o?1:s/o),n[2]=t[2],n}function xt(t,{start:e,end:s,type:n},r=R()){const i=L(Ht,t,e),o=L(Yt,s,e),a=y(i,o)/y(o,o);return _(r,e,o,n===ht.RAY?Math.max(a,0):a)}const vt=(()=>{const t=R(),e=R(),s=R();return({start:n,end:r},{center:i,radius:o,normal:a,slicePlane:c})=>{const u=G(i,a,Qt);if(It(U(u,n),0)&&It(U(u,r),0)){st(a,t,e);const u=(n,r)=>(A(s,r,i),h(n,y(s,t),y(s,e)),n),f=lt({start:u(Ct,n),end:u(Ft,r),type:ht.LINE},g,o),l=[];for(const[s,n]of f){const r=P(R(),i);_(r,r,t,s),_(r,r,e,n),c&&!Dt(c,r)||l.push(r)}return l}const f=R();return V(u,n,r,f)?!It(k(f,i),o)||c&&!Dt(c,f)?[]:[f]:[]}})();function Tt({start:t,end:e,type:s},n,a){const c=[],u=A(Ht,e,t),f=r(Ft,t,n),h=i(u),l=2*o(u,f),d=l*l-4*h*(i(f)-a*a);if(0===d){const e=-l/(2*h);(s===ht.LINE||e>=0)&&c.push(_(R(),t,u,e))}else if(d>0){const e=Math.sqrt(d),n=(-l+e)/(2*h);(s===ht.LINE||n>=0)&&c.push(_(R(),t,u,n));const r=(-l-e)/(2*h);(s===ht.LINE||r>=0)&&c.push(_(R(),t,u,r))}return c}function Rt(t,e){const s=t.start,n=t.end,r=e.start,i=e.end,o=L(Ht,n,s),a=L(Yt,i,r),c=L(Zt,r,s),u=M(Gt,o,a);if(!It(y(c,u),0))return[];const f=N(u);if(It(f,0))return[];const h=M(Ut,c,a),l=y(h,u)/f,d=_(Vt,s,o,l);if(t.type===ht.RAY){const t=L(Jt,d,s);if(y(o,t)<-ft())return[]}if(e.type===ht.RAY){const t=L(Jt,d,r);if(y(a,t)<-ft())return[]}return[q(d)]}function qt(t,e,s,n){const[r,i]=t,[o,a]=s,c=o-r,u=a-i,h=c*c+u*u,l=Math.sqrt(h);if(l>e+n)return[];if(l<Math.abs(e-n))return[];if(It(l,0)&&It(e,n))return[];const d=(e*e-n*n+h)/(2*l),p=Math.sqrt(e*e-d*d),g=p*u/l,L=p*c/l,[y,_]=f(Ct,t,s,d/l);return It(g,L)?[m(y,_)]:[m(y+g,_-L),m(y-g,_+L)]}function zt(t,e,{start:s,end:n,type:r}){return E(t.start,s[0],s[1],e),E(t.end,n[0],n[1],e),t.type=St[r],t}function bt(t,e){return It(t[2],e[2])}function It(t,e){return s(Math.abs(t-e),0,ft())}function Dt(t,e){return Z(t,e)}var Ot;!function(t){t[t.PLANE=0]="PLANE",t[t.HALF_PLANE=1]="HALF_PLANE"}(Ot||(Ot={}));const St={[Ot.PLANE]:ht.LINE,[Ot.HALF_PLANE]:ht.RAY},Ct=p(),Ft=p(),Ht=R(),Yt=R(),Zt=R(),Gt=R(),Ut=R(),Vt=R(),Jt=R(),Qt=Y(),Xt={start:R(),end:R(),type:ht.LINE},Kt={start:R(),end:R(),type:ht.LINE};class Bt{intersect(t){return Me(this,t)}closestPoints(t){return[this.closestTo(t)]}}class Wt extends Bt{constructor(t){super(),this.point=t}equals(t){return this===t||Oe(t)&&j(this.point,t.point)}closestTo(){return rt(this.point)}}class $t extends Bt{constructor(t,e,s){super(),this.start=t,this.end=e,this.lineLike={start:t,end:e,type:s}}equals(t){return this===t||Se(t)&&this.lineLike.type===t.lineLike.type&&j(this.start,t.start)&&j(this.end,t.end)}closestTo(t){const e=it();return xt(t,this.lineLike,e),e}}class te extends $t{constructor(t,e){super(t,e,ht.LINE)}}class ee extends $t{constructor(t,e){super(t,e,ht.RAY)}}class se extends Bt{constructor(t){super(),this.constraints=t}equals(t){return this===t||De(t)&&e(this.constraints,t.constraints,((t,e)=>t.equals(e)))}closestTo(t){let e,s=1/0;for(const n of this.constraints){const r=n.closestTo(t),i=w(t,r);i<s&&(s=i,e=r)}return rt(e??t)}closestPoints(t){return this.constraints.flatMap((e=>e===this?[]:e.closestPoints(t)))}}class ne extends Bt{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||He(t)&&this.center[0]===t.center[0]&&this.center[1]===t.center[1]&&this.radius===t.radius}closestTo(t){const e=it();return wt(t,this.center,this.radius,e),e}}class re extends Bt{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||Ye(t)&&j(this.center,t.center)&&this.radius===t.radius}closestTo(t){const e=it();return wt(t,this.center,this.radius,e),e[2]=this.center[2],e}asCircle(){return new ie(rt(this.center),this.radius,at(0,0,1))}}class ie extends Bt{constructor(t,e,s,n=void 0){super(),this.center=t,this.radius=e,this.normal=s,this.slicePlane=n}equals(t){return this===t||Ze(t)&&j(this.center,t.center)&&j(this.normal,t.normal)&&this.radius===t.radius}closestTo(t){const{center:e,radius:s}=this;Q(this.getPlane(ae),t,oe);const n=L(oe,oe,e),r=x(n);if(It(r,0))return rt(t);const i=s/Math.sqrt(r),o=it();_(o,e,n,i);const{slicePlane:a}=this;if(a&&!Dt(a,o)){const e=je(a,this);return e?.closestTo(t)??rt(t)}return o}getPlane(t=Y()){return G(this.center,this.normal,t)}}const oe=R(),ae=Y();class ce extends Bt{constructor(t){super(),this.z=t}equals(t){return this===t||Ce(t)&&this.z===t.z}closestTo(t){return at(t[0],t[1],this.z)}getPlane(t=Y()){return E(ue,0,0,this.z),G(ue,b,t)}}const ue=R();class fe extends Bt{constructor(t,e,s){super(),this.start=t,this.end=e,this.planeLike={start:ot(t),end:ot(e),type:s}}equals(t){return this===t||Fe(t)&&this.planeLike.type===t.planeLike.type&&j(this.start,t.start)&&j(this.end,t.end)}closestTo(t){const e=it();return jt(t,this.planeLike,e),e}closestEndTo(t){const{start:e,end:s}=this.planeLike;return Math.sign(o(r(he,s,e),r(le,ot(t),e)))>0?this.end:this.start}getPlane(t=Y()){const e=P(de,this.end);return e[2]+=1,K(this.start,this.end,e,t)}getSlicePlane(t=Y()){const{start:e,end:s,type:n}=this.planeLike;if(n===Ot.PLANE)return;const r=E(de,e[0],e[1],0),i=E(pe,s[0],s[1],0),o=A(pe,i,r);return G(r,o,t),t}}const he=p(),le=p(),de=R(),pe=R();class me extends fe{constructor(t,e){super(t,e,Ot.HALF_PLANE)}}class ge extends fe{constructor(t,e){super(t,e,Ot.PLANE)}}class Le extends Bt{constructor(t,e){super(),this.sphere=W(t,e)}equals(t){return this===t||Ge(t)&&$(this.sphere,t.sphere)}closestTo(t){const e=it();return tt(this.sphere,t,e),e}get center(){return et(this.sphere)}get radius(){return this.sphere[3]}}class ye extends Bt{constructor(t,e,s){super(),this.start=t,this.end=e,this.getZ=s,this.planeLike={start:ot(t),end:ot(e),type:Ot.PLANE}}equals(t){return this===t||Ue(t)&&j(this.start,t.start)&&j(this.end,t.end)&&this.getZ===t.getZ}closestTo(t){return function(t,e){const s=it();return jt(e,t.planeLike,s),s[2]=t.getZ(s[0],s[1])??Ve,s}(this,t)}addIfOnTheGround(t,e){for(const s of e){const e=this.getZ(s[0],s[1])??0;It(s[2],e)&&(s[2]=e,t.push(s))}}}class _e extends Bt{constructor(t,e,s){super(),this._x=t,this._y=e,this._z=s}equals(t){return this===t||t instanceof _e&&this._x===t._x&&this._y===t._y&&this._z===t._z}closestTo([t,e,s]){return ct(this._x??t,this._y??e,this._z??s)}}class Ee extends Bt{constructor(t,e,s,n,r){super(),this._origin=t,this._spatialReference=e,this._distanceMeters=s,this._z=n,this._directionDegrees=r}equals(t){return this===t||t instanceof Ee&&d(this._origin,t._origin)&&this._spatialReference===t._spatialReference&&this._distanceMeters===t._distanceMeters&&this._z===t._z&&this._directionDegrees===t._directionDegrees}closestTo([t,e,s]){return h(Pe,t,e),d(Pe,this._origin)||this._applyDirectionAndDistance(Pe),ct(Pe[0],Pe[1],this._z??s)}_applyDirectionAndDistance(t){if(null!=this._directionDegrees&&null!=this._distanceMeters)C(t,this._origin,this._directionDegrees,this._distanceMeters,this._spatialReference);else if(null!=this._directionDegrees)!function(t,e,s,n,r){let{azimuth:i,distance:o}=F(Ae,e,n,r);i??=0;let a=o*Math.cos((i-s)*S);a=Math.max(0,a),C(t,e,s,a,r)}(t,this._origin,this._directionDegrees,t,this._spatialReference);else if(null!=this._distanceMeters){const{azimuth:e}=F(ke,this._origin,t,this._spatialReference);C(t,this._origin,e??0,this._distanceMeters,this._spatialReference)}}}const Pe=[0,0],ke=new H,Ae=new H;function Me(t,e){if(De(t)){const s=[];for(const n of t.constraints){const t=n.intersect(e);t&&s.push(t)}return Ie(s)}if(De(e))return Me(e,t);if(Ue(t))return Re(t,e);if(Ue(e))return Re(e,t);if(Oe(t)){const{point:s}=t;if(Oe(e))return j(s,e.point)?t:void 0;const n=e.closestTo(s);return T(n,s)?t:void 0}if(Se(t)){if(Oe(e))return Me(e,t);if(Se(e))return ze(Rt(t.lineLike,e.lineLike));if(Ce(e))return Ne(t,e);if(Fe(e))return ze(Mt(e.planeLike,t.lineLike));if(He(e))return ze(Tt(t.lineLike,e.center,e.radius));if(Ze(e))return ze(vt(t.lineLike,e));if(Ye(e))return function({lineLike:t},{center:e,radius:s}){const n=e[2];return ze(Tt(t,e,s).filter((t=>It(t[2],n))))}(t,e);if(Ge(e))return function({lineLike:t},{sphere:e}){return ze(B(e,t.start,t.end))}(t,e)}else if(Ce(t)){if(Oe(e)||Se(e))return Me(e,t);if(Ce(e))return function(t,e){return It(t.z,e.z)?t:void 0}(t,e);if(Fe(e))return function({z:t},{planeLike:e}){const[s,n]=e.start,[r,i]=e.end,o=at(s,n,t),a=at(r,i,t);return e.type===Ot.PLANE?new te(o,a):new ee(o,a)}(t,e);if(He(e))return function(t,e){const[s,n]=e.center;return new re(at(s,n,t.z),e.radius)}(t,e);if(Ze(e))return we(t,e);if(Ye(e))return s=t,It((n=e).center[2],s.z)?n:void 0;if(Ge(e))return function(t,{center:e,radius:s}){const n=Math.abs(e[2]-t.z);if(n>s&&!It(n,s))return;const r=at(e[0],e[1],t.z),i=Math.sqrt(s**2-n**2);return It(i,0)?void 0:new re(r,i)}(t,e)}else if(Fe(t)){if(Oe(e)||Se(e)||Ce(e))return Me(e,t);if(Fe(e))return qe(Nt(t.planeLike,e.planeLike));if(He(e))return qe(At(t.planeLike,e.center,e.radius));if(Ze(e))return ve(t,e);if(Ye(e))return xe(t,e);if(Ge(e))return Te(t,e)}else if(He(t)){if(Oe(e)||Se(e)||Ce(e)||Fe(e))return Me(e,t);if(He(e))return qe(qt(ot(t.center),t.radius,ot(e.center),e.radius));if(Ze(e))return;if(Ye(e))return function(t,e){return It(l(ot(t.center),ot(e.center)),0)&&It(t.radius,e.radius)?e:be(qt(ot(t.center),t.radius,ot(e.center),e.radius),e.center[2])}(t,e);if(Ge(e))return}else if(Ze(t)){if(Oe(e)||Se(e)||Ce(e)||Fe(e)||He(e))return Me(e,t);if(Ze(e))return;if(Ye(e))return void e.asCircle();if(Ge(e))return}else if(Ye(t)){if(Oe(e)||Se(e)||Ce(e)||Fe(e)||He(e)||Ze(e))return Me(e,t);if(Ye(e))return function(t,e){if(bt(t.center,e.center))return It(l(ot(t.center),ot(e.center)),0)&&It(t.radius,e.radius)?t:be(qt(ot(t.center),t.radius,ot(e.center),e.radius),t.center[2])}(e,t);if(Ge(e))return}else if(Ge(t)){if(Oe(e)||Se(e)||Ce(e)||Fe(e)||He(e)||Ye(e))return Me(e,t);if(Ge(e))return}var s,n}const Ne=(()=>{const t=Y();return(e,s)=>{const{start:n,end:r}=e;if(bt(n,r)&&It(n[2],s.z))return e;const i=it();return V(s.getPlane(t),n,r,i)?new Wt(i):void 0}})(),je=(()=>{const t=O(),e=R(),s=R();return(r,i,o)=>{const{normal:a,center:c,radius:u}=i;st(a,e,s);const f=X(r),h=u*y(f,e),l=u*y(f,s);I(t,c[0],c[1],c[2],1);const d=D(r,t),p=Math.hypot(h,l),m=It(p,0);if(It(U(r,c),0)){if(m)return i;if(It(u,0))return!o||Dt(o,c)?new Wt(rt(c)):void 0;M(e,f,a),v(e,e);const t=new Array,s=q(c);_(s,s,e,u),o&&!Dt(o,s)||t.push(s);const n=q(c);return _(n,n,e,-u),o&&!Dt(o,n)||t.push(n),ze(t)}if(m)return;const g=-d/p;if(Math.abs(g)>1||It(g,1))return;const L=Math.atan(h/l),E=n(g)-L,P=Math.PI-E,k=new Array,A=R();_(A,c,e,u*Math.cos(E)),_(A,A,s,u*Math.sin(E)),k.push(A);const N=R();return _(N,c,e,u*Math.cos(P)),_(N,N,s,u*Math.sin(P)),k.push(N),ze(o?function(t,e){return e.filter((e=>Dt(t,e)))}(o,k):k)}})(),we=(()=>{const t=Y();return(e,s)=>je(e.getPlane(t),s,s.slicePlane)})(),xe=(()=>{const t=Y();return(e,{center:s,radius:n})=>{const r=At(e.planeLike,s,n),i=s[2];e.getSlicePlane(t);const o=new Array;for(const[e,s]of r){const n=[e,s,i];Dt(t,n)&&o.push(n)}return ze(o)}})(),ve=(()=>{const t=Y(),e=Y();return(s,n)=>je(s.getPlane(t),n,s.getSlicePlane(e))})(),Te=(()=>{const t=Y();return(e,{center:s,radius:n})=>{const r=e.getPlane(t),i=J(r,s),o=Math.abs(i);if(o>n&&!It(o,n))return;const a=Math.sqrt(n**2-i**2);if(It(a,0)){const t=it();return Q(r,s,t),new Wt(t)}const c=it(),u=q(X(r));return _(c,s,u,i),new ie(c,a,u,e.getSlicePlane())}})();function Re(t,e){const{planeLike:s,getZ:n}=t,r=new Array;if(Oe(e))t.addIfOnTheGround(r,(i=s,o=e.point,function({start:t,end:e,type:s},n){const r=L(Ht,n,t),i=L(Yt,e,t),o=M(Zt,i,r),a=N(o)/N(i),c=ft();if(a<c)switch(s){case ht.LINE:return[q(n)];case ht.RAY:return y(i,r)<-c?[]:[q(n)]}return[]}(zt(Xt,o[2],i),o)));else if(Se(e))t.addIfOnTheGround(r,Mt(s,e.lineLike));else if(He(e))for(const[t,i]of At(s,e.center,e.radius)){const e=n(t,i);null!=e&&r.push(z(t,i,e))}else if(Fe(e)||Ue(e))for(const[t,i]of Nt(s,e.planeLike)){const e=n(t,i)??Ve;r.push(z(t,i,e))}var i,o;return ze(r)}function qe(t){return Ie(t.map((([t,e])=>{const s=at(t,e,0),n=at(t,e,1);return new te(s,n)})))}function ze(t){return Ie(t.map((t=>t?new Wt(nt(t)):void 0)))}function be(t,e){return ze(t.map((([t,s])=>[t,s,e])))}function Ie(e){if(0!==e.length)return 1===e.length?e[0]??void 0:new se(e.filter(t))}function De(t){return t instanceof se}function Oe(t){return t instanceof Wt}function Se(t){return t instanceof $t}function Ce(t){return t instanceof ce}function Fe(t){return t instanceof fe}function He(t){return t instanceof ne}function Ye(t){return t instanceof re}function Ze(t){return t instanceof ie}function Ge(t){return t instanceof Le}function Ue(t){return t instanceof ye}const Ve=0,Je=Symbol("grid-placement-graphic");function Qe(t,e){const s=t.x-e.x,n=t.y-e.y;return s*s+n*n}function Xe(t,e){return Math.sqrt(Qe(t,e))}function Ke(t,e){e.sort(((e,s)=>w(e.targetPoint,t)-w(s.targetPoint,t)))}var Be;function We({point:t,distance:e,returnEdge:s,vertexMode:n,coordinateHelper:{spatialReference:r},filter:i},o,a){return a=null!=a?a.clone():new _t({where:"1=1"}),i&&(a.geometry=i.geometry,a.distance=i.distance,a.spatialRelationship=i.spatialRelationship,a.where=gt(a.where,i.where),a.timeExtent=Lt(a.timeExtent,i.timeExtent),a.objectIds=(c=a.objectIds,u=i.objectIds,c||u?u?c?Array.from(mt(new Set(c),new Set(u))):u:c:null)),{point:yt(t[0],t[1],t[2],r.toJSON()),mode:o,distance:e,returnEdge:s,vertexMode:n,query:a.toJSON()};var c,u}function $e(t,e,s){return{left:ut(t.leftVertex.pos,e,s),right:ut(t.rightVertex.pos,e,s)}}function ts(t){return t.createQuery()}!function(t){t[t.TARGET=0]="TARGET",t[t.REFERENCE=1]="REFERENCE",t[t.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"}(Be||(Be={}));const es=Symbol("snapping-toggle");function ss(t,e=()=>{}){const s=dt((()=>({view:t.view,snappingOptions:t.snappingOptions})),(({view:s,snappingOptions:n})=>{if(t.removeHandles(es),!s||!n)return;const r=Et.TOOL,i=[s.on("key-down",(t=>{t.key!==Pt.toggle||t.repeat||(n.enabledToggled=!0,e())}),r),s.on("key-up",(t=>{t.key===Pt.toggle&&(n.enabledToggled=!1,e())}),r),s.on("pointer-move",(t=>{const s=t.native.ctrlKey;n.enabledToggled!==s&&(n.enabledToggled=s,e())}),r)];t.addHandles(i,es)}),pt);t.addHandles(s)}function ns(t){return kt(t)&&"utilityNetworks"in t&&!!t.utilityNetworks?.length}export{_e as C,ye as D,Ee as G,ce as H,Be as L,Wt as P,me as V,We as a,ss as b,Xe as c,ne as d,Ie as e,Oe as f,Je as g,Qe as h,ns as i,$e as j,te as k,ge as l,ts as m,xt as p,Ke as s};
