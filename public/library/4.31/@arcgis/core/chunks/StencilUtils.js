/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{n as e,d as t,k as i,j as r,x as s}from"../core/lang.js";import{I as n,a,c as o}from"./mat4f64.js";import{l,r as c,f as u,g as d,s as h,I as f,m,a as g}from"./vec3.js";import{c as p,a as _}from"./Indices.js";import{P as v}from"../core/scheduling.js";import{f as T,a as A,c as E,Z as x}from"./vec3f64.js";import{a as S}from"./Util.js";import{a as C,C as b,R as I,D as y}from"./Material.js";import{b as P}from"./triangle.js";import{g as R}from"../core/Accessor.js";import{O as w,a as M,T as L,S as D}from"./basicInterfaces.js";import{V as O}from"./VertexAttribute.js";import{_ as U}from"./tslib.es6.js";import{U as N,l as z,T as F,F as H,b as B,S as G,M as V,a as j,c as $,q as k}from"./Matrix4PassUniform.js";import{p as W,S as X}from"./ShaderTechniqueConfiguration.js";import{B as K}from"./BindType.js";import{l as q,r as Q,d as Y,h as Z,c as J,n as ee,m as te,s as ie,x as re}from"./mat4.js";import{N as se,g as ne,I as ae}from"./interfaces3.js";import{c as oe}from"./mathUtils.js";import{f as le}from"./mat3.js";import{c as ce}from"./mat3f64.js";import{m as ue}from"./lengthUtils.js";import{d as de}from"./debugFlags2.js";import he from"../core/Error.js";import fe from"../core/Evented.js";import{f as me,r as ge}from"./maybe.js";import{throwIfAborted as pe,onAbort as _e,createAbortError as ve}from"../core/promiseUtils.js";import{isBlobProtocol as Te,isDataProtocol as Ae}from"../core/urlUtils.js";import{r as Ee}from"./requestImageUtils.js";import{l as xe}from"../request.js";import{g as Se}from"./assets.js";import{m as Ce,d as be,c as Ie,T as ye,k as Pe,a as Re,f as we,h as Me,g as Le}from"./enums.js";import{T as De,d as Oe,a as Ue,w as Ne}from"./Texture.js";import{L as ze}from"./Logger.js";import{g as Fe}from"./vec2.js";import{c as He}from"./vec2f64.js";import{n as Be}from"./compilerUtils.js";import{a as Ge}from"./AlphaCutoff.js";import{m as Ve,b as je,d as $e,s as ke,p as We,a as Xe}from"./renderState.js";class Ke{constructor(){this.uid=R()}}class qe extends Ke{constructor(e){super(),this.highlightGroupName=e,this.channel=w.Highlight}}class Qe extends Ke{constructor(){super(...arguments),this.channel=w.MaskOccludee}}function Ye(t,i=!1){return t<=e?i?new Array(t).fill(0):new Array(t):new Float32Array(t)}function Ze(i){return t(i)?i.length<e?i:new Float32Array(i):i.length<e?Array.from(i):i}function Je(i){return(t(i)?i.length:i.byteLength/8)<=e?Array.from(i):new Float32Array(i)}function et(e,t,i){return Array.isArray(e)?e.slice(t,t+i):e.subarray(t,t+i)}function tt(r){if(r.length<e)return Array.from(r);if(t(r))return Float64Array.from(r);if(!("BYTES_PER_ELEMENT"in r))return Array.from(r);switch(r.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(r);case 2:return i(r)?Uint16Array.from(r):Int16Array.from(r);case 4:return Float32Array.from(r);default:return Float64Array.from(r)}}class it{constructor(e,t,i){this.primitiveIndices=e,this._numIndexPerPrimitive=t,this.position=i,this._children=void 0,S(e.length>=1),S(3===i.size||4===i.size);const{data:r,size:s,indices:n}=i;S(n.length%this._numIndexPerPrimitive==0),S(n.length>=e.length*this._numIndexPerPrimitive);const a=e.length;let o=s*n[this._numIndexPerPrimitive*e[0]];rt.clear(),rt.push(o);const c=T(r[o],r[o+1],r[o+2]),u=A(c);for(let t=0;t<a;++t){const i=this._numIndexPerPrimitive*e[t];for(let e=0;e<this._numIndexPerPrimitive;++e){o=s*n[i+e],rt.push(o);let t=r[o];c[0]=Math.min(t,c[0]),u[0]=Math.max(t,u[0]),t=r[o+1],c[1]=Math.min(t,c[1]),u[1]=Math.max(t,u[1]),t=r[o+2],c[2]=Math.min(t,c[2]),u[2]=Math.max(t,u[2])}}this.bbMin=c,this.bbMax=u;const d=l(E(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(u[0]-c[0],u[1]-c[1]),u[2]-c[2]);let h=this.radius*this.radius;for(let e=0;e<rt.length;++e){o=rt.at(e);const t=r[o]-d[0],i=r[o+1]-d[1],s=r[o+2]-d[2],n=t*t+i*i+s*s;if(n<=h)continue;const a=Math.sqrt(n),l=.5*(a-this.radius);this.radius=this.radius+l,h=this.radius*this.radius;const c=l/a;d[0]+=t*c,d[1]+=i*c,d[2]+=s*c}this.center=d,rt.clear()}getChildren(){if(this._children||c(this.bbMin,this.bbMax)<=1)return this._children;const e=l(E(),this.bbMin,this.bbMax,.5),t=this.primitiveIndices.length,i=new Uint8Array(t),r=new Array(8);for(let e=0;e<8;++e)r[e]=0;const{data:s,size:n,indices:a}=this.position;for(let o=0;o<t;++o){let t=0;const l=this._numIndexPerPrimitive*this.primitiveIndices[o];let c=n*a[l],u=s[c],d=s[c+1],h=s[c+2];for(let e=1;e<this._numIndexPerPrimitive;++e){c=n*a[l+e];const t=s[c],i=s[c+1],r=s[c+2];t<u&&(u=t),i<d&&(d=i),r<h&&(h=r)}u<e[0]&&(t|=1),d<e[1]&&(t|=2),h<e[2]&&(t|=4),i[o]=t,++r[t]}let o=0;for(let e=0;e<8;++e)r[e]>0&&++o;if(o<2)return;const u=new Array(8);for(let e=0;e<8;++e)u[e]=r[e]>0?new Uint32Array(r[e]):void 0;for(let e=0;e<8;++e)r[e]=0;for(let e=0;e<t;++e){const t=i[e];u[t][r[t]++]=this.primitiveIndices[e]}this._children=new Array;for(let e=0;e<8;++e)void 0!==u[e]&&this._children.push(new it(u[e],this._numIndexPerPrimitive,this.position));return this._children}static prune(){rt.prune()}}const rt=new v({deallocator:null}),st=E(),nt=E(),at=E(),ot=E();class lt extends C{constructor(e,t,i=null,r=b.Mesh,s=null,n=-1){super(),this.material=e,this.mapPositions=i,this.type=r,this.objectAndLayerIdColor=s,this.edgeIndicesLength=n,this.highlights=new Set,this._highlightGroupCounts=new Map,this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[e,i]of t)this._attributes.set(e,{...i,indices:p(i.indices)}),e===O.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(e).indices.length:this.edgeIndicesLength)}instantiate(e={}){const t=new lt(e.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach(((e,i)=>{e.exclusive=!1,t._attributes.set(i,e)})),t._boundingInfo=this._boundingInfo,t.transformation=e.transformation||this.transformation,t}get attributes(){return this._attributes}getMutableAttribute(e){let t=this._attributes.get(e);return t&&!t.exclusive&&(t={...t,exclusive:!0,data:tt(t.data)},this._attributes.set(e,t)),t}setAttributeData(e,t){const i=this._attributes.get(e);i&&this._attributes.set(e,{...i,exclusive:!0,data:t})}get indexCount(){const e=this._attributes.values().next().value.indices;return e?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return null==this._boundingInfo&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===b.Mesh?this._computeAttachmentOriginTriangles(e):this.type===b.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(null!=this._transformation&&m(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){return function(e,t){if(!e)return!1;const{size:i,data:r,indices:s}=e;u(t,0,0,0),u(ot,0,0,0);let n=0,a=0;for(let e=0;e<s.length-2;e+=3){const o=s[e]*i,l=s[e+1]*i,c=s[e+2]*i;u(st,r[o],r[o+1],r[o+2]),u(nt,r[l],r[l+1],r[l+2]),u(at,r[c],r[c+1],r[c+2]);const f=P(st,nt,at);f?(d(st,st,nt),d(st,st,at),h(st,st,1/3*f),d(t,t,st),n+=f):(d(ot,ot,st),d(ot,ot,nt),d(ot,ot,at),a+=3)}return!(0===a&&0===n||(0!==n?(h(t,t,1/n),0):0===a||(h(t,ot,1/a),0)))}(this.attributes.get(O.POSITION),e)}_computeAttachmentOriginLines(e){const t=this.attributes.get(O.POSITION);return function(e,t,i){if(!e)return!1;u(i,0,0,0),u(ot,0,0,0);let r=0,s=0;const{size:n,data:a,indices:o}=e,l=o.length-1,c=l+(t?2:0);for(let e=0;e<c;e+=2){const t=e<l?e+1:0,c=o[e<l?e:l]*n,u=o[t]*n;st[0]=a[c],st[1]=a[c+1],st[2]=a[c+2],nt[0]=a[u],nt[1]=a[u+1],nt[2]=a[u+2],h(st,d(st,st,nt),.5);const m=f(st,nt);m>0?(d(i,i,h(st,st,m)),r+=m):0===r&&(d(ot,ot,st),s++)}return 0!==r?(h(i,i,1/r),!0):0!==s&&(h(i,ot,1/s),!0)}(t,function(e,t){return!(!("isClosed"in e)||!e.isClosed)&&t.indices.length>2}(this.material.parameters,t),e)}_computeAttachmentOriginPoints(e){return function(e,t){if(!e)return!1;const{size:i,data:r,indices:s}=e;u(t,0,0,0);let n=-1,a=0;for(let e=0;e<s.length;e++){const o=s[e]*i;n!==o&&(t[0]+=r[o],t[1]+=r[o+1],t[2]+=r[o+2],a++),n=o}return a>1&&h(t,t,1/a),a>0}(this.attributes.get(O.POSITION),e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.attributes.get(O.POSITION);if(!e||0===e.indices.length)return null;const t=this.type===b.Mesh?3:1;S(e.indices.length%t==0,"Indexing error: "+e.indices.length+" not divisible by "+t);const i=_(e.indices.length/t);return new it(i,t,e)}get transformation(){return this._transformation??n}set transformation(e){this._transformation=e&&e!==n?a(e):null}get highlightGroups(){return this._highlightGroupCounts}get hasHighlights(){return this._highlightGroupCounts.size>0}foreachHighlightGroup(e){this._highlightGroupCounts.forEach(((t,i)=>e(i)))}allocateIdAndHighlight(e){const t=new qe(e);return this.addHighlight(t)}addHighlight(e){this.highlights.add(e);const{highlightGroupName:t}=e,i=(this._highlightGroupCounts.get(t)??0)+1;return this._highlightGroupCounts.set(t,i),e}removeHighlight(e){if(this.highlights.delete(e)){const{highlightGroupName:t}=e,i=this._highlightGroupCounts.get(t)??0;i<=1?this._highlightGroupCounts.delete(t):this._highlightGroupCounts.set(t,i-1)}}}class ct{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){}get _stippleTextures(){return this._techniques.context.stippleTextures}get _markerTextures(){return this._techniques.context.markerTextures}acquireTechnique(e,t){return this._techniques.acquire(e,this._material.getConfiguration(this._output,t))}ensureResources(e){return M.LOADED}}var ut,dt,ht;!function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.OPAQUE_MATERIAL_WITHOUT_NORMALS=3]="OPAQUE_MATERIAL_WITHOUT_NORMALS",e[e.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_MATERIAL_WITHOUT_NORMALS=5]="TRANSPARENT_MATERIAL_WITHOUT_NORMALS",e[e.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_MATERIAL_WITHOUT_DEPTH=7]="TRANSPARENT_MATERIAL_WITHOUT_DEPTH",e[e.OCCLUDED_TERRAIN=8]="OCCLUDED_TERRAIN",e[e.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",e[e.HUD_MATERIAL=12]="HUD_MATERIAL",e[e.LABEL_MATERIAL=13]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=14]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=15]="LINE_CALLOUTS_HUD_DEPTH",e[e.DRAPED_MATERIAL=16]="DRAPED_MATERIAL",e[e.DRAPED_WATER=17]="DRAPED_WATER",e[e.VOXEL=18]="VOXEL",e[e.MAX_SLOTS=19]="MAX_SLOTS"}(ut||(ut={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"}(dt||(dt={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}(ht||(ht={}));class ft{constructor(e){this.field=e}}class mt extends ft{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[dt.Undefined,dt.Undefined,dt.Undefined]}}class gt extends ft{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0]}}class pt extends ft{constructor(e){super(e),this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}}class _t{}function vt(e){return null!=e}function Tt(e){return"number"==typeof e}function At(e){return"string"==typeof e}function Et(e,t,i,r,s){const n=e.minSize,a=e.maxSize;if(e.useSymbolValue){const e=r.symbolSize[i];return t.minSize[i]=e,t.maxSize[i]=e,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=dt.DefinedSize,!0}if(vt(e.field))return vt(e.stops)?!(2!==e.stops.length||!Tt(e.stops[0].size)||!Tt(e.stops[1].size)||(xt(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=dt.DefinedSize,0)):Tt(n)&&Tt(a)&&vt(e.minDataValue)&&vt(e.maxDataValue)?(xt(n,a,e.minDataValue,e.maxDataValue,t,i),t.type[i]=dt.DefinedSize,!0):"unknown"!==e.valueUnit&&null!=ue[e.valueUnit]&&(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/ue[e.valueUnit],t.type[i]=dt.DefinedSize,!0);if(!vt(e.field)){if(e.stops?.[0]&&Tt(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=dt.DefinedSize,!0;if(Tt(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=dt.DefinedSize,!0}return!1}function xt(e,t,i,r,s,n){const a=Math.abs(r-i)>0?(t-e)/(r-i):0;s.minSize[n]=a>0?e:t,s.maxSize[n]=a>0?t:e,s.offset[n]=e-i*a,s.factor[n]=a}function St(e,t,i){e[4*t]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function Ct(e,t,i){const r=2===i&&"arithmetic"===e.rotationType;t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}class bt{constructor(e,t=[1,1,1],i=[1,1,1],r=1,s=[0,0,0],n=[1,1,1],a=[0,0,0]){this.supports=e,this.modelSize=t,this.symbolSize=i,this.unitInMeters=r,this.anchor=s,this.scale=n,this.rotation=a}}function It(e,t,i){if(!e)return null;const r=e.reduce(((e,i)=>{if(!e)return e;if(i.valueExpression)return null;switch(i.type){case"size":return t.supports.size?function(e,t,i){if(e.normalizationField||e.valueRepresentation)return null;if(null!=(r=e.field)&&!At(r))return null;var r;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return null}else t.size.field=e.field}else t.size=new mt(e.field);let s;switch(e.axis){case"width":return s=Et(e,t.size,0,i),s?t:null;case"height":return s=Et(e,t.size,2,i),s?t:null;case"depth":return s=Et(e,t.size,1,i),s?t:null;case"width-and-depth":return s=Et(e,t.size,0,i),s&&Et(e,t.size,1,i),s?t:null;case null:case void 0:case"all":return s=Et(e,t.size,0,i),s=s&&Et(e,t.size,1,i),s=s&&Et(e,t.size,2,i),s?t:null;default:return e.axis,null}}(i,e,t):e;case"color":return t.supports.color?function(e,t){if(e.normalizationField)return null;if(At(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.color=new gt(e.field);const i=e.stops;for(let e=0;e<8;++e){const r=i[Math.min(e,i.length-1)];t.color.values[e]=r.value,St(t.color.colors,e,r.color)}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.color.values[e]=1/0,St(t.color.colors,e,i)}}return t}(i,e):e;case"opacity":return t.supports.opacity?function(e,t){if(e.normalizationField)return null;if(At(e.field)){if(!e.stops)return null;{if(e.stops.length>8)return null;t.opacity=new pt(e.field);const i=e.stops;for(let e=0;e<8;++e){const r=i[Math.min(e,i.length-1)];t.opacity.values[e]=r.value,t.opacity.opacityValues[e]=r.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const i=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=i}}return t}(i,e):null;case"rotation":return t.supports.rotation?function(e,t){if(!At(e.field))return null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return Ct(e,t.rotation,0),t;case"roll":return Ct(e,t.rotation,1),t;case null:case void 0:case"heading":return Ct(e,t.rotation,2),t;default:return e.axis,null}}(i,e):e;default:return null}}),new _t);return!(e.length>0&&r)||r.size||r.color||r.opacity||r.rotation?r?.size&&!function(e,t){for(let i=0;i<3;++i){let r=t.unitInMeters;e.type[i]===dt.DefinedSize&&(r*=t.modelSize[i],e.type[i]=dt.DefinedScale),e.minSize[i]=e.minSize[i]/r,e.maxSize[i]=e.maxSize[i]/r,e.offset[i]=e.offset[i]/r,e.factor[i]=e.factor[i]/r}let i;if(e.type[0]!==dt.Undefined)i=0;else if(e.type[1]!==dt.Undefined)i=1;else{if(e.type[2]===dt.Undefined)return!1;i=2}for(let t=0;t<3;++t)e.type[t]===dt.Undefined&&(e.minSize[t]=e.minSize[i],e.maxSize[t]=e.maxSize[i],e.offset[t]=e.offset[i],e.factor[t]=e.factor[i],e.type[t]=e.type[i]);return!0}(r.size,t)?null:r:null}class yt{constructor(e,t,i){this.visualVariables=e,this.materialParameters=t,this.requiresShaderTransformation=i}}function Pt(e,t){if(!e)return null;if(de.TESTS_DISABLE_FAST_UPDATES)return null;const i=It(e.visualVariables,t);return i?new yt(i,Lt(i,t),!!i.size):null}function Rt(e,t,i){if(!t||!e)return!1;const r=e.visualVariables,s=It(t.visualVariables,i);return!!s&&!!(wt(r.size,s.size,"size")&&wt(r.color,s.color,"color")&&wt(r.rotation,s.rotation,"rotation")&&wt(r.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=Lt(s,i),e.requiresShaderTransformation=!!s.size,!0)}function wt(e,t,i){if(!!e!=!!t)return!1;if(e&&e.field!==t?.field)return!1;if(e&&"rotation"===i){const i=e,r=t;for(let e=0;e<3;e++)if(i.type[e]!==r.type[e]||i.offset[e]!==r.offset[e]||i.factor[e]!==r.factor[e])return!1}return!0}class Mt extends se{constructor(e){super(),this.vvSize=e?.size??null,this.vvColor=e?.color??null,this.vvOpacity=e?.opacity??null}}function Lt(e,t){const i=new Mt(e);return i.vvSize&&(i.vvSymbolAnchor=t.anchor,q(Ft),function(e,t,i,r=o()){const s=e||0,n=t||0,a=i||0;0!==s&&Q(r,r,-s/180*Math.PI),0!==n&&Y(r,r,n/180*Math.PI),0!==a&&Z(r,r,a/180*Math.PI)}(t.rotation[2],t.rotation[0],t.rotation[1],Ft),i.vvSymbolRotationMatrix=i.vvSymbolRotationMatrix||ce(),le(i.vvSymbolRotationMatrix,Ft)),i}function Dt(e,t,i){if(!e.vvSize)return i;J(Nt,i);const r=e.vvSymbolRotationMatrix;ee(Ft,r[0],r[1],r[2],0,r[3],r[4],r[5],0,r[6],r[7],r[8],0,0,0,0,1),te(Nt,Nt,Ft);for(let i=0;i<3;++i){const r=e.vvSize.offset[i]+t[0]*e.vvSize.factor[i];zt[i]=oe(r,e.vvSize.minSize[i],e.vvSize.maxSize[i])}return ie(Nt,Nt,zt),re(Nt,Nt,e.vvSymbolAnchor),Nt}function Ot(e,t,i){if(!t.vvSize)return u(e,1,1,1),e;for(let r=0;r<3;++r){const s=t.vvSize.offset[r]+i[0]*t.vvSize.factor[r];e[r]=oe(s,t.vvSize.minSize[r],t.vvSize.maxSize[r])}return e}function Ut(e,t){const i=null==e?0:t.attributes[e];return"number"==typeof i&&isFinite(i)?i:0}const Nt=o(),zt=E(),Ft=o();class Ht extends Mt{constructor(){super(...arguments),this.renderOccluded=I.Occlude,this.isDecoration=!1}}const Bt=8;var Gt,Vt,jt;function $t(e,t){switch(t.textureCoordinateType){case Gt.Default:return e.attributes.add(O.UV0,"vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(ne`void forwardTextureCoordinates() {
vuv0 = uv0;
}`);case Gt.Compressed:return e.attributes.add(O.UV0,"vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(ne`vec2 getUV0() {
return uv0 / 16384.0;
}
void forwardTextureCoordinates() {
vuv0 = getUV0();
}`);case Gt.Atlas:return e.attributes.add(O.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.attributes.add(O.UVREGION,"vec4"),e.varyings.add("vuvRegion","vec4"),void e.vertex.code.add(ne`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:Be(t.textureCoordinateType);case Gt.None:return void e.vertex.code.add(ne`void forwardTextureCoordinates() {}`);case Gt.COUNT:return}}function kt(e){e.fragment.code.add(ne`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)}function Wt(e,t){const{textureCoordinateType:i}=t;if(i===Gt.None||i===Gt.COUNT)return;e.include($t,t);const r=i===Gt.Atlas;r&&e.include(kt),e.fragment.code.add(ne`
    vec4 textureLookup(sampler2D tex, vec2 uv) {
      return ${r?"textureAtlasLookup(tex, uv, vuvRegion)":"texture(tex, uv)"};
    }
  `)}!function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Atlas=2]="Atlas",e[e.Compressed=3]="Compressed",e[e.COUNT=4]="COUNT"}(Gt||(Gt={}));class Xt extends N{constructor(e,t){super(e,"sampler2D",K.Pass,((i,r,s)=>i.bindTexture(e,t(r,s))))}}function Kt(e,t){if(!z(t.output))return;const{emissionSource:i,hasEmissiveTextureTransform:r,bindType:s}=t,n=i===Vt.Texture;n&&(e.include(Wt,t),e.fragment.uniforms.add(s===K.Pass?new Xt("texEmission",(e=>e.textureEmissive)):new F("texEmission",(e=>e.textureEmissive))));const a=i===Vt.Value||n;a&&e.fragment.uniforms.add(s===K.Pass?new H("emissionFactor",(e=>e.emissiveFactor)):new B("emissionFactor",(e=>e.emissiveFactor))),e.fragment.code.add(ne`
    vec4 getEmissions() {
      vec4 emissions = ${a?"vec4(emissionFactor, 1.0)":"vec4(0.0)"};
      ${ae(n,`emissions *= textureLookup(texEmission, ${r?"emissiveUV":"vuv0"});\n         emissions.w = emissions.rgb == vec3(0.0) ? 0.0: emissions.w;`)};
      return emissions;
    }
  `)}!function(e){e[e.None=0]="None",e[e.Value=1]="Value",e[e.Texture=2]="Texture",e[e.COUNT=3]="COUNT"}(Vt||(Vt={}));class qt extends X{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}}U([W()],qt.prototype,"instancedDoublePrecision",void 0),U([W()],qt.prototype,"hasModelTransformation",void 0),function(e){e[e.NONE=0]="NONE",e[e.ColorAlpha=1]="ColorAlpha",e[e.FrontFace=2]="FrontFace",e[e.COUNT=3]="COUNT"}(jt||(jt={}));class Qt extends qt{constructor(){super(...arguments),this.output=G.Color,this.oitPass=jt.NONE,this.hasSliceHighlight=!0,this.hasSliceInVertexProgram=!1,this.bindType=K.Pass,this.writeDepth=!0}}U([W({count:G.COUNT})],Qt.prototype,"output",void 0),U([W({count:jt.COUNT})],Qt.prototype,"oitPass",void 0);class Yt extends se{constructor(e){super(),this.slicePlaneLocalOrigin=e}}function Zt(e,t){ei(e,t,new H("slicePlaneOrigin",((e,i)=>si(t,e,i))),new H("slicePlaneBasis1",((e,i)=>ni(t,e,i,i.slicePlane?.basis1))),new H("slicePlaneBasis2",((e,i)=>ni(t,e,i,i.slicePlane?.basis2))))}function Jt(e,t){ei(e,t,new B("slicePlaneOrigin",((e,i)=>si(t,e,i))),new B("slicePlaneBasis1",((e,i)=>ni(t,e,i,i.slicePlane?.basis1))),new B("slicePlaneBasis2",((e,i)=>ni(t,e,i,i.slicePlane?.basis2))))}function ei(e,t,...i){if(!t.hasSlicePlane){const i=ne`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;return t.hasSliceInVertexProgram&&e.vertex.code.add(i),void e.fragment.code.add(i)}const r=ne`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,s=ne`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
if (sliceByFactors(factors)) {
return color;
}
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,n=t.hasSliceHighlight?ne`
        ${s}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `:ne`#define highlightSlice(_color_, _pos_) (_color_)`;t.hasSliceInVertexProgram&&e.vertex.uniforms.add(...i).code.add(r),e.fragment.uniforms.add(...i).code.add(r),e.fragment.code.add(n)}function ti(e,t,i){return e.instancedDoublePrecision?u(ai,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function ii(e,t){return null!=e?g(oi,t.origin,e):t.origin}function ri(e,t,i){return e.hasSliceTranslatedView?null!=t?re(ci,i.camera.viewMatrix,t):i.camera.viewMatrix:null}function si(e,t,i){if(null==i.slicePlane)return x;const r=ti(e,t,i),s=ii(r,i.slicePlane),n=ri(e,r,i);return null!=n?m(oi,s,n):s}function ni(e,t,i,r){if(null==r||null==i.slicePlane)return x;const s=ti(e,t,i),n=ii(s,i.slicePlane),a=ri(e,s,i);return null!=a?(d(li,r,n),m(oi,n,a),m(li,li,a),g(li,li,oi)):r}const ai=E(),oi=E(),li=E(),ci=o();function ui(e,t){if(t.output!==G.ObjectAndLayerIdColor)return e.vertex.code.add(ne`void forwardObjectAndLayerIdColor() {}`),void e.fragment.code.add(ne`void outputObjectAndLayerIdColor() {}`);const i=t.objectAndLayerIdColorInstanced;e.varyings.add("objectAndLayerIdColorVarying","vec4"),e.attributes.add(i?O.INSTANCEOBJECTANDLAYERIDCOLOR:O.OBJECTANDLAYERIDCOLOR,"vec4"),e.vertex.code.add(ne`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${i?"instanceObjectAndLayerIdColor":"objectAndLayerIdColor"} * 0.003921568627451;
    }`),e.fragment.code.add(ne`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)}class di extends N{constructor(e,t,i){super(e,"vec4",K.Pass,((i,r,s)=>i.setUniform4fv(e,t(r,s))),i)}}class hi extends N{constructor(e,t,i){super(e,"float",K.Pass,((i,r,s)=>i.setUniform1fv(e,t(r,s))),i)}}function fi(e,t){const{vertex:i,attributes:r}=e;t.hasVvInstancing&&(t.vvSize||t.vvColor)&&r.add(O.INSTANCEFEATUREATTRIBUTE,"vec4"),t.vvSize?(i.uniforms.add(new H("vvSizeMinSize",(e=>e.vvSize.minSize))),i.uniforms.add(new H("vvSizeMaxSize",(e=>e.vvSize.maxSize))),i.uniforms.add(new H("vvSizeOffset",(e=>e.vvSize.offset))),i.uniforms.add(new H("vvSizeFactor",(e=>e.vvSize.factor))),i.uniforms.add(new V("vvSymbolRotationMatrix",(e=>e.vvSymbolRotationMatrix))),i.uniforms.add(new H("vvSymbolAnchor",(e=>e.vvSymbolAnchor))),i.code.add(ne`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),i.code.add(ne`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${t.hasVvInstancing?ne`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):i.code.add(ne`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vvColor?(i.constants.add("vvColorNumber","int",8),i.uniforms.add(new hi("vvColorValues",(e=>e.vvColor.values),8),new di("vvColorColors",(e=>e.vvColor.colors),8)),i.code.add(ne`
      vec4 interpolateVVColor(float value) {
        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${t.hasVvInstancing?ne`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }`:"vec4 vvColor() { return vec4(1.0); }"}
    `)):i.code.add(ne`vec4 vvColor() { return vec4(1.0); }`)}class mi extends N{constructor(e,t){super(e,"mat4",K.Draw,((i,r,s)=>i.setUniformMatrix4fv(e,t(r,s))))}}function gi(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",x):e.uniforms.add(new B("cameraPosition",((e,t)=>u(vi,t.camera.viewInverseTransposeMatrix[3]-e.origin[0],t.camera.viewInverseTransposeMatrix[7]-e.origin[1],t.camera.viewInverseTransposeMatrix[11]-e.origin[2]))))}function pi(e,t){if(!t.instancedDoublePrecision)return void e.uniforms.add(new j("proj",((e,t)=>t.camera.projectionMatrix)),new mi("view",((e,t)=>re(_i,t.camera.viewMatrix,e.origin))),new B("localOrigin",(e=>e.origin)));const i=e=>u(vi,e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]);e.uniforms.add(new j("proj",((e,t)=>t.camera.projectionMatrix)),new j("view",((e,t)=>re(_i,t.camera.viewMatrix,i(t)))),new H("localOrigin",((e,t)=>i(t))))}const _i=o(),vi=E();function Ti(e){e.uniforms.add(new j("viewNormal",((e,t)=>t.camera.viewInverseTransposeMatrix)))}function Ai(e){e.uniforms.add(new $("pixelRatio",((e,t)=>t.camera.pixelRatio/t.overlayStretch)))}class Ei extends N{constructor(e,t){super(e,"vec4",K.Pass,((i,r,s)=>i.setUniform4fv(e,t(r,s))))}}let xi;var Si;!function(e){e[e.ETC1_RGB=0]="ETC1_RGB",e[e.ETC2_RGBA=1]="ETC2_RGBA",e[e.BC1_RGB=2]="BC1_RGB",e[e.BC3_RGBA=3]="BC3_RGBA",e[e.BC4_R=4]="BC4_R",e[e.BC5_RG=5]="BC5_RG",e[e.BC7_M6_RGB=6]="BC7_M6_RGB",e[e.BC7_M5_RGBA=7]="BC7_M5_RGBA",e[e.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",e[e.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",e[e.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",e[e.ATC_RGB=11]="ATC_RGB",e[e.ATC_RGBA=12]="ATC_RGBA",e[e.FXT1_RGB=17]="FXT1_RGB",e[e.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",e[e.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",e[e.ETC2_EAC_R11=20]="ETC2_EAC_R11",e[e.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",e[e.RGBA32=13]="RGBA32",e[e.RGB565=14]="RGB565",e[e.BGR565=15]="BGR565",e[e.RGBA4444=16]="RGBA4444"}(Si||(Si={}));let Ci=null,bi=null;async function Ii(){return null==bi&&(xi??=(async()=>{const e=await import("./basis_transcoder.js"),t=await e.default({locateFile:e=>Se(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t})(),bi=xi,Ci=await bi),bi}function yi(e,t,i,r,s){const n=Oe(t?Ce.COMPRESSED_RGBA8_ETC2_EAC:Ce.COMPRESSED_RGB8_ETC2),a=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*r*n*a)}function Pi(e){return e.getNumImages()>=1&&!e.isUASTC()}function Ri(e){return e.getFaces()>=1&&e.isETC1S()}function wi(e,t,i,r,s,n,a,o){const{compressedTextureETC:l,compressedTextureS3TC:c}=e.capabilities,[u,d]=l?r?[Si.ETC2_RGBA,Ce.COMPRESSED_RGBA8_ETC2_EAC]:[Si.ETC1_RGB,Ce.COMPRESSED_RGB8_ETC2]:c?r?[Si.BC3_RGBA,Ce.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[Si.BC1_RGB,Ce.COMPRESSED_RGB_S3TC_DXT1_EXT]:[Si.RGBA32,be.RGBA],h=t.hasMipmap?i:Math.min(1,i),f=[];for(let e=0;e<h;e++)f.push(new Uint8Array(a(e,u))),o(e,u,f[e]);return t.internalFormat=d,t.hasMipmap=f.length>1,t.samplingMode=t.hasMipmap?Ie.LINEAR_MIPMAP_LINEAR:Ie.LINEAR,t.width=s,t.height=n,new De(e,t,{type:"compressed",levels:f})}const Mi=()=>ze.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function Li(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const Di=Li("DXT1"),Oi=Li("DXT3"),Ui=Li("DXT5");function Ni(e){return 16*Math.ceil(e/16)}function zi(e){return 16*Math.floor(e/16)}function Fi(e,t){let i=e.width*e.height;if(i<4096)return e instanceof ImageData?Bi(e):e;let r=e.width,s=e.height;do{r=Math.ceil(r/2),s=Math.ceil(s/2),i=r*s}while(i>1048576||null!=t&&(r>t||s>t));return Hi(e,r,s)}function Hi(e,t,i){if(e instanceof ImageData)return Hi(Bi(e),t,i);const r=document.createElement("canvas");return r.width=t,r.height=i,r.getContext("2d").drawImage(e,0,0,r.width,r.height),r}function Bi(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");if(null==i)throw new he("Failed to create 2d context from HTMLCanvasElement");return i.putImageData(e,0,0),t}class Gi extends C{get parameters(){return this._parameters}constructor(e,t){super(),this._data=e,this.type=b.Texture,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this.events=new fe,this._parameters={...$i,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(e){null!=e&&(e instanceof HTMLVideoElement?(this.frameUpdate=t=>this._frameUpdate(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(Te(e.src)||"auto"===e.preload&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const t=!e.paused;if(e.src=e.src,t&&e.autoplay){const t=()=>{e.removeEventListener("canplay",t),e.play()};e.addEventListener("canplay",t)}}}_startPreloadImageElement(e){Ae(e.src)||Te(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new Ue;return t.wrapMode=this._parameters.wrap??ye.REPEAT,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?Ie.LINEAR_MIPMAP_LINEAR:Ie.LINEAR,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.usedMemory||function(e,t){if(null==e)return 0;if(s(e)||r(e))return t.encoding===L.KTX2_ENCODING?function(e,t){if(null==Ci)return e.byteLength;const i=new Ci.KTX2File(new Uint8Array(e)),r=Ri(i)?yi(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),t):0;return i.close(),i.delete(),r}(e,!!t.mipmap):t.encoding===L.BASIS_ENCODING?function(e,t){if(null==Ci)return e.byteLength;const i=new Ci.BasisFile(new Uint8Array(e)),r=Pi(i)?yi(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),t):0;return i.close(),i.delete(),r}(e,!!t.mipmap):e.byteLength;const{width:i,height:n}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?Vi(e):t;return(t.mipmap?4/3:1)*i*n*(t.components||4)||0}(this._data,this._parameters)}load(e){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;const t=this._data;return null==t?(this._glTexture=new De(e,this._createDescriptor(e),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),"string"==typeof t?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):r(t)&&this._parameters.encoding===L.DDS_ENCODING?this._loadFromDDSData(e,t):s(t)&&this._parameters.encoding===L.DDS_ENCODING?this._loadFromDDSData(e,new Uint8Array(t)):(s(t)||r(t))&&this._parameters.encoding===L.KTX2_ENCODING?this._loadFromKTX2(e,t):(s(t)||r(t))&&this._parameters.encoding===L.BASIS_ENCODING?this._loadFromBasis(e,t):r(t)?this._loadFromPixelData(e,t):s(t)?this._loadFromPixelData(e,new Uint8Array(t)):null)}_frameUpdate(e,t){return null==this._glTexture||e.readyState<ji.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=function(e,t,i){const r=function(e,t){const i=new Int32Array(e.buffer,e.byteOffset,31);if(542327876!==i[0])return Mi().error("Invalid magic number in DDS header"),null;if(!(4&i[20]))return Mi().error("Unsupported format, must contain a FourCC code"),null;const r=i[21];let s,n;switch(r){case Di:s=8,n=Ce.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Oi:s=16,n=Ce.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Ui:s=16,n=Ce.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return Mi().error("Unsupported FourCC code:",(a=r,String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255))),null}var a;let o=1,l=i[4],c=i[3];(3&l||3&c)&&(Mi().warn("Rounding up compressed texture size to nearest multiple of 4."),l=l+3&-4,c=c+3&-4);const u=l,d=c;131072&i[2]&&!1!==t&&(o=Math.max(1,i[7]));let h,f,m=e.byteOffset+i[1]+4;const g=[];for(let t=0;t<o;++t)f=(l+3>>2)*(c+3>>2)*s,h=new Uint8Array(e.buffer,m,f),g.push(h),m+=f,l=Math.max(1,l>>1),c=Math.max(1,c>>1);return{textureData:{type:"compressed",levels:g},internalFormat:n,width:u,height:d}}(i,t.hasMipmap??!1);if(null==r)throw new Error("DDS texture data is null");const{textureData:s,internalFormat:n,width:a,height:o}=r;return t.samplingMode=s.levels.length>1?Ie.LINEAR_MIPMAP_LINEAR:Ie.LINEAR,t.hasMipmap=s.levels.length>1,t.internalFormat=n,t.width=a,t.height=o,new De(e,t,s)}(e,this._createDescriptor(e),t),this._glTexture}_loadFromKTX2(e,t){return this._loadAsync((()=>async function(e,t,i){null==Ci&&(Ci=await Ii());const r=new Ci.KTX2File(new Uint8Array(i));if(!Ri(r))return null;r.startTranscoding();const s=wi(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),((e,t)=>r.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,i)=>r.transcodeImage(i,e,0,0,t,0,-1,-1)));return r.close(),r.delete(),s}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromBasis(e,t){return this._loadAsync((()=>async function(e,t,i){null==Ci&&(Ci=await Ii());const r=new Ci.BasisFile(new Uint8Array(i));if(!Pi(r))return null;r.startTranscoding();const s=wi(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),((e,t)=>r.getImageTranscodedSizeInBytes(0,e,t)),((e,t,i)=>r.transcodeImage(i,0,e,t,0,0)));return r.close(),r.delete(),s}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromPixelData(e,t){S(this._parameters.width>0&&this._parameters.height>0);const i=this._createDescriptor(e);return i.pixelFormat=1===this._parameters.components?be.LUMINANCE:3===this._parameters.components?be.RGB:be.RGBA,i.width=this._parameters.width??0,i.height=this._parameters.height??0,this._glTexture=new De(e,i,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync((async i=>{const r=await Ee(t,{signal:i});return pe(i),this._loadFromImage(e,r)}))}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync((async i=>{const r=await xe(t,t.src,!1,i);return pe(i),this._loadFromImage(e,r)}))}_loadFromVideoElement(e,t){return t.readyState>=ji.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync((i=>new Promise(((r,s)=>{const n=()=>{t.removeEventListener("loadeddata",a),t.removeEventListener("error",o),ge(l)},a=()=>{t.readyState>=ji.HAVE_CURRENT_DATA&&(n(),r(this._loadFromImage(e,t)))},o=e=>{n(),s(e||new he("Failed to load video"))};t.addEventListener("loadeddata",a),t.addEventListener("error",o);const l=_e(i,(()=>o(ve())))}))))}_loadFromImage(e,t){let i=t;if(!(i instanceof HTMLVideoElement)){const{maxTextureSize:t}=e.parameters;i=this._parameters.downsampleUncompressed?Fi(i,t):function(e,t){const i=Math.max(e.width,e.height);if(i<=t)return e;const r=t/i;return Hi(e,Math.round(e.width*r),Math.round(e.height*r))}(i,t)}const r=Vi(i);this._parameters.width=r.width,this._parameters.height=r.height;const s=this._createDescriptor(e);return s.pixelFormat=3===this._parameters.components?be.RGB:be.RGBA,s.width=r.width,s.height=r.height,this._glTexture=new De(e,s,i),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const i=e(t.signal);this._loadingPromise=i;const r=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===i&&(this._loadingPromise=null)};return i.then(r,r),i}unload(){if(this._glTexture=me(this._glTexture),null!=this._loadingController){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}}function Vi(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}var ji;!function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(ji||(ji={}));const $i={wrap:{s:ye.REPEAT,t:ye.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1};function ki(e){const t=3.141592653589793,i=.3183098861837907;e.vertex.constants.add("PI","float",t),e.fragment.constants.add("PI","float",t),e.fragment.constants.add("LIGHT_NORMALIZATION","float",i),e.fragment.constants.add("INV_PI","float",i),e.fragment.constants.add("HALF_PI","float",1.570796326794897),e.fragment.constants.add("TWO_PI","float",6.28318530717958)}class Wi extends N{constructor(e,t){super(e,"vec2",K.Pass,((i,r,s)=>i.setUniform2fv(e,t(r,s))))}}function Xi(e){e.uniforms.add(new Wi("zProjectionMap",((e,t)=>function(e){const t=e.projectionMatrix;return Fe(Ki,t[14],t[10])}(t.camera)))),e.code.add(ne`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),e.code.add(ne`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),e.code.add(ne`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}const Ki=He();function qi(e,{occlusionPass:t,terrainDepthTest:i,cullAboveTerrain:r}){i?(e.fragment.include(Xi),e.fragment.uniforms.add(new Xt("terrainDepthTexture",((e,t)=>t.terrainDepth?.attachment))).code.add(ne`
   ${t?"bool":"void"} terrainDepthTest(float fragmentDepth) {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${t?ne`return fragmentDepth < linearDepth && depth < 1.0;`:ne`if(fragmentDepth ${r?">":"<="} linearDepth) discard;`}
    }`)):t?e.fragment.code.add(ne`#define terrainDepthTest(fragmentDepth) false`):e.fragment.code.add(ne`#define terrainDepthTest(fragmentDepth) {}`)}function Qi(e){e.code.add(ne`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}class Yi{constructor(){this._includedModules=new Map}include(e,t){this._includedModules.has(e)?this._includedModules.get(e):(this._includedModules.set(e,t),e(this.builder,t))}}class Zi extends Yi{constructor(){super(...arguments),this.vertex=new ir,this.fragment=new ir,this.attributes=new rr,this.varyings=new sr,this.extensions=new nr,this.outputs=new ar}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e){const t=this.extensions.generateSource(e),i=this.attributes.generateSource(e),r=this.varyings.generateSource(e),s="vertex"===e?this.vertex:this.fragment,n=s.uniforms.generateSource(),a=s.code.generateSource(),o=s.main.generateSource(),l="vertex"===e?cr:lr,c=s.constants.generateSource(),u=this.outputs.generateSource(e);return`#version 300 es\n${t.join("\n")}\n\n${l}\n\n${c.join("\n")}\n\n${n.join("\n")}\n\n${i.join("\n")}\n\n${r.join("\n")}\n\n${u.join("\n")}\n\n${a.join("\n")}\n\n${o.join("\n")}`}generateBindPass(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const i=e.bind[K.Pass];i&&t.set(e.name,i)})),this.fragment.uniforms.entries.forEach((e=>{const i=e.bind[K.Pass];i&&t.set(e.name,i)}));const i=Array.from(t.values()),r=i.length;return(t,s)=>{for(let n=0;n<r;++n)i[n](e,t,s)}}generateBindDraw(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const i=e.bind[K.Draw];i&&t.set(e.name,i)})),this.fragment.uniforms.entries.forEach((e=>{const i=e.bind[K.Draw];i&&t.set(e.name,i)}));const i=Array.from(t.values()),r=i.length;return(t,s,n)=>{for(let a=0;a<r;++a)i[a](e,n,t,s)}}}class Ji{constructor(e){this._stage=e,this._entries=new Map}add(...e){for(const t of e)this._add(t);return this._stage}get(e){return this._entries.get(e)}_add(e){if(null!=e){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new he(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else ze.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder").error(`Trying to add null Uniform from ${(new Error).stack}.`)}generateSource(){return Array.from(this._entries.values()).map((e=>null!=e.arraySize?`uniform ${e.type} ${e.name}[${e.arraySize}];`:`uniform ${e.type} ${e.name};`))}get entries(){return Array.from(this._entries.values())}}class er{constructor(e){this._stage=e,this._bodies=new Array}add(e){return this._bodies.push(e),this._stage}generateSource(){if(this._bodies.length>0)return[`void main() {\n ${this._bodies.join("\n")||""} \n}`];throw new he("Shader does not contain main function body.")}}class tr{constructor(e){this._stage=e,this._entries=new Array}add(e){return this._entries.push(e),this._stage}generateSource(){return this._entries}}class ir extends Yi{constructor(){super(...arguments),this.uniforms=new Ji(this),this.main=new er(this),this.code=new tr(this),this.constants=new or(this)}get builder(){return this}}class rr{constructor(){this._entries=new Array}add(e,t){this._entries.push([e,t])}generateSource(e){return"fragment"===e?[]:this._entries.map((e=>`in ${e[1]} ${e[0]};`))}}class sr{constructor(){this._entries=new Map}add(e,t){this._entries.has(e)&&S(this._entries.get(e)===t),this._entries.set(e,t)}generateSource(e){const t=new Array;return this._entries.forEach(((i,r)=>t.push("vertex"===e?`out ${i} ${r};`:`in ${i} ${r};`))),t}}class nr{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const t="vertex"===e?nr.ALLOWLIST_VERTEX:nr.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((e=>t.includes(e))).map((e=>`#extension ${e} : enable`))}}nr.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],nr.ALLOWLIST_VERTEX=[];class ar{constructor(){this._entries=new Map}add(e,t,i=0){const r=this._entries.get(i);r?S(r.name===e&&r.type===t,`Fragment shader output location ${i} occupied`):this._entries.set(i,{name:e,type:t})}generateSource(e){if("vertex"===e)return[];0===this._entries.size&&this._entries.set(0,{name:ar.DEFAULT_NAME,type:ar.DEFAULT_TYPE});const t=new Array;return this._entries.forEach(((e,i)=>t.push(`layout(location = ${i}) out ${e.type} ${e.name};`))),t}}ar.DEFAULT_TYPE="vec4",ar.DEFAULT_NAME="fragColor";class or{constructor(e){this._stage=e,this._entries=new Set}add(e,t,i){let r="ERROR_CONSTRUCTOR_STRING";switch(t){case"float":r=or._numberToFloatStr(i);break;case"int":r=or._numberToIntStr(i);break;case"bool":r=i.toString();break;case"vec2":r=`vec2(${or._numberToFloatStr(i[0])},                            ${or._numberToFloatStr(i[1])})`;break;case"vec3":r=`vec3(${or._numberToFloatStr(i[0])},                            ${or._numberToFloatStr(i[1])},                            ${or._numberToFloatStr(i[2])})`;break;case"vec4":r=`vec4(${or._numberToFloatStr(i[0])},                            ${or._numberToFloatStr(i[1])},                            ${or._numberToFloatStr(i[2])},                            ${or._numberToFloatStr(i[3])})`;break;case"ivec2":r=`ivec2(${or._numberToIntStr(i[0])},                             ${or._numberToIntStr(i[1])})`;break;case"ivec3":r=`ivec3(${or._numberToIntStr(i[0])},                             ${or._numberToIntStr(i[1])},                             ${or._numberToIntStr(i[2])})`;break;case"ivec4":r=`ivec4(${or._numberToIntStr(i[0])},                             ${or._numberToIntStr(i[1])},                             ${or._numberToIntStr(i[2])},                             ${or._numberToIntStr(i[3])})`;break;case"mat2":case"mat3":case"mat4":r=`${t}(${Array.prototype.map.call(i,(e=>or._numberToFloatStr(e))).join(", ")})`}return this._entries.add(`const ${t} ${e} = ${r};`),this._stage}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}const lr="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif",cr="precision highp float;\nprecision highp sampler2D;";class ur extends N{constructor(e,t){super(e,"ivec2",K.Pass,((i,r,s)=>i.setUniform2iv(e,t(r,s))))}}class dr extends N{constructor(e,t){super(e,"int",K.Pass,((i,r,s)=>i.setUniform1i(e,t(r,s))))}}function hr(e,t){const{fragment:i}=e;t.output===G.Highlight?(i.uniforms.add(new Xt("depthTexture",((e,t)=>t.mainDepth)),new Xt("highlightTexture",((e,t)=>t.highlightMixTexture)),new dr("highlightLevel",((e,t)=>t.highlightLevel)),new ur("highlightMixOrigin",((e,t)=>t.highlightMixOrigin))),e.outputs.add("fragHighlight","vec2",0),i.code.add(ne`vec2 getAccumulatedHighlight() {
return texelFetch(highlightTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = vec2(float(bits) / 255.0, 0.0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
vec2 combinedHighlight = getAccumulatedHighlight();
uint accumulatedI = uint(combinedHighlight[li] * 255.0);
combinedHighlight[li] = float(bits | accumulatedI) / 255.0;
fragHighlight = combinedHighlight;
}
}
bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}
void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`),t.canHaveOverlay&&(i.constants.add("occlusionAndMask","int",85),i.code.add(ne`void outputAllHighlights(vec2 highlightToAdd) {
if (highlightToAdd == vec2(0.0)) { discard; }
int occludedOrMask = isHighlightOccluded() ? 0xaa : 0;
ivec2 added = ivec2(highlightToAdd * 255.0);
ivec2 masked = (added & ivec2(occlusionAndMask)) | (ivec2(occludedOrMask) & (added<<1));
fragHighlight = vec2(masked) / 255.0;
}`))):i.code.add(ne`void calculateOcclusionAndOutputHighlight() {}`)}function fr(e,t){e.include(hr,t),e.include(Kt,t),e.fragment.include(Qi);const i=t.output===G.ObjectAndLayerIdColor,r=k(t.output),s=z(t.output)&&t.oitPass===jt.ColorAlpha,n=z(t.output)&&t.oitPass!==jt.ColorAlpha,a=t.discardInvisibleFragments;let o=0;(n||r||s)&&e.outputs.add("fragColor","vec4",o++),r&&e.outputs.add("fragEmission","vec4",o++),s&&e.outputs.add("fragAlpha","float",o++),e.fragment.code.add(ne`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition) {
      ${ae(i,ne`finalColor.a = 1.0;`)}

      ${ae(a,ne`if (finalColor.a < ${ne.float(Ge)}){
              discard;
              return;
            }`)}

      finalColor = highlightSlice(finalColor, vWorldPosition);
      ${ae(s,ne`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${ae(n,"fragColor = finalColor;")}
      ${ae(r,"fragEmission = getEmissions();")}
      calculateOcclusionAndOutputHighlight();
      ${ae(i,"outputObjectAndLayerIdColor();")}
    }
  `)}class mr{constructor(e,t){this._module=e,this._load=t}get(){return this._module}async reload(){return this._module=await this._load(),this._module}}class gr{constructor(e,t,i){this._context=e,this._locations=i,this._textures=new Map,this._freeTextureUnits=new v({deallocator:null}),this._glProgram=e.programCache.acquire(t.generate("vertex"),t.generate("fragment"),i),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this),this._fragmentUniforms=Ne()?t.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t){this._glProgram.setUniform1f(e,t)}setUniform2fv(e,t){this._glProgram.setUniform2fv(e,t)}setUniform3fv(e,t){this._glProgram.setUniform3fv(e,t)}setUniform4fv(e,t){this._glProgram.setUniform4fv(e,t)}setUniformMatrix3fv(e,t){this._glProgram.setUniformMatrix3fv(e,t)}setUniformMatrix4fv(e,t){this._glProgram.setUniformMatrix4fv(e,t)}setUniform1fv(e,t){this._glProgram.setUniform1fv(e,t)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(e,t){if(null==t?.glName){const t=this._textures.get(e);return t&&(this._context.bindTexture(null,t.unit),this._freeTextureUnit(t),this._textures.delete(e)),null}let i=this._textures.get(e);return null==i?(i=this._allocTextureUnit(t),this._textures.set(e,i)):i.texture=t,this._context.useProgram(this),this.setUniform1i(e,i.unit),this._context.bindTexture(t,i.unit),i.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach(((e,t)=>{this._context.bindTexture(e.texture,e.unit),this.setUniform1i(t,e.unit)})),this._fragmentUniforms?.forEach((e=>{"sampler2D"!==e.type&&"samplerCube"!==e.type||this._textures.has(e.name)||console.error(`Texture sampler ${e.name} has no bound texture`)}))}_allocTextureUnit(e){return{texture:e,unit:0===this._freeTextureUnits.length?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(e){this._freeTextureUnits.push(e.unit)}}class pr{constructor(e,t,i,r,s=y){this.release=r,this.locations=s,this.primitiveType=Pe.TRIANGLES,this.key=t.key,this._program=new gr(e.rctx,i.get().build(t),s),this._pipeline=this.initializePipeline(t),this.reload=async r=>{if(r&&await i.reload(),!this.key.equals(t.key))throw new Error("Configuration was changed after construction, cannot reload shader");me(this._program),this._program=new gr(e.rctx,i.get().build(t),s),this._pipeline=this.initializePipeline(t)}}destroy(){this._program=me(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,t){return this._pipeline}initializePipeline(e){return Ve({blending:je,colorWrite:$e})}}const _r=ke(Re.ONE,Re.ZERO,Re.ONE,Re.ONE_MINUS_SRC_ALPHA);function vr(e){return e===jt.FrontFace?null:_r}function Tr(e){switch(e){case jt.NONE:return We;case jt.ColorAlpha:return _r;case jt.FrontFace:case jt.COUNT:return null}}function Ar(e){if(e.draped)return null;switch(e.oitPass){case jt.NONE:case jt.FrontFace:return e.writeDepth?Xe:null;case jt.ColorAlpha:case jt.COUNT:return null}}const Er=5e5,xr={factor:-1,units:-2};function Sr(e){return e?xr:null}function Cr(e,t=we.LESS){return e===jt.NONE||e===jt.FrontFace?t:we.LEQUAL}function br(e,t){const i=k(t);return e===jt.ColorAlpha?i?{buffers:[Me.COLOR_ATTACHMENT0,Me.COLOR_ATTACHMENT1,Me.COLOR_ATTACHMENT2]}:{buffers:[Me.COLOR_ATTACHMENT0,Me.COLOR_ATTACHMENT1]}:i?{buffers:[Me.COLOR_ATTACHMENT0,Me.COLOR_ATTACHMENT1]}:null}const Ir={func:we.LESS},yr={func:we.ALWAYS},Pr={mask:255},Rr={mask:0},wr=e=>({function:{func:we.NOTEQUAL,ref:e,mask:e},operation:{fail:Le.KEEP,zFail:Le.KEEP,zPass:Le.KEEP}}),Mr=e=>({function:{func:we.ALWAYS,ref:e,mask:e},operation:{fail:Le.KEEP,zFail:Le.KEEP,zPass:Le.REPLACE}}),Lr={function:{func:we.ALWAYS,ref:D.OutlineVisualElementMask,mask:D.OutlineVisualElementMask},operation:{fail:Le.KEEP,zFail:Le.KEEP,zPass:Le.ZERO}},Dr={function:{func:we.ALWAYS,ref:D.OutlineVisualElementMask,mask:D.OutlineVisualElementMask},operation:{fail:Le.KEEP,zFail:Le.KEEP,zPass:Le.REPLACE}},Or={function:{func:we.EQUAL,ref:D.OutlineVisualElementMask,mask:D.OutlineVisualElementMask},operation:{fail:Le.KEEP,zFail:Le.KEEP,zPass:Le.KEEP}},Ur={function:{func:we.NOTEQUAL,ref:D.OutlineVisualElementMask,mask:D.OutlineVisualElementMask},operation:{fail:Le.KEEP,zFail:Le.KEEP,zPass:Le.KEEP}};export{Fi as $,Ir as A,fi as B,Qi as C,ui as D,jt as E,Ei as F,lt as G,Sr as H,Qt as I,Gt as J,Vt as K,Er as L,vr as M,Ni as N,hr as O,dr as P,Ot as Q,Xi as R,Zi as S,Gi as T,xr as U,Ht as V,Wt as W,ki as X,qe as Y,Yt as Z,mi as _,ct as a,Ii as a0,Ze as a1,Qe as a2,hi as a3,it as a4,tt as a5,zi as a6,kt as a7,Ut as a8,$t as a9,ur as aa,Pt as ab,Rt as ac,bt as ad,Dt as ae,et as af,Bt as ag,di as ah,wr as ai,Zt as aj,Mr as ak,Wi as b,gi as c,pi as d,Ti as e,Je as f,Ai as g,Xt as h,ut as i,Jt as j,pr as k,mr as l,Tr as m,Ye as n,fr as o,Cr as p,Ar as q,br as r,Pr as s,qi as t,Dr as u,Lr as v,yr as w,Ur as x,Rr as y,Or as z};
