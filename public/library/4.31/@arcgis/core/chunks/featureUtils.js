/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{h as e}from"../core/lang.js";import{r as t,L as n}from"./Logger.js";import{c as r,g as i,f as a}from"./date.js";import{f as o,c as l}from"./number.js";import{featureHasFields as s,isTimeOnlyField as u,l as f,isRasterPixelValueField as c}from"../layers/support/fieldUtils.js";import{g as d}from"./layerUtils.js";import{i as p,f as y}from"./utils3.js";const m=()=>n.getLogger("esri.widgets.Feature.support.featureUtils"),g=/href=(""|'')/gi,b=/(\{([^{\r\n]+)\})/g,h=/'/g,I=/^\s*expression\//i,w=/(\n)/gi,T=/[\u00A0-\u9999<>&]/gim,F=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,N=/^(?:mailto:|tel:)/,j="relationships/",L=r("short-date-short-time");function Z(e){if(null!=e)return(e.sourceLayer||e.layer)??void 0}async function v({type:e,value:t,event:n}){try{return"function"==typeof t?t(n):await t}catch(r){return void m().error("error",`An error occurred when calling the "${e}" function`,{error:r,graphic:n.graphic,value:t})}}function x(e=""){if(e)return!N.test(e.trim().toLowerCase())}function E(e){return!!e&&I.test(e)}function q(e,t){const n=function(e,t){if(!t||!E(t)||!e)return;const n=t.replace(I,"").toLowerCase();return e.find((({name:e})=>e.toLowerCase()===n))}(t,e?.fieldName);return n?n.title||null:e?e.label||e.fieldName:null}function A(e,t){const n=U(t,e);return n?n.name:e}function C(e,t){return e&&e.map((e=>A(e,t)))}function U(e,t){return e&&"function"==typeof e.getField&&t?e.getField(t)??null:null}function M(e){return`${e}`.trim()}function R({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:i,fieldInfoMap:a}){return r?k({formattedAttributes:t,template:D(r,{...t,...i,...e},n),fieldInfoMap:a}):""}function k({formattedAttributes:e,template:n,fieldInfoMap:r}){return M((i=t(t(n,(e=>function(e,t){const n=t.get(e.toLowerCase());return`{${n?.fieldName||e}}`}(e,r))),e),i.replaceAll(g,"")));var i}function $(e,t){return e.replaceAll(b,((e,n,r)=>{const i=U(t,r);return i?`{${i.name}}`:n}))}function D(e,n,r){const i=$(e,r);return i?i.replaceAll(F,((e,r,i)=>function(e,n,r){const i=(n=M(n))&&"{"!==n[0];return t(e,function(e,t=!1){const n={...e};return Object.keys(n).forEach((e=>function(e,t,n=!1){const r=t[e];if("string"==typeof r){const i="%27",a=(n?encodeURIComponent(r):r).replaceAll(h,i);t[e]=a}}(e,n,t))),n}(r,i||!1))}(e,r||i,n))):i}function z(e){return null!=e&&"object"==typeof e&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&("feature"===e.type||"scene"===e.type||"subtype-sublayer"===e.type||"sublayer"===e.type)&&"when"in e}function O(e){return z(e)&&function(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}(e)}function G(e){return z(e)&&function(e){return!!(e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"type"in e)&&("subtype-sublayer"===e.type&&"parent"in e&&e.parent&&"object"==typeof e.parent?"globalIdField"in e.parent:"globalIdField"in e)}(e)}function S(e){return!!e&&"object"==typeof e&&"sourceLayer"in e&&O(e.sourceLayer)}function Q(e,t,n,r){return e.trim().split(t).map((e=>o(Number(e),l(r)))).join(n)}function P(e,t){if(e?.length&&t)return e.find((e=>e.fieldName?.toLowerCase()===t.toLowerCase()))}function _(e,t,n,r){const{creatorField:o,creationDateField:l,editorField:s,editDateField:u}=e;if(!t)return;const f=i(r&&"preferredTimeZone"in r?r.preferredTimeZone:null,!(!r||!("datesInUnknownTimezone"in r)||!r.datesInUnknownTimezone),n,L,"date"),c={...L,...f},d=t[u];if("number"==typeof d){const e=t[s];return{type:"edit",date:a(d,c),user:e}}const p=t[l];if("number"==typeof p){const e=t[o];return{type:"create",date:a(p,c),user:e}}return null}function H(e,t){const n=new Map;if(!e)return n;for(const r of e){if(!r.fieldName)continue;const e=A(r.fieldName,t);r.fieldName=e,n.set(e.toLowerCase(),r)}return n}function B(e){const t=[];if(!e)return t;const{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)?(r.forEach((e=>{if("fields"===e.type){const n=e?.fieldInfos;n&&t.push(...n)}})),t):t}function J(e){return e.replaceAll(T,(e=>`&#${e.charCodeAt(0)};`))}function K(e){return"string"==typeof e?e.replaceAll(w,'<br class="esri-text-new-line" />'):e}function V(t){const{value:n,fieldName:r,fieldInfos:i,fieldInfoMap:a,layer:s,graphic:f,timeZone:d}=t;if(null==n)return"";const m=function({fieldName:t,value:n,graphic:r,layer:i}){if(ee(t))return null;if(!i||"function"!=typeof i.getFieldDomain)return null;const a=r&&i.getFieldDomain(t,{feature:r,excludeImpliedDomains:e("esri-widget-legacy-field-domain-calculation")});return a&&"coded-value"===a.type?a.getName(n):null}({fieldName:r,value:n,graphic:f,layer:s});if(m)return m;const g=function({fieldName:e,graphic:t,layer:n}){if(ee(e))return null;if(!n||"function"!=typeof n.getFeatureType)return null;const{typeIdField:r}=n;if(!r||e!==r)return null;const i=n.getFeatureType(t);return i?i.name:null}({fieldName:r,graphic:f,layer:s});if(g)return g;if(a.get(r.toLowerCase()))return function(e,t){const{fieldInfos:n,fieldName:r,preventPlacesFormatting:i,layer:a,timeZone:s}=t,u=P(n,r),f=U(a,r);if(u&&!c(r)){const t=f?.type,n=u.format?.dateFormat;if("date"===t||"date-only"===t||"time-only"===t||"timestamp-offset"===t||n)return y(e,{format:n,fieldType:t,timeZoneOptions:{layerTimeZone:a&&"preferredTimeZone"in a?a.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!a||!("datesInUnknownTimezone"in a)||!a.datesInUnknownTimezone)}})}const d=u?.format;return"string"==typeof e&&c(r)&&d?function(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?Q(e,",",", ",t):e.includes(";")?Q(e,";","; ",t):e.includes(" ")?Q(e," "," ",t):o(Number(e),l(t))}(e,d):(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,d),"string"==typeof e||null==e||null==d?K(e):o(e,i?{...l(d),minimumFractionDigits:0,maximumFractionDigits:20}:l(d)))}(n,{fieldInfos:i||Array.from(a.values()),fieldName:r,layer:s,timeZone:d});const b=s?.fieldsIndex?.get(r);return b&&(p(b)||u(b))?y(n,{fieldType:b.type,timeZoneOptions:{layerTimeZone:s&&"preferredTimeZone"in s?s.preferredTimeZone:null,viewTimeZone:d,datesInUnknownTimezone:!(!s||!("datesInUnknownTimezone"in s)||!s.datesInUnknownTimezone)}}):K(n)}function W({fieldInfos:e,attributes:t,layer:n,graphic:r,fieldInfoMap:i,relatedInfos:a,timeZone:o}){const l={};return a?.forEach((t=>function({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:a}){e&&t&&(t.relatedFeatures?.forEach((o=>te({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:a}))),t.relatedStatsFeatures?.forEach((o=>te({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:a}))))}({attributes:l,relatedInfo:t,fieldInfoMap:i,fieldInfos:e,layer:n,timeZone:o}))),t&&Object.keys(t).forEach((a=>{const s=t[a];l[a]=V({fieldName:a,fieldInfos:e,fieldInfoMap:i,layer:n,value:s,graphic:r,timeZone:o})})),l}async function X(e,t){const{layer:n,graphic:r,outFields:i,objectIds:a,returnGeometry:o,spatialReference:l}=e,s=a[0];if("number"!=typeof s&&"string"!=typeof s){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:n,graphic:r,objectId:s,requiredFields:i};return m().warn(e,t),null}if(!d(n)?.operations?.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:n,graphic:r,requiredFields:i,returnGeometry:o};return m().warn(e,t),null}const u=n.createQuery();return u.objectIds=a,u.outFields=i?.length?i:[n.objectIdField],u.returnGeometry=!!o,u.returnZ=!!o,u.returnM=!!o,u.outSpatialReference=l,(await n.queryFeatures(u,t)).features[0]}async function Y({graphic:e,popupTemplate:t,layer:n,spatialReference:r},i){if(!n||!t)return;if("function"==typeof n.load&&await n.load(i),!e.attributes)return;const a=n.objectIdField,o=e.attributes[a];if(null==o)return;const l=[o],u=await t.getRequiredFields(n.fieldsIndex),c=s(u,e),d=c?[]:u.includes(a)?u:[...u,a],p=t.returnGeometry||await async function(e){if(!e.expressionInfos?.length)return!1;const t=await f(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}(t);if(c&&!p)return;const y=await X({layer:n,graphic:e,outFields:d,objectIds:l,returnGeometry:p,spatialReference:r},i);y&&(y.geometry&&(e.geometry=y.geometry),y.attributes&&(e.attributes={...e.attributes,...y.attributes}))}function ee(e=""){return!!e&&e.includes(j)}function te({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:i,layer:a,timeZone:o}){e&&t&&n&&Object.keys(t.attributes).forEach((l=>{const s=(u={layerId:n.relation.id.toString(),fieldName:l})?`${j}${u.layerId}/${u.fieldName}`:"";var u;const f=t.attributes[l];e[s]=V({fieldName:s,fieldInfos:r,fieldInfoMap:i,layer:a,value:f,graphic:t,timeZone:o})}))}const ne=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},re=({layer:e,method:t,query:n,definitionExpression:r})=>{if(!e.capabilities?.query?.supportsCacheHint||"attachments"===t)return;const i=null!=n.where?n.where:null,a=null!=n.geometry?n.geometry:null;ne(r)||ne(i)||"extent"===a?.type||"tile"===n.resultType||(n.cacheHint=!0)},ie=({query:e,layer:t,method:n})=>{re({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},ae=({queryPayload:e,layer:t,method:n})=>{re({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function oe(e,t,n){return e&&t&&n?"sublayer"===t.type?ue({layers:t.layer?.sublayers,map:e,relatedLayer:t,relationship:n})||ue({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:n}):ue({layers:e.allLayers,map:e,relatedLayer:t,relationship:n})||ue({layers:e.allTables,map:e,relatedLayer:t,relationship:n}):null}function le(e,t){return e&&"utilityNetworks"in e&&t?e.utilityNetworks?.find((e=>e.isUtilityLayer(t))):null}function se(e,t){return e?.allTables.find((e=>"feature"===e.type&&e.layerId===t.id&&e.url===t.layer?.url))}function ue({map:e,relationship:t,relationship:{relatedTableId:n},relatedLayer:r,layers:i}){if(!i)return null;for(const a of i){if("map-image"===a.type){const n=ue({layers:a.sublayers,map:e,relatedLayer:r,relationship:t})||ue({layers:a.subtables,map:e,relatedLayer:r,relationship:t});if(n)return n;continue}if(!O(a))continue;if("sublayer"===r.type){if(a!==r&&a.id===n)return a.isTable?se(e,a):a;continue}const i="scene"===r.type&&r.associatedLayer?r.associatedLayer.url:r.url;if(!i)return null;if("sublayer"!==a.type){if(a!==r&&a.url===i&&a.layerId===n)return a}else if(a!==r&&a.layer?.url===i&&a.id===n)return a.isTable?se(e,a):a}return null}function fe(e){const t=e.getObjectId();return null!=t?`oid:${t}`:`uid:${e.uid}`}export{ae as A,x as B,Z as a,A as b,S as c,v as d,q as e,oe as f,fe as g,ee as h,O as i,$ as j,k,C as l,E as m,P as n,K as o,J as p,le as q,H as r,R as s,B as t,X as u,G as v,_ as w,Y as x,W as y,ie as z};
