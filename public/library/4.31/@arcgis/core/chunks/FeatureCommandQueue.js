/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{C as e}from"./CIMSymbolHelper.js";import{r as t}from"./utils7.js";import{c as i}from"./enums2.js";import{u as s,U as o,F as a,b as r,S as n,M as l,h as u,a8 as p,j as c,B as d,A as m,l as f,Y as h,a as y,q as v,p as x,t as b,k as g,m as w,a9 as S,c as V,Z as z,aa as _,a4 as P,a5 as T,K as M,w as C,_ as R,r as A,a7 as I,s as O,i as F,T as D,V as L,G as k,n as E,z as B,D as U,e as N,a2 as j,g as H,d as q,f as G,o as W,O as Z,I as $,ab as K,ac as X,C as Y,v as Q,y as J,ad as ee}from"./GraphShaderModule.js";import{_ as te,c as ie}from"./tslib.es6.js";import{h as se,R as oe,i as ae}from"../core/lang.js";import{t as re,R as ne,v as le,F as ue,A as pe,w as ce,x as de,y as me,z as fe,B as he,V as ye,C as ve,D as xe,E as be,G as ge,H as we,I as Se,J as Ve,c as ze,K as _e,L as Pe,N as Te,O as Me,P as Ce,Q as Re,S as Ae,W as Ie,M as Oe,X as Fe,Y as De,Z as Le,_ as ke,$ as Ee,a0 as Be,a1 as Ue,a2 as Ne,a3 as je,a4 as He,a5 as qe,a6 as Ge,k as We,l as Ze,a7 as $e,a8 as Ke,a9 as Xe,aa as Ye,q as Qe,r as Je,h as et,ab as tt,U as it}from"./UpdateTracking2D.js";import{i as st,m as ot}from"./mat3.js";import{c as at}from"./mat3f32.js";import{b as rt,r as nt,c as lt,d as ut,g as pt,e as ct,i as dt,f as mt,h as ft,W as ht,V as yt}from"./featureTechniqueUtils.js";import{M as vt,d as xt,T as bt,g as gt}from"./Technique.js";import{a as wt,Y as St,Z as Vt,y as zt,B as _t,_ as Pt}from"./definitions.js";import{D as Tt,k as Mt,c as Ct,T as Rt,n as At,P as It,j as Ot,f as Ft,g as Dt}from"./enums.js";import{R as Lt,a as kt,F as Et}from"./Program.js";import{a as Bt,T as Ut}from"./Texture.js";import{L as Nt,n as jt}from"./Logger.js";import{f as Ht}from"./maybe.js";import{l as qt}from"./heatmapTextureUtils.js";import{a as Gt,t as Wt}from"./screenUtils.js";import{d as Zt,a as $t}from"./constants.js";import{r as Kt}from"./WGLContainer.js";import{g as Xt}from"./unitUtils.js";import{m as Yt}from"./lengthUtils.js";import Qt from"../core/Error.js";import{g as Jt}from"./capabilities2.js";import{ignoreAbortErrors as ei}from"../core/promiseUtils.js";import{Q as ti}from"./QueueProcessor.js";const ii=new class{get forceStaticPath(){return"disabled"===se("esri-cim-animations-enable-status")}get forceAnimatedPath(){return"forced"===se("esri-cim-animations-enable-status")}get freezeGlobalTime(){return se("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!se("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return!1!==se("esri-cim-animations-freeze-time")}},si={position:{type:Tt.SHORT,count:2}};class oi extends vt{static create(e,t,i){const s=[];let{stride:o}=t;if(null==o){o=0;for(const[e,{count:i,type:s,offset:a}]of Object.entries(t.layout)){if(null!=a)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");o+=i*xt[s]}}let a=0;for(const[e,{count:r,offset:n,type:l,normalized:u}]of Object.entries(t.layout)){null!=n&&(a=n);const t=i.get(e);if(null==t)throw new Error("Locations must be specified at mesh initialization.");const p={name:e,location:t,vertex:"vertexData",count:r,type:l,offset:a,stride:o,divisor:0,normalized:null!=u&&u};s.push(p),a+=r*xt[l]}const r={attributes:s,primitive:t.primitive};null!=t.index&&(r.index="indexData");let{count:n}=t;if(null==n&&(n=t.index?t.index.length:t.vertex.byteLength/o,Math.floor(n)!==n))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${o}.`);const l={start:0,count:n,group:0,primitive:t.primitive},u={vertex:{vertexData:t.vertex},parts:[l],groups:[r]};return null!=t.index&&(u.index={indexData:t.index}),new oi(e,u,t.layout)}static fromVertexStream(e,t){return oi.create(e,{primitive:Mt.TRIANGLE_STRIP,vertex:new Uint16Array(t),layout:si},new Map([["position",0]]))}constructor(e,t,i){super(e,t),this._spec=i}bind(e,t=0){super.bind(e,t)}}class ai extends o{}te([s(a)],ai.prototype,"globalTime",void 0),te([s(r)],ai.prototype,"animationTextureSize",void 0),te([s(n)],ai.prototype,"animationTexture",void 0),te([s(l)],ai.prototype,"toScreen",void 0),te([s(l)],ai.prototype,"toNdc",void 0),te([s(a)],ai.prototype,"mapRotation",void 0),te([s(a)],ai.prototype,"pixelRatio",void 0);class ri extends o{getVVRotationMat4(e){return u(re(e),p.identity(),(()=>{const t=this.getNormalizedAngle(e).multiply(le),i=d(t),s=m(t);return new p(s,i,0,0,i.multiply(new a(-1)),s,0,0,0,0,1,0,0,0,0,1)}))}getVVRotationMat3(e){return u(re(e),l.identity(),(()=>{const t=this.getNormalizedAngle(e).multiply(le),i=d(t),s=m(t);return new l(s,i,0,i.multiply(new a(-1)),s,0,0,0,1)}))}getNormalizedAngle(e){const t=c(this.rotationType,new a(ne.Arithmatic));return u(t,new a(90).subtract(e),e)}}te([s(a)],ri.prototype,"rotationType",void 0);class ni extends ue{}te([f(3,V)],ni.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),te([f(4,r)],ni.prototype,"zoomRange",void 0);class li extends Se{}class ui extends pe{_getScreenPosition(e){const{pos:t,translation:i,rotation:s,scale:o,offset:r,id:n,vvScale:u}=e,p=ce(this,n).multiply(Math.PI/180),c=i.x.multiply(4/3),f=i.y.multiply(-1).multiply(4/3),h=d(s.subtract(p)),v=m(s.subtract(p)),x=new a(0),b=new a(1),{pixelRatio:g}=this.animationInfo,w=new l(b,x,x,x,b,x,c.multiply(g),f.multiply(g),b),S=new l(v,h.multiply(-1),x,h,v,x,0,0,b),V=o.multiply(u).multiply(g).multiply(4/3),z=S.multiply(V),_=this.animationInfo.toScreen.multiply(new y(t,1)),P=w.multiply(_).xy,T=z.multiply(new y(r,0)).xy;return P.add(T)}_clip(e,t){let i=super.clip(e,t);const s=v(this._getLocalTimeOrigin(e),new a(0));return ii.forceGlobalTimeOrigin||(i=i.add(x([s,()=>new a(2)],[!0,()=>new a(0)]))),i}_getLocalTimeOrigin(e){return this.storage.getLocalTimeOrigin(e)}_toNdc(e){return this.animationInfo.toNdc.multiply(new y(e,1)).xy}_getEvalParams(e,t){const{globalTime:i,animationTextureSize:s,animationTexture:o}=this.animationInfo;return{globalTime:i,localTimeOrigin:this._getLocalTimeOrigin(e.id),animationTextureSize:s,animationTexture:o,pixelDimensions:t}}_getColor(e,t){return u(c(t.isSDF,new a(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return b(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=b(this.mosaicInfo.texture,e),s=new a(.5).subtract(de(i)).multiply(t.distanceToPx).multiply(me),o=g(new a(.5).subtract(s),new a(0),new a(1)),r=t.color.multiply(o),n=t.outlineSize.multiply(.5),l=w(s).subtract(n),u=g(new a(.5).subtract(l),new a(0),new a(1)),p=t.outlineColor.multiply(u);return new a(1).subtract(p.a).multiply(r).add(p)}}function pi(e,t,i){const s=e.add(new r(t,0)),o=b(i.animationTexture,s.add(.5).divide(i.animationTextureSize)).xy;return e=e.add(o),S({animationPointer:e,...i},V,null,(e=>{const{out:t}=e;if(!t)throw new Error("out is null");return fe({...e,out:t})}))}var ci;te([s(he)],ui.prototype,"mosaicInfo",void 0),te([s(ai)],ui.prototype,"animationInfo",void 0),te([h(ye)],ui.prototype,"visualVariableColor",void 0),te([h(ve)],ui.prototype,"visualVariableOpacity",void 0),te([h(xe)],ui.prototype,"visualVariableSizeMinMaxValue",void 0),te([h(be)],ui.prototype,"visualVariableSizeScaleStops",void 0),te([h(ge)],ui.prototype,"visualVariableSizeStops",void 0),te([h(we)],ui.prototype,"visualVariableSizeUnitValue",void 0),te([h(ri)],ui.prototype,"visualVariableRotation",void 0),function(e){e[e.transform=0]="transform",e[e.fromColor=1]="fromColor",e[e.toColor=2]="toColor",e[e.colorMix=3]="colorMix",e[e.toOpacity=4]="toOpacity",e[e.opacityMix=5]="opacityMix"}(ci||(ci={}));class di extends ni{}te([f(5,r)],di.prototype,"offset",void 0),te([f(6,r)],di.prototype,"uv",void 0),te([f(7,V)],di.prototype,"sizing",void 0),te([f(8,a)],di.prototype,"angle",void 0);class mi extends z{}function fi(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}te([f(12,r)],mi.prototype,"offsetNextVertex1",void 0),te([f(13,r)],mi.prototype,"offsetNextVertex2",void 0),te([f(14,r)],mi.prototype,"textureUVNextVertex1",void 0),te([f(15,r)],mi.prototype,"textureUVNextVertex2",void 0);class hi extends ui{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}_vertexPreamble(e){const{id:t,pos:i,offset:s,animationPointerAndBaseSizeAndReferenceSize:o,uv:r,sizing:n,angle:l}=e,u=o.xy,p=o.z,f=o.w,h=n.xy,y=n.z,v=Ve(e.bitset,Oe.bitset.isStroke),b=n.w,g=Ve(e.bitset,Oe.bitset.scaleSymbolsProportionally),w=this._getEvalParams(e,h),S=pi(u,ci.transform,w),V=x([c(Ve(e.bitset,Oe.bitset.isMapAligned),new a(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new a(0)]),z=new _(m(V),d(V.multiply(-1)),d(V),m(V)).multiply(S.xy),P=S.z.subtract(V).subtract(l.multiply(ze)),T=S.w,M=Ve(e.bitset,Oe.bitset.isSDF),C=_e(this,t,new a(f)).divide(new a(f));return{baseSize:p,animationPointer:u,strokeWidth:y,isOutline:v,unscaledDistanceToPx:b,scaleSymbolsProportionally:g,isSDF:M,position:this._getScreenPosition({id:t,pos:i,offset:s,referenceSize:f,translation:z,rotation:P,scale:T,vvScale:C}),uv:r,evalParams:w,vvScale:C,scale:T}}vertex(e,t){const{position:i,animationPointer:s,evalParams:o,isOutline:r,unscaledDistanceToPx:n,vvScale:u,uv:p,strokeWidth:c,scaleSymbolsProportionally:d,scale:m,isSDF:f,baseSize:h}=this._vertexPreamble(e),y=this._toNdc(i);let v=pi(s,ci.fromColor,o);v=new V(v.rgb.multiply(v.a),v.a);let x=pi(s,ci.toColor,o);x=new V(x.rgb.multiply(x.a),x.a);let b=pi(s,ci.colorMix,o);b=new V(b.rgb.multiply(b.a),b.a);const g=pi(s,ci.toOpacity,o).a,w=pi(s,ci.opacityMix,o).a,S=Pe(this,e.id,v,P(Te(e.bitset,Oe.bitset.colorLocked),new T(r))),z=M(S,x,b),_=Me(this,e.id),C=M(_,g,w),R=z.multiply(C),A=this.clip(e.id,e.zoomRange),I=n.multiply(u);return{glPosition:new V(y,A,1),uv:p.divide(this.mosaicInfo.size),color:R.multiply(new a(1).subtract(r)),outlineColor:R.multiply(r),distanceToPx:I,strokeWidth:c.multiply(M(new a(1),m,d)),isOutline:r,isSDF:f,...this.maybeRunHittest(e,t,{pos:e.pos,size:h,sizeCorrection:new a(1),isMapAligned:new a(1),vvRotationMat3:new l(1,0,0,0,1,0,0,0,1),placementMat3:new l(1,0,0,0,1,0,0,0,1),outlineSize:new a(1),distanceToPx:I,isSDF:f})}}fragment(e){let t=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return ii.spotlightAnimatedSymbols&&(t=t.add(new V(0,.3,0,.3))),this.getFragmentOutput(t,e)}hittest(e,t,i){return u(C(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_hittestSmallMarker(e,t,i){const{position:s,distance:o,smallSymbolDistance:a}=this.hittestRequest,r=o.subtract(a),{viewMat3:n,tileMat3:l}=this.view,u=n.multiply(l).multiply(new y(i.pos,1)).xy,p=i.size.multiply(.5);return R(u,s).subtract(p).add(r)}_hittestMarker(e,t,i){const s=this._vertexPreamble({...e}).position,o=this._vertexPreamble({...e,offset:t.offsetNextVertex1,uv:t.textureUVNextVertex1}).position,a=this._vertexPreamble({...e,offset:t.offsetNextVertex2,uv:t.textureUVNextVertex2}).position,r=this.hittestRequest.position,n=this.hittestRequest.distance,l=Ce(r,s,o,a);return u(A(l,n),l,this._hittestSamples(s,o,a,e,t,i))}_hittestSamples(e,t,i,s,o,n){const{outlineSize:l,isSDF:u,distanceToPx:p}=n,c=this.hittestRequest.position,d=this.hittestRequest.distance,m=Re(c.add(new r(I(d),I(d))),e,t,i),f=Re(c.add(new r(0,I(d))),e,t,i),h=Re(c.add(new r(d,I(d))),e,t,i),y=Re(c.add(new r(I(d),0)),e,t,i),v=Re(c,e,t,i),x=Re(c.add(new r(d,0)),e,t,i),b=Re(c.add(new r(I(d),d)),e,t,i),g=Re(c.add(new r(0,d)),e,t,i),w=Re(c.add(new r(d,d)),e,t,i),S=s.uv.divide(this.mosaicInfo.size),z=o.textureUVNextVertex1.divide(this.mosaicInfo.size),_=o.textureUVNextVertex2.divide(this.mosaicInfo.size),P={color:new V(1,1,1,1),outlineSize:l,outlineColor:new V(1,1,1,1),isSDF:u,distanceToPx:p};let T=new a(0);return T=T.add(Ae(m).multiply(this._getColor(fi(m,S,z,_),P).a)),T=T.add(Ae(f).multiply(this._getColor(fi(f,S,z,_),P).a)),T=T.add(Ae(h).multiply(this._getColor(fi(h,S,z,_),P).a)),T=T.add(Ae(y).multiply(this._getColor(fi(y,S,z,_),P).a)),T=T.add(Ae(v).multiply(this._getColor(fi(v,S,z,_),P).a)),T=T.add(Ae(x).multiply(this._getColor(fi(x,S,z,_),P).a)),T=T.add(Ae(b).multiply(this._getColor(fi(b,S,z,_),P).a)),T=T.add(Ae(g).multiply(this._getColor(fi(g,S,z,_),P).a)),T=T.add(Ae(w).multiply(this._getColor(fi(w,S,z,_),P).a)),O(T,new a(.05)).multiply(Ie(this.hittestRequest))}}te([ie(0,F(di)),ie(1,F(mi))],hi.prototype,"vertex",null),te([ie(0,F(class extends li{}))],hi.prototype,"fragment",null);class yi extends bt{constructor(){super(...arguments),this.symbologyPlane=rt.FILL,this._input=null}}class vi extends yi{render(e,t){const{context:i,painter:s}=e,{target:o}=t,{freezeGlobalTime:a}=ii,r=s.textureManager.animationStore.getTexture(i,0),n=[2/e.state.size[0],0,0,0,-2/e.state.size[1],0,-1,1,1],l=Array.from(st(at(),n)),u=Array.from(ot(at(),l,o.transforms.displayViewScreenMat3)),p=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,p.uniforms),...lt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey,!0),animationInfo:{globalTime:!1===a?e.time/1e3:a,animationTextureSize:[r.descriptor.width,r.descriptor.height],animationTexture:{unit:6,texture:r},toScreen:u,toNdc:n,mapRotation:e.state.rotation,pixelRatio:e.state.pixelRatio}},defines:{...ut(e)},optionalAttributes:{zoomRange:!0},useComputeBuffer:!0}),s.setPipelineState({...pt(e)}),s.submitDraw(e,t),!1===a&&o.requestRender()}}class xi extends L{}te([f(0,r)],xi.prototype,"pos",void 0);class bi extends o{}te([s(a)],bi.prototype,"dotSize",void 0);class gi extends o{}te([s(n)],gi.prototype,"locations",void 0),te([s(a)],gi.prototype,"pixelRatio",void 0),te([s(a)],gi.prototype,"tileZoomFactor",void 0);class wi extends k{vertex(e){const t=new l(1,0,0,0,-1,0,0,1,1).multiply(new y(e.pos.xy.divide(wt),1)),i=b(this.draw.locations,t.xy),s=E(this.instance.dotSize.divide(2),new a(1));let o=new a(0);o=o.add(O(i.a,new a(1e-6)).multiply(2));let r=s.add(this.instance.dotSize);const n=this.view.displayViewScreenMat3.multiply(new y(e.pos.add(.5),1)),u=new V(n.xy,o,1),p=this.instance.dotSize.divide(r),c=new a(-1).divide(s.divide(r));return r=r.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:r,color:i,ratio:p,invEdgeRatio:c}}fragment(e){const t=B(e.glPointCoord.subtract(.5)).multiply(2),i=U(new a(0),new a(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),s=new N;return s.glFragColor=e.color.multiply(i),s}}te([s(bi)],wi.prototype,"instance",void 0),te([s(gi)],wi.prototype,"draw",void 0),te([s(Fe)],wi.prototype,"view",void 0),te([ie(0,F(xi))],wi.prototype,"vertex",null),te([ie(0,F(class extends Se{}))],wi.prototype,"fragment",null);class Si extends ue{}te([f(3,a)],Si.prototype,"inverseArea",void 0);class Vi extends o{}te([s(j.ofType(V,2))],Vi.prototype,"isActive",void 0),te([s(j.ofType(V,8))],Vi.prototype,"colors",void 0),te([s(a)],Vi.prototype,"dotValue",void 0);class zi extends o{}te([s(n)],zi.prototype,"dotTexture0",void 0),te([s(n)],zi.prototype,"dotTexture1",void 0),te([s(a)],zi.prototype,"tileZoomFactor",void 0),te([s(a)],zi.prototype,"pixelRatio",void 0),te([s(a)],zi.prototype,"tileDotsOverArea",void 0);class _i extends pe{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new l(2/wt,0,0,0,-2/wt,0,-1,1,1).multiply(new y(e.pos,1)),i=this.clip(e.id),s=new V(t.xy,i,1),o=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),a=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),r=this.draw.tileZoomFactor.multiply(wt).divide(this.draw.pixelRatio),n=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),u=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),p=e.pos.add(.5).divide(r);return{glPosition:s,color:new V(0,0,0,0),textureCoords:p,thresholds0:n,thresholds1:u}}fragment(e){const t=new N,i=b(this.draw.dotTexture0,e.textureCoords),s=b(this.draw.dotTexture1,e.textureCoords),o=e.thresholds0.subtract(i),r=e.thresholds1.subtract(s);let n;const l=p.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),u=p.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const e=O(new a(0),o),t=O(new a(0),r),i=q(e,o).add(q(t,r)),s=O(i,new a(0)),p=new a(1).subtract(s),c=i.add(s),d=o.multiply(e).divide(c),m=r.multiply(t).divide(c),f=l.multiply(d).add(u.multiply(m));n=p.multiply(f)}else{const e=E(De(o),De(r)),t=O(e,new a(0)),i=new a(1).subtract(t),s=O(e,o),p=O(e,r),c=l.multiply(s).add(u.multiply(p));n=i.multiply(c)}return t.glFragColor=n,t}hittest(e){return Ie(this.hittestRequest)}}te([H],_i.prototype,"blending",void 0),te([s(Vi)],_i.prototype,"instance",void 0),te([s(zi)],_i.prototype,"draw",void 0),te([ie(0,F(Si))],_i.prototype,"vertex",null),te([ie(0,F(Se))],_i.prototype,"fragment",null);const Pi={pos:{count:2,type:Tt.UNSIGNED_SHORT}};class Ti{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(null==this._dotFBO){const t=wt,i=wt,s=new Bt(t,i);s.samplingMode=Ct.NEAREST,s.wrapMode=Rt.CLAMP_TO_EDGE;const o=new Lt(e,new kt(At.DEPTH_STENCIL,t,i));this._dotFBO=new Et(e,s,o)}return this._dotFBO}getDotDensityMesh(e,t){if(null==this._dotMesh){const i=wt,s=i*i,o=2,a=new Int16Array(s*o);for(let e=0;e<i;e++)for(let t=0;t<i;t++)a[o*(t+e*i)]=t,a[o*(t+e*i)+1]=e;this._dotMesh=oi.create(e,{primitive:Mt.POINTS,vertex:a,count:s,layout:Pi},t)}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),null===this._dotTextures){const s=new oe(i);this._dotTextures=[this._allocDotDensityTexture(e,t,s),this._allocDotDensityTexture(e,t,s)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const s=new Float32Array(t*t*4);for(let e=0;e<s.length;e++)s[e]=i.getFloat();const o=new Bt;return o.dataType=It.FLOAT,o.samplingMode=Ct.NEAREST,o.width=t,o.height=t,new Ut(e,o,s)}}function Mi(e){const t=1/e;return{antialiasing:t,blur:0+t}}class Ci{destroy(){this._accumulateFramebuffer=Ht(this._accumulateFramebuffer),this._resolveGradientTexture=Ht(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return null!=this._accumulateFramebuffer&&null!=this._resolveGradientTexture}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(null==this._qualityProfile){const t=qt(e,Nt.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"));this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==It.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(null==this._accumulateFramebuffer){const{dataType:s,samplingMode:o,pixelFormat:a,internalFormat:r}=this.loadQualityProfile(e),n=new Bt(t,i);n.pixelFormat=a,n.internalFormat=r,n.dataType=s,n.samplingMode=o,n.wrapMode=Rt.CLAMP_TO_EDGE;const l=new kt(At.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new Et(e,n,l)}else{const{width:e,height:s}=this._accumulateFramebuffer;e===t&&s===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(null==this._resolveGradientTexture){const t=new Bt;t.wrapMode=Rt.CLAMP_TO_EDGE,this._resolveGradientTexture=new Ut(e,t)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t);return this._resolveGradientTexture}}function Ri(e){return e?.25:1}class Ai extends ue{}te([f(5,r)],Ai.prototype,"offset",void 0);class Ii extends o{}te([s(a)],Ii.prototype,"radius",void 0),te([s(a)],Ii.prototype,"isFieldActive",void 0);class Oi extends pe{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,s=e.offset,o=i.multiply(this.storage.getVVData(e.id).x).add(new a(1).subtract(i)),r=this.view.displayViewScreenMat3.multiply(new y(e.pos,1)).add(this.view.displayViewMat3.multiply(new y(s,0)).multiply(t)),n=this.clip(e.id);return{glPosition:new V(r.xy,n,1),offset:s,fieldValue:o,color:new V(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,s=B(t),o=O(s,new a(1)),r=new a(1).subtract(s.multiply(s)),n=r.multiply(r),l=o.multiply(n).multiply(i).multiply(new a(Ri(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new V(l),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view,s=t.multiply(i).multiply(new y(e.pos,1));return je(s.xy,this.kernelControls.radius,this.hittestRequest.position)}}te([H],Oi.prototype,"usesHalfFloatPrecision",void 0),te([s(Ii)],Oi.prototype,"kernelControls",void 0),te([ie(0,F(Ai))],Oi.prototype,"vertex",null),te([ie(0,F(class extends Se{}))],Oi.prototype,"fragment",null);class Fi extends L{}te([f(0,r)],Fi.prototype,"position",void 0);class Di extends o{}te([s(n)],Di.prototype,"texture",void 0),te([s(r)],Di.prototype,"minAndInvRange",void 0),te([s(a)],Di.prototype,"normalization",void 0);class Li extends o{}te([s(n)],Li.prototype,"texture",void 0);class ki extends k{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new V(e.position.multiply(2).subtract(1),1,1),uv:e.position}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let s=b(t.texture,e.uv).r.divide(new a(Ri(this.usesHalfFloatPrecision)));s=s.multiply(t.normalization),s=s.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const o=b(i.texture,new r(s,.5)),n=new N;return n.glFragColor=new V(o.rgb.multiply(o.a),o.a),n}}function Ei(e){return e.key.level+1}te([H],ki.prototype,"usesHalfFloatPrecision",void 0),te([s(Di)],ki.prototype,"accumulatedDensity",void 0),te([s(Li)],ki.prototype,"gradient",void 0),te([ie(0,F(Fi))],ki.prototype,"vertex",null),te([ie(0,F(class extends G{}))],ki.prototype,"fragment",null);const Bi={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:Ei,compare:Ft.GEQUAL,mask:255,op:{fail:Dt.KEEP,zFail:Dt.KEEP,zPass:Dt.REPLACE}}}},Ui={...Bi,stencil:!1},Ni={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function ji(e,t){const{referenceScale:i,radius:s}=e.uniforms;return s*(0!==i?i/t.scale:1)}const Hi=360/254;var qi;!function(e){e[e.Color=0]="Color",e[e.Outline=1]="Outline",e[e.Halo=2]="Halo"}(qi||(qi={}));class Gi extends ue{}te([f(3,V)],Gi.prototype,"color",void 0),te([f(4,r)],Gi.prototype,"offset",void 0),te([f(5,r)],Gi.prototype,"textureUV",void 0),te([f(6,a)],Gi.prototype,"fontSize",void 0),te([f(7,a)],Gi.prototype,"referenceSize",void 0),te([f(8,V)],Gi.prototype,"outlineColor",void 0),te([f(9,V)],Gi.prototype,"haloColor",void 0),te([f(10,r)],Gi.prototype,"outlineAndHaloSize",void 0),te([f(11,r)],Gi.prototype,"zoomRange",void 0),te([f(12,a)],Gi.prototype,"clipAngle",void 0),te([f(13,V)],Gi.prototype,"referenceSymbol",void 0);class Wi extends z{}te([f(14,r)],Wi.prototype,"offsetNextVertex1",void 0),te([f(15,r)],Wi.prototype,"offsetNextVertex2",void 0);class Zi extends pe{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=qi.Color,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){const s=t.multiply(Hi),o=w(this.view.rotation.subtract(s)),r=W(new a(360).subtract(o),o);let n=new a(0);const l=Z(this.view.currentZoom.multiply(zt)).divide(zt),u=e.x,p=e.y,c=new a(1).subtract(O(u,l)).multiply(2),d=O(new a(90),r).multiply(2),m=new a(2).multiply(new a(1).subtract(O(l,p)));return n=n.add(i.multiply(c)),n=n.add(i.multiply(d)),n=n.add(m),n}vertex(e,t){const i=Ve(e.bitset,We),s=new a(1).subtract(i);let o=e.fontSize,n=o.divide(He);const u=this.textRenderPassType===qi.Outline?e.outlineColor:this.textRenderPassType===qi.Halo?e.haloColor:this._getVertexColor(e),p=this.isLabel?this.storage.getLabelVisibility(e.id):new a(1),d=this.isLabel?u.multiply(p):u,m=this.view.displayViewScreenMat3.multiply(new y(e.pos,1));let f=e.offset,h=new a(1),v=l.identity(),x=new r(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const t=e.referenceSymbol,i=t.xy,s=t.z,o=this._unpackDirection(t.w),a=_e(this,e.id,s).divide(2),r=o.multiply(a.add(_t));x=i.add(r),f=f.add(x)}else h=_e(this,e.id,e.referenceSize).divide(e.referenceSize),o=o.multiply(h),n=n.multiply(h),f=f.multiply(h),v=qe(this,e.id),f=v.multiply(new y(f,0)).xy;const b=Ve(e.bitset,Ze),g=this._getViewRotationMatrix(b).multiply(new y(f,0));let w=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,b):this.clip(e.id,e.zoomRange);w=this.isBackgroundPass?w.add(s.multiply(2)):w.add(i.multiply(2));const S=this.isLabel?P(A(w,new a(1)),c(p,new a(0))):new T(!1),z=new V(m.xy.add(g.xy),w,1),_=e.textureUV.divide(this.mosaicInfo.size);let M=new a(0);if(this.textRenderPassType===qi.Outline&&(c(e.outlineAndHaloSize.x,new a(0))&&(w=w.add(new a(2))),M=new a(e.outlineAndHaloSize.x).divide(n).divide(Ge)),this.textRenderPassType===qi.Halo){const t=e.outlineAndHaloSize.x,i=new a(e.outlineAndHaloSize.y);c(i,new a(0))&&(w=w.add(new a(2))),M=i.add(t).divide(n).divide(Ge)}return{glPosition:z,color:d,size:n,textureUV:_,antialiasingWidth:new a(.105*He).divide(o).divide(this.view.pixelRatio),outlineDistanceOffset:M,...this.maybeRunHittest(e,t,{vvSizeAdjustment:h,vvRotation:v,labelOffset:x,labelClipped:S})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new a(1).subtract(e);return t.multiply(e).add(i.multiply(s))}fragment(e){const t=new a(2/8),i=new a(1).subtract(t),s=b(this.mosaicInfo.texture,e.textureUV).a;let o=i.subtract(e.outlineDistanceOffset);this.highlight&&(o=o.divide(2));const r=e.antialiasingWidth,n=U(o.subtract(r),o.add(r),s);return this.getFragmentOutput(e.color.multiply(n),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:s,labelOffset:o,labelClipped:a}){let r,n,l;this.isLabel?(r=new y(e.offset.add(o),0),n=new y(t.offsetNextVertex1.add(o),0),l=new y(t.offsetNextVertex2.add(o),0)):(r=s.multiply(new y(e.offset.multiply(i),0)),n=s.multiply(new y(t.offsetNextVertex1.multiply(i),0)),l=s.multiply(new y(t.offsetNextVertex2.multiply(i),0)));const{viewMat3:p,tileMat3:c}=this.view,d=p.multiply(c).multiply(new y(e.pos,1)),m=d.add(c.multiply(r)).xy,f=d.add(c.multiply(n)).xy,h=d.add(c.multiply(l)).xy,v=Ce(this.hittestRequest.position,m.xy,f.xy,h.xy);return this.isLabel?u(a,Ie(this.hittestRequest),v):v}_unpackDirection(e){const t=new $(e),i=K(t,new $(2)),s=X(t,new $(3));return new r(new a(i).subtract(1),new a(s).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new T(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),s=this.visualVariableOpacity.getOpacity(i);t=t.multiply(s)}return t}}te([h(ye)],Zi.prototype,"visualVariableColor",void 0),te([h(ve)],Zi.prototype,"visualVariableOpacity",void 0),te([h(ri)],Zi.prototype,"visualVariableRotation",void 0),te([h(xe)],Zi.prototype,"visualVariableSizeMinMaxValue",void 0),te([h(be)],Zi.prototype,"visualVariableSizeScaleStops",void 0),te([h(ge)],Zi.prototype,"visualVariableSizeStops",void 0),te([h(we)],Zi.prototype,"visualVariableSizeUnitValue",void 0),te([s(he)],Zi.prototype,"mosaicInfo",void 0),te([H],Zi.prototype,"textRenderPassType",void 0),te([H],Zi.prototype,"isBackgroundPass",void 0),te([H],Zi.prototype,"isLabel",void 0),te([ie(0,F(Gi)),ie(1,F(Wi))],Zi.prototype,"vertex",null),te([ie(0,F(class extends Se{}))],Zi.prototype,"fragment",null);class $i extends Ke{}te([f(9,a)],$i.prototype,"accumulatedDistance",void 0),te([f(10,r)],$i.prototype,"segmentDirection",void 0),te([f(11,a)],$i.prototype,"offsetAlongLine",void 0),te([f(12,a)],$i.prototype,"capType",void 0),te([f(13,V)],$i.prototype,"tlbr",void 0);class Ki extends $e{_getDistanceRatio(e,t){const i=Ve(e.bitset,Qe);return i.multiply(E(t,new a(.25)).multiply(new a(2))).add(new a(1).subtract(i).multiply(Gt(1)))}_getSDFAlpha(e){const{halfWidth:t,normal:i,tlbr:s,patternSize:o,accumulatedDistance:n,offsetAlongLine:l,dashToPx:u,capType:p}=e,d=o.x.divide(Zt).multiply(u),m=Y(n.add(l).divide(d)),f=M(s.xy,s.zw,new r(m,.5)),h=de(b(this.mosaicInfo.texture,f)).multiply(2).subtract(1).multiply($t).multiply(u),y=i.y.multiply(t),v=x([c(p,new a(1)),h.subtract(t)],[c(p,new a(2)),Q(J(E(h,new a(0)),new a(2)).add(y.multiply(y))).subtract(t)],[!0,h]),w=g(new a(.25).subtract(v),new a(0),new a(1));return new V(w)}_getPatternColor(e){const{halfWidth:t,normal:i,color:s,accumulatedDistance:o,patternSize:n,sampleAlphaOnly:l,tlbr:p}=e,c=n.y.multiply(new a(2).multiply(t).divide(n.x)),d=Y(o.divide(c)),m=new a(.5).multiply(i.y).add(new a(.5)),f=M(p.xy,p.zw,new r(m,d));let h=b(this.mosaicInfo.texture,f);return null!=this.visualVariableColor&&(h=u(A(l,new a(.5)),new V(s.a),s)),h}vertex(e,t){const{segmentDirection:i,tlbr:s,bitset:o}=e,n=Xe(this,e),l=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(q(i,n.scaledOffset)),p=new r(s.z.subtract(s.x),s.w.subtract(s.y)),c=s.divide(this.mosaicInfo.size.xyxy),d=Ve(o,Je),m=Ve(o,et),f=u(A(d,new a(.5)),this._getDistanceRatio(e,n.scaledHalfWidth),new a(1));return{...n,tlbr:c,patternSize:p,accumulatedDistance:l,isSDF:d,sampleAlphaOnly:m,dashToPx:f,offsetAlongLine:e.offsetAlongLine,capType:e.capType,...this.maybeRunHittest(e,t,n.halfWidth)}}fragment(e){const{color:t,opacity:i,isSDF:s}=e,o=Ye(e,this.antialiasingControls.blur),r=u(A(s,new a(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),n=t.multiply(i).multiply(o).multiply(r);return this.getFragmentOutput(n,e)}}te([s(he)],Ki.prototype,"mosaicInfo",void 0),te([ie(0,F($i)),ie(1,F(tt))],Ki.prototype,"vertex",null);class Xi extends ue{}te([f(3,V)],Xi.prototype,"color",void 0),te([f(4,V)],Xi.prototype,"outlineColor",void 0),te([f(5,r)],Xi.prototype,"offset",void 0),te([f(6,r)],Xi.prototype,"textureUV",void 0),te([f(7,V)],Xi.prototype,"sizing",void 0),te([f(8,a)],Xi.prototype,"placementAngle",void 0),te([f(9,a)],Xi.prototype,"sdfDecodeCoeff",void 0),te([f(10,r)],Xi.prototype,"zoomRange",void 0);class Yi extends z{}function Qi(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}function Ji(e){return e.multiply(e).divide(128)}te([f(12,r)],Yi.prototype,"offsetNextVertex1",void 0),te([f(13,r)],Yi.prototype,"offsetNextVertex2",void 0),te([f(14,r)],Yi.prototype,"textureUVNextVertex1",void 0),te([f(15,r)],Yi.prototype,"textureUVNextVertex2",void 0);class es extends pe{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=Ji(e.sizing.x),s=Ji(e.sizing.y),o=Ji(e.sizing.z),r=e.placementAngle,n=Ve(e.bitset,Oe.bitset.isSDF),u=Ve(e.bitset,Oe.bitset.isMapAligned),p=Ve(e.bitset,Oe.bitset.scaleSymbolsProportionally),c=Te(e.bitset,Oe.bitset.colorLocked),d=Me(this,e.id),m=Pe(this,e.id,e.color,c).multiply(d),f=this.view.displayViewScreenMat3.multiply(new y(e.pos.xy,1)),h=_e(this,e.id,o).divide(o),v=i.multiply(h),x=e.offset.xy.multiply(h);let b=s.multiply(p.multiply(h.subtract(1)).add(1));b=W(b,E(v.subtract(.99),new a(0)));const g=E(b,new a(1)),w=W(b,new a(1)),S=l.fromRotation(r.multiply(ze)),z=qe(this,e.id),_=this._getViewRotationMatrix(u).multiply(z).multiply(S).multiply(new y(x.xy,0)),P=this.clip(e.id,e.zoomRange),T=new V(f.xy.add(_.xy),P,1),M=e.textureUV.divide(this.mosaicInfo.size),C=e.outlineColor.multiply(w),R=Ve(e.bitset,Oe.bitset.overrideOutlineColor),A=e.sdfDecodeCoeff.multiply(v);return{glPosition:T,color:m,textureUV:M,outlineColor:C,outlineSize:g,distanceToPx:A,isSDF:n,overrideOutlineColor:R,...this.maybeRunHittest(e,t,{pos:e.pos,size:v,sizeCorrection:h,isMapAligned:u,vvRotationMat3:z,placementMat3:S,outlineSize:g,distanceToPx:A,isSDF:n})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return u(C(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new a(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,s=new a(1).subtract(e);return t.multiply(e).add(i.multiply(s))}_getColor(e,t){return u(c(t.isSDF,new a(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return b(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=b(this.mosaicInfo.texture,e),s=new a(.5).subtract(de(i)).multiply(t.distanceToPx).multiply(me),o=g(new a(.5).subtract(s),new a(0),new a(1)),r=t.color.multiply(o);let n=t.outlineSize;this.highlight&&(n=E(n,t.overrideOutlineColor.multiply(4)));const l=n.multiply(.5),u=w(s).subtract(l),p=g(new a(.5).subtract(u),new a(0),new a(1)),c=M(t.outlineColor,t.color,t.overrideOutlineColor).multiply(p);return new a(1).subtract(c.a).multiply(r).add(c)}_hittestSmallMarker(e,t,i){const{position:s,distance:o,smallSymbolDistance:a}=this.hittestRequest,r=o.subtract(a),{viewMat3:n,tileMat3:l}=this.view,u=n.multiply(l).multiply(new y(i.pos,1)).xy,p=i.size.multiply(.5);return R(u,s).subtract(p).add(r)}_hittestMarker(e,t,i){const{pos:s,sizeCorrection:o,isMapAligned:a}=i,r=new y(e.offset.multiply(o),0),n=new y(t.offsetNextVertex1.multiply(o),0),l=new y(t.offsetNextVertex2.multiply(o),0),{viewMat3:p,tileMat3:c}=this.view,d=p.multiply(c).multiply(new y(s,1)),m=this._getViewScreenMatrix(a).multiply(i.vvRotationMat3).multiply(i.placementMat3),f=d.add(m.multiply(r)).xy,h=d.add(m.multiply(n)).xy,v=d.add(m.multiply(l)).xy,x=this.hittestRequest.position,b=this.hittestRequest.distance,g=Ce(x,f,h,v);return u(A(g,b),g,this._hittestSamples(f,h,v,e,t,i))}_hittestSamples(e,t,i,s,o,n){const{outlineSize:l,isSDF:u,distanceToPx:p}=n,c=this.hittestRequest.position,d=this.hittestRequest.distance,m=Re(c.add(new r(I(d),I(d))),e,t,i),f=Re(c.add(new r(0,I(d))),e,t,i),h=Re(c.add(new r(d,I(d))),e,t,i),y=Re(c.add(new r(I(d),0)),e,t,i),v=Re(c,e,t,i),x=Re(c.add(new r(d,0)),e,t,i),b=Re(c.add(new r(I(d),d)),e,t,i),g=Re(c.add(new r(0,d)),e,t,i),w=Re(c.add(new r(d,d)),e,t,i),S=s.textureUV.divide(this.mosaicInfo.size),z=o.textureUVNextVertex1.divide(this.mosaicInfo.size),_=o.textureUVNextVertex2.divide(this.mosaicInfo.size),P={color:new V(1),outlineColor:new V(1),overrideOutlineColor:new a(1),outlineSize:l,distanceToPx:p,isSDF:u};let T=new a(0);return T=T.add(Ae(m).multiply(this._getColor(Qi(m,S,z,_),P).a)),T=T.add(Ae(f).multiply(this._getColor(Qi(f,S,z,_),P).a)),T=T.add(Ae(h).multiply(this._getColor(Qi(h,S,z,_),P).a)),T=T.add(Ae(y).multiply(this._getColor(Qi(y,S,z,_),P).a)),T=T.add(Ae(v).multiply(this._getColor(Qi(v,S,z,_),P).a)),T=T.add(Ae(x).multiply(this._getColor(Qi(x,S,z,_),P).a)),T=T.add(Ae(b).multiply(this._getColor(Qi(b,S,z,_),P).a)),T=T.add(Ae(g).multiply(this._getColor(Qi(g,S,z,_),P).a)),T=T.add(Ae(w).multiply(this._getColor(Qi(w,S,z,_),P).a)),O(T,new a(.05)).multiply(Ie(this.hittestRequest))}}te([h(ye)],es.prototype,"visualVariableColor",void 0),te([h(ve)],es.prototype,"visualVariableOpacity",void 0),te([h(ri)],es.prototype,"visualVariableRotation",void 0),te([h(xe)],es.prototype,"visualVariableSizeMinMaxValue",void 0),te([h(be)],es.prototype,"visualVariableSizeScaleStops",void 0),te([h(ge)],es.prototype,"visualVariableSizeStops",void 0),te([h(we)],es.prototype,"visualVariableSizeUnitValue",void 0),te([s(he)],es.prototype,"mosaicInfo",void 0),te([ie(0,F(Xi)),ie(1,F(Yi))],es.prototype,"vertex",null),te([ie(0,F(class extends Se{}))],es.prototype,"fragment",null);class ts{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map((([e,t])=>`${e}.${t}`)).join("."),i=jt(t);this._locationInfo={hash:i,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map((t=>`${t}.${e[t]}`)).join(".")}.${Object.keys(i).filter((e=>i[e])).map((e=>`${e}_${i[e].toString()}`)).join(".")}.${Object.keys(t).filter((e=>this.optionPropertyKeys.has(e))).join(".")}`}getProgram(e,t,i,s){let o="",a="";for(const e in i)if(i[e]){const t="boolean"==typeof i[e]?`#define ${e}\n`:`#define ${e} ${i[e]}\n`;o+=t,a+=t}return o+=this.vertexShader,a+=this.fragmentShader,new ee(o,a,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const e in this.required){const i=this.required[e];t.push({uniformHydrated:null,shaderModulePath:e,uniformName:e,uniformType:i.type,uniformArrayElementType:is(i),uniformArrayLength:ss(i)})}for(const i in e){const s=this.options[i];if(e[i])for(const e in s){const o=s[e];t.push({uniformHydrated:null,shaderModulePath:`${i}.${e}`,uniformName:e,uniformType:o.type,uniformArrayElementType:is(o),uniformArrayLength:ss(o)})}}return t}}const is=e=>"array"===e.type?e.elementType?.type:void 0,ss=e=>"array"===e.type?e.size:void 0,os={hittestDist:a,hittestPos:r},as={filterFlags:n,animation:n,visualVariableData:n,dataDriven0:n,dataDriven1:n,dataDriven2:n,gpgpu:n,size:a},rs={displayViewScreenMat3:l,displayViewMat3:l,displayMat3:l,viewMat3:l,tileMat3:l,displayZoomFactor:a,requiredZoomFactor:a,tileOffset:r,currentScale:a,currentZoom:a,metersPerSRUnit:a};class ns extends ts{constructor(){super(...arguments),this.vertexShader=Kt("materials/pie/pie.vert"),this.fragmentShader=Kt("materials/pie/pie.frag"),this.required={...as,...rs,outlineWidth:a,colors:j,defaultColor:V,othersColor:V,outlineColor:V,donutRatio:a,sectorThreshold:a},this.options={hittestUniforms:os,visualVariableSizeMinMaxValue:{minMaxValueAndSize:V},visualVariableSizeScaleStops:{sizes:{...j.ofType(a,8),type:"array",elementType:a,size:8},values:{...j.ofType(a,8),type:"array",elementType:a,size:8}},visualVariableSizeStops:{sizes:{...j.ofType(a,8),type:"array",elementType:a,size:8},values:{...j.ofType(a,8),type:"array",elementType:a,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:a},visualVariableOpacity:{opacities:{...j.ofType(a,8),type:"array",elementType:a,size:8},opacityValues:{...j.ofType(a,8),type:"array",elementType:a,size:8}}},this.locations={pos:{index:0,type:r},id:{index:1,type:y},bitset:{index:2,type:a},offset:{index:3,type:r},texCoords:{index:4,type:r},size:{index:5,type:r},referenceSize:{index:6,type:a},zoomRange:{index:7,type:r}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...j.ofType(V,e),type:"array",elementType:V,size:e}}}const ls={fill:new class extends yi{constructor(){super(...arguments),this.type=D.Fill,this.shaders={geometry:new Le}}render(e,t){const{painter:i}=e,s=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,s.uniforms),...lt(e,t.target)},defines:ut(e),optionalAttributes:s.optionalAttributes,useComputeBuffer:dt(e)}),i.setPipelineState(pt(e)),i.submitDraw(e,t)}},patternFill:new class extends yi{constructor(){super(...arguments),this.type=D.PatternFill,this.shaders={geometry:new Ue}}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,o.uniforms),...lt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:ft(t.target)},defines:{...ut(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:dt(e)}),s.setPipelineState(pt(e)),s.submitDraw(e,t)}},complexFill:new class extends yi{constructor(){super(...arguments),this.type=D.ComplexFill,this.shaders={geometry:new ke}}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,o.uniforms),...lt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:ft(t.target)},defines:{...ut(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:dt(e)}),s.setPipelineState(pt(e)),s.submitDraw(e,t)}},outlineFill:new class extends yi{constructor(){super(...arguments),this.type=D.OutlineFill,this.shaders={geometry:new Be}}render(e,t){const{painter:i,pixelRatio:s}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,o.uniforms),...lt(e,t.target),antialiasingControls:Mi(s)},defines:{...ut(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:dt(e)}),i.setPipelineState(pt(e)),i.submitDraw(e,t)}},patternOutlineFill:new class extends yi{constructor(){super(...arguments),this.type=D.PatternOutlineFill,this.shaders={geometry:new Ne}}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,a.uniforms),...lt(e,t.target),antialiasingControls:Mi(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:ft(t.target)},defines:{...ut(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:dt(e)}),s.setPipelineState(pt(e)),s.submitDraw(e,t)}},complexOutlineFill:new class extends yi{constructor(){super(...arguments),this.type=D.ComplexOutlineFill,this.shaders={geometry:new Ee}}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,a.uniforms),...lt(e,t.target),antialiasingControls:Mi(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:ft(t.target)},defines:{...ut(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:dt(e)}),s.setPipelineState(pt(e)),s.submitDraw(e,t)}},marker:new class extends yi{constructor(){super(...arguments),this.type=D.Marker,this.shaders={geometry:new es},this.symbologyPlane=rt.MARKER}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,o.uniforms),...lt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...ut(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:dt(e)}),s.setPipelineState(pt(e)),s.submitDraw(e,t)}},pieChart:new class extends yi{constructor(){super(...arguments),this.type=D.PieChart,this.shaders={geometry:new ns},this.symbologyPlane=rt.MARKER}render(e,t){const{painter:i}=e,{instance:s,target:o}=t,a=this.shaders.geometry,r=s.getInput(),n=r.uniforms.numberOfFields,l=dt(e),u=lt(e,o),p=ut(e);a.setNumberOfFields(n),i.setShader({shader:a,uniforms:{...nt(e,t.target,r.uniforms.shader),...u.storage,...u.view,hittestUniforms:u.hittestRequest?{hittestDist:u.hittestRequest?.distance,hittestPos:u.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!r.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!r.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!r.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!r.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!r.uniforms.shader.visualVariableOpacity,HITTEST:l,highlight:u.highlight?1:0,...p,numberOfFields:n},optionalAttributes:{},useComputeBuffer:l}),i.setPipelineState(pt(e)),i.submitDraw(e,t)}},line:new class extends yi{constructor(){super(...arguments),this.type=D.Line,this.shaders={geometry:new $e},this.symbologyPlane=rt.LINE}render(e,t){const{painter:i,pixelRatio:s}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,o.uniforms),...lt(e,t.target),antialiasingControls:Mi(s)},defines:{...ut(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:dt(e)}),i.setPipelineState(pt(e)),i.submitDraw(e,t)}},texturedLine:new class extends yi{constructor(){super(...arguments),this.type=D.TexturedLine,this.shaders={geometry:new Ki},this.symbologyPlane=rt.LINE}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,a=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...nt(e,t.target,a.uniforms),...lt(e,t.target),antialiasingControls:Mi(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...ut(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:dt(e)}),s.setPipelineState(pt(e)),s.submitDraw(e,t)}},text:new class extends yi{constructor(){super(...arguments),this.type=D.Text,this.shaders={geometry:new Zi},this.symbologyPlane=rt.TEXT}render(e,t){const{context:i,painter:s}=e,o=ut(e),a=t.instance.getInput(),r={shader:this.shaders.geometry,uniforms:{...nt(e,t.target,a.uniforms),...lt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...o,isBackgroundPass:!0,isLabel:!1,textRenderPassType:qi.Color},optionalAttributes:a.optionalAttributes,useComputeBuffer:dt(e)};s.setShader(r),s.setPipelineState(pt(e)),s.submitDraw(e,t),s.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:qi.Halo}}),s.submitDraw(e,t),s.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:qi.Outline}}),s.submitDraw(e,t),s.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:qi.Color}}),s.submitDraw(e,t)}},label:new class extends yi{constructor(){super(...arguments),this.type=D.Label,this.shaders={geometry:new Zi},this.drawPhase=ht.LABEL|ht.LABEL_ALPHA|ht.HITTEST,this.symbologyPlane=rt.TEXT}render(e,t){const{context:i,painter:s}=e,o=ut(e),a={...pt(e)},r=t.instance.getInput(),n={shader:this.shaders.geometry,uniforms:{...nt(e,t.target,r.uniforms),...lt(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...o,textRenderPassType:qi.Color,isBackgroundPass:!0,isLabel:!0},optionalAttributes:r.optionalAttributes,useComputeBuffer:dt(e)};s.setShader(n),s.setPipelineState(a),s.submitDraw(e,t),s.setShader({...n,defines:{...o,textRenderPassType:qi.Halo,isBackgroundPass:!1,isLabel:!0}}),s.setPipelineState(a),s.submitDraw(e,t),s.setShader({...n,defines:{...o,textRenderPassType:qi.Color,isBackgroundPass:!1,isLabel:!0}}),s.setPipelineState(a),s.submitDraw(e,t)}},heatmap:new class extends yi{constructor(){super(...arguments),this.type=D.Heatmap,this.drawPhase=ht.MAP|ht.HITTEST|ht.DEBUG,this.shaders={accumulate:new Oi,resolve:new ki},this._isBound=!1,this._resources=new Map}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:i,painter:s,state:o}=e,a=t.instance.getInput(),{isFieldActive:r}=a.uniforms,n=this._getOrCreateResourcesRecord(i),l=n.loadQualityProfile(i);dt(e)||this._bind(e,n,a),s.setShader({shader:this.shaders.accumulate,uniforms:{...lt(e,t.target),kernelControls:{radius:ji(a,o),isFieldActive:r?1:0}},defines:{...ut(e),...l.defines},optionalAttributes:{},useComputeBuffer:dt(e)});const u=dt(e)?Ui:Bi;s.setPipelineState(u),s.submitDraw(e,t)}getStencilReference(e){return Ei(e)}renderResolvePass(e,t){if(dt(e))return;const{context:i,painter:s}=e,o=this._resources.get(i);if(null==this._prevFBO||null==this._prevViewport||!o?.initialized)return;const{defines:a}=o.loadQualityProfile(i),{minDensity:r,maxDensity:n,radius:l}=t.getInput().uniforms,u=o.accumulateFramebuffer,p=o.resolveGradientTexture,c={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:8,texture:u.colorTexture},minAndInvRange:[r,1/(n-r)],normalization:3/(l*l*Math.PI)},gradient:{texture:{unit:9,texture:p}}},defines:a,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(u.colorTexture,8),i.bindTexture(p,9),s.setPipelineState(Ni),s.submitDrawMesh(i,c,s.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new Ci,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:s,state:o,pixelRatio:a}=e,r=s.getBoundFramebufferObject(),n=s.getViewport();this._prevFBO=r,this._prevViewport=n;const{gradient:l,gradientHash:u}=i.uniforms;t.ensureResolveGradientTexture(s,u,l);const{width:p,height:c}=n,d=function(e,t){const i=t>1.5?.25:.5;return e<1/(2*i)?1:i}(ji(i,o),a),m=p*d,f=c*d,h=t.ensureAccumulateFBO(s,m,f);s.blitFramebuffer(r,h,0,0,r.width,r.height,0,0,h.width,h.height,Ot.STENCIL,Ct.NEAREST),s.bindFramebuffer(h),s.setViewport(0,0,h.width,h.height),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(Ot.COLOR),this._isBound=!0}},dotDensity:new class extends yi{constructor(){super(...arguments),this.type=D.DotDensity,this.shaders={polygon:new _i,point:new wi,fill:new Le},this._resources=new Map}render(e,t){ct(e)||dt(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:{...lt(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...ut(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:dt(e)}),i.setPipelineState(pt(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){const{context:i,painter:s,requiredLevel:o}=e,a=t.instance.getInput().uniforms,r=this._getOrCreateResourcesRecord(i),n=r.getDotDensityTextures(i,wt,a.seed),l=1/2**(o-t.target.key.level),u=wt,p=u*window.devicePixelRatio*u*window.devicePixelRatio,c=1/l*(1/l),d=a.dotScale?e.state.scale/a.dotScale:1,m=a.dotValue*d*c;s.setShader({shader:this.shaders.polygon,uniforms:{...lt(e,t.target),instance:{isActive:a.isActive,colors:a.colors,dotValue:Math.max(1,m)},draw:{dotTexture0:{unit:St,texture:n[0]},dotTexture1:{unit:Vt,texture:n[1]},tileZoomFactor:l,pixelRatio:window.devicePixelRatio,tileDotsOverArea:p/(wt*window.devicePixelRatio*wt*window.devicePixelRatio)}},defines:{...ut(e),blending:a.blending},optionalAttributes:{},useComputeBuffer:!1});const f=i.getViewport();i.setViewport(0,0,wt,wt);const h=i.getBoundFramebufferObject(),y=r.getFBO(i);i.bindFramebuffer(y),i.setClearColor(0,0,0,0),i.clear(Ot.COLOR),s.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),s.updatePipelineState(i),s.submitDraw(e,t),i.bindFramebuffer(h),i.setViewport(f.x,f.y,f.width,f.height);const v=r.getFBO(i).colorTexture,x={shader:this.shaders.point,uniforms:{view:mt(e,t.target),instance:{dotSize:a.dotSize},draw:{locations:{unit:St,texture:v},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...ut(e)},optionalAttributes:{},useComputeBuffer:!1};s.setPipelineState(pt(e)),s.submitDrawMesh(i,x,r.getDotDensityMesh(i,gt(this.shaders.point)))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return null==t&&(t=new Ti,this._resources.set(e,t)),t}},animatedMarker:new class extends vi{constructor(){super(...arguments),this.type=D.AnimatedMarker,this.shaders={geometry:new hi}}}};function us(){for(const e in ls)ls[e].startup()}function ps(e){for(const t in ls)ls[t].shutdown(e)}function cs(e,t){const i=e.slice(0,t),s=t-i.length;for(let e=0;e<s;e++){const e=i[i.length-1];i.push(e)}return i}function ds(e){if(!e)return[0,0,0,0];const{r:t,g:i,b:s,a:o}=e;return[t*(o/255),i*(o/255),s*(o/255),o]}const ms=()=>Nt.getLogger("esri.views.2d.layers.features.support.rendererUtils");function fs(e){return e.map((e=>function(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}(e)?function(e){return e.stops=(t=e.type,(i=e.stops??[]).length<=8?i:(ms().warn(`Found ${i.length} Visual Variable stops, but MapView only supports 8. Displayed stops will be simplified.`),i.length>16?function(e,t){const[i,...s]=t,o=s.pop(),a=s[0].value,r=s[s.length-1].value,n=(r-a)/6,l=[];for(let i=a;i<r;i+=n){let o=0;for(;i>=s[o].value;)o++;const a=s[o],r=t[o-1],n=i-r.value,u=a.value===r.value?1:n/(a.value-r.value);if("color"===e){const e=s[o],a=t[o-1],r=e.color.clone();r.r=hs(a.color.r,r.r,u),r.g=hs(a.color.g,r.g,u),r.b=hs(a.color.b,r.b,u),r.a=hs(a.color.a,r.a,u),l.push({value:i,color:r,label:e.label})}else if("size"===e){const e=s[o],a=t[o-1],r=Wt(e.size),n=hs(Wt(a.size),r,u);l.push({value:i,size:n,label:e.label})}else{const e=s[o],a=hs(t[o-1].opacity,e.opacity,u);l.push({value:i,opacity:a,label:e.label})}}return[i,...l,o]}(t,i):function(e){const[t,...i]=e,s=i.pop();for(;i.length>6;){let e=0,t=0;for(let s=1;s<i.length;s++){const o=i[s-1],a=i[s],r=Math.abs(a.value-o.value);r>t&&(t=r,e=s)}i.splice(e,1)}return[t,...i,s]}(i))),e;var t,i}(e.clone()):e))}function hs(e,t,i){return(1-i)*e+i*t}function ys(e){if(!e)return!0;switch(e.type){case"dot-density":break;case"heatmap":if(!function(){const{supportsColorBufferFloat:e,supportsColorBufferFloatBlend:t,supportsColorBufferHalfFloat:i}=Jt();return e&&t||i}()){const e=Jt(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter((t=>!e[t])).join(", ");return ms().errorOnce(new Qt("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}function vs(e){if(!e.stops?.length)return null;const t=cs(e.stops.sort(((e,t)=>e.value-t.value)),8),i=t.map((({value:e})=>e)),s=t.map((({color:e})=>ds(e)));return{values:i,colors:s}}function xs(e){if(!e.stops?.length)return null;const t=cs(e.stops.sort(((e,t)=>e.value-t.value)),8);return{opacityValues:t.map((({value:e})=>e)),opacities:t.map((({opacity:e})=>e))}}function bs(e){return{rotationType:"geographic"===e.rotationType?ne.Geographic:ne.Arithmatic}}function gs(e){if(!e.stops?.length)return null;if(e.stops.some((e=>e.useMaxValue||e.useMinValue)))return(t,i)=>{const s=t.statisticsByLevel.get(i.key.level),o=cs(e.stops.map((t=>({value:t.useMaxValue?s?.get(e.field)?.maxValue??0:t.useMinValue?s?.get(e.field)?.minValue??0:t.value,size:t.size?Gt(t.size):Pt}))).sort(((e,t)=>e.value-t.value)),8);return{values:o.map((({value:e})=>e)),sizes:o.map((({size:e})=>e))}};const t=cs(e.stops.sort(((e,t)=>e.value-t.value)),8);return{values:t.map((({value:e})=>e)),sizes:t.map((({size:e})=>Gt(e)))}}function ws(e){return t=>{const{state:i}=t;return{unitValueToPixelsRatio:Xt(i.spatialReference)/Yt[e.valueUnit??"meters"]/i.resolution}}}function Ss(e,t){const i=t.length;if(e<t[0].value||1===i)return t[0].size;for(let s=1;s<i;s++)if(e<t[s].value){const i=(e-t[s-1].value)/(t[s].value-t[s-1].value);return t[s-1].size+i*(t[s].size-t[s-1].size)}return t[i-1].size}function Vs(e){const{minDataValue:t,maxDataValue:i,minSize:s,maxSize:o}=e;if("object"==typeof s&&"object"==typeof o)return(e,a)=>{const r=e.state.scale,n=Gt(Ss(r,s.stops)),l=Gt(Ss(r,o.stops));return{minMaxValueAndSize:[t,i,n,l]}};if("object"==typeof s||"object"==typeof o)throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[t,i,Gt(s),Gt(o)]}}const zs={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function _s(e,t=128,i=1.25){if(e.visualVariableSizeMinMaxValue)return e.visualVariableSizeMinMaxValue instanceof Function?128:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,t);if(e.visualVariableSizeScaleStops){if(e.visualVariableSizeScaleStops instanceof Function)return 128;const s=e.visualVariableSizeScaleStops.sizes;return Math.max(s[s.length-1]*i,t)}if(e.visualVariableSizeStops){if(e.visualVariableSizeStops instanceof Function)return 128;const s=e.visualVariableSizeStops.sizes;return Math.max(s[s.length-1]*i,t)}return e.visualVariableSizeUnitValue?256:0}function Ps(e){const t={...zs};if(!e||!("visualVariables"in e)||!e.visualVariables)return t;for(const s of fs(e.visualVariables))switch(s.type){case"color":t.visualVariableColor=vs(s);break;case"opacity":t.visualVariableOpacity=xs(s);break;case"rotation":t.visualVariableRotation=bs(s);break;case"size":switch("number"==typeof(i=s).minDataValue&&"number"==typeof i.maxDataValue&&null!=i.minSize&&null!=i.maxSize?"min-max":"$view.scale"===i?.valueExpression&&Array.isArray(i.stops)?"scale-stops":null==i.field&&"$view.scale"===i?.valueExpression||!(Array.isArray(i.stops)||"levels"in i&&i.levels)?null!=i.field||"$view.scale"!==i?.valueExpression?"unit-value":null:"field-stops"){case"field-stops":t.visualVariableSizeStops=gs(s);break;case"scale-stops":"outline"===s.target?t.visualVariableSizeOutlineScaleStops=gs(s):t.visualVariableSizeScaleStops=gs(s);break;case"min-max":t.visualVariableSizeMinMaxValue=Vs(s);break;case"unit-value":t.visualVariableSizeUnitValue=ws(s)}}var i;return t}function Ts(e){return!!(e.visualVariableSizeMinMaxValue||e.visualVariableSizeScaleStops||e.visualVariableSizeStops||e.visualVariableSizeUnitValue||e.visualVariableSizeOutlineScaleStops)}function Ms(e){return!!e.visualVariableRotation}function Cs(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function Rs(e){if(null==e)return null;if(Array.isArray(e)){const[t,i,s,o]=e;return[t,i,s,255*o]}return"string"==typeof e?e:{...e,defaultValue:Rs(e?.defaultValue)}}async function As(t,i){const{cimResourceManager:s,cimAnalyzer:o,scaleExpression:a}=i.schemaOptions;await Promise.all(e.fetchResources(t.symbol,s,[]));const r=o.analyzeSymbolReference(t,!1),n={scaleInfo:Cs(t),scaleExpression:a},l=[];for(const e of r)switch(e.type){case"marker":l.push(...Is(e,i,n));break;case"fill":l.push(...Ls(e,i,n));break;case"line":l.push(...Es(e,i,n));break;case"text":l.push(...js(e,i,n))}return l}function Is(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r=e.isOutline?{...zs,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation};return e.animationParams?Os(a.ensureInstance(ls.animatedMarker,{uniforms:r,optionalAttributes:{zoomRange:!0}}),e,0,i):Fs(a.ensureInstance(ls.marker,{uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,s,i)}function Os(e,t,s,o){return t.animationParams?[e.createMeshInfo({pixelDimensions:t.pixelDimensions,texelDimensions:t.texelDimensions,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,sprite:t.spriteRasterizationParam,animations:t.animationParams,scaleInfo:o.scaleInfo,scaleSymbolsProportionally:t.scaleSymbolsProportionally,strokeWidth:t.outlineWidth,isMapAligned:t.alignment===i.MAP,colorLocked:t.colorLocked,isStroke:t.isStroke,baseSize:t.baseSize,referenceSize:t.referenceSize,angleToLine:!!t.markerPlacement&&t.markerPlacement.placement&&"angleToLine"in t.markerPlacement.placement&&t.markerPlacement.placement.angleToLine,sizeRatio:t.sizeRatio})]:[]}function Fs(e,i,s,{scaleInfo:o,scaleExpression:a}){const r=Ts(s);return[e.createMeshInfo({size:i.size,scaleX:i.scaleX,anchorX:i.anchorPoint.x,anchorY:i.anchorPoint.y,angle:i.rotation,color:Rs(i.color)??[0,0,0,0],colorLocked:i.colorLocked,frameHeight:i.frameHeight,widthRatio:i.widthRatio,scaleInfo:o,offsetX:i.offsetX,offsetY:i.offsetY,outlineColor:Rs(i.outlineColor)??[0,0,0,0],outlineSize:i.outlineWidth,referenceSize:i.referenceSize||t.CIMVectorMarker.size,rotateClockwise:i.rotateClockwise,scaleFactor:a??1,sizeRatio:i.sizeRatio,alignment:i.alignment,isAbsoluteAnchorPoint:i.isAbsoluteAnchorPoint,scaleSymbolsProportionally:i.scaleSymbolsProportionally,sprite:i.spriteRasterizationParam,hasSizeVV:r,placement:i.markerPlacement,effects:i.effects?{type:"cim-effect-infos",effectInfos:i.effects}:null,transforms:i.transform,minPixelBuffer:_s(s)})]}function Ds(e,t,{scaleInfo:i}){return[e.createMeshInfo({color:Rs(t.color)??[0,0,0,0],scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function Ls(e,t,i){if(!e.spriteRasterizationParam)return function(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return Ds(a.ensureInstance(ls.fill,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}(e,t,i);const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return ks(a.ensureInstance(ls.complexFill,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,null!=s.visualVariableColor,i)}function ks(e,t,i,{scaleInfo:s}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=!!t.hasUnresolvedReplacementColor&&(!i||t.colorLocked),a=t.sampleAlphaOnly&&!o,r=t.spriteRasterizationParam;return[e.createMeshInfo({color:Rs(t.color)??[0,0,0,0],height:t.height,aspectRatio:t.scaleX,offsetX:t.offsetX,offsetY:t.offsetY,scaleX:1,scaleY:1,angle:t.angle,applyRandomOffset:t.applyRandomOffset,sampleAlphaOnly:a,scaleProportionally:"CIMHatchFill"===r.resource.type,sprite:r,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function Es(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o,r=e.isOutline?{...zs,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},n={uniforms:r,optionalAttributes:{zoomRange:!!i.scaleInfo}},l=!!(r.visualVariableSizeMinMaxValue||r.visualVariableSizeScaleStops||r.visualVariableSizeStops||r.visualVariableSizeUnitValue);return e.spriteRasterizationParam?Ns(a.ensureInstance(ls.texturedLine,n),e,l,i):Us(a.ensureInstance(ls.line,n),e,l,i)}function Bs(e,t,{scaleInfo:i}){return{color:Rs(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:i,hasSizeVV:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}function Us(e,t,i,s){if(t.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const o=Bs(t,i,s);return[e.createMeshInfo(o)]}function Ns(e,t,i,s){const{spriteRasterizationParam:o,scaleDash:a,sampleAlphaOnly:r}=t;if(!o)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({...Bs(t,i,s),offsetAlongLine:t.offsetAlongLine??0,shouldScaleDash:a??!1,shouldSampleAlphaOnly:r,isSDF:"CIMPictureStroke"!==o.resource.type,sprite:o})]}function js(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:a}=o;return Hs(a.ensureInstance(ls.text,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1}}),e,s,i)}function Hs(e,t,i,{scaleInfo:s,scaleExpression:o}){return[e.createMeshInfo({boxBackgroundColor:Rs(t.backgroundColor),boxBorderLineColor:Rs(t.borderLineColor),boxBorderLineSize:t.borderLineWidth??0,color:Rs(t.color)??[0,0,0,0],offsetX:t.offsetX,offsetY:t.offsetY,postAngle:t.angle,fontSize:t.size,referenceSize:t.referenceSize,decoration:t.decoration,haloColor:Rs(t.haloColor)??[0,0,0,0],haloSize:t.haloSize??0,outlineColor:Rs(t.outlineColor)??[0,0,0,0],outlineSize:t.outlineSize,lineWidth:t.lineWidth||512,lineHeightRatio:1,horizontalAlignment:t.horizontalAlignment??"center",verticalAlignment:t.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:t.textRasterizationParam,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,placement:t.markerPlacement,transforms:t.transform,scaleFactor:o??1,minPixelBuffer:_s(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null})]}function qs(e,t){return{type:"simple",filters:t,capabilities:{maxTextureSize:Jt().maxTextureSize},bindings:Ws(e)}}function Gs(e){switch(e){case"opacity":return yt.OPACITY;case"color":return yt.COLOR;case"rotation":return yt.ROTATION;case"size":return yt.SIZE;default:return null}}function Ws(e){if(!e)return[];switch(e.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return Zs(e);case"dot-density":return function(e){const t=[];for(const i of e.attributes)t.push({binding:t.length,expression:i.valueExpression,field:i.field});return t}(e);case"pie-chart":return function(e){const t=Zs(e);let i=4;for(const s of e.attributes)t.push({binding:i++,expression:s.valueExpression,field:s.field});return t}(e);case"heatmap":return function({valueExpression:e,field:t}){return e||t?[{binding:0,expression:e,field:t}]:[]}(e)}}function Zs(e){return"visualVariables"in e&&e.visualVariables?.length?fs(e.visualVariables).map((e=>function(e){switch(e.type){case"size":return function(e){return"$view.scale"===e.valueExpression?null:{binding:Gs(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression,valueRepresentation:e.valueRepresentation}}(e);case"color":case"opacity":return function(e){return{binding:Gs(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}(e);case"rotation":return function(e){return{binding:Gs(e.type),expression:e.valueExpression,field:e.field}}(e)}}(e))).filter(ae):[]}class $s{constructor(e){this.updateTracking=new it({debugName:"FeatureCommandQueue"}),this._queueProcessor=new ti({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return ei(this.updateTracking.addPromise(this._doPush(e)))}async _doPush(e){const t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"highlight":if(i?.type===e.type)return;return t.push(e);case"edit-by-id":case"edit-by-feature":return t.push(e)}}}export{$s as F,oi as S,ls as T,Ns as a,Us as b,Hs as c,Ds as d,ks as e,Os as f,Cs as g,Fs as h,qs as i,As as j,Ps as k,_s as l,Ts as m,zs as n,Ms as o,ds as p,ys as q,Zs as r,ii as s,us as t,ps as u};
