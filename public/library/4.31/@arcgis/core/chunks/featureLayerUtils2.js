/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{e as r,q as t}from"../core/lang.js";import"../core/Error.js";import{s as e,a as o}from"./utils25.js";import{p as s}from"./arcgisLayerUrl.js";import{f as a,g as i}from"./fetchService.js";import{k as n}from"./layerUtils.js";import{l as p}from"./lazyLayerLoader.js";import{b as l,r as m,t as c,a as u,c as y}from"./portalItemUtils.js";import"./Logger.js";import"../config.js";import"./originUtils.js";import"./multiOriginJSONSupportUtils.js";import"../portal/Portal.js";import"./tslib.es6.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"./reader.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./persistableUrlUtils.js";import"./jsonContext.js";import"./saveUtils.js";import"./requestPresets.js";import"../geometry/projection.js";import"./SimpleObservable.js";import"./vec3f64.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"../geometry/Polyline.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";const j="Feature Service",f="feature-layer-utils",d=`${f}-save`,g=`${f}-save-as`;function b(r){return{isValid:n(r)&&(!("dynamicDataSource"in r)||!r.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function P(r){const t=[],e=[];for(const{layer:o,layerJSON:s}of r)o.isTable?e.push(s):t.push(s);return{layers:t,tables:e}}function S(r){return P([r])}function I(t,e){if(t.length<2)return;const o=[];for(const{id:r}of t)o.push(r);r(o.sort(h),e.slice().sort(h))&&t.sort(((r,t)=>{const o=e.indexOf(r.id),s=e.indexOf(t.id);return o<s?-1:o>s?1:0}))}function h(r,t){return r<t?-1:r>t?1:0}function T(r,e,o){const s=t(r,e,((r,t)=>r.id===t.id));r=r.filter((r=>!s.removed.some((t=>t.id===r.id))));const a=s.added;return a.forEach((({id:t})=>{r.push({id:t})})),{itemResources:r,added:a.filter((({id:r})=>!o.includes(r)))}}function E(r,t,e){r.isTable?U(e.tables,t):U(e.layers,t)}function U(r,t){const e=r.findIndex((({id:r})=>r===t.id));-1===e?r.push(t):r[e]=t}async function L(r,t,e){!function(r,t){const e=r.layers.some((r=>"OrientedImageryLayer"===r.layerType));y(t,c.ORIENTED_IMAGERY_LAYER,e)}(e,t)}async function v(r,t){const{url:e,layerId:o,title:a,fullExtent:i,isTable:n}=r,p=s(e);t.url=("FeatureServer"===p?.serverType?e:`${e}/${o}`)??null,t.title||=a,t.extent=null,n||null==i||(t.extent=await l(i)),m(t,c.METADATA),m(t,c.MULTI_LAYER),u(t,c.SINGLE_LAYER),y(t,c.TABLE,n),function(r,t){const e=r.some((r=>"oriented-imagery"===r.type));y(t,c.ORIENTED_IMAGERY_LAYER,e)}([r],t)}async function A(r,t){return e({layer:r,itemType:j,validateLayer:b,createItemData:(r,t)=>async function(r,t){return/\/\d+\/?$/.test(r.url)?S(t[0]):async function(r,t){if(r.reverse(),!t)return P(r);const e=await async function(r,t){let e=await r.fetchData("json");if(function(r){return!!(r&&Array.isArray(r.layers)&&Array.isArray(r.tables))}(e))return e;e||={},function(r){r.layers||=[],r.tables||=[]}(e);const{layer:{url:o,customParameters:s,apiKey:n}}=t[0];return await async function(r,t,e){const{url:o,customParameters:s,apiKey:n}=t,{serviceJSON:l,layersJSON:m}=await a(o,{customParameters:s,apiKey:n}),c=T(r.layers,l.layers,e),u=T(r.tables,l.tables,e);r.layers=c.itemResources,r.tables=u.itemResources;const y=[...c.added,...u.added],j=m?[...m.layers,...m.tables]:[];await async function(r,t,e,o){const s=await async function(r){const t=[];r.forEach((({type:r})=>{const e=i(r),o=p[e];t.push(o())}));const e=await Promise.all(t),o=new Map;return r.forEach((({type:r},t)=>{o.set(r,e[t])})),o}(t),a=t.map((({id:r,type:t})=>new(s.get(t))({url:e,layerId:r,sourceJSON:o.find((({id:t})=>t===r))})));await Promise.allSettled(a.map((r=>r.load()))),a.forEach((t=>{const{layerId:e,loaded:o,defaultPopupTemplate:s}=t;if(!o||null==s)return;const a={id:e,popupInfo:s.toJSON()};"ArcGISFeatureLayer"!==t.operationalLayerType&&(a.layerType=t.operationalLayerType),E(t,a,r)}))}(r,y,o,j)}(e,{url:o??"",customParameters:s,apiKey:n},t.map((r=>r.layer.layerId))),e}(t,r);for(const t of r)E(t.layer,t.layerJSON,e);return function(r,t){const e=[],o=[];for(const{layer:r}of t){const{isTable:t,layerId:s}=r;t?o.push(s):e.push(s)}I(r.layers,e),I(r.tables,o)}(e,r),e}(t,r)}(t,[r]),errorNamePrefix:d,setItemProperties:L},t)}async function O(r,t,e){return o({layer:r,itemType:j,validateLayer:b,createItemData:(r,t)=>Promise.resolve(S(r)),errorNamePrefix:g,newItem:t,setItemProperties:v},e)}export{A as save,O as saveAs};
