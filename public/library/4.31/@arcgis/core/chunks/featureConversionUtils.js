/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import t from"../core/Error.js";import{L as e}from"./Logger.js";import{b as o}from"./maybe.js";import{i as n,a as r}from"./aaBoundingBox.js";import{f as s}from"./aaBoundingRect.js";import{isPoint as u,isPolygon as l,isPolyline as c,isMultipoint as i}from"../geometry/support/jsonUtils.js";import{O as a}from"./OptimizedFeature.js";import{O as f}from"./OptimizedFeatureSet.js";import{O as d}from"./OptimizedGeometry.js";function h(t,e){return t?e?4:3:e?3:2}const m=()=>e.getLogger("esri.layers.graphics.featureConversionUtils"),g={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0,esriGeometryMultiPatch:3,esriGeometryEnvelope:0},y=(t,e,o,n,r,s)=>{t[o]=r,t[o+1]=s},p=(t,e,o,n,r,s)=>{t[o]=r,t[o+1]=s,t[o+2]=e[n+2]},b=(t,e,o,n,r,s)=>{t[o]=r,t[o+1]=s,t[o+2]=e[n+3]},w=(t,e,o,n,r,s)=>{t[o]=r,t[o+1]=s,t[o+2]=e[n+2],t[o+3]=e[n+3]};function M(t,e,o,n){if(t){if(o)return e&&n?w:p;if(e&&n)return b}else if(e&&n)return p;return y}function G({scale:t,translate:e},o){return Math.round((o-e[0])/t[0])}function I({scale:t,translate:e},o){return Math.round((e[1]-o)/t[1])}function N({scale:t,translate:e},o,n){return o*t[n]+e[n]}function T(t,e,o){return t?e?o?k(t):F(t):o?Z(t):P(t):null}function P(t){const e=t.coords;return{x:e[0],y:e[1]}}function j(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t}function F(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2]}}function x(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t}function Z(t){const e=t.coords;return{x:e[0],y:e[1],m:e[2]}}function v(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.m,t}function k(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2],m:e[3]}}function z(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t.coords[3]=e.m,t}function E(t,e){return t&&e?z:t?x:e?v:j}function L(t,e,o=E(null!=e.z,null!=e.m)){return o(t,e)}function O(t,e,o){if(null==t)return null;const n=h(e,o),r=[];for(let e=0;e<t.coords.length;e+=n){const o=[];for(let r=0;r<n;r++)o.push(t.coords[e+r]);r.push(o)}return e?o?{points:r,hasZ:e,hasM:o}:{points:r,hasZ:e}:o?{points:r,hasM:o}:{points:r}}function q(t,e,o=h(e.hasZ,e.hasM)){t.lengths[0]=e.points.length;const n=t.coords;let r=0;for(const t of e.points)for(let e=0;e<o;e++)n[r++]=t[e];return t}function U(t,e,o){if(!t)return null;const n=h(e,o),{coords:r,lengths:s}=t,u=[];let l=0;for(const t of s){const e=[];for(let o=0;o<t;o++){const t=[];for(let e=0;e<n;e++)t.push(r[l++]);e.push(t)}u.push(e)}return e?o?{paths:u,hasZ:e,hasM:o}:{paths:u,hasZ:e}:o?{paths:u,hasM:o}:{paths:u}}function R(t,e,o=h(e.hasZ,e.hasM)){const{lengths:n,coords:r}=t;let s=0;for(const t of e.paths){for(const e of t)for(let t=0;t<o;t++)r[s++]=e[t];n.push(t.length)}return t}function S(t,e,o){if(!t)return null;const n=h(e,o),{coords:r,lengths:s}=t,u=[];let l=0;for(const t of s){const e=[];for(let o=0;o<t;o++){const t=[];for(let e=0;e<n;e++)t.push(r[l++]);e.push(t)}u.push(e)}return e?o?{rings:u,hasZ:e,hasM:o}:{rings:u,hasZ:e}:o?{rings:u,hasM:o}:{rings:u}}function V(t,e,o=e.hasZ,n=e.hasM){return Y(t,e.rings,o,n)}function Y(t,e,o,n){const r=h(o,n),{lengths:s,coords:u}=t;let l=0;it(t);for(const t of e){for(const e of t)for(let t=0;t<r;t++)u[l++]=e[t];s.push(t.length)}return t}const $=[],_=[];function B(t,e,o,n,r){$[0]=t;const[s]=A(_,$,e,o,n,r);return at($),at(_),s}function A(e,o,n,r,s,u){if(at(e),!n){for(const t of o){const o=u?t.attributes[u]:void 0;e.push(new a(null,t.attributes,null,o))}return e}switch(n){case"esriGeometryPoint":return function(t,e,o,n,r){const s=E(o,n);for(const{geometry:o,attributes:n}of e){const e=null!=o?s(new d,o):null;t.push(new a(e,n,null,r?n[r]:void 0))}return t}(e,o,r,s,u);case"esriGeometryMultipoint":return function(t,e,o,n,r){const s=h(o,n);for(const{geometry:o,attributes:n}of e){const e=null!=o?q(new d,o,s):null;t.push(new a(e,n,null,r?n[r]:void 0))}return t}(e,o,r,s,u);case"esriGeometryPolyline":return function(t,e,o,n,r){const s=h(o,n);for(const{geometry:o,attributes:n,centroid:u}of e){const e=null!=o?R(new d,o,s):null,l=null!=u?L(new d,u):null;t.push(new a(e,n,l,r?n[r]:void 0))}return t}(e,o,r,s,u);case"esriGeometryPolygon":case"esriGeometryMultiPatch":return function(t,e,o,n,r){for(const{geometry:s,centroid:u,attributes:l}of e){const e=null!=s?V(new d,s,o,n):null,c=r?l[r]:void 0;null!=u?t.push(new a(e,l,j(new d,u),c)):t.push(new a(e,l,null,c))}return t}(e,o,r,s,u);default:m().error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${n}'`)),at(e)}return e}function C(t,e,o,n){_[0]=t,J($,_,e,o,n);const r=$[0];return at($),at(_),r}function D(e,o,n){if(null==e)return null;const r=new d;return"hasZ"in e&&null==o&&(o=e.hasZ),"hasM"in e&&null==n&&(n=e.hasM),u(e)?E(null!=o?o:null!=e.z,null!=n?n:null!=e.m)(r,e):l(e)?V(r,e,o,n):c(e)?R(r,e,h(o,n)):i(e)?q(r,e,h(o,n)):void m().error("convertFromGeometry:unknown-geometry",new t(`Unable to parse unknown geometry type '${e}'`))}function H(e,o,n,r){const s=e&&("coords"in e?e:e.geometry);if(null==s)return null;switch(o){case"esriGeometryPoint":{let t=P;return n&&r?t=k:n?t=F:r&&(t=Z),t(s)}case"esriGeometryMultipoint":return O(s,n,r);case"esriGeometryPolyline":return U(s,n,r);case"esriGeometryPolygon":return S(s,n,r);default:return m().error("convertToGeometry:unknown-geometry",new t(`Unable to parse unknown geometry type '${o}'`)),null}}function J(e,o,n,r,s){if(at(e),null==n)return function(t,e){for(const o of e)t.push({attributes:o.attributes});return t}(e,o);switch(n){case"esriGeometryPoint":return function(t,e,o,n){let r=P;o&&n?r=k:o?r=F:n&&(r=Z);for(const o of e){const{geometry:e,attributes:n}=o,s=null!=e?r(e):null;t.push({attributes:n,geometry:s})}return t}(e,o,r,s);case"esriGeometryMultipoint":return function(t,e,o,n){for(const{geometry:r,attributes:s}of e)t.push({attributes:s,geometry:null!=r?O(r,o,n):null});return t}(e,o,r,s);case"esriGeometryPolyline":return function(t,e,o,n){for(const{geometry:r,attributes:s}of e)t.push({attributes:s,geometry:null!=r?U(r,o,n):null});return t}(e,o,r,s);case"esriGeometryPolygon":return function(t,e,o,n){for(const{geometry:r,attributes:s,centroid:u}of e){const e=null!=r?S(r,o,n):null;if(null!=u){const o=P(u);t.push({attributes:s,centroid:o,geometry:e})}else t.push({attributes:s,geometry:e})}return t}(e,o,r,s);default:m().error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${n}'`))}return e}function K(t){const{objectIdFieldName:e,spatialReference:o,transform:n,fields:r,hasM:s,hasZ:u,features:l,geometryType:c,exceededTransferLimit:i,uniqueIdField:a,queryGeometry:f,queryGeometryType:d}=t,h={features:J([],l,c,u,s),fields:r,geometryType:c,objectIdFieldName:e,spatialReference:o,uniqueIdField:a,queryGeometry:H(f,d,!1,!1)};return n&&(h.transform=n),i&&(h.exceededTransferLimit=i),s&&(h.hasM=s),u&&(h.hasZ=u),h}function Q(e,o){const n=new f,{hasM:r,hasZ:s,features:u,objectIdFieldName:l,spatialReference:c,geometryType:i,exceededTransferLimit:a,transform:d,fields:h}=e;return h&&(n.fields=h),n.geometryType=i??null,n.objectIdFieldName=l??o??null,n.spatialReference=c??null,n.objectIdFieldName?(u&&A(n.features,u,i,s,r,n.objectIdFieldName),a&&(n.exceededTransferLimit=a),r&&(n.hasM=r),s&&(n.hasZ=s),d&&(n.transform=d),n):(m().error(new t("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)}function W(t){const{transform:e,features:o,hasM:n,hasZ:r}=t;if(!e)return t;for(const t of o)null!=t.geometry&&st(t.geometry,t.geometry,n,r,e),null!=t.centroid&&st(t.centroid,t.centroid,n,r,e);return t.transform=null,t}function X(t,e){const{geometryType:o,features:n,hasM:r,hasZ:s}=e;if(!t)return e;for(let e=0;e<n.length;e++){const u=n[e],l=u.weakClone();l.geometry=new d,tt(l.geometry,u.geometry,r,s,o,t),u.centroid&&(l.centroid=new d,tt(l.centroid,u.centroid,r,s,"esriGeometryPoint",t)),n[e]=l}return e.transform=t,e}function tt(t,e,o,n,r,s,u=o,l=n){if(it(t),!e?.coords.length)return null;const c=g[r],{coords:i,lengths:a}=e,f=h(o,n),d=h(o&&u,n&&l),m=M(o,n,u,l);if(!a.length)return m(t.coords,i,0,0,G(s,i[0]),I(s,i[1])),it(t,f,0),t;let y,p,b,w,N=0,T=0,P=T;for(const e of a){if(e<c)continue;let o=0;T=P,b=y=G(s,i[N]),w=p=I(s,i[N+1]),m(t.coords,i,T,N,b,w),o++,N+=f,T+=d;for(let n=1;n<e;n++,N+=f)b=G(s,i[N]),w=I(s,i[N+1]),b===y&&w===p||(m(t.coords,i,T,N,b-y,w-p),T+=d,o++,y=b,p=w);o>=c&&(t.lengths.push(o),P=T)}return at(t.coords,P),t.coords.length?t:null}function et(t,e,o,n,r,s,u=o,l=n){if(it(t),!e?.coords.length)return null;const c=g[r],{coords:i,lengths:a}=e,f=h(o,n),d=h(o&&u,n&&l),m=M(o,n,u,l);if(!a.length)return m(t.coords,i,0,0,i[0],i[1]),it(t,f,0),t;let y=0;const p=s*s;for(const e of a){if(e<c){y+=e*f;continue}const o=t.coords.length/d,n=y,r=y+(e-1)*f;m(t.coords,i,t.coords.length,n,i[n],i[n+1]),nt(t.coords,i,f,p,m,n,r),m(t.coords,i,t.coords.length,r,i[r],i[r+1]);const s=t.coords.length/d-o;s>=c?t.lengths.push(s):at(t.coords,o*d),y+=e*f}return t.coords.length?t:null}function ot(t,e,o,n){const r=t[e],s=t[e+1],u=t[o],l=t[o+1],c=t[n],i=t[n+1];let a=u,f=l,d=c-a,h=i-f;if(0!==d||0!==h){const t=((r-a)*d+(s-f)*h)/(d*d+h*h);t>1?(a=c,f=i):t>0&&(a+=d*t,f+=h*t)}return d=r-a,h=s-f,d*d+h*h}function nt(t,e,o,n,r,s,u){let l,c=n,i=0;for(let t=s+o;t<u;t+=o)l=ot(e,t,s,u),l>c&&(i=t,c=l);c>n&&(i-s>o&&nt(t,e,o,n,r,s,i),r(t,e,t.length,i,e[i],e[i+1]),u-i>o&&nt(t,e,o,n,r,i,u))}function rt(t,e,o,u){if(!e?.coords?.length)return null;const l=h(o,u);let c=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY;if(e&&e.coords){const t=e.coords;for(let e=0;e<t.length;e+=l){const o=t[e],n=t[e+1];c=Math.min(c,o),a=Math.max(a,o),i=Math.min(i,n),f=Math.max(f,n)}}return n(t)?r(t,c,i,a,f):s(c,i,a,f,t),t}function st(t,e,n,r,s){const{coords:u,lengths:l}=e,c=h(n,r);if(!u.length)return t!==e&&it(t),t;o(s);const{originPosition:i,scale:a,translate:f}=s,d=ft;d.originPosition=i;const m=d.scale;m[0]=a[0]??1,m[1]=-(a[1]??1),m[2]=a[2]??1,m[3]=a[3]??1;const g=d.translate;if(g[0]=f[0]??0,g[1]=f[1]??0,g[2]=f[2]??0,g[3]=f[3]??0,!l.length){for(let e=0;e<c;++e)t.coords[e]=N(d,u[e],e);return t!==e&&it(t,c,0),t}let y=0;for(let e=0;e<l.length;e++){const o=l[e];t.lengths[e]=o;for(let e=0;e<c;++e)t.coords[y+e]=N(d,u[y+e],e);let n=t.coords[y],r=t.coords[y+1];y+=c;for(let e=1;e<o;e++,y+=c){n+=u[y]*m[0],r+=u[y+1]*m[1],t.coords[y]=n,t.coords[y+1]=r;for(let e=2;e<c;++e)t.coords[y+e]=N(d,u[y+e],e)}}return t!==e&&it(t,u.length,l.length),t}function ut(t,e,o,n,r,s){if(it(t),t.lengths.push(...e.lengths),o===r&&n===s)for(let o=0;o<e.coords.length;o++)t.coords.push(e.coords[o]);else{const u=h(o,n),l=M(o,n,r,s),c=e.coords;for(let e=0;e<c.length;e+=u)l(t.coords,c,t.coords.length,e,c[e],c[e+1])}return t}function lt(t,e,o,n){let r=0,s=t[n*e],u=t[n*(e+1)];for(let l=1;l<o;l++){const o=s+t[n*(e+l)],c=u+t[n*(e+l)+1],i=(o-s)*(c+u);s=o,u=c,r+=i}return.5*r}function ct(t,e){const{coords:o,lengths:n}=t;let r=0,s=0;for(let t=0;t<n.length;t++){const u=n[t];s+=lt(o,r,u,e),r+=u}return Math.abs(s)}function it(t,e=0,o=0){at(t.lengths,o),at(t.coords,e)}function at(t,e=0){t.length!==e&&(t.length=e)}const ft={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};export{H as a,D as b,K as c,A as d,C as e,B as f,rt as g,T as h,U as i,S as j,O as k,et as l,V as m,W as n,Q as o,L as p,tt as q,ut as r,Y as s,G as t,st as u,I as v,ct as w,X as x};
