/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"../geometry.js";import t from"../core/Accessor.js";import n from"../core/Error.js";import{L as i}from"./Logger.js";import{g as r}from"./ensureType.js";import{parseWhereClause as o}from"../core/sql.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import p from"../geometry/Polygon.js";import{initializeProjection as l,project as d}from"../geometry/projection.js";import{w as c}from"./unitUtils.js";import{a as u,b as y,s as m,e as h,c as f}from"../layers/knowledgeGraph/KnowledgeGraphSublayer.js";import{b as g}from"./featureConversionUtils.js";import{O as T}from"./OptimizedFeature.js";import{fromJSON as b}from"../geometry/support/jsonUtils.js";import"../Graphic.js";import w from"../request.js";import"../symbols.js";import"../layers/GraphicsLayer.js";import"./aaBoundingBox.js";import"./mathUtils.js";import E from"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../geometry/Polyline.js";import{executeQueryStreaming as I,g as D}from"../rest/knowledgeGraphService.js";import{g as N}from"./assets.js";import L from"../rest/knowledgeGraph/GraphQueryStreaming.js";import _ from"../rest/support/Query.js";class M{constructor(){this._featureLookup=new Map}static getInstance(){return M.instance||(M.instance=new M),M.instance}static resetInstance(){M.instance&&(M.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const n=this.readFromStoreById(e);n&&t.push(n)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,n){const i=[];return e.forEach((e=>{if(!e?.id)return;e.properties||(e.properties=[]);let r,o=null;if(n&&e.properties[n]&&(o=g(e.properties[n])),"originId"in e&&"destinationId"in e&&(e.properties[u]=e.originId,e.properties[y]=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)&&this._featureLookup.get(e.id).attributes){const i=this._featureLookup.get(e.id),s=JSON.parse(JSON.stringify(Object.assign(i.attributes,e.properties)));n&&e.properties[n]&&(s[n]=b(e.properties[n])),r=new T(o?JSON.parse(JSON.stringify(o)):i?.geometry?JSON.parse(JSON.stringify(i.geometry)):null,s,null,e.properties[t])}else r=new T(o?JSON.parse(JSON.stringify(o)):null,e.properties,null,e.properties[t]);this._featureLookup.set(`${e.typeName?`${e.typeName}__${e.id}`:e.id}`,r),i.push(r)})),i}}let R,A=null;function C(){return R||(R=import("./lclayout.js").then((e=>e.l)).then((({default:e})=>e({locateFile:e=>N(`esri/libs/linkchartlayout/${e}`)}))).then((e=>{A=e})),R)}var k,S,j,v,x,q,O,$,B,F,G,U,P,H,Y,W,z,V,Q,J;function K(e,t,n,i,r,o){const s=n.length,a=r.length,p=Float64Array.BYTES_PER_ELEMENT,l=Uint32Array.BYTES_PER_ELEMENT,d=Uint8Array.BYTES_PER_ELEMENT,c=16+s*(d+2*p)+a*(2*l),u=A._malloc(c);try{const d=u+16-u%16,c=d+s*p,y=c+s*p,m=y+a*l,h=m+a*l,f=()=>[A.HEAPF64.subarray(d>>3,(d>>3)+s),A.HEAPF64.subarray(c>>3,(c>>3)+s),A.HEAPU32.subarray(y>>2,(y>>2)+a),A.HEAPU32.subarray(m>>2,(m>>2)+a),A.HEAPU8.subarray(h,h+s)],[g,T,b,w,E]=f();g.set(n),T.set(i),b.set(r),w.set(o),E.set(t);let I=e(s,h,d,c,a,y,m),D=null,N=null;if(I){const e=A.getLayoutLinksTypes(),t=A.getLayoutLinksVerticesEndIndices(),n=A.getLayoutLinksVertices(),i=A.countLayoutLinksVertices();!a||e&&t?i&&!n?I=!1:(D={types:new Uint8Array(A.HEAPU8.subarray(e,e+a)),vertexEndIndex:new Uint32Array(A.HEAPU32.subarray(t>>2,(t>>2)+a)),vertices:new Float64Array(A.HEAPF64.subarray(n>>3,(n>>3)+2*i))},N=A.getAuxiliaryGraphicElements()):I=!1}const[L,_,M,R,C]=f();return n.set(L),i.set(_),r.set(M),o.set(R),t.set(C),{success:I,links:D,graphics:N}}finally{A._free(u),A.cleanupLayout()}}function Z(e){if(!e.spatialReference.isWGS84)throw new n("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map((e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]))}async function X(e,t){const n=[],i=new Map,r=[];if(t.dataModel?.relationshipTypes)for(const e of t.dataModel.relationshipTypes)e.name&&i.set(e.name,[]);for(const t of e)i.has(t.typeName)&&i.get(t.typeName)?.push(t.id);for(const[e,o]of i){if(o.length<1)continue;const i=new L({openCypherQuery:`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:o}});r.push(I(t,i).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:i}=await t.read();if(e)break;for(const e of i)n.push({id:e[0],typeName:e[1]}),n.push({id:e[2],typeName:e[3]})}})))}return await Promise.all(r),n}async function ee(e,t){t??=!1;const i={generateAllSublayers:t,namedTypeDefinitions:new Map};return await async function(e){const t=await w(e,{responseType:"array-buffer"}),i=await t.data;return async function(e){const t=new((await D()).MapOfObjectIdentifierSetsDecoder),i=t.decode(new Uint8Array(e)),r=new Map;if(0!==i.error_code)throw new n("knowledge-graph:layer-support-utils",i.error_message);const o=t.get_map_of_identifier_sets(),s=o.keys,a=s.size();for(let e=0;e<a;e++){const t=s.get(e),i=o.query_identifier_set(t),a=[];if(i.id_array_type.value===J.GLOBALID_ARRAY){const e=i.get_globalid_array(),t=e.count();for(let n=0;n<t;n++)a.push(e.get_globalid_at(n))}else if(i.id_array_type.value===J.IDENTIFIER_ARRAY){const e=i.get_identifier_array(),t=e.count();for(let n=0;n<t;n++)a.push(e.get_identifier_at(n).toString())}else if(i.id_array_type.value===J.STRING_ARRAY){const e=i.get_string_array(),t=e.count();for(let n=0;n<t;n++)a.push(e.get_string_at(n))}else{if(i.id_array_type.value!==J.OID_ARRAY)throw new n("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const e=i.get_oid_array(),t=e.count();for(let n=0;n<t;n++)a.push(e.get_objectid_at(n).toString())}}r.set(t,a)}return t.delete(),r}(new Uint8Array(i))}(e).then((e=>{!function(e,t){for(const[n,i]of e){const e=r(t.namedTypeDefinitions,n,(()=>({useAllData:!1,members:new Map})));for(const t of i)e.members.has(t)||e.members.set(t,{id:t})}}(e,i)})),i}async function te(e){const t=await D(),i=new t.MapOfObjectIdentifierSets;!function(e,t,n){for(const[i,r]of n.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const n=r.members.keys();let o=!1,s=!0;const a=new t.ObjectIdArray,p=new t.StringArray,l=new t.GlobalIdArray,d=new t.IdentifierArray,c=new t.ObjectIdentifierSet;for(const e of n)s&&(o=!isNaN(Number(e)),s=!1),o?a.add_objectid(Number(e)):(p.add_string(e),l.add_globalid(e)),d.add_identifier(e);c.set_oid_array(a),c.set_string_array(p),c.set_globalid_array(l),c.set_identifier_array(d),a.delete(),p.delete(),l.delete(),d.delete(),e.put_identifier_set(i,c),c.delete()}}(i,t,e);const r=new t.MapOfObjectIdentifierSetsEncoder;try{r.set_map_of_identifier_sets(i),r.encode();const e=r.get_encoding_result();if(0!==e.error.error_code)throw new n("knowledge-graph:layer-support-utils",e.error.error_message);const t=structuredClone(e.get_byte_buffer());return r.delete(),t}finally{i.delete()}}!function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot",e[e.IsOld=8]="IsOld"}(k||(k={})),function(e){e[e.Regular=0]="Regular",e[e.Curved=1]="Curved",e[e.Recursive=2]="Recursive"}(S||(S={})),function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom"}(j||(j={})),function(e){e[e.none=0]="none",e[e.startOnly=1]="startOnly",e[e.startAndEnd=2]="startAndEnd"}(v||(v={})),function(e){e.getMinIdealEdgeLength=function(){return A.getMinIdealEdgeLength()},e.apply=function(e,t,n,i,r,o=2,s=1,a=-1){return K(((e,t,n,i,r,p,l)=>A.applyForceDirectedLayout(e,t,n,i,r,p,l,o,s,a)),e,t,n,i,r)}}(x||(x={})),function(e){e.apply=function(e,t,n,i,r,o=2,s=1,a=-1){return K(((e,t,n,i,r,p,l)=>A.applyCommunityLayout(e,t,n,i,r,p,l,o,s,a)),e,t,n,i,r)}}(q||(q={})),function(e){e.apply=function(e,t,n,i,r){return K(A.applySimpleLayout,e,t,n,i,r)}}(O||(O={})),function(e){e.apply=function(e,t,n,i,r){return K(A.applyHierarchicalLayout,e,t,n,i,r)}}($||($={})),function(e){e.apply=function(e,t,n,i,r){return K(A.applyRadialTreeLayout,e,t,n,i,r)}}(B||(B={})),function(e){e.apply=function(e,t,n,i,r){return K(A.applySmartTreeLayout,e,t,n,i,r)}}(F||(F={})),function(e){e.apply=function(e,t,n,i,r,o,s,a,p,l,d){const c={timeDirection:j.right,timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:v.startAndEnd,showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0};return K(((e,t,n,o,s,u,y)=>{if(i.length!==e)return!1;if(r.length!==e)return!1;if(a.length!==s)return!1;if(p.length!==s)return!1;const m=Float64Array.BYTES_PER_ELEMENT,h=16,f=A._malloc(h+e*m),g=A._malloc(h+e*m),T=A._malloc(h+s*m),b=A._malloc(h+s*m),w=f+h-f%h,E=g+h-g%h,I=T+h-T%h,D=b+h-b%h;try{A.HEAPF64.subarray(w>>3,(w>>3)+e).set(i),A.HEAPF64.subarray(E>>3,(E>>3)+e).set(r),A.HEAPF64.subarray(I>>3,(I>>3)+s).set(a),A.HEAPF64.subarray(D>>3,(D>>3)+s).set(p);const m=function(e){const t=Object.keys(j).filter((e=>isNaN(parseInt(e,10)))).indexOf(e.timeDirection),n=Object.keys(v).filter((e=>isNaN(parseInt(e,10)))).indexOf(e.eventsTicksVisualization);return{timeDirection:{value:t>-1?t:j.right},timeBannerUTCOffsetInMinutes:e.timeBannerUTCOffsetInMinutes,eventsTicksVisualization:{value:n>-1?n:v.startAndEnd},showDurationLineForNonZeroDurationEntityEvents:e.showDurationLineForNonZeroDurationEntityEvents,durationLineWidth:e.durationLineWidth,entityPositionAtDurationRatio:e.entityPositionAtDurationRatio,showNonZeroDurationIntervalBounds:e.showNonZeroDurationIntervalBounds,separateTimeOverlaps:e.separateTimeOverlaps,separateTimelineOverlaps:e.separateTimelineOverlaps,moveFirstBends:e.moveFirstBends,secondBendRatio:e.secondBendRatio,lineSeparationMultiplier:e.lineSeparationMultiplier,spaceSeparatedLinesEvenly:e.spaceSeparatedLinesEvenly,useBezierCurves:e.useBezierCurves,separatedLineShapeRatio:e.separatedLineShapeRatio}}(Object.assign(c,d));return A.applyChronologicalLayout(e,t,n,o,w,E,s,u,y,I,D,l,m)}finally{A._free(f),A._free(g),A._free(T),A._free(b)}}),e,t,n,o,s)}}(G||(G={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(U||(U={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(P||(P={})),function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"}(H||(H={})),H.ELEMENTUID,H.TYPENAME,function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"}(Y||(Y={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(W||(W={})),function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"}(z||(z={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(V||(V={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(Q||(Q={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(J||(J={}));let ne=class extends t{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((n=>{n.name&&(t.set(n.name,"entity"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(n.name),n.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(n.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((n=>{n.name&&(t.set(n.name,"relationship"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(n.name),n.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(n.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((n,o)=>{if("entity"===t.get(o))this.entityTypeNames.add(o);else{if("relationship"!==t.get(o))return i.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(o);this.relationshipTypeNames.add(o)}const s=new Map;n.members?.forEach((e=>{r(this.memberIdTypeLookup,e.id,(()=>new Set)).add(o);const t=this.getById(e.id);t&&s.set(e.id,t)})),this.sublayerCaches.set(o,s)}))}addToLayer(e){e.forEach((({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new n("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(e);n.members||(n.members=new Map),n.members.set(t,{id:t}),r(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}else{const n=new Map;n.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:n}),r(this.memberIdTypeLookup,t,(()=>new Set)).add(e)}}))}getById(e){return M.getInstance().readFromStoreById(e)}async getData(e,t,n){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let i;if(i=e||new _({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,n=this._processingCacheUpdatesLookup.get(t.objectType.name??""),r=i.outFields;r&&1===r.length&&r[0]===m&&"1=1"===i.where||await Promise.all(n??[]);const o=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],s=[];return o.forEach((n=>{if(this.relationshipTypeNames.has(t.objectType.name)){n.geometry=e.relationshipLinkChartDiagramLookup.get(n.attributes[t.objectIdField]);const i=this.memberIdTypeLookup.get(n.attributes[u]),r=this.memberIdTypeLookup.get(n.attributes[y]),o=this._isEndEntitySpatial(i,n,u),s=this._isEndEntitySpatial(r,n,y);n.attributes[h]=Number(o&&s)}else{n.geometry=e.entityLinkChartDiagramLookup.get(n.attributes[t.objectIdField]);const i=this.geographicLookup.get(t.objectType.name);i&&n.attributes[i.name]?n.attributes[h]=1:n.attributes[h]=0}n.attributes[f]=n.geometry,s.push(n)})),s}return this.retrieveDataFromService(i,t,n)}async getConnectedRecordIds(e,t){const n=[];let r="";const o=[],s=new Map;if(e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(t))return;s.has(t)?s.get(t)?.push(e):s.set(t,[e])}})),t&&0!==t?.length){for(const e of t)r=r+e+"|";r=r.slice(0,-1)}const a={};let p="",l=-1;for(const[e,n]of s){l++,0!==l&&(p+=" UNION ");const i=`${e}_ids`;a[i]=n,p+=t&&0!==t?.length?`MATCH (n:${e}) WHERE id(n) IN $${i} WITH n MATCH (n)-[r:${r}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${e}) WHERE id(n) IN $${i} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`}if(!p)return n;const d=new Promise((e=>{(async()=>{const e=(await I(this.knowledgeGraph,new L({openCypherQuery:p,bindParameters:a}))).resultRowsStream.getReader();try{for(;;){const{done:t,value:i}=await e.read();if(t)break;for(let e=0;e<i.length;e++){const t=i[e];n.push({id:t[0],typeName:t[1]}),n.push({id:t[2],typeName:t[3]})}}}catch(e){if("AbortError"!==e.name)throw e;i.getLogger(this).info("Request aborted as expected")}})().then((()=>{e()}))}));return o.push(d),this.refreshCacheContent(),await Promise.all(o),n}async getRelationshipsBetweenNodes(e,t){const n=[],r=(await I(this.knowledgeGraph,new L({openCypherQuery:"MATCH (n)-[r]->(m) WHERE id(n) IN $nodeIds AND id(m) in $nodeIds AND NOT id(r) IN $relationshipExclusionIds return id(r), type(r)",bindParameters:{nodeIds:e,relationshipExclusionIds:t}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:t}=await r.read();if(e)break;for(let e=0;e<t.length;e++){const i=t[e];n.push({id:i[0],typeName:i[1]})}}}catch(e){if("AbortError"!==e.name)throw e;i.getLogger(this).info("Request aborted as expected")}return n}async getRelationshipsFromNodes(e,t,n){const r=[],o=(await I(this.knowledgeGraph,new L({openCypherQuery:"MATCH (n)-[r]-(m) WHERE id(n) IN $targetEntityIds AND id(m) in $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds return id(r), type(r)",bindParameters:{targetEntityIds:e,possibleConnectionEntityIds:t,relationshipExclusionIds:n}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:t}=await o.read();if(e)break;for(let e=0;e<t.length;e++){const n=t[e];r.push({id:n[0],typeName:n[1]})}}}catch(e){if("AbortError"!==e.name)throw e;i.getLogger(this).info("Request aborted as expected")}return r}async refreshCacheContent(e,t,i,o=!0){const s=M.getInstance(),a=[],p=new Map,l=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e))p.has(t)?p.get(t)?.push(e):p.set(t,[e])})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?p.set(t,null):e.members&&e.members.forEach((e=>{p.has(t)&&null!==p.get(t)?p.get(t)?.push(e.id):p.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&p.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&p.set(e.name,null)})));for(const[e,d]of p){const p=new Promise((a=>{(async()=>{const a=new Set,p=[];let c,u="",y=!1;if(t||l.get(e)?.properties?.forEach((e=>{e.name&&a.add(e.name)})),i&&this.geographicLookup.has(e)){const t=this.geographicLookup.get(e)?.name;t&&a.add(t)}if(this.entityTypeNames.has(e))u=`MATCH (n:${e}) ${d?"WHERE id(n) IN $ids ":""}return ID(n)`,a.forEach((e=>{u+=`, n.${e}`,p.push(e)}));else{if(!this.relationshipTypeNames.has(e))throw new n("knowledge-graph:layer-data-manager",`The graph type of ${e} could not be determined. Was this type set in the KG data model and inclusion definition?`);y=!0,u=`MATCH ()-[n:${e}]->() ${d?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,a.forEach((e=>{u+=`, n.${e}`,p.push(e)}))}c=new L(d?{openCypherQuery:u,bindParameters:{ids:d}}:{openCypherQuery:u});const h=(await I(this.knowledgeGraph,c)).resultRowsStream.getReader();for(;;){const{done:t,value:n}=await h.read();if(t)break;const i=[];for(let e=0;e<n.length;e++){const t=n[e];let o=0,s=0;const a={properties:{}};for(a.id=t[o],o++,s++,y&&(a.originId=t[o],o++,s++,a.destinationId=t[o],o++,s++,r(this.nodeConnectionsLookup,a.originId,(()=>new Set)).add(a.id),r(this.nodeConnectionsLookup,a.destinationId,(()=>new Set)).add(a.id),r(this.relationshipConnectionsLookup,a.id,(()=>[a.originId,a.destinationId])));o<t.length;o++)a.properties[p[o-s]]=t[o];i.push(a)}const a=s.writeToStore(i,m,this.geographicLookup.get(e)?.name);this.sublayerCaches.has(e)||this.sublayerCaches.set(e,new Map),o&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(e)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map}),o&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(e).members=new Map);const l=this.sublayerCaches.get(e);a.forEach((t=>{l?.set(t.attributes[m],t),o&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.has(t.attributes[m])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.set(t.attributes[m],{id:t.attributes[m]}),r(this.memberIdTypeLookup,t.attributes[m],(()=>new Set)).add(e))}))}})().then((()=>{a(null)}))}));a.push(p),this._processingCacheUpdatesLookup.get(e)?.push(p)}await Promise.all(a)}removeFromLayer(e){const t=new Set,n=new Set(e.map((e=>e.id)));for(const n of e)t.add(n.typeName),1===this.memberIdTypeLookup.get(n.id)?.size?this.memberIdTypeLookup.delete(n.id):this.memberIdTypeLookup.get(n.id)?.delete(n.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{t===n.typeName&&e.members?.has(n.id)&&e.members.delete(n.id)}));t.forEach((e=>{this.sublayerCaches.get(e)?.forEach(((t,i)=>{n.has(i)&&this.sublayerCaches.get(e)?.delete(i)}))}))}async retrieveDataFromService(e,t,i){const r=M.getInstance(),s=new Set,a=[];let u,y="",h=[];const f="relationship"===t.graphType,g=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,T=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let b=!g&&T?Array.from(T).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&null!=e.objectIds&&(b=e.objectIds);else if(null!=e.objectIds&&b&&b.length>0){const t=e.objectIds;e.objectIds=b.filter((e=>t.includes(e)))}else if(null!=e.objectIds)b=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=b}if(null!=e.outFields){const n=e.outFields;n.includes("*")?t.fields.forEach((e=>{s.add(e.name)})):n.forEach((e=>{e!==m&&e!==t.geometryFieldName&&s.add(e)}))}if(null!=e.geometry){const i=e.geometry;let r;const m=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,h=m?.spatialReference,g=m?.serviceCapabilities?.geometryCapabilities;let T=g?.geometryMaxBoundingRectangleSizeX,b=g?.geometryMaxBoundingRectangleSizeY;if("point"===i.type){let e=i;e.spatialReference?.isWGS84||(await l(e.spatialReference,c),e=d(e,c)),r=new E({spatialReference:c,xmin:e.x-1e-4,ymin:e.y-1e-4,xmax:e.x+1e-4,ymax:e.y+1e-4})}else i?.extent?.spatialReference&&!i.spatialReference?.isWGS84?(await l(i.extent.spatialReference,c),r=d(i.extent,c)):r=i.extent;if(T&&b&&h){if(4326!==h.wkid){const e=new E({spatialReference:h,xmax:T,ymax:b}),t=d(e,c);T=t.xmax,b=t.ymax}if(r.xmax-r.xmin>T)throw new n("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${T}° latitude, limit exceeded`);if(r.ymax-r.ymin>b)throw new n("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${b}° longitude, limit exceeded`)}if(null!=e.where&&"1=1"!==e.where){const n=await o(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&s.add(e.name)}))}y=f?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&s.add(t.geometryFieldName),s.forEach((e=>{y+=`, n.${e}`,a.push(e)})),u=new L({openCypherQuery:y,bindParameters:{param_filter_geom:new p({rings:Z(r)})}})}else{let n="";if(null!=e.where&&"1=1"!==e.where){const i=await o(e.where,t.fieldsIndex);t.fields.forEach((e=>{i.fieldNames.includes(e.name)&&s.add(e.name)}));const r=new Set(["column-reference","string","number","binary-expression"]),a=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let p=!1;const l=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&r.has(e.left.type)&&r.has(e.right.type)&&a.has(e.operator))return`${l(e.left)} ${e.operator} ${l(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return p=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return p=!0,"";{let n=e.right.value;"%"===n.charAt(0)&&(n=n.slice(1)),"%"===n.charAt(n.length-1)&&(n=n.slice(0,-1)),t+=`'${n.toLowerCase()}')`}return t}return p=!0,""};n=l(i.parseTree),p&&(n="")}let i="";i=f?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let r=!1;b&&(r=!0,i+=" WHERE ID(n) IN $ids"),n&&(i+=r?" AND":" WHERE",i+=` ${n}`),i+=" return ID(n)",f&&(i+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&s.add(t.geometryFieldName),s.forEach((e=>{i+=`, n.${e}`,a.push(e)})),u=new L(b?{openCypherQuery:i,bindParameters:{ids:b}}:{openCypherQuery:i})}const w=(await I(t.parentCompositeLayer.dataManager.knowledgeGraph,u,i)).resultRowsStream.getReader();for(;;){const{done:e,value:n}=await w.read();if(e)break;const i=[];for(let e=0;e<n.length;e++){const t=n[e];let r=0,o=0;const s={properties:{}};for(s.id=t[r],r++,o++,f&&(s.originId=t[r],r++,o++,s.destinationId=t[r],r++,o++);r<t.length;r++)s.properties[a[r-o]]=t[r];i.push(s)}h=h.concat(r.writeToStore(i,m,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return h}_isEndEntitySpatial(e,t,n){for(const i of e??[])if(this.entityTypeNames.has(i)){const e=this.geographicLookup.get(i),r=e&&this.sublayerCaches.get(i)?.get(t.attributes[n]);if(e&&r?.attributes[e.name])return!0}return!1}};e([s()],ne.prototype,"knowledgeGraph",void 0),e([s()],ne.prototype,"inclusionModeDefinition",void 0),e([s()],ne.prototype,"entityTypeNames",void 0),e([s()],ne.prototype,"relationshipTypeNames",void 0),e([s()],ne.prototype,"geographicLookup",void 0),e([s()],ne.prototype,"sublayerCaches",void 0),e([s()],ne.prototype,"nodeConnectionsLookup",void 0),e([s()],ne.prototype,"relationshipConnectionsLookup",void 0),e([s()],ne.prototype,"memberIdTypeLookup",void 0),ne=e([a("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],ne);export{ne as K,G as L,k as N,M as S,O as a,F as b,B as c,$ as d,q as e,ee as f,X as g,x as h,S as i,C as l,te as s};
