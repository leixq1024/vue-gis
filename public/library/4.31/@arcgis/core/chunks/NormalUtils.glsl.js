/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{c as t}from"./vec2f64.js";import{c as e}from"./vec3f64.js";import{f as s,Z as i,c as r}from"./vec4f64.js";import n from"../Color.js";import{i as a,l as o}from"./fontUtils.js";import{L as h}from"./Logger.js";import{a as l}from"./screenUtils.js";import{_ as c}from"./tslib.es6.js";import d,{g as _}from"../core/Accessor.js";import m from"../core/Evented.js";import"../core/lang.js";import{f as u,r as f}from"./maybe.js";import{property as g}from"../core/accessorSupport/decorators/property.js";import{subclass as p}from"../core/accessorSupport/decorators/subclass.js";import{e as x,s as v}from"./vec4.js";import{C as w}from"./Material.js";import{N as y}from"./StencilUtils.js";import{T,Y as b}from"./Scheduler.js";import{T as k,c as R}from"./enums.js";import{a as A,T as z}from"./Texture.js";import{g as S}from"./interfaces3.js";class j{constructor(i,r="center",n=!1,a=t(),o=s(0,0,0,-1),h="world",l=e(),c=0){this.verticalOffset=i,this.anchor=r,this.hasLabelVerticalOffset=n,this.screenOffset=a,this.centerOffset=o,this.centerOffsetUnits=h,this.translation=l,this.elevationOffset=c}}class C{constructor(e,s="center",i="center",r=null,n=t()){this.placement=e,this.horizontalPlacement=s,this.verticalPlacement=i,this.text=r,this.displaySize=n}}class M{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=E(t.color),this.haloStyle=`rgb(${t.halo.color.slice(0,3).map((t=>Math.floor(255*t))).toString()})`,this.backgroundStyle=0!==t.background.color[3]?E(t.background.color):null}fontString(t){const e=this.definition.font;return`${e.style} ${e.weight} ${t}px ${e.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(t,e){t.font=this.fontString(e),t.textAlign="left",t.textBaseline="alphabetic"}static async fromSymbol(t,e){const s=t?.material?.color,r=n.toUnitRGBA(s)??i,c=null!=t.size?l(t.size):12,d=t.lineHeight,_=null!=t.background?n.toUnitRGBA(t.background.color):i,m={family:t.font?.family??"sans-serif",decoration:t.font?.decoration??"none",weight:t.font?.weight??"normal",style:t.font?.style??"normal"},u=t.halo,f=null!=u?.color&&u.size>0?{size:l(u.size),color:n.toUnitRGBA(u.color)}:{size:0,color:i},g=new M({color:r,size:c,background:{color:_,padding:null!=t.background?[.65*c,.5*c]:[0,0],borderRadius:null!=t.background?c*(6/16):0},lineSpacingFactor:d,font:m,halo:f,pixelRatio:e});if(t.font){let e=!1;const s=g.fontString(c);try{e=(await document.fonts.load(s)).some((t=>!a(t)))}catch(t){h.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${s}'. Some text symbology may be rendered using the default browser font.`)}if(!e&&!O.has(t.font.family))try{await o(t.font)}catch(t){}}return g}}function E(t){return`rgba(${t.slice(0,3).map((t=>Math.floor(255*t))).toString()},${t[3]})`}const O=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),P=4096;let N=class extends d{constructor(t){super(t),this.type=w.Texture,this.id=_(),this.events=new m,this._glTexture=null,this._atlas=new W(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=u(this._glTexture),this._frameWorker=f(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get glTexture(){return this._glTexture}static get maxSize(){return B=0,[P-U-B,P-U-B-L]}load(t){if(this._glTexture)return this._glTexture;const e=new A;return e.wrapMode=k.CLAMP_TO_EDGE,e.samplingMode=R.LINEAR_MIPMAP_LINEAR,e.hasMipmap=!0,e.preMultiplyAlpha=!0,e.maxAnisotropy=t.parameters.maxMaxAnisotropy,this._glTexture=new z(t,e,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(T.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=f(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=u(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(t){this._canvas.width=t.width,this._canvas.height=t.height}_resizeAtlas(t,e){const{width:s,height:i}=this._atlas;s===t&&i===e||(this._atlas.width=t,this._atlas.height=e,this._glTexture?.resize(t,e),this._glTexture?.updateData(0,0,0,s,i,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach((t=>this._uvCallbacks.get(t.textRenderer.key)?.forEach((e=>e(t.uv))))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(t,e,s,i){const r=this._atlas;if(r.width<s||r.height<i)return!1;let n=r.cursors.get(i);if(!n){if(r.height<r.nextY+i)return!1;n=[new $(r.nextY)],r.cursors.set(i,n),r.nextY+=i}let a=n.find((t=>r.width>=t.x+s));if(null==a){if(r.height<r.nextY+i)return!1;a=new $(r.nextY),r.nextY+=i,n.push(a)}return t.setNewPosition(a),this._elements.set(e,t),this._elementsToRender.set(e,t),a.x+=s,!0}_ensureCallbacks(t){const e=this._uvCallbacks.get(t);if(e)return e;const s=new Set;return this._uvCallbacks.set(t,s),s}_addCallback(t,e){this._ensureCallbacks(t).add(e)}_removeCallback(t,e){const s=this._uvCallbacks.get(t);return!(!s?.delete(e)||0!==s.size||(this._uvCallbacks.delete(t),0))}_processAddition(t){const e=t.textRenderer.key;if(this._needsRepack)return void this._elements.set(e,t);const s=this._atlas,i=t.textRenderer.renderedWidth,r=t.textRenderer.renderedHeight,n=i+U,a=r+U+L;if(!this._addAtlasElement(t,e,n,a)){if(this._canRepack)this._reset();else if(s.width<n){const t=Math.min(y(Math.max(n,1.5*s.width)),P);this._resizeAtlas(t,s.height)}else{const t=s.nextY+a,e=Math.min(y(Math.max(t,1.5*s.height)),P);if(e>s.height)this._resizeAtlas(s.width,e);else if(s.width<P){const t=Math.min(y(1.5*s.width),P);this._resizeAtlas(t,s.height)}}this._elements.set(e,t)}}_renderElement(t){const e=t.commitNewPosition(),s=t.textRenderer;this._ctx.clearRect(e[0]-U,e[1]-U,s.renderedWidth+2*U,s.renderedHeight+2*U),s.render(this._ctx,e[0],e[1]),this._uvCallbacks.get(s.key)?.forEach((e=>e(t.uv)))}get running(){return this.updating}runTask(t){if(null==this._glTexture)return b;for(;this._needsRepack&&(this._canRepack||this._atlas.height<P&&this._atlas.height<P);){this._canRepack=this._needsRepack=!1;const e=this._elements;this._elements=new Map,e.forEach((t=>this._processAddition(t))),t.madeProgress()}if(this._elementsToRender.size>0){for(const[e,s]of this._elementsToRender){if(t.done)break;this._renderElement(s),this._elementsToRender.delete(e),t.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(t,e){const s=t.key;this._addCallback(s,e);let r=this._elements.get(s);return r?x(r.uv,i)||e(r.uv):(r=new Y(this._atlas,t),this._processAddition(r),this.setDirty()),{remove:()=>this._removeText(t,e)}}_removeText(t,e){const s=t.key;this._elements.get(s)&&this._removeCallback(s,e)&&(this._elements.delete(s),this._elementsToRender.delete(s),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}};c([g({constructOnly:!0})],N.prototype,"view",void 0),c([g({type:Boolean})],N.prototype,"updating",void 0),N=c([p("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],N);const U=2,L=2;class Y{constructor(t,e){this._atlas=t,this.textRenderer=e,this._uv=r(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return i;const{renderedWidth:t,renderedHeight:e}=this.textRenderer;return v(this._uv,this._xOffset/this._atlas.width,(this._yOffset+e)/this._atlas.height,(this._xOffset+t)/this._atlas.width,this._yOffset/this._atlas.height)}setNewPosition(t){this._newPosition[0]=t.x,this._newPosition[1]=t.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class W{constructor(t,e){this.width=t,this.height=e,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=B}}class ${constructor(t){this.y=t,this.x=B}}let B=0;function D(t,e){e.spherical?t.vertex.code.add(S`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):t.vertex.code.add(S`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.spherical?t.vertex.code.add(S`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):t.vertex.code.add(S`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}export{C as L,D as N,N as T,M as a,j as b};
