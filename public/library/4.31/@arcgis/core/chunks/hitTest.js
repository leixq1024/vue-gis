/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../Graphic.js";import{i as n}from"../core/Handles.js";import{d as r,s as i}from"./screenUtils.js";import{c as t}from"./vec3f64.js";import{p as s}from"./projectVectorToVector.js";import{f as o}from"./LayerConstants.js";import{j as a}from"./layerUtils.js";import{d as c}from"./debugFlags2.js";import{g as l}from"./ElevationProvider.js";import{n as d}from"./Intersector3.js";import{S as u,i as p,I as m}from"./intersectorUtils.js";import{a as f,b as g}from"./intersectorUtilsConversions.js";import{t as y}from"./verticalOffsetUtils.js";import h from"../geometry/SpatialReference.js";import E from"../geometry/Point.js";async function U(e,n,i,t){const s=i?R(e,i):t,o=r(n.x,n.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const l=d(e.state.viewingMode);l.options.selectionMode=!0,l.options.store=u.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(o,l,s);const m=function(e,n,r){const i=new Array;let t=null;for(let s=0;s<n.length;s++){const o=n[s],c=f(o,e);if(null!=c&&(c===e.map.ground||"type"in c&&a(c.type)))break;const l=g(o,e);if(null==l)continue;if("graphic"===l.type){if(null==t&&s!==n.length-1&&(t=new Set),null!=t){const e=S(l.graphic);if(t.has(e))continue;t.add(e)}if(!L(r,l.graphic))continue}const d=j(e,o),u=o.distanceInRenderSpace;if("media"===l.type){const e=l.element.toSource(d);i.push({...l,mapPoint:d,distance:u,sourcePoint:e})}else i.push({...l,mapPoint:d,distance:u})}return i}(e,l.results.all,s.graphics),y=l.results.ground,h=f(y,e),E=null!=h&&"type"in h&&a(h.type)?h:null,U={screenPoint:n,results:m,ground:{mapPoint:j(e,y),distance:p(y)?y.distanceInRenderSpace:0,layer:E}};return c.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(U.intersector=l),U}function I(e,n,r,t){const s=r?R(e,r):t,o=!(!s.graphics?.include&&!s.graphics?.exclude),a=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),c=i(n);s.enableDraped=s.include&&!s.include.has(y)||s.exclude?.has(y);const l=e.sceneIntersectionHelper,p=d(e.state.viewingMode);if(p.options.selectionMode=!0,p.options.store=o||a?u.ALL:u.MIN,p.options.excludeLabels=r?.excludeLabels??!1,l.intersectIntersectorScreen(c,p,s),o||a){for(const n of p.results.all){const r=g(n,e);if(null==r)return j(e,n);if(o&&("graphic"!==r.type||L(s.graphics,r.graphic)))return j(e,n);if(a&&("media"!==r.type||b(s.mediaElements,r.element)))return j(e,n)}return null}return j(e,p.results.min)}function j(e,n,r){return n.getIntersectionPoint(v)?(r=x(e,v,r),n.intersector===m.TERRAIN&&e.basemapTerrain&&(r.z=l(e.basemapTerrain,r)??0),r):null}function S(e){const n=e.sourceLayer,r=e.layer,i=n&&"objectIdField"in n?n:r&&"objectIdField"in r?r:n;if(i){const n=i.objectIdField??o,r=e.attributes?.[n];if(r)return`o-${i.id}-${r}`}return`u-${e.uid}`}function L(e,n){return b(e,S(n))}function b(e,n){return null==e||(null==e.include||e.include.has(n))&&(null==e.exclude||!e.exclude.has(n))}function x(e,n,r){let i=e.spatialReference||h.WGS84;return s(n,e.renderSpatialReference,v,i)?n=v:(i=h.WGS84,s(n,e.renderSpatialReference,v,i)&&(n=v)),r?(r.x=n[0],r.y=n[1],r.z=n[2],r.spatialReference=i):r=new E(n,i),r}function R(e,n){const r=w(e,n.include,D.INCLUDE),i=w(e,n.exclude,D.EXCLUDE);return{include:r.layerUids,exclude:i.layerUids,graphics:{include:r.graphicUids,exclude:i.graphicUids},mediaElements:{include:r.mediaElements,exclude:i.mediaElements}}}function w(r,i,t,s={layerUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!i)return s;if(i instanceof e)!function(e,n){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(n)}(s,S(i)),t===D.INCLUDE&&(null!=r.graphicsView&&i.layer===r?C(s,r.graphicsView.processor.layer.id):i.layer&&C(s,i.layer.uid));else if("layer"in i&&"element"in i)!function(e,n){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(n)}(s,i.element),t===D.INCLUDE&&C(s,i.layer.uid);else if(n(i))for(const e of i)e===r.graphics&&null!=r.graphicsView?C(s,r.graphicsView.processor.layer.id):e===r.map.ground?C(s,y):w(r,e,t,s);else"uid"in i&&C(s,i.uid);return s}function C(e,n){e.layerUids||(e.layerUids=new Set),e.layerUids.add(n)}const v=t();var D;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(D||(D={}));export{x as c,R as e,U as h,I as t};
