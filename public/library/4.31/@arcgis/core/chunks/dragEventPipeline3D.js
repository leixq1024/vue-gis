/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import"../geometry.js";import{s as e,f as n,d as r}from"./screenUtils.js";import{c as t}from"./vec2f64.js";import{h as s,i as o,c as l,a,d as c,s as u,g as i}from"./vec3.js";import{c as d}from"./vec3f64.js";import{projectPoint as f}from"../geometry/projection.js";import{n as m,i as p,c as E,g as S,o as g,q as j}from"./plane.js";import{c as y,b as R}from"./ray.js";import{i as v}from"./elevationInfoUtils.js";import{f as x}from"./ray2.js";import{n as I}from"./Intersector3.js";import{S as w,I as H}from"./intersectorUtils.js";import{t as U}from"./verticalOffsetUtils.js";import{E as O}from"./InteractiveToolBase.js";import T from"../geometry/Point.js";function b(e,n){return D(e,(()=>n))}function C(e){return D(e,(e=>e.plane))}function D(r,t){const s=d(),o=d();let l=!1;return a=>{const c=t(a);if("start"===a.action){const t=e(a.screenStart,n(m.get())),o=x(r.state.camera,t,J);null!=o&&(l=p(c,o,s))}if(!l)return null;const u=e(a.screenEnd,n(m.get())),i=x(r.state.camera,u,J);return null==i?null:p(c,i,o)?{...a,renderStart:s,renderEnd:o,plane:c,ray:i}:null}}function M(e,n,t,s=null,o=null){return function(e,n,t=0,s=null,o=null){let l=null;return a=>{if("start"===a.action&&(l=e.sceneIntersectionHelper.intersectElevationFromScreen(r(a.screenStart.x,a.screenStart.y),n,t,o),null!=l&&null!=s&&!f(l,l,s)))return null;if(null==l)return null;const c=e.sceneIntersectionHelper.intersectElevationFromScreen(r(a.screenEnd.x,a.screenEnd.y),n,t,o);return null==c||null!=s&&!f(c,c,s)?null:{...a,mapStart:l,mapEnd:c}}}(e,t,v(n,e,t),s,o)}function N(e,n,r,t){const s=r.toMap(e.screenStart);return null!=s?M(n,s,r.elevationInfo,t):null}function h(e,n,r){let t=null;const f=new O;return f.next(b(e,function(e,n){const r=B,t=z,s=E();e.renderCoordsHelper.worldUpAtPosition(n,r);const o=l(S(s),r,a(t,n,e.state.camera.eye));return l(o,o,r),g(n,o,s)}(e,n))).next(function(e,n){const r=d(),t=s(n);e.renderCoordsHelper.worldUpAtPosition(n,r);const l=d(),f=d(),m=o=>(a(o,o,n),j(r,o,o),"global"===e.viewingMode&&s(o)*Math.sign(c(r,o))<.001-t&&a(o,u(o,r,.001),n),i(o,o,n),o);return e=>(e.renderStart=m(o(l,e.renderStart)),e.renderEnd=m(o(f,e.renderEnd)),e)}(e,n)).next(P(e,r)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,t=e})),e=>(t=null,f.execute(e),t)}function G(r,t){const s=s=>{const o=e(s,n(q)),l=x(r.state.camera,o,J);if(null==l)return null;const a=R(t,l,B,z);return a?.[0]};return e=>{const n=s(e.screenStart);if(null==n)return null;const r=s(e.screenEnd);return null==r?null:{...e,renderStart:n,renderEnd:r}}}function P(e,n){const r=e.renderCoordsHelper;return e=>{const t=r.fromRenderCoords(e.renderStart,new T({spatialReference:n})),s=r.fromRenderCoords(e.renderEnd,new T({spatialReference:n}));return null!=t&&null!=s?{...e,mapStart:t,mapEnd:s}:null}}var A;function F(e){let n=null;return r=>{switch(r.action){case"start":n=e.disableDisplay();break;case"end":case"cancel":null!=n&&(n.remove(),n=null)}return r}}function k(n,t=null){const s=I(n.state.viewingMode);s.options.selectionMode=!0,s.options.store=w.MIN,s.options.hud=!1;const o=r(),l={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},a=d(),c=t??n.spatialReference,u=r=>{n.map.ground&&n.map.ground.opacity<1?l.exclude.add(U):l.exclude.delete(U),n.sceneIntersectionHelper.intersectIntersectorScreen(e(r,o),s,l);const t=s.results.min;let u;if(t.getIntersectionPoint(a))u=t.intersector===H.TERRAIN?A.GROUND:A.OTHER;else{if(!s.results.ground.getIntersectionPoint(a))return null;u=A.GROUND}return{location:n.renderCoordsHelper.fromRenderCoords(a,new T({spatialReference:c})),surfaceType:u}};let i;return e=>{if("start"===e.action){const n=u(e.screenStart);i=null!=n?n.location:null}if(null==i)return null;const n=u(e.screenEnd);return null!=n?.location?{...e,mapStart:i,mapEnd:n.location,surfaceType:n.surfaceType}:null}}!function(e){e[e.GROUND=0]="GROUND",e[e.OTHER=1]="OTHER"}(A||(A={}));const q=t(),B=d(),z=d(),J=y();export{A as S,b as a,M as b,h as c,G as d,N as e,C as f,P as g,F as h,k as s};
