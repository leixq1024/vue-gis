/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{a as e}from"./devEnvironmentUtils.js";import{h as t}from"./mathUtils.js";import{m as r,b as s,f as o}from"./mat3.js";import{f as a,c as n}from"./mat3f64.js";import{i}from"./mat4.js";import{c as l}from"./mat4f64.js";import{O as u}from"./vec2f64.js";import{m as c,a as m,H as f,h as d,n as p,l as x}from"./vec3.js";import{c as h}from"./vec3f64.js";import{k as g,e as b}from"./aaBoundingBox.js";import{n as T,G as y,T as v}from"./StencilUtils.js";import{c as w,o as R,s as M,b as B,n as S,r as j}from"./BufferView.js";import{b as A,t as O,n as E,f as F}from"./vec32.js";import{t as C,b as I}from"./vec42.js";import{d as L,c as N,e as _,g as P}from"./DefaultMaterial_COLOR_GAMMA.js";import{D as V,a as D}from"./vec33.js";import{i as U}from"./resourceUtils3.js";import{Z as k,O as G}from"./vec2f32.js";import{l as q,p as H}from"./wosrLoader.js";import{N as W}from"./NormalAttribute.glsl.js";import{A as z}from"./Attribute.js";import{A as $,D as K,C as Q}from"./basicInterfaces.js";import{V as Z}from"./VertexAttribute.js";import{e as J,a as X,D as Y,u as ee,s as te}from"./DefaultMaterial.js";function re(e){if(null==e)return null;const t=null!=e.offset?e.offset:k,s=null!=e.rotation?e.rotation:0,o=null!=e.scale?e.scale:G,i=a(1,0,0,0,1,0,t[0],t[1],1),l=a(Math.cos(s),-Math.sin(s),0,Math.sin(s),Math.cos(s),0,0,0,1),u=a(o[0],0,0,0,o[1],0,0,0,1),c=n();return r(c,l,u),r(c,i,c),c}class se{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class oe{constructor(e,t,r){this.name=e,this.lodThreshold=t,this.pivotOffset=r,this.stageResources=new se,this.numberOfVertices=0}}async function ae(r,a){const n=ne(e(r));if("wosr"===n.fileType){const e=await(a.cache?a.cache.loadWOSR(n.url,a):q(n.url,a)),{engineResources:t,referenceBoundingBox:r}=H(e,a);return{lods:t,referenceBoundingBox:r,isEsriSymbolResource:!1,isWosr:!0}}let k;if(a.cache)k=await a.cache.loadGLTF(n.url,a,!!a.usePBR);else{const{loadGLTF:e}=await import("./loader2.js");k=await e(new V(a.streamDataRequester),n.url,a,a.usePBR)}const G=k.model.meta?.ESRI_proxyEllipsoid,se=k.meta.isEsriSymbolResource&&null!=G&&"EsriRealisticTreesStyle"===k.meta.ESRI_webstyle;se&&!k.customMeta.esriTreeRendering&&(k.customMeta.esriTreeRendering=!0,function(e,t){for(let r=0;r<e.model.lods.length;++r){const s=e.model.lods[r];for(const o of s.parts){const s=o.attributes.normal;if(null==s)return;const a=o.attributes.position,n=a.count,u=h(),g=h(),b=h(),T=new Uint8Array(4*n),y=new Float64Array(3*n),v=i(l(),o.transform);let w=0,M=0;for(let i=0;i<n;i++){a.getVec(i,g),s.getVec(i,u),c(g,g,o.transform),m(b,g,t.center),f(b,b,t.radius);const n=b[2],l=d(b),h=Math.min(.45+.55*l*l,1);f(b,b,t.radius),null!==v&&c(b,b,v),p(b,b),r+1!==e.model.lods.length&&e.model.lods.length>1&&x(b,b,u,n>-1?.2:Math.min(-4*n-3.8,1)),y[w]=b[0],y[w+1]=b[1],y[w+2]=b[2],w+=3,T[M]=255*h,T[M+1]=255*h,T[M+2]=255*h,T[M+3]=255,M+=4}o.attributes.normal=new B(y),o.attributes.color=new R(T)}}}(k,G));const ae=!!a.usePBR,le=k.meta.isEsriSymbolResource?{usePBR:ae,isSchematic:!1,treeRendering:se,mrrFactors:J}:{usePBR:ae,isSchematic:!1,treeRendering:!1,mrrFactors:X},ue={...a.materialParameters,treeRendering:se},{engineResources:ce,referenceBoundingBox:me}=function(e,r,a,n,i){const l=e.model,c=new Array,m=new Map,f=new Map,d=l.lods.length,p=g();return l.lods.forEach(((e,x)=>{const h=!0===n.skipHighLods&&(d>1&&0===x||d>3&&1===x)||!1===n.skipHighLods&&null!=i&&x!==i;if(h&&0!==x)return;const g=new oe(e.name,e.lodThreshold,[0,0,0]);e.parts.forEach((e=>{const i=h?new Y({},n):function(e,t,r,s,o,a,n,i){const l=t.material+(t.attributes.normal?"_normal":"")+(t.attributes.color?"_color":"")+(t.attributes.texCoord0?"_texCoord0":"")+(t.attributes.tangent?"_tangent":""),c=e.materials.get(t.material),m=null!=t.attributes.texCoord0,f=null!=t.attributes.normal;if(null==c)return null;const d=function(e){switch(e){case"BLEND":return $.Blend;case"MASK":return $.Mask;case"OPAQUE":case null:case void 0:return $.Opaque}}(c.alphaMode);if(!a.has(l)){if(m){const t=(t,r=!1)=>{if(null!=t&&!n.has(t)){const s=e.textures.get(t);if(null!=s){const e=s.data;n.set(t,new v(U(e)?e.data:e,{...s.parameters,preMultiplyAlpha:!U(e)&&r,encoding:U(e)&&null!=e.encoding?e.encoding:void 0}))}}};t(c.textureColor,d!==$.Opaque),t(c.textureNormal),t(c.textureOcclusion),t(c.textureEmissive),t(c.textureMetallicRoughness)}const r=c.color[0]**(1/L),p=c.color[1]**(1/L),x=c.color[2]**(1/L),h=c.emissiveFactor[0]**(1/L),g=c.emissiveFactor[1]**(1/L),b=c.emissiveFactor[2]**(1/L),T=null!=c.textureColor&&m?n.get(c.textureColor):null,y=ee({normalTexture:c.textureNormal,metallicRoughnessTexture:c.textureMetallicRoughness,metallicFactor:c.metallicFactor,roughnessFactor:c.roughnessFactor,emissiveTexture:c.textureEmissive,emissiveFactor:c.emissiveFactor,occlusionTexture:c.textureOcclusion}),w=null!=c.normalTextureTransform?.scale?c.normalTextureTransform?.scale:u;a.set(l,new Y({...s,transparent:d===$.Blend,customDepthTest:K.Lequal,textureAlphaMode:d,textureAlphaCutoff:c.alphaCutoff,diffuse:[r,p,x],ambient:[r,p,x],opacity:c.opacity,doubleSided:c.doubleSided,doubleSidedType:"winding-order",cullFace:c.doubleSided?Q.None:Q.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:f?W.Attribute:W.ScreenDerivative,castShadows:!0,receiveShadows:c.receiveShadows,receiveAmbientOcclusion:c.receiveAmbientOcclustion,textureId:null!=T?T.id:void 0,colorMixMode:c.colorMixMode,normalTextureId:null!=c.textureNormal&&m?n.get(c.textureNormal).id:void 0,textureAlphaPremultiplied:null!=T&&!!T.parameters.preMultiplyAlpha,occlusionTextureId:null!=c.textureOcclusion&&m?n.get(c.textureOcclusion).id:void 0,emissiveTextureId:null!=c.textureEmissive&&m?n.get(c.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=c.textureMetallicRoughness&&m?n.get(c.textureMetallicRoughness).id:void 0,emissiveFactor:[h,g,b],mrrFactors:y?te:[c.metallicFactor,c.roughnessFactor,s.mrrFactors[2]],isSchematic:y,colorTextureTransformMatrix:re(c.colorTextureTransform),normalTextureTransformMatrix:re(c.normalTextureTransform),scale:[w[0],w[1]],occlusionTextureTransformMatrix:re(c.occlusionTextureTransform),emissiveTextureTransformMatrix:re(c.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:re(c.metallicRoughnessTextureTransform),...o},i))}const p=a.get(l);if(r.stageResources.materials.push(p),m){const e=e=>{null!=e&&r.stageResources.textures.push(n.get(e))};e(c.textureColor),e(c.textureNormal),e(c.textureOcclusion),e(c.textureEmissive),e(c.textureMetallicRoughness)}return p}(l,e,g,r,a,m,f,n),{geometry:c,vertexCount:d}=function(e,r){const a=e.attributes.position.count,n=N(e.indices||a,e.primitiveType),i=T(3*a),{typedBuffer:l,typedBufferStride:u}=e.attributes.position;A(i,l,e.transform,3,u);const c=[[Z.POSITION,new z(i,n,3,!0)]];if(null!=e.attributes.normal){const r=T(3*a),{typedBuffer:o,typedBufferStride:i}=e.attributes.normal;s(ie,e.transform),O(r,o,ie,3,i),t(ie)&&E(r,r),c.push([Z.NORMAL,new z(r,n,3,!0)])}if(null!=e.attributes.tangent){const r=T(4*a),{typedBuffer:s,typedBufferStride:i}=e.attributes.tangent;o(ie,e.transform),C(r,s,ie,4,i),t(ie)&&E(r,r,4),c.push([Z.TANGENT,new z(r,n,4,!0)])}if(null!=e.attributes.texCoord0){const t=T(2*a),{typedBuffer:r,typedBufferStride:s}=e.attributes.texCoord0;_(t,r,2,s),c.push([Z.UV0,new z(t,n,2,!0)])}const m=e.attributes.color;if(null!=m){const t=new Uint8Array(4*a);4===m.elementCount?m instanceof w?I(t,m,255):m instanceof R?P(t,m):m instanceof M&&I(t,m,1/256):(t.fill(255),m instanceof B?F(t,m.typedBuffer,255,4,m.typedBufferStride):e.attributes.color instanceof S?D(t,m.typedBuffer,4,e.attributes.color.typedBufferStride):e.attributes.color instanceof j&&F(t,m.typedBuffer,1/256,4,m.typedBufferStride)),c.push([Z.COLOR,new z(t,n,4,!0)])}return{geometry:new y(r,c),vertexCount:a}}(e,i??new Y({},n)),V=c.boundingInfo;null!=V&&0===x&&(b(p,V.bbMin),b(p,V.bbMax)),null!=i&&(g.stageResources.geometries.push(c),g.numberOfVertices+=d)})),h||c.push(g)})),{engineResources:c,referenceBoundingBox:p}}(k,le,ue,a,n.specifiedLodIndex);return{lods:ce,referenceBoundingBox:me,isEsriSymbolResource:k.meta.isEsriSymbolResource,isWosr:!1}}function ne(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}const ie=n(),le=Object.freeze(Object.defineProperty({__proto__:null,fetch:ae,parseUrl:ne},Symbol.toStringTag,{value:"Module"}));export{ae as f,re as g,le as o};
