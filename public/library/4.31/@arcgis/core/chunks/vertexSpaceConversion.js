/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{L as n}from"./Logger.js";import{h as t,d as r,g as e}from"./mathUtils.js";import{af as o,ah as a,ai as i,h as s,Z as l,n as u,aj as c}from"./unitUtils.js";import{b as f,f as m}from"./mat3.js";import{c as p}from"./mat3f64.js";import{i as A,e as g,c as T,m as y,s as R}from"./mat4.js";import{c as E,I as d}from"./mat4f64.js";import{x as F,n as N,y as O,a as h,m as _}from"./vec3.js";import{c as P}from"./vec3f64.js";import{g as j,W as w}from"./spatialReferenceEllipsoidUtils.js";import{c as M}from"./computeTranslationToOriginAndRotation.js";import{p as v}from"./projectPointToVector.js";import{i as C,a as S}from"./meshVertexSpaceUtils.js";import{t as x,n as U,a as G,b as L}from"./vec32.js";import{p as b}from"./projectBuffer.js";import{y2lat as V}from"../geometry/support/webMercatorUtils.js";import{b as B,h as D}from"./BufferView.js";import{t as k}from"./vec42.js";const $="Projection may be possible after calling projection.load().";function W(n,t,r,e){n.error(`Failed to project from (wkid:${t.wkid}) to (wkid:${r.wkid}).${e?" ":""}${e}`)}function Y(n,t,r,e,o,a){return on(rn.TO_PCPF,B.fromTypedArray(n),tn.NORMAL,D.fromTypedArray(t),r,D.fromTypedArray(e),o,B.fromTypedArray(a))?a:null}function q(n,t,r,e,o,a){return on(rn.FROM_PCPF,B.fromTypedArray(n),tn.NORMAL,D.fromTypedArray(t),r,D.fromTypedArray(e),o,B.fromTypedArray(a))?a:null}function I(n,t,r,e){return b(n,t,0,r,e,0)?r:null}function Z(n,t,r,e){return b(n,t,0,r,e,0)?r:null}function z(n,r,e){return f(un,e),x(r,n,un),t(un)&&U(r,r),r}function H(n,r,e){return m(un,e),k(r,n,un),t(un)&&U(r,r,4),r}function J(n,t,e,o){const a=t===tn.NORMAL;return Q(n,t,e,((n,t)=>{const e=Math.cos(r(n));t[0]=a?e:1/e,t[1]=1}),o)}function K(n,t,r,e){const o=t===tn.NORMAL;return Q(n,t,r,((n,t)=>{const r=Math.cosh(-n/s.radius);t[0]=1,t[1]=o?r:1/r}),e)}function Q(n,t,r,e,o){const a=t===tn.NORMAL?3:4,i=[0,0];for(let t=0,s=1;t<n.length;t+=a,s+=3){e(r[s],i);const l=n[t]*i[0],u=n[t+1]*i[1],c=n[t+2],f=1/Math.sqrt(l*l+u*u+c*c);o[t]=l*f,o[t+1]=u*f,o[t+2]=c*f,4===a&&(o[t+3]=n[t+3])}return o}function X(n,t,r,e,o,a){if(!on(rn.TO_PCPF,B.fromTypedArray(n,4*Float32Array.BYTES_PER_ELEMENT),tn.TANGENT,D.fromTypedArray(t),r,D.fromTypedArray(e),o,B.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT)))return null;for(let t=3;t<n.length;t+=4)a[t]=n[t];return a}function nn(n,t,r,e,o,a){if(!on(rn.FROM_PCPF,B.fromTypedArray(n,16),tn.TANGENT,D.fromTypedArray(t),r,D.fromTypedArray(e),o,B.fromTypedArray(a,16)))return null;for(let t=3;t<n.length;t+=4)a[t]=n[t];return a}var tn,rn;function en(n,t,r,e,o){switch(M(e,r,ln,e),n===rn.FROM_PCPF&&A(ln,ln),t){case tn.NORMAL:return f(o,ln);case tn.TANGENT:return m(o,ln)}}function on(n,t,r,e,s,l,u,c){if(!t)return;const f=e.count;if(function(n){return n.isWGS84||o(n)||a(n)||i(n)}(s))for(let e=0;e<f;e++)l.getVec(e,an),t.getVec(e,sn),F(sn,sn,en(n,r,an,u,un)),c.setVec(e,sn);else for(let o=0;o<f;o++){l.getVec(o,an),t.getVec(o,sn);const a=V(e.get(o,1));let i=Math.cos(a);r===tn.TANGENT!=(n===rn.TO_PCPF)&&(i=1/i),en(n,r,an,u,un),n===rn.TO_PCPF?(un[0]*=i,un[1]*=i,un[2]*=i,un[3]*=i,un[4]*=i,un[5]*=i):(un[0]*=i,un[3]*=i,un[6]*=i,un[1]*=i,un[4]*=i,un[7]*=i),F(sn,sn,un),N(sn,sn),c.setVec(o,sn)}return c}!function(n){n[n.NORMAL=0]="NORMAL",n[n.TANGENT=1]="TANGENT"}(tn||(tn={})),function(n){n[n.TO_PCPF=0]="TO_PCPF",n[n.FROM_PCPF=1]="FROM_PCPF"}(rn||(rn={}));const an=P(),sn=P(),ln=E(),un=p(),cn=()=>n.getLogger("esri.geometry.support.meshUtils.vertexSpaceConversion");function fn(n,t,{vertexSpace:r,spatialReference:e}){if("georeferenced"===r.type){const o=n;if(!v(t,o,e))return!1;const{origin:a}=r;return h(n,o,a),!0}const o=j(e),a=n;if(!v(t,a,o))return!1;const{origin:i}=r,s=hn;if(!M(e,i,s,o))return!1;const l=A(hn,s);return null!=l&&(_(n,a,l),!0)}function mn(n,t,r){const{vertexSpace:e,transform:o,vertexAttributes:a}=n,i=C(e)?o:null,s=yn(n.spatialReference,r,_n.SOURCE_AND_TARGET);if(S(e,t)&&(!i||g(i.localMatrix,d))&&Rn(s)){const{position:n,normal:t,tangent:e}=a,o=r?.allowBufferReuse;return{position:o?n:n.slice(),normal:o?t:t?.slice(),tangent:o?e:e?.slice()}}switch(n.vertexSpace.type){case"local":return"local"===t.type?function({vertexAttributes:n,spatialReference:t,transform:r},{origin:e},o,a){const i=pn(t,a);if(!M(t,e,dn,i))return W(cn(),t,i),null;if(r&&y(dn,dn,r.localMatrix),!M(t,o,Fn,i))return W(cn(),i,t),null;A(Fn,Fn);const s=y(dn,Fn,dn);return Tn(s,t,a,_n.SOURCE_AND_TARGET),gn(n,s)}(n,n.vertexSpace,t.origin,r):function({spatialReference:n,vertexAttributes:t,transform:r},{origin:e},o,a){const i=pn(n,a);if(!M(n,e,dn,i))return W(cn(),n,i),null;r&&y(dn,dn,r.localMatrix),Tn(dn,n,a,_n.SOURCE);const s=new Float64Array(t.position.length),l=function(n,t,r,e,o){L(e,n,dn);const a=new Float64Array(n.length);return Z(e,o,a,r)?a:(W(cn(),o,r),null)}(t.position,0,n,s,i);if(!l)return null;const u=function(n,t,r,e,o,a){if(null==o)return null;const i=new Float32Array(o.length);return z(o,i,a),q(i,n,t,r,e,i)?i:(W(cn(),e,t),null)}(l,n,s,i,t.normal,dn);if(t.normal&&!u)return null;const c=function(n,t,r,e,o,a){if(null==o)return null;const i=new Float32Array(o.length);return H(o,i,a),nn(i,n,t,r,e,i)?i:(W(cn(),e,t),null)}(l,n,s,i,t.tangent,dn);if(t.tangent&&!c)return null;if(o){const n=O(On,o);G(l,l,n)}return{position:l,normal:u,tangent:c}}(n,n.vertexSpace,t.origin,r);case"georeferenced":return"local"===t.type?An(n,n.vertexSpace,t.origin,r):function({vertexAttributes:n,transform:t,spatialReference:r},{origin:e},o,a){const i=yn(r,a,_n.SOURCE_AND_TARGET),s=e||!Rn(i)?T(dn,t?.localMatrix??d):null;s&&Tn(s,r,a,_n.SOURCE_AND_TARGET);const{position:l,normal:u,tangent:c}=s?gn(n,s):n,f=a?.allowBufferReuse,m=f?l:new Float64Array(l.length);let p=l;if(e&&(p=G(m,p,e)),o){const n=O(On,o);p=G(m,p,n)}return{position:p!==n.position||f?p:p.slice(),normal:u!==n.normal||f?u:u?.slice(),tangent:c!==n.tangent||f?c:c?.slice()}}(n,n.vertexSpace,t.origin,r)}}function pn(n,t){return t?.useEllipsoid&&c(n)?w:j(n)}function An({vertexAttributes:n,spatialReference:t,transform:r},{origin:e},o,a){const i=pn(t,a);if(!M(t,o,dn,i))return W(cn(),t,i),null;const s=1/yn(t,a,_n.TARGET);R(dn,dn,[s,s,s]);const l=A(Fn,dn),{position:u,normal:c,tangent:m}=function(n,t,r){if(!t)return n;if(!r){const{position:r,normal:e,tangent:o}=n;return{position:G(new Float64Array(r.length),r,t),tangent:o,normal:e}}const e=gn(n,r.localMatrix);return G(e.position,e.position,t),e}(n,e,r),p=new Float64Array(u.length),g=function(n,t,r,e,o){const a=I(n,t,e,o);if(!a)return W(cn(),t,o),null;const i=new Float64Array(a.length);return L(i,a,r),i}(u,t,l,p,i);if(!g)return null;const T=f(Nn,l),y=function(n,t,r,e,o,a,i){if(null==n)return null;const s=i??new Float32Array(n.length);return Y(n,t,r,e,o,s)?(x(s,s,a),s):(W(cn(),r,o),null)}(c,u,t,p,i,T,c!==n.normal?c:void 0);if(!y&&c)return null;const E=function(n,t,r,e,o,a,i){if(null==n)return null;const s=i??new Float32Array(n.length);return X(n,t,r,e,o,s)?(x(s,s,a,4),s):(W(cn(),r,o),null)}(m,u,t,p,i,T,m!==n.tangent?m:void 0);return!E&&m?null:{position:g,normal:y,tangent:E}}function gn(n,t){const r=new Float64Array(n.position.length);L(r,n.position,t);const e=n.normal?new Float32Array(n.normal.length):null,o=n.tangent?new Float32Array(n.tangent.length):null;return e&&n.normal&&z(n.normal,e,t),o&&n.tangent&&H(n.tangent,o,t),{position:r,normal:e,tangent:o}}function Tn(n,t,r,e){const o=yn(t,r,e);Rn(o)||R(n,n,[o,o,o])}function yn(n,t,r){const e=!!(r&_n.SOURCE),o=!!(r&_n.TARGET),a=t?.sourceUnit,i=t?.targetUnit;if(!a&&!i)return 1;let s=En(a,n);e||!a||Rn(s)||(cn().warn("source unit conversion not supported"),s=1);let l=1/En(i,n);return o||!i||Rn(l)||(cn().warn("target unit conversion not supported"),l=1),s*l}function Rn(n){return e(n,1)}function En(n,t){if(null==n)return 1;const r=l(t);return 1/u(r,"meters",n)}const dn=E(),Fn=E(),Nn=p(),On=P(),hn=E();var _n;!function(n){n[n.NONE=0]="NONE",n[n.SOURCE=1]="SOURCE",n[n.TARGET=2]="TARGET",n[n.SOURCE_AND_TARGET=3]="SOURCE_AND_TARGET"}(_n||(_n={}));export{tn as V,$ as a,I as b,mn as c,Y as d,X as e,Z as f,En as g,q as h,nn as i,J as j,K as k,W as l,H as m,fn as p,z as t};
