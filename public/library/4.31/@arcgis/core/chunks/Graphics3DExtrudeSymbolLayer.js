/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{clone as t}from"../core/lang.js";import e from"../core/Error.js";import{A as s}from"./unitUtils.js";import{e as n}from"./earcut.js";import{b as o}from"./mat3.js";import{c as i}from"./mat3f64.js";import{i as a,q as r}from"./mat4.js";import{c}from"./mat4f64.js";import{i as l,n as h,f as p,a as u,c as m,G as d,m as f,j as g}from"./vec3.js";import{c as y,e as b,a as _,Z as x}from"./vec3f64.js";import{c as S}from"./computeTranslationToOriginAndRotation.js";import{h as P,u as E,c as j,A as C,B as O}from"./aaBoundingBox.js";import{g as I,n as w}from"./Indices.js";import{b as v}from"./vec32.js";import{m as A,a as M}from"./SnappingCandidate.js";import{b as R}from"./renderingInfoUtils.js";import{V as D}from"./ViewingMode.js";import{a as L,n as B,S as T}from"./ElevationContext.js";import{G as U,A as z,O as N,a as G,i as V}from"./ElevationUpdateEvent.js";import{v as F,c as H}from"./graphicUtils.js";import"../geometry.js";import{A as k}from"./Axis.js";import{l as W,r as Z,C as q}from"./triangulationUtils.js";import{A as J}from"./Attribute.js";import{C as K}from"./Material.js";import{G as Q}from"./StencilUtils.js";import{V as X}from"./VertexAttribute.js";import Y from"../geometry/Extent.js";import $ from"../geometry/Polygon.js";import{b as tt}from"./edgeUtils.js";import{d as et}from"./debugFlags2.js";import{S as st}from"./ElevationProvider.js";import{p as nt}from"./projectBuffer.js";import{d as ot}from"./RenderGeometry.js";import{N as it}from"./NormalAttribute.glsl.js";import{C as at}from"./basicInterfaces.js";import{c as rt,a as ct}from"./Normals.js";import{O as lt}from"./RibbonLineMaterial.js";import{D as ht}from"./DefaultMaterial.js";function pt(t,e,s){const o=(e.length>0?e[0]:t.length/3)-1,i=W(t,o,s);if(i!==k.Z){t=t.slice();for(let e=0;e<t.length;e+=3)t[e+i]=t[e+2]}return n(t,e,3)}function ut(t){const e=[[X.POSITION,new J(t.attributeData.position,t.indices,3,!0)]],s=I(t.indices.length);return null!=t.attributeData.colorFeature?e.push([X.COLORFEATUREATTRIBUTE,new J([t.attributeData.colorFeature],s,1,!0)]):t.attributeData.color&&e.push([X.COLOR,new J(t.attributeData.color,s,4,!0)]),t.attributeData.uvMapSpace&&e.push([X.UVMAPSPACE,new J(t.attributeData.uvMapSpace,t.indices,4,!0)]),t.attributeData.boundingRect&&e.push([X.BOUNDINGRECT,new J(t.attributeData.boundingRect,t.indices,9,!0)]),new Q(t.material,e,t.mapPositions,K.Mesh,t.attributeData.objectAndLayerIdColor)}function mt(t,e=null){const s=[[X.POSITION,new J(t.attributeData.position,t.indices,3,!0)],[X.UV0,new J(t.attributeData.uv0,t.indices,2,!0)]];return new Q(t.material,s,t.mapPositions,K.Mesh,e)}function dt(t){switch(t.type){case"extent":if(t instanceof Y)return $.fromExtent(t);break;case"polygon":return t}return null}class ft{constructor(t,e,s){this.renderData=t,this.layerUid=e,this.graphicUid=s,this.outGeometries=new Array}}function gt(t,e,s,n){const o=Z(t.rings,!!t.hasZ&&"on-the-ground"!==n.mode,q.CCW_IS_HOLE,t.spatialReference),i=P(o.position.length),a=L(o.position,t.spatialReference,0,i,0,o.position,0,o.position.length/3,e,s,n),r=null!=a;return new jt(o.position,i,_t(o.polygons,o.position,i),bt(o.outlines,o.position,i),r,a)}function yt(t,e){const s=Z(t.rings,!1,q.CCW_IS_HOLE),n=nt(s.position,t.spatialReference,0,s.position,e,0);for(let t=2;t<s.position.length;t+=3)s.position[t]=ot;return{position:s.position,polygons:_t(s.polygons,s.position),outlines:bt(s.outlines,s.position),projectionSuccess:n}}function bt(t,e,s=null){return t.filter((({count:t})=>t>1)).map((({index:t,count:n})=>{const o=3*t,i=3*n;return null!=s?new St(t,n,E(e,o,i),E(s,o,i)):new xt(t,n,E(e,o,i))}))}function _t(t,e,s=null){const n=new Array;for(const{index:o,count:i,holeIndices:a,pathLengths:r}of t){if(i<=1)continue;const t=3*o,c=3*i,l=a.map((t=>t-o)),h=null!=s?new Pt(o,i,E(e,3*o,3*i),E(s,t,c),l,r):new Et(o,i,E(e,3*o,3*i),l,r);n.push(h)}return n}class xt{constructor(t,e,s){this.index=t,this.count=e,this.position=s}}class St extends xt{constructor(t,e,s,n){super(t,e,s),this.mapPositions=n}}class Pt extends St{constructor(t,e,s,n,o,i){super(t,e,s,n),this.holeIndices=o,this.pathLengths=i}}class Et extends xt{constructor(t,e,s,n,o){super(t,e,s),this.holeIndices=n,this.pathLengths=o}}class jt{constructor(t,e,s,n,o,i){this.position=t,this.mapPositions=e,this.polygons=s,this.outlines=n,this.projectionSuccess=o,this.sampledElevation=i}}const Ct=["polygon","extent"];class Ot extends U{constructor(t,e,s,n){super(t,e,s,n),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const t=F(this._getSymbolSize());if(t)throw new e("graphics3dextrudesymbollayer:invalid-size",t)}const t=this.symbolLayer?.material?.color,s=this._getCombinedOpacityAndColor(t),n=b(s),o=s[3],i=o<1||this.needsDrivenTransparentPass,a=this.symbolLayer?.material?.emissiveFactor,r=a?d(_(a)):x,c={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:n,ambient:n,opacity:o,transparent:i,cullFace:i?at.None:at.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,emissiveFactor:r,offsetTransparentBackfaces:!0,normalType:it.Compressed};this._materials[Qt.Main]=new ht(c,this._context),this._materials[Qt.Bottom]=new ht({...c,cullFace:at.Back},this._context),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(t){const e=t.graphic;if(!this._validateGeometry(e.geometry,Ct,this.symbolLayer.type))return null;const s=this._getVertexOpacityAndColor(t.renderingInfo,255),n=this.setGraphicElevationContext(e);return this._createAs3DShape(e,t.renderingInfo,s,n,e.uid)}layerOpacityChanged(t,e){const s=this.symbolLayer?.material?.color,n=this._getCombinedOpacity(s),o=n<1||this.needsDrivenTransparentPass;this._materials[Qt.Main]?.setParameters({opacity:n,transparent:o}),this._materials[Qt.Bottom]?.setParameters({opacity:n,transparent:o});const i=this._getLayerOpacity();t.forEach((t=>e(t)?.layerOpacityChanged(i,this._context.isAsync)))}layerElevationInfoChanged(t,e){return this.updateGraphics3DGraphicElevationInfo(t,e,B)}slicePlaneEnabledChanged(t,e){return this._materials[Qt.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[Qt.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t.forEach((t=>{const s=e(t);null!=s&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[Qt.Main]?.setParameters(t),this._materials[Qt.Bottom]?.setParameters(t),!0}_getExtrusionSize(t){let e;return e=t.size&&this._drivenProperties.size?R(t.size,2)??0:this._getSymbolSize(),e/=this._context.renderCoordsHelper.unitInMeters,e}applyRendererDiff(t,e){return this._drivenPropertiesChanged(e)?z.RecreateSymbol:z.RecreateGraphics}async queryForSnapping(e,n,o,i){const a=this._getExtrusionSize(o)*this._context.renderCoordsHelper.unitInMeters/s(n),{objectId:r,target:c}=e,l=t(c);switch(l.z=(l.z??0)+a,e.type){case"edge":{const{start:s,end:n}=e,o=t(s),i=t(n);return o.z=(o.z??0)+a,i.z=(i.z??0)+a,[M(r,l,1/0,o,i)]}case"vertex":return[A(r,l,1/0),M(r,c,1/0,c,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,e,s,l,h){const u=dt(t.geometry);if(null==u)return null;if(0===u.rings.length||!u.rings.some((t=>t.length>0)))return this._logGeometryValidationWarnings(u.rings,"rings","ExtrudeSymbol3DLayer"),null;const m=gt(u,this._context.elevationProvider,this._context.renderCoordsHelper,l);this._logGeometryCreationWarnings(m,u.rings,"rings","ExtrudeSymbol3DLayer");const d=H(u);if(null==d)return null;const g=new Array,b=new Array,_=j(),x=c(),E=y(),I=this._context.renderCoordsHelper.viewingMode===D.Global;I||this._context.renderCoordsHelper.worldUpAtPosition(null,E),S(u.spatialReference,[d.x,d.y,0],x,this._context.renderCoordsHelper.spatialReference);const A=c();a(A,x);const M=i();o(M,A);const{polygons:R,mapPositions:L,position:T}=m,U=new Map,z=this._materials[Qt.Main];for(const t of R){const o=t.count;if(this._context.clippingExtent&&(C(t.mapPositions,_),!O(_,this._context.clippingExtent)))continue;const i=n(t.mapPositions,t.holeIndices,3);if(0===i.length)continue;const a=i.length,r=6*o,c=w(r+a),l=w(a),p=P(3*r),u=P(3*r),m=P(3*r),d=P(r);wt(T,L,i,t,p,m,u,d,c,l,this._getExtrusionSize(e),E,I),v(p,p,A);const f=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:h,layerUid:this._context.layer.uid}),y=new Xt(p,m,rt(u),d),S=It(z,c,c.length-l.length,y,s,f),j=o,M=o,R=2*t.count,D=new Yt(j,M,R,a/3);Nt(S,D,x),U.set(S,D),g.push(S,It(this._materials[Qt.Bottom],l,0,y,s,f)),b.push(y.heights)}if(0===g.length)return null;const F=new lt({geometries:g,layerUid:this._context.layer.uid,graphicUid:h,isElevationSource:!0});F.transformation=x;const k=tt(this.symbolLayer,{opacity:this._getLayerOpacity()}),W=k?new N(this._materials[Qt.Main],k,this._context.slicePlaneEnabled):null,Z=new G(this,F,g,null,null,((t,e,s,n,o)=>function(t,e,s,n,o,i,a){const l=t.stageObject,h=l.geometries,u=h.length,m="absolute-height"!==e.mode;let d=0;const g=l.transformation,y=r(c(),g);for(let t=0;t<u;t+=2){const e=h[t];if(!V(e))continue;const r=e.getMutableAttribute(X.POSITION).data,c=i[t/2],u=new st(e.mapPositions),b=r.length/3;let _=!1,x=0;{let t=0;for(let e=0;e<b;e++){zt[0]=r[t],zt[1]=r[t+1],zt[2]=r[t+2],n(u,Ft),m&&(x+=Ft.sampledElevation),et.TESTS_DISABLE_OPTIMIZATIONS?(p(Gt,u.array[u.offset],u.array[u.offset+1],Ft.z+c[t/3]),null!=s&&o.toRenderCoords(Gt,s,Gt),f(Gt,Gt,y)):(p(Gt,r[t],r[t+1],r[t+2]),f(Gt,Gt,g),o.setAltitude(Gt,Ft.z+c[t/3]),f(Gt,Gt,y)),r[t]=Gt[0],r[t+1]=Gt[1],r[t+2]=Gt[2];const e=Wt/o.unitInMeters;(Math.abs(zt[0]-r[t])>=e||Math.abs(zt[1]-r[t+1])>=e||Math.abs(zt[2]-r[t+2])>=e)&&(_=!0),u.offset+=3,t+=3}}if(_){const s=a.get(e);s&&Nt(e,s,g),l.geometryVertexAttributeUpdated(h[t],X.NORMALCOMPRESSED),e.invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(h[t],X.POSITION),h[t+1].invalidateBoundingInfo(),l.geometryVertexAttributeUpdated(h[t+1],X.POSITION)}d+=x/b}return d/u}(t,e,s,n,o,b,U)),l,W);return Z.alignedSampledElevation=m.sampledElevation,Z.needsElevationUpdates=B(l.mode),Z}}function It(t,e,s,n,o,i){const a=I(e.length),r=[[X.POSITION,new J(n.positions,e,3,!0)],[X.NORMALCOMPRESSED,new J(n.normals,e,2,!0)],[X.COLOR,new J(o,a,4,!0)]];return new Q(t,r,n.elevation,K.Mesh,i,s)}function wt(t,e,s,n,o,i,a,r,c,p,u,m,d){{const f=s.length/3,g=2*n.count;!function(t,e,s,n,o,i,a,r,c,p,u,m,d,f,g,y,b){l(Vt,y);{const o=g>0?1:-1;let i=3*s,a=0,l=3*a,m=n,d=3*m;for(let s=0;s<n;++s){const s=t[i],n=t[i+1],f=t[i+2];b&&(Vt[0]=s,Vt[1]=n,Vt[2]=f,h(Vt,Vt)),r[l+0]=s,r[l+1]=n,r[l+2]=f;const y=e[i+0],_=e[i+1],x=e[i+2];c[l+0]=y,c[l+1]=_,c[l+2]=x,p[l+0]=-o*Vt[0],p[l+1]=-o*Vt[1],p[l+2]=-o*Vt[2],u[a]=0,r[d+0]=s+g*Vt[0],r[d+1]=n+g*Vt[1],r[d+2]=f+g*Vt[2],c[d+0]=y,c[d+1]=_,c[d+2]=x,u[m]=g,l+=3,d+=3,i+=3,a+=1,m+=1}}{let t=0,e=0,s=3*f;const i=g<0?kt:Ht,r=g<0?Ht:kt;for(let c=0;c<a;++c)d[e]=o[t+i[0]],d[e+1]=o[t+i[1]],d[e+2]=o[t+i[2]],m[s]=o[t+r[0]]+n,m[s+1]=o[t+r[1]]+n,m[s+2]=o[t+r[2]]+n,e+=3,s+=3,t+=3}}(t,e,n.index,n.count,s,0,f,o,i,a,r,c,p,g,u,m,d)}{let t=0,e=2*n.count,s=0;const l=n.pathLengths[0];Mt(o,i,r,a,t,l,n.count,e,c,s,u),e+=4*l,s+=2*l,t+=l;for(let l=1;l<n.pathLengths.length;++l){const h=n.pathLengths[l];Mt(o,i,r,a,t,h,n.count,e,c,s,u),e+=4*h,s+=2*h,t+=h}}}function vt(t,e,s,n,o,i,a){n[i]=n[a],a*=3,t[i*=3]=t[a],t[i+1]=t[a+1],t[i+2]=t[a+2],e[i]=e[a],e[i+1]=e[a+1],e[i+2]=e[a+2],s[i]=o[0],s[i+1]=o[1],s[i+2]=o[2]}const At=y();function Mt(t,e,s,n,o,i,a,r,c,l,h){let p=o,u=o+1,m=o+a,d=o+a+1,f=r,g=r+1,y=r+2*i,b=r+2*i+1;h<0&&(p=o+a+1,d=o);let _=3*l;for(let r=0;r<i;++r)r===i-1&&(u=o,h>0?d=o+a:p=o+a),Ut(t,p,u,m,At),vt(t,e,n,s,At,f,p),vt(t,e,n,s,At,g,u),vt(t,e,n,s,At,y,m),vt(t,e,n,s,At,b,d),c[_]=f,c[_+1]=y,c[_+2]=b,c[_+3]=f,c[_+4]=b,c[_+5]=g,_+=6,p++,u++,m++,d++,f+=2,g+=2,y+=2,b+=2}const Rt=y(),Dt=y(),Lt=y(),Bt=y(),Tt=y();function Ut(t,e,s,n,o){e*=3,s*=3,n*=3,p(Rt,t[e++],t[e++],t[e++]),p(Dt,t[s++],t[s++],t[s++]),p(Lt,t[n++],t[n++],t[n++]),u(Bt,Dt,Rt),u(Tt,Lt,Rt),m(o,Tt,Bt),h(o,o)}const zt=y();function Nt(t,e,s){const n=t.getMutableAttribute(X.POSITION),o=t.getMutableAttribute(X.NORMALCOMPRESSED).data,{topVertexStart:i,topVertexCount:a,topFaceStart:r,topFaceCount:c}=e,l=n.data,u=a,d=t.attributes.get(X.POSITION).indices,y=r+c,b=i+a,_=P(3*u);for(let t=0;t<u;++t){const e=3*t;_[e+0]=0,_[e+1]=0,_[e+2]=0}const x=Zt,S=qt,E=Jt,j=Kt,C=Vt;for(let t=r;t<y;++t){const e=3*t;for(let t=0;t<3;++t){const n=d[e+t];j[t]=n;const o=3*n;p(Gt,l[o+0],l[o+1],l[o+2]),f(x[t],Gt,s)}g(S,x[1],x[0]),g(E,x[2],x[0]),m(C,S,E),h(C,C);for(let t=0;t<3;++t){const e=3*(j[t]-i);_[e+0]+=C[0],_[e+1]+=C[1],_[e+2]+=C[2]}}for(let t=i;t<b;++t){const e=3*(t-i),s=_[e+0],n=_[e+1],a=_[e+2],r=Math.sqrt(s*s+n*n+a*a);ct(o,t,s/r,n/r,a/r)}}const Gt=y(),Vt=y(),Ft=new T,Ht=[0,2,1],kt=[0,1,2],Wt=.01,Zt=[y(),y(),y()],qt=y(),Jt=y(),Kt=[0,0,0];var Qt;!function(t){t[t.Main=0]="Main",t[t.Bottom=1]="Bottom"}(Qt||(Qt={}));class Xt{constructor(t,e,s,n){this.positions=t,this.elevation=e,this.normals=s,this.heights=n}}class Yt{constructor(t,e,s,n){this.topVertexStart=t,this.topVertexCount=e,this.topFaceStart=s,this.topFaceCount=n}}export{Ot as G,ft as P,dt as a,ut as b,pt as c,yt as d,wt as e,mt as f,gt as g};
