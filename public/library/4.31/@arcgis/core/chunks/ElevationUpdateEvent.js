/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{c as e}from"./vec2f64.js";import{d as t,a as r,g as s,s as i,o as a,i as n,f as o,m as l}from"./vec3.js";import{c,O as u}from"./vec3f64.js";import{g as h,z as d}from"./plane.js";import{L as p,a as m}from"./Logger.js";import{t as y,b as f}from"./calloutUtils.js";import g from"../Color.js";import{a as b}from"./screenUtils.js";import{f as v,Z as S,c as _}from"./vec4f64.js";import{c as P}from"./mat4.js";import{c as L}from"./mat4f64.js";import{c as E}from"./computeTranslationToOriginAndRotation.js";import{p as O}from"./projectBuffer.js";import{u as x,S as C,s as A,d as D,E as w,z as j,g as F,h as T,i as I,j as R,k as G}from"./ElevationContext.js";import{d as z}from"./debugFlags2.js";import{S as U}from"./ElevationProvider.js";import"./Indices.js";import{S as B,o as M,i as N,r as V}from"../core/lang.js";import{a8 as q,R as k,h as H,S as $,j as W,F as Z,b as Q,k as J,l as Y,I as X,i as K,a as ee,G as te}from"./StencilUtils.js";import{M as re,b as se,C as ie}from"./Material.js";import"./triangle.js";import{O as ae}from"./basicInterfaces.js";import{V as ne}from"./VertexAttribute.js";import{c as oe,e as le,d as ce}from"./coordsUtils.js";import{d as ue,m as he,c as de}from"./graphicUtils.js";import{p as pe}from"./projectPointToVector.js";import{y as me,z as ye,c as fe,r as ge,k as be,p as ve,J as Se,K as _e,C as Pe,F as Le,b as Ee,L as Oe,q as xe}from"./aaBoundingBox.js";import{m as Ce}from"./dehydratedPoint.js";import{O as Ae}from"./RibbonLineMaterial.js";import{A as De}from"./Attribute.js";import{f as we}from"./vec2f32.js";import{n as je}from"./InterleavedLayout.js";import{c as Fe,S as Te}from"./Matrix4PassUniform.js";import{a as Ie}from"./AlphaCutoff.js";import{b as Re,c as Ge,e as ze}from"./RayIntersections.js";import{g as Ue,e as Be}from"./vec2.js";import{A as Me,H as Ne,a as Ve}from"./HUDVisibility.glsl.js";import{g as qe,I as ke}from"./interfaces3.js";import{b as He}from"./VerticalOffset.glsl.js";import{f as $e,a as We}from"./enums.js";import{m as Ze,a as Qe,s as Je,d as Ye}from"./renderState.js";import{_ as Xe}from"./tslib.es6.js";import{p as Ke}from"./ShaderTechniqueConfiguration.js";import{f as et}from"./asyncUtils.js";import{isAbortError as tt,onAbortOrThrow as rt,throwIfAborted as st,createAbortError as it,createResolver as at,onAbort as nt}from"../core/promiseUtils.js";import{h as ot}from"../core/Accessor.js";import lt from"../geometry/Polygon.js";import{p as ct}from"./projectBoundingRect.js";import{c as ut,C as ht,e as dt}from"./aaBoundingRect.js";import{f as pt}from"./unitUtils.js";import{d as mt}from"./dehydratedFeatures.js";import{b as yt}from"./featureConversionUtils.js";import{g as ft}from"./sphere.js";import{T as gt,h as bt}from"./edgeUtils.js";import{V as vt}from"./ViewingMode.js";import{n as St}from"./compilerUtils.js";import{d as _t}from"../symbols/ObjectSymbol3DLayer.js";import{k as Pt,l as Lt,m as Et,h as Ot,e as xt,n as Ct,o as At}from"./GeometryUtil.js";import{b as Dt,a as wt,L as jt}from"./LodResources.js";import{D as Ft}from"./DefaultMaterial.js";import{a as Tt}from"./maybe.js";import"../geometry.js";import{T as It,n as Rt}from"./Scheduler.js";import Gt from"../geometry/Multipoint.js";function zt(e,t,s,o){const l=function(e,t,s){const o=Bt;return e?(s&&(o.len=a(t,s)),n(o.dir,e)):(o.len=a(t,s),r(o.dir,s,t),i(o.dir,o.dir,1/o.len)),o}(o,t,s);return function(e,t,r,s){s.clip[0]=0,s.clip[1]=r?s.len:Number.MAX_VALUE;for(let r=0;r<e.length;r++)if(!Mt(e[r],t,s))return!1;return!0}(e,t,s,l)}function Ut(e,a,n,o){const l=t(n,r(e,o,a));return s(e,a,i(e,n,l))}const Bt={dir:c(),len:0,clip:e()};function Mt(e,r,s){const i=t(h(e),s.dir),a=-d(e,r);if(a<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return a>0;if((a<0||i<0)&&!(a<0&&i<0))return!0;const n=a/i;return i>0?n<s.clip[1]&&(s.clip[1]=n):n>s.clip[0]&&(s.clip[0]=n),s.clip[0]<=s.clip[1]}var Nt,Vt;function qt(e){return null!=e.mapPositions}function kt(e,t,r,s,i){const a=e.stageObject,n=a.geometries;let o=0;for(const e of n){if(!qt(e))continue;const{update:n,averageGeometrySampledElevation:l}=rr(e,t,r,s,i);o+=l,n&&a.geometryVertexAttributeUpdated(e,ne.POSITION)}return o/n.length}function Ht(e,t,r,s,i,a){const n=e.stageObject,l=t.centerPointInElevationSR;let c=0;n.usesVerticalDistanceToGround?(s(l,tr),x(n,tr.verticalDistanceToGround),c=tr.sampledElevation):(s(l,tr),"absolute-height"!==t.mode&&(c=tr.sampledElevation));const u=P($t,a??n.transformation),h=o(er,u[12],u[13],u[14]);z.TESTS_DISABLE_OPTIMIZATIONS?(Jt[0]=l.x,Jt[1]=l.y,Jt[2]=tr.z,E(l.spatialReference,Jt,u,i.spatialReference)&&(a?P(a,u):n.transformation=u)):i.setAltitudeOfTransformation(tr.z,u);const d=Qt/i.unitInMeters;return(Math.abs(u[12]-h[0])>=d||Math.abs(u[13]-h[1])>=d||Math.abs(u[14]-h[2])>=d)&&(a?P(a,u):n.transformation=u),c}!function(e){e[e.USER=1]="USER",e[e.SCALE_RANGE=2]="SCALE_RANGE",e[e.FILTER=4]="FILTER",e[e.DECONFLICTION=8]="DECONFLICTION",e[e.ALL_GRAPHIC=15]="ALL_GRAPHIC",e[e.ALL_LABEL=255]="ALL_LABEL"}(Nt||(Nt={})),function(e){e[e.GRAPHIC=1]="GRAPHIC",e[e.LABEL=16]="LABEL"}(Vt||(Vt={}));const $t=L();function Wt(e,t,r,s,i){const a=e.graphics3DSymbolLayer.lodRenderer;if(null==a)return 0;const n=t.centerPointInElevationSR;s(n,tr);const l="absolute-height"!==t.mode?tr.sampledElevation:0,c=a.instanceData,u=e.instanceIndex,h=Kt;c.getGlobalTransform(u,h);const d=o(er,h[12],h[13],h[14]);z.TESTS_DISABLE_OPTIMIZATIONS?(Jt[0]=n.x,Jt[1]=n.y,Jt[2]=tr.z,E(n.spatialReference,Jt,h,i.spatialReference)&&c.setGlobalTransform(u,h)):i.setAltitudeOfTransformation(tr.z,h);const p=Qt/i.unitInMeters;return(z.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-d[0])>=p||Math.abs(h[13]-d[1])>=p||Math.abs(h[14]-d[2])>=p)&&c.setGlobalTransform(u,h),l}function Zt(e,t,r,s,i){const a=e.stageObject,n=a.geometries;if(0===n.length)return 0;let o=0,l=null,c=0,u=!1;for(const e of n){if(!qt(e))continue;const n=e.attributes.get(ne.POSITION);if(n!==l){const{update:a,averageGeometrySampledElevation:o}=rr(e,t,r,s,i);c=o,l=n,u=a}u&&a.geometryVertexAttributeUpdated(e,ne.POSITION),o+=c}return o/n.length}const Qt=.01,Jt=c(),Yt=c(),Xt=c(),Kt=L(),er=c(),tr=new C;function rr(e,t,r,s,i){let a=!1;const n=e.transformation,o=t.requiresSampledElevationInfo;Yt[0]=n[12],Yt[1]=n[13],Yt[2]=n[14],e.invalidateBoundingInfo();const l=e.getMutableAttribute(ne.POSITION),c=l.data,u=l.size,h=c.length/u,d=new U(e.mapPositions,r);let p=0,m=0;for(let e=0;e<h;e++){if(Xt[0]=c[p],Xt[1]=c[p+1],Xt[2]=c[p+2],s(d,tr),o&&(m+=tr.sampledElevation),z.TESTS_DISABLE_OPTIMIZATIONS)c[p]=d.array[d.offset],c[p+1]=d.array[d.offset+1],c[p+2]=tr.z,O(c,r,p,c,i.spatialReference,p,1),c[p]-=Yt[0],c[p+1]-=Yt[1],c[p+2]-=Yt[2],a=!0;else{Jt[0]=c[p]+Yt[0],Jt[1]=c[p+1]+Yt[1],Jt[2]=c[p+2]+Yt[2],i.setAltitude(Jt,tr.z),c[p]=Jt[0]-Yt[0],c[p+1]=Jt[1]-Yt[1],c[p+2]=Jt[2]-Yt[2];const e=Qt/i.unitInMeters;(Math.abs(Xt[0]-c[p])>=e||Math.abs(Xt[1]-c[p+1])>=e||Math.abs(Xt[2]-c[p+2])>=e)&&(a=!0)}p+=u,d.offset+=3}return m/=h,{update:a,averageGeometrySampledElevation:m}}class sr{constructor(e,t,r){this.graphic=e,this.renderingInfo=t,this.layer=r}}class ir{constructor(e,t,r){this.baseMaterial=e,this.edgeMaterial=t,this.hasSlicePlane=r}}class ar{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,r,s,i,a,n,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=r,this._uniqueMaterials=s,this._sharedResource=i,this.elevationAligner=a,this.elevationContext=n,this._edgeState=o,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e;const t=e.stage;t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.add(this.stageObject)}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}layerOpacityChanged(e,t){const{stageObject:r,_edgeState:s,_stageLayer:i}=this;if(null==s)return;const a=nr(s.baseMaterial);s.edgeMaterial.objectTransparency!==a&&(s.edgeMaterial.objectTransparency=a,this.resetEdgeObject(t)),i.stage.renderer.withEdgeView((t=>t.updateAllComponentOpacities(r,[e])))}slicePlaneEnabledChanged(e,t){const{stageObject:r,_edgeState:s,_stageLayer:i}=this;null!=s&&i.stage.renderer.withEdgeView((i=>{i.updateAllComponentMaterials(r,s.edgeMaterial,e,!t),s.hasSlicePlane=e}))}setVisibility(e){const{_edgeState:t,stageObject:r,_stageLayer:s}=this;null!=s&&this.visible!==e&&(this._visible=e,r.visible=e,e&&!this._addedToStage&&(s.add(r),this._addedToStage=!0),null!=t&&s.stage.renderer.withEdgeView((s=>{s.hasObject(r)?s.updateObjectVisibility(r,e):e&&this._addOrUpdateEdgeObject(t,s,!1)})))}get visible(){return this._visible}alignWithElevation(e,t,r,s){null!=this.elevationAligner&&(null!=r&&A(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,((r,s)=>D(r,e,this.elevationContext,t,s)),t),this.resetEdgeObject(s))}alignWithAbsoluteElevation(e,t,r){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,((t,r)=>{r.sampledElevation=e,r.verticalDistanceToGround=0,r.z=e}),t),this.resetEdgeObject(r)}getCenterObjectSpace(e=c()){return n(e,ft(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=fe()){const t=this.stageObject.boundingVolumeObjectSpace;return me(e,t.min),ye(e,t.max),e}computeAttachmentOrigin(e){const t=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;else for(const r of this.stageObject.geometries)r.computeAttachmentOrigin(cr)&&(l(cr,cr,t),s(e.render.origin,e.render.origin,cr),e.render.num++)}async getProjectedBoundingBox(e,t,r,s,i){const a=this.getBoundingBoxObjectSpace(i),n=ur,o=ge(a)?1:n.length;for(let e=0;e<o;e++){const t=n[e];lr[0]=a[t[0]],lr[1]=a[t[1]],lr[2]=a[t[2]],l(lr,lr,this.stageObject.transformation),or[3*e]=lr[0],or[3*e+1]=lr[1],or[3*e+2]=lr[2]}if(!e(or,0,o))return null;be(a);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let e=0;e<3*o;e+=3){for(let t=0;t<3;t++)a[t]=Math.min(a[t],or[e+t]),a[t+3]=Math.max(a[t+3],or[e+t]);c&&r.push({location:or.slice(e,e+3),screenSpaceBoundingRect:c})}if(t?.service&&"absolute-height"!==this.elevationContext.mode){ve(a,cr);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let r=0;if(t.useViewElevation)r=t.service.getElevation(cr[0],cr[1],e)??0;else try{const i=ue(a,t.service.spatialReference,t);r=await t.service.queryElevation(cr[0],cr[1],s,i,e)??0}catch(e){}Se(a,0,0,-this.alignedSampledElevation+r)}return a}addObjectState(e){e.stateType===ae.Highlight&&e.addObject(this.stageObject,this.stageObject.highlight(e.highlightGroupName)),e.stateType===ae.MaskOccludee&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeByObject(this.stageObject)}resetEdgeObject(e){const{_edgeState:t,stageObject:r,_stageLayer:s,_visible:i}=this;null!=t&&s.stage.renderer.withEdgeView((s=>{i?this._addOrUpdateEdgeObject(t,s,e):s.removeObject(r)}))}_addOrUpdateEdgeObject(e,t,r){const s=nr(e.baseMaterial);e.edgeMaterial.objectTransparency=s,t.addOrUpdateObject3D(this.stageObject,e.edgeMaterial,e.hasSlicePlane,!r).then((()=>this._stageLayer?.sync()))}}function nr(e){return e.parameters.transparent?gt.TRANSPARENT:gt.OPAQUE}const or=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],lr=c(),cr=c(),ur=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class hr{constructor(e,t=null){this.labelText=t,this.elevationOffset=e??0}}const dr=3,pr=3,mr=10;function yr(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function fr(e,t){const r=(e,t,r=!1)=>new Dt(e.map((e=>{const s=t(e.tesselation);return r&&Pt(s),new wt([new jt(s)],e.minScreenSpaceRadius)})));switch(e){case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(e=>At(t,.5,e,!0)));case"cube":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>Ct(t,1)));case"cone":return r(gr,(e=>xt(t,1,.5,e,!1)),!0);case"inverted-cone":return r(gr,(e=>xt(t,1,.5,e,!0)),!0);case"cylinder":return r(gr,(e=>Ot(t,1,.5,e,[0,0,1],[0,0,.5])));case"tetrahedron":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>Et(t,1)),!0);case"diamond":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>Lt(t,1)),!0);default:return}}const gr=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class br{constructor(e){this.estimated=!1,this.verticesPerFeature=e.verticesPerFeature??0,this.verticesPerCoordinate=e.verticesPerCoordinate??0,this.drawCallsPerFeature=e.drawCallsPerFeature??0,this.memory=e.memory??new Pr}}class vr extends br{constructor(e){super(e),this.estimated=!0}}class Sr extends br{constructor(e,t){super(t),this.numComplexities=e}}class _r extends vr{constructor(e,t){super(t),this.numComplexities=e}}class Pr{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}const Lr=new vr({});function Er(e){return"web-style"===e.type?Lr:Or(e.symbolLayers.toArray().map((t=>Ar(e,t))))}function Or(e){let t=0,r=0,s=0,i=!1,a=0;const n=new Pr;for(const o of e)null!=o&&(t+=o.verticesPerFeature,r+=o.verticesPerCoordinate,s+=o.drawCallsPerFeature,n.bytesPerFeature+=o.memory.bytesPerFeature,n.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,n.resourceBytes+=o.memory.resourceBytes,n.draped.bytesPerFeature+=o.memory.bytesPerFeature,n.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,i=i||o.estimated,++a);return i?new _r(a,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:s,memory:n}):new Sr(a,{verticesPerFeature:t,verticesPerCoordinate:r,drawCallsPerFeature:s,memory:n})}function xr(e){const t=Or(e);return t.numComplexities>0&&(t.verticesPerFeature/=t.numComplexities,t.verticesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities),t}const Cr={};function Ar(e,t){const r=Dr(e,t),s=bt(t)?2:0;switch(t.type){case"extrude":return new br({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:s,memory:r});case"fill":if("mesh-3d"===e.type)return new br({drawCallsPerFeature:s,memory:r});if(null!=t.outline&&t.outline.size>0)return new br({verticesPerFeature:-12,verticesPerCoordinate:9,memory:r});case"water":return new br({verticesPerFeature:-6,verticesPerCoordinate:3,memory:r});case"line":return new br({verticesPerFeature:-6,verticesPerCoordinate:6,memory:r});case"object":return t.resource?.href?new vr({verticesPerFeature:100,memory:r}):{...wr(t.resource?.primitive??_t),memory:r};case"path":{let e=0,s=0;switch(t.profile){case"circle":e=10;break;case"quad":e=4;break;default:return void St(t.profile)}switch(t.join){case"round":s=3;break;case"miter":case"bevel":s=1;break;default:return}const i=2*e,a=e*s*2,n=a+i;let o=-2*a-i;switch(t.cap){case"none":break;case"butt":case"square":o+=2*(e-1);break;case"round":o+=2*(2*e*2+e);break;default:return}return new br({verticesPerFeature:o,verticesPerCoordinate:n,memory:r})}case"text":case"icon":return new br({verticesPerFeature:6,memory:r});default:return}}function Dr(e,t){const r="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?Fr.EXTRUDE_EDGES:Fr.EXTRUDE;case"fill":return null!=t.outline&&t.outline.size>0?Fr.FILL_OUTLINE:Fr.FILL;case"water":return Fr.FILL;case"line":return"round"===t.join?Fr.LINE_ROUND:Fr.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return Fr.PATH_ROUND_CIRCLE;case"quad":return Fr.PATH_ROUND_QUAD;default:return void St(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return Fr.PATH_MITER_CIRCLE;case"quad":return Fr.PATH_MITER_QUAD;default:return void St(t.profile)}default:return}case"object":return r?Fr.OBJECT_POINT:Fr.OBJECT_POLYGON;case"icon":case"text":return r?Fr.ICON_POINT:Fr.ICON_POLYGON;default:return}}function wr(e){const t=Cr[e];if(t)return t;const r=jr(fr(e,new Ft({},{spherical:!0,doublePrecisionRequiresObfuscation:!0})).levels);return Cr[e]=new br({verticesPerFeature:r}),Cr[e]}function jr(e){return e.reduce(((e,t,r)=>e+t.numVertices*(1/10**r)),0)/e.reduce(((e,t,r)=>e+1/10**r),0)}const Fr={ICON_POINT:{bytesPerFeature:2346.460896195398,bytesPerFeatureLabel:3484.7516349999996,resourceBytes:0,draped:{bytesPerFeature:2007.3528529826217,bytesPerFeatureLabel:3522.702025}},ICON_POLYGON:{bytesPerFeature:3677.214053765355,bytesPerFeatureLabel:3502.5355950000003,resourceBytes:0,draped:{bytesPerFeature:3030.3700096053935,bytesPerFeatureLabel:3550.247175}},OBJECT_POINT:{bytesPerFeature:569.2092700798497,bytesPerFeatureLabel:3183.0256999999992,resourceBytes:0,draped:{bytesPerFeature:569.2092700798497,bytesPerFeatureLabel:3183.0256999999992}},OBJECT_POLYGON:{bytesPerFeature:1252.202280530861,bytesPerFeatureLabel:3125.853350000001,resourceBytes:0,draped:{bytesPerFeature:1252.202280530861,bytesPerFeatureLabel:3125.853350000001}},LINE_MITER:{bytesPerFeature:3252.89170349711,bytesPerFeatureLabel:3554.3931949999997,resourceBytes:0,draped:{bytesPerFeature:2843.5793737736867,bytesPerFeatureLabel:3538.2547083333334}},LINE_ROUND:{bytesPerFeature:3384.080501909172,bytesPerFeatureLabel:3522.6055950000004,resourceBytes:0,draped:{bytesPerFeature:2833.1897218657587,bytesPerFeatureLabel:3532.0680950000005}},PATH_MITER_CIRCLE:{bytesPerFeature:38490.63544346431,bytesPerFeatureLabel:3660.7835999999998,resourceBytes:0,draped:{bytesPerFeature:38490.63544346431,bytesPerFeatureLabel:3660.7835999999998}},PATH_ROUND_CIRCLE:{bytesPerFeature:42934.88589895749,bytesPerFeatureLabel:3729.49955,resourceBytes:0,draped:{bytesPerFeature:42934.88589895749,bytesPerFeatureLabel:3729.49955}},PATH_MITER_QUAD:{bytesPerFeature:25392.923576583788,bytesPerFeatureLabel:3647.05925,resourceBytes:0,draped:{bytesPerFeature:25392.923576583788,bytesPerFeatureLabel:3647.05925}},PATH_ROUND_QUAD:{bytesPerFeature:40448.297252606244,bytesPerFeatureLabel:3646.8303499999997,resourceBytes:0,draped:{bytesPerFeature:40448.297252606244,bytesPerFeatureLabel:3646.8303499999997}},FILL:{bytesPerFeature:3419.9079008788176,bytesPerFeatureLabel:3564.2132483333335,resourceBytes:0,draped:{bytesPerFeature:2910.096178654882,bytesPerFeatureLabel:3554.8655816666665}},FILL_OUTLINE:{bytesPerFeature:5018.088812445781,bytesPerFeatureLabel:3524.8219616666665,resourceBytes:0,draped:{bytesPerFeature:4278.49006198517,bytesPerFeatureLabel:3532.068368333334}},EXTRUDE:{bytesPerFeature:7963.8889768932695,bytesPerFeatureLabel:3628.5106350000005,resourceBytes:0,draped:{bytesPerFeature:7963.8889768932695,bytesPerFeatureLabel:3628.5106350000005}},EXTRUDE_EDGES:{bytesPerFeature:3111.7648563053044,bytesPerFeatureLabel:2658.4350683333337,resourceBytes:0,draped:{bytesPerFeature:3111.7648563053044,bytesPerFeatureLabel:2658.4350683333337}}};var Tr,Ir;!function(e){e[e.RecreateSymbol=0]="RecreateSymbol",e[e.RecreateGraphics=1]="RecreateGraphics",e[e.FastUpdate=2]="FastUpdate"}(Tr||(Tr={}));class Rr{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=Ir.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return this._loadStatus===Ir.LOADED?(e&&e(),this._loader??Promise.resolve()):this._loadStatus===Ir.FAILED?(t&&t(this._loadError),this._loader??Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=Ir.LOADED}),(e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=Ir.FAILED,!tt(e)&&this.logger&&e.message&&this.logger.warn(e.message),e}))),this._loader.then(e,t).catch((()=>{})),this._loader)}abortLoad(){null!=this._abortController?this._abortController=Tt(this._abortController):this._loadStatus===Ir.LOADING&&(this._loadStatus=Ir.FAILED),this._loader=null}}!function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.FAILED=2]="FAILED"}(Ir||(Ir={}));const Gr=()=>p.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class zr extends Rr{constructor(e,t,r,s){super(r.schedule),this.symbol=e,this.symbolLayer=t,this._context=r,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1},this._materials=[],this.usedMemory=0,this.logger=Gr(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new w,this.complexity=this.computeComplexity(),this.ignoreDrivers=s.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=Ur(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,r=Ur(e);return r.color!==t.color||r.opacity!==t.opacity||r.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||r.size!==t.size||r.rotation!==t.rotation}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,r,s){const i=e.projectionSuccess,a="polygons"in e?e.polygons:null,n=`${s} geometry failed to be created`;i?!this._logGeometryValidationWarnings(t,r,s)&&a&&0===a.length&&"rings"===r&&t.length>0&&t[0].length>2&&Gr().warnOncePerTick(`${n} (filled rings should use clockwise winding - try reversing the order of vertices)`):Gr().warnOncePerTick(`${n} (failed to project geometry to view spatial reference)`)}_logGeometryValidationWarnings(e,t,r){const s=`${r} geometry failed to be created`;return!e.length||1===e.length&&!e[0].length?(Gr().warnOncePerTick(`${s} (no ${t} were defined)`),!0):!(Array.isArray(e)&&Array.isArray(e[0])||(Gr().warnOncePerTick(`${s} (${t} should be defined as a 2D array)`),0))}_validateGeometry(e,t=null,r=null){if(null!=t&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${e.type}`),!1;switch(e.type){case"point":{const t=e;if(!isFinite(t.x)||!isFinite(t.y))return Gr().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":oe(e)&&Gr().warnOncePerTick("Fixed a non-closed polygon ring.")}return!0}_defaultElevationInfoNoZ(){return Br}_defaultElevationInfoZ(){return Mr}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t=new w){const r=e.geometry,s=this.getDefaultElevationInfo(r);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:s.unit,t.mode=this.getGeometryElevationMode(r,s),t.offsetMeters=this._elevationContext.meterUnitOffset??s.offset??0;const i=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;i&&(t.mode="relative-to-ground",t.offsetMeters=0);const a=i?j:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(a,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}updateTransform(e,t,r,s){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=Nr){const r=this.draped?1:this._getLayerOpacity();return this._drivenProperties.opacity?r:e?r*e.a:t.hasIntrinsicColor?r:0}_getCombinedOpacityAndColor(e,t=Nr){const r=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return he(null,r);const s=null!=e?g.toUnitRGB(e):u;return he(s,r)}_getVertexOpacityAndColor(e,t=null){const r=this._drivenProperties.color?e.color:null,s=this._drivenProperties.opacity?e.opacity:null,i=he(r,s);return t&&(i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t),i}isFastUpdatesEnabled(){return null!=this._fastUpdates}computeComplexity(){return Ar(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,r){switch(e){case"opacity":return this.layerOpacityChanged(t,r),!0;case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,r,e)!==F.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,r){let s=F.UPDATE;return e.forEach((e=>{const i=t(e);if(null!=i){const t=e.graphic;this.setGraphicElevationContext(t,i.elevationContext),i.needsElevationUpdates=r(i.elevationContext.mode)}else s=F.RECREATE})),s}applyRendererDiff(e,t){return Tr.RecreateSymbol}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,r=t.size?q(t.size.field,e):0,s=t.color?q(t.color.field,e):0,i=t.opacity?q(t.opacity.field,e):0;return v(r,s,i,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&Gr().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null})}}}function Ur(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let r=0;r<e.stops.length;r++){const s=e.stops[r].color;s&&(t.opacity=!0,s.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0;break;case"rotation":t.rotation=!0}})),t}const Br={mode:"on-the-ground",offset:0,unit:"meters"},Mr={mode:"absolute-height",offset:0,unit:"meters"},Nr={hasIntrinsicColor:!1};function Vr(e,t,r,s,i){if(kr(e,t))return null;r.localOrigin=Wr(e,t);const a=new Ae({geometries:[r],castShadow:!1,layerUid:e.layer.uid,graphicUid:i,usesVerticalDistanceToGround:!0});return{object:a,sampledElevation:T(a,t,e.elevationProvider,e.renderCoordsHelper,s)}}function qr(e,t,r,s){return kr(t,r)?null:T(e,r,t.elevationProvider,t.renderCoordsHelper,s)}function kr(e,t){const r=e.clippingExtent;return!!r&&(pe(t,Zr,e.elevationProvider.spatialReference),!_e(r,Zr))}function Hr(e,t,r){const s=e.elevationContext,i=r.spatialReference;pe(t,Zr,i),s.centerPointInElevationSR=Ce(Zr[0],Zr[1],t.hasZ?Zr[2]:0,null!=i?i:null)}function $r(e){switch(e.type){case"point":return e;case"polygon":case"extent":return de(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const r=le(t,ce(t)/2);return Ce(r[0],r[1],r[2],e.spatialReference)}case"mesh":return e.extent.center}return null}function Wr(e,t){return pe(t,Zr,e.renderCoordsHelper.spatialReference),e.localOriginFactory.getOrigin(Zr)}const Zr=c();function Qr(e){e.include(k),e.uniforms.add(new H("geometryDepthTexture",((e,t)=>t.geometryDepth?.attachment))),e.code.add(qe`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)}const Jr=e(),Yr=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new $,{vertex:r,fragment:s}=t,{terrainDepthTest:i}=e;return r.include(Me),t.include(Ne,e),t.include(W,e),t.attributes.add(ne.UV0,"vec2"),r.uniforms.add(new Z("viewport",((e,t)=>t.camera.fullViewport)),new Fe("lineSize",((e,t)=>e.size>0?Math.max(1,e.size)*t.camera.pixelRatio:0)),new Q("pixelToNDC",((e,t)=>Ue(Jr,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]))),new Fe("borderSize",((e,t)=>e.borderColor?t.camera.pixelRatio:0)),new Q("screenOffset",((e,t)=>Ue(Jr,e.horizontalScreenOffset*t.camera.pixelRatio,0)))),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),i&&t.varyings.add("depth","float"),e.occlusionTestEnabled&&t.include(Ve),e.hasScreenSizePerspective&&He(r),r.main.add(qe`
    ProjectHUDAux projectAux;
    vec4 endPoint = projectPositionHUD(projectAux);

    vec3 vpos = projectAux.posModel;
    if (rejectBySlice(vpos)) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
    ${ke(e.occlusionTestEnabled,qe`if (!testHUDVisibility(endPoint)) {
             gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
             return;
           }`)}

    ${e.hasScreenSizePerspective?qe`vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
               vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);`:"vec2 screenOffsetScaled = screenOffset;"}
    // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
    // correct depth value
    vec3 posView = (view * vec4(position, 1.0)).xyz;
    ${ke(i,"depth = posView.z;")}

    applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);
    vec4 startPoint = proj * vec4(posView, 1.0);

    // Apply screen offset to both start and end point
    vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
    startPoint.xy += screenOffsetNorm * startPoint.w;
    endPoint.xy += screenOffsetNorm * endPoint.w;

    // Align start and end to pixel origin
    vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
    vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${ke(e.hudDepth,e.hudDepthAlignStart?"endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);":"startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);")}
    vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);

    // The direction of the line in screen space
    vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
    vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.hasScreenSizePerspective?qe`float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
               float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);`:qe`float lineSizeScaled = lineSize;
               float borderSizeScaled = borderSize;`}
    float halfPixelSize = lineSizeScaled * 0.5;

    // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
    float padding = 1.0 + borderSizeScaled;
    vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

    // Offset x/y from the center of the line in screen space
    projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

    // Compute a coverage varying which we can use in the fragment shader to determine
    // how much a pixel is actually covered by the line (i.e. to anti alias the line).
    // This works by computing two coordinates that can be linearly interpolated and then
    // subtracted to find out how far away from the line edge we are.
    float edgeDirection = (uv0.x * 2.0 - 1.0);

    float halfBorderSize = 0.5 * borderSizeScaled;
    float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
    float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

    float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

    coverageSampling = vec4(
      // Edge coordinate
      outerEdgeCoverageSampler,

      // Border edge coordinate
      outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

      // Line offset
      halfPixelSize - 0.5,

      // Border offset
      halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
    );

    lineSizes = vec2(lineSizeScaled, borderSizeScaled);
    gl_Position = projectedPosition;`),s.uniforms.add(new Z("uColor",(e=>e.color??S)),new Z("borderColor",(e=>e.borderColor??S))),i&&(s.include(Qr,e),s.uniforms.add(new Q("inverseViewport",((e,t)=>t.inverseViewport)))),s.main.add(qe`
    ${ke(i,"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }")}

    vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

    float borderAlpha = uColor.a * borderColor.a * coverage.y;
    float colorAlpha = uColor.a * coverage.x;

    float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);
    ${ke(!e.hudDepth,qe`vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
           fragColor = vec4(finalRgb, finalAlpha);`)}`),t}},Symbol.toStringTag,{value:"Module"}));class Xr extends J{constructor(e,t,r){super(e,t,new Y(Yr,(()=>Promise.resolve().then((()=>Yr)))),r)}initializePipeline(e){const t={func:e.terrainDepthTest?$e.ALWAYS:$e.LESS};return Ze(e.hudDepth?{depthTest:t,depthWrite:Qe}:{blending:Je(We.ONE,We.SRC_ALPHA,We.ONE_MINUS_SRC_ALPHA,We.ONE_MINUS_SRC_ALPHA),depthTest:t,colorWrite:Ye})}}class Kr extends X{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.hasSlicePlane=!1,this.terrainDepthTest=!1,this.hasSliceInVertexProgram=!0,this.draped=!1}}Xe([Ke()],Kr.prototype,"screenCenterOffsetUnitsEnabled",void 0),Xe([Ke()],Kr.prototype,"occlusionTestEnabled",void 0),Xe([Ke()],Kr.prototype,"hasVerticalOffset",void 0),Xe([Ke()],Kr.prototype,"hasScreenSizePerspective",void 0),Xe([Ke()],Kr.prototype,"hudDepth",void 0),Xe([Ke()],Kr.prototype,"hudDepthAlignStart",void 0),Xe([Ke()],Kr.prototype,"hasSlicePlane",void 0),Xe([Ke()],Kr.prototype,"terrainDepthTest",void 0);class es extends re{constructor(e,t){super(e,ss),this.produces=new Map([[K.LINE_CALLOUTS,e=>e===Te.Color],[K.LINE_CALLOUTS_HUD_DEPTH,e=>e===Te.Color]]),this._configuration=new Kr(t),this._uniqueMaterialIdentifier=ts(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){const r=t.slot===K.LINE_CALLOUTS_HUD_DEPTH;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.hudDepth=r,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=Ie||(this.parameters.borderColor?.[3]??0)>=Ie}intersect(){}createGLMaterial(e){return new rs(e)}createBufferWriter(){return new ns}validateParameters(e){this._uniqueMaterialIdentifier=ts(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}}function ts({renderOccluded:e,isDecoration:t,horizontalScreenOffset:r,color:s,size:i,occlusionTest:a,shaderPolygonOffset:n,hudDepthAlignStart:o,centerOffsetUnits:l,hasSlicePlane:c,screenSizePerspective:u,verticalOffset:h,borderColor:d}){return m`${e}:${t}:${r}:[${s}]:${i}:${a}:${n}:${o}:${l}:${c}:${null!=u}:{${h.screenLength}:${h.minWorldLength}:${h.maxWorldLength}}:[${d}]`}class rs extends ee{beginSlot(e){return this.acquireTechnique(Xr,e)}}class ss extends se{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=v(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const is=je().vec3f(ne.POSITION).vec3f(ne.NORMAL).vec2f(ne.UV0).vec4f(ne.CENTEROFFSETANDDISTANCE),as=[we(0,0),we(1,0),we(0,1),we(1,0),we(1,1),we(0,1)];class ns{constructor(){this.vertexBufferLayout=is}elementCount(e){return 6*e.get(ne.POSITION).indices.length}write(e,t,r,s,i,a){Re(r.get(ne.POSITION),e,i.position,a,6),Ge(r.get(ne.NORMAL),t,i.normal,a,6),ze(r.get(ne.CENTEROFFSETANDDISTANCE),i.centerOffsetAndDistance,a,6);for(let e=0;e<as.length;++e)i.uv0.setVec(a+e,as[e])}}class os extends zr{constructor(e,t){super(e,null,t,us),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new es(this._materialParameters,this._context.spherical),this._context.stage.add(this._materials[0])}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new ss,t=this.symbol,r=t.callout;if(r.color){const t=g.toUnitRGBA(r.color);t[3]*=this._getLayerOpacity(),e.color=t}else e.color=S;if(e.size=b(r.size||0),t.verticalOffset){const{screenLength:r,minWorldLength:s,maxWorldLength:i}=t.verticalOffset;e.verticalOffset={screenLength:b(r),minWorldLength:s||0,maxWorldLength:null!=i?i:1/0}}e.borderColor=null!=r.border?.color?g.toUnitRGBA(r.border.color):null;const s="object"===t.symbolLayers.at(0).type,i="label-3d"===t.type;return e.occlusionTest=!s,e.shaderPolygonOffset=s?0:void 0,e.hudDepthAlignStart=i,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return cs}createGraphics3DGraphic(e){const t=e.renderingInfo,r=e.graphic,s=this.setGraphicElevationContext(r,new w,t.elevationOffset||0),i=t.symbol,a="on-the-ground"===this._elevationContext.mode&&("cim"===i.type||!i.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==i.type&&a)return null;if("point-3d"===i.type&&i.symbolLayers.every((e=>"text"===e.type&&!y(e))))return null;const n=de(r.geometry);return null==n?null:this._createAs3DShape(n,s,t,r.uid)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,r){const s=this._elevationContext.mode,i=I(os.elevationModeChangeTypes,r,s);return i!==F.UPDATE||e.forEach((e=>{const r=t(e);null!=r&&this.updateGraphicElevationContext(e.graphic,r)})),i}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,t,r=0){return super.setGraphicElevationContext(e,t),t.addOffsetRenderUnits(r),t}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,null!=t.metadata?t.metadata.elevationOffset:0),t.needsElevationUpdates=R(t.elevationContext.mode)}computeComplexity(){return new br({verticesPerFeature:6})}_getOrCreateMaterial(e){const t=this._perInstanceMaterialParameters(e),r=ts(t);if(r===this._materials[0]?.uniqueMaterialIdentifier)return{material:this._materials[0],isUnique:!1};if(null!=e.materialCollection){let s=e.materialCollection.get(r);return null==s&&(s=new es(t,this._context.spherical),e.materialCollection.add(r,s)),{material:s,isUnique:!1}}return{material:new es(t,this._context.spherical),isUnique:!0}}_createAs3DShape(e,t,r,s){const i=this._context.layer.uid,a=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:i}),n=this._getOrCreateMaterial(r),o=new te(n.material,function(e){const{translation:t,centerOffset:r}=e,s=new De(t?[t[0],t[1],t[2]]:[0,0,0],ls,3,!0),i=new De(r?[r[0],r[1],r[2],r[3]]:[0,0,0,1],ls,4,!0);return[[ne.POSITION,s],[ne.NORMAL,new De([0,0,1],ls,3,!0)],[ne.CENTEROFFSETANDDISTANCE,i]]}(r),null,ie.Point,a),l=Vr(this._context,e,o,t,s);if(null==l)return null;const c=new ar(this,l.object,[o],n.isUnique?[n.material]:null,null,Ht,t);return c.metadata=new hr(r.elevationOffset),c.alignedSampledElevation=l.sampledElevation,c.needsElevationUpdates=R(t.mode),Hr(c,e,this._context.elevationProvider),c}}os.elevationModeChangeTypes={definedChanged:F.UPDATE,staysOnTheGround:F.UPDATE,onTheGroundChanged:F.RECREATE};const ls=[0],cs={mode:"relative-to-ground",offset:0},us={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class hs{constructor(e,t,r=c(),s=_(),i=0,a="world",n=0,o=null){this.renderer=e,this.symbol=t,this.translation=r,this.centerOffset=s,this.horizontalScreenOffset=i,this.centerOffsetUnits=a,this.elevationOffset=n,this.materialCollection=o}}class ds extends sr{}const ps=()=>p.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function ms(e,t){if(!f(e))return ps().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const r=ys[e.callout.type];return r?new r(e,t):(ps().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const ys={line:os},fs=new ot(Array,(e=>Pe(e,Le)),null,10,5),gs=ut();class bs{get labelLayers(){return this._labelLayers||B}get extent(){return this._extent}get isElevationSource(){return this.layers.some((e=>e?.isElevationSource))}constructor(e,t,r,s,i){this.graphic=e,this.graphics3DSymbol=t,this.layers=r,this._visibleFlags=Nt.ALL_LABEL,this.deconflictionPriority=0,++t.referenced,this._featureExpressionFeature=i?G(i,e,s):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic((t=>{t.initialize(e),t.setVisibility(this.isVisible())}))}destroy(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic((e=>e.destroy())),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(Vt.LABEL))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(e=Vt.GRAPHIC,t){const r=t?this._visibleFlags|t|Vt.LABEL*t:this._visibleFlags;return e===Vt.GRAPHIC?(r&Nt.ALL_GRAPHIC)===Nt.ALL_GRAPHIC:(r&Nt.ALL_LABEL)===Nt.ALL_LABEL}setVisibilityFlag(e,t,r){const s=this.isVisible(e);r?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const i=this.isVisible(e);if(s===i)return!1;if(e===Vt.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(i)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(i)));const e=this.isVisible(Vt.LABEL);this._forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}getVisibilityFlag(e,t){return!!(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(null==t)return!1;this._extent=ut(),mt(t,this._extent);const r=t.spatialReference;if(!pt(r,e)&&!ct(this._extent,r,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,r){let s=e.geometry;return"mesh"!==s.type&&"extent"!==s.type||(s=lt.fromExtent("mesh"===s.type?s.extent:s)),yt(s,t,r)}get usedMemory(){let e=M(this.graphic.attributes);return this._forEachSymbolLayerGraphic((t=>e+=t.graphics3DSymbolLayer.usedMemory)),e}computeAttachmentOrigin(){const t={render:{origin:c(),num:0},draped:{origin:e(),num:0}};for(const e of this.layers)null!=e&&e.computeAttachmentOrigin(t);return t.render.num>1&&i(t.render.origin,t.render.origin,1/t.render.num),t.draped.num>1&&Be(t.draped.origin,t.draped.origin,1/t.draped.num),t}async getProjectedBoundingBox(e,t,r,s,i){return i||(i={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),i.boundingBox?be(i.boundingBox):i.boundingBox=be(),i.requiresDrapedElevation=!1,await et(this.layers,(async a=>{if(null==a)return;const n="draped"===a.type?t:e,o=fs.acquire(),l=await a.getProjectedBoundingBox(n,r,i.screenSpaceObjects,s,o);isFinite(l[2])&&isFinite(l[5])||(i.requiresDrapedElevation=!0),l&&Ee(i.boundingBox,o),fs.release(o)})),Oe(i.boundingBox)||ht(xe(i.boundingBox,gs))?i:null}needsElevationUpdates(){for(const e of this.layers)if(null!=e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some((e=>e?.needsElevationUpdates??!1))??!1}alignWithElevation(e,t,r){this._forEachRenderedGraphic((s=>{"object3d"!==s.type&&"lod-instance"!==s.type||s.alignWithElevation(e,t,this._featureExpressionFeature,r)}))}alignWithAbsoluteElevation(e,t,r){this._forEachRenderedGraphic((s=>{"object3d"===s.type&&s.alignWithAbsoluteElevation(e,t,r)}))}addObjectStateSet(e){this._forEachSymbolLayerGraphic((t=>t.addObjectState(e)))}removeObjectState(e){this._forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}_forEachGraphicList(e,t){e?.forEach((e=>e&&t(e)))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}}class vs{constructor(e,t){this.scheduler=e,this.schedule=t,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===vt.Global}get doublePrecisionRequiresObfuscation(){return this.stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result}}class Ss extends Rr{set symbol(e){this._symbol=e,e.symbolLayers.forEach(((t,r)=>{const s=this.symbolLayers[r];null!=s&&(s.symbol=e,s.symbolLayer=t)}))}get symbol(){return this._symbol}constructor(e,t,r){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const r=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const s=[],{make:i}=await import("./Graphics3DSymbolLayerFactory.js");for(let a=0;a<r;a++){const n=t.at(a);if(!1===n.enabled)continue;_s.renderPriority=1-(1+a)/r,_s.renderPriorityStep=1/r,_s.ignoreDrivers=n.ignoreDrivers;const o=i(this.symbol,n,this._context,_s),l=rt(e,(()=>{this.symbolLayers[a]=null,o.destroy()}));l&&s.push(l),this.symbolLayers[a]=o}if(await et(this.symbolLayers,(async(e,t)=>{if(null!=e)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}})),s.forEach((e=>e.remove())),st(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return null!=t?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((e=>e?.queryForSnapping))}createGraphics3DGraphic(e,t){const r=e.graphic,s=this.symbolLayers.map((t=>t?.createGraphics3DGraphic(e)??null)),i=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new bs(r,t||this,s,e.layer,i)}get complexity(){return Or(this.symbolLayers.map((e=>null!=e?e.complexity:null)))}globalPropertyChanged(e,t){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const r=this.symbolLayers[s],i=e=>{const t=e.layers[s];return t instanceof ar?t:null};if(null!=r&&!r.globalPropertyChanged(e,t,i))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==Ir.LOADED?Tr.RecreateSymbol:this.symbolLayers.reduce(((r,s)=>r!==Tr.RecreateSymbol&&null!=s?Math.min(r,s.applyRendererDiff(e,t)):r),Tr.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===Ir.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const r=t.symbolLayers.diff;this.symbolLayers.forEach(((t,s)=>{if(null==t)return;const i=r[s];if(i){const r={diff:i,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(r),e.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const i=e.layers[s];null!=i&&r.graphics3DGraphicPatches.forEach((e=>e(i,t)))}))}}))}updateGeometry(e,t){return this._updateGeometryOrTransform(e,((e,r)=>e.updateGeometry(r,t)))}updateTransform(e,t,r,s){return this._updateGeometryOrTransform(e,((e,i)=>e.updateTransform(i,t,r,s)))}_updateGeometryOrTransform(e,t){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(null==s)continue;const i=e.layers[r];if(!i||!t(s,i))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const r=this.symbolLayers[t];if(null==r)continue;const s=e.layers[t];null!=s&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=0,t=0,r=0;return this.symbolLayers.forEach((s=>{null!=s&&(s.loadStatus===Ir.LOADING?e++:s.isFastUpdatesEnabled()?r++:t++)})),{loading:e,slow:t,fast:r}}async queryForSnapping(e,t,r,s){const i=this.symbolLayers.filter(N).filter((e=>null!=e.queryForSnapping)).map((i=>i.queryForSnapping(e,t,r,s))),a=await Promise.all(i);return st(s),a.flat()}destroy(){if(!this.destroyed){super.destroy();for(const e of this.symbolLayers)null!=e&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const _s=new class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};class Ps extends Rr{constructor(e,t,r){super(t),this.symbol=e,this._convert=r,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),null!=this.graphics3DSymbol&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:Lr}globalPropertyChanged(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(e,t):Tr.RecreateSymbol}prepareSymbolPatch(e){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(e,t)}updateTransform(e,t,r,s){return this.graphics3DSymbol?.updateTransform(e,t,r,s)??!1}onRemoveGraphic(){}getFastUpdateStatus(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}}const Ls=1.2,Es=S,Os=4;function xs(e,t,r){if(null==e||null==r)return!1;let s=!0;return As[0]=null!=e.xmin?e.xmin:0,As[1]=null!=e.ymin?e.ymin:0,As[2]=null!=e.zmin?e.zmin:0,s=s&&O(As,e.spatialReference,0,t,r,0),As[0]=null!=e.xmax?e.xmax:0,As[1]=null!=e.ymax?e.ymax:0,As[2]=null!=e.zmax?e.zmax:0,s=s&&O(As,e.spatialReference,0,t,r,3),null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.zmin&&(t[2]=-1/0),null==e.xmax&&(t[3]=1/0),null==e.ymax&&(t[4]=1/0),null==e.zmax&&(t[5]=1/0),s}function Cs(e,t,r){if(null==e||null==r)return!1;let s=!0;return As[0]=null!=e.xmin?e.xmin:0,As[1]=null!=e.ymin?e.ymin:0,As[2]=null!=e.zmin?e.zmin:0,s=s&&O(As,e.spatialReference,0,As,r,0),t[0]=As[0],t[1]=As[1],As[0]=null!=e.xmax?e.xmax:0,As[1]=null!=e.ymax?e.ymax:0,As[2]=null!=e.zmax?e.zmax:0,s=s&&O(As,e.spatialReference,0,As,r,0),t[2]=As[0],t[3]=As[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),s}const As=c();class Ds{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,r){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}async queryElevation(e,t,r,s,i){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,i,r,s)}}class ws{constructor(e,t,r,s){this.spatialReference=t,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(It.ELEVATION_QUERY,this)}destroy({completeTasks:e}={completeTasks:!1}){if(this._frameTask.remove(),this.running)if(e)this.runTask(Rt);else for(const e of this._queries)e.result.reject(it())}queryElevation(e,t,r,s=0){const i=at(),a={x:e,y:t,minDemResolution:s,result:i,signal:r};return this._queries.push(a),nt(r,(()=>{V(this._queries,a),i.reject(it())})),i.promise}get running(){return this._queries.length>0}runTask(e){const t=this._queries;this._queries=[];const r=this._getElevationQueryProvider();if(!r)return t.forEach((e=>e.result.reject())),void e.madeProgress();const s=t.map((e=>[e.x,e.y])),i=t.reduce(((e,t)=>Math.min(e,t.minDemResolution)),1/0),a=new Gt({points:s,spatialReference:this.spatialReference}),n=t.length>1&&t.some((e=>!!e.signal))?new AbortController:null,o=null!=n?n.signal:t[0].signal;if(null!=n){let e=0;t.forEach((r=>nt(r.signal,(()=>{e++,r.result.reject(it()),e===t.length&&n.abort()}))))}const l={...this._queryOptions,minDemResolution:i,signal:o};r.queryElevation(a,l).then((e=>{t.forEach(((t,r)=>{null!=t.signal&&t.signal.aborted?t.result.reject(it()):t.result.resolve(e.geometry.points[r][2])}))})).catch((e=>{t.forEach((t=>t.result.reject(e)))})),e.madeProgress()}get test(){}}class js{constructor(e="scene"){this.context=e,this.extent=dt()}}export{Tr as A,jr as B,Dr as C,Wt as D,js as E,mr as F,zr as G,dr as H,pr as I,kt as J,hr as K,hs as L,Ut as M,Os as N,ir as O,ds as P,ws as Q,br as S,Vt as V,ar as a,Ss as b,xr as c,Er as d,vs as e,zt as f,Nt as g,Ds as h,qt as i,Ir as j,sr as k,Ps as l,ms as m,Es as n,$r as o,xs as p,Wr as q,Hr as r,Ls as s,Cs as t,qr as u,Vr as v,Ht as w,Zt as x,yr as y,fr as z};
