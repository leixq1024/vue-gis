/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{d as e}from"./maybe.js";import{watch as o,syncAndInitial as s}from"../core/reactiveUtils.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import{subclass as i}from"../core/accessorSupport/decorators/subclass.js";import{e as p}from"./earcut.js";import{c as m}from"./mat4f64.js";import{n as a}from"./vec3.js";import{Z as n,c as l}from"./vec3f64.js";import{c}from"./computeTranslationToOriginAndRotation.js";import{h as j}from"./aaBoundingBox.js";import{n as u}from"./Indices.js";import{b as d}from"./vec32.js";import{V as y}from"./ViewingMode.js";import{L as f}from"./LayerView3D.js";import{E as h}from"./ElevationContext.js";import{g,e as b}from"./Graphics3DExtrudeSymbolLayer.js";import{c as S}from"./graphicUtils.js";import"../core/lang.js";import"./Logger.js";import{C as v}from"./SceneLighting.js";import w from"../views/3d/webgl/RenderNode.js";import{S as _,h as C,P as A,k as U,l as P}from"./StencilUtils.js";import{S as E}from"./ScreenSpacePass.glsl.js";import{N as x,g as D}from"./interfaces3.js";import{m as T,d as M}from"./renderState.js";import{x as I}from"./mat4.js";import{a as L}from"./Matrix4PassUniform.js";import{V as R}from"./VertexAttribute.js";import{f as N,j as F,F as O,g as V,k as B,U as G}from"./enums.js";import{D as k}from"./Material.js";import{P as q}from"./RenderGeometry.js";import{V as H}from"./VertexArrayObject2.js";import{B as W}from"./BufferObject.js";import z from"../views/layers/LayerView.js";import"./asyncUtils.js";import"../core/Accessor.js";import"../core/Handles.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./ObservableBase.js";import"./tracking.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../core/Error.js";import"../config.js";import"../core/Collection.js";import"../core/Evented.js";import"./ensureType.js";import"./shared.js";import"./SimpleObservable.js";import"./common.js";import"./mathUtils.js";import"./projectBuffer.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"./geodesicConstants.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./aaBoundingRect.js";import"./heightModelInfoUtils.js";import"../geometry/HeightModelInfo.js";import"./arcgisLayerUrl.js";import"./persistableUrlUtils.js";import"./dehydratedFeatureUtils.js";import"./ElevationProvider.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./hydratedFeatures.js";import"../geometry.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./datetime.js";import"./number.js";import"./substitute.js";import"./messages.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"./colorUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./dehydratedPoint.js";import"./mat3.js";import"./mat3f64.js";import"./SnappingCandidate.js";import"./renderingInfoUtils.js";import"./visualVariableUtils.js";import"./compilerUtils.js";import"./sizeVariableUtils.js";import"./ElevationUpdateEvent.js";import"./vec2f64.js";import"./plane.js";import"./quatf64.js";import"./vec4f64.js";import"./mathUtils2.js";import"./debugFlags2.js";import"./triangle.js";import"./ray.js";import"./lineSegment.js";import"./basicInterfaces.js";import"./projectPointToVector.js";import"../geometry/projection.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./RibbonLineMaterial.js";import"./sphere.js";import"./vec4.js";import"./Util.js";import"./sdfPrimitives.js";import"./doublePrecisionUtils.js";import"./floatRGBA.js";import"./Octree.js";import"./frustum.js";import"./vec2.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./types.js";import"./AlphaCutoff.js";import"./ShaderTechniqueConfiguration.js";import"./RgbaFloatEncoding.glsl.js";import"./Texture.js";import"./GLObjectType.js";import"./Attribute.js";import"./vec2f32.js";import"./RayIntersections.js";import"./HUDVisibility.glsl.js";import"./VerticalOffset.glsl.js";import"./HUDRenderStyle.js";import"./projectBoundingRect.js";import"./dehydratedFeatures.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"./edgeUtils.js";import"./DecodeSymbolColor.glsl.js";import"./Float4DrawUniform.js";import"./BindType.js";import"./NormalAttribute.glsl.js";import"./Matrix3DrawUniform.js";import"./GeometryUtil.js";import"./vec3f32.js";import"./LodResources.js";import"./DefaultMaterial.js";import"./GLTextureMaterial.js";import"./verticalOffsetUtils.js";import"./orientedBoundingBox.js";import"./quat.js";import"./spatialReferenceEllipsoidUtils.js";import"./VertexColor.glsl.js";import"./VertexPosition.glsl.js";import"./Matrix4sPassUniform.js";import"../views/3d/webgl.js";import"./CameraSpace.glsl.js";import"./Scheduler.js";import"../core/signal.js";import"./debugFlags.js";import"./triangulationUtils.js";import"./deduplicate.js";import"./Normals.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../geometry/support/MeshLocalVertexSpace.js";import"./requestImageUtils.js";import"./boundedPlane.js";import"./GridLocalOriginFactory.js";import"../views/3d/webgl/RenderCamera.js";import"./axisAngleDegrees.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./MergedRenderer.js";import"./NestedMap.js";import"./glUtil.js";import"./VertexElementDescriptor.js";import"./HighlightDefaults.js";import"./Intersector.js";import"./intersectorUtils.js";import"./Intersector3.js";import"./VertexArrayObject.js";import"./UpdatingHandles.js";import"./layerViewUtils.js";class K extends x{}const Q=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:K,build:function(){const t=new _;return t.include(E),t.outputs.add("fragColor","vec4",0),t.fragment.uniforms.add(new C("colorTexture",(t=>t.color)),new C("focusArea",(t=>t.focusArea)),new A("focusAreaEffectMode",(t=>t.effect??1))).main.add(D`float mask = texture( focusArea, uv, 0.0 ).r;
vec4 color = texture( colorTexture, uv, 0.0 );
vec4 colorDeSaturate = vec4(color.r * 0.25 + color.g * 0.5 + color.b * 0.25);
if (focusAreaEffectMode == 1) {
fragColor = mask > 0.0 ? color : 0.55 * colorDeSaturate + 0.45;
} else {
fragColor = mask > 0.0 ? color : 0.33 * mix(color, colorDeSaturate, 0.);
}`),t}},Symbol.toStringTag,{value:"Module"}));class J extends U{constructor(t,e,o){super(t,e,new P(Q,(()=>Promise.resolve().then((()=>Q)))),o)}initializePipeline(){return T({colorWrite:M})}}class Y extends x{constructor(){super(...arguments),this.origin=n}}const Z=m(),X=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskPassParameters:Y,build:function(){const t=new _;return t.attributes.add(R.POSITION,"vec3"),t.outputs.add("fragColor","vec4",0),t.vertex.uniforms.add(new L("proj",((t,e)=>e.camera.projectionMatrix)),new L("view",((t,e)=>I(Z,e.camera.viewMatrix,t.origin)))).main.add(D`gl_Position = proj * view * vec4(position, 1.0);`),t.fragment.main.add(D`fragColor = vec4(1., 0., 0., 1.);`),t}},Symbol.toStringTag,{value:"Module"}));class $ extends U{constructor(t,e,o){super(t,e,new P(X,(()=>Promise.resolve().then((()=>X)))),o)}initializePipeline(){return T({colorWrite:M,depthTest:{func:N.LEQUAL}})}}let tt=class extends w{constructor(t){super(t),this.consumes={required:["final-color"]},this.produces="final-color",this.focusAreaGeometries=new Array,this._vaos=Array(),this._count=new Array,this._origins=new Array,this._colorParameters=new K,this._maskParameters=new Y,t.techniques.precompile($),t.techniques.precompile(J)}initialize(){this.setExtrudedVolume()}destroy(){this._vaos.forEach((t=>t.dispose())),this._vaos=[],this._count=[],this._origins=[]}render(t){const e=this.techniques.acquire($),o=this.techniques.acquire(J),s=this.bindParameters,r=t.find((({name:t})=>"final-color"===t)),i=r?.getTexture(),p=s.camera,m=p.fullViewport[2],a=p.fullViewport[3],n=this.fboCache.acquire(m,a,"focusArea",v.RGBA),l=this.fboCache.acquire(m,a,this.produces);if(!e.compiled||!o.compiled||!this._vaos||this.effect===ot.NONE)return this.requestRender(),e.release(),o.release(),l.release(),n.release(),r;const c=this.renderingContext;n.attachDepth(r.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),c.bindFramebuffer(n.fbo),c.clear(F.COLOR|F.STENCIL),c.setViewport(0,0,m,a),c.gl.clearStencil(0),c.gl.clear(c.gl.STENCIL_BUFFER_BIT),c.setClearStencil(0);for(let t=0;t<this._vaos.length;t++){const o=this._vaos[t],r=this._count[t];o&&(this._maskParameters.origin=this._origins[t],c.bindTechnique(e,s,this._maskParameters),c.setFaceCullingEnabled(!1),c.setStencilTestEnabled(!0),c.setStencilWriteMask(255),c.setStencilFunction(N.ALWAYS,0,255),c.setStencilOpSeparate(O.FRONT,V.KEEP,V.INCR_WRAP,V.KEEP),c.setStencilOpSeparate(O.BACK,V.KEEP,V.DECR_WRAP,V.KEEP),c.setDepthWriteEnabled(!1),c.setColorMask(!1,!1,!1,!1),c.bindVAO(o),c.drawArrays(B.TRIANGLES,0,r),c.setFaceCullingEnabled(!1),c.setDepthTestEnabled(!1),c.setStencilFunction(N.NOTEQUAL,0,255),c.setStencilWriteMask(0),c.setColorMask(!0,!0,!0,!0),c.drawArrays(B.TRIANGLES,0,r))}return e.release(),c.gl.clear(c.gl.STENCIL_BUFFER_BIT),c.bindFramebuffer(l.fbo),this._colorParameters.color=i,this._colorParameters.focusArea=n.getTexture(),this._colorParameters.effect=this.effect,c.bindTechnique(o,s,this._colorParameters),c.screen.draw(),n.release(),o.release(),l.attachDepth(r.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),l}setExtrudedVolume(){const t=this.focusAreaGeometries;this._vaos=[],this._count=[],this._origins=[];for(let e=0;e<t.length;e++){const o=t[e],s=new Array,r=o.indicesBottom;this._origins.push(o.origin);for(let t=0;t<r.length;t++)s.push(o.positions[3*(r[t]-1)]),s.push(o.positions[3*(r[t]-1)+1]),s.push(o.positions[3*(r[t]-1)+2]);const i=o.indicesExtruded;for(let t=0;t<i.length;t++)s.push(o.positions[3*i[t]]),s.push(o.positions[3*i[t]+1]),s.push(o.positions[3*i[t]+2]);const p=new Float32Array(s),m=new H(this.renderingContext,k,new Map([["geometry",q]]),new Map([["geometry",W.createVertex(this.renderingContext,G.STATIC_DRAW,p)]]));this._vaos?.push(m),this._count.push(r.length+i.length)}}};t([r()],tt.prototype,"consumes",void 0),t([r()],tt.prototype,"produces",void 0),t([r({constructOnly:!0})],tt.prototype,"techniques",void 0),t([r()],tt.prototype,"focusAreaGeometries",void 0),t([r()],tt.prototype,"effect",void 0),tt=t([i("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaRenderNode")],tt);class et{constructor(t,e,o,s,r){this.positions=t,this.indicesBottom=e,this.indicesExtruded=o,this.height=s,this.origin=r}}var ot;!function(t){t[t.NONE=0]="NONE",t[t.BRIGHT=1]="BRIGHT",t[t.DARK=2]="DARK"}(ot||(ot={}));const st={none:ot.NONE,bright:ot.BRIGHT,dark:ot.DARK};let rt=class extends(f(z)){constructor(){super(...arguments),this.type="focusArea-3d",this._elevationContext=new h,this._geometries=new Array}initialize(){this.addHandles([o((()=>this.layer.geometries),((t,e)=>{e=t,this._extrudePolygons(e),this._setFocusAreaRenderNode()}),s),o((()=>this.layer.tmpEffect),((t,e)=>{e=t,this._renderNode&&e&&(this._renderNode.effect=st[e])}),s),o((()=>this.layer.visible),((t,o)=>{t?this._renderNode??=new tt({view:this.view,techniques:this.view._stage.renderView.techniques,focusAreaGeometries:this._geometries,effect:st[this.layer.tmpEffect??"none"]}):this._renderNode=e(this._renderNode)}),s)])}destroy(){this._renderNode=e(this._renderNode),this._geometries=[]}_extrudePolygons(t){this._geometries=[];for(const e of t){const t=m(),o=l(),s=this.view.renderCoordsHelper.viewingMode===y.Global;s||this.view.renderCoordsHelper.worldUpAtPosition(null,o);const r=S(e);if(null==r)return;c(e.spatialReference,[r.x,r.y,0],t,this.view.renderCoordsHelper.spatialReference);const i=a(it,[t[12]-0*o[0],t[13]-0*o[1],t[14]-0*o[2]]),n=m();n[12]=-t[12],n[13]=-t[13],n[14]=-t[14];const f=g(e,this.view.elevationProvider,this.view.renderCoordsHelper,this._elevationContext),{polygons:h,mapPositions:v,position:w}=f;for(const e of h){const r=e.count,m=p(e.mapPositions,e.holeIndices,3);if(0===m.length)continue;const a=m.length,l=6*r,c=u(l+a),y=u(a),f=j(3*l),h=j(3*l),g=j(3*l),S=j(l);b(w,v,m,e,f,g,h,S,c,y,1e4,o,s),d(f,f,n);const _=new et(f,y,c,1e4,[t[12]+0*i[0],t[13]+0*i[1],t[14]+0*i[2]]);this._geometries.push(_)}}}_setFocusAreaRenderNode(){this._renderNode?(this._renderNode.focusAreaGeometries=this._geometries,this._renderNode.setExtrudedVolume()):this._renderNode=new tt({view:this.view,techniques:this.view._stage.renderView.techniques,focusAreaGeometries:this._geometries,effect:st[this.layer.tmpEffect??"none"]})}};t([r()],rt.prototype,"type",void 0),t([r()],rt.prototype,"layer",void 0),rt=t([i("esri.views.3d.layers.FocusAreaLayerView3D")],rt);const it=l(),pt=rt;export{pt as default};
