/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{u as t}from"./originUtils.js";import r from"../portal/Portal.js";import a from"../portal/PortalItem.js";import{c as o}from"./jsonContext.js";import{a as i,t as n}from"./portalItemUtils.js";import{e as s}from"./saveUtils.js";async function l(t){const{layer:r,errorNamePrefix:a,validateLayer:o}=t;await r.load(),function(t,r,a){const o=a(t);if(!o.isValid)throw new e(`${r}:invalid-parameters`,o.errorMessage,{layer:t})}(r,a,o)}function p(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function m(t){const{item:r,errorNamePrefix:a,layer:o,validateItem:i}=t;if(function(t){const{item:r,itemType:a,additionalItemType:o,errorNamePrefix:i,layer:n}=t,s=[a];if(o&&s.push(o),!s.includes(r.type)){const t=s.map((e=>`'${e}'`)).join(", ");throw new e(`${i}:portal-item-wrong-type`,`Portal item type should be one of: "${t}"`,{item:r,layer:n})}}(t),i){const t=i(r);if(!t.isValid)throw new e(`${a}:invalid-parameters`,t.errorMessage,{layer:o})}}function c(e){return o(e,"portal-item")}async function f(e,t,r){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const a=e.write({},t);return await Promise.all(t.resources?.pendingOperations??[]),s(t,{errorName:"layer-write:unsupported"},r),a}function u(e){i(e,n.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}async function d(r,a){const{layer:o,createItemData:i,createJSONContext:n,setItemProperties:s,saveResources:d,supplementalUnsupportedErrors:y}=r;await l(r),function(t){const{layer:r,errorNamePrefix:a}=t,{portalItem:o}=r;if(!o)throw new e(`${a}:portal-item-not-set`,p(r,"requires the portalItem property to be set"));if(!o.loaded)throw new e(`${a}:portal-item-not-loaded`,p(r,"cannot be saved to a portal item that does not exist or is inaccessible"));m({...t,item:o})}(r);const w=o.portalItem,I=n?n(w):c(w),v=await f(o,I,{...a,supplementalUnsupportedErrors:y}),P=await i({layer:o,layerJSON:v},w);return await(s?.(o,w,P)),u(w),await w.update({data:P}),t(I),await(d?.(w,I)),w}async function y(e,o){const{layer:i,createItemData:n,createJSONContext:s,setItemProperties:p,saveResources:d,supplementalUnsupportedErrors:y}=e;await l(e);const w=function(e){const{newItem:t,itemType:o}=e;let i=a.from(t);return i.id&&(i=i.clone(),i.id=null),i.type??=o,i.portal??=r.getDefault(),m({...e,item:i}),i}(e),I=s?s(w):c(w),v=await f(i,I,{...o,supplementalUnsupportedErrors:y}),P=await n({layer:i,layerJSON:v},w);return await p(i,w,P),u(w),await async function(e,t,r){const a=e.portal;await a.signIn(),await a.user.addItem({item:e,data:t,folder:r?.folder})}(w,P,o),i.portalItem=w,t(I),await(d?.(w,I)),w}export{y as a,d as s};
