/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{i as e}from"../core/lang.js";import n from"../layers/support/DimensionalDefinition.js";function t(e,n,a){const i=n.shift();if(0===a.length){const e=[];a.push({sliceId:-1,multidimensionalDefinition:e})}const s=a.length;for(let n=0;n<s;n++){const n=a.shift().multidimensionalDefinition;i.values?.forEach((t=>{a.push({sliceId:-1,multidimensionalDefinition:[...n,{variableName:e,dimensionName:i.name,values:[t]}]})}))}n.length&&t(e,n,a)}function a(e,n){const a=[];let i=0;return(n?e.variables.filter((e=>e.name.toLowerCase()===n.toLowerCase())):[...e.variables].sort(((e,n)=>e.name>n.name?1:-1))).forEach((e=>{const n=[],s=[...e.dimensions].sort(((e,n)=>e.name>n.name?-1:1));t(e.name,s,n),n.forEach((e=>{a.push({...e,sliceId:i++})}))})),a}function i(e,n,t){let a=e;if(n&&(n=[...n].sort(((e,n)=>e.dimensionName<n.dimensionName?-1:1))).forEach((({dimensionName:e,values:n,isSlice:t})=>{n.length&&(a=a.filter((a=>{const i=a.multidimensionalDefinition.find((n=>n.dimensionName===e));if(null==i)return!1;const s=i.values[0];return"number"==typeof s?"number"==typeof n[0]?n.includes(s):n.some((e=>e[0]<=s&&e[1]>=s)):"number"==typeof n[0]?n.some((e=>s[0]<=e&&s[1]>=e)):t?n.some((e=>e[0]===s[0]&&e[0]===s[1])):n.some((e=>e[0]>=s[0]&&e[0]<=s[1]||e[1]>=s[0]&&e[1]<=s[1]||e[0]<s[0]&&e[1]>s[1]))})))})),a.length&&null!=t?.start&&null!=t.end){const e=t.start.getTime(),n=t.end.getTime(),i=a[0].multidimensionalDefinition.findIndex((e=>"StdTime"===e.dimensionName));i>-1&&(a=a.filter((t=>{const a=t.multidimensionalDefinition[i].values[0];return e<=a&&n>=a})))}return a.map((e=>e.sliceId))}function s(e,n){return Array.isArray(e)?n[0]===n[1]?e[0]===n[0]||e[1]===n[0]:e[0]>=n[0]&&e[0]<=n[1]&&e[1]>=n[0]&&e[1]<=n[1]:e>=n[0]&&e<=n[1]}function r(e,n){return e[0]<=n[0]&&e[1]>=n[0]||e[0]<=n[1]&&e[1]>=n[1]||e[0]>=n[0]&&e[1]<=n[1]}function l(e){return 1===e.length?[e[0],e[0]]:[e[0],e[e.length-1]]}function o(e,n,t){if(!n?.subsetDefinitions?.length)return e;let a;if(t){const{variables:i}=n;if(i.length&&!i.includes(t))return null;const s=n.subsetDefinitions.find((n=>n.dimensionName===e.name&&n.variableName===t));if(!s?.values?.length)return e;a=l(s.values)}else{const t=n.dimensions.find((({name:n})=>n===e.name));a=t?.extent}const i=a;if(!i?.length)return e;const r=e.values.filter((e=>s(e,i)));return{...e,extent:[...i],values:r}}function u(e,n,t){if(!n?.subsetDefinitions?.length)return!1;const{variables:a}=n;if(a.length&&e.some((({variableName:e})=>e&&!a.includes(e))))return!0;for(let a=0;a<e.length;a++){const i=e[a],o=n.subsetDefinitions.find((e=>(""===i.variableName||e.variableName===i.variableName)&&e.dimensionName===i.dimensionName));if(o?.values.length){const e=l(o.values);if(i.isSlice||2!==i.values.length||Array.isArray(i.values[0])||i.values[0]===i.values[1]||!t){if(i.values.some((n=>!s(n,e))))return!0}else if(!r(i.values,e))return!0}}return!1}function m(e,t){if(null==e)return{isOutside:!1};const{geometry:a,timeExtent:i,multidimensionalDefinition:s}=t;let r=null;if(null!=i&&(r=function(e,t){const a=e.dimensions.find((({name:e})=>"StdTime"===e));if(null==a||null==t.start&&null==t.end)return t;t=t.clone();const{start:i,end:s}=t.toJSON(),r=i===s?[i]:null!=i&&null!=s?[i,s]:[i??s];return 2===r.length&&a?.extent.length&&(r[0]=Math.max(r[0],a.extent[0]),r[1]=Math.min(r[1],a.extent[1]??a.extent[0]),r[1]<r[0])||u([new n({variableName:"",dimensionName:"StdTime",isSlice:1===r.length,values:r})],e,!0)?null:(t.start=new Date(r[0]),t.end=new Date(r[1]??r[0]),t)}(e,i),null==r))return{isOutside:!0};const{areaOfInterest:l}=e;if(l&&a){const e="point"===a.type?a:"extent"===a.type?a.center:"polygon"===a.type?a.centroid:null;if(e&&!l.contains(e))return{isOutside:!0}}return null!=s&&s.length&&u(s,e,!0)?{isOutside:!0}:{isOutside:!1,intersection:{geometry:a,timeExtent:r,multidimensionalDefinition:s}}}function c(e,n={}){const{multidimensionalInfo:t,keyProperties:a}=e;if(null==t)return null;const{variableName:i,multidimensionalSubset:s,multidimensionalDefinition:r}=n,l=null!=r?r[0]?.variableName:null,o=i||l||a?.DefaultVariable;let{variables:u}=t;return s?.variables?.length&&(u=u.filter((({name:e})=>s.variables.includes(e)))),o?u.find((({name:e})=>e===o))??u[0]:u[0]}function f(e,t={}){const a=c(e,t);if(!a)return null;const i=[],{dimensions:s,name:r}=a;if(0===s.length)return[new n({variableName:r,dimensionName:"",values:[],isSlice:!0})];for(let e=0;e<s.length;e++){const a=o(s[e],t.multidimensionalSubset,r);if(!a)return null;const{values:l,extent:u}=a;let m=l?.[0]??u?.[0];"stdz"===a.name.toLowerCase()&&!a.hasRanges&&u&&Math.abs(u[1])<=Math.abs(u[0])&&(m=l?.length?l[l.length-1]:u[1]),i.push(new n({variableName:r,dimensionName:a.name,values:[m],isSlice:!t.useRangeForRangedDimensionInfo||!!a.hasRanges}))}return i}function d(e){return!!e?.length&&e.some((e=>{if(null==e.values)return!0;const n=e.values.length;return 0===n||n>1||!e.isSlice&&Array.isArray(e.values[0])}))}function h(n,t){if(null==t||null==n)return null;let a=t.variables.map((e=>({...e})));return n?.variables?.length&&(a=a.filter((({name:e})=>n.variables.includes(e))),a.forEach((t=>{t.dimensions=t.dimensions.map((e=>o(e,n,t.name))).filter(e)}))),a}function g(e,n){const{values:t}=n;if(t?.length){const n=Array.isArray(t[0]),a=Array.isArray(e);return n!==a?-1:n&&a?t.findIndex((n=>n[0]===e[0]&&n[1]===e[1])):t.indexOf(e)}const{extent:a}=n;if(Array.isArray(e)||!a||e<a[0]||e>a[1])return-1;const i=n.interval||1;if("ISO8601"!==n.unit)return Math.round((e-a[0])/i);const s=a[0];let r=-1;switch(n.intervalUnit?.toLowerCase()||"days"){case"seconds":r=Math.round((e-s)/1e3/i);break;case"minutes":r=Math.round((e-s)/6e4/i);break;case"hours":r=Math.round((e-s)/36e5/i);break;case"days":r=Math.round((e-s)/864e5/i);break;case"months":{const n=new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear(),t=new Date(s).getUTCMonth(),a=new Date(e).getUTCMonth();r=0===n?a-t:a+11-t+12*(n-1)}break;case"years":r=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/i);break;case"decades":r=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/10/i)}return r}function v(e){let n=e.values?.length;if(n)return n;const{extent:t,unit:a}=e,i=e.interval||1,s=t?t[1]-t[0]:0;if("ISO8601"!==a)return Math.round(s/i);switch(e.intervalUnit?.toLowerCase()??"seconds"){case"seconds":n=Math.round(s/1e3/i);break;case"minutes":n=Math.round(s/6e4/i);break;case"hours":n=Math.round(s/36e5/i);break;case"days":n=Math.round(s/864e5/i);break;case"months":if(t){const e=new Date(t[1]).getUTCFullYear()-new Date(t[0]).getUTCFullYear(),a=new Date(t[0]).getUTCMonth(),i=new Date(t[1]).getUTCMonth();n=0===e?i-a+1:i+11-a+12*(e-1)+1}else n=0;break;case"years":n=t?Math.round((new Date(t[1]).getUTCFullYear()-new Date(t[0]).getUTCFullYear())/i):0;break;case"decades":n=t?Math.round((new Date(t[1]).getUTCFullYear()-new Date(t[0]).getUTCFullYear())/10/i):0;break;default:n=0}return n}function b(e){if(2!==e.extent?.length||!e.interval)return[];const{extent:[n,t],interval:a}=e;if("ISO8601"===e.unit){const i=e.intervalUnit?.toLowerCase()??"days";return["decades","years","months","days","hours","minutes","seconds"].includes(i)?function(e,n,t,a){const i=[];let s=e;const r=new Date(e);for(;s<=n;)switch(i.push(s),a){case"decades":r.setUTCFullYear(r.getUTCFullYear()+10*t),s=r.getTime();break;case"years":r.setUTCFullYear(r.getUTCFullYear()+t),s=r.getTime();break;case"months":r.setUTCMonth(r.getUTCMonth()+t),s=r.getTime();break;case"days":s+=864e5*t;break;case"hours":s+=36e5*t;break;case"minutes":s+=6e4*t;break;case"seconds":s+=1e3*t}return 1===i.length?i[1]=n:i[i.length-1]=n,i}(n,t,a,i):[]}const i=Math.round((t-n)/a);return Array.from({length:i},((e,s)=>s===i-1?t:n+s*a))}function D(e,n){let t=0;const a=e[0].variableName,i=[...n.variables].sort(((e,n)=>e.name>n.name?1:-1));for(let n=0;n<i.length;n++){const s=i[n],r=[...s.dimensions].sort(((e,n)=>e.name>n.name?-1:1));if(s.name!==a){t+=r.map((e=>v(e))).reduce(((e,n)=>e*n));continue}const l=r.map((e=>v(e))),o=r.length;for(let n=0;n<o;n++){const a=e.find((e=>e.dimensionName===r[n].name));if(null==a)return null;const i=g(a.values[0],r[n]);if(-1===i)return null;l.shift(),t+=n===o-1?i:i*l.reduce(((e,n)=>e*n))}break}return t}export{i as a,f as b,a as c,c as d,h as e,b as f,D as g,u as h,d as i,m as j};
