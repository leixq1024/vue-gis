/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{d as t}from"./deduplicate.js";import{n as e}from"./InterleavedLayout.js";import{V as o}from"./VertexAttribute.js";import{RegularEdgeInstancesLayout as n,SilhouetteEdgeInstancesLayout as s,EdgeInputBufferLayout as r}from"./bufferLayouts.js";import{R as a}from"../core/lang.js";import{o as i,f as c,i as l,d as f,p as u,c as d,a as p,n as g,g as h}from"./vec3.js";import{c as m}from"./vec3f64.js";import{g as w}from"./glUtil.js";import{a as y}from"./Normals.js";import{a as I,d as v}from"./mathUtils.js";import{P as N}from"../core/scheduling.js";function A(t,e,o){const n=t.vertices.position,s=t.vertices.componentIndex,r=j.position0,a=j.position1,h=j.faceNormal0,m=j.faceNormal1,{edges:w,normals:y}=function(t){const e=t.faces.length/3,o=t.faces,n=t.neighbors,s=t.vertices.position;L.length=b.length=0;for(let t=0;t<e;t++){const e=3*t,r=n[e],a=n[e+1],i=n[e+2],c=o[e],l=o[e+1],f=o[e+2];s.getVec(c,_),s.getVec(l,M),s.getVec(f,B),p(M,M,_),p(B,B,_),d(_,M,B),g(_,_),b.pushArray(_),(-1===r||c<l)&&(L.push(c),L.push(l),L.push(t),L.push(r)),(-1===a||l<f)&&(L.push(l),L.push(f),L.push(t),L.push(a)),(-1===i||f<c)&&(L.push(f),L.push(c),L.push(t),L.push(i))}return{edges:L,normals:b}}(t),v=w.length/4,N=e.allocate(v);let A=0;const S=v,U=o?.allocate(S);let F=0,T=0,W=0;x.length=0;for(let t=0;t<v;++t){const e=4*t;n.getVec(w.data[e],r),n.getVec(w.data[e+1],a);const o=x.pushNew();o.index=4*t,o.length=i(r,a)}x.sort(((t,e)=>e.length-t.length));const D=new Array,R=new Array;x.forAll((({length:t,index:i})=>{const p=w.data[i],g=w.data[i+1],v=w.data[i+2],S=w.data[i+3],x=-1===S;if(n.getVec(p,r),n.getVec(g,a),x){const t=3*v;c(h,y.data[t],y.data[t+1],y.data[t+2]),l(m,h),j.componentIndex=s.get(p),j.cosAngle=f(h,m)}else{let t=3*v;if(c(h,y.data[t],y.data[t+1],y.data[t+2]),t=3*S,c(m,y.data[t],y.data[t+1],y.data[t+2]),j.componentIndex=s.get(p),j.cosAngle=f(h,m),L=E,j.cosAngle>L)return;j.cosAngle<-.9999&&l(m,h)}var L,b;T+=t,W++,x||(b=C,j.cosAngle<b)?(e.write(N,A++,j),D.push(t)):function(t,e){const o=I(t.cosAngle);return u(V,t.position1,t.position0),o*(f(d(O,t.faceNormal0,t.faceNormal1),V)>0?-1:1)>e}(j,P)&&(U&&o&&o.write(U,F++,j),R.push(t))}));const k=new Float32Array(D.reverse()),H=new Float32Array(R.reverse()),q=U&&o?{instancesData:U.slice(0,F),lodInfo:{lengths:H}}:void 0;return{regular:{instancesData:N.slice(0,A),lodInfo:{lengths:k}},silhouette:q,averageEdgeLength:T/W}}class S{constructor(){this.index=0,this.length=0}}const x=new N({allocator:t=>t||new S,deallocator:null}),L=new N({deallocator:null}),b=new N({deallocator:null}),j=new class{constructor(){this.position0=m(),this.position1=m(),this.faceNormal0=m(),this.faceNormal1=m(),this.componentIndex=0,this.cosAngle=0}},O=m(),V=m(),_=m(),M=m(),B=m(),P=v(4),E=Math.cos(P),U=v(35),C=Math.cos(U);function F(t,e,o){const n=e/3,s=new Uint32Array(o+1),r=new Uint32Array(o+1),a=(t,e)=>{t<e?s[t+1]++:r[e+1]++};for(let e=0;e<n;e++){const o=t[3*e],n=t[3*e+1],s=t[3*e+2];a(o,n),a(n,s),a(s,o)}let i=0,c=0;for(let t=0;t<o;t++){const e=s[t+1],o=r[t+1];s[t+1]=i,r[t+1]=c,i+=e,c+=o}const l=new Uint32Array(6*n),f=s[o],u=(t,e,o)=>{if(t<e){const n=s[t+1]++;l[2*n]=e,l[2*n+1]=o}else{const n=r[e+1]++;l[2*f+2*n]=t,l[2*f+2*n+1]=o}};for(let e=0;e<n;e++){const o=t[3*e],n=t[3*e+1],s=t[3*e+2];u(o,n,e),u(n,s,e),u(s,o,e)}const d=(t,e)=>{const o=2*t,n=e-t;for(let t=1;t<n;t++){const e=l[o+2*t],n=l[o+2*t+1];let s=t-1;for(;s>=0&&l[o+2*s]>e;s--)l[o+2*s+2]=l[o+2*s],l[o+2*s+3]=l[o+2*s+1];l[o+2*s+2]=e,l[o+2*s+3]=n}};for(let t=0;t<o;t++)d(s[t],s[t+1]),d(f+r[t],f+r[t+1]);const p=new Int32Array(3*n),g=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,h=(t,e)=>{const o=g(t,e);p[3*e+o]=-1},m=(t,e,o,n)=>{const s=g(t,e);p[3*e+s]=n;const r=g(o,n);p[3*n+r]=e};for(let t=0;t<o;t++){let e=s[t];const o=s[t+1];let n=r[t];const a=r[t+1];for(;e<o&&n<a;){const o=l[2*e],s=l[2*f+2*n];o===s?(m(t,l[2*e+1],s,l[2*f+2*n+1]),e++,n++):o<s?(h(t,l[2*e+1]),e++):(h(s,l[2*f+2*n+1]),n++)}for(;e<o;)h(t,l[2*e+1]),e++;for(;n<a;)h(l[2*f+2*n],l[2*f+2*n+1]),n++}return p}class T{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?H:k}write(t,e,o){K.seed=this._edgeHashFunction(o);const n=K.getIntRange(0,255),s=K.getIntRange(0,this.settings.variants-1),r=K.getFloat();var a;const i=255*(.5*(a=-(1-Math.min(r/.7,1))+Math.max(0,r-.7)/(1-.7),Math.abs(a)**1.2*Math.sign(a))+.5);t.position0.setVec(e,o.position0),t.position1.setVec(e,o.position1),t.componentIndex.set(e,o.componentIndex),t.variantOffset.set(e,n),t.variantStroke.set(e,s),t.variantExtension.set(e,i)}}const W=new Float32Array(6),D=new Uint32Array(W.buffer),R=new Uint32Array(1);function k(t){return W[0]=t.position0[0],W[1]=t.position0[1],W[2]=t.position0[2],W[3]=t.position1[0],W[4]=t.position1[1],W[5]=t.position1[2],R[0]=31*(31*(31*(31*(31*(166811+D[0])+D[1])+D[2])+D[3])+D[4])+D[5],R[0]}function H(t){const e=W;e[0]=z(t.position0[0]),e[1]=z(t.position0[1]),e[2]=z(t.position0[2]),e[3]=z(t.position1[0]),e[4]=z(t.position1[1]),e[5]=z(t.position1[2]),R[0]=5381;for(let t=0;t<D.length;t++)R[0]=31*R[0]+D[t];return R[0]}const q=1e4;function z(t){return Math.round(t*q)/q}class X{constructor(){this._commonWriter=new T}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return n.createBuffer(t)}write(t,e,o){this._commonWriter.write(t,e,o),h(J,o.faceNormal0,o.faceNormal1),g(J,J);const{typedBuffer:n,typedBufferStride:s}=t.normalCompressed;y(n,e,J[0],J[1],J[2],s)}}X.Layout=n,X.glLayout=w(n,1);class G{constructor(){this._commonWriter=new T}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return s.createBuffer(t)}write(t,e,o){this._commonWriter.write(t,e,o);{const{typedBuffer:n,typedBufferStride:s}=t.normalCompressed;y(n,e,o.faceNormal0[0],o.faceNormal0[1],o.faceNormal0[2],s)}{const{typedBuffer:n,typedBufferStride:s}=t.normal2Compressed;y(n,e,o.faceNormal1[0],o.faceNormal1[1],o.faceNormal1[2],s)}}}G.Layout=s,G.glLayout=w(s,1);const J=m(),K=new a;function Q(t){const e=Y(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return $.updateSettings(t.writerSettings),tt.updateSettings(t.writerSettings),A(e,$,tt)}function Y(e,o,n,s){if(o){const t=F(n,s,e.count);return new Z(n,s,t,e)}const a=t(e.buffer,e.stride/4,{originalIndices:n,originalIndicesLength:s}),i=F(a.indices,s,a.uniqueCount);return{faces:a.indices,facesLength:a.indices.length,neighbors:i,vertices:r.createView(a.buffer)}}class Z{constructor(t,e,o,n){this.faces=t,this.facesLength=e,this.neighbors=o,this.vertices=n}}const $=new X,tt=new G,et=e().vec3f(o.POSITION0).vec3f(o.POSITION1),ot=e().vec3f(o.POSITION0).vec3f(o.POSITION1).u16(o.COMPONENTINDEX),nt=Object.freeze(Object.defineProperty({__proto__:null,extract:Q,extractComponentsEdgeLocationsLayout:ot,extractEdgeInformation:Y,extractEdgeLocationsLayout:et},Symbol.toStringTag,{value:"Module"}));export{X as R,G as S,Y as a,A as b,et as c,ot as d,Q as e,nt as f};
