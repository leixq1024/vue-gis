/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import{c as i}from"./asyncUtils.js";import n from"../core/Evented.js";import"../core/lang.js";import{throwIfAborted as s,isAborted as r}from"../core/promiseUtils.js";import{watch as a,syncAndInitial as o,sync as h}from"../core/reactiveUtils.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import{project as c,initializeProjection as l}from"../geometry/projection.js";import{a as u}from"./elevationInfoUtils.js";import{e as f,a as g,h as _,m as E,j as S}from"./normalizedPoint.js";import{d as m}from"./Settings2.js";import{a as v,L as w,I as y,P,R as T}from"./RightAngleSnappingHint.js";import C from"../views/interactive/snapping/SnappingOptions.js";import{D as R,L as x,k as j,P as L,l as N,d as D,s as M,h as F}from"./snappingUtils.js";import{a as I,g as A,e as V,l as b}from"./vec3.js";import{a as q,c as z}from"./vec3f64.js";import{u as H}from"./vec2.js";import{c as O,d as U}from"./screenUtils.js";import{m as G}from"./dehydratedPoint.js";import{v as k}from"./viewUtils.js";class Z{constructor(t,e,i,n){this.targetPoint=t,this.constraint=e,this.isDraped=i,this.domain=n}}class W extends Z{constructor({targetPoint:t,objectId:e,constraint:i,isDraped:n}){super(t,i,n,v.FEATURE),this.objectId=e}}class X extends W{constructor(t){super({...t,isDraped:!0,constraint:new R(t.edgeStart,t.edgeEnd,t.getGroundElevation)})}get hints(){return[new w(x.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}}class B extends W{constructor(t){super({...t,constraint:new j(t.edgeStart,t.edgeEnd)})}get hints(){return[new w(x.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}}class J extends Z{constructor(t,e,i,n){super(t,new L(t),n,v.ALL),this.first=e,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new y(this.targetPoint,this.isDraped,this.domain)]}}class K extends Z{constructor({lineStart:t,lineEnd:e,targetPoint:i,isDraped:n}){super(i,new N(t,e),n,v.SELF),this._referenceLineHint=new w(x.REFERENCE_EXTENSION,t,e,n,this.domain)}get hints(){return[this._referenceLineHint,new w(x.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}}class Q extends Z{constructor({referenceLine:t,lineStart:e,targetPoint:i,isDraped:n}){const s=q(e),{left:r,right:a}=t;I(s,A(s,s,a),r),super(i,new N(e,f(s)),n,v.SELF),this._referenceLines=[{edge:t,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new w(x.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new P(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map((t=>new w(x.REFERENCE,t.edge.left,t.edge.right,this.isDraped,this.domain,t.fadeLeft,t.fadeRight)))]}addReferenceLine(t){const e={edge:t,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach((i=>{V(t.right,i.edge.left)&&(i.fadeLeft=!1,e.fadeRight=!1),V(t.right,i.edge.right)&&(i.fadeRight=!1,e.fadeRight=!1),V(t.left,i.edge.right)&&(i.fadeRight=!1,e.fadeLeft=!1),V(t.left,i.edge.left)&&(i.fadeLeft=!1,e.fadeLeft=!1)})),this._referenceLines.push(e)}}class Y extends Z{constructor({targetPoint:t,constraint:e,previousVertex:i,otherVertex:n,otherVertexType:s,isDraped:r,selfSnappingType:a,objectId:o,domain:h}){super(t,e,r,h??v.SELF),this.previousVertex=i,this.otherVertex=n,this.otherVertexType=s,this.selfSnappingType=a??tt.None,this.objectId=o??null}get hints(){const t=this.previousVertex,e=this.otherVertexType===$.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===$.CENTER?this.targetPoint:this.otherVertex;return[new w(x.TARGET,e,i,this.isDraped,this.domain),new w(x.REFERENCE,t,e,this.isDraped,this.domain),new T(this.previousVertex,e,i,this.isDraped,this.domain)]}}var $,tt;!function(t){t[t.NEXT=0]="NEXT",t[t.CENTER=1]="CENTER"}($||($={})),function(t){t[t.None=0]="None",t[t.LastVertex=1]="LastVertex",t[t.FirstVertex=2]="FirstVertex",t[t.ExistingEdge=3]="ExistingEdge"}(tt||(tt={}));class et extends Z{constructor({targetPoint:t,point1:e,point2:i,isDraped:n}){super(t,new D(f(b(z(),e,i,.5)),.5*H(g(e),g(i))),n,v.SELF),this._p1=e,this._p2=i}get hints(){return[new w(x.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new w(x.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new T(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}}function it(t,e,i,n){return"2d"===n.type?(nt.x=t[0],nt.y=t[1],nt.spatialReference=e,n.toScreen(nt)):(k(t,e,i,n,st),n.state.camera.projectToScreen(st,rt),O(rt[0],rt[1]))}const nt=G(0,0,0,null),st=z(),rt=U();let at=class extends(n.EventedMixin(e)){constructor(t){super(t),this.options=new C,this._engineCache=new Map,this._loadTask=null,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=ot.MAIN}initialize(){this.addHandles([a((()=>{const{distance:t,touchSensitivityMultiplier:e,effectiveSelfEnabled:i,effectiveFeatureEnabled:n,effectiveGridEnabled:s}=this.options;return{selfEnabled:i,featureEnabled:n,gridEnabled:"2d"===this.view.type&&s,viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,distance:t,touchSensitivityMultiplier:e}}),((t,e)=>{e&&(this.doneSnapping(),this.emit("changed")),this._loadTask?.abort(),this._loadTask=i((i=>this._updateEngines(t,e,i)))}),o),a((()=>this.options),(t=>{for(const e of this._engines)e.options=t}),h)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some((t=>t.updating))||!this._loadTask?.finished}_destroyEngines(){this._engineCache.forEach((t=>t.destroy())),this._engineCache.clear(),this._engines=[]}async _updateEngines(t,e,i){if(!t.viewReady)return void this._destroyEngines();e?.viewSpatialReference!==t.viewSpatialReference&&this._destroyEngines();const{_engineCache:n}=this,s=[];t.featureEnabled&&!n.has("feature")&&s.push(this._setupFeatureSnappingEngine(i)),t.selfEnabled&&!n.has("self")&&s.push(this._setupSelfSnappingEngine(i)),t.gridEnabled&&!n.has("grid")&&"2d"===this.view.type&&s.push(this._setupGridSnappingEngine(i)),await Promise.allSettled(s),i.aborted||(this._engines=Array.from(n.values()))}async _setupSelfSnappingEngine(t){const{SelfSnappingEngine:e}=await import("./SelfSnappingEngine.js");s(t);const i=new e({view:this.view,options:this.options});this._engineCache.set("self",i)}async _setupGridSnappingEngine(t){const{view:e}=this,{GridSnappingEngine:i}=await import("./GridSnappingEngine.js");if(s(t),"2d"===e.type){const t=new i({view:e,options:this.options});this._engineCache.set("grid",t)}}async _setupFeatureSnappingEngine(t){const{FeatureSnappingEngine:e}=await import("./FeatureSnappingEngine.js");s(t);const{view:i,options:n,_engineCache:r}=this,a=new e({view:i,options:n,spatialReference:i.spatialReference});r.set("feature",a)}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:t,touchSensitivityMultiplier:e}=this.options,i=t*e;return i*i}snap(t){return function(t){return null!=t.scenePoint}(t)?this._snapMultiPoint(t):this._snapSinglePoint(t)}update(t){const{point:e,context:i}=t;this._removeVisualization();const n=this._currentMainCandidate;if(null==n)return e;const s=this._selectUpdateInput(t);if(null==s)return e;const{spatialReference:r}=i,a=c(s,r);if(null==a)return e;const{view:o}=this,{elevationInfo:h,visualizer:p}=i,d=[],l=_(a,o,h),u=n.constraint.closestTo(l);if(!this._arePointsWithinScreenThreshold(l,u,i)||!pt(n,i.drawConstraints))return this._resetSnappingState(),e;n.targetPoint=E(u),d.push(...n.hints);for(const t of this._currentOtherActiveCandidates)pt(t,i.drawConstraints)&&(t.targetPoint=E(u),d.push(...t.hints));return null!=p&&this.addHandles(p.draw(d,{spatialReference:r,elevationInfo:ct(i),view:o,selfSnappingZ:i.selfSnappingZ}),ht),S(u,o,e,i)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:t,scenePoint:e}){switch(this._currentSnappedType){case ot.MAIN:return t;case ot.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=ot.MAIN}_removeVisualization(){this.removeHandles(ht)}async _snapSinglePoint({point:t,context:e,signal:i}){const{view:n}=this,{elevationInfo:s}=e,r=_(t,n,s),a=await this._fetchCandidates(r,v.ALL,e,i);return this._createSnapResult(r,ot.MAIN,a,n,t,e,i)}async _snapMultiPoint({point:t,scenePoint:e,context:i,signal:n}){const{view:s}=this,{coordinateHelper:r,elevationInfo:a,spatialReference:o}=i;await l(e.spatialReference,o);const h=c(e,o),p=_(h,s,a),d=await this._fetchCandidates(p,v.FEATURE,i,n);if(d.length>0){const t=await this._fetchCandidates(p,v.SELF,i,n);return this._createSnapResult(p,ot.SCENE,[...d,...t],s,h,i,n)}const u=_(t,s,a),f=await this._fetchCandidates(u,v.SELF,i,n);return this._createSnapResult(u,ot.MAIN,f,s,{z:r.hasZ()&&t.hasZ?t.z??0:void 0,m:r.hasM()&&t.hasM?t.m??0:void 0},i,n)}async _fetchCandidates(t,e,i,n){return(await Promise.all(this._engines.map((s=>s.fetchCandidates(t,e,i,n))))).flat()}_createSnapResult(t,e,i,n,s,a,o){return{get valid(){return!r(o)},apply:()=>{const{spatialReference:r}=a,{snappedPoint:o,hints:h}=this._processCandidates(t,e,i,a);return this._removeVisualization(),null!=a.visualizer&&this.addHandles(a.visualizer.draw(h,{spatialReference:r,elevationInfo:u,view:n,selfSnappingZ:a.selfSnappingZ}),ht),S(o,n,s,a)}}}_processCandidates(t,e,i,n){if(i.length<1)return this.doneSnapping(),{snappedPoint:t,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),M(t,i);const s=this._currentMainCandidate;if(null!=s){const o=(a=i,(r=s)instanceof J?dt(a,r.first)>=0&&dt(a,r.second)>=0?0:-1:dt(a,r));if(o>=0){if(!(i[o]instanceof J))return this._intersectWithOtherCandidates(o,i,t,e,n);if(this._arePointsWithinScreenThreshold(t,s.targetPoint,n))return this._updateSnappingCandidate(s,e,i,n)}}var r,a;return this._intersectWithOtherCandidates(0,i,t,e,n)}_intersectWithOtherCandidates(t,e,i,n,s){const{coordinateHelper:r}=s,a=e[t],o=[];for(let n=0;n<e.length;++n){if(n===t)continue;const s=e[n],h=a.constraint.intersect(s.constraint);if(h)for(const t of h.closestPoints(a.targetPoint))o.push([new J(E(t),a,s,s.isDraped),this._squaredScreenDistance(i,t,r)])}return o.length>0&&(o.sort(((t,e)=>t[1]-e[1])),o[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(o[0][0],n,e,s):pt(a,s.drawConstraints)?this._updateSnappingCandidate(a,n,e,s):{snappedPoint:i,hints:[]}}_updateSnappingCandidate(t,e,i,n){this.doneSnapping(),this._currentMainCandidate=t,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...t.hints);for(const e of i){if(t instanceof J){if(e.constraint.equals(t.first.constraint)||e.constraint.equals(t.second.constraint))continue}else if(e.constraint.equals(t.constraint))continue;const i=e.constraint.closestTo(s);this._squaredScreenDistance(i,s,n.coordinateHelper)<m.satisfiesConstraintScreenThreshold*m.satisfiesConstraintScreenThreshold&&(e.targetPoint=s,this._currentOtherActiveCandidates.push(e),r.push(...e.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(t){return"touch"===t?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(t,e,i){return this._squaredScreenDistance(t,e,i.coordinateHelper)<this._squaredPointProximityThreshold(i.pointer)}_squaredScreenDistance(t,e,i){return F(this._toScreen(t,i),this._toScreen(e,i))}_toScreen(t,e){return it(t,e.spatialReference,u,this.view)}get test(){}};var ot;t([p({constructOnly:!0})],at.prototype,"view",void 0),t([p()],at.prototype,"options",void 0),t([p({readOnly:!0})],at.prototype,"updating",null),t([p()],at.prototype,"_loadTask",void 0),t([p()],at.prototype,"_engines",void 0),t([p()],at.prototype,"_squaredMouseProximityThreshold",null),t([p()],at.prototype,"_squaredTouchProximityThreshold",null),at=t([d("esri.views.interactive.snapping.SnappingManager")],at),function(t){t[t.MAIN=0]="MAIN",t[t.SCENE=1]="SCENE"}(ot||(ot={}));const ht="visualization-handle";function pt(t,e){return!e||null==e.direction&&null==e.distance||!(t instanceof X||t instanceof B||t instanceof K||t instanceof Q||t instanceof et)&&(!(t instanceof Y)||null==e.direction&&t.selfSnappingType===tt.LastVertex)}function dt(t,e){let i=-1;for(let n=0;n<t.length;++n)if(e.constraint.equals(t[n].constraint)){i=n;break}return i}function ct({coordinateHelper:t,elevationInfo:e}){return t.hasZ()?u:e}export{X as D,B as E,W as F,J as I,K as L,$ as O,Q as P,Y as R,at as S,tt as a,et as b,it as v};
