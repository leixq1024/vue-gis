/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../core/Collection.js";import{ah as t,ai as n,i,af as r,aj as o}from"./unitUtils.js";import{m as l}from"./layerUtils.js";import{V as a}from"./ViewingMode.js";import s from"../core/Error.js";import{i as c,a as u,d as f,g as T,s as S}from"./vec3.js";import{c as m}from"./vec3f64.js";import{s as p,u as h,d as E,c as g}from"./aaBoundingRect.js";import{g as O,T as d,m as H}from"./TerrainConst.js";function _(e){return null!=e&&"type"in e&&"vector-tile"===e.type}function y(e){return null!=e&&"type"in e&&"raster-tile"===e.type}function R(e){return null!=e&&"type"in e&&"tile-texture"===e.type}function W(e){return null!=e&&"type"in e&&"image+type"===e.type}var b;function I(e){return w(e)||t(e)||n(e)}function w(e){return i(e)||r(e)}!function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(b||(b={}));const x=m(),A=m(),N=m(),M=m();function U(e,t,n,i){c(x,n),x[i]=t[i];const r=u(x,x,t),o=u(A,e,t),l=f(o,r),a=f(r,r);let s;s=l<=0?t:a<=l?n:T(x,t,S(r,r,l/a));const m=u(x,e,s);return Math.PI/2-Math.atan(m[2]/Math.sqrt(m[0]*m[0]+m[1]*m[1]))}const v=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,n,i){if(null==e)return O();const r=e.spatialReference;if(r.isGeographic&&!w(r))return new s("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const o=d.checkUnsupported(e);if(null!=o)return o;if(null==n)return new s("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const l=function(e,t){const n=e.lods,i=n[0].resolution*2**n[0].level,r=[i*e.size[0],i*e.size[1]],o=[e.origin.x,e.origin.y],l=E(t),a=g();d.computeRowColExtent(l,r,o,a);const c=(a[2]-a[0])*(a[3]-a[1]);if(c>H){const t=n[0].scale*2**n[0].level;let r=Math.max((l[3]-l[1])/e.size[1],(l[2]-l[0])/e.size[0])*t/i;const o=Math.floor(Math.log(r)/Math.log(10));return r=Math.ceil(r/10**o)*10**o,new s("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+r.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:r,requiredNumRootTiles:c,allowedNumRootTiles:H})}return null}(e,n);return l||(null==t||r.equals(t)||t.isWGS84&&r.isWebMercator?null:new s("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"))},isInsideExtent:function(e,t,n=0){const i=e.extent;if(null==i)return!1;if(0===n)return p(i,t);const r=Math.min(i[2]-i[0],i[3]-i[1]);return h(i,t,n*r)},tiltToExtentEdge:function(e,t,n){const i=e.extent;if(null==i)return 0;N[0]=i[0],N[1]=i[1],N[2]=n,M[0]=i[2],M[1]=i[3],M[2]=n;let r=1/0,o=1/0;return t[0]<N[0]?r=U(t,N,M,0):t[0]>M[0]&&(r=U(t,M,N,0)),t[1]<N[1]?o=U(t,N,M,1):t[1]>M[1]&&(o=U(t,M,N,1)),Math.min(r,o)}},Symbol.toStringTag,{value:"Module"})),L=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,n,i){if(null==e)return O();const r=e?.lods.length-1,o=e.spatialReference;if(o.isWebMercator){if(!d.makeWebMercatorAuxiliarySphere(r).compatibleWith(e,i))return new s("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!I(o))return new s("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!d.makeGCSWithTileSize(e.spatialReference,e.size[0],r).compatibleWith(e,i))return e.spatialReference.isWGS84?new s("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new s("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==t||e.spatialReference.equals(t)?null:new s("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")},isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0}},Symbol.toStringTag,{value:"Module"})),j={[a.Global]:L,[a.Local]:v};function C(e,t){e||console.warn("Terrain: "+t)}let G=!1,k=!1;function z(e){k=e,G=G||e}function V(e){G=e}function F(e,t){if(G&&!e){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(t??"")+" at "+e),new Error("Assertion failed"+(t?": "+t:""))}}function q(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function P(e){return"imagery-tile-3d"===e?.type}function B(e){return"tile-3d"===e?.type}function D(e){return"vector-tile-3d"===e?.type}function J(e){return"wmts-3d"===e?.type}function K(e){return"elevation-3d"===e?.type}function Q(e){return"group"===e?.type}function X(e){return e&&(B(e)||J(e)||P(e)||D(e))}function Y(e){return e&&(B(e)||P(e)||D(e)||J(e))}function Z(e){return Y(e)||K(e)}function $(e){return y(e?.sourceLayerInfo?.data)}function ee(e){return ie(e?.sourceLayerInfo)||!!e?.isVTLBackground}function te(e){return R(e?.sourceLayerInfo?.data)}function ne(e){const t=e?.sourceLayerInfo?.data;return W(t)||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData}function ie(e){return _(e?.data)}function re(e){return null!=e&&"release"in e&&e.release(),null}function oe(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function le(e,t,n,i,r){return j[i].checkIfTileInfoSupportedForViewSR(e,n,t,r)}function ae(e,t,n){let i=null,r=null;if("wmts"===e?.type){const o=se(e,t,n);i=o.tileInfo,r=o.fullExtent}else{r=q(e)?e.getCompatibleFullExtent(t):e.fullExtent;const o=n===a.Local;i=q(e)?e.getCompatibleTileInfo(t,r,o):"vector-tile"===e?.type?o&&!ce(t)||ue.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):e.tileInfo}const o="tilemapCache"in e?e.tilemapCache?.effectiveMaxLOD:void 0;return null!=i&&null!=r&&null==le(i,r,t,n,o)?{tileInfo:i,fullExtent:r}:null}function se(t,n,i){const r=l(t);if(null!=r){if(!e.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const e=r.find((e=>null==le(e.tileInfo,e.fullExtent,n,i)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function ce(e){return e.isWGS84||e.isWebMercator||r(e)||!o(e)}const ue={force512VTL:!1};function fe(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function Te(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function Se(e,t,n=Re){return Math.abs(e-t)<n}function me(e){return e===b.NORTH_EAST?b.SOUTH_WEST:e===b.NORTH_WEST?b.SOUTH_EAST:e===b.SOUTH_WEST?b.NORTH_EAST:b.NORTH_WEST}function pe(e){return e===b.NORTH?b.SOUTH:e===b.EAST?b.WEST:e===b.SOUTH?b.NORTH:b.EAST}function he(e){return e===b.NORTH_WEST||e===b.SOUTH_WEST}function Ee(e){return e===b.NORTH_WEST||e===b.NORTH_EAST}function ge(e){return e===b.NORTH_WEST||e===b.WEST||e===b.SOUTH_WEST}function Oe(e){return e===b.NORTH_EAST||e===b.EAST||e===b.SOUTH_EAST}function de(e){return e===b.SOUTH_EAST||e===b.SOUTH||e===b.SOUTH_WEST}function He(e){return e===b.NORTH_EAST||e===b.NORTH||e===b.NORTH_WEST}const _e=[b.NORTH,b.EAST,b.SOUTH,b.WEST],ye=[b.NORTH_EAST,b.SOUTH_EAST,b.SOUTH_WEST,b.NORTH_WEST],Re=1e-5;export{Oe as A,Se as B,k as C,he as D,Ee as E,D as F,ee as G,$ as H,ne as I,te as J,ie as K,w as L,I as M,b as N,Z as O,Q as P,Y as Q,K as R,V as S,z as T,ae as a,q as b,le as c,F as d,P as e,G as f,se as g,ye as h,W as i,Te as j,_ as k,fe as l,R as m,_e as n,pe as o,y as p,X as q,re as r,me as s,ue as t,oe as u,ce as v,C as w,He as x,de as y,ge as z};
