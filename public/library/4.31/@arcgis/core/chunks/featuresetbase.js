/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{A as e}from"./TimeOnly.js";import{D as t,l as r,F as s,o as i}from"./arcadeUtils.js";import{p as o,G as n,H as a,g as l,n as m,E as p,t as u,x as d,Q as f,P as c,i as y,f as j,J as h,O as b,d as I,e as g,c as w,k as F,w as D,T as S,U as T,V as x}from"./languageUtils.js";import{c as E,a as C,F as L,b as A,O as U,d as P,T as v,e as N,f as R,g as M,h as Z,S as $,i as k,j as O,A as V,k as z}from"./featureSetUtils.js";import{I as B}from"./ImmutableArray.js";import{g as G}from"./portalUtils.js";import{E as H,i as W}from"./SpatialFilter.js";import{c as q}from"./shared2.js";import{isPromiseLike as Q}from"../core/promiseUtils.js";import{WhereClause as _}from"../core/sql/WhereClause.js";import K from"../layers/FeatureLayer.js";import J from"../layers/support/Field.js";import Y from"../portal/Portal.js";import"./Logger.js";import"../config.js";import"../core/lang.js";import"./UnknownTimeZone.js";import"./datetime.js";import"./locale.js";import"./handleUtils.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./utils.js";import"./metadata.js";import"../core/Error.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObservableBase.js";import"../core/scheduling.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./boundsUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./deepClone.js";import"./featureConversionUtils.js";import"./aaBoundingBox.js";import"./OptimizedFeature.js";import"./OptimizedGeometry.js";import"./OptimizedFeatureSet.js";import"../layers/support/FieldsIndex.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./number.js";import"./substitute.js";import"./messages.js";import"./number2.js";import"./hash.js";import"./uuid.js";import"../rest/support/Query.js";import"./enumeration.js";import"./DataLayerSource.js";import"./FullTextSearch.js";import"../core/Clonable.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../time/TimeExtent.js";import"./timeUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../Color.js";import"./colorUtils.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/content/UtilityNetworkAssociationsContent.js";import"../popup/support/UtilityNetworkAssociationType.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"./vec3f64.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"./asyncUtils.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./MD5.js";import"../rest/support/AttachmentQuery.js";import"../layers/support/FeatureType.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../layers/support/FeatureTemplate.js";import"../rest/support/RelationshipQuery.js";import"./fieldType.js";import"../layers/Layer.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../geometry/geometryEngineAsync.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"./sizeVariableUtils.js";import"./visualVariableUtils.js";import"./compilerUtils.js";import"./lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"./commonProperties.js";import"../symbols/support/jsonUtils.js";import"./layerUtils.js";import"./defaults.js";import"./defaultsJSON.js";import"./RendererLegendOptions.js";import"../renderers/DictionaryRenderer.js";import"./LRUCache.js";import"./MemCache.js";import"./Version2.js";import"./OverrideHelper.js";import"./colorUtils2.js";import"./vec4.js";import"./common.js";import"./vec4f64.js";import"./utils7.js";import"./enums2.js";import"./quantizationUtils.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"./heatmapUtils.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"./diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils.js";import"../renderers/support/jsonUtils.js";import"./MultiOriginJSONSupport.js";import"./layerContainerType.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/AttachmentElement.js";import"../form/elements/inputs/attachments/AttachmentInput.js";import"./Input.js";import"../form/elements/inputs/attachments/support/inputs.js";import"../form/elements/inputs/attachments/AudioInput.js";import"./utils8.js";import"../form/elements/inputs/attachments/DocumentInput.js";import"../form/elements/inputs/attachments/ImageInput.js";import"../form/elements/inputs/attachments/SignatureInput.js";import"../form/elements/inputs/attachments/VideoInput.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DatePickerInput.js";import"../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../form/elements/inputs/TimePickerInput.js";import"../form/elements/RelationshipElement.js";import"../form/elements/TextElement.js";import"./formUtils.js";import"./editsZScale.js";import"./queryZScale.js";import"./zscale.js";import"../rest/support/FeatureSet.js";import"../layers/mixins/APIKeyMixin.js";import"./ArcGISService.js";import"./arcgisLayerUrl.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils.js";import"./parser.js";import"./utils2.js";import"./mat4.js";import"../layers/mixins/CustomParametersMixin.js";import"./EditBusLayer.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../layers/mixins/FeatureLayerBase.js";import"../geometry/HeightModelInfo.js";import"./commonProperties2.js";import"./ElevationInfo.js";import"./unitConversionUtils.js";import"../tables/AttributeTableTemplate.js";import"../tables/elements/AttributeTableGroupElement.js";import"../tables/elements/AttributeTableElement.js";import"../tables/support/elements.js";import"../tables/elements/AttributeTableAttachmentElement.js";import"../tables/elements/AttributeTableFieldElement.js";import"../tables/elements/AttributeTableRelationshipElement.js";import"./featureLayerUtils.js";import"./featureQueryAll.js";import"../layers/support/GeometryFieldsInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"./serviceCapabilitiesUtils.js";import"../layers/support/Subtype.js";import"../layers/mixins/FeatureReductionLayer.js";import"../layers/support/AggregateField.js";import"../layers/support/ExpressionInfo.js";import"./FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/LabelClass.js";import"./labelUtils.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"./clusterUtils.js";import"../layers/mixins/OperationalLayer.js";import"../layers/mixins/OrderedLayer.js";import"./OrderByInfo.js";import"../layers/mixins/PortalLayer.js";import"./portalItemUtils.js";import"../geometry/projection.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../layers/mixins/PublishableLayer.js";import"../layers/support/PublishingInfo.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../layers/support/TimeInfo.js";import"../time/TimeInterval.js";import"./fieldProperties.js";import"./labelingInfo.js";import"./versionUtils.js";import"./styleUtils2.js";import"../support/popupUtils.js";import"./AlphaCutoff.js";import"./interfaces2.js";async function X(e,t,r){const s=e.getVariables();if(s.length>0){const i=[];for(let e=0;e<s.length;e++){const o={name:s[e]};i.push(await t.evaluateIdentifier(r,o))}const o={};for(let e=0;e<s.length;e++)o[s[e]]=i[e];return e.parameters=o,e}return e}function ee(e,t,r=null){for(const r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return r}function te(e){if(null===e)return null;const t={type:ee(e,"type",""),name:ee(e,"name","")};if("range"===t.type)t.range=ee(e,"range",[]);else{t.codedValues=[];for(const r of ee(e,"codedValues",[]))t.codedValues.push({name:ee(r,"name",""),code:ee(r,"code",null)})}return t}function re(e){if(null===e)return null;const t={},r=ee(e,"wkt");null!==r&&(t.wkt=r);const s=ee(e,"wkid");return null!==s&&(t.wkid=s),t}function se(e){if(null===e)return null;const t={hasZ:ee(e,"hasz",!1),hasM:ee(e,"hasm",!1)},r=ee(e,"spatialreference");null!=r&&(t.spatialReference=re(r));const s=ee(e,"x",null);if(null!==s)return t.x=s,t.y=ee(e,"y",null),t.hasZ&&(t.z=ee(e,"z",null)),t.hasM&&(t.m=ee(e,"m",null)),t;const i=ee(e,"rings",null);if(null!==i)return t.rings=i,t;const o=ee(e,"paths",null);if(null!==o)return t.paths=o,t;const n=ee(e,"points",null);if(null!==n)return t.points=n,t;for(const r of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const s=ee(e,r,null);null!==s&&(t[r]=s)}return t}function ie(e){return"utc"===e?.toLowerCase()?"UTC":"unknown"===e?.toLowerCase()?"Unknown":e}function oe(oe){"async"===oe.mode&&(oe.functions.timezone=function(r,s){return oe.standardFunctionAsync(r,s,(async(i,y,j)=>{if(o(j,1,2,r,s),n(j[0]))return"Unknown";if(a(j[0]))return"Unknown";if(l(j[0])){if(await j[0].load(),1===j.length||null===j[1])return j[0].datesInUnknownTimezone?ie("unknown"):ie(j[0].dateFieldsTimeZone);if(!(j[1]instanceof t)||!1===j[1].hasField("type"))throw new m(r,p.InvalidParameter,s);const e=j[1].field("type");if(!1===u(e))throw new m(r,p.InvalidParameter,s);switch(d(e).toLowerCase()){case"preferredtimezone":return ie(j[0].preferredTimeZone);case"editfieldsinfo":return ie(j[0].editFieldsInfo?.timeZone??null);case"timeinfo":return ie(j[0].timeInfo?.timeZone??null);case"field":if(j[1].hasField("fieldname")&&u(j[1].field("fieldname")))return ie(j[0].fieldTimeZone(d(j[1].field("fieldname"))))}throw new m(r,p.InvalidParameter,s)}const h=f(j[0],c(r));if(null===h)return null;const b=h.timeZone;return"system"===b?e.systemTimeZoneCanonicalName:"utc"===b.toLowerCase()?"UTC":"unknown"===b.toLowerCase()?"Unknown":b}))},oe.functions.sqltimestamp=function(e,t){return oe.standardFunctionAsync(e,t,(async(r,s,i)=>{o(i,1,3,e,t);const n=i[0];if(y(n)){if(1===i.length)return n.toSQLWithKeyword();if(2===i.length)return n.changeTimeZone(d(i[1])).toSQLWithKeyword();throw new m(e,p.InvalidParameter,t)}if(a(n))return n.toSQLWithKeyword();if(l(n)){if(3!==i.length)throw new m(e,p.InvalidParameter,t);await n.load();const r=d(i[1]);if(a(i[2]))return i[2].toSQLWithKeyword();if(!1===y(i[2]))throw new m(e,p.InvalidParameter,t);const s=n.fieldTimeZone(r);return null===s?i[2].toSQLWithKeyword():i[2].changeTimeZone(s).toSQLWithKeyword()}throw new m(e,p.InvalidParameter,t)}))},oe.signatures.push({name:"sqltimestamp",min:2,max:4}),oe.functions.featuresetbyid=function(e,t){return oe.standardFunctionAsync(e,t,((r,s,i)=>{if(o(i,2,4,e,t),j(i[0])){const r=d(i[1]);let s=h(i[2],null);const o=b(h(i[3],!0));if(null===s&&(s=["*"]),!1===I(s))throw new m(e,p.InvalidParameter,t);return i[0].featureSetById(r,o,s)}throw new m(e,p.InvalidParameter,t)}))},oe.signatures.push({name:"featuresetbyid",min:2,max:4}),oe.functions.getfeatureset=function(e,t){return oe.standardFunctionAsync(e,t,(async(r,s,i)=>{if(o(i,1,2,e,t),g(i[0])){let t=h(i[1],"datasource");return null===t&&(t="datasource"),t=d(t).toLowerCase(),E(i[0].fullSchema(),t,e.lrucache,e.interceptor,e.spatialReference??null)}throw new m(e,p.InvalidParameter,t)}))},oe.signatures.push({name:"getfeatureset",min:1,max:2}),oe.functions.featuresetbyportalitem=function(e,t){return oe.standardFunctionAsync(e,t,((s,i,n)=>{if(o(n,2,5,e,t),null===n[0])throw new m(e,p.PortalRequired,t);if(n[0]instanceof r){const r=d(n[1]),s=d(n[2]);let i=h(n[3],null);const o=b(h(n[4],!0));if(null===i&&(i=["*"]),!1===I(i))throw new m(e,p.InvalidParameter,t);let a;return a=e.services?.portal?e.services.portal:Y.getDefault(),a=G(n[0],a),C(r,s,e.spatialReference??null,i,o,a,e.lrucache,e.interceptor)}if(!1===u(n[0]))throw new m(e,p.PortalRequired,t);const a=d(n[0]),l=d(n[1]);let f=h(n[2],null);const c=b(h(n[3],!0));if(null===f&&(f=["*"]),!1===I(f))throw new m(e,p.InvalidParameter,t);return C(a,l,e.spatialReference??null,f,c,e.services?.portal??Y.getDefault(),e.lrucache,e.interceptor)}))},oe.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),oe.functions.featuresetbyname=function(e,t){return oe.standardFunctionAsync(e,t,((r,s,i)=>{if(o(i,2,4,e,t),j(i[0])){const r=d(i[1]);let s=h(i[2],null);const o=b(h(i[3],!0));if(null===s&&(s=["*"]),!1===I(s))throw new m(e,p.InvalidParameter,t);return i[0].featureSetByName(r,o,s)}throw new m(e,p.InvalidParameter,t)}))},oe.signatures.push({name:"featuresetbyname",min:2,max:4}),oe.functions.featureset=function(e,r){return oe.standardFunction(e,r,((s,i,n)=>{o(n,1,1,e,r);const a={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(u(n[0])){const e=JSON.parse(n[0]);void 0!==e.layerDefinition?(a.layerDefinition=e.layerDefinition,a.featureSet=e.featureSet,e.layerDefinition.spatialReference&&(a.layerDefinition.spatialReference=e.layerDefinition.spatialReference)):(a.featureSet.features=e.features,a.featureSet.geometryType=e.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=e.objectIdFieldName??"",a.layerDefinition.typeIdField=e.typeIdFieldName,a.layerDefinition.globalIdField=e.globalIdFieldName,a.layerDefinition.fields=e.fields,e.spatialReference&&(a.layerDefinition.spatialReference=e.spatialReference))}else{if(!(n[0]instanceof t))throw new m(e,p.InvalidParameter,r);{const t=JSON.parse(n[0].castToText(!0)),s=ee(t,"layerdefinition");if(null!==s){a.layerDefinition.geometryType=ee(s,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.globalIdField=ee(s,"globalidfield",""),a.layerDefinition.objectIdField=ee(s,"objectidfield",""),a.layerDefinition.typeIdField=ee(s,"typeidfield",""),a.layerDefinition.hasZ=!0===ee(s,"hasz",!1),a.layerDefinition.hasM=!0===ee(s,"hasm",!1);const e=ee(s,"spatialreference");e&&(a.layerDefinition.spatialReference=re(e));const r=[];for(const e of ee(s,"fields",[])){const t={name:ee(e,"name",""),alias:ee(e,"alias",""),type:ee(e,"type",""),nullable:ee(e,"nullable",!0),editable:ee(e,"editable",!0),length:ee(e,"length",null),domain:te(ee(e,"domain"))};r.push(t)}a.layerDefinition.fields=r;const i=ee(t,"featureset");if(i){const e={};for(const t of r)e[t.name.toLowerCase()]=t.name;for(const t of ee(i,"features",[])){const r={},s=ee(t,"attributes",{});for(const t in s)r[e[t.toLowerCase()]]=s[t];a.featureSet.features.push({attributes:r,geometry:se(ee(t,"geometry"))})}}}else{a.layerDefinition.hasZ=!0===ee(t,"hasz",!1),a.layerDefinition.hasM=!0===ee(t,"hasm",!1),a.layerDefinition.geometryType=ee(t,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.objectIdField=ee(t,"objectidfieldname",""),a.layerDefinition.typeIdField=ee(t,"typeidfieldname","");const s=ee(t,"spatialreference");s&&(a.layerDefinition.spatialReference=re(s));const i=[],o=ee(t,"fields",null);if(!I(o))throw new m(e,p.InvalidParameter,r);for(const e of o){const t={name:ee(e,"name",""),alias:ee(e,"alias",""),type:ee(e,"type",""),nullable:ee(e,"nullable",!0),editable:ee(e,"editable",!0),length:ee(e,"length",null),domain:te(ee(e,"domain"))};i.push(t)}a.layerDefinition.fields=i;const n={};for(const e of i)n[e.name.toLowerCase()]=e.name;let l=ee(t,"features",null);if(I(l))for(const e of l){const t={},r=ee(e,"attributes",{});for(const e in r)t[n[e.toLowerCase()]]=r[e];a.featureSet.features.push({attributes:t,geometry:se(ee(e,"geometry",null))})}else l=null,a.featureSet.features=l}}}if(0==(!!(l=a).layerDefinition&&!!l.featureSet&&!1!==function(e){for(const t of["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])if(t===e)return!0;return!1}(l.layerDefinition.geometryType)&&!1!==I(l.layerDefinition.fields)&&!1!==I(l.featureSet.features)))throw new m(e,p.InvalidParameter,r);var l;return a.layerDefinition.geometryType||(a.layerDefinition.geometryType="esriGeometryNull"),L.create(a,e.spatialReference)}))},oe.signatures.push({name:"featureset",min:1,max:1}),oe.functions.filter=function(e,t){return oe.standardFunctionAsync(e,t,(async(r,s,i)=>{if(o(i,2,2,e,t),I(i[0])||w(i[0])){const r=[];let s,o=i[0];if(o instanceof B&&(o=o.toArray()),!F(i[1]))throw new m(e,p.InvalidParameter,t);s=i[1].createFunction(e);for(const e of o){const t=s(e);Q(t)?!0===await t&&r.push(e):!0===t&&r.push(e)}return r}if(l(i[0])){const t=await i[0].load(),r=_.create(i[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),s=r.getVariables();if(s.length>0){const t=[];for(let r=0;r<s.length;r++){const i={name:s[r]};t.push(await oe.evaluateIdentifier(e,i))}const o={};for(let e=0;e<s.length;e++)o[s[e]]=t[e];return r.parameters=o,new A({parentfeatureset:i[0],whereclause:r})}return new A({parentfeatureset:i[0],whereclause:r})}throw new m(e,p.InvalidParameter,t)}))},oe.signatures.push({name:"filter",min:2,max:2}),oe.functions.orderby=function(e,t){return oe.standardFunctionAsync(e,t,(async(r,s,i)=>{if(o(i,2,2,e,t),l(i[0])){const e=new U(i[1]);return new P({parentfeatureset:i[0],orderbyclause:e})}throw new m(e,p.InvalidParameter,t)}))},oe.signatures.push({name:"orderby",min:2,max:2}),oe.functions.top=function(e,t){return oe.standardFunctionAsync(e,t,(async(r,s,i)=>{if(o(i,2,2,e,t),l(i[0]))return new v({parentfeatureset:i[0],topnum:i[1]});if(I(i[0]))return D(i[1])>=i[0].length?i[0].slice():i[0].slice(0,D(i[1]));if(w(i[0]))return D(i[1])>=i[0].length()?i[0].slice():i[0].slice(0,D(i[1]));throw new m(e,p.InvalidParameter,t)}))},oe.signatures.push({name:"top",min:2,max:2}),oe.functions.first=function(e,t){return oe.standardFunctionAsync(e,t,(async(r,i,n)=>{if(o(n,1,1,e,t),l(n[0])){const t=await n[0].first(r.abortSignal);if(null!==t){const r=s.createFromGraphicLikeObject(t.geometry,t.attributes,n[0],e.timeZone);return r._underlyingGraphic=t,r}return t}return I(n[0])?0===n[0].length?null:n[0][0]:w(n[0])?0===n[0].length()?null:n[0].get(0):null}))},oe.signatures.push({name:"first",min:1,max:1}),oe.functions.attachments=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,i,n)=>{o(n,1,2,e,r);const a={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(n.length>1)if(n[1]instanceof t){if(n[1].hasField("minsize")&&(a.minsize=D(n[1].field("minsize"))),n[1].hasField("metadata")&&(a.returnMetadata=b(n[1].field("metadata"))),n[1].hasField("maxsize")&&(a.maxsize=D(n[1].field("maxsize"))),n[1].hasField("types")){const e=S(n[1].field("types"),!1);e.length>0&&(a.types=e)}}else if(null!==n[1])throw new m(e,p.InvalidParameter,r);if(g(n[0])){let t=n[0]._layer;return t instanceof K&&(t=N(t,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)),null===t||!1===l(t)?[]:(await t.load(),t.queryAttachments(n[0].field(t.objectIdField),a.minsize,a.maxsize,a.types,a.returnMetadata))}if(null===n[0])return[];throw new m(e,p.InvalidParameter,r)}))},oe.signatures.push({name:"attachments",min:1,max:2}),oe.functions.featuresetbyrelationshipname=function(e,t){return oe.standardFunctionAsync(e,t,(async(r,s,i)=>{o(i,2,4,e,t);const n=i[0],a=d(i[1]);let u=h(i[2],null);const f=b(h(i[3],!0));if(null===u&&(u=["*"]),!1===I(u))throw new m(e,p.InvalidParameter,t);if(null===i[0])return null;if(!g(i[0]))throw new m(e,p.InvalidParameter,t);let c=n._layer;if(c instanceof K&&(c=N(c,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)),null===c)return null;if(!1===l(c))return null;c=await c.load();const y=c.relationshipMetaData().filter((e=>e.name===a));if(0===y.length)return null;if(void 0!==y[0].relationshipTableId&&null!==y[0].relationshipTableId&&y[0].relationshipTableId>-1)return R(c,y[0],n.field(c.objectIdField),c.spatialReference,u,f,e.lrucache,e.interceptor);let j=c.serviceUrl();if(!j)return null;j="/"===j.charAt(j.length-1)?j+y[0].relatedTableId.toString():j+"/"+y[0].relatedTableId.toString();const w=await M(j,c.spatialReference,u,f,e.lrucache,e.interceptor);await w.load();let F=w.relationshipMetaData();if(F=F.filter((e=>e.id===y[0].id)),!1===n.hasField(y[0].keyField)||null===n.field(y[0].keyField)){const e=await c.getFeatureByObjectId(n.field(c.objectIdField),[y[0].keyField]);if(e){const t=_.create(F[0].keyField+"= @id",{fieldsIndex:w.getFieldsIndex(),timeZone:w.dateFieldsTimeZoneDefaultUTC});return t.parameters={id:e.attributes[y[0].keyField]},w.filter(t)}return new H({parentfeatureset:w})}const D=_.create(F[0].keyField+"= @id",{fieldsIndex:w.getFieldsIndex(),timeZone:w.dateFieldsTimeZoneDefaultUTC});return D.parameters={id:n.field(y[0].keyField)},w.filter(D)}))},oe.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),oe.functions.featuresetbyassociation=function(e,t){return oe.standardFunctionAsync(e,t,(async(r,s,i)=>{o(i,2,3,e,t);const n=i[0],a=d(h(i[1],"")).toLowerCase(),f=u(i[2])?d(i[2]):null;if(null===i[0])return null;if(!g(i[0]))throw new m(e,p.InvalidParameter,t);let c=n._layer;if(c instanceof K&&(c=N(c,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)),null===c)return null;if(!1===l(c))return null;await c.load();const y=c.serviceUrl(),j=await Z(y,e.spatialReference);let b=null,I=null,w=!1;if(null!==f&&""!==f&&void 0!==f){for(const e of j.terminals)e.terminalName===f&&(I=e.terminalId);null===I&&(w=!0)}const F=j.associations.getFieldsIndex(),D=F.get("TOGLOBALID").name,S=F.get("FROMGLOBALID").name,x=F.get("TOTERMINALID").name,E=F.get("FROMTERMINALID").name,C=F.get("FROMNETWORKSOURCEID").name,L=F.get("TONETWORKSOURCEID").name,A=F.get("ASSOCIATIONTYPE").name,U=F.get("ISCONTENTVISIBLE").name,P=F.get("OBJECTID").name;for(const e of c.fields)if("global-id"===e.type){b=n.field(e.name);break}let v=null,R=new $(new J({name:"percentalong",alias:"percentalong",type:"double"}),_.create("0",{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC})),M=new $(new J({name:"side",alias:"side",type:"string"}),_.create("''",{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC}));const B="globalid",G="globalId",H={};for(const e in j.lkp)H[e]=j.lkp[e].sourceId;const W=new k(new J({name:"classname",alias:"classname",type:"string"}),null,H);let Q="";switch(a){case"midspan":{Q=`((${D}='${b}') OR ( ${S}='${b}')) AND (${A} IN (5))`,W.codefield=_.create(`CASE WHEN (${D}='${b}') THEN ${C} ELSE ${L} END`,{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC});const e=q(V.findField(j.associations.fields,S));e.name=B,e.alias=B,v=new $(e,_.create(`CASE WHEN (${S}='${b}') THEN ${D} ELSE ${S} END`,{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC})),R=j.unVersion>=4?new z(V.findField(j.associations.fields,F.get("PERCENTALONG").name)):new $(new J({name:"percentalong",alias:"percentalong",type:"double"}),_.create("0",{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{Q=`((${D}='${b}') OR ( ${S}='${b}')) AND (${A} IN (4,6))`,W.codefield=_.create(`CASE WHEN (${D}='${b}') THEN ${C} ELSE ${L} END`,{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC});const e=q(V.findField(j.associations.fields,S));e.name=B,e.alias=B,v=new $(e,_.create(`CASE WHEN (${S}='${b}') THEN ${D} ELSE ${S} END`,{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC})),M=new $(new J({name:"side",alias:"side",type:"string"}),_.create(`CASE WHEN (${A}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let e=`${D}='@T'`,t=`${S}='@T'`;null!==I&&(e+=` AND ${x}=@A`,t+=` AND ${E}=@A`),Q="(("+e+") OR ("+t+"))",Q=T(Q,"@T",b??""),e=T(e,"@T",b??""),null!==I&&(e=T(e,"@A",I.toString()),Q=T(Q,"@A",I.toString())),W.codefield=_.create("CASE WHEN "+e+` THEN ${C} ELSE ${L} END`,{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC});const r=q(V.findField(j.associations.fields,S));r.name=B,r.alias=B,v=new $(r,_.create("CASE WHEN "+e+` THEN ${S} ELSE ${D} END`,{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC}));break}case"container":Q=`${D}='${b}' AND ${A} = 2`,null!==I&&(Q+=` AND ${x} = `+I.toString()),W.codefield=C,Q="( "+Q+" )",v=new O(V.findField(j.associations.fields,S),B,B);break;case"content":Q=`(${S}='${b}' AND ${A} = 2)`,null!==I&&(Q+=` AND ${E} = `+I.toString()),W.codefield=L,Q="( "+Q+" )",v=new O(V.findField(j.associations.fields,D),B,B);break;case"structure":Q=`(${D}='${b}' AND ${A} = 3)`,null!==I&&(Q+=` AND ${x} = `+I.toString()),W.codefield=C,Q="( "+Q+" )",v=new O(V.findField(j.associations.fields,S),B,G);break;case"attached":Q=`(${S}='${b}' AND ${A} = 3)`,null!==I&&(Q+=` AND ${E} = `+I.toString()),W.codefield=L,Q="( "+Q+" )",v=new O(V.findField(j.associations.fields,D),B,G);break;default:throw new m(e,p.InvalidParameter,t)}return w&&(Q="1 <> 1"),new V({parentfeatureset:j.associations,adaptedFields:[new z(V.findField(j.associations.fields,P)),new z(V.findField(j.associations.fields,U)),v,M,W,R],extraFilter:Q?_.create(Q,{fieldsIndex:j.associations.getFieldsIndex(),timeZone:j.associations.dateFieldsTimeZoneDefaultUTC}):null})}))},oe.signatures.push({name:"featuresetbyassociation",min:2,max:6}),oe.functions.groupby=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,i,n)=>{if(o(n,3,3,e,r),!l(n[0]))throw new m(e,p.InvalidParameter,r);const a=await n[0].load(),f=[],c=[];let y=!1,j=[];if(u(n[1]))j.push(n[1]);else if(n[1]instanceof t)j.push(n[1]);else if(I(n[1]))j=n[1];else{if(!w(n[1]))throw new m(e,p.InvalidParameter,r);j=n[1].toArray()}for(const s of j)if(u(s)){const e=_.create(d(s),{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}),t=!0===W(e)?d(s):"%%%%FIELDNAME";f.push({name:t,expression:e}),"%%%%FIELDNAME"===t&&(y=!0)}else{if(!(s instanceof t))throw new m(e,p.InvalidParameter,r);{const t=s.hasField("name")?s.field("name"):"%%%%FIELDNAME",i=s.hasField("expression")?s.field("expression"):"";if("%%%%FIELDNAME"===t&&(y=!0),!t)throw new m(e,p.InvalidParameter,r);f.push({name:t,expression:_.create(i||t,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})})}}if(j=[],u(n[2]))j.push(n[2]);else if(I(n[2]))j=n[2];else if(w(n[2]))j=n[2].toArray();else{if(!(n[2]instanceof t))throw new m(e,p.InvalidParameter,r);j.push(n[2])}for(const s of j){if(!(s instanceof t))throw new m(e,p.InvalidParameter,r);{const t=s.hasField("name")?s.field("name"):"",i=s.hasField("statistic")?s.field("statistic"):"",o=s.hasField("expression")?s.field("expression"):"";if(!t||!i||!o)throw new m(e,p.InvalidParameter,r);c.push({name:t,statistic:i.toLowerCase(),expression:_.create(o,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})})}}if(y){const e={};for(const t of a.fields)e[t.name.toLowerCase()]=1;for(const t of f)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);for(const t of c)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of f)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const t of f)await X(t.expression,oe,e);for(const t of c)await X(t.expression,oe,e);return n[0].groupby(f,c)}))},oe.signatures.push({name:"groupby",min:3,max:3}),oe.functions.distinct=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,n,a)=>{if(l(a[0])){o(a,2,2,e,r);const s=await a[0].load(),i=[];let n=[];if(u(a[1]))n.push(a[1]);else if(a[1]instanceof t)n.push(a[1]);else if(I(a[1]))n=a[1];else{if(!w(a[1]))throw new m(e,p.InvalidParameter,r);n=a[1].toArray()}let l=!1;for(const o of n)if(u(o)){const e=_.create(d(o),{fieldsIndex:s.getFieldsIndex(),timeZone:s.dateFieldsTimeZoneDefaultUTC}),t=!0===W(e)?d(o):"%%%%FIELDNAME";i.push({name:t,expression:e}),"%%%%FIELDNAME"===t&&(l=!0)}else{if(!(o instanceof t))throw new m(e,p.InvalidParameter,r);{const t=o.hasField("name")?o.field("name"):"%%%%FIELDNAME",n=o.hasField("expression")?o.field("expression"):"";if("%%%%FIELDNAME"===t&&(l=!0),!t)throw new m(e,p.InvalidParameter,r);i.push({name:t,expression:_.create(n||t,{fieldsIndex:s.getFieldsIndex(),timeZone:s.dateFieldsTimeZoneDefaultUTC})})}}if(l){const e={};for(const t of s.fields)e[t.name.toLowerCase()]=1;for(const t of i)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of i)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const t of i)await X(t.expression,oe,e);return a[0].groupby(i,[])}return function(e){if(1===e.length){if(I(e[0]))return i("distinct",e[0],-1);if(w(e[0]))return i("distinct",e[0].toArray(),-1)}return i("distinct",e,-1)}(a)}))},oe.functions.getfeaturesetinfo=function(e,r){return oe.standardFunctionAsync(e,r,(async(s,i,n)=>{if(o(n,1,1,e,r),!l(n[0]))return null;const a=await n[0].getFeatureSetInfo();return a?t.convertObjectToArcadeDictionary({layerId:a.layerId,layerName:a.layerName,itemId:a.itemId,serviceLayerUrl:a.serviceLayerUrl,webMapLayerId:a.webMapLayerId??null,webMapLayerTitle:a.webMapLayerTitle??null,className:null,objectClassId:null},c(e),!1,!1):null}))},oe.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),oe.functions.filterbysubtypecode=function(e,t){return oe.standardFunctionAsync(e,t,(async(r,s,i)=>{if(o(i,2,2,e,t),l(i[0])){const r=await i[0].load(),s=i[1];if(!x(s))throw new m(e,p.InvalidParameter,t);if(r.subtypeField){const e=_.create(`${r.subtypeField}= ${i[1]}`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});return new A({parentfeatureset:i[0],whereclause:e})}if(null===r.typeIdField||""===r.typeIdField)throw new m(e,p.FeatureSetDoesNotHaveSubtypes,t);const o=_.create(`${r.typeIdField}= ${i[1]}`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});return new A({parentfeatureset:i[0],whereclause:o})}throw new m(e,p.InvalidParameter,t)}))},oe.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{oe as registerFunctions};
