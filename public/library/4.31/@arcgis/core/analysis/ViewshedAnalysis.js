/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import"../geometry.js";import{A as e}from"../chunks/Analysis.js";import s from"./Viewshed.js";import r from"../core/Collection.js";import{r as o,c as i}from"../chunks/collectionUtils.js";import{c as n}from"../chunks/Cyclical.js";import{d as p,c as m}from"../chunks/mathUtils.js";import{watch as c,syncAndInitial as u}from"../core/reactiveUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"../chunks/Logger.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import{projectOrLoadMany as h}from"../geometry/projection.js";import j from"../geometry/Extent.js";import"../chunks/ensureType.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../chunks/metadata.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../core/Error.js";import"../config.js";import"../chunks/reader.js";import"../geometry/SpatialReference.js";import"../chunks/unitUtils.js";import"../chunks/jsonMap.js";import"../chunks/assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/writer.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/boundsUtils.js";import"../chunks/aaBoundingRect.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Clonable.js";import"../core/Identifiable.js";import"../chunks/featureReferenceUtils.js";import"../chunks/vec3.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../chunks/ray.js";import"../chunks/mat3.js";import"../chunks/mat3f64.js";import"../chunks/plane.js";import"../chunks/mat4f64.js";import"../chunks/quatf64.js";import"../chunks/vec2f64.js";import"../chunks/vec4f64.js";import"../chunks/mathUtils2.js";import"../chunks/intersectorUtils.js";import"../chunks/boundedPlane.js";import"../chunks/mat4.js";import"../chunks/lineSegment.js";import"../chunks/intersectorUtilsConversions.js";import"../chunks/aaBoundingBox.js";import"../chunks/sphere.js";import"../chunks/vec4.js";import"../chunks/Intersector.js";import"../chunks/Intersector2.js";import"../core/Evented.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/asyncUtils.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";const d=r.ofType(s);let k=class extends e{constructor(t){super(t),this.type="viewshed",this._extent=null}initialize(){this.addHandles(c((()=>this._computeExtent()),(t=>{null==t.pending&&(this._extent=t.extent)}),u))}get viewsheds(){return this._get("viewsheds")||new d}set viewsheds(t){this._set("viewsheds",o(t,this.viewsheds,d))}get spatialReference(){for(const t of this.viewsheds)if(null!=t.observer)return t.observer.spatialReference;return null}get extent(){return this._extent}get requiredPropertiesForEditing(){return this.viewsheds.items.map((({observer:t})=>t))}async waitComputeExtent(){const t=this._computeExtent();null!=t.pending&&await t.pending}_computeExtent(){const{spatialReference:t}=this;if(null==t)return{pending:null,extent:null};const e=this.viewsheds.filter((t=>null!=t.observer)),s=e.map((t=>t.observer)).toArray(),r=h(s,t);return null!=r.pending?{pending:r.pending,extent:null}:{pending:null,extent:r.geometries.map(((t,s)=>{const r=e.at(s);return null!=t&&null!=r?this._computeViewshedExtent(this.viewsheds.at(s),t):null})).filter((t=>null!=t)).reduce(((t,e)=>{return r=e,null==(s=t)?r:null==r?s:s.union(r);var s,r}),null)}}_computeViewshedExtent(t,e){const{farDistance:s,heading:r,tilt:o,horizontalFieldOfView:i,verticalFieldOfView:c}=t,{spatialReference:u}=e,l=i/2,a=c/2,h=s/u.metersPerUnit,d=[n.normalize(r-l),r,n.normalize(r+l)],k=j.fromPoint(e),y=t=>{const e=d.map((e=>n.normalize(e-t)));if(e[0]>e[2]||360===i)return h;const s=e.map((t=>Math.abs(t>180?360-t:t))).reduce(((t,e)=>t>e?e:t));return s>90?0:h*Math.cos(p(s))};k.xmax+=y(90),k.xmin-=y(-90),k.ymax+=y(0),k.ymin-=y(180);const v=e.z;if(null!=v){let t=v,e=v;const r=o-90,i=m(r+a,-90,90),n=m(r-a,-90,90),p=u?.isGeographic?s:h;t+=p*g(i),e+=p*g(n);const c=f(a)*p,j=g(r)*c*(1-f(l));o<90&&(t-=j),o>90&&(e-=j),k.zmax=Math.max(t,v),k.zmin=Math.min(e,v)}return k}clear(){this.viewsheds.removeAll()}};function f(t){return Math.cos(p(t))}function g(t){return Math.sin(p(t))}t([l({type:["viewshed"]})],k.prototype,"type",void 0),t([l({cast:i,type:d,nonNullable:!0})],k.prototype,"viewsheds",null),t([l({readOnly:!0})],k.prototype,"spatialReference",null),t([l()],k.prototype,"_extent",void 0),t([l({readOnly:!0})],k.prototype,"extent",null),t([l({readOnly:!0})],k.prototype,"requiredPropertiesForEditing",null),k=t([a("esri.analysis.ViewshedAnalysis")],k);const y=k;export{y as default};
