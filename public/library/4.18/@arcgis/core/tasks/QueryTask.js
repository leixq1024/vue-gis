/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import"../chunks/ArrayPool.js";import{h as e}from"../chunks/object.js";import"../chunks/deprecate.js";import"../core/lang.js";import"../config.js";import{i as o}from"../chunks/Logger.js";import"../chunks/string.js";import"../chunks/metadata.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import"../core/Accessor.js";import"../chunks/PropertyOrigin.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../chunks/Message.js";import"../core/Error.js";import{n as r}from"../chunks/compilerUtils.js";import"../chunks/ensureType.js";import{subclass as i}from"../core/accessorSupport/decorators/subclass.js";import"../chunks/Evented.js";import"../core/Collection.js";import"../chunks/collectionUtils.js";import"../chunks/JSONSupport.js";import"../chunks/Promise.js";import"../chunks/Loadable.js";import{addProxy as n}from"../core/urlUtils.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/jsonMap.js";import"../chunks/enumeration.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../chunks/resourceExtension.js";import"../chunks/persistableUrlUtils.js";import"../geometry/SpatialReference.js";import"../chunks/locale.js";import"../chunks/number.js";import"../intl.js";import{addTokenParameter as a}from"../kernel.js";import p from"../request.js";import"../chunks/assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../chunks/Ellipsoid.js";import"../geometry/support/webMercatorUtils.js";import m from"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import"../chunks/mathUtils2.js";import"../chunks/colorUtils.js";import"../Color.js";import"../chunks/zmUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/domains.js";import"../chunks/arcadeOnDemand.js";import"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"../chunks/date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"../chunks/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"../chunks/Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import"../chunks/screenUtils.js";import"../chunks/opacityUtils.js";import"../chunks/materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/utils.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"../chunks/colors.js";import"../chunks/Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"../chunks/Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../chunks/Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../chunks/urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols/support/jsonUtils.js";import"../chunks/uid.js";import"../Graphic.js";import"../chunks/unitUtils.js";import"../geometry/support/normalizeUtils.js";import"../chunks/timeUtils.js";import"../TimeExtent.js";import"../chunks/fieldType.js";import{g as u}from"../chunks/zscale.js";import"../chunks/queryZScale.js";import"../layers/support/Field.js";import l from"./support/FeatureSet.js";import{D as c}from"../chunks/DataLayerSource.js";import h from"./support/AttachmentQuery.js";import d from"./support/Query.js";import"./support/StatisticDefinition.js";import y from"./support/RelationshipQuery.js";import j from"./Task.js";import"../chunks/OptimizedGeometry.js";import{u as f,c as b}from"../chunks/featureConversionUtils.js";import"../chunks/pbf.js";import"../chunks/pbfQueryUtils.js";import{m as S,e as g,a as k,b as P,c as C,d as D}from"../chunks/query.js";import I from"../layers/support/AttachmentInfo.js";function R(t,e){return e}function M(t,e,o,s){switch(o){case 0:return U(t,e+s,0);case 1:return"lowerLeft"===t.originPosition?U(t,e+s,1):function({translate:t,scale:e},o,s){return t[s]-o*e[s]}(t,e+s,1)}}function x(t,e,o,s){switch(o){case 2:return U(t,e,2);default:return M(t,e,o,s)}}function O(t,e,o,s){switch(o){case 2:return U(t,e,3);default:return M(t,e,o,s)}}function F(t,e,o,s){switch(o){case 3:return U(t,e,3);default:return x(t,e,o,s)}}function U({translate:t,scale:e},o,s){return t[s]+o*e[s]}class G{constructor(t){this.options=t,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],this.previousCoordinate=[0,0],this.transform=null,this.applyTransform=R,this.lengths=[],this.currentLengthIndex=0,this.toAddInCurrentPath=0,this.vertexDimension=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,this.AttributesConstructor=function(){}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(t){if(this.options.applyTransform&&(t.transform=null),this.AttributesConstructor=function(){},this.coordinateBuffer=null,this.lengths.length=0,!t.hasZ)return;const e=u(t.geometryType,this.options.sourceSpatialReference,t.spatialReference);if(e)for(const o of t.features)e(o.geometry)}createSpatialReference(){return{}}addField(t,e){t.fields.push(e);const o=t.fields.map((t=>t.name));this.AttributesConstructor=function(){for(const t of o)this[t]=null}}addFeature(t,e){t.features.push(e)}prepareFeatures(t){switch(this.transform=t.transform,this.options.applyTransform&&t.transform&&(this.applyTransform=this.deriveApplyTransform(t)),this.vertexDimension=2,t.hasZ&&this.vertexDimension++,t.hasM&&this.vertexDimension++,t.geometryType){case"esriGeometryPoint":this.addCoordinate=(t,e,o)=>this.addCoordinatePoint(t,e,o),this.createGeometry=t=>this.createPointGeometry(t);break;case"esriGeometryPolygon":this.addCoordinate=(t,e,o)=>this.addCoordinatePolygon(t,e,o),this.createGeometry=t=>this.createPolygonGeometry(t);break;case"esriGeometryPolyline":this.addCoordinate=(t,e,o)=>this.addCoordinatePolyline(t,e,o),this.createGeometry=t=>this.createPolylineGeometry(t);break;case"esriGeometryMultipoint":this.addCoordinate=(t,e,o)=>this.addCoordinateMultipoint(t,e,o),this.createGeometry=t=>this.createMultipointGeometry(t);break;default:r(t.geometryType)}}createFeature(){return this.lengths.length=0,this.currentLengthIndex=0,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,{attributes:new this.AttributesConstructor}}addLength(t,e,o){0===this.lengths.length&&(this.toAddInCurrentPath=e),this.lengths.push(e)}addQueryGeometry(t,e){const{queryGeometry:o,queryGeometryType:s}=e,r=f(o.clone(),o,!1,!1,this.transform),i=b(r,s,!1,!1);t.queryGeometryType=s,t.queryGeometry={...i}}createPointGeometry(t){const e={x:0,y:0,spatialReference:t.spatialReference};return t.hasZ&&(e.z=0),t.hasM&&(e.m=0),e}addCoordinatePoint(t,e,o){switch(e=this.applyTransform(this.transform,e,o,0),o){case 0:t.x=e;break;case 1:t.y=e;break;case 2:"z"in t?t.z=e:t.m=e;break;case 3:t.m=e}}transformPathLikeValue(t,e){let o=0;return e<=1&&(o=this.previousCoordinate[e],this.previousCoordinate[e]+=t),this.applyTransform(this.transform,t,e,o)}addCoordinatePolyline(t,e,o){this.dehydratedAddPointsCoordinate(t.paths,e,o)}addCoordinatePolygon(t,e,o){this.dehydratedAddPointsCoordinate(t.rings,e,o)}addCoordinateMultipoint(t,e,o){0===o&&t.points.push([]);const s=this.transformPathLikeValue(e,o);t.points[t.points.length-1].push(s)}createPolygonGeometry(t){return{rings:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}createPolylineGeometry(t){return{paths:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}createMultipointGeometry(t){return{points:[],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}dehydratedAddPointsCoordinate(t,e,o){0===o&&0==this.toAddInCurrentPath--&&(t.push([]),this.toAddInCurrentPath=this.lengths[++this.currentLengthIndex]-1,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0);const s=this.transformPathLikeValue(e,o),r=t[t.length-1];0===o&&(this.coordinateBufferPtr=0,this.coordinateBuffer=new Array(this.vertexDimension),r.push(this.coordinateBuffer)),this.coordinateBuffer[this.coordinateBufferPtr++]=s}deriveApplyTransform(t){const{hasZ:e,hasM:o}=t;return e&&o?F:e?x:o?O:M}}function T(t){const e=t.toJSON();return e.attachmentTypes&&(e.attachmentTypes=e.attachmentTypes.join(",")),e.keywords&&(e.keywords=e.keywords.join(",")),e.globalIds&&(e.globalIds=e.globalIds.join(",")),e.objectIds&&(e.objectIds=e.objectIds.join(",")),e.size&&(e.size=e.size.join(",")),e}function L(t,e){const o={};for(const s of t){const{parentObjectId:t,parentGlobalId:r,attachmentInfos:i}=s;for(const s of i){const{id:i}=s,p=n(a(`${e}/${t}/attachments/${i}`)),m=I.fromJSON(s);m.set({url:p,parentObjectId:t,parentGlobalId:r}),o[t]?o[t].push(m):o[t]=[m]}}return o}function q(t,e){const o=t.toJSON();return o.objectIds&&(o.objectIds=o.objectIds.join(",")),o.orderByFields&&(o.orderByFields=o.orderByFields.join(",")),!o.outFields||null!=e&&e.returnCountOnly?delete o.outFields:-1!==o.outFields.indexOf("*")?o.outFields="*":o.outFields=o.outFields.join(","),o.outSpatialReference&&(o.outSR=o.outSR.wkid||JSON.stringify(o.outSR.toJSON()),delete o.outSpatialReference),o.dynamicDataSource&&(o.layer=JSON.stringify({source:o.dynamicDataSource}),delete o.dynamicDataSource),o}async function v(t,e,o={},s){const r=S({...t.query,f:"json",...s,...q(e,s)});return p(t.path+"/queryRelatedRecords",{...o,query:{...o.query,...r}})}let A=class extends j{constructor(t){super(t),this.dynamicDataSource=null,this.format="json",this.gdbVersion=null,this.sourceSpatialReference=null}execute(t,e){return this.executeJSON(t,e).then((t=>l.fromJSON(t)))}async executeJSON(t,o){var s;const r={...this.requestOptions,...o},i=this._normalizeQuery(t),n=null!=(null==(s=t.outStatistics)?void 0:s[0]),a=e("featurelayer-pbf-statistics"),p=!n||a;let m;if("pbf"===this.format&&p){const t=!i.quantizationParameters;try{m=(await g(this.parsedUrl,i,new G({sourceSpatialReference:this.sourceSpatialReference,applyTransform:t}),r)).data}catch(t){if("query:parsing-pbf"!==t.name)throw t;this.format="json"}}if("json"===this.format||!p){m=(await k(this.parsedUrl,i,this.sourceSpatialReference,r)).data}return this._normalizeFields(m.fields),m}executeForCount(t,e){return P(this.parsedUrl,this._normalizeQuery(t),{...this.requestOptions,...e}).then((t=>t.data.count))}executeForExtent(t,e){return C(this.parsedUrl,this._normalizeQuery(t),{...this.requestOptions,...e}).then((t=>({count:t.data.count,extent:m.fromJSON(t.data.extent)})))}executeForIds(t,e){return D(this.parsedUrl,this._normalizeQuery(t),{...this.requestOptions,...e}).then((t=>t.data.objectIds))}executeRelationshipQuery(t,e){return t=y.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),async function(t,e,o){const s=await v(t,e,o),r=s.data,i=r.geometryType,n=r.spatialReference,a={};for(const t of r.relatedRecordGroups){const e={fields:void 0,objectIdFieldName:void 0,geometryType:i,spatialReference:n,hasZ:!!r.hasZ,hasM:!!r.hasM,features:t.relatedRecords};if(null!=t.objectId)a[t.objectId]=e;else for(const o in t)t.hasOwnProperty(o)&&"relatedRecords"!==o&&(a[t[o]]=e)}return{...s,data:a}}(this.parsedUrl,t,{...this.requestOptions,...e}).then((t=>{const e=t.data,o={};return Object.keys(e).forEach((t=>o[t]=l.fromJSON(e[t]))),o}))}executeRelationshipQueryForCount(t,e){return t=y.from(t),(this.gdbVersion||this.dynamicDataSource)&&((t=t.clone()).gdbVersion=t.gdbVersion||this.gdbVersion,t.dynamicDataSource=t.dynamicDataSource||this.dynamicDataSource),async function(t,e,o){const s=await v(t,e,o,{returnCountOnly:!0}),r=s.data,i={};for(const t of r.relatedRecordGroups)null!=t.objectId&&(i[t.objectId]=t.count);return{...s,data:i}}(this.parsedUrl,t,{...this.requestOptions,...e}).then((t=>t.data))}executeAttachmentQuery(t,e){return function(t,e,o){let s={query:S({...t.query,f:"json",...T(e)})};return o&&(s={...o,...s,query:{...o.query,...s.query}}),p(t.path+"/queryAttachments",s)}(this.parsedUrl,h.from(t),{...this.requestOptions,...e}).then((t=>L(t.data.attachmentGroups,this.parsedUrl.path)))}_normalizeQuery(t){const e=d.from(t);if(!this.gdbVersion&&!this.dynamicDataSource)return e;const o=e===t?e.clone():e;return o.gdbVersion=t.gdbVersion||this.gdbVersion,o.dynamicDataSource=t.dynamicDataSource?c.from(t.dynamicDataSource):this.dynamicDataSource,o}_normalizeFields(t){if(o(this.fieldsIndex)&&o(t))for(const e of t){const t=this.fieldsIndex.get(e.name);t&&Object.assign(e,t.toJSON())}}};t([s({type:c})],A.prototype,"dynamicDataSource",void 0),t([s()],A.prototype,"fieldsIndex",void 0),t([s()],A.prototype,"format",void 0),t([s()],A.prototype,"gdbVersion",void 0),t([s()],A.prototype,"sourceSpatialReference",void 0),A=t([i("esri.tasks.QueryTask")],A);var w=A;export default w;export{L as p};
