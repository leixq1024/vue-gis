/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../chunks/object.js";import"../../chunks/deprecate.js";import"../../core/lang.js";import"../../config.js";import{b as t,i as o,L as i,u as r,g as s}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../chunks/Message.js";import n from"../../core/Error.js";import{n as p}from"../../chunks/compilerUtils.js";import"../../chunks/ensureType.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import{E as h}from"../../chunks/Evented.js";import l from"../../core/Collection.js";import"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/Promise.js";import"../../chunks/Loadable.js";import"../../core/urlUtils.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import"../../chunks/number.js";import"../../intl.js";import"../../kernel.js";import"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import d from"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalUser.js";import"../../portal/Portal.js";import"../../chunks/mathUtils2.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/vec3.js";import"../../chunks/mathUtils.js";import"../../chunks/colorUtils.js";import"../../Color.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import{d as m}from"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import"../../layers/support/fieldUtils.js";import"../../popup/content/Content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/CustomContent.js";import"../../chunks/date.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/FieldInfo.js";import"../../popup/content/FieldsContent.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/MediaContent.js";import"../../popup/content/TextContent.js";import"../../popup/content.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/RelatedRecordsInfo.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../PopupTemplate.js";import"../../symbols/Symbol.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol3DLayer.js";import{c as u,a as y}from"../../chunks/screenUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/materialUtils.js";import"../../symbols/edges/Edges3D.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/utils.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import v from"../../symbols/SimpleLineSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/patterns/StylePattern3D.js";import"../../symbols/FillSymbol3DLayer.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/Symbol3D.js";import"../../chunks/Thumbnail.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import g from"../../symbols/SimpleFillSymbol.js";import _ from"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import{s as G}from"../../symbols/support/jsonUtils.js";import"../../chunks/uid.js";import f from"../../Graphic.js";import w from"../../core/Handles.js";import"../../layers/Layer.js";import{e as b}from"../../chunks/unitUtils.js";import"../../chunks/lengthUtils.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import{watch as k,on as j,init as C,when as x,whenNotOnce as S}from"../../core/watchUtils.js";import"../../chunks/fieldType.js";import"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/projection.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../core/HandleOwner.js";import"../../chunks/_commonjsHelpers.js";import"../../geometry/support/geodesicUtils.js";import E from"../../geometry/Circle.js";import"../../chunks/geometryEngineBase.js";import"../../chunks/hydrated.js";import"../../geometry/geometryEngine.js";import"../../chunks/vec4f64.js";import"../../chunks/quatf64.js";import"../../chunks/mat3.js";import"../../chunks/BufferView.js";import"../../chunks/vec2.js";import"../../chunks/vec4.js";import"../../chunks/quat.js";import"../../chunks/domUtils.js";import"../../chunks/widgetUtils.js";import"../../chunks/projector.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../../chunks/renderable.js";import"../../chunks/vmEvent.js";import"../../chunks/index.js";import"../support/widget.js";import"../Widget.js";import"../../chunks/zscale.js";import"../../chunks/queryZScale.js";import"../../layers/support/Field.js";import"../../tasks/support/FeatureSet.js";import"../../chunks/BlendLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../chunks/DataLayerSource.js";import"../../tasks/support/AttachmentQuery.js";import"../../tasks/support/Query.js";import"../../tasks/support/StatisticDefinition.js";import"../../tasks/support/RelationshipQuery.js";import"../../chunks/GraphicsCollection.js";import T from"../../layers/GraphicsLayer.js";import"../../tasks/Task.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/featureConversionUtils.js";import"../../tasks/QueryTask.js";import"../../chunks/pbf.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/query.js";import"../../layers/support/AttachmentInfo.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/Queue.js";import{V as I}from"../../chunks/InputManager.js";import{i as A}from"../../chunks/interactiveToolUtils.js";import"../../chunks/throttle.js";import"../Attachments.js";import"../Attachments/AttachmentsViewModel.js";import"../Feature/FeatureViewModel.js";import"../Feature.js";import"../../chunks/AnchorElementViewModel.js";import"../Spinner/SpinnerViewModel.js";import"../Popup.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../../chunks/GoTo.js";import"../Popup/PopupViewModel.js";import{c as O}from"../../chunks/screenUtils2.js";import"../../chunks/quantizationUtils.js";import"../../chunks/mat2d.js";import"../../chunks/dehydratedFeatures.js";import"../../chunks/ElevationProvider.js";import"../../chunks/mat2df64.js";import"../../chunks/vec2f64.js";import"../../chunks/PointerClickHoldAndDrag.js";import"../../chunks/requestImageUtils.js";import"../../chunks/PiUtils.glsl.js";import"../../chunks/Program.js";import"../../chunks/isWebGL2Context.js";import"../../chunks/glUtil.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/mat4f32.js";import"../../chunks/vec3f32.js";import"../../chunks/geometryUtils.js";import"../../chunks/ColorMaterial.js";import"../../chunks/Util.js";import"../../chunks/Geometry.js";import"../../chunks/VertexArrayObject.js";import"../../chunks/sdfPrimitives.js";import"../../chunks/Object3D.js";import"../../chunks/DefaultTextureUnits.js";import"../../chunks/GLMaterialTexture.js";import"../../chunks/VerticalOffset.glsl.js";import"../../chunks/elevationAlignmentUtils.js";import"../../chunks/RenderingContext.js";import"../../chunks/CameraSpace.glsl.js";import"../../chunks/Texture.js";import"../../chunks/vec4f32.js";import"../../views/draw/DrawAction.js";import"../../chunks/Keys.js";import"../../views/draw/MultipointDrawAction.js";import{S as L}from"../../chunks/DrawTool.js";import{c as D,h as U}from"../../chunks/elevationInfoUtils.js";import"../../chunks/InteractiveToolBase.js";import"../../chunks/RightAngleQuadVisualElement.js";import"../../chunks/LaserLineRenderer.js";import"../../views/draw/PointDrawAction.js";import"../../views/draw/PolygonDrawAction.js";import"../../views/draw/PolylineDrawAction.js";import{c as M,a as H,b as P,d as R,e as F,f as V,g as K,h as W,m as z}from"../../views/draw/SegmentDrawAction.js";import q from"../../views/draw/Draw.js";function B(e){switch(e){case 0:break;case 1:return"not owned by a graphics layer";case 2:return"no geometry";case 3:return"the geometry type is not supported";case 4:return"the elevation mode is not supported";case 5:return"the symbol type is not supported"}return""}function Z(e){var o;if("graphics"!==(null==(o=e.layer)?void 0:o.type))return 1;if(t(e.geometry))return 2;switch(e.geometry.type){case"polygon":case"point":case"polyline":break;case"multipoint":case"extent":case"mesh":default:return 3}return"on-the-ground"!==D(e)&&U(e)?4:0}function Q(e){var o;if("graphics"!==(null==(o=e.layer)?void 0:o.type))return 1;const i=e.geometry;if(t(i))return 2;switch(i.type){case"polygon":if(i instanceof E)return 3;break;case"polyline":break;case"point":case"multipoint":case"extent":case"mesh":default:return 3}return"on-the-ground"!==D(e)&&U(e)?4:0}function N(e,t){if(!t||!e||!e.map)return;const{map:o}=e;o.layers.find((e=>e===t))||o.add(t)}let $=class extends h.EventedAccessor{constructor(e){super(e),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw":case"draw-3d":return null;default:p(this.activeComponent)}return null}addToHistory(e){this.history.redo=[],this.history.undo.push(e)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this.reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}reset(){this.activeComponent.reset()}refreshComponent(){const e=this.activeComponent;e&&("box"!==e.type&&"reshape"!==e.type||e.refresh())}set undo(e){this._set("undo",(()=>{this.canUndo()&&e()}))}set redo(e){this._set("redo",(()=>{this.canRedo()&&e()}))}};e([a()],$.prototype,"activeComponent",void 0),e([a()],$.prototype,"cancelled",void 0),e([a()],$.prototype,"history",void 0),e([a({dependsOn:["activeComponent"]})],$.prototype,"tool",null),e([a()],$.prototype,"type",void 0),e([a()],$.prototype,"canUndo",null),e([a()],$.prototype,"canRedo",null),e([a()],$.prototype,"onEnd",void 0),e([a()],$.prototype,"undo",null),e([a()],$.prototype,"redo",null),e([a()],$.prototype,"toggleTool",void 0),e([a()],$.prototype,"addToSelection",void 0),e([a()],$.prototype,"removeFromSelection",void 0),$=e([c("esri.widgets.Sketch.support.OperationHandle")],$);const J=i.getLogger("esri.widgets.Sketch.SketchViewModel"),Y={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Control",cancelKey:"Escape",deleteKeys:["Backspace","Delete"],complete:"c",pan:" "},X={defaultZ:0},ee={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform",enableZ:!0,enableMoveGraphic:!0};let te=class extends h.EventedAccessor{constructor(e){super(e),this._activeFillGraphic=null,this._activeLineGraphic=null,this._centerIndicatorGraphic=null,this._centerSymbol=new _({style:"cross",size:6,color:[255,255,255]}),this._defaultSegmentOffset=48,this._numUpdating=0,this._handles=new w,this._internalGraphicsLayer=new T({listMode:"hide"}),this._lineGraphic=null,this._operationHandle=null,this._vertexGraphics=[],this._viewHandles=new w,this._doUnnormalization=!1,this.activeFillSymbol=new g({style:"solid",color:[150,150,150,.2],outline:{color:[50,50,50],width:0}}),this.activeLineSymbol=new v({color:[255,127,0,1],width:2}),this.activeVertexSymbol=new _({style:"circle",size:6,color:[255,127,0,1],outline:{color:[50,50,50],width:1}}),this.layer=null,this.pointSymbol=new _({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new g({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new v({color:[130,130,130,1],width:2}),this.updateGraphics=new l,this.updateOnGraphicClick=!0,this.updatePointSymbol=new _({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new g({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new v({color:[12,207,255],width:2}),this.vertexSymbol=new _({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.snappingOptions=new L,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=X,this.defaultUpdateOptions=ee}initialize(){this._handles.add([k(this,"layer",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=o(this.layer)?this.layer.elevationInfo:null})),j(this,"view.map.layers","change",(e=>{e.removed.indexOf(this.layer)>=0&&this.cancel()})),j(this,"layer.graphics","change",(e=>{if(o(this._operationHandle))for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())})),C(this,"layer.elevationInfo",(()=>{this.cancel(),this._internalGraphicsLayer.elevationInfo=o(this.layer)?this.layer.elevationInfo:null}),!0)])}destroy(){this.cancel(),this._handles.removeAll(),this._handles=null,this._viewHandles.removeAll(),this._viewHandles=null,this._removeDefaultLayer(),this._draw&&this._draw.destroy(),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get _draw(){return"ready"===this.state||"active"===this.state?new q({view:this.view}):null}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return this.view&&"3d"===this.view.type&&o(this.activeComponent)&&"draw-3d"===this.activeComponent.type?r(this.activeComponent.createGraphic):this._get("createGraphic")}set defaultCreateOptions(e){this._set("defaultCreateOptions",{...X,...e})}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...ee,...e})}get state(){var e;const t=!(null==(e=this.view)||!e.ready||!this.layer),o=this._operationHandle;return t&&o?"active":t?"ready":"disabled"}get view(){return this._get("view")}set view(e){const t=this._get("view");if(t){const{container:e,map:o}=t;e&&(t.cursor=null),o&&o.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;const o="view-ready";this._handles.remove(o),e&&this._handles.add(x(e,"ready",(t=>{this._viewHandles.removeAll(),t&&this._viewHandles.add(this._generateViewHandles(e))}),!0),o),this._set("view",e)}cancel(){this._moduleLoaderAbortController&&(this._moduleLoaderAbortController.abort(),this._moduleLoaderAbortController=null),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:t}=this;if("active"===e&&t.length){const{activeTool:e,layer:o}=this,i=t.toArray();o.removeMany(i),this.cancel(),this._emitDeleteEvent({graphics:i,tool:e})}}async create(e,o){if("disabled"===this.state)return this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),void(this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."));if(this.cancel(),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");const i=await this._setupCreateOperation(e,o);if(t(i)||this.destroyed)return;N(this.view,this._internalGraphicsLayer);i.on("complete",(()=>{if(i===this._operationHandle){const t=this.createGraphic,o=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),i.cancelled||null==t||this.layer.add(t),this.emit("create",{graphic:t,state:o?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}})),this._operationHandle=i,this.view.ready&&A(this.view)&&this.view.focus()}async update(e,o){const{layer:i,state:r,view:s}=this;if("disabled"===r)return i||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),void(s||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."));this.cancel();const a=Array.isArray(e)?e:[e];if(null==e||!a||!a.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(a.some((e=>e.layer!==i?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):t(e.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===s.type&&!s.spatialReference.equals(e.geometry.spatialReference)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0))))return;const n=await this._setupUpdateOperation(a,o);t(n)||ae(n)||(N(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(n,o),this.emit("update",{graphics:a,state:"start",aborted:!1,tool:n.tool,toolEventInfo:null,type:"update"}))}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(e){const t=[];switch(this.view.type){case"2d":{const r=await this.view.hitTest(e);if(r.results.length>0){const e=r.results[0];if(e.graphic){var o,i;const r=e.graphic;"vector-tile"!==(null==(o=r.layer)?void 0:o.type)&&"imagery"!==(null==(i=r.layer)?void 0:i.type)&&t.push(e)}}}break;case"3d":{const o=[this.view.map.ground];this.view.map.allLayers.forEach((e=>{"integrated-mesh"===e.type&&o.push(e)}));const i=await this.view.hitTest(e,{exclude:o});if(i.results.length>0){const e=i.results[0];(!i.ground.mapPoint||this.view.map.ground.opacity<1||i.ground.distance-e.distance>-Math.min(3*i.ground.distance,"global"===this.view.viewingMode?b(this.view.renderCoordsHelper.spatialReference).radius/this.view.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY))&&t.push(e)}}}return{screenPoint:e,results:t}}_generateViewHandles(e){return[e.on("immediate-click",(t=>{const{_operationHandle:i,defaultUpdateOptions:r,layer:s,state:a,updateGraphics:n,updateOnGraphicClick:p}=this,c="active"===a&&"create"===i.type;"disabled"!==a&&!c&&p&&(this._beginAsyncOperation(),this._getFirstHit(O(t)).then((o=>{const i=o.results;if(i.length)for(let o=0;o<i.length;++o){const r=i[o];if(r.graphic){const o=r.graphic;if(n.indexOf(o)>-1||o.layer===s)return t.stopPropagation(),o;"2d"!==e.type||this._isComponentGraphic(o)||"active"!==a||this.cancel()}}else"active"===a&&this.cancel();return null})).then((e=>o(e)&&-1===n.indexOf(e)?this.update([e],{...r}):null)).then((()=>{this._endAsyncOperation()})))}),I.WIDGET)]}async _setupCreateOperation(e,o){if(!e)return null;const i={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...o};let r;if("2d"===this.view.type)switch(e){case"point":r=this._setupCreatePointOperation(e,i);break;case"multipoint":r=this._setupCreateMultipointOperation(e,null);break;case"polygon":case"polyline":r=this._setupCreatePolyOperation(e,i);break;case"rectangle":r=this._setupCreateRectangleOperation(e,i);break;case"circle":r=this._setupCreateCircleOperation(e,i)}else{const o=await this._setupCreate3DOperation(e,this.view,i);if(t(o)||ae(o))return null;r=o}return r}async _setupCreate3DOperation(e,i,s){if("multipoint"===e)return null;const a={point:this.pointSymbol,multipoint:null,polyline:this.polylineSymbol,polygon:this.polygonSymbol,rectangle:this.polygonSymbol,circle:this.polygonSymbol}[e];this._removeCreateOperationGraphics();const n="rectangle"!==e,p="rectangle"!==e;this.snappingOptions.selfEnabledToggled=!1;const c={view:i,mode:"rectangle"===e||"circle"===e?"hybrid":"click",...s,elevationInfo:this.layer.elevationInfo,geometryType:e,createGraphicSymbol:a,snapToScene:!o(this.layer.elevationInfo)||"absolute-height"===this.layer.elevationInfo.mode,snappingOptions:this.snappingOptions,forceUniformSize:p,centered:n},h=await this._requireModule(import("../../chunks/editingTools.js"));if(ae(h))return h;const l=new h.module.DrawGraphicTool(c);this.view.tools.add(l);let d=null;this.view.activeTool=l;const m=[],u=new $({activeComponent:l,tool:e,type:"update",onEnd:()=>{var e;m.forEach((e=>e.remove())),m.length=0,null==(e=this.view.tools)||e.remove(l),l.destroy()},undo:()=>{l.canUndo&&l.undo()},redo:()=>{l.canRedo&&l.redo()},canUndo:()=>l.canUndo,canRedo:()=>l.canRedo});return m.push(this.view.on("key-down",(t=>{t.key===Y.pan?(t.stopPropagation(),t.repeat||(l.enabled=!1)):t.key===Y.complete?(t.stopPropagation(),l.completeCreateOperation()):t.key===Y.undoKey?(t.stopPropagation(),u.undo()):t.key===Y.redoKey?(t.stopPropagation(),u.redo()):t.key!==Y.snappingKey||"rectangle"===e||"circle"===e||t.repeat?t.key!==Y.constraintKey||"rectangle"!==e&&"circle"!==e||t.repeat?t.key===Y.centerKey&&(t.repeat||(l.centered=!n,t.stopPropagation())):(l.forceUniformSize=!p,t.stopPropagation()):(l.snappingOptions.selfEnabledToggled=!0,t.stopPropagation())}),I.WIDGET),this.view.on("key-up",(t=>{t.key===Y.pan?l.enabled=!0:t.key===Y.snappingKey&&"rectangle"!==e&&"circle"!==e?(l.snappingOptions.selfEnabledToggled=!1,t.stopPropagation()):t.key!==Y.constraintKey||"rectangle"!==e&&"circle"!==e?t.key===Y.centerKey&&(l.centered=n,t.stopPropagation()):(l.forceUniformSize=p,t.stopPropagation())}),I.WIDGET),l.on("vertex-add",(o=>{switch(d=t(d)?"start":"active",o.operation){case"apply":this.emit("create",{graphic:r(l.createGraphic),state:d,tool:this.activeTool,toolEventInfo:o,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[r(l.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[r(l.createGraphic)],tool:e})}})),l.on("cursor-update",(e=>{l.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:r(l.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),l.on("vertex-remove",(t=>{switch(t.operation){case"apply":this.emit("create",{graphic:r(l.createGraphic),state:"active",tool:this.activeTool,toolEventInfo:t,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[r(l.createGraphic)],tool:e});break;case"redo":this._emitRedoEvent({graphics:[r(l.createGraphic)],tool:e})}})),l.on("complete",(e=>{this._removeCreateOperationGraphics(),this._set("createGraphic",r(e.graphic)),d="complete",e.aborted?u&&u.cancel():u&&u.complete()}))),u}_setupCreatePointOperation(e,t){const i={elevationInfo:this.layer.elevationInfo,hasZ:t.hasZ,defaultZ:t.defaultZ,interactiveUndoDisabled:!0},r=this._draw.create(e,i),s=[r.on("cursor-update",(e=>{o(e.vertexIndex)?this._displayCrosshairCursor():this._displayDefaultCursor()})),r.on("draw-complete",(e=>{const t=this.createPointFromVertex(e.vertices[0]),o=new f(t,this.pointSymbol);this._set("createGraphic",o),n&&n.complete()}))],a=[this.view.on("key-down",(e=>{e.key===Y.cancelKey&&(n&&n.cancel(),e.stopPropagation())}),I.WIDGET)],n=this._operationHandleForCreateAction(r,[...s,...a],e);return n}_setupCreateMultipointOperation(e,t){const o={...t,undoDisabled:!0},i=this._draw.create(e,o);let r=null;const s=[],a=this._operationHandleForCreateAction(i,s,e);return s.push(i.on("vertex-add",(t=>{const{type:o,vertexIndex:i,vertices:s}=t,a=s[i];r=t,this._drawMultipointGraphic(s,!0),this.emit("create",{graphic:this.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:i}],type:o},type:"create"})})),i.on("vertex-remove",(t=>{const{type:o,vertexIndex:i,vertices:s}=t,a=s[i];r=t,this._drawMultipointGraphic(s,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:i}],type:o},type:"create"})})),i.on("vertex-update",(t=>{const{type:o,vertexIndex:i,vertices:s}=t,a=s[i];r=t,this._drawMultipointGraphic(s,!0),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:a,vertices:[{coordinates:a,componentIndex:0,vertexIndex:i}]},type:"create"})})),i.on("cursor-update",(e=>{r=e})),i.on("draw-complete",(e=>{const t=e.vertices.slice(0),o=M(t,this.view.spatialReference);o&&this.createGraphic&&(this.createGraphic.geometry=o),a&&a.complete()})),i.on("undo",(e=>{const t=e.vertices,o=r&&"cursor-update"!==r.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(t,o)})),i.on("redo",(e=>{const t=e.vertices,o=r&&"cursor-update"!==r.type;this._resetCreateOperationGraphics(),t.length&&this._drawMultipointGraphic(t,o)}))),s.push(this.view.on("pointer-move",(()=>this._displayCrosshairCursor()),I.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(a,e)),I.WIDGET)),a}_setupCreatePolyOperation(e,t){const o={...t,elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0};let i=null;("polyline"===e||"polygon"===e)&&(i=this._draw.create(e,o));let r=new d,s=null,a=!1;const n=[i.on("vertex-add",(t=>{const{type:o,vertexIndex:i,vertices:r}=t,n=r[i];this._snap(e,r,a),s=t,this._drawVertexGraphics(e,r,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:1===r.length?"start":"active",tool:e,toolEventInfo:{added:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:i}],type:o},type:"create"})})),i.on("vertex-remove",(t=>{const{type:o,vertexIndex:i,vertices:r}=t,n=r[i];this._snap(e,r,a),s=t,this._drawVertexGraphics(e,r,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{removed:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:i}],type:o},type:"create"})})),i.on("vertex-update",(t=>{const{type:o,vertexIndex:i,vertices:r}=t,n=r[i];this._snap(e,r,a),s=t,this._drawVertexGraphics(e,r,{userClicked:!0}),this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:n,vertices:[{coordinates:n,componentIndex:0,vertexIndex:i}]},type:"create"})})),i.on("cursor-update",(t=>{const{type:o,vertices:i}=t;if(t.mapPoint&&(this._snap(e,i,a),s=t,r=t.mapPoint,this._drawVertexGraphics(e,i,{userClicked:!1}),i.length>1)){const t=i[i.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:o},type:"create"})}})),i.on("draw-complete",(t=>{const o=t.vertices.slice(0);let i=null;"polyline"===e?i=H([o],this.view.spatialReference,this._doUnnormalization):"polygon"===e&&(i=P([o],this.view.spatialReference,this._doUnnormalization,!0)),i&&(this.createGraphic.geometry=i),c&&c.complete()})),i.on("undo",(t=>{const o=t.vertices,i=s&&"cursor-update"!==s.type;this._resetCreateOperationGraphics(),this._snap(e,o,a),o.length&&this._drawVertexGraphics(e,o,{userClicked:i})})),i.on("redo",(t=>{const o=t.vertices,i=s&&"cursor-update"!==s.type;this._resetCreateOperationGraphics(),this._snap(e,o,a),o.length&&this._drawVertexGraphics(e,o,{userClicked:i})}))],p=[this.view.on("pointer-move",(e=>{this.view.toMap(u(e.x,e.y))?this._displayCrosshairCursor():this._displayDefaultCursor()}),I.WIDGET),this.view.on("key-down",(t=>{const o=i.vertices.slice(0),r=s&&"cursor-update"!==s.type;t.key===Y.constraintKey?"2d"===this.view.type&&(a||(a=!0,this._snap(e,o,!r),this._drawVertexGraphics(e,o,{userClicked:r}))):t.key===Y.undoKey&&c&&c.canUndo()?(t.stopPropagation(),c.undo()):t.key===Y.redoKey&&c&&c.canRedo()?(t.stopPropagation(),c.redo()):t.key===Y.cancelKey&&c&&c.cancel()}),I.WIDGET),this.view.on("key-up",(t=>{const o=i.vertices.slice(0),n=s&&"cursor-update"!==s.type;t.key===Y.constraintKey&&a&&(n||(o.pop(),o.push([r.x,r.y]),this._drawVertexGraphics(e,o,{userClicked:n})),a=!1)}),I.WIDGET)];if("polygon"===e){const e=(e,t,o)=>{if(!e||!e.layer||!e.visible)return!1;const i=this.view.toScreen(e.geometry);return this._isWithinScreenDistance(i,t,o)},t=t=>{if(!(this._vertexGraphics.length<=2))return e(this._vertexGraphics[0],t,this._getVertexIntersectDistance())};let o=!1;p.push(this.view.on("pointer-move",(()=>{o=!1}),I.WIDGET),this.view.on("pointer-down",(i=>{if(t(i))return o=!0,void i.stopPropagation();this._vertexGraphics.some((t=>e(t,i,this._getVertexIntersectDistance())))&&i.stopPropagation()}),I.WIDGET),this.view.on("pointer-up",(e=>{o&&(e.stopPropagation(),i.complete())})))}const c=this._operationHandleForCreateAction(i,[...n,...p],e);return c}_setupCreateCircleOperation(e,t){const i={...t,elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0},r=this._draw.create(e,i);let s=!1,a=!0;const n=[r.on("vertex-add",(t=>{const{type:o,vertexIndex:i,vertices:n}=t,p=n[i];this._drawSegmentGraphic(e,n,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:i}],type:o},type:"create"})})),r.on("cursor-update",(t=>{const{type:o,vertices:i}=t;if(this._drawSegmentGraphic(e,i,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem),2===i.length){const t=i[i.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:o},type:"create"})}})),r.on("draw-complete",(e=>{const t=e.vertices.slice(0);let o=null;1===t.length?(t.push(r.viewAlignedCoordinateSystem.makeMapPoint(t[0][0]+this._defaultSegmentOffset*this.view.resolution,t[0][1])),o=R(t,r.viewAlignedCoordinateSystem,!0,this.view.resolution)):o=s?K(t,r.viewAlignedCoordinateSystem,a):R(t,r.viewAlignedCoordinateSystem,a,this.view.resolution),this.createGraphic?this.createGraphic.geometry=o:(this._removeCreateGraphic(),this._set("createGraphic",new f(o,this.polygonSymbol))),c&&c.complete()}))],p=[this.view.on("pointer-move",(e=>{o(r.getCoordsFromScreenPoint(u(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),I.WIDGET),this.view.on("key-down",(t=>{t.key===Y.constraintKey?s||(s=!0,this._drawSegmentGraphic(e,r.vertices,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===Y.centerKey?a&&(a=!1,this._drawSegmentGraphic(e,r.vertices,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===Y.cancelKey&&c&&c.cancel()}),I.WIDGET),this.view.on("key-up",(t=>{t.key===Y.constraintKey?(s=!1,this._drawSegmentGraphic(e,r.vertices,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===Y.centerKey&&(a=!0,this._drawSegmentGraphic(e,r.vertices,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem))}),I.WIDGET)],c=this._operationHandleForCreateAction(r,[...n,...p],e);return c}_setupCreateRectangleOperation(e,t){const i={...t,elevationInfo:this.layer.elevationInfo,interactiveUndoDisabled:!0},r=this._draw.create(e,i);let s=!1,a=!1;const n=[r.on("vertex-add",(t=>{const{type:o,vertexIndex:i,vertices:n}=t,p=n[i];this._drawSegmentGraphic(e,n,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem),this.emit("create",{graphic:this.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:p,vertices:[{coordinates:p,componentIndex:0,vertexIndex:i}],type:o},type:"create"})})),r.on("cursor-update",(t=>{const{type:o,vertices:i}=t;if(this._drawSegmentGraphic(e,i,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem),2===i.length){const t=i[i.length-1];this.emit("create",{graphic:this.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:t,type:o},type:"create"})}})),r.on("draw-complete",(e=>{const t=e.vertices.slice(0);let o=null;1===t.length&&(s=!1,a=!1),o=s?F(t,r.viewAlignedCoordinateSystem,a):V(t,r.viewAlignedCoordinateSystem,a),this.createGraphic?this.createGraphic.geometry=o:(this._removeCreateGraphic(),this._set("createGraphic",new f(o,this.polygonSymbol))),c&&c.complete()}))],p=[this.view.on("pointer-move",(e=>{o(r.getCoordsFromScreenPoint(u(e.x,e.y)))?this._displayCrosshairCursor():this._displayDefaultCursor()}),I.WIDGET),this.view.on("key-down",(t=>{t.key===Y.constraintKey?s||(s=!0,this._drawSegmentGraphic(e,r.vertices,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===Y.centerKey?a||(a=!0,this._drawSegmentGraphic(e,r.vertices,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===Y.cancelKey&&c&&c.cancel()}),I.WIDGET),this.view.on("key-up",(t=>{t.key===Y.constraintKey?(s=!1,this._drawSegmentGraphic(e,r.vertices,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem)):t.key===Y.centerKey&&(a=!1,this._drawSegmentGraphic(e,r.vertices,{centered:a,constrainToggle:s},r.viewAlignedCoordinateSystem))}),I.WIDGET)],c=this._operationHandleForCreateAction(r,[...n,...p],e);return c}async _setupUpdateOperation(e,i){const{_defaultUpdateTool:r,defaultUpdateOptions:a,layer:n,view:p}=this,c={...a,...i},h=c.tool||r;for(const t of e)n.remove(t),n.add(t);if("3d"===p.type){if(0===e.length)return null;switch(h){case"move":return this._setupMove3DOperation(e,c,p,h);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const t=Q(e[0]);return 0===t?this._setupReshape3DOperation(e[0],c,p):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${B(t)}).`),null)}case"transform":return 1===e.length&&0===function(e){var i;if("graphics"!==(null==(i=e.layer)?void 0:i.type))return 1;if(t(e.geometry))return 2;switch(e.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":default:return 3}const r=o(e.symbol)&&"point-3d"===e.symbol.type&&e.symbol.symbolLayers;return r&&r.length>0&&r.some((e=>"object"===e.type))?"on-the-ground"!==D(e)&&U(e)?4:0:5}(e[0])?this._setupPointTransform3DOperation(e[0],c,p):this._setupMove3DOperation(e,c,p,h)}}if("move"===h)return this._setupMoveOperation(e,c,p);if(e.length>1)return"reshape"===h?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupTransformOrReshapeOperation(e,h,c,p);if(1===e.length){const t=e[0],o=s(t.geometry,"type");if("point"===o||"multipoint"===o)return this._setupMoveOperation(e,c,p);if("transform"===h||"reshape"===h)return this._setupTransformOrReshapeOperation(e,h,c,p)}return null}async _setupMove3DOperation(e,t,o,i,r=!1){for(const t of e){const e=Z(t);if(0!==e)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${B(e)}).`),null}const s=await this._requireModule(import("../../chunks/editingTools.js"));if(ae(s))return s;const a=new s.module.GraphicMoveTool({view:o,enableZ:t.enableZ});this.view.tools.add(a),a.graphics.addMany(e),r||this.updateGraphics.addMany(e);const n=[],p=new $({activeComponent:a,tool:i,type:"update",onEnd:()=>{var e;n.forEach((e=>e.remove())),n.length=0,null==(e=this.view.tools)||e.remove(a),a.destroyed||a.destroy()},undo:()=>{oe(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{ie(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:e=>{this.updateGraphics.push(e),a.graphics.push(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);p.history.undo.forEach((e=>e.updates.splice(t,1))),p.history.redo.forEach((e=>e.updates.splice(t,1))),this.updateGraphics.remove(e),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?a.graphics.remove(e):p.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===t.toggleToolOnClick)return;if("transform"!==i)return;const e=this.updateGraphics.getItemAt(0);if(0!==Q(e))return;const r=await this._setupReshape3DOperation(e,t,o,!0);ae(r)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(r,t))}});return n.push(...this._getHandlesForComponent(p,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e)),I.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(p,e)),I.WIDGET)),p}async _setupPointTransform3DOperation(e,t,o){const i="transform",{enableRotation:r,enableScaling:s,enableZ:a}=t,n=await this._requireModule(import("../../chunks/editingTools.js"));if(ae(n))return n;const p=new n.module.GraphicTransformTool({graphic:e,view:o,enableRotation:r,enableScaling:s,enableZ:a});this.view.tools.add(p),this.updateGraphics.add(e);const c=[],h=new $({activeComponent:p,tool:i,type:"update",onEnd:()=>{var e;c.forEach((e=>e.remove())),c.length=0,null==(e=this.view.tools)||e.remove(p),p.destroyed||p.destroy()},undo:()=>{oe(h,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{ie(h,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:async e=>{this.updateGraphics.add(e);const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,o,"transform",!0);ae(i)||(h.onEnd(),h.destroy(),this._setUpdateOperationHandle(i,t))}});return c.push(...this._getHandlesForComponent(h,t),this.view.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(h,e)),I.WIDGET),this.view.on("key-down",(e=>this._getCommonUpdateOperationKeyDownHandlers(h,e)),I.WIDGET)),h}async _setupMoveOperation(e,t,o){const i="move";this.updateGraphics.addMany(e);const r=this._getCloneInfos(e);for(const e of r)this._internalGraphicsLayer.add(e.clone);const s=await this._getGraphicMover(e,t,o);if(ae(s))return s;const a=new $({activeComponent:s,tool:i,type:"update",onEnd:()=>{var e;this._displayDefaultCursor(),p.forEach((e=>e.remove())),n.forEach((e=>e.remove())),p=[],n=[],s.destroy(),null==(e=this._internalGraphicsLayer)||e.removeMany([...this.updateGraphics.toArray(),...r.map((e=>e.clone))])},undo:()=>{oe(a,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{ie(a,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:e=>{this.updateGraphics.push(e),s.graphics=this.updateGraphics.toArray();const t=this._createClone(e);r.push({graphic:e,clone:t}),this._internalGraphicsLayer.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=this.updateGraphics.indexOf(e);a.history.undo.forEach((e=>e.updates.splice(t,1))),a.history.redo.forEach((e=>e.updates.splice(t,1)));const o=r.findIndex((t=>t.graphic===e)),i=r[o];this._internalGraphicsLayer.remove(i.clone),this.updateGraphics.remove(e),r.splice(o,1);const n=this.updateGraphics.toArray();this.emit("update",{graphics:n,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?s.graphics=n:a.complete()}});let n=[o.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(a,e,t)),I.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(a,e),e.key!==Y.constraintKey||e.repeat||(s.enableMoveAllGraphics=!s.enableMoveAllGraphics)}),I.WIDGET),o.on("key-up",(e=>{e.key===Y.constraintKey&&(s.enableMoveAllGraphics=!s.enableMoveAllGraphics)}),I.WIDGET)],p=this._getHandlesForComponent(a,t);return p.push(s.on("graphic-move",(e=>{r.forEach((t=>{const o=e.allGraphics.find((e=>e===t.graphic));o&&(t.clone.geometry=o.geometry)}))}))),a}_getCloneInfos(e){return(null==e?void 0:e.map((e=>({graphic:e,clone:this._createClone(e)}))))||[]}_createClone(e){const t=e.clone();return t.symbol=this._getSymbolForClone(e),t}_getSymbolForClone(e){if(t(e.symbol))return null;switch(e.symbol.type){case"cim":return new _({style:"circle",size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}});case"picture-marker":{const{xoffset:t,yoffset:o,height:i,width:r}=e.symbol,s=i===r?r:Math.max(i,r);return new _({xoffset:t,yoffset:o,size:s,style:"square",color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case"simple-marker":{const{xoffset:t,yoffset:o,size:i,style:r}=e.symbol;return new _({xoffset:t,yoffset:o,style:"circle"===r?"circle":"square",size:i+2,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case"simple-fill":return new g({color:[0,0,0,0],outline:{style:"dash",color:[255,127,0,1],width:1}});case"simple-line":return new v({color:[255,127,0,1],style:"dash",width:1});case"text":{const{xoffset:t,yoffset:o}=e.symbol;return new _({xoffset:t,yoffset:o,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}default:return null}}async _setupReshape3DOperation(e,t,o,i=!1){const r="reshape",s=await this._requireModule(import("../../chunks/editingTools.js"));if(ae(s))return s;this.snappingOptions.selfEnabledToggled=!1;const a=new s.module.GraphicReshapeTool({view:o,graphic:e,enableZ:t.enableZ,enableMoveGraphic:t.enableMoveGraphic,snappingOptions:this.snappingOptions});o.tools.add(a),i||this.updateGraphics.add(e);const n=[],p=new $({activeComponent:a,tool:r,type:"update",onEnd:()=>{var e;n.forEach((e=>e.remove())),n.length=0,null==(e=this.view.tools)||e.remove(a),a.destroyed||a.destroy()},undo:()=>{a.beforeUndo(),oe(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r})},redo:()=>{ie(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r})},addToSelection:async e=>{this.updateGraphics.add(e);const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,o,"transform",!0);ae(i)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(i,t))},toggleTool:async()=>{if(!1===t.toggleToolOnClick)return;const e=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,o,"transform",!0);ae(e)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(e,t))}});return n.push(...this._getHandlesForComponent(p,t),o.on("immediate-click",(e=>this._getCommonUpdateOperationClickHandlers(p,e)),I.WIDGET),o.on("key-down",(e=>{this._getCommonUpdateOperationKeyDownHandlers(p,e),e.key===Y.snappingKey&&(a.snappingOptions.selfEnabledToggled=!0,e.stopPropagation())}),I.WIDGET),o.on("key-up",(e=>{e.key===Y.snappingKey&&(a.snappingOptions.selfEnabledToggled=!1,e.stopPropagation())}),I.WIDGET)),p}async _setupTransformOrReshapeOperation(e,t,o,i){const{multipleSelectionEnabled:r}=o;this.updateGraphics.addMany(e);const s="transform"===t?await this._getBox(e,o,i):await this._getReshape(e,o,i);if(ae(s))return s;const a=new $({activeComponent:s,type:"update",onEnd:()=>{p.forEach((e=>e.remove())),n.forEach((e=>e.remove())),p=[],n=[],a.activeComponent&&!a.activeComponent.destroyed&&a.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{oe(a,this.updateGraphics.toArray()),a.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a.tool})},redo:()=>{ie(a,this.updateGraphics.toArray()),a.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a.tool})},addToSelection:e=>{const t=a.activeComponent;this.updateGraphics.add(e),t.graphics=this.updateGraphics.toArray(),t.refresh(),a.resetHistory(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[e],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:e=>{const t=a.activeComponent,o=this.updateGraphics.indexOf(e);a.history.undo.forEach((e=>e.updates.splice(o,1))),a.history.redo.forEach((e=>e.updates.splice(o,1))),this.updateGraphics.remove(e);const i=this.updateGraphics.toArray();this.emit("update",{graphics:i,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[e],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?t.graphics=i:a.complete()},toggleTool:async()=>{if(this.updateGraphics.length>1)return;let t=null;"transform"===a.tool?t=await this._getReshape(e,o,i):"reshape"===a.tool&&(t=await this._getBox(e,o,i)),ae(t)||(a.activeComponent.destroy(),a.activeComponent=t,a.activeComponent&&(p.forEach((e=>e.remove())),p=this._getHandlesForComponent(a,o)))}});let n=[i.on("immediate-click",(e=>{this._getFirstHit(O(e)).then((t=>{var o;if(!a)return;if(null==(o=t.results)||!o.length)return void a.complete();const i=a.activeComponent;t.results.some((t=>{if(t.graphic){var o;const s=t.graphic;if("box"===(null==i?void 0:i.type)&&null!=(o=e.native)&&o.shiftKey&&r)return a.addToSelection(s),!0;s.layer===this.layer&&a.complete()}return!1}))&&e.stopPropagation()}))}),I.WIDGET),i.on("key-down",(e=>{if(this._getCommonUpdateOperationKeyDownHandlers(a,e),e.key===Y.constraintKey&&!e.repeat&&a){const e=a.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),I.WIDGET),i.on("key-up",(e=>{if(e.key===Y.constraintKey&&a){const e=a.activeComponent;e&&"box"===e.type&&(e.preserveAspectRatio=!e.preserveAspectRatio)}}),I.WIDGET)],p=this._getHandlesForComponent(a,o);return a}async _getGraphicMover(e,t,o){const{enableMoveAllGraphics:i}=t,r=await this._requireModule(import("../../chunks/GraphicMover.js"));return ae(r)?r:new r.module.default({enableMoveAllGraphics:i,graphics:e,view:o,callbacks:{onGraphicMoveStart:({dx:e,dy:t,graphic:o})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:t,graphic:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:t,graphic:o})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,t,o){const{enableRotation:i,enableScaling:r,preserveAspectRatio:s}=t,a=await this._requireModule(import("../../chunks/Box.js"));return ae(a)?a:new a.module.default({graphics:e,enableRotation:i,enableScaling:r,preserveAspectRatio:s,layer:this._internalGraphicsLayer,view:o,callbacks:{onMoveStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMove:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onMoveStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScale:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onScaleStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotate:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onRotateStop:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"})}})}async _getReshape(e,t,o){const{enableMidpoints:i=!0}=t,r=await this._requireModule(import("../../chunks/Reshape.js"));return ae(r)?r:new r.module.default({enableMidpoints:i,graphic:e[0],layer:this._internalGraphicsLayer,view:o,callbacks:{onReshapeStart:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshape:e=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...e},type:"update"}),onReshapeStop:({mover:e,type:t})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e,type:t},type:"update"}),onMoveStart:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onMove:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onMoveStop:({dx:e,dy:t,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:t,mover:o,type:i},type:"update"}),onVertexAdd:({added:e,type:t,vertices:o})=>{const i=e.map((e=>m(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:i,vertices:o,type:t},type:"update"})},onVertexRemove:({removed:e,type:t,vertices:o})=>{const i=e.map((e=>m(e.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:i,vertices:o,type:t},type:"update"})}}})}_getHandlesForComponent(e,t){const o=e.activeComponent;switch(o.type){case"graphic-mover":return[o.on("graphic-click",(({graphic:t,viewEvent:o})=>{var i;null!=(i=o.native)&&i.shiftKey&&(o.stopPropagation(),e.removeFromSelection(t))})),o.on("graphic-move-start",(t=>e.addToHistory(re(t.allGraphics))))];case"box":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(e,t,o))),o.on("move-start",(t=>e.addToHistory(re(t.graphics)))),o.on("rotate-start",(t=>e.addToHistory(re(t.graphics)))),o.on("scale-start",(t=>e.addToHistory(re(t.graphics))))];case"reshape":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(e,t,o))),o.on("move-start",(t=>e.addToHistory(re([t.mover])))),o.on("reshape-start",(t=>e.addToHistory(re([t.graphic])))),o.on("vertex-add",(t=>e.addToHistory(re([t.oldGraphic])))),o.on("vertex-remove",(t=>e.addToHistory(re([t.oldGraphic]))))];case"move-3d":return[o.on("graphic-move-start",(t=>{e.addToHistory(re(t.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"},type:"update"})})),o.on("graphic-move",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"},type:"update"})})),o.on("graphic-move-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"},type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],e,t):e.toggleTool()}))];case"transform-3d":return[o.on("graphic-translate-start",(t=>{e.addToHistory(re([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-start"},type:"update"})})),o.on("graphic-translate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move-stop"},type:"update"})})),o.on("graphic-rotate-start",(t=>{e.addToHistory(se([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-start"},type:"update"})})),o.on("graphic-rotate-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate-stop"},type:"update"})})),o.on("graphic-scale-start",(t=>{e.addToHistory(se([t.graphic])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.scale,yScale:t.scale,type:"scale-start"},type:"update"})})),o.on("graphic-scale-stop",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale-stop"},type:"update"})})),o.on("graphic-translate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dxScreen,dy:e.dyScreen,type:"move"},type:"update"})})),o.on("graphic-rotate",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"},type:"update"})})),o.on("graphic-scale",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale"},type:"update"})}))];case"reshape-3d":return[o.on("reshape",(t=>{"reshape-start"===t.type&&e.addToHistory(re([t.mover])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),o.on("move",(t=>{"move-start"===t.type&&e.addToHistory(re([t.mover])),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),o.on("vertex-add",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("vertex-remove",(e=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:e,type:"update"})})),o.on("immediate-click",(()=>e.toggleTool()))];case"draw":case"draw-3d":return null;default:return}}_onTransformOrReshape2DGraphicClick(e,o,i){var r;const{graphic:s,viewEvent:a}=i;null!=(r=a.native)&&r.shiftKey?(a.stopPropagation(),e.removeFromSelection(s)):o.toggleToolOnClick&&(t(s.geometry)||"extent"!==s.geometry.type?(a.stopPropagation(),e.toggleTool()):this._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."))}_setUpdateOperationHandle(e,t){this._operationHandle=e;const o=this.view.map;this._disablePopup(t);e.on("complete",(()=>{if(e===this._operationHandle){const i=this.updateGraphics.toArray(),r=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),o&&o.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:i,state:"complete",aborted:e.cancelled,tool:r,toolEventInfo:null,type:"update"})}}))}_getCommonUpdateOperationClickHandlers(e,t,o){const i=O(t);this._getFirstHit(i).then((i=>{const r=i.results;if(!r.length)return void e.complete();if(t.native.shiftKey&&this._toggleSelection(r.map((e=>e.graphic)),e,o))return void t.stopPropagation();r.some((e=>e.graphic&&this.updateGraphics.indexOf(e.graphic)>-1))?t.stopPropagation():e.complete()}))}_toggleSelection(e,t,o){const i=!o||!!o.multipleSelectionEnabled;return e.some((e=>null!=e&&(!(!i||e.layer!==this.layer)&&(-1===this.updateGraphics.indexOf(e)?t.addToSelection(e):t.removeFromSelection(e),!0))))}_getCommonUpdateOperationKeyDownHandlers(e,t){if(!e)return;const o=t.key;o===Y.undoKey&&e.canUndo()?(t.stopPropagation(),e.undo()):o===Y.redoKey&&e.canRedo()?(t.stopPropagation(),e.redo()):o===Y.cancelKey?(t.stopPropagation(),e.cancel()):Y.deleteKeys.indexOf(o)>=0&&this._onDeleteKey(t)}_onDeleteKey(e){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const o=this.activeComponent;if(t(o)||"reshape"===o.type||"reshape-3d"===o.type)return;e.stopPropagation();const i=this.updateGraphics.toArray();this.layer.removeMany(i),this._emitDeleteEvent({graphics:i,tool:this.activeTool})}_drawMultipointGraphic(e,t){let o=null;if(!t&&e.length>1){const t=e.slice(0);t.pop(),o=M(t,this.view.spatialReference)}else o=M(e,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=o:this._set("createGraphic",new f(o,this.pointSymbol)),t&&1===e.length&&this._internalGraphicsLayer.add(this.createGraphic)}_drawVertexGraphics(e,t,o){if(!t.length)return;const{_doUnnormalization:i,activeLineSymbol:r,activeVertexSymbol:s,polygonSymbol:a,polylineSymbol:n,vertexSymbol:p,view:{spatialReference:c}}=this,h=!(!o||!o.userClicked),l="polygon"===e,d=l?a:n;if(1===t.length){this._removeLineGraphic(),this._removeActiveLineGraphic();const e=this.createPointFromVertex(t[0]),o=l?P([t],c,i,!0):H([t],c,i);this._vertexGraphics.length?this._vertexGraphics[0].geometry=e:this._vertexGraphics.push(new f(e,s)),this.createGraphic?this.createGraphic.geometry=o:this._set("createGraphic",new f(o,d)),h&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===t.length){const e=this.createPointFromVertex(t[1]),o=H([t],c,i),r=l?P([t],c,i,!0):H([t],c,i);if(!this._vertexGraphics.length){const e=this.createPointFromVertex(t[0]),o=new f(e,p);this._vertexGraphics.push(o)}if(1===this._vertexGraphics.length){const t=this._vertexGraphics[0],o=new f(e,p);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(o),this._internalGraphicsLayer.remove(t),this._internalGraphicsLayer.add(t)}else this._vertexGraphics[1].geometry=e;this._showActiveLineGraphic(o);const s=this._vertexGraphics[0];h&&(this._activeLineGraphic.symbol=n,s.symbol=p,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.geometry=r:this._set("createGraphic",new f(r,a)),this._internalGraphicsLayer.remove(s),this._internalGraphicsLayer.add(s)}else if(t.length>2){const o=l?P([t],c,i,!0):H([t],c,i);"polygon"===e&&this._showFillGraphic(o);const a=t.map((e=>e.slice())),m=a.pop(),u=[a[a.length-1],m],y=H([a],c,i),v=H([u],c,i);this._showLineGraphic(y),this._showActiveLineGraphic(v);for(let e=0;e<a.length;e++){const o=this._vertexGraphics[e];if(o)h||e!==this._vertexGraphics.length-1?o.symbol=p:o.symbol=s;else{const o=this.createPointFromVertex(t[e]);this._showVertexGraphic(o)}}if(h){this._activeLineGraphic.symbol=n;const e=t.length-1,o=this.createPointFromVertex(t[e]);this._showVertexGraphic(o)}else this._activeLineGraphic.symbol=r;this.createGraphic?this.createGraphic.geometry=o:(this._removeCreateGraphic(),this._set("createGraphic",new f(o,d)));for(const e of this._vertexGraphics)this._internalGraphicsLayer.remove(e),this._internalGraphicsLayer.add(e)}}_drawSegmentGraphic(e,t,o,i){if(!t.length)return;const r=!(null==o||!o.centered),s=!(null==o||!o.constrainToggle);let a=null;1===t.length?this._removeCenterIndicatorGraphic():("rectangle"===e?a=s?F(t,i,r):V(t,i,r):"circle"===e&&(a=s?K(t,i,r):R(t,i,r,this.view.resolution)),a.extent&&a.extent.center&&this._showCenterIndicatorGraphic(a.extent.center)),a?this.createGraphic?this.createGraphic.geometry=a:(this._removeCreateGraphic(),this._set("createGraphic",new f(a,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}_showCenterIndicatorGraphic(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new f(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))}_removeCenterIndicatorGraphic(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)}_showActiveLineGraphic(e){this._activeLineGraphic?(this._activeLineGraphic.geometry=e,this._internalGraphicsLayer.remove(this._activeLineGraphic)):this._activeLineGraphic=new f(e,this.activeLineSymbol),this._internalGraphicsLayer.add(this._activeLineGraphic)}_showFillGraphic(e){this._activeFillGraphic?(this._activeFillGraphic.geometry=e,this._internalGraphicsLayer.remove(this._activeFillGraphic)):this._activeFillGraphic=new f(e,this.activeFillSymbol),this._internalGraphicsLayer.add(this._activeFillGraphic)}_showLineGraphic(e){this._lineGraphic?(this._lineGraphic.geometry=e,this._internalGraphicsLayer.remove(this._lineGraphic)):this._lineGraphic=new f(e,this.polylineSymbol),this._internalGraphicsLayer.add(this._lineGraphic)}_showVertexGraphic(e,t){const o=t?this.activeVertexSymbol:this.vertexSymbol,i=new f(e,o);this._vertexGraphics.push(i),this._internalGraphicsLayer.add(i)}_resetCreateOperationGraphics(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics()}_removeCreateGraphic(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))}_removeCreateOperationGraphics(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()}_removeActiveLineGraphic(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)}_removeActiveFillGraphic(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)}_removeLineGraphic(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)}_removeVertexGraphics(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach((e=>e.destroy())),this._vertexGraphics=[])}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)}_operationHandleForCreateAction(e,t,o){return new $({activeComponent:this._draw,tool:o,type:"create",onEnd:()=>{t.forEach((e=>e.remove())),t.length=0,this._removeCreateOperationGraphics(),this._internalGraphicsLayer&&this._internalGraphicsLayer.remove(this.createGraphic),this._displayDefaultCursor()},undo:()=>{e.undo(),this._emitUndoEvent({graphics:[this.createGraphic],tool:o})},redo:()=>{e.redo(),this._emitRedoEvent({graphics:[this.createGraphic],tool:o})},canUndo:()=>e&&e.canUndo(),canRedo:()=>e&&e.canRedo()})}_isComponentGraphic(e){const{activeComponent:o}=this;return!(!e||t(o))&&(!(!e.attributes||!e.attributes.esriSketchTool)||("box"===o.type||"reshape"===o.type)&&o.isUIGraphic(e))}_snap(e,t,o){o&&this._snapLastVertexToAxis(t),"polygon"===e&&this._snapLastPolygonVertexToFirst(t)}_snapLastPolygonVertexToFirst(e){if(e.length<=2)return;const t=e[0],o=e[e.length-1],i=this.view.toScreen(new d(t[0],t[1],this.view.spatialReference)),r=this.view.toScreen(new d(o[0],o[1],this.view.spatialReference));this._isWithinScreenDistance(i,r,this._getVertexIntersectDistance())&&(o[0]=t[0],o[1]=t[1])}_getVertexIntersectDistance(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?y(this.vertexSymbol.size)/2+3:3}_isWithinScreenDistance(e,t,o){const i=e.x-t.x,r=e.y-t.y;return Math.sqrt(i*i+r*r)<=o}_snapLastVertexToAxis(e){if(e.length<2)return;const t=e.pop(),o=e[e.length-1],i=W(this.view,o),r=i.mapToLocal(o),s=i.mapToLocal(t),a=Math.abs(s.x-r.x),n=Math.abs(s.y-r.y),p=i.localToMap(z(a>n?s.x:r.x,a>n?r.y:s.y));e.push(p)}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayCrosshairCursor(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(e,t,o){J.error(new n(e,t,o))}async _requireModule(e){const t=new AbortController;this._moduleLoaderAbortController=t;const o=await e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:o}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}createPointFromVertex(e){return e.length>2?new d(e[0],e[1],e[2],this.view.spatialReference):new d(e[0],e[1],this.view.spatialReference)}test(){return this._operationHandle}wait(){return S(this,"updating")}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(e){var t;return"3d"!==(null==(t=this.view)?void 0:t.type)||this.updateOnGraphicClick||e.toggleToolOnClick}_disablePopup(e){if(!this._disablePopupEnabled(e))return;const o=this.view.popup;o&&t(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=o.autoOpenEnabled,o.autoOpenEnabled=!1)}_restorePopup(e){if(!this._disablePopupEnabled(e))return;const t=this.view.popup;t&&o(this._originalAutoOpenEnabled)&&(t.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}};function oe(e,t){const i=e.history.undo.pop().updates,r=[];t.forEach(((e,t)=>{const s=i[t],a={};null!=s&&(o(s.geometry)&&(a.geometry=e.geometry,e.geometry=s.geometry),o(s.symbol)&&(a.symbol=e.symbol,e.symbol=s.symbol),r.push(a))})),e.history.redo.push({updates:r})}function ie(e,t){const i=e.history.redo.pop().updates,r=[];t.forEach(((e,t)=>{const s=i[t],a={};null!=s&&(o(s.geometry)&&(a.geometry=e.geometry,e.geometry=s.geometry),o(s.symbol)&&(a.symbol=e.symbol,e.symbol=s.symbol),r.push(a))})),e.history.undo.push({updates:r})}function re(e){return{updates:e.map((e=>({geometry:e.geometry})))}}function se(e){return{updates:e.map((e=>({symbol:e.symbol})))}}function ae(e){return"requireError"in e&&"aborted"===e.requireError}e([a({dependsOn:["state"],readOnly:!0})],te.prototype,"_draw",null),e([a()],te.prototype,"updating",null),e([a()],te.prototype,"_operationHandle",void 0),e([a({dependsOn:["_operationHandle","_operationHandle.tool"],readOnly:!0})],te.prototype,"activeTool",null),e([a()],te.prototype,"activeFillSymbol",void 0),e([a()],te.prototype,"activeLineSymbol",void 0),e([a()],te.prototype,"activeVertexSymbol",void 0),e([a({readOnly:!0})],te.prototype,"createGraphic",null),e([a()],te.prototype,"defaultCreateOptions",null),e([a()],te.prototype,"defaultUpdateOptions",null),e([a()],te.prototype,"layer",void 0),e([a({types:G})],te.prototype,"pointSymbol",void 0),e([a({types:G})],te.prototype,"polygonSymbol",void 0),e([a({types:G})],te.prototype,"polylineSymbol",void 0),e([a({dependsOn:["view.ready","layer","_operationHandle"],readOnly:!0})],te.prototype,"state",null),e([a({readOnly:!0})],te.prototype,"updateGraphics",void 0),e([a()],te.prototype,"updateOnGraphicClick",void 0),e([a({types:G})],te.prototype,"updatePointSymbol",void 0),e([a({types:G})],te.prototype,"updatePolygonSymbol",void 0),e([a({types:G})],te.prototype,"updatePolylineSymbol",void 0),e([a({types:G})],te.prototype,"vertexSymbol",void 0),e([a({value:null})],te.prototype,"view",null),e([a({type:L})],te.prototype,"snappingOptions",void 0),e([a()],te.prototype,"cancel",null),e([a()],te.prototype,"complete",null),e([a()],te.prototype,"delete",null),e([a()],te.prototype,"create",null),e([a()],te.prototype,"update",null),e([a()],te.prototype,"undo",null),e([a()],te.prototype,"redo",null),e([a()],te.prototype,"canUndo",null),e([a()],te.prototype,"canRedo",null),e([a()],te.prototype,"toggleUpdateTool",null),te=e([c("esri.widgets.Sketch.SketchViewModel")],te);var ne=te;export default ne;export{Q as a,N as b,Z as i};
