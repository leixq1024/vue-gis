/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../chunks/object.js";import"../../chunks/deprecate.js";import"../../core/lang.js";import"../../config.js";import{i as e,d as s,b as i,c as o,e as r}from"../../chunks/Logger.js";import"../../chunks/string.js";import{f as n}from"../../chunks/metadata.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import l from"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import{s as p,m as c,k as u}from"../../core/scheduling.js";import{throwIfAborted as h,resolve as m,createTask as d,isAbortError as y,after as j,ignoreAbortErrors as f,whenOrAbort as g}from"../../core/promiseUtils.js";import"../../chunks/Message.js";import"../../core/Error.js";import"../../chunks/compilerUtils.js";import"../../chunks/ensureType.js";import{subclass as v}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import _ from"../../core/Collection.js";import{r as k}from"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/Promise.js";import"../../chunks/Loadable.js";import"../../chunks/asyncUtils.js";import"../../core/urlUtils.js";import{aliasOf as b}from"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../chunks/persistableUrlUtils.js";import w,{h as S}from"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import"../../chunks/number.js";import"../../intl.js";import"../../kernel.js";import"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalUser.js";import"../../portal/Portal.js";import"../../chunks/mathUtils2.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/vec3.js";import"../../chunks/mathUtils.js";import"../../chunks/colorUtils.js";import"../../Color.js";import"../../chunks/zmUtils.js";import P from"../../geometry/Multipoint.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import"../../layers/support/fieldUtils.js";import"../../popup/content/Content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/CustomContent.js";import"../../chunks/date.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/FieldInfo.js";import"../../popup/content/FieldsContent.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/MediaContent.js";import"../../popup/content/TextContent.js";import"../../popup/content.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/RelatedRecordsInfo.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../PopupTemplate.js";import"../../symbols/Symbol.js";import U from"../../symbols/CIMSymbol.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/screenUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/materialUtils.js";import"../../symbols/edges/Edges3D.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/utils.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/patterns/StylePattern3D.js";import"../../symbols/FillSymbol3DLayer.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/Symbol3D.js";import"../../chunks/Thumbnail.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/uid.js";import I from"../../Graphic.js";import M from"../../core/Handles.js";import"../../layers/Layer.js";import{a as C,i as D,c as L,A as E,B as x,z as R}from"../../chunks/unitUtils.js";import"../../chunks/lengthUtils.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/MemCache.js";import{L as V}from"../../chunks/LRUCache.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import{init as T,on as O}from"../../core/watchUtils.js";import"../../chunks/fieldType.js";import"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../geometry/support/GeographicTransformation.js";import{initializeProjection as A,project as z}from"../../geometry/projection.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../core/HandleOwner.js";import"../../chunks/_commonjsHelpers.js";import{T as G}from"../../chunks/Scheduler.js";import{isSupported as F,geodesicLengths as q,geodesicDensify as N,inverseGeodeticSolver as B}from"../../geometry/support/geodesicUtils.js";import"../../geometry/Circle.js";import"../../chunks/geometryEngineBase.js";import"../../chunks/hydrated.js";import"../../geometry/geometryEngine.js";import"../../chunks/vec4f64.js";import"../../chunks/quatf64.js";import"../../chunks/mat3.js";import"../../chunks/BufferView.js";import"../../chunks/vec2.js";import"../../chunks/vec4.js";import"../../chunks/quat.js";import"../../chunks/domUtils.js";import"../../chunks/widgetUtils.js";import"../../chunks/projector.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../../chunks/renderable.js";import"../../chunks/vmEvent.js";import"../../chunks/index.js";import"../support/widget.js";import"../Widget.js";import"../../chunks/zscale.js";import"../../chunks/queryZScale.js";import"../../layers/support/Field.js";import"../../tasks/support/FeatureSet.js";import"../../chunks/BlendLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../chunks/DataLayerSource.js";import"../../tasks/support/AttachmentQuery.js";import"../../tasks/support/Query.js";import"../../tasks/support/StatisticDefinition.js";import"../../tasks/support/RelationshipQuery.js";import"../../chunks/GraphicsCollection.js";import Q from"../../layers/GraphicsLayer.js";import"../../tasks/Task.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/featureConversionUtils.js";import"../../tasks/QueryTask.js";import"../../chunks/pbf.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/query.js";import"../../layers/support/AttachmentInfo.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/Queue.js";import"../../chunks/InputManager.js";import{i as W}from"../../chunks/interactiveToolUtils.js";import{t as H}from"../../chunks/throttle.js";import"../Attachments.js";import"../Attachments/AttachmentsViewModel.js";import"../Feature/FeatureViewModel.js";import"../Feature.js";import"../../chunks/AnchorElementViewModel.js";import"../Spinner/SpinnerViewModel.js";import"../Popup.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../../chunks/GoTo.js";import"../Popup/PopupViewModel.js";import"../../chunks/screenUtils2.js";import"../../layers/support/ElevationSampler.js";import"../../chunks/quantizationUtils.js";import"../../chunks/mat2d.js";import"../../chunks/dehydratedFeatures.js";import"../../chunks/ElevationProvider.js";import"../../chunks/mat2df64.js";import"../../chunks/vec2f64.js";import{Q as Z}from"../../chunks/QueueProcessor.js";import"../../chunks/PointerClickHoldAndDrag.js";import"../../chunks/requestImageUtils.js";import"../../chunks/PiUtils.glsl.js";import"../../chunks/Program.js";import"../../chunks/isWebGL2Context.js";import"../../chunks/glUtil.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/mat4f32.js";import"../../chunks/vec3f32.js";import"../../chunks/geometryUtils.js";import"../../chunks/ColorMaterial.js";import"../../chunks/Util.js";import"../../chunks/Geometry.js";import"../../chunks/VertexArrayObject.js";import"../../chunks/sdfPrimitives.js";import"../../chunks/Object3D.js";import"../../chunks/intersectorUtils.js";import"../../chunks/Intersector.js";import"../../chunks/DefaultTextureUnits.js";import"../../chunks/GLMaterialTexture.js";import"../../chunks/VerticalOffset.glsl.js";import"../../chunks/elevationAlignmentUtils.js";import"../../chunks/RenderingContext.js";import"../../chunks/CameraSpace.glsl.js";import"../../chunks/Texture.js";import"../../chunks/vec4f32.js";import"../../views/draw/DrawAction.js";import"../../chunks/Keys.js";import"../../views/draw/MultipointDrawAction.js";import"../../chunks/DrawTool.js";import"../../chunks/elevationInfoUtils.js";import"../../chunks/InteractiveToolBase.js";import"../../chunks/RightAngleQuadVisualElement.js";import"../../chunks/LaserLineRenderer.js";import"../../views/draw/PointDrawAction.js";import"../../views/draw/PolygonDrawAction.js";import"../../views/draw/PolylineDrawAction.js";import"../../views/draw/SegmentDrawAction.js";import"../../views/draw/Draw.js";import{d as J}from"../../chunks/commonProperties3.js";import K from"../Sketch/SketchViewModel.js";import{E as X}from"../../chunks/ElevationProfileLine.js";import"../../chunks/elevationQuerySourceUtils.js";import Y from"./ElevationProfileLineGround.js";import"../../chunks/ElevationQuery.js";import $ from"./ElevationProfileLineInput.js";import tt from"./ElevationProfileLineQuery.js";import et from"./ElevationProfileLineView.js";class st{constructor(t){this.store=t}destroy(){this.store.destroy()}get(t){return this.store.get(t)}put(t,e){this.store.put(t,e,e.values.byteLength+40)}}function it(t,e){const s=t/e.maxSamples;return Math.max(e.samplingDistance,s)}function ot(t){return rt(t)&&1===t.paths.length&&t.paths[0].length>=2}function rt(t){return e(t)&&"polyline"===t.type}var nt;!function(t){t.Ready="ready",t.Creating="creating",t.Reshaping="reshaping",t.Selecting="selecting",t.Selected="selected"}(nt||(nt={}));let at=class extends l{constructor(t){super(t),this.state=nt.Ready,this._handles=new M,this._prevInput=null,this._hasPrevInput=!1,this._prevInputIsInternal=!1,this._toolPromise=m()}initialize(){const t=this.parentViewModel.view;this._graphicsLayer=new Q({listMode:"hide",elevationInfo:{mode:"on-the-ground",offset:null}});const e="2d"===t.type?new U({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",effects:[{type:"CIMGeometricEffectDashes",dashTemplate:[5,4],lineDashEnding:"FullGap",controlPointEnding:"NoConstraint"}],enable:!0,capStyle:"Butt",joinStyle:"Round",width:1.5,color:[0,0,0,255]},{type:"CIMSolidStroke",enable:!0,capStyle:"Butt",joinStyle:"Round",width:1.5,color:[255,255,255,255]}]}}}):null;this._sketchVM=new K({layer:this._graphicsLayer,view:t,defaultCreateOptions:{mode:"click",hasZ:!1},updateOnGraphicClick:!1,defaultUpdateOptions:{enableMidpoints:!0,enableRotation:!1,enableScaling:!1,enableMoveAllGraphics:!1,enableZ:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,enableMoveGraphic:!1,tool:"reshape"},polylineSymbol:e,activeLineSymbol:e,updatePolylineSymbol:e}),this._handles.add([T(this.parentViewModel,["input"],(()=>this._update()),!0),T(t,"map",(t=>{null==t||t.add(this._graphicsLayer),this._update()})),this._sketchVM.on("create",(t=>this._onSketchViewModelCreate(t))),this._sketchVM.on("update",(t=>this._onSketchViewModelUpdate(t)))])}destroy(){var t,e;this._handles.destroy(),this._handles=null,null==(t=this.parentViewModel.view)||null==(e=t.map)||e.remove(this._graphicsLayer),this._sketchVM.destroy(),this._sketchVM=null,this._graphicsLayer.destroy(),this._graphicsLayer=null}get canStopCreating(){const t=s(this.parentViewModel.input,(t=>t.geometry));return rt(t)&&t.paths.length>0&&t.paths[0].length>2}get test(){return{sketchVM:this._sketchVM,toolPromise:this._toolPromise}}start(t={mode:"sketch"}){this._sketchVM.cancel(),this._stopSelectionInteraction(),this._prevInput||this._storePreviousInput(this._input),this._input=null,this._graphicsLayer.removeAll(),"sketch"===t.mode?(this._set("state",nt.Creating),this._toolPromise=this._sketchVM.create("polyline")):(this._set("state",nt.Selecting),this._startSelectionInteraction())}stop(){switch(this.state){case nt.Creating:this._stopCreationInteraction(),this._afterInteraction();break;case nt.Selecting:this._stopSelectionInteraction(),this._afterInteraction()}}cancel(){switch(this.state){case nt.Creating:this._sketchVM.cancel(),this._restorePreviousInput(),this._afterInteraction();break;case nt.Selecting:this._stopSelectionInteraction(),this._restorePreviousInput(),this._afterInteraction()}}clear(){this._sketchVM.cancel(),this._set("state",nt.Ready),this._clearPreviousInput(),this._input=null}_stopCreationInteraction(){const t=this._input,e=this.canStopCreating;this._sketchVM.cancel(),!i(t)&&e?(this._removeLastPoint(t),this._graphicsLayer.removeAll(),this._graphicsLayer.add(t),this._input=t):this._input=null}_startSelectionInteraction(){this._stopSelectionInteraction();const t=this.parentViewModel.view,s=t.cursor;t.cursor="crosshair";const i=n((()=>t.cursor=s));let o=null;const r=n((()=>{e(o)&&(o.abort(),o=null)})),a=t.on("immediate-click",(s=>{s.preventDefault(),s.stopPropagation(),o=d((async i=>{const{results:o}=await t.hitTest(s);h(i);const r=o.map((t=>t.graphic)).find((t=>e(t.geometry)&&"polyline"===t.geometry.type));r&&(this._input=r,this._clearPreviousInput(),this._set("state",nt.Selected),this._stopSelectionInteraction())}))})),l=t.on("key-down",(t=>{"Escape"===t.key&&this.cancel()}));this._handles.add([a,l,r,i],"selection-interaction"),t.ready&&W(t)&&t.focus()}_stopSelectionInteraction(){this._handles.remove("selection-interaction")}_update(){const t=this.state,{input:e}=this.parentViewModel;if(t!==nt.Selecting){if(!(t===nt.Creating||t===nt.Reshaping&&this._isInternalGraphic(e))){if(this._sketchVM.cancel(),i(e))return this._graphicsLayer.removeAll(),void this._set("state",nt.Ready);this._isInternalGraphic(e)?(this._set("state",nt.Reshaping),this._toolPromise=this._sketchVM.update(e,{tool:"reshape"})):(this._graphicsLayer.removeAll(),this._set("state",nt.Selected))}}else this.stop()}_afterInteraction(){this._toolPromise=null,this._clearPreviousInput(),this._set("state",nt.Ready),this._update()}_onSketchViewModelCreate(t){if("polyline"===t.tool)switch(t.state){case"complete":this._input=t.graphic,this._afterInteraction();break;case"cancel":this.cancel();break;case"active":case"start":this._input=t.graphic}}_onSketchViewModelUpdate(t){switch(t.state){case"complete":this._afterInteraction();break;case"active":case"start":this._input=t.graphics[0]}}_removeLastPoint(t){const e=t.geometry;if(rt(e)){const s=e.clone();s.paths=[s.paths[0].slice(0,-1)],t.geometry=s}}_storePreviousInput(t){this._hasPrevInput=!0,this._prevInput=t,this._prevInputIsInternal=this._isInternalGraphic(t)}_restorePreviousInput(){if(!this._hasPrevInput)return;const t=this._prevInput;e(t)&&this._prevInputIsInternal&&(this._graphicsLayer.removeAll(),this._graphicsLayer.add(t)),this._input=t,this._clearPreviousInput()}_clearPreviousInput(){this._hasPrevInput=null,this._prevInput=null,this._prevInputIsInternal=!1}_isInternalGraphic(t){return e(t)&&this._graphicsLayer.graphics.includes(t)}};t([a({nonNullable:!0})],at.prototype,"state",void 0),t([a({nonNullable:!0})],at.prototype,"parentViewModel",void 0),t([a()],at.prototype,"canStopCreating",null),t([b("parentViewModel.input")],at.prototype,"_input",void 0),at=t([v("esri.widgets.ElevationProfile.ElevationProfileInteraction")],at);var lt=at;const pt={base:X,key:"type",typeMap:{ground:Y,input:$,query:tt,view:et},errorContext:"elevation-profile-line"},ct=_.ofType(pt);var ut;!function(t){t.Disabled="disabled",t.Ready="ready",t.Creating="creating",t.Created="created",t.Selecting="selecting",t.Selected="selected"}(ut||(ut={}));const ht={noDataValue:-5e5,demResolution:"auto",maximumAutoTileRequests:150},mt=1,dt=400,yt=" ― ",jt={width:3,outlineSize:0,falloff:0,outlineColor:[1,1,1,0]},ft={width:6,outlineSize:4,color:[1,1,1,1],outlineColor:[1,.5,0,1],falloff:0},gt={size:12,outlineSize:2,outlineColor:[1,1,1,1]};function vt(t,s){return i(s)?t:e(t)?Math.min(t,s):s}function _t(t,s){return i(s)?t:e(t)?Math.max(t,s):s}function kt(t,s){return e(t)&&e(s)?t*s:null}function bt(t,e,s=[]){if(t>=e)return s;s.push(t);if(e-t<2)return s;const i=e-1;s.push(i);const o=wt(t+1,i);for(;;){const t=o.next();if(t.done)break;s.push(t.value)}return s}function*wt(t,e){if(t>=e)return;const s=t+Math.floor((e-t)/2);yield s;const i=wt(t,s),o=wt(s+1,e);for(;;){const t=i.next(),e=o.next();if(t.done&&e.done)break;t.done||(yield t.value),e.done||(yield e.value)}}async function*St(t){const e={signal:t.signal},s=t.path;if(!rt(s)||!ot(s))return null;const i=t.view.spatialReference,o=await async function(t,e,s,i){let o,r,n=null;const a=t.spatialReference,l=a.isGeographic||a.isWebMercator,p=await import("../../geometry/geometryEngineAsync.js");h(i);let c=0;if(l||(c=await p.planarLength(t,"meters"),h(i)),l||c>=s.geodesicDistanceThreshold){if(await A([{source:a,dest:e},{source:a,dest:w.WGS84}],i),!S(a)&&F(a)){o=q([t],"meters")[0];const e=it(o,s);n=N(t,e)}else{const e=z(t,w.WGS84);o=await p.geodesicLength(e,"meters"),h(i);const r=it(o,s);n=await p.geodesicDensify(e,r,"meters"),h(i)}r=z(n,e)}else{await A([{source:a,dest:e}],i),o=c;const n=it(o,s);r=await p.densify(t,n,"meters"),h(i),r=z(r,e)}return{densifiedPath:r,densifiedPathInMeasurementSR:n,pathLength:o/C(e)}}(s,i,t.options,e),r={...t,path:s,densificationResult:o,result:Ut(o)},n=bt(0,o.densifiedPath.paths[0].length),a=n.slice(0,r.provider.numSamplesForPreview);yield await Pt(r,a,!0),h(e),await j(500),h(e);const l=p(n,r.provider.numSamplesPerChunk);for(const t of l)yield await Pt(r,t,!1),h(e);r.result.progress=1,yield r.result}async function Pt({densificationResult:t,result:s,provider:o,queue:r,signal:n,cache:a},l,p){const{densifiedPath:c,pathLength:u}=t,h=c.paths[0],m=l.map((t=>h[t])),d=p?Math.round(u/o.numSamplesForPreview):Math.round(u/h.length);await r.push({geometry:new P({spatialReference:c.spatialReference,points:m,hasZ:c.hasZ}),provider:o,indices:l,result:s,queryOptions:{...ht,minDemResolution:d,cache:a}},{signal:n});const y=s.samples.filter((t=>t.processed));return s.progress=p?0:s.progress+l.length/h.length,s.statistics=function(t,s){const o=t.length;if(0===o)return null;const r=t[0].z;let n=r,a=r,l=0,p=0,c=null,u=null,h=e(r)?r:0,m=0,d=0,y=e(r)?1:0,j=0,f=0;for(let e=1;e<o;++e){const o=t[e-1],r=t[e],g=r.z,v=r.distance-o.distance;if(0===v||i(g))continue;y++,h+=g,n=vt(n,g),a=_t(a,g);const _=o.z;if(i(_))continue;const k=g-_,b=k*D(s),w=v*C(s),S=L(Math.atan2(b,w),"radians","degrees");S>0?(l+=k,m+=S,c=_t(c,S),j++):S<0&&(p-=k,d-=S,u=_t(u,-S),f++)}return 0===y?null:{maxDistance:t[o-1].distance,minElevation:n,maxElevation:a,avgElevation:0===y?null:h/y,elevationGain:l,elevationLoss:p,maxPositiveSlope:c,maxNegativeSlope:u,avgPositiveSlope:0===j?null:m/j,avgNegativeSlope:0===f?null:d/f}}(s.samples,s.spatialReference),{...s,samples:y}}function Ut(t){const s=t.densifiedPath,i=s.spatialReference,o=t.densifiedPathInMeasurementSR;let r=s.paths[0];const n=r.length;let a=0;const l=new Array(n);if(l[0]=It(r[0],a),e(o)){const t=r;r=o.paths[0];const e=C(i),s={distance:0},p=o.spatialReference;for(let i=1;i<n;i++)B(s,r[i-1],r[i],p),a+=s.distance/e,l[i]=It(t[i],a)}else for(let t=1;t<n;t++){const e=r[t],s=r[t-1],i=e[0]-s[0],o=e[1]-s[1];a+=Math.sqrt(i*i+o*o),l[t]=It(e,a)}return{progress:0,samples:l,statistics:null,spatialReference:i}}function It([t,e],s){return{x:t,y:e,z:null,distance:s,processed:!1}}let Mt=class extends l{constructor(t){super(t),this._handles=new M,this._updateTask=null,this._lastParams=null,this._lastSamplingDistance=null,this._update=async()=>{if(!this.viewModel.view.stationary)return;const t=this.line,e=this._generateProfileParams;if(i(e))return this._abortUpdate(),void(t.result=null);if(!t.visible)return;const s=o(this.viewModel.minDemResolution,.1);(this._generateProfileParams!==this._lastParams||this._lastSamplingDistance!==s||t.progress<1)&&(this._abortUpdate(),this._updateTask=d((async i=>{const o=St({...e,options:{...e.options,samplingDistance:s},signal:i});for await(const e of o)h(i),t.result=e;this._lastParams=e,this._lastSamplingDistance=s})))},this._throttledUpdate=H((()=>f(this._update())),80)}initialize(){const t=this.viewModel,e=this.line;this._handles.add([this._throttledUpdate,e.attach(t),e.on("change",this._throttledUpdate),T(t,["view.stationary","minDemResolution"],this._throttledUpdate),T(e,"visible",this._throttledUpdate),T(this,"_generateProfileParams",this._throttledUpdate)])}destroy(){this._handles.destroy(),this._abortUpdate()}get _generateProfileParams(){const{input:t,queue:e,view:o,tileCache:r,geodesicDistanceThreshold:n}=this.viewModel,a=s(t,(t=>t.geometry));return rt(a)&&ot(a)&&!i(e)?{view:o,path:a,provider:this.line,options:{geodesicDistanceThreshold:n,samplingDistance:.1,maxSamples:2e3},queue:e,cache:r}:null}_abortUpdate(){e(this._updateTask)&&(this._updateTask.abort(),this._updateTask=null)}};t([a({nonNullable:!0})],Mt.prototype,"line",void 0),t([a({nonNullable:!0})],Mt.prototype,"viewModel",void 0),t([a()],Mt.prototype,"_generateProfileParams",null),Mt=t([v("esri.widgets.ElevationProfile.ElevationProfileLineUpdater")],Mt);var Ct=Mt;class Dt{constructor(t){this._parentViewModel=t,this._visualization=null,this._loadingTask=null,this._handles=new M}initialize(){this._handles.add(T(this._parentViewModel,"view",(()=>this._load())))}destroy(){this._handles.destroy(),this._handles=null,e(this._loadingTask)&&(this._loadingTask.abort(),this._loadingTask=null),e(this._visualization)&&(this._visualization.destroy(),this._visualization=null)}_load(){e(this._loadingTask)&&this._loadingTask.abort(),this._loadingTask=d((async t=>{const e=this._parentViewModel;if("2d"===e.view.type){const s=import("../../chunks/ElevationProfileVisualization2D.js"),i=(await g(s,t)).ElevationProfileVisualization2D;this._visualization=new i(e)}else if((t=>"3d"===t.view.type)(e)){const s=import("../../chunks/ElevationProfileVisualization3D.js"),i=(await g(s,t)).ElevationProfileVisualization3D;this._visualization=new i(e)}}))}}let Lt=class extends l{constructor(t){super(t),this.view=null,this.input=null,this.geodesicDistanceThreshold=1e5,this.hoveredChartPosition=null,this.defaultUnit=null,this.queue=null,this._currentTileCache=null,this.defaultProfileLineGround=new Y,this._handles=new M,this._visualization=new Dt(this),this._userUnitOptions=null,this._userUnit=null,t.profiles||(this.profiles=new _([this.defaultProfileLineGround]))}initialize(){var t,e;this.queue=(e="3d"===this.view.type?null==(t=this.view.resourceController)?void 0:t.scheduler:void 0,new Z({task:G.ELEVATION_PROFILE,concurrency:1,scheduler:e,process:async t=>{h(t.queryOptions);try{await async function({geometry:t,provider:e,indices:s,result:i,queryOptions:o}){if(0===s.length)return null;const r=(await e.queryElevation(t,o)).geometry,n=o.noDataValue,a=i.samples;for(let t=0;t<s.length;t++){const e=a[s[t]],{hasZ:i,z:o}=r.getPoint(t);e.z=i&&o!==n?o:null,e.processed=!0}}(t)}catch(t){if(y(t))return}}})),this._interaction=new lt({parentViewModel:this}),this._handles.add(this._watchAndUpdateProfiles()),this._visualization.initialize()}destroy(){this._handles.destroy(),this._handles=null,this.defaultProfileLineGround.destroy(),this.defaultProfileLineGround=null,this._visualization.destroy(),this._visualization=null,this._interaction.destroy(),this._interaction=null,this.queue=r(this.queue),this._currentTileCache=r(this._currentTileCache)}set profiles(t){const e=this._get("profiles"),s=null!=t?t:new _;this._set("profiles",k(s,e))}get state(){var t;switch(null==(t=this._interaction)?void 0:t.state){case nt.Ready:return ut.Ready;case nt.Creating:return ut.Creating;case nt.Selecting:return ut.Selecting;case nt.Selected:return ut.Selected;case nt.Reshaping:return ut.Created}}get progress(){let t=0,e=0;for(const s of this.visibleProfiles)t++,e+=s.progress;return t>0?e/t:0}set unitOptions(t){this._userUnitOptions=t,this._set("unitOptions",this._filteredOrAllUnits(this._userUnitOptions))}get unitOptions(){return this._filteredOrAllUnits(this._userUnitOptions)}set unit(t){this._userUnit=t?this._findSelectableUnit(t,this._userUnit):null,this.notifyChange("unit")}get unit(){return this._userUnit?(this._userUnit=this._findSelectableUnit(this._userUnit,this.defaultUnit),this._userUnit):this._findSelectableUnit(this.defaultUnit)}get effectiveUnits(){const t=function(t){let e=null,s=null,r=null;for(const o of t){if(i(o))continue;const{statistics:t,spatialReference:n}=o;if(i(t))continue;const a=C(n);e=_t(e,kt(t.maxDistance,a));const l=D(n);r=vt(r,kt(t.minElevation,l)),s=_t(s,kt(t.maxElevation,l))}return{minDistance:0,maxDistance:o(e,0),minElevation:o(r,0),maxElevation:o(s,0)}}(this.visibleProfiles.map((t=>t.result)));return{distance:E(t.maxDistance,"meters",this.unit),elevation:x(t.maxElevation,"meters",this.unit)}}get hoveredPoints(){return i(this.input)?[]:this.visibleProfiles.map((t=>{const s=t.hoveredPoint;return e(s)?{hoveredPoint:s,color:t.color}:null})).filter(e)}get statistics(){return function(t){const s=t.filter(e),i=s.length;if(0===i)return null;const o=s[0];if(1===i)return o;let r=o.maxDistance,n=o.minElevation,a=o.maxElevation,l=o.maxPositiveSlope,p=o.maxNegativeSlope;for(let t=1;t<s.length;++t){const e=s[t];r=_t(r,e.maxDistance),n=vt(n,e.minElevation),a=_t(a,e.maxElevation),l=_t(l,e.maxPositiveSlope),p=_t(p,e.maxNegativeSlope)}return{maxDistance:r,minElevation:n,maxElevation:a,avgElevation:null,elevationGain:null,elevationLoss:null,maxPositiveSlope:l,maxNegativeSlope:p,avgPositiveSlope:null,avgNegativeSlope:null}}(this.visibleProfiles.map((t=>t.statistics)))}get chartData(){if(i(this.input))return null;const t=[];for(const{id:s,type:i,title:r,color:n,samples:a,progress:l,showFill:p}of this.visibleProfiles){o(a,[]).some((t=>e(t.z)))&&t.push({id:s,type:i,title:r,color:n,samples:a,progress:l,showFill:p})}return 0===t.length?null:{lines:t,effectiveUnits:this.effectiveUnits,statistics:this.statistics,progress:this.progress}}get visibleProfiles(){return this.profiles.toArray().filter((t=>t.visible))}get minDemResolutions(){const t=[];for(const{minDemResolution:s}of this.visibleProfiles)e(s)&&t.push(s);return t}get elevationUnitsPerPixel(){return c(this.minDemResolutions)}get minDemResolution(){return u(this.minDemResolutions)}get canStopCreating(){return this._interaction.canStopCreating}get errorState(){const t=s(this.input,(t=>t.geometry));return function(t){return rt(t)&&t.paths.length>1}(t)?1:ot(t)?0===this.visibleProfiles.length?2:i(this.chartData)&&1===this.progress?3:4:0}get tileCache(){var t,e;return r(this._currentTileCache),this._currentTileCache="3d"===(null==(t=this.view)?void 0:t.type)&&null!=(e=this.view)&&e.resourceController?new st(this.view.resourceController.memoryController.getMemCache("elevation-profile-widget")):new st(new V(20971520)),this._currentTileCache}get test(){return{interaction:this._interaction}}start(t){this._interaction.start(t)}stop(){this._interaction.stop()}cancel(){this._interaction.cancel()}clear(){this._interaction.clear()}_watchAndUpdateProfiles(){const t=()=>{this._handles.remove("profiles");const t=[];for(const e of this.profiles){const s=new Ct({line:e,viewModel:this});t.push(n((()=>s.destroy())),e.watch("visible",(()=>this.notifyChange("visibleProfiles"))))}this._handles.add(t,"profiles"),this.notifyChange("visibleProfiles")};return[O(this,"profiles","change",t,t,t),T(this,"visibleProfiles",(()=>{this._handles.remove("visible-profiles");const t=[];for(const e of this.visibleProfiles)t.push(e.watch(["id","title","color","samples","progress"],(()=>this.notifyChange("chartData"))),e.watch("minDemResolution",(()=>this.notifyChange("minDemResolutions"))),e.watch("statistics",(()=>this.notifyChange("statistics"))),e.watch("result",(()=>this.notifyChange("effectiveUnits"))),e.watch("progress",(()=>this.notifyChange("progress"))),e.watch(["color","hoveredPoint"],(()=>this.notifyChange("hoveredPoints"))));this._handles.add(t,"visible-profiles")}))]}_findSelectableUnit(t,s){const i=this.unitOptions;return e(t)&&-1!==i.indexOf(t)?t:s?this._findSelectableUnit(s):i[0]}_filteredOrAllUnits(t){const s=(e(t)?t:[]).filter((t=>-1!==R.indexOf(t)));return 0===s.length?R.slice():s}};t([a()],Lt.prototype,"view",void 0),t([a({type:I})],Lt.prototype,"input",void 0),t([a({type:ct,nonNullable:!0})],Lt.prototype,"profiles",null),t([a({readOnly:!0})],Lt.prototype,"state",null),t([a({readOnly:!0})],Lt.prototype,"progress",null),t([a()],Lt.prototype,"unitOptions",null),t([a()],Lt.prototype,"unit",null),t([a({readOnly:!0})],Lt.prototype,"effectiveUnits",null),t([a({type:Number})],Lt.prototype,"geodesicDistanceThreshold",void 0),t([a()],Lt.prototype,"hoveredChartPosition",void 0),t([a({readOnly:!0})],Lt.prototype,"hoveredPoints",null),t([a({readOnly:!0})],Lt.prototype,"statistics",null),t([a()],Lt.prototype,"chartData",null),t([a()],Lt.prototype,"visibleProfiles",null),t([a()],Lt.prototype,"minDemResolutions",null),t([a()],Lt.prototype,"elevationUnitsPerPixel",null),t([a({readOnly:!0})],Lt.prototype,"minDemResolution",null),t([a({readOnly:!0})],Lt.prototype,"canStopCreating",null),t([a({readOnly:!0})],Lt.prototype,"errorState",null),t([a(J)],Lt.prototype,"defaultUnit",void 0),t([a()],Lt.prototype,"queue",void 0),t([a()],Lt.prototype,"tileCache",null),t([a()],Lt.prototype,"_visualization",void 0),t([a()],Lt.prototype,"_interaction",void 0),t([a()],Lt.prototype,"_userUnitOptions",void 0),t([a()],Lt.prototype,"_userUnit",void 0),Lt=t([v("esri.widgets.ElevationProfile.ElevationProfileViewModel")],Lt);var Et=Lt;export default Et;export{ut as E,mt as F,gt as H,ft as I,yt as N,dt as P,jt as a};
