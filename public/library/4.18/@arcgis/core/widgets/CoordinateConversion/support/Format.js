/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../chunks/ArrayPool.js";import"../../../chunks/object.js";import"../../../chunks/deprecate.js";import"../../../core/lang.js";import"../../../config.js";import"../../../chunks/Logger.js";import"../../../chunks/string.js";import"../../../chunks/metadata.js";import{property as t}from"../../../core/accessorSupport/decorators/property.js";import r from"../../../core/Accessor.js";import"../../../chunks/PropertyOrigin.js";import"../../../core/scheduling.js";import{resolve as o,reject as n}from"../../../core/promiseUtils.js";import"../../../chunks/Message.js";import i from"../../../core/Error.js";import"../../../chunks/ensureType.js";import{subclass as s}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../chunks/JSONSupport.js";import"../../../core/urlUtils.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../chunks/jsonMap.js";import"../../../chunks/reader.js";import"../../../chunks/writer.js";import"../../../chunks/resourceExtension.js";import a,{e as c}from"../../../geometry/SpatialReference.js";import"../../../kernel.js";import"../../../request.js";import"../../../chunks/assets.js";import"../../../geometry/Geometry.js";import p from"../../../geometry/Point.js";import"../../../chunks/Ellipsoid.js";import{project as l,canProject as m}from"../../../geometry/support/webMercatorUtils.js";import"../../../geometry/Extent.js";import"../../../chunks/mathUtils2.js";import"../../../chunks/vec3f64.js";import"../../../chunks/common.js";import"../../../chunks/vec3.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Multipoint.js";import"../../../geometry/Polygon.js";import"../../../chunks/extentUtils.js";import"../../../geometry/Polyline.js";import"../../../chunks/typeUtils.js";import"../../../geometry/support/jsonUtils.js";import"../../../geometry.js";import"../../../chunks/unitUtils.js";import u from"../../../tasks/support/ProjectParameters.js";import"../../../chunks/mat4.js";import"../../../chunks/pe.js";import"../../../chunks/aaBoundingRect.js";import"../../../chunks/geodesicConstants.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../geometry/support/GeographicTransformation.js";import{isLoaded as d,project as h}from"../../../geometry/projection.js";import{fromUsng as f,fromUtm as g,fromMgrs as v,fromLatitudeLongitude as j,toUtm as y,toUsng as w,toMgrs as S,toLatitudeLongitude as R}from"../../../geometry/coordinateFormatter.js";const k={utm:{conversionMode:"utmDefault",addSpaces:!0},usng:{numOfDigits:5,rounding:!1,addSpaces:!1},mgrs:{rounding:!1}},P=new Array(3);function b(e){return e>=500?6:e<500&&e>=50?7:e<50&&e>=5?8:9}function M(e){return"number"==typeof e&&isFinite(e)}function _(e){return e&&M(e.x)&&M(e.y)}function x(e,t){if(e.spatialReference.isGeographic&&t){const[r,o]=function(e,t){const r=b(t);return[e[0].toFixed(r),e[1].toFixed(r)]}([e.x,e.y],t);return`${r}, ${o}`}return`${e.x.toFixed(3)}, ${e.y.toFixed(3)}`}function C(e){return"dd"===e||"dms"===e||"ddm"===e||"mgrs"===e||"usng"===e||"utm"===e}let G=class extends r{constructor(e){super(e),this.conversionInfo=null,this.coordinateSegments=null,this.defaultPattern=null,this.name=null,this.viewModel=null}get currentPattern(){return this._get("currentPattern")||this._get("defaultPattern")}set currentPattern(e){this._set("currentPattern",e)}get hasDisplayProperties(){return!(!this.defaultPattern||!this.coordinateSegments)}get spatialReference(){const e=this.get("conversionInfo.spatialReference")||a.WGS84;return"basemap"===this.name?this._viewSpatialReference:e}set spatialReference(e){void 0===e&&this._clearOverride("spatialReference"),this._override("spatialReference",e)}get _viewSpatialReference(){return this.get("viewModel.view.spatialReference")||a.WGS84}get _additionalCharactersPattern(){const e=this.get("coordinateSegments");if(!e)return null;const t=e.map((e=>e.alias)),r=this.currentPattern.replace(new RegExp(`["nsew${t.join()}]`,"gi"),"").replace(/\ /g,"");return new RegExp(`[${r}]`,"g")}convert(e,t){if(!_(e))return n(new i("format:invalid-point","Could not convert invalid point.",{point:e}));const r=this.get("conversionInfo.convert");return r?o().then((()=>r(e))):this._project(e,this.spatialReference,t).then((e=>this._getCoordinate(e).then((t=>({location:e,coordinate:t})))))}getConversionStrategy(){const e=this._viewSpatialReference;return this.get("conversionInfo.convert")||this.get("viewModel.formatterAvailable")||"xy"===this.name&&(e.isWebMercator||e.isWGS84)||"basemap"===this.name?"client":"server"}getDisplayCoordinate(e){if(!e)return null;if(!this.coordinateSegments||!this.currentPattern)return e;let t=this.currentPattern;const r=this._getSegmentMatches(e,!1);for(let e=this.coordinateSegments.length-1;e>=0;e--){const o=this.coordinateSegments[e];t=t.replace(o.alias,r[e])}return t}parseUserInput(e){let t=this.defaultPattern.replace(this._additionalCharactersPattern,"");e=e.replace(this._additionalCharactersPattern,"");const r=this._getSegmentMatches(e,!0);for(let e=this.coordinateSegments.length-1;e>=0;e--){const o=this.coordinateSegments[e];t=t.replace(o.alias,r[e])}return t}_getSegmentMatches(e,t){const r=[];for(let o=0;o<this.coordinateSegments.length;o++){const n=this.coordinateSegments[o],i=e.match(n.searchPattern);if(!i){r.push("");continue}let s=i[0];if(e=e.replace(s,"").trim(),n.substitution){const e=t?n.substitution.input(s):n.substitution.output(s);e&&(s=e)}r.push(s)}return r}reverseConvert(e){const t=this.parseUserInput(e),r=this.get("conversionInfo.reverseConvert"),o=C(this.name);let s;if(r)s=r(t);else if("xy"===this.name||"basemap"===this.name)s=function(e,t){const r=e.indexOf(",")>=0?",":" ",[o,n,i]=e.split(r).map((e=>{const t=e.trim();return t?Number(t):null}));if(!M(o)||!M(n))return null;const s=new p({x:o,y:n,spatialReference:t||a.WGS84});return i&&(s.z=i,s.hasZ=!0),s}(t,this.spatialReference);else if(this.viewModel.formatterAvailable)switch(this.name){case"dd":case"ddm":case"dms":s=j(t,this.spatialReference);break;case"mgrs":{const e="automatic";s=v(t,this.spatialReference,e);break}case"utm":{const e="latitude-band-indicators";s=g(t,this.spatialReference,e);break}case"usng":s=f(t,this.spatialReference);break;default:s=null}else if(o)return function(e){const{geometryServicePromise:t,coordinate:r,spatialReference:o,formatName:n}=e;return t.then((e=>e.fromGeoCoordinateString({strings:[r],sr:o,conversionType:n}).then((e=>{const t=new p({x:e[0][0],y:e[0][1],spatialReference:o});if(!_(t))throw e;return t})).catch((e=>{throw new i("coordinate-conversion:from-geo-coordinate-string-failed","Failed to convert coordinate notation",{notationResult:e})}))))}({coordinate:t,spatialReference:this.spatialReference,formatName:this.name,geometryServicePromise:this.get("viewModel.geometryServicePromise")});return s?this._project(s,this._viewSpatialReference):n(new i("format:invalid-input","Could not parse input into point.",{userInput:e}))}_getCoordinate(e){const t=this.get("viewModel.view.scale");if(!_(e))return n(new i("format:invalid-point","Could not transform invalid point into coordinate.",{point:e}));if(this.get("viewModel.formatterAvailable")||"basemap"===this.name||"xy"===this.name)switch(this.name){case"dd":case"ddm":case"dms":{const r=b(t);return o(R(e,this.name,r))}case"mgrs":return o(S(e,"automatic",5,!1));case"usng":return o(w(e,5,!1));case"utm":return o(y(e,"latitude-band-indicators",!0));default:return o(x(e,t))}return C(this.name)?function(e){const{formatName:t,location:r,geometryServicePromise:o}=e,n=k[t]||{},s={coordinates:[[r.x,r.y]],sr:r.spatialReference,conversionType:t,...n};return o.then((e=>e.toGeoCoordinateString(s).then((e=>{const t=e[0];if(!t)throw e;return t})).catch((e=>{throw new i("coordinate-conversion:to-geo-coordinate-string-failed","Failed to convert coordinate notation",{notationResult:e})}))))}({formatName:this.name,location:e,geometryServicePromise:this.get("viewModel.geometryServicePromise")}):o(x(e,t))}_project(e,t,r){return c(e.spatialReference,t)||!t?o(e):this.get("viewModel.formatterAvailable")&&d()?o(h(e,t)):this.get("viewModel.formatterAvailable")?null:m(e,t)?o(l(e,t)):function(e,t){const{spatialReference:r,geometryServicePromise:n,location:s,scale:a}=e;if(!r||s.spatialReference.wkid===r.wkid)return o({location:s,coordinate:x(s,a)});if((s.spatialReference.isWGS84||s.spatialReference.isWebMercator)&&(r.isWGS84||r.isWebMercator))return o({location:l(s,r),coordinate:x(s,a)});if(P[0]===s&&P[1]===r.wkid)return P[2];P[0]=s,P[1]=r.wkid;const c=n.then((e=>e.project(new u({geometries:[s],outSpatialReference:r}),{signal:t}).then((e=>{if(!_(e[0]))throw e[0];return{location:e[0],coordinate:x(e[0],a)}})).catch((e=>{throw new i("coordinate-conversion:projection-failed","Failed to project point",{projectionResult:e})}))));return P[2]=c,c}({location:e,spatialReference:t,geometryServicePromise:this.get("viewModel.geometryServicePromise"),scale:this.get("viewModel.view.scale")},r).then((e=>e.location))}};e([t()],G.prototype,"conversionInfo",void 0),e([t()],G.prototype,"coordinateSegments",void 0),e([t()],G.prototype,"currentPattern",null),e([t()],G.prototype,"defaultPattern",void 0),e([t({readOnly:!0,dependsOn:["defaultPattern","coordinateSegments"]})],G.prototype,"hasDisplayProperties",null),e([t()],G.prototype,"name",void 0),e([t({dependsOn:["_viewSpatialReference","name"],type:a})],G.prototype,"spatialReference",null),e([t()],G.prototype,"viewModel",void 0),e([t({dependsOn:["viewModel.view.spatialReference"],readOnly:!0})],G.prototype,"_viewSpatialReference",null),e([t({readOnly:!0,dependsOn:["currentPattern"]})],G.prototype,"_additionalCharactersPattern",null),G=e([s("esri.widgets.CoordinateConversion.support.Format")],G);var O=G;export default O;export{C as a,_ as i};
