/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import{h as e}from"../../chunks/object.js";import"../../chunks/deprecate.js";import"../../core/lang.js";import"../../config.js";import{L as s,b as i,i as r}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import a from"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import{addFrameTask as n}from"../../core/scheduling.js";import{c as l,ignoreAbortErrors as p}from"../../core/promiseUtils.js";import"../../chunks/Message.js";import"../../core/Error.js";import{n as u}from"../../chunks/compilerUtils.js";import"../../chunks/ensureType.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import h from"../../core/Collection.js";import{c as d,r as m}from"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/Promise.js";import"../../chunks/Loadable.js";import"../../chunks/asyncUtils.js";import"../../core/urlUtils.js";import{aliasOf as g}from"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/shared.js";import"../../chunks/writer.js";import"../../chunks/multiOriginJSONSupportUtils.js";import"../../chunks/resourceExtension.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/persistable.js";import"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import"../../chunks/number.js";import"../../intl.js";import"../../kernel.js";import"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import y from"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalUser.js";import"../../portal/Portal.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../portal/PortalItem.js";import{d as j,r as A}from"../../chunks/mathUtils2.js";import{a as f,f as b,c as v}from"../../chunks/vec3f64.js";import"../../chunks/common.js";import{l as k,s as w,g as P,d as M,e as _,n as S,a as T,c as x,m as L,f as C,i as U}from"../../chunks/vec3.js";import"../../chunks/mathUtils.js";import"../../chunks/colorUtils.js";import"../../Color.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import"../../layers/support/fieldUtils.js";import"../../popup/content/Content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/CustomContent.js";import"../../chunks/date.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/FieldInfo.js";import"../../popup/content/FieldsContent.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/MediaContent.js";import"../../popup/content/TextContent.js";import"../../popup/content.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/RelatedRecordsInfo.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../PopupTemplate.js";import"../../symbols/Symbol.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol3DLayer.js";import{e as I,c as R,s as O,b as E}from"../../chunks/screenUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/materialUtils.js";import"../../symbols/edges/Edges3D.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/utils.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/patterns/StylePattern3D.js";import"../../symbols/FillSymbol3DLayer.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/Symbol3D.js";import"../../chunks/Thumbnail.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/uid.js";import"../../Graphic.js";import V from"../../core/Handles.js";import D from"../../layers/Layer.js";import"../../chunks/LegendOptions.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../tasks/support/ColorRamp.js";import"../../tasks/support/AlgorithmicColorRamp.js";import"../../tasks/support/MultipartColorRamp.js";import"../../chunks/colorRamps.js";import"../../renderers/Renderer.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/unitUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/VisualVariablesMixin.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../renderers/ClassBreaksRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/styleUtils.js";import"../../renderers/UniqueValueRenderer.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/MemCache.js";import"../../chunks/LRUCache.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import"../../TimeInterval.js";import"../../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../../chunks/MultiOriginJSONSupport.js";import{init as G}from"../../core/watchUtils.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/fieldType.js";import"../../geometry/HeightModelInfo.js";import{d as H,i as z,s as F,m as B,e as N,t as W,n as q,r as Q,p as K}from"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/projection.js";import"../../chunks/OperationalLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/commonProperties2.js";import"../../core/HandleOwner.js";import"../../chunks/_commonjsHelpers.js";import"../../core/workers/Connection.js";import"../../chunks/Scheduler.js";import"../../core/workers/workers.js";import"../../form/ExpressionInfo.js";import"../../form/elements/FieldElement.js";import"../../form/support/elements.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/GroupElement.js";import"../../form/FormTemplate.js";import"../../chunks/vec4f64.js";import{c as X}from"../../chunks/quatf64.js";import"../../chunks/mat3.js";import"../../chunks/BufferView.js";import"../../chunks/vec2.js";import"../../chunks/vec4.js";import{r as Z}from"../../chunks/quat.js";import"../../chunks/domUtils.js";import"../../chunks/widgetUtils.js";import"../../chunks/projector.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../../chunks/renderable.js";import"../../chunks/vmEvent.js";import"../../chunks/index.js";import"../support/widget.js";import"../Widget.js";import"../../chunks/zscale.js";import"../../chunks/queryZScale.js";import"../../layers/support/Field.js";import"../../tasks/support/FeatureSet.js";import"../../layers/FeatureLayer.js";import"../../chunks/ArcGISService.js";import"../../chunks/BlendLayer.js";import"../../chunks/CustomParametersMixin.js";import"../../chunks/PortalLayer.js";import"../../chunks/RefreshableLayer.js";import"../../chunks/ScaleRangeLayer.js";import"../../layers/support/TimeInfo.js";import"../../chunks/TemporalLayer.js";import"../../layers/support/FeatureReductionSelection.js";import"../../layers/support/FeatureReductionCluster.js";import"../../chunks/labelUtils.js";import"../../layers/support/LabelClass.js";import"../../chunks/defaultsJSON.js";import"../../chunks/defaults.js";import"../../chunks/featureReductionUtils.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/labelingInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/DataLayerSource.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";import"../../tasks/support/AttachmentQuery.js";import"../../tasks/support/Query.js";import"../../tasks/support/StatisticDefinition.js";import"../../tasks/support/RelationshipQuery.js";import"../../layers/buildingSublayers/BuildingSublayer.js";import"../../chunks/capabilities.js";import"../../chunks/I3SLayerDefinitions.js";import Y from"../../layers/buildingSublayers/BuildingComponentSublayer.js";import"../../tasks/Task.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/featureConversionUtils.js";import"../../tasks/QueryTask.js";import"../../chunks/pbf.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/query.js";import"../../layers/support/AttachmentInfo.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/Queue.js";import"../../chunks/InputManager.js";import{b as J}from"../../chunks/interactiveToolUtils.js";import"../../chunks/throttle.js";import"../Attachments.js";import"../Attachments/AttachmentsViewModel.js";import"../Feature/FeatureViewModel.js";import"../Feature.js";import"../../chunks/AnchorElementViewModel.js";import"../Spinner/SpinnerViewModel.js";import"../Popup.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../../chunks/GoTo.js";import"../Popup/PopupViewModel.js";import{c as $}from"../../chunks/screenUtils2.js";import"../../chunks/quantizationUtils.js";import"../../chunks/dehydratedFeatures.js";import"../../chunks/ElevationProvider.js";import"../../chunks/vec2f64.js";import"../../chunks/requestImageUtils.js";import{S as tt,g as et,b as st,D as it,V as rt,R as ot,M as at,r as nt,G as lt,t as pt}from"../../chunks/PiUtils.glsl.js";import{P as ut}from"../../chunks/Program.js";import{m as ct,s as ht,d as dt}from"../../chunks/isWebGL2Context.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/mat4f32.js";import"../../chunks/vec3f32.js";import{r as mt,c as gt,R as yt,p as jt,e as At,b as ft,S as bt,O as vt,T as kt,U as wt}from"../../chunks/geometryUtils.js";import{D as Pt,e as Mt,R as _t,C as St,G as Tt}from"../../chunks/ColorMaterial.js";import{V as xt}from"../../chunks/Util.js";import{G as Lt,a as Ct}from"../../chunks/Geometry.js";import"../../chunks/VertexArrayObject.js";import"../../chunks/Object3D.js";import"../../chunks/intersectorUtils.js";import{I as Ut}from"../../chunks/Intersector.js";import"../../chunks/Camera.js";import"../../chunks/DefaultTextureUnits.js";import"../../chunks/GLMaterialTexture.js";import{T as It}from"../../chunks/Texture.js";import{N as Rt}from"../../chunks/NativeLineMaterial.js";import"../../chunks/elevationInfoUtils.js";import{I as Ot,c as Et}from"../../chunks/InteractiveToolBase.js";import{I as Vt}from"../../chunks/InteractiveToolViewModel.js";import{a as Dt}from"../../chunks/dragEventPipeline3D.js";import{M as Gt,b as Ht,d as zt}from"../../chunks/manipulatorUtils.js";import{I as Ft}from"../../chunks/ImageMaterial.js";import Bt from"./SlicePlane.js";const Nt=e("mac")?"Meta":"Control",Wt=Math.cos(j(45)),qt=Math.cos(j(5)),Qt=[1,.5,0],Kt=[...Qt,.7],Xt=[0,0,0,.04],Zt=[...Qt,.5],Yt=[...Qt,1],Jt=[1,1,1,1],$t=[1,.8,.6,1],te=[1,.93,.86,1],ee=[...Qt,1],se=[...Qt,1];var ie=Object.freeze({__proto__:null,build:function(){const t=new tt;return t.extensions.add("GL_OES_standard_derivatives"),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.varyings.add("vUV","vec2"),t.vertex.code.add(et`
    void main(void) {
      vUV = uv0;
      gl_Position = proj * view * vec4(position, 1.0);
    }
  `),t.fragment.uniforms.add("backgroundColor","vec4").add("gridColor","vec4").add("ratio","float").add("gridWidth","float"),t.fragment.code.add(et`
    void main() {
      const float LINE_WIDTH = 1.0;

      vec2 uvScaled = vUV * gridWidth;
      vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
      vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);

      // mask aliasing along edges
      grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
      grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);

      float gridFade = max(grid.x, grid.y);

      float gridAlpha = gridColor.a * gridFade;

      // premultiply alpha in output
      gl_FragColor =
        vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
        vec4(gridColor.rgb, 1.0) * gridAlpha;
    }
  `),t}});class re extends st{initializeProgram(t){const e=re.shader.get().build();return new ut(t.rctx,e.generateSource("vertex"),e.generateSource("fragment"),it)}bindPass(t,e,s){rt.bindProjectionMatrix(this.program,s.camera.projectionMatrix),this.program.setUniform4fv("backgroundColor",e.backgroundColor),this.program.setUniform4fv("gridColor",e.gridColor),this.program.setUniform1f("gridWidth",e.gridWidth)}bindDraw(t){rt.bindView(this.program,t)}initializePipeline(){return ct({blending:ht(1,1,771,771),depthTest:{func:513},colorWrite:dt})}}re.shader=new ot(ie,(()=>Promise.resolve().then((function(){return ie}))));class oe extends at{constructor(t,e){super(e,t,ne)}intersect(t,e,s,i,r,o,a){return nt(t,e,i,r,o,void 0,a)}createBufferWriter(){return new Pt(Mt)}getGLMaterial(t){return 0===t.output?new ae(t):void 0}}class ae extends lt{constructor(t){super(t),this.technique=new re(this.techniqueRep.constructionContext,null),this.updateParameters()}updateParameters(){}beginSlot(t){return 8===t}bind(t,e){t.bindProgram(this.technique.program),this.technique.bindPass(t,this.material.params,e)}}const ne={backgroundColor:[1,0,0,.5],gridColor:[0,1,0,.5],gridWidth:4,...pt},le=s.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function pe(t,e,s,i,r,o,a,n){return function(t,e,s,i,r,o){const a=M(t,e),n=gt.get(),l=gt.get();switch(0===i?Math.abs(a)>Wt?1:2:i){case 2:{const i=Math.abs(a)<=qt?t:s.viewUp;_(n,i,e),P(l,e);break}case 1:_(n,s.viewUp,e),_(l,e,n);break;case 3:{const i=Math.abs(a)<=qt?e:s.viewUp;_(n,i,t),_(l,t,n);break}}const p=_(gt.get(),n,l);M(p,s.viewForward)>0&&w(l,l,-1);S(r,n),S(o,l)}(e,a.worldUpAtPosition(t,gt.get()),r,o,n.basis1,n.basis2),w(n.basis1,n.basis1,s),w(n.basis2,n.basis2,i),P(n.origin,t),jt.fromVectorsAndPoint(n.basis2,n.basis1,n.origin,n.plane),n}function ue(t,e,s,i){const r=e.worldUpAtPosition(t.origin,gt.get()),o=gt.get();switch(s){case 1:P(o,r);break;case 2:P(o,t.basis1)}return jt.fromPositionAndNormal(t.origin,o,i)}function ce(t,e,s,i){const r=he(s,2),o=ft.get();H(o,e,r.edge*Math.PI/2);const a=S(gt.get(),r.basis);let n=w(gt.get(),a,r.direction*i.computeScreenPixelSizeAt(r.position)*40);T(n,n,r.position);const l=i.projectToRenderScreen(n,I(gt.get())),p=function(t,e){const[s,i,r,o]=t.viewport,a=Math.min(r,o)/16;let n=!0;e[0]<s+a?(e[0]=s+a,n=!1):e[0]>s+r-a&&(e[0]=s+r-a,n=!1);e[1]<i+a?(e[1]=i+a,n=!1):e[1]>i+o-a&&(e[1]=i+o-a,n=!1);return n}(i,l);mt.fromRender(i,l,Me),S(Me.direction,Me.direction);const u=gt.get();!p&&At.intersectRay(s,Me,u)&&(n=u),o[12]=0,o[13]=0,o[14]=0,t.modelTransform=o,t.renderLocation=f(n),p?t.state|=Pe:t.state&=~Pe}function he(t,e){switch(e){case 0:return{basis:t.basis1,direction:1,position:T(gt.get(),t.origin,t.basis1),edge:e};case 1:return{basis:t.basis2,direction:1,position:T(gt.get(),t.origin,t.basis2),edge:e};case 2:return{basis:t.basis1,direction:-1,position:x(gt.get(),t.origin,t.basis1),edge:e};case 3:return{basis:t.basis2,direction:-1,position:x(gt.get(),t.origin,t.basis2),edge:e}}}function de(t,e,s){const i=s.projectToRenderScreen(T(gt.get(),t,e),I(gt.get())),r=s.projectToRenderScreen(x(gt.get(),t,e),I(gt.get()));return L(x(i,i,r))}function me(t){const e=k(t.basis1),s=k(t.basis2);return.3*Math.min(e,s)}function ge(t){return me(t)}function ye(t){return 0!==t.direction[0]&&0!==t.direction[1]}function je(t){const e=[b(0,0,-24),b(0,0,24)],s=function(t,e){const s=x(v(),t[t.length-1],t[t.length-2]);if(S(s,s),w(s,s,12),T(s,s,t[t.length-1]),e){const e=x(v(),t[0],t[1]);return S(e,e),w(e,e,12),T(e,e,t[0]),[e,...t,s]}return[...t,s]}(e,!0),i=(t,s)=>function(t,e,s){const i=i=>{const o=(i?e:t).slice(0),a=x(gt.get(),o[0],o[1]);S(a,a);const n=x(gt.get(),o[o.length-1],o[o.length-2]);if(S(n,n),s.padding>0){const t=w(v(),n,-s.padding);if(o[o.length-1]=T(t,t,o[o.length-1]),s.bothEnds){const t=w(v(),a,-s.padding);o[0]=T(t,t,o[0])}}const l=i?s.tipFocusMultiplier:1,p=s.tipLength*(s.focusTipLength?l:1),u=s.tipRadius*l,c=z(ft.get());if(s.padding>0){const t=p/4,e=C(gt.get(),0,t,0),i=1+s.padding/t;W(c,c,e),F(c,c,C(gt.get(),i,i,i)),W(c,c,w(e,e,-1/i))}const h=z(X()),d=b(0,1,0),m=q(X(),Z(bt.get(),d,n));m[12]=o[o.length-1][0],m[13]=o[o.length-1][1],m[14]=o[o.length-1][2],B(m,m,c);const g=[{part:"tube",geometry:new Lt(function(t,e,s){const i=[];if(r(e))i.push([t,e.thickness/2],[-t,e.thickness/2],[-t,-e.thickness/2],[t,-e.thickness/2]);else{const e=12;for(let s=0;s<e;s++){const r=s/e*2*Math.PI;i.push([Math.cos(r)*t,Math.sin(r)*t])}}return Tt.createPathExtrusionGeometry(i,s,[],[],!1)}(s.tubeRadius*(i?s.tubeFocusMultiplier:1)+s.padding,s.flat,o),"arrow-tube"),transform:h}];let y,j;if(r(s.flat)?y=new Lt(Tt.createExtrudedTriangle(p,u,u,s.flat.thickness),"arrow-tip"):(y=new Lt(Tt.createConeGeometry(p,u,24,!1,!1,!0),"arrow-tip"),j=new Lt(Tt.createConeGeometry(p,u,24,!1,!0,!1),"arrow-cap")),g.push({part:"tip",geometry:y,transform:m}),j&&g.push({part:"cap",geometry:j,transform:m}),s.bothEnds){const t=q(X(),Z(bt.get(),d,a));t[12]=o[0][0],t[13]=o[0][1],t[14]=o[0][2],B(t,t,c),g.push({part:"tip",geometry:y,transform:t}),j&&g.push({part:"cap",geometry:j,transform:t})}return g};return{normal:i(!1),focused:i(!0)}}(e,e,{tubeRadius:3,tipRadius:11,tipLength:22.5,tubeFocusMultiplier:1.15,tipFocusMultiplier:1.15,padding:t,bothEnds:!0,flat:null,focusTipLength:!0,addCap:s}),o=i(0,!1),a=i(2.25,!0),n=new St({color:Jt,cullFace:2,renderOccluded:16},"slice-shift"),l=new St({color:$t,cullFace:2,renderOccluded:16},"slice-shift"),p=new St({color:te,cullFace:2,renderOccluded:16},"slice-shift"),u=new St({color:se,transparent:!0,writeDepth:!1,cullFace:1,renderOccluded:2},"slice-shift"),c=new Lt(Tt.createPolylineGeometry([[0,0,0],[-40,0,0]]),"slice-rotate-heading"),h=new Lt(Tt.createPolylineGeometry([[0,0,0],[-40,0,0]]),"slice-rotate-heading"),d=new Rt({color:ee,renderOccluded:4},"slice-rotate-heading");return new Gt({view:t,renderObjects:[...o.normal.map((({part:t,geometry:e,transform:s})=>({geometry:e,material:"tip"===t?n:"cap"===t?l:p,transform:s,stateMask:1|we}))),...a.normal.map((({geometry:t,transform:e})=>({geometry:t,material:u,transform:e,stateMask:1|we}))),{geometry:c,material:d,stateMask:1|we|Pe},...o.focused.map((({part:t,geometry:e,transform:s})=>({geometry:e,material:"tip"===t?n:"cap"===t?l:p,transform:s,stateMask:2|we}))),...a.focused.map((({geometry:t,transform:e})=>({geometry:t,material:u,transform:e,stateMask:2|we}))),{geometry:h,material:d,stateMask:2|we|Pe}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:11,state:we})}function Ae(t,e){const s=new Ft({transparent:!0,writeDepth:!1,textureId:e.id,renderOccluded:16},"slice-rotate"),i=40,r=27*1.1,o=t=>{const e=new Uint32Array([0,1,2,2,3,0]);return new Lt(new Ct({[xt.POSITION]:{size:3,data:new Float32Array([i-t,-t,0,i+t,-t,0,i+t,t,0,i-t,t,0])},[xt.UV0]:{size:2,data:new Float32Array([0,0,1,0,1,1,0,1])}},{[xt.POSITION]:e,[xt.UV0]:e}))},a=new Lt(Tt.createPolylineGeometry([[0,0,0],[13,0,0]]),"slice-rotate-heading"),n=new Lt(Tt.createPolylineGeometry([[0,0,0],[10.299999999999997,0,0]]),"slice-rotate-heading"),l=new Rt({color:Yt,renderOccluded:4},"slice-rotate-heading"),p=[{geometry:o(27),material:s,stateMask:1|we},{geometry:a,material:l,stateMask:1|we},{geometry:o(r),material:s,stateMask:2|we},{geometry:n,material:l,stateMask:2|we}];return new Gt({view:t,renderObjects:p,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[i,0,0]},collisionPriority:1,radius:13.5,state:we})}function fe(t){const e=new Lt(Tt.createPolylineGeometry([[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]),"slice-outline"),s=[...Kt],i=new _t({color:s,writeDepth:!1,width:2,renderOccluded:4},"slice-outline");return{manipulator:new Gt({view:t,renderObjects:[{geometry:e,material:i}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:i}}function be(t,e){const s=ye(e),i=s?[b(1,0,0),b(0,0,0),b(0,1,0)]:[b(1,0,0),b(-1,0,0)],r=new Lt(Tt.createPolylineGeometry(i),"slice-resize"),o=[...Qt,1],a=s?4:1,n=2*a,l=t=>t>1?(t=>new _t({color:o,width:t,renderOccluded:4},"slice-resize"))(t):new Rt({color:o,renderOccluded:4},"slice-resize");return new Gt({view:t,renderObjects:[{geometry:r,material:l(a),stateMask:1},{geometry:r,material:l(n),stateMask:2}],collisionType:{type:"line",paths:[i]},autoScaleRenderObjects:!1,worldSized:!0,radius:s?6:4})}function ve(t,e,s,o){if(i(t))return null;const a=r(o.position)?o.position:new y;e.fromRenderCoords(t.origin,a,s),o.position=a;const n=e.worldUpAtPosition(t.origin,gt.get()),l=e.worldBasisAtPosition(t.origin,1,gt.get());return o.width=2*k(t.basis1),o.height=2*k(t.basis2),o.tilt=A(ke(t,n)),o.heading=A(function(t,e,s){return yt(t.basis1,s,e)-_e}(t,n,l)),o}function ke(t,e){return yt(e,t.basis2,t.basis1)+_e}const we=16,Pe=32,Me=mt.create(),_e=Math.PI/2;const Se=s.getLogger("esri.views.3d.interactive.analysisTools.slice.SliceTool");let Te=class extends Ot{constructor(t){super(t),this.clock=l,this.deferCreation=!0,this.cursor=null,this.layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this.disableEngineLayers=!1,this._handles=new V,this._viewHandles=new V,this._frameTask=null,this._prevPointerMoveTimeout=null,this._previewOutlineManipulator=null,this._previewOutlineMaterial=null,this._outlineManipulator=null,this._gridManipulator=null,this._gridMaterial=null,this._startPlane=At.create(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=R(),this._baseOpacity=1,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=new Ut(t.view.state.mode),this._intersector.options.store=0}initialize(){this.rotateHeadingTexture=new It("data:image/png;base64,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","slice-rotate-heading",{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.rotateTiltTexture=new It("data:image/png;base64,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","slice-rotate-tilt",{width:64,height:64,mipmap:!0,preMultiplyAlpha:!0}),this.view._stage&&(this.view._stage.add(4,this.rotateHeadingTexture),this.view._stage.add(4,this.rotateTiltTexture));const t=G(this,"state",(t=>{"ready"!==t&&this.create(),"sliced"===t&&this.complete()}),!0);this._handles.add([t,this.view.state.watch("camera",(()=>this._onCameraChange())),this.excludedLayers.on("before-add",(t=>{const e=t.item;null!=e&&(e instanceof D||e instanceof Y)?e instanceof D&&function(t){switch(t.type){case"building-scene":case"csv":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"scene":case"stream":case"unknown":case"unsupported":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return u(t.type),!1}}(e)?(Se.error("excludedLayers",`Layer '${e.title}, id:${e.id}' of type '${e.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),t.preventDefault()):this.excludedLayers.includes(e)&&t.preventDefault():(Se.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())}))]);const e=t=>{this.updateManipulatorsInteractive(t),t.grabbing||(r(this.plane)&&At.copy(this.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=je(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",(t=>{this._onShiftGrab(t),e(this.shiftManipulator)})),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=Ae(this.view,this.rotateHeadingTexture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",(t=>{this._onRotateHeadingGrab(t),e(this.rotateHeadingManipulator)})),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=Ae(this.view,this.rotateTiltTexture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",(t=>{this._onRotateTiltGrab(t),e(this.rotateTiltManipulator)})),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map(((t,s)=>{const i=be(this.view,t);return i.events.on("grab-changed",(t=>{this._onResizeGrab(t,s),e(i)})),this._handles.add(this._createResizeDragPipeline(i)),i})),this.manipulators.addMany(this.resizeManipulators);const{manipulator:s,material:i}=fe(this.view);this._previewOutlineManipulator=s,this._previewOutlineMaterial=i,this.manipulators.add(this._previewOutlineManipulator,2),this._outlineManipulator=fe(this.view).manipulator,this.manipulators.add(this._outlineManipulator,1);const{manipulator:o,material:a}=function(t){const e=new Lt(Tt.createSquareGeometry(),"slice-grid"),s=[...Xt],i=new oe({backgroundColor:s,gridColor:Zt,gridWidth:4,renderOccluded:4},"slice-grid");return{manipulator:new Gt({view:t,renderObjects:[{geometry:e,material:i}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:i}}(this.view);this._gridManipulator=o,this._gridMaterial=a,this.manipulators.add(this._gridManipulator,2)}destroy(){this.view._stage&&(this.view._stage.remove(4,this.rotateHeadingTexture.id),this.view._stage.remove(4,this.rotateTiltTexture.id)),this.detach(),this._handles.destroy(),this._handles=null,this._viewHandles.destroy(),this._viewHandles=null,this._removeFrameTask(),this._clearPointerMoveTimeout()}get state(){const t=!!this.plane,e=!!this.inputState;return t?t&&e?"slicing":t&&!e?"sliced":"ready":"ready"}get isSupported(){return"3d"===this.get("view.type")}set plane(t){this.view?r(t)&&!this.tiltEnabled?this.internalSetPlane(function(t,e,s){const i=e.worldUpAtPosition(t.origin,gt.get()),r=t.basis1,o=ke(t,i),a=Math.round(o/_e)*_e;return At.rotate(t,a-o,r,s)}(t,this.view.renderCoordsHelper,At.create())):this.internalSetPlane(t):this._set("plane",t)}internalSetPlane(t){this._set("plane",t),this.planeChanged()}planeChanged(){this.view&&(this._updateLayerViews(),this.visible&&this.attached&&(this.view.slicePlane=this.plane,this._updateManipulators()))}get excludedLayers(){return this._get("excludedLayers")||new h}set excludedLayers(t){this._set("excludedLayers",m(t,this._get("excludedLayers")))}set excludeGroundSurface(t){this._set("excludeGroundSurface",t),this.view&&this._updateLayerViews()}set tiltEnabled(t){t!==this._get("tiltEnabled")&&(this._set("tiltEnabled",t),this.view&&(this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),r(this.plane)&&!t&&(this.plane=At.copy(this.plane)),this._updateManipulators()))}get inputState(){return this._get("inputState")}set inputState(t){this._set("inputState",t),this._updateMaterials()}get _isTargeting(){return!this.inputState&&!this.plane&&this.active}get _creatingPointerId(){return this.inputState&&"shift"===this.inputState.type?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){this.created&&(this._set("layersMode","exclude"),J(this,!0))}exitExcludeLayerMode(){this.created&&(this._set("layersMode","none"),J(this,!1))}deactivate(){this._updateMouseCursor(),this._set("layersMode","none"),this._updatePreviewPlane(null)}onDetach(){this.plane=null,this._set("layersMode","none")}onShow(){this._updateMouseCursor(),this._updateLayerViews(),this._updateManipulators();const t=this.view;t.slicePlane=this.plane,0===this._viewHandles.size&&this._viewHandles.add([t.allLayerViews.on("change",(()=>this._updateLayerViews())),this.excludedLayers.on("change",(()=>this._updateLayerViews()))])}onHide(){this._updateMouseCursor(),this._updateLayerViews(),this.view.slicePlane=null,this._viewHandles.removeAll(),this._clearPointerMoveTimeout()}onInputEvent(t){switch(t.type){case"pointer-down":if(!Le(t))return;this._onPointerDown(t)&&(t.stopPropagation(),this._updateMouseCursor());break;case"pointer-drag":if(!Le(t))return;this._onPointerDrag(t)&&t.stopPropagation();break;case"pointer-move":this._onPointerMove(t),this._updateMouseCursor();break;case"pointer-up":this._onPointerUp(t)&&t.stopPropagation();break;case"click":if(!Le(t))return;this._onClick(t)&&t.stopPropagation();break;case"drag":this.inputState&&t.stopPropagation();break;case"key-down":this._onKeyDown(t)&&t.stopPropagation();break;case"key-up":this._onKeyUp(t)&&t.stopPropagation()}}_updateLayerViews(){const t=!(!this.plane||!this.visible),e=[],s=t=>{"layers"in t?t.layers.forEach(s):e.push(t)};this.excludedLayers.forEach(s),this.view.allLayerViews.forEach((s=>{"slicePlaneEnabled"in s&&(s.slicePlaneEnabled=t&&e.indexOf(s.layer)<0),"sublayerViews"in s&&s.sublayerViews.forEach((s=>{s.slicePlaneEnabled=t&&e.indexOf(s.sublayer)<0}))})),this.view.basemapTerrain.slicePlaneEnabled=t&&!this.excludeGroundSurface}_onPointerDown(t){if("exclude"===this.layersMode)return!0;if(this._isTargeting){const e=$(t),s=At.create();if(this._pickPlane(e,!1,this._activeKeyModifiers,s)){At.copy(s,this._startPlane);const i=this._calculatePickRay(e);return this.inputState=xe(i,t.pointerId,s.origin,s),this.internalSetPlane(s),!0}}return!1}_onPointerDrag(t){if(t.pointerId===this._creatingPointerId){const e=$(t);return this.shiftManipulator.events.emit("drag",{action:"start",pointerType:t.pointerType,start:e,screenPoint:e}),!0}return!1}_onPointerMove(t){this._lastCursorPosition.x=t.x,this._lastCursorPosition.y=t.y,this._resetPointerMoveTimeout(),"touch"!==t.pointerType&&this._updatePreviewPlane($(t),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(t){return!(t.pointerId!==this._creatingPointerId||!r(this.plane))&&(At.copy(this.plane,this._startPlane),this.inputState=null,!0)}_onClick(t){return!("exclude"!==this.layersMode||!this.created)&&(this.view.hitTest($(t)).then((t=>{if(t.results.length){const e=t.results[0],s=e&&e.graphic;if(s){const t=s.sourceLayer||s.layer;t&&this.excludedLayers.push(t)}}else t.ground.layer?this.excludedLayers.push(t.ground.layer):this.excludeGroundSurface=!0})),this._set("layersMode","none"),J(this,!1),!0)}_onKeyDown(t){return("Shift"===t.key||t.key===Nt)&&(this._activeKeyModifiers[t.key]=!0,r(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(t){return!("Shift"!==t.key&&t.key!==Nt||!this._activeKeyModifiers[t.key])&&(delete this._activeKeyModifiers[t.key],r(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(t){if("start"!==t.action||i(this.plane))return;const e=this._calculatePickRay(t.screenPoint);At.copy(this.plane,this._startPlane),this.inputState=xe(e,null,this.shiftManipulator.renderLocation,this.plane)}_createShiftDragPipeline(t){return Et(t,((t,e)=>{const s=this.inputState;s&&"shift"===s.type&&e.next(Dt(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s))}))}_shiftDragAdjustSensitivity(t){return e=>{if(i(this.plane))return null;const s=Math.min((1-Math.abs(M(At.normal(this.plane),e.ray.direction)/k(e.ray.direction)))/.001,1),r=-jt.signedDistance(this._startPlane.plane,e.renderEnd),o=-jt.signedDistance(this._startPlane.plane,t.startPoint);return t.depth=t.depth*(1-s)+r*s-o,e}}_shiftDragUpdatePlane(t){return()=>{if(i(this.plane))return;const e=P(gt.get(),this._startPlane.origin),s=P(gt.get(),At.normal(this._startPlane));w(s,s,-t.depth),T(s,s,e),At.fromValues(s,this.plane.basis1,this.plane.basis2,this.plane),this.planeChanged(),this.notifyChange("plane")}}_onRotateHeadingGrab(t){if("start"!==t.action||i(this.plane))return;const e=ue(this.plane,this.view.renderCoordsHelper,1,jt.create()),s=this._calculatePickRay(t.screenPoint),r=v();jt.intersectRay(e,s,r)&&(At.copy(this.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:r})}_createRotateHeadingDragPipeline(t){return Et(t,((t,e)=>{const s=this.inputState;s&&"rotate"===s.type&&e.next(Dt(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate())}))}_onRotateTiltGrab(t){if("start"!==t.action||i(this.plane))return;const e=ue(this.plane,this.view.renderCoordsHelper,2,jt.create()),s=this._calculatePickRay(t.screenPoint),r=v();jt.intersectRay(e,s,r)&&(At.copy(this.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:r})}_createRotateTiltDragPipeline(t){return Et(t,((t,e)=>{const s=this.inputState;s&&"rotate"===s.type&&e.next(Dt(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate())}))}_rotateDragRenderPlaneToRotate(t){return e=>{if(i(this.plane))return null;const s=jt.normal(t.rotatePlane),r=zt(this.inputState.startPoint,e.renderEnd,this.plane.origin,s);return{...e,rotateAxis:s,rotateAngle:r}}}_rotateDragUpdatePlaneFromRotate(){return t=>{if(i(this.plane))return;const e=z(ft.get());Q(e,e,t.rotateAngle,t.rotateAxis);const s=U(gt.get(),this._startPlane.basis1,e),r=U(gt.get(),this._startPlane.basis2,e);At.fromValues(this.plane.origin,s,r,this.plane),this.planeChanged(),this.notifyChange("plane")}}_onResizeGrab(t,e){if("start"!==t.action||i(this.plane))return;const s=this._calculatePickRay(t.screenPoint),r=gt.get();jt.intersectRay(this.plane.plane,s,r)&&(At.copy(this.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:e,startPoint:f(r)})}_createResizeDragPipeline(t){return Et(t,((t,e)=>{const s=this.inputState;s&&"resize"===s.type&&!i(this.plane)&&e.next(Dt(this.view,this.plane.plane)).next(this._resizeDragUpdatePlane(s))}))}_resizeDragUpdatePlane(t){return e=>{if(i(this.plane))return;!function(t,e,s,i,r,o){const a=P(gt.get(),r.origin);T(a,a,w(gt.get(),r.basis1,t.direction[0]<0?1:-1)),T(a,a,w(gt.get(),r.basis2,t.direction[1]<0?1:-1));const n=k(r.basis1),l=k(r.basis2),p=x(gt.get(),s,a),u=x(gt.get(),e,a);let c=0,h=0;if(ye(t)){const e=ge(r),s=ge(o);c=n-.5*t.direction[0]*M(r.basis1,u)/n,h=l-.5*t.direction[1]*M(r.basis2,u)/l;const i=s/e;c*=i,h*=i}const d=c+.5*t.direction[0]*M(r.basis1,p)/n,m=h+.5*t.direction[1]*M(r.basis2,p)/l,g=w(gt.get(),r.basis1,d/n),y=w(gt.get(),r.basis2,m/l);(d<=0||de(o.origin,g,i)<=1600)&&P(g,o.basis1),(m<=0||de(o.origin,y,i)<=1600)&&P(y,o.basis2);const j=P(gt.get(),a);T(j,j,w(gt.get(),g,t.direction[0]<0?-1:1)),T(j,j,w(gt.get(),y,t.direction[1]<0?-1:1)),At.fromValues(j,g,y,o)}(this._resizeHandles[t.activeHandleIdx],this.inputState.startPoint,e.renderEnd,this.view._stage.getCamera(),this._startPlane,this.plane),this.planeChanged(),this.notifyChange("plane")}}_updatePreviewPlane(t,e={}){let s=this._previewPlane;if(this._previewPlane=null,i(t))return this._removeFrameTask(),void this._updateManipulators();if(!this.plane&&this.active){const i=r(s)?s:At.create();if(s=r(s)?At.copy(s,Ce):null,this._pickPlane(t,!0,e,i)){const t=.95;let e=!1;r(s)&&(e=M(s.plane,i.plane)<t||M(S(gt.get(),s.basis1),S(gt.get(),i.basis1))<t),e&&(this._baseOpacity=0),this._previewPlane=i}}r(this._previewPlane)&&i(this._frameTask)&&0===this._baseOpacity?this._frameTask=n({update:({deltaTime:t})=>{this._baseOpacity=Math.min(this._baseOpacity+t/300,1),this._updateManipulators(),1===this._baseOpacity&&this._removeFrameTask()}}):i(this._previewPlane)&&r(this._frameTask)?this._removeFrameTask():r(this._previewPlane)&&this._updateManipulators()}_removeFrameTask(){r(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)}_calculatePickRay(t){const e=mt.create(),s=O(t,Ue);return mt.fromScreen(this.view.state.camera,s,e),S(e.direction,e.direction),e}_pickMinResult(t){const e=O(t,vt.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector),this._intersector.results.min}_pickPlane(t,e,s,i){const r=this._pickMinResult(t),o=gt.get();if(!r.getIntersectionPoint(o))return!1;const a=r.getTransformedNormal(gt.get()),n=this.view._stage.getCamera();M(a,n.viewForward)>0&&w(a,a,-1);const l=function(t,e){return.4*Math.min(e.width,e.height)*e.computeRenderPixelSizeAt(t)}(o,n),p=(e?1:-1)*l*.02,u=w(gt.get(),a,p);T(u,u,o);const c=this.tiltEnabled?3:0;return pe(u,a,l,l,n,s.Shift?2:s[Nt]?1:c,this.view.renderCoordsHelper,i),!0}_updateMouseCursor(){this._set("cursor",null),this._isTargeting||"exclude"===this.layersMode?this._set("cursor","crosshair"):r(this._creatingPointerId)&&this._set("cursor","grabbing")}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),this._prevPointerMoveTimeout=null)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=we,this.rotateHeadingManipulator.state|=we,this.rotateTiltManipulator.state|=we,this._prevPointerMoveTimeout=this.clock.setTimeout((()=>{this.shiftManipulator.state&=~we,this.rotateHeadingManipulator.state&=~we,this.rotateTiltManipulator.state&=~we}),2500)}_updateManipulators(){if(this.disableEngineLayers)return;const t=r(this.plane)?this.plane:r(this._previewPlane)?this._previewPlane:null,e=r(t)&&t===this.plane,s=r(t)&&t===this._previewPlane,i=r(t)?function(t,e){return Ht(t.basis1,t.basis2,t.origin,e)}(t,ft.get()):null;if(this.shiftManipulator.available=e,this.rotateHeadingManipulator.available=e,this.rotateTiltManipulator.available=e&&this.tiltEnabled,this.resizeManipulators.forEach((t=>{t.available=e})),e&&(ce(this.shiftManipulator,i,t,this.view._stage.getCamera()),function(t,e,s,i){const r=i.worldUpAtPosition(s.origin,gt.get()),o=he(s,0),a=z(ft.get());H(a,a,o.edge*Math.PI/2),N(a,a,-ke(s,r)),B(a,e,a),a[12]=0,a[13]=0,a[14]=0,t.modelTransform=a,t.renderLocation=o.position}(this.rotateHeadingManipulator,i,t,this.view.renderCoordsHelper),function(t,e,s){const i=he(s,1),r=z(ft.get());H(r,r,i.edge*Math.PI/2),N(r,r,_e),B(r,e,r),r[12]=0,r[13]=0,r[14]=0,t.modelTransform=r,t.renderLocation=i.position}(this.rotateTiltManipulator,i,t),this.resizeManipulators.forEach(((e,s)=>{!function(t,e,s,i){const r=k(i.basis1),o=k(i.basis2),a=me(i),n=ge(i),l=C(gt.get(),0,0,0);T(l,w(gt.get(),i.basis1,e.direction[0]),w(gt.get(),i.basis2,e.direction[1])),T(l,i.origin,l);let p=0,u=1;if(ye(e))1===e.direction[0]&&-1===e.direction[1]?p=_e:1===e.direction[0]&&1===e.direction[1]?p=Math.PI:-1===e.direction[0]&&1===e.direction[1]&&(p=3*Math.PI/2),u=n;else{const t=0!==e.direction[0]?1:2;p=1===t?_e:0,u=(1===t?o:r)-a}const c=z(ft.get());H(c,c,p),F(c,c,C(gt.get(),u,u,u)),B(c,s,c),c[12]=0,c[13]=0,c[14]=0,t.modelTransform=c,t.renderLocation=l}(e,this._resizeHandles[s],i,t)}))),this._previewOutlineManipulator.available=s,this._outlineManipulator.available=e,this._gridManipulator.available=r(t),r(t)){const e=C(gt.get(),k(t.basis1),k(t.basis2),1),s=K(ft.get(),e),r=B(s,i,s);r[12]=0,r[13]=0,r[14]=0;const o=C(gt.get(),i[12],i[13],i[14]);this._previewOutlineManipulator.modelTransform=r,this._previewOutlineManipulator.renderLocation=o,this._outlineManipulator.modelTransform=r,this._outlineManipulator.renderLocation=o,this._gridManipulator.modelTransform=r,this._gridManipulator.renderLocation=o,this._updateMaterials()}}_updateMaterials(){const t=[Kt[0],Kt[1],Kt[2],Kt[3]*this._baseOpacity];this._previewOutlineMaterial.setParameterValues({color:t});const e=[Xt[0],Xt[1],Xt[2],Xt[3]*this._baseOpacity],s=this.inputState&&"resize"===this.inputState.type?Zt:[0,0,0,0];this._gridMaterial.setParameterValues({backgroundColor:e,gridColor:s})}updateManipulatorsInteractive(t){if(!t.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach((t=>{t.interactive=!0}));this.shiftManipulator.interactive=this.shiftManipulator===t,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===t,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===t,this.resizeManipulators.forEach((e=>{e.interactive=e===t}))}};function xe(t,e,s,i){const r=function(t,e,s,i){const r=_(gt.get(),e,s);return _(r,r,e),jt.fromPositionAndNormal(t,r,i)}(s,At.normal(i),t.direction,jt.create()),o=v();return jt.intersectRay(r,t,o)?{type:"shift",creatingPointerId:e,shiftPlane:r,depth:0,startPoint:o}:null}function Le(t){return"mouse"!==t.pointerType||0===t.button}t([o()],Te.prototype,"clock",void 0),t([o({constructOnly:!0})],Te.prototype,"view",void 0),t([o({dependsOn:["plane","inputState"],readOnly:!0})],Te.prototype,"state",null),t([o({dependsOn:["view.type"],readOnly:!0})],Te.prototype,"isSupported",null),t([o({readOnly:!0})],Te.prototype,"cursor",void 0),t([o({value:null})],Te.prototype,"plane",null),t([o({readOnly:!0})],Te.prototype,"layersMode",void 0),t([o({cast:d})],Te.prototype,"excludedLayers",null),t([o({type:Boolean,value:!1})],Te.prototype,"excludeGroundSurface",null),t([o({type:Boolean,value:!1})],Te.prototype,"tiltEnabled",null),t([o({value:null})],Te.prototype,"inputState",null),Te=t([c("esri.views.3d.interactive.analysisTools.slice.SliceTool")],Te);const Ce=At.create(),Ue=E();var Ie=Te;const Re=s.getLogger("esri.widgets.Slice.SliceViewModel"),Oe=new Set;let Ee=class extends Vt{constructor(t){super(t),this.supportedViewType="3d",this.handles=new V,Oe.add(this)}destroy(){Oe.delete(this),this.handles.destroy()}get state(){return this.isDisabled?"disabled":this.tool?this.tool.state:"ready"}get plane(){return this.tool?this.tool.plane:this._get("plane")}set plane(t){this._clearOverride("shape"),this._set("plane",t),r(t)?this.tool?this.tool.plane=t:t&&p(this.createTool()):this.removeTool()}get shape(){if(i(this.plane))return null;const t=this._get("shape"),e=this.view,s=ve(this.plane,e.renderCoordsHelper,e.spatialReference,new Bt);return i(s)||i(t)?s:s.heading===t.heading&&s.tilt===t.tilt&&r(s.position)&&r(t.position)&&s.position.equals(t.position)&&s.width===t.width&&s.height===t.height?t:s}set shape(t){if(i(this.view)||!this.view.ready)return void this._override("shape",t);const e=(s=t,o=this.view.renderCoordsHelper,a=kt(),i(s)||i(s.position)?null:o.toRenderCoords(s.position,a.origin)?(o.worldBasisAtPosition(a.origin,0,a.basis1),o.worldBasisAtPosition(a.origin,1,a.basis2),jt.fromVectorsAndPoint(a.basis2,a.basis1,a.origin,a.plane),At.rotate(a,-j(s.heading),At.normal(a),a),At.rotate(a,j(s.tilt),a.basis1,a),w(a.basis1,a.basis1,s.width/2),w(a.basis2,a.basis2,s.height/2),At.updateUnboundedPlane(a),a):(le.error(`Failed to project slice plane position, projection from ${s.position.spatialReference.wkid} is not supported`),null));var s,o,a;r(this.plane)&&r(e)&&wt(this.plane,e)||(this.plane=e)}get tiltEnabled(){var t,e,s;return null!=(t=null!=(e=null==(s=this.tool)?void 0:s.tiltEnabled)?e:this._get("tiltEnabled"))&&t}set tiltEnabled(t){this._set("tiltEnabled",t),this._updateToolOrRecreate((e=>e.tiltEnabled=t))}get excludedLayers(){return this.tool?this.tool.excludedLayers:this._get("excludedLayers")||new h}set excludedLayers(t){this._set("excludedLayers",m(t,this.excludedLayers)),this._updateToolOrRecreate((e=>e.excludedLayers=t))}get excludeGroundSurface(){return this.tool?this.tool.excludeGroundSurface:this._get("excludeGroundSurface")||!1}set excludeGroundSurface(t){this._set("excludeGroundSurface",t),this._updateToolOrRecreate((e=>e.excludeGroundSurface=t))}start(){return Oe.forEach((t=>{t.view===this.view&&t!==this&&t.clear()})),this.createTool()}clear(){this.removeTool(),this._set("plane",null),this._set("excludeGroundSurface",!1),this._set("excludedLayers",new h)}newSlice(){p(this.start())}clearSlice(){this.clear()}removeSliceAndStart(){return this.removeTool(),this.plane=null,this.start()}enterExcludeLayerMode(){this.tool&&this.tool.enterExcludeLayerMode()}exitExcludeLayerMode(){this.tool&&this.tool.exitExcludeLayerMode()}async createTool(){if(await this.view.whenReady(),this._isOverridden("shape")){const t=this.shape;this._clearOverride("shape"),this.shape=t}await super.createTool()}_updateToolOrRecreate(t){this.tool?t(this.tool):this.creatingTool&&p(this.createTool())}createToolParams(){return{toolConstructor:Ie,constructorArguments:()=>({excludeGroundSurface:this.excludeGroundSurface,plane:this.plane,excludedLayers:this.excludedLayers,tiltEnabled:this.tiltEnabled})}}logUnsupportedError(){this.logError("Slice widget is not implemented for MapView")}logError(...t){Re.error(...t)}};t([o({dependsOn:["isDisabled","tool.attached","tool.state"],readOnly:!0})],Ee.prototype,"state",null),t([o()],Ee.prototype,"tool",void 0),t([o({dependsOn:["tool.plane"]})],Ee.prototype,"plane",null),t([o({types:{key:"type",base:a,typeMap:{plane:Bt},defaultKeyValue:"plane"},dependsOn:["plane"]})],Ee.prototype,"shape",null),t([o({type:Boolean,dependsOn:["tool.tiltEnabled"]})],Ee.prototype,"tiltEnabled",null),t([g("tool.layersMode")],Ee.prototype,"layersMode",void 0),t([o({dependsOn:["tool.excludedLayers"],cast:d})],Ee.prototype,"excludedLayers",null),t([o({dependsOn:["tool.excludeGroundSurface"],nonNullable:!0})],Ee.prototype,"excludeGroundSurface",null),Ee=t([c("esri.widgets.slice.SliceViewModel")],Ee);var Ve=Ee;export default Ve;
