/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../chunks/object.js";import"../../chunks/deprecate.js";import{clone as t}from"../../core/lang.js";import"../../config.js";import{L as i,i as r}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import{resolve as o,reject as n}from"../../core/promiseUtils.js";import"../../chunks/Message.js";import l from"../../core/Error.js";import"../../chunks/ensureType.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/JSONSupport.js";import"../../core/urlUtils.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import{a as u}from"../../chunks/number.js";import{substitute as c}from"../../intl.js";import"../../kernel.js";import"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import d from"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../chunks/Identifiable.js";import{a as p}from"../../chunks/unitUtils.js";import"../../chunks/scaleUtils.js";import m from"./SearchSource.js";import{c as h,s as g}from"../../chunks/geometryUtils3.js";const f=/https?:\/\/services.*\.arcgis\.com/i,y=/(?:\{([^}]+)\})/g,j=i.getLogger("esri.widgets.Search.support.layerSearchUtils");function F(e,i){const{exactMatch:s=!1,location:o,maxResults:n,spatialReference:a,source:u,sourceIndex:c,suggestResult:m,view:f}=e,{layer:y,filter:F,zoomScale:v}=u,R=f&&f.scale,U=x(u,f),_=i&&i.signal;return w(y).then((()=>{const e=y.popupTemplate;return e?e.getRequiredFields(y.fields):null})).then((e=>{var i,x;const{objectIdField:w,returnZ:M}=y,O=k(u);if(!E(y,O))throw j.error("invalid-field: displayField is invalid."),new l("getResults():invalid-field","displayField is invalid.");const D=e&&e.length?e:[O],N=u.outFields||D,C=S(N);-1!==N.indexOf(w)||C||N.push(w);if(!(C||$(y,N)))throw j.error("invalid-field: outField is invalid."),new l("getResults():invalid-field","outField is invalid.");const P=y.createQuery(),{orderByFields:A}=u;if(A&&(P.orderByFields=A),a){P.outSpatialReference=a;const e=1/p(a);e&&(P.maxAllowableOffset=e)}const B="mesh"===y.geometryType||"multipatch"===y.geometryType,q=(null==(i=y.capabilities)||null==(x=i.data)?void 0:x.supportsZ)&&!B;if(P.returnZ=q&&!1!==M,P.returnGeometry=!0,P.multipatchOption=B?"xyFootprint":null,N&&(P.outFields=N),o)P.geometry=o;else if(m.key)P.objectIds=[parseInt(m.key,10)];else{const e=u.searchFields||[O];if(!$(y,e))throw j.error("invalid-field: search field is invalid."),new l("getResults():invalid-field","search field is invalid.");b(y)&&(P.num=n),U&&(P.geometry=U);if(!m.text.trim())return[];const{prefix:t="",suffix:i=""}=u,r=L(T(`${t}${m.text}${i}`),y,e,F,s);if(!r)return[];P.where=r}return y.queryFeatures(P,{signal:_}).then((e=>function(e,i,s,o,n,l,a){return e.features.map((e=>function(e,i,s,o,n,l,a){const u=e.clone(),c=e.sourceLayer,p=c&&c.objectIdField,m=p&&e.attributes[p],f=I(e,s.searchTemplate,n),y=h(u.geometry,i,l),j="number"==typeof a?g(t(y),i,a):y,F=e.clone();r(j)&&(F.geometry=d.fromExtent(j));return{extent:j,target:F,feature:u,key:m,name:f,sourceIndex:o}}(e,i,s,o,n,l,a)))}(e,f,u,c,O,R,v)))}))}function v(e,t){const{source:i,spatialReference:r,view:s,suggestTerm:o,maxSuggestions:n,sourceIndex:a}=e,{layer:u,filter:c}=i,d=t&&t.signal,p=x(i,s);return w(u).then((()=>{if(!b(u))return[];const e=k(i),t=i.searchFields||[e],s=[];i.suggestionTemplate?i.suggestionTemplate.replace(y,((e,t)=>(s.push(t),e))):s.push(e);const m=S(s);-1!==s.indexOf(u.objectIdField)||m||s.push(u.objectIdField);const h=E(u,e),g=m||$(u,s),f=$(u,t);if(!h)throw j.error("invalid-field: displayField is invalid."),new l("getSuggestions():invalid-field","displayField is invalid.");if(!g)throw j.error("invalid-field: outField is invalid."),new l("getSuggestions():invalid-field","outField is invalid.");if(!f)throw j.error("invalid-field: search field is invalid."),new l("getSuggestions():invalid-field","search field is invalid.");const F=u.createQuery(),{orderByFields:v}=i;v&&(F.orderByFields=v),F.outSpatialReference=r,F.returnGeometry=!1,F.num=n,F.outFields=s,p&&(F.geometry=p);if(!o.trim())return[];const{prefix:x="",suffix:w=""}=i,R=L(T(`${x}${o}${w}`),u,t,c,!1);return R?(F.where=R,u.queryFeatures(F,{signal:d}).then((t=>function(e,t,i,r){return e.features.map((e=>function(e,t,i,r){const s=e.sourceLayer,{attributes:o}=e,{objectIdField:n}=s,l=o[n];return{text:I(e,t.suggestionTemplate,r),key:l,sourceIndex:i}}(e,t,i,r)))}(t,i,a,e)))):[]}))}function x(e,t){const{filter:i,withinViewEnabled:r}=e,s=t&&t.extent;return i&&i.geometry||(r&&s?s:void 0)}function S(e){return e&&-1!==e.indexOf("*")}function w(e){return e?e.load().then(o).catch(n):o()}function b(e){var t,i,r;return null!=(t=null==e||null==(i=e.capabilities)||null==(r=i.query)?void 0:r.supportsPagination)&&t}function k(e){return e.displayField||e.layer.displayField||function(e){let t="";if(e){const{fields:i}=e;i&&i.some((e=>"string"===e.type&&(t=e.name,!0)))}return t}(e.layer)}function $(e,t){return!(!e||!t)&&t.every((t=>E(e,t)))}function E(e,t){return!!e.getField(t)}function T(e){return e.replace(/\'/g,"''")}function R(e,t){const i=t&&t.where;return i?`(${e}) AND (${i})`:e}function L(e,t,i,r,s){const{definitionExpression:o}=t;let n="";if(e){const o=f.test(t.url)&&function(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}(e)?"N":"";i&&i.forEach((i=>{const l=t.getField(i),a="function"==typeof t.getFieldDomain&&t.getFieldDomain(i),u=(a&&"coded-value"===a.type?function(e,t,i){let r=null;const{codedValues:s}=e;return s&&s.some((e=>{const s=e.name,o=i?s:s.toLowerCase();return(i?t:t.toLowerCase())===o&&(r=e.code.toString(),!0)})),r}(a,e,s):null)||e||null;if(null!==u){const e=function(e,t,i,r,s){const o=t.type,n=t.name;if("string"===o||"date"===o||"global-id"===o)return R(s?`${n} = ${i}'${e}'`:`UPPER(${n}) LIKE ${i}'%${e.toUpperCase()}%'`,r);if("oid"===o||"small-integer"===o||"integer"===o||"single"===o||"double"===o){const t=Number(e);return isNaN(t)?null:R(`${n} = ${t}`,r)}return R(`${n} = ${e}`,r)}(u,l,o,r,s);e&&(n+=function(e,t){return e?` OR (${t})`:`(${t})`}(n,e))}}))}return o?`(${o}) AND (${n})`:n}function I(e,t,i){const r=e.sourceLayer,{attributes:s}=e,o="function"==typeof r.getFieldDomain&&r.getFieldDomain(i);if(t)return c(t,s);if(i&&s){const e=r.getField(i),t=(l=i,(n=s)[Object.keys(n).find((e=>e.toLowerCase()===l.toLowerCase()))]);return null==t?"":o&&"coded-value"===o.type?function(e,t){let i=null;const{codedValues:r}=e;return r&&r.length&&r.some((e=>e.code===t&&(i=e.name,!0))),i}(o,t):"date"===(null==e?void 0:e.type)?u(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}var n,l;return""}var U;let _=U=class extends m{constructor(){super(...arguments),this.displayField=null,this.exactMatch=null,this.orderByFields=null,this.searchFields=null,this.searchTemplate=null,this.suggestionTemplate=null,this.getResults=(e,t)=>F({source:this,...e},t),this.getSuggestions=(e,t)=>v({source:this,...e},t)}set layer(e){this._set("layer",e),e&&e.load().catch((()=>{}))}get name(){return this._getLayerTitle()||""}set name(e){void 0!==e?this._override("name",e):this._clearOverride("name")}clone(){return new U({autoNavigate:this.autoNavigate,filter:this.filter,maxResults:this.maxResults,maxSuggestions:this.maxSuggestions,minSuggestCharacters:this.minSuggestCharacters,outFields:this.outFields?t(this.outFields):null,placeholder:this.placeholder,popupEnabled:this.popupEnabled,prefix:this.prefix,resultGraphicEnabled:this.resultGraphicEnabled,resultSymbol:this.resultSymbol?this.resultSymbol.clone():null,suggestionsEnabled:this.suggestionsEnabled,suffix:this.suffix,withinViewEnabled:this.withinViewEnabled,displayField:this.displayField,exactMatch:this.exactMatch,layer:this.layer,searchFields:this.searchFields?t(this.searchFields):null,suggestionTemplate:this.suggestionTemplate,zoomScale:this.zoomScale})}_getFirstStringField(){const e=this.layer;let t="";return e&&e.fields&&e.fields.some((e=>"string"===e.type&&(t=e.name,!0))),t}_getDisplayField(){return this.displayField||this.layer.displayField||this._getFirstStringField()}_getSearchFieldsString(){const{layer:e,searchFields:t}=this;if(!e.loaded)return"";return`: ${(t||[this._getDisplayField()]).map((t=>{const i=e.getField(t);return i&&i.alias||t})).join(", ")}`}_getLayerTitle(){const{layer:e}=this;if(!e)return;const{title:t}=e;return t?`${t}${this._getSearchFieldsString()}`:void 0}};e([s({json:{read:{source:"field.name"},write:{target:"field.name"}}})],_.prototype,"displayField",void 0),e([s({json:{read:{source:"field.exactMatch"},write:{target:"field.exactMatch"}}})],_.prototype,"exactMatch",void 0),e([s({value:null})],_.prototype,"layer",null),e([s({dependsOn:["layer.title","layer.loaded"]})],_.prototype,"name",null),e([s({type:[String],json:{write:!0}})],_.prototype,"orderByFields",void 0),e([s()],_.prototype,"searchFields",void 0),e([s()],_.prototype,"searchTemplate",void 0),e([s()],_.prototype,"suggestionTemplate",void 0),_=U=e([a("esri.widgets.Search.LayerSearchSource")],_);var M=_;export default M;
