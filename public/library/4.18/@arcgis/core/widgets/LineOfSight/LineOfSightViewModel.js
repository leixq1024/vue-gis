/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../chunks/object.js";import"../../chunks/deprecate.js";import"../../core/lang.js";import"../../config.js";import{b as t,i,L as s}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as r}from"../../core/accessorSupport/decorators/property.js";import o from"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../chunks/Message.js";import"../../core/Error.js";import"../../chunks/compilerUtils.js";import"../../chunks/ensureType.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import a from"../../core/Collection.js";import{r as l,c as p}from"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/Promise.js";import"../../chunks/Loadable.js";import"../../core/urlUtils.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import"../../chunks/number.js";import"../../intl.js";import"../../kernel.js";import"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import c from"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalUser.js";import"../../portal/Portal.js";import"../../chunks/mathUtils2.js";import{c as h}from"../../chunks/vec3f64.js";import"../../chunks/common.js";import{g as u,d as m,s as d,n as g,a as y,c as _,p as b,z as j}from"../../chunks/vec3.js";import"../../chunks/mathUtils.js";import"../../chunks/colorUtils.js";import v from"../../Color.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import"../../layers/support/fieldUtils.js";import"../../popup/content/Content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/CustomContent.js";import"../../chunks/date.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/FieldInfo.js";import"../../popup/content/FieldsContent.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/MediaContent.js";import"../../popup/content/TextContent.js";import"../../popup/content.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/RelatedRecordsInfo.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../PopupTemplate.js";import"../../symbols/Symbol.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol3DLayer.js";import{s as f}from"../../chunks/screenUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/materialUtils.js";import"../../symbols/edges/Edges3D.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/utils.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/patterns/StylePattern3D.js";import"../../symbols/FillSymbol3DLayer.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/Symbol3D.js";import"../../chunks/Thumbnail.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/uid.js";import"../../Graphic.js";import k from"../../core/Handles.js";import"../../layers/Layer.js";import"../../chunks/unitUtils.js";import"../../chunks/lengthUtils.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import{init as O,on as C,watch as S}from"../../core/watchUtils.js";import"../../chunks/fieldType.js";import"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/projection.js";import"../../chunks/unitConversionUtils.js";import"../../core/HandleOwner.js";import"../../chunks/_commonjsHelpers.js";import{T as L}from"../../chunks/Scheduler.js";import"../../chunks/vec4f64.js";import{c as I}from"../../chunks/quatf64.js";import"../../chunks/mat3.js";import"../../chunks/BufferView.js";import"../../chunks/vec2.js";import"../../chunks/vec4.js";import"../../chunks/quat.js";import"../../chunks/domUtils.js";import"../../chunks/widgetUtils.js";import"../../chunks/projector.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../../chunks/renderable.js";import"../../chunks/vmEvent.js";import"../../chunks/index.js";import"../support/widget.js";import"../Widget.js";import"../../chunks/zscale.js";import"../../chunks/queryZScale.js";import"../../layers/support/Field.js";import"../../tasks/support/FeatureSet.js";import"../../chunks/DataLayerSource.js";import"../../tasks/support/AttachmentQuery.js";import"../../tasks/support/Query.js";import"../../tasks/support/StatisticDefinition.js";import"../../tasks/support/RelationshipQuery.js";import"../../tasks/Task.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/featureConversionUtils.js";import"../../tasks/QueryTask.js";import"../../chunks/pbf.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/query.js";import"../../layers/support/AttachmentInfo.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/Queue.js";import"../../chunks/InputManager.js";import"../../chunks/interactiveToolUtils.js";import"../../chunks/throttle.js";import"../Attachments.js";import"../Attachments/AttachmentsViewModel.js";import"../Feature/FeatureViewModel.js";import"../Feature.js";import"../../chunks/AnchorElementViewModel.js";import"../Spinner/SpinnerViewModel.js";import"../Popup.js";import"../../chunks/layerViewUtils.js";import"../../chunks/actions.js";import"../../chunks/GoTo.js";import"../Popup/PopupViewModel.js";import"../../chunks/quantizationUtils.js";import{g as w}from"../../chunks/dehydratedFeatures.js";import"../../chunks/ElevationProvider.js";import"../../chunks/vec2f64.js";import"../../chunks/PiUtils.glsl.js";import"../../chunks/Program.js";import"../../chunks/isWebGL2Context.js";import"../../chunks/glUtil.js";import"../../chunks/InterleavedLayout.js";import"../../chunks/mat4f32.js";import"../../chunks/vec3f32.js";import{x as T,u as M,O as R,z as E,P,Q as D}from"../../chunks/geometryUtils.js";import{R as V,G as U,L as A}from"../../chunks/ColorMaterial.js";import"../../chunks/Util.js";import{G}from"../../chunks/Geometry.js";import"../../chunks/VertexArrayObject.js";import{O as z}from"../../chunks/Object3D.js";import"../../chunks/intersectorUtils.js";import{I as H}from"../../chunks/Intersector.js";import"../../chunks/Camera.js";import"../../chunks/RenderingContext.js";import"../../chunks/CameraSpace.glsl.js";import{g as F}from"../../chunks/tileUtils.js";import"../../chunks/elevationInfoUtils.js";import{I as x,c as N}from"../../chunks/InteractiveToolBase.js";import{L as W}from"../../chunks/LaserLineRenderer.js";import{I as B}from"../../chunks/InteractiveToolViewModel.js";import{a as $,M as Q}from"../../chunks/manipulatorUtils.js";import{d as q}from"../../chunks/manipulatorUtils2.js";import J from"./LineOfSightTarget.js";let Z=class extends o{constructor(e){super(e),this.laserLineEnabled=!0,this.laserLineGlowColor=new v([255,127,0]),this.laserLineGlowWidth=8,this.laserLineInnerColor=new v([255,255,255]),this.laserLineInnerWidth=.75,this.laserLineGlobalAlpha=.75,this.observerManipulatorSize=.5,this.observerManipulatorColor=new v([255,127,0,.75]),this.targetManipulatorSize=.5,this.targetManipulatorVisibleColor=new v([3,252,111,.75]),this.targetManipulatorOccludedColor=new v([252,3,69,.75]),this.targetManipulatorUndefinedColor=new v([127,127,127,.75]),this.lineOfSightInnerWidth=2,this.lineOfSightOuterWidth=8,this.lineOfSightVisibleInnerColor=new v([3,252,111,1]),this.lineOfSightVisibleOuterColor=new v([3,252,111,.15]),this.lineOfSightOccludedInnerColor=new v([252,3,69,1]),this.lineOfSightOccludedOuterColor=new v([252,3,69,.1]),this.lineOfSightUndefinedInnerColor=new v([255,255,255,1]),this.lineOfSightUndefinedOuterColor=new v([127,127,127,.2])}};function K(e,t,i,s){return new V({width:e,color:v.toUnitRGBA(t),stipplePattern:i,stippleOffColor:s&&[s.r,s.g,s.b,s.a],renderOccluded:4},"line-of-sight-line")}function X(e,t,i){return new G(U.createPolylineGeometry([e,t]),`line-of-sight-line-${i}`)}function Y(e,t,i){return{geometry:new G(U.createSphereGeometry(e,32,32),"manipulator"),material:$(v.toUnitRGBA(t)),stateMask:i}}e([r({type:Boolean})],Z.prototype,"laserLineEnabled",void 0),e([r({type:v})],Z.prototype,"laserLineGlowColor",void 0),e([r({type:Number})],Z.prototype,"laserLineGlowWidth",void 0),e([r({type:v})],Z.prototype,"laserLineInnerColor",void 0),e([r({type:Number})],Z.prototype,"laserLineInnerWidth",void 0),e([r({type:Number})],Z.prototype,"laserLineGlobalAlpha",void 0),e([r({type:Number})],Z.prototype,"observerManipulatorSize",void 0),e([r({type:v})],Z.prototype,"observerManipulatorColor",void 0),e([r({type:Number})],Z.prototype,"targetManipulatorSize",void 0),e([r({type:v})],Z.prototype,"targetManipulatorVisibleColor",void 0),e([r({type:v})],Z.prototype,"targetManipulatorOccludedColor",void 0),e([r({type:v})],Z.prototype,"targetManipulatorUndefinedColor",void 0),e([r({type:Number})],Z.prototype,"lineOfSightInnerWidth",void 0),e([r({type:Number})],Z.prototype,"lineOfSightOuterWidth",void 0),e([r({type:v})],Z.prototype,"lineOfSightVisibleInnerColor",void 0),e([r({type:v})],Z.prototype,"lineOfSightVisibleOuterColor",void 0),e([r({type:v})],Z.prototype,"lineOfSightOccludedInnerColor",void 0),e([r({type:v})],Z.prototype,"lineOfSightOccludedOuterColor",void 0),e([r({type:v})],Z.prototype,"lineOfSightUndefinedInnerColor",void 0),e([r({type:v})],Z.prototype,"lineOfSightUndefinedOuterColor",void 0),Z=e([n("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightConfiguration")],Z);const ee=a.ofType(J);let te=class extends x{constructor(e){super(e),this.deferCreation=!0,this.observer=null,this.targets=new ee,this.configuration=null,this.updating=!1,this._handles=new k,this._manipulatorHandles=new k,this._observer=null,this._tracker=null,this._analyses=new a,this._screenPixelSize=0,this._grabbedManipulator=null,this._showTracker=!0}initialize(){const e=O(this,"state",(e=>{switch(e){case"created":this.complete();break;default:this.create()}}),!0),t=this.configuration=new Z;this._intersector=new H(this.view.state.mode),this._intersector.options.hud=!1,this._intersector.options.store=0,this._engineLayer=new A("line-of-sight-analysis",{isPickable:!1});const i=this.view._stage;i.addToViewContent([this._engineLayer.id]),i.add(0,this._engineLayer),this._createEngineResources(),this._observer={location:null,intersection:null,manipulator:this._addManipulator({size:t.observerManipulatorSize,color:t.observerManipulatorColor,visible:!1})},this._tracker=this._createLineOfSightAnalysis(new J({location:new c})),this._tracker.point.manipulator.available=!1,this._tracker.point.manipulator.interactive=!1;const s=this._handles;s.add([e,this.view.state.watch("camera",(()=>this._onCameraChange())),this.view.watch("map.ground.opacity",((e,t)=>this._onGroundOpacityChange(e,t))),O(this.view,"slicePlane",(()=>this._onSlicePlaneChange())),O(this,"observer",(e=>this._onObserverChange(e)),!0),C(this,"targets","change",(e=>this._onTargetCollectionChange(e)),(e=>this._onTargetsChange(e)),null,!0),S(this.configuration,["laserLineEnabled","laserLineGlowColor","laserLineGlowWidth","laserLineInnerColor","laserLineInnerWidth","laserLineGlobalAlpha","lineOfSightInnerWidth","lineOfSightOuterWidth","lineOfSightVisibleInnerColor","lineOfSightVisibleOuterColor","lineOfSightOccludedInnerColor","lineOfSightOccludedOuterColor","lineOfSightUndefinedInnerColor","lineOfSightUndefinedOuterColor","lineOfSightUndefinedStipplePattern","lineOfSightUndefinedStipplePatternOffColor"],(()=>this._createEngineResources())),S(this.configuration,["observerManipulatorSize","observerManipulatorColor"],(()=>this._recreateManipulator(this._observer))),S(this.configuration,["targetManipulatorSize","targetManipulatorVisibleColor","targetManipulatorOccludedColor","targetManipulatorUndefinedColor"],(()=>this._analyses.forEach((e=>this._recreateManipulator(e.point)))))]);const r=this.view.pointsOfInterest;r&&s.add([r.contentGeometryUpdates.events.on("request-update",(()=>this._onContentChange())),this.view.elevationProvider.on("elevation-change",(()=>this._onContentChange()))]);const o=this.view.resourceController&&this.view.resourceController.scheduler;o&&(this._frameTask=o.registerTask(L.LINE_OF_SIGHT_TOOL,(e=>this._updateAnalyses(e)),(()=>this.updating)),s.add(this._frameTask)),this.continue()}destroy(){this.detach(),this._handles.destroy(),this._handles=null,this._manipulatorHandles.destroy(),this._manipulatorHandles=null,this.manipulators.remove(this._observer.manipulator),this._destroyLineOfSightAnalysis(this._tracker),this._analyses.forEach((e=>{this._destroyLineOfSightAnalysis(e)}));const e=this.view._stage;e.removeFromViewContent([this._engineLayer.id]),e.remove(0,this._engineLayer.id),this._removeEngineResources(),this._engineLayer=null,e.removeRenderPlugin(this._engineResources.laserLineRenderer),this._engineResources.laserLineRenderer=null,this._engineResources=null,this._intersector=null,this.observer=null,this._set("targets",null)}get state(){return this._showTracker?"creating":this.observer?"created":"ready"}get cursor(){return this.manipulators.some((({manipulator:e})=>e.focused))?null:this._showTracker?"crosshair":null}get isSupported(){return"3d"===this.get("view.type")}continue(){this.view.activeTool=this,this._showTracker=!0,this._updateTrackerVisibility()}stop(){this._showTracker=!1,this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE),this._updateTrackerVisibility()}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"key-down":this._keyDownHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onInputEventAfter(e){switch(e.type){case"immediate-click":this._clickHandler(e)}}_setDirty(e){this.updating?e===L.LINE_OF_SIGHT_TOOL_INTERACTIVE&&this._frameTask&&(this._frameTask.task=e):(this._set("updating",!0),this._frameTask&&(this._frameTask.task=e))}_updateTrackerVisibility(){this._tracker.shouldRender=this._showTracker&&!this.manipulators.some((e=>e.manipulator.focused)),this._updateLaserLineRenderer()}_manipulatorFocusChanged(){this._updateTrackerVisibility(),this.notifyChange("cursor")}_addManipulator(e){const t=function(e,t){const i=[];t.customColor1&&i.push(Y(t.size,t.customColor1,16)),t.customColor2&&i.push(Y(t.size,t.customColor2,32)),t.customColor3&&i.push(Y(t.size,t.customColor3,64)),t.color&&i.push(Y(t.size,t.color));const s=new Q({view:e,renderObjects:i,elevationInfo:{mode:"absolute-height",offset:0}});q(s);for(const e in t)s[e]=t[e];return s}(this.view,e);return this._manipulatorHandles.add([this._createManipulatorDragPipeline(t),t.events.on("focus-changed",(()=>this._manipulatorFocusChanged())),t.events.on("grab-changed",(e=>this._manipulatorGrabChanged(t,e))),t.events.on("immediate-click",(e=>e.stopPropagation()))],t),this.manipulators.add(t),t}_removeManipulator(e){this.manipulators.remove(e),this._manipulatorHandles.remove(e)}_recreateManipulator(e){const t=this.configuration,i=e.manipulator;this._removeManipulator(i);const s=e===this._observer?{size:t.observerManipulatorSize,color:t.observerManipulatorColor,visible:i.available}:{size:t.targetManipulatorSize,customColor1:t.targetManipulatorVisibleColor,customColor2:t.targetManipulatorOccludedColor,customColor3:t.targetManipulatorUndefinedColor};e.manipulator=this._addManipulator(s),e.manipulator.location=i.location,this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_screenToIntersection(){return e=>{const i=this._getScreenPointIntersection(e.screenEnd);return t(i)?null:{...e,intersection:i}}}_createManipulatorDragPipeline(e){return N(e,((t,i,s)=>{i.next(this._screenToIntersection()).next(e===this._observer.manipulator?this._updateObserverDragStep():this._updateAnalysisDragStep(e)).next((()=>this._updateLaserLineRenderer())),s.next(e===this._observer.manipulator?this._cancelObserverDragStep():this._cancelAnalysisDragStep(e)).next((()=>this._updateLaserLineRenderer()))}))}_updateObserverDragStep(){return e=>(this.observer=e.intersection.point,this._observer.intersection=e.intersection,e)}_cancelObserverDragStep(){const e=i(this.observer)?this.observer.clone():null,t=this._observer.intersection;return i=>(this.observer=e,this._observer.intersection=t,i)}_updateAnalysisDragStep(e){return t=>{const i=this._analyses.find((t=>t.point.manipulator===e));return i.target.location=t.intersection.point,i.point.intersection=t.intersection,t}}_cancelAnalysisDragStep(e){const t=this._analyses.find((t=>t.point.manipulator===e)),s=i(t.target.location)?t.target.location.clone():null,r=t.point.intersection;return e=>(t.target.location=s,t.point.intersection=r,e)}_updateLaserLineRenderer(){const e=this._engineResources.laserLineRenderer;if(!this.configuration.laserLineEnabled)return e.heightManifoldEnabled=!1,void(e.lineVerticalPlaneEnabled=!1);const t=i(this._grabbedManipulator)?this._grabbedManipulator:this._tracker.shouldRender&&this.observer?this._tracker.point.manipulator:null;this.configuration.laserLineEnabled&&i(t)?(e.heightManifoldEnabled=!0,e.heightManifoldTarget=t.renderLocation,t!==this._observer.manipulator?(e.lineVerticalPlaneEnabled=!0,e.lineVerticalPlaneSegment=M.fromPoints(this._observer.manipulator.renderLocation,t.renderLocation,ce)):e.lineVerticalPlaneEnabled=!1):(e.heightManifoldEnabled=!1,e.lineVerticalPlaneEnabled=!1)}_createLaserLineRenderer(){const e=this.configuration;return new W(this.view.renderCoordsHelper,{glowColor:v.toUnitRGB(e.laserLineGlowColor),glowWidth:e.laserLineGlowWidth,innerColor:v.toUnitRGB(e.laserLineInnerColor),innerWidth:e.laserLineInnerWidth,globalAlpha:e.laserLineGlobalAlpha})}_removeEngineResources(){const e=this.view._stage;e.remove(3,this._engineResources.visibleLineMaterialInner.id),e.remove(3,this._engineResources.visibleLineMaterialOuter.id),e.remove(3,this._engineResources.occludedLineMaterialInner.id),e.remove(3,this._engineResources.occludedLineMaterialOuter.id),e.remove(3,this._engineResources.undefinedLineMaterialInner.id),e.remove(3,this._engineResources.undefinedLineMaterialOuter.id)}_createEngineResources(){const e=this.view._stage,t=this.configuration;this._engineResources&&(this._removeEngineResources(),e.removeRenderPlugin(this._engineResources.laserLineRenderer)),this._engineResources={laserLineRenderer:this._createLaserLineRenderer(),visibleLineMaterialInner:K(t.lineOfSightInnerWidth,t.lineOfSightVisibleInnerColor),visibleLineMaterialOuter:K(t.lineOfSightOuterWidth,t.lineOfSightVisibleOuterColor),occludedLineMaterialInner:K(t.lineOfSightInnerWidth,t.lineOfSightOccludedInnerColor),occludedLineMaterialOuter:K(t.lineOfSightOuterWidth,t.lineOfSightOccludedOuterColor),undefinedLineMaterialInner:K(t.lineOfSightInnerWidth,t.lineOfSightUndefinedInnerColor),undefinedLineMaterialOuter:K(t.lineOfSightOuterWidth,t.lineOfSightUndefinedOuterColor)},e.addRenderPlugin(this._engineResources.laserLineRenderer.renderSlots,this._engineResources.laserLineRenderer),e.add(3,this._engineResources.visibleLineMaterialInner),e.add(3,this._engineResources.visibleLineMaterialOuter),e.add(3,this._engineResources.occludedLineMaterialInner),e.add(3,this._engineResources.occludedLineMaterialOuter),e.add(3,this._engineResources.undefinedLineMaterialInner),e.add(3,this._engineResources.undefinedLineMaterialOuter),this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onObserverChange(e){if(t(e))return this._observer.manipulator.available=!1,void this.targets.removeAll();this._observer.location=e,this._observer.intersection=null,this._observer.manipulator.available=!0,this._observer.manipulator.location=e,this._tracker.point.manipulator.location=e,this._analyses.forEach((e=>{e.isDirty=!0,e.isValid=!1})),this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onTargetsChange(e){this._analyses.forEach((e=>{this._destroyLineOfSightAnalysis(e)})),this._analyses.removeAll(),e.items&&this._onTargetCollectionChange({target:e,added:e.items,removed:[],moved:[]})}_onTargetCollectionChange(e){e.added.forEach((e=>{if(!this._analyses.some((t=>t.target===e))){const t=this._createLineOfSightAnalysis(e);this._analyses.add(t)}this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)})),e.removed.forEach((e=>{const t=this._analyses.find((t=>t.point.location===e.location));this._destroyLineOfSightAnalysis(t),this._analyses.remove(t)}))}_onTargetLocationChange(e,t){e.isValid=!1,e.point.location=t,e.point.intersection=null,e.point.manipulator.location=t,e.isDirty=!0,this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE)}_onGroundOpacityChange(e,t){this._analyses.length&&(1!==e&&1!==t||e===t||(this._setDirty(L.LINE_OF_SIGHT_TOOL),this._analyses.forEach((e=>e.isDirty=!0))))}_onContentChange(){this._analyses.forEach((e=>{e.isDirty=!0,e.shouldIntersect=!0})),this._setDirty(L.LINE_OF_SIGHT_TOOL)}_onCameraChange(){if(!this._analyses.length)return;let e=!1;if(i(this.observer)){this.view.renderCoordsHelper.toRenderCoords(this.observer,ie);const t=this.view.state.camera.computeScreenPixelSizeAt(ie);e=e||Math.abs((t-this._screenPixelSize)/this._screenPixelSize)>.1}this._analyses.some((e=>!e.isValid))&&(e=!0),e&&(this._setDirty(L.LINE_OF_SIGHT_TOOL),this._analyses.forEach((e=>e.isDirty=!0)))}_onSlicePlaneChange(){this._analyses.length&&(this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE),this._analyses.forEach((e=>e.isDirty=!0)))}_addPointFromClickEvent(e){const i=this._getScreenPointIntersection(e);if(!t(i)&&!t(i.point))if(this.observer){const e=new J({location:i.point}),t=this._createLineOfSightAnalysis(e);this._analyses.add(t),t.point.intersection=i,this.targets.add(e)}else this.observer=i.point,this._observer.intersection=i}_clickHandler(e){this._showTracker&&(this._addPointFromClickEvent({x:e.x,y:e.y}),e.stopPropagation())}_doubleClickHandler(e){this._showTracker&&(this.stop(),e.stopPropagation())}_keyDownHandler(e){this._showTracker&&"Escape"===e.key&&(this.stop(),e.stopPropagation())}_pointerMoveHandler(e){if(!this._showTracker)return;const t={x:e.x,y:e.y},s=this._getScreenPointIntersection(t);i(s)&&i(s.point)&&(this._tracker.point.manipulator.location=s.point,this._tracker.isDirty=!0,this._updateLaserLineRenderer(),this._setDirty(L.LINE_OF_SIGHT_TOOL_INTERACTIVE))}_getScreenPointIntersection(e){const t=f(e,R.get()),i=E(this.view.state.camera,t,ae);return this._getRayIntersection(i)}_getRayIntersection(e){if(t(e))return null;this.view.sceneIntersectionHelper.intersectToolIntersectorRay(e,this._intersector);const s=this._intersector.results.min;if(!s||!s.getIntersectionPoint(ie))return null;const r=new c;this.view.renderCoordsHelper.fromRenderCoords(ie,r,this.view.spatialReference);const o=h();u(o,s.normal);const n=m(o,e.direction)>0?-1:1;d(o,o,n);const a=s.toGraphic(this.view);if(i(a)){const t=a.layer,i=a.sourceLayer;let n;if(i)switch(i.type){case"scene":n=w(a,i.objectIdField);break;case"integrated-mesh":{const e=s.target;n=`${e.metadata.nodeIndex}/${e.metadata.componentIndex}`;break}default:n=a.uid}else n=a.uid;return{type:"Graphic",id:`${t.uid}/${n}`,ray:P(e),normal:o,point:r}}if("TerrainRenderer"===s.intersector){return{type:"Terrain",id:s.target.metadata.tile.lij.slice(),ray:P(e),normal:o,point:r}}return null}_createLineOfSightAnalysis(e){const t=this.configuration,s={isValid:!1,isDirty:!0,shouldRender:!0,shouldIntersect:!1,point:{location:e.location,manipulator:this._addManipulator({size:t.targetManipulatorSize,customColor1:t.targetManipulatorVisibleColor,customColor2:t.targetManipulatorOccludedColor,customColor3:t.targetManipulatorUndefinedColor}),intersection:null},isTargetVisible:!1,hasIntersection:!1,target:e,targetHandle:null,engine:{points:{observer:h(),target:h(),intersection:h(),intersectionObserver:h(),intersectionTarget:h()},visualization:new z}};return i(e.location)&&(s.point.manipulator.location=e.location),s.targetHandle=O(e,"location",(e=>this._onTargetLocationChange(s,e)),!0),this.manipulators.add(s.point.manipulator),this.view._stage.add(1,s.engine.visualization),this._engineLayer.addObject(s.engine.visualization),s}_destroyLineOfSightAnalysis(e){e.targetHandle.remove(),this.manipulators.remove(e.point.manipulator),this.view._stage.remove(1,e.engine.visualization.id),this._engineLayer.removeObject(e.engine.visualization)}_canComputeAnalysis(e){if(t(this.observer)||t(e.point)||t(e.point.location))return!1;this.view.renderCoordsHelper.toRenderCoords(this.observer,ie);const i=this.view.frustum.intersectsPoint(ie);this.view.renderCoordsHelper.toRenderCoords(e.point.location,ie);const s=this.view.frustum.intersectsPoint(ie);return i&&s}_manipulatorGrabChanged(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}this._updateTrackerVisibility()}_canUpdateFromIntersectionResult(e,i){if(t(e)||!i||e.type!==i.type)return!1;if("Terrain"===e.type){const t=e.id,s=i.id;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]||F(t,s)}return("Graphic"===e.type||"I3S"===e.type)&&e.id===i.id}_updateFromIntersectionResult(e){let t;if("Terrain"===e.type&&i(e.point)){this.view.renderCoordsHelper.toRenderCoords(e.point,re),this.view.renderCoordsHelper.worldUpAtPosition(re,ne);const i=this.view.basemapTerrain.elevationBounds,s=this.view.renderCoordsHelper.getAltitude(re),r=i?Math.abs(i.max-i.min)/Math.abs(s):100,o=s>0?1:-1;g(ne,ne),d(ne,ne,o*r),y(se,re,ne),D(se,re,ae),t=this._getRayIntersection(ae)}else t=this._getRayIntersection(e.ray);return this._canUpdateFromIntersectionResult(t,e)?t.point:null}_updateAnalyses(e){if(!this.observer)return void this._set("updating",!1);if(this._analyses.some((e=>e.shouldIntersect))){const e=this._observer.intersection,t=e&&this._updateFromIntersectionResult(e);i(t)&&(this._observer.manipulator.location=t)}this._set("updating",this._updateAnalysis(this._tracker,"tracker")||this._analyses.items.some(((t,i)=>this._updateAnalysis(t,`${i}`,e))))}_updateAnalysis(e,t,s){if(!e.shouldRender)return e.engine.visualization.removeAllGeometries(),e.isDirty=!1,!1;if(!e.isDirty)return!1;if(e.shouldIntersect){const t=e.point.intersection,s=t&&this._updateFromIntersectionResult(t);i(s)&&(e.point.manipulator.location=s),e.shouldIntersect=!1}this.view.renderCoordsHelper.toRenderCoords(e.point.manipulator.location,e.engine.points.target),this.view.renderCoordsHelper.toRenderCoords(this._observer.manipulator.location,e.engine.points.observer);const r="tracker"===t||this._canComputeAnalysis(e),o=e.engine,n=o.points.observer,a=o.points.target;this._screenPixelSize=this.view.state.camera.computeScreenPixelSizeAt(n),this._observer.intersection?u(ne,this._observer.intersection.normal):_(ne,a,n);const l=this._screenPixelSize;g(ne,ne),d(ne,ne,Math.min(l,1)),y(se,n,ne),e.point.intersection?u(ne,e.point.intersection.normal):_(ne,n,a);const p=this.view.state.camera.computeScreenPixelSizeAt(a);if(g(ne,ne),d(ne,ne,Math.min(p,1)),y(re,a,ne),r){const t=D(se,re,ae);if(this.view.sceneIntersectionHelper.intersectToolIntersectorRay(t,this._intersector),e.hasIntersection=!!this._intersector.results.min&&this._intersector.results.min.getIntersectionPoint(oe),e.isTargetVisible=!0,e.hasIntersection){u(o.points.intersection,oe),u(o.points.intersectionObserver,se),u(o.points.intersectionTarget,re),this.view.renderCoordsHelper.fromRenderCoords(o.points.intersection,ie,this.view.spatialReference);const t=1-b(re,a)/b(n,a);e.isTargetVisible=b(n,o.points.intersection)>=t*b(n,a)}e.isValid=!0;const i=new c(ie,this.view.spatialReference);e.target.intersectedLocation=e.isTargetVisible?null:i,e.target.intersectedGraphic=e.isTargetVisible?null:this._intersector.results.min.toGraphic(this.view),e.target.visible=!!e.hasIntersection&&e.isTargetVisible}else if(e.isValid){u(oe,o.points.intersection);const t=b(e.engine.points.intersectionObserver,o.points.intersection)/b(e.engine.points.intersectionObserver,e.engine.points.intersectionTarget);j(le,se,e.engine.points.intersectionObserver),d(le,le,1-t),y(oe,oe,le),j(le,re,e.engine.points.intersectionTarget),d(le,le,t),y(oe,oe,le)}else e.hasIntersection=!1,e.target.intersectedLocation=null,e.target.intersectedGraphic=null,e.target.visible=void 0;return pe[12]=o.points.observer[0],pe[13]=o.points.observer[1],pe[14]=o.points.observer[2],_(se,se,o.points.observer),_(re,re,o.points.observer),_(oe,oe,o.points.observer),e.engine.visualization.removeAllGeometries(),e.isValid?(e.point.manipulator.state=e.isTargetVisible?16:32,e.engine.visualization.addGeometry(X(se,e.isTargetVisible?re:oe,`${t}-visible-inner`),this._engineResources.visibleLineMaterialInner,pe),e.isTargetVisible?e.engine.visualization.addGeometry(X(se,e.isTargetVisible?re:oe,`${t}-visible-outer`),this._engineResources.visibleLineMaterialOuter,pe):(e.engine.visualization.addGeometry(X(oe,re,`${t}-occluded-inner`),this._engineResources.occludedLineMaterialInner,pe),e.engine.visualization.addGeometry(X(se,re,`${t}-occluded-outer`),this._engineResources.occludedLineMaterialOuter,pe))):(e.point.manipulator.state=64,e.engine.visualization.addGeometry(X(se,re,`${t}-observer-inner`),this._engineResources.undefinedLineMaterialInner,pe),e.engine.visualization.addGeometry(X(se,re,`${t}-observer-inner`),this._engineResources.undefinedLineMaterialOuter,pe)),e.isDirty=!1,!!s&&(s.madeProgress(),s.done)}};e([r({constructOnly:!0})],te.prototype,"view",void 0),e([r({dependsOn:["_showTracker","observer"],readOnly:!0})],te.prototype,"state",null),e([r({readOnly:!0,dependsOn:["_showTracker"]})],te.prototype,"cursor",null),e([r({dependsOn:["view.type"],readOnly:!0})],te.prototype,"isSupported",null),e([r({type:c})],te.prototype,"observer",void 0),e([r({type:ee,nonNullable:!0})],te.prototype,"targets",void 0),e([r({type:Z})],te.prototype,"configuration",void 0),e([r({readOnly:!0})],te.prototype,"updating",void 0),e([r()],te.prototype,"_showTracker",void 0),te=e([n("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],te);const ie=h(),se=h(),re=h(),oe=h(),ne=h(),ae=T(),le=h(),pe=I(),ce=M.create(),he=s.getLogger("esri.widgets.LineOfSight.LineOfSightViewModel");let ue=class extends B{constructor(e){super(e),this.supportedViewType="3d"}get state(){return this.isDisabled?"disabled":this.tool?this.tool.state:"ready"}get observer(){return this.tool?this.tool.observer:this._get("observer")||null}set observer(e){this.tool?this.tool.observer=e:this._set("observer",e)}get targets(){return this.tool?this.tool.targets:this._get("targets")||new ee}set targets(e){const t=l(e,this.targets,ee);this.tool?this.tool.targets=t:this._set("targets",t)}start(){return this.createTool()}clear(){this.removeTool(),this._set("observer",null),this.targets.removeAll()}continue(){this.tool&&this.tool.continue()}stop(){this.tool&&this.tool.stop()}createToolParams(){return{toolConstructor:te,constructorArguments:()=>({observer:this.observer,targets:this.targets})}}logUnsupportedError(){this.logError("LineOfSight widget is not implemented for MapView")}logError(...e){he.error(...e)}};e([r({dependsOn:["isDisabled","tool.attached","tool.state"],readOnly:!0})],ue.prototype,"state",null),e([r()],ue.prototype,"tool",void 0),e([r({dependsOn:["tool.observer"]})],ue.prototype,"observer",null),e([r({type:ee,dependsOn:["tool.targets"],cast:p,nonNullable:!0})],ue.prototype,"targets",null),ue=e([n("esri.widgets.lineOfSight.LineOfSightViewModel")],ue);var me=ue;export default me;
