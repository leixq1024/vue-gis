/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../chunks/object.js";import"../../chunks/deprecate.js";import"../../core/lang.js";import"../../config.js";import{L as t,u as o,b as s}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import{reject as r,createAbortController as n,resolve as a}from"../../core/promiseUtils.js";import"../../chunks/Message.js";import l from"../../core/Error.js";import"../../chunks/compilerUtils.js";import"../../chunks/ensureType.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import u from"../../core/Collection.js";import"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/Promise.js";import"../../chunks/Loadable.js";import"../../core/urlUtils.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import"../../chunks/number.js";import"../../intl.js";import"../../kernel.js";import"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import c from"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import{geographicToWebMercator as m}from"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalUser.js";import"../../portal/Portal.js";import"../../chunks/mathUtils2.js";import"../../chunks/colorUtils.js";import"../../Color.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import"../../layers/support/fieldUtils.js";import"../../popup/content/Content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/CustomContent.js";import"../../chunks/date.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/FieldInfo.js";import"../../popup/content/FieldsContent.js";import"../../chunks/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/MediaContent.js";import"../../popup/content/TextContent.js";import"../../popup/content.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/RelatedRecordsInfo.js";import"../../chunks/Identifiable.js";import h from"../../support/actions/ActionBase.js";import d from"../../support/actions/ActionButton.js";import y from"../../support/actions/ActionToggle.js";import"../../PopupTemplate.js";import"../../symbols/Symbol.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/screenUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/materialUtils.js";import"../../symbols/edges/Edges3D.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/utils.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/patterns/StylePattern3D.js";import"../../symbols/FillSymbol3DLayer.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/Symbol3D.js";import"../../chunks/Thumbnail.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/uid.js";import"../../Graphic.js";import g from"../../core/Handles.js";import j from"../../layers/Layer.js";import"../../chunks/unitUtils.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import{init as f,watch as b,whenFalse as F}from"../../core/watchUtils.js";import"../../chunks/fieldType.js";import"../../core/HandleOwner.js";import"../../chunks/zscale.js";import"../../chunks/queryZScale.js";import"../../layers/support/Field.js";import"../../tasks/support/FeatureSet.js";import"../../chunks/DataLayerSource.js";import"../../tasks/support/AttachmentQuery.js";import"../../tasks/support/Query.js";import"../../tasks/support/StatisticDefinition.js";import"../../tasks/support/RelationshipQuery.js";import"../../tasks/Task.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/featureConversionUtils.js";import"../../tasks/QueryTask.js";import"../../chunks/pbf.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/query.js";import"../../layers/support/AttachmentInfo.js";import"../../chunks/Queue.js";import{V as w}from"../../chunks/InputManager.js";import"../../chunks/throttle.js";import"../Attachments/AttachmentsViewModel.js";import v from"../Feature/FeatureViewModel.js";import{A as _}from"../../chunks/AnchorElementViewModel.js";import{h as k}from"../../chunks/layerViewUtils.js";import{z as C,t as P}from"../../chunks/actions.js";import{G as S}from"../../chunks/GoTo.js";const E=u.ofType({key:"type",defaultKeyValue:"button",base:h,typeMap:{button:d,toggle:y}}),L=t.getLogger("esri.widgets.Popup.PopupViewModel");let M=class extends(S(_)){constructor(e){super(e),this._handles=new g,this._pendingPromises=new Set,this._zoomToLocation=null,this._fetchFeaturesController=null,this.actions=new E([C.clone()]),this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.content=null,this.featureViewModels=[],this.highlightEnabled=!0,this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4}initialize(){this._handles.add([f(this,["autoOpenEnabled","view"],(()=>this._autoOpenEnabledChange())),this.on("view-change",(()=>this._autoClose())),b(this,["highlightEnabled","selectedFeature","visible","view"],(()=>this._highlightFeature())),b(this,"view.animation.state",(e=>this._animationStateChange(e))),b(this,"location",(e=>this._locationChange(e))),b(this,"selectedFeature",(e=>this._selectedFeatureChange(e))),this.on("trigger-action",(e=>P({event:e,view:this.view}))),F(this,"waitingForResult",(()=>this._waitingForResultChange())),b(this,["features","view","view.map","view.spatialReference"],(()=>this._updateFeatureVMs()))])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._handles=null,this._pendingPromises.clear(),this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new E;e.removeAll();const t=this.selectedFeature&&("function"==typeof this.selectedFeature.getEffectivePopupTemplate&&this.selectedFeature.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled)||this.selectedFeature.popupTemplate),o=t&&t.actions,s=t&&t.overwriteActions?o:o?o.concat(this.actions):this.actions;return s&&s.filter(Boolean).forEach((t=>e.add(t))),e}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:o,promiseCount:s,selectedFeatureIndex:i}=this,r=s&&t.length;r&&o&&-1===i?this.selectedFeatureIndex=0:r&&-1!==i||(this.selectedFeatureIndex=t.length?0:-1)}get location(){return this._get("location")||null}set location(e){const t=this.get("view.spatialReference.isWebMercator");e&&e.get("spatialReference.isWGS84")&&t&&(e=m(e)),this._set("location",e)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||0!==this.featureCount)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach((e=>{this._pendingPromises.add(e);e.then((t=>{this._pendingPromises.has(e)&&this._updateFeatures(t),this._updatePendingPromises(e)}),(()=>this._updatePendingPromises(e)))})),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;if(-1===t)return null;return e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return"number"==typeof e?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;e=isNaN(e)||e<-1||!t?-1:(e+t)%t,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:e}=this,t=this._getSelectedTarget();if(!t){const o=new l("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e});return L.error(o),r(o)}return this.callGoTo({target:{target:t,scale:e.scale}})}clear(){this.set({promises:[],features:[],content:null,title:null,location:null})}fetchFeatures(e,t){const{view:o}=this;if(!o||!e){const t=new l("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:o});return L.error(t),r(t)}return o.fetchPopupFeatures(e,{event:t&&t.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t&&t.signal})}open(e){const t={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...e,visible:!0},{fetchFeatures:o}=t;delete t.fetchFeatures,o&&this._setFetchFeaturesPromises(t.location),this.set(t)}triggerAction(e){const t=this.allActions.getItemAt(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}zoomToLocation(){const{location:e,selectedFeature:t,view:o,zoomFactor:s}=this,i=this._getSelectedTarget();if(!i){const e=new l("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:i,view:o});return L.error(e),r(e)}const n=o.scale/s,a=this.get("selectedFeature.geometry")||e,p=a&&"point"===a.type&&this._isZoomScreenSize(t);C.active=!0,C.disabled=!0;const u=this.callGoTo({target:{target:i,scale:p?n:void 0}}).catch((()=>{C.active=!1,C.disabled=!1,this._zoomToLocation=null})).then((()=>{p&&(this.location=a)}));return this._zoomToLocation=u,u}_animationStateChange(e){this._zoomToLocation||(C.disabled="waiting-for-target"===e)}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:o}=this;o&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureChange(e){if(!e)return;const{location:t,updateLocationEnabled:s,view:i}=this;!s&&t||!e.geometry?s&&!e.geometry&&this.centerAtLocation().then((()=>{this.location=i.center.clone()})):this.location=o(this._getPointFromGeometry(e.geometry))}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(e){return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then((e=>{const{clientOnlyGraphics:t,promisesPerLayerView:o}=e,s=a(t),i=o.map((e=>e.promise));this.promises=[s,...i]}))}_destroyFeatureVMs(){this.featureViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("featureViewModels",[])}_updateFeatureVMs(){const{features:e,featureViewModels:t}=this;if(this._destroyFeatureVMs(),!e||!e.length)return;const o=t.slice(0),s=[];e.forEach(((e,t)=>{if(!e)return;let i=null;if(o.some(((t,s)=>(t&&t.graphic===e&&(i=t,o.splice(s,1)),!!i))),i)s[t]=i;else{var r,n;const o=new v({defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,graphic:e,spatialReference:null==(r=this.view)?void 0:r.spatialReference,map:null==(n=this.view)?void 0:n.map});s[t]=o}})),o.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("featureViewModels",s)}_getScreenPoint(e){const{view:t}=this;return t&&e&&"function"==typeof t.toScreen?t.toScreen(e):null}_getSelectedTarget(){const{selectedFeature:e,location:t,view:o}=this;if(!o)return null;if("3d"===o.type)return e||t;return this.get("selectedFeature.geometry")||t}_autoOpenEnabledChange(){const e="auto-fetch-features",{_handles:t,autoOpenEnabled:o}=this;if(t.remove(e),o&&this.view){const o=this.view.on("click",(e=>{"mouse"===e.pointerType&&0!==e.button||this._fetchFeaturesAndOpen(e)}),w.WIDGET);t.add(o,e)}}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(e,t){this._cancelFetchingFeatures();const o=n(),{signal:s}=o;this._fetchFeaturesController=o,this.notifyChange("waitingForResult");const i=this.fetchFeatures(e,{signal:s,event:t});return i.catch((()=>{})).then((()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")})),i}_fetchFeaturesAndOpen(e){const{screenPoint:t,mapPoint:o}=e,{view:s}=this;this._fetchFeaturesWithController(t,e).then((e=>{const{clientOnlyGraphics:t,promisesPerLayerView:i,location:r}=e,n=[a(t),...i.map((e=>e.promise))];return s.popup.open({location:r||o,promises:n}),e}))}_updatePendingPromises(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}_isZoomScreenSize(e){const{view:t}=this;if("3d"!==t.type||!e||"esri.Graphic"!==e.declaredClass)return!0;const o=t.getViewForGraphic(e);if(o&&"whenGraphicBounds"in o){let t=!1;return o.whenGraphicBounds(e,{useViewElevation:!0}).then((e=>{t=!e||!e.boundingBox||e.boundingBox[0]===e.boundingBox[3]&&e.boundingBox[1]===e.boundingBox[4]&&e.boundingBox[2]===e.boundingBox[5]})).catch((()=>{const t=new l("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:e});L.error(t)})),t}return!0}_getPointFromGeometry(e){return s(e)?null:"point"===e.type?e:"extent"===e.type?e.center:"polygon"===e.type?e.centroid:"multipoint"===e.type||"polyline"===e.type?e.extent.center:null}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}async _highlightFeature(){const e="highlight";this._handles.remove(e);const{selectedFeature:t,highlightEnabled:o,view:s,visible:i}=this;if(!(t&&s&&o&&i))return;const{layer:r}=t;if(!(r&&r instanceof j))return;const n=this._getLayerView(s,r);this._highlightPromise=n;const a=await n;if(!(a&&k(a)&&this._highlightPromise===n&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const l="objectIdField"in r&&r.objectIdField,p=t.attributes,u=p&&l&&p[l],c=a.highlight(u||t);this._handles.add(c,e)}_updateFeatures(e){const{features:t}=this;if(!e||!e.length)return;if(!t.length)return void(this.features=e);const o=e.filter((e=>-1===t.indexOf(e)));this.features=t.concat(o)}};e([i({type:E})],M.prototype,"actions",void 0),e([i({readOnly:!0,dependsOn:["visible","waitingForResult"]})],M.prototype,"active",null),e([i({dependsOn:["actions.length","selectedFeature.sourceLayer.popupTemplate.actions.length","selectedFeature.sourceLayer.popupTemplate.overwriteActions","selectedFeature.popupTemplate.actions.length","selectedFeature.popupTemplate.overwriteActions"],readOnly:!0})],M.prototype,"allActions",null),e([i({type:Boolean})],M.prototype,"defaultPopupTemplateEnabled",void 0),e([i()],M.prototype,"autoCloseEnabled",void 0),e([i()],M.prototype,"autoOpenEnabled",void 0),e([i()],M.prototype,"content",void 0),e([i({readOnly:!0,dependsOn:["features"]})],M.prototype,"featureCount",null),e([i()],M.prototype,"features",null),e([i({readOnly:!0})],M.prototype,"featureViewModels",void 0),e([i()],M.prototype,"highlightEnabled",void 0),e([i({type:c})],M.prototype,"location",null),e([i({readOnly:!0,dependsOn:["promises"]})],M.prototype,"pendingPromisesCount",null),e([i({readOnly:!0,dependsOn:["featureCount","pendingPromisesCount"]})],M.prototype,"waitingForResult",null),e([i({readOnly:!0,dependsOn:["promises"]})],M.prototype,"promiseCount",null),e([i()],M.prototype,"promises",null),e([i({value:null,readOnly:!0,dependsOn:["features","selectedFeatureIndex","updateLocationEnabled"]})],M.prototype,"selectedFeature",null),e([i({value:-1})],M.prototype,"selectedFeatureIndex",null),e([i({readOnly:!0,dependsOn:["featureViewModels","selectedFeatureIndex"]})],M.prototype,"selectedFeatureViewModel",null),e([i({readOnly:!0,dependsOn:["view.ready"]})],M.prototype,"state",null),e([i()],M.prototype,"title",void 0),e([i()],M.prototype,"updateLocationEnabled",void 0),e([i()],M.prototype,"view",void 0),e([i()],M.prototype,"visible",void 0),e([i()],M.prototype,"zoomFactor",void 0),e([i()],M.prototype,"centerAtLocation",null),e([i()],M.prototype,"zoomToLocation",null),M=e([p("esri.widgets.Popup.PopupViewModel")],M);var I=M;export default I;
