/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../chunks/object.js";import"../../chunks/deprecate.js";import"../../core/lang.js";import"../../config.js";import{L as e,i as o}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as r}from"../../core/accessorSupport/decorators/property.js";import s from"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import{eachAlways as i,createAbortController as a}from"../../core/promiseUtils.js";import"../../chunks/Message.js";import n from"../../core/Error.js";import"../../chunks/compilerUtils.js";import"../../chunks/ensureType.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import"../../core/Collection.js";import"../../chunks/collectionUtils.js";import"../../chunks/JSONSupport.js";import"../../chunks/Promise.js";import"../../chunks/Loadable.js";import"../../core/urlUtils.js";import"../../core/accessorSupport/decorators/aliasOf.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../chunks/resourceExtension.js";import"../../chunks/persistableUrlUtils.js";import"../../geometry/SpatialReference.js";import"../../chunks/locale.js";import"../../chunks/number.js";import"../../intl.js";import"../../kernel.js";import p from"../../request.js";import"../../chunks/assets.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Extent.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalUser.js";import"../../portal/Portal.js";import"../../chunks/mathUtils2.js";import"../../chunks/colorUtils.js";import"../../Color.js";import"../../chunks/zmUtils.js";import"../../geometry/Multipoint.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../geometry.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/domains.js";import"../../chunks/arcadeOnDemand.js";import{isNumericField as c,getField as u}from"../../layers/support/fieldUtils.js";import"../../popup/content/Content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/CustomContent.js";import"../../chunks/date.js";import"../../popup/support/FieldInfoFormat.js";import d from"../../popup/FieldInfo.js";import"../../popup/content/FieldsContent.js";import"../../chunks/MediaInfo.js";import m from"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/MediaContent.js";import f from"../../popup/content/TextContent.js";import"../../popup/content.js";import h from"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/RelatedRecordsInfo.js";import"../../chunks/Identifiable.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../PopupTemplate.js";import"../../symbols/Symbol.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/screenUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/materialUtils.js";import"../../symbols/edges/Edges3D.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/utils.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/FillSymbol.js";import"../../symbols/patterns/StylePattern3D.js";import"../../symbols/FillSymbol3DLayer.js";import"../../chunks/colors.js";import"../../chunks/Symbol3DOutline.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/Symbol3D.js";import"../../chunks/Thumbnail.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../chunks/Symbol3DVerticalOffset.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureFillSymbol.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../symbols/support/jsonUtils.js";import"../../chunks/uid.js";import y from"../../Graphic.js";import g from"../../core/Handles.js";import"../../chunks/unitUtils.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/timeUtils.js";import"../../TimeExtent.js";import{init as j}from"../../core/watchUtils.js";import"../../chunks/fieldType.js";import{HandleOwnerMixin as b}from"../../core/HandleOwner.js";import"../../chunks/zscale.js";import"../../chunks/queryZScale.js";import"../../layers/support/Field.js";import"../../tasks/support/FeatureSet.js";import"../../chunks/DataLayerSource.js";import"../../tasks/support/AttachmentQuery.js";import I from"../../tasks/support/Query.js";import v from"../../tasks/support/StatisticDefinition.js";import"../../tasks/support/RelationshipQuery.js";import"../../tasks/Task.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/featureConversionUtils.js";import _ from"../../tasks/QueryTask.js";import"../../chunks/pbf.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/query.js";import"../../layers/support/AttachmentInfo.js";import{t as M}from"../../chunks/throttle.js";import k,{g as T,a as F,i as w,p as C,b as S,f as A,c as x,d as L,e as P,h as E,j as O,k as R,l as U,m as D,n as V,o as $,q as N,r as q}from"../Attachments/AttachmentsViewModel.js";let Q=class extends(b(s)){constructor(t){super(t),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(j(this,"creator",(t=>{this._destroyContent(),this._createContent(t)})))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:t,graphic:e,destroyer:o}=this;t&&(T(o,{graphic:e}).catch((()=>null)),this._set("created",null))}async _createContent(t){const{graphic:e}=this,o=T(t,{graphic:e}).catch((()=>null));this._loadingPromise=o,this.notifyChange("state");const r=await o;o===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",r))}};t([r({readOnly:!0})],Q.prototype,"created",void 0),t([r()],Q.prototype,"creator",void 0),t([r()],Q.prototype,"destroyer",void 0),t([r({type:y})],Q.prototype,"graphic",void 0),t([r({readOnly:!0})],Q.prototype,"state",null),Q=t([l("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],Q);var z=Q;let B=class extends s{constructor(t){super(t),this.attributes=null,this.expressionInfos=null,this.fieldInfos=null}get formattedFieldInfos(){const{expressionInfos:t,fieldInfos:e}=this,o=[];return null==e||e.forEach((e=>{if(!(!e.hasOwnProperty("visible")||e.visible))return;const r=e.clone();r.label=F(r,t),o.push(r)})),o}};t([r()],B.prototype,"attributes",void 0),t([r({type:[h]})],B.prototype,"expressionInfos",void 0),t([r({type:[d]})],B.prototype,"fieldInfos",void 0),t([r({readOnly:!0,dependsOn:["expressionInfos","fieldInfos"]})],B.prototype,"formattedFieldInfos",null),B=t([l("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],B);var G=B;const W=e.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),H=new Map;function J(t){if(!w(t))return null;const[e,o]=t.split("/").slice(1);return{layerId:e,fieldName:o}}function Z(t,e){const o=function(t,e){if(!e.relationships)return null;let o=null;const{relationships:r}=e;return r.some((e=>e.id===parseInt(t,10)&&(o=e,!0))),o}(t,e);if(!o)return;const r=`${e.url}/${o.relatedTableId}`;return{url:r,queryTask:new _({url:r,sourceSpatialReference:e.spatialReference}),relation:o,relatedFields:[],outStatistics:[]}}function K({relatedInfos:t,layer:e},o){const r={};return t.forEach(((t,s)=>{const{relation:i}=t;if(!i){const t=new n("relation-required","A relation is required on a layer to retrieve related records.");throw W.error(t),t}const{relatedTableId:a}=i;if("number"!=typeof a){const t=new n("A related table ID is required on a layer to retrieve related records.");throw W.error(t),t}const l=`${e.url}/${a}`,c=H.get(l),u=c||function(t,e){return p(t,{query:{f:"json"},signal:e&&e.signal})}(l,o);c||H.set(l,u),r[s]=u})),i(r)}function X({graphic:t,relatedInfos:e,layer:o},r){const s={};return e.forEach(((e,a)=>{e.layerInfo&&(s[a]=async function(t,e,o,r){var s;const a=o.layerId.toString(),{layerInfo:n,queryTask:l,relation:p}=e,d=null==(s=function({originRelationship:t,relationships:e,layerId:o}){let r;return e&&e.some((e=>(`${e.relatedTableId}`===o&&e.id===t.id&&(r=e),!!r))),r}({originRelationship:p,relationships:n.relationships,layerId:a}))?void 0:s.keyField;if(d){const o=c(u(n.fields,d)),s=function(t,e){const o=e.toLowerCase();for(const e in t)if(e.toLowerCase()===o)return t[e];return null}(t.attributes,p.keyField),a=o?`${d}=${s}`:`${d}='${s}'`,m=l.execute(new I({where:a,outFields:e.relatedFields}),r),f=e.outStatistics&&e.outStatistics.length>0&&n.supportsStatistics?l.execute(new I({where:a,outFields:e.relatedFields,outStatistics:e.outStatistics}),r):null,h={features:m};return f&&(h.statsFeatures=f),i(h)}return null}(t,e,o,r))})),i(s)}let Y=class extends s{constructor(t){super(t),this.activeMediaInfoIndex=0,this.attributes=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,o=(t+e)%e;this.activeMediaInfoIndex=o}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,o=e+t;this._setContentElementMedia(o)}_formatMediaInfos(){const{attributes:t,mediaInfos:e,formattedAttributes:o,fieldInfoMap:r,layer:s}=this,i={...o,...t};return null==e?void 0:e.map((e=>{if(!e)return null;const a=e.title?C(e.title,i,s):"";e.title=a?S({formattedAttributes:o,template:a,fieldInfoMap:r}):"";const n=e.caption?C(e.caption,i,s):"";e.caption=n?S({formattedAttributes:o,template:n,fieldInfoMap:r}):"";const l=e.altText?C(e.altText,i,s):"";if(e.altText=l?S({formattedAttributes:o,template:l,fieldInfoMap:r}):"","image"===e.type){const{value:t}=e;return this._setImageValue({value:t,formattedAttributes:o,layer:s}),e.value.sourceURL?e:void 0}if("pie-chart"===e.type||"line-chart"===e.type||"column-chart"===e.type||"bar-chart"===e.type){const{value:r}=e;return this._setChartValue({value:r,chartType:e.type,attributes:t,formattedAttributes:o,layer:s}),e}return null})).filter(Boolean)}_setImageValue(t){const{fieldInfoMap:e}=this,{value:o,formattedAttributes:r,layer:s}=t,{linkURL:i,sourceURL:a}=o;if(a){const t=A(a,s);o.sourceURL=S({formattedAttributes:r,template:t,fieldInfoMap:e})}if(i){const t=A(i,s);o.linkURL=S({formattedAttributes:r,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:o,formattedAttributes:r,chartType:s,layer:i}=t,{popupTemplate:a,relatedInfos:n}=this,{fields:l,normalizeField:p}=e;e.fields=x(l,i),p&&(e.normalizeField=L(p,i));if(!l.some((t=>!!(null!=r[t]||w(t)&&n.size))))return;const c=null==a?void 0:a.fieldInfos;l.forEach((t=>{if(w(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:c,fieldName:t,formattedAttributes:r,chartType:s,value:e})]);const i=this._getChartOption({value:e,attributes:o,chartType:s,formattedAttributes:r,fieldName:t,fieldInfos:c});e.series.push(i)}))}_getRelatedChartInfos(t){var e;const{fieldInfos:o,fieldName:r,formattedAttributes:s,chartType:i,value:a}=t,n=[],l=J(r),{layerId:p,fieldName:c}=l,u=null==(e=this.relatedInfos)?void 0:e.get(p.toString());if(!u)return n;const{relatedFeatures:d,relation:m}=u;if(!m||!d)return n;const{cardinality:f}=m;d.forEach((t=>{const{attributes:e}=t;e&&Object.keys(e).forEach((t=>{t===c&&n.push(this._getChartOption({value:a,attributes:e,formattedAttributes:s,fieldName:r,chartType:i,relatedFieldName:t,fieldInfos:o}))}))}));return"one-to-many"===f||"many-to-many"===f?n:[n[0]]}_getTooltip({label:t,value:e,chartType:o}){return"pie-chart"===o?t:`${t}: ${e}`}_getChartOption(t){var e;const{value:o,attributes:r,formattedAttributes:s,fieldName:i,relatedFieldName:a,fieldInfos:n,chartType:l}=t,{layer:p}=this,{normalizeField:c,tooltipField:u}=o,f=c?w(c)?r[J(c).fieldName]:r[c]:null,h=a&&void 0!==r[a]?r[a]:void 0!==r[i]?r[i]:s[i],y=void 0===h?null:h&&f?h/f:h,g=new m({value:y});if(w(i)){const t=J(i),e=J(u),o=e?e.fieldName:null,s=P(y,{fieldInfos:n,fieldName:a,layer:p,preventPlacesFormatting:!!f}),c=t?t.label||t.fieldName:a,d=o&&void 0!==r[o]?r[o]:c;return g.tooltip=this._getTooltip({label:d,value:s,chartType:l}),g}const j=E(n,i),b=L(i,p),I=u&&void 0!==s[u]?s[u]:F(j||new d({fieldName:b}),null==(e=this.popupTemplate)?void 0:e.expressionInfos),v=s[b];return g.tooltip=this._getTooltip({label:I,value:v,chartType:l}),g}};t([r()],Y.prototype,"activeMediaInfoIndex",void 0),t([r({readOnly:!0,dependsOn:["formattedMediaInfos","activeMediaInfoIndex"]})],Y.prototype,"activeMediaInfo",null),t([r()],Y.prototype,"attributes",void 0),t([r()],Y.prototype,"fieldInfoMap",void 0),t([r()],Y.prototype,"formattedAttributes",void 0),t([r({readOnly:!0,dependsOn:["attributes","fieldInfoMap","formattedAttributes","mediaInfos","popupTemplate","layer","relatedInfos"]})],Y.prototype,"formattedMediaInfos",null),t([r()],Y.prototype,"layer",void 0),t([r({readOnly:!0,dependsOn:["formattedMediaInfos"]})],Y.prototype,"formattedMediaInfoCount",null),t([r()],Y.prototype,"mediaInfos",void 0),t([r()],Y.prototype,"popupTemplate",void 0),t([r()],Y.prototype,"relatedInfos",void 0),Y=t([l("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],Y);var tt=Y;const et=["$datastore","$map","$layer"],ot=e.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");async function rt({expressionAttributes:t,info:e,arcadeUtils:o,spatialReference:r,map:s,graphic:i}){const a=`expression/${e.name}`,n=o.createSyntaxTree(e.expression),l=et.filter((t=>o.hasVariable(n,t)));await o.loadScriptDependencies(n,!0,l);const p=o.getViewInfo({spatialReference:r}),c=o.createExecContext(i,p);c.useAsync=!0,function({arcadeUtils:t,featureSetVars:e,context:o,viewInfo:r,map:s,graphic:i}){e.forEach((e=>{const a=e.toLowerCase(),n={map:s,spatialReference:r.sr};"$map"===a&&(o.vars[a]=t.convertMapToFeatureSetCollection(n)),"$layer"===a&&(o.vars[a]=t.convertFeatureLayerToFeatureSet(i.sourceLayer,r.sr)),"$datastore"===a&&(o.vars[a]=t.convertServiceUrlToWorkspace(i.sourceLayer.url,r.sr))}))}({arcadeUtils:o,featureSetVars:l,context:c,viewInfo:p,map:s,graphic:i});const u=o.createFunction(n,c),d=await o.executeAsyncFunction(u,c).catch((t=>ot.error("arcade-execution-error",{error:t,graphic:i,expressionInfo:e})));var m;t[a]="string"==typeof d?O(R(d)):Array.isArray(d)?function(t){return`<ul class="esri-widget__list">${t.map((t=>`<li>${"string"==typeof t?O(R(t)):t}</li>`)).join("")}</ul>`}(d):d&&"esri.arcade.Dictionary"===d.declaredClass?`<table class="esri-widget__table">${(m=d).keys().map((t=>{const e=m.field(t);return`<tr><th>${t}</th><td>${"string"==typeof e?O(R(e)):e}</td></tr>`})).join("")}</table>`:d}async function st({popupTemplate:t,spatialReference:e,graphic:o,map:r}){const s=t.expressionInfos,a=[],n={};if(!s||!s.length)return n;const l=await import("../../chunks/arcadeUtils.js").then((function(t){return t.aq}));for(const t of s)a.push(rt({expressionAttributes:n,info:t,arcadeUtils:l,spatialReference:e,map:r,graphic:o}));return await i(a),n}const it=e.getLogger("esri.widgets.FeatureViewModel");let at=class extends s{constructor(t){super(t),this._handles=new g,this._featureAbortController=null,this.graphicChangedThrottled=M(this.graphicChanged,1,this),this.content=null,this.contentViewModels=[],this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._handles.add(j(this,["graphic","_effectivePopupTemplate"],(()=>this.graphicChangedThrottled())))}destroy(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return o(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return U(D(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return V(this.graphic)}set graphic(t){this._set("graphic",t?t.clone():null)}get spatialReference(){return this.get("view.spatialReference")||null}set spatialReference(t){void 0!==t?this._override("spatialReference",t):this._clearOverride("spatialReference")}get map(){return this.get("view.map")||null}set map(t){void 0!==t?this._override("map",t):this._clearOverride("map")}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(t,e){const o=this.contentViewModels[t];o instanceof tt&&o.setActiveMedia(e)}nextMedia(t){const e=this.contentViewModels[t];e instanceof tt&&e.next()}previousMedia(t){const e=this.contentViewModels[t];e instanceof tt&&e.previous()}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async graphicChanged(){this._cancelFeatureQuery(),this._clear();const{graphic:t}=this;if(!t)return;const e=a();this._featureAbortController=e;try{await this._queryFeature({signal:e.signal})}catch(e){it.error("error","error loading popupTemplate for graphic",{error:e,graphic:t})}this._featureAbortController===e&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:t}=this;t&&t.abort(),this._featureAbortController=null}_compileContent(t){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(t)?t.map(((t,e)=>"attachments"===t.type?this._compileAttachments(t,e):"custom"===t.type?this._compileCustom(t,e):"fields"===t.type?this._compileFields(t,e):"media"===t.type?this._compileMedia(t,e):"text"===t.type?this._compileText(t,e):void 0)):"string"==typeof t?this._compileText(new f({text:t}),0).text:t}_destroyContentViewModels(){this.contentViewModels.forEach((t=>t&&!t.destroyed&&t.destroy())),this._set("contentViewModels",[])}_compileAttachments(t,e){const{graphic:o}=this;return this.contentViewModels[e]=new k({graphic:o}),t}_compileCustom(t,e){const{graphic:o}=this,{creator:r,destroyer:s}=t;return this.contentViewModels[e]=new z({graphic:o,creator:r,destroyer:s}),t}_compileFields(t,e){const{_effectivePopupTemplate:o,formattedAttributes:r}=this,s=t.clone(),i=(null==t?void 0:t.fieldInfos)||(null==o?void 0:o.fieldInfos),a=null==o?void 0:o.expressionInfos,n={...r.global,...r.content[e]},l=new G({attributes:n,expressionInfos:a,fieldInfos:i});return this.contentViewModels[e]=l,s.fieldInfos=l.formattedFieldInfos.slice(0),s}_compileMedia(t,e){const{graphic:o,_fieldInfoMap:r,_effectivePopupTemplate:s,relatedInfos:i,_sourceLayer:a}=this,{attributes:n}=o,l=this.formattedAttributes.global,p=t.clone(),{mediaInfos:c}=p,u=new tt({activeMediaInfoIndex:p.activeMediaInfoIndex||0,attributes:n,layer:a,fieldInfoMap:r,formattedAttributes:l,mediaInfos:c,popupTemplate:s,relatedInfos:i});return p.mediaInfos=u.formattedMediaInfos.slice(0),this.contentViewModels[e]=u,p}_compileText(t,e){const o=t.clone(),{graphic:r,_fieldInfoMap:s,_sourceLayer:i}=this;if(o&&o.text){const{attributes:t}=r,e=this.formattedAttributes.global,a=C(o.text,{...e,...t},i);o.text=S({formattedAttributes:e,template:a,fieldInfoMap:s})}return this.contentViewModels[e]=new z({graphic:r,creator:o.text}),o}_compileLastEditInfo(){const{_effectivePopupTemplate:t,_sourceLayer:e,graphic:o}=this;if(!t)return;const{lastEditInfoEnabled:r}=t,s=null==e?void 0:e.editFieldsInfo;return r&&s?$(s,o.attributes):void 0}_compileTitle(t){const{_fieldInfoMap:e,_sourceLayer:o,graphic:r}=this,{attributes:s}=r,i=this.formattedAttributes.global;if(t){const r=C(t,{...i,...s},o);return S({formattedAttributes:i,template:r,fieldInfoMap:e})}return""}async _getTitle(){const{_effectivePopupTemplate:t,graphic:e}=this,o=null==t?void 0:t.title;return T(o,{graphic:e})}async _getContent(){const{_effectivePopupTemplate:t,graphic:e}=this,o=null==t?void 0:t.content;return T(o,{graphic:e})}async _queryFeature(t){const{_featureAbortController:e,_sourceLayer:o,graphic:r,_effectivePopupTemplate:s,spatialReference:a,map:n}=this,{content:{value:l},title:{value:p}}=await i({content:this._getContent(),title:this._getTitle()});if(e!==this._featureAbortController||!r)return;const{expressionAttributes:{value:c}}=await i({checkForRelatedFeatures:this._checkForRelatedFeatures(t),expressionAttributes:st({popupTemplate:this._effectivePopupTemplate,spatialReference:a,graphic:r,map:n}),queryUpdatedFeature:N({graphic:r,popupTemplate:s,layer:o},t)});e===this._featureAbortController&&r&&(this._set("formattedAttributes",this._createFormattedAttributes(l,c)),this._set("title",this._compileTitle(p)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createFormattedAttributes(t,e){const{_effectivePopupTemplate:o,graphic:r,relatedInfos:s,_sourceLayer:i,_fieldInfoMap:a}=this,n=null==o?void 0:o.fieldInfos,l={...r.attributes,...e},p={global:q({fieldInfos:n,graphic:r,attributes:l,layer:i,fieldInfoMap:a,relatedInfos:s}),content:[]};return Array.isArray(t)&&t.forEach(((t,e)=>{"fields"===t.type&&t.fieldInfos&&(p.content[e]=q({fieldInfos:t.fieldInfos,graphic:r,attributes:l,layer:i,fieldInfoMap:a,relatedInfos:s}))})),p}_checkForRelatedFeatures(t){const{graphic:e,_effectivePopupTemplate:o}=this;return this._queryRelatedInfos(e,D(o),t)}async _queryRelatedInfos(t,e,r){const{relatedInfos:s,_sourceLayer:i}=this;s.clear();const a=o(i.associatedLayer)?await i.associatedLayer.load(r):i;if(!a)return;const n=e.filter((t=>t&&w(t.fieldName)));if(!n||!n.length)return;e.forEach((t=>this._configureRelatedInfo(t,a)));const l=await K({relatedInfos:s,layer:a},r);Object.keys(l).forEach((t=>{var e;const o=s.get(t.toString()),r=null==(e=l[t])?void 0:e.value;o&&r&&(o.layerInfo=r.data)}));const p=await X({graphic:t,relatedInfos:s,layer:a},r);Object.keys(p).forEach((t=>{var e;!function(t,e){if(!e)return;if(!t)return;const{features:o,statsFeatures:r}=t,s=o&&o.value;e.relatedFeatures=s?s.features:[];const i=r&&r.value;e.relatedStatsFeatures=i?i.features:[]}(null==(e=p[t])?void 0:e.value,s.get(t.toString()))}))}_configureRelatedInfo(t,e){const{relatedInfos:o}=this,r=J(t.fieldName);if(!r)return;const{layerId:s,fieldName:i}=r;if(!s)return;const a=o.get(s.toString())||Z(s,e);a&&(!function({relatedInfo:t,fieldName:e,fieldInfo:o}){if(t.relatedFields.push(e),o.statisticType){const r=new v({statisticType:o.statisticType,onStatisticField:e,outStatisticFieldName:e});t.outStatistics.push(r)}}({relatedInfo:a,fieldName:i,fieldInfo:t}),this.relatedInfos.set(s,a))}};t([r()],at.prototype,"_featureAbortController",void 0),t([r({readOnly:!0,dependsOn:["graphic","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.expressionInfos","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.sourceLayer.popupTemplate.outFields","graphic.sourceLayer.popupTemplate.relatedRecordsInfo","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.expressionInfos","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.outFields","graphic.popupTemplate.relatedRecordsInfo","defaultPopupTemplateEnabled"]})],at.prototype,"_effectivePopupTemplate",null),t([r({readOnly:!0,dependsOn:["_effectivePopupTemplate","_sourceLayer"]})],at.prototype,"_fieldInfoMap",null),t([r({readOnly:!0,dependsOn:["graphic.layer","graphic.sourceLayer"]})],at.prototype,"_sourceLayer",null),t([r({readOnly:!0})],at.prototype,"content",void 0),t([r({readOnly:!0})],at.prototype,"contentViewModels",void 0),t([r({type:Boolean})],at.prototype,"defaultPopupTemplateEnabled",void 0),t([r({readOnly:!0})],at.prototype,"formattedAttributes",void 0),t([r({type:y,value:null})],at.prototype,"graphic",null),t([r({readOnly:!0})],at.prototype,"lastEditInfo",void 0),t([r()],at.prototype,"relatedInfos",void 0),t([r({dependsOn:["view"]})],at.prototype,"spatialReference",null),t([r({readOnly:!0})],at.prototype,"title",void 0),t([r({dependsOn:["view"]})],at.prototype,"map",null),t([r({readOnly:!0,dependsOn:["_featureAbortController"]})],at.prototype,"waitingForContent",null),t([r()],at.prototype,"view",void 0),at=t([l("esri.widgets.FeatureViewModel")],at);var nt=at;export default nt;export{z as F,G as a,tt as b};
