/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{O as t}from"../chunks/ArrayPool.js";import{h as i,a as r}from"../chunks/object.js";import{b as s}from"../chunks/deprecate.js";import{clone as a,mixin as n,s as o,i as l,a as c}from"../core/lang.js";import"../config.js";import{i as h,L as d,b as u,e as p,u as m,c as f,g,f as v,h as y,r as _,d as x}from"../chunks/Logger.js";import"../chunks/string.js";import{t as b,h as w,f as C}from"../chunks/metadata.js";import{property as S}from"../core/accessorSupport/decorators/property.js";import T,{a as P}from"../core/Accessor.js";import"../chunks/PropertyOrigin.js";import{P as R,u as M,addFrameTask as O,b as D,r as A,e as E,d as I,g as L,setFrameDuration as F}from"../core/scheduling.js";import{createResolver as V,createAbortController as z,isAbortError as U,resolve as k,createTask as j,after as G,createAbortError as B,throwIfAbortError as N,throwIfAborted as q,onAbortOrThrow as H,create as W,isAborted as Z,onAbort as Q,eachAlways as Y,reject as $,all as X,isThenable as K,o as J}from"../core/promiseUtils.js";import"../chunks/Message.js";import ee from"../core/Error.js";import{n as te}from"../chunks/compilerUtils.js";import{e as ie}from"../chunks/ensureType.js";import{subclass as re}from"../core/accessorSupport/decorators/subclass.js";import{E as se}from"../chunks/Evented.js";import ae from"../core/Collection.js";import"../chunks/collectionUtils.js";import"../chunks/JSONSupport.js";import"../chunks/Promise.js";import"../chunks/Loadable.js";import{f as ne,r as oe}from"../chunks/asyncUtils.js";import"../chunks/loadAll.js";import{dataComponents as le,isSVG as ce}from"../core/urlUtils.js";import{aliasOf as he}from"../core/accessorSupport/decorators/aliasOf.js";import{cast as de}from"../core/accessorSupport/decorators/cast.js";import"../chunks/jsonMap.js";import"../chunks/enumeration.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../chunks/resourceExtension.js";import"../chunks/persistableUrlUtils.js";import ue,{b as pe,c as me,h as fe}from"../geometry/SpatialReference.js";import"../chunks/locale.js";import"../chunks/number.js";import"../intl.js";import"../kernel.js";import"../request.js";import{f as ge,g as ve}from"../chunks/assets.js";import ye from"../geometry/Geometry.js";import _e from"../geometry/Point.js";import{e as xe,m as be,a as we}from"../chunks/Ellipsoid.js";import{geographicToWebMercator as Ce,canProject as Se,project as Te}from"../geometry/support/webMercatorUtils.js";import Pe from"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../portal/PortalItem.js";import"../Basemap.js";import"../chunks/writeUtils.js";import{c as Re,d as Me,r as Oe,h as De,a as Ae,s as Ee,b as Ie,i as Le,j as Fe,n as Ve,l as ze}from"../chunks/mathUtils2.js";import{a as Ue,f as ke,c as je,Z as Ge,O as Be,b as Ne,u as qe,d as He}from"../chunks/vec3f64.js";import{t as We}from"../chunks/common.js";import{s as Ze,a as Qe,f as Ye,l as $e,g as Xe,k as Ke,e as Je,m as et,b as tt,i as it,o as rt,d as st,c as at,n as nt,h as ot,t as lt,p as ct,q as ht,r as dt,u as ut,v as pt,w as mt,x as ft,y as gt,z as vt,A as yt}from"../chunks/vec3.js";import{a as _t,d as xt,b as bt,s as wt,e as Ct,C as St,f as Tt,g as Pt,h as Rt,c as Mt,i as Ot}from"../chunks/mathUtils.js";import Dt from"../Camera.js";import"../chunks/colorUtils.js";import At from"../Color.js";import"../chunks/zmUtils.js";import Et from"../geometry/Multipoint.js";import It from"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/domains.js";import{a as Lt}from"../chunks/arcadeOnDemand.js";import"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"../chunks/date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"../chunks/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"../chunks/Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import Ft from"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import{b as Vt,s as zt,d as Ut,a as kt,p as jt,c as Gt,e as Bt,f as Nt}from"../chunks/screenUtils.js";import"../chunks/opacityUtils.js";import"../chunks/materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/utils.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"../chunks/colors.js";import"../chunks/Symbol3DOutline.js";import"../symbols/Font.js";import{d as qt}from"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import{d as Ht}from"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"../chunks/Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import{i as Wt}from"../chunks/Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../chunks/urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import Zt from"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols/support/jsonUtils.js";import"../chunks/uid.js";import Qt from"../Graphic.js";import Yt from"../Ground.js";import $t from"../core/Handles.js";import{C as Xt}from"../chunks/CollectionFlattener.js";import"../chunks/basemapUtils.js";import"../Map.js";import"../layers/Layer.js";import"../chunks/TablesMixin.js";import"../chunks/LegendOptions.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../tasks/support/ColorRamp.js";import"../tasks/support/AlgorithmicColorRamp.js";import"../tasks/support/MultipartColorRamp.js";import"../chunks/colorRamps.js";import"../renderers/Renderer.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../renderers/visualVariables/SizeVariable.js";import"../chunks/sizeVariableUtils.js";import{e as Kt,a as Jt,f as ei}from"../chunks/unitUtils.js";import{m as ti}from"../chunks/lengthUtils.js";import{getVisualVariableValues as ii}from"../chunks/visualVariableUtils.js";import"../chunks/VisualVariablesMixin.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties.js";import"../renderers/ClassBreaksRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/devEnvironmentUtils.js";import{d as ri}from"../chunks/styleUtils.js";import"../renderers/UniqueValueRenderer.js";import"../geometry/support/normalizeUtils.js";import{M as si,a as ai}from"../chunks/MemCache.js";import"../chunks/ItemCache.js";import"../chunks/utils3.js";import"../symbols/support/cimSymbolUtils.js";import{g as ni}from"../chunks/utils2.js";import"../chunks/LRUCache.js";import"../renderers/DictionaryRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../renderers/HeatmapRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/support/jsonUtils.js";import{M as oi}from"../chunks/timeUtils.js";import"../TimeExtent.js";import li from"../Viewpoint.js";import"../chunks/ReadOnlyMultiOriginJSONSupport.js";import"../chunks/MultiOriginJSONSupport.js";import{on as ci,init as hi,when as di,whenOnce as ui,once as pi,whenFalseOnce as mi,whenTrueOnce as fi,whenTrue as gi}from"../core/watchUtils.js";import"../chunks/arcgisLayerUrl.js";import vi from"../tasks/support/ProjectParameters.js";import"../chunks/fieldType.js";import"../chunks/Version.js";import yi from"../geometry/HeightModelInfo.js";import{c as _i,a as xi,l as bi,m as wi,d as Ci,i as Si,e as Ti,f as Pi,r as Ri,t as Mi,g as Oi,s as Di,o as Ai,h as Ei}from"../chunks/mat4.js";import"../chunks/pe.js";import{b as Ii,c as Li,e as Fi,o as Vi,w as zi,h as Ui,d as ki,i as ji,f as Gi,g as Bi,s as Ni,j as qi,k as Hi,l as Wi,m as Zi,n as Qi,p as Yi,q as $i,r as Xi,u as Ki,t as Ji}from"../chunks/aaBoundingRect.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformationStep.js";import"../geometry/support/GeographicTransformation.js";import{canProjectToWGS84ComparableLonLat as er,projectPointToWGS84ComparableLonLat as tr,projectPointToVector as ir,projectVectorToVector as rr,projectVectorToPoint as sr,projectBuffer as ar,computeLinearTransformation as nr,projectBoundingRect as or,canProjectWithoutEngine as lr,projectVectorToDehydratedPoint as cr,webMercator as hr,lonLatToSphericalPCPF as dr}from"../geometry/projection.js";import{m as ur,r as pr}from"../chunks/heightModelInfoUtils.js";import{i as mr}from"../chunks/spatialReferenceSupport.js";import fr from"../webscene/Lighting.js";import"../webscene/background/Background.js";import gr from"../webscene/background/ColorBackground.js";import vr from"../webscene/Environment.js";import"../chunks/OperationalLayer.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../chunks/commonProperties2.js";import{W as yr}from"../core/HandleOwner.js";import{c as _r}from"../chunks/_commonjsHelpers.js";import"../core/workers/Connection.js";import{T as xr,n as br,a as wr,I as Cr}from"../chunks/Scheduler.js";import{initialize as Sr}from"../core/workers/workers.js";import{c as Tr,f as Pr,a as Rr,O as Mr,Z as Or,b as Dr}from"../chunks/vec4f64.js";import{e as Ar,c as Er,r as Ir,t as Lr,s as Fr}from"../chunks/screenshotUtils.js";import"../geometry/support/MeshTexture.js";import"../geometry/support/MeshMaterial.js";import Vr from"../geometry/support/MeshMaterialMetallicRoughness.js";import zr from"../geometry/support/MeshComponent.js";import{e as Ur}from"../chunks/earcut.js";import"../chunks/deduplicate.js";import{p as kr}from"../chunks/triangulationUtils.js";import{c as jr,f as Gr,a as Br,I as Nr,d as qr,b as Hr}from"../chunks/quatf64.js";import{t as Wr,n as Zr,f as Qr,b as Yr,c as $r,d as Xr,e as Kr}from"../chunks/mat3.js";import{B as Jr,b as es,c as ts,d as is,e as rs,f as ss,g as as,a as ns,h as os}from"../chunks/BufferView.js";import{s as ls,d as cs,c as hs,b as ds,i as us,k as ps,a as ms,f as fs,g as gs,l as vs,m as ys,j as _s,n as xs}from"../chunks/vec2.js";import{s as bs,t as ws,a as Cs,b as Ss,c as Ts,e as Ps,v as Rs,l as Ms}from"../chunks/vec4.js";import{a as Os,d as Ds}from"../chunks/projection.js";import{t as As,a as Es}from"../chunks/vec32.js";import{c as Is,a as Ls}from"../chunks/quat.js";import{b as Fs}from"../chunks/domUtils.js";import"../chunks/widgetUtils.js";import"../chunks/projector.js";import"../chunks/accessibleHandler.js";import"../chunks/messageBundle.js";import"../chunks/renderable.js";import"../chunks/vmEvent.js";import"../chunks/index.js";import"../widgets/support/widget.js";import"../widgets/Widget.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"../chunks/zscale.js";import"../chunks/queryZScale.js";import"../layers/support/Field.js";import"../tasks/support/FeatureSet.js";import"../chunks/ArcGISService.js";import"../chunks/BlendLayer.js";import"../chunks/CustomParametersMixin.js";import"../chunks/PortalLayer.js";import"../chunks/RefreshableLayer.js";import"../chunks/ScaleRangeLayer.js";import"../chunks/labelUtils.js";import"../layers/support/LabelClass.js";import"../chunks/defaultsJSON.js";import"../chunks/defaults.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"../layers/support/FieldsIndex.js";import"../chunks/DataLayerSource.js";import"../support/popupUtils.js";import"../tasks/support/AttachmentQuery.js";import"../tasks/support/Query.js";import"../tasks/support/StatisticDefinition.js";import"../tasks/support/RelationshipQuery.js";import"../chunks/serviceTileInfoProperty.js";import"../chunks/TilemapCache.js";import"../chunks/ArcGISCachedService.js";import{a as Vs,r as zs,W as Us}from"../layers/ElevationLayer.js";import"../chunks/GraphicsCollection.js";import"../tasks/Task.js";import"../chunks/OptimizedGeometry.js";import{b as ks}from"../chunks/featureConversionUtils.js";import"../tasks/QueryTask.js";import"../chunks/pbf.js";import"../chunks/pbfQueryUtils.js";import"../chunks/query.js";import"../layers/support/AttachmentInfo.js";import{c as js,i as Gs,b as Bs,f as Ns,o as qs,s as Hs,g as Ws,h as Zs,Z as Qs,a as Ys,j as $s,t as Xs,k as Ks,l as Js,m as ea,n as ta,p as ia,q as ra,r as sa,u as aa,v as na,w as oa,x as la,y as ca,z as ha}from"../chunks/aaBoundingBox.js";import{b as da}from"../chunks/scaleUtils.js";import"../chunks/SublayersOwner.js";import"../layers/support/Sublayer.js";import"../chunks/sublayerUtils.js";import"./BasemapView.js";import{s as ua}from"../chunks/MapUtils.js";import pa from"./View.js";import"../chunks/RefreshableLayerView.js";import"../chunks/Queue.js";import{I as ma,a as fa,V as ga}from"../chunks/InputManager.js";import{D as va}from"../chunks/interactiveToolUtils.js";import"../chunks/throttle.js";import"../widgets/Attachments.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../widgets/Feature/FeatureViewModel.js";import"../widgets/Feature.js";import"../chunks/AnchorElementViewModel.js";import"../widgets/Spinner/SpinnerViewModel.js";import"../widgets/Popup.js";import{o as ya}from"../chunks/layerViewUtils.js";import"../chunks/actions.js";import"../chunks/GoTo.js";import"../widgets/Popup/PopupViewModel.js";import{i as _a,a as xa}from"../chunks/screenUtils2.js";import"./input/gamepad/GamepadInputDevice.js";import"./input/gamepad/GamepadSettings.js";import"./input/Input.js";import"./navigation/gamepad/GamepadSettings.js";import"./navigation/Navigation.js";import"../layers/TileLayer.js";import"../layers/VectorTileLayer.js";import"../chunks/TileKey.js";import"../chunks/TileIndex.js";import"../chunks/jsonContext.js";import"../chunks/StyleRepository.js";import"../chunks/unitBezier.js";import"../chunks/definitions.js";import{c as ba}from"../chunks/capabilities2.js";import"../layers/support/ElevationSampler.js";import{b as wa,i as Ca,c as Sa}from"../chunks/layerUtils.js";import"../chunks/quantizationUtils.js";import"../chunks/mat2d.js";import"../chunks/mat2df32.js";import{f as Ta}from"../chunks/vec2f32.js";import{c as Pa,e as Ra,n as Ma,m as Oa,i as Da}from"../chunks/dehydratedFeatures.js";import{g as Aa,S as Ea}from"../chunks/ElevationProvider.js";import{E as Ia,M as La,G as Fa,L as Va,a as za,W as Ua,b as ka,T as ja,D as Ga,c as Ba,d as Na,e as qa,f as Ha}from"../chunks/TerrainConst.js";import Wa from"./GroundView.js";import{e as Za,h as Qa,a as Ya,i as $a,j as Xa,D as Ka,B as Ja,I as en,S as tn,c as rn,d as sn,f as an,P as nn,g as on}from"../chunks/WebGLRequirements.js";import ln from"./ViewAnimation.js";import"../chunks/mat2df64.js";import{c as cn,f as hn,a as dn,Z as un}from"../chunks/vec2f64.js";import"../chunks/viewpointUtils.js";import{f as pn,c as mn,a as fn}from"../chunks/mat3f32.js";import gn from"./2d/ViewState.js";import{P as vn}from"../chunks/PointerClickHoldAndDrag.js";import"./ui/UI.js";import"../widgets/Attribution/AttributionViewModel.js";import"../widgets/Attribution.js";import"../widgets/Compass/CompassViewModel.js";import"../widgets/Compass.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/NavigationToggle.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";import yn from"./ui/DefaultUI.js";import{r as _n}from"../chunks/requestImageUtils.js";import{S as xn,g as bn,T as wn,p as Cn,a as Sn,b as Tn,D as Pn,R as Rn,V as Mn,C as On,c as Dn,d as An,O as En,e as In,f as Ln,s as Fn,h as Vn,i as zn,j as Un,k as kn,l as jn,m as Gn,n as Bn,o as Nn,M as qn,q as Hn,r as Wn,G as Zn,t as Qn,u as Yn,w as $n,v as Xn,x as Kn,y as Jn,z as eo,A as to,B as io,E as ro,F as so,H as ao,I as no,J as oo,K as lo,L as co,N as ho,P as uo,Q as po,U as mo,W as fo,X as go,Y as vo,Z as yo,_ as _o,$ as xo}from"../chunks/PiUtils.glsl.js";import{P as bo}from"../chunks/Program.js";import{m as wo,s as Co,b as So,d as To,T as Po,a as Ro,i as Mo,c as Oo,F as Do,R as Ao}from"../chunks/isWebGL2Context.js";import{g as Eo}from"../chunks/glUtil.js";import{n as Io}from"../chunks/InterleavedLayout.js";import"../chunks/mat4f32.js";import{c as Lo,a as Fo,b as Vo,f as zo}from"../chunks/vec3f32.js";import{p as Uo,r as ko,s as jo,a as Go,b as Bo,c as No,d as qo,i as Ho,e as Wo,f as Zo,g as Qo,n as Yo,h as $o,j as Xo,k as Ko,l as Jo,m as el,o as tl,q as il,t as rl,u as sl,v as al,w as nl,x as ol,y as ll,z as cl,A as hl,B as dl,C as ul,D as pl,E as ml}from"../chunks/geometryUtils.js";import{G as fl,D as gl,P as vl,u as yl,d as _l,m as xl,c as bl,v as wl,n as Cl,R as Sl,O as Tl,a as Pl,b as Rl,V as Ml,i as Ol,C as Dl,e as Al,h as El,L as Il}from"../chunks/ColorMaterial.js";import{V as Ll,p as Fl,a as Vl,l as zl,u as Ul,v as kl,r as jl,i as Gl,b as Bl}from"../chunks/Util.js";import{c as Nl,G as ql,a as Hl,P as Wl,b as Zl,d as Ql,e as Yl,B as $l,f as Xl}from"../chunks/Geometry.js";import{v as Kl,V as Jl,B as ec,b as tc,u as ic,g as rc}from"../chunks/VertexArrayObject.js";import{A as sc,H as ac,s as nc,E as oc,z as lc,a as cc,c as hc,b as dc,d as uc,e as pc,f as mc,g as fc,h as gc}from"../chunks/sdfPrimitives.js";import{M as vc,A as yc,F as _c,d as xc,D as bc,T as wc,g as Cc,c as Sc,a as Tc,N as Pc,W as Rc,b as Mc,O as Oc,f as Dc,e as Ac,o as Ec,S as Ic,G as Lc,h as Fc,R as Vc,i as zc,s as Uc,j as kc,k as jc,l as Gc,m as Bc,C as Nc,n as qc,p as Hc}from"../chunks/lineUtils.js";import{O as Wc,g as Zc,e as Qc,a as Yc,r as $c,G as Xc}from"../chunks/Object3D.js";import{I as Kc,s as Jc,T as eh,g as th}from"../chunks/intersectorUtils.js";import{I as ih}from"../chunks/Intersector.js";import{C as rh}from"../chunks/Camera.js";import{F as sh,M as ah,Z as nh,R as oh,P as lh,l as ch}from"../chunks/resources.js";import{D as hh}from"../chunks/DefaultTextureUnits.js";import"../chunks/GLMaterialTexture.js";import{V as dh}from"../chunks/VerticalOffset.glsl.js";import{createLabelFunction as uh}from"../chunks/labelFormatUtils.js";import{e as ph,S as mh,a as fh,n as gh,b as vh,c as yh}from"../chunks/elevationAlignmentUtils.js";import{c as _h,e as xh,p as bh,a as wh,s as Ch}from"../chunks/mat2f64.js";import{R as Sh}from"../chunks/RenderingContext.js";import{R as Th,F as Ph}from"../chunks/PhysicallyBasedRendering.glsl.js";import{S as Rh,R as Mh,C as Oh}from"../chunks/CameraSpace.glsl.js";import{c as Dh,S as Ah}from"../chunks/lineStippleUtils.js";import{D as Eh,P as Ih,E as Lh,a as Fh,N as Vh,V as zh,l as Uh,b as kh,c as jh,H as Gh,d as Bh,M as Nh,e as qh,f as Hh,T as Wh,g as Zh,h as Qh,C as Yh,i as $h,j as Xh,k as Kh,m as Jh}from"../chunks/vec42.js";import{c as ed}from"../chunks/callExpressionWithFeature.js";import{R as td}from"../chunks/RenderGeometry.js";import{T as id}from"../chunks/Texture.js";import{N as rd}from"../chunks/NativeLineMaterial.js";import{o as sd,a as ad}from"../chunks/symbolLayerUtils3D.js";import{f as nd,l as od}from"../chunks/objectResourceUtils.js";import{P as ld}from"../chunks/PropertiesPool.js";import{f as cd,c as hd}from"../chunks/vec4f32.js";import{create as dd}from"../chunks/geometryServiceUtils.js";import ud,{i as pd}from"./3d/support/SceneViewPerformanceInfo.js";import{S as md,c as fd,g as gd,r as vd,T as yd,I as _d,R as xd,w as bd,a as wd,i as Cd,b as Sd,d as Td,e as Pd,f as Rd,h as Md,j as Od,k as Dd,l as Ad,u as Ed,m as Id,n as Ld}from"../chunks/terrainUtils.js";import"./3d/support/LayerPerformanceInfo.js";import"../chunks/config.js";import{w as Fd,V as Vd,a as zd}from"../chunks/VectorTile.js";import"../chunks/DisplayObject.js";import"../chunks/TiledDisplayObject.js";import{g as Ud,s as kd,a as jd}from"../chunks/rasterUtils.js";import{S as Gd,a as Bd,C as Nd}from"../chunks/SymbolRepository.js";import qd from"./layers/LayerView.js";import{f as Hd,c as Wd,t as Zd,I as Qd,a as Yd,s as $d,b as Xd,d as Kd,h as Jd,e as eu}from"../chunks/tileUtils.js";import{c as tu,a as iu}from"../chunks/quatf32.js";import{w as ru,u as su,V as au,E as nu,g as ou,R as lu,S as cu,a as hu}from"../chunks/EdgeProcessingWorker.js";import{h as du}from"../chunks/hitTestSelectUtils.js";function uu(e){return"global"===e?1:2}const pu=()=>import("../chunks/TileLayerView3D.js"),mu=()=>Promise.resolve().then((function(){return $M})),fu={"base-dynamic":()=>import("../chunks/BaseDynamicLayerView3D.js"),"base-elevation":mu,"base-tile":pu,"bing-maps":pu,"building-scene":()=>import("../chunks/BuildingSceneLayerView3D.js"),csv:()=>import("../chunks/CSVLayerView3D.js"),elevation:mu,feature:()=>import("../chunks/FeatureLayerView3D.js"),geojson:()=>import("../chunks/GeoJSONLayerView3D.js"),graphics:()=>import("../chunks/GraphicsLayerView3D.js"),group:()=>import("../chunks/GroupLayerView.js"),imagery:()=>import("../chunks/ImageryLayerView3D.js"),"integrated-mesh":()=>import("../chunks/IntegratedMeshLayerView3D.js"),"map-image":()=>import("../chunks/MapImageLayerView3D.js"),"ogc-feature":()=>import("../chunks/OGCFeatureLayerView3D.js"),"open-street-map":pu,"point-cloud":()=>import("../chunks/PointCloudLayerView3D.js"),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?import("../chunks/SceneLayerView3D.js"):import("../chunks/SceneLayerGraphicsView3D.js"),stream:()=>import("../chunks/StreamLayerView3D.js"),tile:pu,"imagery-tile":()=>import("../chunks/ImageryTileLayerView3D.js"),"vector-tile":()=>import("../chunks/VectorTileLayerView3D.js"),wcs:()=>import("../chunks/ImageryTileLayerView3D.js"),"web-tile":pu,wms:()=>import("../chunks/WMSLayerView3D.js"),wmts:()=>import("../chunks/WMTSLayerView3D.js"),"geo-rss":null,kml:null,"map-notes":null,route:null,unknown:null,unsupported:null};const gu=e=>h(fu[e.type]),vu=e=>{const t=fu[e.type];if(!h(t))throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new ee(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)},yu=d.getLogger("esri.views.3d.state.Constraints");let _u=class extends T{constructor(e){super(e),this.collision=new Cu,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return 2===this.mode?null:this._get("altitude")||null}set altitude(e){2!==this.mode?this._set("altitude",e):yu.warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?Re(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return Re(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return 2===this.mode?this.createDefaultTiltLocal():this.createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=wu)=>(i.min=bu.min,i.max=e,i)}createDefaultTiltLocal(){const e=this.collision.enabled?_t([[4e3,bu.max],[1e4,Me(88)],[6e6,Me(88)]]):()=>bu.max;return(t,i=wu)=>(i.min=bu.min,i.max=e(t),i)}createDefaultTiltGlobal(){const e=this.collision.enabled?_t([[4e3,bu.max],[5e4,Me(88)],[6e6,Me(88)],[2e7,bu.min]]):_t([[3e5,bu.max],[3e6,Me(88)],[6e6,Me(88)],[2e7,bu.min]]);return(t,i=wu)=>(i.min=bu.min,i.max=e(t),i)}};e([S()],_u.prototype,"altitude",null),e([S({readOnly:!0})],_u.prototype,"collision",void 0),e([S()],_u.prototype,"distance",void 0),e([S({readOnly:!0})],_u.prototype,"minimumPoiDistance",void 0),e([S()],_u.prototype,"tilt",void 0),e([S({constructOnly:!0})],_u.prototype,"mode",void 0),_u=e([re("esri.views.3d.state.Constraints")],_u);const xu={min:-2e5,max:4*xe.radius};const bu={min:Me(.5),max:Me(179.5)},wu={min:0,max:0};let Cu=class extends T{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};e([S({type:Boolean})],Cu.prototype,"enabled",void 0),e([S({type:Number})],Cu.prototype,"elevationMargin",void 0),Cu=e([re("esri.views.3d.state.Constraints.CollisionConstraint")],Cu);var Su=_u;let Tu=class extends T{constructor(){super(...arguments),this.min=xu.min,this.max=xu.max}set mode(e){s(d.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"})}get mode(){return s(d.getLogger(this.declaredClass),"esri.views.SceneView.constraints.altitude.mode is deprecated. The altitude constraint no longer applies to local scenes and does not have an automatic mode anymore.",{version:"4.6"}),"manual"}};e([S({type:Number})],Tu.prototype,"min",void 0),e([S({type:Number})],Tu.prototype,"max",void 0),Tu=e([re("esri.views.3d.constraints.AltitudeConstraint")],Tu);var Pu=Tu;let Ru=class extends T{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};e([S({type:Number,value:1e-8})],Ru.prototype,"near",null),e([de("near")],Ru.prototype,"castNear",null),e([S({type:Number,value:1e-8})],Ru.prototype,"far",null),e([de("far")],Ru.prototype,"castFar",null),e([S({type:["auto","manual"]})],Ru.prototype,"mode",void 0),Ru=e([re("esri.views.3d.constraints.ClipDistanceConstraint")],Ru);var Mu=Ru;let Ou=class extends T{set enabled(e){s(d.getLogger(this.declaredClass),"SceneView.constraint.collision.enabled",{replacement:"Map.ground.navigationConstraint",version:"4.8"}),this._set("enabled",e)}};e([S({value:!0})],Ou.prototype,"enabled",null),Ou=e([re("esri.views.3d.constraints.CollisionConstraint")],Ou);var Du=Ou;const Au={min:Oe(bu.min),max:Oe(bu.max)};let Eu=class extends T{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return Re(e,Au.min,Au.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};e([S({type:["auto","manual"]})],Eu.prototype,"mode",void 0),e([S({type:Number,value:Au.max})],Eu.prototype,"max",null),e([de("max")],Eu.prototype,"castMax",null),Eu=e([re("esri.views.3d.constraints.TiltConstraint")],Eu);var Iu=Eu;let Lu=class extends T{constructor(){super(...arguments),this.tilt=new Iu,this.altitude=new Pu,this.clipDistance=new Mu,this.collision=new Du}};e([S({type:Iu})],Lu.prototype,"tilt",void 0),e([S({type:Pu})],Lu.prototype,"altitude",void 0),e([S({type:Mu})],Lu.prototype,"clipDistance",void 0),e([S({type:Du})],Lu.prototype,"collision",void 0),Lu=e([re("esri.views.3d.constraints.Constraints")],Lu);var Fu,Vu=Lu;let zu=Fu=class extends T{set quality(e){-1!==["low","high"].indexOf(e)&&this._set("quality",e)}clone(){return new Fu({quality:this.quality})}};e([S({type:["low","high"],value:"low"})],zu.prototype,"quality",null),zu=Fu=e([re("esri.views.3d.environment.SceneViewAtmosphere")],zu);var Uu,ku=zu;let ju=Uu=class extends(se.EventedMixin(fr)){constructor(e){super(e),this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0},this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1;const t=(new Date).getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}static fromWebsceneLighting(e){return new Uu({...e.cloneConstructProperties()})}get defaultDate(){return new Date(this._get("defaultDate").getTime())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=Gu(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime())));const s=Gu(this.positionTimezoneInfo);if(i!==s&&(Bu.target=this,Bu.timezoneOffset=s,this.emit("timezone-will-change",Bu)),null!=e)return r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new Uu({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}};function Gu({hours:e,minutes:t,seconds:i}){return Math.round(e+t/60+i/3600)}e([S({type:Boolean})],ju.prototype,"cameraTrackingEnabled",void 0),e([S({type:Boolean})],ju.prototype,"ambientOcclusionEnabled",void 0),e([S({type:Boolean})],ju.prototype,"waterReflectionEnabled",void 0),e([S({type:Date})],ju.prototype,"defaultDate",null),e([S({type:Date})],ju.prototype,"date",null),ju=Uu=e([re("esri.views.3d.environment.SceneViewLighting")],ju);const Bu={target:null,timezoneOffset:0};var Nu;let qu=Nu=class extends vr{constructor(e){super(e),this.atmosphere=new ku}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new Nu({...t,lighting:ju.fromWebsceneLighting(t.lighting)})}castLighting(e){return this.convertLighting(e)}updateLighting(e){this.lighting=this.convertLighting(e)}convertLighting(e){return e?e instanceof ju?e:e instanceof fr?this.lighting?this.lighting.cloneWithWebsceneLighting(e):ju.fromWebsceneLighting(e):ie(ju,e):new ju}clone(){return new Nu({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:a(this.background)})}cloneWithWebsceneEnvironment(e){return new Nu({atmosphere:this.atmosphere.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:a(this.background),...e.cloneConstructProperties(),lighting:null!=this.lighting?this.lighting.cloneWithWebsceneLighting(e.lighting):ju.fromWebsceneLighting(e.lighting)})}};e([S({type:ku,json:{read:!1}})],qu.prototype,"atmosphere",void 0),e([S()],qu.prototype,"lighting",void 0),e([de("lighting")],qu.prototype,"castLighting",null),qu=Nu=e([re("esri.views.3d.environment.SceneViewEnvironment")],qu);var Hu=qu;var Wu=Object.freeze({__proto__:null,build:function(e){const t=new xn;return 2===e.geometry?(t.attributes.add("position","vec2"),t.varyings.add("color","vec4"),t.vertex.uniforms.add("lightingMainDirection","vec3").add("cameraPosition","vec3").add("undergroundFadeAlpha","float"),t.vertex.code.add(bn`
      void main(void) {
          float ndotl = dot(normalize(cameraPosition), -lightingMainDirection);
          float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

          color = vec4(vec3(lighting), undergroundFadeAlpha);

          gl_Position = vec4(position.xy, 1.0, 1.0); // on the far plane
      }
  `),t.fragment.code.add(bn`
      void main() {
          gl_FragColor = color;
      }
  `)):(t.include(wn,{linearDepth:!1}),t.attributes.add("position","vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float"),1!==e.geometry&&t.varyings.add("innerFactor","float"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("lightingMainDirection","vec3"),1!==e.geometry&&t.vertex.uniforms.add("silCircleCenter","vec3").add("silCircleV1","vec3").add("silCircleV2","vec3").add("texV","vec2").add("innerScale","float"),1!==e.geometry&&t.vertex.code.add(bn`
			const float TWICEPI = 2.0*3.14159265;
			const float ATMOSPHERE_RIM_SEGMENTS = 128.0;
		`),t.vertex.code.add(bn`
		void main(void) {
			vec3 lightDirection = -lightingMainDirection;
	`),1===e.geometry?t.vertex.code.add(bn`
			vec3 pos = position;
			float ndotl = lightDirection.z;
			vtc = vec2(0.0, position.z+0.05);
			`):t.vertex.code.add(bn`
			innerFactor = clamp(-position.z, 0.0, 1.0);
			float scale = position.y * (1.0 + innerFactor * innerScale);
			float phi = position.x * (TWICEPI / ATMOSPHERE_RIM_SEGMENTS) + 1.0;
			vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
			float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightDirection);

			vtc.x = position.x / ATMOSPHERE_RIM_SEGMENTS;
			vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
		`),t.vertex.code.add(bn`
		falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		gl_Position = transformPosition(proj, view, pos);
		gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
			}
	`),t.fragment.uniforms.add("tex","sampler2D"),1!==e.geometry&&t.fragment.uniforms.add("altitudeFade","float"),t.fragment.code.add(bn`
		void main() {
			vec4 texColor = texture2D(tex, vtc);
	`),1===e.geometry?t.fragment.code.add(bn`
			gl_FragColor = texColor * falloff;
			}
		`):t.fragment.code.add(bn`
			vec4 atmosphereColor = texColor * falloff;
			vec4 innerColor = vec4(texColor.rgb * falloff, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
		}
		`)),t}});class Zu extends Tn{initializeProgram(e){const t=Zu.shader.get(),i=this.configuration,r=t.build({geometry:i.geometry});return new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),Pn)}initializePipeline(){return 1===this.configuration.geometry?wo({blending:Co(770,1,771,771),culling:So,depthTest:{func:515},colorWrite:To}):wo({blending:Co(770,1,771,771),depthTest:{func:515},colorWrite:To})}}Zu.shader=new Rn(Wu,(()=>Promise.resolve().then((function(){return Wu}))));class Qu extends Sn{constructor(){super(...arguments),this.geometry=0}}e([Cn({count:3})],Qu.prototype,"geometry",void 0);var Yu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAAB3RJTUUH4QkLDx4bnqU2+QAAAd1JREFUSMd9lkmWxDAIQ/Xluv+V0wuDjaeuhV+IGQUoJUnNwGfAVvx+lsBCWJIsCaMpQn8nuhgqyyEzbAX1Ih0oHaQZN5X5jul581diaDVbSgAdZv1YLoCLyn/RruCsOdcqR7RS/jXkLMa9UddcDn9O7G8gwprzs6xbQl/Fns3BE90r9veQ/wzNrTM5p1yDF1yokLCosDX5kik1lxeSWxfWsihN/lZcHuPIOuhccZ4Ovt74qQK3USkFzsQx7Ki5NgqoMI1J5ILztr9UrGoGHN2qnSEwOHiD97ByDghs/KIVYp9DfdIIoJPcBkWWnM2O2s5ru3su+8GdPLhM5048r/09UDsZmJ3HRwe5MT/aA9Ul4cG74+lIvICYlZcFY42B6vAzuz/HEVn5VbP3DDgQ7xuAGZtnI76cEkbPczDDgSMDR8iFkfBMTQV728mnsx84GopNWZxQsWJxbI9pD0hmNAzWB8bun41hRk+3mNlRFvbY86mcMEVCWWAX+xJbERJHWVPP3Wkq91uyDtuKDLrYNKLl7bww6rZulo3jnafyePJ64ZZi67aEl0MkbJtTbE1h+2vIzVOU3JwWISrNyNtfi+9xqECIXZk87ODcEMeBhjj41GN1Xf+DzP9c9UmPd39C1BID2rDpAwAAAABJRU5ErkJggg==";const $u=d.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class Xu{constructor(e,t){this.slot=14,this._readyResolver=V(),this._readyController=z(),this.view=e,this._techniqueRepository=t,this._atmosphereTechniqueConfig=new Qu}get canRender(){return null!=this._texture}destroy(){this._readyResolver.reject(),this._texture&&(this._texture.dispose(),this._texture=null),this._readyController&&(this._readyController.abort(),this._readyController=null)}when(){return this._readyResolver.promise}initializeRenderContext(e){const t=e.rctx;this._atmosphereTechniqueConfig.geometry=1,this._atmosphereTechnique=this._techniqueRepository.acquireAndReleaseExisting(Zu,this._atmosphereTechniqueConfig,this._atmosphereTechnique),this._vao=this._createVertexArrayObject(t),this._vaoCount=Kl(this._vao,"geometry"),_n(Yu,{signal:this._readyController.signal}).then((t=>{this._texture=new Po(e.rctx,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},t),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{U(e)||$u.error("Unable to initialize atmosphere: image request failed",e),this._readyResolver.reject()}))}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;const t=e.rctx,i=this._atmosphereTechnique.program;var r,s;return t.bindProgram(i),this._atmosphereTechnique.bindPipelineState(t),t.bindTexture(this._texture,0),i.setUniform1i("tex",0),Mn.bindProjectionMatrix(i,e.camera.projectionMatrix),r=Ku,s=e.camera.viewMatrix,_i(r,s),r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.setUniformMatrix4fv("view",Ku),i.setUniform4f("color",1,1,1,1),e.scenelightingData.setLightDirectionUniform(i),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(4,0,this._vaoCount),!0}_createVertexArrayObject(e){const t=fl.createPolySphereGeometry(1,2,!1),i=t.indices[Ll.POSITION];for(let e=0;e<i.length;e+=3){const t=i[e];i[e]=i[e+2],i[e+2]=t}const r=t.vertexAttributes[Ll.POSITION].data,s=Ju.createBuffer(i.length),a=s.position;for(let e=0;e<i.length;++e){const t=3*i[e];a.set(e,0,r[t]),a.set(e,1,r[t+1]),a.set(e,2,r[t+2])}return new Jl(e,Pn,{geometry:Eo(Ju)},{geometry:ec.createVertex(e,35044,s.buffer)})}}const Ku=jr(),Ju=Io().vec3f("position");function ep(e){const t=1e5;return Math.min(1,Math.max(0,(e-t)/9e5))}var tp=Object.freeze({__proto__:null,build:function(e){const t=new xn;return t.attributes.add("position","vec2"),t.attributes.add("uv0","vec2"),t.varyings.add("worldRay","vec3"),t.varyings.add("vtc","vec2"),e.haze&&t.varyings.add("eyeDir","vec3"),t.vertex.uniforms.add("projectionInverse","mat4"),t.vertex.uniforms.add("viewInverse","mat4"),t.vertex.code.add(bn`
    void main(void) {
      vec3 posViewNear = (projectionInverse * vec4(position, -1, 1)).xyz;

      worldRay = (viewInverse * vec4(posViewNear, 0)).xyz;
      vtc = uv0;

      ${e.haze?bn`eyeDir = posViewNear;`:""}

      gl_Position = vec4(position, 1, 1);
    }
  `),t.fragment.uniforms.add("lightingMainDirection","vec3").add("invWavelength","vec3").add("invWavelengthScaled","vec3").add("radii","vec2").add("atmosphereParameters1","vec4").add("atmosphereParameters2","vec4").add("cameraPosition","vec3").add("nearFar","vec2").add("heightParameters","vec4"),e.haze?t.fragment.uniforms.add("depthTex","sampler2D"):t.fragment.uniforms.add("atmosphereParameters3","vec3").add("innerFadeDistance","float").add("altitudeFade","float"),t.fragment.include(On),t.fragment.code.add(bn`
  // Atmosphere
  const float krESun = 0.075;        // Kr * ESun = 0.005 * 15.0
  const float kmESun = 0.015;        // Km * ESun = 0.005 * 15

  // The inner (planetary) radius
  #define innerRadius radii[0]
  // The outer (atmosphere) radius
  #define outerRadius radii[1]

  // Atmosphere parameters:

  // shellScale:               1.0 / (outerRadius - innerRadius)
  #define shellScale atmosphereParameters1.x

  // shellDepth:               The scale depth (i.e. the altitude at which the atmosphere's average density is found)
  // scaleDepthBlue:           The scale depth (i.e. the altitude at which the atmosphere's average density is found)
  #define shellDepth vec2(atmosphereParameters1.y, atmosphereParameters2.y)

  // scaleOverScaleDepth:      scale / shellDepth
  // scaleOverScaleDepthBlue:  scale / scaleDepthBlue
  #define scaleOverScaleDepth vec2(atmosphereParameters1.z, atmosphereParameters2.z)

  // oneOverScaleDepth:        1.0 / shellDepth
  // oneOverScaleDepthBlue;    1.0 / scaleDepthBlue
  #define oneOverScaleDepth vec2(atmosphereParameters1.w, atmosphereParameters2.w)
  `),e.haze||t.fragment.code.add(bn`
      #define g atmosphereParameters2.x
      #define gSq atmosphereParameters3.x
      #define miePhaseCoefficients atmosphereParameters3.y
      #define lowerAlphaBlendBound atmosphereParameters3.z
    `),t.fragment.code.add(bn`
  // The camera's current height
  #define cameraHeight heightParameters[0]
  // cameraHeight^2
  #define cameraHeightSq heightParameters[1]
  // cameraHeightSq - outerRadiusSq; // C = ||o-c||^2 - r^2
  #define C heightParameters[2]
  // cameraHeightSq - (innerRadiusSq - 63756370000.0); // C = ||o-c||^2 - r^2
  #define CSur heightParameters[3]

  ${e.haze?"// Camera HDR\n        const float exposure = 1.5;\n        const vec3 oneOverGamma = vec3(1.0); //Gamma = 1.0":"const float exposure = 2.0;\n        const vec3 oneOverGamma = vec3(0.454545); // Gamma = 2.2\n        vec3 reinhardTM(vec3 inputColor, float _exposure) {\n          vec3 intermediate = inputColor * _exposure;\n          intermediate /= ( 1.0 + intermediate );\n          return pow(intermediate, oneOverGamma);\n        }\n        "}
    // Loop constants for integral approximation
    const float samples = 5.0;
    const int maxSamples = 5;

    // ToneMapping operators
    vec3 expTM(vec3 inputColor,float _exposure) {
        return pow(1.0 - exp(inputColor * -_exposure), oneOverGamma);
    }

    // Approximation for inner integral based on a radii ratio of 10.25:10
    float scale(float _cos) {
      float x = 1.0 - _cos;
      return exp( -0.00287 + x * ( 0.459 + x * ( 3.83 + x * (-6.80 + x * 5.25 ))));
    }

    void main() {
      // Obtain ray from Camera
      vec3 worldSpaceRay = normalize(worldRay);

      // Compute Atmosphere intersection; i.e. ray/sphere intersection
      float B = 2.0 * dot(cameraPosition, worldSpaceRay); // B = 2(l * (o-c))
      float det = B * B - 4.0 * C; // det = B^2 - 4.0* C

      // idealized sphere intersection to discard early some pixels
      float detSur = B * B - 4.0 * CSur; // det = B^2 - 4.0* C

      // the minimal sample start position:
      // at the camera by default, on the earth radius surface if the camera is underground.
      float minRayStart = 0.0;
  `),e.haze||t.fragment.code.add(bn`
      float surfaceBlend = 0.0;
      vec4 surfaceColor = vec4(0.0);
      if (detSur >= 0.0) {
        float nearSurface = max(0.0, 0.5 *(-B - sqrt(detSur)));
        float farSurface = max(0.0, 0.5 *(-B + sqrt(detSur)));

        if (nearSurface == 0.0) {
          minRayStart = farSurface;
        }

        // Compute lighting at the point where the ray enters the earth surface
        // Lighting computation is copied from the terrain shader.
        vec3 vPos = cameraPosition + worldSpaceRay * nearSurface;
        float lightAngle = dot(-lightingMainDirection, normalize(vPos));
        float brightness = max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)));

        // Make the surface transparent based on altitude
        surfaceColor = vec4(brightness, brightness, brightness, 1.0 - altitudeFade);

        // Fade based on the distance the ray travels below the earth surface
        float relDist = (farSurface - nearSurface) / innerFadeDistance;

        // early exit
        if (relDist > 1.0) {
          gl_FragColor = surfaceColor;
          return;
        }

        surfaceBlend = smoothstep(0.0, 1.0, relDist * relDist);
      }
    `),t.fragment.code.add(bn`
    if (det >= 0.0) {
    ${e.haze?"\n          float depthSample = texture2D(depthTex, vtc).r;\n\n          float zNear = nearFar[0];\n          float zFar = nearFar[1];\n\n          // http://web.archive.org/web/20130416194336/http://olivers.posterous.com/linear-depth-in-glsl-for-real\n          float zNorm = 2.0 * depthSample - 1.0;\n          float linDepth = 2.0 * zNear * zFar /\n            (zFar + zNear - zNorm * (zFar - zNear));\n\n          float rayEnd;\n          float altitudeAlpha = 1.0;\n\n          // find intersections with ground, but only between the near and far\n          // clipping planes.\n          if (depthSample < 1.0 && depthSample > 0.0) {\n            vec3 cameraSpaceRay = normalize(eyeDir);\n            cameraSpaceRay /= cameraSpaceRay.z;\n            cameraSpaceRay *= linDepth;\n\n            float cameraSpaceRayLength = length(cameraSpaceRay);\n\n            vec3 world = cameraPosition + worldSpaceRay * cameraSpaceRayLength;\n            float worldRadiusSq = dot(world, world);\n\n            // Handle tall structures:\n            // https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/5450\n            float transitionStart = innerRadius + 20000.0;\n            float transitionHeight = 25000.0;\n            float transitionEnd = transitionStart + transitionHeight;\n\n            float edge0 = transitionStart * transitionStart;\n            float edge1 = transitionEnd * transitionEnd;\n\n            altitudeAlpha = 1.0 - clamp((worldRadiusSq - edge0) / (edge1 - edge0), 0.0, 1.0);\n            rayEnd = cameraSpaceRayLength;\n\n            if (altitudeAlpha > 0.0 && detSur > 0.0) {\n              float nearSurface = 0.5 * ( -B - sqrt(detSur) );\n              float interp = clamp(((cameraHeight - innerRadius) - 2000000.0) / 6000000.0, 0.0, 1.0);\n              rayEnd = mix(cameraSpaceRayLength, nearSurface, interp);\n            }\n          }":""}
    float rayStart = 0.5 *(-B - sqrt(det)); //near intersection with atmosphere
    ${e.haze?"float near = abs(rayStart);\n        float far = abs(rayEnd);":"float rayEnd = 0.5 *(-B + sqrt(det)); //far intersection with atmosphere"}

    float scatterDistance; // calculate its scattering offset
    // Calculate the ray's starting position
    if (rayStart < minRayStart)
    { // ray starts from camera or inner radius sphere to far
      rayStart = minRayStart;
      ${e.haze?"":"// clamp to value at inner radius altitude\n          scatterDistance = shellScale * min(0.0, innerRadius - cameraHeight);"}
    }
    ${e.haze?"":"else { // outside atmosphere\n          scatterDistance = -1.0;\n        }"}
    // Initialize the scattering loop variables
    vec3 start = cameraPosition + worldSpaceRay * rayStart;
  `),e.haze&&t.fragment.code.add(bn`
      vec3 end = cameraPosition + worldSpaceRay * rayEnd;

      float endLength = length(end);
      //altitudeStart, altitudeEnd
      vec2 altitudeInterval = vec2(length(start) - innerRadius, endLength - innerRadius);

      // for camera positions below altitude 0, invert the altitudes, to achieve
      // a similar haze as above ground. Note that there is a small but visible change
      // when the camera passes altitude 0.
      if (altitudeInterval.x < 0.0) {
        altitudeInterval = -altitudeInterval;
      }

      // computed for the original end point to get consistent light angles after possible inversions
      float lightAngle = dot(-lightingMainDirection, end) / endLength;

      if (near > far)
      {
        if (altitudeInterval.x < altitudeInterval.y)
        {
          // Switch positive slopes for flipped rays
          end = cameraPosition + worldSpaceRay * rayStart;
          start = cameraPosition + worldSpaceRay * rayEnd;
          worldSpaceRay *= -1.0;
          float tmp = altitudeInterval.x;
          altitudeInterval.x = altitudeInterval.y;
          altitudeInterval.y = tmp;
        }
        else if (altitudeInterval.x == altitudeInterval.y)
        { // create minuscule fake slope for integration if the slope is zero
          altitudeInterval.x += 1.0; //BUGFIX, if the height of camera and ground is equal the equation breaks, add fake meter to camera height to get
          // slope for the camera function
        }
      }

      // Calculate its scattering offset
      // Assumes camera constrains of WSV 3.8
      if (altitudeInterval.x > outerRadius - innerRadius)
      { // outside atmosphere
        scatterDistance = innerRadius - outerRadius;
      } else
      {
        scatterDistance = altitudeInterval.y - altitudeInterval.x;
      }
    `),t.fragment.code.add(bn`
    vec2 opticalStartDepth = exp(scatterDistance * oneOverScaleDepth);

    float rayLength = rayEnd - rayStart;
    float sampleLength = rayLength / samples;
    float scaledLength = sampleLength * shellScale;
    vec3 sampleRay = worldSpaceRay * sampleLength;
    vec3 samplePoint = start + sampleRay * 0.5;
  `),e.haze?t.fragment.code.add(bn`
      float cameraAngle = dot(-worldSpaceRay, end) / length(end);
      float scaleCameraAngle = scale(cameraAngle);
      vec2 cameraOffset = scaleCameraAngle * opticalStartDepth;

      float scaledValues = scale(lightAngle) + scaleCameraAngle;
      vec2 scaledValuesDepth = scaledValues * shellDepth;
    `):t.fragment.code.add(bn`
      float cameraAngle = dot(worldSpaceRay, start / length(start));
      float angleMultiplier = cameraAngle > 0.0 ? cameraAngle : 0.0;

      float scaleCameraAngle = scale(cameraAngle);
      vec2 cameraOffset = scaleCameraAngle * opticalStartDepth * shellDepth;
    `),t.fragment.code.add(bn`
    // Loop variables
    vec3 frontColor = vec3(0.0);
    vec3 frontColorBlue = vec3(0.0);
    vec3 attenuate = vec3(0.0);
    vec3 attenuateBlue = vec3(0.0);

    // Now loop through the sample rays
    for(int i=0; i<maxSamples; i++) {
      float height = length(samplePoint);
      float altitude = abs(height - innerRadius);

      vec2 depth = exp(-altitude * scaleOverScaleDepth);
  `),e.haze?t.fragment.code.add(bn`
      vec2 scatter = depth * scaledValuesDepth - cameraOffset;
    `):t.fragment.code.add(bn`
      float lightAngle = dot(-lightingMainDirection, samplePoint) / height;
      float cameraAngle = dot(worldSpaceRay, samplePoint) / height;
      float tmpScaledValues = scale(lightAngle) - scale(cameraAngle);
      vec2 scatter = cameraOffset + tmpScaledValues * depth * shellDepth;
    `),t.fragment.code.add(bn`
      attenuate = exp(-scatter.x * invWavelengthScaled);
      attenuateBlue = exp(-scatter.y * invWavelengthScaled);

      frontColor += attenuate * depth.x;
      frontColorBlue += attenuateBlue * depth.y;

      samplePoint += sampleRay;
    }

    // Phase computation
    // clamp to avoid numerical instability at fCos == -1.0 (and close values) to display fake sun
    float LdotR = clamp(dot(-lightingMainDirection, -worldSpaceRay ),-0.9999999,1.0);
    float LdotRSq = LdotR * LdotR + 1.0;
  `),e.haze?t.fragment.code.add(bn`
      // Finally, scale the Rayleigh colors and set up the varying variables for the pixel shader
      vec3 colorCoefficients = (scaledLength * 0.75 * LdotRSq) * (krESun * invWavelength + kmESun );

      // Scaled Length is only applied afterwards to save multiplications
      vec3 color = colorCoefficients * frontColor;
      vec3 colorBlue = colorCoefficients * frontColorBlue;
    `):t.fragment.code.add(bn`
      vec3 rayleighCoefficients = (scaledLength * 0.75 * LdotRSq * krESun) * invWavelength;
      float mieCoefficients = scaledLength * kmESun * miePhaseCoefficients * LdotRSq / pow(1.0 + gSq - 2.0 * g * LdotR, 1.5);

      // Calculate the attenuation factor for the ground
      vec3 color = rayleighCoefficients * frontColor + mieCoefficients * frontColor;
      vec3 colorBlue = rayleighCoefficients * frontColorBlue + mieCoefficients * frontColorBlue;
    `),t.fragment.code.add(bn`
    // HDR to LDR conversion
    vec3 ldrBlue = expTM(colorBlue, 2.0 * exposure);
    vec3 ldrRed = expTM(color, exposure);

    // mix reddish and blueish atmosphere
    vec3 LDR = mix(ldrBlue, ldrRed, 0.2);
  `),e.haze?t.fragment.code.add(bn`
      LDR *= (1.0 - cameraAngle);
      vec3 hsv = rgb2hsv(LDR);
      hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0); // boost haze saturation by 50%
      LDR = hsv2rgb(hsv);
      vec3 finalColor = LDR;
      // when rendering we specify the blend functions such that
      // newDestColor = oldDestColor*(1.0-finalColor) + finalColor
    `):t.fragment.code.add(bn`
      // reinhard tonemapper for looking upwards
      vec3 ldrReinhard = reinhardTM(color, exposure);
      LDR += angleMultiplier * ldrReinhard;

      // height dependent parameter to smooth out reddish atmosphere
      float side = (rayEnd + rayStart) * 0.5;
      float atmoHeight = sqrt(cameraHeightSq - side * side);
      float h2 = clamp(1.0 - ( atmoHeight - lowerAlphaBlendBound ) / ( outerRadius - lowerAlphaBlendBound ), 0.0, 1.0);

      vec3 finalColor = LDR * h2;
      vec3 hsv = rgb2hsv(finalColor);
      hsv.y = clamp(hsv.y * 1.5, 0.0, 1.0); // boost sky saturation by 50%
      finalColor = hsv2rgb(hsv);
    `),t.fragment.code.add(bn`
    ${e.haze?"gl_FragColor = vec4(finalColor, 1.0) * altitudeAlpha;":"float atmosStrength = clamp((length(ldrRed) - 0.05) * 1.05, 0.0, 1.0);\n          gl_FragColor = vec4(finalColor, atmosStrength * clamp(1.0 - ( atmoHeight - innerRadius ) / (outerRadius - innerRadius), 0.0, 1.0));\n          if (surfaceBlend > 0.0) {\n            gl_FragColor = mix(gl_FragColor, surfaceColor, surfaceBlend);\n          }"}
      } else { // Outside Atmosphere
        gl_FragColor = vec4(0.0);
      }
    }
  `),t}});class ip extends Tn{initializeProgram(e){const t=ip.shader.get(),i=this.configuration,r=t.build({haze:i.haze});return new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),Pn)}initializePipeline(){return this.configuration.haze?wo({blending:Co(1,0,769,1),colorWrite:To}):wo({blending:Co(770,1,771,771),depthTest:{func:515},colorWrite:To})}}ip.shader=new Rn(tp,(()=>Promise.resolve().then((function(){return tp}))));class rp extends Sn{constructor(){super(...arguments),this.haze=!1}}e([Cn()],rp.prototype,"haze",void 0);class sp{constructor(e,t){this._view=e,this.canRender=!0,this._skyslot=14,this._hazeSlot=15,this._renderData={texDepth:cn(),cameraPosition:je(),projectionInverse:jr(),viewInverse:jr(),heightParameters:Tr(),atmosphereParameters1:Tr(),atmosphereParameters2:Tr(),atmosphereParameters3:je(),invWavelength:op,invWavelengthScaled:lp,radii:cn(),scale:0,scaleDepth:cp,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:hp,oneOverScaleDepthBlue:up,scaleOverScaleDepthBlue:0,g:pp,g2:pp*pp,miePhaseCoefficients:mp,nearFar:cn(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0},this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=xe.radius,this._updateRadius(xe.radius),this._techniqueRepository=t,this._atmosphereTechniqueConfig=new rp}destroy(){this._handles&&(this._handles.destroy(),this._handles=null),this._vao&&(this._vao.dispose(),this._vao=null)}when(){return k()}initializeRenderContext(e){const t=e.rctx;this._handles=new $t,this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"}),this._handles.add(ci(this._view,"basemapTerrain","elevation-change",(e=>this._updateElevation(e)),(()=>this._updateElevation()))),this._handles.add(ci(this._view,"basemapTerrain","elevation-bounds-change",(()=>this._updateVisibleElevationBounds()),(()=>this._updateVisibleElevationBounds()))),this._atmosphereTechniqueConfig.haze=!1,this._atmosphereTechnique=this._techniqueRepository.acquireAndReleaseExisting(ip,this._atmosphereTechniqueConfig,this._atmosphereTechnique),this._atmosphereTechniqueConfig.haze=!0,this._atmosphereHazeTechnique=this._techniqueRepository.acquireAndReleaseExisting(ip,this._atmosphereTechniqueConfig,this._atmosphereHazeTechnique),this._vao=this._createVertexArrayObject(t)}uninitializeRenderContext(){this.destroy()}render(e){return(e.slot===this._hazeSlot||e.slot===this._skyslot)&&0===e.pass&&(this._update(e.camera),e.slot===this._skyslot&&this._renderSky(e),e.slot===this._hazeSlot&&this._renderHaze(e),!0)}_renderSky(e){const t=e.rctx,i=this._atmosphereTechnique.program;t.bindProgram(i),this._atmosphereTechnique.bindPipelineState(t),i.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3),this._renderCommon(i,e)}_renderHaze(e){const t=e.rctx,i=e.offscreenRenderingHelper,r=this._atmosphereHazeTechnique.program;t.bindProgram(r),this._atmosphereHazeTechnique.bindPipelineState(t),i.renderDepthDetached((()=>{const s=i.depthTexture;t.bindTexture(s,0),r.setUniform1i("depthTex",0),this._renderCommon(r,e)}))}_renderCommon(e,t){const i=t.rctx;e.setUniform3fv("invWavelength",this._renderData.invWavelength),e.setUniform3fv("invWavelengthScaled",this._renderData.invWavelengthScaled),t.scenelightingData.setLightDirectionUniform(e),e.setUniform4fv("heightParameters",this._renderData.heightParameters),e.setUniform3fv("cameraPosition",this._renderData.cameraPosition),e.setUniformMatrix4fv("projectionInverse",this._renderData.projectionInverse),e.setUniformMatrix4fv("viewInverse",this._renderData.viewInverse),e.setUniform2fv("nearFar",this._renderData.nearFar),e.setUniform2fv("radii",this._renderData.radii),e.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1),e.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2),e.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance),e.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(5,0,4)}_createVertexArrayObject(e){const t=fp.createBuffer(4);return t.position.setVec(0,[-1,-1]),t.position.setVec(1,[1,-1]),t.position.setVec(2,[-1,1]),t.position.setVec(3,[1,1]),t.uv0.setVec(0,[0,0]),t.uv0.setVec(1,[1,0]),t.uv0.setVec(2,[0,1]),t.uv0.setVec(3,[1,1]),new Jl(e,Pn,{geometry:Eo(fp)},{geometry:ec.createVertex(e,35044,t.buffer)})}_adjustRadiusForTesselation(e){const t=Math.PI/Math.pow(2,4)/16;return e*Math.cos(t)}_updateElevation(e){const t=e?e.tile:this._view.basemapTerrain.rootTiles[0];if(0!==t.lij[0])return;const i=this._adjustRadiusForTesselation(xe.radius+t.elevationBounds[0]);i!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=i,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(xe.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||e<this._lowerBoundEarthRadius)&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e;const t=e,i=t/10*10.25,r=1/(i-t),s=r/cp,a=r/hp,n=.3*(i-t)+t,o=this._renderData;bs(o.atmosphereParameters1,r,cp,s,dp),bs(o.atmosphereParameters2,pp,hp,a,up),Ye(o.atmosphereParameters3,pp*pp,mp,n),ls(o.radii,t,i),o.scale=r,o.lowerAlphaBlendBound=n,o.scaleOverScaleDepth=s,o.scaleOverScaleDepthBlue=a;o.innerFadeDistance=2*Math.sqrt(1e4*(2*t-1e4))}_update(e){e&&(this._renderData.cameraHeight=$e(e.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=Pr(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),Xe(this._renderData.cameraPosition,e.eye),xi(this._renderData.projectionInverse,e.projectionMatrix),xi(this._renderData.viewInverse,e.viewMatrix),ls(this._renderData.nearFar,e.near,e.far),this._renderData.altitudeFade=ep(this._renderData.cameraHeight-this._lowerBoundEarthRadius))}static isSupported(e){return e.rctx.capabilities.depthTexture}}const ap=.02*Math.PI,np=.004*Math.PI,op=ke(1/Math.pow(.65,4),1/Math.pow(.57,4),1/Math.pow(.475,4)),lp=Ue(op);Ze(lp,lp,ap),Qe(lp,lp,ke(np,np,np));const cp=.25,hp=.05,dp=1/cp,up=1/hp,pp=-.99999,mp=(1-pp*pp)/(2+pp*pp)*1.5,fp=Io().vec2f("position").vec2f("uv0");const gp=d.getLogger("esri.views.3d.environment.SimpleAtmosphere"),vp=_t([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class yp{constructor(e,t){this.slot=14,this._renderData={texV:cn(),silCircleCenter:je(),silCircleV1:je(),silCircleV2:je(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this._readyResolver=V(),this._readyController=z(),this.texV1=1,this.isOnMars=pe(e.spatialReference);const i=Kt(e.spatialReference);this.planetRadius=i.radius,this.outerRimWidth=i.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+-1e4)/this.planetRadius,this.middleRimFactor=(this.planetRadius+0)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=0/this.outerRimWidth,this.texVScale=this.texV1-this.texV0,this._techniqueRepository=t,this._atmosphereTechniqueConfig=new Qu,this.view=e}get canRender(){return null!=this._texture}when(){return this._readyResolver.promise}initializeRenderContext(e){const t=e.rctx;this._cameraChangeHandle=hi(this.view,"state.camera",(()=>e.requestRender()),!0),this._atmosphereTechniqueConfig.geometry=0,this._atmosphereConeTechnique=this._techniqueRepository.acquireAndReleaseExisting(Zu,this._atmosphereTechniqueConfig,this._atmosphereConeTechnique),this._atmosphereTechniqueConfig.geometry=2,this._atmosphereUndergroundTechnique=this._techniqueRepository.acquireAndReleaseExisting(Zu,this._atmosphereTechniqueConfig,this._atmosphereUndergroundTechnique),this._vao=this._createRibbon(t),this._vaoCount=Kl(this._vao,"geometry"),this._fadeVao=Nl(t),this._fadeVaoCount=Kl(this._fadeVao,"geometry"),_n(this.isOnMars?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==":Yu,{signal:this._readyController.signal}).then((i=>{this._texture=new Po(t,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},i),e.requestRender(),this._readyController=null,this._readyResolver.resolve()})).catch((e=>{U(e)||gp.error("Unable to initialize simple atmosphere: image request failed",e),this._readyResolver.reject()}))}uninitializeRenderContext(){this.destroy()}destroy(){this._readyResolver.reject(),this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null),this._vao&&(this._vao.dispose(),this._vao=null),this._readyController&&(this._readyController.abort(),this._readyController=null)}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;this._update(e.camera);const t=e.rctx;if(this._atmosphereConeTechnique.bindPipelineState(t),this._renderData.undergroundFadeAlpha<1){const i=this._atmosphereConeTechnique.program;t.bindProgram(i),i.setUniformMatrix4fv("proj",e.camera.projectionMatrix),i.setUniformMatrix4fv("view",e.camera.viewMatrix),i.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),i.setUniform3fv("silCircleV1",this._renderData.silCircleV1),i.setUniform3fv("silCircleV2",this._renderData.silCircleV2),i.setUniform2fv("texV",this._renderData.texV),t.bindTexture(this._texture,0),i.setUniform1i("tex",0),e.scenelightingData.setLightDirectionUniform(i),i.setUniform1f("altitudeFade",this._renderData.altitudeFade),i.setUniform1f("innerScale",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const i=this._atmosphereUndergroundTechnique.program;t.bindProgram(i),i.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),e.scenelightingData.setLightDirectionUniform(i),i.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount)}return!0}_update(e){const t=je(),i=this.planetRadius,r=$e(e.eye),s=r-i;if(s<0){const e=Math.min(-s/5e3,1);this._renderData.undergroundFadeAlpha=e}else this._renderData.undergroundFadeAlpha=0;const a=Math.max(50,s),n=i+-1e4;this._renderData.innerScale=function(e,t,i){const r=Math.sqrt(e*e-t*t),s=Math.sqrt(e*e-i*i);return e*e/(r*s+t*i)}(i+a,i,n)-1,this._renderData.altitudeFade=ep(s),Ze(t,e.eye,(i+50)/r),_p(t,e.center,e.up,i,this._renderData);const o=this._computeScreenRimWidth(e,t,e.up,this._renderData),l=1-511/512,c=vp(s);let h=this.texV0+l*this.texVScale,d=this.texV0+o*c*this.texVScale;if(s>50){_p(e.eye,e.center,e.up,i,this._renderData);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._renderData),r=Re((t-1.5)/(o-1.5),0,1);h=this.texV0+r*l*this.texVScale,d=this.texV0+De(this.texV1,o*c,r)*this.texVScale}ls(this._renderData.texV,h,d)}_createRibbon(e){const t=new Float32Array(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<128;e++){const r=9*e+3;t[r+0]=e,t[r+1]=this.innerRimFactor,t[r+2]=-1,t[r+3]=e,t[r+4]=this.middleRimFactor,t[r+5]=0,t[r+6]=e,t[r+7]=this.outerRimFactor,t[r+8]=1;const s=3*e+1,a=127===e?1:s+3,n=15*e;i[n+0]=s,i[n+1]=s+1,i[n+2]=a+1,i[n+3]=a+1,i[n+4]=a,i[n+5]=s,i[n+6]=s+1,i[n+7]=s+2,i[n+8]=a+2,i[n+9]=a+2,i[n+10]=a+1,i[n+11]=s+1,i[n+12]=s,i[n+13]=a,i[n+14]=0}const r=Cp.createBuffer(i.length),s=r.position;for(let e=0;e<i.length;++e){const r=3*i[e];s.set(e,0,t[r]),s.set(e,1,t[r+1]),s.set(e,2,t[r+2])}return new Jl(e,Pn,{geometry:Eo(Cp)},{geometry:ec.createVertex(e,35044,r.buffer)})}_computeScreenRimWidth(e,t,i,r){return Qe(bp,r.silCircleCenter,r.silCircleV2),Ze(wp,bp,this.outerRimFactor),bi(xp,t,bp,i),Fl(bp,xp,e.projectionMatrix,e.viewport),Fl(wp,xp,e.projectionMatrix,e.viewport),Ke(bp,wp)/e.height}}function _p(e,t,i,r,s){const a=$e(e),n=r*Math.sqrt(a*a-r*r)/a,o=Math.sqrt(r*r-n*n),l=s.silCircleV1,c=s.silCircleV2;return Ze(s.silCircleCenter,e,o/a),Je(l,e,t),et(l)<1&&Je(l,e,i),Ze(l,l,n/$e(l)),Je(c,l,e),Ze(c,c,n/$e(c)),n}const xp=jr(),bp=je(),wp=je();const Cp=Io().vec3f("position");var Sp=Object.freeze({__proto__:null,build:function(){const e=new xn;return e.attributes.add("position","vec3"),e.attributes.add("color","vec4"),e.attributes.add("size","float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add("transform","mat4").add("viewport","vec4").add("pixelRatio","float"),e.include(sc),e.vertex.code.add(bn`
    void main(void) {
      vec4 posProj = transform * vec4(position, 0);
      gl_Position = alignToPixelCenter(posProj, viewport.zw);
      vcolor = color / 1.2;
      vsize = size * 5.0 * pixelRatio;
      gl_PointSize = vsize;
    }
  `),e.fragment.code.add(bn`
    void main() {
      float cap = 0.7;
      float scale = 1.0 / cap;
      float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
      float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
      float intensity = alpha * alpha * alpha;
      if (vsize < 3.0) {
        intensity *= 0.5;
      }
      gl_FragColor = vec4(vcolor.xyz, intensity);
    }
  `),e}});class Tp extends Tn{initializeProgram(e){const t=Tp.shader.get().build();return new bo(e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),Pn)}initializePipeline(){return wo({blending:Co(770,1,771,771),depthTest:{func:515},colorWrite:To})}bindPass(e,{camera:t,modelMatrix:i}){const r=this.makeInfiniteProjectionMatrix(t.projectionMatrix,t.near,Pp);wi(r,r,t.viewMatrix),wi(r,r,i),this.program.setUniformMatrix4fv("transform",r),this.program.setUniform4fv("viewport",t.fullViewport),this.program.setUniform1f("pixelRatio",t.pixelRatio)}makeInfiniteProjectionMatrix(e,t,i){const r=24e-8;return _i(i,e),i[10]=r-1,i[11]=-1,i[14]=(r-2)*t,i}}Tp.shader=new Rn(Sp,(()=>Promise.resolve().then((function(){return Sp}))));const Pp=jr(),Rp=d.getLogger("esri.views.3d.environment.Stars");let Mp=class extends T{constructor(e){super(e),this.slot=14,this._loadDataTask=null,this._resources=null,this._modelMatrix=jr(),this._updatingTracking=new yr,this._requestRender=()=>{}}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return h(this._loadDataTask)&&!this._loadDataTask.finished}get canRender(){return!this.loading}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){h(this._loadDataTask)&&(this._loadDataTask.abort(),this._loadDataTask=null),this._updatingTracking.destroy(),h(this._resources)&&(this._resources.vao.dispose(),this._resources.technique.dispose(),this._resources=null),this._requestRender=null}initializeRenderContext(e){this._requestRender=e.requestRender}uninitializeRenderContext(){this.destroy()}render(e){if(e.slot!==this.slot||0!==e.pass)return!1;if(this._ensureResources(e),u(this._resources))return!0;const{technique:t,vao:i,num:r}=this._resources,s=e.rctx,a=t.program;return s.bindProgram(a),t.bindPass(s,{camera:e.camera,modelMatrix:this._modelMatrix}),t.bindPipelineState(s),s.bindVAO(i),a.assertCompatibleVertexAttributeLocations(i),s.drawArrays(0,0,r),!0}_ensureResources(e){if(h(this._resources)||u(Lp))return;const t=e.rctx,i=new Tp({rctx:t,viewingMode:this.view.state.mode},null),r=Lp.byteLength/Ep,s=new Float32Array(Lp,0,2*r),a=new Uint8Array(Lp,2*r*4,r),n=this._createVertexArrayObject(e.rctx,s,a,r);this._resources={vao:n,technique:i,num:r},this._updatingTracking.add(this.view,"environment.lighting.date",(e=>this._update(e)),2)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=this._modelMatrix;_i(r,Ap),Ci(r,r,-i*Math.PI),wi(r,Dp,r),Ci(r,r,-t*Math.PI),this._requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const s=Ip.createBuffer(r),a=s.position,n=s.color,o=s.size;for(let e=0;e<r;e++){const r=t[2*e+0],s=t[2*e+1];a.set(e,0,-Math.cos(r)*Math.sin(s)),a.set(e,1,-Math.sin(r)*Math.sin(s)),a.set(e,2,-Math.cos(s));const l=this._unpackUint8Attributes(i[e]),c=this._hexToRGB(Op[l[1]]);n.set(e,0,255*c[0]),n.set(e,1,255*c[1]),n.set(e,2,255*c[2]),n.set(e,3,255),o.set(e,l[0])}return new Jl(e,Pn,{geometry:Eo(Ip)},{geometry:ec.createVertex(e,35044,s.buffer)})}_createLoadDataTask(){if(h(Lp))return null;const e=j((async e=>{const{data:t}=await ge("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),Lp=t}));return e.promise.catch((e=>{U(e)||Rp.error(e)})).then((()=>{this.destroyed||(this._requestRender(),this.notifyChange("updating"))})),e}_verifyStarData(e){if(!e)throw new ee("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/Ep;if(t%1!=0||t>5e4||t<5e3)throw new ee("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};e([S({constructOnly:!0})],Mp.prototype,"view",void 0),e([S({readOnly:!0,dependsOn:["_updatingTracking.updating"]})],Mp.prototype,"updating",null),e([S()],Mp.prototype,"_loadDataTask",void 0),e([S()],Mp.prototype,"_updatingTracking",void 0),Mp=e([re("esri.views.3d.environment.Stars")],Mp);const Op=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],Dp=Gr(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),Ap=Gr(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Ep=9,Ip=Io().vec3f("position").vec4u8("color").f32("size");let Lp=null;const Fp=[14,15];let Vp=class extends T{constructor(){super(...arguments),this._handles=new $t,this._initContext=null,this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null}get canRender(){return!(!this.view.basemapTerrain||!this.view.basemapTerrain.renderer.canRender)||"global"!==this.view.viewingMode}get updating(){return h(this._pendingAtmosphere)||h(this._stars)&&this._stars.updating}initialize(){this.view._stage.addRenderPlugin(Fp,this)}destroy(){this._pendingAtmosphere=p(this._pendingAtmosphere),this._atmosphere=p(this._atmosphere),this._stars=p(this._stars),this._handles=p(this._handles),this.view&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))}initializeRenderContext(e){this._initContext=e,this._techniqueRepository=this._initContext.shaderTechniqueRep,this.setup()}setup(){this._handles.add(di(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0)),this._handles.add([hi(this.view,["viewingMode","environment.atmosphereEnabled","environment.atmosphere.quality"],(()=>this._updateAtmosphere()),!0),hi(this.view,"environment.starsEnabled",(()=>this._updateStars()),!0)])}uninitializeRenderContext(){h(this._stars)&&(this._stars.uninitializeRenderContext(),this._stars.destroy(),this._stars=null),h(this._atmosphere)&&(this._atmosphere.uninitializeRenderContext(),this._atmosphere.destroy(),this._atmosphere=null)}render(e){let t=!0;return h(this._stars)&&this._stars.canRender&&(t=this._stars.render(e)&&t),h(this._atmosphere)&&this._atmosphere.canRender&&(t=this._atmosphere.render(e)&&t),t}_setNeedsRender(){this._initContext&&this._initContext.requestRender()}_updateStars(){var e,t,i;const r=null!=(e=null==(t=this.view)||null==(i=t.environment)?void 0:i.starsEnabled)&&e;r&&u(this._stars)?(this._stars=new Mp({view:this.view}),this._stars.initializeRenderContext(this._initContext),this._setNeedsRender()):!r&&h(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())}_updateAtmosphere(){const e=this._getAtmosphereType();if(this.atmosphereType===e)return;this.atmosphereType=e,h(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return h(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new t(this.view,this._techniqueRepository);i.initializeRenderContext(this._initContext),u(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then((()=>{h(this._atmosphere)&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)}))}_getAtmosphereClass(){const e=this._getAtmosphereType();if(this.atmosphereClassFromType)return this.atmosphereClassFromType(e);switch(e){case"none":return null;case"realistic":return sp;case"panoramic":return Xu;case"simple":return yp;default:return}}_getAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!e||null==t||me(this.view.spatialReference)?"none":"local"===i?"panoramic":"high"===t&&sp.isSupported(this._initContext)&&!pe(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){const e=this.view.basemapTerrain;e&&(e.velvetOverground=null!=this._atmosphere&&"simple"===this.atmosphereType)}get test(){return{atmosphere:this._atmosphere}}};e([S({constructOnly:!0})],Vp.prototype,"view",void 0),e([S({constructOnly:!0})],Vp.prototype,"atmosphereClassFromType",void 0),e([S({dependsOn:["_pendingAtmosphere","_stars.updating"]})],Vp.prototype,"updating",null),e([S()],Vp.prototype,"_pendingAtmosphere",void 0),e([S()],Vp.prototype,"_stars",void 0),Vp=e([re("esri.views.3d.environment.EnvironmentRenderer")],Vp);var zp=Vp;function Up(e,t,i){return function(e,t,i,r,s){const a=Me(i),n=Me(s),o=Me(t),l=Me(r),c=a-n,h=o-l,d=Math.sin(c/2),u=Math.sin(h/2),p=2*Ae(Math.sqrt(d*d+Math.cos(a)*Math.cos(n)*u*u))*e;return Math.round(1e4*p)/1e4}(e,t.longitude,t.latitude,i.longitude,i.latitude)}function kp(e,t){t||(t={hours:0,minutes:0,seconds:0}),t.hours=function(e,t){let i=e/15;return t||(i=Math.round(i)),i}(e[0],!0);const i=t.hours%1;t.hours-=i,t.minutes=60*i;const r=t.minutes%1;return t.minutes-=r,t.seconds=Math.round(60*r),t}var jp=_r((function(e){!function(t){var i=function(){var e=Math.PI,t=Math.sin,i=Math.cos,r=Math.tan,s=Math.asin,a=Math.atan2,n=Math.acos,o=e/180,l=864e5,c=2440588,h=2451545,d={dec:0,ra:0};function u(e){return e.valueOf()/l-.5+c}function p(e){return new Date((e+.5-c)*l)}function m(e){return u(e)-h}var f=23.4397*o;function g(e,s){return a(t(e)*i(f)-r(s)*t(f),i(e))}function v(e,r){return s(t(r)*i(f)+i(r)*t(f)*t(e))}function y(e,s,n){return a(t(e),i(e)*t(s)-r(n)*i(s))}function _(e,r,a){return s(t(r)*t(a)+i(r)*i(a)*i(e))}function x(e,t){return o*(280.16+360.9856235*e)-t}function b(e){return o*(357.5291+.98560028*e)}function w(e){return o*(1.9148*t(e)+.02*t(2*e)+3e-4*t(3*e))}function C(t,i){return t+i+102.9372*o+e}function S(e,t){var i=b(e),r=C(i,w(i));return t||(t={dec:0,ra:0}),t.dec=v(r,0),t.ra=g(r,0),t}var T={POLAR_EXCEPTION:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2}};T.getPosition=function(e,t,i,r){var s=o*-i,a=o*t,n=m(e),l=S(n,d),c=x(n,s)-l.ra;return r||(r={azimuth:0,altitude:0}),r.azimuth=y(c,a,l.dec),r.altitude=_(c,a,l.dec),r};var P=[[-.83,"sunrise","sunset"]];T.addTime=function(e,t,i){P.push([e,t,i])};var R=9e-4;function M(t,i){return Math.round(t-R-i/(2*e))}function O(t,i,r){return R+(t+i)/(2*e)+r}function D(e,i,r){return h+e+.0053*t(i)-.0069*t(2*r)}function A(e,r,s){return n((t(e)-t(r)*t(s))/(i(r)*i(s)))}function E(e){var r=o*(134.963+13.064993*e),s=o*(93.272+13.22935*e),a=o*(218.316+13.176396*e)+6.289*o*t(r),n=5.128*o*t(s),l=385001-20905*i(r);return{ra:g(a,n),dec:v(a,n),dist:l}}return T.getTimes=function(e,r,s){var a=o*-s,n=o*r,l=M(m(e),a),c=O(0,a,l),h=b(c),d=w(h),u=C(h,d),f=v(u,0),g=D(c,h,u);function y(e){return D(O(A(e,n,f),a,l),h,u)}function _(e){var r=(t(e)-t(n)*t(f))/(i(n)*i(f));return r<-1?T.POLAR_EXCEPTION.MIDNIGHT_SUN:r>1?T.POLAR_EXCEPTION.POLAR_NIGHT:T.POLAR_EXCEPTION.NORMAL}var x,S,R,E,I,L={solarNoon:p(g),nadir:p(g-.5),polarException:T.POLAR_EXCEPTION.NORMAL};for(x=0,S=P.length;x<S;x+=1)I=g-((E=y((R=P[x])[0]*o))-g),L[R[1]]=p(I),L[R[2]]=p(E);return L.polarException=_(P[0][0]*o),L},T.getMoonPosition=function(e,t,i){var s=o*-i,a=o*t,n=m(e),l=E(n),c=x(n,s)-l.ra,h=_(c,a,l.dec);return h+=.017*o/r(h+10.26*o/(h+5.1*o)),{azimuth:y(c,a,l.dec),altitude:h,distance:l.dist}},T.getMoonFraction=function(e){var r=m(e),s=S(r),o=E(r),l=149598e3,c=n(t(s.dec)*t(o.dec)+i(s.dec)*i(o.dec)*i(s.ra-o.ra)),h=a(l*t(c),o.dist-l*i(c));return(1+i(h))/2},T}();void 0!==i&&(e.exports=i)}()}));const Gp={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,diffuseAtNoon:.65,diffuseAtTwilight:.7},global:{altitude:8e5,ambient:.015,diffuse:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function Bp(e,t){const i=t[2],r=Hp;Ye(r.ambient.color,1,1,1),r.ambient.intensity=Gp.global.ambient,Ye(r.diffuse.color,1,1,1),r.diffuse.intensity=Gp.global.diffuse;let s=(Math.abs(i)-Gp.local.altitude)/(Gp.global.altitude-Gp.local.altitude);s=Re(s,0,1),r.globalFactor=s;const a=jp.getTimes(e,t[1],t[0]);if(s<1){const t=function(e,t){const i=e.valueOf();let r,s;t.polarException===jp.POLAR_EXCEPTION.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===jp.POLAR_EXCEPTION.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const a=s-r,n=r+a/2,o=a/4,l=n-o,c=n+o,h=.06*a,d=r-h/2,u=r+h/2,p=s-h/2,m=s+h/2,f=Gp.local,g=[.01,f.ambientAtNight],v=[.8,.8,1],y=[.01,.01,.01],_=[f.diffuseAtTwilight,f.ambientAtTwilight],x=[1,.75,.75],b=[.8,.8,1],w=[.9*f.diffuseAtNoon,f.ambientAtNoon],C=[1,.98,.98],S=[.98,.98,1],T=[f.diffuseAtNoon,f.ambientAtNoon],P=[1,1,1],R=[1,1,1],M=w,O=C,D=S,A=_,E=x,I=b;let L,F,V=[0,0],z=[0,0,0],U=[0,0,0];i<d||i>m?(V=g,z=y,U=v,F="night"):i<u?(L=u-d,V=Wp(i-d,L,g,_),z=Wp(i-d,L,y,x),U=Wp(i-d,L,v,b),F="sun rising"):i<l?(L=l-u,V=Wp(i-u,L,_,w),z=Wp(i-u,L,x,C),U=Wp(i-u,L,b,S),F="early morning"):i<n?(L=n-l,V=Wp(i-l,L,w,T),z=Wp(i-l,L,C,P),U=Wp(i-l,L,S,R),F="late morning"):i<c?(L=c-n,V=Wp(i-n,L,T,M),z=Wp(i-n,L,P,O),U=Wp(i-n,L,R,D),F="early afternoon"):i<p?(L=p-c,V=Wp(i-c,L,M,A),z=Wp(i-c,L,O,E),U=Wp(i-c,L,D,I),F="late afternoon"):i<m&&(L=m-p,V=Wp(i-p,L,A,g),z=Wp(i-p,L,E,y),U=Wp(i-p,L,I,v),F="sun setting");return{diffuse:{intensity:V[0],color:ke(z[0],z[1],z[2])},ambient:{intensity:V[1],color:ke(U[0],U[1],U[2])},timeOfDay:F}}(e,a);tt(r.ambient.color,t.ambient.color,r.ambient.color,s),r.ambient.intensity=De(t.ambient.intensity,r.ambient.intensity,s),tt(r.diffuse.color,t.diffuse.color,r.diffuse.color,s),r.diffuse.intensity=De(t.diffuse.intensity,r.diffuse.intensity,s)}return r.noonFactor=function(e,t){const i=e.valueOf();let r,s;t.polarException===jp.POLAR_EXCEPTION.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===jp.POLAR_EXCEPTION.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const a=r+(s-r)/2;return 1-Re(Math.abs(i-a)/432e5,0,1)}(e,a),r}const Np=jr(),qp={azimuth:0,altitude:0},Hp={ambient:{color:je(),intensity:0},diffuse:{color:je(),intensity:0,direction:je()},globalFactor:0,noonFactor:0};function Wp(e,t,i,r){const s=[];for(let a=0;a<i.length;a++)s[a]=(r[a]-i[a])*e/t+i[a];return s}const Zp=ke(.5773502691896258,-.5773502691896258,.5773502691896258);let Qp=class extends se.EventedAccessor{constructor(...e){super(...e),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new $t,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this.referencePosUpdateTimer=null,this._referencePosWGS84Comparable=null,this._referencePosMapCoords=null,this._mainLight=new vc,this._ambientLight=new yc,this._moonLight=new _c,this._renderer=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get updating(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)}connectView(e){this._renderer||(this._view=e,this._renderer=new zp({view:e}),this._viewHandles.add([e.watch("environment.lighting.date",(e=>this._lightingDateHandler(e)),!0),e.watch("stationary",(()=>this._interactingStationaryHandler())),e.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],(()=>this._updateRenderParamsHandler()),!0),e.watch("spatialReference",(()=>this._resetReferencePosition(!0)),!0),hi(e,"viewingMode",(()=>this._resetReferencePosition(!0)),!0),hi(e,"environment.lighting.cameraTrackingEnabled",(e=>this._updateCameraTracking(e)),!0),hi(e,"state.camera",(()=>this._cameraHandler(null)),!0),this.watch("disableQueries",(()=>this._cameraHandler(null)))]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))}disconnectView(){this._renderer&&(this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer.destroy(),this._renderer=null,this._view=null)}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;e&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){if(!e)return;const t=this._view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!er(i)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),this._referencePosWGS84Comparable){const e=kp(this._referencePosWGS84Comparable,$p);h(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(e)}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){if(!this._view.ready)return;const t=this._view.camera;t&&(this._cameraHandlerClientSide(t,e)||this._cameraHandlerServerSide(t))}_cameraHandlerClientSide(e,t){const i=fe(this._view.spatialReference);if(i&&!er(this._view.spatialReference))return!1;const r=e.position;return this._referencePosWGS84Comparable||(this._referencePosWGS84Comparable=je()),i?tr(r,this._referencePosWGS84Comparable):Ye(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLightParams(e){const t=this._view.environment.lighting;e=e||t.date;const i=this._view._stage;let r;this._referencePosWGS84Comparable?(r=Bp(e,this._referencePosWGS84Comparable),function(e,t,i,r){r||(r=je());const s=qp,a=Si(Np);if("global"===i)jp.getPosition(e,0,0,s),Ye(r,0,0,-1),Ti(a,a,-s.azimuth),Pi(a,a,-s.altitude),it(r,r,a);else{const i=Gp.planarDirection,n=i.globalAngles,o=t[2];let l=(Math.abs(o)-i.localAltitude)/(i.globalAltitude-i.localAltitude);l=Re(l,0,1),l<1?(jp.getPosition(e,t[1],t[0],s),s.azimuth=(1-l)*s.azimuth+l*n.azimuth,s.altitude=(1-l)*s.altitude+l*n.altitude):(s.azimuth=n.azimuth,s.altitude=n.altitude),Ye(r,0,-1,0),Ci(a,a,-s.azimuth),Ti(a,a,-s.altitude),it(r,r,a)}}(e,this._referencePosWGS84Comparable,this._view.viewingMode,r.diffuse.direction)):r={diffuse:{color:[1,1,1],intensity:.55,direction:Zp},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0},Ze(this._mainLight.intensity,r.diffuse.color,r.diffuse.intensity*Math.PI),rt(this._mainLight.direction,r.diffuse.direction),Ze(this._ambientLight.intensity,r.ambient.color,r.ambient.intensity),tt(this._moonLight.intensity,Xp,Kp,r.globalFactor);const s=(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor));Ze(this._moonLight.intensity,this._moonLight.intensity,s),Xe(this._moonLight.direction,r.diffuse.direction),i.setLighting({lights:[this._mainLight,this._ambientLight,this._moonLight],globalFactor:r.globalFactor,groundLightingFactor:1-r.noonFactor}),this._updateRenderParamsHandler()}_autoUpdateTimezone(e,t=null){if(!this._view.environment.lighting.cameraTrackingEnabled)return!1;const i=Yp;i.setTime((t||this._view.environment.lighting.date).getTime());const r=kp(e,$p);if(u(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const a=i.getUTCHours()-(r.hours-s.hours),n=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(a),i.setUTCMinutes(n),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParamsHandler(){const e=this._view._stage;if(!e)return;const t=!this._referencePosWGS84Comparable||function(e,t){if("global"===t)return!0;{const t=Gp.planarDirection,i=e[2];return Math.abs(i)<t.localAltitude}}(this._referencePosWGS84Comparable,this._view.viewingMode),i=this._view.environment.background,r=i instanceof gr?{type:"color",color:Rr(At.toUnitRGBA(i.color))}:{type:"color",color:Pr(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,ssao:this._view.environment.lighting.ambientOcclusionEnabled,waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:r})}_resetReferencePosition(e=!1){const t=this._cancelReferencePosUpdates();this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),t&&e&&this._cameraHandler(null)}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=G(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this.referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this.referencePosUpdateTimer=G(this._referencePointUpdateInterval).then((()=>{this.referencePosUpdateTimer===t&&(this.referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams()}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this.referencePosUpdateTimer=null,e}get test(){const e=this;return{renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e.referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t}}}};Qp.FIXED_LIGHT_DIRECTION=Zp,e([S({type:Boolean,dependsOn:["disableQueries","_renderer.updating"],readOnly:!0})],Qp.prototype,"updating",null),e([S()],Qp.prototype,"disableQueries",void 0),e([S()],Qp.prototype,"_renderer",void 0),Qp=e([re("esri.views.3d.environment.SceneViewEnvironmentManager")],Qp);const Yp=new Date,$p={hours:0,minutes:0,seconds:0},Xp=ke(.22,.22,.33),Kp=ke(.22,.22,.22);var Jp=Qp;function em(e,t){return 0!=(e&t)}function tm(e,t,i,r,s,a){0!==e&&(i?(a.min=Math.min(a.min,t),a.max=Math.max(a.max,t)):null!=r?(a.min-=Math.max(0,(t-a.min)*(1-r)),a.max+=Math.max(0,(t-a.max)*(1-r))):s&&(a.min-=Math.max(0,t-a.min-s),a.max+=Math.max(0,t-a.max-s)))}const im={selection:0,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0};function rm(e,t,i,r){return t=t||e.viewForward,Xe(r,t),Ze(r,r,Ee(st(t,i))),r}function sm(e,t,i,r){return function(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let i=0;i<e.length;i++)if(!nm(e[i],t,r))return!1;return!0}(e,t,i,function(e,t,i,r){const s=am;e?(i&&r&&(s.len=Ke(t,i)),Xe(s.dir,e)):r?(s.len=Ke(t,i),at(s.dir,i,t),Ze(s.dir,s.dir,1/s.len)):(at(s.dir,i,t),nt(s.dir,s.dir));return s}(r,t,i,!0))}const am={dir:je(),len:0,clip:cn()};function nm(e,t,i){const r=st(Uo.normal(e),i.dir),s=-Uo.signedDistance(e,t);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const a=s/r;return r>0?a<i.clip[1]&&(i.clip[1]=a):a>i.clip[0]&&(i.clip[0]=a),i.clip[0]<=i.clip[1]}function om(e,t,i=im){if(!function(e,t){const i=e.state.constraints.altitude;if(!e.state.isGlobal||!i)return!1;if(2===t.interactionType&&em(t.selection,1))return!1;return!0}(e,i))return 0;const r=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,lm);!function(e,t,i){const r=t.interactionType;if(0===r)return;const{min:s,max:a}=i,{interactionStartCamera:n,interactionFactor:o}=t,l=2===r||1===r,c=om(e,n),h=0===c?0:e.renderCoordsHelper.getAltitude(n.eye);i.min=s,i.max=a;tm(c,h,l,o,.05*h,i)}(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),a=Re(s,r.min,r.max)-s;return Math.abs(a)<=1e-6?0:a}const lm={min:0,max:0},cm=je(),hm=je(),dm=je();function um(e,t,i=im){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;mm.min=0,mm.max=r,function(e,t,i){const r=t.interactionType;if(0===r)return;const{min:s,max:a}=i,{interactionStartCamera:n,interactionFactor:o}=t,l=1===r||4===r,c=um(e,n),h=0===c?0:pm(e,n);i.min=s,i.max=a;tm(c,h,l,o,.05*h,i)}(e,i,mm);const s=pm(e,t),a=mm.max-s;return a>=-1e-6?0:a}function pm(e,t){const i=e.pointsOfInterest.surfaceOrigin;return Ke(t.eye,i.renderLocation)}const mm={min:0,max:0},fm=je(),gm=je(),vm=je(),ym=je();function _m(e,t,i,r){return e.renderCoordsHelper.fromRenderCoords(t.eye,Sm,r)&&Ii(i,Sm)}function xm(e,t){return e.elevationProvider&&e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")||0}function bm(e,t,i,r){const s=e.state.camera.clone();t&&(s.eye=t),i&&(s.center=i),r&&(s.up=r),function(e,t,i=je()){let r=Cm[e.viewingMode];r||(r=new ih(e.state.mode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,Cm[e.viewingMode]=r);const{isGlobal:s}=e.state;if(e.sceneIntersectionHelper.intersectRay(t,r,i)&&!wm(e,t.origin,i))return!0;if(!e.renderCoordsHelper.intersectManifold(t,0,i)||wm(e,t.origin,i))return!!s&&function(e,t,i){const r=st(e.origin,e.origin),s=r-i*i,a=s>0?Math.sqrt(s)/3:1;return Ze(t,e.direction,a/$e(e.direction)),Qe(t,t,e.origin),!0}(t,i,Kt(e.spatialReference).radius);return!0}(e,s.ray,Tm)||Xe(Tm,s.center);const a=e.state.constraints,n=a.minimumPoiDistance;if(ot(s.eye,Tm)<n){const t=a.collision.enabled;Xe(Pm,s.viewForward),Ze(Pm,Pm,n),t?at(s.eye,Tm,Pm):Qe(Tm,s.eye,Pm);const i=e.renderCoordsHelper,r=i.getAltitude(s.eye),o=a.collision.elevationMargin;t&&r<o&&(at(Pm,Tm,s.eye),i.setAltitude(o,s.eye),Qe(Tm,s.eye,Pm))}return s.center=Tm,s}function wm(e,t,i){if(!e.state.isGlobal)return!1;const r=xm(e,t),s=e.stateManager.constraintsManager.nearFarHeuristic,{far:a}=s.compute(t,i,e.dataExtent,r,Rm),n=a*a;return ot(t,i)>n}const Cm={},Sm=je(),Tm=je(),Pm=je(),Rm={near:0,far:0};function Mm(e,t,i=0){const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=xm(e,t.eye),a=e.renderCoordsHelper.getAltitude(t.eye),n=s+r.collision.elevationMargin;if(a>=n)return!1;const o=$e(t.eye);if(at(Om,t.center,t.eye),e.renderCoordsHelper.setAltitude(n,t.eye),1===i)Qe(t.center,t.eye,Om);else if(2===i){const e=(o-a+n)/o;Ze(t.center,t.center,e)}return t.markViewDirty(),!0}const Om=je();function Dm(e,t,i){e.worldUpAtPosition(t,Am),at(Em,i,t);const r=$e(Em);return 0===r?0:Ie(st(Em,Am)/r)}const Am=je(),Em=je();function Im(e,t,i=im,r=im,s){if(!e.state.constraints.tilt)return 0;const a=t.distance,n=e.state.constraints.tilt(a,Bm);return function(e,t,i){if(0===t.interactionType)return;const{interactionStartCamera:r,interactionFactor:s}=t,{min:a,max:n}=i,o=Im(e,r,im,t),l=0===o?0:Dm(e.renderCoordsHelper,r.center,r.eye);i.min=a,i.max=n,2===t.interactionType?(em(t.selection,2)&&zm(e,r,i),tm(o,l,!0,s,Gm,i)):tm(o,l,!1,s,Gm,i)}(e,i,n),2===r.interactionType&&em(r.selection,2)&&zm(e,r.interactionStartCamera,n),1===i.tiltMode||1===r.tiltMode?function(e,t,i,r){r&&(r.requiresTwoSteps=!1);switch(e.viewingMode){case"global":return function(e,t,i,r){const s=Lm(e,t,Nm),a=Re(s.tiltAtCenter,i.min,i.max);if(!Fm(s.tiltAtCenter-a))return 0;let n,o;s.centerIsOnSurface?(n=function(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:r}=e;let s=r,a=t.clampTilt(i,r);const n=Vm(e,a);if(t.clampTilt(n,r)===a)return a;let o=0;for(;o<10&&Fm(a-s);){const i=(s+a)/2,r=Vm(e,i);Fm(t.clampTilt(r,i)-i)?s=i:a=i,o++}return a}(s),o=function(e,t){const i=Ae(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=Ae(e.radius/e.eyeRadius*Math.sin(t));if(e.eyeRadius>e.radius)return i-r;return r-i}(s,n)):(n=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&n<Math.PI/2&&(r.requiresTwoSteps=!0,n=Math.PI/2-1e-5),o=function(e,t){const i=e.tiltAtCenter-Math.PI/2,r=t-Math.PI/2;return i-r}(s,n));r&&(r.eyeCenterDistance=Vm(s,n));return o}(e,t,i,r);case"local":return function(e,t,i,r){const s=Dm(e.renderCoordsHelper,t.center,t.eye),a=Re(s,i.min,i.max),n=s-a;if(!Fm(n))return 0;if(r){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=e.renderCoordsHelper.getAltitude(t.eye)-i,n=Math.cos(a);Math.abs(n)>1e-4?r.eyeCenterDistance=s/n:r.eyeCenterDistance=t.distance}return n}(e,t,i,r);default:return void te(e.viewingMode)}}(e,t,n,s):function(e,t,i){const r=Dm(e.renderCoordsHelper,t.center,t.eye),s=Re(r,i.min,i.max),a=r-s;if(!Fm(a))return 0;return a}(e,t,n)}function Lm(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+Kt(e.spatialReference).radius,a=e.renderCoordsHelper.intersectManifold(t.ray,r,jm);return i.eyeCenterDistance=t.distance,a?(i.eyeCenterDistance=Ke(t.eye,jm),i.tiltAtCenter=Dm(e.renderCoordsHelper,jm,t.eye)):e.state.isLocal?i.tiltAtCenter=Dm(e.renderCoordsHelper,t.center,t.eye):(jo.closestPointOnSilhouette(jo.wrap(s),t.ray,jm),i.eyeCenterDistance=Ke(t.eye,jm),i.tiltAtCenter=Ie(-st(t.viewForward,nt(jm,jm)))),i.radius=s,i.eyeRadius=$e(t.eye),i.constraints=e.state.constraints,i.centerIsOnSurface=a,i}function Fm(e){return Math.abs(e)>1e-9}function Vm(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-Re(t,0,Math.PI),r=Ae(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,a=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&a>1){const t=Math.PI-r,s=Math.PI-i-t;return Math.sin(s)/Math.sin(i)*e.eyeRadius}return a*e.eyeRadius}function zm(e,t,i){if(e.state.isLocal)return;const r=e.state.constraints;if(!r.altitude)return;const s=et(t.center),a=Math.sqrt(s),n=t.distance,o=Kt(e.spatialReference).radius,l=r.altitude.min+o,c=r.altitude.max+o,h=(l*l-n*n-s)/(-2*a*n),d=(c*c-n*n-s)/(-2*a*n);i.min=Math.max(i.min,Math.min(Math.PI-Ie(d),i.max)),i.max=Math.min(i.max,Math.PI-Ie(h))}const Um=je(),km=jr(),jm=je(),Gm=Me(5),Bm={min:0,max:0},Nm={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},qm={eyeCenterDistance:0,requiresTwoSteps:!1};const Hm=e=>e*e,Wm=e=>1-Hm(1-e),Zm=e=>e*e*e,Qm=e=>1-Zm(1-e),Ym=e=>e<.5?Zm(2*e)/2:(Qm(2*(e-.5))+1)/2,$m=e=>e*e*e*e,Xm=e=>1-$m(1-e),Km=e=>e*e*e*e*e,Jm=e=>1-Km(1-e),ef=e=>1-Math.cos(e*Math.PI/2),tf=e=>1-ef(1-e),rf=e=>Math.pow(2,10*(e-1)),sf=e=>1-rf(1-e),af=e=>-(Math.sqrt(1-e*e)-1),nf=e=>1-af(1-e);function of(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function lf(e,t){return i=>i<t?t*e(i/t):1-e((1-i)/(1-t))*(1-t)}const cf=lf(of(1),1),hf=lf(of(1),0),df=lf(of(1),.5),uf=lf(of(2),1),pf=lf(of(2),0),mf=lf(of(2),.5),ff=lf(of(3),1),gf=lf(of(3),0),vf=lf(of(3),.5),yf=lf(of(4),1),_f=lf(of(4),0),xf=lf(of(4),.5),bf={linear:function(e){return e},"in-quad":Hm,"out-quad":Wm,"in-out-quad":e=>e<.5?Hm(2*e)/2:(Wm(2*(e-.5))+1)/2,"in-coast-quad":cf,"out-coast-quad":hf,"in-out-coast-quad":df,"in-cubic":Zm,"out-cubic":Qm,"in-out-cubic":Ym,"in-coast-cubic":uf,"out-coast-cubic":pf,"in-out-coast-cubic":mf,"in-quart":$m,"out-quart":Xm,"in-out-quart":e=>e<.5?$m(2*e)/2:(Xm(2*(e-.5))+1)/2,"in-coast-quart":ff,"out-coast-quart":gf,"in-out-coast-quart":vf,"in-quint":Km,"out-quint":Jm,"in-out-quint":e=>e<.5?Km(2*e)/2:(Jm(2*(e-.5))+1)/2,"in-coast-quint":yf,"out-coast-quint":_f,"in-out-coast-quint":xf,"in-sine":ef,"out-sine":tf,"in-out-sine":e=>e<.5?ef(2*e)/2:(tf(2*(e-.5))+1)/2,"in-expo":rf,"out-expo":sf,"in-out-expo":e=>e<.5?rf(2*e)/2:(sf(2*(e-.5))+1)/2,"in-circ":af,"out-circ":nf,"in-out-circ":e=>e<.5?af(2*e)/2:(nf(2*(e-.5))+1)/2};function wf(e,t,i=Tf,r=t){let s=!1;r!==t&&r.copyFrom(t),r.markViewDirty(),r.computeUp(e.state.mode);for(let t=0;t<Pf;t++){let t=0;for(const a of Sf)if(em(i.selection,a.type)){const n=Math.abs(a.error(e,r,i));a.apply(e,r,i)&&(s=!0,t+=n)}if(0===t)break}const a=em(i.selection,8),n=function(e,t){switch(e){case 4:return 1;case 5:return t.state.isGlobal?2:1;default:return 0}}(i.interactionType,e);return a&&Mm(e,r,n)&&(s=!0),s&&r.computeUp(e.state.mode),s}function Cf(e,t){const i="number"==typeof e?e:cs(e,t),r=Math.min(1,i/150);return Ym(r)}const Sf=[{type:1,error:function(e,t,i){return Im(e,t,i)*t.distance},apply:function e(t,i,r=im,s=!0){qm.eyeCenterDistance=0,qm.requiresTwoSteps=!1;const a=Im(t,i,r,void 0,qm);if(0===a)return!1;switch(Si(km),Ri(km,km,-a,i.viewRight),r.tiltMode){case 1:it(Um,i.viewForward,km),Ze(Um,Um,qm.eyeCenterDistance),Qe(i.center,i.eye,Um);break;case 0:at(Um,i.center,i.eye),it(Um,Um,km),at(i.eye,i.center,Um);break;default:te(r.tiltMode)}return it(i.up,i.up,km),i.markViewDirty(),!qm.requiresTwoSteps||!s||e(t,i,r,!1)}},{type:2,error:om,apply:function(e,t,i=im){const r=om(e,t,i);if(0===r)return!1;const s=e.renderCoordsHelper,a=s.getAltitude(t.eye)+r,n=rm(t,i.interactionDirection,function(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),Ze(r,r,i),r}(e,t,Ee(r),hm),cm),o=Xe(dm,t.viewForward);return s.intersectInfiniteManifold(ko.wrap(t.eye,n),a,t.eye)||s.setAltitude(a,t.eye),function(e,t,i,r){const s=st(t,at(r,i,e));Qe(r,e,Ze(r,t,s))}(t.eye,o,t.center,t.center),t.markViewDirty(),!0}},{type:4,error:um,apply:function(e,t,i=im){const r=um(e,t,i);if(0===r)return!1;const s=e.pointsOfInterest.surfaceOrigin,a=pm(e,t)+r,n=Xe(fm,t.eye),o=rm(t,i.interactionDirection,function(e,t,i){const r=e.pointsOfInterest.surfaceOrigin;return xt(i,t.eye,r.renderLocation)}(e,t,ym),vm);if(jo.intersectRay(jo.wrap(a,s.renderLocation),ko.wrap(t.eye,o),t.eye)){const i=at(gm,t.eye,n);Qe(t.center,t.center,i),t.markViewDirty();const r=e.renderCoordsHelper.getAltitude(t.center);return e.renderCoordsHelper.intersectInfiniteManifold(t.ray,r,t.center),t.markViewDirty(),!0}return!1}}],Tf={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},Pf=5,Rf=je(),Mf=je(),Of=je(),Df=je(),Af=je(),Ef=je(),If={upward:ke(0,0,1),forward:ke(0,1,0),sideway:ke(1,0,0)},Lf=Br();class Ff{constructor(e=1){this.viewingMode=e,this.center=je(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=Ue(If.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),1===this.viewingMode){const i=($e(this.center)+$e(e.center))/2;t.pan=bt(this.center,e.center)*i}else t.pan=Ke(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(i,r),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,i){1===this.viewingMode?wt(e.center,t.center,i.pan,this.center):tt(this.center,e.center,t.center,i.pan),this.distance=De(e.distance,t.distance,i.zoom),this.pitch=De(e.pitch,t.pitch,i.rotate);let r=e.yaw;const s=t.yaw;Math.abs(s-r)>=Math.PI&&(r+=2*(r<s?1:-1)*Math.PI),this.yaw=De(r,s,i.rotate)}copyFrom(e){Xe(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,Xe(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,Lf);Xe(this.center,e.center),at(Df,e.center,e.eye),lt(Df,Df,t),lt(Af,e.up,t),this.distance=$e(Df),Df[0]/=this.distance,Df[1]/=this.distance,Df[2]/=this.distance,this.pitch=this._eyeUpToPitch(Df),this.yaw=this._eyeUpToYaw(Df,Af),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,Lf);Wr(t,t),this._axisAngleVec3(If.sideway,this.pitch-Math.PI/2,If.forward,Df),this._axisAngleVec3(If.upward,this.yaw,Df),this._axisAngleVec3(If.sideway,this.pitch-Math.PI/2,If.upward,Af),this._axisAngleVec3(If.upward,this.yaw,Af),Ze(Df,Df,this.distance),lt(Df,Df,t),lt(Af,Af,t),e.center=this.center,e.eye=at(Df,this.center,Df),e.up=Af}_axisAngleVec3(e,t,i,r=i){const s=Math.cos(t),a=Math.sin(t);return Ze(Rf,i,s),Je(Mf,e,i),Ze(Mf,Mf,a),Ze(Of,e,(1-s)*st(e,i)),Qe(r,Qe(r,Rf,Mf),Of)}_lookAtOrientation(e,t){return this._upAtLookAt(e,Of),Je(Rf,this.lookAtDirection,Of),nt(Rf,Rf),0===Rf[0]&&0===Rf[1]&&0===Rf[2]&&Xe(Rf,If.sideway),Je(Mf,Of,Rf),nt(Mf,Mf),t||(t=Br()),t[0]=Rf[0],t[1]=Mf[0],t[2]=Of[0],t[3]=Rf[1],t[4]=Mf[1],t[5]=Of[1],t[6]=Rf[2],t[7]=Mf[2],t[8]=Of[2],t}_upAtLookAt(e,t){return 2===this.viewingMode?Xe(t,If.upward):nt(t,e)}_eyeUpToPitch(e){return Math.PI-bt(If.upward,e)}_eyeUpToYaw(e,t){const i=Ef;return Math.abs(t[2])<.5?(Xe(i,t),e[2]>0&&Ze(i,i,-1)):Xe(i,e),Je(Mf,i,If.upward),nt(Mf,Mf),bt(If.sideway,Mf,If.upward)}}const Vf=2,zf=.5,Uf=8;class kf{constructor(e){this.createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:Vf},this.source=e(),this.target=e()}clone(){const e=new kf(this.createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=i.desiredScreenFlow?i.desiredScreenFlow:Vf,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class jf{constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,r=t.targetZoom;this._zoomSign=i>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const s=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(r))/2;this._rotatePixels=t.rotate*s}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:r,hasRotate:s}=this.definition;let a=0,n=0;i&&(r&&(a=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),s&&(n=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const o=this.definition.desiredPixelFlow;if(i&&r&&s){const e=a+n+a*n;this._zoomPixelFlow=a*n/e*o,this._panPixelFlow=n/e*o,this._rotatePixelFlow=a/e*o}else if(i&&r){const e=1+a;this._zoomPixelFlow=a/e*o,this._panPixelFlow=1/e*o}else if(i&&s){const e=1+n;this._zoomPixelFlow=n/e*o,this._rotatePixelFlow=1/e*o}else if(r&&s){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*o,this._rotatePixelFlow=1/t*o}else r?this._panPixelFlow=o:i?this._zoomPixelFlow=o:s&&(this._rotatePixelFlow=o);this.time=s?this.rotateTime:i?this.zoomTime:r?this.panTime:0}get zoomTime(){return this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow)}return this._panPixelsAtSource/this._panPixelFlow}return 0}get rotateTime(){return this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*Math.pow(t/i,-e)-t)/(i-t)}return e}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(Math.pow(2,t*e*this.time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),r=this._interpolateComponentsPan(e),s=this._interpolateComponentsRotate(e);return t?(t.zoom=i,t.pan=r,t.rotate=s):t={zoom:i,pan:r,rotate:s},t}}function Gf(e,t,i){const r=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function Bf(e,t,i){const r=1/t,s=Math.log(e.compared.sourceZoom*r),a=1/e.desiredPixelFlow,n=1/Math.LN2,o=t-e.compared.sourceZoom,l=1/o,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*a*n*l*c-e.halfWindowSize*s*a*n*l+e.halfWindowSize*s*a*n*c/(o*o)}function Nf(e,t,i){const r=t-e.compared.sourceZoom,s=1/r,a=1/t,n=Math.log(e.compared.sourceZoom*a),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*a*o+2*s*n+2*a-2*n*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function qf(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function Hf(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Wf(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Zf(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function Qf(e,t,i){const r=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,a=1/Math.LN2,n=-t+e.compared.targetZoom,o=1/n,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*s*a*o+e.halfWindowSize*r*s*a*l/(n*n)+e.halfWindowSize*s*a*o*l/t}function Yf(e,t,i){const r=t-e.compared.targetZoom,s=1/r,a=1/t,n=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*a*o-2*s*n+2*a+2*n*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function $f(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function Xf(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Kf(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Jf(e,t){let i=function(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;if(r<i)return null!=t.maximumDistance?i+(t.maximumDistance-i)/2:1.5*i;if(t.maximumDistance)return Math.min(t.maximumDistance,r);return r}(e,t);const r={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},s=0===r.ascensionFactor,a=0===r.descensionFactor,n=s?qf:Gf,o=s?Hf:Bf,l=s?Wf:Nf,c=a?$f:Zf,h=a?Xf:Qf,d=a?Kf:Yf,u=t=>n(e,t,r)+function(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,r)+c(e,t,r),p=t=>o(e,t,r)+function(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,r)+h(e,t,r),m=t=>l(e,t,r)+function(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,r)+d(e,t,r);let f=u(i);const g=function(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,r=e.halfWindowPanAtZoom(i),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*r);return e.compared.sourceZoom<=e.compared.targetZoom?s*(t-r):s*(t+r)}(e);let v;const y=t.maximumIterations||20,_=null!=t.maximumDistance?t.maximumDistance:1/0;for(v=0;v<y;v++){const t=1e-6,r=(p(i)+t)/m(i);if(isNaN(r)||i>=_&&r<0){if(!isFinite(_))return null;i=_,f=u(i);break}if(i-=r,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const s=u(i);if(Math.abs(s-f)/f<=.005)break;f=s}return f>.7*g||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}class eg extends class{constructor(){this.segments=[]}get time(){return this.segments.reduce(((e,t)=>e+t.time),0)}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0;const s=this.definition;for(let a=0;a<this.segments.length;a++){const n=this.segments[a],o=n.definition;if(e<=n.time||a===this.segments.length-1){t=this.segmentInterpolateComponentsAt(n,e/n.time,t),s.hasPan?t.pan=(i+o.compared.pan*t.pan)/s.compared.pan:t.pan=1,s.hasRotate?t.rotate=(r+o.compared.rotate*t.rotate)/s.compared.rotate:t.rotate=1;const a=t.zoom*(o.compared.targetZoom-o.compared.sourceZoom)+o.compared.sourceZoom,l=this.segments[0].definition.compared.sourceZoom,c=this.segments[this.segments.length-1].definition.compared.targetZoom;return s.hasZoom?t.zoom=(a-l)/(c-l):t.zoom=1,t}e-=n.time,i+=o.compared.pan,r+=o.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){return e.interpolateComponentsAt(t,i)}}{constructor(e,t){super(),this._preallocSegments=[new jf,new jf,new jf],this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;t&&t.apex&&(i=Jf(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==i?this._updateWithoutApex():this._updateWithApex(i,t.apex)}segmentInterpolateComponentsAt(e,t,i){return i=e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=Wm(i.zoom):e===this._descensionSegment&&(i.zoom=Hm(i.zoom)),i}_updateWithApex(e,t){const[i,r,s]=this._preallocSegments,a=null!=t.ascensionFactor?t.ascensionFactor:.5,n=Math.min(1-a,null!=t.ascensionFactor?t.descensionFactor:.5),o=1-a-n;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*a,i.definition.compared.rotate=this.definition.compared.rotate*a,i.update(),this._ascensionSegment=i,this.segments.push(i),o>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.update(),this.segments.push(r)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*n,s.definition.compared.rotate=this.definition.compared.rotate*n,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const tg={zoom:0,pan:0,rotate:0};class ig{constructor(e){this.createCamera=e,this.time=0,this.definition=new kf(e),this.path=new eg}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this.time=this._applyTimeSettings(this.path.time,i),this.settings=i}cameraAt(e,t){t=t||this.createCamera(),e=Math.min(Math.max(0,e),1),e=this.settings.easing?this.normalizedEasing(this.settings.easing,e):this.time>=1?this.normalizedEasing(df,e):this.normalizedEasing(sf,e);const i=this.path.interpolateComponentsAt(e,tg);return t.interpolate(this.definition.source,this.definition.target,i),t}normalizedEasing(e,t){const i=e(0),r=e(1);return(e(t)-i)/(r-i)}_applyTimeSettings(e,t){const i=null!=t.speedFactor?t.speedFactor:1;null!=t.duration?e=t.duration:null!=t.speedFactor&&(e/=i);const r=null!=t.minDuration?t.minDuration:zf/i,s=null!=t.maxDuration?t.maxDuration:Uf/i;return e=Math.min(Math.max(r,e),s)}}const rg=je();class sg{constructor(e){this.currentTime=0,this.animation=new ig((()=>new Ff(e))),this._current=new Ff(e)}get finished(){return this.currentTime>=this.animation.time}get time(){return this.animation.time}update(e,t,i){const r=this.animation.definition.source,s=this.animation.definition.target,a=at(rg,t.center,e.center),n=$e(a);n>=1e-5?(a[0]/=n,a[1]/=n,a[2]/=n):(a[0]=0,a[1]=1,a[0]=0),Xe(r.lookAtDirection,a),Xe(s.lookAtDirection,a),r.copyFromRenderCamera(e),s.copyFromRenderCamera(t),this._current.copyFrom(r),this.animation.update(r,s,i),this.currentTime=0,e.almostEquals(t)&&(this.currentTime=this.animation.time)}cameraAt(e,t){return this.animation.cameraAt(e,this._current),t=t||new rh,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime+=e,this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}var ag;!function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"}(ag||(ag={}));let ng=class extends T{constructor(){super(...arguments),this.state=ag.Ready}get active(){return this.state===ag.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=ag.Stopped,!0)}finishController(){this.state=ag.Finished}get steppingFinished(){return!1}};e([S({readOnly:!0,dependsOn:["state"]})],ng.prototype,"active",null),e([S()],ng.prototype,"state",void 0),ng=e([re("esri.views.3d.state.controllers.CameraController")],ng);let og=class extends ng{get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(B()),this._asyncResult=null),this.state===ag.Finished||this.state===ag.Stopped?this.state===ag.Finished?e.resolve():e.reject(B()):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=ag.Running,h(this.viewAnimation)&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!h(this.viewAnimation)||this.state!==ag.Ready&&this.state!==ag.Running||(this.viewAnimation.state===ln.State.FINISHED?this.finish():this.viewAnimation.state===ln.State.STOPPED&&(this.state=ag.Stopped))}onControllerEnd(){h(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===ag.Finished?this.viewAnimation.finish():this.state===ag.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===ag.Finished?this._asyncResult.resolve():this._asyncResult.reject(B()))}finish(){this.finishController()}};og=e([re("esri.views.3d.state.controllers.AnimationController")],og);let lg=class extends og{constructor(e){super(e),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new sg(this.view.state.mode),this.viewAnimation="interaction"===this.mode?null:new ln}get isInteractive(){return"interaction"===this.mode}begin(e,t){this.hasTarget=!0;const i=this.animationSettings(t);cg.copyFrom(this.view.state.camera);const r=new ih(this.view.state.mode);this.intersectionHelper.intersectRay(cg.ray,r,hg)&&(cg.center=hg),this.animation.update(cg,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(e,t){this.hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},speedFactor:e.speedFactor,duration:e.duration,maxDuration:e.maxDuration,easing:e.easing}}};e([S({constructOnly:!0})],lg.prototype,"view",void 0),e([S({constructOnly:!0})],lg.prototype,"mode",void 0),lg=e([re("esri.views.3d.state.controllers.PointToPointAnimationController")],lg);const cg=new rh,hg=je();function dg(e,t,i=function(e){return{operations:e,value:e.create()}}(e)){return i.operations=e,e.copy(t,i.value),i}function ug(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function pg(e,t,i){return e.operations.elevate(e.value,t,i.value)}const mg=je();function fg(e,t,i,r,s){return s[0]=st(e,t),s[1]=st(e,i),s[2]=st(e,r),s}function gg(e,t,i,r,s){Xe(i,e),Xe(vg,t),nt(vg,vg),Je(r,vg,i),Je(s,r,i)}const vg=je();function yg(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function _g(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function xg(e,t,i){const r=Bo.get();Si(r),Ri(r,r,i[3],Go.axis(i)),at(e.eye,e.eye,t),it(e.eye,e.eye,r),Qe(e.eye,e.eye,t),at(e.center,e.center,t),it(e.center,e.center,r),Qe(e.center,e.center,t),it(e.up,e.up,r),e.markViewDirty()}function bg(e,t,i,r){return Uo.intersectRay(e,ko.fromScreen(t,i,fv),r)}function wg(e,t,i,r){const s=No.get();let a=1-i;at(s,t,e.eye);const n=$e(s);let o=n*(1-a);a>=0&&o<r&&(o=r,a=-(o-n)/n),Math.abs(n-o)<1e-6||(Ze(s,s,a),Qe(e.eye,e.eye,s),tt(e.center,e.center,t,a))}function Cg(e,t,i){t.getScreenCenter(Sg),jo.intersectScreen(e,t,Sg,t.center),t.markViewDirty();const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const a=Ze(No.get(),t.viewForward,s);at(t.eye,t.center,a),t.markViewDirty()}const Sg=Vt();function Tg(e,t){Ye(t,0,0,0);for(const i of e)Qe(t,t,i);Ze(t,t,1/e.length)}function Pg(e,t,i,r){return Math.sin(e/$e(t))*(i+r.radius)}function Rg(e,t,i,r){return Pg(Math.PI/2,t,i,r)+(e-Math.PI/2)}var Mg;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(Mg||(Mg={}));const Og=3e4,Dg=Me(6),Ag={Pole:.95,Angle:Me(18),Tilt:45},Eg=Me(80);function Ig(e,t,i,r,s){const a=je(),n=jo.create();let o=!0,l=!0;return e.intersectScreen(i,a)?n.radius=$e(a):(l=!1,t.aboveGround?n.radius=Math.max($e(t.center),.9*s.radius):n.radius=$e(t.eye)-t.relativeElevation,r?zg(n,t,i,a):o=jo.intersectScreen(n,t,i,a)),{sphere:n,scenePickPoint:o?a:null,hasGeometryIntersection:l}}function Lg(e,t,i,r){if($e(e.eye)-r.radius>Og)return Mg.Horizontal;if(!i)return Mg.Vertical;ko.fromScreenAtEye(e,t,gv);return-Ee(e.relativeElevation)*(.5*Math.PI+qo(e.eye,gv.direction))<Dg?Mg.Vertical:Mg.Horizontal}function Fg(e,t,i){at(Vg,i,t),at(e.eye,e.eye,Vg),at(e.center,e.center,Vg),e.markViewDirty()}const Vg=je();function zg(e,t,i,r){const s=ko.fromScreenAtEye(t,i,fv);return!u(s)&&(jo.closestPointOnSilhouette(e,s,Ug),jo.intersectRay(e,s,r)?!(ot(Ug,s.origin)<ot(r,s.origin))||(Xe(r,Ug),!1):(at(kg,t.eye,t.center),nt(kg,kg),Uo.fromNormalAndOffset(kg,-st(nt(kg,kg),Ug),jg),Uo.intersectRay(jg,s,r),!1))}const Ug=je(),kg=je(),jg=Uo.create();function Gg(e,t,i,r,s,a){let n;if(Je(pv,e,t),at(dv,e,t),$e(e)<=s||!r.aboveGround){Je(i,dv,r.eye);const o=st(e,t)/($e(e)*$e(t)),l=Math.cos(Re(Ct.normalize(Me(a)),0,Eg));n=-Ie(o)-Math.max(0,$e(t)-s)/(l*s)}else at(Bg,r.eye,r.center),Je(i,dv,Bg),n=-$e(dv)/s;return nt(i,i),Ze(i,i,$e(pv)),n}const Bg=je();function Ng(e,t,i,r){let s,a;const n=Math.cos(Re(Ct.normalize(Me(r)),0,Eg));return s=t>i?-(t-i)/(n*i):t<-i?Math.PI-(t+i)/(n*i):Ie(t/i),a=e>i?-(e-i)/(n*i):e<-i?Math.PI-(e+i)/(n*i):Ie(e/i),(a-s)*i}function qg(e,t,i,r,s,a,n,o,l,c){Je(pv,e,t),gg(a.up,a.eye,Jg,ev,tv),gg([0,0,1],a.eye,$g,Xg,Kg),Xe(i,Xg),Xe(r,$g),nt(i,i),Ze(i,i,$e(pv)),fg(e,nt(ev,ev),nt(tv,tv),nt(Jg,Jg),iv),fg(t,ev,tv,Jg,rv),function(e,t,i,r,s,a,n,o,l,c){const h=Ng(e[2],t[2],n.radius,l),d=c?Ng(e[0],t[0],n.radius,180):t[0]-e[0],u=Math.sin(o)*d-Math.cos(o)*h,p=Math.cos(o)*d+Math.sin(o)*h;nt(hv,s);const m=c?u/Math.sqrt(Math.abs(Math.pow(n.radius,2)-Math.pow(st(i,hv),2))):u/n.radius,f=p/Math.sqrt(Math.abs(Math.pow(n.radius,2)-Math.pow(st(i,r),2)));ls(a,m,f)}(iv,rv,e,$g,Xg,s,n,o,l,c)}function Hg(e,t,i,r,s,a){Si(nv),Si(ov),Si(lv),Ri(nv,nv,r,i),Ri(ov,ov,a,s),wi(lv,nv,ov),at(e.eye,e.eye,t),it(e.eye,e.eye,lv),Qe(e.eye,e.eye,t),at(e.center,e.center,t),it(e.center,e.center,lv),Qe(e.center,e.center,t),at(e.up,e.up,t),it(e.up,e.up,lv),Qe(e.up,e.up,t),e.markViewDirty()}function Wg(e,t,i,r,s,a,n=Ag.Pole,o=Ag.Angle){const l=Math.abs(r)>Math.PI-o||Math.abs(r)<o,c=Math.abs(e[2])<i*n||Math.abs(t)>i;return!!(l&&c&&a.aboveGround&&s<Ag.Tilt)}function Zg(e,t,i,r,s,a){if(a)Go.fromPoints(i,r,av),xg(t,e.center,av);else{const a=Gg(i,r,mv,t,e.radius,s);xg(t,e.center,Go.wrapAxisAngle(mv,a))}}function Qg(e,t,i,r,s,a,n){const o=n?20:1;let l,c;Xe(cv,r),uv.copyFrom(t);for(let r=0;r<o&&ot(i,cv)>1e-12&&(l=ot(i,cv),qg(i,cv,Xg,$g,sv,uv,e,s,a,n),Hg(uv,e.center,$g,sv[1],Xg,sv[0]),h=cv,d=cv,u=e.center,p=$g,m=sv[1],f=Xg,g=sv[0],Si(nv),Si(ov),Si(lv),Ri(nv,nv,m,p),Ri(ov,ov,g,f),wi(lv,nv,ov),at(d,h,u),it(d,d,lv),Qe(d,d,u),c=ot(i,cv),c<l||0===r);r++)t.copyFrom(uv);var h,d,u,p,m,f,g}function Yg(e,t,i,r,s,a,n,o,l){Wg(e.center,st(e.up,e.center),$e(e.center),-Ct.normalize(Me(a)),n,t)?function(e,t,i,r,s,a){const{eye:n}=e;gg([0,0,1],n,$g,Xg,Kg);const o=t.translation[0]*i.pan,l=t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-Math.pow(st(e.center,$g),2)/Math.pow($e(e.center),2))),.5),h=(Math.sin(a)*l+Math.cos(a)*o)/c,d=-Math.cos(a)*l+Math.sin(a)*o;switch(Ri(r.pan.matrix,r.pan.matrix,h,$g),r.pan.enabled=!0,s.mode){case"pan":Ri(r.pan.matrix,r.pan.matrix,d,Xg),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l,-Ct.normalize(Me(s))):function(e,t,i,r,s){const{eye:a,viewRight:n}=e,o=Je(No.get(),n,a),l=t.translation[0]*i.pan;switch(0!==l&&(Ri(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&(Ri(r.pan.matrix,r.pan.matrix,e,n),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l)}const $g=je(),Xg=je(),Kg=je(),Jg=je(),ev=je(),tv=je(),iv=je(),rv=je(),sv=cn(),av=Go.create(),nv=jr(),ov=jr(),lv=jr(),cv=je(),hv=je(),dv=je(),uv=new rh,pv=je(),mv=je(),fv={origin:je(),direction:je()},gv={origin:je(),direction:je()};let vv=class extends lg{constructor(){super(...arguments),this.zoomLocation=je(),this.tmpCamera=new rh,this.tmpViewDir=je(),this.tmpRayDir={origin:je(),direction:je()},this.targetOnSphere=je(),this.tmpCenter=je(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:null,interactionStartCamera:new rh,interactionDirection:null,tiltMode:0},this.sphere=jo.create()}initialize(){this.intersector=new ih(this.view.state.mode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let s=!1,a=!1;this.intersectionHelper.intersectScreen(t,this.zoomLocation)&&(s=e>0,a=!0),this.tmpCamera.copyFrom(i.camera),s?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:Xe(this.zoomLocation,this.tmpCamera.center),this.updateCamera(this.tmpCamera,e,this.zoomLocation,t,a),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:.6,easing:sf}}updateCamera(e,t,r,s,a){if(Lg(e,s,a,Kt(this.view.spatialReference))===Mg.Horizontal||i("disable-feature:context-navigation")){let i=Math.pow(.6,t);this.sphere.radius=$e(r),at(this.tmpViewDir,e.center,e.eye);const a=$e(this.tmpViewDir);let n=a*i;if(i<=1&&n<4&&(n=4,i=n/a),Math.abs(a-n)<1e-6)return;const o=$e(e.center);if(this.sphere.radius!==o){const t=this.sphere.radius+i*(o-this.sphere.radius);Ze(e.center,e.center,t/o)}Ze(this.tmpViewDir,this.tmpViewDir,-i),Qe(e.eye,e.center,this.tmpViewDir),wf(this.view,e,this.constraintOptions),ot(r,e.center)>1e-12&&jo.intersectScreen(this.sphere,e,s,this.targetOnSphere)&&function(e,t,i,r,s,a,n){Wg(i,st(t.up,i),e.radius,-Ct.normalize(Me(s)),a,t,Ag.Pole,Ag.Angle)?Qg(e,t,i,r,-Ct.normalize(Me(s)),a,n):Zg(e,t,i,r,a,n)}(this.sphere,e,r,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let i=Math.pow(.6,Math.abs(t));const a=t>0?1:-1;let n;ko.fromScreenAtEye(e,s,this.tmpRayDir),nt(this.tmpRayDir.direction,this.tmpRayDir.direction),this.view.camera.position.hasZ&&(n=Math.abs(this.view.camera.position.z));let o=Math.max(12*n,20);const l=this.view._stage.renderView.getMinimalDepthForArea(s[0],s[1],this.view._stage.getCamera(),60);o=o>l?l:o,Ze(this.tmpRayDir.direction,this.tmpRayDir.direction,o),Qe(r,this.tmpRayDir.origin,this.tmpRayDir.direction);let c=o*i;if(t>0&&c<4&&(c=4,i=c/o),Math.abs(o-c)<1e-6)return;Ze(this.tmpRayDir.direction,this.tmpRayDir.direction,a*(1-i)),Qe(e.eye,e.eye,this.tmpRayDir.direction),Qe(e.center,e.center,this.tmpRayDir.direction)}Mm(this.view,e)}};vv=e([re("esri.views.3d.state.controllers.global.ZoomStepController")],vv);let yv=class extends lg{constructor(){super(...arguments),this.zoomLocation=je(),this.tmpCamera=new rh,this.tmpRayDir=je(),this.tmpCenter=je(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:null,interactionStartCamera:new rh,interactionDirection:null,tiltMode:0}}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r),this.tmpCamera.copyFrom(i.camera);const s=new ih(this.view.state.mode);e>0?(this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:Xe(this.zoomLocation,this.tmpCamera.center);const a=Math.pow(.6,e);if(!ri()&&this.view._stage.getCamera()._contextNavigation){let e=this.view._stage.renderView.getMinimalDepthForArea(t[0],t[1],this.view._stage.getCamera(),60);const i=Math.max(14*Math.abs(this.view.camera.position.z),20);if(e=e?Math.min(e,i):i,e){const t=je();at(t,this.zoomLocation,this.tmpCamera.eye),e<$e(t)&&(nt(t,t),Qe(this.zoomLocation,this.tmpCamera.eye,Ze(t,t,e)))}}this.updateCamera(this.tmpCamera,a,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:.6,easing:sf}}updateCamera(e,t,i){at(this.tmpRayDir,i,e.eye);const r=$e(this.tmpRayDir);let s=r*t;t<=1&&s<4&&(s=4,t=s/r),Math.abs(r-s)<1e-6||(Ze(this.tmpRayDir,this.tmpRayDir,t),at(e.eye,i,this.tmpRayDir),tt(e.center,e.center,i,1-t),wf(this.view,e,this.constraintOptions))}};yv=e([re("esri.views.3d.state.controllers.local.ZoomStepController")],yv);class _v extends ma{constructor(e,t){super(!0),this.view=e,this.registerIncoming("double-click",t,(e=>this.handleDoubleClick(e)))}handleDoubleClick(e){const t=e.data;if(Za(t,"primary")){const i=this.view.state.isGlobal?new vv({view:this.view,mode:"animation"}):new yv({view:this.view,mode:"animation"});this.view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),Vt(t.x,t.y)),e.stopPropagation()}}}let xv=class extends ng{constructor(){super(...arguments),this.beginCamera=new rh,this.currentCamera=new rh}get isInteractive(){return!0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=ag.Running,this.beginCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}};xv=e([re("esri.views.3d.state.controllers.InteractiveController")],xv);let bv=class extends xv{constructor(e){super(e),this.view=null,this.pivot="center",this.lastPoint=cn(),this.tmpWorldUp=je(),this.tmpViewDir=je(),this.tmpRotCurPoint=cn(),this.tmpTransf=jr(),this.tmpAxis=je(),this.tmpPivotPoint=je(),this.pivotPos=je(),this.constraintOptions={selection:15,interactionType:2,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale="center"===this.pivot?3:1.5}begin(e){if(this.active){switch(this.pivot){case"eye":Xe(this.pivotPos,this.beginCamera.eye),this.constraintOptions.interactionType=3,this.constraintOptions.tiltMode=1,this.constraintOptions.selection=0;break;case"center":this.intersectionHelper.intersectRayFreePointFallback(this.beginCamera.ray,this.pivotPos)||Xe(this.pivotPos,this.beginCamera.center),i("disable-feature:context-navigation")||this.constrainPivotPoint(e),this.beginCamera.center=this.pivotPos,this.constraintOptions.interactionType=2,this.constraintOptions.tiltMode=0,this.constraintOptions.selection=11}this.constraintOptions.interactionStartCamera=this.beginCamera,yg(this.beginCamera,e,this.lastPoint)}}constrainPivotPoint(e){const t=this.beginCamera,i=je();let r;at(i,this.pivotPos,t.eye),this.view.camera.position.hasZ&&(r=Math.abs(this.view.camera.position.z));let s=$e(i);this.view.camera.position.hasZ&&s>7*r&&(s=7*r);const a=Kt(this.view.spatialReference),n=Vt(t.width/t.pixelRatio*.5,t.height/t.pixelRatio*.5),o=Lg(this.beginCamera,n,!0,a);let l=this.view._stage.renderView.getMinimalDepthForArea(t.fullWidth/t.pixelRatio*.5,t.fullHeight/t.pixelRatio*.5,t,90,2.5),c=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],t,90);void 0===l&&void 0===c||(l=void 0===l?c:l,c=void 0===c||o===Mg.Horizontal?l:c,s=l>c?c:l),nt(i,i),Xe(this.pivotPos,Qe(this.tmpPivotPoint,t.eye,Ze(this.tmpPivotPoint,i,s)))}update(e){if(!this.active)return;let t;switch(this.pivot){case"eye":t=this.currentCamera.center;break;case"center":this.currentCamera.center=this.pivotPos,t=this.currentCamera.eye}this.applyRotation(this.currentCamera,e,t,this.pivotPos),wf(this.view,this.currentCamera,this.constraintOptions)}end(){this.active&&this.finishController()}applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this.tmpWorldUp),yg(e,t,this.tmpRotCurPoint);let s=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,a=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;at(this.tmpViewDir,i,r);const n=$e(this.tmpViewDir),o=Ie(st(this.tmpViewDir,this.tmpWorldUp)/n);if("eye"===this.pivot){s*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;s=e-Math.max(-t,Math.min(t,e+s))}s=Re(s+o,bu.min,bu.max)-o,Si(this.tmpTransf),Je(this.tmpAxis,e.up,this.tmpViewDir),"center"===this.pivot&&(a=-a),Ri(this.tmpTransf,this.tmpTransf,a,this.tmpWorldUp),Ri(this.tmpTransf,this.tmpTransf,s,this.tmpAxis),it(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),Qe(i,r,this.tmpViewDir),it(e.up,e.up,this.tmpTransf),hs(this.lastPoint,this.tmpRotCurPoint),e.markViewDirty()}};e([S({constructOnly:!0})],bv.prototype,"view",void 0),e([S()],bv.prototype,"pivot",void 0),bv=e([re("esri.views.3d.state.controllers.RotateController")],bv);class wv extends ma{constructor(e,t,i,r){super(!0),this.view=e,this.pointerAction=t,this.pivotPoint=i,this.registerIncoming("drag",r,(e=>this.handleDrag(e)))}handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!Qa(e.data,this.pointerAction))return;const i=Vt(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new bv({view:this.view,pivot:this.pivotPoint}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}let Cv=class extends xv{constructor(e){super(e),this.view=null,this.pickPoint=je(),this.tmpP0=cn(),this.panAxisAngle=Go.create(),this.tmpRayDir=je(),this.targetOnSphere=je(),this.tmpRay={origin:je(),direction:je()},this.dragBeginPoint=Vt(),this.normalizedAnchorPoint=cn(),this.constraintOptions={selection:7,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:0},this.sphere=jo.create(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;hs(this.dragBeginPoint,e),yg(this.beginCamera,e,this.normalizedAnchorPoint);const t=Kt(this.view.spatialReference),r=Ig(this.intersectionHelper,this.beginCamera,e,!1,t);if(this.navMode=Lg(this.beginCamera,e,r.hasGeometryIntersection,t),this.navMode===Mg.Horizontal||i("disable-feature:context-navigation"))this.hasPickPoint=!!r.scenePickPoint,this.pickPoint=r.scenePickPoint,this.sphere=r.sphere;else{let t;ko.fromScreenAtEye(this.beginCamera,e,this.tmpRay),nt(this.tmpRay.direction,this.tmpRay.direction),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=30*t;const r=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view._stage.getCamera(),70);i=i>r?r:i,this.hasPickPoint=!0,Ze(this.tmpRay.direction,this.tmpRay.direction,i),Qe(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.beginCamera}update(e){if(this.active){if(this.currentCamera.eye=this.beginCamera.eye,this.currentCamera.center=this.beginCamera.center,this.currentCamera.up=this.beginCamera.up,this.navMode===Mg.Horizontal||i("disable-feature:context-navigation")){at(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=$e(this.tmpRayDir);yg(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*Math.pow(2,i);const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this.hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this.sphere.radius/$e(this.currentCamera.center));Ze(this.currentCamera.center,this.currentCamera.center,e)}Ze(this.tmpRayDir,this.tmpRayDir,-r/t),Qe(this.currentCamera.eye,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=Cf(this.dragBeginPoint,e),wf(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(zg(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),Go.fromPoints(this.pickPoint,this.targetOnSphere,this.panAxisAngle),xg(this.currentCamera,this.sphere.center,this.panAxisAngle))}else{const t=$e(this.tmpRay.direction);yg(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*Math.pow(2,i);const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;Ze(this.tmpRayDir,this.tmpRay.direction,1-r/t),Qe(this.currentCamera.eye,this.currentCamera.eye,this.tmpRayDir),Qe(this.currentCamera.center,this.currentCamera.center,this.tmpRayDir)}Mm(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};e([S({constructOnly:!0})],Cv.prototype,"view",void 0),Cv=e([re("esri.views.3d.state.controllers.global.ZoomController")],Cv);let Sv=class extends xv{constructor(e){super(e),this.view=null,this.tmpP=je(),this.tmpDir=je(),this.tmpN=je(),this.tmpP0=cn(),this.tmpPoi=je(),this.tmpRayDir=je(),this.dragBeginPoint=Vt(),this.normalizedAnchorPoint=cn(),this.constraintOptions={selection:15,interactionType:1,interactionFactor:0,interactionStartCamera:null,interactionDirection:je(),tiltMode:0},this.plane=Uo.create()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;let t;hs(this.dragBeginPoint,e),yg(this.beginCamera,e,this.normalizedAnchorPoint),this.intersectionHelper.intersectScreenFreePointFallback(e,this.tmpP),at(this.tmpDir,this.tmpP,this.beginCamera.eye),nt(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(t=Math.abs(this.view.camera.position.z));let i=30*t;const r=this.view._stage.renderView.getMinimalDepthForArea(e[0],e[1],this.view._stage.getCamera(),70);i=i>r?r:i,Ze(this.tmpDir,this.tmpDir,i),Qe(this.tmpP,this.beginCamera.eye,this.tmpDir),at(this.tmpN,this.beginCamera.eye,this.beginCamera.center),nt(this.tmpN,this.tmpN),this.tmpN[1]<0&&rt(this.tmpN,this.tmpN),Uo.fromPositionAndNormal(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.beginCamera}update(e){if(!this.active)return;bg(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||Xe(this.tmpPoi,this.currentCamera.center),yg(this.currentCamera,e,this.tmpP0);let t=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);hs(this.normalizedAnchorPoint,this.tmpP0),at(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=$e(this.tmpRayDir);let r=i*(1-t);Xe(this.constraintOptions.interactionDirection,this.tmpRayDir),Ze(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Ee(t)/i);const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||(Ze(this.tmpRayDir,this.tmpRayDir,t),Qe(this.currentCamera.eye,this.currentCamera.eye,this.tmpRayDir),tt(this.currentCamera.center,this.currentCamera.center,this.tmpPoi,t),this.tmpPoi[2]>this.beginCamera.center[2]?this.currentCamera.center[2]=Math.max(this.beginCamera.center[2],this.currentCamera.center[2]):this.currentCamera.center[2]=Math.min(this.beginCamera.center[2],this.currentCamera.center[2]),this.currentCamera.markViewDirty(),this.constraintOptions.interactionFactor=Cf(this.dragBeginPoint,e),wf(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};e([S({constructOnly:!0})],Sv.prototype,"view",void 0),Sv=e([re("esri.views.3d.state.controllers.local.ZoomController")],Sv);class Tv extends ma{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.registerIncoming("drag",i,(e=>this.handleDrag(e)))}handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!Qa(e.data,this.pointerAction))return;const i=Vt(t.center.x,t.center.y);switch(t.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new Cv({view:this.view}):this.cameraController=new Sv({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}e.stopPropagation()}}const Pv=je(),Rv=je();function Mv(){return{direction:je(),up:je()}}function Ov(e,t,i,r,s){let a=Pv;nt(a,e);let n=st(a,r);const o=n>0;n=Math.abs(n),n>.99&&(n=Math.abs(st(t,r)),n<.99?(Xe(a,t),o&&Ze(a,a,-1)):a=null);let l=0;if(a){Ze(Rv,r,st(r,a)),at(a,a,Rv);const e=st(a,s)/($e(a)*$e(s));Je(Rv,a,s);l=(st(Rv,r)>0?1:-1)*Oe(Ie(e))}const c=Oe(Ie(-st(r,e)/$e(e)));return i?(i.heading=l,i.tilt=c,i):{heading:l,tilt:c}}const Dv=ke(0,1,0),Av=ke(0,0,1),Ev=jr(),Iv=je(),Lv=je();function Fv(e,t,i,r=Mv()){Si(Ev);const{direction:s,up:a}=r;return Ci(Ev,Ev,-Me(t)),Ti(Ev,Ev,Me(i)),it(s,Av,Ev),Ze(s,s,-1),it(a,Dv,Ev),r}function Vv(e,t,i,r,s){const a=e.renderSpatialReference,n=e.map&&e.spatialReference||t.spatialReference;return ir(t,Iv,a),ir(t,Lv,a),Iv[0]-=i/2,Lv[0]+=i/2,Iv[1]-=r/2,Lv[1]+=r/2,rr(Iv,a,Iv,n),rr(Lv,a,Lv,n),s?(s.xmin=Iv[0],s.ymin=Iv[1],s.xmax=Lv[0],s.ymax=Lv[1],s.spatialReference=n):s=new Pe(Iv[0],Iv[1],Lv[0],Lv[1],n),s}var zv=Object.freeze({__proto__:null,headingTiltToDirectionUp:Fv,directionToHeadingTilt:function(e,t,i,r){return Ov(t,i,r,Av,Dv)},eyeForCenterWithHeadingTilt:function(e,t,i,r){const s=Fv(0,i,r),a=je();return Ze(a,s.direction,-t),Qe(a,a,e),{up:s.up,eye:a,heading:i,tilt:r}},lookAtTiltToEyeTilt:function(e){return Oe(e)},eyeTiltToLookAtTilt:function(e){return Me(e)},toExtent:Vv});const Uv=ke(0,0,1),kv=nt(je(),ke(1,1,1)),jv=new St(-180,180),Gv=jr(),Bv=je(),Nv=je();function qv(e,t,i,r=Mv()){Je(Bv,e,Uv),0===st(Bv,Bv)&&Je(Bv,e,kv),Si(Gv),Ri(Gv,Gv,-Me(t),e),Ri(Gv,Gv,-Me(i),Bv);const{up:s,direction:a}=r;return Je(s,Bv,e),nt(s,s),it(s,s,Gv),nt(a,e),rt(a,a),it(a,a,Gv),r}function Hv(e){const t=e[1];e[1]=-e[2],e[2]=t}function Wv(e,t){const i=qv(t,e.heading,e.tilt);return e.up=i.up,e}function Zv(e,t,i,r,s){let a,n,o,l;const c=t.latitude,h=t.longitude,d=function(e,t,i){const r=t/i,s=Me(e),a=Math.sin(r/2),n=Math.cos(s),o=2*Ae(Math.sqrt(a*a/(n*n)));return Oe(o)}(c,i,Kt(e.spatialReference).radius)/2;a=h-d,n=h+d;const u=Me(c),p=Kt(e.spatialReference).radius,m=(1+Math.sin(u))/(1-Math.sin(u)),f=(m+1)*Math.tan(r/p/2),g=f*f;function v(e){const t=Math.PI/2;return(e=Tt.normalize(e,-t))>t&&(e=Math.PI-e),e}if(o=1.5*Math.PI-2*Math.atan(.5*(f+Math.sqrt(4*m+g))),l=o+r/p,o=v(o),l=v(l),l<o){const e=l;l=o,o=e}if(o=Math.max(Oe(o),-90),l=Math.min(Oe(l),90),n=jv.monotonic(a,n),n-a>180){const e=(n-a-180)/2;a+=e,n-=e}const y=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:ue.WGS84;return s?(s.xmin=a,s.ymin=o,s.xmax=n,s.ymax=l,s.spatialReference=y):s=new Pe(a,o,n,l,y),e.spatialReference&&e.spatialReference.isWebMercator&&Ce(s,!1,s),s}var Qv=Object.freeze({__proto__:null,headingTiltToDirectionUp:qv,directionToHeadingTilt:function(e,t,i,r){const s=Bv,a=Nv;return nt(s,e),Je(Nv,s,Uv),0===st(Nv,Nv)&&Je(Nv,s,kv),Je(a,Nv,s),Ov(t,i,r,s,a)},eyeForCenterWithHeadingTilt:function(e,t,i,r){const s={eye:je(),up:null,tilt:r,heading:i},a=Bv;a[0]=e[0],a[1]=e[2],a[2]=-e[1];const n=t,o=Me(i),l=Me(r),c=Math.sin(o),h=Math.cos(o),d=Math.sin(l),u=Math.cos(l),p=$e(a);let m;if(Math.abs(l)<1e-8)m=n+p;else{const e=p/d,t=Ae(n/e),i=Math.PI-l-t;m=e*Math.sin(i)}const f=u*n,g=n*n*(d*d),v=h*h*g,y=m-f,_=y*y,x=v*(v+_-a[1]*a[1]);if(x<0)return Ze(s.eye,a,m/p),s.tilt=0,s;const b=Math.sqrt(x),w=a[1]*y,C=v+_;let S;if(S=h>0?-b+w:b+w,Math.abs(C)<1e-8)return p<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=n):Ze(s.eye,a,m/p),s.tilt=0,Hv(s.eye),Wv(s,e);s.eye[1]=S/C;const T=c*c*g,P=d*n,R=h*P*s.eye[1],M=s.eye[1]*s.eye[1],O=1-M,D=Math.sqrt(O),A=v*M+T-2*R*D*y+O*_;return Math.abs(A)<1e-8?(Ze(s.eye,a,m/p),s.tilt=0,Hv(s.eye),Wv(s,e)):(s.eye[0]=(O*(m*a[0]-f*a[0])-P*D*(a[0]*s.eye[1]*h+a[2]*c))/A,s.eye[2]=(O*(m*a[2]-f*a[2])-P*D*(a[2]*s.eye[1]*h-a[0]*c))/A,Ze(s.eye,s.eye,m),Hv(s.eye),Wv(s,e))},lookAtTiltToEyeTilt:function(e,t,i){const r=$e(t),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),a=Ae(i/(s/Math.sin(e)));return Oe(e-a)},eyeTiltToLookAtTilt:function(e,t,i){const r=Me(e),s=$e(t);return Ae(i/(s/Math.sin(r)))+r},toExtent:Zv});const Yv=d.getLogger("esri.views.3d.support.cameraUtils"),$v=je(),Xv=je(),Kv=je(),Jv={heading:0,tilt:0},ey=new _e,ty=new St(-20037508.342788905,20037508.342788905),iy=new St(-180,180);function ry(e){return e.spatialReference||ue.WGS84}function sy(e){return"global"===e.viewingMode?Qv:zv}function ay(e,t){const i=e.renderSpatialReference,r=sy(e).headingTiltToDirectionUp,s=je();if(!ir(t.position,s,i))return null;const a=r(s,t.heading,t.tilt);Ze(a.direction,a.direction,e.state.camera.distance),Qe(a.direction,a.direction,s);const n=bm(e,s,a.direction,a.up);return n.fov=Me(t.fov),n}const ny=je();function oy(e,t,i){const r=e.renderSpatialReference,s=Xe(Kv,t.viewForward),a=uy(e,t.eye,s,t.up,Jv);let n=ry(e);return rr(t.eye,r,ny,n)||(n=ue.WGS84,rr(t.eye,r,ny,n)),u(i)?new Dt(new _e(ny,n),a.heading,a.tilt,Oe(t.fov)):(i.position.x=ny[0],i.position.y=ny[1],i.position.z=ny[2],i.position.spatialReference=n,i.heading=a.heading,i.tilt=a.tilt,i.fov=Oe(t.fov),i)}function ly(e,t,i){const r=e.state.camera,s=r.fovX,a=r.width/2/r.pixelRatio;"global"===e.viewingMode&&null!=i&&(t*=Math.cos(Me(i)));return a/(3779.5199999999995/(t/=e.renderCoordsHelper.unitInMeters))/Math.tan(s/2)}function cy(e,t,i){const r=e.state.camera,s=r.fovX,a=t*Math.tan(s/2);let n=3779.5199999999995/(r.width/2/r.pixelRatio/a);return"global"===e.viewingMode&&(n/=Math.cos(Me(i))),n*=e.renderCoordsHelper.unitInMeters,n}function hy(e,t,i,r,s,a){return dy(e,t,ly(e,i,t.latitude),r,s,a)}function dy(e,t,i,r,s,a){if(wy(a)){const n=new by(a.signal);return py(e,r.heading,r.tilt,t,i,s,n),void n.resolver.promise.then((t=>{const i=yy(e,t,r.fov);if(!u(i))return a.resolver.resolve(i);a.resolver.reject()}),(e=>a.resolver.reject(e)))}const n=py(e,r.heading,r.tilt,t,i,s);return yy(e,n,r.fov,a)}function uy(e,t,i,r,s){return sy(e).directionToHeadingTilt(t,i,r,s)}function py(e,t,i,r,s,a,n){const o=r&&r instanceof _e?r:null;if(wy(n))return async function(e,t,i){const r=je();if(t)if(t instanceof _e){if(ir(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const s=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",i);return null!=s&&e.renderCoordsHelper.setAltitude(s,r),r}}else Xe(r,t);else Xe(r,e.state.camera.center);return r}(e,r,n.signal).then((r=>{my(e,t,i,o,r,s,a,n)}),(e=>n.resolver.reject(e))),null;const l=function(e,t){const i=je();if(t&&t instanceof _e){if(ir(t,i,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=Aa(e.elevationProvider,t);null!=r&&e.renderCoordsHelper.setAltitude(r,i)}}else Xe(i,t||e.state.camera.center);return i}(e,r);return my(e,t,i,o,l,s,a,n)}function my(e,t,i,r,s,a,n,o){if(!r){const t=e.renderSpatialReference,i=ry(e);if(!(r=sr(s,t,i)))return null}a=Math.max(a,e.state.constraints.minimumPoiDistance);const l=function(e,t,i,r,s,a){let n=0;1===a&&function(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>8)return!0;const s=e.renderSpatialReference,a=ry(e),n=sr(t,s,a),o=sr(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,a);if(u(n)||u(o))return!1;const l=Math.tan(.5*e.state.camera.fov)*r;return o.distance(n)/l>5}(e,r,s)?(t=0,n=function(e,t,i,r){const s=e.state.constraints.tilt(t);s.max=Math.min(s.max,.5*Math.PI);const a=s.min*(1-.7)+.7*s.max,n=vy(e,r,t,i);return Math.min(n,a)}(e,s,i,r)):n=vy(e,r,s,i);return n=e.state.constraints.clampTilt(s,n),i=gy(e,r,s,n),{heading:t,tilt:i}}(e,t,i,s,a,n),c=(0,sy(e).eyeForCenterWithHeadingTilt)(s,a,l.heading,l.tilt);if(1===n&&"global"===e.viewingMode&&i>0){const l=()=>{const l=gy(e,s,a,function(e,t,i,r){const s=e.state.constraints.tilt(t);let a=vy(e,r,t,i);return a=Math.min(a,.5*Math.PI),s.min*(1-.7)+.7*a}(e,a,i,s));return my(e,t,l,r,s,a,n=i-l<1?0:1,o)},h=e.map.ground.navigationConstraint;if(!h||"stay-above"===h.type){if(function(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,ey,e.spatialReference)&&Aa(e.elevationProvider,ey)>ey.z-1)}(e,c.eye))return l();if(wy(o))return async function(e,t,i){return!!e.renderCoordsHelper.fromRenderCoords(t,ey,e.spatialReference)&&await e.elevationProvider.queryElevation(ey.x,ey.y,ey.z,ey.spatialReference,"ground",i)>ey.z-1}(e,c.eye,o.signal).then((e=>e?l():(o.resolver.resolve({eye:c.eye,up:c.up,center:Ue(s),heading:c.heading,tilt:c.tilt}),null))),null}}const h=!o||wy(o)?{center:je(),eye:je(),up:je(),tilt:0,heading:0}:o;return h.eye=c.eye,h.up=c.up,h.center=Ue(s),h.heading=c.heading,h.tilt=c.tilt,wy(o)&&o.resolver.resolve(h),h}function fy(e,t,i,r,s,a=null){let n,o,l,c,h=0;null!=t.zmax&&null!=t.zmin&&(n=(t.zmax+t.zmin)/2,h=t.zmax-t.zmin);if("global"===e.viewingMode){if(!mr(t.spatialReference,"global"))return wy(a)&&a.resolver.reject(),null;const e=new _e(t.xmin,t.ymin,t.spatialReference),i=new _e(t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?iy:ty;o=new _e(r.center(e.x,i.x),(i.y+e.y)/2,t.spatialReference),null!=n&&(o.z=n);const s=Kt(t.spatialReference),h=function(e,t,i){const r=t.spatialReference,s=Kt(r),a=new _e(t.x,e.y,r),n=new _e(i.x,e.y,r),o=new _e(e.x,t.y,r),l=new _e(e.x,i.y,r);return{lon:Up(s.radius,a,n),lat:Up(s.radius,o,l)}}(o,e,i);l=h.lon,c=h.lat,r.diff(e.x,i.x)>r.range/2&&(l+=s.halfCircumference),l=Math.min(l,s.halfCircumference),c=Math.min(c,s.halfCircumference)}else{const i=ry(e);l=t.xmax-t.xmin,c=t.ymax-t.ymin,o=new _e({x:t.xmin+.5*l,y:t.ymin+.5*c,z:n,spatialReference:i})}const d=e.state.camera,p=1/Math.tan(d.fovX/2),m=1/Math.tan(d.fovY/2),f=1/Math.tan(d.fov/2),g=Math.max(.5*l*p,.5*c*m,.5*h*f)/1;if(wy(a)){const t=new by(a.signal);return py(e,i,r,o,g,s,t),void t.resolver.promise.then((t=>{const i=yy(e,t,e.camera.fov);if(!u(i))return a.resolver.resolve(i);a.resolver.reject()}),(e=>a.resolver.reject(e)))}const v=py(e,i,r,o,g,s);return yy(e,v,e.camera.fov,a)}function gy(e,t,i,r){return sy(e).lookAtTiltToEyeTilt(r,t,i)}function vy(e,t,i,r){return sy(e).eyeTiltToLookAtTilt(r,t,i)}function yy(e,t,i,r){if(u(t))return null;const s=e.renderSpatialReference,a=ry(e),n=sr(t.eye,s,a);return u(n)?null:h(r)?(r.position=n,r.heading=t.heading,r.tilt=t.tilt,r.fov=i,r):new Dt(n,t.heading,t.tilt,i)}function _y(e,t){const i=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(i)return i.scaleAtLevel(t);Yv.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function xy(e,t,i){const r=e.renderSpatialReference;let s,a;t||(t=e.state.camera);const n=ue.WGS84;return t instanceof Dt?(s=t.position.latitude,ir(t.position,$v,r),ir(i,Xv,r),a=Ke($v,Xv)):(rr(t.center,r,Xv,n),s=Xv[1],a=t.distance),cy(e,a,s)}class by{constructor(e){this.signal=e,this.resolver=V()}}function wy(e){return e&&"resolver"in e}let Cy=class extends xv{constructor(e){super(e),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new rh,this.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new rh,interactionFactor:0,interactionDirection:null,tiltMode:1}}handleEventGamepad(e){const t=Ya(e,this.view.navigation.gamepad,this.transformation);("end"===e.action||$a(t))&&this.finishController()}activateDirection(e){this.keysButtonState[e]=1,Xa(this.keysButtonState,this.transformation)}deactivateDirection(e){this.keysButtonState[e]=0;const t=Xa(this.keysButtonState,this.transformation);$a(t)&&this.finishController()}onControllerStart(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(e)}updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this.filteredSurfaceElevation+=1*(t-this.filteredSurfaceElevation)*e}stepController(e,t){this.updateStartHeading(),this.updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(e,this.currentCamera,Ay),this.applyDisabledMovementTypes(Ay),this.applyPan(Ay.pan),this.applyRotate(Ay.rotate),this.applyZoom(Ay.zoom),this.applyAscend(Ay.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,wf(this.view,this.currentCamera,this.constraintOptions),super.stepController(e,t)}updateStartHeading(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)}applyRotate(e){if(!e.enabled)return;const t=this.currentCamera,{center:i,up:r,eye:s}=t;at(i,i,s),it(i,i,e.matrix),Qe(i,i,s),it(r,r,e.matrix),t.markViewDirty(),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,wf(this.view,t,this.constraintOptions)}applyPan(e,t=this.currentCamera){if(!e.enabled)return;const{center:i,eye:r,up:s}=t;it(r,r,e.matrix),it(i,i,e.matrix);this.view.state.isGlobal&&it(s,s,e.matrix),t.markViewDirty(),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,wf(this.view,t,this.constraintOptions)}applyZoom(e){if(!e)return;const{eye:t,viewForward:i}=this.currentCamera;Qe(t,t,Ze(No.get(),i,e)),this.currentCamera.markViewDirty(),Xe(Ey,i),rt(Ey,Ey),this.constraintOptions.interactionDirection=Ey,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,wf(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}applyAscend(e){if(!e)return;const{center:t,eye:i}=this.currentCamera,r=this.view.renderCoordsHelper.worldUpAtPosition(i,No.get());this.constraintOptions.interactionDirection=Xe(Ey,r);if(this.view.state.isGlobal){const r=$e(i),s=(r+e)/r;Ze(i,i,s),Ze(t,t,s)}else{const s=Ze(No.get(),r,e);Qe(i,i,s),Qe(t,t,s)}this.currentCamera.markViewDirty(),this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,wf(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,wf(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,Si(e.pan.matrix),e.rotate.enabled=!1,Si(e.rotate.matrix)}(i);const r=this.computeVelocities(e);this.view.state.isLocal?this.calculateControlTransformationLocal(r,t,i):this.calculateControlTransformationGlobal(r,t,i)}updateCameraCenter(){const{ray:e,center:t}=this.currentCamera,i=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(e,i,t),this.currentCamera.markViewDirty()}calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,a=this.transformation,n=this.view.navigation.gamepad,o=Ye(No.get(),s[0],s[1],0);nt(o,o);const l=a.translation[0]*e.pan;if(0!==l){const e=Ze(No.get(),r,l);Mi(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(n.mode){case"pan":{const t=-a.translation[1]*e.pan;if(0!==t){const e=Ze(No.get(),o,t);Mi(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=a.zoom*e.zoom;break}case"zoom":i.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:te(n.mode)}const c=a.translation[2]*e.ascend;i.ascend=c;const h=-a.heading*e.rotate;0!==h&&(Ri(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,No.get())),i.rotate.enabled=!0);const d=a.tilt*e.rotate,u=Dm(this.view.renderCoordsHelper,t.center,t.eye),p=Re(u+d,bu.min,bu.max)-u;p&&(Ri(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,a=this.transformation,n=this.view.navigation.gamepad,o=Je(No.get(),s,r);nt(o,o),rt(o,o),Yg(this.beginCamera,t,a,e,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,n),this.tmpCamera.copyFrom(this.currentCamera),this.applyPan(Ay.pan,this.tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=a.translation[2]*e.ascend;i.ascend=c;const h=-a.heading*e.rotate;0!==h&&(Ri(i.rotate.matrix,i.rotate.matrix,h,this.tmpCamera.eye),i.rotate.enabled=!0);const d=a.tilt*e.rotate,u=this.clampTiltDeltaGlobalToValidRange(d,t.ray,l);0!==u&&(Ri(i.rotate.matrix,i.rotate.matrix,u,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom=a.zoom*e.zoom}clampTiltDeltaGlobalToValidRange(e,t,i){const r=Kt(this.view.spatialReference),s=Pg(bu.min,t.origin,i,r);let a=0,n=0;const o=No.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,o)){a=Pg(Dm(this.view.renderCoordsHelper,o,t.origin),t.origin,i,r),n=Pg(bu.max,t.origin,i,r)}else{jo.closestPointOnSilhouette(jo.wrap(i+r.radius),t,o);a=Rg(Ie(-st(t.direction,nt(o,o))),t.origin,i,r),n=Rg(bu.max,t.origin,i,r)}return Re(a+e,s,n)-a}getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),a=t+Math.abs(s-t);return Xe(i,e),r.setAltitude(a,i),a}clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=(a=this.view,n=t,o=0,l=Ty,c=Iy,sy(a).headingTiltToDirectionUp(n,o,l,c));var a,n,o,l,c;const h=i.intersectManifoldClosestSilhouette(ko.wrap(t,s),e,No.get()),d=Ke(t,h),u=i.intersectManifoldClosestSilhouette(ko.wrap(t,xt(No.get(),t,r.center)),e,No.get()),p=Ke(t,u);return Math.min(d,p)}computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,a=t.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,No.get());if(s){const t=at(No.get(),e,a),i=$e(t);Ze(t,t,1/i);const r=nt(No.get(),e),s=Ie(st(r,t));return i*Math.sin(Math.min(Py,s))}{const i=Xe(No.get(),e);return t.setAltitude(this.filteredSurfaceElevation,i),Ke(a,i)}}minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:My}computeVelocities(e){const t=this.filteredSurfaceElevation,i=t+Kt(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,a=No.get(),n=this.getPointAbsoluteSurfaceElevation(r.eye,t,a),o=this.clampedDistanceToSurface(t,a),l=r.width/2,c=Ry*r.width,h=Ry*r.width,d=o*Math.tan(.5*r.fovX)/l,u=d/i,p=d/this.computeHeadingRotateRadius(a),m=n-t;return{pan:(s?u:d)*c*e,ascend:Math.max(this.minimumAscendVelocity()*e,Math.pow(2,c*e/l)*m-m),zoom:Math.pow(2,c*e/l)*o-o,rotate:Re(p*h,Oy,Dy)*e}}applyDisabledMovementTypes(e){!h(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.mode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Si(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Si(e.rotate.matrix))}static activatesFor(e,t){const i=Ya(t,e.navigation.gamepad,Sy);return!("end"===t.action||$a(i))}};e([S({constructOnly:!0})],Cy.prototype,"view",void 0),e([S({constructOnly:!0})],Cy.prototype,"gamepadDevice",void 0),e([S({constructOnly:!0})],Cy.prototype,"disableMovements",void 0),Cy=e([re("esri.views.3d.state.controllers.GamepadKeyboardController")],Cy);const Sy={translation:[0,0,0],heading:0,tilt:0,zoom:0},Ty=80,Py=Me(Ty),Ry=.75,My=5,Oy=Me(30),Dy=Me(80),Ay={zoom:0,ascend:0,pan:{enabled:!1,matrix:jr()},rotate:{enabled:!1,matrix:jr()}},Ey=je(),Iy=Mv();class Ly extends ma{constructor(e){super(!0),this.view=e,this.watchHandles=new $t,this.handle=this.registerIncoming("gamepad",(e=>this.handleEventGamepad(e))),this.handle.pause()}onInstall(e){super.onInstall(e),this.watchHandles.add([hi(this.view.navigation.gamepad,"enabled",(e=>{e?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))})),this.view.navigation.gamepad.watch("device",(e=>{this.cameraControllerGamepad&&e&&this.cameraControllerGamepad.gamepadDevice!==e&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)}))])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}handleEventGamepad(e){const t=this.view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(i||Cy.activatesFor(this.view,e.data)){if(!i){const t=new Cy({view:this.view,gamepadDevice:e.data.device});this.view.state.switchCameraController(t)&&(this.cameraControllerGamepad=t)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===e.data.device&&this.cameraControllerGamepad.handleEventGamepad(e.data)}}}class Fy extends ma{constructor(e,t){super(!0),this.view=e,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this.keyToNumber={[t.left]:0,[t.right]:1,[t.forward]:2,[t.backward]:3,[t.up]:4,[t.down]:5,[t.headingLeft]:6,[t.headingRight]:7,[t.tiltUp]:8,[t.tiltDown]:9,[t.zoomIn]:10,[t.zoomOut]:11},this.registerIncoming("key-down",null,(e=>this.handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this.handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this.handleBlur()))}handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new Cy({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this.keyToNumber[e.data.key];null!=t&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}class Vy extends ma{constructor(e,t){super(!0),this.view=e,this.registerIncoming("mouse-wheel",t,(e=>this.handleMouseWheel(e)))}handleMouseWheel(e){if(!this.view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new vv({view:this.view,mode:"interaction"}):new yv({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*t.deltaY,Vt(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}class zy{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let Uy=class extends og{constructor(e){super(e),this.view=null,this.beginCamera=new rh,this.elapsedTimeSec=0,this.constraintOptions={selection:15,interactionType:4,interactionFactor:0,interactionStartCamera:new rh,interactionDirection:null,tiltMode:0}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ln}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(e){this.beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=e,this.momentumStep(this.elapsedTimeSec,t),wf(this.view,t,this.constraintOptions)}};e([S({constructOnly:!0})],Uy.prototype,"view",void 0),Uy=e([re("esri.views.3d.state.controllers.momentum.MomentumController")],Uy);let ky=class extends Uy{constructor(e){super(e),this.interactionType=4,this.tmpPan=je()}momentumStep(e,t){const i=this.momentum.value(e);Ze(this.tmpPan,this.momentum.direction,i),at(t.eye,t.eye,this.tmpPan),at(t.center,t.center,this.tmpPan),t.markViewDirty(),this.constraintOptions.interactionDirection=this.tmpPan}};e([S({constructOnly:!0})],ky.prototype,"momentum",void 0),ky=e([re("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],ky);const jy=je(),Gy=je();let By=class extends Uy{constructor(e){super(e),this.interactionType=4}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);Xe(Gy,t.eye),nt(Gy,Gy),Je(this.momentum.axis2,Gy,this.momentum.axis1),Hg(t,jy,this.momentum.axis1,i,this.momentum.axis2,r)}};e([S({constructOnly:!0})],By.prototype,"momentum",void 0),By=e([re("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],By);let Ny=class extends Uy{constructor(e){super(e),this.interactionType=2}set center(e){this._set("center",Ue(e))}set axis(e){this._set("axis",Ue(e))}momentumStep(e,t){const i=this.momentum.value(e);xg(t,this.center,Go.wrapAxisAngle(this.axis,i))}};e([S({constructOnly:!0})],Ny.prototype,"momentum",void 0),e([S({constructOnly:!0})],Ny.prototype,"center",null),e([S({constructOnly:!0})],Ny.prototype,"axis",null),Ny=e([re("esri.views.3d.state.controllers.momentum.MomentumController")],Ny);let qy=class extends Uy{constructor(e){super(e),this.interactionType=1,this.constraintOptions.interactionDirection=je()}set zoomCenter(e){this._set("zoomCenter",Ue(e))}momentumStep(e,t){Xe(this.constraintOptions.interactionDirection,t.eye);const i=this.momentum.valueDelta(0,e);wg(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=xt(this.constraintOptions.interactionDirection,t.eye,this.constraintOptions.interactionDirection)}};e([S({constructOnly:!0})],qy.prototype,"momentum",void 0),e([S({constructOnly:!0})],qy.prototype,"zoomCenter",null),qy=e([re("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],qy);let Hy=class extends Uy{constructor(e){super(e),this.interactionType=1,this.radius=0,this.tmpSceneCenter=je(),this.tmpZoomAxisAngle=Go.create(),this.sphere=jo.create()}set screenCenter(e){this._set("screenCenter",Vt(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Ue(e))}initialize(){this.sphere.radius=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);Cg(this.sphere,t,i),this.constraintOptions.interactionType=1,wf(this.view,t,this.constraintOptions),zg(this.sphere,t,this.screenCenter,this.tmpSceneCenter),Go.fromPoints(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),xg(t,this.sphere.center,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=4}};e([S({constructOnly:!0})],Hy.prototype,"momentum",void 0),e([S({constructOnly:!0})],Hy.prototype,"screenCenter",null),e([S({constructOnly:!0})],Hy.prototype,"sceneCenter",null),e([S({constructOnly:!0})],Hy.prototype,"radius",void 0),Hy=e([re("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Hy);class Wy{constructor(e){this.gain=e}update(e){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}class Zy extends ah{constructor(e,t,i,r,s,a=0,n){super(e,t,i),this.angularVelocity1=r,this.axis1=s,this.angularVelocity2=a,this.axis2=n}value1(e){return super.valueFromInitialVelocity(this.angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class Qy{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.tmpAxis1=je(),this.tmpAxis2=je(),this.tmpAngles=cn(),this.time=new sh(.3),this.screen=[new sh(.4),new sh(.4)],this.angle1=new Wy(.6),this.angle2=new Wy(.6),this.axis1=je(),this.axis2=je(),this.lastScene=je()}addMomentumDirectRotation(e,t,i,r,s,a){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;let e=Gg(this.lastScene,t,this.tmpAxis2,r,s,a);this.angle2.update(0),et(this.tmpAxis2)<1e-5?e=0:nt(this.axis1,this.tmpAxis2),this.angle1.update(e),Xe(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}addMomentumPreserveHeading(e,t,i,r,s,a,n){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;qg(this.lastScene,t,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,r,s,a,n,!1),et(this.tmpAxis2)<1e-5?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),nt(this.axis1,this.tmpAxis1),nt(this.axis2,this.tmpAxis2)),Xe(this.lastScene,t)}this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){const r=this.angle1.filteredValue/this.time.filteredDelta,s=this.angle2.filteredValue/this.time.filteredDelta;return new Zy(e,t,i,r,this.axis1,s,this.axis2)}}let Yy=class extends xv{constructor(e){super(e),this.view=null,this.smoothRotation=new zy(.05),this.rotationAxis=je(),this.panningPlane=Uo.create(),this.smoothScaling=new zy(.05),this.zoomCenterScreen=Vt(),this.zoomMomentumEstimator=new nh,this.rotationMomentumEstimator=new oh,this.panSphericalMomentumEstimator=new Qy,this.panPlanarMomentumEstimator=new lh,this.adjustedSphere=jo.create(),this.tmp3d=je(),this.tmpScreenPointArray=Vt(),this.beginScreenPoint=Vt(),this.beginScenePoint=je(),this.screenPickPoint=Vt(),this.navMode=Mg.Horizontal,this.tmpInteractionDirection=je(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new rh,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panPlanarMomentumEstimator.enabled=t,this.panSphericalMomentumEstimator.enabled=t,this.beginHeading=-Ct.normalize(Me(this.view.camera.heading)),this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.smoothRotation.reset(),zt(e.center,this.screenPickPoint),hs(this.beginScreenPoint,this.screenPickPoint);const i=Kt(this.view.spatialReference),r=Ig(this.intersectionHelper,this.beginCamera,this.screenPickPoint,!0,i);this.scenePickPoint=r.scenePickPoint,this.sphere=r.sphere,Xe(this.beginScenePoint,this.scenePickPoint),this.navMode=Lg(this.beginCamera,this.screenPickPoint,r.hasGeometryIntersection,i),this.navMode===Mg.Vertical&&this.preparePlanarPanMode(e),this.constraintOptions.interactionStartCamera.copyFrom(this.beginCamera)}preparePlanarPanMode(e){const t=rt(this.tmp3d,this.beginCamera.viewForward);Uo.fromPositionAndNormal(this.scenePickPoint,t,this.panningPlane);const i=Vt(this.screenPickPoint[0],0),r=je(),s=$e(this.beginCamera.eye);this.adjustedSphere.radius=s<this.sphere.radius?s-100:this.sphere.radius,zg(this.adjustedSphere,this.beginCamera,i,r);const a=Ut();this.beginCamera.projectToRenderScreen(r,a);const n=.9*a[1];if(this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],n),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&Uo.fromPositionAndNormal(this.scenePickPoint,Uo.normal(this.panningPlane),this.panningPlane),!ri()&&this.view._stage.getCamera()._contextNavigation){const e=je(),t=je(),i=je(),r=80,s=5,a=50;at(e,this.scenePickPoint,this.currentCamera.eye),nt(e,e);const n=s*Math.max(Math.abs(this.view.camera.position.z),a),o=this.view._stage.renderView.getMinimalDepthForArea(this.screenPickPoint[0],this.screenPickPoint[1],this.view._stage.getCamera(),r),l=o?Math.min(o,n):n;Xe(i,Qe(t,this.currentCamera.eye,Ze(t,e,l))),this.panningPlane[3]=-st(this.panningPlane,i)}const o=zt(e.center,this.tmpScreenPointArray);bg(this.panningPlane,this.beginCamera,o,this.beginScenePoint)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.beginCamera);const t=e.pointers.size>1;this.navMode===Mg.Horizontal?(t&&this.zoomSpherical(e),this.panningSpherical(e),t&&this.rotateSpherical(e)):(t&&this.zoomPlanar(e),this.panningPlanar(e),t&&this.rotatePlanar(e)),this.currentCamera.markViewDirty()}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return this.navMode===Mg.Horizontal?new Hy({view:this.view,momentum:t,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere.radius}):new qy({view:this.view,momentum:t,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new Ny({view:this.view,momentum:i,center:this.sphere.center,axis:this.rotationAxis});if(this.navMode===Mg.Horizontal){const e=this.panSphericalMomentumEstimator.evaluateMomentum();if(e)return new By({view:this.view,momentum:e})}else{const e=this.panPlanarMomentumEstimator.evaluateMomentum();if(e)return new ky({view:this.view,momentum:e})}return null}zoomSpherical(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),Cg(this.sphere,this.currentCamera,this.smoothScaling.value),zt(e.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Cf(e.radius-this.beginRadius),wf(this.view,this.currentCamera,this.constraintOptions)}panningSpherical(e){const t=zt(e.center,this.tmpScreenPointArray);zg(this.sphere,this.currentCamera,t,this.tmp3d),Wg(this.beginScenePoint,st(this.currentCamera.up,this.beginScenePoint),this.sphere.radius,this.beginHeading,this.view.camera.tilt,this.beginCamera)?(Qg(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this.tmp3d,.001*e.timestamp,this.beginCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(Zg(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(t,this.tmp3d,.001*e.timestamp,this.beginCamera,this.sphere.radius,this.view.camera.tilt)),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Cf(this.screenPickPoint,t),wf(this.view,this.currentCamera,this.constraintOptions)}rotateSpherical(e){nt(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||rt(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value,i=t+_g(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=r,this.smoothRotation.update(i);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*e.timestamp),xg(this.currentCamera,this.sphere.center,Go.wrapAxisAngle(this.rotationAxis,s)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Cf(e.radius*i),wf(this.view,this.currentCamera,this.constraintOptions)}panningPlanar(e){const t=zt(e.center,this.tmpScreenPointArray);bg(this.panningPlane,this.currentCamera,t,this.tmp3d)&&(Fg(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(t,this.tmp3d,.001*e.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Cf(this.beginScreenPoint,t),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),wf(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}zoomPlanar(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),wg(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Cf(e.radius-this.beginRadius),wf(this.view,this.currentCamera,this.constraintOptions)}rotatePlanar(e){Xe(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||rt(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value;let i=e.angle-t;i=_g(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(r);const a=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(a,.001*e.timestamp),xg(this.currentCamera,this.sphere.center,Go.wrapAxisAngle(this.rotationAxis,a)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Cf(e.radius*a),wf(this.view,this.currentCamera,this.constraintOptions)}};e([S({constructOnly:!0})],Yy.prototype,"view",void 0),Yy=e([re("esri.views.3d.state.controllers.global.PinchAndPanController")],Yy);const $y=ke(0,0,1),Xy=16/180*Math.PI;let Ky=class extends xv{constructor(e){super(e),this.view=null,this.rotationValueSmooth=new zy(.05),this.scalingValueSmooth=new zy(.05),this.planeHorizontal=Uo.create(),this.planeVertical=Uo.create(),this.rotationMomentumEstimator=new oh,this.panMomentumEstimator=new lh(300,12,.9),this.zoomMomentumEstimator=new nh,this.beginCenter=je(),this.tmpPoints=[],this.beginCenterScreen=Vt(),this.tmpCentroid3d=je(),this.tmpCentroid2d=Vt(),this.tmp2d=Vt(),this.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new rh,interactionDirection:null,tiltMode:0}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panMomentumEstimator.enabled=t,this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),zt(e.center,this.beginCenterScreen),Uo.fromNormalAndOffset($y,0,this.planeHorizontal);const i=je();this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i);const r=je();rt(r,this.beginCamera.viewForward);const s=je();Xe(s,$y);const a=st(r,s),n=Ae(a<0?-a:a);if(this.panMode=n>=Xy?Mg.Horizontal:Mg.Vertical,Uo.setOffsetFromPoint(this.planeHorizontal,i,this.planeHorizontal),this.beginCamera.aboveGround||Uo.negate(this.planeHorizontal,this.planeHorizontal),this.panMode===Mg.Vertical){if(Ze(s,s,a),at(this.planeVertical,r,s),nt(this.planeVertical,this.planeVertical),Uo.setOffsetFromPoint(this.planeVertical,i,this.planeVertical),!ri()&&this.view._stage.getCamera()._contextNavigation){const e=je(),t=je(),r=je();at(e,i,this.currentCamera.eye),nt(e,e);const s=5*Math.max(Math.abs(this.view.camera.position.z),50),a=this.view._stage.renderView.getMinimalDepthForArea(this.beginCenterScreen[0],this.beginCenterScreen[1],this.view._stage.getCamera(),80),n=a?Math.min(a,s):s;Xe(r,Qe(t,this.currentCamera.eye,Ze(t,e,n))),this.planeVertical[3]=-st(this.planeVertical,r)}this.computePlanePoints(e.pointers,this.planeVertical,this.beginCamera,this.tmpPoints),Tg(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(e.pointers,this.planeHorizontal,this.beginCamera,this.tmpPoints),Tg(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.beginCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.beginCamera);const t=e.pointers.size>1,i=this.panMode===Mg.Horizontal?this.planeHorizontal:this.planeVertical,r=this.beginCenter;if(t){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.scalingValueSmooth.gain=i,this.scalingValueSmooth.update(t),wg(this.currentCamera,r,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*e.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=Cf(Math.abs(e.radius-this.beginRadius)),wf(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(e.pointers,i,this.currentCamera,this.tmpPoints),Tg(this.tmpPoints,this.tmpCentroid3d),zt(e.center,this.tmpCentroid2d),Fg(this.currentCamera,r,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*e.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=Cf(this.beginCenterScreen,this.tmpCentroid2d),wf(this.view,this.currentCamera,this.constraintOptions),t){const t=this.planeHorizontal,i=r,s=this.rotationValueSmooth.value,a=s+_g(e.angle-s),n=.00125*Math.min(Math.max(e.radius,40),120);this.rotationValueSmooth.gain=n,this.rotationValueSmooth.update(a);const o=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(o,.001*e.timestamp),xg(this.currentCamera,i,Go.wrapAxisAngle(t,o)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=Cf(Math.abs(e.radius*o)),wf(this.view,this.currentCamera,this.constraintOptions)}this.currentCamera.markViewDirty()}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return new qy({view:this.view,momentum:t,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new Ny({view:this.view,momentum:i,center:this.beginCenter,axis:Uo.normal(this.planeHorizontal)});const r=this.panMomentumEstimator.evaluateMomentum();return r?new ky({view:this.view,momentum:r}):null}computePlanePoints(e,t,i,r){r.length=e.size;const s=this.tmp2d;let a=0;return e.forEach((e=>{s[0]=e.x,s[1]=e.y,void 0===r[a]&&(r[a]=je()),bg(t,i,s,r[a]),a+=1})),r}};e([S({constructOnly:!0})],Ky.prototype,"view",void 0),Ky=e([re("esri.views.3d.state.controllers.local.PinchAndPanController")],Ky);class Jy extends ma{constructor(e,t,i){super(!0),this.view=e,this.pointerAction=t,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",i,(e=>this.handleDrag(e)))}handleDrag(e){if("mouse"===e.data.pointerType&&!Qa(e.data,this.pointerAction))return;const t=e.timestamp-this.lastEndTimestamp,i=this.momentum&&this.momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this.controller&&this.controller.active?e.data.timestamp-this.lastTimestamp>2&&(this.controller.update(e.data),this.lastTimestamp=e.timestamp):this.startController(e);break;case"end":case"removed":this.endController(e,!0);break;case"added":this.endController(e,!1),this.startController(e)}e.stopPropagation()}endController(e,t){if(this.controller&&this.controller.active){this.lastEndTimestamp=e.timestamp;const i=this.controller.end(e.data);t&&i&&(this.momentum=i,this.view.state.switchCameraController(this.momentum))}this.controller=null}startController(e){this.controller=this.createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(e.data),this.lastTimestamp=e.timestamp}createController(){return this.view.state.isGlobal?new Yy({view:this.view}):new Ky({view:this.view})}}class e_ extends ma{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class t_ extends ma{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,(e=>this._handleKeyDown(e)))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class i_ extends t_{constructor(e,t,i){super(t,i),this.view=e,this.key=t}activate(){this.view.goTo({heading:0}).catch((()=>{}))}}class r_ extends t_{constructor(e,t,i){super(t,i),this.view=e,this.key=t}activate(){this.view.goTo({tilt:0}).catch((()=>{}))}}class s_ extends ma{constructor(e,t=!1){super(!0),this.view=e,this.invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this.handleTwoFinger(e)))}handleTwoFinger(e){const t=this.invert?-1:1,i=Vt(0,e.data.delta*t);switch(e.data.action){case"begin":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new bv({view:this.view,pivot:"center"}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(i);break;case"update":this.cameraController&&this.cameraController.update(i);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}}}class a_ extends ma{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new Ka({start:(e,t)=>this.observeStart(e,t),update:(e,t,i)=>this.observeUpdate(e,t,i),end:(e,t)=>this.observeEnd(t)}),this.registerIncoming("drag",(e=>this.dragEventSeparator.handle(e)))}get failed(){return"failed"===this.state}observeStart(e,t){1===e&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center,artifical:!0}),t.stopPropagation()),this.state=2===e?"ready":"failed"}observeUpdate(e,t,i){if("failed"!==this.state&&2===e)return"active"===this.state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this.checkMovementWithinLimits(t.data,i.data)?this.checkVerticalThresholdReached(t.data,i.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center,artifical:!0}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this.state="failed")}observeEnd(e){"active"===this.state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",e.stopPropagation())}checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,s=-1/0,a=1/0;t.pointers.forEach((e=>{i=Math.max(i,e.x),r=Math.min(r,e.x),s=Math.max(s,e.y),a=Math.min(a,e.y)}));let n=-1/0,o=1/0,l=-1/0,c=1/0;e.pointers.forEach((e=>{n=Math.max(n,e.x),o=Math.min(o,e.x),l=Math.max(l,e.y),c=Math.min(c,e.y)}));const h=i-r,d=s-a,u=n-o,p=l-c;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-h)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,r)=>{const s=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-s.y))})),i>=this._threshold}}let n_=class extends T{constructor(){super(...arguments),this._handles=new $t}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const e=this.view;this._source=new Ja(this.view.surface,e.input);const t=[new en,new vn,new tn,new rn(this.view.navigation),new a_],i=new fa({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new sn],ga.INTERNAL),this._modeDragPan=new Jy(e,"primary"),this._modeDragRotate=new wv(e,"secondary","center"),this._modeDragZoom=new Tv(e,"tertiary");const r="b",s={left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},a="n",n="p";i.installHandlers("navigation",[new e_(e),new _v(e),new Ly(e),new Fy(e,s),new Vy(e),new r_(e,n),new i_(e,a),new wv(e,"primary","eye",[r]),new wv(e,"secondary","center",[r]),new Jy(e,"tertiary",[r]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new s_(e)],ga.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),hi(this.view.navigation,"browserTouchPanEnabled",(e=>{this._source.browserTouchPanningEnabled=!e}))}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=o_.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};e([S()],n_.prototype,"view",void 0),e([S({value:"pan"})],n_.prototype,"primaryDragAction",null),e([S({value:"default"})],n_.prototype,"mode",null),e([S({readOnly:!0,aliasOf:"_inputManager.hasPendingInputs"})],n_.prototype,"hasPendingInputs",void 0),e([S({readOnly:!0,aliasOf:"_inputManager.latestPointerType"})],n_.prototype,"latestPointerType",void 0),e([S()],n_.prototype,"_inputManager",void 0),n_=e([re("esri.views.3d.input.SceneInputManager")],n_);const o_=new Map,l_=new Map,c_=new Map;l_.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),l_.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),c_.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),c_.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),o_.set("default",l_),o_.set("pro",c_);var h_=n_;let d_,u_,p_=!1,m_=!1,f_=!1,g_=!1,v_=null;function y_(e){f_=xc.DECONFLICTOR_SHOW_VISIBLE,g_=xc.DECONFLICTOR_SHOW_INVISIBLE,p_=f_||g_,m_=xc.DECONFLICTOR_SHOW_GRID,v_=null,p_||m_?v_=()=>function(e){null==d_&&(d_=document.createElement("canvas"),d_.setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(d_));const t=e.width*e.pixelRatio,i=e.height*e.pixelRatio;d_.setAttribute("width",`${t}px`),d_.setAttribute("height",`${i}px`),d_.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${e.width}px;height:${e.height}px`),u_=d_.getContext("2d"),u_.clearRect(0,0,e.width,e.height),u_.font="12px Arial"}(e):d_&&(d_.parentElement.removeChild(d_),d_=null)}function __(){v_&&(v_(),v_=null)}function x_(e,t,i,r,s){__();const a=d_.height,n=u_;n.beginPath(),n.lineWidth=1,n.strokeStyle=s,n.moveTo(e,a-i),n.lineTo(t,a-i),n.stroke(),n.lineTo(t,a-r),n.stroke(),n.lineTo(t,a-i),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.closePath()}function b_(e,t){p_&&(t&&f_||!t&&g_)&&x_(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}const w_=je(),C_=Tr(),S_=Tr(),T_=je(),P_=jr(),R_=jo.create(),M_=ko.create(),O_=je(),D_=Li();class A_{constructor(){this.aabr=Li(),this.distance=0,this.culled=!1,this.visible=!1}}class E_{constructor(e,t,i={}){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info=i}}class I_{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class L_{}class F_{constructor(){this.sortArray=new R({allocator:e=>e||new L_})}}class V_{constructor(){this.camera=new rh,this.slicePlane=Wo.create(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),Wo.copy(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let z_=class extends T{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new V_,this._state=0,this.graphics=new I_,this.iterators=new F_,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return 0!==this._state||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/4;return this._dirty?.5*e:e}needsUpdate(){return this.view.ready&&null!=this.view.state&&this.updating}update(e){switch(this._state){case 0:this.startUpdate(),e.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(e))return;case 2:if(this._state=2,!this.sortVisibleGraphics(e))return;case 3:if(this._state=3,!this.deconflictVisibleGraphics(e))return;default:!function(e,t){if(!m_||!u_)return;__();const i=u_;let r=0;for(let t=0;t<e.accBinsNumX;t++)for(let s=0;s<e.accBinsNumY;s++){const a=e.accBins[t][e.accBinsNumY-1-s];r+=a.length;const n=t*e.accBinsSizeX,o=(t+1)*e.accBinsSizeX,l=s*e.accBinsSizeY,c=(s+1)*e.accBinsSizeY;i.fillText(a.length.toFixed(),n+5,l+15),x_(n,o,l,c,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}(this,this.graphics.visible),this._state=0,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e))),this.setDirty()}layerSupportsDeconfliction(e){if(u(e)||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?t.getNumGeometryRecords():0))return!1;return t.getGeometryRecord(0).material instanceof ac}startUpdate(){y_(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._runningViewState.camera;this.initBins(e,t),this.resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new A_,this.graphics.active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this.removeFromVisibleGraphics(e),function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(3,t)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this.graphics.active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToVisibleGraphics(e){this.graphics.visible.set(e.graphics3DGraphic.graphic.uid,e)}removeFromVisibleGraphics(e){this.graphics.visible.delete(e.graphics3DGraphic.graphic.uid)}processActiveGraphics(e){const t=this.ensureActiveGraphicsIterator(),i=xi(P_,this._runningViewState.camera.projectionMatrix),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?R_:null;let s=0;for(h(r)&&(it(r.center,Ge,this._runningViewState.camera.viewMatrix),r.radius=Kt(this.view.spatialReference).radius,s=jo.distanceToSilhouette(r,Ge));!e.done;){e.madeProgress();const a=t.next();if(a.done)return this.resetActiveGraphicsIterator(),!0;const n=a.value,o=n&&n.info[this.visibilityGroup];o&&(this.collectGraphics3DGraphics(n,i,r,s),o.culled?this.removeFromVisibleGraphics(n):this.addToVisibleGraphics(n))}return!1}sortVisibleGraphics(e){const t=this.ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),i.done)return this.resetSortGraphicsIterator(),!0}return!1}deconflictVisibleGraphics(e){const t=this.ensureVisibleGraphicsIterator(),i=1===this.visibilityGroup;for(;!e.done;){e.madeProgress();const r=t.next();if(r.done)return this.resetVisibleGraphicsIterator(),!0;const s=r.value,a=s.info[this.visibilityGroup];if(!a||a.culled)continue;const n=s.graphics3DGraphic,o=(!i||n.isVisible())&&!this.isConflicted(s);o&&this.addToBins(s),a.visible=o,this.setGraphicVisibility(s,o),b_(a,o)}return!1}resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=U_(this.graphics.active)),this.iterators.active}resetActiveGraphicsIterator(){this.iterators.active=null}ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=U_(this.graphics.visible)),this.iterators.visible}resetVisibleGraphicsIterator(){this.iterators.visible=null}ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=function*(e,t,i){t.clear(),e.forEach(((e,r)=>{const s=t.pushNew();s.id=r,s.prio=e.info?-e.info[i].distance:Number.MAX_VALUE})),yield;const r=t.iterableSort(((e,t)=>t.prio-e.prio));for(let e=r.next();!e.done;e=r.next())yield;t.forAll((t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))})),t.clear()}(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}resetSortGraphicsIterator(){this.iterators.sort=null}collectGraphics3DGraphics(e,t,i,r){const s=e.graphics3DGraphic;if(s.destroyed)return;const a=e.info[this.visibilityGroup];if(!s.isVisible(0,3))return void(a.culled=!0);const n=this.getGraphicsLayers(s);Fi(a.aabr);let o=null;for(const s of n){if(!this.layerSupportsDeconfliction(s))continue;const n=s.stageObject.getGeometryRecord(0).material;if(u(o)){if(o=this.getProjectionInfo(s,t,j_),o.isOutsideScreen||this.isCulledBySlice(e,w_)||h(i)&&this.isCulledByHorizon(o,i,r))return void(a.culled=!0);!xc.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&a.visible&&(o.distance*=.7)}this.expandBoundingRect(a,s,n,o)}u(o)?a.culled=!0:(a.distance=o.distance,a.culled=!1)}getProjectionInfo(e,t,i){const r=this._runningViewState.camera,s=e.stageObject,a=s.getGeometryRecord(0),n=a.material,o=s.getCenter();it(w_,o,r.viewMatrix);const l=a.geometry.data.getVertexAttr(),c=l[Ll.NORMAL].data,h=l[Ll.AUXPOS1].data;return n.applyShaderOffsetsView(w_,c,s.objectTransformation,h,r,i.scaleInfo,w_),bs(C_,w_[0],w_[1],w_[2],1),ws(S_,C_,r.projectionMatrix),Ze(i.positionNDC,S_,1/S_[3]),n.applyShaderOffsetsNDC(i.positionNDC,h,r,i.positionNDC,T_),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(T_[2]),i.distance=T_[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),bs(S_,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),ws(C_,S_,t),Cs(C_,C_,1/C_[3]),Ye(i.positionView,w_[0],w_[1],w_[2]),i}isCulledByHorizon(e,t,i){return Xe(M_.direction,e.positionView),Ye(M_.origin,0,0,0),!!Ho(t,M_,O_)&&e.distanceWithoutPolygonOffset>i}isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&Wo.extrusionContainsPoint(this._runningViewState.slicePlane,t)}expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:s}){const a=this._runningViewState.camera,n=t.getScreenSize(k_);Dn(n,s.factor,n),n[0]*=a.pixelRatio,n[1]*=a.pixelRatio;const o=Vi(i.calculateRelativeScreenBounds(n,s.factorAlignment.scale,D_),De(0,a.fullWidth,.5+.5*r[0]),De(0,a.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(0!==l){const e=l*Math.min(zi(o),Ui(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}ki(e.aabr,o)}isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];for(let e=Math.floor(i.aabr[0]/this.accBinsSizeX);e<=Math.floor(i.aabr[2]/this.accBinsSizeX);e++)if(!(e<0||e>=this.accBinsNumX))for(let r=Math.floor(i.aabr[1]/this.accBinsSizeY);r<=Math.floor(i.aabr[3]/this.accBinsSizeY);r++){if(r<0||r>=this.accBinsNumY)continue;const s=this.accBins[e][r];for(let e=0;e<s.length;e++){const r=s.data[e],a=r.info[this.visibilityGroup];if(a&&a.visible&&(r.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,ji(a.aabr,i.aabr))))return!0}}return!1}initBins(e,t){if(null==this.accBins){this.accBins=[];for(let e=0;e<this.accBinsNumX;e++){this.accBins.push([]);const e=this.accBins[this.accBins.length-1];for(let t=0;t<this.accBinsNumY;t++)e.push(new R)}}else for(let e=0;e<this.accBinsNumX;e++)for(let t=0;t<this.accBinsNumY;t++)this.accBins[e][t].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0}addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this.accBinsSizeX),r=Math.floor(t.aabr[2]/this.accBinsSizeX),s=Math.floor(t.aabr[1]/this.accBinsSizeY),a=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let t=i;t<=r;t++)if(!(t<0||t>=this.accBinsNumX))for(let i=s;i<=a;i++)i<0||i>=this.accBinsNumY||this.accBins[t][i].push(e)}setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(3,t,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function*U_(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}e([S({constructOnly:!0})],z_.prototype,"view",void 0),e([S({type:Boolean,readOnly:!0})],z_.prototype,"updating",null),z_=e([re("esri.views.3d.layers.graphics.Deconflictor")],z_);const k_=cn();const j_=new class{constructor(){this.positionView=je(),this.positionNDC=je(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}};let G_=class extends z_{constructor(){super(...arguments),this.visibilityGroup=1,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}update(e){if(this.parent.needsUpdate())return;const t=performance.now();(2===e.state||t-this._lastDeconfliction>2e3)&&(super.update(e),0===this.state&&(this._lastDeconfliction=t))}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelGraphics}};e([S({constructOnly:!0})],G_.prototype,"parent",void 0),G_=e([re("esri.views.3d.layers.graphics.LabelDeconflictor")],G_);let B_=class extends z_{constructor(){super(...arguments),this._handles=new $t,this._contexts=new Map,this._viewState=new V_,this.visibilityGroup=0,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([this.view.watch("state.camera",(()=>{this.updateViewState(),this.setDirty()})),this.view.watch("map.ground.opacity",((e,t)=>{1!==e&&1!==t||this.setDirty()})),hi(this.view,"slicePlane",(()=>{this.updateSlicePlane(),this.slicePlaneChanged()}))]),this._frameTask=this.view.resourceController.scheduler.registerTask(xr.GRAPHICS_DECONFLICTOR,(e=>this.update(e)),(()=>this.needsUpdate())),this._labels=new G_({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}update(e){super.update(e),this.needsUpdate()||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&N_(e));t.setVisibilityFlag(3,i,0)}updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this.updateSlicePlane())}updateSlicePlane(){const e=this.view?this.view.slicePlane:null;h(e)&&Wo.transform(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=h(e)}slicePlaneChanged(){ua(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(e){let t=this._contexts.get(e);return null==t&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this.addGraphic(e,t,i),removeGraphic:e=>this.removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}addGraphic(e,t,i){const r=i.graphic.uid,s=new E_(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),N_(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s)}removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=N_(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.clearVisibilityFlag(3)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e._graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e._graphics;if(!t||!t.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}};function N_(e){const t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}B_=e([re("esri.views.3d.layers.graphics.GraphicsDeconflictor")],B_);const q_=.70710678118;var H_=Object.freeze({__proto__:null,build:function(e){const t=new xn;e.draped||t.extensions.add("GL_OES_standard_derivatives");const i=1===e.output;t.include(wn,{linearDepth:i}),t.include(An,e),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),i&&(t.include(En,e),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("linearDepth","float")),e.draped?t.vertex.uniforms.add("worldToScreenRatio","float"):(t.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),t.vertex.uniforms.add("camPos","vec3"),t.attributes.add("bound1","vec3"),t.attributes.add("bound2","vec3"),t.attributes.add("bound3","vec3")),t.attributes.add("position","vec3"),t.attributes.add("uvMapSpace","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2");const r=3===e.style||4===e.style||5===e.style;return r&&t.vertex.code.add(bn`
      const mat2 rotate45 = mat2(${bn.float(q_)}, ${bn.float(-.70710678118)},
                                 ${bn.float(.70710678118)}, ${bn.float(q_)});
    `),e.draped||(t.vertex.code.add(bn`
      vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
        float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
        return center + halfVector * clamp(projectedLength, -1.0, 1.0);
      }
    `),t.vertex.code.add(bn`
      vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
        float d = dot(planeNormal, planePoint);
        float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);

        return rayOrigin + t * rayDir;
      }
    `),t.vertex.code.add(bn`
      float boundingRectDistanceToCamera() {
        vec3 halfU = (bound2 - bound1) * 0.5;
        vec3 halfV = (bound3 - bound1) * 0.5;
        vec3 center = bound1 + halfU + halfV;
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${bn.float(.08715574274)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, camPos, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - camPos);
      }
    `)),t.vertex.code.add(bn`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${r?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${r?" * rotate45":""};

      ${e.draped?bn`
            float ratio = worldToScreenRatio;
          `:bn`
            float distanceToCamera = boundingRectDistanceToCamera();
            float ratio = worldToScreenPerDistanceRatio / distanceToCamera;

            // Logarithmically discretize ratio to avoid jittering
            float step = 0.1;
            ratio = log(ratio);
            ratio = ceil(ratio / step) * step;
            ratio = exp(ratio);
          `}

      vec2 uvOffset = mod(uvCellOrigin * ratio, ${bn.float(e.patternSpacing)});
      return uvOffset + (uv * ratio);
    }
  `),t.vertex.code.add(bn`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      forwardNormalizedVertexColor();
      gl_Position = ${i?bn`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:bn`transformPosition(proj, view, vpos);`}
    }
  `),t.include(In,e),t.fragment.include(On),t.fragment.uniforms.add("matColor","vec4"),e.draped&&t.fragment.uniforms.add("texelSize","float"),4===e.output&&t.include(Ln),4!==e.output&&(t.fragment.code.add(bn`
      const float lineWidth = ${bn.float(e.lineWidth)};
      const float spacing = ${bn.float(e.patternSpacing)};
      const float spacingINV = ${bn.float(1/e.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),e.draped||t.fragment.code.add(bn`
        const int maxSamples = 5;

        float sample(float p) {
          vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
          float fwidth = dxdy.x + dxdy.y;

          ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
          vec2 invSamples = 1.0 / vec2(samples);

          float accumulator = 0.0;

          for (int j = 0; j < maxSamples; j++) {
            if(j >= samples.y) {
              break;
            }

            for (int i = 0; i < maxSamples; i++) {
              if(i >= samples.x) {
                break;
              }

              vec2 step = vec2(i,j) * invSamples - 0.5;
              accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
            }
          }

          accumulator /= float(samples.x * samples.y);
          return accumulator;
        }
      `)),t.fragment.code.add(bn`
    void main() {
      discardBySlice(vpos);
      vec4 color = ${e.attributeColor?"vColor * matColor;":"matColor;"}
      color = highlightSlice(color, vpos);

      ${4!==e.output?bn`color.a *= ${function(e){function t(t){return e.draped?bn`coverage(vuv.${t}, texelSize)`:bn`sample(vuv.${t})`}switch(e.style){case 3:case 0:return t("y");case 4:case 1:return t("x");case 5:case 2:return bn`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return"0.0"}}(e)};`:""}

      if (color.a < ${bn.float(Fn)}) {
        discard;
      }

      ${7===e.output?bn`gl_FragColor = vec4(color.a);`:""}

      ${0===e.output?bn`gl_FragColor = color; ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${4===e.output?bn`outputHighlight();`:""}
      ${1===e.output?bn`outputDepth(linearDepth);`:""};
    }
  `),t}});class W_ extends Tn{initializeProgram(e){const t=W_.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,style:i.style,patternSpacing:i.patternSpacing,lineWidth:i.lineWidth,draped:i.draped,OITEnabled:0===i.transparencyPassType});return new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),Pn)}bindPass(e,t,i){Mn.bindProjectionMatrix(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("matColor",t.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/i.screenToWorldRatioGlobalWM),this.program.setUniform1f("texelSize",1/i.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/i.camera.perScreenPixelRatio),4===this.configuration.output&&Ln.bindOutputHighlight(e,this.program,i),1===this.configuration.output&&this.program.setUniform2fv("nearFar",i.camera.nearFar)}bindDraw(e){Mn.bindView(this.program,e),Mn.bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),In.bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e,t){const i=this.configuration,r=3===e,s=2===e;return wo({blending:0===i.output||7===i.output?i.transparent&&r?Vn:zn(e):null,culling:(a=i.cullFace,0!==a&&{face:1===a?1028:1029,mode:2305}),depthTest:{func:Un(e)},depthWrite:r?i.writeDepth&&Ro:kn(e),colorWrite:To,stencilWrite:i.sceneHasOcludees?jn:null,stencilTest:i.sceneHasOcludees?t?Gn:Bn:null,polygonOffset:r||s?i.polygonOffset&&Z_:Nn(i.enableOffset)});var a}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}W_.shader=new Rn(H_,(()=>Promise.resolve().then((function(){return H_}))));const Z_={factor:1,units:1};class Q_ extends Sn{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.vertexColors=!1,this.transparent=!0,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=3}}e([Cn({count:8})],Q_.prototype,"output",void 0),e([Cn({count:3})],Q_.prototype,"cullFace",void 0),e([Cn()],Q_.prototype,"slicePlaneEnabled",void 0),e([Cn()],Q_.prototype,"sliceHighlightDisabled",void 0),e([Cn()],Q_.prototype,"vertexColors",void 0),e([Cn()],Q_.prototype,"transparent",void 0),e([Cn()],Q_.prototype,"polygonOffset",void 0),e([Cn()],Q_.prototype,"writeDepth",void 0),e([Cn()],Q_.prototype,"sceneHasOcludees",void 0),e([Cn({count:6})],Q_.prototype,"style",void 0),e([Cn()],Q_.prototype,"patternSpacing",void 0),e([Cn()],Q_.prototype,"lineWidth",void 0),e([Cn()],Q_.prototype,"enableOffset",void 0),e([Cn()],Q_.prototype,"draped",void 0),e([Cn({count:4})],Q_.prototype,"transparencyPassType",void 0);class Y_ extends qn{constructor(e,t){super(t,e,X_),this.supportsEdges=!0,this.techniqueConfig=new Q_}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.style=this.params.style,this.techniqueConfig.patternSpacing=this.params.patternSpacing,this.techniqueConfig.lineWidth=this.params.lineWidth,this.techniqueConfig.draped=this.params.draped,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<Hn,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,i,r,s,a,n){Wn(e,t,r,s,a,void 0,n)}getGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.params.writeLinearDepth?new $_(e):void 0}createBufferWriter(){return new gl(vl)}}class $_ extends Zn{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(W_,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){if(4===this.output)return 3===e;return e===(this.technique.configuration.transparent?this.technique.configuration.writeDepth?5:8:3)}_updateOccludeeState(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})}ensureParameters(e){0!==this.output&&7!==this.output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}getPipelineState(e,t){return this.technique.getPipelineState(t)}}const X_={color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,style:2,patternSpacing:10,lineWidth:1,draped:!0,...Qn};function K_(e,t,i,r,s,a,n=1){Ye(ix,1,0,0),Ye(rx,0,1,0),Ye(sx,0,0,1),function(e,t){Ye(fx,0,0,0);for(let e=0;e<t.count-1;e++)t.getVec(e,ex),Qe(fx,fx,ex);Ze(e,fx,1/(t.count-1))}(J_,t),function(e,t){const i=e.count-1;return Qo(e,t,0,Math.floor(i/3),Math.floor(i*(2/3)))}(t,tx)&&function(e,t,i,r,s,a){s.basisMatrixAtPosition(a,dx),Ye(ux,dx[0],dx[1],dx[2]),Ye(px,dx[4],dx[5],dx[6]),Ye(mx,dx[8],dx[9],dx[10]);const n=Yo(e);st(n,mx)<0&&Ze(n,n,-1);Xe(r,n);const o=st(n,px),l=st(n,ux);Math.abs(o)<Math.abs(l)?(ht(t,ux,n,-l),nt(t,t),Je(i,t,n),nt(i,i),Ze(i,i,-1)):(ht(i,px,n,-o),nt(i,i),Je(t,i,n),nt(t,t))}(tx,ix,rx,sx,i,J_),ls(ax,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),ls(nx,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let e=0;e<t.count;e++){t.getVec(e,ex);const i=st(ix,ex),r=st(rx,ex);ax[0]=Math.min(ax[0],i),ax[1]=Math.min(ax[1],r),nx[0]=Math.max(nx[0],i),nx[1]=Math.max(nx[1],r)}const o=st(sx,J_);gx(lx,ax[0],ax[1],o,ix,rx,sx),gx(cx,nx[0],ax[1],o,ix,rx,sx),gx(hx,ax[0],nx[1],o,ix,rx,sx);const l=ax[0]%n,c=ax[1]%n;ox[0]=ax[0]-l,ox[1]=ax[1]-c;for(let i=0;i<t.count;i++)t.getVec(i,ex),e.setValues(i,(st(ix,ex)-ox[0])/n,(st(rx,ex)-ox[1])/n,ox[0]/n,ox[1]/n),r&&s&&a&&(r.setVec(i,lx),s.setVec(i,cx),a.setVec(i,hx))}const J_=je(),ex=je(),tx=Zo(),ix=je(),rx=je(),sx=je(),ax=cn(),nx=cn(),ox=cn(),lx=je(),cx=je(),hx=je();const dx=jr(),ux=je(),px=je(),mx=je();const fx=je();function gx(e,t,i,r,s,a,n){Ye(e,t*s[0]+i*a[0]+r*n[0],t*s[1]+i*a[1]+r*n[1],t*s[2]+i*a[2]+r*n[2])}const vx=Ll;function yx(e,t,i,r){const s=e.stageObject,a=i.spatialReference;Sx.spatialReference=a;const n=s.geometryRecords,o=n.length,l="absolute-height"!==t.mode;let c=0;for(let e=0;e<o;e++){const a=n[e].geometry,o=n[e].getShaderTransformation();Px[0]=o[12],Px[1]=o[13],Px[2]=o[14],a.invalidateBoundingInfo();const h=a.data.getVertexAttr(),d=h[vx.POSITION],u=d.data,p=h.mapPos.data,m=d.size,f=u.length/m;let g=0,v=0,y=!1,_=0;for(let e=0;e<f;e++){Sx.x=p[v++],Sx.y=p[v++],Sx.z=p[v++],Rx[0]=u[g],Rx[1]=u[g+1],Rx[2]=u[g+2];const e=ph(Sx,i,t,r,l?Dx:null);if(l&&(_+=Dx.sampledElevation),Tx[0]=u[g]+Px[0],Tx[1]=u[g+1]+Px[1],Tx[2]=u[g+2]+Px[2],r.setAltitude(e,Tx),u[g]=Tx[0]-Px[0],u[g+1]=Tx[1]-Px[1],u[g+2]=Tx[2]-Px[2],xc.TESTS_DISABLE_UPDATE_THRESHOLDS)y=!0;else{const e=Cx/r.unitInMeters;(Math.abs(Rx[0]-u[g])>=e||Math.abs(Rx[1]-u[g+1])>=e||Math.abs(Rx[2]-u[g+2])>=e)&&(y=!0)}g+=m}c+=_/f,y&&s.geometryVertexAttrsUpdated(e)}return c/o}function _x(e,t,i,r){const s=yx(e,t,i,r),a=e.stageObject.geometryRecords;for(let e=0;e<a.length;e++)if((n=a[e]).material instanceof Y_&&!n.material.params.draped){const t=a[e].geometry.data.getVertexAttr(),i=t[vx.POSITION].data,s=t[vx.BOUND1].data,n=t[vx.BOUND2].data,o=t[vx.BOUND3].data,l=t[vx.UVMAPSPACE].data;K_(es.fromTypedArray(l),Jr.fromTypedArray(i),r,Jr.fromTypedArray(s),Jr.fromTypedArray(n),Jr.fromTypedArray(o))}var n;return s}function xx(e,t,i,r){const s=e.stageObject,a=t.centerPointInElevationSR;let n=0,o=0;if(s.metadata.usesVerticalDistanceToGround)n=ph(a,i,t,r,Dx),yl(s,Dx.verticalDistanceToGround),o=Dx.sampledElevation;else{const e="absolute-height"!==t.mode;n=ph(a,i,t,r,e?Dx:null),e&&(o=Dx.sampledElevation)}const l=_i(bx,s.objectTransformation),c=Ye(Ox,l[12],l[13],l[14]);xc.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(Tx[0]=a.x,Tx[1]=a.y,Tx[2]=n,nr(a.spatialReference,Tx,l,r.spatialReference)&&(s.objectTransformation=l)):r.setAltitudeOfTransformation(n,l);const h=Cx/r.unitInMeters;return(Math.abs(l[12]-c[0])>=h||Math.abs(l[13]-c[1])>=h||Math.abs(l[14]-c[2])>=h)&&(s.objectTransformation=l),o}const bx=jr();function wx(e,t,i,r){const s=e.graphics3DSymbolLayer.lodRenderer;if(u(s))return 0;const a=t.centerPointInElevationSR;let n=0,o=0;const l="absolute-height"!==t.mode;n=ph(a,i,t,r,l?Dx:null),l&&(o=Dx.sampledElevation);const c=s.instanceData,h=e.instanceIndex,d=Mx;c.getGlobalTransform(h,d);const p=Ye(Ox,d[12],d[13],d[14]);xc.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(Tx[0]=a.x,Tx[1]=a.y,Tx[2]=n,nr(a.spatialReference,Tx,d,r.spatialReference)&&c.setGlobalTransform(h,d)):r.setAltitudeOfTransformation(n,d);const m=Cx/r.unitInMeters;return(Math.abs(d[12]-p[0])>=m||Math.abs(d[13]-p[1])>=m||Math.abs(d[14]-p[2])>=m)&&c.setGlobalTransform(h,d),o}let Cx=.01;const Sx=new _e,Tx=je(),Px=je(),Rx=je(),Mx=jr(),Ox=je(),Dx={verticalDistanceToGround:0,sampledElevation:0};class Ax{constructor(e,t,i,r,s,a,n,o=null){this.uniqueGeometries=i,this.uniqueMaterials=r,this.uniqueTextures=s,this.elevationAligner=a,this.elevationContext=n,this._edgeState=o,this.type="object3d",this.stageLayer=null,this.stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.graphics3DSymbolLayer=e,this.stageObject=t}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(e,t){if(this.stageLayer=t,this.stage=e,this.uniqueMaterials)for(let t=0;t<this.uniqueMaterials.length;t++)e.add(3,this.uniqueMaterials[t]);if(this.uniqueGeometries)for(let t=0;t<this.uniqueGeometries.length;t++)e.add(2,this.uniqueGeometries[t]);if(this.uniqueTextures)for(let t=0;t<this.uniqueTextures.length;t++)e.add(4,this.uniqueTextures[t]);e.add(1,this.stageObject)}layerOpacityChanged(e,t){if(u(this._edgeState))return;const i=Ex(this._edgeState.baseMaterial);let r=!1;for(const e of this._edgeState.edgeMaterials)e.objectTransparency!==i&&(e.objectTransparency=i,r=!0);r&&this.resetEdgeObject(t);this.stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,t){if(u(this._edgeState))return;this.stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:e},!t),this._edgeState.properties.slicePlaneEnabled=e}setVisibility(e){if(null!=this.stage&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this.stageLayer.addObject(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),h(this._edgeState))){const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this.addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}destroy(){const e=this.stage;if(this.stageLayer){if(this.uniqueMaterials)for(let t=0;t<this.uniqueMaterials.length;t++)e.remove(3,this.uniqueMaterials[t].id);if(this.uniqueGeometries)for(let t=0;t<this.uniqueGeometries.length;t++)e.remove(2,this.uniqueGeometries[t].id);if(this.uniqueTextures)for(let t=0;t<this.uniqueTextures.length;t++)e.remove(4,this.uniqueTextures[t].id)}e.remove(1,this.stageObject.id),this._addedToStage&&(this.stageLayer.removeObject(this.stageObject),this._addedToStage=!1);const t=this.stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this.stageLayer=null,this.stage=null}alignWithElevation(e,t,i,r){if(null==this.elevationAligner)return;h(i)&&nc(this.elevationContext.featureExpressionInfoContext,i);const s=this.elevationAligner(this,this.elevationContext,e,t);null!=s&&(this.alignedSampledElevation=s),this.resetEdgeObject(r)}getBSRadius(){return this.stageObject.getBSRadius()}getCenterObjectSpace(e=je()){return Xe(e,this.stageObject.getCenter(!0))}getBoundingBoxObjectSpace(e=js()){return function(e,t,i){i||(i=js());return Hs(i,e.getBBMin(t)),Ws(i,e.getBBMax(t)),i}(this.stageObject,!0,e)}computeAttachmentOrigin(e){for(const t of this.stageObject.geometryRecords)t.computeAttachmentOrigin(Fx)&&(it(Fx,Fx,this.stageObject.objectTransformation),Qe(e.render.origin,e.render.origin,Fx),e.render.num++)}async getProjectedBoundingBox(e,t,i,r,s){const a=this.getBoundingBoxObjectSpace(s),n=Vx,o=Gs(a)?1:n.length;for(let e=0;e<o;e++){const t=n[e];Lx[0]=a[t[0]],Lx[1]=a[t[1]],Lx[2]=a[t[2]],it(Lx,Lx,this.stageObject.objectTransformation),Ix[3*e+0]=Lx[0],Ix[3*e+1]=Lx[1],Ix[3*e+2]=Lx[2]}if(!e(Ix,0,o))return null;Bs(a);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let e=0;e<3*o;e+=3){for(let t=0;t<3;t++)a[t]=Math.min(a[t],Ix[e+t]),a[t+3]=Math.max(a[t+3],Ix[e+t]);l&&i.push({location:Ix.slice(e,e+3),screenSpaceBoundingRect:l})}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){Ns(a,Fx);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i;if(t.useViewElevation)i=t.service.getElevation(Fx[0],Fx[1],e);else try{const s=_l(a,t);i=await t.service.queryElevation(Fx[0],Fx[1],r,s,e)}catch(e){i=null}qs(a,0,0,-this.alignedSampledElevation+i)}return a}addObjectState(e,t){0===e&&t.addObject(this.stageObject,this.stageObject.highlight()),1===e&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){if(u(this._edgeState))return;const t=this.stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}addOrUpdateEdgeObject(e,t){const i=this._edgeState;if(u(i))return;const r=Ex(i.baseMaterial);for(const e of i.edgeMaterials)e.objectTransparency=r;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!t)}}function Ex(e){return e.isVisible?e.params.transparent?1:2:0}!function(e){let t;!function(e){e[e.REMOVE_OBJECT=0]="REMOVE_OBJECT",e[e.HIDE_FACERANGE=1]="HIDE_FACERANGE"}(t=e.VisibilityModes||(e.VisibilityModes={}))}(Ax||(Ax={}));const Ix=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Lx=je(),Fx=je(),Vx=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var zx=Ax;class Ux{constructor(){this._abortController=null,this._loadStatus=0,this._loadError=null,this._loader=null,this.logger=null}get loadStatus(){return this._loadStatus}load(e,t){return 1===this._loadStatus?(e&&e(),this._loader):2===this._loadStatus?(t&&t(this._loadError),this._loader):(this._loader||(this._abortController=z(),this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=1}),(e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=2,!U(e)&&this.logger&&e.message&&this.logger.warn(e.message),e}))),this._loader.then(e,t).catch((()=>{})),this._loader)}abortLoad(){this._abortController?(this._abortController.abort(),this._abortController=null):0===this._loadStatus&&(this._loadStatus=2),this._loader=null}}function kx(e,t,i){const r=(e,r,s=!1)=>({levels:e.map(((e,a)=>{const n=r(e.tesselation);return s&&fl.cgToGIS(n),{components:[{geometry:new ql(n,i+`_lod${a}`),material:t}],faceCount:n.indexCount/3,minScreenSpaceRadius:e.minScreenSpaceRadius}}))});switch(e){case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(e=>fl.createPolySphereGeometry(.5,e,!0)));case"cube":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>fl.createBoxGeometry(1)));case"cone":return r(jx,(e=>fl.createConeGeometry(1,.5,e,!1)),!0);case"inverted-cone":return r(jx,(e=>fl.createConeGeometry(1,.5,e,!0)),!0);case"cylinder":return r(jx,(e=>fl.createCylinderGeometry(1,.5,e,[0,0,1],[0,0,.5])));case"tetrahedron":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>fl.createTetrahedronGeometry(1)),!0);case"diamond":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>fl.createDiamondGeometry(1)),!0);default:return}}const jx=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function Gx(e,t){return Bx(function(e){return e&&e.enabled&&e.edges||null}(e),t)}function Bx(e,t){if(u(e))return null;const i=h(e.color)?Rr(At.toUnitRGBA(e.color)):Pr(0,0,0,0),r=kt(e.size),s=kt(e.extensionLength);switch(e.type){case"solid":return Nx({color:i,size:r,extensionLength:s,...t});case"sketch":return function(e){return{...Hx,...e,type:"sketch"}}({color:i,size:r,extensionLength:s,...t});default:return}}function Nx(e){return{...qx,...e,type:"solid"}}const qx={color:Pr(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2},Hx={color:Pr(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2};function Wx(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{t.push(e.material)}))})),M(t)}function Zx(e){const t=[];return e.components.forEach((e=>{t.push(e.geometry)})),M(t)}const Qx={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function Yx(e){if("web-style"===e.type)return Qx;return $x(e.symbolLayers.toArray().map((t=>Jx(e,t))))}function $x(e){let t=0,i=0,r=0,s=!1,a=0;const n={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const o of e)u(o)||(t+=o.primitivesPerFeature,i+=o.primitivesPerCoordinate,r+=o.drawCallsPerFeature,n.bytesPerFeature+=o.memory.bytesPerFeature,n.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,n.bytesPerCoordinate+=o.memory.bytesPerCoordinate,n.draped.bytesPerFeature+=o.memory.bytesPerFeature,n.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,n.draped.bytesPerCoordinate+=o.memory.bytesPerCoordinate,s=s||o.estimated,++a);return{primitivesPerFeature:t,primitivesPerCoordinate:i,drawCallsPerFeature:r,estimated:s,memory:n,numComplexities:a}}function Xx(e){const t=$x(e);return t.numComplexities>0&&(t.primitivesPerFeature/=t.numComplexities,t.primitivesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.bytesPerCoordinate/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities,t.memory.draped.bytesPerCoordinate/=t.numComplexities),t}const Kx={};function Jx(e,t){const i=eb(e,t),r=(s=t)&&s.enabled&&(function(e){return"extrude"===e.type}(s)||function(e){return"fill"===e.type}(s))&&h(s.edges)?2:0;var s;switch(t.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:i};case"fill":return"mesh-3d"===e.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:i}:h(t.outline)&&t.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:i}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:i};case"object":if(t.resource&&t.resource.href)return{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:i};return{...tb(t.resource&&t.resource.primitive||Ht),memory:i};case"path":{const e=3,r=3,s=10;let a=0,n=0;switch(t.profile){case"circle":a=s;break;case"quad":a=4;break;default:return void te(t.profile)}switch(t.join){case"round":n=e;break;case"miter":case"bevel":n=1;break;default:return void te(t.join)}const o=2*a,l=a*n*2;let c=-2*l-o;switch(t.cap){case"none":break;case"butt":case"square":c+=2*(a-1);break;case"round":c+=2*(a*(r-1)*2+a);break;default:return void te(t.cap)}return{primitivesPerFeature:c,primitivesPerCoordinate:l+o,drawCallsPerFeature:0,estimated:!1,memory:i}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:i};default:return}}function eb(e,t){const i="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?ib.EXTRUDE_EDGES:ib.EXTRUDE;case"fill":return h(t.outline)&&t.outline.size>0?ib.FILL_OUTLINE:ib.FILL;case"water":return ib.FILL;case"line":return"round"===t.join?ib.LINE_ROUND:ib.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return ib.PATH_ROUND_CIRCLE;case"quad":return ib.PATH_ROUND_QUAD;default:return void te(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return ib.PATH_MITER_CIRCLE;case"quad":return ib.PATH_MITER_QUAD;default:return void te(t.profile)}default:return void te(t.join)}case"object":return i?ib.OBJECT_POINT:ib.OBJECT_POLYGON;case"icon":case"text":return i?ib.ICON_POINT:ib.ICON_POLYGON;default:return}}function tb(e){let t=Kx[e];if(t)return t;return t={primitivesPerFeature:Zx(kx(e,null,null).levels[0]).reduce(((e,t)=>e+t.data.getIndices(Ll.POSITION).length/3),0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},Kx[e]=t,t}const ib={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},rb=d.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class sb extends Ux{constructor(e,t,i,r){super(),this._elevationInfoOverride=null,this.complexity=null,this.logger=rb,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=e,this.symbolLayer=t,this._context=i,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new oc,this.complexity=this.computeComplexity(),this._updateDrivenProperties(r.ignoreDrivers),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,r){const s=e.projectionSuccess,a="polygons"in e?e.polygons:null,n=`${r} geometry failed to be created`;let o=null;s?!t.length||1===t.length&&!t[0].length?o=`${n} (no ${i} were defined)`:Array.isArray(t)&&Array.isArray(t[0])?a&&0===a.length&&"rings"===i&&t.length>0&&t[0].length>2&&(o=`${n} (filled rings should use clockwise winding - try reversing the order of vertices)`):o=`${n} (${i} should be defined as a 2D array)`:o=`${n} (failed to project geometry to view spatial reference)`,o&&rb.warnOncePerTick(o)}_validateGeometryType(e,t,i){return!!t.includes(e.type)||(this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1)}_validateGeometry(e){if("point"===e.type){const t=e;if(!Le(t.x)||!Le(t.y))return rb.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return nb}_defaultElevationInfoZ(){return ob}_updateElevationContext(){h(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t){const i=m(e.geometry),r=this.getDefaultElevationInfo(i);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:r.unit,t.mode=this.getGeometryElevationMode(i,r),t.offsetMeters=f(this._elevationContext.meterUnitOffset,f(r.offset,0));const s=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;s&&(t.mode="relative-to-ground",t.offsetMeters=0);const a=s?lc:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(a,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}onRemoveGraphic(e){}_updateDrivenProperties(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};if(e)return void(this._drivenProperties=t);const i=this._context.renderer;i&&"visualVariables"in i&&i.visualVariables&&i.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let i=0;i<e.stops.length;i++){const r=e.stops[i].color;r&&(t.opacity=!0,r.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}})),this._drivenProperties=t}_getLayerOpacity(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;const e=this._context.layer.opacity;return null==e?1:e}_getCombinedOpacity(e,t=lb){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(h(e)?i*=e.a:t.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,t=lb){const i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return xl(null,i);const r=h(e)?At.toUnitRGB(e):Be;return xl(r,i)}_getVertexOpacityAndColor(e,t,i){const r=this._drivenProperties.color?e.color:null,s=this._drivenProperties.opacity?e.opacity:null,a=xl(r,s);return i&&(a[0]*=i,a[1]*=i,a[2]*=i,a[3]*=i),t?new t(a):a}_getIdHint(e=""){return this._context.layer.id+"_symbol"+e}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return Jx(this.symbol,this.symbolLayer)}destroy(){this.abortLoad()}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i);case"elevationInfo":{const e=this._elevationContext.mode;this._updateElevationContext();return this.layerElevationInfoChanged(t,i,e)!==mh.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(e,t,i){let r=mh.UPDATE;return e.forEach((e=>{const s=t(e);if(h(s)){const t=e.graphic;this.setGraphicElevationContext(t,s.elevationContext),s.needsElevationUpdates=i(s.elevationContext.mode)}else r=mh.RECREATE})),r}applyRendererDiff(e,t){return!1}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const t=this._fastUpdates.visualVariables,i=t.size?ab(t.size.field,e):0,r=t.color?ab(t.color.field,e):0,s=t.opacity?ab(t.opacity.field,e):0;return Pr(i,r,s,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&rb.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function ab(e,t){const i=null!=e?t.attributes[e]:0;return null!=i&&isFinite(i)?i:0}const nb={mode:"on-the-ground",offset:0,unit:"meters"},ob={mode:"absolute-height",offset:0,unit:"meters"},lb={hasIntrinsicColor:!1};var cb;function hb(e,t,i){3===i.length?e.setUniform4f(t,i[0],i[1],i[2],1):e.setUniform4fv(t,i)}!function(e){e.bindUniforms=function(e,t,i){hb(e,"color",t.color),e.setUniform1f("pixelRatio",i),e.setUniform2f("screenOffset",t.screenOffset[0]*i,t.screenOffset[1]*i),null!==t.borderColor?(hb(e,"borderColor",t.borderColor),e.setUniform1f("borderSize",i)):(e.setUniform4f("borderColor",0,0,0,0),e.setUniform1f("borderSize",0))}}(cb||(cb={}));var db=Object.freeze({__proto__:null,build:function(e){const t=new xn;return t.include(sc),t.include(cc,e),t.include(In,e),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),t.vertex.code.add(bn`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${e.occlusionTestEnabled?bn`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${e.screenSizePerspectiveEnabled?bn`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:bn`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${e.depthHudEnabled?e.depthHudAlignStartEnabled?bn`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:bn`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.screenSizePerspectiveEnabled?bn`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:bn`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),t.fragment.uniforms.add("color","vec4"),t.fragment.uniforms.add("borderColor","vec4"),t.fragment.code.add(bn`
    void main() {
      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = color.a * borderColor.a * coverage.y;
      float colorAlpha = color.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${e.depthHudEnabled?bn`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:bn`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, color.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),t},get LineCallout(){return cb}});class ub extends Tn{initializeProgram(e){const t=ub.shader.get(),i=this.configuration,r=t.build({occlusionTestEnabled:i.occlusionTestEnabled,verticalOffsetEnabled:i.verticalOffset,screenSizePerspectiveEnabled:i.screenSizePerspective,depthHudEnabled:i.depthHudEnabled,depthHudAlignStartEnabled:i.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:e.viewingMode,isDraped:!1});return new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),Pn)}bindPass(e,t,i){Mn.bindProjectionMatrix(this.program,i.camera.projectionMatrix),cb.bindUniforms(this.program,t,i.camera.pixelRatio||1),dh.bindUniforms(this.program,t,i),this.program.setUniform1i("hudVisibilityTexture",0),e.bindTexture(i.hudVisibilityTexture,0),this.program.setUniform1f("cameraGroundRelative",i.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",t.shaderPolygonOffset),Mn.bindViewport(this.program,i),this.program.setUniform1f("perDistancePixelRatio",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/i.camera.fullViewport[2],2/i.camera.fullViewport[3]);const r=i.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(t.size)*r),Yn(t.screenSizePerspective,this.program,"screenSizePerspectiveAlignment")}bindDraw(e){Mn.bindView(this.program,e),Mn.bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),In.bindUniformsWithOrigin(this.program,this.configuration,e)}initializePipeline(){return this.configuration.depthHudEnabled?wo({depthTest:{func:513},depthWrite:Ro}):wo({blending:Co(1,770,771,771),depthTest:{func:513},colorWrite:To})}}ub.shader=new Rn(db,(()=>Promise.resolve().then((function(){return db}))));class pb extends Sn{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=0,this.slicePlaneEnabled=!1}}e([Cn()],pb.prototype,"occlusionTestEnabled",void 0),e([Cn()],pb.prototype,"verticalOffset",void 0),e([Cn()],pb.prototype,"screenSizePerspective",void 0),e([Cn()],pb.prototype,"depthHudEnabled",void 0),e([Cn()],pb.prototype,"depthHudAlignStartEnabled",void 0),e([Cn({count:2})],pb.prototype,"screenCenterOffsetUnitsEnabled",void 0),e([Cn()],pb.prototype,"slicePlaneEnabled",void 0);class mb extends qn{constructor(e,t){super(t,e,gb),this.techniqueConfig=new pb,this._uniqueMaterialIdentifier=mb.uniqueMaterialIdentifier(this.params)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}dispose(){}getGLMaterial(e){return 0===e.output?new fb(e):void 0}getPassParameters(){return this.params}getTechniqueConfig(e){return this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest,this.techniqueConfig.verticalOffset=!!this.params.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective,this.techniqueConfig.depthHudEnabled=e,this.techniqueConfig.depthHudAlignStartEnabled=!!this.params.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig}intersect(){}createBufferWriter(){return new _b}validateParameterValues(e){const t=mb.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}}class fb extends Zn{constructor(e){super(e),this.isRenderSlot=!0,this.updateParameters()}updateParameters(){this.technique=this.techniqueRep.acquireAndReleaseExisting(ub,this.material.getTechniqueConfig(!1),this.technique),this.depthTechnique=this.techniqueRep.acquireAndReleaseExisting(ub,this.material.getTechniqueConfig(!0),this.depthTechnique)}beginSlot(e){switch(e){case 20:return this.isRenderSlot=!0,!0;case 21:return this.isRenderSlot=!1,!0}return!1}getTechnique(){return this.isRenderSlot?this.technique:this.depthTechnique}bind(e,t){const i=this.getTechnique();e.bindProgram(i.program),i.bindPass(e,this.material.getPassParameters(),t)}}const gb={verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1,...Qn},vb=Io().vec3f(Ll.POSITION).vec3f(Ll.NORMAL).vec2f(Ll.UV0).vec4f(Ll.AUXPOS1),yb=[Ta(0,0),Ta(1,0),Ta(0,1),Ta(1,0),Ta(1,1),Ta(0,1)];class _b{constructor(){this.vertexBufferLayout=vb}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices[Ll.POSITION].length}write(e,t,i,r){$n(t.indices[Ll.POSITION],t.vertexAttr[Ll.POSITION].data,e.transformation,i.position,r,6),Xn(t.indices[Ll.NORMAL],t.vertexAttr[Ll.NORMAL].data,e.invTranspTransformation,i.normal,r,6),Kn(t.indices[Ll.AUXPOS1],t.vertexAttr[Ll.AUXPOS1].data,i.auxpos1,r,6);for(let e=0;e<yb.length;++e)i.uv0.setVec(r+e,yb[e])}}const xb=Ll;class bb extends sb{constructor(e,t){super(e,null,t,Pb),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new mb(this.materialParameters,this._getIdHint("_lineCallout_common")),this._context.stage.add(3,this._material)}destroy(){super.destroy(),h(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null)}perInstanceMaterialParameters(e){const t=this.materialParameters;return t.screenOffset=e.screenOffset||[0,0],t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get materialParameters(){const e=this.symbol,t=e.callout,i=h(t.color)?At.toUnitRGBA(t.color):[0,0,0,0];i[3]*=this._getLayerOpacity();const r=kt(t.size||0);let s=null;if(e.verticalOffset){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e.verticalOffset;s={screenLength:kt(t),minWorldLength:i||0,maxWorldLength:null!=r?r:1/0}}const a=h(t.border)&&h(t.border.color)?At.toUnitRGBA(t.border.color):null,n="object"===e.symbolLayers.getItemAt(0).type,o=!n,l=n?0:void 0,c="label-3d"===e.type;return{color:i,size:r,verticalOffset:s,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:a,occlusionTest:o,shaderPolygonOffset:l,depthHUDAlignStart:c,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:Qn.renderOccluded}}_defaultElevationInfoNoZ(){return Tb}createGraphics3DGraphic(e){const t=e.renderingInfo,i=e.graphic,r=this.setGraphicElevationContext(i,new oc,t.elevationOffset||0),s=t.symbol,a="on-the-ground"===this._elevationContext.mode&&("cim"===s.type||!s.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==s.type&&a)return null;const n=bl(i.geometry);if(u(n))return null;const o="graphic"+i.uid;return this._createAs3DShape(n,r,t,o,i.uid)}layerOpacityChanged(){return u(this._material)||this._material.setParameterValues(this.materialParameters),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=fh(bb.elevationModeChangeTypes,i,r);return s!==mh.UPDATE||e.forEach((e=>{const i=t(e);h(i)&&this.updateGraphicElevationContext(e.graphic,i)})),s}slicePlaneEnabledChanged(){return u(this._material)||this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=gh(t.elevationContext.mode)}updateGeometry(e,t){return!1}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:Qx.memory}}createVertexData(e){const{translation:t,centerOffset:i}=e;if(!t&&!i)return wb;const r=t?{size:3,data:[t[0],t[1],t[2]]}:wb[xb.POSITION],s=i?{size:4,data:[i[0],i[1],i[2],i[3]]}:wb[xb.AUXPOS1];return{[xb.POSITION]:r,[xb.NORMAL]:wb[xb.NORMAL],[xb.AUXPOS1]:s}}getOrCreateMaterial(e,t){const i=this.perInstanceMaterialParameters(e),r=mb.uniqueMaterialIdentifier(i);if(h(this._material)&&r===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection){let s=e.materialCollection.getMaterial(r);return s||(s=new mb(i,`${t}_lineCallout_shared`),e.materialCollection.addMaterial(r,s)),{material:s,isUnique:!1}}return{material:new mb(i,`${t}_lineCallout_unique`),isUnique:!0}}_createAs3DShape(e,t,i,r,s){const a=new Hl(this.createVertexData(i),Sb,"point"),n=[new ql(a,r)],o=this.getOrCreateMaterial(i,r),l=_h(this._context,e,n,[o.material],null,null,t,r,this._context.layer.uid,s);if(null===l)return null;const c=xx,h=new zx(this,l.object,n,o.isUnique?[o.material]:null,null,c,t);return h.metadata={elevationOffset:i.elevationOffset||0},h.alignedSampledElevation=l.sampledElevation,h.needsElevationUpdates=gh(t.mode),xh(h,e,this._context.elevationProvider),h}}bb.elevationModeChangeTypes={definedChanged:mh.UPDATE,staysOnTheGround:mh.UPDATE,onTheGroundChanged:mh.RECREATE};const wb={[xb.POSITION]:{size:3,data:[0,0,0]},[xb.NORMAL]:{size:3,data:[0,0,1]},[xb.AUXPOS1]:{size:4,data:[0,0,0,1]}},Cb=new Uint32Array([0]),Sb={[xb.POSITION]:Cb,[xb.NORMAL]:Cb,[xb.AUXPOS1]:Cb},Tb={mode:"relative-to-ground",offset:0},Pb={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},Rb=d.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function Mb(e,t){if(!Wt(e))return Rb.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=Ob[e.callout.type];return i?new i(e,t):(Rb.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const Ob={line:bb};class Db{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}}const Ab=new t(Array,(e=>Zs(e,Qs)),null,10,5),Eb=Li();class Ib{constructor(e,t,i,r,s){this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=function(e,t){const i=new Array(e);for(let e=0;e<i.length;e++)i[e]=new Array(t);return i}(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++t.referenced,this.graphics3DSymbol=t,this.graphic=e,this._graphics=i,this._featureExpressionFeature=s?hc(s,e,r):null;for(const e of this._graphics)h(e)&&(this.isElevationSource=this.isElevationSource||e.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(e,t,i){this._layer=t,this._stage=e,this.forEachSymbolLayerGraphic((r=>{r.initialize(e,t,i),r.setVisibility(this.isVisible())}))}destroy(){this.forEachSymbolLayerGraphic((e=>e.destroy())),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this._graphics}clearLabelGraphics(){this.forEachLabelGraphic((e=>e.destroy())),this._labelGraphics.length=0}addLabelGraphic(e,t,i){this._labelGraphics.push(e),e.initialize(t,i),e.setVisibility(this.isVisible(1))}addAuxiliaryGraphic(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this.forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(e=0,t){for(let i=0;i<=e;i++){const e=this._visibilityFlags[i];for(let i=0;i<e.length;++i)if(!1===e[i]&&i!==t)return!1}return!0}hasVisibilityFlag(e,t){return null!=this._visibilityFlags[t][e]}setVisibilityFlag(e,t,i){const r=this.isVisible(i);this._visibilityFlags[i][e]=t;const s=this.isVisible(i);if(r===s)return!1;if(1===i)this.forEachLabelGraphic((e=>e.setVisibility(s)));else{this.forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(1);this.forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}clearVisibilityFlag(e,t=0){return this.setVisibilityFlag(e,void 0,t)}getBSRadius(){let e=0;return this.forEachSymbolLayerGraphic((t=>{e=Math.max(e,t.getBSRadius())})),e}getCenterObjectSpace(e=je()){if(0===this._graphics.length)return Ye(e,0,0,0),e;const t=this._graphics[0];return h(t)?t.getCenterObjectSpace(e):e}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(u(t))return!1;this._extent=Li(),Pa(t,this._extent);const i=t.spatialReference;if(!i.equals(e)&&!or(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===t||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=t),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=It.fromExtent("mesh"===r.type?r.extent:r)),ks(r,t,i)}get usedMemory(){let e=Ra(this.graphic.attributes);return this.forEachSymbolLayerGraphic((t=>{const i=t.graphics3DSymbolLayer.complexity;if(u(i))return;const r="draped"===t.type?i.memory.draped:i.memory;e+=r.bytesPerFeature,r.bytesPerCoordinate&&(e+=Ma(this.graphic.geometry)*r.bytesPerCoordinate)})),e}computeAttachmentOrigin(){const e={render:{origin:je(),num:0},draped:{origin:cn(),num:0}};for(const t of this._graphics)u(t)||t.computeAttachmentOrigin(e);return e.render.num&&Ze(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&ds(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,r,s){return s||(s={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),s.boundingBox?Bs(s.boundingBox):s.boundingBox=Bs(),s.requiresDrapedElevation=!1,await ne(this._graphics,(async a=>{if(u(a))return;const n="draped"===a.type?t:e,o=Ab.acquire(),l=await a.getProjectedBoundingBox(n,i,s.screenSpaceObjects,r,o);isFinite(l[2])&&isFinite(l[5])||(s.requiresDrapedElevation=!0),l&&Ys(s.boundingBox,o),Ab.release(o)})),$s(s.boundingBox)||Gi(Xs(s.boundingBox,Eb))?s:null}needsElevationUpdates(){for(const e of this._graphics)if(h(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,t,i){this.forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,t,this._featureExpressionFeature,i)}))}addObjectStateSet(e,t){this.forEachSymbolLayerGraphic((i=>i.addObjectState(e,t)))}removeObjectState(e){this.forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}forEachGraphicList(e,t){e.forEach((e=>e&&t(e)))}forEachSymbolLayerGraphic(e){this.forEachGraphicList(this._graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)}forEachLabelGraphic(e){this.forEachGraphicList(this._labelGraphics,e)}forEachRenderedGraphic(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)}}function Lb(e,t){if(!e||e.symbol)return null;const i=t&&t.renderer;return e&&h(i)&&i.getObservationRenderer?i.getObservationRenderer(e):i}function Fb(e,t){const i=Lb(e,t),r=function(e,t){if(h(e.symbol))return e.symbol;const i=Lb(e,t);return h(i)?i.getSymbol(e,t):null}(e,t);if(!r)return null;const s={renderer:i,symbol:r};if(u(i)||!("visualVariables"in i)||!i.visualVariables)return s;const a=ii(i,e,t),n=["proportional","proportional","proportional"];for(const{variable:e,value:t}of a)switch(e.type){case"color":s.color=t.toRgba();break;case"size":if("outline"===e.target)s.outlineSize=t;else{const i=e.axis,r=e.useSymbolValue?"symbol-value":t;switch(i){case"width":n[0]=r;break;case"depth":n[1]=r;break;case"height":n[2]=r;break;case"width-and-depth":n[0]=n[1]=r;break;default:n[0]=n[1]=n[2]=r}}break;case"opacity":s.opacity=t;break;case"rotation":switch(e.axis){case"tilt":s.tilt=t;break;case"roll":s.roll=t;break;default:s.heading=t}}return"proportional"===n[0]&&"proportional"===n[1]&&"proportional"===n[2]||(s.size=n),s}async function Vb(e,t){const i=Lb(e,t),r=await async function(e,t){if(h(e.symbol))return e.symbol;const i=Lb(e,t);return h(i)&&i.getSymbolAsync(e,{...t,abortOptions:{signal:t.signal}})}(e,t);if(!r)return null;const s={renderer:i,symbol:r};if(!i||!("visualVariables"in i)||!i.visualVariables)return s;const a=ii(i,e,t),n=["proportional","proportional","proportional"];for(const{variable:e,value:t}of a)if("color"===e.type)s.color=At.toUnitRGBA(t);else if("size"===e.type)if("outline"===e.target)s.outlineSize=t;else{const i=e.axis,r=e.useSymbolValue?"symbol-value":t;"width"===i?n[0]=r:"depth"===i?n[1]=r:"height"===i?n[2]=r:n[0]=n[1]="width-and-depth"===i?r:n[2]=r}else"opacity"===e.type?s.opacity=t:"rotation"===e.type&&"tilt"===e.axis?s.tilt=t:"rotation"===e.type&&"roll"===e.axis?s.roll=t:"rotation"===e.type&&(s.heading=t);return(isFinite(n[0])||isFinite(n[1])||isFinite(n[2]))&&(s.size=n),s}function zb(e){const t={},i={};if(i[Ll.POSITION]={size:3,data:e.attributeData.position},t[Ll.POSITION]=e.indices,h(e.attributeData.color)){const r=new Uint32Array(e.indices.length);i[Ll.COLOR]={size:4,data:e.attributeData.color},t[Ll.COLOR]=r}return h(e.attributeData.uvMapSpace)&&(i[Ll.UVMAPSPACE]={size:4,data:e.attributeData.uvMapSpace},t[Ll.UVMAPSPACE]=e.indices),h(e.attributeData.bound1)&&(i[Ll.BOUND1]={size:3,data:e.attributeData.bound1},t[Ll.BOUND1]=e.indices),h(e.attributeData.bound2)&&(i[Ll.BOUND2]={size:3,data:e.attributeData.bound2},t[Ll.BOUND2]=e.indices),h(e.attributeData.bound3)&&(i[Ll.BOUND3]={size:3,data:e.attributeData.bound3},t[Ll.BOUND3]=e.indices),h(e.attributeData.mapPosition)&&(i.mapPos={size:3,data:e.attributeData.mapPosition},t.mapPos=e.indices),new Hl(i,t)}function Ub(e){const t={},i={};return i[Ll.POSITION]={size:3,data:e.attributeData.position},t[Ll.POSITION]=e.indices,i[Ll.UV0]={size:2,data:e.attributeData.uv0},t[Ll.UV0]=e.indices,h(e.attributeData.mapPosition)&&(i.mapPos={size:3,data:e.attributeData.mapPosition},t.mapPos=e.indices),new Hl(i,t)}function kb(e){switch(e.type){case"extent":if(e instanceof Pe)return It.fromExtent(e);break;case"polygon":return e}return null}function jb(e,t,i,r){const s=kr(e.rings,e.hasZ,1),a=new Float64Array(s.position.length),n=vh(s.position,e.spatialReference,0,a,0,s.position,0,s.position.length/3,t,i,r),o=null!=n;return{position:s.position,mapPosition:a,polygons:Nb(s.polygons,s.position,a),outlines:Bb(s.outlines,s.position,a),projectionSuccess:o,sampledElevation:n}}function Gb(e,t){const i=kr(e.rings,!1,1),r=ar(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let e=2;e<i.position.length;e+=3)i.position[e]=bc;return{position:i.position,polygons:Nb(i.polygons,i.position),outlines:Bb(i.outlines,i.position),projectionSuccess:r}}function Bb(e,t,i){const r=new Array;for(const{index:s,count:a}of e){if(a<=1)continue;const e=3*s,n=e+3*a;r.push({index:s,count:a,position:t.subarray(e,n),mapPosition:i?i.subarray(e,n):void 0})}return r}function Nb(e,t,i){const r=new Array;for(const{index:s,count:a,holeIndices:n,pathLengths:o}of e){if(a<=1)continue;const e=3*s,l=e+3*a,c=n.map((e=>e-s));r.push({index:s,count:a,holeIndices:c,pathLengths:o,position:t.subarray(e,l),mapPosition:i?i.subarray(e,l):void 0})}return r}class qb extends sb{constructor(e,t,i,r){super(e,t,i,r),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=wl(this._getSymbolSize());if(e)throw new ee("graphics3dextrudesymbollayer:invalid-size",e)}const e=g(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),i=Ne(t),r=t[3],s={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:r,transparent:r<1||this.needsDrivenTransparentPass,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new Eh(s,this._getIdHint("_3dlinemat")),this._bottomMaterial=new Eh({...s,cullFace:2},this._getIdHint("_3dlinematbot")),this._context.stage.add(3,this._material),this._context.stage.add(3,this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(3,this._material.id),this._context.stage.remove(3,this._bottomMaterial.id))}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometryType(t.geometry,qb.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(t.geometry))return null;const i="graphic"+t.uid,r=this._getVertexOpacityAndColor(e.renderingInfo,Float32Array,255),s=this.setGraphicElevationContext(t,new oc);return this._createAs3DShape(t,e.renderingInfo,r,s,i,t.uid)}layerOpacityChanged(e,t){const i=g(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i),s=r<1||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:r,transparent:s}),this._bottomMaterial.setParameterValues({opacity:r,transparent:s});const a=this._getLayerOpacity();return e.forEach((e=>{const i=t(e);h(i)&&i.layerOpacityChanged(a,this._context.isAsync)})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,yh)}slicePlaneEnabledChanged(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((e=>{const i=t(e);h(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(e){let t;var i;e.size&&this._drivenProperties.size?t=null!=(i=function(e,t=0){const i=e[t];return"number"==typeof i&&isFinite(i)?i:null}(e.size,2))?i:0:t=this._getSymbolSize();return t/=this._context.renderCoordsHelper.unitInMeters,t}_getSymbolSize(){var e;return null!=(e=this.symbolLayer.size)?e:1}_createAs3DShape(e,t,i,r,s,a){const n=kb(e.geometry);if(u(n))return null;const o=jb(n,this._context.elevationProvider,this._context.renderCoordsHelper,r);if(this._logGeometryCreationWarnings(o,n.rings,"rings","ExtrudeSymbol3DLayer"),0===n.rings.length||!n.rings.some((e=>e.length>0)))return null;const l=bl(n);if(u(l))return null;const c=new Array,d=new Array,p=new Array,m=js(),f=jr(),g=je(),v=1===this._context.renderCoordsHelper.viewingMode;v||this._context.renderCoordsHelper.worldUpAtPosition(null,g),nr(n.spatialReference,[l.x,l.y,0],f,this._context.renderCoordsHelper.spatialReference);const y=jr();xi(y,f);const _=Br();Zr(_,y);const{polygons:x,mapPosition:b,position:w}=o,C=w.length/3,S=new Float64Array(3*C*6),T=new Float64Array(3*C*6),P=new Float64Array(3*C*6),R=new Float64Array(1*C*6);let M=0;for(let e=0;e<x.length;++e){const r=x[e],a=r.count;if(this._context.clippingExtent&&(Bs(m),Ks(m,r.mapPosition),!Js(m,this._context.clippingExtent)))continue;const n=Ur(r.mapPosition,r.holeIndices,3);if(0===n.length)continue;const o=3*a*2+n.length,l=new Uint32Array(o),h=new Uint32Array(n.length),u=6*a,f=3*S.BYTES_PER_ELEMENT,C=new Jr(S.buffer,M*f,f,(M+u)*f),O=3*T.BYTES_PER_ELEMENT,D=new Jr(T.buffer,M*O,O,(M+u)*O),A=new Float64Array(P.buffer,3*M*P.BYTES_PER_ELEMENT,3*u),E=new Float64Array(R.buffer,1*M*R.BYTES_PER_ELEMENT,1*u),I=this._getExtrusionSize(t);Hb(w,b,n,r,C.typedBuffer,A,D.typedBuffer,E,0,l,h,I,g,v),As(C,C,y),Es(D,D,_),M+=6*a;const L=this._createExtrudeGeometry(l,{positions:C.typedBuffer,elevation:A,normals:D.typedBuffer,heights:E},i),F=new ql(L,s+"path"+e);c.push(F),d.push(this._material),p.push(Nr);const V=this._createExtrudeGeometry(h,{positions:C.typedBuffer,elevation:A,normals:D.typedBuffer,heights:E},i),z=new ql(V,s+"bottompath"+e);c.push(z),d.push(this._bottomMaterial),p.push(Nr)}if(0===c.length)return null;const O=new Wc({geometries:c,materials:d,transformations:p,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:a,isElevationSource:!0},idHint:s});O.objectTransformation=f;const D=iw,A=this._createEdgeMaterial(),E=h(A)?{baseMaterial:this._material,edgeMaterials:[A],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,I=new zx(this,O,c,null,null,D,r,E);return I.alignedSampledElevation=o.sampledElevation,I.needsElevationUpdates=yh(r.mode),I}_createExtrudeGeometry(e,t,i){const r=new Uint32Array(e.length),s={};s[Ll.POSITION]=e,s[Ll.NORMAL]=e,s[Ll.COLOR]=r;const a={};return a[Ll.POSITION]={size:3,data:t.positions},a[Ll.NORMAL]={size:3,data:t.normals},a[Ll.COLOR]={size:4,data:i},a[Ll.SIZE]={size:1,data:t.heights},t.elevation&&(a.mapPos={size:3,data:t.elevation},s.mapPos=e),new Hl(a,s)}_createEdgeMaterial(){const e={opacity:this._getLayerOpacity()};return Gx(this.symbolLayer,e)}}function Hb(e,t,i,r,s,a,n,o,l,c,h,d,u,p){const m=i.length/3;let f=0,g=2*r.count;!function(e,t,i,r,s,a,n,o,l,c,h,d,u,p,m,f,g,v){Xe(sw,g);const y=f>0?1:-1;let _=3*i,x=d,b=3*x,w=d+r,C=3*w;for(let i=0;i<r;++i)v&&(sw[0]=e[_+0],sw[1]=e[_+1],sw[2]=e[_+2],nt(sw,sw)),o[b+0]=e[_+0],o[b+1]=e[_+1],o[b+2]=e[_+2],l[b+0]=t[_+0],l[b+1]=t[_+1],l[b+2]=t[_+2],c[b+0]=-y*sw[0],c[b+1]=-y*sw[1],c[b+2]=-y*sw[2],h[x]=0,o[C+0]=e[_+0]+f*sw[0],o[C+1]=e[_+1]+f*sw[1],o[C+2]=e[_+2]+f*sw[2],l[C+0]=t[_+0],l[C+1]=t[_+1],l[C+2]=t[_+2],c[C+0]=y*sw[0],c[C+1]=y*sw[1],c[C+2]=y*sw[2],h[w]=f,b+=3,C+=3,_+=3,x+=1,w+=1;_=3*a,b=0,C=3*m;const S=f<0?nw:aw,T=f<0?aw:nw;for(let e=0;e<n;++e)p[b+0]=s[_+S[0]],p[b+1]=s[_+S[1]],p[b+2]=s[_+S[2]],u[C+0]=s[_+T[0]]+r,u[C+1]=s[_+T[1]]+r,u[C+2]=s[_+T[2]]+r,b+=3,C+=3,_+=3}(e,t,r.index,r.count,i,0,m,s,a,n,o,l,c,h,g,d,u,p),l+=2*r.count,g=0,Qb(s,a,o,n,f,r.pathLengths[0],r.count,l,c,g,d),l+=4*r.pathLengths[0],g+=2*r.pathLengths[0],f+=r.pathLengths[0];for(let e=1;e<r.pathLengths.length;++e)Qb(s,a,o,n,f,r.pathLengths[e],r.count,l,c,g,d),l+=4*r.pathLengths[e],g+=2*r.pathLengths[e],f+=r.pathLengths[e]}function Wb(e,t,i,r,s,a,n){r[a]=r[n],n*=3,e[(a*=3)+0]=e[n+0],e[a+1]=e[n+1],e[a+2]=e[n+2],t[a+0]=t[n+0],t[a+1]=t[n+1],t[a+2]=t[n+2],i[a+0]=s[0],i[a+1]=s[1],i[a+2]=s[2]}qb.validGeometryTypes=["polygon","extent"];const Zb=je();function Qb(e,t,i,r,s,a,n,o,l,c,h){let d=s,u=s+1,p=s+n,m=s+n+1,f=o,g=o+1,v=o+2*a,y=o+2*a+1;h<0&&(d=s+n+1,m=s),c*=3;for(let o=0;o<a;++o)o===a-1&&(h>0?(u=s,m=s+n):(u=s,d=s+n)),ew(e,d,u,p,Zb),Wb(e,t,r,i,Zb,f,d),Wb(e,t,r,i,Zb,g,u),Wb(e,t,r,i,Zb,v,p),Wb(e,t,r,i,Zb,y,m),l[c++]=f,l[c++]=v,l[c++]=y,l[c++]=f,l[c++]=y,l[c++]=g,d++,u++,p++,m++,f+=2,g+=2,v+=2,y+=2}const Yb=je(),$b=je(),Xb=je(),Kb=je(),Jb=je();function ew(e,t,i,r,s){t*=3,i*=3,r*=3,Ye(Yb,e[t++],e[t++],e[t++]),Ye($b,e[i++],e[i++],e[i++]),Ye(Xb,e[r++],e[r++],e[r++]),at(Kb,$b,Yb),at(Jb,Xb,Yb),Je(s,Jb,Kb),nt(s,s)}const tw=je();function iw(e,t,i,r){const s=e.stageObject,a=s.geometryRecords,n=a.length,o="absolute-height"!==t.mode;let l=0;const c=s.objectTransformation,h=xi(jr(),c);for(let e=0;e<n;e+=2){const n=a[e].geometry,d=n.data.getVertexAttr(),u=d[Ll.POSITION].data,p=d[Ll.SIZE].data,m=d.mapPos.data,f=new Ea(m),g=u.length/3;let v=0,y=!1,_=0;for(let e=0;e<g;e++){tw[0]=u[v],tw[1]=u[v+1],tw[2]=u[v+2];const e=ph(f,i,t,r,o?ow:null);o&&(_+=ow.sampledElevation),Ye(rw,u[v+0],u[v+1],u[v+2]),it(rw,rw,c),r.setAltitude(e+p[v/3],rw),it(rw,rw,h),u[v]=rw[0],u[v+1]=rw[1],u[v+2]=rw[2];const s=.01/r.unitInMeters;(Math.abs(tw[0]-u[v])>s||Math.abs(tw[1]-u[v+1])>s||Math.abs(tw[2]-u[v+2])>s)&&(y=!0),f.offset+=3,v+=3}y&&(n.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(e),a[e+1].geometry.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(e+1)),l+=_/g}return l/n}const rw=je(),sw=je(),aw=[0,2,1],nw=[0,1,2],ow={verticalDistanceToGround:0,sampledElevation:0};class lw{constructor(e,t,i){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._layerView=null,this.isElevationSource=!1}initialize(e,t,i){this.stage=e,this._layerView=i,this._overlayRenderer=this._layerView.view.basemapTerrain.overlayManager.renderer}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._layerView,1);if(e||this._addedToStage){for(const e of this.renderGeometries)e.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._layerView,1)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._layerView,4),this._addedToStage=!1,this._visible=!1,this.stage=null}getBSRadius(){return this.renderGeometries.reduce(((e,t)=>Math.max(e,t.bsRadius)),0)}getCenterObjectSpace(e=je()){return Ye(e,0,0,0)}getBoundingBoxObjectSpace(e=js()){return Bs(e)}addObjectState(e,t){0===e&&(this.renderGeometries.forEach((e=>{const i=e.addHighlight();t.addRenderGeometry(e,i,this)})),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView))}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t)}))}removeRenderGeometryObjectState(e,t){e.removeHighlight(t),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.computeAttachmentOrigin(dw)&&(e.draped.origin[0]+=dw[0],e.draped.origin[1]+=dw[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,r,s){Bs(s);for(let t=0;t<this.renderGeometries.length;t++){const r=this.renderGeometries[t];this._getRenderGeometryProjectedBoundingRect(r,e,cw,i),ea(s,cw)}if(t){let e;Ns(s,dw);const i=_l(s,t);try{e=await t.service.queryElevation(dw[0],dw[1],r,i,"ground")}catch(t){e=null}null!=e&&(s[2]=Math.min(s[2],e),s[5]=Math.max(s[5],e))}return s}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)Zs(hw,this.boundingBox);else{const t=e.center,i=e.bsRadius;hw[0]=t[0]-i,hw[1]=t[1]-i,hw[2]=t[2]-i,hw[3]=t[0]+i,hw[4]=t[1]+i,hw[5]=t[2]+i}return t(hw,0,2),this.calculateRelativeScreenBounds&&r.push({location:Ns(hw),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),Xs(hw,i)}}const cw=Li(),hw=js(),dw=je();function uw(e){return null!=e}function pw(e){return"number"==typeof e}function mw(e){return"string"==typeof e}function fw(e,t){e&&e.push(t)}function gw(e,t,i,r,s){const a=e.minSize,n=e.maxSize;if(e.expression)return fw(s,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const e=r.symbolSize[i];return t.minSize[i]=e,t.maxSize[i]=e,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0}if(uw(e.field))return uw(e.stops)?2===e.stops.length&&pw(e.stops[0].size)&&pw(e.stops[1].size)?(vw(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=1,!0):(fw(s,"Could not convert size info: stops only supported with 2 elements"),!1):pw(a)&&pw(n)&&uw(e.minDataValue)&&uw(e.maxDataValue)?(vw(a,n,e.minDataValue,e.maxDataValue,t,i),t.type[i]=1,!0):null!=ti[e.valueUnit]?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/ti[e.valueUnit],t.type[i]=1,!0):"unknown"===e.valueUnit?(fw(s,"Could not convert size info: proportional size not supported"),!1):(fw(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!uw(e.field)){if(e.stops&&e.stops[0]&&pw(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0;if(pw(a))return t.minSize[i]=a,t.maxSize[i]=a,t.offset[i]=a,t.factor[i]=0,t.type[i]=1,!0}return fw(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function vw(e,t,i,r,s,a){const n=Math.abs(r-i)>0?(t-e)/(r-i):0;s.minSize[a]=n>0?e:t,s.maxSize[a]=n>0?t:e,s.offset[a]=e-i*n,s.factor[a]=n}function yw(e,t,i,r){if(e.normalizationField||e.valueRepresentation)return fw(r,"Could not convert size info: unsupported property"),null;if(null!=(s=e.field)&&!mw(s))return fw(r,"Could not convert size info: field is not a string"),null;var s;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return fw(r,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};let a;switch(e.axis){case"width":return a=gw(e,t.size,0,i,r),a?t:null;case"height":return a=gw(e,t.size,2,i,r),a?t:null;case"depth":return a=gw(e,t.size,1,i,r),a?t:null;case"width-and-depth":return a=gw(e,t.size,0,i,r),a&&gw(e,t.size,1,i,r),a?t:null;case null:case void 0:case"all":return a=gw(e,t.size,0,i,r),a=a&&gw(e,t.size,1,i,r),a=a&&gw(e,t.size,2,i,r),a?t:null;default:return fw(r,`Could not convert size info: unknown axis "${e.axis}""`),null}}function _w(e,t,i){e[4*t+0]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function xw(e,t,i){const r=2===i&&"arithmetic"===e.rotationType;t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function bw(e,t,i){if(!e)return null;const r=!t.supportedTypes||!!t.supportedTypes.size,s=!t.supportedTypes||!!t.supportedTypes.color,a=!t.supportedTypes||!!t.supportedTypes.rotation,n=!!t.supportedTypes&&!!t.supportedTypes.opacity,o=e.reduce(((e,o)=>{if(!e)return e;if(o.valueExpression)return fw(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(o.type){case"size":return r?yw(o,e,t,i):e;case"color":return s?function(e,t,i){if(e.normalizationField)return fw(i,"Could not convert color info: unsupported property"),null;if(mw(e.field)){if(!e.stops)return fw(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return fw(i,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.color.values[e]=i.value,_w(t.color.colors,e,i.color)}}}else{if(!(e.stops&&e.stops.length>=0))return fw(i,"Could not convert color info: no field and no colors/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.color.values[e]=1/0,_w(t.color.colors,e,i)}}return t}(o,e,i):e;case"opacity":return n?function(e,t,i){if(e.normalizationField)return fw(i,"Could not convert opacity info: unsupported property"),null;if(mw(e.field)){if(!e.stops)return fw(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return fw(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.opacity.values[e]=i.value,t.opacity.opacityValues[e]=i.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return fw(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=i}}return t}(o,e,i):null;case"rotation":return a?function(e,t,i){if(!mw(e.field))return fw(i,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return fw(i,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return xw(e,t.rotation,0),t;case"roll":return xw(e,t.rotation,1),t;case null:case void 0:case"heading":return xw(e,t.rotation,2),t;default:return fw(i,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}(o,e,i):e;default:return null}}),{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&o)||o.size||o.color||o.opacity||o.rotation?o&&o.size&&!function(e,t,i){for(let i=0;i<3;++i){let r=t.unitInMeters;1===e.type[i]&&(r*=t.modelSize[i],e.type[i]=2),e.minSize[i]=e.minSize[i]/r,e.maxSize[i]=e.maxSize[i]/r,e.offset[i]=e.offset[i]/r,e.factor[i]=e.factor[i]/r}let r;if(0!==e.type[0])r=0;else if(0!==e.type[1])r=1;else{if(0===e.type[2])return fw(i,"No size axis contains a valid size or scale"),!1;r=2}for(let t=0;t<3;++t)0===e.type[t]&&(e.minSize[t]=e.minSize[r],e.maxSize[t]=e.maxSize[r],e.offset[t]=e.offset[r],e.factor[t]=e.factor[r],e.type[t]=e.type[r]);return!0}(o.size,t,i)?null:o:null}function ww(e){return e&&null!=e.size}function Cw(e,t){if(!e)return{enabled:!1};if(xc.DISABLE_FAST_UPDATES)return{enabled:!1};const i=bw(e.visualVariables,t);return i?{enabled:!0,visualVariables:i,materialParameters:Pw(i,t),requiresShaderTransformation:ww(i)}:{enabled:!1}}function Sw(e,t,i){if(!t||!e.enabled)return!1;const r=e.visualVariables,s=bw(t.visualVariables,i);return!!s&&(!!(Tw(r.size,s.size,"size")&&Tw(r.color,s.color,"color")&&Tw(r.rotation,s.rotation,"rotation")&&Tw(r.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=Pw(s,i),e.requiresShaderTransformation=ww(s),!0))}function Tw(e,t,i){if(!!e!=!!t)return!1;if(e&&e.field!==t.field)return!1;if(e&&"rotation"===i){const i=e,r=t;for(let e=0;e<3;e++)if(i.type[e]!==r.type[e]||i.offset[e]!==r.offset[e]||i.factor[e]!==r.factor[e])return!1}return!0}function Pw(e,t){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=ww(e);return e&&e.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=e.size.minSize,i.vvSizeMaxSize=e.size.maxSize,i.vvSizeOffset=e.size.offset,i.vvSizeFactor=e.size.factor):e&&r&&(i.vvSizeValue=t.transformation.scale),e&&r&&(i.vvSymbolAnchor=t.transformation.anchor,i.vvSymbolRotationMatrix=Br(),Si(Mw),function(e,t,i,r=jr()){const s=e||0,a=t||0,n=i||0;0!==s&&Ci(r,r,-s/180*Math.PI),0!==a&&Ti(r,r,a/180*Math.PI),0!==n&&Pi(r,r,n/180*Math.PI)}(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],Mw),Qr(i.vvSymbolRotationMatrix,Mw)),e&&e.color&&(i.vvColorEnabled=!0,i.vvColorValues=e.color.values,i.vvColorColors=e.color.colors),e&&e.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=e.opacity.values,i.vvOpacityOpacities=e.opacity.opacityValues),i}var Rw;!function(e){const t=jr(),i=je();e.evaluateModelTransform=function(e,r,s){if(!e.vvSizeEnabled)return s;_i(t,s);const a=e.vvSymbolRotationMatrix;Oi(Mw,a[0],a[1],a[2],0,a[3],a[4],a[5],0,a[6],a[7],a[8],0,0,0,0,1),wi(t,t,Mw);for(let t=0;t<3;++t){const s=e.vvSizeOffset[t]+r[0]*e.vvSizeFactor[t];i[t]=Re(s,e.vvSizeMinSize[t],e.vvSizeMaxSize[t])}return Di(t,t,i),Mi(t,t,e.vvSymbolAnchor),t},e.evaluateModelTransformScale=function(e,t,i){if(!t.vvSizeEnabled)return Ye(e,1,1,1);for(let r=0;r<3;++r){const s=t.vvSizeOffset[r]+i[0]*t.vvSizeFactor[r];e[r]=Re(s,t.vvSizeMinSize[r],t.vvSizeMaxSize[r])}return e}}(Rw||(Rw={}));const Mw=jr(),Ow=Rw.evaluateModelTransform,Dw=Rw.evaluateModelTransformScale,Aw=jr(),Ew=ke(0,0,1),Iw=[.25,.25,.75,.75],Lw=[64,64];class Fw extends sb{constructor(e,t,i,r){super(e,t,i,r),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._texture=null,this._releaseTexture=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(h(i))this._prepareResourcesPrimitive(t,i);else{const i=ni(this.symbol,this.symbolLayer),r=le(i);r&&"application/json"===r.mediaType?await this._prepareResourcesCIM(t,JSON.parse(r.data),e):await this._prepareResourcesHref(t,i,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=wl(this._getIconSize());if(e)throw new ee("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?kt(e.size):16);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){const t=this._getGraphicHash(e);let i=""===t?null:this._cimSymbolTextures.get(t);if(!i){const r={scaleFactor:this._cimScaleFactorOrFunction},s=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",r,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",s.anchorPosition);const a={width:s.imageData.width,height:s.imageData.height,powerOfTwoResizeMode:2};i=new id(s.imageData,"symbol",a),this._cimSymbolTextures.set(t,i),this._context.stage.add(4,i)}return i}_computeSize(e,t){const i=e.width/e.height;return i>1?[t,Math.round(t/i)]:[Math.round(t*i),t]}_prepareMaterialParameters(){const e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){const{screenLength:i,minWorldLength:r,maxWorldLength:s}=t.verticalOffset;e.verticalOffset={screenLength:kt(i),minWorldLength:r||0,maxWorldLength:null!=s?s:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const i=this._getOutlineSize();if(Vw(t)&&0===i)throw new Error("Nothing to render");this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const r=this._context.sharedResources.textures.fromData(t,(()=>function(e){let t;const i=128,r=.5*i;switch(e){case"circle":t=gc(i,r);break;case"square":t=fc(i,r);break;case"kite":t=mc(i,r);break;case"cross":t=pc(i,r);break;case"x":t=uc(i,r);break;case"triangle":t=dc(i,r)}return new id(t,"sdf_"+e,{mipmap:!1,wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})}(t)));this._texture=r.texture,this._releaseTexture=()=>this._context.sharedResources.textures.release(r.uid),e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=Iw,e.textureId=this._texture.id;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=2,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,t,r){if(!i("esri-canvas-svg-support")&&ce(t)){throw new ee("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)")}this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const s=this._getIconSize(),a=s*this._context.layerView.view.pixelRatio,n=await oe(this._context.sharedResources.textures.fromUrl(t,a,{signal:r}));if(!1===n.ok){N(n.error);throw new ee("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`)}const{uid:o,texture:l}=n.value;this._releaseTexture=()=>this._context.sharedResources.textures.release(o);const c=l.params;this._size=this._computeSize(c,s),e.textureId=l.id,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,t,i){const r=new Ft({data:t});if(!this._context.sharedResources.cimSymbolRasterizer){const e=(await import("../chunks/CIMSymbolRasterizer.js")).CIMSymbolRasterizer;q(i),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference,!0))}const s=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):null;let a,n;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(r,s,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:i}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,i=await Lt(t,this._context.layer.spatialReference,s);n=(e,t,r)=>{const s=ed(i,e,{$view:r},"esriGeometryPoint",t);return null!==s?s:1}}else a=Number(e.scaleExpression)}this._cimScaleFactorOrFunction=a||n||1;const o=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fields):[];q(i);const l=this._context.layer.fieldsIndex;this._cimRequiredFields=o.map((e=>l.get(e).name)),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||qt}_getOutlineSize(){let e=0;const t=this.symbolLayer;if(h(t.outline)&&null!=t.outline.size)return Math.max(kt(t.outline.size),0);return e=Vw(this._getPrimitive())?1.5:0,Math.max(e,0)}_getOutlineColor(){const e=this._getLayerOpacity(),t=this.symbolLayer,i=g(t,"outline","color");if(h(i)){const t=At.toUnitRGB(i),r=i.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]}_getFillColor(){if(Vw(this._getPrimitive()))return wc;const e=u(this._getPrimitive()),t=g(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return"relative"===e?hn((t.x||0)+.5,.5-(t.y||0)):e in Cl?Cl[e]:Cl.center}_createMaterialAndAddToStage(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=Cw(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&n(e,this._fastUpdates.materialParameters),this._cimLayers){let i=this._cimSymbolMaterials.get(e.textureId);return i||(i=new ac(e,this._getIdHint("_icon")),this._cimSymbolMaterials.set(e.textureId,i),t.add(3,i)),i}return this._material=new ac(e,this._getIdHint("_icon")),t.add(3,this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((e=>{e.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})})),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial((e=>{this._context.stage.remove(3,e.id)})),h(this._material)&&(this._material=null),this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>{this._context.stage.remove(4,e.id)})),this._cimSymbolTextures.clear(),this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const i=e.size[t];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[t]=kt(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.renderingInfo,i=e.graphic;let r,s;if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(i),t={textureId:e.id,...this._cimMaterialParametersInfo};s=this._createMaterialAndAddToStage(t,this._context.stage),r=[e.params.width,e.params.height]}else r=this._size,s=m(this._material);if(!this._validateGeometry(i.geometry))return null;const a=bh(i.geometry);if(u(a))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const n="graphic"+i.uid,o=this._getVertexOpacityAndColor(t);let l=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const e=r[0]>r[1]?r[0]:r[1];l=this._getScaleFactor(t,e)}l*=this._symbolTextureRatio;const c=[r[0]*l,r[1]*l],h=this.setGraphicElevationContext(i,new oc);return this.ensureDrapedStatus("on-the-ground"===h.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(i,a,s,o,c,e.layer.uid):this._createAs3DShape(i,a,s,o,c,h,n,i.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial((i=>{i.setParameterValues({color:e}),i.setParameterValues({outlineColor:t})})),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=fh(Fw.elevationModeChangeTypes,i,r);if(s!==mh.UPDATE)return s;const a=gh(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((e=>{e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!Sw(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;h(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}_defaultElevationInfoNoZ(){return zw}_createAs3DShape(e,t,i,r,s,a,n,o){const l=this.getFastUpdateAttrValues(e),c=l?e=>Ow(this._fastUpdates.materialParameters,l,e):null,h=fl.createPointGeometry(Ew,null,r,s,Uw,null,l),d=[new ql(h,n)],u=_h(this._context,t,d,[i],null,null,a,n,this._context.layer.uid,o,c);if(null===u)return null;const p=xx,m=new zx(this,u.object,d,null,null,p,a);return m.alignedSampledElevation=u.sampledElevation,m.needsElevationUpdates=gh(a.mode)||"absolute-height"===a.mode,m.getScreenSize=this._createScreenSizeGetter(s,c),m.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(m.getScreenSize(),1,e),xh(m,t,this._context.elevationProvider),m}_createAsOverlay(e,t,i,r,s,a){i.renderPriority=this._renderPriority;const n=je();ir(t,n,this._context.overlaySR),n[2]=bc;const o=this._context.clippingExtent;if(h(o)&&!ta(o,n))return null;const l=this.getFastUpdateAttrValues(e),c=l?e=>Ow(this._fastUpdates.materialParameters,l,e):null,d=fl.createPointGeometry(Ew,n,r,s,null,null,l),u=new td(d);u.material=i,u.center=n,u.bsRadius=0,u.data.layerUid=a,u.data.graphicUid=e.uid,u.calculateShaderTransformation=c;const p=new lw(this,[u],null);return p.getScreenSize=this._createScreenSizeGetter(s,c),p.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(p.getScreenSize(),1,e),p}_createScreenSizeGetter(e,t){const i=this._outlineSize+2;if(this._fastUpdates.enabled){const r=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return(e=cn())=>{const a=t(Aw);return e[0]=a[0]*r+i,e[1]=a[5]*s+i,e}}{const t=e[0]/this._symbolTextureRatio+i,r=e[1]/this._symbolTextureRatio+i;return(e=cn())=>(e[0]=t,e[1]=r,e)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=ke(e,e,e),i=jt(1),r=e*i;return{modelSize:t,symbolSize:ke(r,r,r),unitInMeters:i,transformation:{anchor:Ge,scale:Be,rotation:Ge}}}_getGraphicHash(e){let t="";for(const i of this._cimRequiredFields)t+=i+e.attributes[i];return t}_forEachMaterial(e){h(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}}function Vw(e){return!!h(e)&&("cross"===e||"x"===e)}Fw.PRIMITIVE_SIZE=Lw,Fw.elevationModeChangeTypes={definedChanged:mh.UPDATE,staysOnTheGround:mh.NONE,onTheGroundChanged:mh.RECREATE};const zw={mode:"relative-to-ground",offset:0},Uw=Pr(0,0,0,1);class kw extends sb{constructor(e,t,i,r){super(e,t,i,r),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=Cw(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:jt(1);if(e<0)throw new ee("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}}getMaterialParameters(e){const t=g(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t),r=i[3],s={width:1,color:i,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:r<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:this.symbolLayer.stipplePattern?Dh(this.symbolLayer.stipplePattern.map(kt)):null,stippleOffColor:this.symbolLayer.stippleOffColor?At.toUnitRGBA(this.symbolLayer.stippleOffColor):null,stippleIntegerRepeats:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(s.width=kt(1));else{const e=null!=this.symbolLayer.size?this.symbolLayer.size:jt(1);s.width=kt(e)}return this._fastUpdates&&this._fastUpdates.visualVariables?{...s,...this._fastUpdates.materialParameters}:s}get lineMaterial(){return u(this._lineMaterial)&&(this._lineMaterial=new Sl(this.getMaterialParameters(!1),this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._lineMaterial)),this._lineMaterial}get ringMaterial(){return u(this._ringMaterial)&&(this._ringMaterial=new Sl(this.getMaterialParameters(!0),this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._ringMaterial)),this._ringMaterial}destroy(){super.destroy(),h(this._lineMaterial)&&(this._context.stage.remove(3,this._lineMaterial.id),this._lineMaterial=null),h(this._ringMaterial)&&(this._context.stage.remove(3,this._ringMaterial.id),this._ringMaterial=null)}getDrivenSize(e){return this._drivenProperties.size&&e.size?kt(function(e){for(let t=0;t<3;t++){const i=e[t];if("number"==typeof i)return isFinite(i)?i:0}return 0}(e.size)):1}getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?ab(this._fastUpdates.visualVariables.size.field,e):null}getDrivenColor(e){const t=Pr(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?ab(this._fastUpdates.visualVariables.color.field,e):null}getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?ab(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic,i=t.geometry;if(!this._validateGeometryType(t.geometry,kw.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(i))return null;const r="graphic"+t.uid,s=this.setGraphicElevationContext(t,new oc);return this.ensureDrapedStatus("on-the-ground"===s.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,s,r,t.uid)}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!Sw(this._fastUpdates,t,this._vvConvertOptions))return!1;h(this._lineMaterial)&&this._lineMaterial.setParameterValues(this._fastUpdates.materialParameters),h(this._ringMaterial)&&this._ringMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}layerOpacityChanged(){return h(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),h(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0}updateMaterialLayerOpacity(e){const t=e.params.color,i=g(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i),s=r<1||this.needsDrivenTransparentPass,a=[t[0],t[1],t[2],r];e.setParameterValues({color:a,transparent:s})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=fh(kw.elevationModeChangeTypes,i,r);if(s!==mh.UPDATE)return s;const a=gh(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return h(this._lineMaterial)&&this._lineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),h(this._ringMaterial)&&this._ringMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof Pe)return It.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,i,r){const s=e.graphic,a=this._getGeometryAsPolygonOrPolyline(s.geometry),n="polygon"===a.type?a.rings:a.paths,o=[],l=[],c=[],d=js(),u=Cc(a,this._context.elevationProvider,this._context.renderCoordsHelper,t),p="polygon"===a.type?"rings":"paths";this._logGeometryCreationWarnings(u,n,p,"LineSymbol3DLayer");for(let t=0;t<u.lines.length;t++){const{position:r,mapPosition:s}=u.lines[t];if(h(this._context.clippingExtent)&&(Bs(d),Ks(d,s),!Js(d,this._context.clippingExtent)))continue;const n=this._createGeometryData(e,r,s,a.type),p=new ql(n,i+"path"+t);o.push(p),l.push("polygon"===a.type?this.ringMaterial:this.lineMaterial),c.push(Nr)}if(0===o.length)return null;const m=new Wc({geometries:o,materials:l,transformations:c,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r},idHint:i}),f=new zx(this,m,o,null,null,yx,t);return f.alignedSampledElevation=u.sampledElevation,f.needsElevationUpdates=gh(t.mode),f}_createGeometryData(e,t,i,r){const s="polygon"===r?1:0,a=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return Sc({removeDuplicateStartEnd:s,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:n?null:this.getDrivenSize(e.renderingInfo),color:a?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),s="polygon"===r.type?r.rings:r.paths,a="polygon"===r.type?this.ringMaterial:this.lineMaterial;a.renderPriority=this._renderPriority;const n=[],o=js(),l=Bs(),c=Tc(r,this._context.overlaySR),h="polygon"===r.type?"rings":"paths";if(this._logGeometryCreationWarnings(c,s,h,"LineSymbol3DLayer"),s.length>0){const{lines:s}=c;for(let c=0;c<s.length;++c){const h=s[c];if(Bs(o),Ks(o,h.position),!Js(o,this._context.clippingExtent))continue;Ys(l,o);const d=this._createGeometryData(e,h.position,null,r.type),u=new td(d);u.data.layerUid=t,u.data.graphicUid=i.uid,u.material=a,u.center=[.5*(o[0]+o[3]),.5*(o[1]+o[4]),0],u.bsRadius=.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1])),n.push(u)}return new lw(this,n,l)}return null}}function jw(e){switch(e){case"multiply":return 1;case"ignore":return 2;case"replace":return 3;case"tint":return 4;default:return 1}}function Gw(e,t,i){if(u(e)||2===t)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const r=Re(Math.round(e[3]*Nw),0,Nw),s=0===r||4===t?0:3===t?qw:Hw;i[0]=Re(Math.round(e[0]*Bw),0,Bw),i[1]=Re(Math.round(e[1]*Bw),0,Bw),i[2]=Re(Math.round(e[2]*Bw),0,Bw),i[3]=r+s}kw.validGeometryTypes=["polyline","polygon","extent"],kw.elevationModeChangeTypes={definedChanged:mh.RECREATE,staysOnTheGround:mh.NONE,onTheGroundChanged:mh.RECREATE};const Bw=255,Nw=85,qw=Nw,Hw=2*Nw,Ww=Ll;class Zw extends sb{constructor(e,t,i,r){super(e,t,i,r),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){xc.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new rd({color:[1,0,1,1]},"debugVertexNormal"),this._debugFaceNormalMaterial=new rd({color:[0,1,1,1]},"debugFAceNormal"))}destroy(){super.destroy(),this._materials.forEach((e=>{this._context.stage.remove(3,e.material.id)})),this._textures.forEach((e=>{this._context.stage.remove(4,e.id)})),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometryType(t.geometry,Zw.validGeometryTypes,"fill on mesh-3d"))return null;if(!this._validateGeometry(t.geometry))return null;const i="graphic"+t.uid,r=this.setGraphicElevationContext(t,new oc),s=e.renderingInfo;return this._createAs3DShape(t,s,r,i,t.uid)}layerOpacityChanged(e,t){const i=this._getLayerOpacity();return this._materials.forEach((e=>{e.material.setParameterValues({layerOpacity:i});const t=e.material.params;this._setMaterialTransparentParameter(t,e),e.material.setParameterValues({transparent:t.transparent})})),e.forEach((e=>{const r=t(e);h(r)&&r.layerOpacityChanged(i,this._context.isAsync)})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,yh)}slicePlaneEnabledChanged(e,t){return this._materials.forEach((e=>{e.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),e.forEach((e=>{const i=t(e);h(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){return this._materials.forEach((e=>{const{isSchematic:t}=e.material.params;e.material.setParameterValues({usePBR:this._usePBR(t)})})),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return e?e instanceof At?e.toHex():e.contentHash:"-"}_materialPropertiesDefault(e,t){const i=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,s=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:r,hasVertexTangents:s,uid:`vc:${r},vt:${s},vct${t},svc:${i}`}}_materialProperties(e,t,i){const r=this._materialPropertiesDefault(e,i);if(!t.material)return r;const{color:s,colorTexture:a,normalTexture:n,doubleSided:o,alphaCutoff:l,alphaMode:c}=t.material,h=this._colorOrTextureUid(s),d=this._colorOrTextureUid(a),u=this._colorOrTextureUid(n);if(r.color=s,r.colorTexture=a,r.normalTexture=n,r.uid=`${r.uid},cmuid:${h},ctmuid:${d},ntmuid:${u},ds:${o},ac:${l},am:${c}`,t.material instanceof Vr){const{metallic:e,roughness:i,metallicRoughnessTexture:s,emissiveColor:a,emissiveTexture:n,occlusionTexture:o}=t.material,l=this._colorOrTextureUid(s),c=this._colorOrTextureUid(a),h=this._colorOrTextureUid(n),d=this._colorOrTextureUid(o);r.metallic=e,r.roughness=i,r.metallicRoughnessTexture=s,r.emissiveColor=a,r.emissiveTexture=n,r.occlusionTexture=o,r.uid=`${r.uid},mrm:${e},mrr:${i},mrt:${l},emuid:${c},etmuid:${h},otmuid:${d}`}return r}_setInternalColorValueParameters(e,t){t.diffuse=At.toUnitRGB(e),t.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e,t){const i=this._getLoadableTextureResource(e);if(!i)return;const r=e.contentHash;let s=this._textures.get(r);return s||(s=new id(i,`${t}_${r}_tex`,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!0}),this._textures.set(r,s),this._context.stage.add(4,s)),s.id}_castTextureWrap(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return{s:t,t:t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;case"repeat":default:return 10497}}_setInternalMaterialParameters(e,t,i){e.color&&this._setInternalColorValueParameters(e.color,i),e.colorTexture&&(i.textureId=this._getInternalTextureId(e.colorTexture,t)),e.normalTexture&&(i.normalTextureId=this._getInternalTextureId(e.normalTexture,t)),e.emissiveColor&&(i.emissiveFactor=At.toUnitRGB(e.emissiveColor)),e.emissiveTexture&&(i.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture,t)),e.occlusionTexture&&(i.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture,t)),e.metallicRoughnessTexture&&(i.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture,t))}_setExternalMaterialParameters(e){const t=this._drivenProperties.color;let i=h(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(t)e.externalColor=Mr;else{const t=h(this.symbolLayer.material)?this.symbolLayer.material.color:null;h(t)?e.externalColor=At.toUnitRGBA(t):(i=null,e.externalColor=Mr)}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(!t)return!1;for(let e=3;e<t.length;e+=4)if(255!==t[e])return!0;return!1}_getOrCreateMaterial(e,t){const i=t.material&&t.material.color,r=t.material&&t.material.colorTexture,s=t.material&&"blend"===t.material.alphaMode,a=!(t.material&&"opaque"===t.material.alphaMode)&&(this._hasTransparentVertexColors(e)||i&&i.a<1||r&&r.transparent||s),n=this._materialProperties(e,t,a),o=this._materials.get(n.uid);if(o)return o.material;const l={material:null,isComponentTransparent:a,alphaMode:t.material?t.material.alphaMode:"opaque"},c=this._getIdHint(),h=null==n.metallicRoughnessTexture&&null==n.metallic&&null==n.roughness,d={usePBR:this._usePBR(h),isSchematic:h,vertexColors:n.hasVertexColors,symbolColors:n.hasSymbolVertexColors,vertexTangents:n.hasVertexTangents,ambient:Ge,diffuse:Be,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,textureAlphaPremultiplied:!0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};h||(d.mrrFactors=[null!=n.metallic?n.metallic:1,null!=n.roughness?n.roughness:1,.5]),t.material&&(d.doubleSided=t.material.doubleSided,d.cullFace=t.material.doubleSided?0:2,d.textureAlphaCutoff=t.material.alphaCutoff),this._setInternalMaterialParameters(n,c,d),this._setExternalMaterialParameters(d),this._setMaterialTransparentParameter(d,l);const u=new Eh(d,`${c}_${n.uid}_mat`);return l.material=u,this._materials.set(n.uid,l),this._context.stage.add(3,u),u}_usePBR(e){return!e||this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?3:1:e.textureAlphaMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:0}_addDebugNormals(e,t,i,r){const s=t.length,a=e.spatialReference.isGeographic?20015077/180:1,n=.1*Math.max(e.extent.width*a,e.extent.height*a,e.extent.zmax-e.extent.zmin),o=[],l=[],c=[],h=[];for(let e=0;e<s;e++){const i=t[e],r=i.data.getAttribute(Ww.POSITION),s=i.data.getAttribute(Ww.NORMAL),a=i.data.getIndices(Ww.POSITION),d=i.data.getIndices(Ww.NORMAL),u=r.data,p=s.data;for(let e=0;e<a.length;e++){const t=3*a[e],i=3*d[e];for(let e=0;e<3;e++)o.push(u[t+e]);for(let e=0;e<3;e++)o.push(u[t+e]+p[i+e]*n);if(l.push(l.length),l.push(l.length),e%3==0){this._calculateFaceNormal(u,a,e,Kw),this._getFaceVertices(u,a,e,Yw,$w,Xw),Qe(Yw,Yw,$w),Qe(Yw,Yw,Xw),Ze(Yw,Yw,1/3);for(let e=0;e<3;e++)c.push(Yw[e]);for(let e=0;e<3;e++)c.push(Yw[e]+Kw[e]*n);h.push(h.length),h.push(h.length)}}}{const e={[Ww.POSITION]:{data:new Float64Array(o),size:3}},s={[Ww.POSITION]:new Uint32Array(l)},a=new Hl(e,s,"line"),n=new ql(a,"debugVertexNormal");t.push(n),i.push(this._debugVertexNormalMaterial),r.push(qr(r[0]))}{const e={[Ww.POSITION]:{data:new Float64Array(c),size:3}},s={[Ww.POSITION]:new Uint32Array(h)},a=new Hl(e,s,"line"),n=new ql(a,"debugFaceNormal");t.push(n),i.push(this._debugFaceNormalMaterial),r.push(qr(r[0]))}}_createAs3DShape(e,t,i,r,s){const a=e.geometry;if("mesh"!==a.type)return null;const n=this._createGeometryInfo(a,t,r);if(!n)return null;const{geometries:o,materials:l,transformations:c,objectTransformation:d}=n;xc.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(a,o,l,c);const u=new Wc({geometries:o,materials:l,transformations:c,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:s},idHint:r});u.objectTransformation=d;const p=xx,m=this._createEdgeMaterial(),f=h(m)?{baseMaterial:l[0],edgeMaterials:[m],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,g=new zx(this,u,o,null,null,p,i,f);g.needsElevationUpdates=yh(i.mode);const v=a.extent.center.clone();return v.z=0,g.elevationContext.centerPointInElevationSR=v,g.alignedSampledElevation=p(g,g.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),g}_createComponentNormals(e,t,i,r){switch(i.shading||"flat"){case"source":return this._createComponentNormalsSource(e,t,i,r);case"flat":return this._createComponentNormalsFlat(e,r);case"smooth":return this._createComponentNormalsSmooth(e,r);default:return}}_createComponentNormalsSource(e,t,i,r){if(!t)return this._createComponentNormalsFlat(e,r);let s=!1;if(!i.trustSourceNormals)for(let i=0;i<r.length;i+=3){this._calculateFaceNormal(e,r,i,Kw);for(let e=0;e<3;e++){const a=3*r[i+e];Yw[0]=t[a+0],Yw[1]=t[a+1],Yw[2]=t[a+2],st(Kw,Yw)<0&&(t[a+0]=-t[a+0],t[a+1]=-t[a+1],t[a+2]=-t[a+2],s=!0)}}return{normals:t,indices:r,didFlipNormals:s}}_createComponentNormalsFlat(e,t){const i=new Float32Array(t.length),r=new Uint32Array(3*t.length);for(let s=0;s<t.length;s+=3){const a=this._calculateFaceNormal(e,t,s,Kw);for(let e=0;e<3;e++)i[s+e]=a[e],r[s+e]=s/3}return{normals:i,indices:r,didFlipNormals:!1}}_createComponentNormalsSmooth(e,t){const i={};for(let r=0;r<t.length;r+=3){const s=this._calculateFaceNormal(e,t,r,Kw);for(let e=0;e<3;e++){const a=t[r+e];let n=i[a];n||(n={normal:je(),count:0},i[a]=n),Qe(n.normal,n.normal,s),n.count++}}const r=new Float32Array(3*t.length),s=new Uint32Array(3*t.length);for(let e=0;e<t.length;e++){const a=i[t[e]];1!==a.count&&(nt(a.normal,a.normal),a.count=1);for(let t=0;t<3;t++)r[3*e+t]=a.normal[t];s[e]=e}return{normals:r,indices:s,didFlipNormals:!1}}_getFaceVertices(e,t,i,r,s,a){const n=3*t[i+0],o=3*t[i+1],l=3*t[i+2];r[0]=e[n+0],r[1]=e[n+1],r[2]=e[n+2],s[0]=e[o+0],s[1]=e[o+1],s[2]=e[o+2],a[0]=e[l+0],a[1]=e[l+1],a[2]=e[l+2]}_calculateFaceNormal(e,t,i,r){return this._getFaceVertices(e,t,i,Yw,$w,Xw),at($w,$w,Yw),at(Xw,Xw,Yw),Je(Yw,$w,Xw),nt(r,Yw),r}_getOrCreateComponents(e){return e.components?e.components:iC}_createPositionBuffer(e){const t=e.vertexAttributes.position,i=new Float64Array(t.length),r=this._context.renderCoordsHelper.spatialReference;return ar(e.vertexAttributes.position,e.spatialReference,0,i,r,0,t.length/3),i}_createNormalBuffer(e,t){const i=e.vertexAttributes.normal;if(!i)return null;if("local"===this._context.layerView.view.viewingMode)return i;const r=e.vertexAttributes.position,s=new Float32Array(i.length);return Os(i,r,t,e.spatialReference,s)}_createTangentBuffer(e,t){const i=e.vertexAttributes.tangent;if(!i)return null;if("local"===this._context.layerView.view.viewingMode)return i;const r=e.vertexAttributes.position,s=new Float32Array(i.length);return Ds(i,r,t,e.spatialReference,s)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),i=jw(g(this.symbolLayer,"material","colorMixMode")),r=new Uint8Array(4);return Gw(t,i,r),r}return null}_createColorIndices(e){const t=new Uint32Array(e.length);for(let e=0;e<t.length;e++)t[e]=0;return t}_createBuffers(e,t){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const r=e.vertexAttributes.normal,s=e.vertexAttributes.uv,a=e.vertexAttributes.tangent;if(r&&r.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(a&&a.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(s&&s.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const n=this._createPositionBuffer(e),o=this._createColorBuffer(e),l=this._createSymbolColorBuffer(t),c=this._createNormalBuffer(e,n);return{positionBuffer:n,normalBuffer:c,tangentBuffer:this._createTangentBuffer(e,n),uvBuffer:s,colorBuffer:o,symbolColorBuffer:l,objectTransformation:this._transformCenterLocal(e,n,c)}}_transformCenterLocal(e,t,i){const r=e.extent.center,s=this._context.renderCoordsHelper.spatialReference;Qw[0]=r.x,Qw[1]=r.y,Qw[2]=0;const a=jr();nr(e.spatialReference,Qw,a,s),xi(Jw,a);for(let e=0;e<t.length;e+=3)Yw[0]=t[e+0],Yw[1]=t[e+1],Yw[2]=t[e+2],it(Yw,Yw,Jw),t[e+0]=Yw[0],t[e+1]=Yw[1],t[e+2]=Yw[2];if(i){Qr(eC,a),Wr(eC,eC);for(let e=0;e<i.length;e+=3)Yw[0]=i[e+0],Yw[1]=i[e+1],Yw[2]=i[e+2],lt(Yw,Yw,eC),i[e+0]=Yw[0],i[e+1]=Yw[1],i[e+2]=Yw[2]}return a}_validateFaces(e,t){const i=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){const i=r[t];i>e&&(e=i)}if(i<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,t){if(t.faces)return t.faces;{const t=new Uint32Array(e.vertexAttributes.position.length/3);for(let e=0;e<t.length;e++)t[e]=e;return t}}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;const i=this._context.elevationProvider.spatialReference;let r;const s=t.length/3;return e.spatialReference.equals(i)?r=t:(r=new Float64Array(t.length),ar(e.vertexAttributes.position,e.spatialReference,0,r,i,0,s)),Bs(tC),Ks(tC,r,0,s),!Js(tC,this._context.clippingExtent)}_createGeometryInfo(e,t,i){if(!lr(e.spatialReference,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const r=this._createBuffers(e,t);if(!r)return null;const{positionBuffer:s,uvBuffer:a,colorBuffer:n,symbolColorBuffer:o,normalBuffer:l,tangentBuffer:c,objectTransformation:h}=r,d=this._getOrCreateComponents(e),u=[],p=[],m=[];let f=!1;for(const t of d){if(!this._validateFaces(e,t))return null;const r=this._getOrCreateFaces(e,t);if(0===r.length)continue;const h=this._createComponentNormals(s,l,t,r);h.didFlipNormals&&(f=!0);const d={[Ww.POSITION]:{size:3,data:s},[Ww.NORMAL]:{size:3,data:h.normals}},g={[Ww.POSITION]:r,[Ww.NORMAL]:h.indices};n&&(d[Ww.COLOR]={size:4,data:n},g[Ww.COLOR]=r),o&&(d[Ww.SYMBOLCOLOR]={size:4,data:o},g[Ww.SYMBOLCOLOR]=this._createColorIndices(r)),e.vertexAttributes.uv&&(d[Ww.UV0]={size:2,data:a},g[Ww.UV0]=r),e.vertexAttributes.tangent&&(d[Ww.TANGENT]={size:4,data:c},g[Ww.TANGENT]=r);const v=new Hl(d,g),y=new ql(v,`${i}_mesh`);u.push(y),p.push(jr()),m.push(this._getOrCreateMaterial(e,t))}return f&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:u,transformations:p,materials:m,objectTransformation:h}}_createEdgeMaterial(){const e={opacity:this._getLayerOpacity()};return Gx(this.symbolLayer,e)}}Zw.validGeometryTypes=["mesh"];const Qw=je(),Yw=je(),$w=je(),Xw=je(),Kw=je(),Jw=jr(),eC=Br(),tC=js(),iC=[new zr];class rC{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=r,this.type="lod-instance",this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){nc(this.elevationContext.featureExpressionInfoContext,i);const r=this.elevationAligner(this,this.elevationContext,e,t);null!=r&&(this.alignedSampledElevation=r)}}getBSRadius(){const e=this.lodRenderer;return e.baseBoundingSphere.radius*e.instanceData.getCombinedMaxScaleFactor(this.instanceIndex)}getCenterObjectSpace(e=je()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,lC),it(e,this.lodRenderer.baseBoundingSphere.center,lC)}getBoundingBoxObjectSpace(e=js()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,lC);const t=this.lodRenderer.baseBoundingBox;Bs(e);for(let i=0;i<8;++i)Ye(aC,0==(1&i)?t[0]:t[3],0==(2&i)?t[1]:t[4],0==(4&i)?t[2]:t[5]),it(aC,aC,lC),ia(e,aC);return e}computeAttachmentOrigin(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,lC),e.render.origin[0]+=lC[12],e.render.origin[1]+=lC[13],e.render.origin[2]+=lC[14],e.render.num++}async getProjectedBoundingBox(e,t,i,r,s){const a=this.getBoundingBoxObjectSpace(s),n=oC,o=Gs(a)?1:n.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,lC);for(let e=0;e<o;e++){const t=n[e];aC[0]=a[t[0]],aC[1]=a[t[1]],aC[2]=a[t[2]],it(aC,aC,lC),sC[3*e+0]=aC[0],sC[3*e+1]=aC[1],sC[3*e+2]=aC[2]}if(!e(sC,0,o))return null;Bs(a);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let e=0;e<3*o;e+=3){for(let t=0;t<3;t++)a[t]=Math.min(a[t],sC[e+t]),a[t+3]=Math.max(a[t+3],sC[e+t]);l&&i.push({location:sC.slice(e,e+3),screenSpaceBoundingRect:l})}if(t&&(Ns(a,nC),"absolute-height"!==this.elevationContext.mode)){let e;const i=_l(a,t);try{e=await t.service.queryElevation(nC[0],nC[1],r,i,"ground")}catch(t){e=null}null!=e&&qs(a,0,0,-this.alignedSampledElevation+e)}return a}addObjectState(e,t){if(0===e){const i=Zc(e);this.addHighlightId(i),t.addExternal((e=>{this.removeHighlightId(e)}),i)}}removeObjectState(e){this.highlights&&this.highlights.forEach((t=>e.remove(t)))}addHighlightId(e){this.highlights=this.highlights||new Set,this.highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}removeHighlightId(e){this.highlights&&(this.highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this.highlights.size>0),0===this.highlights.size&&(this.highlights=null))}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const sC=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],aC=je(),nC=je(),oC=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],lC=jr();function cC(e,t=hC){const i=function(e){let t=0;return Zx(e).forEach((e=>{t+=e.data.indexCount/3})),t}(e);return Math.sqrt(i/(t*Math.PI))}const hC=.05;var dC;!function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.ACTIVE=2]="ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED"}(dC||(dC={}));class uC{constructor(e){this.localTransform=e.getField("localTransform",ts),this.globalTransform=e.getField("globalTransform",ts),this.modelOrigin=e.getField("modelOrigin",Jr),this.model=e.getField("model",is),this.modelNormal=e.getField("modelNormal",is),this.modelScaleFactors=e.getField("modelScaleFactors",rs),this.boundingSphere=e.getField("boundingSphere",ss),this.color=e.getField("color",es),this.featureAttribute=e.getField("featureAttribute",es),this.state=e.getField("state",as),this.lodLevel=e.getField("lodLevel",as)}}class pC extends se{constructor(e,t){super(),this._capacity=0,this._size=0,this._next=0,this._layout=function(e){let t=Io().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return e.indexOf("color")>=0&&(t=t.vec4f("color")),e.indexOf("featureAttribute")>=0&&(t=t.vec4f("featureAttribute")),t=t.u8("state").u8("lodLevel").alignTo(8),t}(e),this._shaderTransformation=t}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this.grow();const e=this.findSlot();return this._view.state.set(e,dC.ALLOCATED),this._size++,this.emit("instance-added",{index:e}),e}removeInstance(e){const t=this._view.state;Vl(e>=0&&e<this._capacity&&t.get(e)&dC.ALLOCATED,"invalid instance handle"),this.getStateFlag(e,dC.ACTIVE)?this.setStateFlags(e,dC.REMOVE):this.freeInstance(e),this.emit("instance-removed",{index:e})}freeInstance(e){const t=this._view.state;Vl(e>=0&&e<this._capacity&&t.get(e)&dC.ALLOCATED,"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=gC,r=vC;t.localTransform.getMat(e,yC),t.globalTransform.getMat(e,_C);const s=wi(_C,_C,yC);Ye(i,s[12],s[13],s[14]),t.modelOrigin.setVec(e,i),Qr(r,s),t.model.setMat(e,r);const a=Pt(gC,s);a.sort(),t.modelScaleFactors.set(e,0,a[1]),t.modelScaleFactors.set(e,1,a[2]),Yr(r,r),Wr(r,r),t.modelNormal.setMat(e,r),this.setStateFlags(e,dC.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,vC),i.modelOrigin.getVec(e,gC),t[0]=vC[0],t[1]=vC[1],t[2]=vC[2],t[3]=0,t[4]=vC[3],t[5]=vC[4],t[6]=vC[5],t[7]=0,t[8]=vC[6],t[9]=vC[7],t[10]=vC[8],t[11]=0,t[12]=gC[0],t[13]=gC[1],t[14]=gC[2],t[15]=1}applyShaderTransformation(e,t){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){return this._view.localTransform.getMat(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(gC,this,e);t*=Math.max(i[0],i[1],i[2])}return t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(gC,this,e);i.sort(),t*=i[1]}return t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}getColor(e,t){this._view.color.getVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this.setStateFlag(e,dC.VISIBLE,t),this.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this.getStateFlag(e,dC.VISIBLE)}setHighlight(e,t){t!==this.getHighlight(e)&&(this.setStateFlag(e,dC.HIGHLIGHT,t),this.emit("instance-highlight-changed",{index:e}))}getHighlight(e){return this.getStateFlag(e,dC.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i){this.getState(i)&e&&++t}return t}setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}setStateFlag(e,t,i){i?this.setStateFlags(e,t):this.clearStateFlags(e,t)}getStateFlag(e,t){return!!(this._view.state.get(e)&t)}grow(){const e=Math.max(mC,Math.floor(this._capacity*fC)),t=this._layout.createBuffer(e);if(this._buffer){const e=new Uint8Array(this._buffer.buffer);new Uint8Array(t.buffer).set(e)}this._capacity=e,this._buffer=t,this._view=new uC(this._buffer)}findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&dC.ALLOCATED;)t=(t+1)%this._capacity;return this._next=(t+1)%this._capacity,t}}const mC=1024,fC=2,gC=je(),vC=Br(),yC=jr(),_C=jr();class xC extends Tl{constructor(e,t){super({getCenter:e=>{const t=this._instanceData.view.boundingSphere,i=this._tmpCenter;return i[0]=t.get(e,0),i[1]=t.get(e,1),i[2]=t.get(e,2),i},getRadius:e=>this._instanceData.view.boundingSphere.get(e,3)},{maximumDepth:25}),this._tmpCenter=je(),this._tmpMat4=jr(),this._instanceData=e,this._boundingSphere=t}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4),r=it(this._tmpCenter,this._boundingSphere.center,i),s=this._boundingSphere.radius*Rt(i);t.set(e,0,r[0]),t.set(e,1,r[1]),t.set(e,2,r[2]),t.set(e,3,s),this.add(e)}removeInstance(e){this.remove(e)}}class bC{constructor(e,t){this.thresholdScale=1,this._camera=new rh,this._worldSpaceRadius=e,this._thresholds=t.map((e=>e))}updateCamera(e){this._camera.copyFrom(e)}selectLevel(e,t){const i=this._camera.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*t/i,s=this._thresholds;let a=-1;for(let e=0;e<s.length;++e)r>=s[e]*this.thresholdScale&&(a=e);return a}}class wC{constructor(e,t,i,r,s){this._elementSize=r,this._buffer=new ec(e,t,i),this.resize(s)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,t,i,r=0){const s=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,r*this.elementSize).set(s)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this._elementSize,r=t*this._elementSize;this._buffer.setSubData(this._array,i,i,r)}resize(e){const t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setData(t),this._capacity=e}}class CC{constructor(e){this.modelOriginHi=e.getField("modelOriginHi",ns),this.modelOriginLo=e.getField("modelOriginLo",ns),this.model=e.getField("model",is),this.modelNormal=e.getField("modelNormal",is),this.color=e.getField("instanceColor",es),this.featureAttribute=e.getField("instanceFeatureAttribute",es)}}class SC{constructor(e,t){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=t,this._elementSize=t.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){Vl(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){Vl(this._updating,"not updating"),this.size<RC*this.capacity&&this.shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this.transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){Vl(this._updating,"not updating"),this.isFull&&this.grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this.incrementHead(),Vl(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){Vl(this._updating,"not updating"),Vl(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this.incrementTail(),e&&(this._firstIndex=this._tailIndex)}grow(){const e=Math.max(TC,Math.floor(this._capacity*PC));this.resize(e)}shrink(){const e=Math.max(TC,Math.floor(this._capacity*MC));this.resize(e)}resize(e){if(Vl(this._updating,"not updating"),e===this._capacity)return;const t=new wC(this._rctx,34962,35044,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,i=this.compactInstances(t);Vl(i===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new CC(this._instanceBufferLayout.createView(this._buffer.array))}compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const TC=1024,PC=2,RC=.3,MC=.5;class OC{constructor(e,t){const i=e.rctx,r=t.geometry,s=t.material,a=r.data.toRenderData();this.materialRep=e.materialRep,s.setParameterValues({instancedDoublePrecision:!0});const n=s.createBufferWriter(),o=n.vertexBufferLayout,l=n.elementCount(a),c=n.allocate(l);n.write({},a,c,0),this.geometry=r,this.material=s,this.glMaterials=Yc(s,this.materialRep),this.vertexBufferLayout=o,this.vbo=ec.createVertex(i,35044,c.buffer),this.vao=new Jl(i,Pn,{geometry:Eo(o)},{geometry:this.vbo}),this.vertexCount=l}destroy(){$c(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,i,r,s,a){const n=this.geometry.id,o=s.toString();this.material.intersect(this.geometry,null,e.transform.transform,e,i,r,((i,r,l,c)=>{if(i>=0){if(null!=t&&!t(e.rayBeginPoint,e.rayEndPoint,i))return;const h={type:"external",metadata:{layerUid:a.layerUid,graphicUid:a.graphicUid(s)}};if((null==e.results.min.drapedLayerOrder||c>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||i<e.results.min.dist)&&(e.results.min.set(h,o,i,r,e.transform.transform,c,null,n,l),e.results.min.intersector="LodRenderer"),0!==e.options.store&&(null==e.results.max.drapedLayerOrder||c>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||i>e.results.max.dist)&&(e.results.max.set(h,o,i,r,e.transform.transform,c,null,n,l),e.results.min.intersector="LodRenderer"),2===e.options.store){const t=new Kc(e.results.min.ray);t.set(h,o,i,r,e.transform.transform,c,null,n,l),t.intersector="LodRenderer",e.results.all.push(t)}}}))}}class DC{constructor(e,t){this.components=[],this.minScreenSpaceRadius=t.minScreenSpaceRadius,t.components.forEach((t=>{this.components.push(new OC(e,t))}))}destroy(){this.components.forEach((e=>{e.destroy()}))}intersect(e,t,i,r,s,a){this.components.forEach((n=>{n.intersect(e,t,i,r,s,a)}))}get boundingBox(){if(!this._boundingBox){const e=Bs();this.components.forEach((t=>{ia(e,t.boundingInfo.bbMin),ia(e,t.boundingInfo.bbMax)})),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(!this._boundingSphere){const e=this.boundingBox,t=je();Ns(e,t),this._boundingSphere={center:t,radius:.5*ra(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}class AC{constructor(e,t,i,r){this.type="Lod",this.isGround=!1,this._inverseViewport=cn(),this._levels=[],this._renderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new rh,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=i,this._instanceBufferLayout=Eh.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=Eo(this._instanceBufferLayout,{divisor:1}),this._instanceData=new pC(this._optionalFields,r),this._instanceData.on("instance-added",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-removed",(()=>{this.requestUpdateCycle()})),this._instanceData.on("instance-transform-changed",(e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicUpdate(e.index,2)})),this._instanceData.on("instance-visibility-changed",(e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicUpdate(e.index,1)})),this._instanceData.on("instance-highlight-changed",(()=>{this.requestUpdateCycle(!0)})),this._enableLevelSelection=this._symbol.levels.length>1}destroy(){}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlane(){return this._slicePlane}set slicePlane(e){this._slicePlane=e}get intersectionHandlerId(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._renderInstanceData.forEach((t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu})),this._highlightRenderInstanceData.forEach((t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu})),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,i)=>{const r=this._renderInstanceData[i],s=this._highlightRenderInstanceData[i],a=r.size+s.size,n=e.triangleCount;t.push({renderedInstances:a,renderedTriangles:a*n,trianglesPerInstance:n})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}initializeRenderContext(e){this._initContext=e;const t=e.rctx;this._symbol.levels.forEach((i=>{this._levels.push(new DC(e,i)),this._renderInstanceData.push(new SC(t,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new SC(t,this._instanceBufferLayout))})),this._levelSelector=function(e){const t=e.baseBoundingSphere.radius,i=e.levels.map((e=>e.minScreenSpaceRadius));return new bC(t,i)}(this)}uninitializeRenderContext(){this.invalidateOctree(),this._levels.forEach((e=>{e.destroy()})),this._renderInstanceData.forEach((e=>{e.destroy()})),this._highlightRenderInstanceData.forEach((e=>{e.destroy()}))}get slots(){return[4,6]}get needsHighlight(){return this._highlightRenderInstanceData.reduce(((e,t)=>e+t.size),0)>0}prepareRender(e){this.runUpdates(e)}render(e){const t=e.rctx,i=4===e.slot?3:6===e.slot?5:null;if(!i)return;if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const r=e.camera;this._inverseViewport[0]=1/r.fullViewport[2],this._inverseViewport[1]=1/r.fullViewport[3];const s={slot:i,origin:[0,0,0],camera:r,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:!!e.shadowMap&&e.shadowMap.enabled,ssaoEnabled:!!e.ssaoHelper&&e.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType};t.bindVAO();for(let t=0;t<this._levels.length;++t){const r=e.isHighlightPass?this._highlightRenderInstanceData[t]:this._renderInstanceData[t];this._levels[t].components.forEach((a=>{this.renderComponent(e,i,s,r,a,t)}))}return!0}intersect(e,t,i,r){if(!this.baseMaterial.isVisible())return;const s=je();at(s,r,i);const a=s=>{this._instanceData.getCombinedModelTransform(s,FC),e.transform.set(FC),it(VC,i,e.transform.inverse),it(zC,r,e.transform.inverse);const a=this._instanceData.getState(s),n=this._instanceData.getLodLevel(s);Vl(a&dC.ACTIVE,"invalid instance state"),Vl(n>=0&&n<this._levels.length,"invaid lod level"),this._levels[n].intersect(e,t,VC,zC,s,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(a):this.octree.forEachAlongRay(i,s,a)}queryDepthRange(e){return this.queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this.invalidateOctree()}requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._initContext.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runUpdates(e){if(xc.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const t=e.equals(this._lastCamera);this._lastCamera.copyFrom(e),t||this.requestUpdateCycle()}const t=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(e,t),this.needsUpdates&&this._initContext.requestRender()}get octree(){return this._octree||(this._octree=this.buildOctree()),this._octree}invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}buildOctree(){const e=new xC(this._instanceData,this.baseBoundingSphere),t=this._instanceData,i=t.view?t.view.state:null;for(let t=0;t<this._instanceData.capacity;++t){i.get(t)&dC.ACTIVE&&e.addInstance(t)}return e}queryDepthRangeOctree(e){const t=e.eye,i=e.viewForward,r=this.octree.findClosest(i,"front-to-back",e.frustum),s=this.octree.findClosest(i,"back-to-front",e.frustum);if(null!=r&&null!=s){this._instanceData.view.boundingSphere.getVec(r,LC),at(LC,LC,t);const a=st(LC,i)-LC[3];this._instanceData.view.boundingSphere.getVec(s,LC),at(LC,LC,t);const n=st(LC,i)+LC[3];return{near:Math.max(e.near,a),far:Math.min(e.far,n)}}return{near:1/0,far:-1/0}}startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._renderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._initContext.requestRender()}updateInstances(e,t){const i=this._enableLevelSelection,r=this._levelSelector;r.updateCamera(e),this._renderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const s=this._instanceData,a=this._instanceData.view,n=s.size,o=s.capacity;let l=this._instanceIndex;t=Math.min(n,t);for(let e=0;e<t;++e){0===l&&this.startUpdateCycle();const e=a.state.get(l);let n=0;if(!(e&dC.ALLOCATED)){l=(l+1)%o,t++;continue}const c=a.lodLevel.get(l);if(e&dC.ACTIVE&&this._renderInstanceData[c].freeTail(),e&dC.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[c].freeTail(),e&dC.REMOVE)s.freeInstance(l);else if(e&dC.VISIBLE){let t=0;if(i&&(a.modelOrigin.getVec(l,IC),t=r.selectLevel(IC,s.getCombinedMedianScaleFactor(l))),n=e&~(dC.ACTIVE|dC.HIGHLIGHT_ACTIVE|dC.TRANSFORM_CHANGED),t>=0){const i=this._renderInstanceData[t],r=i.allocateHead();if(EC(a,l,i.view,r),n|=dC.ACTIVE,e&dC.HIGHLIGHT){const e=this._highlightRenderInstanceData[t],i=e.allocateHead();EC(a,l,e.view,i),n|=dC.HIGHLIGHT_ACTIVE}}a.state.set(l,n),a.lodLevel.set(l,t)}else n=e&~(dC.ACTIVE|dC.HIGHLIGHT_ACTIVE|dC.TRANSFORM_CHANGED),a.state.set(l,n);if(this._octree){const t=!!(e&dC.ACTIVE),i=!!(n&dC.ACTIVE);!t&&i?this._octree.addInstance(l):t&&!i?this._octree.removeInstance(l):t&&i&&e&dC.TRANSFORM_CHANGED&&(this._octree.removeInstance(l),this._octree.addInstance(l))}l=(l+1)%o}this._instanceIndex=l,this._renderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))}renderComponent(e,t,i,r,s,a){const n=s.glMaterials.get(e.pass);if(!n||!n.beginSlot(t)||0===r.size)return;const o=e.rctx,l=o.capabilities.instancing;n.ensureParameters(i);const c=n.getTechnique(),h=n.getPipelineState(t);o.setPipelineState(h),n.bind(o,i),o.bindVAO(s.vao),c.ensureAttributeLocations(s.vao);const d=c.program;e.isHighlightPass&&Ln.bindOutputHighlight(o,d,i),c.bindDraw(i),xc.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(d.setUniform4fv("externalColor",UC[Math.min(a,UC.length-1)]),d.setUniform1i("colorMixMode",Jn.replace));const u=r.capacity,p=r.headIndex,m=r.tailIndex,f=r.firstIndex,g=this._glInstanceBufferLayout,v=(e,t)=>{tc(o,Pn,r.buffer,g,e),l.drawArraysInstanced(c.primitiveType,0,s.vertexCount,t-e),ic(o,Pn,r.buffer,g)};s.material.params.transparent&&null!=f?p>m?(Vl(f>=m&&f<=p,"invalid firstIndex"),v(f,p),v(m,f)):p<m&&(f<=p?(Vl(f>=0&&f<=p,"invalid firstIndex"),v(f,p),v(m,u),v(0,f)):(Vl(f>=m&&f<=u,"invalid firstIndex"),v(f,u),v(0,p),v(m,f))):p>m?v(m,p):p<m&&(v(0,p),v(m,u)),o.bindVAO(null)}}function EC(e,t,i,r){Qc(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}const IC=je(),LC=Tr(),FC=jr(),VC=je(),zC=je(),UC=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];const kC=je(),jC=jr(),GC=jr(),BC=Tr(),NC={verticalDistanceToGround:0,sampledElevation:0};function qC(e,t){e.attributes.add("featureValue","vec4"),e.vertex.code.add(bn`
  bool isCapVertex() {
    return featureValue.w == 1.0;
  }
  `),e.vertex.uniforms.add("size","vec3"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(bn`
    vec2 getSize() {
      return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
    }
    `)):e.vertex.code.add(bn`
    vec2 getSize(){
      return size.xy;
    }
    `),t.vvOpacity?(e.vertex.defines.addInt("VV_OPACITY_N",8),e.vertex.code.add(bn`
    uniform float vvOpacityValues[VV_OPACITY_N];
    uniform float vvOpacityOpacities[VV_OPACITY_N];

    vec4 applyOpacity(vec4 color) {
      float value = featureValue.z;
      if (value <= vvOpacityValues[0]) {
        return vec4( color.xyz, vvOpacityOpacities[0]);
      }

      for (int i = 1; i < VV_OPACITY_N; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
        }
      }

      return vec4( color.xyz, vvOpacityOpacities[VV_OPACITY_N - 1]);
    }
    `)):e.vertex.code.add(bn`
    vec4 applyOpacity(vec4 color){
      return color;
    }
    `),t.vvColor?(e.vertex.defines.addInt("VV_COLOR_N",8),e.vertex.code.add(bn`
    uniform float vvColorValues[VV_COLOR_N];
    uniform vec4 vvColorColors[VV_COLOR_N];

    vec4 getColor() {
      float value = featureValue.y;
      if (value <= vvColorValues[0]) {
        return applyOpacity(vvColorColors[0]);
      }

      for (int i = 1; i < VV_COLOR_N; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
        }
      }

      return applyOpacity(vvColorColors[VV_COLOR_N - 1]);
    }
    `)):e.vertex.code.add(bn`
    vec4 getColor(){
      return applyOpacity(vec4(1, 1, 1, 1));
    }
    `),e.include(Ih),e.attributes.add("profileRight","vec4"),e.attributes.add("profileUp","vec4"),e.attributes.add("profileVertexAndNormal","vec4"),e.vertex.code.add(bn`
  vec3 calculateVPos() {
    vec2 size = getSize();
    vec3 origin = position;
    vec3 right = profileRight.xyz;
    vec3 up = profileUp.xyz;
    vec3 forward = cross(up, right);
    vec2 profileVertex = profileVertexAndNormal.xy * size;
    vec2 profileNormal = profileVertexAndNormal.zw;
    float positionOffsetAlongProfilePlaneNormal = 0.0;
    float normalOffsetAlongProfilePlaneNormal = 0.0;
    `),e.vertex.code.add(bn`
    if(!isCapVertex()) {
      vec2 rotationRight = vec2(profileRight.w, profileUp.w);
      float maxDistance = length(rotationRight);
  `),e.vertex.code.add(bn`
      rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);

      // decompose vertex into rotationRight and rotationUp
      // limit rotation right component to maxDistance
      // and reassemble profile vertex from rotationRight and rotationUp
      float rx = dot(profileVertex, rotationRight);
      if (abs(rx) > maxDistance) {
        // NB: we do the tangent by x=-y and y=x
        vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
        float ry = dot(profileVertex, rotationUp);
        profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
      }
    }else{
       positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
       normalOffsetAlongProfilePlaneNormal = profileUp.w;
    }

    vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;

    return origin + offset; // localPosition
  }
  `),e.vertex.code.add(bn`
  vec3 localNormal() {
    vec3 right = profileRight.xyz;
    vec3 up = profileUp.xyz;
    vec3 forward = cross(up, right);
    vec2 profileNormal = profileVertexAndNormal.zw;

    vec3 normal = right * profileNormal.x + up * profileNormal.y;

    if(isCapVertex()) {
      normal += forward * profileUp.w;
    }

    return normal;
  }
  `)}var HC=Object.freeze({__proto__:null,build:function(e){const t=new xn;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),t.varyings.add("vpos","vec3"),t.include(qC,e),0!==e.output&&7!==e.output||(t.include(wn,{linearDepth:!1}),e.receiveShadows&&t.include(Th,e),t.include(Ph,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),t.vertex.code.add(bn`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        gl_Position = transformPosition(proj, view, vpos);

        ${0===e.output?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),7===e.output&&(t.include(In,e),t.fragment.uniforms.add("camPos","vec3"),t.fragment.uniforms.add("localOrigin","vec3"),t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(bn`
      void main() {
        discardBySlice(vpos);
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),0===e.output&&(t.include(In,e),t.include(Lh,e),t.include(Fh,e),e.receiveShadows&&t.include(Th,e),t.include(Vh,e),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),t.fragment.include(On),t.fragment.code.add(bn`
      void main() {
        discardBySlice(vpos);

        shadingParams.viewDirection = normalize(vpos - camPos);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = _oldHeuristicLighting(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
    `),e.receiveShadows?t.fragment.code.add(bn`
        float shadow = readShadowMap(vpos, linearDepth);
      `):1===e.viewingMode?t.fragment.code.add(bn`
        float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);
      `):t.fragment.code.add(bn`
        float shadow = 0.0;
      `),t.fragment.code.add(bn`
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==e.output&&3!==e.output||(t.include(wn,{linearDepth:!0}),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("depth","float"),t.vertex.code.add(bn`
        void main() {
          vpos = calculateVPos();
          gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
        }
    `),t.include(In,e),t.include(En,e),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(bn`
        void main() {
          discardBySlice(vpos);
          outputDepth(depth);
        }
    `)),2===e.output&&(t.include(wn,{linearDepth:!1}),t.include(Pc,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(bn`
        void main(void) {
          vpos = calculateVPos();
          vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.include(In,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(bn`
        void main() {
          discardBySlice(vpos);
          vec3 normal = normalize(vnormal);
          if (gl_FrontFacing == false) normal = -normal;
          gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
        }
    `)),4===e.output&&(t.include(wn,{linearDepth:!1}),t.include(Pc,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(bn`
        void main(void) {
          vpos = calculateVPos();
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.include(In,e),t.include(Ln),t.fragment.code.add(bn`
      void main() {
        discardBySlice(vpos);
        outputHighlight();
      }
    `)),t}});const WC="position",ZC="profileRight",QC="profileUp",YC="profileVertexAndNormal",$C="featureValue",XC={position:0,profileRight:1,profileUp:2,profileVertexAndNormal:3,featureValue:4};class KC extends Tn{initializeProgram(e){const t=KC.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,useOldSceneLightInterface:!1,pbrMode:0,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:i.receiveSSAO,doubleSidedMode:i.doubleSidedMode});return new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),XC)}bindPass(e,t,i){Mn.bindProjectionMatrix(this.program,i.camera.projectionMatrix),this.program.setUniform3fv("size",t.size),0!==this.configuration.output&&7!==this.configuration.output||this.program.setUniform1f("opacity",t.opacity),0===this.configuration.output?(i.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",t.ambient),this.program.setUniform3fv("diffuse",t.diffuse),this.program.setUniform3fv("specular",t.specular),this.program.setUniform1f("opacity",t.opacity)):1!==this.configuration.output&&3!==this.configuration.output||Mn.bindNearFar(this.program,i.camera.nearFar),function(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors)),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}(this.program,t)}bindDraw(e){Mn.bindView(this.program,e),In.bindUniformsWithOrigin(this.program,this.configuration,e),0!==this.configuration.output&&7!==this.configuration.output||Mn.bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Th.bindView(this.program,e),2===this.configuration.output&&zh.bindUniforms(this.program,e.camera.viewInverseTransposeMatrix)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e;return wo({blending:0!==t.output&&7!==t.output||!t.transparent?null:i?Vn:zn(e),culling:(s=t,(e=>!e.slicePlaneEnabled&&!(e.transparent||0===e.doubleSidedMode))(s)&&{face:1028,mode:2305}),depthTest:{func:Un(e)},depthWrite:i||r?Ro:null,colorWrite:To,stencilWrite:t.sceneHasOcludees?jn:null,stencilTest:t.sceneHasOcludees?Bn:null,polygonOffset:i||r?null:eo});var s}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}KC.shader=new Rn(HC,(()=>Promise.resolve().then((function(){return HC}))));class JC extends Sn{constructor(){super(...arguments),this.output=0,this.doubleSidedMode=0,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.shadowMap=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3}}var eS;e([Cn({count:8})],JC.prototype,"output",void 0),e([Cn({count:3})],JC.prototype,"doubleSidedMode",void 0),e([Cn()],JC.prototype,"receiveShadows",void 0),e([Cn()],JC.prototype,"receiveSSAO",void 0),e([Cn()],JC.prototype,"vvSize",void 0),e([Cn()],JC.prototype,"vvColor",void 0),e([Cn()],JC.prototype,"vvOpacity",void 0),e([Cn()],JC.prototype,"slicePlaneEnabled",void 0),e([Cn()],JC.prototype,"shadowMap",void 0),e([Cn()],JC.prototype,"transparent",void 0),e([Cn()],JC.prototype,"sceneHasOcludees",void 0),e([Cn({count:4})],JC.prototype,"transparencyPassType",void 0),function(e){function t(){return{up:je(),right:je()}}e.makeFrame=t,e.profileSpaceToVertexSpace=function(e,t,i){e[0]=i[0]*t.right[0]+i[1]*t.up[0],e[1]=i[0]*t.right[1]+i[1]*t.up[1],e[2]=i[0]*t.right[2]+i[1]*t.up[2]},e.vertexSpaceToProfileSpace=function(e,t,i){ls(e,st(i,t.right),st(i,t.up))};e.PathVertex=class{constructor(){this.pos=je(),this.posES=je(),this.posGS=je(),this.vRight=je(),this.vLeft=je(),this.frame=t(),this.rotationFrame=t(),this.rotationRight=cn(),this.rotationAngle=0,this.miterStretch=wh()}setFrameFromUpVector(e){Xe(this.frame.up,e),Qe(nS,this.vLeft,this.vRight),nt(nS,nS),Ze(aS,this.frame.up,st(nS,this.frame.up)),at(cS,nS,aS),nt(cS,cS),Je(this.frame.right,cS,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){Xe(this.rotationFrame.up,this.frame.up),Xe(this.rotationFrame.right,this.frame.right),ls(this.rotationRight,1,0),Ze(aS,this.frame.up,st(this.frame.up,this.vLeft)),at(aS,this.vLeft,aS),rt(aS,aS),nt(aS,aS),Ze(nS,this.frame.up,st(this.frame.up,this.vRight)),at(nS,this.vRight,nS),nt(nS,nS),Je(oS,this.rotationFrame.up,this.vLeft);const e=Ee(st(oS,this.vRight));if(this.rotationAngle=e*(Math.PI-Ie(st(aS,nS))),Math.abs(this.rotationAngle)>0){const e=Fe(Math.cos(.5*this.rotationAngle));Ch(this.miterStretch,e-1+1,0,0,1)}const t=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*t))}};class i{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(e,t){return this.vertices.push(dn(e)),this.vertexNormals.push(dn(t)),this.vertices.length-1}addUV(e){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(e),this.uvs.length-1}addPole(e,t=null){return this.poles.push({position:dn(e),normal:t?dn(t):null}),this.poles.length-1}addSegment(e,t=null,i=null){this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),t&&(this.uvIndices.push(t.v0),this.uvIndices.push(t.v1)),i&&(this.poleIndices.push(i.v0),this.poleIndices.push(i.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return null!=this.uvs}translate(e,t){for(const i of this.vertices)i[0]+=e,i[1]+=t;for(const i of this.poles)i.position[0]+=e,i.position[1]+=t}static circle(e=20){const t=new i,r={v0:0,v1:0};t.addPole(hn(0,0));for(let i=0;i<e;++i){const r=2*i*Math.PI/e,s=Math.cos(r),a=Math.sin(r),n=hn(.5*s,.5*a),o=hn(s,a);t.addVertex(n,o),t.addUV(i/e)}t.addUV(1);for(let i=0;i<e-1;++i){const e={v0:i,v1:i+1},s=e;t.addSegment(e,s,r)}const s={v0:e-1,v1:0},a={v0:e-1,v1:e};return t.addSegment(s,a,r),t}static rect(){const e=new i,t=hn(-.5,-.5),r=hn(.5,-.5),s=hn(.5,.5),a=hn(-.5,.5),n=hn(0,-1),o=hn(1,0),l=hn(0,1),c=hn(-1,0);e.addUV(0),e.addUV(1),e.addPole(hn(0,.5),l),e.addPole(hn(0,.5)),e.addPole(hn(0,-.5)),e.addPole(hn(0,-.5),n);const h={v0:0,v1:1};return e.addVertex(t,n),e.addVertex(r,n),e.addSegment({v0:0,v1:1},h,{v0:3,v1:3}),e.addVertex(r,o),e.addVertex(s,o),e.addSegment({v0:2,v1:3},h,{v0:2,v1:1}),e.addVertex(s,l),e.addVertex(a,l),e.addSegment({v0:4,v1:5},h,{v0:0,v1:0}),e.addVertex(a,c),e.addVertex(t,c),e.addSegment({v0:6,v1:7},h,{v0:1,v1:2}),e}}e.Profile=i;e.Path=class{constructor(e){this.vertices=[],this.offset=je(),this.xform=jr(),this.vertices=e;const t=Math.floor((e.length-1)/2);Xe(this.offset,this.vertices[t].pos);for(const e of this.vertices)at(e.pos,e.pos,this.offset);Mi(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length;let t=this.vertices[0];t.index=0,Ye(t.vLeft,0,0,0),t.vLeftLength=0,at(t.vRight,this.vertices[1].pos,t.pos),t.vRightLength=$e(t.vRight),nt(t.vRight,t.vRight);let i=t;for(let r=1;r<e;++r)t=this.vertices[r],t.index=r,Xe(t.vLeft,i.vRight),t.vLeftLength=i.vRightLength,r<e-1?(at(t.vRight,this.vertices[r+1].pos,t.pos),t.vRightLength=$e(t.vRight),nt(t.vRight,t.vRight)):(Xe(t.vRight,t.vLeft),t.vRightLength=t.vLeftLength),i=t}},e.computeMinimumRotationTangentFrame=function(e,t){let i=null;const r=e.vertices.length,s=.99619469809,a=je(),n=je(),o=je(),l=je(),c=je(),h=je(),d=Uo.create();let u=e.vertices[0];Xe(n,t),Ye(a,0,1,0),fl.makeOrthoBasisDirUpFallback(u.vRight,n,a,a,o,n,s),Xe(u.frame.up,n),Xe(u.frame.right,o),i=u;for(let t=1;t<r;++t){u=e.vertices[t],Qe(c,u.vLeft,u.vRight);let r=$e(c);r>0?(r=1/Math.sqrt(r),c[0]=c[0]*r,c[1]=c[1]*r,c[2]=c[2]*r):(c[0]=u.vRight[0],c[1]=u.vRight[1],c[2]=u.vRight[2]),Qe(h,i.pos,i.frame.up),Uo.fromPositionAndNormal(u.pos,c,d);Uo.intersectRay(d,ko.wrap(h,u.vLeft),l)?(at(l,l,u.pos),nt(n,l),Je(o,c,n),nt(o,o)):fl.makeOrthoBasisDirUpFallback(c,i.frame.up,i.frame.right,a,o,n,s),Xe(u.frame.up,n),Xe(u.frame.right,o),i=u}};e.Extruder=class{};e.SimpleExtruder=class{numProfilesPerJoin(){return 1}extrude(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],!1)}};e.MiterExtruder=class{constructor(e=.8*Math.PI,t=1){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,i){const r=hS;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(let o=0;o<this.numBendSubdivisions+1;++o){Si(dS),Ri(dS,dS,.5*-e.rotationAngle+o*e.rotationAngle/this.numBendSubdivisions,e.rotationFrame.up),s=r,a=e.frame,n=dS,it(s.up,a.up,n),it(s.right,a.right,n);for(let s=0;s<t.vertices.length;++s){us(t.vertices[s],e.rotationRight)*e.rotationAngle>=0?i(e.index,r,t.vertices[s],t.vertexNormals[s],!1):(ps(iS,t.vertices[s],e.miterStretch),i(e.index,e.frame,iS,t.vertexNormals[s],!0))}}else for(let r=0;r<this.numBendSubdivisions+1;++r)for(let r=0;r<t.vertices.length;++r){const s=us(t.vertices[r],e.rotationRight)*e.rotationAngle>=0;ps(iS,t.vertices[r],e.miterStretch),i(e.index,e.frame,iS,t.vertexNormals[r],!s)}var s,a,n}};const r={generateUV:!1};class s{rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],0,0)}}e.CapBuilder=s;e.NoCapBuilder=class extends s{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}};e.TriangulationCapBuilder=class extends s{constructor(e,t=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=i}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],this.profilePlaneOffset,0)}rebuildCapGeometry(e,t){const i=rS;ls(i,0,0);const r=this.flip?1:-1;for(let s=0;s<this.profile.vertices.length;++s)t(e.index,e.frame,this.profile.vertices[s],i,this.profilePlaneOffset,r)}buildTopology(e,t){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let e=1;e<this.profile.numSegments;++e){const r=this.profile.vertexIndices[2*e+0],s=this.profile.vertexIndices[2*e+1],a=this.vertexBufferStart+r,n=this.vertexBufferStart+s;this.flip?t(n,a,i):t(i,a,n)}}};e.RoundCapBuilder=class extends s{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}getNumVertices(){let e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length,e}getNumIndices(){let e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(let t=0;t<this.profile.numSegments;++t){const i=this.profile.vertexIndices[2*t+0],r=this.profile.vertexIndices[2*t+1];this.profile.poleIndices[i]===this.profile.poleIndices[r]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){const i=e.frame,r=.5*this.sign,s=iS,a=rS;ls(a,0,0);for(let s=0;s<this.profile.poles.length;++s){const n=this.profile.poles[s];n.normal?t(e.index,i,n.position,n.normal,r,0):t(e.index,i,n.position,a,r,this.sign)}if(this.breakNormals)for(let r=0;r<this.profile.vertices.length;++r)t(e.index,i,this.profile.vertices[r],this.profile.vertexNormals[r],0,0);for(let n=0;n<this.numSegments-1;++n){const o=(1-(n+1)/this.numSegments)*Math.PI*.5,l=Math.sin(o),c=Math.cos(o);for(let n=0;n<this.profile.vertices.length;++n){const o=this.profile.poles[this.profile.poleIndices[n]];ms(s,this.profile.vertices[n],o.position),ds(s,s,l),o.normal?(fs(s,s,o.position),t(e.index,i,s,o.normal,r*c,0)):(gs(a,s),ds(a,a,l),fs(s,s,o.position),t(e.index,i,s,a,r*c,this.sign*c))}}}buildTopology(e,t){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let e=0;e<this.profile.numSegments;++e){const s=this.profile.vertexIndices[2*e+0],a=this.profile.vertexIndices[2*e+1],n=this.vertexBufferStart+this.profile.poleIndices[s],o=this.vertexBufferStart+this.profile.poleIndices[a];let l=i+s,c=i+a;for(let e=0;e<this.numSegments-1;++e){const i=r+e*this.profile.vertices.length+s,n=r+e*this.profile.vertices.length+a;this.flip?(t(i,c,l),t(c,i,n)):(t(l,c,i),t(n,i,c)),l=i,c=n}this.flip?(t(n,c,l),n!==o&&t(n,o,c)):(t(l,c,n),n!==o&&t(c,o,n))}}};e.Builder=class{constructor(e,t,i,s,a,n=r){this.options=n,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=t,this.path=e,this.extruder=i,this.startCap=s,this.endCap=a;const o=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*o+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const l=this.startCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this.rebuildGeometry(),this.buildTopology()}emitVertex(e,t,i,r,s){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,s){const t=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[0]*t.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[1]*t.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(e,t,i,r,s,a){this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=s,this.profileUpAxisData[4*this._extrusionVertexCount+3]=a,++this._extrusionVertexCount}emitTriangle(e,t,i){this.vertexIndices[3*this._triangleCount+0]=e,this.vertexIndices[3*this._triangleCount+1]=t,this.vertexIndices[3*this._triangleCount+2]=i,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[i],this.normalIndices[3*this._triangleCount+0]=e,this.normalIndices[3*this._triangleCount+1]=t,this.normalIndices[3*this._triangleCount+2]=i,++this._triangleCount}rebuildGeometry(){const e=(e,t,i,r,s)=>this.emitVertex(e,t,i,r,s),t=(e,t,i,r,s,a)=>this.emitCapVertex(e,t,i,r,s,a);this._extrusionVertexCount=0;for(const e of this.path.vertices)this.originData[3*e.index+0]=e.pos[0],this.originData[3*e.index+1]=e.pos[1],this.originData[3*e.index+2]=e.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,t);for(let t=1;t<this.path.vertices.length-1;++t)this.extruder.extrude(this.path.vertices[t],this.profile,e);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,t),this.startCap.rebuildCapGeometry(this.path.vertices[0],t),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],t),this.profile.hasUV()&&this.options.generateUV)for(let e=0;e<this.profile.uvs.length;++e)this.uvData[2*e+0]=this.profile.uvs[e],this.uvData[2*e+1]=0}buildTopology(){const e=(e,t,i)=>this.emitTriangle(e,t,i);this._triangleCount=0;const t=this.profile.vertices.length,i=this.profile.numSegments,r=this.numExtrusionProfiles-1;let s=3*(2*(i*r));this.startCap.indexBufferStart=s,this.startCap.firstProfileVertexIndex=0,s+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=s,this.endCap.firstProfileVertexIndex=t*(this.numExtrusionProfiles-1),s+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(s),this.normalIndices=new Uint32Array(s),this.pathVertexIndices=new Uint32Array(s),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(s));for(let s=0;s<i;++s){const i=this.profile.vertexIndices[2*s],a=this.profile.vertexIndices[2*s+1];for(let s=0;s<r;++s){const r=s*t+i,n=(s+1)*t+a,o=s*t+a;e(r,(s+1)*t+i,n),e(r,n,o)}}this.startCap.buildTopology(this.path.vertices[0],e),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],e)}onPathChanged(){this.rebuildGeometry()}};class a{constructor(e){this.builder=e}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}e.PathGeometry=a;class n extends a{constructor(e){super(e),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;for(let t=0;t<this.builder.numVerticesTotal;++t){const i=this.builder.pathVertexData[t],r=0===i||i===this.builder.path.vertices.length-1,s=tS;Ye(s,this.builder.originData[3*i+0],this.builder.originData[3*i+1],this.builder.originData[3*i+2]);const a=aS,n=iS,o=nS,l=oS,c=lS;let h=0,d=0;if(Ye(l,this.builder.profileRightAxisData[4*t+0],this.builder.profileRightAxisData[4*t+1],this.builder.profileRightAxisData[4*t+2]),Ye(c,this.builder.profileUpAxisData[4*t+0],this.builder.profileUpAxisData[4*t+1],this.builder.profileUpAxisData[4*t+2]),ls(n,this.builder.profileVertexAndNormalData[4*t+0]*e[0],this.builder.profileVertexAndNormalData[4*t+1]*e[1]),r)Je(o,c,l),h=this.builder.profileRightAxisData[4*t+3]*e[0],d=this.builder.profileUpAxisData[4*t+3];else{const e=rS,i=sS;ls(e,this.builder.profileRightAxisData[4*t+3],this.builder.profileUpAxisData[4*t+3]);const r=vs(e);gs(e,e);const s=us(n,e);if(Math.abs(s)>r){ls(i,-e[1],e[0]);const t=us(n,i);ds(e,e,r*Ee(s)),ds(i,i,t),fs(n,e,i)}Ye(o,0,0,0)}Ye(a,l[0]*n[0]+c[0]*n[1],l[1]*n[0]+c[1]*n[1],l[2]*n[0]+c[2]*n[1]),this.vertexAttributePosition[3*t+0]=s[0]+a[0]+o[0]*h,this.vertexAttributePosition[3*t+1]=s[1]+a[1]+o[1]*h,this.vertexAttributePosition[3*t+2]=s[2]+a[2]+o[2]*h;const u=iS;ls(u,this.builder.profileVertexAndNormalData[4*t+2],this.builder.profileVertexAndNormalData[4*t+3]),this.vertexAttributeNormal[3*t+0]=l[0]*u[0]+c[0]*u[1]+o[0]*d,this.vertexAttributeNormal[3*t+1]=l[1]*u[0]+c[1]*u[1]+o[1]*d,this.vertexAttributeNormal[3*t+2]=l[2]*u[0]+c[2]*u[1]+o[2]*d}}createGeometryData(){const e={};if(e[Ll.POSITION]=this.builder.vertexIndices,e[Ll.NORMAL]=this.builder.normalIndices,this.vertexAttributeColor){const t=e[Ll.POSITION].length;e[Ll.COLOR]=new Uint32Array(t)}const t={};return t[Ll.POSITION]={size:3,data:this.vertexAttributePosition},t[Ll.NORMAL]={size:3,data:this.vertexAttributeNormal},this.vertexAttributeColor&&(t[Ll.COLOR]={size:4,data:this.vertexAttributeColor}),new Hl(t,e,"triangle")}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(e,t,i){const r=this.builder.vertexIndices,s={size:3,offsetIdx:0,strideIdx:3,data:this.vertexAttributePosition},a=r.length/3;to(e,t,0,a,r,s,void 0,void 0,i)}}e.StaticPathGeometry=n;e.FastUpdatePathGeometry=class extends a{constructor(e,t,i,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=i,this.opacityAttributeValue=r,this.vvData=null,this.baked=new n(e),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let e=0;e<this.builder.path.vertices.length;++e){this.vvData[4*e+0]=t,this.vvData[4*e+1]=i,this.vvData[4*e+2]=r;const s=0===e||e===this.builder.path.vertices.length-1;this.vvData[4*e+3]=s?1:0}}createGeometryData(){const e={};e[WC]=this.builder.pathVertexIndices,e[ZC]=this.builder.vertexIndices,e[QC]=this.builder.vertexIndices,e[YC]=this.builder.vertexIndices,e[$C]=this.builder.pathVertexIndices;const t={};return t[WC]={size:3,data:this.builder.originData},t[ZC]={size:4,data:this.builder.profileRightAxisData},t[QC]={size:4,data:this.builder.profileUpAxisData},t[YC]={size:4,data:this.builder.profileVertexAndNormalData},t[$C]={size:4,data:this.vvData},new Hl(t,e,"triangle")}}}(eS||(eS={}));const tS=je(),iS=cn(),rS=cn(),sS=cn(),aS=je(),nS=je(),oS=je(),lS=je(),cS=je(),hS=eS.makeFrame(),dS=jr();var uS=eS;const pS=Vl;class mS extends qn{constructor(e,t){super(t,e,gS),this.supportsEdges=!0,this._vertexAttributeLocations=XC,this.techniqueConfig=new JC,this.vertexBufferLayout=mS.getVertexBufferLayout(this.params)}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,0!==e&&7!==e||(this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.receiveSSAO=this.params.receiveSSAO),this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig}getPassParameters(){return this.params}isVisibleInPass(e){return 4!==e||this.params.castShadows}isVisible(){const e=this.params;return!!super.isVisible()&&e.opacity>0}intersect(e,t,i,r,s,a,n){const o=e;if(!o.metadata)return;const l=o.metadata.pathGeometry,c=[this.params.size[0],this.params.size[1]];if(this.params.vvSizeEnabled){const e=this.params.vvSizeOffset,t=this.params.vvSizeFactor,i=this.params.vvSizeMinSize,r=this.params.vvSizeMaxSize,s=l.sizeAttributeValue;c[0]*=Re(e[0]+s*t[0],i[0],r[0]),c[1]*=Re(e[2]+s*t[2],i[2],r[2])}const h=Math.max(c[0],c[1]),d=aa(e.boundingInfo.bbMin[0]-h,e.boundingInfo.bbMin[1]-h,e.boundingInfo.bbMin[2]-h,e.boundingInfo.bbMax[0]+h,e.boundingInfo.bbMax[1]+h,e.boundingInfo.bbMax[2]+h),u=[a[0]-s[0],a[1]-s[1],a[2]-s[2]],p=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]);io(d,s,[p/u[0],p/u[1],p/u[2]],r.tolerance)&&(l.baked.size&&l.baked.size[0]===c[0]&&l.baked.size[1]===c[1]||l.baked.bake(c),l.baked.intersect(s,a,n))}computeAttachmentOrigin(e,t){const i=e.data,r="getVertexAttr"in i?i.getVertexAttr():"vertexAttr"in i?i.vertexAttr:null;if(!r)return null;const s=r[WC];return ro(s,null,!1,t)}createBufferWriter(){return new vS(this.vertexBufferLayout)}getGLMaterial(e){if(0===e.output||7===e.output||1===e.output||2===e.output||4===e.output||3===e.output&&this.params.castShadows)return new fS(e)}static getVertexBufferLayout(e){let t=Io().vec3f(WC).vec4f(ZC).vec4f(QC).vec4f(YC);return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f($C)),t}}class fS extends Zn{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(KC,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){return e===(this.technique.configuration.transparent?5:3)}_updateOccludeeState(e){e.hasOccludees!==this.material.params.sceneHasOcludees&&this.material.setParameterValues({sceneHasOcludees:e.hasOccludees})}_updateShadowState(e){e.shadowMappingEnabled!==this.technique.configuration.receiveShadows&&this.material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}ensureParameters(e){0!==this.output&&7!==this.output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}}const gS={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...Ml.Default,...Qn};class vS{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices[WC].length}write(e,t,i,r){const s=e=>{if(e in t.vertexAttr){const s=t.vertexAttr[e],a=t.indices[e];pS(4===s.size);const n=i.getField(e,es);if(!n)throw new Error("unable to acquire view for "+e);Kn(a,s.data,n,r)}};s(ZC),s(QC),s(YC),this.vertexBufferLayout.hasField($C)&&s($C),so(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}class yS extends sb{constructor(e,t,i,r){super(e,t,i,r),this._intrinsicSize=hn(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=h(this.symbolLayer.width)?this.symbolLayer.width:h(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,t=h(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,t],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=Cw(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const i=this.symbolLayer.anchor||"center";this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");const r=this.symbolLayer.profile||"circle";switch(r){case"circle":default:this._profile=uS.Profile.circle(OS);break;case"quad":this._profile=uS.Profile.rect()}let s=[0,0];"center"!==i&&(s={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[i],this._profile.translate(s[0],s[1]));switch(this.symbolLayer.join||"simple"){case"round":this._extruder=new uS.MiterExtruder(0,RS);break;case"bevel":this._extruder=new uS.MiterExtruder(0,1);break;case"miter":this._extruder=new uS.MiterExtruder(.8*Math.PI,1);break;case"simple":default:this._extruder=new uS.SimpleExtruder}const a=this.symbolLayer.cap||"butt";switch(a){case"none":this._startCap=new uS.NoCapBuilder,this._endCap=new uS.NoCapBuilder;break;case"butt":default:this._startCap=new uS.TriangulationCapBuilder(this._profile,0),this._endCap=new uS.TriangulationCapBuilder(this._profile,0,!0);break;case"square":this._startCap=new uS.TriangulationCapBuilder(this._profile,-.5),this._endCap=new uS.TriangulationCapBuilder(this._profile,.5,!0);break;case"round":{const e="quad"===r;this._startCap=new uS.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:e,subdivisions:MS}),this._endCap=new uS.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:e,subdivisions:MS});break}}const o=this._getIdHint(),l=g(this.symbolLayer,"material","color"),c=this._getCombinedOpacityAndColor(l),d=Ne(c),u=c[3],p={diffuse:d,ambient:d,opacity:u,transparent:u<1||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===a?0:void 0,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(ls(this._intrinsicSize,e,t),!Ol(this._intrinsicSize[0])||!Ol(this._intrinsicSize[1])))throw new ee("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||ds(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(n(p,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new mS(p,`${o}_pathmat`)):(p.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new Eh(p,`${o}_pathmat`)),this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(3,this._material)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometryType(t.geometry,yS.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;const i="graphic"+t.uid,r=this.setGraphicElevationContext(t,new oc),s=e.renderingInfo;return this._createAs3DShape(t,s,r,i,t.uid)}layerOpacityChanged(){const e=g(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({opacity:t,transparent:i}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,yh)}slicePlaneEnabledChanged(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(e,t){for(const i in e.diff)switch(i){case"visualVariables":if(!Sw(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0}getVertexData(e){let t=0;const i=e.paths,r=[],s=e.spatialReference,a=this._context.elevationProvider.spatialReference,n=this._context.renderCoordsHelper.spatialReference;for(const e of i)t+=e.length;const o=new Float64Array(3*t),l=new Float64Array(3*t),c=new Float64Array(3*t);let h=0;for(const t of i){r.push({index:h,numVertices:t.length});for(const i of t)o[h++]=i[0],o[h++]=i[1],o[h++]=e.hasZ?i[2]:0}let d=!0;return s.equals(a)?this._copyVertices(o,0,l,0,t):d=ar(o,s,0,l,a,0,t),a.equals(n)?this._copyVertices(l,0,c,0,t):ar(l,a,0,c,n,0,t),{pathVertexDataInfos:r,vertexDataGS:o,vertexDataES:l,vertexDataRS:c,projectionSuccess:d,terrainElevation:0}}_copyVertices(e,t,i,r,s){t*=3,r*=3;for(let a=0;a<s;++a)i[r++]=e[t++],i[r++]=e[t++],i[r++]=e[t++]}_createAs3DShape(e,t,i,r,s){const a=e.geometry,n=[],o=[],l=[],c=a.spatialReference,d=js(),u=this._context.renderCoordsHelper,p=this.getVertexData(a);if(!p.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(p.pathVertexDataInfos.length>0){for(let s=0;s<p.pathVertexDataInfos.length;++s){const a=p.pathVertexDataInfos[s],m=a.index,f=a.numVertices;if(f<2){this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");continue}if(h(this._context.clippingExtent)&&(Bs(d),Ks(d,p.vertexDataES,3*m,f),!Js(d,this._context.clippingExtent)))continue;const g=[];for(let e=m;e<m+3*f;){const t=e++,r=e++,s=e++,a=new uS.PathVertex;Ye(a.posGS,p.vertexDataGS[t],p.vertexDataGS[r],p.vertexDataGS[s]),Ye(a.posES,p.vertexDataES[t],p.vertexDataES[r],p.vertexDataES[s]);const n=ph(a.posES,this._context.elevationProvider,i,u,null);Ye(SS,p.vertexDataRS[t],p.vertexDataRS[r],p.vertexDataRS[s]),u.setAltitude(n,SS),Ye(a.pos,SS[0],SS[1],SS[2]),g.push(a)}const v=new uS.Path(g);_S(v,this.upVectorAlignment,this._context.renderCoordsHelper);const y=new uS.Builder(v,this._profile,this._extruder,this._startCap,this._endCap);let _=null;if(this._fastUpdates.enabled){const t=this._fastUpdates.visualVariables,i=t.size?ab(t.size.field,e):0,r=t.color?ab(t.color.field,e):0,s=t.opacity?ab(t.opacity.field,e):0;_=new uS.FastUpdatePathGeometry(y,i,r,s)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(e[0]*=xS(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),e[1]*=xS(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));let i=null;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new uS.StaticPathGeometry(y);r.bake(e),i&&r.bakeVertexColors(i),_=r}const x=_.createGeometryData(),b=new ql(x,r+"path"+s),w={pathGeometry:_,geometrySR:c,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};b.metadata=w,n.push(b),o.push(this._material),l.push(_.xform)}const a={layerUid:this._context.layer.uid,graphicUid:s};if(n.length>0){const e=new Wc({geometries:n,materials:o,transformations:l,castShadow:!0,metadata:a,idHint:r}),t=new zx(this,e,n,null,null,wS,i);return t.alignedSampledElevation=p.terrainElevation,t.needsElevationUpdates=yh(i.mode),t}}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}}function _S(e,t,i){switch(t){case"world":for(const t of e.vertices)Qe(TS,t.pos,e.offset),i.worldUpAtPosition(TS,SS),t.setFrameFromUpVector(SS),t.computeRotationAxisAndAngleFromUpVector();break;case"path":Qe(TS,e.vertices[0].pos,e.offset),i.worldUpAtPosition(TS,SS),uS.computeMinimumRotationTangentFrame(e,SS);for(const t of e.vertices){const e=Ee(st(t.frame.right,t.vRight));Je(t.rotationFrame.up,t.vRight,t.vLeft),Ze(t.rotationFrame.up,t.rotationFrame.up,e),nt(t.rotationFrame.up,t.rotationFrame.up);const i=st(t.rotationFrame.up,t.frame.up),r=st(t.rotationFrame.up,t.frame.right);if(Ze(TS,t.frame.up,-r),Ze(PS,t.frame.right,i),Qe(TS,TS,PS),nt(t.rotationFrame.right,TS),uS.vertexSpaceToProfileSpace(t.rotationRight,t.frame,t.rotationFrame.right),rt(TS,t.vLeft),t.rotationAngle=-e*(Math.PI-Ie(st(TS,t.vRight))),Math.abs(t.rotationAngle)>0){const e=Fe(Math.cos(.5*t.rotationAngle));Ch(t.miterStretch,1+(e-1)*t.rotationRight[0]*t.rotationRight[0],(e-1)*t.rotationRight[0]*t.rotationRight[1],(e-1)*t.rotationRight[0]*t.rotationRight[1],1+(e-1)*t.rotationRight[1]*t.rotationRight[1])}const s=Math.PI-t.rotationAngle;t.maxStretchDistance=Math.abs(Math.min(t.vLeftLength,t.vRightLength)*Fe(Math.cos(.5*s)))}}}function xS(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function bS(e,t,i,r){let s=0;for(const a of e.vertices){const n=ph(a.posES,i,t,r,DS);s+=DS.sampledElevation,Qe(SS,a.pos,e.offset),r.setAltitude(n,SS),at(a.pos,SS,e.offset)}return e.updatePathVertexInformation(),s/e.vertices.length}function wS(e,t,i,r){const s=e.stageObject,a=s.geometryRecords,n=a.length;let o=0;CS.spatialReference=r.spatialReference;for(let e=0;e<n;e++){const n=a[e].geometry,l=n.metadata,c=l.pathGeometry,h=c.builder.path;l.geometrySR;o+=bS(h,t,i,r),"world"!==h.upVector&&_S(h,l.upVectorAlignment,r),c.onPathChanged(),n.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(e)}return o/n}yS.validGeometryTypes=["polyline"];const CS=Oa(0,0,0,null),SS=je(),TS=Lo(),PS=Lo(),RS=3,MS=3,OS=10,DS={verticalDistanceToGround:0,sampledElevation:0};function AS(e,t,i){return function(e,t,i){if(h(e))return"none"===e.style||"solid"===e.style?("none"===e.style&&(t.color=Pr(0,0,0,0),t.transparent=!0),new Dl(t,i.idHint+"_colormat")):(t.style=function(e){switch(e){case"horizontal":return 0;case"vertical":return 1;case"cross":return 2;case"forward-diagonal":return 3;case"backward-diagonal":return 4;case"diagonal-cross":return 5;default:return}}(e.style),t.draped=i.isDraped,new Y_(t,i.idHint+"_patternmat"));return new Dl(t,i.idHint+"_colormat")}(function(e){return e&&e.pattern||null}(e),t,i)}class ES extends sb{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if(h(this._material))return;const e=g(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=AS(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped,idHint:this._getIdHint()}),this._needsUV=this._material instanceof Y_,this._context.stage.add(3,this._material)}ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(h(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;this._outlineMaterial=(t=>{const i=e.stipplePattern?Dh(e.stipplePattern.map(kt)):null,r=e.stippleOffColor?At.toUnitRGBA(e.stippleOffColor):null;return t>1.5?new Sl({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r},this._getIdHint("_outline_ribbonlinemat")):new rd({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:t,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r},this._getIdHint("_outline_nativelinemat"))})(kt(e.size)),this._context.stage.add(3,this._outlineMaterial)}_isValidOutline(e){return h(e)&&e.size&&e.size>0&&h(e.color)}destroy(){super.destroy(),h(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null),h(this._outlineMaterial)&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometryType(t.geometry,ES.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;const i="graphic"+t.uid,r=this._getVertexOpacityAndColor(e.renderingInfo,Uint8Array,255),s=this.setGraphicElevationContext(t,new oc);return this.ensureDrapedStatus("on-the-ground"===s.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,r,i):this._createAs3DShape(t,r,s,i)}layerOpacityChanged(){if(h(this._material)){const e=this._material.params.color,t=g(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameterValues({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(h(this._outlineMaterial)){const e=this._outlineMaterial.params.color;this._outlineMaterial.setParameterValues({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=fh(ES.elevationModeChangeTypes,i,r);if(s!==mh.UPDATE)return s;const a=gh(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){if(h(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),h(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i,r){const s=kb(e.geometry);if(u(s))return null;LS.renderData=jb(s,this._context.elevationProvider,this._context.renderCoordsHelper,i),LS.idHint=r,LS.color=t;const a=LS.renderData.position.length/3;if(this._needsUV&&(LS.uvMapSpace=new Float32Array(4*a),LS.bound1=new Float64Array(3*a),LS.bound2=new Float64Array(3*a),LS.bound3=new Float64Array(3*a)),LS.outNum=0,LS.outGeometries=[],LS.outTransforms=[],LS.outMaterials=[],this._createAs3DShapeFill(LS),this._hasOutline&&this._createAs3DShapeOutline(LS),this._logGeometryCreationWarnings(LS.renderData,s.rings,"rings","FillSymbol3DLayer"),0===LS.outNum)return null;this._needsUV&&K_(es.fromTypedArray(LS.uvMapSpace),Jr.fromTypedArray(LS.renderData.position),this._context.layerView.view.renderCoordsHelper,Jr.fromTypedArray(LS.bound1),Jr.fromTypedArray(LS.bound2),Jr.fromTypedArray(LS.bound3));const n=new Wc({geometries:LS.outGeometries,materials:LS.outMaterials,transformations:LS.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid},idHint:r}),o=_x,l=new zx(this,n,LS.outGeometries,null,null,o,i);return l.alignedSampledElevation=LS.renderData.sampledElevation,l.needsElevationUpdates=gh(i.mode),l}_createAs3DShapeFill(e){const t=e.renderData.polygons;for(const{position:i,mapPosition:r,holeIndices:s,index:a,count:n}of t){if(h(this._context.clippingExtent)&&(Bs(IS),Ks(IS,r),!Js(IS,this._context.clippingExtent)))continue;const t=Ur(r,s,3);if(0===t.length)continue;const o=zb({indices:new Uint32Array(t),attributeData:{position:i,color:e.color,mapPosition:r,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*a*e.uvMapSpace.BYTES_PER_ELEMENT,4*n):null,bound1:this._needsUV?new Float64Array(e.bound1.buffer,3*a*e.bound1.BYTES_PER_ELEMENT,3*n):null,bound2:this._needsUV?new Float64Array(e.bound2.buffer,3*a*e.bound2.BYTES_PER_ELEMENT,3*n):null,bound3:this._needsUV?new Float64Array(e.bound3.buffer,3*a*e.bound3.BYTES_PER_ELEMENT,3*n):null}}),l=new ql(o,e.idHint);e.outGeometries.push(l),e.outMaterials.push(m(this._material)),e.outTransforms.push(Nr),e.outNum++}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines,i=this._outlineMaterial instanceof rd;for(let r=0;r<t.length;++r){const{mapPosition:s,position:a}=t[r];if(h(this._context.clippingExtent)&&(Bs(IS),Ks(IS,s),!Js(IS,this._context.clippingExtent)))continue;const n=Sc({removeDuplicateStartEnd:i?0:1,attributeData:{position:a,mapPosition:s}}),o=n.vertexAttributes[Ll.POSITION];o.data===a&&(o.data=new Float64Array(a));const l=new ql(n,e.idHint+"outline"+r);e.outGeometries.push(l),e.outMaterials.push(m(this._outlineMaterial)),e.outTransforms.push(Nr),e.outNum++}}_createAsOverlay(e,t,i){const r=kb(e.geometry);if(u(r))return null;m(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,h(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),FS.renderData=Gb(r,this._context.overlaySR),FS.idHint=i,FS.color=t;const s=FS.renderData.position.length/3;return this._needsUV&&(FS.uvMapSpace=new Float32Array(4*s)),FS.outNum=0,FS.outGeometries=[],FS.outBoundingBox=Bs(),FS.layerUid=this._context.layer.uid,FS.graphicsUid=e.uid,this._createAsOverlayFill(FS),this._hasOutline&&this._createAsOverlayOutline(FS),this._logGeometryCreationWarnings(FS.renderData,r.rings,"rings","FillSymbol3DLayer"),0===FS.outNum?null:(this._needsUV&&function(e,t,i,r=1){if(i.isGeographic){const e=new Float64Array(t.typedBuffer.length);ar(t.typedBuffer,i,0,e,ue.WebMercator,0,t.count),t=Jr.fromTypedArray(e),i=ue.WebMercator}ls(ax,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let e=0;e<t.count;e++)t.getVec(e,ex),ax[0]=Math.min(ax[0],ex[0]),ax[1]=Math.min(ax[1],ex[1]);const s=ax[0]%r,a=ax[1]%r;ox[0]=ax[0]-s,ox[1]=ax[1]-a;for(let i=0;i<t.count;i++)t.getVec(i,ex),e.setValues(i,(ex[0]-ox[0])/r,(ex[1]-ox[1])/r,ox[0]/r,ox[1]/r)}(es.fromTypedArray(FS.uvMapSpace),Jr.fromTypedArray(FS.renderData.position),this._context.overlaySR),FS.outNum>0?new lw(this,FS.outGeometries,FS.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:r,index:s,count:a}of t){if(Bs(IS),Ks(IS,i),!Js(IS,this._context.clippingExtent))continue;const t=Ur(i,r,3);if(0===t.length)continue;Ys(e.outBoundingBox,IS);const n=zb({indices:new Uint32Array(t),attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*s*e.uvMapSpace.BYTES_PER_ELEMENT,4*a):null}}),o=new td(n);o.data.layerUid=e.layerUid,o.data.graphicUid=e.graphicsUid,o.material=m(this._material);const l=IS;o.center=[.5*(l[0]+l[3]),.5*(l[1]+l[4]),0],o.bsRadius=.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1])),e.outGeometries.push(o),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if(Bs(IS),Ks(IS,r),!Js(IS,this._context.clippingExtent))continue;Ys(e.outBoundingBox,IS);const s=this._outlineMaterial instanceof rd,a=Sc({removeDuplicateStartEnd:s?0:1,attributeData:{position:r}}),n=new td(a);n.data.layerUid=e.layerUid,n.data.graphicUid=e.graphicsUid,n.material=m(this._outlineMaterial);const o=IS;n.center=[.5*(o[0]+o[3]),.5*(o[1]+o[4]),0],n.bsRadius=.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1])),e.outGeometries.push(n),e.outNum++}}_getOutlineOpacity(){const e=g(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(h(e)?e.a:0)}_getOutlineColor(){const e=g(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return xl(h(e)?At.toUnitRGB(e):null,t)}get test(){return{createAsOverlay:(e,t,i)=>this._createAsOverlay(e,t,i),createAs3DShape:(e,t,i,r)=>this._createAs3DShape(e,t,i,r)}}}ES.validGeometryTypes=["polyline","polygon","extent"],ES.elevationModeChangeTypes={definedChanged:mh.RECREATE,staysOnTheGround:mh.NONE,onTheGroundChanged:mh.RECREATE};const IS=js(),LS={idHint:null,renderData:null,color:null,uvMapSpace:null,bound1:null,bound2:null,bound3:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},FS={idHint:null,renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};class VS{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.fillStyle=this.colorToRGBA(e.color),this.haloStyle=this.colorToRGB(e.halo.color)}colorToRGB(e){return`rgb(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()})`}colorToRGBA(e){return`rgba(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()},${e[3]})`}static fromSymbol(e,t=1){const i=g(e,"material","color"),r=h(i)?At.toUnitRGBA(i):Or,s=e.halo,a=null!=e.size?kt(e.size):12,n={family:e.font&&e.font.family?e.font.family:"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:"normal"},o=h(s)&&h(s.color)&&s.size>0?{size:kt(s.size),color:At.toUnitRGBA(s.color)}:{size:0,color:Or};return new VS({size:a,color:r,font:n,halo:o,pixelRatio:t})}}class zS{constructor(e,t,i=2048){this.text=e,this.maxSize=i,this._renderPixelRatio=null,this._displayWidth=null,this.parameters=t instanceof VS?t:new VS(t),this.key=`${this.parameters.key}--${e}`,this.textLines=e.split(/\r?\n/),this.lineHeight=this.computeLineHeight()}get displayWidth(){return u(this._displayWidth)&&(this._displayWidth=this.computeTextWidth()),this._displayWidth}get displayHeight(){return this.lineHeight*this.textLines.length}get renderedWidth(){return Math.round(this.displayWidth*this.renderPixelRatio)}get renderedHeight(){return Math.round(this.displayHeight*this.renderPixelRatio)}get renderedLineHeight(){return Math.round(this.lineHeight*this.renderPixelRatio)}get renderedFontSize(){return this.parameters.definition.size*this.renderPixelRatio}get renderedHaloSize(){return this.parameters.haloSize*this.renderPixelRatio}get renderPixelRatio(){if(u(this._renderPixelRatio)){const e=this.parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this.maxSize/(this.displayWidth*e),this.maxSize/(this.displayHeight*e))):this._renderPixelRatio=e}return this._renderPixelRatio}render(e,t=0,i=0){const r=this.renderedLineHeight,s=this.renderedHaloSize,a=function(e,t){return"center"===e?.5*t:"right"===e?t:0}(e.textAlign,this.renderedWidth)+s,n=s+US;e.save();s>0&&this.renderHalo(e,a,n,t,i),this.setFontProperties(e,this.renderedFontSize),i+=n,t+=a;for(const s of this.textLines)e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",e.fillText(s,t,i),e.globalCompositeOperation="source-over",e.fillStyle=this.parameters.fillStyle,e.fillText(s,t,i),i+=r;e.restore()}renderHalo(e,t,i,r,s){const a=this.renderedWidth,n=this.renderedHeight,o=jS(GS,Math.max(a,BS),Math.max(n,BS)),l=o.getContext("2d");l.clearRect(0,0,a,n),this.setFontProperties(l,this.renderedFontSize),l.fillStyle=this.parameters.haloStyle,l.strokeStyle=this.parameters.haloStyle;const c=this.renderedHaloSize<3;l.lineJoin=c?"miter":"round",c?this.renderHaloEmulated(l,t,i):this.renderHaloNative(l,t,i),e.globalAlpha=this.parameters.definition.halo.color[3],e.drawImage(o,0,0,a,n,r,s,a,n),e.globalAlpha=1}renderHaloEmulated(e,t,i){const r=this.renderedLineHeight,s=this.renderedHaloSize;for(const a of this.textLines){for(const[r,n]of kS)e.fillText(a,t+s*r,i+s*n);i+=r}}renderHaloNative(e,t,i){const r=this.renderedLineHeight,s=this.renderedHaloSize;for(const a of this.textLines){const n=2*s,o=5,l=.1;for(let r=0;r<o;r++){const s=1-(o-1)*l+r*l;e.lineWidth=s*n,e.strokeText(a,t,i)}i+=r}}setFontProperties(e,t){const i=this.parameters.definition.font,r=`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif`;e.font=r,e.textAlign="left",e.textBaseline="top"}computeTextWidth(){const e=jS(GS,BS,BS).getContext("2d");this.setFontProperties(e,this.parameters.definition.size);let t=0;for(const i of this.textLines)t=Math.max(t,e.measureText(i).width);const i=this.parameters.definition.font;return("italic"===i.style||"oblique"===i.style||"string"==typeof i.weight&&("bold"===i.weight||"bolder"===i.weight)||"number"==typeof i.weight&&i.weight>600)&&(t+=.3*e.measureText("A").width),t+=2*this.parameters.haloSize,Math.round(t)}computeLineHeight(){const e=1.275*this.parameters.definition.size;return Math.ceil(e+2*this.parameters.haloSize)+US}}const US=1,kS=[];{const e=16;for(let t=0;t<360;t+=360/e)kS.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}function jS(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}const GS={canvas:null},BS=512;class NS{constructor(e,t,i,r){this._idHint=r,this._glTexture=null,this.events=new se,this._requiresPowerOfTwo=!Mo(e.gl),this._renderer=new zS(t,i)}get id(){return null==this._id&&(this._id=id.idGen.gen(this._idHint)),this._id}get width(){return this._renderer.renderedWidth}get height(){return this._renderer.renderedHeight}get textureWidth(){const e=this.width;return this._requiresPowerOfTwo?Ve(e):e}get textureHeight(){const e=this.height;return this._requiresPowerOfTwo?Ve(e):e}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}get texcoordScale(){return[this._renderer.renderedWidth/this.textureWidth,this._renderer.renderedHeight/this.textureHeight]}get requiresFrameUpdates(){return!1}createDescriptor(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}load(e){if(h(this._glTexture))return this._glTexture;const t=jS(qS,this.textureWidth,this.textureHeight),i=t.getContext("2d");return i.save(),this._renderer.render(i,0,this.textureHeight-this._renderer.renderedHeight),this._glTexture=new Po(e,this.createDescriptor(e),t),i.restore(),this._glTexture}unload(){h(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),this.events.emit("unloaded")}}const qS={canvas:null},HS=[0,0,1];function WS(e,t,i){e&&e.forEach((e=>{const r=t(e);h(r)&&i(r,e.graphic)}))}const ZS={mode:"relative-to-ground",offset:0},QS={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};class YS{constructor(e=!0){this.enabled=e,this._time=0}get time(){return h(this._forcedTime)?this._forcedTime:oi(this._time)}advance(e){this.enabled&&(this._time+=e)}stopAtTime(e){this._forcedTime=e}}const $S={waveStrength:.06,waveTextureRepeat:32,waveDirection:hn(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1,...Qn},XS={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};class KS extends qn{constructor(e,t){super(t,e,$S),this.animation=new YS,this.techniqueConfig=new Rc}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.useSSR=this.params.ssrEnabled,this.techniqueConfig.isDraped=this.params.isDraped,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig.enableOffset=!t||t.camera.relativeElevation<Hn,this.techniqueConfig}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);return this.animation.enabled=Math.sqrt(this.params.waveTextureRepeat/this.params.waveStrength)*t<JS,this.animation.advance(e.dt),this.animation.enabled}intersect(e,t,i,r,s,a,n){Wn(e,t,r,s,a,void 0,n)}getGLMaterial(e){if(0===e.output&&this.params.isDraped){const t=e;return t.output=5,new Mc(t)}switch(e.output){case 0:case 2:case 4:case 7:return new Mc(e)}}createBufferWriter(){return new gl(Al)}}const JS=35e3;class eT extends sb{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){}destroy(){super.destroy(),h(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null)}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometryType(t.geometry,eT.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;const i="graphic"+t.uid,r=this.setGraphicElevationContext(t,new oc);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,r,i,t.uid)}ensureMaterial(){if(h(this._material))return;const e={...$S},t=this.symbolLayer.color;h(t)&&(e.color=At.toUnitRGBA(t));const i=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=h(this.symbolLayer.waveDirection)?eT.headingVectorFromAngle(this.symbolLayer.waveDirection):hn(0,0);const r=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,s=XS[r];e.waveStrength=s.waveStrength,e.waveTextureRepeat=s.textureRepeat,e.waveVelocity=s.waveVelocity,e.flowStrength=s.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new KS(e,"water"),this._context.stage.add(3,this._material)}layerOpacityChanged(){if(u(this._material))return!0;const e=this._material.params.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({color:[e[0],e[1],e[2],t],transparent:i}),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,s=fh(eT.elevationModeChangeTypes,i,r);if(s!==mh.UPDATE)return s;const a=gh(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return h(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i,r){const s=kb(e.geometry);if(u(s))return null;aT.renderData=jb(s,this._context.elevationProvider,this._context.renderCoordsHelper,t);const a=aT.renderData.position.length/3;if(aT.uvCoords=new Float64Array(2*a),aT.idHint=i,aT.outNum=0,aT.outGeometries=[],aT.outTransforms=[],aT.outMaterials=[],this._create3DShapeGeometries(aT),this._logGeometryCreationWarnings(aT.renderData,s.rings,"rings","WaterSymbol3DLayer"),0===aT.outNum)return null;this._createUVCoordsFromVertices(aT.uvCoords,aT.renderData.mapPosition,a,this._context.elevationProvider.spatialReference);const n=new Wc({geometries:aT.outGeometries,materials:aT.outMaterials,transformations:aT.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r},idHint:i}),o=yx,l=new zx(this,n,aT.outGeometries,null,null,o,t);return l.alignedSampledElevation=aT.renderData.sampledElevation,l.needsElevationUpdates=gh(t.mode),l}_createUVCoordsFromVertices(e,t,i,r){const s=Jt(r);Fi(iT);for(let e=0;e<i;e++)ls(rT,t[3*e+0],t[3*e+1]),Bi(iT,rT);Cs(iT,iT,s);const a=iT[0]%eT.unitSizeOfTexture,n=iT[1]%eT.unitSizeOfTexture;tT[0]=iT[0]-a,tT[1]=iT[1]-n;for(let r=0;r<i;r++)e[2*r+0]=(t[3*r+0]*s-tT[0])/eT.unitSizeOfTexture,e[2*r+1]=(t[3*r+1]*s-tT[1])/eT.unitSizeOfTexture}_create3DShapeGeometries(e){const t=e.renderData.polygons,i=e.uvCoords;for(const{count:r,index:s,position:a,mapPosition:n,holeIndices:o}of t){if(h(this._context.clippingExtent)&&(Bs(sT),Ks(sT,n),!Js(sT,this._context.clippingExtent)))continue;const t=Ur(n,o,3);if(0===t.length)continue;const l=Ub({indices:new Uint32Array(t),attributeData:{position:a,uv0:new Float64Array(i.buffer,2*s*i.BYTES_PER_ELEMENT,2*r),mapPosition:n}}),c=new ql(l,e.idHint);e.outGeometries.push(c),e.outMaterials.push(m(this._material)),e.outTransforms.push(Nr),e.outNum++}}_createAsOverlay(e,t){const i=kb(e.geometry);if(u(i))return null;m(this._material).renderPriority=this._renderPriority,nT.renderData=Gb(i,this._context.overlaySR),nT.idHint=t;const r=nT.renderData.position.length/3;return nT.uvCoords=new Float64Array(2*r),nT.outNum=0,nT.outGeometries=[],nT.outBoundingBox=Bs(),nT.layerUid=this._context.layer.uid,nT.graphicsUid=e.uid,this._createAsOverlayWater(nT),this._logGeometryCreationWarnings(nT.renderData,i.rings,"rings","WaterSymbol3DLayer"),0===nT.outNum?null:(this._createUVCoordsFromVertices(nT.uvCoords,nT.renderData.position,r,this._context.overlaySR),nT.outNum>0?new lw(this,nT.outGeometries,nT.outBoundingBox):null)}_createAsOverlayWater(e){const t=e.uvCoords,i=e.renderData.polygons;for(const{position:r,holeIndices:s,index:a,count:n}of i){if(Bs(sT),Ks(sT,r),!Js(sT,this._context.clippingExtent))continue;Ys(e.outBoundingBox,sT);const i=Ur(r,s,3);if(0===i.length)continue;const o=Ub({indices:new Uint32Array(i),attributeData:{position:r,uv0:new Float64Array(t.buffer,2*a*t.BYTES_PER_ELEMENT,2*n)}}),l=new td(o);l.data.layerUid=e.layerUid,l.data.graphicUid=e.graphicsUid,l.material=m(this._material);const c=sT;l.center=[.5*(c[0]+c[3]),.5*(c[1]+c[4]),0],l.bsRadius=.5*Math.sqrt((c[3]-c[0])*(c[3]-c[0])+(c[4]-c[1])*(c[4]-c[1])),e.outGeometries.push(l),e.outNum++}}static headingVectorFromAngle(e){const t=cn(),i=We(e);return t[0]=Math.sin(i),t[1]=Math.cos(i),t}get test(){return{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.idHint,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}eT.validGeometryTypes=["polyline","polygon","extent"],eT.unitSizeOfTexture=100,eT.elevationModeChangeTypes={definedChanged:mh.RECREATE,staysOnTheGround:mh.NONE,onTheGroundChanged:mh.RECREATE};const tT=cn(),iT=Li(),rT=cn(),sT=js(),aT={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},nT={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},oT=d.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function lT(e,t,i,r){const s=hT[e.type]&&hT[e.type][t.type]||cT[t.type];return s?new s(e,t,i,r):(oT.error("GraphicsLayerFactory#make",`unknown symbol type ${t.type}`),null)}const cT={icon:Fw,object:class extends sb{constructor(e,t,i,r){super(e,t,i,r),this._resources=null,this._optionalFields=[],this._instanceIndexToGraphicUid=new Map,this.ensureDrapedStatus(!1)}getCachedSize(){const[e,t,i]=h(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:i}}async doLoad(e){const t=this._getIdHint("_objectmat");if(!this._drivenProperties.size){if(wl(this.symbolLayer))throw new Error}const i=this.symbolLayer;if(this.isPrimitive){const e=i.resource?i.resource.primitive:Ht;this._resources=this._createResourcesForPrimitive(e,t)}else this._resources=await this._createResourcesForUrl(i.resource.href,e);this.complexity=this.computeComplexity()}get extentPadding(){return h(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return g(this._resources,"lodRenderer")}setMaterialTransparencyParams(e,t=g(this.symbolLayer,"material","color")){const i=this._getCombinedOpacity(t),r=i<1||this.needsDrivenTransparentPass;return e.transparent=r,e.opacity=i,e}_createResourcesForPrimitive(e,t){if(!function(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}(e))throw new Error(`Unknown object symbol primitive: ${e}`);const i=this.symbolLayer,r=js(sd(e)),s=Ne(sa(r)),a=Ne(ad(s,i)),o=$e(a),l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:Be,diffuse:Be,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},c=l.usePBR;this.setMaterialTransparencyParams(l);const d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=d.verticalOffset;l.verticalOffset={screenLength:kt(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},l.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(l.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)l.externalColor=Mr;else{const e=h(i.material)&&i.material.color,t=h(e)?At.toUnitRGBA(e):Mr;l.externalColor=t}this._fastUpdates=Cw(this._context.renderer,this._fastVisualVariableConvertOptions(r,a,s,v)),this._fastUpdates.enabled?(n(l,this._fastUpdates.materialParameters),l.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(l.instanced.push("color"),this._optionalFields.push("color"));const u=kx(e,new Eh(l,t),t);if(!u)throw new Error(`Unknown object symbol primitive: ${e}`);const p=Wx(u).map((e=>({opacity:1,transparent:e.params.transparent}))),m=this._createStageResources(u,c);return{lodResources:u,lodRenderer:this._createLodRenderer(u),stageResources:m,symbolSize:a,extentPadding:o,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:p,physicalBasedRenderingEnabled:c,resourceBoundingBox:r,resourceSize:s,dispose:v,pivotOffset:v}}async _createResourcesForUrl(e,t){const i=["transformation"],r={materialParamsMixin:{instanced:i,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=Cw(this._context.renderer,this._fastVisualVariableConvertOptions(v,v,v,v)),this._fastUpdates.enabled?(n(r.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const s=this.symbol;if("point-3d"===s.type&&s.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=s.verticalOffset;r.materialParamsMixin.verticalOffset={screenLength:kt(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},r.materialParamsMixin.castShadows=!1}r.signal=t,r.usePBR=this._context.physicalBasedRenderingEnabled;const a=r.usePBR,o=await nd(e,r),l=o.isEsriSymbolResource,c=o.isWosr,h=o.remove,d={levels:o.lods.map((e=>function(e){const t=[];return e.stageResources.geometries.forEach(((i,r)=>{const s=e.stageResources.materials[r],a=e.stageResources.textures;t.push({material:s,geometry:i,textures:a})})),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}(e)))};d.levels.forEach((e=>{e.minScreenSpaceRadius||(e.minScreenSpaceRadius=cC(e))})),d.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),d.levels[0].minScreenSpaceRadius=Math.min(2,d.levels[0].minScreenSpaceRadius);const u=this._context,p=this.symbolLayer.material,m=this._getExternalColorParameters(p),f=g(this.symbolLayer,"material","color"),y=this._getCombinedOpacity(f,{hasIntrinsicColor:!0}),_=this.needsDrivenTransparentPass,x=Wx(d),b=Wx(d).map((e=>{const t=e.params;return{opacity:t.opacity||1,transparent:t.transparent}}));x.forEach((e=>{const t=e.params;e.setParameterValues(m);const i=t.opacity*y,r=i<1||_||t.transparent;e.setParameterValues({opacity:i,transparent:r}),u.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:u.sharedResources.screenSizePerspectiveSettings})}));const w=o.referenceBoundingBox,C=Ne(sa(w)),S=Ne(d.levels[0].pivotOffset),T=Ne(ad(C,this.symbolLayer)),P=$e(T);Sw(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(w,T,C,S))&&x.forEach((e=>e.setParameterValues(this._fastUpdates.materialParameters)));const R=this._createStageResources(d,a);return{lodResources:d,lodRenderer:this._createLodRenderer(d),stageResources:R,symbolSize:T,extentPadding:P,isEsriSymbolResource:l,isWosr:c,originalMaterialParameters:b,physicalBasedRenderingEnabled:a,resourceBoundingBox:w,resourceSize:C,dispose:h,pivotOffset:S}}_createStageResources(e,t){const i=this._context.stage,r=Wx(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();for(const e of r)i.add(3,e);const s=function(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{e.textures&&t.push(...e.textures)}))})),M(t)}(e);for(const e of s)i.add(4,e);const a=function(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{t.push(e.geometry)}))})),M(t)}(e);for(const e of a)i.add(2,e);return{materials:r,textures:s,geometries:a}}_createLodRenderer(e){const t=this._context.stage,i={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicUpdate:(e,t)=>this._context.notifyGraphicUpdate(this._instanceIndexToGraphicUid.get(e),t)},r=this._fastUpdates.enabled?{applyTransform:(e,t,i)=>{e.getFeatureAttribute(t,BC),_i(i,Ow(this._fastUpdates.materialParameters,BC,i))},scaleFactor:(e,t,i)=>(t.getFeatureAttribute(i,BC),Dw(e,this._fastUpdates.materialParameters,BC))}:null,s=new AC(e,this._optionalFields,i,r);return s.slicePlane=this._context.slicePlaneEnabled,t.addRenderPlugin(s.slots,s),s}_getExternalColorParameters(e){const t={};return this._drivenProperties.color?t.externalColor=Mr:h(e)&&h(e.color)?t.externalColor=At.toUnitRGBA(e.color):(t.externalColor=Mr,t.colorMixMode="ignore"),t}destroy(){super.destroy();const e=this._context.stage;if(h(this._resources)){e.removeRenderPlugin(this._resources.lodRenderer),this._resources.lodRenderer.destroy();const t=this._resources.stageResources;for(const i of t.materials)e.remove(3,i.id);for(const i of t.textures)e.remove(4,i.id);for(const i of t.geometries)e.remove(2,i.id);h(this._resources.dispose)&&this._resources.dispose()}this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const i=bh(t.geometry);if(u(i))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t,new oc),s=e.renderingInfo;return this._createAs3DShape(t,i,s,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(u(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,i=this._resources.stageResources.materials,r=this._resources.originalMaterialParameters;for(let s=0;s<i.length;s++){const a=i[s],n=g(this.symbolLayer,"material","color"),o=r[s],l=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*o.opacity;a.setParameterValues({opacity:l,transparent:l<1||e||o.transparent})}return!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,yh)}slicePlaneEnabledChanged(){if(u(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(u(this._resources))return!0;const{stageResources:e,isEsriSymbolResource:t,isWosr:i}=this._resources;for(const r of e.materials)this.isPrimitive?r.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t&&!i&&r.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!0}pixelRatioChanged(){return!0}applyRendererDiff(e,t){if(u(this._resources))return!0;const{stageResources:{materials:i},lodRenderer:r,resourceBoundingBox:s,symbolSize:a,resourceSize:n,pivotOffset:o}=this._resources;for(const l in e.diff)switch(l){case"visualVariables":if(!Sw(this._fastUpdates,t,this._fastVisualVariableConvertOptions(s,a,n,o)))return!1;for(const e of i)e.setParameterValues(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged();break;default:return!1}return!0}computeComplexity(){if(u(this._resources))return super.computeComplexity();return{primitivesPerFeature:Zx(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.data.getIndices(Ll.POSITION).length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:eb(this.symbol,this.symbolLayer)}}hasLodRenderer(){return h(this._resources)}_createAs3DShape(e,t,i,r,s){if(!this.hasLodRenderer()||u(this._resources))return null;const a=this.getFastUpdateAttrValues(e),n=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?xl(i.color,i.opacity):null,o=this._context.clippingExtent;if(ir(t,kC,this._context.elevationProvider.spatialReference),h(o)&&!ta(o,kC))return null;const l=this._requiresTerrainElevation(r),c=this._computeGlobalTransform(t,r,GC,l?NC:null),d=this._computeLocalTransform(this._resources,this.symbolLayer,i,jC),p=this._resources.lodRenderer.instanceData,m=p.addInstance();this._instanceIndexToGraphicUid.set(m,s),p.setLocalTransform(m,d,!1),p.setGlobalTransform(m,c),a&&p.setFeatureAttribute(m,a),n&&p.setColor(m,n);const f=new rC(this,m,wx,r);return l&&(f.alignedSampledElevation=NC.sampledElevation),f.needsElevationUpdates=yh(r.mode),xh(f,t,this._context.elevationProvider),f}_computeGlobalTransform(e,t,i,r){const s=ph(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r);return kC[0]=e.x,kC[1]=e.y,kC[2]=s,nr(e.spatialReference,kC,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,t,i,r){return Si(r),this._applyObjectRotation(i,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,i,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,s=Pl(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===s[0]&&1===s[1]&&1===s[2]||Di(i,i,s)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(u(this._resources))return!0;const i=t&&bh(t);if(u(i))return!1;const r=this.getGeometryElevationMode(t);if(e.elevationContext.mode!==r)return!1;const s=this._requiresTerrainElevation(e.elevationContext);return this._computeGlobalTransform(i,e.elevationContext,GC,s?NC:null),s&&(e.alignedSampledElevation=NC.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,GC,!0),xh(e,i,this._context.elevationProvider),!0}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(u(this._resources))return;const i=(e,t,i)=>f(null!=e&&"complete"===e.type?e.newValue:t,i),r=i(t.heading,this.symbolLayer.heading,0),s=i(t.tilt,this.symbolLayer.tilt,0),a=i(t.roll,this.symbolLayer.roll,0),n=i(t.width,this.symbolLayer.width,void 0),o=i(t.height,this.symbolLayer.height,void 0),l=i(t.depth,this.symbolLayer.depth,void 0),c=i(t.anchor,this.symbolLayer.anchor,void 0),h=i(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const d={heading:r,tilt:s,roll:a,anchor:c,anchorPosition:h},p=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{p.symbolSize=Ne(ad(p.resourceSize,{width:n,height:o,depth:l,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const i=this._computeLocalTransform(p,d,t,jC),r=e.instanceIndex;p.lodRenderer.instanceData.setLocalTransform(r,i,!0)}))}_preparePatchColor(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const r=i.color.newValue,s=h(r)?At.toUnitRGBA(r):Mr;delete i.color;const a=this._resources;u(a)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(a.lodRenderer.instanceData.setColor(e.instanceIndex,s),t=this.setMaterialTransparencyParams({},r)):t=this.setMaterialTransparencyParams({externalColor:s},r);for(const e of a.stageResources.materials)e.setParameterValues(t)}))}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,i){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return Rl(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,t,i){const r=je();switch(i.anchor){case"center":Xe(r,Ns(e)),rt(r,r);break;case"top":{const t=Ns(e);Ye(r,-t[0],-t[1],-e[5]);break}case"bottom":{const t=Ns(e);Ye(r,-t[0],-t[1],-e[2]);break}case"relative":{const t=Ns(e),s=sa(e),a=i.anchorPosition,n=a?ke(a.x,a.y,a.z):Ge;dt(r,s,n),Qe(r,r,t),rt(r,r);break}case"origin":default:h(t)?rt(r,t):Xe(r,Ge)}return r}_applyAnchor(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&Mi(i,i,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,i,r){const s=h(e)?Ne(sa(e)):Be,a=h(e)?this._computeAnchor(e,r,this.symbolLayer):Ge,n=this._context.renderCoordsHelper.unitInMeters,o=Pl(h(t)?t:void 0,t,i,n),l=ke(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:s,symbolSize:h(t)?t:Be,unitInMeters:n,transformation:{anchor:a,scale:o,rotation:l}}}},line:kw,path:yS,fill:ES,extrude:qb,text:class extends sb{constructor(e,i,r,s){super(e,i,r,s),this._geometryDataPool=new t(Hl,((e,t,i)=>{const r=t.translation,s=h(i)?[i.displayWidth,i.displayHeight]:[0,0],a=t.centerOffset;if(0===e.indexCount){const t=HS,i=[0,0];fl.createPointGeometry(t,r,null,s,a,i,null,e)}else fl.updatePointGeometry(null,r,null,s,a,null,null,e)})),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=wl(this.symbolLayer.size);if(e)throw new ee("graphics3dtextsymbollayer:invalid-size",e)}this._createTextRenderParameters()}_createTextRenderParameters(){const e=this._context.layerView.view.pixelRatio;this._textRenderParameters=VS.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy(),this._geometryDataPool.destroy()}createGraphics3DGraphic(e){const t=e.graphic,i=bh(t.geometry);if(u(i))return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const r=this.symbolLayer.text;if(!r)return null;const s=Wt(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,i,r,s)}onRemoveGraphic(e){this._geometryDataPool.release(e.stageObject.geometries[0].data)}createLabel(e,t,i,r){const s=e.graphic,a=bh(s.geometry);if(u(a))return this.logger.warn(`unsupported geometry type for label: ${s.geometry.type}`),null;const n=t.text;return!n||/^\s+$/.test(n)?null:this._createAs3DShape(s,a,n,t,t,i,r)}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return WS(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),mh.UPDATE}slicePlaneEnabledChanged(e,t){return WS(e,t,(e=>{for(const t of e.stageObject.geometryRecords)t.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=gh(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode}_defaultElevationInfoNoZ(){return ZS}_createAs3DShape(e,t,i,r,s=QS,a,n){const o=this.setGraphicElevationContext(e,new oc,s.elevationOffset),l=this._context.layer.id+"_label_"+e.uid,c="polyline"===g(e.geometry,"type"),d=e.uid,p=this._context.stage.renderView.renderingContext,m=s.anchor in Cl?s.anchor:"center",f=Cl[m],v=u(n)?new NS(p,i,this._textRenderParameters,l):null,y={occlusionTest:!0,screenOffset:s.screenOffset,anchorPos:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,debugDrawBorder:s.debugDrawBorder,drawInSecondSlot:!0};if(h(v)&&(y.textureId=v.id,y.texCoordScale=v.texcoordScale),h(n)&&(y.textureId=n.textureId),h(r)&&h(r.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=r.verticalOffset;y.verticalOffset={screenLength:kt(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;y.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize),y.screenSizePerspectiveAlignment=e}c&&(y.shaderPolygonOffset=1e-4),y.slicePlaneEnabled=this._context.slicePlaneEnabled;let _=null;if(h(a)){const e=JSON.stringify(y);_=a.getMaterial(e),null==_&&(_=new ac(y,l),a.addMaterial(e,_))}else _=new ac(y,l);const x=[_],b=this._geometryDataPool.acquire(s,v),w=[new ql(b,l)],C=this._context.layer.uid,S=_h(this._context,t,w,x,null,null,o,l,C,d);if(null===S)return null;const T=xx,P=new zx(this,S.object,w,u(a)?x:null,h(v)?[v]:null,T,o);P.alignedSampledElevation=S.sampledElevation,P.needsElevationUpdates=gh(o.mode)||"absolute-height"===o.mode;const{displayWidth:R,displayHeight:M}=h(v)?v:s;P.getScreenSize=(e=cn())=>(e[0]=R,e[1]=M,e);const O={labelText:i,elevationOffset:s.elevationOffset};return P.metadata=O,xh(P,t,this._context.elevationProvider),P}},water:eT},hT={"mesh-3d":{fill:Zw}};class dT extends Ux{constructor(e,t,i){super(),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=[],this.referenced=0,this._extentPadding=0}set symbol(e){if(this._symbol=e,this.symbolLayers)for(let t=0;t<e.symbolLayers.length;t++){const i=this.symbolLayers[t];u(i)||(i.symbol=e,i.symbolLayer=e.symbolLayers.items[t])}}get symbol(){return this._symbol}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const r=[];for(let s=0;s<i;s++){const a=t.getItemAt(s);if(!1===a.enabled)continue;uT.renderPriority=1-(1+s)/i,uT.renderPriorityStep=1/i,uT.ignoreDrivers=a._ignoreDrivers;const n=lT(this.symbol,a,this._context,uT);r.push(H(e,(()=>{this.symbolLayers[s]=null,n.destroy()}))),this.symbolLayers[s]=n}await ne(this.symbolLayers,(async(e,t)=>{if(h(e))try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}}));for(const e of r)null==e||e.remove();if(r.length=0,q(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return h(t)?t.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(e,t){const i=e.graphic,r=new Array(this.symbolLayers.length);for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];r[t]=h(i)?i.createGraphics3DGraphic(e):null}const s=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new Ib(i,t||this,r,e.layer,s)}get complexity(){return $x(this.symbolLayers.map((e=>g(e,"complexity"))))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let r=0;r<i;r++){const i=this.symbolLayers[r],s=e=>{const t=e._graphics[r];return t instanceof zx?t:null};if(h(i)&&!i.globalPropertyChanged(e,t,s))return!1}return!0}applyRendererDiff(e,t){return 1===this.loadStatus&&this.symbolLayers.reduce(((i,r)=>i&&(u(r)||r.applyRendererDiff(e,t))),!0)}prepareSymbolPatch(e){if(2===this.loadStatus)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const i=t.symbolLayers.diff;this.symbolLayers.forEach(((t,r)=>{if(u(t))return;const s=i[r];if(s){const i={diff:s,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(i),e.symbolStatePatches.push(...i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const s=e._graphics[r];h(s)&&i.graphics3DGraphicPatches.forEach((e=>e(s,t)))}))}}))}updateGeometry(e,t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(u(r))continue;const s=e._graphics[i];if(u(s)||!r.updateGeometry(s,t))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if(u(i))continue;const r=e._graphics[t];h(r)&&i.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=0,t=0,i=0;return this.symbolLayers.forEach((r=>{u(r)||(0===r.loadStatus?e++:r.isFastUpdatesEnabled()?i++:t++)})),{loading:e,slow:t,fast:i}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{this.abortLoad();for(const e of this.symbolLayers)h(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const uT={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class pT extends Ux{constructor(e,t){super(),this.symbol=e,this.convert=t,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return h(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}get extentPadding(){return h(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this.convert(t),await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return h(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return h(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:Qx}globalPropertyChanged(e,t){return!!h(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return!!h(this.graphics3DSymbol)&&this.graphics3DSymbol.applyRendererDiff(e,t)}prepareSymbolPatch(e){h(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return!!h(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,t)}onRemoveGraphic(){}getFastUpdateStatus(){return h(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){h(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,this.abortLoad()}get destroyed(){return void 0===this.graphics3DSymbol}}function mT(e){return e instanceof pT?e.graphics3DSymbol:e instanceof dT?e:null}const fT=d.getLogger("esri.views.3d.layers.graphics.labelPlacement");function gT(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,s=mT(r.graphics3DSymbol),a=h(s)?s.symbol:null,n=wT[t]||_T(e);if("point-3d"===a.type&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!r.isDraped)return{placement:null,hasLabelVerticalOffset:!1,verticalOffset:bT(a.verticalOffset),anchor:null,normalizedOffset:null};if(i&&i.hasVisibleVerticalOffset()&&("point-3d"!==a.type||!a.supportsCallout()||!a.verticalOffset||r.isDraped))return function(e){switch(e){case"above-center":return!0;default:return!1}}(n.placement)?{placement:"above-center",verticalOffset:bT(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(fT.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null);return{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}(e);if(u(t))return null;const i=function(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=wT[i],s=r||_T(e);i&&!r&&fT.warnOncePerTick(`the requested label placement '${i}' is not currently supported in SceneView`);return function(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(u(i))return null;if(h(t.disablePlacement)){return t.labelClass.labelPlacement?(fT.warnOncePerTick(yT(e.placement,t.disablePlacement.logEntityDescription)),_T(t)):e}const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return fT.warnOncePerTick(yT(e.placement,`'${r}' geometries`)),_T(t);break;case"point":case"mesh":return e}return e}(s,e)}(e,t);if(u(i))return null;const r=i.anchor,s=!!t.hasLabelVerticalOffset;return function(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(u(r))return null;switch(r.type){case"point":!function(e,t,i){const r=vT(i);if(u(r))return;switch(i.graphics3DGraphic.getCenterObjectSpace(e.translation),r.type){case"icon":case"text":!function(e,t,i){const{graphics3DGraphic:r}=i,s=r._graphics[0],a=h(s)?s.getScreenSize():null;if(!r.isDraped&&h(a)){const r=function(e,t=TT){const{graphics3DGraphic:i}=e,r=i._graphics[0],s=h(r)?r.stageObject.geometryRecords[0].material:null;if(s&&s instanceof ac){const e=s.params.anchorPos;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}(i);ST[0]=a[0]/2*(t.normalizedOffset[0]-r[0]),ST[1]=a[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=ST[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=ST[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=ST[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(wT[i.labelClass.labelPlacement]&&fT.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}(e,t,i);break;case"object":xT(e,t,i)}}(e,t,i);break;case"polygon":!function(e,t,i){const r=vT(i);if(u(r))return;switch(r.type){case"extrude":{const r=i.graphics3DGraphic._graphics[0];h(r)&&r.getBoundingBoxObjectSpace(PT),Ns(PT,e.translation),e.translation[2]=na(PT)/2,xT(e,t,i);break}}}(e,t,i);break;case"mesh":xT(e,t,i)}return e}({anchor:r,verticalOffset:t.verticalOffset,screenOffset:cn(),centerOffset:Pr(0,0,0,-1),centerOffsetUnits:"world",translation:je(),elevationOffset:0,hasLabelVerticalOffset:s},i,e)}function vT(e){const t=mT(e.graphics3DGraphic.graphics3DSymbol);return h(t)?t.symbol.symbolLayers.getItemAt(0):null}function yT(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView`}function _T(e){const t=e.graphics3DGraphic.graphic.geometry;if(u(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=vT(e);return h(t)&&"extrude"===t.type?wT["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return wT["above-center"];default:return}}function xT(e,t,i){const r=i.graphics3DGraphic._graphics[0],s=h(r)?r.getBoundingBoxObjectSpace(PT):PT,a=ke(s[3]-s[0],s[4]-s[1],s[5]-s[2]),n=Math.sqrt(a[0]*a[0]+a[1]*a[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const o=e.translation[2],l=a[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=o+l;const c=$e(a);e.centerOffset[2]=c/2*t.normalizedOffset[2]}function bT(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const wT={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},CT={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in CT){const t=CT[e],i=wT[e];t.forEach((e=>{wT[e]=i}))}Object.freeze&&(Object.freeze(wT),Object.keys(wT).forEach((function(e){Object.freeze(wT[e]),Object.freeze(wT[e].normalizedOffset)})));const ST=[0,0],TT=[0,0],PT=js();class RT{constructor(e){this.materials={},this.stage=e}getMaterial(e){return this.materials[e]}addMaterial(e,t){this.materials[e]=t,this.stage.add(3,t)}dispose(){for(const e in this.materials)this.stage.remove(3,this.materials[e].id);this.materials={}}}var MT;let OT=MT=class extends T{constructor(e){super(e),this.events=new se,this.glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.id=id.idGen.gen(this.idHint),this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(4,this);const e=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(e),this.update2DCanvasSize(),this.resetAtlasCursor()}unload(){h(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}createDescriptor(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}load(e){if(h(this.glTexture))return this.glTexture;this.glTexture=new Po(e,this.createDescriptor(e),this.canvas);const t=this.view.resourceController.scheduler;return this.frameWorker=t.registerTask(xr.TEXT_TEXTURE_ATLAS,(e=>this.run(e,!0)),(()=>this.updating)),this.setDirty(),this.glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null),this.glTexture&&(this.stage.remove(4,this.id),this.glTexture=null),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",512..toString()),e.setAttribute("height",512..toString()),e}update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}createAtlasRegion(e=512){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}computeAtlasResolution(e,t){let i=Math.max(e,t);return i+=256,i=Ve(i),i=Math.min(i,4096),i}resizeAtlas(e,t){t=t||e;const i=this.atlas;i.size.width=e,i.size.height=t,h(this.glTexture)&&this.glTexture.resize(e,t),this.update2DCanvasSize()}resetAtlasCursor(){const e=this.atlas;e.cursor.x=DT,e.cursor.y=DT+AT,e.lineHeight=0,this.needsClear=!0}getAtlasUsage(){const e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,i=this.elements.size;return this.getAtlasUsage()/i*(i+t-e)}addAtlasElement(e,t,i,r){const s=this.atlas,{renderedWidth:a,renderedHeight:n,displayWidth:o,displayHeight:l}=e.textRenderer;e.placement.offset.x=s.cursor.x,e.placement.offset.y=s.cursor.y,e.placement.size.width=a,e.placement.size.height=n,e.placement.size.displayWidth=o,e.placement.size.displayHeight=l,e.placement.uvMinMax=[e.placement.offset.x/s.size.width,1-(e.placement.offset.y+n)/s.size.height,(e.placement.offset.x+a)/s.size.width,1-e.placement.offset.y/s.size.height],s.cursor.x+=i,s.lineHeight=Math.max(s.lineHeight,r),this.elements.set(t,e)}removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,i=e.placement.size;this.ctx.clearRect(t.x,t.y,i.width,i.height),this.elements.delete(e.textId)}}ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const i=new Set;return this.stageObjects.set(e,i),i}addStageObject(e,t){this.ensureStageObjects(e).add(t)}removeStageObject(e,t){const i=this.stageObjects.get(e);i&&i.delete(t)&&(t.geometries[0].data.vertexAttributes.size.data=new Float32Array([0,0]),t.geometryVertexAttrsUpdated(0))}_processAddition(e,t){const i=this.atlas,r=e.textId,s=e.textRenderer.renderedWidth,a=e.textRenderer.renderedHeight,n=s+DT,o=a+DT+AT;if(i.cursor.x+n<i.size.width&&i.cursor.y+o<i.size.height)this.addAtlasElement(e,r,n,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+o+i.lineHeight<i.size.height)){const e=this.getExpectedAtlasUsage(),r=e>.85&&i.size.width<4096;return r&&this.resizeAtlas(2*i.size.width,2*i.size.height),!t||!r&&e>.95&&4096===i.size.width?(this.processRemovals(),0):(this.repack(),1)}i.cursor.x=DT,i.cursor.y+=i.lineHeight,i.lineHeight=0,this.addAtlasElement(e,r,n,o),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r)}return 0}processRemovals(){this.elementsToRemove.forEach(((e,t)=>{const i=this.stageObjects.get(t);i&&0!==i.size||this.removeAtlasElement(e),i&&0===i.size&&this.stageObjects.delete(t)})),this.elementsToRemove.clear()}repack(){this.processRemovals(),this.elements.forEach(((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e)})),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear()}processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach((t=>{t.geometries[0].data.vertexAttributes.uv0.data=new Float32Array(e.placement.uvMinMax),t.geometries[0].data.vertexAttributes.size.data=new Float32Array([e.placement.size.displayWidth,e.placement.size.displayHeight]),t.geometryVertexAttrsUpdated(0)})),e.rendered=!0}run(e,t){if(!this.glTexture)return;let i=!1;if(ua(this.elementsToAddOrUpdate,((e,r)=>{const s=this.elements.get(r);if(s&&s.rendered){const e=this.stageObjects.get(r);return e&&e.forEach((e=>{const t=e.geometries[0].data.vertexAttributes,i=this.elements.get(r);t.uv0.data=new Float32Array(i.placement.uvMinMax),t.size.data=new Float32Array([i.placement.size.displayWidth,i.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(0)})),this.elementsToAddOrUpdate.delete(r),!1}return 1===this._processAddition(this.elementsToAddOrUpdate.get(r),t)&&(i=!0,!0)})),i)return void this.run(br,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),ua(this.elementsToRender,((t,i)=>(this.processRenderingRequest(t),this.elementsToRender.delete(i),r=!0,e.madeProgress(),e.done))),r&&h(this.glTexture)&&this.glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&MT.test.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(e,t){const i=e.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this.addStageObject(i,t),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,t){const i=e.key;this.elementsToRemove.set(i,this.elements.get(i)),this.removeStageObject(i,t)}get textureId(){return this.id}setDirty(){this.updating=!0}repackOrdered(){if(0===this.elements.size)return;const e=[];this.elements.forEach(((t,i)=>e.push({element:t,key:i})));let t=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort(((e,t)=>e.key.localeCompare(t.key))),this.elements.clear();for(const{element:t,key:i}of e)this.elements.set(i,t);this.repack(),this.setDirty()}}get test(){const{elements:e,stageObjects:t,elementsToRemove:i,atlas:r}=this,s=this;return{elements:e,stageObjects:t,elementsToRemove:i,atlas:r,resizeAtlas:(e,t)=>s.resizeAtlas(e,t),run:(e,t)=>s.run(e,t)}}};OT.test={orderedRepackingEnabled:!1},e([S({constructOnly:!0})],OT.prototype,"idHint",void 0),e([S({constructOnly:!0})],OT.prototype,"view",void 0),e([S({type:Boolean})],OT.prototype,"updating",void 0),OT=MT=e([re("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],OT);const DT=2,AT=2;var ET=OT;const IT=d.getLogger("esri.views.3d.layers.graphics.Labeler");let LT=class extends T{constructor(){super(...arguments),this.idHint="__labeler",this._dirty=!1,this.labels=new Map,this.labelsToAdd=new Map,this.labelsToRemove=new Map,this.labelingContexts=[]}setup(){if(u(this.handles)){const e=this.view.resourceController.scheduler;this.handles=new $t,this.handles.add([this.view.watch("state.camera",(()=>this.setDirty())),this.view.watch("pixelRatio",(()=>this.resetAllLabels())),e.registerTask(xr.LABELER,(e=>this.update(e)),(()=>this.needsUpdate()))])}u(this.textTextureAtlas)&&(this.textTextureAtlas=new ET({idHint:this.idHint+"_atlas",view:this.view}),this.hudMaterialCollection=new RT(this.view._stage),this.calloutMaterialCollection=new RT(this.view._stage))}dispose(){this.handles=p(this.handles),this.textTextureAtlas=y(this.textTextureAtlas),this.hudMaterialCollection=y(this.hudMaterialCollection),this.calloutMaterialCollection=y(this.calloutMaterialCollection),this.labelingContexts=[],this.labels.clear(),this.labelsToAdd.clear(),this.labelsToRemove.clear()}isActiveLabelingContext(e){return e.active&&wa(e.layer)}activateLabelingContext(e){e.labels.forEach(((e,t)=>{this.labels.set(t,e),e.graphics3DGraphic.setVisibilityFlag(0,!0,1)})),e.active=!0}deactivateLabelingContext(e){e.labels.forEach(((e,t)=>{e.graphics3DGraphic.setVisibilityFlag(0,!1,1),this.setLabelGraphicVisibility(e.graphics3DGraphic,!1),this.labels.delete(t)})),e.active=!1}addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&this.textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0}removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];i&&this.textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1}needsUpdate(){return this.view.ready&&this.isDirty}update(e){this._updateLabels(e),!this._dirty&&this.deconflictor.needsUpdate()&&this.deconflictor.update(e)}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this.labelingContexts)if(this.isActiveLabelingContext(t)){if(!this.hasValidLabelClassContext(t)){if(this.hasInvalidLabelClassContext(t)){this.deactivateLabelingContext(t);continue}if(this.createLabelClassContext(t),this.hasPendingLabelClassContext(t)){this._dirty=!0;continue}if(!this.hasValidLabelClassContext(t))continue}ua(t.labelsToInitialize,((i,r)=>(this.ensureGraphics3DResources(i)&&(this.labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.hasTextTextureResources||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done)))&&(this._dirty=!0)}this.labelsToRemove.forEach((e=>this.removeLabelTextureFromAtlas(e))),this.labelsToRemove.clear(),this.labelsToAdd.forEach((e=>this.addLabelTextureToAtlas(e))),this.labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}hasPendingLabelClassContext(e){return e.labelClassPromise&&!!e.labelClassAbortController}hasValidLabelClassContext(e){return e.labelClassContexts&&e.labelClassContexts.length}hasInvalidLabelClassContext(e){return null===e.labelClassContexts}async createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),q(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo&&r.labelingInfo.filter((e=>!!e.symbol));if(!s||0===s.length)return;const a=new Array(s.length);let n=!1;await ne(s,(async(r,s)=>{const o=r.symbol,l=mT(i.getOrCreateGraphics3DSymbol(o));if(u(l))return void IT.error("Failed to create Graphics3DSymbol for label");await l.load(),q(t);let c=null;Wt(o)&&o.hasVisibleCallout()&&(c=Mb(o,i.symbolCreationContext),await c.load(),q(t));const h=await oe(uh(r,e.layer.fields.map((e=>e.toJSON())),this.view.spatialReference));q(t),!0===h.ok?a[s]={labelClass:r,labelFunction:h.value,graphics3DSymbol:l,graphics3DCalloutSymbolLayer:c,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(l.symbol)}:(IT.error(`Label expression failed to evaluate: ${h.error}`),n=!0)})),q(t),n||(e.labelClassContexts=a)}async createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this.createLabelClassContextAsync(e).catch((t=>{if(U(t))throw t;e.labelClassContexts=null})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?VS.fromSymbol(t,this.view.pixelRatio):null}destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced,t.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=z(),t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")}createTextSymbolGraphic(e,t,i,r,s){const a={text:e.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,anchor:i.anchor,centerOffsetUnits:i.centerOffsetUnits,verticalOffset:i.verticalOffset,debugDrawBorder:xc.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return FT.graphic=t,FT.renderingInfo=null,FT.layer=r,s.createLabel(FT,a,this.hudMaterialCollection,this.textTextureAtlas)}createLineCalloutGraphic(e,t,i,r,s){const a={symbol:t,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};return FT.graphic=e,FT.renderingInfo=a,FT.layer=s,i.createGraphics3DGraphic(FT)}ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this.ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(!r||0===r.length||!i.emptySymbolLabelSupported&&0===t._graphics.length)return!1;let s=!1;const a=t.graphic,n=i.layer,o=wa(i.layer),l=this.view._stage;for(let c=0;c<r.length;c++){const h=e.textRenderers[c];if(!h)continue;const d=r[c],p=d.graphics3DSymbol;let m=null;p.symbol&&"label-3d"===p.symbol.type&&(m=p.symbol);const f=p.symbolLayers[0];if(!f)continue;const g=d.labelClass,v=gT({graphics3DGraphic:t,labelSymbol:m,labelClass:g,disablePlacement:i.disablePlacement});if(u(v))continue;f.setElevationInfoOverride(i.elevationInfoOverride);const y=this.createTextSymbolGraphic(h,a,v,n,f);if(!y)return!1;y._labelClass=g,y._labelIndex=c,t.addLabelGraphic(y,l,i.stageLayer),t.setVisibilityFlag(0,o,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),s=!0;const _=d.graphics3DCalloutSymbolLayer;if(_&&v.hasLabelVerticalOffset){_.setElevationInfoOverride(i.elevationInfoOverride);const e=this.createLineCalloutGraphic(a,m,_,v,n);e&&(d.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(e,l,i.stageLayer))}break}return i.scaleVisibility&&s&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelGraphics){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}ensureTextTextureResources(e){if(e.hasTextTextureResources)return;const t=e.labelingContext,i=t.labelClassContexts;if(!i||0===i.length)return;const r=e.graphics3DGraphic.graphic;for(let s=0;s<i.length;s++){const a=i[s];if(e.textRenderers[s]=null,!a.textRenderParameters)continue;const n=a.labelFunction;let o;if("arcade"===n.type)try{const e=n.needsHydrationToEvaluate()?El(r,t.layer):r;o=n.evaluate(e)}catch(e){o=null}else o=n.evaluate(r);u(o)||""===o||/^\s+$/.test(o)||(e.textRenderers[s]=new zS(o,a.textRenderParameters))}e.hasTextTextureResources=!0}destroyTextTextureResources(e){e.textRenderers=[],e.hasTextTextureResources=!1}addGraphic(e,t){const i={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},r=t.graphic.uid;e.labels.set(r,i),e.labelsToInitialize.set(r,i),this.setDirty(),this.deconflictor.setDirty()}removeGraphic(e,t){const i=t.graphic.uid,r=e.labels.get(i);r&&(this.destroyGraphic(r,i),e.labels.delete(i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}destroyGraphic(e,t){this.labels.has(t)&&(this.labels.delete(t),this.labelsToAdd.delete(t),this.labelsToRemove.delete(t)),e.hasTextTextureResources&&(this.removeLabelTextureFromAtlas(e),this.destroyTextTextureResources(e)),e.hasGraphics3DResources&&this.destroyGraphics3DResources(e)}async labelingInfoChange(e,t){if(!t)return this.visibilityInfoChange(e),this.resetLabels(e),this.createLabelClassContext(e);for(const i of t){const t=e.labels.get(i);t&&(this.removeGraphic(e,t.graphics3DGraphic),this.addGraphic(e,t.graphics3DGraphic))}}globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.labels.forEach((e=>{const t=e.graphics3DGraphic;r.set(t.graphic.uid,t)}));const s=e=>e.labelGraphics[0];if(m(i.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelGraphics[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this.activateLabelingContext(e),!t&&e.active&&this.deactivateLabelingContext(e),this.setDirty()}resetAllLabels(){for(const e of this.labelingContexts)this.resetLabels(e)}resetLabels(e){e.labels.forEach(((t,i)=>{this.destroyGraphic(t,i),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(i,t)})),this.destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}findLabelingContext(e){for(const t of this.labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,a=i&&i.disablePlacement||null;if(this.findLabelingContext(e))return;const n=e.layer,o={graphics3DCore:e,layer:n,scaleVisibility:t,emptySymbolLabelSupported:r,elevationInfoOverride:s,disablePlacement:a,active:n.labelsVisible,labelClassPromise:null,labelClassAbortController:z(),labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new Il(`${this.idHint}_${n.uid}`,{isPickable:!0},n.uid)};return this.view._stage.add(0,o.stageLayer),this.view._stage.addToViewContent([o.stageLayer.id]),this.labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this.addGraphic(o,e),removeGraphic:e=>this.removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>wa(o.layer),labelingInfoChange:e=>this.labelingInfoChange(o,e),elevationInfoChange:()=>this.globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this.globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this.visibilityInfoChange(o),reset:()=>this.resetLabels(o),clear:()=>{},processStageDirty:()=>this.view._stage.processDirtyLayer(o.stageLayer.id)}}removeGraphicsOwner(e){const t=this.findLabelingContext(e);if(!t)return;const i=this.labelingContexts.indexOf(t);this.labelingContexts.splice(i,1),t.labels.forEach((e=>this.removeGraphic(t,e.graphics3DGraphic)));const r=t.stageLayer.id;this.view._stage.removeFromViewContent([r]),this.view._stage.remove(0,r),t.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this.labels.get(i);r&&r.visible!==t&&(t&&!r.rendered?(this.labelsToAdd.set(i,r),this.labelsToRemove.delete(i),r.hasTextTextureResources||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.rendered&&(this.labelsToRemove.set(i,r),this.labelsToAdd.delete(i)),r.visible=t,this.setDirty())}get isDirty(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.needsUpdate()}setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.deconflictor.updating||this.labelingContexts.some((e=>this.hasPendingLabelClassContext(e)))}get updatingProgress(){if(!this.updating||!this.textTextureAtlas)return 1;const e=this.labelingContexts.length>0?this.labelingContexts.reduce(((e,t)=>e+(this.hasPendingLabelClassContext(t)?0:1)),0)/this.labelingContexts.length:1;return(this._dirty?0:.3)+(this.textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this.textTextureAtlas,resetAllLabels:()=>this.resetAllLabels()}}};e([S({constructOnly:!0})],LT.prototype,"view",void 0),e([S({constructOnly:!0})],LT.prototype,"deconflictor",void 0),e([S()],LT.prototype,"textTextureAtlas",void 0),e([S({type:Boolean,readOnly:!0,dependsOn:["textTextureAtlas.updating","deconflictor.updating"]})],LT.prototype,"updating",null),LT=e([re("esri.views.3d.layers.graphics.Labeler")],LT);const FT=new Db(null,null,null);class VT{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new $t}loadGLTF(e,t){const i=`gltf:${e}`;return this.fromCache(this.gltfCache,i,(t=>Uh(new kh(t.streamDataRequester),e,t)),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`;return this.fromCache(this.wosrCache,i,(t=>od(e,t)),t)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}fromCache(e,t,i,r){return W(((s,a)=>{if(Z(r))return void a(B());const n=Q(r,(()=>{this.remove(e,t),a(B())})),o=e.get(t);if(o)return this.evictHandles.remove(t),o.refCount++,void o.item.then(s,a);const l=z(),c={...r,signal:l.signal},d={refCount:1,abortController:l,item:i(c).then((i=>(d.abortController=null,i.remove=()=>this.remove(e,t),i)))};e.set(t,d),d.item.then((e=>{h(n)&&n.remove(),s(e)}),(e=>{h(n)&&n.remove(),a(e)}))}))}remove(e,t){const i=e.get(t);i&&(i.refCount--,0===i.refCount&&this.evictHandles.add(b((()=>{e.delete(t),h(i.abortController)&&i.abortController.abort()}),zT),t))}}let zT=1e4;class UT{constructor(e,t,i,r=null){this.lij=[0,0,0],this.extent=Li(),this.resolution=0,this.loadPriority=0,this.measures={visibility:2,screenRect:Li(),distance:0,shouldSplit:!1},this.used=!1,r&&this.acquire(e,t,i,r)}acquire(e,t,i,r){this.tilingScheme=r,this.id=UT.id(e,t,i),this.lij[0]=e,this.lij[1]=t,this.lij[2]=i,r.getExtent(e,t,i,this.extent),this.resolution=r.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const t=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return e?(e[0].acquire(t,i,r,this.tilingScheme),e[1].acquire(t,i+1,r,this.tilingScheme),e[2].acquire(t,i,r+1,this.tilingScheme),e[3].acquire(t,i+1,r+1,this.tilingScheme),e):[new UT(t,i,r,this.tilingScheme),new UT(t,i+1,r,this.tilingScheme),new UT(t,i,r+1,this.tilingScheme),new UT(t,i+1,r+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,Ni(e.measures.screenRect,this.measures.screenRect)}static id(e,t,i){return`${e}/${t}/${i}`}}class kT{constructor(e){this.frustum=$o(),this.lines=new Array(12),this.origin=je(),this.direction=je(),this._altitude=null,this.renderCoordsHelper=e?e.renderCoordsHelper:null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:je(),endpoint:null}}get planes(){return this.frustum.planes}get points(){return this.frustum.points}get mutablePoints(){return this.frustum.points}update(e){Xo(e.viewMatrix,e.projectionMatrix,this.frustum),Xe(this.origin,e.eye),Xe(this.direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this.origin),this.updateLines()}updatePoints(e){for(let t=0;t<this.frustum.points.length;t++)Xe(this.frustum.points[t],e[t]);Ko(this.frustum),this.updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return Jo(this.frustum.planes,e)}intersectsRay(e){return el(this.frustum.planes,e)}intersectsLineSegment(e,t){return tl(this.frustum.planes,e,t)}intersectsPoint(e){return il(this.frustum.planes,e)}updateLines(){const{points:e}=this.frustum;for(let t=0;t<4;t++){const i=t,r=t+4;this.updateLine(this.lines[t],e[i],e[r]),this.updateLine(this.lines[t+4],e[i],3===t?e[0]:e[i+1]),this.updateLine(this.lines[t+8],e[r],3===t?e[4]:e[r+1])}}updateLine(e,t,i){e.origin=t,e.endpoint=i,xt(e.direction,t,i)}}kT.planePointIndices=rl,kT.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]];const jT=.5*Math.PI,GT=jT/Math.PI*180;class BT{constructor(e){this.renderCoordsHelper=e.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:je(),direction:je()};for(let e=0;e<4;e++)this.extent[e]={origin:je(),direction:je(),cap:{next:null,direction:je()}},this.planes[e]=Uo.create();this.planes[4]=Uo.create(),this.planes[5]=Uo.create(),this.planesWithoutFar=this.planes.slice(0,5)}update(e,t,i,r=!0){const s=this.extent;this.toRenderBoundingExtent(e,t,i),Qe(this.center.origin,s[0].origin,s[2].origin),Ze(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),r||Ze(this.center.direction,this.center.direction,-1);for(let e=0;e<4;e++){const t=s[e];this.renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);const i=s[3===e?0:e+1];t.cap.next=i.origin,xt(t.cap.direction,t.origin,i.origin),Uo.fromVectorsAndPoint(t.direction,t.cap.direction,t.origin,this.planes[e]),r||Ze(t.direction,t.direction,-1)}Uo.fromVectorsAndPoint(s[0].cap.direction,s[1].cap.direction,s[0].origin,this.planes[4]),r?Uo.negate(this.planes[4],this.planes[5]):(Uo.copy(this.planes[4],this.planes[5]),Uo.negate(this.planes[4],this.planes[4])),this.maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this.maxSpanSpatialReference=t,this.minGlobalAltitude=.9*Kt(this.maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(null==e)return!1;if(1===this.renderCoordsHelper.viewingMode){const i=this.maxSpanSpatialReference.isGeographic?GT:jT*t;if(this.maxSpan>i)return!0;if(e.altitude>=this.minGlobalAltitude)return this.isVisibleInFrustumGlobal(e)}if(0===this.maxSpan){const t=this.extent[0];return!(i||!e.intersectsRay(ko.wrap(t.origin,t.direction)))}for(let t=0;t<this.extent.length;t++){const r=this.extent[t];if(!i&&e.intersectsRay(ko.wrap(r.origin,r.direction)))return!0;if(e.intersectsLineSegment(sl.fromPoints(r.origin,r.cap.next,QT),r.cap.direction))return!0}const r=i?this.planes:this.planesWithoutFar;for(let t=0;t<e.lines.length;t++){const i=e.lines[t];if(sm(r,i.origin,i.endpoint,i.direction))return!0}return!1}toRenderBoundingExtentGlobal(e,t,i){qi(e,qT),qT[2]=i,nr(t,qT,HT,this.renderCoordsHelper.spatialReference),xi(WT,HT),Bs(ZT);for(const{x0:r,x1:s,y0:a,y1:n}of NT)for(let o=0;o<5;o++){const l=o/4;qT[0]=De(e[r],e[s],l),qT[1]=De(e[a],e[n],l),qT[2]=i,rr(qT,t,qT,this.renderCoordsHelper.spatialReference),it(qT,qT,WT),ia(ZT,qT)}Ye(this.extent[0].origin,ZT[0],ZT[1],ZT[2]),Ye(this.extent[1].origin,ZT[3],ZT[1],ZT[2]),Ye(this.extent[2].origin,ZT[3],ZT[4],ZT[2]),Ye(this.extent[3].origin,ZT[0],ZT[4],ZT[2]);for(let e=0;e<4;++e)it(this.extent[e].origin,this.extent[e].origin,HT)}toRenderBoundingExtentLocal(e,t){Ye(this.extent[0].origin,e[0],e[1],t),Ye(this.extent[1].origin,e[2],e[1],t),Ye(this.extent[2].origin,e[2],e[3],t),Ye(this.extent[3].origin,e[0],e[3],t)}toRenderBoundingExtent(e,t,i){switch(this.renderCoordsHelper.viewingMode){case 1:this.toRenderBoundingExtentGlobal(e,t,i);break;case 2:this.toRenderBoundingExtentLocal(e,i);break;default:te(this.renderCoordsHelper.viewingMode)}}isVisibleInFrustumGlobal(e){if(st(this.center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this.extent[t];if(st(i.direction,e.direction)<0)return!0}return!1}}const NT=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],qT=je(),HT=jr(),WT=jr(),ZT=js(),QT=sl.create();class YT{constructor(e){this.surfaceElevation=0,this.cache=new Map;const{renderCoordsHelper:t}=e;this.frustum=new kT({renderCoordsHelper:t}),this.extendedFrustum=new kT({renderCoordsHelper:t}),this.intersector=new BT({renderCoordsHelper:t}),this.renderCoordsHelper=t}begin(e,t){this.surfaceElevation=t,this.aboveGround=this.renderCoordsHelper.getAltitude(e.eye)>t,this.frustum.update(e),this.shortenFrustumFarPlane(this.frustum),this.updateExtendedFrustum(e)}end(){this.cache.clear()}calculate(e){if(this.allTilesInvisible)return 0;const t=1===this.renderCoordsHelper.viewingMode&&e.lij[0]>=$T&&e.lij[0]<XT,i=this.getOrCalculateSingleTileVisibility(e,!t);return 0!==i&&t?this.calculateAggregatedChildrenVisibility(e):i}shortenFrustumFarPlane(e){const t=kT.nearFarLineIndices,i=e.mutablePoints;for(const e of t){const[t,r]=e,s=i[t],a=i[r];at(tP,a,s),Ze(tP,tP,JT),Qe(i[r],s,tP)}e.updatePoints(i)}calculateAggregatedChildrenVisibility(e){let t=0;const i=this.cache.get(e.id);if(null!=i)return i;const r=sP.acquire();e.getChildren(r);for(const e of r){const i=this.calculate(e);if(0!==i&&(t=i,2===i))break}return sP.release(r),this.cache.set(e.id,t),t}getOrCalculateSingleTileVisibility(e,t){const i=this.cache.get(e.id);if(null!=i)return i;const r=this.calculateSingleTileVisibility(e);return t&&this.cache.set(e.id,r),r}calculateSingleTileVisibility(e){if(!this.aboveGround&&1===this.renderCoordsHelper.viewingMode&&e.lij[0]<KT){return 0===this.calculateSingleTileVisibilitySided(e,!1)?this.calculateSingleTileVisibilitySided(e,!0):void 0}return this.calculateSingleTileVisibilitySided(e,this.aboveGround)}calculateSingleTileVisibilitySided(e,t){this.intersector.update(e.extent,e.tilingScheme.spatialReference,this.surfaceElevation,t);const i=Kt(e.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,i)?this.intersector.isVisibleInFrustum(this.frustum,i,!0)?2:1:0}updateExtendedFrustum(e){this.extendedFrustum.update(e),this.shortenFrustumFarPlane(this.extendedFrustum);const t=this.renderCoordsHelper.worldUpAtPosition(e.eye,tP);this.aboveGround||rt(t,t);const i=Ie(-st(t,e.viewForward));if(this.allTilesInvisible=i>(Math.PI+e.fovY)/2,this.allTilesInvisible)return;if(this.hasExtendedFrustum=i>e.fovY/2,!this.hasExtendedFrustum)return;const r=this.extendedFrustumParameters(),s=this.extendedFrustum.mutablePoints;for(let e=0;e<4;e++){const t=r.pointIndices[e],i=s[t],a=this.renderCoordsHelper.getAltitude(i);if(r.needsAltitudeAdjustment(a)){switch(this.renderCoordsHelper.worldUpAtPosition(i,tP),t){case 4:case 7:case 0:case 3:Uo.projectVector(this.extendedFrustum.planes[0],tP,tP);break;case 5:case 6:case 1:case 2:Uo.projectVector(this.extendedFrustum.planes[1],tP,tP)}Ze(tP,tP,r.direction),this.renderCoordsHelper.intersectInfiniteManifold(ko.wrap(i,tP),r.zWithMargin,i)}}if(this.extendedFrustum.updatePoints(s),Uo.fromPoints(s[0],s[1],s[2],iP),Uo.fromPoints(s[1],s[2],s[3],rP),st(Uo.normal(iP),Uo.normal(rP))<0){const e=this.extendedFrustum.mutablePoints;this.aboveGround?[e[0],e[1]]=[e[1],e[0]]:[e[3],e[2]]=[e[2],e[3]],this.extendedFrustum.updatePoints(e)}}extendedFrustumParameters(){return this.aboveGround?this.extendedFrustumParametersAboveSurface():this.extendedFrustumParametersBelowSurface()}extendedFrustumParametersAboveSurface(){const e=this.surfaceElevation-eP;return{zWithMargin:e,pointIndices:kT.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}extendedFrustumParametersBelowSurface(){const e=this.surfaceElevation+eP;return{zWithMargin:e,pointIndices:kT.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const $T=2,XT=6,KT=12,JT=.95,eP=1,tP=je(),iP=Uo.create(),rP=Uo.create(),sP=new t(Array,(e=>{4!==e.length&&(e[0]=new UT,e[1]=new UT,e[2]=new UT,e[3]=new UT)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));class aP{constructor(e){this.camera=new rh,this.focusOnMap=[0,0],this.screenRect=Li(),this.tileSize=e.tileSize,this.maxVerticalScreenSize=e.maxVerticalScreenSize,this.renderCoordsHelper=e.renderCoordsHelper,this.tilingScheme=e.tilingScheme,this.visibility=new YT({renderCoordsHelper:e.renderCoordsHelper})}begin(e,t,i){this.camera.copyFrom(e),this.surfaceElevation=i,this.focusOnMap[0]=t.x,this.focusOnMap[1]=t.y,Hi(0,0,e.fullWidth,e.fullHeight,this.screenRect),this.visibility.begin(this.camera,i)}end(){this.visibility.end()}updateTile(e){e.measures.visibility=this.visibility.calculate(e),0!==e.measures.visibility&&this.updateScreenMeasure(e),this.updateDistanceMeasure(e)}updateDistanceMeasure(e){e.measures.distance=Wi(e.extent,this.focusOnMap)}updateScreenMeasure(e){const t=lP,i=1<<t,r=e.measures.screenRect;Fi(r);let s=0;const a=e.lij[0]+t,n=e.lij[1]<<t,o=e.lij[2]<<t,l=this.tileSizeWithBias(e),c=l*l;let h=!1;for(let t=0;t<i;t++){for(let l=0;l<i;l++){if(s+=this.computeScreenArea(e,a,n+t,o+l,r).area,h=s>c&&Ui(r)>this.maxVerticalScreenSize,h)break}if(h)break}e.measures.shouldSplit=s>c}tileSizeWithBias(e){return 1===e.measures.visibility?this.tileSize*cP:this.tileSize}computeScreenArea(e,t,i,r,s){const a=1===e.measures.visibility,n=hP.points;this.projectToScreen(t,i,r,a,n),Fi(nP);for(let e=0;e<4;e++)Bi(nP,n[e]);return ki(s,nP),Zi(nP,this.screenRect,oP),hP.screenOverlap=Qi(oP)/Qi(nP),hP.area=al.areaPoints2d(n[0],n[1],n[2])+al.areaPoints2d(n[0],n[2],n[3]),hP}projectToScreen(e,t,i,r,s){this.tilingScheme.ensureMaxLod(e),this.tilingScheme.getExtent(e,t,i,dP),this.toRenderCoords(dP,0,3,pP[0]),this.toRenderCoords(dP,2,3,pP[1]),this.toRenderCoords(dP,2,1,pP[2]),this.toRenderCoords(dP,0,1,pP[3]),r&&(this.projectToPlane(pP,this.camera.frustum.planes[4]),this.projectToPlane(pP,this.camera.frustum.planes[3]),this.projectToPlane(pP,this.camera.frustum.planes[2]));for(let e=0;e<4;e++)this.camera.projectToRenderScreen(pP[e],fP),this.camera.renderToScreen(fP,s[e])}projectToPlane(e,t){for(let i=0;i<4;i++)mP[i]=Uo.signedDistance(t,e[i]);const i=Math.max(mP[0],mP[1],mP[2],mP[3]);if(i>0){const r=Ze(uP,Uo.normal(t),-i);for(let t=0;t<4;t++)Qe(e[t],e[t],r)}}toRenderCoords(e,t,i,r){return uP[0]=e[t],uP[1]=e[i],uP[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(uP,this.tilingScheme.spatialReference,r),r}}const nP=Li(),oP=Li(),lP=2,cP=5,hP={points:[Vt(),Vt(),Vt(),Vt()],area:0,screenOverlap:0},dP=Li(),uP=je(),pP=[je(),je(),je(),je()],mP=[0,0,0,0],fP=Ut();function gP(e,t,i){if(null==e||u(i))return!1;let r=!0;return yP[0]=null!=e.xmin?e.xmin:0,yP[1]=null!=e.ymin?e.ymin:0,yP[2]=null!=e.zmin?e.zmin:0,r=r&&ar(yP,e.spatialReference,0,t,i,0,1),yP[0]=null!=e.xmax?e.xmax:0,yP[1]=null!=e.ymax?e.ymax:0,yP[2]=null!=e.zmax?e.zmax:0,r=r&&ar(yP,e.spatialReference,0,t,i,3,1),null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.zmin&&(t[2]=-1/0),null==e.xmax&&(t[3]=1/0),null==e.ymax&&(t[4]=1/0),null==e.zmax&&(t[5]=1/0),r}function vP(e,t,i){if(null==e)return!1;let r=!0;return yP[0]=null!=e.xmin?e.xmin:0,yP[1]=null!=e.ymin?e.ymin:0,yP[2]=null!=e.zmin?e.zmin:0,r=r&&ar(yP,e.spatialReference,0,yP,i,0,1),t[0]=yP[0],t[1]=yP[1],yP[0]=null!=e.xmax?e.xmax:0,yP[1]=null!=e.ymax?e.ymax:0,yP[2]=null!=e.zmax?e.zmax:0,r=r&&ar(yP,e.spatialReference,0,yP,i,0,1),t[2]=yP[0],t[3]=yP[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),r}const yP=je(),_P=d.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let xP=class extends T{constructor(e){super(e),this.tiles=new ae,this.tileSize=512,this._idToTile=new Map,this._handles=new $t,this._clients=new Set,this._dirty=!1,this._newTiles=new R}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;if(!e)return null;return e.clone()}set filterExtent(e){if(e&&!e.spatialReference.equals(this.viewState.spatialReference))return void _P.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(!this.filterExtent||!this.tilingScheme)return null;const e=Li();return vP(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add(this.watch(["tilingScheme","tileSize"],(()=>this._reset()),!0)),this._handles.add(hi(this,["tileSize","cameraOnSurface.location","tilingScheme","viewState.camera","focus.location"],(()=>this._setDirty()),!0)),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(xr.FEATURE_TILE_TREE,(e=>this._update(e)),(()=>this.updating)))}destroy(){this._frameWorker=_(this._frameWorker),this._handles=p(this._handles)}addClient(){const e=bP++;return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this._update(br))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}_update(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),h(this._frameWorker)&&(this._frameWorker.task=xr.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&h(this._frameWorker)&&(this._frameWorker.task=xr.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new aP({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize,maxVerticalScreenSize:CP}));const e=this.viewState.camera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map((e=>new UT(e[0],e[1],e[2],this.tilingScheme)))}_purgeHorizonTiles(e){e.sort(((e,t)=>{const i=e.measures.screenRect,r=t.measures.screenRect;return i[1]+i[3]-(r[1]+r[3])})),Fi(wP);for(let t=0;t<e.length;t++)if(ki(wP,e.data[t].measures.screenRect),Ui(wP)>CP)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!ji(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),0!==t.measures.visibility&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(e){for(const e of this.tiles.items)e.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this.sortTiles()}sortTiles(){this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?2===e.measures.visibility?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};e([S({constructOnly:!0})],xP.prototype,"scheduler",void 0),e([S({constructOnly:!0})],xP.prototype,"renderCoordsHelper",void 0),e([S({constructOnly:!0})],xP.prototype,"tilingSchemeOwner",void 0),e([S({constructOnly:!0})],xP.prototype,"cameraOnSurface",void 0),e([S({constructOnly:!0})],xP.prototype,"focus",void 0),e([S({constructOnly:!0})],xP.prototype,"viewState",void 0),e([S()],xP.prototype,"tiles",void 0),e([S()],xP.prototype,"tileSize",void 0),e([S({readOnly:!0,dependsOn:["tilingSchemeOwner.tilingScheme"]})],xP.prototype,"tilingScheme",null),e([S()],xP.prototype,"filterExtent",null),e([S({readOnly:!0,dependsOn:["filterExtent","tilingScheme"]})],xP.prototype,"filterExtentRect",null),e([S({readOnly:!0,dependsOn:["filterExtentRect"]})],xP.prototype,"rootTileIds",null),e([S({value:!1})],xP.prototype,"suspended",null),e([S({readOnly:!0})],xP.prototype,"updating",null),xP=e([re("esri.views.3d.layers.support.FeatureTileTree3D")],xP);let bP=0;const wP=Li(),CP=10;var SP=xP;let TP=class extends T{constructor(){super(),this._propertiesPool=new ld({camera:rh},this),this._lastSeenCameraProjectionValues=new rh,this.events=new se,this.mode=1,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new ld({camera:rh},this)}init(e,t){this._set("mode",e),this._set("spatialReference",t),this.camera=function(e,t){if(1===e){const e=Kt(t).radius;return new rh(ke(4*e,0,0),ke(e,0,0),ke(0,0,1))}return new rh(ke(0,0,100),ke(0,0,0),ke(0,1,0))}(this.mode,t),this._set("constraints",new Su({mode:this.mode}))}get animation(){return this.cameraController instanceof og&&h(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==RP&&RP.copyFrom(e),RP.markViewDirty(),RP.computeUp(this.mode),MP.camera=RP,this.events.emit("before-camera-change",MP);const t=this._get("camera");if(this.cameraProjectionChanged(this._lastSeenCameraProjectionValues,RP)&&(this._lastSeenCameraProjectionValues.copyFrom(RP),OP.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",OP)),(!t||!t.equals(RP))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(RP)),this._cameraChanged=!t||!t.almostEquals(RP),this._cameraChanged)){const e=P((()=>{this._cameraChanged=!1,e.remove()}))}}get isGlobal(){return!this.isLocal}get isLocal(){return 2===this.mode}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(e.watch("state",(t=>{t!==ag.Finished&&t!==ag.Stopped||(this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t))))}),!0),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=ag.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==ag.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this.processUpdateQueue()}processUpdateQueue(){if(0===this.updateQueue.length||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();RP.copyFrom(this._get("camera")),e(RP),this.camera=RP,this.processingUpdates=!1,this.processUpdateQueue()}cameraProjectionChanged(e,t){return e.fov!==t.fov||(e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||(e.padding[0]!==t.padding[0]||e.padding[1]!==t.padding[1]||e.padding[2]!==t.padding[2]||e.padding[3]!==t.padding[3]))}};e([S({readOnly:!0,type:ln,dependsOn:["cameraController"]})],TP.prototype,"animation",null),e([S({type:rh})],TP.prototype,"camera",null),e([S({readOnly:!0})],TP.prototype,"constraints",void 0),e([S({readOnly:!0})],TP.prototype,"events",void 0),e([S({readOnly:!0,dependsOn:["isLocal"]})],TP.prototype,"isGlobal",null),e([S({readOnly:!0,dependsOn:["mode"]})],TP.prototype,"isLocal",null),e([S({readOnly:!0})],TP.prototype,"mode",void 0),e([S({constructOnly:!0})],TP.prototype,"spatialReference",void 0),e([S({readOnly:!0,dependsOn:["cameraController"]})],TP.prototype,"navigating",null),e([S({readOnly:!0,dependsOn:["navigating","_cameraChanged"]})],TP.prototype,"stationary",null),e([S()],TP.prototype,"_cameraChanged",void 0),e([S()],TP.prototype,"cameraController",null),TP=e([re("esri.views.3d.state.ViewState")],TP);var PP=TP;const RP=new rh;const MP={camera:null},OP={camera:null};class DP{constructor(e,t){this.elevationProvider=e,this._referenceEllipsoid=Kt(t),this.unitInMeters=Jt(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,r,s){s||(s={near:0,far:0});let a=e[2]*this.unitInMeters;const n=a,o=a-r,l=this.elevationProvider?this.elevationProvider.elevationBounds:null;l&&(a=o>=0?n-this.unitInMeters*l.min:this.unitInMeters*l.max-n);const c={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},h=Math.max(c.x,c.y,c.z);at(UP,t,e),zP[0]=UP[0]>0?i.xmax:i.xmin,zP[1]=UP[1]>0?i.ymax:i.ymin,zP[2]=UP[2]>0?h/2:-h/2,at(zP,zP,e),nt(UP,UP);const d=1.1*st(zP,UP)*this.unitInMeters,u=Math.sqrt(a*(a+2*this._referenceEllipsoid.radius)),p=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),m=p*FP*this.unitInMeters,f=p*VP*this.unitInMeters;let g=Re((a-f)/(m-f),0,1);g*=g*g;let v=De(u,d,g);return v*=Math.max(Math.log(Math.abs(o)),1),v=Math.min(v,Math.max(34064e4,h)),v/=this.unitInMeters,EP(v,IP,this.unitInMeters,s)}}class AP{constructor(e){this._referenceEllipsoid=Kt(e)}compute(e,t,i,r,s){s||(s={near:0,far:0});const a=$e(e)-this._referenceEllipsoid.radius,n=this._referenceEllipsoid.radius+Math.min(0,r),o=Math.abs(a-r),l=Math.max(o,Math.abs(a));return EP(1.2*Math.sqrt(l*(l+2*n)),Re(2e4-(Math.log(l)-7.983)/9.011*19e3,1e3,2e4),1,s)}}function EP(e,t,i,r){const s=LP/i;return e/t>s?(r.far=e,r.near=r.far/t):(r.near=s,r.far=r.near*t),r}const IP=2e4,LP=2,FP=.001,VP=1e-4,zP=je(),UP=je();let kP=class extends T{constructor(e){super(e),this.handles=new $t}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e))))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;_m(this.view,t,e.extent,e.spatialReference)&&this.applyToCurrentCamera()}applyToCurrentCamera(){this.view.state.updateCamera((e=>{Mm(this.view,e,1)}))}};e([S({constructOnly:!0})],kP.prototype,"view",void 0),kP=e([re("esri.views.3d.state.ElevationCollisionConstraint")],kP);var jP=kP;let GP=class extends T{constructor(e){var t,i,r;super(e),this._handles=new $t,this.nearFarHeuristic=(t=e.view.state.mode,i=e.view.basemapTerrain,r=e.view.renderCoordsHelper.spatialReference,1===t?new AP(r):new DP(i,r))}initialize(){this._handles.add([this.view.watch(["constraints.clipDistance.near","constraints.clipDistance.far"],(()=>this._clipDistanceNearFarChanged())),this.view.watch("constraints.clipDistance.mode",(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(e=>this._updateCameraNearFar(e.camera))),this.view.watch("dataExtent",(()=>this._updateNearFar()),!0),this.view.watch(["constraints.altitude.min","constraints.altitude.max"],(()=>this._updateAltitude()),!0),this.view.watch("constraints.tilt.max",(()=>this._updateTiltMax()),!0),this.view.watch("constraints.tilt.mode",(()=>this._updateTilt()),!0),this.view.watch("state.camera",(()=>this._updateTiltAutoMax()),!0),this.view.watch(["map.ground.navigationConstraint.type","constraints.collision.enabled"],(()=>this._updateCollision()),!0)]),this.view.state.isLocal&&this._handles.add(hi(this.view,"dataExtent",(e=>this._updateLocalSurfaceDistance(e)))),this._updateNearFar(),2!==this.view.state.mode&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new jP({view:this.view}))}destroy(){this._handles=p(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints&&this.view.constraints.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>(this._updateCameraNearFarManual(t,e),!0)))}_updateNearFar(){this.view.state.updateCamera((e=>(this._updateCameraNearFar(e),!0)))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.dataExtent,xm(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){const e=this.view.map&&this.view.map.ground&&this.view.map.ground.navigationConstraint,t=this.view.constraints&&this.view.constraints.collision.enabled,i=e?"stay-above"===e.type:t,r=this.view.state.constraints.collision;if(i!==r.enabled){r.enabled=i,i&&this._reapplyConstraints(8);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&2!==this.view.state.mode?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Me(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(Oe(i))}}_updateLocalSurfaceDistance(e){let t=Math.max(e.width,e.height);if(t<=0)return;e.hasZ&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=15){this.view.state.updateCamera((t=>wf(this.view,t,{selection:e,interactionType:0,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:0})))}};e([S({constructOnly:!0})],GP.prototype,"view",void 0),e([S({readOnly:!0})],GP.prototype,"surfaceCollisionConstraint",void 0),GP=e([re("esri.views.3d.state.ConstraintsManager")],GP);var BP=GP;let NP=class extends ng{constructor(e){super(e),this.handles=new $t}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=ag.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this.handleElevationChangeEvent(e)))),this.applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}handleElevationChangeEvent(e){_m(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this.applyCorrection()}applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),Mm(this.view,e,1)||this.constraintEnabled||(this.state=ag.Stopped)}))}};e([S({constructOnly:!0})],NP.prototype,"view",void 0),e([S({constructOnly:!0})],NP.prototype,"desiredCamera",null),NP=e([re("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],NP);function qP(e){return 360-Mt.normalize(e)}function HP(e){return Mt.normalize(360-e)}function WP(e){return h(e)&&e.resolver&&e.resolver.reject(),null}function ZP(e,t,i,r=null){if(!t)return WP(r);const s=e.spatialReference||ue.WGS84;if(h(t.camera)){const e=t.get("camera.position.spatialReference");if(!Se(e,s))return WP(r);const i=t.camera.clone();return e.equals(s)||(i.position=Te(i.position,s)),function(e,t){return h(e)&&e.resolver&&e.resolver.resolve(t),t}(r,i)}if(u(t.targetGeometry))return WP(r);const a=t.get("targetGeometry.spatialReference");if(a&&!Se(a,s))return WP(r);const n=oy(e,e.state.camera);let o=1;if(null!=t.rotation&&(n.heading=qP(t.rotation),o=0),null!=i&&(n.tilt=i),"point"===t.targetGeometry.type){const i=t.targetGeometry;let s;const a=t.targetGeometry.clone();return s=null!=t.scale?ly(e,t.scale,i.latitude):e.state.camera.distance,dy(e,a,s,n,o,r)}return fy(e,t.targetGeometry.extent,n.heading,n.tilt,o,r)}async function QP(e,t,i){const r=function(e,t){if(!t||!e.spatialReference)return null;const i={target:null};if("declaredClass"in t||Array.isArray(t))i.target=t;else{for(const e in t)i[e]=t[e];t.center&&!i.target&&(i.target=t.center)}return i}(e,t);if(!r)throw new ee("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new Dt({fov:e.camera.fov}),a=new li({camera:s});if(r.target instanceof li){return iR(await async function(e,t,i,r,s){if(h(t.camera))return eR(e,t.camera,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=h(t.targetGeometry)?t.targetGeometry.clone():null,s.camera=null,null!=i.heading?s.rotation=HP(i.heading):null!=i.rotation&&(s.rotation=i.rotation);const a=YP(e,i);null!=a&&(s.scale=a);const n=new by(r);return ZP(e,s,i.tilt,n),s.camera=await n.resolver.promise,s}(e,r.target,r,i,a))}if(r.target instanceof Dt)return iR(eR(e,r.target,a));const n=null!=r.scale||null!=r.zoom;if(r.target instanceof Pe){const t=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return iR(n||t?await tR(e,r,r.target.center,s,i,a):await async function(e,t,i,r,s,a){a.targetGeometry=i.clone();const n=bm(e);oy(e,n,r);const o=$P(r,t)?0:1,l=new by(s);return fy(e,i,r.heading,r.tilt,o,l),a.camera=await l.resolver.promise,a}(e,r,r.target,s,i,a))}const o={boundingBox:Bs(),hasZ:!1,screenSpaceObjects:[]},l=n?function(e,t){return function(e,t){return e.spatialReference?da(t,e.spatialReference):void 0}(e,YP(e,t))}(e,r):void 0;if(await JP(e,r.target,l,o),isFinite(o.boundingBox[0])){let t;if(Ns(o.boundingBox,rR),uR.x=rR[0],uR.y=rR[1],uR.z=rR[2],uR.spatialReference=e.spatialReference,isFinite(uR.z)&&o.hasZ?t=Gs(o.boundingBox):(uR.z=void 0,t=Yi(Xs(o.boundingBox,oR))),n||t)return iR(await tR(e,r,uR,s,i,a));const l=function(e,t){const i=.66;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let e=0;e<t.length;e++){const i=t[e].screenSpaceBoundingRect;r=Math.max(r,Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2]),Math.abs(i[3]))}const s=Math.min(e.width,e.height);return i-r/s*2}(e,o.screenSpaceObjects);return iR(await async function(e,t,i,r,s,a,n,o){o.targetGeometry=i.clone();const l=bm(e),c=function(e,t,i,r,s){let a=0;i.hasZ?a=i.z:e.basemapTerrain&&(a=Aa(e.elevationProvider,i));Ye(rR,i.x,i.y,a),nr(e.spatialReference,rR,sR,e.renderSpatialReference),Qr(aR,sR),Wr(aR,aR),Bs(nR);const n=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let t=0;t<n.length;t++){const i=n[t];let s=r[i[2]];isFinite(s)||(s=a),Ye(rR,r[i[0]],r[i[1]],s),rr(rR,e.spatialReference,rR,e.renderSpatialReference),ia(nR,lt(rR,rR,aR))}const o=oa(nR),l=na(nR),c=la(nR),h=1/Math.tan(t.fovX/2),d=1/Math.tan(t.fovY/2),u=.5*Math.sqrt(o*o+c*c)*Math.max(d,h)+.5*l,p=.5*l*d+.5*Math.max(o,c);return Math.max(u,p)/s}(e,l,i,r,s);oy(e,l,a);const h=$P(a,t)?0:1;o.scale=cy(e,c,o.targetGeometry.latitude);const d=new by(n);return hy(e,o.targetGeometry,o.scale,a,h,d),o.camera=await d.resolver.promise,o}(e,r,uR,o.boundingBox,l,s,i,a))}return r.position?iR(function(e,t,i,r){const s=bm(e);return Xe(lR,s.viewForward),uy(e,s.eye,lR,s.up,dR),i.position=new _e(t.position),i.heading=null!=t.heading?t.heading:dR.heading,i.tilt=null!=t.tilt?t.tilt:dR.tilt,XP(e,null,i,r)}(e,r,s,a)):iR(await async function(e,t,i,r,s){const a=bm(e),n=sr(a.center,e.renderSpatialReference,e.spatialReference,uR);return tR(e,t,n,i,r,s)}(e,r,s,i,a))}function YP(e,t){return null==t.scale&&null!=t.zoom?_y(e,t.zoom):t.scale}function $P(e,t){let i=!1;return null!=t.heading?(e.heading=t.heading,i=!0):null!=t.rotation&&(e.heading=qP(t.rotation),i=!0),null!=t.tilt&&(e.tilt=t.tilt,i=!0),null!=t.fov&&(e.fov=t.fov),i}function XP(e,t,i,r){const s=e.spatialReference||ue.WGS84;return t=h(t)?t:ay(e,i),r.targetGeometry=sr(t.center,e.renderSpatialReference,s),r.scale=xy(e,t),r.rotation=HP(i.heading),r.camera=i,r}function KP(e,t,i){if(!t)return;if(!Se(t.spatialReference,e.spatialReference))throw new ee("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const r=[];if(!t.hasZ&&e.basemapTerrain){let i;switch(t.type){case"point":i=t;break;case"multipoint":case"polyline":case"mesh":i=t.extent.center;break;case"extent":i=t.center;break;case"polygon":i=t.centroid}i&&Se(i,e.basemapTerrain.spatialReference)?rR[2]=Aa(e.elevationProvider,i)||0:rR[2]=0}(0,pR[t.type])(t,(e=>{r.push(e[0],e[1],e[2])}),rR);const s=r.length/3;if(0===s)return;const a=new Array(r.length);if(ar(r,t.spatialReference,0,a,e.spatialReference,0,s)){t.hasZ&&(i.hasZ=!0);for(let e=0;e<a.length;e+=3)t.hasZ?(rR[0]=a[e+0],rR[1]=a[e+1],rR[2]=a[e+2]):(rR[0]=a[e+0],rR[1]=a[e+1]),ia(i.boundingBox,rR)}}async function JP(e,t,i,r){if(Array.isArray(t)&&2===t.length){const i=t[0],s=t[1];if("number"==typeof i&&"number"==typeof s)return uR.x=i,uR.y=s,uR.z=void 0,uR.spatialReference=e.spatialReference.isGeographic?e.spatialReference:ue.WGS84,void KP(e,uR,r)}t&&"function"==typeof t.map?await Y(t.map((t=>JP(e,t,i,r)))):t instanceof ye?KP(e,t,r):t instanceof Qt&&await async function(e,t,i,r){const s=await oe(e.whenViewForGraphic(t));if(!1===s.ok||u(s.value)||!("whenGraphicBounds"in s.value))return void KP(e,t.geometry,r);const a=s.value,n=await oe(a.whenGraphicBounds(t,{minDemResolution:i}));if(!1===n.ok)return void KP(e,t.geometry,r);const{screenSpaceObjects:o,boundingBox:l}=n.value;Ys(r.boundingBox,l),o&&o.forEach((e=>{r.screenSpaceObjects.push(e)})),isFinite(l[2])&&(r.hasZ=!0)}(e,t,i,r)}function eR(e,t,i){const r=e.spatialReference,s=t.position.spatialReference;return Se(s,r)?((t=t.clone()).fov=e.camera.fov,s.equals(r)||(t.position=Te(t.position,r)),XP(e,null,t,i)):null}async function tR(e,t,i,r,s,a){if(u(i))throw new ee("createfromcenter","invalid point");a.targetGeometry=i.clone();const n=bm(e);if(t.position)return function(e,t,i,r,s,a){const n=e.renderSpatialReference;return ir(i.position,cR,n),ir(t,hR,n),a.targetGeometry=new _e(t),s.position=new _e(i.position),at(lR,hR,cR),uy(e,cR,lR,r.up,s),a.scale=cy(e,Ke(cR,hR),a.targetGeometry.latitude),a.rotation=HP(s.heading),a.camera=s,a}(e,a.targetGeometry,t,n,r,a);if(t.zoomFactor){const r=n.distance/t.zoomFactor,s=Ze(rR,n.viewForward,-r);Qe(n.eye,n.center,s),n.markViewDirty(),a.scale=cy(e,r,i.latitude)}oy(e,n,r);const o=$P(r,t)?0:1;if(!t.zoomFactor){a.scale=YP(e,t),null==a.scale&&(ir(i,rR,e.renderSpatialReference),nl.intersectsPoint(n.frustum.planes,rR)?a.scale=cy(e,Ke(n.eye,rR),i.latitude):a.scale=xy(e,n));const l=new by(s);hy(e,a.targetGeometry,a.scale,r,o,l),a.camera=await l.resolver.promise}return a}function iR(e){return e&&h(e.camera)&&(e.rotation=HP(e.camera.heading)),e}const rR=je(),sR=jr(),aR=Br(),nR=js(),oR=Li(),lR=je(),cR=je(),hR=je(),dR={heading:0,tilt:0},uR=new _e,pR={point(e,t,i){i[0]=e.x,i[1]=e.y,e.hasZ&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let s=0;s<e.rings.length;s++){const a=e.rings[s];for(let e=0;e<a.length;e++)i[0]=a[e][0],i[1]=a[e][1],r&&(i[2]=a[e][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let s=0;s<e.paths.length;s++){const a=e.paths[s];for(let e=0;e<a.length;e++)i[0]=a[e][0],i[1]=a[e][1],r&&(i[2]=a[e][2]),t(i)}},multipoint(e,t,i){const r=e.points,s=e.hasZ;for(let e=0;e<r.length;e++)i[0]=r[e][0],i[1]=r[e][1],s&&(i[2]=r[e][2]),t(i)},extent(e,t,i){e.hasZ?(t(Ye(i,e.xmin,e.ymin,e.zmin)),t(Ye(i,e.xmax,e.ymin,e.zmin)),t(Ye(i,e.xmin,e.ymax,e.zmin)),t(Ye(i,e.xmax,e.ymax,e.zmin)),t(Ye(i,e.xmin,e.ymin,e.zmax)),t(Ye(i,e.xmax,e.ymin,e.zmax)),t(Ye(i,e.xmin,e.ymax,e.zmax)),t(Ye(i,e.xmax,e.ymax,e.zmax))):(t(Ye(i,e.xmin,e.ymin,i[2])),t(Ye(i,e.xmax,e.ymin,i[2])),t(Ye(i,e.xmin,e.ymax,i[2])),t(Ye(i,e.xmax,e.ymax,i[2])))},mesh(e,t,i){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let e=0;e<r.length;e+=3)t(Ye(i,r[e+0],r[e+1],r[e+2]))}};class mR{constructor(e,t,i){this.target=e,this.options=t,this.view=i,this.state="pending",this.abortController=null,this.animationController=null,this.promise=W(((e,t)=>{this.resolveCallback=e,this.rejectCallback=t;const i=z();h(this.options.signal)&&Q(this.options.signal,(()=>{this.abort()})),this.abortController=i,this.waitForReady()}))}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}resolve(e){return this.state="finished",this.resolveCallback(e)}reject(e){return this.state="finished",this.rejectCallback(e)}goTo(e,t){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":t.animate&&this.options.animate?this.reject(new ee("AbortError")):this.abort()}return new mR(e,t,this.view)}waitForReady(){this.state="wait-for-ready",this.view.stateManager.view.ready?this.createViewPoint():ui(this.view.stateManager.view,"ready",this.abortController.signal).then((()=>{this.createViewPoint()}),(e=>{this.reject(e)}))}createViewPoint(){"finished"!==this.state&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this.getAnimationController():null,QP(this.view.stateManager.view,this.target,this.abortController.signal).then((e=>{if("finished"===this.state)return;const t=this.getCameraFromViewpoint(e);if(!u(t))if(this.options.animate){if(u(this.animationController))return;this.startAnimation(t,this.animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}),(e=>{this.reject(e)})))}internalAnimateOptions(e){const t={};return e&&(null!=e.speedFactor&&(t.speedFactor=e.speedFactor),null!=e.duration&&(t.duration=e.duration/1e3),null!=e.maxDuration&&(t.maxDuration=e.maxDuration/1e3),null!=e.easing&&("string"==typeof e.easing?t.easing=bf[e.easing]:t.easing=e.easing)),t}getCameraFromViewpoint(e){const t=!!(this.target instanceof li&&this.target.camera||this.target instanceof Dt),i=e.camera;if(u(i))return null;if(!this.view.stateManager.isCompatible(i)){const e=i.position,t=e&&e.spatialReference,r=t?t.wkid:"none",s=this.view.stateManager.view.spatialReference.wkid;return this.reject(new ee("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${r}, view: ${s})`,{camera:i})),null}const r=ay(this.view.stateManager.view,i);return r?{viewpoint:e,camera:r,isFullySpecified:t}:(this.reject(new ee("GotoAnimation:invalid-camera","Resulting camera is invalid")),null)}startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(u(i))return void this.reject(new ee("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.active||u(t.viewAnimation)||t.viewAnimation.target!==e.viewpoint||this.view.stateManager.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new NP({view:this.view.stateManager.view,desiredCamera:e.camera}),Mm(this.view.stateManager.view,e.camera,1)):wf(this.view.stateManager.view,e.camera),t.begin(e.camera,this.internalAnimateOptions(this.options));const s=e=>{if(!u(this.view.stateManager.view.state))switch(t.state){case ag.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case ag.Ready:case ag.Rejected:case ag.Running:case ag.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(e)}}};i.when((()=>{const i=this.view.stateManager.view.state.cameraController;r&&(i&&i.active?i instanceof lg&&h(i.viewAnimation)&&i.viewAnimation.target===e.viewpoint&&(this.view.stateManager.view.state.cameraController=r):h(t.viewAnimation)&&t.viewAnimation.target===e.viewpoint&&"finished"===t.state&&(this.view.stateManager.view.state.cameraController=r))}),(e=>s(e))),t.asyncResult={resolve:()=>s(),reject:e=>s(e)}}getAnimationController(){let e,t=null;const i=this.view.stateManager.view.state.cameraController;return i instanceof lg&&(i.updateStateFromViewAnimation(),i.active&&(e=i,t=e.viewAnimation)),null!=e||(e=new lg({view:this.view.stateManager.view,mode:"animation"}),t=e.viewAnimation,this.view.stateManager.view.state.switchCameraController(e))?e:(h(t)&&t.stop(),this.reject(new ee("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}abort(){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(B());break;case"wait-for-animation-finish":h(this.animationController)&&this.view.stateManager.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(B())}}}const fR=d.getLogger("esri.views.3d.state.ViewStateManager");let gR=class extends T{constructor(e){super(e),this.propertiesPool=new ld({frustum:kT},this),this.handles=new $t,this.cameraSetByUser=!1,this.internalSetOrder=[],this.gotoOperation=null,this.ready=!1,this.updateDevicePixelRatio=null}get camera(){if(!this.ready)return this._get("camera");const e=oy(this.view,this.view.state.camera),t=this._get("camera");return e&&t&&e.equals(t)?t:e}set camera(e){this.updatePropertyBeforeReady("camera",e)||this.setStateCamera(ay(this.view,e),{applyConstraints:!1})||fR.error("#camera=","Invalid camera",e)}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this.updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this.centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.update():fR.error("#center=","Invalid center",e):fR.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):fR.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=function(e,t,i){const r=e.renderSpatialReference,s=ct(t.eye,i),a=sr(i,r,ry(e));if(u(a))return null;const n=2*s*Math.tan(t.fovX/2)*1,o=2*s*Math.tan(t.fovY/2)*1;return"global"===e.viewingMode?Zv(e,a,n,o):Vv(e,a,n,o)}(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return h(t)?t:this._get("extent")}set extent(e){this.updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this.extentToCamera(e),{applyConstraints:!0})||fR.error("#extent=","Invalid extent",e):fR.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):fR.error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(!this.ready)return this._get("scale");const e=this.view.pointsOfInterest.centerOnContent;return cy(this.view,e.distance,e.location.latitude)}set scale(e){this.updatePropertyBeforeReady("scale",e)||this.setStateCamera(this.scaleToCamera(e),{applyConstraints:!0})||fR.error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[0]/i),a=Math.round(t[1]/i),n=Math.round(t[2]/i),o=Math.round(t[3]/i);return null!=r&&r.top===s&&r.right===a&&r.bottom===n&&r.left===o?r:{top:s,right:a,bottom:n,left:o}}set padding(e){this.updatePropertyBeforeReady("padding",e)||(this.paddingToArray(e,this.view.state.camera.pixelRatio,CR),this.view.state.updateCamera((e=>e.padding=CR)))}paddingToArray(e,t,i){e?bs(i,e.top||0,e.right||0,e.bottom||0,e.left||0):bs(i,0,0,0,0);for(let e=0;e<4;e++)i[e]=Math.round(i[e]*t)}get screenCenter(){const e=this.padding;return Gt((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?function(e,t,i=null){return u(i)&&(i=new li),XP(e,null,t.clone(),i)}(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this.updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this.viewpointToCamera(e),{applyConstraints:!e.camera})||fR.error("#viewpoint=","Invalid viewpoint",e);else{const t=h(e.camera)?e.camera.position:e.targetGeometry,i=h(t)&&t.spatialReference;fR.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else fR.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?function(e,t){const i=e.basemapTerrain&&e.basemapTerrain.tilingScheme;if(i)return i.levelAtScale(t);Yv.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}(this.view,this.scale):this._get("zoom")}set zoom(e){this.updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this.zoomToCamera(e),{applyConstraints:!0})||fR.error("#zoom=","Invalid zoom",e)}initialize(){this.handles.add([this.view.state.watch("camera",(e=>this.cameraChangedSync(e)),!0),ci(this.view,"state.events","before-camera-change",(e=>this.updateElevation(e.camera)))]),pi(this.view.state,"camera",(e=>this.updateElevation(e)),!0),this.handles.add(O({prepare:()=>this.prepareFrame()})),this.handles.add(this.view.state.watch("cameraController",(()=>{this.cameraSetByUser=!0,this.handles.remove(SR)}))),this.handles.add(ci(this.view,"state.events","camera-projection-changed",(()=>this.notifyChange("scale"))))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new BP({view:this.view}),this.prepareFrame();const e=this.getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this.setInitialView(e):2===this.view.state.mode&&this.handles.add(ui(this.view.basemapTerrain,"ready",(()=>{this.handles.remove(SR),this.setInitialView(this.view.groundExtent)})),SR)}}deinit(){this.cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.internalSetOrder.length=0,this.cameraSetByUser=!1,this.handles.remove(SR),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(e,t){const i={animate:!0,...t};return this.gotoOperation=h(this.gotoOperation)?this.gotoOperation.goTo(e,i):new mR(e,i,this.view),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(bm(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera((t=>{i.stepController(e,t)})),i.steppingFinished&&i.finishController())}cancelGoToOperation(){h(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of _R){const s=e.has(i),a=this._isOverridden(i);!s&&a&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||a)&&r.forEach((t=>e.add(t)))}return t}setInitialView(e){if(!e||this.cameraSetByUser)return;if(e instanceof Dt)return void this.setStateCamera(ay(this.view,e),{applyConstraints:!1});if(e instanceof li){if(e.targetGeometry instanceof Pe){const t=fy(this.view,e.targetGeometry,0,.5,0);return void(h(t)&&this.setStateCamera(ay(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this.viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=fy(this.view,e,0,.5,0);h(t)&&this.setStateCamera(ay(this.view,t),{applyConstraints:!0})}updatePropertyBeforeReady(e,t){if(!this.ready){this._override(e,t);const i=this.internalSetOrder.indexOf(e);return-1!==i&&(this.internalSetOrder=this.internalSetOrder.splice(i,1)),t&&(this.internalSetOrder.push(e),-1!==yR.indexOf(e)&&this._override("hasInitialView",!0)),!0}return!1}isCompatible(e){return!u(e)&&(e instanceof li?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof Dt?this.isCompatible(e.position):e.spatialReference&&Se(e.spatialReference,this.view.spatialReference))}getPreservingHeadingTilt(e=xR){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}centerPointAtDistanceToCamera(e,t,i=wR){const{heading:r,tilt:s}=this.getPreservingHeadingTilt(),a=py(this.view,r,s,e,t,1);return u(a)?null:(i.copyFrom(this.view.state.camera),i.eye=a.eye,i.center=a.center,i.up=a.up,i)}centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.update();const i=t.distance;return this.centerPointAtDistanceToCamera(e,i)}extentToCamera(e){const{heading:t,tilt:i}=this.getPreservingHeadingTilt(),r=fy(this.view,e,t,i,1,bR);return h(r)?ay(this.view,r):null}scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.update();const i=t.renderLocation,r=t.location.latitude,s=ly(this.view,e,r);return this.centerPointAtDistanceToCamera(i,s)}zoomToCamera(e){return this.scaleToCamera(_y(this.view,e))}viewpointToCamera(e){const t=ZP(this.view,e);return h(t)?ay(this.view,t):null}setStateCamera(e,t){return!(u(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this.cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&wf(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new NP({view:this.view,desiredCamera:e})),!0)}prepareFrame(){const{container:e,canvas:t}=this.view;if(!e||!t)return;h(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();const i=this.view.pixelRatio,r=Math.round(e.clientWidth*i),s=Math.round(e.clientHeight*i);if(0!==r&&0!==s&&(t.width===r&&t.height===s||(t.width=r,t.height=s),this.view.state)){const e=this.view.state.camera;e.fullWidth===r&&e.fullHeight===s&&e.pixelRatio===i||(wR.copyFrom(e),wR.pixelRatio!==i&&(this.paddingToArray(this.padding,i,CR),wR.padding=CR),wR.fullWidth=r,wR.fullHeight=s,wR.pixelRatio=i,this.view.state.camera=wR)}}updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?xm(this.view,e.eye):0;e.relativeElevation=i-r}cameraChangedSync(e){e&&this.view._stage&&this.view._stage.setCamera(e)}};e([S({type:Dt,dependsOn:["view.state.camera","ready"],autoTracked:!1})],gR.prototype,"camera",null),e([S({type:_e,dependsOn:["view.pointsOfInterest.centerOnContent.location","ready"]})],gR.prototype,"center",null),e([S({type:Pe,dependsOn:["view.state.camera","ready","view.pointsOfInterest.centerOnContent.location"]})],gR.prototype,"extent",null),e([S({readOnly:!0,dependsOn:["view.state.camera","ready"]})],gR.prototype,"frustum",null),e([S({readOnly:!0,dependsOn:["view.map.initialViewProperties?.viewpoint"]})],gR.prototype,"hasInitialView",null),e([S({readOnly:!0,type:Boolean})],gR.prototype,"ready",void 0),e([S({dependsOn:["view.pointsOfInterest.centerOnContent.distance","ready"],type:Number})],gR.prototype,"scale",null),e([S({dependsOn:["view.state.camera","ready"]})],gR.prototype,"padding",null),e([S({readOnly:!0,dependsOn:["view.width","view.height","padding"]})],gR.prototype,"screenCenter",null),e([S({constructOnly:!0})],gR.prototype,"view",void 0),e([S({type:li,dependsOn:["camera","ready"]})],gR.prototype,"viewpoint",null),e([S({type:Number,dependsOn:["scale"]})],gR.prototype,"zoom",null),e([S({constructOnly:!0})],gR.prototype,"updateDevicePixelRatio",void 0),gR=e([re("esri.views.3d.state.ViewStateManager")],gR);var vR=gR;const yR=["camera","viewpoint","extent","scale","center","zoom"],_R=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],xR={heading:0,tilt:0},bR=new Dt,wR=new rh,CR=Tr(),SR="pending-initial-view";class TR{constructor(e,t,i){this.viewingMode=e,this.layerProvider=t,this.view=i,this.externalIntersectionHandlers=new R,this.tolerance=ih.DEFAULT_TOLERANCE,this.tmpRay=ol(),this.validateHUDIntersector=new ih(this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(e,t){return this.intersectRay(this.getPickRay(e,this.tmpRay),MR(this.viewingMode),t)}intersectScreenFreePointFallback(e,t){return this.intersectRayFreePointFallback(this.getPickRay(e,this.tmpRay),t)}intersectRayFreePointFallback(e,t){return this.intersectRay(e,MR(this.viewingMode),t)||this.intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(AR,i,r),AR[0]+=.0466,AR[1]-=.0123,ll(e,AR,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this.getPickRay(e,this.tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const r=this.getPickRay(e,this.tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const r=t.results.min;!!this.view.basemapTerrain&&this.view.basemapTerrain.isOpaque()||r.hasIntersectionPoint&&"TerrainRenderer"!==r.intersector||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(e=ih.DEFAULT_TOLERANCE){this.tolerance=e}addIntersectionHandler(e){this.externalIntersectionHandlers.push(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0))}removeIntersectionHandler(e){this.externalIntersectionHandlers.removeUnordered(e),this.externalIntersectionHandlers.sort(((e,t)=>"Terrain"===e.type?1:"Terrain"===t.type?-1:0))}getPickRay(e,t=ol()){const i=this.view.state.camera;return cl(i,e,t)}intersectRayFreePointLocal(e,t){if(2!==this.viewingMode||u(e))return!1;const i=this.view.dataExtent,r={x:i.xmax-i.xmin,y:i.ymax-i.ymin,z:8*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},s=Math.max(r.x,r.y,r.z);if(0===s)return Qe(t,e.origin,nt(No.get(),e.direction)),!0;const a=this.view.state.camera,n=Math.max(0,i.xmin-a.eye[0],a.eye[0]-i.xmax),o=Math.max(0,i.ymin-a.eye[1],a.eye[1]-i.ymax),l=Math.sqrt(n*n+o*o),c=Math.abs(a.relativeElevation)+Number.MIN_VALUE,h=Math.pow(Math.max(0,Math.log(s/c)),2);let d=s/Math.max(1,h);d=Math.max(d,Math.min(l,s));const p=Ze(No.get(),e.direction,d/$e(e.direction));return Qe(t,e.origin,p),!0}intersectElevationFromScreen(e,t,i=0){return this.intersectElevation(this.getPickRay(e,this.tmpRay),t,i)}intersectElevation(e,t,i=0){if(u(e))return null;const r=h(t)?t.mode:"absolute-height",s=h(t)?f(t.offset,0):0,a="on-the-ground"!==r?s+i:0,n=a/this.view.renderCoordsHelper.unitInMeters;if("absolute-height"===r){if(this.view.renderCoordsHelper.intersectManifold(e,a,DR)){const e=this.view.computeMapPointFromVec3d(DR);return e.z-=s,e}return null}const o=this.view.state.camera,l=Bt(No.get());o.projectToRenderScreen(e.origin,l);const c=this.prepareFilters(null,OR),d=this.view.slicePlane,p=h(d)?Jc(d):null,m=new ih(this.viewingMode);m.options.store=0,m.options.verticalOffset=n;const g=e.origin,v=Qe(No.get(),g,e.direction);switch(m.reset(g,v),m.point=l,m.camera=o,m.filterPredicate=null,r){case"relative-to-scene":{const e=e=>e.metadata&&e.metadata.isElevationSource;m.intersect(c.layers,l,o,this.tolerance,null,e),this.externalIntersectionHandlers.forAll((e=>{if("I3S"===e.type||"Terrain"===e.type){const t=e.slicePlane?p:null;e.intersect(m,t,m.rayBeginPoint,m.rayEndPoint,l)}}))}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlane?p:null;e.intersect(m,t,m.rayBeginPoint,m.rayEndPoint,l)}}))}if(m.results.min.getIntersectionPoint(DR)){const e=this.view.computeMapPointFromVec3d(DR);return e.z=i,e}return null}computeIntersection(e,t,i){if(u(e))return;const r=this.view.state.camera,s=Bt(No.get());r.projectToRenderScreen(e.origin,s);const a=this.prepareFilters(i,OR);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const n=e.origin,o=Qe(No.get(),e.origin,e.direction);t.reset(n,o),t.intersect(a.layers,s,r,this.tolerance);const l=this.view.slicePlane,c=h(l)?Jc(l):null;t.intersect(a.sliceableLayers,s,r,this.tolerance,c);const d=i&&(i.requiresGroundFeedback||i.enableDraped);this.externalIntersectionHandlers.forAll((e=>{if(t.options.isFiltered=!a.filterLayerUid(e.intersectionHandlerId),e.isGround&&d||!t.options.isFiltered){const i=e.slicePlane?c:null;e.intersect(t,i,n,o,s)}}));const p=No.get();if(i&&i.enableDraped&&t.results.ground.getIntersectionPoint(p)){const e=this.view.basemapTerrain.overlayManager.renderer,i=this.view.renderCoordsHelper.spatialReference,r=No.get();this.view.renderCoordsHelper.fromRenderCoords(p,r,this.view.spatialReference),r[2]=this.view.elevationProvider.getElevation(p[0],p[1],p[2],i,"ground")||0,e.intersect(t,r,a.filterRenderGeometry)}t.sortResults();const m=t.results.hud;if(m.hasIntersectionPoint){const e=Bt(No.get()),i=No.get(),s=No.get();this.unprojectHUDResultRay(m.center,e,i,s);const n=Ke(m.center,i)/Ke(i,s)*.99;this.validateHUDIntersector.reset(i,s),this.validateHUDIntersector.intersect(a.layers,e,r,this.tolerance),this.validateHUDIntersector.intersect(a.sliceableLayers,e,r,this.tolerance,c),this.externalIntersectionHandlers.forAll((t=>{if(!a.filterLayerUid(t.intersectionHandlerId))return;const r=t.slicePlane?c:null;t.intersect(this.validateHUDIntersector,r,i,s,e)}));const o=this.validateHUDIntersector.results.min;(null==o.dist||n<=o.dist)&&(t.results.min.copyFrom(m),t.results.all.splice(0,0,m))}}prepareFilters(e,t){const i=[],r=[];return this.layerProvider.forEachLayer((e=>{e.isPickable&&(e.isSliceable?r:i).push(e)})),t.include=e&&e.include,t.exclude=e&&e.exclude,t.layers.length=0,t.sliceableLayers.length=0,PR(i,t.filterLayer,t.layers),PR(r,t.filterLayer,t.sliceableLayers),t}unprojectHUDResultRay(e,t,i,r){const s=this.view.state.camera;s.projectToRenderScreen(e,t);const a=Bt(No.get());a[0]=t[0],a[1]=t[1],a[2]=0,s.unprojectFromRenderScreen(a,i),a[2]=1,s.unprojectFromRenderScreen(a,r)}}function PR(e,t,i){for(const r of e)t&&!t(r)||i.push(r);return i}let RR;function MR(e){return RR||(RR=new ih(e)),RR.viewingMode=e,RR}const OR={include:null,exclude:null,layers:[],sliceableLayers:[],filterLayer:e=>OR.filterLayerUid(e.apiLayerUid),filterLayerUid(e){const{include:t,exclude:i}=OR;return u(e)?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))},filterRenderGeometry:e=>OR.filterLayerUid(e.data.layerUid)},DR=je(),AR=Nt();class ER{constructor(e,t){this.spatialReference=e,this.view=t}getElevation(e,t,i){return this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,s){return this.view.elevationProvider.queryElevation(e,t,0,this.spatialReference,s,i,r)}}class IR{constructor(e,t,i,r){this.spatialReference=t,this._getElevationQueryProvider=i,this._queries=new Array,this._queryOptions={...r,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(xr.ELEVATION_QUERY,(()=>this._update()),(()=>this._queries.length>0))}destroy(){this._frameTask.remove()}queryElevation(e,t,i,r=0){return W(((s,a)=>{const n={x:e,y:t,minDemResolution:r,result:{resolve:s,reject:a},signal:i};this._queries.push(n),Q(i,(()=>{D(this._queries,n),a(B())}))}))}_update(){const e=this._queries;this._queries=[];const t=this._getElevationQueryProvider();if(!t)return void e.forEach((e=>e.result.reject()));const i=e.map((e=>[e.x,e.y])),r=e.reduce(((e,t)=>Math.min(e,t.minDemResolution)),1/0),s=new Et({points:i,spatialReference:this.spatialReference}),a=e.length>1&&e.some((e=>!!e.signal))?z():null,n=h(a)?a.signal:e[0].signal;if(h(a)){let t=0;e.forEach((i=>Q(i.signal,(()=>{t++,i.result.reject(B()),t===e.length&&a.abort()}))))}const o={...this._queryOptions,minDemResolution:r,signal:n};t.queryElevation(s,o).then((t=>{e.forEach(((e,i)=>{h(e.signal)&&e.signal.aborted?e.result.reject(B()):e.result.resolve(t.geometry.points[i][2])}))})).catch((t=>{e.forEach((e=>e.result.reject(t)))}))}get test(){const e=this;return{update:()=>e._queries.length>0&&e._update()}}}let LR=class extends(se.EventedMixin(T)){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map}destroy(){this._elevationQuery=p(this._elevationQuery)}get elevationQuery(){return u(this._elevationQuery)&&(this._elevationQuery=new IR(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQuery}getElevation(e,t,i,r,s){let a=null;return a=FR(a,this.im,e,t,i,r,s),null==a&&(a=FR(a,this.ground,e,t,i,r,s)),"scene"===s&&(a=FR(a,this.scene,e,t,i,r,s)),a}queryElevation(e,t,i,r,s,a=null,n=0){const o=V();return this.elevationQuery.queryElevation(e,t,a,n).then((a=>{"scene"===s&&(a=FR(a,this.scene,e,t,i,r,s)),o.resolve(a)})).catch((a=>{U(a)?o.reject(a):o.resolve(this.getElevation(e,t,i,r,s))})),o.promise}register(e,t){this.handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}};function FR(e,t,i,r,s,a,n){for(const o of t){const t=o.getElevation(i,r,s,a,n);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}e([S({constructOnly:!0})],LR.prototype,"view",void 0),e([S({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],LR.prototype,"spatialReference",void 0),LR=e([re("esri.views.3d.support.CombinedElevationProvider")],LR);class VR{static isValidProfile(e){return e in VR.profiles}static getDefaultProfile(){return i("trident")||i("esri-iPhone")?"low":"medium"}static apply(e,t){const i=VR.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor;{const e=t.sceneService["3dObject"],r=i.sceneService["3dObject"];e.lodFactor=r.lodFactor,e.lodCrossfadeinDuration=r.lodCrossfadeinDuration,e.lodCrossfadeoutDuration=r.lodCrossfadeoutDuration,e.lodCrossfadeUncoveredDuration=r.lodCrossfadeUncoveredDuration}t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.orderIndependentTransparencyEnabled=i.orderIndependentTransparencyEnabled,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumRenderResolution=i.maximumRenderResolution,t.maximumPixelRatio=i.maximumPixelRatio}}function zR(){const e=!!i("esri-mobile");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,orderIndependentTransparencyEnabled:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!i("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!1,orderIndependentTransparencyEnabled:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!i("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,orderIndependentTransparencyEnabled:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:e?null:4096,maximumPixelRatio:e?1:null}}}VR.debug={reset(){const e=zR();for(const t in e)VR.profiles[t]=e[t]}},function(e){e.profiles=zR()}(VR||(VR={}));var UR=VR;let kR=class extends T{constructor(){super(...arguments),this.color=new At([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25}static toEngineOptions(e){const t=At.toUnitRGBA(e.color),i=h(e.haloColor)?At.toUnitRGBA(e.haloColor):t;return{color:cd(t[0],t[1],t[2],t[3]),haloColor:cd(i[0],i[1],i[2],i[3]),haloOpacity:e.haloOpacity,haloOpacityOccluded:.25*e.haloOpacity,fillOpacity:e.fillOpacity,fillOpacityOccluded:.25*e.fillOpacity}}};e([S({type:At})],kR.prototype,"color",void 0),e([S({type:At})],kR.prototype,"haloColor",void 0),e([S()],kR.prototype,"haloOpacity",void 0),e([S()],kR.prototype,"fillOpacity",void 0),kR=e([re("esri.views.3d.support.HighlightOptions")],kR);var jR=kR;class GR{constructor(e,t,i=null){this.spatialReference=t,this.unitInMeters=Jt(this.spatialReference),this._geometryServicePromise=oe(this.loadGeometryService(e,i))}async loadGeometryService(e,t){if(t)return t;try{return await dd(e&&e.get("portalItem"))}catch{throw new ee("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}}async awaitGeometryService(){const e=await this._geometryServicePromise;if(!0===e.ok)return e.value;throw e.error}async toGeographic(e){const t=await this.awaitGeometryService();let i,r=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?i=e:(i=[e],r=!1);const s=i.map((e=>e instanceof _e?e:new _e(e,this.spatialReference))),a=new vi({geometries:s,outSpatialReference:ue.WGS84}),n=(await t.project(a)).map((e=>"point"===e.type?[e.x,e.y]:void 0));return r?n:n[0]}}let BR=class extends T{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.polygonLodFactor=1,this.polylineLodFactor=1}};e([S()],BR.prototype,"minTotalNumberOfFeatures",void 0),e([S()],BR.prototype,"maxTotalNumberOfFeatures",void 0),e([S()],BR.prototype,"maxTotalNumberOfPrimitives",void 0),e([S()],BR.prototype,"polygonLodFactor",void 0),e([S()],BR.prototype,"polylineLodFactor",void 0),BR=e([re("esri.views.3d.support.QualitySettings.Graphics3DSettings")],BR);let NR=class extends T{constructor(){super(...arguments),this.lodFactor=1}};e([S()],NR.prototype,"lodFactor",void 0),NR=e([re("esri.views.3d.support.QualitySettings.LoDFactorSettings")],NR);let qR=class extends NR{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};qR=e([re("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],qR);let HR=class extends T{constructor(){super(...arguments),this["3dObject"]=new qR,this.point=new NR,this.integratedMesh=new NR,this.pointCloud=new NR,this.uncompressedTextureDownsamplingEnabled=!1}};e([S({type:qR})],HR.prototype,"3dObject",void 0),e([S({type:NR})],HR.prototype,"point",void 0),e([S({type:NR})],HR.prototype,"integratedMesh",void 0),e([S({type:NR})],HR.prototype,"pointCloud",void 0),e([S()],HR.prototype,"uncompressedTextureDownsamplingEnabled",void 0),HR=e([re("esri.views.3d.support.QualitySettings.SceneServiceSettings")],HR);let WR=class extends T{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};e([S()],WR.prototype,"lodBias",void 0),e([S()],WR.prototype,"angledSplitBias",void 0),e([S()],WR.prototype,"reduceTileLevelDifferences",void 0),e([S()],WR.prototype,"textureFadeDuration",void 0),WR=e([re("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],WR);let ZR=class extends T{constructor(){super(...arguments),this.graphics3D=new BR,this.sceneService=new HR,this.tiledSurface=new WR,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.orderIndependentTransparencyEnabled=!0}};e([S({type:BR})],ZR.prototype,"graphics3D",void 0),e([S({type:HR})],ZR.prototype,"sceneService",void 0),e([S({type:WR})],ZR.prototype,"tiledSurface",void 0),e([S()],ZR.prototype,"antialiasingEnabled",void 0),e([S()],ZR.prototype,"physicallyBasedRenderingEnabled",void 0),e([S()],ZR.prototype,"orderIndependentTransparencyEnabled",void 0),e([S()],ZR.prototype,"memoryLimit",void 0),e([S()],ZR.prototype,"additionalCacheMemory",void 0),e([S()],ZR.prototype,"frameRate",void 0),e([S()],ZR.prototype,"maximumRenderResolution",void 0),e([S()],ZR.prototype,"maximumPixelRatio",void 0),ZR=e([re("esri.views.3d.support.QualitySettings.QualitySettings")],ZR);var QR=ZR;class YR{constructor(e,t,i,r){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this.coordinateSystem=r,this._coordinateSystem=function(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}(r)}set extent(e){e&&function(e,t,i){e.operations.setExtent(e.value,t,i.value)}(this.coordinateSystem,e,this.coordinateSystem)}getAltitude(e){return t=this.coordinateSystem,i=e,t.operations.altitudeAt(t.value,i);var t,i}setAltitude(e,t){ug(this.coordinateSystem,t,e,t)}setAltitudeOfTransformation(e,t){!function(e,t,i,r){t!==r&&_i(r,t),Ye(mg,r[12],r[13],r[14]),ug(e,mg,i,mg),r[12]=mg[0],r[13]=mg[1],r[14]=mg[2]}(this.coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return i=this.coordinateSystem,r=e,s=t,i.operations.axisAt(i.value,r,2,s);var i,r,s}worldBasisAtPosition(e,t,i){return function(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}(this.coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,0,No.get()),r=this.worldBasisAtPosition(e,1,No.get()),s=this.worldBasisAtPosition(e,2,No.get());return Oi(t,i[0],i[1],i[2],0,r[0],r[1],r[2],0,s[0],s[1],s[2],0,0,0,0,1),t}intersectManifoldClosestSilhouette(e,t,i){return pg(this.coordinateSystem,t,this._coordinateSystem),function(e,t,i){e.operations.intersectRayClosestSilhouette(e.value,t,i)}(this._coordinateSystem,e,i),i}intersectManifold(e,t,i){pg(this.coordinateSystem,t,this._coordinateSystem);const r=No.get();return!!function(e,t,i){return e.operations.intersectRay(e.value,t,i)}(this._coordinateSystem,e,r)&&(Xe(i,r),!0)}intersectInfiniteManifold(e,t,i){if(1===this.viewingMode)return this.intersectManifold(e,t,i);pg(this.coordinateSystem,t,this._coordinateSystem);const r=this._coordinateSystem.value,s=No.get();return!!Uo.intersectRay(r.plane,e,s)&&(Xe(i,s),!0)}toRenderCoords(e,t,i){return Da(e)?ir(e,t,this.spatialReference):rr(e,t,i,this.spatialReference)}fromRenderCoords(e,t,i){return Da(t)?cr(e,this.spatialReference,t,i):t instanceof ue?sr(e,this.spatialReference,t):rr(e,this.spatialReference,t,m(i))}static createGlobal(e){const t=dg(jo,jo.fromValues(Kt(e).radius,[0,0,0]));return new YR(1,e,1,t)}static createLocal(e){const t=dg(Wo,Wo.fromValues([0,0,0],[$R,0,0],[0,$R,0])),i=Jt(e);return new YR(2,e,i,t)}static createMode(e,t){switch(e){case 2:return YR.createLocal(t);case 1:return YR.createGlobal(t);default:return}}}const $R=Math.pow(2,50),XR=(()=>{const e=new Array;return e[0]=10,e[1]=10,e[2]=10,e[3]=10,e[4]=5,e})(),KR=d.getLogger("esri.views.3d.support.MemoryController");class JR{constructor(e){this._view=e,this.events=new se,this.minQuality=.1,this._maxMemory=500,this._additionalCacheMemory=100,this._quality=1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryUsed=0,this._memoryPredicted=0,this._cacheStorage=new si,this._numQualityChanges=0,this._updating=!1}destroy(){this.events=null}getMemCache(e,t){return new ai(e,this._cacheStorage,t)}set maxMemory(e){null!=e&&e>0&&(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}disableMemCache(){this._additionalCacheMemory=-4096}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}resetStableQuality(){this._stableQuality=0}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._memoryUsed>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this.updating!==e&&(this._updating=e,this.events.emit("updating-changed",this.updating))}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),1))!==this._quality&&(this._quality=e,this.events.emit("quality-changed",this._quality),++this._numQualityChanges,!0)}_layersUpdating(){return this._view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){let e=0,t=0;this._view.basemapTerrain&&this._view.basemapTerrain.getUsedMemory&&(e+=this._view.basemapTerrain.getUsedMemory());const i=this._view._stage&&this._view._stage.renderView&&this._view._stage.renderView.edgeView;h(i)&&(e+=i.getUsedMemory()),this._view.allLayerViews&&this._view.allLayerViews.forEach((i=>{if(pd(i)){const r=i.ignoresMemoryFactor()?this._quality:1;e+=i.getUsedMemory()*r,t+=i.getUnloadedMemory()*r}}));const r=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),s=1048576*this._maxMemory;if(e>s&&r){this._warnMemoryUsage=e;const i=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);KR.warn(`Memory Limit exceeded! Limit: ${i(s)} Current: ${i(e)} Projected: ${i(e+t)} Quality: ${r}%`)}this._memoryUsed=e/s,this._memoryPredicted=(e+t)/s;const a=s-e;this._cacheStorage.maxSize=Math.max(0,a+1048576*this._additionalCacheMemory),this.events.emit("memory-used",this._memoryUsed)}get test(){return{cacheStorage:this._cacheStorage,numQualityChanges:this._numQualityChanges}}}let eM=class extends T{constructor(){super(...arguments),this.updating=!1}};var tM;e([S({readOnly:!0})],eM.prototype,"updating",void 0),eM=e([re("esri.views.3d.support.ResourceController")],eM),function(t){let i=class extends eM{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._cameraChangeTime=0,this._handles=new $t,this._frameTask=null}initialize(){var e;this._cameraChangeTime=this.now(),this._scheduler=wr(this.now),this._memoryController=(e=this.view,new JR(e)),this._streamDataLoader=new md,this._streamDataLoader.setup(30,XR,this._scheduler),this._handles.add([this.view.watch("state.camera",((e,t)=>this._cameraChangedHandler(e,t)),!0),this.view.watch("stationary",(()=>this._stationaryChangedHandler())),this._memoryController.events.on("updating-changed",(()=>this.notifyChange("updating")))]),this._frameTask=O({update:e=>this.frame(e)})}destroy(){this._handles=p(this._handles),this._frameTask=_(this._frameTask),this._streamDataLoader=p(this._streamDataLoader),this._memoryController=p(this._memoryController),this._scheduler=p(this._scheduler)}get updating(){var e,t;return!!(null!=(e=this._memoryController)&&e.updating||null!=(t=this._streamDataLoader)&&t.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,s)=>t.request(i,r,e,s),get busy(){return!t.hasDownloadSlots(e)}}}frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(e.deltaTime/1e3),!this._scheduler)||(this._scheduler.state=this.state,this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get state(){const e=this.view;return e.animation?0:e.interacting||this._scheduler.now-this._cameraChangeTime<=r?1:2}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e),state:this.state}}};e([S({constructOnly:!0})],i.prototype,"view",void 0),e([S({constructOnly:!0})],i.prototype,"now",void 0),e([S()],i.prototype,"_memoryController",void 0),e([S()],i.prototype,"_streamDataLoader",void 0),e([S({readOnly:!0,dependsOn:["_memoryController.updating","_streamDataLoader.updating"]})],i.prototype,"updating",null),i=e([re("esri.views.3d.support.ResourceController")],i),t.ResourceController=i;const r=300}(tM||(tM={}));class iM{constructor(e,t,i,r){this._streamDataRequester=e,this._stage=t,this._textureOptions=i,this._textureRequests=new Map,this._frameTask=h(r)?r.registerTask(xr.TEXTURE_UNLOAD,(()=>{}),(()=>!1)):Cr}destroy(){this._frameTask.remove(),this._textureRequests.forEach((e=>this.releaseTextureRequest(e))),this._textureRequests.clear()}async fromUrl(e,t,i){q(i);const r=h(i)&&i.signal,s=this.makeUid(e,t);let a=this._textureRequests.get(s);if(!a){const i=z(),r=this._streamDataRequester.request(e,"image",{uid:s,signal:i.signal});a={referenceCount:0,texture:null,textureAsync:null,abortController:i},this._textureRequests.set(s,a),a.textureAsync=r.then((i=>{const r=this.createTexture(e,i,t);return a.texture=r,a.abortController=null,this.addToStage(r),{uid:s,texture:r}}),(e=>{throw a.abortController=null,e}))}return a.referenceCount++,W(((e,t)=>{Q(r,(()=>{t(B())})),a.textureAsync.then(e,t)})).catch((e=>{throw this.release(s),e}))}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);return r||(r={referenceCount:0,texture:t(),textureAsync:null,abortController:null},this.addToStage(r.texture),this._textureRequests.set(i,r)),r.referenceCount++,{uid:i,texture:r.texture}}release(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this.releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this.releaseTextureRequest(t),this._textureRequests.delete(e))}releaseTextureRequest(e){e.texture?this.removeFromStage(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}createTexture(e,t,i){if(ce(e)&&(i||0===t.width&&0===t.height)){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}const r={...this._textureOptions,width:t.width,height:t.height,powerOfTwoResizeMode:2};return new id(t,"symbol",r)}addToStage(e){this._stage.add(4,e)}removeFromStage(e){this._stage.remove(4,e.id)}makeUid(e,t){return null!=t?`${e}.${t}px`:e}}class rM{constructor(e){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=e.viewState,this.view=e.view,this.pointsOfInterest=e.pointsOfInterest,this.objectResourceCache=e.objectResourceCache,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.textures=new iM(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:33071,t:33071}},e.resourceController.scheduler);const t=Kt(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=ao(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=no(e.viewingMode,t)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return{remove(){}};this.graphicsOwners.push(e);const t="layer"in e?e.watch("layer.screenSizePerspectiveEnabled",(()=>this.updateScreenSizePerspectiveEnabled())):null;return this.updateScreenSizePerspectiveEnabled(),{remove:()=>{t&&(t.remove(),A(this.graphicsOwners,e),this.updateScreenSizePerspectiveEnabled())}}}updateScreenSizePerspectiveEnabled(){const e=this.graphicsOwners.some((e=>!0===e.get("layer.screenSizePerspectiveEnabled")));if(e&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new $t;const e=()=>this.updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([this.pointsOfInterest.centerOnSurfaceInfrequent.watch("distance",e,!0),this.viewState.events.on("camera-projection-changed",e)]),this.updateScreenSizePerspectiveSettings()}else!e&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}updateScreenSizePerspectiveSettings(){const e=this.pointsOfInterest;sM.distance=e.centerOnSurfaceInfrequent.distance,sM.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(sM),this.screenSizePerspectiveSettingsLabels.update(sM),this.view._stage.renderView.setNeedsRender()}}const sM={distance:0,fovY:0};function aM(e,...t){if(nM(e)&&e.destroyed)try{throw new Error("instance is already destroyed")}catch(e){console.warn(e.stack)}else for(const i of t){if(!(i in e))throw new Error(`Property '${i}' does not exist and cannot be disposed`);const t=e[i];t&&("function"==typeof t.destroy?t.destroy():"function"==typeof t.dispose?t.dispose():"function"==typeof t.remove&&t.remove()),nM(e)&&i in e.__accessor__.metadatas?e._set(i,null):e[i]=null}}function nM(e){return e instanceof T}let oM=class extends T{constructor(e){super(e),this.handles=new $t}destroy(){aM(this,"handles")}};e([S({constructOnly:!0})],oM.prototype,"renderCoordsHelper",void 0),e([S({constructOnly:!0})],oM.prototype,"surface",void 0),e([S({constructOnly:!0})],oM.prototype,"state",void 0),oM=e([re("esri.views.3d.support.PointOfInterest")],oM);const lM=Array;let cM=class extends oM{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new ld({location:_e,renderLocation:lM},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=je()}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,(()=>this._measureSurfaceAltitude()),(()=>this._needsUpdate()))),this._measureSurfaceAltitude(),this.map){const e=()=>this._setDirty();this.handles.add([ci(this.map,"ground.layers","change",e,e,e)])}}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}update(){this._measureSurfaceAltitude(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_needsUpdate(){return!this._pendingElevationQueryController&&this._dirty}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}_measureSurfaceAltitude(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this.state.camera.eye,dM,this.state.spatialReference);let e=z();this.map.ground.queryElevation(dM,{signal:e.signal}).then((e=>this._updateSurfaceAltitude(e.geometry.z))).catch((e=>{U(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===e&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),e=null})),this._pendingElevationQueryController=e}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){Xe(hM,this.state.camera.eye),this.renderCoordsHelper.setAltitude(this._estimatedSurfaceAltitude,hM),ut(this._get("renderLocation"),hM)||this._set("renderLocation",Xe(this._propertiesPool.get("renderLocation"),hM))}};e([S({constructOnly:!0})],cM.prototype,"scheduler",void 0),e([S({constructOnly:!0})],cM.prototype,"task",void 0),e([S({readOnly:!0,dependsOn:["renderLocation"]})],cM.prototype,"location",null),e([S({constructOnly:!0})],cM.prototype,"map",void 0),e([S({readOnly:!0})],cM.prototype,"renderLocation",void 0),e([S({readOnly:!0})],cM.prototype,"updating",null),cM=e([re("esri.views.3d.support.CameraOnSurface")],cM);const hM=je(),dM=new _e;var uM=cM;const pM=Array;let mM=class extends oM{constructor(e){super(e),this._propertiesPool=new ld({location:_e,renderLocation:pM},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=je(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,(()=>this._measureSurfaceAltitude()),(()=>this.updating)),this._measureSurfaceAltitude()}destroy(){this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null),this._propertiesPool.destroy(),this._propertiesPool=null}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this._set("updating",!0),this._updateRenderLocation()}update(){this._measureSurfaceAltitude(),this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}_measureSurfaceAltitude(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this._set("updating",!1)}_updateRenderLocation(){const e=gM;let t=this.calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this.calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=vM;if(t&&this.latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(Xe(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t){const t=Ke(this.state.camera.eye,e);t!==this._get("distance")&&this._set("distance",t)}else{const t=this.state.camera;Ze(e,t.viewForward,this._get("distance")),Qe(e,e,t.eye)}ut(this._get("renderLocation"),e)||this._set("renderLocation",Xe(this._propertiesPool.get("renderLocation"),e))}calculateSurfaceIntersection(e,t){const i=this.state.camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=Kt(this.renderCoordsHelper.spatialReference).radius,s=r+e,a=et(i.eye),n=a<s*s,o=Ke(i.eye,t);if(n&&o>r/4){const e=s-Math.sqrt(a);return Ze(t,i.viewForward,e),Qe(t,t,i.eye),!0}}else{const e=this.surface.ready&&this.surface.extent;e&&(t[0]=Re(t[0],e[0],e[2]),t[1]=Re(t[1],e[1],e[3]))}return!0}latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this.calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){const i=this.state.camera.eye,r=Ke(i,e),s=Ke(i,t),a=Math.abs(s-r);if(xc.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;if(a/r>fM)return!0}return!1}};e([S({constructOnly:!0})],mM.prototype,"scheduler",void 0),e([S({constructOnly:!0})],mM.prototype,"task",void 0),e([S({readOnly:!0})],mM.prototype,"distance",void 0),e([S({constructOnly:!0})],mM.prototype,"estimateSurfaceAltitudeAtCenter",void 0),e([S({readOnly:!0,dependsOn:["renderLocation"]})],mM.prototype,"location",null),e([S({readOnly:!0})],mM.prototype,"renderLocation",void 0),e([S({readOnly:!0})],mM.prototype,"updating",void 0),mM=e([re("esri.views.3d.support.CenterOnSurface")],mM);const fM=.05,gM=je(),vM=je();var yM=mM;class _M{constructor(e){this.handles=new $t,this.events=new se,this.contentLayerViews=e.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",(e=>this.layerViewsChanged(e)))),this.layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this.handles.add(e.on("visible-geometry-changed",(()=>this.contentChanged())),e.uid)})),e.removed.forEach((e=>this.handles.remove(e.uid)))}contentChanged(){this.events.emit("request-update",xM)}}const xM={},bM={red:[255,0,0],green:[0,255,0],blue:[0,0,255]};class wM{constructor(e,t){this.graphics=e,this._symbol=new Zt({color:bM[t],outline:{color:[255,255,255],width:2}})}showPoint(e,t){if(u(t))return;this.remove();const i=new _e({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new Qt({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}remove(){h(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}const CM=Array;let SM=class extends oM{constructor(e){super(e),this._propertiesPool=new ld({location:_e,renderLocation:CM},this)}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null,OM=_(OM)}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get renderLocation(){const e=this.centerOnSurface.renderLocation,t=this.renderCoordsHelper,i=this.calculateScreenHorizontalEdgeOnSurface(MM);at(TM,e,this.state.camera.eye),nt(TM,TM),t.worldUpAtPosition(e,PM);const r=Math.abs(Math.acos(st(PM,TM))-.5*Math.PI),s=this._propertiesPool.get("renderLocation");if(Number.isNaN(r))Xe(s,e);else{const t=1-Re(r/(.5*Math.PI),0,1);tt(s,e,i,t*t*t)}return h(OM)&&(xc.SHOW_POI?OM.showPoint(s,this.renderCoordsHelper.spatialReference):OM.remove()),s}calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.camera,i=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation),r=this.renderCoordsHelper.getAltitude(t.eye)>=i,s=t.getRenderCenter(Ut());if(s[1]=r?t.padding[2]:t.fullHeight-t.padding[0],t.unprojectFromRenderScreen(s,RM)){at(RM,RM,t.eye);const r=nt(RM,RM);if(this.renderCoordsHelper.intersectManifold(ko.wrap(t.eye,r),i,e))return e}return Xe(e,t.eye),this.renderCoordsHelper.setAltitude(i,e),e}updateRenderLocation(){}};e([S({constructOnly:!0})],SM.prototype,"centerOnSurface",void 0),e([S({readOnly:!0})],SM.prototype,"location",null),e([S({readOnly:!0})],SM.prototype,"renderLocation",null),e([S({readOnly:!0,aliasOf:"centerOnSurface.updating"})],SM.prototype,"updating",void 0),SM=e([re("esri.views.3d.support.CenterOnSurface")],SM);const TM=je(),PM=je(),RM=je(),MM=je();let OM;var DM=SM;let AM=class extends T{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new $t}get renderLocation(){if(!this.location)return null;const e=je();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([this.watch(["surfaceView.spatialReference","surfaceView.extent"],(()=>this._update())),ci(this,"surface.layers","change",(()=>this._update()))]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||!this.surfaceView.extent||!this.surfaceView.spatialReference)return void this._set("location",null);const e=qi(this.surfaceView.extent),t=new _e({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=z(),this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{U(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)}))):this._set("location",t)}};e([S({constructOnly:!0})],AM.prototype,"view",void 0),e([S({readOnly:!0,aliasOf:"view.map.ground"})],AM.prototype,"surface",void 0),e([S({readOnly:!0,aliasOf:"view.basemapTerrain"})],AM.prototype,"surfaceView",void 0),e([S({readOnly:!0})],AM.prototype,"location",void 0),e([S({readOnly:!0,dependsOn:["location"]})],AM.prototype,"renderLocation",null),AM=e([re("esri.views.3d.terrain.StableSurfaceCenter")],AM);var EM=AM;let IM=class extends T{constructor(){super(...arguments),this.handles=new $t,this._tileGeometryUpdateExtent=Fi(),this._tileGeometryUpdateSpatialReference=null,this.events=new se,this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(xr.SURFACE_GEOMETRY_UPDATES,(()=>this.update()),(()=>this.updating))])}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}update(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",LM),Fi(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,ki(this._tileGeometryUpdateExtent,e.tile.extent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.camera.eye,r=zM,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,FM,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,VM,t),FM[0]<VM[0]?(r[0]=FM[0],r[2]=VM[0]):(r[0]=VM[0],r[2]=FM[0]),FM[1]<VM[1]?(r[1]=FM[1],r[3]=VM[1]):(r[1]=VM[1],r[3]=FM[1]),ji(r,e)}};e([S({constructOnly:!0})],IM.prototype,"state",void 0),e([S({constructOnly:!0})],IM.prototype,"centerOnSurfaces",void 0),e([S({constructOnly:!0})],IM.prototype,"renderCoordsHelper",void 0),e([S({constructOnly:!0})],IM.prototype,"scheduler",void 0),e([S({constructOnly:!0})],IM.prototype,"surface",void 0),e([S({readOnly:!0})],IM.prototype,"updating",void 0),IM=e([re("esri.views.3d.support.SurfaceGeometryUpdates")],IM);const LM={},FM=je(),VM=je(),zM=Fi();var UM=IM;let kM=class extends T{constructor(e){super(e),this.handles=new $t,this.surfaceAltitudeAtCenter=0,this.surfaceAltitudeAtCenterDirty=!0,this.surfaceAltitudeAtCenterWithContent=0,this.surfaceAltitudeAtCenterWithContentDirty=!0,this.propertiesPool=new ld({renderPointOfView:jM},this),this.renderPointOfView=je()}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view;this.surfaceIntersector=new ih(e.mode),e.isGlobal?this.surfaceIntersector.options.backfacesTerrain=!1:this.surfaceIntersector.options.backfacesTerrain=!0,this.surfaceIntersector.options.invisibleTerrain=!1,this.contentIntersector=new ih(e.mode),this.contentIntersectorOptions={exclude:new Set([eh])};const s=()=>this.estimateSurfaceAltitudeAtCenter(),a={state:e,scheduler:this.view.resourceController.scheduler,surface:t,renderCoordsHelper:i};var n;this._set("centerOnSurfaceInfrequent",new yM({...a,task:xr.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnSurfaceFrequent",new yM({...a,task:xr.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnContent",new yM({...a,task:xr.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this.estimateSurfaceAltitudeAtCenterWithContent()})),this._set("cameraOnSurface",new uM({...a,task:xr.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new UM({...a,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new _M({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new EM({view:this.view})),this._set("focus",new DM({state:e,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent})),n=this.view.graphics,_(OM),OM=new wM(n,"green"),this.handles.add([e.watch("camera",(e=>this.cameraChanged(e)),!0),t.watch("extent",(()=>this.updateCenterPointsOfInterest())),this.surfaceGeometryUpdates.events.on("request-update",(()=>this.updateCenterPointsOfInterest())),this.contentGeometryUpdates.events.on("request-update",(()=>this.updateCenterOnContent()))]),this.cameraChanged(this.view.state.camera),this.centerOnContent.update(),this.centerOnSurfaceFrequent.update(),this.centerOnSurfaceInfrequent.update(),this.cameraOnSurface.update()}destroy(){aM(this,"handles","centerOnSurfaceInfrequent","centerOnSurfaceFrequent","cameraOnSurface","centerOnContent","surfaceOrigin","focus","propertiesPool")}get updating(){var e,t,i,r,s,a;return!!(null!=(e=this.surfaceGeometryUpdates)&&e.updating||null!=(t=this.centerOnContent)&&t.updating||null!=(i=this.centerOnSurfaceInfrequent)&&i.updating||null!=(r=this.centerOnSurfaceFrequent)&&r.updating||null!=(s=this.cameraOnSurface)&&s.updating||null!=(a=this.focus)&&a.updating)}estimateSurfaceAltitudeAtCenterWithContent(){if(!this.surfaceAltitudeAtCenterWithContentDirty)return this.surfaceAltitudeAtCenterWithContent;this.surfaceAltitudeAtCenterWithContentDirty=!1;const e=this.view.state.camera,t=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,BM);return u(t)||(this.view.sceneIntersectionHelper.intersectRay(t,this.contentIntersector,GM,this.contentIntersectorOptions)?this.surfaceAltitudeAtCenterWithContent=this.view.renderCoordsHelper.getAltitude(GM):this.surfaceAltitudeAtCenterWithContent=this.estimateSurfaceAltitudeAtCenter(t)),this.surfaceAltitudeAtCenterWithContent}estimateSurfaceAltitudeAtCenter(e=null){if(!this.view.basemapTerrain)return 0;if(!this.surfaceAltitudeAtCenterDirty)return this.surfaceAltitudeAtCenter;this.surfaceAltitudeAtCenterDirty=!1;const t=this.view.state.camera;if(u(e)&&(e=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(t,BM),u(e)))return this.surfaceAltitudeAtCenter;const i=e.origin,r=Qe(GM,e.origin,e.direction);return this.surfaceIntersector.resetWithRay(e),this.surfaceIntersector.intersect(null,null,t),this.view.basemapTerrain.intersect(this.surfaceIntersector,null,i,r),this.surfaceIntersector.results.min.getIntersectionPoint(GM)&&(this.surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(GM)),this.surfaceAltitudeAtCenter}cameraChanged(e){this.updateCenterPointsOfInterest();const t=e.eye;ut(this.renderPointOfView,t)||this._set("renderPointOfView",Xe(this.propertiesPool.get("renderPointOfView"),t))}updateCenterPointsOfInterest(){this.surfaceAltitudeAtCenterDirty=!0,this.surfaceAltitudeAtCenterWithContentDirty=!0,this.centerOnSurfaceFrequent.updateRenderLocation(),this.centerOnSurfaceInfrequent.updateRenderLocation(),this.cameraOnSurface.updateRenderLocation(),this.focus.updateRenderLocation(),this.centerOnContent.updateRenderLocation()}updateCenterOnContent(){this.surfaceAltitudeAtCenterWithContentDirty=!0,this.centerOnContent.updateRenderLocation()}get test(){return{update:()=>{this.surfaceGeometryUpdates.update(),this.centerOnSurfaceFrequent.update(),this.centerOnSurfaceInfrequent.update()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};e([S({readOnly:!0})],kM.prototype,"centerOnContent",void 0),e([S({readOnly:!0})],kM.prototype,"centerOnSurfaceFrequent",void 0),e([S({readOnly:!0})],kM.prototype,"centerOnSurfaceInfrequent",void 0),e([S({readOnly:!0})],kM.prototype,"cameraOnSurface",void 0),e([S({readOnly:!0})],kM.prototype,"focus",void 0),e([S({readOnly:!0})],kM.prototype,"renderPointOfView",void 0),e([S({readOnly:!0})],kM.prototype,"surfaceOrigin",void 0),e([S({readOnly:!0})],kM.prototype,"contentGeometryUpdates",void 0),e([S({readOnly:!0})],kM.prototype,"surfaceGeometryUpdates",void 0),e([S({constructOnly:!0})],kM.prototype,"view",void 0),e([S({readOnly:!0,dependsOn:["surfaceGeometryUpdates.updating","centerOnContent.updating","centerOnSurfaceInfrequent.updating","centerOnSurfaceFrequent.updating","cameraOnSurface.updating","focus.updating"]})],kM.prototype,"updating",null),kM=e([re("esri.views.3d.support.PointsOfInterest")],kM);const jM=Array,GM=je(),BM=ol();var NM=kM;const qM=t=>{let i=class extends t{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(e){super.postscript(e),ur(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=mi(this.view.defaultsFromMap,"isHeightModelInfoSearching");this.handles.add(e),await e;const t=pr(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(t)throw t}};return e([S()],i.prototype,"view",void 0),e([S()],i.prototype,"slicePlaneEnabled",void 0),i=e([re("esri.views.3d.layers.LayerView3D")],i),i},HM={value:.5,readOnly:!0},WM={dependsOn:["updating","updatingProgressValue"],readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}},ZM=t=>{let i=class extends t{get imageFormatIsOpaque(){return!1}get isOpaque(){return this.fullOpacity>=1&&this.imageFormatIsOpaque}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale;return this.levelRangeFromScaleRange(t,i)}get displayLevelRange(){const e=this.tileInfo.lods,t=this.layer.minScale||e[0].scale,i=this.layer.maxScale||e[e.length-1].scale,r=this.levelRangeFromScaleRange(t,i);return this.layer.maxScale&&r.maxLevel++,r}getTileUrl(e,t,i){return this.layer.getTileUrl(e,t,i)}_addTilingSchemeMatchPromise(){const e=this._getTileInfoSupportError(this.tileInfo,this.layer.fullExtent);if(e)this.addResolvingPromise($(e));else{const e=fi(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const e=this.view.basemapTerrain.tilingScheme,t=this._getTileInfoCompatibilityError(this.tileInfo,e);if(t)throw t}));this.addResolvingPromise(e)}}_getTileInfoSupportError(e,t){const i=fd(e,t,this.view.spatialReference,this.view.basemapTerrain.manifold);if(i){const e={layer:this.layer,error:i};let t;switch(i.name){case"tilingscheme:local-gcs-not-supported":t=new ee("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",e);break;case"tilingscheme:spatial-reference-mismatch":case"tilingscheme:global-unsupported-spatial-reference":t=new ee("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",e);break;default:t=new ee("layerview:tiling-scheme-unsupported","The tiling scheme of this layer is not supported by SceneView",e)}return t}return null}_getTileInfoCompatibilityError(e,t){return t.compatibleWith(e)?null:new ee("layerview:tiling-scheme-incompatible","The tiling scheme of this layer is incompatible with the tiling scheme of the surface")}levelRangeFromScaleRange(e,t){const i={minLevel:0,maxLevel:1/0},r=this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.tilingScheme;if(!r)return i;const s=r.levels[0],a=e=>{const t=Math.log(s.scale/e)/Math.LN2;return.5-Math.abs(.5-t%1)<1e-9?Math.round(t):Math.ceil(t)};return null!=e&&e>0&&(i.minLevel=Math.max(0,a(e))),null!=t&&t>0&&(i.maxLevel=Math.max(0,a(t))),i}isUpdating(){return!!(this.view&&this.view.basemapTerrain&&this.view.basemapTerrain.updating)}};return e([S({readOnly:!0})],i.prototype,"imageFormatIsOpaque",null),e([S({readOnly:!0,dependsOn:["view.basemapTerrain.updating"]})],i.prototype,"updating",void 0),e([S(WM)],i.prototype,"updatingProgress",void 0),e([S(HM)],i.prototype,"updatingProgressValue",void 0),e([S({readOnly:!0})],i.prototype,"fullExtent",void 0),e([S({readOnly:!0,dependsOn:["fullOpacity","imageFormatIsOpaque"]})],i.prototype,"isOpaque",null),e([S({readOnly:!0,dependsOn:["tileInfo","view.basemapTerrain.tilingScheme"]})],i.prototype,"dataLevelRange",null),e([S({readOnly:!0,dependsOn:["tileInfo","view.basemapTerrain.tilingScheme","layer.minScale","layer.maxScale"]})],i.prototype,"displayLevelRange",null),e([S()],i.prototype,"layer",void 0),e([S({readOnly:!0})],i.prototype,"tileInfo",void 0),i=e([re("esri.views.3d.layers.TiledLayerView3D")],i),i};let QM=class extends(ZM(qM(qd))){initialize(){const e=this.get("view.map.allLayers"),t=e&&e.includes(this.layer),i=this.get("view.map.ground.layers"),r=i&&i.includes(this.layer);if(t&&!r){const e=new ee("layerview:elevation-layer-only","3D elevation layer '"+this.layer.id+"' can only be added in the map ground");this.addResolvingPromise($(e))}this._addTilingSchemeMatchPromise()}};e([S({readOnly:!0,aliasOf:"layer.fullExtent"})],QM.prototype,"fullExtent",void 0),e([S()],QM.prototype,"layer",void 0),e([S({readOnly:!0,aliasOf:"layer.tileInfo"})],QM.prototype,"tileInfo",void 0),QM=e([re("esri.views.3d.layers.ElevationLayerView3D")],QM);var YM=QM,$M=Object.freeze({__proto__:null,default:YM});class XM{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}class KM{constructor(e,t,i){this.samplerData=null,this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t;const r=i.noDataValue,s=i.values;let a=1/0,n=-1/0,o=!0,l=!1;for(let e=0;e<s.length;e++){const t=s[e];t!==r?(a=t<a?t:a,n=t>n?t:n,o=!1):l=!0}o&&(a=0,n=0),n=n>-3e38?n:0,this.samplerData={pixelData:i.values,width:i.width,height:i.height,noDataValue:r,safeWidth:.99999999*(i.width-1),dx:(i.width-1)/(t[2]-t[0]),dy:(i.width-1)/(t[3]-t[1]),x0:t[0],y1:t[3]},this.bounds=[a,n],this.hasNoDataValues=l}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const s=e-this.level;if(s<=0)return r;const a=Math.pow(2,s);if(!(Math.floor(t/a)===this.i&&Math.floor(i/a)===this.j))return r;let n=1/0,o=-1/0;const l=this.samplerData.width,c=this.samplerData.pixelData,h=.5*Ia;let d=(l-1)/a,u=(i-this.j*a)*d,p=(t-this.i*a)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*l,s=c[i],a=c[i+1],n=c[i+l],o=c[i+l+1];if(s+a+n+o<h){const i=u-e,l=p-t,c=Ot(s,a,n,o,i,l),h=Ot(s,a,n,o,i+d,l),m=Ot(s,a,n,o,i,l+d),f=Ot(s,a,n,o,i+d,l+d);return r.min=Math.min(c,h,m,f),r.max=Math.max(c,h,m,f),r}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let e=u;e<=u+d;e++)for(let t=p;t<=p+d;t++){const i=c[e+t*l];i<h?(n=Math.min(n,i),o=Math.max(o,i)):r.hasNoDataValues=!0}return r.min=n,r.max=o,r}static sample(e,t,i){for(const r of i){if(!r)continue;const i=r.safeWidth,s=r.width,a=r.pixelData;let n=Re(r.dy*(r.y1-t),0,i),o=Re(r.dx*(e-r.x0),0,i);const l=Math.floor(n),c=Math.floor(o),h=l*s+c,d=h+s,u=a[h],p=a[d],m=a[h+1],f=a[d+1];if(u+p+m+f<.5*Ia){n-=l,o-=c;const e=u+(m-u)*o;return e+(p+(f-p)*o-e)*n}}return null}}const JM=oi(40),eO=oi(50);function tO(){var e;const t=null==(e=r.require)?void 0:e.modules;if(t){const e=Object.keys(t);for(const i of e)-1!==i.search(".glsl")&&delete t[i]}}const iO=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let rO,sO=class extends T{constructor(e){super(e),this._handles=new $t,this._overlaySR=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Map,this._drapeTargets=new Set,this._drapeSourceTypes=[0,0],this._drapeTargetTypes=[0,0],this._renderedAltitude=0,this._placementDirty=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._layerViewsDirty=!0,this._hasUnusedRenderTargets=!1,this._isSpherical=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=i("esri-mobile")?2048:4096,this._animationTimeLast=0,this._forceAnimation=!1}get _needsUpdate(){return(this._placementDirty||this._layerViewsDirty)&&(this._drapeSources.size>0||this.view.graphics.length>0||xc.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._overlaySR&&!this.suspended&&this.surface.ready}get view(){return this.surface.view}get updating(){return this._needsUpdate||this.renderer.updating}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view._stage.renderView,t=this.view.state.isGlobal&&h(this._overlaySR)?Jt(this._overlaySR):1;this.renderer=new Oc({renderView:e,globalUnitScale:t}),this._drapeTargetTypes[0]++,this.renderer.onHasHighlightsChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("hasHighlights")},this.renderer.onRendersOccludedChanged=()=>{this._setDrawTexturesDirty(),this.notifyChange("rendersOccluded")},this.renderer.onContentChanged=()=>{this._setDrawTexturesDirty()},this.groundIntersector=new ih(this.view.state.mode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],(()=>this.setOverlayPlacementDirty())),this.surface.on("elevation-change",(()=>this.setOverlayPlacementDirty())),this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0)),this.view.on("resize",(()=>this.setOverlayPlacementDirty())),O({preRender:e=>{this.renderer.commitChanges(),this._updateLayerViews(),this.renderer.hasOverlays&&(this._dispatchRendererUpdate(e),this._drawOverlayTextures(this.renderer.overlays)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),this.view.resourceController.scheduler.registerTask(xr.OVERLAY_MANAGER,(()=>this.updateOverlays()),(()=>this._needsUpdate)),this.view._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this.updateOverlays(e),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays)}))]),this._updateLayerViews()}destroy(){this._drapeSources.forEach(((e,t)=>this.unregisterDrapeSource(t))),this._drapeTargets.forEach((e=>this._unregisterDrapeTarget(e))),this._drapeTargetTypes[0]--,this._disposeOverlays(),this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),h(rO)&&(rO.remove(),rO=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e,t){this._overlaySR=e,this._longitudeCyclical=null;const i=this.view.renderSpatialReference;h(e)&&h(i)?(this._renderSR=i,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical=t,t&&(this._longitudeCyclical=e.isWebMercator?new St(-20037508.342787,20037508.342787):new St(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.globalUnitScale=t&&h(this._overlaySR)?Jt(this._overlaySR):1)):this._disposeOverlays()}getGpuMemoryUsage(){return this.renderer.gpuMemoryUsage}_updateLayerViews(){if(!this._layerViewsDirty)return;const e=new Set;for(const t of this.view.allLayerViews.items)e.add(t.uid),"drapeSourceType"in t&&!this._drapeSources.has(t)&&this._registerDrapeSource(t,0),"drapeTargetType"in t&&!this._drapeTargets.has(t)&&this._registerDrapeTarget(t);this._drapeSources.forEach(((t,i)=>{0!==t||e.has(i.uid)||this.unregisterDrapeSource(i)})),this._drapeTargets.forEach((t=>{e.has(t.uid)||this._unregisterDrapeTarget(t)})),this.renderer.updateLayerOrder(),this._setDrawTexturesDirty(),this._layerViewsDirty=!1}registerDrapeSource(e){this._registerDrapeSource(e,1)}_registerDrapeSource(e,t){this._drapeSourceTypes[e.drapeSourceType]++,this._drapeSources.set(e,t),this.renderer.forEachOverlay(((t,i)=>this._updateDrapeSource(e,i,t))),this._setOverlayContentDirty(),this.notifyChange("_needsUpdate")}_updateDrapeSource(e,t,i){h(e.setDrapingExtent)&&h(this._overlaySR)&&e.setDrapingExtent(t,i.extent,this._overlaySR,i.resolution,i.renderLocalOrigin,i.pixelRatio)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSourceTypes[e.drapeSourceType]--,this._drapeSources.delete(e),this._setOverlayContentDirty(),this.notifyChange("_needsUpdate"))}_registerDrapeTarget(e){this._drapeTargets.add(e),this._updateDrapeTarget(e),this._drapeTargetTypes[e.drapeTargetType]++}_updateDrapeTarget(e){this.renderer.forEachOverlay(((t,i)=>{const r=t.renderTargets,s=this.needsColorWithoutRasterImage()?r.colorWithoutRasterImage:this.hasDrapedFeatures()?r.color:null,a=r.highlight,n=r.water;e.setDrapingTextures(i,t.extent,s&&s.valid?s.fbo.getTexture():null,a.valid?a.fbo.getTexture():null,n.valid?n.fbo.getTexture():null)}))}_unregisterDrapeTarget(e){this._drapeTargets.delete(e),this._drapeTargetTypes[e.drapeTargetType]--}_setOverlayContentDirty(){this.setOverlayPlacementDirty(),this._setDrawTexturesDirty()}setOverlayPlacementDirty(){this._placementDirty=!0}updateOverlays(e=this.view.state.camera){if(!this._overlaySR)return;this._updateLayerViews();const t=function(e,t){const i=Math.max(e,t)+256;return Ve(i)}(e.fullWidth,e.fullHeight),i=Math.min(t,this._maxResolution);this._computeOverlayExtents(e,t,lO);const r=zi(lO.inner)/zi(lO.outer);this.renderer.ensureOverlays();const s=this._updateOverlay(0,lO.inner,i,1),a=this._updateOverlay(1,lO.outer,i,r);(s||a)&&(this.surface.updateTileOverlayParams(),this._setDrawTexturesDirty()),this._placementDirty=!1,this.surface.updateOverlayOpacity()}_updateOverlay(e,t,i,r){if(u(this.renderer.overlays))return!1;const s=this.renderer.overlays[e];if(!function(e,t){const i=1e-5,r=xc.TESTS_DISABLE_UPDATE_THRESHOLDS?0:i*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);for(let i=0;i<4;i++)if(Math.abs(t[i]-e[i])>r)return!0;return!1}(t,s.extent)&&i===s.resolution&&s.pixelRatio===r)return!1;Ni(s.extent,t),s.resolution=i,s.pixelRatio=r;const a=qi(s.extent);return s.renderLocalOrigin=Dc(a[0],a[1],0,"OV_"+this._latestOriginId++),this._drapeSources.forEach(((t,i)=>this._updateDrapeSource(i,e,s))),!0}computeOpacity(e){if(!this.renderer.hasOverlays)return 1;if(3.5*e<this._renderedAltitude){const t=(e-this._renderedAltitude/10)/(this._renderedAltitude/3.5-this._renderedAltitude/10);return Math.sqrt(Re(t,0,1))}return 1}setTileParameters(e){const t=e.renderData.overlay;if(h(this.renderer.overlays)){const i=this.renderer.overlays[0],r=this.renderer.overlays[1],s=Zi(e.extent,e.surface.extent,cO);this._rectInsideRect(s,i.extent)?(this._setTileOverlayData(s,0,t),this._clearTileOverlayData(1,t)):this._rectanglesOverlap(s,i.extent)?(this._setTileOverlayData(s,0,t),this._setTileOverlayData(s,1,t)):this._rectanglesOverlap(s,r.extent)?(this._clearTileOverlayData(0,t),this._setTileOverlayData(s,1,t)):(this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t))}else this._clearTileOverlayData(0,t),this._clearTileOverlayData(1,t)}overlayPixelSizeInMapUnits(e){if(u(this.renderer.overlays))return 0;const t=this.renderer.overlays[0],i=this.renderer.overlays[1],r=this._pointIsInExtent(e,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(u(this.renderer.overlays))return;const r=this.renderer.overlays[t].extent;i.setScale(t,(e[2]-e[0])/(r[2]-r[0]),(e[3]-e[1])/(r[3]-r[1]));let s=e[0];if(this._longitudeCyclical){s=this._longitudeCyclical.minimalMonotonic(r[0],s);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);s>t&&(s=t-(e[2]-e[0]))}i.setOffset(t,(s-r[0])/(r[2]-r[0]),(e[1]-r[1])/(r[3]-r[1]))}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}_disposeOverlays(){this.renderer.disposeOverlays()}async reloadShaders(){tO(),await this.renderer.reloadShaders(),this.updateOverlays()}stopAnimationsAtTime(e){this.renderer.stopAnimationsAtTime(e),this._forceAnimation=!0}_dispatchRendererUpdate(e){const t=oi(e.time-this._animationTimeLast);if(t<eO&&!this._forceAnimation)return;this._animationTimeLast=e.time;this.renderer.updateLogic({dt:t,camera:this.view._stage.getCamera()})&&(this._drawTexturesAnimateDirty=!0)}_setDrawTexturesDirty(){this.renderer.hasOverlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()}_intersectGroundFromView(e,t,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,dO,t,i);if(u(s))return!1;const a=s.origin,n=Qe(oO,s.origin,s.direction);return this.groundIntersector.reset(a,n),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,a,n),this.groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,n=1e-5,o=Re(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+n,e.aboveGround?s-n:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=oO;jo.closestPointOnSilhouette(jo.wrap(Kt(this.view.spatialReference).radius+o),ko.wrap(e.eye,e.viewForward),t),at(t,t,e.eye);const s=Ct.normalize(hl.angleAroundAxis(e.viewForward,t,e.viewRight))/e.fovY+.5,a=s<=0||s>=1?.5:r;i=l?a*s:s+a*(1-s)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),a=Pr(0,s,1,0),n=ws(a,a,e.projectionMatrix)[1],o=Re(.5+.5*n,0,1);i=1===o||0===o?.5:l?o*r:1-(1-o)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&pt(t,e.eye)<a.distance*a.distance}_computeOverlayExtents(e,t,i){const r=this.surface.extent,s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,a=je();this._findHorizonBasedPointOfInterest(e,a)||Xe(a,s),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);const n=Ke(e.eye,a),o=Dm(this.view.renderCoordsHelper,s,e.eye),l=Math.PI/2-Math.abs(o-Math.PI/2);xc.OVERLAY_SHOW_CENTER?(u(rO)&&(rO=new wM(this.view.graphics,"red")),rO.showPoint(a,this._renderSR)):h(rO)&&rO.remove(),this._overlaySREqualsRenderSR||rr(a,this._renderSR,a,this._overlaySR);let c=t*e.perRenderPixelRatio*n/2,d=!1,p=1/0;this._isSpherical&&h(this._overlaySR)&&(this._overlaySR.isWebMercator?(c/=Math.cos(hr.y2lat(a[1])),p=this.surface.extent[3]):(d=!0,c/=Kt(this._overlaySR).metersPerDegree,p=90),c>=p&&(c=p,a[1]=0,this._overlaySR.isWebMercator&&(a[0]=0)));let m=1;d&&(m=1/Math.max(.2,Math.cos(Math.abs(Me(a[1])))),c*m>180&&(m=180/c));const f=Math.log(2)/12;c=Math.exp(Math.round(Math.log(c)/f)*f);const g=c*m,v=.5*t/(32*g),y=.5*t/(32*c);a[0]=Math.round(a[0]*v)/v,a[1]=Math.round(a[1]*y)/y;const _=i.inner;_[0]=a[0]-g,_[1]=a[1]-c,_[2]=a[0]+g,_[3]=a[1]+c,this._isSpherical&&this._shiftExtentToFitBounds(_,1/0,p);const x=i.outer;if(Ni(x,_),6*g>r[2]-r[0])Ni(x,r);else if(l<=.25*Math.PI)x[0]-=g,x[1]-=c,x[2]+=g,x[3]+=c;else{rr(e.eye,this._renderSR,oO,this._overlaySR),ms(nO,a,oO);let t=-Math.atan2(nO[1],nO[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));Cs(nO,iO[i],2*c),nO[0]*=m,nO[2]*=m,Ss(x,x,nO)}if(this._isSpherical&&(x[0]=this._longitudeCyclical.clamp(x[0]),x[2]=this._longitudeCyclical.clamp(x[2]),x[1]=Math.max(x[1],-p),x[3]=Math.min(x[3],p)),!this._isSpherical&&r){const e=Zi(_,r,cO),t=Zi(x,r,hO);$i(e,t)&&(x[2]=x[0],x[3]=x[1])}}_drawOverlayTextures(e){if(u(e)||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const t=this._drawOverlay(e,0),i=this._drawOverlay(e,1);0!==t&&0!==i||this.surface.updateTileOverlayParams(),this._collectUnusedRenderTargetMemory(),this._drapeTargets.forEach((e=>this._updateDrapeTarget(e))),this._drawTexturesDirty?(this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this.surface.requestRender(),this.surface.pendingUpdates=!0):(this._drawTexturesAnimateDirty=!1,this.surface.requestRender(0))}_setupGeometryViewsCyclical(e,t,i){this._setupGeometryViewsDirect(e,t,i);const r=.001*this._longitudeCyclical.range;if(t[0]-r<=this._longitudeCyclical.min){const r=e.views[e.numViews++];bs(r.viewport,0,0,i,i),Vi(t,this._longitudeCyclical.range,0,r.extent)}if(t[2]+r>=this._longitudeCyclical.max){const r=e.views[e.numViews++];bs(r.viewport,0,0,i,i),Vi(t,-this._longitudeCyclical.range,0,r.extent)}}_setupGeometryViewsDirect(e,t,i){e.numViews=1;const r=e.views[0];Ni(r.extent,t),bs(r.viewport,0,0,i,i)}_drawOverlay(e,t){const i=e[t],r=i.computeRenderTargetValidityBitfield(),{extent:s,resolution:a,pixelRatio:n}=i;this._longitudeCyclical?this._setupGeometryViewsCyclical(aO,s,a):this._setupGeometryViewsDirect(aO,s,a),aO.width=a,aO.height=a,aO.pixelRatio=n*this.view.state.camera.pixelRatio,aO.index=t,i.drawRenderTargets(this.renderer,aO,this.needsColorWithoutRasterImage());return r^i.computeRenderTargetValidityBitfield()?0:1}needsColorWithoutRasterImage(){return this._drapeSourceTypes[0]>0&&this._drapeSourceTypes[1]>0&&this._drapeTargetTypes[1]>0}hasDrapedFeatures(){return this._drapeSourceTypes[1]>0}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this.renderer.forEachOverlay((t=>this._hasUnusedRenderTargets=t.collectUnusedMemory(e)||this._hasUnusedRenderTargets))}}_rectanglesOverlap(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):ji(e,t)}_rectInsideRect(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:$i(t,e)}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),Vi(e,r,s)}get test(){return{renderer:this.renderer}}};e([S()],sO.prototype,"_overlaySR",void 0),e([S({readOnly:!0})],sO.prototype,"_needsUpdate",null),e([S()],sO.prototype,"_placementDirty",void 0),e([S()],sO.prototype,"_layerViewsDirty",void 0),e([S()],sO.prototype,"renderer",void 0),e([S({constructOnly:!0})],sO.prototype,"surface",void 0),e([S({readOnly:!0,aliasOf:"surface.suspended"})],sO.prototype,"suspended",void 0),e([S({readOnly:!0})],sO.prototype,"updating",null),e([S({type:Boolean})],sO.prototype,"hasHighlights",null),e([S({type:Boolean})],sO.prototype,"rendersOccluded",null),sO=e([re("esri.views.3d.terrain.OverlayManager")],sO);const aO={width:0,height:0,pixelRatio:0,views:[{viewport:Li(),extent:Li()},{viewport:Li(),extent:Li()},{viewport:Li(),extent:Li()}],numViews:0,index:0},nO=Tr(),oO=je(),lO={inner:Li(),outer:Li()},cO=Li(),hO=Li(),dO=ko.create();class uO{constructor(e,t){this._factoryCallback=e,this._lengthCallback=t,this._pool=new Map}acquire(e){if(!uO.test.disabled){const t=this._pool.get(e);if(t&&0!==t.length)return t.pop()}try{return this._factoryCallback(e)}catch(t){const i=window.performance&&window.performance.memory;let r="";throw i&&(r=`\n  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+t+r),t}}release(e){if(uO.test.disabled)return;const t=this._lengthCallback(e);let i=this._pool.get(t);i||(i=new R({shrink:!0}),this._pool.set(t,i)),i.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}uO.test={disabled:!1};const pO=Io().vec3f(Ll.POSITION).vec2f(Ll.UV0),mO=new uO((e=>pO.createBuffer(e)),(e=>e.count));class fO{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=Bs(),this.numSurfaceIndices=0,this.numSkirtIndices=0,this.numWithoutSkirtIndices=0,this.numVertsPerRow=0,this.skirtLength=0,this.uvOffsetAndScale=Tr()}}class gO{constructor(e,t,i){this.values=e,this.numSurfaceIndices=t,this.numSkirtIndices=i}}const vO=new Map;function yO(e,t,i,r){const s=(2&i)>0,a=t+(r?1024:0)+(s?2048:0);let n=vO.get(a);n||(n=function(e,t,i){const r=e-1,s=e-1,a=e*e,n=2*r+2*s;let o=r*s*2*3,l=6*n,c=6*(2*r+s-1);i&&(o*=2,l*=2,c*=2);const h=a+n>65536?new Uint32Array(o+l):new Uint16Array(o+l);let d,u,p,m,f=0,g=0,v=o,y=0;for(let e=0;e<=s;e++){t&&(y=0===e?c:e===s?-c:0),v+=y;for(let t=0;t<=r;t++){const n=bO(t,e,r,s);if(n>-1){const o=wO(t,e,r,s);0!==o&&(d=f,u=a+n,p=a+(0===t&&1===e?0:n+1),m=f+o,i?(h[v+0]=d,h[v+1]=u,h[v+2]=u,h[v+3]=p,h[v+4]=p,h[v+5]=d,h[v+6]=p,h[v+7]=m,h[v+8]=m,h[v+9]=d,h[v+10]=d,h[v+11]=p,v+=12):(h[v+0]=d,h[v+1]=u,h[v+2]=p,h[v+3]=p,h[v+4]=m,h[v+5]=d,v+=6))}++f,t<r&&e<s&&(d=e*(r+1)+t,u=d+1,p=u+(r+1),m=p-1,i?(h[g+0]=d,h[g+1]=u,h[g+2]=u,h[g+3]=p,h[g+4]=p,h[g+5]=d,h[g+6]=p,h[g+7]=m,h[g+8]=m,h[g+9]=d,h[g+10]=d,h[g+11]=p,g+=12):(h[g+0]=d,h[g+1]=u,h[g+2]=p,h[g+3]=p,h[g+4]=m,h[g+5]=d,g+=6))}v-=y}return new gO(h,o,l)}(t,s,r),vO.set(a,n)),e.indices=n.values,e.numSurfaceIndices=n.numSurfaceIndices,e.numSkirtIndices=n.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(i?6*(t-1)*(r?2:1):0)}function _O(e,t,i,r){e<r[0]&&(r[0]=e),e>r[3]&&(r[3]=e),t<r[1]&&(r[1]=t),t>r[4]&&(r[4]=t),i<r[2]&&(r[2]=i),i>r[5]&&(r[5]=i)}function xO(e,t){const i=t>e?1:0;return 2+4*i+(1-2*i)*(e+t)}function bO(e,t,i,r){return 0===t?e:e===i?i+t:t===r?i+r+(i-e):0===e&&t>0?2*i+r+(r-t):-1}function wO(e,t,i,r){return 0===t&&e!==i?1:e===i&&t!==r?i+1:t===r&&0!==e?-1:0===e&&0!==t?-(i+1):0}function CO(e,t,i,r,s,a,n,o,l){const c=a.position,d=a.uv0,u=e[0],p=e[1],m=e[2],f=t[0]-u,g=t[1]-p,v=t[2]-m;r*=3;for(let e=i*=3;e<r;e+=3){const t=s[e],i=s[e+1],r=s[e+2];let a=c.get(t,0),y=c.get(t,1),_=c.get(t,2),x=c.get(i,0),b=c.get(i,1),w=c.get(i,2),C=c.get(r,0),S=c.get(r,1),T=c.get(r,2);const P=d.get(t,0),R=d.get(i,0),M=d.get(r,0);P>=2&&(Ye(MO,a,y,_),n(MO),a+=MO[0],y+=MO[1],_+=MO[2]),R>=2&&(Ye(MO,x,b,w),n(MO),x+=MO[0],b+=MO[1],w+=MO[2]),M>=2&&(Ye(MO,C,S,T),n(MO),C+=MO[0],S+=MO[1],T+=MO[2]),h(o)&&([a,y,_]=o.applyToVertex(a,y,_),[x,b,w]=o.applyToVertex(x,b,w),[C,S,T]=o.applyToVertex(C,S,T));const O=x-a,D=b-y,A=w-_,E=C-a,I=S-y,L=T-_,F=g*L-I*v,V=v*E-L*f,z=f*I-E*g,U=O*F+D*V+A*z,k=u-a,j=p-y,G=m-_,B=j*A-D*G,N=G*O-A*k,q=k*D-O*j;if(U>2220446049250313e-31){const e=k*F+j*V+G*z;if(e<0||e>U)continue;const t=f*B+g*N+v*q;if(t<0||e+t>U)continue}else{if(!(U<-2220446049250313e-31))continue;{const e=k*F+j*V+G*z;if(e>0||e<U)continue;const t=f*B+g*N+v*q;if(t>0||e+t<U)continue}}const H=(E*B+I*N+L*q)/U;if(H>=0){l(H,oo(O,D,A,E,I,L,OO))}}}const SO=new Array(La+1),TO=new Array(La+1),PO=new Array(La+1),RO=new Array(La+1),MO=je(),OO=je(),DO=new Error("Abstract method called on TileAgent");class AO{constructor(){}get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.disposeData(),this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),r=gd(i),{minLevel:s,maxLevel:a}=i.dataLevelRange,n=this._desiredMinLevelDelta,o=this._loadingLevelDelta+n,l=this._scaleRangeEnabled?Hd:()=>!0;let c,h=this.tile,d=0;const p=this._tileLayerInfo.upsampleInfo,m=p?p.tile.level:-1,f=g(r,"tilemapCache");for(;h&&l(h,r,!1)&&h.level>=s;){const i=h.level,r=h.layerInfo[t][e];if(r.data&&d>=n){i>m&&this._setUpsampleTile(h),r.dataInvalidated&&(c=h);break}if((u(f)||"unavailable"!==f.getAvailability(h.lij[0],h.lij[1],h.lij[2]))&&i<=a&&!r.data&&!r.dataMissing&&((!c||i%Va==0||this.tile.level-c.level<n)&&(c=h),d>=o))break;h=h.parent,d++}return c&&this.tile.level-c.level<n&&this._tileLayerInfo.upsampleInfo&&(c=null),c}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}const EO=new class extends AO{get _desiredMinLevelDelta(){throw DO}get _loadingLevelDelta(){throw DO}};class IO extends AO{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return za-(this.tile.vlevel-this.tile.lij[0])}get _loadingLevelDelta(){return 0}}class LO extends AO{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _loadingLevelDelta(){return 8}}class FO{constructor(e,t){this._pool=t,this.waitingAgents=[],this.data=null,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0,this.elevationBounds=void 0,this.init(e)}init(e){this.waitingAgents.length=0,this.data=null,this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0,0===e&&(this.elevationBounds=null)}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestPromise&&(this.requestAbort.abort(),this.requestPromise=null,this.requestAbort=null)}dispose(){this.loadingAgent&&this.loadingAgent!==EO&&this.loadingAgent.dispose(),this.loadingAgent=null,this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this.disposeData()}disposeData(){this.data=vd(this.data)}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),Wd(e,t,this._upsampleInfo)}else this._unsetUpsampleInfo()}static makeEmptyLayerInfo(e,t,i){return i?(i.init(e),i):new FO(e,t)}}const VO=bd,zO=je(),UO=je(),kO=je(),jO=Tr();class GO{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class BO{constructor(e){this._numSubdivisionAtLevel=e,this.lij=[0,0,0],this._children=[null,null,null,null],this._dirty=!0,this._previouslyRendered=!1,this.extent=Li(),this._elevationBounds=cn(),this.layerInfo=new Array(2),this.extentInRadians=Li(),this.centerAtSeaLevel=je(),this._center=[je(),je(),je()],this.up=qe(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._maxTesselation=0,this._usedMemory=QO,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._radius=0,this._curvatureHeight=0}get usedMemory(){return this._usedMemory===QO&&this._updateMemoryUsed(),this._usedMemory+(this.isCached?0:this.mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){this._usedMemory===QO&&this._updateMemoryUsed();let e=this._mapTileMemory;for(const{data:t}of this.layerInfo[1])t instanceof zd&&(e+=t.getMemoryUsage());return e}get isCached(){return!this.shouldRender&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get numSubdivisionsAtLevel(){return this._numSubdivisionAtLevel}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get edgeLen(){return this._edgeLen}get radius(){return this._radius}get screenDepth(){return this._screenDepth}get visible(){if(this._dirty){const e=this._isVisible();e!==this._visible&&(this._visible=e,this.updateAgentSuspension(),this.surface.emit("tiles-visibility-changed"),this.surface.renderer.setNeedsRender()),this._dirty=!1}return this._visible}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this.surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this.surface.renderer.setNeedsRender()),e}get shouldRender(){if(!this.visible)return!1;if(1===this.surface.lodSnapping){const e=this.level-this._surface.snapLevel;if(0===e)return!0;if(1===e)return!1}return this.isLeaf}init(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=Kt(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(Zd(this)),this._edgeLen=0,this._edgeLen2=0,this._radius=0,this.vlevel=e?e[0]:0,t&&t._elevationBounds?hs(this._elevationBounds,t.elevationBounds):ls(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(let e=0;e<2;e++){const t=i.numLayers(e);let r=this.layerInfo[e];this.layerInfo[e]?r.length=t:(r=new Array(t),this.layerInfo[e]=r);for(let i=0;i<t;i++)r[i]=FO.makeEmptyLayerInfo(e,this._surface.upsampleInfoPool,r[i]),0===e&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,La)}release(){VO(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(Zd(this));for(let e=0;e<2;e++)for(const t of this.layerInfo[e])t.dispose();this._parent=null,this._surface=null,this._usedMemory=QO}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(Zd(this))}unrefMapData(){if(--this._mapDataRefCount,this.isCached){const e=this.cachedMemory;e>0&&(this._surface.upsampleMapCache.put(Zd(this),this,e),this.setMemoryDirty())}}setMemoryDirty(){this._usedMemory=QO}get cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_updateMemoryUsed(){this._usedMemory=0,this._mapTileMemory=0;const e=this.cpuImageMemorySize;for(const t of this.layerInfo[1]){const i=t.data;i instanceof yd?this._mapTileMemory+=rc(i.texture):i instanceof HTMLImageElement||i instanceof _d?this._mapTileMemory+=e:i instanceof xd&&(this._mapTileMemory+=i.getMemoryUsage())}for(const t of this.layerInfo[0])this._usedMemory+=t.data?e:0;if(this.renderData){this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage;const e=this.renderData.textureDescriptor;e&&(this._mapTileMemory+=rc(e))}this.isCached&&this._surface.upsampleMapCache.updateSize(Zd(this),this,this.cachedMemory)}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];if(!i||!i.data)return 0;if(1!==e||this.isCached){if(0===e)return this.cpuImageMemorySize}else{const e=i.data;if(e instanceof yd)return rc(e.texture);if(e instanceof HTMLImageElement||e instanceof _d)return this.cpuImageMemorySize;if(e instanceof zd||e instanceof xd)return e.getMemoryUsage()}return 0}updateScreenDepth(e){Xe(jO,this._center[0]),jO[3]=1,ws(jO,jO,e),this._screenDepth=jO[2]<0?0:jO[2]/jO[3]}shouldSplit(e,t,i){const r=this.level;at(zO,this._center[0],t);let s=et(zO),a=0;at(UO,this._center[1],t);const n=et(UO);n<s&&(s=n,a=1),at(UO,this._center[2],t);const o=et(UO);if(o<s&&(s=o,a=2),this._edgeLen2>s&&r<e.maxLod)return 2;const l=Math.sqrt(s),c=e.fovX*l*2,h=this._edgeLen/c,d=()=>{const t=r+Math.ceil(-ze(e.relativeWidthLimit/h));return t!==this.vlevel?(this.vlevel=t,4):1};if(1===i){if(1===this._surface.snapLevel-r)return r>=e.maxLod?d():2}const u=st(this.up,zO),p=this._elevationBounds[1]-this._elevationBounds[0],m=p/this.edgeLen;if(e.aboveGround&&u>0&&m<.001){if(u/l-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-m>0)return 0}if(h<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,4):0;if(r>=e.maxLod)return d();if(r>6){at(UO,this._center[a],t),Ze(kO,this.up,u),at(kO,kO,UO);const i=et(kO);if(i>this._radius*this._radius){Ze(kO,kO,this._radius/Math.sqrt(i)),Qe(kO,kO,this._center[a]),at(kO,t,kO);const r=Math.min(1,(Math.abs(st(kO,this.up))+.5*p+this._curvatureHeight)/$e(kO)),s=.1/e.angledSplitBias,n=e.fovY*l*2;if(r*(this._edgeLen/n)<s*e.relativeHeightLimit)return 0}}return 2}setChildren(e,t,i,r){VO(!!(e&&t&&i&&r),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=r}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}load(e){this.refMapData();for(let e=0;e<2;e++){this.layerInfo[e]&&this._createOrUpdateAgents(0,e)}e.loadTile(this)}unload(e){e.unloadTile(this);for(let e=0;e<2;e++){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==EO&&(qO(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(32),this.resetPendingUpdate(64),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==EO&&(qO(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(Xi(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;e?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this.isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._isWithinClippingArea,s=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||r||s||this.setPendingUpdate(32),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(let e=0;e<2;e++){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==EO&&e.loadingAgent.updating)return!0}return!1}isSuspended(e){return!!this.hasPendingUpdate(2)||0!==e&&!this.visible}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,2===e||8===e?this._surface.setTileTreeDirty():this._surface.pendingUpdates=!0}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.indexOf(i)>-1)return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),i.dataArrived(this),!0;if(r.requestPromise)return!0;r.requestAbort=z();const s=this._surface.requestTileData(this,e,t,r.requestAbort);if(!s)return r.requestAbort=null,!1;const a=()=>{r.requestPromise===s&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=s,s.then(a,a),!!r.requestPromise}get isLeaf(){return null==this._children[0]}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;if(this.isLeaf)return null;const t=this._children[0].findByLij(e)||this._children[1].findByLij(e)||this._children[2].findByLij(e)||this._children[3].findByLij(e);return t||null}distanceToSquared(e){return et(at(kO,this._center[0],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],s=r.waitingAgents,a=null!=A(s,i);VO(a,"agent has not requested this piece of map data"),s.length<1&&(r.abortRequest(),this._updateMemoryUsed())}dataArrived(e,t,i){const r=this.layerInfo[t][e];r.data=i,r.dataInvalidated=!1;for(let e=0;e<r.waitingAgents.length;e++)r.waitingAgents[e].dataArrived(this);r.waitingAgents.length=0,this._updateMemoryUsed()}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const r=this.layerInfo[t][e];r.dataMissing=!0;for(let e=0;e<r.waitingAgents.length;e++)r.waitingAgents[e].dataMissing();r.waitingAgents.length=0,this._updateMemoryUsed()}updateRenderData(e){switch(e){case 1:return this.updateTexture();case 0:return this.updateGeometry()}}updateTexture(){this.renderData&&this.setPendingUpdate(64)}updateGeometry(){this.setPendingUpdate(32);for(const e of this.layerInfo[0])e.pendingUpdates|=32}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){ls(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const e=this.layerInfo[0];let t=!0;for(const i of e)i.elevationBounds&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],i.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],i.elevationBounds.max),i.elevationBounds.hasNoDataValues||(t=!1));t&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0)),this.updateRadiusAndCenter(),this.surface.setTileTreeDirty()}_updateCenter(){const e=.5*(this._elevationBounds[0]+this._elevationBounds[1]);Ze(kO,this.up,e),Qe(this._center[0],this.centerAtSeaLevel,kO),Ze(kO,this.up,this._elevationBounds[0]),Qe(this._center[1],this.centerAtSeaLevel,kO),Ze(kO,this.up,this._elevationBounds[1]),Qe(this._center[2],this.centerAtSeaLevel,kO)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[0][e];if(!i.elevationBounds||i.elevationBounds.level<t){const t=this._surface.layerViewByIndex(e,0),r=gd(t);if(Hd(this,r,!1)){const t=ZO;let r=!1;if(i.data){const e=i.data;t.min=e.bounds[0],t.max=e.bounds[1],t.hasNoDataValues=e.hasNoDataValues,t.level=this.lij[0],r=!0}else{let i,s,a=0;for(let t=this._parent;t&&(!s||a<za)&&(a=this.vlevel-t.level,i=s||i,s=t.layerInfo[0][e].data,!(!s&&i&&a>=za));t=t._parent);s=s||i,s&&(s.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],t),t.min!==1/0&&(t.level=s.level,r=!0))}r&&(i.elevationBounds||(i.elevationBounds=new XM),i.elevationBounds.copyFrom(t))}}}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const e of r)e.loadingAgent&&e.loadingAgent!==EO&&(qO(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.length=0;if(1===i)for(let t=0;t<r.length;++t)void 0===e[t]&&r[t].dispose();const s=t.length,a=new Array(s);for(let e=0;e<s;e++){const s=t[e];a[e]=s>-1?r[s]:FO.makeEmptyLayerInfo(i,this._surface.upsampleInfoPool)}this.layerInfo[i]=a,this._updateMemoryUsed()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(let e=0;e<t.length;e++){const i=t[e];i.loadingAgent===EO&&(i.loadingAgent=null)}this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(let e=0;e<2;e++){const t=this.isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==EO&&(i.loadingAgent.setSuspension(t),i.loadingAgent===EO&&this.updateRenderData(e))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==EO&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=EO,i.data||i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_createOrUpdateAgents(e,t){const i=this.isSuspended(t),r=this.layerInfo[t];for(let s=e;s<r.length;++s){const e=r[s];let a=!1;const n=this._surface.layerViewByIndex(s,t),o=gd(n);if(e.loadingAgent?Hd(this,o,!1)?(e.loadingAgent!==EO&&e.loadingAgent.setSuspension(i),e.loadingAgent!==EO&&(a=e.loadingAgent.update())):e.dispose():Hd(this,o,!1)&&(e.loadingAgent=NO(this,s,t,i),a=e.loadingAgent.startLoading(),a?e.loadingAgent===EO&&this.setPendingUpdate(32):(qO(e.loadingAgent),e.loadingAgent=EO)),e.loadingAgent===EO&&this.updateRenderData(t),a&&n.isOpaque)return}}isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}get test(){return{cachedMemory:this.cachedMemory}}}function NO(e,t,i,r){const s=0===i?WO.acquire():HO.acquire();return s.init(e,t,i,r),s}function qO(e){e.dispose(),e instanceof IO?WO.release(e):e instanceof LO&&HO.release(e)}const HO=new t(LO),WO=new t(IO),ZO=new XM,QO=-1;class YO extends BO{constructor(e,t,i){super(YO.NumSubdivisionsAtLevel),void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i),this._edgeLen=this.extent[2]-this.extent[0],this._edgeLen2=this._edgeLen*this._edgeLen,this.centerAtSeaLevel[0]=De(this.extent[0],this.extent[2],.5),this.centerAtSeaLevel[1]=De(this.extent[1],this.extent[3],.5),this.centerAtSeaLevel[2]=0,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=(this.extent[2]-this.extent[0])*Math.SQRT1_2,t=.5*(this.elevationBounds[0]-this.elevationBounds[1]);this._radius=Math.sqrt(e*e+t*t)}_isVisible(){return this.intersectsClippingArea&&nl.intersectsAABB(this.surface.frustum.planes,ca(this.extent[0],this.extent[1],this.elevationBounds[0],this.extent[2],this.extent[3],this.elevationBounds[1]))}createGeometry(e,t){!function(e,t,i,r){const s=t[0],a=t[1],n=t[2]-s,o=t[3]-a,l=e.clippingArea,c=l?Math.max(0,(l[0]-t[0])/n):0,h=l?Math.max(0,(l[1]-t[1])/o):0,d=l?Math.min(1,(l[2]-t[0])/n):1,u=l?Math.min(1,(l[3]-t[1])/o):1,p=d>c?1/(d-c):1,m=u>h?1/(u-h):1,f=-c*p,g=-h*m,v=.1*n,y=e.numVertsPerRow-1,_=e.numVertsPerRow-1,x=e.numVertsPerRow*e.numVertsPerRow,b=2*y+2*_,w=mO.acquire(x+b),C=w.position.typedBuffer,S=w.uv0.typedBuffer,T=r.geometryInfo.boundingBox;Bs(T);let P=0;for(let t=0;t<=_;t++){const r=t/_;let c=g+r*m,h=a+r*o;l&&(h<l[1]?(h=l[1],c=0):h>l[3]&&(h=l[3],c=1));for(let r=0;r<=y;r++){const a=r/y;let o=f+a*p,d=s+a*n;l&&(d<l[0]?(d=l[0],o=0):d>l[2]&&(d=l[2],o=1));const u=e.samplerData&&KM.sample(d,h,e.samplerData)||0,m=d-i[0],g=h-i[1],_=u-i[2];_O(m,g,_,T);const b=Fa*P;C[b+0]=m,C[b+1]=g,C[b+2]=_,S[b+0]=o,S[b+1]=c;const w=bO(r,t,y,y);if(w>-1){const e=Fa*(x+w);C[e+0]=m,C[e+1]=g,C[e+2]=_,S[e+0]=xO(o,c),S[e+1]=v}++P}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=w,r.geometryInfo.skirtLength=v,bs(r.geometryInfo.uvOffsetAndScale,c,h,d-c,u-h),yO(r.geometryInfo,e.numVertsPerRow,0,e.wireframe)}(e,this.extent,t,this.renderData),this.setMemoryDirty()}}YO.NumSubdivisionsAtLevel=[2,2,2,2,2,2,2,2];class $O extends BO{constructor(e,t,i){super(XO),this.obb=new Array(8),this.isWebMercator=!1;for(let e=0;e<8;e++)this.obb[e]=je();void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i),this.isWebMercator=i.tilingScheme.spatialReference.isWebMercator;const r=this.ellipsoid.radius,s=this.extentInRadians[0],a=this.extentInRadians[1],n=this.extentInRadians[2],o=this.extentInRadians[3],l=e[0],c=De(a,o,.5),h=De(s,n,.5),d=0===l?0:Math.min(Math.abs(a),Math.abs(o));this._edgeLen=(n-s)*Math.cos(d)*r,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=r-Math.sqrt(r*r-this._edgeLen2/4),dr(this.centerAtSeaLevel,h,c,this.ellipsoid.radius,0);const u=Ne(this.centerAtSeaLevel);nt(u,u),this.up=u,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(0===this.lij[0])Ye(this._center[0],0,0,0),Ye(this._center[1],0,0,0),Ye(this._center[2],0,0,0),this.ellipsoid||(this.ellipsoid=Kt(this.surface.tilingScheme.spatialReference)),this._radius=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const e=Math.max(ot(this._center[0],this.obb[0]),ot(this._center[0],this.obb[1]));this._radius=Math.sqrt(e)}}_isVisible(){if(!this.intersectsClippingArea)return!1;const e=this.lij[0],t=this.surface.frustum.planes;if(e<10)return nl.intersectsSphere(t,jo.wrap(this._radius,this._center[0]));const i=this.obb;for(let e=0;e<6;e++){let r,s=t[e];for(4===e&&(s=dl(s,KO),KO[3]-=this.surface.view.state.camera.near),r=0;r<8&&!ul(s,i[r]);r++);if(8===r)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(e,t){const i=this._isPole(this.lij[1],this.lij[0]);!function(e,t,i,r,s,a,n,o){const l=s[0],c=s[1],h=s[2],d=s[3],u=.1*n.radius*(d-c),p=e.numVertsPerRow-1,m=e.numVertsPerRow-1,f=e.numVertsPerRow*e.numVertsPerRow,g=2*p+2*m,v=mO.acquire(f+g),y=v.position.typedBuffer,_=v.uv0.typedBuffer,x=r.geometryInfo.boundingBox;Bs(x);const b=t[2]-t[0],w=t[3]-t[1],C=h-l,S=i[0],T=i[1],P=i[2];for(let e=0;e<=p;e++){const i=e/p,r=l+i*C;SO[e]=Math.sin(r),TO[e]=Math.cos(r),PO[e]=i,RO[e]=t[0]+i*b}const R=a&&!!(1&o),M=a&&!!(2&o);let O=0;for(let i=0;i<=m;i++){let r=i/m;const s=De(c,d,r),o=Math.cos(s),l=Math.sin(s);let h;a?(h=n.halfSemiMajorAxis*Math.log((1+l)/(1-l)),r=(h-t[1])/w):h=180*s/Math.PI;for(let t=0;t<=p;t++){const s=PO[t],a=SO[t],c=TO[t];let d=n.radius;e.samplerData&&(d+=KM.sample(RO[t],h,e.samplerData)||0);const g=c*o*d-S,v=a*o*d-T,b=l*d-P;_O(g,v,b,x);const w=Fa*O;y[w+0]=g,y[w+1]=v,y[w+2]=b,_[w+0]=s,_[w+1]=r;const C=bO(t,i,p,m);if(C>-1){const e=Fa*(f+C),t=R&&0===i?-1:M&&i===m?1:0,a=0===t?g:-S,o=0===t?v:-T,l=0===t?b:n.radius*t-P;y[e+0]=a,y[e+1]=o,y[e+2]=l,_[e+0]=0===t?xO(s,r):s,_[e+1]=0===t?u:r,0!==t&&_O(a,o,l,x)}++O}}r.geometryInfo.numVertsPerRow=e.numVertsPerRow,r.geometryInfo.vertexAttributes=v,r.geometryInfo.skirtLength=u,bs(r.geometryInfo.uvOffsetAndScale,0,0,1,1),yO(r.geometryInfo,e.numVertsPerRow,a?o:0,e.wireframe)}(e,this.extent,t,this.renderData,this.extentInRadians,this.isWebMercator,this.ellipsoid,i),this.setMemoryDirty()}_updateOBB(){const e=this.extentInRadians,t=this.obb;for(let i=0;i<2;i++){const r=this.elevationBounds[i];let s=4*i;dr(t[s++],e[0],e[1],this.ellipsoid.radius,r),dr(t[s++],e[0],e[3],this.ellipsoid.radius,r),dr(t[s++],e[2],e[3],this.ellipsoid.radius,r),dr(t[s++],e[2],e[1],this.ellipsoid.radius,r)}if(this.isWebMercator){const e=this._isPole(this.lij[1],this.lij[0]);2===e?(Ye(t[1],0,0,this.ellipsoid.radius),Ye(t[2],0,0,this.ellipsoid.radius),Ye(t[5],0,0,this.ellipsoid.radius),Ye(t[6],0,0,this.ellipsoid.radius)):1===e&&(Ye(t[0],0,0,-this.ellipsoid.radius),Ye(t[3],0,0,-this.ellipsoid.radius),Ye(t[4],0,0,-this.ellipsoid.radius),Ye(t[7],0,0,-this.ellipsoid.radius))}}_isPole(e,t){let i=0;return e===(1<<t)-1&&(i+=1),0===e&&(i+=2),i}}const XO=[128,64,32,16,16,8,8,4],KO=Zo();let JO=class extends T{constructor(e){super(e),this._handles=new $t}initialize(){this._handles.add([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents(this.layerViews,this.spatialReference)}set spatialReference(e){this.tilingScheme||this._set("spatialReference",e)}set tilingScheme(e){this._set("tilingScheme",e),this._set("spatialReference",e.spatialReference)}_computeStencilEnabledExtents(e,t){const i=[];for(const r of e.items){const e=r.layer;if("IntegratedMeshLayer"===e.operationalLayerType&&null!=t){const r=iD(e.fullExtent,t);null!=r&&i.push(Ki(r))}}return i}};e([S({readOnly:!0,dependsOn:[],autoTracked:!1})],JO.prototype,"layerViewsExtent",null),e([S({readOnly:!0,dependsOn:["spatialReference","tilingScheme"],autoTracked:!1})],JO.prototype,"tiledLayersExtent",null),e([S({readOnly:!0,dependsOn:["spatialReference"],autoTracked:!1})],JO.prototype,"stencilEnabledExtents",null),e([S()],JO.prototype,"spatialReference",null),e([S()],JO.prototype,"tilingScheme",null),e([S()],JO.prototype,"defaultTiledLayersExtent",void 0),e([S({constructOnly:!0})],JO.prototype,"layers",void 0),e([S({constructOnly:!0})],JO.prototype,"layerViews",void 0),JO=e([re("esri.views.3d.terrain.SurfaceExtentHelperBase")],JO);let eD=class extends JO{_computeLayerViewsExtent(){return this._getGlobalExtent()}_computeTiledLayersExtent(){return this._getGlobalExtent()}_getGlobalExtent(){return this.spatialReference.isWebMercator?Ua:ka}};e([S({dependsOn:["spatialReference"]})],eD.prototype,"layerViewsExtent",void 0),eD=e([re("esri.views.3d.terrain.SurfaceExtentHelperGlobal")],eD);let tD=class extends JO{initialize(){this._handles.add([this.layers.on("change",(e=>this._handleLayersChanged(e))),this.layerViews.on("change",(()=>this.notifyChange("layerViewsExtent")))])}_handleLayersChanged(e){for(const t of e.removed)this._handles.remove(t.uid);for(const t of e.added)this._handles.add(hi(t,"loaded",(()=>this.notifyChange("tiledLayersExtent"))),t.uid)}_computeLayerViewsExtent(){const e=Fi(),t=this.spatialReference;this.layerViews.forEach((i=>{if(i.isResolved()){const r=iD("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);r&&ki(e,r)}}));const i=Gi(e)?e:null,r=this._get("layerViewsExtent");return Xi(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.spatialReference,i=Fi();this.layers.forEach((function(r){if(r.loaded&&Ca(r)){const{tileInfo:s,fullExtent:a}=wd(r,t,2);(s&&Cd(r)&&a||s&&e.compatibleWith(s)&&a&&a.spatialReference.equals(t))&&ki(i,a)}})),this.defaultTiledLayersExtent&&ki(i,this.defaultTiledLayersExtent);const r=Gi(i)?i:null,s=this._get("tiledLayersExtent");return Xi(r,s)?s:r}};function iD(e,t){return e&&!e.spatialReference.equals(t)&&(e=Se(e.spatialReference,t)?Te(e,t):null),e}tD=e([re("esri.views.3d.terrain.SurfaceExtentHelperLocal")],tD);let rD=class extends T{constructor(e){super(e),this._changeHandles=new $t}initialize(){this._changeHandles.add(this.layers.on("change",(()=>this._update()))),this._changeHandles.add(this.extentHelper.watch("layerViewsExtent",(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._changeHandles.destroy(),this._changeHandles=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this._set("tilingSchemeDone",!1),this.layers.some((t=>!(!Ca(t)||t.isRejected())&&(!(t.isFulfilled()&&!function(e,t,i){return!!wd(e,t,i).tileInfo}(t,this.viewSpatialReference,this.manifold))&&(e=t,"vector-tile"!==t.type&&!Cd(t))))),e)if(e.isResolved()){const t=e,{tileInfo:i}=wd(t,this.viewSpatialReference,this.manifold),r=new ja(i);this._set("tilingSchemeDone",!0),this._lockTilingScheme(r)}else this._updateWhen(e);else this._set("tilingSchemeDone",!0)}_updateWhen(e){const t=e.when().catch((e=>e)).then((()=>{t===this._waitTask&&this._update()}));this._waitTask=t}_lockTilingScheme(e){if("spherical"===this.manifold){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=ja.makeWebMercatorAuxiliarySphere(t):er(e.spatialReference)&&(e=ja.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._changeHandles.removeAll(),this._changeHandles.add(this.extentHelper.watch("tiledLayersExtent",(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this.extent=this.extentHelper.tiledLayersExtent}_setAdHocTilingScheme(){if("spherical"===this.manifold){const e=this.extentHelper.spatialReference,t=er(e)||pe(e)||me(e);e.isWebMercator?this.tilingScheme=ja.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=ja.makeGCSWithTileSize(e,256)),this.extent=this.extentHelper.layerViewsExtent}else{const e=this.extentHelper.layerViewsExtent;e&&(this.tilingScheme=ja.fromExtent(e,this.extentHelper.spatialReference),this.extent=e)}}};e([S()],rD.prototype,"tilingScheme",void 0),e([S()],rD.prototype,"extent",void 0),e([S({value:!1})],rD.prototype,"tilingSchemeLocked",void 0),e([S({readOnly:!0,value:!1})],rD.prototype,"tilingSchemeDone",void 0),e([S({constructOnly:!0})],rD.prototype,"viewSpatialReference",void 0),e([S({constructOnly:!0})],rD.prototype,"layers",void 0),e([S({constructOnly:!0})],rD.prototype,"extentHelper",void 0),e([S({constructOnly:!0})],rD.prototype,"manifold",void 0),rD=e([re("esri.views.3d.terrain.SurfaceTilingSchemeLogic")],rD);var sD=rD;class aD{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=p(this._current),this._next=p(this._next),this._waiting=p(this._waiting),this._delayed=p(this._delayed)}get current(){if(u(this._current))return null;if(!this._isFading){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}const e=performance.now();if(h(this._delayed)&&e>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null),h(this._next)){const t=this._fadeDuration;e-this._fadeStart>=t&&(p(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=e)}return this._current}get next(){return this._next}get fadeFactor(){if(u(this._next))return 1;const e=performance.now()-this._fadeStart,t=this._fadeDuration;return e>t?0:1-e/t}get isFading(){return h(this._next)||h(this._delayed)}push(e,t,i,r,s=0){this._delayed=p(this._delayed);const a=h(e)?new nD(e,t,i,r):null;this._push(a,s)}_push(e,t){if(this._isFading||this.clear(),u(this._current))return void(this._current=e);const i=performance.now();return 0!==t?(this._delayed=e,void(this._delayedTime=i+t)):u(this._next)?(this._next=e,void(this._fadeStart=i)):void(u(e)||(p(this._waiting),this._waiting=e))}get _fadeDuration(){return u(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}get _isFading(){return this._getFadeDuration()>0}}class nD{constructor(e,t,i,r){this.texture=e,e.retain(),this.offsetAndScale=Pr(t,i,r,r)}destroy(){this.texture.release()}}class oD{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}class lD{constructor(){this.geometryInfo=new fO,this._textureRef=new aD((()=>this.tile.surface.textureFadeDuration)),this.overlay=new oD}init(e){this.tile=e,this.clear();const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,Bs(t.boundingBox),t.numSurfaceIndices=0,t.numSkirtIndices=0,t.numWithoutSkirtIndices=0,t.numVertsPerRow=0,this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},this.opacity=1,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometry(e,t){return!!this._updateGeometryState(t)&&(this._releaseGeometry(),this._createGeometry(e),!0)}releaseGeometry(){return!!this._releaseGeometry()&&(this.geometryState={numVertsPerRow:0,samplerData:null,clippingArea:null,wireframe:!1},!0)}ensureTexture(e,t){return h(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),this._texture||(this._texture=t(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){h(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_updateGeometryState(e){const t=this._getElevationInfo(),i=this.tile.level;let r=i<8?this.tile.numSubdivisionsAtLevel[i]+1:2;if(t.samplerData){const e=this.tile.vlevel-i,s=Math.max(i-t.maxTileLevel,za-e),a=this.tile.maxTesselation;r=Re(1+(a>>s),2,a+1)}let s=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(s=null);const a=this.geometryState;let n=!1;return a.numVertsPerRow!==r&&(a.numVertsPerRow=r,n=!0),t.changed&&(a.samplerData=t.samplerData,n=!0),E(a.clippingArea,s)||(a.clippingArea=s,n=!0),a.wireframe!==e&&(a.wireframe=e,n=!0),n}_createGeometry(e){this.tile.createGeometry(this.geometryState,this.localOrigin);const t=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,r=e.gl;this._vao=new Jl(e,Pn,{geometry:Eo(t.layout)},{geometry:ec.createVertex(e,r.STATIC_DRAW,t.buffer)},ec.createIndex(e,r.STATIC_DRAW,i))}_releaseGeometry(){return!!this._vao&&(this._vao.dispose(),this._vao=null,e=this.geometryInfo,mO.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null,!0);var e}get vao(){return this._vao}setTextureReference(e,t,i,r,s=0){e!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t,i,r,s)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],i=t.length;let r=new Array(i),s=0,a=0,n=!1;for(let o=0;o<i;o++){const i=t[o];if(i.upsampleInfo){const t=i.upsampleInfo.tile,l=t.layerInfo[0][o].data,c=l&&l.samplerData;e&&e[s]===c||(n=!0),r[s++]=c,a=Math.max(a,t.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,0);if(Hd(this.tile,t.layer,!1)){const t=i.data;e&&e[s]===t.samplerData||(n=!0),r[s++]=t.samplerData,a=this.tile.lij[0]}}}return e&&e.length!==s&&(n=!0),s>0?r.length=s:r=null,{changed:n,samplerData:r,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength}get textureDescriptor(){return h(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:null!=this._texture}}}class cD{constructor(){this.renderParams={context:null,drawPhase:1,state:new gn({viewpoint:new li({targetGeometry:new _e(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,driverTestResult:null,profiler:null,renderingOptions:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1}}dispose(){this.renderParams=null}render(e,t,i,r,s,a,n,o,l,c){const h=a.adjustLevel(t[0]),d=this.renderParams;d.context=e,d.painter=r,d.glyphMosaic=r.glyphMosaic,d.spriteMosaic=r.spriteMosaic,d.pixelRatio=c,d.displayLevel=h,d.requiredLevel=h,r.setContext(e);const u=a.getScale(t[0]),[p,m]=a.getShift(t,n*u),f=.125*n*u/l,g=i.transforms.dvs;g[0]=f,g[4]=-f,g[6]=-1-p-o[0]*n*2,g[7]=1+m+(1-o[1])*n*2-2,d.state.size[0]=l,d.state.size[1]=l,i.stage||i.attachWithContext(e),i.triangleCount=0,r.drawTile(d,i,s)}}var hD=Object.freeze({__proto__:null,build:function(){const e=new xn;return e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("scale","float"),e.vertex.uniforms.add("offset","vec2"),e.varyings.add("uv","vec2"),e.vertex.code.add(bn`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      uv = uv0 * scale + offset;
    }
  `),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("opacity","float"),e.fragment.code.add(bn`
    void main() {
      vec4 color = texture2D(tex, uv);

      // Note: output in pre-multiplied alpha for correct alpha compositing
      gl_FragColor = vec4(color.xyz, 1.0) * color.a * opacity;
    }
  `),e}});class dD extends Tn{initializeProgram(e){const t=dD.shader.get().build();return new bo(e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),Pn)}initializePipeline(){const e=2===this.configuration.mode?Oo(1,771):1===this.configuration.mode?Oo(0,770):null;return wo({blending:e,colorWrite:To})}}dD.shader=new Rn(hD,(()=>Promise.resolve().then((function(){return hD}))));class uD extends Sn{constructor(){super(...arguments),this.mode=0}}function pD(e){e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("u_scale","float"),e.vertex.uniforms.add("u_offset","vec2"),e.varyings.add("v_texcoord","vec2"),e.vertex.code.add(bn`
    void main(void) {
      v_texcoord = uv0 * u_scale + u_offset;
      gl_Position = vec4(position, 0.0, 1.0);
    }
  `)}function mD(e){e.fragment.uniforms.add("u_colormap","sampler2D"),e.fragment.uniforms.add("u_colormapOffset","float"),e.fragment.uniforms.add("u_colormapMaxIndex","float"),e.fragment.code.add(bn`
    vec4 colormap(vec4 currentPixel, bool isFloat) {
      // colormap is only applicable to integer data but could be already normalized to 0-1 float
      float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
      vec4 result;
      // handle no data and out of range pixels
      if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
        result = vec4(0.0, 0.0, 0.0, 0.0);
      } else {
        // colormap lookup
        vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
        vec4 color = texture2D(u_colormap, clrPosition);
        result = vec4(color.rgb, 1.0) * color.a * u_opacity;
      }
      return result;
    }
  `)}function fD(e){e.fragment.uniforms.add("u_transformGrid","sampler2D"),e.fragment.uniforms.add("u_transformSpacing","vec2"),e.fragment.uniforms.add("u_transformGridSize","vec2"),e.fragment.uniforms.add("u_targetImageSize","vec2"),e.fragment.code.add(bn`
    vec2 projectPixelLocation(vec2 coords) {
      // pixel index in row/column, corresponds to upperleft corner, e.g. [100, 20]
      vec2 index_image = floor(coords * u_targetImageSize);

      // pixel's corresponding cell index in transform grid
      // each transform cell corresponds to 4 pixels: 6 coefficients from lowerleft triangle followed by 6 coefficients from upperright triangle
      vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
      vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;

      // correspoding position in transform grid cell, cell center coordinates
      vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
      vec2 srcLocation;
      // pixel's corresponding transform cell location, center cell coordinates
      vec2 transform_location = index_transform + oneTransformPixel * 0.5;

      // use lower triangle or upper triangle
      if (pos.s <= pos.t) {
        vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
        vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
        srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
        srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
      } else {
        vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
        vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
        srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
        srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
      }
      return srcLocation;;
    }
  `)}function gD(e){e.include(fD),e.fragment.uniforms.add("u_image","sampler2D"),e.fragment.uniforms.add("u_isFloatTexture","bool"),e.fragment.uniforms.add("u_flipY","bool"),e.fragment.uniforms.add("u_applyTransform","bool"),e.fragment.uniforms.add("u_opacity","float"),e.fragment.code.add(bn`
    vec2 getPixelLocation(vec2 coords) {
      vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
      if (!u_applyTransform) {
        return targetLocation;
      }
      return projectPixelLocation(targetLocation);
    }

    bool isOutside(vec2 coords){
      if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
        return true;
      } else {
        return false;
      }
    }

    vec4 getPixel(vec2 pixelLocation) {
      return texture2D(u_image, pixelLocation);
    }
  `)}e([Cn({count:3})],uD.prototype,"mode",void 0);var vD=Object.freeze({__proto__:null,build:function(e){const t=new xn;return t.include(pD),t.include(gD),t.include(mD),0===e.output?function(e,t){e.fragment.uniforms.add("u_bandCount","int"),e.fragment.uniforms.add("u_minCutOff","float",3),e.fragment.uniforms.add("u_maxCutOff","float",3),e.fragment.uniforms.add("u_factor","float",3),e.fragment.uniforms.add("u_minOutput","float"),e.fragment.uniforms.add("u_maxOutput","float"),e.fragment.uniforms.add("u_useGamma","bool"),e.fragment.uniforms.add("u_gamma","float",3),e.fragment.uniforms.add("u_gammaCorrection","float",3),e.fragment.code.add(bn`
      float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
        // clamp values
        if (val >= maxCutOff) {
          return maxOutput;
        } else if (val <= minCutOff) {
          return minOutput;
        }

        // stretch a single value based on whether to use gamma
        float stretchedVal;
        if (useGamma) {
          float tempf = 1.0;
          float outRange = maxOutput - minOutput;
          float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
          if (gamma > 1.0) {
            tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
          }
          stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
        } else {
          stretchedVal = minOutput + (val - minCutOff) * factor;
        }
        return stretchedVal;
      }
    `);const i=t?bn`gl_FragColor = colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma);`:bn`gl_FragColor = vec4(grayVal, grayVal, grayVal, 1.0) * currentPixel.a * u_opacity;`;e.fragment.code.add(bn`
      void main() {
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        if (currentPixel.a == 0.0) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = vec4(redVal, greenVal, blueVal, 1.0) * currentPixel.a * u_opacity;
        }
      }
    `)}(t,e.applyColormap):1===e.output?function(e){e.fragment.code.add(bn`
      void main() {
        // get pixel location
        vec2 pixelLocation = getPixelLocation(v_texcoord);
        if (isOutside(pixelLocation)) {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        // apply colormap we use float texture here
        gl_FragColor = colormap(currentPixel, true);
      }
    `)}(t):2===e.output&&function(e,t){e.fragment.uniforms.add("u_hillshadeType","int"),e.fragment.uniforms.add("u_sinZcosAs","float",6),e.fragment.uniforms.add("u_sinZsinAs","float",6),e.fragment.uniforms.add("u_cosZs","float",6),e.fragment.uniforms.add("u_weights","float",6),e.fragment.uniforms.add("u_factor","vec2"),e.fragment.uniforms.add("u_applyColormap","bool"),e.fragment.uniforms.add("u_minValue","float"),e.fragment.uniforms.add("u_maxValue","float"),e.fragment.uniforms.add("u_srcImageSize","vec2"),e.fragment.include(On),e.fragment.code.add(bn`
  vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
    val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
    vec4 rgb = colormap(vec4(val, val, val, 1.0), false);
    vec3 hsv = rgb2hsv(rgb.xyz);
    hsv.z = hillshade;
    return vec4(hsv2rgb(hsv) * alpha, alpha);
  }
`),e.fragment.code.add(bn`
    float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
      if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
        return 0.0;
      }  else {
        return e;
      }
    }
  `);const i=t?bn`gl_FragColor = overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha);`:bn`
       hillshade *= alpha;
       gl_FragColor = vec4(hillshade, hillshade, hillshade, alpha);
       `;e.fragment.code.add(bn`
    void main() {
      vec2 pixelLocation = getPixelLocation(v_texcoord);
      if (isOutside(pixelLocation)) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}(t,e.applyColormap),t}});class yD extends Tn{get uniformLocationInfos(){return this._uniformLocationInfos||(this._uniformLocationInfos=Ud(this._context,this.program)),this._uniformLocationInfos}initializeProgram(e){const t=yD.shader.get(),i=this.configuration,r=t.build({output:i.colorizerType,applyColormap:i.applyColormap});return this._context=e.rctx,new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),Pn)}initializePipeline(){const e=2===this.configuration.mode?Oo(1,771):1===this.configuration.mode?Oo(0,770):null;return wo({blending:e,colorWrite:To})}bindPass(e,t){kd(this.program,this.uniformLocationInfos,t.basic),kd(this.program,this.uniformLocationInfos,t.common),h(t.colormap)&&kd(this.program,this.uniformLocationInfos,t.colormap),0===this.configuration.colorizerType&&h(t.stretch)?kd(this.program,this.uniformLocationInfos,t.stretch):2===this.configuration.colorizerType&&h(t.hillshade)&&kd(this.program,this.uniformLocationInfos,t.hillshade)}}yD.shader=new Rn(vD,(()=>Promise.resolve().then((function(){return vD}))));class _D extends Sn{constructor(){super(...arguments),this.mode=2,this.colorizerType=0,this.applyColormap=!0}}e([Cn({count:3})],_D.prototype,"mode",void 0),e([Cn({count:3})],_D.prototype,"colorizerType",void 0),e([Cn()],_D.prototype,"applyColormap",void 0);class xD{constructor(e){this.renderingContext=e,this._pools=new Map}acquire(e){return this.getPool(e).acquire()}release(e){this.getPool(e.width).release(e)}clear(){this._pools.forEach((e=>{e.destroy()})),this._pools.clear()}getPool(e){let i=this._pools.get(e);if(!i){const r=Do.bind(Do,this.renderingContext,{colorTarget:0,depthStencilTarget:1,width:e,height:e});i=new t(r),this._pools.set(e,i)}return i}}class bD{constructor(e,t,i){this._rctx=e,this.tileSize=t,this._backgroundTexture=null,this._blackTex=null,this._vectorTileHelper=new cD;this._rctx.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy),this._vaoQuad=Nl(this._rctx,Wl);const r=new uD;r.mode=2,this._blendLayersTechnique=i.acquireAndReleaseExisting(dD,r,this._blendLayersTechnique),r.mode=1,this._applyOpacityTechnique=i.acquireAndReleaseExisting(dD,r,this._applyOpacityTechnique),this._techniqueRep=i,this._blackTex=new yd(Zl(this._rctx,[0,0,0,1])),this._fboPool=new xD(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),h(this._backgroundTexture)&&(this._backgroundTexture.release(),this._backgroundTexture=null),this._blackTex&&(this._blackTex.release(),this._blackTex=null),this._blendLayersTechnique&&(this._blendLayersTechnique.dispose(),this._blendLayersTechnique=null),this._applyOpacityTechnique&&(this._applyOpacityTechnique.dispose(),this._applyOpacityTechnique=null),this._rasterColorizerTechnique&&(this._rasterColorizerTechnique.dispose(),this._rasterColorizerTechnique=null),this._vectorTileHelper&&(this._vectorTileHelper.dispose(),this._vectorTileHelper=null)}updateTileTexture(e){const t=e.layerInfo[1];for(const e of t)e.pendingUpdates&=-65;if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let s=0,a=0,n=this.tileSize,o=!1;const l=i.view.pixelRatio;let c=t.length,d=0;for(;d<t.length&&!o;d++){const u=i.layerViewByIndex(d,1),p=u.fullOpacity;if(CD[d]=p,Sa(u.layer)&&c>=t.length&&(c=d),0===p)continue;++a;const m=wD(e,d,SD);m&&(Sd(u)?n=Math.max(n,this.tileSize*l):1===r&&1===p&&(u.isOpaque||this._dataToTexture(m)&&h(m.sourceLayerInfo.data)&&m.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++s)}this._cleanupFBOPool(l,t.length),n=function(e){const t=Ve(e),i=t*t,r=e*e;if(i===r)return e;const s=t/2;return i-r<r-s*s?t:s}(n);const p=n/this.tileSize,m=d-1;if(0===s){let t=0;(e.surface.view.layerViewManager.updating||a>0)&&(t=5e3),this._backgroundTexture&&u(e.renderData.textureReference)&&(t=0),this._useBackgroundTexture(e,t)}else 1===s&&o?this._useLayerTexture(e,m):this._composeMapLayers(e,m,c,o,CD,n,p)}setBackground(e){h(this._backgroundTexture)&&this._backgroundTexture.release(),e instanceof HTMLImageElement?this._backgroundTexture=this._buildTexture(e):this._backgroundTexture=new yd(Zl(this._rctx,e))}_buildTexture(e){if(u(e))return null;const t={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._rctx;let r;if("number"==typeof e)t.width=t.height=e,r=new yd(new Po(i,t));else if(e instanceof _d)t.isOpaque=e.isOpaque,r=new yd(new Po(i,t,e.image)),e.release();else try{r=new yd(new Po(i,t,e))}catch(e){r=new yd(Ql(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}return i.bindTexture(r.texture,0),r.generateMipmap(),r}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,Kl(this._vaoQuad,"geometry"))}_drawRasterData(e,t,i,r,s=1){if(u(t))return;const a=this._rctx,n=e.program;a.setPipelineState(e.pipeline),a.bindProgram(n),a.bindTexture(t,0),n.setUniform1i("tex",0),n.setUniform1f("scale",i),n.setUniform2f("offset",r[0],r[1]),n.setUniform1f("opacity",s),this._drawQuad(n)}_drawImageryTileData(e,t=1){const i=e.sourceLayerInfo.data;if(u(i)||!i.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(i);const r=this._getRasterColorizerTechnique(i.symbolizerParameters.type,!!i.symbolizerParameters.colormap),s=this._rctx,a=r.program;if(s.setPipelineState(r.pipeline),s.bindProgram(a),!i.bind(s))return;i.opacity=t,i.scale=e.scale,i.offset=e.offset;const{names:n,textures:o}=i.getTextures();jd(s,a,n,o);const l=i.getUniforms();r.bindPass(s,l),this._drawQuad(a),s.bindVAO()}_getRasterColorizerTechnique(e,t){const i=["stretch","lut","hillshade"].indexOf(e);return this._rasterColorizerConfig||(this._rasterColorizerConfig=new _D,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=i,this._rasterColorizerConfig.applyColormap=t,this._rasterColorizerTechnique=this._techniqueRep.acquireAndReleaseExisting(yD,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,i,r,s,a,n){const o=t.sourceLayerInfo.data;if(u(o))return n;const l=this._rctx,c=t.tile.surface.layerViewByIndex(t.layerIndex,1);let h;l.setPipelineState(e.pipeline);const d=r<1;return d?(h=this._fboPool.acquire(s),l.bindFramebuffer(h),l.setClearColor(1,1,1,0),l.clearSafe(16640)):n&&l.clearSafe(256),this._vectorTileHelper.render(l,t.sourceLod,o,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,i),!d||(l.bindFramebuffer(a),this._drawRasterData(e,h.colorTexture,1,[0,0],r),this._fboPool.release(h),n)}_useBackgroundTexture(e,t){e.renderData.opacity=e.surface.baseOpacity,e.renderData.setTextureReference(this._backgroundTexture,0,0,1,t)}_useLayerTexture(e,t){e.renderData.opacity=e.surface.baseOpacity;const i=wD(e,t,SD);if(this._dataToTexture(i)){const t=i.offset;e.renderData.setTextureReference(i.sourceLayerInfo.data,t[0],t[1],i.scale)}}_composeMapLayers(e,t,i,r,s,a,n){const o=e.renderData.ensureTexture(a,(()=>this._buildTexture(a)));if(u(o))return;const l=this._rctx,c=this._fboPool.acquire(a);l.bindFramebuffer(c),l.setViewport(0,0,a,a),l.setClearColor(0,0,0,0),l.setClearDepth(1),l.clearSafe(16640);let d=!1;!r&&h(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,un);const p=e.surface.baseOpacity;let m=!1;for(let r=t;r>=0;r--){const t=wD(e,r,SD);t&&(r<i&&p<1&&!m&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,un,p),m=!0),0!==s[r]&&(Td(t)?d=this._drawVectorData(this._blendLayersTechnique,t,n,s[r],a,c,d):Pd(t)?this._drawImageryTileData(t,s[r]):this._dataToTexture(t)&&h(t.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,s[r])))}l.bindTexture(o.texture,0);const f=o.descriptor;l.gl.copyTexImage2D(l.gl.TEXTURE_2D,0,f.pixelFormat,0,0,f.width,f.height,0),o.generateMipmap(),l.bindFramebuffer(null),this._fboPool.release(c),e.renderData.opacity=m?1:p,e.renderData.setTextureReference(o,0,0,1)}_dataToTexture(e){return Rd(e)&&this._rasterDataToTexture(e),Md(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}function wD(e,t,i){i.layerIndex=t;const r=e.layerInfo[1][t];if(r.data)return ls(i.offset,0,0),i.tile=e,i.scale=1,i.sourceLod=e.lij,i.sourceLayerInfo=r,i;const s=r.upsampleInfo;if(s){const e=s.tile.layerInfo[1][t];return i.tile=s.tile,hs(i.offset,s.offset),i.scale=s.scale,i.sourceLod=s.tile.lij,i.sourceLayerInfo=e,i}return null}const CD=new Array,SD={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};function TD(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),1===t.viewingMode?e.vertex.code.add(bn`
      void forwardVertexTangent(vec3 n) {
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
        tbnBiTangent = normalize(cross(n, tbnTangent));
      }
    `):e.vertex.code.add(bn`
      void forwardVertexTangent(vec3 n) {
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(n, tbnTangent));
      }
    `),e.fragment.code.add(bn`
      mat3 getTBNMatrix(vec3 n) {
        return mat3(tbnTangent, tbnBiTangent, n);
      }
    `)}function PD(e,t){3!==t.pbrMode&&4!==t.pbrMode||e.include(Ac,t),e.vertex.uniforms.add("overlayTexOffset","vec4"),e.vertex.uniforms.add("overlayTexScale","vec4"),e.varyings.add("vtcOverlay","vec4"),e.vertex.code.add(bn`
    void setOverlayVTC(in vec2 uv) {
      vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
    }
  `),e.fragment.uniforms.add("ovInnerColorTex","sampler2D"),e.fragment.uniforms.add("ovOuterColorTex","sampler2D"),e.fragment.uniforms.add("overlayOpacity","float"),e.fragment.code.add(bn`
    vec4 getOverlayColor(sampler2D ov0Tex, sampler2D ov1Tex, vec4 texCoords) {
      // read textures outside of conditions, to avoid artifacts likely related to non-uniform flow control:
      // - https://www.khronos.org/opengl/wiki/Sampler_(GLSL)#Non-uniform_flow_control
      // - https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/13657
      vec4 color0 = texture2D(ov0Tex, texCoords.xy);
      vec4 color1 = texture2D(ov1Tex, texCoords.zw);

      float valid0 = float((texCoords.x >= 0.0) && (texCoords.x <= 1.0) && (texCoords.y >= 0.0) && (texCoords.y <= 1.0));
      float valid1 = float((texCoords.z >= 0.0) && (texCoords.z <= 1.0) && (texCoords.w >= 0.0) && (texCoords.w <= 1.0));

      // Pick color0 if valid, otherwise color1 if valid, otherwise vec4(0)
      return mix(color1 * valid1, color0, valid0);
    }
  `),e.fragment.code.add(bn`
    vec4 getCombinedOverlayColor() {
      return overlayOpacity * getOverlayColor(ovInnerColorTex, ovOuterColorTex, vtcOverlay);
    }
  `),3!==t.pbrMode&&4!==t.pbrMode||(e.include(jh),e.fragment.code.add(bn`
    vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
       float shadow, vec3 localUp, mat3 tbn, vec3 position) {

      // reproject normal from 0...1 => -1...1
      // and project it to worldspace.
      vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
      vec3 v = vposEyeDir;
      vec3 l = normalize(-lightingMainDirection);
      vec3 final = getSeaColor(n, v, l, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position);

      // the terrain renderer assumes a premultiplied color output without gamma.
      return vec4(final, colorInput.w);
    }
    `))}function RD(e){e.vertex.code.add(bn`
    vec3 applySkirts(inout vec2 uv, vec3 vpos, vec3 vnormal, float skirtScale) {
      float skirtLength = 0.0;

      if (uv.x >= 2.0) {
        skirtLength = uv.y * skirtScale;
        // decode original uv-coordinates (see "encodeSkirtPos")
        vec2 x = vec2(uv.x) - vec2(3.5, 4.5);
        uv = clamp(vec2(1.5) - abs(x), vec2(0.0), vec2(1.0));
      }

      return vpos - vnormal * skirtLength;
    }
    `)}function MD(e,t){e.varyings.add("vtc","vec2"),e.vertex.uniforms.add("texOffsetAndScale","vec4"),e.fragment.uniforms.add("tex","sampler2D"),t.textureFadingEnabled&&(e.vertex.uniforms.add("nextTexOffsetAndScale","vec4"),e.varyings.add("nvtc","vec2"),e.fragment.uniforms.add("texNext","sampler2D"),e.fragment.uniforms.add("textureFadeFactor","float")),e.vertex.code.add(bn`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${t.textureFadingEnabled?bn`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:bn``}
  }
  `),e.fragment.code.add(bn`
  vec4 getTileColor() {
    ${t.textureFadingEnabled?bn`return textureFadeFactor < 1.0 ? mix(texture2D(texNext, nvtc), texture2D(tex, vtc), textureFadeFactor) : texture2D(tex, vtc);`:bn`return texture2D(tex, vtc);`}
  }
  `)}var OD=Object.freeze({__proto__:null,build:function(e){const t=new xn;if(t.include(Gh,{name:"Terrain Shader",output:e.output}),t.include(RD),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("origin","vec3").add("skirtScale","float"),0===e.output){t.include(wn,{linearDepth:!1}),t.include(Pc,e),t.include(MD,e);const i=0!==e.overlayMode,r=2===e.overlayMode;i&&t.include(PD,{pbrMode:3,useCustomDTRExponentForWater:!1,ssrEnabled:e.ssrEnabled,highStepCount:e.highStepCount}),r&&t.include(TD,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),e.receiveShadows&&t.varyings.add("linearDepth","float"),e.tileBorders&&t.varyings.add("vuv","vec2"),e.atmosphere&&(t.vertex.uniforms.add("lightingMainDirection","vec3"),t.varyings.add("wnormal","vec3"),t.varyings.add("wlight","vec3")),e.screenSizePerspective&&(t.vertex.uniforms.add("screenSizePerspective","vec4"),t.varyings.add("screenSizeDistanceToCamera","float"),t.varyings.add("screenSizeCosAngle","float")),t.vertex.code.add(bn`
      void main(void) {
        vpos = position;
        vnormal = getLocalUp(vpos, origin);

        vec2 uv = uv0;
        vpos = applySkirts(uv, vpos, vnormal, skirtScale);
        ${e.atmosphere?bn`
        wnormal = (viewNormal * vec4(normalize(vpos+origin), 1.0)).xyz;
        wlight = (view  * vec4(-lightingMainDirection, 1.0)).xyz;`:""}
        ${e.tileBorders?bn`vuv = uv;`:""}
        ${e.screenSizePerspective?bn`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${e.receiveShadows?bn`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${i?bn`setOverlayVTC(uv);`:""}
        ${r?bn`forwardVertexTangent(vnormal);`:bn``}
      }
    `),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(In,e),t.include(Lh,e),t.fragment.uniforms.add("camPos","vec3").add("viewDirection","vec3").add("ssaoTex","sampler2D").add("viewportPixelSz","vec4").add("opacity","float"),e.screenSizePerspective&&t.fragment.uniforms.add("screenSizePerspective","vec4"),r&&(t.fragment.uniforms.add("ovInnerWaterTex","sampler2D"),t.fragment.uniforms.add("ovOuterWaterTex","sampler2D"),t.fragment.uniforms.add("view","mat4")),t.fragment.code.add(bn`
      const vec3 ambient = vec3(0.2, 0.2, 0.2);
      const vec3 diffuse = vec3(0.8, 0.8, 0.8);
      const float diffuseHardness = 2.5;
      const float sliceOpacity = 0.2;

      float lum(vec3 c) {
        float max = max(max(c.r, c.g), c.b);
        float min = min(min(c.r, c.g), c.b);
        return (min + max) * 0.5;
      }
      `),e.atmosphere&&t.fragment.code.add(bn`
      vec3 atmosphere(vec3 lightPos, vec3 normal, vec3 view) {
        vec3 surfaceColor   = vec3(0.0);
        vec3 fuzzySpecColor = vec3(1.0);
        vec3 subColor       = vec3(0.0);
        float rollOff       = 1.0;

        vec3 Ln = normalize(lightPos);
        vec3 Nn = normalize(normal);
        vec3 Hn = normalize(view + Ln);

        float ldn = dot(Ln, Nn);
        float diffComp = max(0.0, ldn);
        // clamp necessary here because values might cause flickering: #21549
        float vdn = clamp(1.0 - dot(view, Nn), 0.0, 1.0);
        float ndv = dot(view, Ln);

        vec3 diffContrib = surfaceColor * diffComp;
        float subLamb = max(0.0, smoothstep(-rollOff, 1.0, ldn) - smoothstep(0.0, 1.0, ldn));

        vec3 subContrib = subLamb * subColor;
        vec3 vecColor = vec3(vdn);

        vec3 diffuseContrib = (subContrib + diffContrib);
        vec3 specularContrib = (vecColor * fuzzySpecColor);

        return (diffContrib + specularContrib) * rollOff;
      }
      `),t.fragment.code.add(bn`
      void main() {
        ${e.receiveShadows?bn`float shadow = readShadowMap(vpos, linearDepth);`:bn`float shadow = 0.0;`}
        float vndl = dot(normalize(vnormal), -lightingMainDirection);
        float k = smoothstep(0.0, 1.0, clamp(vndl*diffuseHardness, 0.0, 1.0));
        vec3 d = (1.0 - shadow/1.8) * diffuse * k;

        float ssao = viewportPixelSz.w < .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
        vec4 tileColor = getTileColor() * opacity;
        ${i?bn`
            vec4 overlayColorOpaque = getOverlayColor(ovInnerColorTex, ovOuterColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        vec3 atm = vec3(0.0);
        ${e.atmosphere?bn`
            float ndotl = max(0.0, min(1.0, vndl));
            atm = atmosphere(wlight, wnormal, -viewDirection);
            atm *= max(0.0, min(1.0, (1.0-lum(tileColor.rgb)*1.5))); //avoid atmosphere on bright base maps
            atm *= max(0.0, min(1.0, ndotl*2.0)); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}
        vec3 albedo = atm + tileColor.rgb;
        vec3 normal = normalize(vnormal);

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        gl_FragColor = vec4(evaluateSceneLightingExt(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${r?bn`
            vec4 overlayWaterMask = getOverlayColor(ovInnerWaterTex, ovOuterWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - camPos), shadow, vnormal, tbnMatrix, viewPosition.xyz);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${e.screenSizePerspective?bn`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, screenSizePerspective);
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${e.tileBorders?bn`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return 1!==e.output&&3!==e.output||(t.include(wn,{linearDepth:!0}),t.include(En,{output:e.output}),t.include(Pc,e),t.varyings.add("linearDepth","float"),t.vertex.uniforms.add("nearFar","vec2"),t.vertex.code.add(bn`
        void main(void) {
          vec3 normal = getLocalUp(position, origin);
          vec2 uv = uv0;
          vec3 vpos = applySkirts(uv, position, normal.xyz, skirtScale);

          gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);
        }
    `),t.fragment.code.add(bn`
        void main() {
          outputDepth(linearDepth);
        }
    `)),2===e.output&&(t.include(wn,{linearDepth:!1}),t.include(Pc,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),t.vertex.uniforms.add("viewNormal","mat4"),t.vertex.code.add(bn`
        void main(void) {
          vec3 normal = getLocalUp(position, origin);
          vec2 uv = uv0;
          vpos = applySkirts(uv, position, normal, skirtScale);

          gl_Position = transformPosition(proj, view, vpos);
          vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
        }
    `),t.fragment.code.add(bn`
        void main() {
          vec3 normal = normalize(vnormal);
          if (gl_FrontFacing == false) {
            normal = -normal;
          }
          gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
        }
    `)),4===e.output&&(t.include(wn,{linearDepth:!1}),t.include(Pc,e),t.include(PD,{pbrMode:0}),t.vertex.code.add(bn`
          void main() {
            vec3 vnormal = getLocalUp(position, origin);
            vec2 uv = uv0;
            vec3 vpos = applySkirts(uv, position, vnormal, skirtScale);
            setOverlayVTC(uv);

            gl_Position = transformPosition(proj, view, vpos);
          }
      `),t.include(Ln),t.fragment.code.add(bn`
        void main() {
          vec4 overlayColor = getCombinedOverlayColor();

          if (overlayColor.a == 0.0) {
            gl_FragColor = vec4(0.0);
            return;
          }

          outputHighlight();
        }
      `)),t}});class DD extends Tn{initializeProgram(e){const t=DD.shader.get(),i=this.configuration,r=t.build({overlayMode:i.overlayMode,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,textureFadingEnabled:i.textureFadingEnabled&&!i.renderOccluded,receiveShadows:i.receiveShadows&&!i.renderOccluded,receiveAmbientOcclusion:!1,useOldSceneLightInterface:!0,atmosphere:i.atmosphere,tileBorders:i.tileBorders,screenSizePerspective:i.screenSizePerspective,pbrMode:0,ssrEnabled:i.ssrEnabled,highStepCount:!1});return new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),Pn)}initializePipeline(){const e=this.configuration,t=e.backfaceCullingEnabled&&!e.renderOccluded;return wo({blending:e.renderOccluded?Oo(1,771):null,culling:t&&So,depthTest:!e.renderOccluded&&{func:513},depthWrite:!e.renderOccluded&&Ro,colorWrite:To,stencilTest:e.stencilEnabled?lo(1):null})}}DD.shader=new Rn(OD,(()=>Promise.resolve().then((function(){return OD}))));class AD extends Sn{constructor(){super(...arguments),this.output=0,this.overlayMode=0,this.atmosphere=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.ssrEnabled=!1,this.tileBorders=!1,this.screenSizePerspective=!1}}e([Cn({count:8})],AD.prototype,"output",void 0),e([Cn({count:3})],AD.prototype,"overlayMode",void 0),e([Cn()],AD.prototype,"atmosphere",void 0),e([Cn()],AD.prototype,"receiveShadows",void 0),e([Cn()],AD.prototype,"slicePlaneEnabled",void 0),e([Cn()],AD.prototype,"backfaceCullingEnabled",void 0),e([Cn()],AD.prototype,"stencilEnabled",void 0),e([Cn()],AD.prototype,"textureFadingEnabled",void 0),e([Cn()],AD.prototype,"renderOccluded",void 0),e([Cn()],AD.prototype,"ssrEnabled",void 0),e([Cn()],AD.prototype,"tileBorders",void 0),e([Cn()],AD.prototype,"screenSizePerspective",void 0);_r((function(e){!function(t){var i=function(){var e=function(e){window.console&&window.console.log&&window.console.log(e)},t=function(t){window.console&&window.console.error?window.console.error(t):e(t)},i={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},r=null,s=null;function a(e){if(null==r)for(var t in r={},s={},e)"number"==typeof e[t]&&(r[e[t]]=t,s[t]=e[t])}function n(){if(null==r)throw"WebGLDebugUtils.init(ctx) not called"}function o(e){return n(),void 0!==r[e]}function l(e){n();var t=r[e];return void 0!==t?"gl."+t:"/*UNKNOWN WebGL ENUM*/ 0x"+e.toString(16)}function c(e,t,r,a){var n;if(void 0!==(n=i[e])&&(void 0!==(n=n[t])&&n[r])){if("object"==typeof n[r]&&void 0!==n[r].enumBitwiseOr){for(var o=n[r].enumBitwiseOr,c=0,h=[],d=0;d<o.length;++d){var u=s[o[d]];0!=(a&u)&&(c|=u,h.push(l(u)))}return c===a?h.join(" | "):l(a)}return l(a)}return null===a?"null":void 0===a?"undefined":a.toString()}function h(e,t){for(var i="",r=t.length,s=0;s<r;++s)i+=(0==s?"":", ")+c(e,r,s,t[s]);return i}function d(e,t,i){e.__defineGetter__(i,(function(){return t[i]})),e.__defineSetter__(i,(function(e){t[i]=e}))}function u(e,i,r,s){s=s||e,a(e),i=i||function(e,i,r){for(var s="",a=r.length,n=0;n<a;++n)s+=(0==n?"":", ")+c(i,a,n,r[n]);t("WebGL error "+l(e)+" in "+i+"("+s+")")};var n={};function o(e,t){return function(){r&&r(t,arguments);var a=e[t].apply(e,arguments),o=s.getError();return 0!=o&&(n[o]=!0,i(o,t,arguments)),a}}var h={};for(var p in e)if("function"==typeof e[p])if("getExtension"!=p)h[p]=o(e,p);else{var m=o(e,p);h[p]=function(){return u(m.apply(e,arguments),i,r,s)}}else d(h,e,p);return h.getError=function(){for(var t in n)if(n.hasOwnProperty(t)&&n[t])return n[t]=!1,t;return e.NO_ERROR},h}function p(e){var t=e.getParameter(e.MAX_VERTEX_ATTRIBS),i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i);for(var r=0;r<t;++r)e.disableVertexAttribArray(r),e.vertexAttribPointer(r,4,e.FLOAT,!1,0,0),e.vertexAttrib1f(r,0);e.deleteBuffer(i);var s=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);for(r=0;r<s;++r)e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.bindTexture(e.TEXTURE_2D,null);for(e.activeTexture(e.TEXTURE0),e.useProgram(null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.DITHER),e.disable(e.SCISSOR_TEST),e.blendColor(0,0,0,0),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(-1),e.colorMask(!0,!0,!0,!0),e.cullFace(e.BACK),e.depthFunc(e.LESS),e.depthMask(!0),e.depthRange(0,1),e.frontFace(e.CCW),e.hint(e.GENERATE_MIPMAP_HINT,e.DONT_CARE),e.lineWidth(1),e.pixelStorei(e.PACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_ALIGNMENT,4),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.UNPACK_COLORSPACE_CONVERSION_WEBGL&&e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.BROWSER_DEFAULT_WEBGL),e.polygonOffset(0,0),e.sampleCoverage(1,!1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilMask(4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT);e.getError(););}function m(e){var t,i,r=[],s=[],a={},n=1,o=!1,l=[],c=0,h=0,u=!1,m=0,f={};function g(e){return"function"==typeof e?e:function(t){e.handleEvent(t)}}e.getContext=(i=e.getContext,function(){var r=i.apply(e,arguments);if(r instanceof WebGLRenderingContext){if(r!=t){if(t)throw"got different context";a=T(t=r)}return a}return r});var v=function(e){r.push(g(e))},y=function(e){s.push(g(e))};function _(e){var t=e.addEventListener;e.addEventListener=function(i,r,s){switch(i){case"webglcontextlost":v(r);break;case"webglcontextrestored":y(r);break;default:t.apply(e,arguments)}}}function x(){for(var e=Object.keys(f),t=0;t<e.length;++t)delete f[e]}function b(){++h,o||c==h&&e.loseContext()}function w(e,t){var i=e[t];return function(){if(b(),!o)return i.apply(e,arguments)}}function C(){for(var e=0;e<l.length;++e){var i=l[e];i instanceof WebGLBuffer?t.deleteBuffer(i):i instanceof WebGLFramebuffer?t.deleteFramebuffer(i):i instanceof WebGLProgram?t.deleteProgram(i):i instanceof WebGLRenderbuffer?t.deleteRenderbuffer(i):i instanceof WebGLShader?t.deleteShader(i):i instanceof WebGLTexture&&t.deleteTexture(i)}}function S(e){return{statusMessage:e,preventDefault:function(){u=!0}}}return _(e),e.loseContext=function(){if(!o){for(o=!0,c=0,++n;t.getError(););x(),f[t.CONTEXT_LOST_WEBGL]=!0;var i=S("context lost"),s=r.slice();setTimeout((function(){for(var t=0;t<s.length;++t)s[t](i);m>=0&&setTimeout((function(){e.restoreContext()}),m)}),0)}},e.restoreContext=function(){o&&s.length&&setTimeout((function(){if(!u)throw"can not restore. webglcontestlost listener did not call event.preventDefault";C(),p(t),o=!1,h=0,u=!1;for(var e=s.slice(),i=S("context restored"),r=0;r<e.length;++r)e[r](i)}),0)},e.loseContextInNCalls=function(e){if(o)throw"You can not ask a lost contet to be lost";c=h+e},e.getNumCalls=function(){return h},e.setRestoreTimeout=function(e){m=e},e;function T(e){for(var i in e)"function"==typeof e[i]?a[i]=w(e,i):d(a,e,i);a.getError=function(){if(b(),!o)for(;e=t.getError();)f[e]=!0;for(var e in f)if(f[e])return delete f[e],e;return a.NO_ERROR};for(var r=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],s=0;s<r.length;++s){var c=r[s];a[c]=function(t){return function(){if(b(),o)return null;var i=t.apply(e,arguments);return i.__webglDebugContextLostId__=n,l.push(i),i}}(e[c])}var h=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(s=0;s<h.length;++s){c=h[s];a[c]=function(t){return function(){return b(),o?null:t.apply(e,arguments)}}(a[c])}var u=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(s=0;s<u.length;++s){c=u[s];a[c]=function(t){return function(){return b(),!o&&t.apply(e,arguments)}}(a[c])}return a.checkFramebufferStatus=function(t){return function(){return b(),o?a.FRAMEBUFFER_UNSUPPORTED:t.apply(e,arguments)}}(a.checkFramebufferStatus),a.getAttribLocation=function(t){return function(){return b(),o?-1:t.apply(e,arguments)}}(a.getAttribLocation),a.getVertexAttribOffset=function(t){return function(){return b(),o?0:t.apply(e,arguments)}}(a.getVertexAttribOffset),a.isContextLost=function(){return o},a}}return{init:a,mightBeEnum:o,glEnumToString:l,glFunctionArgToString:c,glFunctionArgsToString:h,makeDebugContext:u,makeLostContextSimulatingCanvas:m,resetToInitialState:p}}();void 0!==i&&(e.exports=i)}()}));const ED=js(),ID=Tr();class LD{constructor(){this.extent=Tr(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let FD=class extends T{constructor(e){super(e),this.type="Terrain",this.isGround=!0,this.tileSize=256,this.rctx=null,this._isTransparent=!1,this.renderDataPool=new t(lD),this.patchGroups=new R({allocator:e=>e||{root:null,origin:null,patches:new R},deallocator:e=>(e.root=null,e.origin=null,e.patches.clear(),e)}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new Qd,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._skirtScale=1,this._velvetOverground=!0,this.castShadows=!0,this._ssrEnabled=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.tileBackgroundUpdating=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.clippingExtent=null,this.overlayOpacity=1,this.needsHighlight=!1,this.renderOccludedFlags=1,this.visibleScaleRangeQueries=new R({initialSize:10}),this.visibleScaleRangeQueriesInvPtr=0,this.visibleScaleRangeQueryQueue=new R({initialSize:30}),this.visibleScaleRangeQueryPool=new t(LD)}destroy(){mO.clear(),vO.clear()}install(e){e.addRenderPlugin([2,7,9],this)}uninstall(e){e.removeRenderPlugin(this)}get updating(){return!this.tileBackgroundInitialized||this.tileBackgroundUpdating}get canRender(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get needsLinearDepth(){return this.overlayRenderer.hasWater}get opaque(){return this._opaque&&!this.shaderTechniqueConfig.slicePlaneEnabled}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}set skirtScale(e){e!==this._skirtScale&&(this._skirtScale=e,this.setNeedsRender())}get skirtScale(){return this._skirtScale}get renderPatchBorders(){return!!this.shaderTechniqueConfig.tileBorders}set renderPatchBorders(e){this.shaderTechniqueConfig.tileBorders!==e&&(this.shaderTechniqueConfig.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this.shaderTechniqueConfig.backfaceCullingEnabled}set cullBackFaces(e){this.shaderTechniqueConfig.backfaceCullingEnabled!==e&&(this.shaderTechniqueConfig.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get intersectionHandlerId(){return eh}get slicePlane(){return this.shaderTechniqueConfig.slicePlaneEnabled}set slicePlane(e){this.shaderTechniqueConfig.slicePlaneEnabled!==e&&(this.shaderTechniqueConfig.slicePlaneEnabled=e,this.setNeedsRender())}set textureFadingEnabled(e){this.shaderTechniqueConfig.textureFadingEnabled!==e&&(this.shaderTechniqueConfig.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this.shaderTechniqueConfig.screenSizePerspective!==e&&(this.shaderTechniqueConfig.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this.rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?Ec:1,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}loadTile(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e)),this.updateTileGeometry(e),this.updateTileTexture(e)}queryVisibleLevelRange(e,t,i,r){const s=this.visibleScaleRangeQueryPool.acquire();Ts(s.extent,e),s.minLevel=t||-Number.MAX_VALUE,s.maxLevel=null!=i?i:Number.MAX_VALUE,s.callback=r,this.visibleScaleRangeQueryQueue.push(s),this.setNeedsRender()}updateTileTexture(e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e),this.setNeedsRender(),e.resetPendingUpdate(64))}updateTileGeometry(e){for(const t of e.layerInfo[0])t.pendingUpdates&=-33;e.resetPendingUpdate(32),e.renderData.updateGeometry(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){e.renderData&&(this.releaseTileGeometry(e.renderData),e.renderData.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.lij[0]-3)/7));if("spherical"===this.manifold&&0===t)return Ge;for(;e.parent&&e.lij[0]>t;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.rootTiles&&(Yd(this.rootTiles,(t=>{t.renderData&&t.renderData.updateGeometry(this.rctx,e)})),this.setNeedsRender()))}setNeedsRender(e=1){this.patchGroupsDirty=!0,this.initContext.requestRender(e)}setTileBackground(e){this.tileBackground=e,this._updateTileBackground()}initializeRenderContext(e){this.initContext=e,this.rctx=e.rctx,this.shaderTechniques=e.shaderTechniqueRep,this.shaderTechniqueConfig=new AD,this.tileRenderer=new bD(this.rctx,this.tileSize,this.shaderTechniques),this.tileBackground&&this._updateTileBackground(),this.emptyTex=Ql(this.rctx)}uninitializeRenderContext(){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)}intersect(e,t,i,r){if(!this.rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const s=jD,a=GD;at(s,r,i),Ye(a,1/s[0],1/s[1],1/s[2]);const n=e.results.min,o=e.results.max,l=e.results.ground,c=0===e.options.store,d=!!e.results.ground.target;let p=null;const m=this.clippingExtent,f=this.tileIterator;f.reset(this.rootTiles);const g=th(e.verticalOffset);for(;!f.done;){const v=f.next();if(null===v.renderData||d&&this._useStencilForTile(v))continue;if(e.options.invisibleTerrain){if(!v.visible&&m&&!v.intersectsExtent(m))continue}else if(!v.visible)continue;const y=v.renderData.geometryInfo,_=v.renderData.localOrigin,x=-this._skirtScale*y.skirtLength;if(Zs(ED,y.boundingBox),h(g)&&(g.localOrigin=_,g.applyToAabb(ED)),0!==x){const e=v.up;ha(ED,x*e[0],x*e[1],x*e[2])}const b=ED;at(BD,i,_);const w=c&&null!=n.dist?n.dist:1/0;if(!co(b,BD,a,e.tolerance,w))continue;const C=(e,t,i,r)=>{e.set(void 0,Zd(t),i,r,Nr,void 0),e.intersector=qD,e.target={type:"external",metadata:{tile:t}}},S=(a,c)=>{if(a>=0&&(e.options.backfacesTerrain||st(c,s)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,r,a))){if((null==l.dist||a<l.dist)&&C(l,v,a,c),e.options.isFiltered)return;2===e.options.store&&(u(p)?(p=new Kc(e.ray),C(p,v,a,c),e.results.all.push(p)):a<p.dist&&C(p,v,a,c)),(null==n.dist||a<n.dist)&&C(n,v,a,c),0!==e.options.store&&(null==o.dist||a>o.dist)&&C(o,v,a,c)}},T=ND;at(T,r,_);const P=y.indices,R=y.vertexAttributes,M={data:R.getField("position",ns).typedBuffer,size:3,offsetIdx:0,strideIdx:R.stride/4},O=y.numWithoutSkirtIndices/3;if(to(BD,T,0,O,P,M,null,g,S),0!==x){const e="spherical"===this.manifold?e=>Ze(e,e,x/$e(e)):e=>Ye(e,0,0,x),t=P.length/3;CO(BD,T,O,t,P,R,e,g,S)}}}render(e){if(9===e.slot){if(0==(e.renderOccludedMask&Ec))return!1}else{const t=this.opaque?2:7;if(e.slot!==t)return!1}const t=e.pass,i=1===e.scenelightingData.globalFactor,r=this._updatePatchGroups();switch(t){case 0:{const t=e.shadowMap&&e.shadowMap.enabled;this.shaderTechniqueConfig.receiveShadows!==t&&(this.shaderTechniqueConfig.receiveShadows=t);const i=this.overlayRenderer.isEmpty()?0:this.overlayRenderer.hasWater?2:1;this.shaderTechniqueConfig.overlayMode!==i&&(this.shaderTechniqueConfig.overlayMode=i);const s=9===e.slot?3:1;this._renderMaterialPass(e,0,r,s);break}case 4:this.castShadows&&i&&this._renderAuxiliaryPass(e,3,r,0);break;case 2:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,1,r,0);break;case 3:this._renderAuxiliaryPass(e,2,r,0);break;case 5:this.needsHighlight&&(this._renderAuxiliaryPass(e,4,r,2),e.rctx.clearSafe(256))}return 0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender(),!0}_renderMaterialPass(e,t,i,r){const s=e.rctx,a=e.camera;this._ssrEnabled=e.ssrParams.ssrEnabled,this._setTerrainTechnique(t,3===r);const n=this.shaderTechnique.program;e.rctx.bindProgram(n),s.bindProgram(n),1===r&&e.ssrParams&&(e.ssrParams.lastFrameColorTextureID=9,e.ssrParams.linearDepthTextureID=8,Ic.bindUniforms(n,s,e.ssrParams)),e.shadowMap&&e.shadowMap.bind(n,7),e.ssaoHelper&&e.ssaoHelper.setUniforms(n,6),n.setUniform1i("tex",0),n.setUniform1i("texNext",1),this._bindOverlayData(n,r),n.setUniformMatrix4fv("viewNormal",a.viewInverseTransposeMatrix),Mn.bindProjectionMatrix(n,a.projectionMatrix),e.scenelightingData.setUniforms(n,!0);const o=a.viewMatrix;Ye(kD,o[12],o[13],o[14]),nt(kD,kD),n.setUniform3fv("viewDirection",kD),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.opaque?this._renderPatchGroups(e,n,i,r):e.offscreenRenderingHelper.renderToTargets((()=>this._renderPatchGroups(e,n,i,r)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries()}_renderAuxiliaryPass(e,t,i,r){this._setTerrainTechnique(t,3===r);const s=this.shaderTechnique.program;if(e.rctx.bindProgram(s),5===e.pass){const t=e.offscreenRenderingHelper;e.rctx.bindTexture(t.depthTexture,6),s.setUniform1i("depthTex",6),s.setUniform4f("highlightViewportPixelSz",0,0,1/t.width,1/t.height)}else s.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),2!==e.pass&&4!==e.pass||s.setUniform2fv("nearFar",e.camera.nearFar);this._renderPatchGroupsAuxiliary(e,s,i,r)}_updateTileBackground(){if(!this.tileRenderer)return;this.tileBackgroundUpdating=!0;const e=()=>{this.tileBackgroundInitialized=!0,this.tileBackgroundUpdating=!1,this.rootTiles&&Yd(this.rootTiles,(e=>{this.tileRenderer.updateTileTexture(e),this.setNeedsRender()})),this.setNeedsRender()};if("string"==typeof this.tileBackground){const t=this.tileBackground;_n(t).then((i=>{t===this.tileBackground&&this.tileRenderer&&(this.tileRenderer.setBackground(i),e())}))}else{const t=this.tileBackground?At.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(t),e()}}_updatePatchGroups(){const e=this.patchGroups;if(!this.patchGroupsDirty)return e;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(e),0!==this.renderOrder){for(let t=0;t<e.length;t++)$d(this.renderOrder,e.data[t].patches);e.sort(((e,t)=>function(e,t,i){if(0===e.patches.length)return-i;if(0===t.patches.length)return i;return Xd(e.patches.data[0],t.patches.data[0],i)}(e,t,this.renderOrder)))}return this.patchGroupsDirty=!1,e}_renderCollectOrigins(e){const t=this.rootTiles,i="spherical"===this.manifold;e.clear();for(const r of t){const t=e.pushNew();t.root=r,t.origin=i?Ge:r.centerAtSeaLevel,t.patches.clear(),this._renderCollectOriginsForRoot(e,t)}e.filterInPlace((e=>e.patches.length>0))}_renderCollectOriginsForRoot(e,t){const i=this.tileIterator;i.resetOne(t.root);const r=this.patchGroupsMap;for(r.clear(),r.set(t.origin,t);!i.done;){const t=i.next(),s=t.renderData;if(!s||t.visible){if(t.lij[0]%7==0){const i=e.pushNew();i.root=t,i.origin=t.centerAtSeaLevel,r.set(t.centerAtSeaLevel,i),i.patches.clear()}if(t.rendered){if(s){const e=r.get(s.localOrigin);e&&e.patches.push(t),(!this.highestVisibleLODTile||t.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=t),i.skipSubtree()}}else this.numTilesCulled++}else this.numTilesCulled++,i.skipSubtree()}}_scaleQueriesForTile(e){const t=e.extent,i=e.lij[0];let r=0;for(;r<this.visibleScaleRangeQueriesInvPtr;){const e=this.visibleScaleRangeQueries.data[r],s=e.extent;i>=e.minLevel&&i<=e.maxLevel&&s[0]<=t[2]&&s[2]>=t[0]&&s[1]<=t[3]&&s[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(r,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):r++}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i,r){this.shaderTechnique.bindPipelineState(e.rctx);const s=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),0!==r&&this._bindOverlayData(t,r);for(let a=0;a<i.length;a++){const n=i.data[a];this._bindPatchGroupData(t,n,e.camera.eye,e.camera.viewMatrix);for(let i=0;i<n.patches.length;i++)this._renderPatch(e.rctx,t,n.patches.data[i],4,s,r)}e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i,r){const s=e.rctx,a=e.camera,n=a.viewMatrix;if(this.shaderTechnique.bindPipelineState(s),this.shaderTechniqueConfig.screenSizePerspective&&this.pointsOfInterest){const e=ao("spherical"===this.manifold?1:2,this.ellipsoidRadius),i=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:i,fovY:a.fovY}),Yn(e,t,"screenSizePerspective")}const o=this.stencilEnabledLayerExtents.length>0,l=3===r;l&&(s.bindTexture(this.emptyTex,0),t.setUniform1f("blend",1),t.setUniform4fv("texOffsetAndScale",Or));const c=l?0:this._skirtScale;t.setUniform1f("skirtScale",c);const d=this.wireframe?1:4;for(let c=0;c<i.length;c++){const p=i.data[c],m=p.patches;if(0===m.length)continue;this._bindPatchGroupData(t,p,a.eye,n);const f=e.sliceHelper&&e.sliceHelper.plane;In.bindUniforms(t,this.shaderTechnique.configuration,f,p.origin),e.shadowMap&&e.shadowMap.bindView(t,p.origin),this.numOriginsRendered++;for(let e=0;e<m.length;e++){const i=m.data[e],a=i.renderData.textureReference;if(u(a))continue;if(Zd(i),i.screenDepth,!l){this._scaleQueriesForTile(i),zD(i.renderData.geometryInfo.uvOffsetAndScale,a.offsetAndScale,ID),t.setUniform4fv("texOffsetAndScale",ID),s.bindTexture(a.texture.texture,0);const e=i.renderData.textureFadeFactor,r=e<1?i.renderData.nextTextureReference:null;this.shaderTechniqueConfig.textureFadingEnabled&&h(r)?(zD(i.renderData.geometryInfo.uvOffsetAndScale,r.offsetAndScale,ID),t.setUniform1f("textureFadeFactor",e),t.setUniform4fv("nextTexOffsetAndScale",ID),s.bindTexture(r.texture.texture,1)):(t.setUniform1f("textureFadeFactor",1),s.bindTexture(this.emptyTex,1)),i.renderData.textureIsFading&&this.setNeedsRender(),t.setUniform1f("opacity",i.renderData.opacity)}const n=this._renderPatch(s,t,i,d,o,r);i.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=n/3}}s.bindVAO(null)}_renderPatch(e,t,i,r,s,a){0!==a&&this._bindOverlayPatchData(t,i.renderData.overlay),s&&(this._useStencilForTile(i)?this.stencilShaderTechnique.bindPipelineState(e):this.shaderTechnique.bindPipelineState(e));const n=0===this._skirtScale?i.renderData.geometryInfo.numWithoutSkirtIndices:i.renderData.vao.indexBuffer.size;return e.bindVAO(i.renderData.vao),t.assertCompatibleVertexAttributeLocations(i.renderData.vao),e.drawElements(r,n,i.renderData.vao.indexBuffer.indexType,0),n}_bindPatchGroupData(e,t,i,r){e.setUniform3fv("origin",t.origin),Mi(UD,r,t.origin),e.setUniformMatrix4fv("view",UD),e.setUniform3f("camPos",i[0]-t.origin[0],i[1]-t.origin[1],i[2]-t.origin[2])}_bindOverlayData(e,t){e.setUniform1i("ovInnerColorTex",2),e.setUniform1i("ovOuterColorTex",3),e.setUniform1i("ovInnerWaterTex",4),e.setUniform1i("ovOuterWaterTex",5),e.setUniform1f("overlayOpacity",this.overlayOpacity);const i=this.overlayRenderer.overlays,r=e=>{if(h(i)){const r=i[e],s=(1===t?r.renderTargets.color:2===t?r.renderTargets.highlight:r.renderTargets.occluded).fbo.getTexture();this.rctx.bindTexture(s,2+e);const a=1===t?r.renderTargets.water:null;if(a){const t=a.fbo.getTexture();this.rctx.bindTexture(t,4+e)}else this.rctx.bindTexture(this.emptyTex,4+e)}else this.rctx.bindTexture(this.emptyTex,2+e),this.rctx.bindTexture(this.emptyTex,4+e)};r(0),r(1)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_setTerrainTechnique(e,t){if(this.shaderTechniqueConfig.output=e,0===e){const e="spherical"===this.manifold;this.shaderTechniqueConfig.atmosphere=e&&this._velvetOverground,this.shaderTechniqueConfig.ssrEnabled=this._ssrEnabled}this.shaderTechniqueConfig.renderOccluded=t,this.shaderTechniqueConfig.stencilEnabled=!1,this.shaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(DD,this.shaderTechniqueConfig,this.shaderTechnique),this.shaderTechniqueConfig.stencilEnabled=!0,this.stencilShaderTechnique=this.shaderTechniques.acquireAndReleaseExisting(DD,this.shaderTechniqueConfig,this.stencilShaderTechnique)}releaseTileGeometry(e){e.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e)}_prepareScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;for(;e.length<e.data.length&&t.length>0;){const i=t.pop();e.push(i)}this.visibleScaleRangeQueriesInvPtr=e.length}_processScaleRangeQueries(){const e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool;for(let i=0;i<e.length;i++){const r=e.data[i];t.release(r),r.callback(i>=this.visibleScaleRangeQueriesInvPtr),r.callback=null}e.clear()}get test(){return{tileRenderer:this.tileRenderer}}};e([S()],FD.prototype,"tileBackgroundInitialized",void 0),e([S()],FD.prototype,"tileBackgroundUpdating",void 0),e([S({constructOnly:!0})],FD.prototype,"manifold",void 0),e([S({constructOnly:!0})],FD.prototype,"overlayRenderer",void 0),e([S({constructOnly:!0})],FD.prototype,"ellipsoidRadius",void 0),e([S({readOnly:!0,dependsOn:["tileBackgroundInitialized","tileBackgroundUpdating"]})],FD.prototype,"updating",null),e([S({value:!1})],FD.prototype,"renderingDisabled",null),e([S()],FD.prototype,"renderPatchBorders",null),e([S()],FD.prototype,"cullBackFaces",null),e([S({value:1})],FD.prototype,"renderOrder",null),e([S()],FD.prototype,"wireframe",null),FD=e([re("esri.views.3d.terrain.TerrainRenderer")],FD);var VD=FD;function zD(e,t,i){const r=e[0]*t[2]+t[0],s=e[1]*t[3]+t[1],a=e[2]*t[2],n=e[3]*t[3];bs(i,r,s,a,n)}const UD=jr(),kD=je(),jD=je(),GD=je(),BD=je(),ND=je(),qD="TerrainRenderer";class HD{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}class WD{constructor(){this.offset=cn(),this.scale=0,this.tile=null}init(e,t,i,r){this.tile=e,this.offset[0]=t,this.offset[1]=i,this.scale=r}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const ZD=d.getLogger("esri.views.3d.terrain.TerrainSurface");let QD=class extends(se.EventedMixin(T)){constructor(e){super(e),this._clippingExtent=null,this._dataExtent=null,this._elevationBounds=new XM,this._rootExtent=Li(),this._iteratorPool=new t(Qd),this._postorderIterator=new Kd,this.pendingUpdates=!1,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=KD,this._performanceInfo=new HD,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._overlayOpacity=1,this._eyePosRenderSR=je(),this._eyePosSurfaceSR=je(),this._splitLimits=new GO,this._snapLevel=1/0,this._frustum=nl.create(),this._viewProjectionMatrix=jr(),this._layerViews=[new Array,new Array],this._layerIndexByLayerViewId=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new $t,this._allTiles=new R,this._upsampleInfoPool=new t(WD),this._visibleLevels=new R({deallocator:null}),this._getElevationData={spatialReference:null,rootTiles:null},this.maxTextureScale=1.2,this.rootTiles=null,this.backgroundImage=Ga,this.backgroundColor=null,this._layerViewsDirty=!1}initialize(){this._stage=this.view._stage,this._lercDecoder=Vs(this.view.resourceController.scheduler),this._tilePool="planar"===this.manifold?new t(YO):new t($O),this._upsampleMapCache=this.view.resourceController.memoryController.getMemCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._set("overlayManager",new sO({surface:this})),this._handles.add([this.watch("overlayManager.hasHighlights",(e=>this._renderer.setNeedsHighlight(e))),this.watch("overlayManager.rendersOccluded",(e=>this._renderer.setRenderOccludedOverlay(e)))],"overlayManager"),this._renderer=new VD({manifold:this.manifold,overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:Kt(this.view.spatialReference).radius}),this._renderer.install(this.view._stage),this._handles.add([hi(this,"baseOpacity",(e=>{this._handleLayerViewChanges(),this._updateBaseOpacity(e)}),!0),hi(this,"_background",(()=>{this._handleLayerViewChanges(),this._renderer.setTileBackground(this._background)}),!0),this.view.watch("pointsOfInterest",(e=>{this._renderer.pointsOfInterest=e,this._handles.remove("poi"),e&&this._handles.add(e.focus.watch("renderLocation",(()=>this._allTilesSorted=!1)),"poi")})),gi(xc,"TERRAIN_DEBUG_POPUP",(()=>{import("../chunks/TerrainDebugPopupOpener.js").then((e=>{const t=new e.TerrainDebugPopupOpener({surface:this});mi(xc,"TERRAIN_DEBUG_POPUP",(()=>t.destroy()))}))}))]);const e={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper="spherical"===this.manifold?new eD(e):new tD(e),this._handles.add(hi(this.extentHelper,"stencilEnabledExtents",(e=>this._renderer.setStencilEnabledLayerExtents(e))),"extentHelper");const i=this.view.defaultsFromMap?new Xt({root:this.view.map,rootCollectionNames:this.view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:e=>e.layers}):this.view.map.allLayers,r=new sD({layers:i,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",r),this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",(()=>this._updateTilingSchemeAndExtent()),!0),this.tilingSchemeLogic.watch("extent",(()=>this._updateTilingSchemeAndExtent()),!0)],"tilingSchemeLogic"),this._updateTilingSchemeAndExtent(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);const s=this.view.resourceController.scheduler;this._frameTask=s.registerTask(xr.TERRAIN_SURFACE,(e=>this._update(e)),(()=>this.updating)),this.view.resourceController.memoryController.events.on("quality-changed",(()=>this._viewChangeUpdate())),this._handles.add([this.view.on("resize",(()=>this._viewChangeUpdate())),this.view.watch("state.camera",(()=>this._viewChangeUpdate()),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",(()=>this._viewChangeUpdate())),hi(this.view,"qualitySettings.tiledSurface.textureFadeDuration",(e=>this._renderer.textureFadingEnabled=e>0)),this.view.watch("lodSnapping",(()=>this._viewChangeUpdate())),this.view.watch("clippingArea",(()=>this._clippingChanged()))]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._updateClippingExtent(),this.notifyChange("extent")}destroy(){this._frameTask.remove(),this._handles.destroy(),zs(this._lercDecoder),this._lercDecoder=null,this._removeAllTiles(),this._upsampleMapCache=p(this._upsampleMapCache),this._set("tilingSchemeLogic",p(this.tilingSchemeLogic)),this.extentHelper=p(this.extentHelper),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",p(this.overlayManager)),this._tilePool=p(this._tilePool),HO.prune(0),WO.prune(0),this._renderer.uninstall(this._stage),this._renderer=p(this._renderer),this._iteratorPool=p(this._iteratorPool),this._set("view",null),this._stage=null,this._upsampleInfoPool=p(this._upsampleInfoPool)}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){return Math.round(this._snapLevel)}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get extent(){return this._clippingExtent||this._rootExtent}get updating(){return!(!(this.pendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._renderer.updating||this.overlayManager.updating||this._layerViewsDirty||this._frameTask.updating)||!this.ready||this.suspended)}get ready(){return!!this.rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}set skirtScale(e){this._renderer.skirtScale=e}get skirtScale(){return this._renderer.skirtScale}get spatialReference(){const e=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=e,e}get _background(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage}set slicePlaneEnabled(e){this._renderer.slicePlane=e,this._set("slicePlaneEnabled",e)}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}isOpaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get lodSnapping(){return fe(this.spatialReference)&&this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=this._getElevationData.rootTiles;if(!s||!s.length)return null;if(0===s[0].layerInfo[0].length)return null;const a=JD;if(a[0]=e,a[1]=t,a[2]=i,!rr(a,r,a,this._getElevationData.spatialReference))return ZD.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let e of s){if(!e.containsPoint(a))continue;for(;e&&!e.rendered&&!e.isLeaf;){let t=0;a[0]>.5*(e.extent[0]+e.extent[2])&&(t+=1),a[1]<.5*(e.extent[1]+e.extent[3])&&(t+=2),e=e.children[t]}const t=e.renderData,i=t&&t.geometryState?t.geometryState.samplerData:null;return i?KM.sample(a[0],a[1],i):null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!ir(e,JD,this.spatialReference))return ZD.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(t)for(let e of t)if(e.containsPoint(JD)){for(;null!=e.children[0];){let t=0;JD[0]>e.children[0].extent[2]&&(t+=1),JD[1]<e.children[0].extent[1]&&(t+=2),e=e.children[t]}return this._getLodBiasCorrectedScale(e.level)}}return 1e100}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+n,a+n,r)}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1,this._renderer.isTransparent=this.allTransparentSurfaceLayers();const i=t!==this._renderer.opaque;this._updateTileTextures(i)}_updateTilingSchemeAndExtent(){const e=this.tilingSchemeLogic.extent,t=e&&!Xi(e,this._dataExtent);t&&(this._dataExtent?Ni(this._dataExtent,e):this._dataExtent=Li(e));const i=this.tilingSchemeLogic.tilingScheme,r=i!==this.tilingScheme;r&&(bd(!!i,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",i),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference,"spherical"===this.manifold))),(t||r)&&this._updateRootTiles()}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return tA[0]=e,tA[1]=t,tA[2]=i,s.init(tA,r,this),s}_updateRootTiles(){const e=this._clippingExtent||this._dataExtent,t=this.tilingScheme;if(!e||!t)return;const i=eA;let r=t.rootTilesInExtent(e,i,5*Ba);const s=e=>{const t=this._acquireTile(0,e[1],e[2],null);return 2===t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&t.setPendingUpdate(2),this._loadTile(t),t};if(this.rootTiles){if(r.length>Ba)return void ZD.warn(Na);const e=this.rootTiles.map((e=>e.lij)),t=I(e,r,$D);if(t.removed.length>0||t.added.length>0){const e=this.rootTiles.filter((e=>!(t.removed.findIndex($D.bind(null,e.lij))>-1)||(this._purgeTile(e),!1)));t.added.forEach((t=>e.push(s(t)))),this._setRootTiles(e)}}else r.length>Ba&&(ZD.warn(qa),r=t.rootTilesInExtent(e,i,Ba)),this._setRootTiles(r.map((e=>s(e))));Xi(i,this._rootExtent)||(this._rootExtent=Li(i),this._hasFixedExtent()||this.notifyChange("extent")),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setOverlayPlacementDirty(),this.notifyChange("ready")}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());this._iteratorPool.release(t)}this._getElevationData.rootTiles=e,this._renderer.setRootTiles(this.rootTiles),this._updateTileVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this._stage&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTileVisibility(this.rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this._clippingExtent)&&e.resetPendingUpdate(32)&&this._updateTileGeometry(e)}_updateTileVisibility(e){if(!e)return;const t=this._iteratorPool.acquire();let i,r;for(t.reset(e),Jd(e)?(i=this._elevationBounds.min,r=this._elevationBounds.max):(i=1/0,r=-1/0);!t.done;){const e=t.next();this._updateClippingStatus(e),e.updateVisibility(),e.setPendingUpdate(16),e.visible?(e.updateScreenDepth(this._viewProjectionMatrix),e.renderData&&(i=Math.min(e.elevationBounds[0],i),r=Math.max(e.elevationBounds[1],r))):t.skipSubtree()}this._iteratorPool.release(t),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const e=this.view.state.camera,t=Math.tan(.5*e.fovX),i=Math.tan(.5*e.fovY),r=this.tilingScheme.pixelSize,s=Math.pow(2,-this.lodBias)*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=i,this._splitLimits.relativeWidthLimit=r/e.width*this.maxTextureScale*s,this._splitLimits.relativeHeightLimit=r/e.height*this.maxTextureScale*s,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,nl.copy(e.frustum,this._frustum),wi(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),Xe(this._eyePosRenderSR,e.eye),rr(this._eyePosRenderSR,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateSnapLevel(){if(0===this.lodSnapping)return!1;const e=this._computeSnapLevel();if(Math.abs(this._snapLevel-e)<.25)return!1;const t=this.snapLevel;return this._snapLevel=e,t!==this.snapLevel}_computeSnapLevel(){if(this._visibleLevels.length<=0)return this._snapLevel;const e=Math.abs(this.view.camera.tilt-90)/90*.4+.3,t=this._visibleLevels,i=Math.round(t.length*e);if(i>=t.length)return this._snapLevel;t.sort(((e,t)=>e-t));let r=0;for(let e=i;e<t.length;++e)r+=t.getItemAt(e);const s=t.getItemAt(Math.round(.95*t.length)-1),a=r/(t.length-i);return Re(a,s-1,this._splitLimits.maxLod)}_updateSkirts(){const e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;this.skirtScale=Od(this,this._eyePosSurfaceSR,t)}_updateRenderData(e){e.rendered&&!e.shouldRender&&(XD(e)?this._loadChildren(e):function(e){return e.isLeaf&&e.parent&&e.parent.shouldRender}(e)&&this._loadParent(e))}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=KD}_elevationUpdate(e){rA.spatialReference=this.spatialReference,rA.tile=e,rA.extent=e.extent,this.emit("elevation-change",rA),Ii(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()}_update(e){this._handleLayerViewChanges(e),this._inFrameTask=!0,this.pendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e),this._mergeAndSplit(e),e.run((()=>this._updateElevation(e))),e.run((()=>this._updateTextures(e))),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done&&(this.pendingUpdates=!0)}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const e=t.next();if(e.visible){const i=e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===i){e.resetPendingUpdate(8),e.isLeaf&&(e.setPendingUpdate(2),t.skipSubtree());continue}e.resetPendingUpdate(2)&&e.updateAgentSuspension(),4===i&&e.updateAgents(0)}if(t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(8),e.resetPendingUpdate(2);const t=this._iteratorPool.acquire();t.resetOne(e);for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.visible&&e.updateScreenDepth(this._viewProjectionMatrix);this._iteratorPool.release(t)}}this._iteratorPool.release(t),this.pendingUpdates=!0,e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(eu(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,e.madeProgress())}_mergeAndSplit(e){if(this.suspended||!this._allTilesDirty||e.done)return;this._allTilesDirty=!1,this.pendingUpdates=!0;const t=this._eyePosRenderSR;let i=0;const r=1===this.lodSnapping?e=>{const i=e.shouldSplit(this._splitLimits,t,0);e.visible&&(2!==i&&e.parent&&2===e.parent.shouldSplit(this._splitLimits,t,0)?1===i?this._visibleLevels.fill(e.level+1,4):this._visibleLevels.push(e.level):e.isLeaf&&2===i&&this._visibleLevels.fill(e.level+1,3))}:()=>{};for(;!e.done;){let t=!1;i=0,this._visibleLevels.clear();const s=!this._allTiles.some((s=>(i+=s.usedMemory,r(s),s.resetPendingUpdate(8)?(this._mergeTile(s),t=!0,e.madeProgress()):s.resetPendingUpdate(2)&&(this._splitTile(s),t=!0,e.madeProgress()),s.resetPendingUpdate(16)&&(this._updateRenderData(s),e.madeProgress()),e.done)));if(t&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(this._usedMemory=i,!t){if(!this._updateSnapLevel())break;this._updateTileVisibility(this.rootTiles)}}else this._allTilesDirty=!0}0===i&&(this._allTilesDirty=!0),this._visibleLevels.clear(),this._sortTiles(e)}_updateElevation(e){return this._allTiles.some((t=>(t.resetPendingUpdate(32)&&(this._updateTileGeometry(t),e.madeProgress()),e.done))),e.hasProgressed}_updateTextures(e){return this._allTiles.some((t=>(t.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(t),this._usedMemory=KD,e.madeProgress()),e.done))),e.hasProgressed}_updateClippingExtent(){if(!this.spatialReference)return!1;const e=Li();let t=null;return vP(this.view.clippingArea,e,this.spatialReference)&&(t=e),!Xi(t,this._clippingExtent)&&(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),this.updateTileOverlayParams(),this.overlayManager.setOverlayPlacementDirty(),!0)}_clippingChanged(){this._updateClippingExtent()&&this._updateRootTiles()}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Ha}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=Re(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){this.rootTiles&&(this.rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeChildTiles(e){if(e.isLeaf)return!1;let t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t}_purgeTile(e){const t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._tilePool.release(e),t}_splitTile(e){bd(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(16),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){sA.spatialReference=this.spatialReference,sA.extent=e.extent,sA.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",sA)}_createTile(e,t,i,r){bd(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this._clippingExtent),s.visible&&(s.updateScreenDepth(this._viewProjectionMatrix),2===s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&s.setPendingUpdate(2)),s}_mergeTile(e){bd(!e.hasPendingUpdate(2),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(bd(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)}_loadChildren(e){bd(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t)}_unloadChildren(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))}_loadTile(e){e.load(this._renderer),e.setPendingUpdate(16),this.pendingUpdates=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)}_elevationDataArrived(e,t,i){const r=new KM(e.lij,e.extent,i);e.dataArrived(t,0,r);const s=[e],a=e.level,n=this._iteratorPool.acquire();for(n.reset(s);!n.done;){const e=n.next();e.findElevationBoundsForLayer(t,a),e.computeElevationBounds()}this._iteratorPool.release(n),this._updateTileVisibility(s)}_handleLayerViewChanges(e=br){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const e of this.view.allLayerViews.items)if(i.add(e.uid),Dd(e))if(this._basemapLayerViewHandles.has(e.uid)){const i=this.layerClassFromLayerView(e),s=this._layerIndexByLayerViewId[i].get(e.uid);s<r&&(t=!0),r=s}else this._registerTiledLayerView(e),e.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this._renderer.isTransparent=this.allTransparentSurfaceLayers(),e.madeProgress()}allTransparentSurfaceLayers(){let e=0===this.view.map.ground.opacity;for(const t of this.view.allLayerViews.items)if(Dd(t)&&!Ad(t)&&!Sa(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}layerClassFromLayerView(e){return Ad(e)?0:1}_registerTiledLayerView(e){const t=[],i=this.layerClassFromLayerView(e);t.push(e.watch("suspended",(()=>this._updateTiledLayers()))),t.push(e.watch("fullOpacity",(()=>this._updateTileTextures(!1)))),t.push(e.layer.watch("scaleRangeId",(()=>this._restartAllAgents(i)))),e.on("data-changed",(()=>{const t=this._layerIndexByLayerViewId[i].get(e.uid);null!=t&&this._invalidateLayerData(t,i)})),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let e=0;e<t.length;e++)t[e].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;const r=Fi();e.forEach((e=>{const s=e.layer;if(!s||e.suspended||!Dd(e))return;const a=e.fullExtent;if(!a)return void ZD.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id);if(!this.tilingScheme.compatibleWith(e.tileInfo))return void ZD.warn("Terrain: tiling scheme of layer "+s.id+" is incompatible with other tiled layers, will not be drawn");ki(r,a);const n=this.layerClassFromLayerView(e);if(1===n){const t=e.displayLevelRange;t.maxLevel!==1/0&&(null===i||t.maxLevel>i)&&(i=t.maxLevel)}t[n].push(e)}));for(let e=0;e<2;e++){const i=this._layerViews[e],r=t[e];r.reverse();const s=r.length;let a=i.length!==s;const n=new Array(s),o=new Array(i.length);this._layerIndexByLayerViewId[e].clear();for(let t=0;t<s;t++){const s=r[t].uid;this._layerIndexByLayerViewId[e].set(s,t);const l=i.indexOf(r[t]);n[t]=l,t!==l&&(a=!0),l>-1&&(o[l]=t)}if(a){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;)t.next().modifyLayers(o,n,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTileVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds()}}_hasFixedExtent(){return!!this._clippingExtent}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(1),e?this.renderer.updateTileTexture(t):t.updateRenderData(1)})),this._renderer.isTransparent=this.allTransparentSurfaceLayers()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=1){this.renderer.setNeedsRender(e)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),a=s.layer;return!a.tilemapCache||Sd(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,U(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){return 0===t?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)}_requestElevationTileData(e,t,i){if(!Ad(t))return void bd(!1,"_requestElevationTileData can only be called for elevation layer views");const r=r=>{if(--this._asyncWorkItems,Z(i))return;const s=this._layerIndexByLayerViewId[0].get(t.uid);null!=s?(this._usedMemory=KD,this.pendingUpdates=!0,this._elevationDataArrived(e,s,r)):ZD.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString())},s=i=>{--this._asyncWorkItems,U(i)||(this._dataMissing(e,0,t,i),this.pendingUpdates=!0)};if(++this._asyncWorkItems,Ed(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:Ia,signal:i.signal}).then((e=>{if(Z(i))return ZD.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(B());r(e)}),s);const a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(a,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:Ia},i.signal))).then((e=>{r({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})}),s)}_requestMapTileData(e,t,i){if(t instanceof YM)return $();++this._asyncWorkItems;const r=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.pendingUpdates=!0,Z(i)?vd(r):this._dataArrived(e,1,t,r)}),i.signal).catch(s),s=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,Z(i)||(this._dataMissing(e,1,t,r),this.pendingUpdates=!0)}));if(Sd(t)){const a=t.schemaHelper.getLevelRowColumn(e.lij);return t.tileHandler.getVectorTile(a[0],a[1],a[2],i).then((e=>{e.neededForCoverage=!0,e.transforms.tileUnitsToPixels=pn(1/8,0,0,0,1/8,0,0,0,1),function(e,t){const i=[],r=new Gd(4096,i,(()=>{const e=new Vd;return e.show=!1,e.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),e.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),e})),s=new Bd(i,r,((t,i,r)=>new Nd(t,i,r,e.styleRepository,e.key.level,0)),((e,t)=>{Fd(e,t,!1)}),(()=>0),(e=>{const i=t.getStyleLayerByUID(e).getLayoutProperty("visibility");return!i||"none"!==i.getValue()}));i.push(e),r.add(e),s.setScreenSize(512,512),s.continue(1/0)}(e,t.layer.styleRepository),r(e)}),s)}if(Id(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(r,s);if(Ed(t.layer)&&Ld(t))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(Z(i))return ZD.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void s(B());r(e)}),s);let a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);(function(e){return null!=e.refreshInterval})(t)&&t.refreshTimestamp&&(a+=`${a.indexOf("?")>-1?"&":"?"}_ts=${t.refreshTimestamp}`);const n=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(a,n,i).then(r,s)}_dataArrived(e,t,i,r){const s=this._layerIndexByLayerViewId[t].get(i.uid);null!=s?e.dataArrived(s,t,r):ZD.warn("TerrainSurface: received data from unknown layer")}_dataMissing(e,t,i,r){const s=this._layerIndexByLayerViewId[t].get(i.uid);null!=s?e.dataMissing(s,t,r):ZD.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender())}updateOverlayOpacity(){if(!this.overlayManager)return;const e=this._eyePosSurfaceSR[2],t=this.overlayManager.computeOpacity(e);t!==this._overlayOpacity&&(this._overlayOpacity=t,this._renderer.overlayOpacity=t,this._renderer.setNeedsRender())}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}getUsedMemory(){return this.tilingScheme?(this._usedMemory===KD&&(this._usedMemory=0,this._allTiles.forAll((e=>this._usedMemory+=e.usedMemory))),this._usedMemory):0}getUsedMemoryForLayerView(e){let t=0;const i=this.layerClassFromLayerView(e),r=this._layerIndexByLayerViewId[i].get(e.uid);return this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}getTile(e){const t=e.split("/").map((e=>+e));if(0===t[0])return this.rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=Math.pow(2,t[0]),r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let a;if(this.rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(a=e,!0))),a){let e=1<<t[0]-1;for(;a.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!a.children[i])return null;a=a.children[i],e>>=1}return bd(a.lij[0]===t[0]&&a.lij[1]===t[1]&&a.lij[2]===t[2],"not the right tile?"),a}return null}getRenderedTiles(){return iA.clear(),this._allTiles.forAll((e=>{e.visible&&e.rendered&&iA.push(e)})),$d(this.renderOrder,iA),iA.toArray()}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate()},getTiles:()=>e._allTiles.toArray()}}};e([S()],QD.prototype,"_renderer",void 0),e([S()],QD.prototype,"pendingUpdates",void 0),e([S()],QD.prototype,"_asyncWorkItems",void 0),e([S()],QD.prototype,"_allTilesDirty",void 0),e([S()],QD.prototype,"_allTilesSorted",void 0),e([S()],QD.prototype,"_viewChanged",void 0),e([S()],QD.prototype,"_frameTask",void 0),e([S({constructOnly:!0})],QD.prototype,"view",void 0),e([he("_renderer.cullBackFaces")],QD.prototype,"cullBackFaces",void 0),e([S({readOnly:!0,dependsOn:[],autoTracked:!1})],QD.prototype,"extent",null),e([S({readOnly:!0,dependsOn:["ready","suspended","pendingUpdates","_asyncWorkItems","_allTilesDirty","_allTilesSorted","_renderer.updating","_layerViewsDirty","overlayManager.updating","_frameTask.updating"]})],QD.prototype,"updating",null),e([S({aliasOf:"view.map.ground.opacity"})],QD.prototype,"baseOpacity",void 0),e([S({readOnly:!0})],QD.prototype,"overlayManager",void 0),e([S({constructOnly:!0})],QD.prototype,"manifold",void 0),e([S()],QD.prototype,"maxTextureScale",void 0),e([S({readOnly:!0,autoTracked:!0})],QD.prototype,"ready",null),e([S({value:1})],QD.prototype,"renderOrder",null),e([S({readOnly:!0})],QD.prototype,"rootTiles",void 0),e([S({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],QD.prototype,"spatialReference",null),e([S()],QD.prototype,"backgroundImage",void 0),e([S({type:At,aliasOf:"view.map.ground.surfaceColor"})],QD.prototype,"backgroundColor",void 0),e([S({dependsOn:["backgroundColor","backgroundImage"]})],QD.prototype,"_background",null),e([S({value:!1})],QD.prototype,"slicePlaneEnabled",null),e([S({readOnly:!0})],QD.prototype,"tilingScheme",void 0),e([S({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],QD.prototype,"tilingSchemeLocked",void 0),e([S({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],QD.prototype,"tilingSchemeDone",void 0),e([S({readOnly:!0})],QD.prototype,"tilingSchemeLogic",void 0),e([S({value:!0})],QD.prototype,"velvetOverground",null),e([he("_renderer.wireframe")],QD.prototype,"wireframe",void 0),e([S({value:!1})],QD.prototype,"suspended",null),e([S({readOnly:!0,dependsOn:["view.qualitySettings.tiledSurface.reduceTileLevelDifferences"]})],QD.prototype,"lodSnapping",null),e([S({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],QD.prototype,"textureFadeDuration",void 0),e([S()],QD.prototype,"_layerViewsDirty",void 0),e([he("_renderer.renderPatchBorders")],QD.prototype,"renderPatchBorders",void 0),e([he("_renderer.renderingDisabled")],QD.prototype,"renderingDisabled",void 0),QD=e([re("esri.views.3d.terrain.TerrainSurface")],QD);var YD=QD;function $D(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function XD(e){return!e.isLeaf&&(e.children[0].shouldRender||e.children[1].shouldRender||e.children[2].shouldRender||e.children[3].shouldRender||XD(e.children[0])||XD(e.children[1])||XD(e.children[2])||XD(e.children[3]))}const KD=-1,JD=Tr(),eA=Li(),tA=[0,0,0],iA=new R,rA={spatialReference:null,tile:null,extent:null,context:"ground"},sA={spatialReference:null,extent:null,scale:0};class aA{constructor(e){this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this._model=e}get residentLayerCount(){return this._residentGeomRecords.size}get residentObjectCount(){let e=0;return this._residentGeomRecords.forEach((t=>{e+=t.size})),e}hasDirtyGeometryRecords(){return ua(this._dirtyGeomRecords,(e=>ua(e,(e=>e&&e.size>0))))}handleUpdate(e,t,i){return Vl(this[t],"ModelDirtySet doesn't know how to process "+t),this[t](e,i)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const i=this._model.get(1,t);i&&i.hasVolativeTransformation()&&e.forEach((e=>{for(const t of e[1])t.shaderTransformationChanged()}))}))}commit(){return this.commitLayers(this._dirtyGeomRecords.keys())}commitLayers(e){const t=[],i=[],r=[];for(const s of e){const e=this._dirtyGeomRecords.get(s);e&&(e.forEach(((e,a)=>{const n=this._ensureGeomRecord(s,a);e.forEach(((e,s)=>{const o=e[0],l=e[1],c=e[2];let h=!1;if(2&l){const e=n.get(s);if(e){const t=e[1];if(4&c){const e=this._model.get(1,a);for(const i of t)if(this._model.updateRenderGeometryTransformation(e,o,i)){h=!0;break}}if(!h)for(const e of t)r.push({renderGeometry:e,updateType:c})}else Vl(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(4&l||h){const e=n.get(s);e?i.push.apply(i,e[1]):4===l&&Vl(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove"),e&&n.delete(s)}if(1&l||h){const e=[o,[]],i=this._model.get(1,a);this._model.getGeometryRenderGeometries(i,o,e[1]),t.push.apply(t,e[1]),n.set(s,e)}})),0===n.size&&this._residentGeomRecords.get(s).delete(a)})),0===this._residentGeomRecords.get(s).size&&this._residentGeomRecords.delete(s),this._dirtyGeomRecords.delete(s))}return[t,i,r]}getResidentRenderGeometries(){return this.getResidentRenderGeometriesFilteredByLayers([...this._residentGeomRecords.keys()])}getResidentRenderGeometriesFilteredByLayers(e){const t=[];for(let i=0;i<e.length;i++){const r=e[i],s=this._residentGeomRecords.get(r);s&&s.forEach((e=>{e.forEach((e=>{t.push(...e[1])}))}))}return t}_objectStateChanged(e,t,i,r){if(null!=i)this._componentPropertyChanged(t,i,r,e);else for(const i of t.geometryRecords)this._componentPropertyChanged(t,i,r,e)}visibilityChanged(e,t,i){this._objectStateChanged(1,e,t,i)}highlightChanged(e,t,i){this._objectStateChanged(8,e,t,i)}occlusionChanged(e,t,i){this._objectStateChanged(16,e,t,i)}vertexAttrsUpdated(e,t,i){this._updateOrCreateDirtyRecord(e,t,i,2,0,0,2,5,2)}layerAdded(e){const t=e.getObjects();for(let i=0;i<t.length;i++)this.layerObjectAdded(e,t[i])}layerRemoved(e){const t=e.getObjects();for(let i=0;i<t.length;i++)this.layerObjectRemoved(e,t[i])}layerObjectAdded(e,t){const i=e.id,r=t.geometryRecords;for(let e=0;e<r.length;e++)this.objGeometryAdded(t,r[e],i)}layerObjectRemoved(e,t){const i=e.id,r=t.geometryRecords;for(let e=0;e<r.length;e++)this.objGeometryRemoved(t,r[e],i)}layObjectReplaced(e,t){this.layerObjectRemoved(e,t[0]),this.layerObjectAdded(e,t[1])}objTransformation(e,t){t=t||this._getParentLayerId(e);const i=e.id;this._ensureGeomRecord(t,i).forEach((i=>{this._updateOrCreateDirtyRecord(e,i[0],t,2,0,0,2,5,4)}))}objGeometryAdded(e,t,i){this._updateOrCreateDirtyRecord(e,t,i,1,4,0,0,0)}objGeometryRemoved(e,t,i){this._updateOrCreateDirtyRecord(e,t,i,4,1,2,0,0)}_componentPropertyChanged(e,t,i,r){this._updateOrCreateDirtyRecord(e,t,i,2,0,0,2,5,r)}_updateOrCreateDirtyRecord(e,t,i,r,s,a,n,o,l){i=i||this._getParentLayerId(e);const c=e.id,h=t.id,d=this._ensureDirtyRecord(i,c),u=d.get(h);if(u){const e=u[1];e&s?d.delete(h):e&a?(u[1]=r,u[2]=l):e&n?u[2]|=l:e&o||Vl(!1,"ModelDirtySet.objGeometryAdded: inconsistent state")}else d.set(h,[t,r,l])}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return e.parentLayer.id}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((i,r)=>{i.forEach(((i,s)=>{t.length>0&&(t+="\n"),t+=r+"."+s;const a=[];i.forEach((e=>{const t=e[1];a[t]||(a[t]=[]),a[t].push(e[0].geometry.id)}));for(let i=0;i<a.length;i++)if(a[i]){t+=" "+e[i-1]+": ";for(let e=0;e<a[i].length;e++)t+=a[i][e]+", "}}))})),t}}const nA=Vl,oA=zl;class lA{constructor(){this.dirtySet=new aA(this),this._id2origin={},this._content=new Array(5);for(let e=0;e<5;++e)this._content[e]=new Map}getAll(e){const t=this._content[e];return nA(void 0!==t),t}get(e,t){return this.getAll(e).get(t)}add(e,t){const i=this._content[e];nA(void 0!==i);const r=t.id;nA(!i.has(r),"Model/Stage already contains object to be added"),i.set(r,t),0===e&&this.notifyDirty(t,"layerAdded")}remove(e,t){const i=this._content[e];nA(void 0!==i);const r=i.get(t);return nA(void 0!==r,"Model/Stage doesn't contain object to be removed"),i.delete(t),4===e&&r.unload(),0===e&&this.notifyDirty(r,"layerRemoved"),r}getDirtySet(){return this.dirtySet}notifyDirty(e,t,i){this.dirtySet.handleUpdate(e,t,i)}getOrigin(e,t,i=10){let r=0;const s=t*i/1e4;s>1&&(r=Math.ceil(oA(s,2)));const a=1e4*Math.pow(2,r),n=Math.round(e[0]/a),o=Math.round(e[1]/a),l=Math.round(e[2]/a),c=r+"_"+n+"_"+o+"_"+l;let h=this._id2origin[c];return null==h&&(h=Dc(n*a,o*a,l*a,c),this._id2origin[c]=h),h}getGeometryRenderGeometries(e,t,i){const r=t.geometry,s=e.getCombinedStaticTransformation(t),a=Rt(s),n=t.origin,o=new td(r.data,r.boundingInfo,t.material,s,t.shaderTransformation,a,e.castShadow);o.uniqueName=t.id,o.origin=n||this.getOrigin(o.center,o.bsRadius),o.instanceParameters=t.instanceParameters,i.push(o)}updateRenderGeometryTransformation(e,t,i){const r=e.getCombinedStaticTransformation(t,i.transformation);i.updateTransformation(r);const s=this.getOrigin(i.center,i.bsRadius);return i.origin!==s}getStats(){const e={};for(let t=0;t<5;++t)e[t]=this.getAll(t).size;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}validateObject(e){const t=e.geometryRecords;for(let e=0;e<t.length;++e){const i=t[e];nA(null!=this.get(2,i.geometry.id)),nA(null!=this.get(3,i.material.id))}}validateLayer(e){const t=e.getObjects();for(let e=0;e<t.length;++e){const i=this.get(1,t[e].id);nA(null!=i)}}}const cA=[0,0,0],hA=[0,0,0];function dA(e,t){const{data:i,strideIdx:r}=e,s=i.length/r;if(s<=0)return;const a=new qA(e);ZA(cA,a.minProj,a.maxProj),YA(cA,cA,.5),QA(hA,a.maxProj,a.minProj);const n=WA(hA),o=new HA;o.quality=n,s<14&&(e={data:new Float64Array(a.buffer,112,42),size:3,offsetIdx:0,strideIdx:3});const l=[0,0,0],c=[0,0,0],h=[0,0,0],d=[0,0,0],u=[0,0,0],p=[0,0,0],m=[0,0,0];switch(function(e,t,i,r,s,a,n,o,l,c){if(function(e,t,i){let r=eE(e.maxVert[0],e.minVert[0]),s=0;for(let t=1;t<7;++t){const i=eE(e.maxVert[t],e.minVert[t]);i>r&&(r=i,s=t)}$A(t,e.minVert[s]),$A(i,e.maxVert[s])}(e,r,s),eE(r,s)<1e-6)return 1;QA(n,r,s),KA(n,n);if(function(e,t,i,r){const{data:s,offsetIdx:a,strideIdx:n}=e;let o=Number.NEGATIVE_INFINITY,l=0;for(let e=a;e<s.length;e+=n){xA[0]=s[e]-t[0],xA[1]=s[e+1]-t[1],xA[2]=s[e+2]-t[2];const r=i[0]*xA[0]+i[1]*xA[1]+i[2]*xA[2],a=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],n=xA[0]*xA[0]+xA[1]*xA[1]+xA[2]*xA[2]-r*r/a;n>o&&(o=n,l=e)}return $A(r,s,l),o}(t,r,n,a)<1e-6)return 2;return QA(o,s,a),KA(o,o),QA(l,a,r),KA(l,l),XA(i,o,n),KA(i,i),MA(t,i,n,o,l,c),0}(a,e,m,l,c,h,d,u,p,o)){case 1:return void AA(cA,hA,t);case 2:return void UA(e,d,t)}!function(e,t,i,r,s,a,n,o,l){(function(e,t,i,r,s){!function(e,t,i,r,s){const{data:a,offsetIdx:n,strideIdx:o}=e;$A(r,a,n),$A(s,r),i[0]=tE(OA,t),i[1]=i[0];for(let e=n+o;e<a.length;e+=o){const n=a[e]*t[0]+a[e+1]*t[1]+a[e+2]*t[2];n<i[0]&&(i[0]=n,$A(r,a,e)),n>i[1]&&(i[1]=n,$A(s,a,e))}}(e,t,bA,s,r);const a=tE(i,t);bA[1]-1e-6<=a&&(r[0]=void 0);bA[0]+1e-6>=a&&(s[0]=void 0)})(e,t,i,uA,pA),void 0!==uA[0]&&(QA(mA,uA,i),KA(mA,mA),QA(fA,uA,r),KA(fA,fA),QA(gA,uA,s),KA(gA,gA),XA(vA,fA,a),KA(vA,vA),XA(yA,gA,n),KA(yA,yA),XA(_A,mA,o),KA(_A,_A),MA(e,vA,a,fA,mA,l),MA(e,yA,n,gA,fA,l),MA(e,_A,o,mA,gA,l));void 0!==pA[0]&&(QA(mA,pA,i),KA(mA,mA),QA(fA,pA,r),KA(fA,fA),QA(gA,pA,s),KA(gA,gA),XA(vA,fA,a),KA(vA,vA),XA(yA,gA,n),KA(yA,yA),XA(_A,mA,o),KA(_A,_A),MA(e,vA,a,fA,mA,l),MA(e,yA,n,gA,fA,l),MA(e,_A,o,mA,gA,l))}(e,m,l,c,h,d,u,p,o),kA(e,o.b0,o.b1,o.b2,FA,VA);const f=[0,0,0];QA(f,VA,FA),o.quality=WA(f),o.quality<n?NA(o.b0,o.b1,o.b2,FA,VA,f,t):AA(cA,hA,t)}const uA=[0,0,0],pA=[0,0,0],mA=[0,0,0],fA=[0,0,0],gA=[0,0,0],vA=[0,0,0],yA=[0,0,0],_A=[0,0,0];const xA=[0,0,0];const bA=[0,0];const wA=[0,0,0],CA=[0,0,0],SA=[0,0,0],TA=[0,0,0],PA=[0,0,0],RA=[0,0,0];function MA(e,t,i,r,s,a){if(JA(t)<1e-6)return;XA(wA,i,t),XA(CA,r,t),XA(SA,s,t),DA(e,t,bA),PA[1]=bA[0],TA[1]=bA[1],RA[1]=TA[1]-PA[1];const n=[i,r,s],o=[wA,CA,SA];for(let i=0;i<3;++i){DA(e,n[i],bA),PA[0]=bA[0],TA[0]=bA[1],DA(e,o[i],bA),PA[2]=bA[0],TA[2]=bA[1],RA[0]=TA[0]-PA[0],RA[2]=TA[2]-PA[2];const r=WA(RA);r<a.quality&&($A(a.b0,n[i]),$A(a.b1,t),$A(a.b2,o[i]),a.quality=r)}}const OA=[0,0,0];function DA(e,t,i){const{data:r,offsetIdx:s,strideIdx:a}=e;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let e=s;e<r.length;e+=a){const s=r[e]*t[0]+r[e+1]*t[1]+r[e+2]*t[2];i[0]=Math.min(i[0],s),i[1]=Math.max(i[1],s)}}function AA(e,t,i){$A(i.center,e),YA(i.halfSize,t,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const EA=[0,0,0],IA=[0,0,0],LA=[0,0,0],FA=[0,0,0],VA=[0,0,0],zA=[0,0,0];function UA(e,t,i){$A(EA,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?EA[0]=0:Math.abs(t[1])>Math.abs(t[2])?EA[1]=0:EA[2]=0,JA(EA)<1e-6&&(EA[0]=EA[1]=EA[2]=1),XA(IA,t,EA),KA(IA,IA),XA(LA,t,IA),KA(LA,LA),kA(e,t,IA,LA,FA,VA),QA(zA,VA,FA),NA(t,IA,LA,FA,VA,zA,i)}function kA(e,t,i,r,s,a){DA(e,t,bA),s[0]=bA[0],a[0]=bA[1],DA(e,i,bA),s[1]=bA[0],a[1]=bA[1],DA(e,r,bA),s[2]=bA[0],a[2]=bA[1]}const jA=[0,0,0],GA=[1,0,0,0,1,0,0,0,1],BA=[0,0,0];function NA(e,t,i,r,s,a,n){GA[0]=e[0],GA[1]=e[1],GA[2]=e[2],GA[3]=t[0],GA[4]=t[1],GA[5]=t[2],GA[6]=i[0],GA[7]=i[1],GA[8]=i[2],function(e,t){const i=t[0]+t[4]+t[8];if(i>0){let r=Math.sqrt(i+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{let i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);const r=(i+1)%3,s=(i+2)%3;let a=Math.sqrt(t[3*i+i]-t[3*r+r]-t[3*s+s]+1);e[i]=.5*a,a=.5/a,e[3]=(t[3*r+s]-t[3*s+r])*a,e[r]=(t[3*r+i]+t[3*i+r])*a,e[s]=(t[3*s+i]+t[3*i+s])*a}}(n.quaternion,GA),ZA(BA,r,s),YA(BA,BA,.5),YA(n.center,e,BA[0]),YA(jA,t,BA[1]),ZA(n.center,n.center,jA),YA(jA,i,BA[2]),ZA(n.center,n.center,jA),YA(n.halfSize,a,.5)}class qA{constructor(e){this.minVert=new Array(7),this.maxVert=new Array(7);this.buffer=new ArrayBuffer(448);let t=0;this.minProj=new Float64Array(this.buffer,t,7),t+=56,this.maxProj=new Float64Array(this.buffer,t,7),t+=56;for(let e=0;e<7;++e)this.minVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.maxVert[e]=new Float64Array(this.buffer,t,3),t+=24;for(let e=0;e<7;++e)this.minProj[e]=Number.POSITIVE_INFINITY,this.maxProj[e]=Number.NEGATIVE_INFINITY;const i=new Array(7),r=new Array(7),{data:s,offsetIdx:a,strideIdx:n}=e;for(let e=a;e<s.length;e+=n){let t=s[e];t<this.minProj[0]&&(this.minProj[0]=t,i[0]=e),t>this.maxProj[0]&&(this.maxProj[0]=t,r[0]=e),t=s[e+1],t<this.minProj[1]&&(this.minProj[1]=t,i[1]=e),t>this.maxProj[1]&&(this.maxProj[1]=t,r[1]=e),t=s[e+2],t<this.minProj[2]&&(this.minProj[2]=t,i[2]=e),t>this.maxProj[2]&&(this.maxProj[2]=t,r[2]=e),t=s[e]+s[e+1]+s[e+2],t<this.minProj[3]&&(this.minProj[3]=t,i[3]=e),t>this.maxProj[3]&&(this.maxProj[3]=t,r[3]=e),t=s[e]+s[e+1]-s[e+2],t<this.minProj[4]&&(this.minProj[4]=t,i[4]=e),t>this.maxProj[4]&&(this.maxProj[4]=t,r[4]=e),t=s[e]-s[e+1]+s[e+2],t<this.minProj[5]&&(this.minProj[5]=t,i[5]=e),t>this.maxProj[5]&&(this.maxProj[5]=t,r[5]=e),t=s[e]-s[e+1]-s[e+2],t<this.minProj[6]&&(this.minProj[6]=t,i[6]=e),t>this.maxProj[6]&&(this.maxProj[6]=t,r[6]=e)}for(let e=0;e<7;++e){let t=i[e];$A(this.minVert[e],s,t),t=r[e],$A(this.maxVert[e],s,t)}}}class HA{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function WA(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function ZA(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function QA(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function YA(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function $A(e,t,i=0){e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2]}function XA(e,t,i){const r=t[0],s=t[1],a=t[2],n=i[0],o=i[1],l=i[2];e[0]=s*l-a*o,e[1]=a*n-r*l,e[2]=r*o-s*n}function KA(e,t){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){const r=1/Math.sqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function JA(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function eE(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function tE(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}const iE=Hr(),rE=je(),sE=je(),aE=Br();class nE{constructor(e){const t=56*e;this.buffer=new ArrayBuffer(t),this.obbs=new Array(e);for(let t=0;t<e;t++)this.obbs[t]={center:He(this.buffer,56*t+0),halfSize:Vo(this.buffer,56*t+24),quaternion:iu(this.buffer,56*t+36)}}}function oE(e=[0,0,0],t=[-1,-1,-1],i=[0,0,0,1]){return{center:Ue(e),halfSize:Fo(t),quaternion:tu(i)}}function lE(e){return oE(e.center,e.halfSize,e.quaternion)}function cE(e,t){Xe(t.center,e.center),Xe(t.halfSize,e.halfSize),Ls(t.quaternion,e.quaternion)}function hE(e,t){return dA(e,t=t||oE()),t}function dE(e,t){const i=Uo.signedDistance(t,e.center),r=vE(e,Uo.normal(t));return i>r?1:i<-r?-1:0}function uE(e,t){t||(t=js());const i=$r(aE,e.quaternion),r=e.halfSize[0]*Math.abs(i[0])+e.halfSize[1]*Math.abs(i[3])+e.halfSize[2]*Math.abs(i[6]),s=e.halfSize[0]*Math.abs(i[1])+e.halfSize[1]*Math.abs(i[4])+e.halfSize[2]*Math.abs(i[7]),a=e.halfSize[0]*Math.abs(i[2])+e.halfSize[1]*Math.abs(i[5])+e.halfSize[2]*Math.abs(i[8]);return t[0]=e.center[0]-r,t[1]=e.center[1]-s,t[2]=e.center[2]-a,t[3]=e.center[0]+r,t[4]=e.center[1]+s,t[5]=e.center[2]+a,t}function pE(e,t){return Uo.signedDistance(t,e.center)-vE(e,Uo.normal(t))}function mE(e,t){return Uo.signedDistance(t,e.center)+vE(e,Uo.normal(t))}function fE(e,t){return dE(e,t.planes[0])<=0&&dE(e,t.planes[1])<=0&&dE(e,t.planes[2])<=0&&dE(e,t.planes[3])<=0&&dE(e,t.planes[4])<=0&&dE(e,t.planes[5])<=0}function gE(e,t,i,r=0){Is(iE,e.quaternion),at(rE,t,e.center);const s=mt(rE,rE,iE),a=mt(sE,i,iE);let n=-1/0,o=1/0;for(let t=0;t<3;t++)if(Math.abs(a[t])>1e-6){const i=(r+e.halfSize[t]-s[t])/a[t],l=(-r-e.halfSize[t]-s[t])/a[t];n=Math.max(n,Math.min(i,l)),o=Math.min(o,Math.max(i,l))}else if(s[t]>e.halfSize[t]+r||s[t]<-e.halfSize[t]-r)return!1;return n<=o}(()=>{const e=new Int8Array(162);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=6};i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4])})();function vE(e,t){Is(iE,e.quaternion),mt(rE,t,iE);const i=e.halfSize;return Math.abs(rE[0]*i[0])+Math.abs(rE[1]*i[1])+Math.abs(rE[2]*i[2])}function yE(e,t){for(let i=0;i<8;++i){const r=t[i];r[0]=1&i?-e.halfSize[0]:e.halfSize[0],r[1]=2&i?-e.halfSize[1]:e.halfSize[1],r[2]=4&i?-e.halfSize[2]:e.halfSize[2],mt(r,r,e.quaternion),Qe(r,r,e.center)}}class _E{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}componentCount(){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];return t}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const a=e[s];i+r===a?r+=1:(t.push(i),t.push(r),i=a,r=1)}return t.push(i),t.push(r),t}(e)}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],s=r+t[i+1];for(let t=r;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],a=s+i[r+1],n=e[s],o=e[a];t[r]=n,t[r+1]=o-n}return t}}class xE extends ho{constructor(e,t){super(),this.pickability=null,this.highlightCounts=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.offsets=o(t);const i=this.count;this.visibility=new _E(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return u(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return u(this.highlightCounts)?null:(u(this.cachedHighlightRanges)&&(this.cachedHighlightRanges=function(e,t,i){const r=[];let s=i.length;t.forEachComponent((t=>(e[t]>0&&(s!==t-1&&(r.length&&r.push(i[s+1]-r[r.length-1]),r.push(i[t])),s=t),!0))),r.length&&r.push(i[s+1]-r[r.length-1]);return r}(this.highlightCounts,this.visibility,this.offsets)),this.cachedHighlightRanges)}highlightsDirty(){this.cachedHighlightRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.cachedHighlightRanges=null}}class bE extends ho{constructor(){super(...arguments),this._bucket=null,this._bucketIndex=0}get bucketKey(){return this._bucket.key}}class wE{constructor(){this._buckets=new Map}add(e,t){const i=this._getBucket(e);t._bucket=i,t._bucketIndex=i.count,i.data.push(t),++i.statistics.added}remove(e){++e._bucket.statistics.removed;const t=e._bucket.data,i=t[t.length-1];t[e._bucketIndex]=i,i._bucketIndex=e._bucketIndex,t.pop(),e._bucket=null,e._bucketIndex=0}updateKey(e,t){this.remove(e),this.add(t,e)}getBucket(e){return this._getBucket(e).data}getPerformanceInfo(e){return this._getBucket(e).statistics}forEach(e){this._buckets.forEach((t=>e(t.data,t.key)))}get count(){let e=0;return this._buckets.forEach((t=>e+=t.count)),e}_getBucket(e){const t=this._buckets.get(e);if(t)return t;const i=new CE(e);return this._buckets.set(e,i),i}}class CE{constructor(e){this.key=e,this.data=new Array,this.statistics={added:0,removed:0}}get count(){return this.data.length}}class SE extends bE{get visible(){return!!(1&this.bucketKey)}}function TE(e,t,i,r){if(i>=t)return e;null==e&&(e=function(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}());const s=e.isVisibleBit;let a=e.data;const n=RE(a),o=i/n|0,l=i-n*o,c=(t-1)/n|0,h=a,d=r===s;if(!(i<h.length*n)&&d){const e=1.5,t=o+1,i=Math.ceil(h.length*e),r=c+1;let s=Math.max(t,i);s=Math.min(s,r),a=new Uint32Array(s),a.set(h)}return o<a.length&&(a[o]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(a[o],l,d)),e.data=a,e}function PE(e,t){if(null==e)return!0;const{isVisibleBit:i,data:r}=e,s=RE(r);return t<r.length*s?function(e,t,i,r){const s=i/r|0,a=i-s*r;return function(e,t){return 0!=(e&1<<t)}(t[s],a)===e}(i,r,t,s):!e.isVisibleBit}function RE(e){return 8*e.BYTES_PER_ELEMENT}e([uo()],SE.prototype,"renderable",void 0),e([uo()],SE.prototype,"components",void 0);class ME{constructor(e,t){this._indices=h(e.indices)?e.indices:po(e.positions.length/3),this._positions=new ns(e.positions),this._components=t}getComponentAabb(e,t){if(h(this._perComponentAabbs)){for(let i=0;i<6;i++)t[i]=this._perComponentAabbs[6*e+i];return t}return this._computePerComponentAabbs(),this.getComponentAabb(e,t)}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,s,a){const n={data:this._positions.typedBuffer,strideIdx:this._positions.typedBufferStride,offsetIdx:0,size:3},o=this._indices,l=this._components.offsets,c=mo(e,t,OE);this._components.visibility.forEachComponent((d=>{if(!PE(this._components.pickability,d))return!0;const u=this.getComponentAabb(d,DE);if(h(s)&&s.applyToAabb(u),!io(u,e,c,i))return!0;const p=l[d]/3,m=l[d+1]/3;return to(e,t,p,m,o,n,void 0,s,((e,t,i)=>a(d,e,lt(t,t,r),i))),!0}))}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);for(let t=0;t<e;t++)this._computeAABB(t)}_computeAABB(e){const t=this._indices,i=this._positions,r=this._components.offsets,s=r[e],a=r[e+1],n=[0,0,0],o=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0];for(let e=s;e<a;e++){const r=t[e];i.getVec(r,n),ft(o,o,n),gt(l,l,n)}let c=6*e;this._perComponentAabbs[c++]=o[0],this._perComponentAabbs[c++]=o[1],this._perComponentAabbs[c++]=o[2],this._perComponentAabbs[c++]=l[0],this._perComponentAabbs[c++]=l[1],this._perComponentAabbs[c]=l[2]}get positions(){return this._positions}get indices(){return this._indices}}const OE=je(),DE=js();class AE extends ho{constructor(){super(...arguments),this.meta={cameraDepthSquared:0,gpuMemoryEstimate:0}}}e([uo()],AE.prototype,"geometry",void 0);class EE extends ho{constructor(e,t,i,r){super(),this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=r}}function IE(e){return e?LE(e,1/0,-1/0):{near:1/0,far:-1/0}}function LE(e,t,i){return e.near=t,e.far=i,e}function FE(e,t,i=e){return i.near=Math.min(e.near,t.near),i.far=Math.max(e.far,t.far),i}function VE(e,t){return e.near<=t&&t<=e.far}e([uo()],EE.prototype,"vao",void 0);const zE=new R({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),UE=IE(),kE=je(),jE=je(),GE=new R({deallocator:null}),BE=new R({deallocator:null});function NE(e,t,i){i.length=0;const r=t.length-3;qE(kE,t,r);const s=pl(e,kE);s<=0&&(i.push(kE[0]),i.push(kE[1]),i.push(kE[2]));let a=0,n=s;for(;a<r;a+=3){qE(jE,t,a);const r=pl(e,jE);if(n*r<0){tt(kE,jE,kE,r/(r-n)),HE(i,kE)}r<=0&&HE(i,jE),n=r,Xe(kE,jE)}if(n*s<0){qE(jE,t,r);tt(kE,jE,kE,s/(s-n)),HE(i,kE)}}function qE(e,t,i){return Ye(e,t.data[i+0],t.data[i+1],t.data[i+2])}function HE(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function WE(e,t,i,r){Is(XE,e.quaternion),vt(KE,t,e.center),mt(KE,KE,XE);const s=8*((KE[0]<-e.halfSize[0]?-1:KE[0]>e.halfSize[0]?1:0)+3*(KE[1]<-e.halfSize[1]?-1:KE[1]>e.halfSize[1]?1:0)+9*(KE[2]<-e.halfSize[2]?-1:KE[2]>e.halfSize[2]?1:0)+13),a=ZE[s];if(0===a)return a;$r($E,e.quaternion),Xr($E,$E,e.halfSize);const n=(t,i)=>{const r=ZE[s+i+1];return Ye(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),lt(t,t,$E),Qe(t,e.center,t)};return i.length=0,HE(i,n(JE,0)),HE(i,n(eI,1)),HE(i,n(KE,2)),HE(i,n(tI,3)),r(i),1===a?a:(i.length=0,HE(i,JE),HE(i,tI),HE(i,n(KE,4)),HE(i,n(iI,5)),r(i),2===a||(i.length=0,HE(i,JE),HE(i,iI),HE(i,n(KE,6)),HE(i,eI),r(i)),a)}const ZE=(()=>{const e=new Int8Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),QE=4;function YE(e,t){let i=0;for(let r=0;r<QE;r++){const s=dE(e,t[r]);if(s>0)return-1;0===s&&(i|=1<<r)}return i}const $E=Br(),XE=Hr(),KE=je(),JE=je(),eI=je(),tI=je(),iI=je();class rI{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t);const i=this._objects.visibleObjects;for(let t=0;t<i.length;t++){const r=i[t];r.renderable.material.submit(e,r)}}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?function(e,t){const i=IE(),r=e.eye,s=e.viewForward,a=e.frustum.planes;for(let e=0;e<t.length;e++){const n=t[e].obb,o=st(vt(KE,n.center,r),s),l=vE(n,s);if(VE(i,o-l)&&VE(i,o+l))continue;const c=YE(n,a);if(-1===c)continue;if(0===c){UE.far=o+l,UE.near=o-l,FE(i,UE);continue}const h=zE.pushNew();h.near=o-l,h.far=o+l,h.mask=c,h.object=t[e]}for(let e=0;e<zE.length;e++){const t=zE.data[e];VE(i,t.near)&&VE(i,t.far)||(UE.far=t.far,UE.near=1/0,0===WE(t.object.obb,r,GE,(e=>{let i=BE;for(let r=0;r<QE&&e.length>0;r++){if(0==(t.mask&1<<r))continue;NE(a[r],e,i);const s=e;e=i,i=s}for(let t=0;t<e.length;t+=3){Ye(kE,e.data[t+0],e.data[t+1],e.data[t+2]);const i=st(vt(kE,kE,r),s);UE.near=Math.min(UE.near,i)}}))&&(UE.near=0),FE(i,UE))}return zE.length=0,i}(e,this._objects.visibleObjects):null}}function sI(e){const t=Io().vec3f("position");return e.normals&&t.vec2i16("normalCompressed",{glNormalized:!0}),1===e.textureCoordinates?t.vec2f("uv0"):2===e.textureCoordinates&&(t.vec2f("uv0"),t.vec4u16("uvRegion",{glNormalized:!0})),e.colors&&t.vec4u8("color",{glNormalized:!0}),t.alignTo(4)}function aI(e,t){1===t.componentData&&(e.vertex.uniforms.add("uComponentColorTex","sampler2D"),e.vertex.uniforms.add("uComponentColorTexInvDim","vec2"),e.attributes.add("componentIndex","float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4"),e.include(Bh),e.vertex.code.add(bn`
      vec4 _readComponentColor() {
        float normalizedIndex = (componentIndex + 0.5) * uComponentColorTexInvDim.x;
        vec2 indexCoord = vec2(
          mod(normalizedIndex, 1.0),
          (floor(normalizedIndex) + 0.5) * uComponentColorTexInvDim.y
        );
        return texture2D(uComponentColorTex, indexCoord);
       }

      vec4 forwardExternalColor(out bool castShadows) {
        vec4 componentColor = _readComponentColor() * 255.0;

        float shadowFlag = mod(componentColor.b * 255.0, 2.0);
        componentColor.b -= shadowFlag;
        castShadows = shadowFlag >= 1.0;

        int decodedColorMixMode;
        vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
        vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

        return vExternalColor;
      }
    `),e.fragment.code.add(bn`
      void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
        externalColor = vExternalColor;
        externalColorMixMode = int(vExternalColorMixMode);
      }
    `)),0===t.componentData&&(e.vertex.uniforms.add("uExternalColor","vec4"),e.fragment.uniforms.add("uExternalColorMixMode","int"),e.varyings.add("vExternalColor","vec4"),e.vertex.code.add(bn`
      vec4 forwardExternalColor(out bool castShadows) {
        vExternalColor = uExternalColor;
        castShadows = true;
        return uExternalColor;
      }
    `),e.fragment.code.add(bn`
      void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
        externalColor = vExternalColor;
        externalColorMixMode = uExternalColorMixMode;
      }
    `))}function nI(e,t){const i=e.vertex;switch(i.code.add(bn`
  #define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)
  `),t.vertexDiscardMode){case 0:i.code.add(bn`
        #define vertexDiscardByOpacity(_opacity_) {}
      `);break;case 2:i.code.add(bn`
        #define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }
      `);break;case 1:i.code.add(bn`
        #define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }
      `)}}function oI(e,t){e.include(An,t),e.fragment.include(Nh);const i=e.fragment;i.uniforms.add("uBaseColor","vec4"),i.uniforms.add("uObjectOpacity","float"),t.attributeColor?i.code.add(bn`
      vec3 _baseColor() {
        // combine the old material parameters into a single one
        return uBaseColor.rgb * vColor.rgb;
      }

      float _baseOpacity() {
        return uBaseColor.a * vColor.a;
      }
    `):i.code.add(bn`
      vec3 _baseColor() {
        // combine the old material parameters into a single one
        return uBaseColor.rgb;
      }

      float _baseOpacity() {
        return uBaseColor.a;
      }
    `),i.code.add(bn`
    vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
      vec3 baseColor = _baseColor();
      float baseOpacity = _baseOpacity();

      vec3 color = mixExternalColor(
        baseColor,
        textureColor.rgb,
        externalColor.rgb,
        externalColorMixMode
      );
      float opacity = uObjectOpacity * mixExternalOpacity(
        baseOpacity,
        textureColor.a,
        externalColor.a,
        externalColorMixMode
      );

      return vec4(color, opacity);
    }
  `)}function lI(e,t){const i=e.fragment;0===t.doubleSidedMode?i.code.add(bn`
      vec3 _adjustDoublesided(vec3 normal) {
        return normal;
      }
    `):1===t.doubleSidedMode?(e.include(qh,t),i.uniforms.add("uTransform_ViewFromCameraLocal_T","vec3"),i.code.add(bn`
      vec3 _adjustDoublesided(vec3 normal) {
        vec3 viewDir = vPositionWorldCameraRelative + uTransform_ViewFromCameraLocal_T;
        return dot(normal, viewDir) > 0.0 ? -normal : normal;
      }
    `)):2===t.doubleSidedMode&&i.code.add(bn`
      vec3 _adjustDoublesided(vec3 normal) {
        return gl_FrontFacing ? normal : -normal;
      }
    `),0===t.normalType||1===t.normalType?(e.include(zh,t),i.code.add(bn`
      vec3 shadingNormalWorld() {
        return _adjustDoublesided(normalize(vNormalWorld));
      }

      vec3 shadingNormal_view() {
        vec3 normal = normalize(vNormalView);
        return gl_FrontFacing ? normal : -normal;
      }
    `)):3===t.normalType?(e.extensions.add("GL_OES_standard_derivatives"),e.include(qh,t),i.code.add(bn`
      vec3 shadingNormalWorld() {
        return normalize(cross(
          dFdx(vPositionWorldCameraRelative),
          dFdy(vPositionWorldCameraRelative)
        ));
      }

      vec3 shadingNormal_view() {
        return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
      }
    `)):2===t.normalType&&(1===t.viewingMode?(e.include(qh,t),i.code.add(bn`
        vec3 shadingNormalWorld() {
          return normalize(positionWorld());
        }
      `)):2===t.viewingMode&&i.code.add(bn`
        vec3 shadingNormalWorld() {
          return vec3(0.0, 0.0, 1.0);
        }
      `),e.extensions.add("GL_OES_standard_derivatives"),i.code.add(bn`
      vec3 shadingNormal_view() {
        return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
      }
    `))}function cI(e,t){const i=e.fragment;t.baseColorTexture?(e.include(Hh,t),i.uniforms.add("uBaseColorTexture","sampler2D"),i.uniforms.add("uBaseColorTextureSize","vec2"),2===t.attributeTextureCoordinates?(e.include(Wh),i.code.add(bn`
        vec4 readBaseColorTexture() {
          return textureAtlasLookup(
            uBaseColorTexture,
            uBaseColorTextureSize,
            vuv0,
            vuvRegion
          );
        }
      `)):i.code.add(bn`
        vec4 readBaseColorTexture() {
          return texture2D(uBaseColorTexture, vuv0);
        }
      `)):i.code.add(bn`
      vec4 readBaseColorTexture() { return vec4(1.0); }
    `)}const hI={position:0,normal:1,normalCompressed:1,color:2,uv0:3,uvRegion:4,componentIndex:5};var dI=Object.freeze({__proto__:null,attributeLocations:hI,build:function(e){const t=new xn;t.include(qh,e),t.include(zh,e),t.include(An,e),t.include(Zh,e),t.include(Ph,e),t.include(aI,e),t.include(fo,e),t.include(In,e),t.include(cI,e),t.include(nI,e),t.fragment.uniforms.add("view","mat4"),1!==e.pbrMode&&2!==e.pbrMode||(t.include(Qh,e),t.include(Yh,e)),3===e.output&&1===e.componentData?t.vertex.code.add(bn`
      #define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }
    `):t.vertex.code.add(bn`
      #define discardShadows(castShadows) {}
    `);const i=e.overlayEnabled&&0===e.output&&4===e.pbrMode;return e.overlayEnabled&&(t.include(PD,e),1===e.viewingMode?t.vertex.code.add(bn`
      const float invEllipsoidRadius = ${bn.float(1/(1===e.ellipsoidMode?xe.radius:2===e.ellipsoidMode?be.radius:we.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):t.vertex.code.add(bn`
      vec2 projectOverlay(vec3 pos) { return pos.xy; }
      `)),i&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"),t.varyings.add("positionView","vec3")),t.vertex.code.add(bn`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${bn.float(Fn)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
      forwardPosition();
      forwardNormal();
      ${i?bn`
        positionView = position_view();
        ${1===e.viewingMode?bn`
        groundNormal = normalize(positionWorld());
        tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:bn`
        groundNormal = vec3(0.0, 0.0, 1.0);
        tbnTangent = vec3(1.0, 0.0, 0.0);
        tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`}
        `:""}

      ${e.overlayEnabled?bn`setOverlayVTC(projectOverlay(position));`:""}
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth(); // depends on forwardPosition()
    }
  `),7===e.output&&(t.include(oI,e),t.fragment.code.add(bn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?bn`
        vec4 overlayColorOpaque = getOverlayColor(ovInnerColorTex, ovOuterColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),0===e.output&&(t.include(oI,e),t.include(lI,e),t.include(Lh,e),i&&(t.fragment.uniforms.add("ovInnerNormalTex","sampler2D"),t.fragment.uniforms.add("ovOuterNormalTex","sampler2D")),e.receiveShadows?(t.include(Th,e),t.fragment.code.add(bn`
        float evaluateShadow() {
          return readShadowMap(vPositionWorldCameraRelative, linearDepth);
        }
      `)):t.fragment.code.add(bn`
        float evaluateShadow() { return 0.0; }
      `),t.fragment.code.add(bn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${e.overlayEnabled?bn`
        vec4 overlayColorOpaque = getOverlayColor(ovInnerColorTex, ovOuterColorTex, vtcOverlay);
        vec4 overlayColor = overlayOpacity * overlayColorOpaque;
        materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}
    `),1===e.pbrMode||2===e.pbrMode?(t.fragment.code.add(bn`
        ${1===e.pbrMode?bn`
        applyPBRFactors();
        if (int(externalColorMixMode) == 3) {
          mrr = vec3(0.0, 0.6, 0.2);
        }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),e.hasNormalTexture?t.fragment.code.add(bn`
        mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
        vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);
        `):t.fragment.code.add(bn`
        vec3 shadingNormal = normalVertex;
        `),t.fragment.code.add(bn`${1===e.viewingMode?bn`vec3 normalGround = normalize(positionWorld());`:bn`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),t.fragment.code.add(bn`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(e.receiveShadows?t.fragment.code.add(bn`
      float shadow = evaluateShadow();
        `):1===e.viewingMode?t.fragment.code.add(bn`
      float additionalAmbientScale = _oldHeuristicLighting(positionWorld());
      float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);
        `):t.fragment.code.add(bn`
      float shadow = 0.0;
      `),t.fragment.code.add(bn`
      float ambientOcclusion = evaluateAmbientOcclusion();
      // At global scale we create some additional ambient light based on the main light to simulate global illumination
      vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());
      vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${i?bn`
          vec4 overlayWaterMask = getOverlayColor(ovInnerNormalTex, ovOuterNormalTex, vtcOverlay);
          float waterNormalLength = length(overlayWaterMask);
          if (waterNormalLength > 0.95) {
            mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
            vec4 waterOverlayColor = vec4(overlayColorOpaque.xyz, overlayColor.w);
            vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, positionView);
            vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
            // un-gamma the ground color to mix in linear space
            shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
          }`:""}
      `)),t.fragment.code.add(bn`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==e.output&&3!==e.output||(t.include(En,e),t.fragment.code.add(bn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        outputDepth(linearDepth);
      }
    `)),2===e.output&&(t.include(lI,e),t.fragment.code.add(bn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${2===e.normalType?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),4===e.output&&(t.include(Ln),t.fragment.code.add(bn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${e.overlayEnabled?bn`
        vec4 overlayColor = getCombinedOverlayColor();

        if (overlayColor.a == 0.0) {
          gl_FragColor = vec4(0.0);
          return;
        }`:""}

        outputHighlight();
      }
    `)),t}});const uI=0,pI=1,mI=2,fI=3,gI=4,vI=5,yI=2,_I=3,xI=4,bI=5,wI=6,CI=7,SI=8,TI=9;class PI extends Tn{bindPass(e,t){const i=this.program;qh.bindViewProjTransform(i,t.viewTransform),In.bindUniforms(this.program,this.configuration,t.slicePlane),0===t.identifier&&void 0!==t.ssrParams&&(t.ssrParams.lastFrameColorTextureID=TI,t.ssrParams.linearDepthTextureID=SI,Ic.bindUniforms(this.program,e,t.ssrParams)),0===t.identifier&&(i.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",t.transformNormal_ViewFromGlobal),2===t.subPass&&i.setUniform2fv("uCameraNearFar",t.cameraNearFar),0===t.subPass&&(t.ambientOcclusionEnabled&&t.ambientOcclusion.bind(i,wI),t.shadowsEnabled&&t.shadowMap.bind(i,CI),t.lighting.setUniforms(this.program,t.integratedMesh))),1===t.identifier&&this.program.setUniform2fv("uCameraNearFar",t.cameraNearFar),2===t.identifier&&Ln.bindOutputHighlight(e,this.program,t)}bindDraw(e,t){if(qh.bindModelTransform(this.program,e),this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",e.transformNormal_GlobalFromModel),t.isIntegratedMesh){const i=t.overlayTexScale,r=t.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[e.toMapSpace[0]*i[0]+r[0],e.toMapSpace[1]*i[1]+r[1],e.toMapSpace[0]*i[2]+r[2],e.toMapSpace[1]*i[3]+r[3]]),this.program.setUniform4fv("overlayTexScale",[e.toMapSpace[2]*i[0],e.toMapSpace[3]*i[1],e.toMapSpace[2]*i[2],e.toMapSpace[3]*i[3]])}}bindMaterial(e,t,i){const r=this.program;r.setUniform4fv("uBaseColor",t.baseColor),r.setUniform1f("uObjectOpacity",t.objectOpacity),r.setUniform1f("textureAlphaCutoff",t.alphaCutoff),1===t.componentParameters.type?t.componentParameters.texture.bind(r,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:pI}):(r.setUniform4fv("uExternalColor",t.componentParameters.externalColor),r.setUniform1i("uExternalColorMixMode",t.componentParameters.externalColorMixMode)),h(t.baseColorTexture)&&t.baseColorTexture.bind(e,r,"uBaseColorTexture",uI,"uBaseColorTextureSize"),0!==this.configuration.output&&7!==this.configuration.output||(Qh.bindUniforms(this.program,t),h(t.metallicRoughnessTexture)&&t.metallicRoughnessTexture.bind(e,r,"texMetallicRoughness",vI,"texMetallicRoughnessSize"),h(t.emissionTexture)&&t.emissionTexture.bind(e,r,"texEmission",fI,"texEmissionSize"),h(t.occlusionTexture)&&t.occlusionTexture.bind(e,r,"texOcclusion",gI,"texOcclusionSize"),h(t.normalTexture)&&t.normalTexture.bind(e,r,"normalTexture",mI,"normalTextureSize")),t.isIntegratedMesh&&(0===i.identifier&&0===i.subPass?(e.bindTexture(m(t.overlayColorInner),yI),e.bindTexture(m(t.overlayColorOuter),_I),e.bindTexture(m(t.overlayNormalInner),xI),e.bindTexture(m(t.overlayNormalOuter),bI),r.setUniform1i("ovInnerNormalTex",xI),r.setUniform1i("ovOuterNormalTex",bI)):2===i.identifier&&(e.bindTexture(m(t.overlayHighlightInner),yI),e.bindTexture(m(t.overlayHighlightOuter),_I)),r.setUniform1i("ovInnerColorTex",yI),r.setUniform1i("ovOuterColorTex",_I),r.setUniform1f("overlayOpacity",1))}initializeProgram(e){const t=PI.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,normalType:0===i.integratedMeshMode?i.hasNormals?1:3:2,attributeColor:i.hasVertexColors,attributeTextureCoordinates:i.vertexTextureCoordinates,componentData:i.componentData,alphaDiscardMode:i.alphaDiscardMode,baseColorTexture:i.baseColorTexture,doubleSidedMode:i.doubleSidedMode,receiveAmbientOcclusion:i.receiveAmbientOcclusion,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:e.viewingMode,vertexDiscardMode:i.vertexDiscardMode,pbrMode:3===i.integratedMeshMode?4:i.usePBR?1:0,hasMetalnessAndRoughnessTexture:i.hasMetalnessAndRoughnessTexture,hasEmissionTexture:i.hasEmissionTexture,hasOcclusionTexture:i.hasOcclusionTexture,hasNormalTexture:i.hasNormalTexture,vertexTangets:!1,useOldSceneLightInterface:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:$h(e.rctx),overlayEnabled:2===i.integratedMeshMode||3===i.integratedMeshMode,ssrEnabled:i.ssrEnabled,highStepCount:!1,ellipsoidMode:i.ellipsoidMode});return new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),t.attributeLocations)}setPipelineState(e){const t=this.configuration,i=0!==t.integratedMeshMode,r=3===e,s=2===e;return wo({blending:0!==t.output&&7!==t.output||!t.blendingEnabled?null:r?Vn:zn(e),culling:RI[t.cullFace],depthTest:{func:Un(e)},depthWrite:r||s?Ro:null,colorWrite:To,stencilWrite:i||t.sceneHasOcludees?jn:null,stencilTest:i?go(1):t.sceneHasOcludees?Bn:null,polygonOffset:r||s?t.polygonOffsetEnabled?{factor:2,units:2}:null:eo})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}PI.shader=new Rn(dI,(()=>Promise.resolve().then((function(){return dI}))));const RI=[];RI[0]=null,RI[2]={face:1029,mode:2305},RI[1]={face:1028,mode:2305};class MI extends qh.ModelTransform{constructor(){super(...arguments),this.transformNormal_GlobalFromModel=Br(),this.toMapSpace=Tr()}}class OI extends Sn{constructor(){super(...arguments),this.output=0,this.hasVertexColors=!1,this.hasNormals=!1,this.vertexTextureCoordinates=0,this.componentData=0,this.slicePlaneEnabled=!1,this.cullFace=2,this.baseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.blendingEnabled=!0,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.ssrEnabled=!1,this.polygonOffsetEnabled=!1,this.usePBR=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.ellipsoidMode=1}}e([Cn({count:8})],OI.prototype,"output",void 0),e([Cn()],OI.prototype,"hasVertexColors",void 0),e([Cn()],OI.prototype,"hasNormals",void 0),e([Cn({count:3})],OI.prototype,"vertexTextureCoordinates",void 0),e([Cn({count:2})],OI.prototype,"componentData",void 0),e([Cn()],OI.prototype,"slicePlaneEnabled",void 0),e([Cn({count:3})],OI.prototype,"cullFace",void 0),e([Cn()],OI.prototype,"baseColorTexture",void 0),e([Cn()],OI.prototype,"receiveAmbientOcclusion",void 0),e([Cn()],OI.prototype,"receiveShadows",void 0),e([Cn({count:3})],OI.prototype,"vertexDiscardMode",void 0),e([Cn({count:3})],OI.prototype,"doubleSidedMode",void 0),e([Cn()],OI.prototype,"blendingEnabled",void 0),e([Cn({count:4})],OI.prototype,"alphaDiscardMode",void 0),e([Cn({count:4})],OI.prototype,"integratedMeshMode",void 0),e([Cn()],OI.prototype,"ssrEnabled",void 0),e([Cn()],OI.prototype,"polygonOffsetEnabled",void 0),e([Cn()],OI.prototype,"usePBR",void 0),e([Cn()],OI.prototype,"hasMetalnessAndRoughnessTexture",void 0),e([Cn()],OI.prototype,"hasEmissionTexture",void 0),e([Cn()],OI.prototype,"hasOcclusionTexture",void 0),e([Cn()],OI.prototype,"hasNormalTexture",void 0),e([Cn()],OI.prototype,"sceneHasOcludees",void 0),e([Cn({count:4})],OI.prototype,"transparencyPassType",void 0),e([Cn({count:4})],OI.prototype,"ellipsoidMode",void 0);class DI{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function AI(e={}){return(t,i)=>{var r;const s=null!=(r=t._parameterCount)?r:0;if(t._parameterCount=s+1,e.vectorOps){const r=e.vectorOps;Object.defineProperty(t,i,{get(){return this[s]},set(e){const t=this[s];if(null==t)this[s]=e;else{if(r.equals(t,e))return;r.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[s]},set(t){this[s]!==t&&(e.dispose&&this[s]&&this[s].dispose(),this[s]=t,this._setDirty())}})}}function EI(){return(e,t)=>{var i;const r=null!=(i=e._parameterCount)?i:0;e._parameterCount=r+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(r),Object.defineProperty(e,t,{get(){return this[r]},set(e){this[r]!==e&&(this[r]=e,this._setDirty())}})}}class II extends class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}{constructor(){super(),this.baseColor=cd(1,1,1,1),this.usePBR=!1,this.mrrFactors=zo(1,1,.5),this.emissiveFactor=zo(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.overlayTexOffset=Pr(-1,-1,-1,-1),this.overlayTexScale=Pr(0,0,0,0),this.overlayColorInner=null,this.overlayColorOuter=null,this.overlayHighlightInner=null,this.overlayHighlightOuter=null,this.overlayNormalInner=null,this.overlayNormalOuter=null,this.objectOpacity=1,this.commonMaterialParameters=new LI,this.componentParameters=new FI,this.alphaCutoff=vo,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.sceneHasOcludees=!1,this._techniqueConfig=new OI}dispose(e){this._technique&&(e.release(this._technique),this._technique=void 0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}getTechnique(e,t,i){const r=this._techniqueConfig;if(r.hasVertexColors=i.colors,r.hasNormals=i.normals,r.vertexTextureCoordinates=i.textureCoordinates,r.usePBR=this.usePBR,r.hasMetalnessAndRoughnessTexture=h(this.metallicRoughnessTexture),r.hasEmissionTexture=h(this.emissionTexture),r.hasOcclusionTexture=h(this.occlusionTexture),r.hasNormalTexture=h(this.normalTexture),r.transparencyPassType=0===t.identifier&&null!=t.transparencyPassType?t.transparencyPassType:3,r.ellipsoidMode=this.ellipsoidMode,this.dirty){r.componentData=this.componentParameters.type,r.cullFace=this.commonMaterialParameters.cullFace,r.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,r.baseColorTexture=h(this.baseColorTexture);const e=this._computeWhichMaterialPass();r.blendingEnabled=1===e||2===e,r.alphaDiscardMode=this.alphaDiscardMode,r.integratedMeshMode=this.isIntegratedMesh?this.overlayColorInner||this.overlayColorOuter?this.overlayNormalInner||this.overlayNormalOuter?3:2:1:0,r.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return r.slicePlaneEnabled=t.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,1===t.identifier?(r.output=3,r.vertexDiscardMode=0):2===t.identifier?(r.output=4,r.vertexDiscardMode=0):(2===this._computeWhichMaterialPass()?r.vertexDiscardMode=t.transparent?2:1:r.vertexDiscardMode=0,r.output=function(e){switch(e){case 0:return 0;case 1:return 7;case 2:return 1;case 3:return 2;case 4:return 8}}(t.subPass),1===t.subPass&&(r.sceneHasOcludees=t.sceneHasOcludees),0===t.subPass?(r.receiveAmbientOcclusion=t.ambientOcclusionEnabled,r.sceneHasOcludees=t.sceneHasOcludees,r.receiveShadows=t.shadowsEnabled,r.ssrEnabled=t.ssrParams.ssrEnabled):(r.receiveAmbientOcclusion=!1,r.receiveShadows=!1)),this._technique=e.repository.acquireAndReleaseExisting(PI,r,this._technique),this._technique}submit(e,t){const i=t.renderable.geometry,r=t.components,s=t.renderable.drawParameters,a=t.renderable.meta.cameraDepthSquared,n=r.geometryRanges,o=r.highlightRanges;switch(this._computeWhichMaterialPass()){case 0:e.materialOpaque.submitDraw(this,i,n,s,a);break;case 1:e.materialTransparent.submitDraw(this,i,n,s,a);break;case 2:e.materialOpaque.submitDraw(this,i,n,s,a),e.materialTransparent.submitDraw(this,i,n,s,a);break;case 3:e.materialIntegratedMesh.submitDraw(this,i,n,s,a),(this.overlayHighlightInner||this.overlayHighlightOuter)&&e.highlightIntegratedMesh.submitDraw(this,i,n,s,a)}h(e.shadowMap)&&2!==this.componentParameters.castShadows&&e.shadowMap.submitDraw(this,i,n,s,a),h(e.highlight)&&h(o)&&e.highlight.submitDraw(this,i,o,s,a)}get attributeLocations(){return hI}_computeWhichMaterialPass(){return this.isIntegratedMesh?3:this.objectOpacity<1?1:0===this.componentParameters.opaqueOverride?0:this.baseColor[3]<1||0===this.alphaDiscardMode||3===this.alphaDiscardMode?1:2===this.componentParameters.transparent?0:0===this.componentParameters.transparent?1:2}}e([AI({vectorOps:Rs})],II.prototype,"baseColor",void 0),e([AI()],II.prototype,"usePBR",void 0),e([AI({vectorOps:yt})],II.prototype,"mrrFactors",void 0),e([AI({vectorOps:yt})],II.prototype,"emissiveFactor",void 0),e([AI({dispose:!0})],II.prototype,"baseColorTexture",void 0),e([AI({dispose:!0})],II.prototype,"metallicRoughnessTexture",void 0),e([AI({dispose:!0})],II.prototype,"emissionTexture",void 0),e([AI({dispose:!0})],II.prototype,"occlusionTexture",void 0),e([AI({dispose:!0})],II.prototype,"normalTexture",void 0),e([AI({vectorOps:{equals:Ps,copy:Ts}})],II.prototype,"overlayTexOffset",void 0),e([AI({vectorOps:{equals:Ps,copy:Ts}})],II.prototype,"overlayTexScale",void 0),e([AI()],II.prototype,"overlayColorInner",void 0),e([AI()],II.prototype,"overlayColorOuter",void 0),e([AI()],II.prototype,"overlayHighlightInner",void 0),e([AI()],II.prototype,"overlayHighlightOuter",void 0),e([AI()],II.prototype,"overlayNormalInner",void 0),e([AI()],II.prototype,"overlayNormalOuter",void 0),e([AI()],II.prototype,"objectOpacity",void 0),e([EI()],II.prototype,"commonMaterialParameters",void 0),e([EI()],II.prototype,"componentParameters",void 0),e([AI()],II.prototype,"alphaCutoff",void 0),e([AI()],II.prototype,"alphaDiscardMode",void 0),e([AI()],II.prototype,"isIntegratedMesh",void 0),e([AI()],II.prototype,"polygonOffsetEnabled",void 0),e([AI()],II.prototype,"ellipsoidMode",void 0),e([AI()],II.prototype,"sceneHasOcludees",void 0);class LI extends DI{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.slicePlaneEnabled=!0}}e([AI()],LI.prototype,"doubleSided",void 0),e([AI()],LI.prototype,"cullFace",void 0),e([AI()],LI.prototype,"slicePlaneEnabled",void 0);class FI extends DI{constructor(){super(...arguments),this.externalColor=cd(1,1,1,1),this.externalColorMixMode=1,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}}e([AI({vectorOps:Rs})],FI.prototype,"externalColor",void 0),e([AI()],FI.prototype,"externalColorMixMode",void 0),e([AI()],FI.prototype,"castShadows",void 0);class VI extends DI{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.castShadows=2}get type(){return 1}}e([AI()],VI.prototype,"texture",void 0),e([AI()],VI.prototype,"transparent",void 0),e([AI()],VI.prototype,"opaqueOverride",void 0),e([AI()],VI.prototype,"castShadows",void 0);class zI{constructor(e){this._low=Lo(),this._high=Lo(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const t=this._low,i=this._high;Xe(t,e),vt(i,e,t)}setElements(e,t,i){Ye(UI,e,t,i),this.set(UI)}get(e){return Qe(e,this._low,this._high)}getLowScaled(e){return Ze(e,this._low,1)}}const UI=je();class kI{constructor(e){this.maxCount=e,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this.recycledIndices.push(e)}}class jI{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.textureWidth=4096,this.dirty=!0,this.texture=new Po(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:this.textureWidth,height:1,flipped:!1}),this.data=new os(new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(e,t,i,r,s,a){const n=e*this.fieldCount+t;this.dirty=!0,this.data.set(n,0,i),this.data.set(n,1,r),this.data.set(n,2,s),this.data.set(n,3,a)}setDataElement(e,t,i,r){const s=e*this.fieldCount+t;this.dirty=!0,this.data.set(s,i,r)}resizeToFit(e){const t=e*this.fieldCount;if(t>=this.data.count){const e=Math.ceil((t+1)/this.textureWidth)*this.textureWidth,i=new os(new ArrayBuffer(4*e));i.typedBuffer.set(this.data.typedBuffer),this.data=i}}updateTexture(){if(!this.dirty)return;const e=this.texture.descriptor.width,t=this.texture.descriptor.height;this.data.count>e*t&&this.texture.resize(e,this.data.count/e),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(e,t){this.rctx.bindTexture(this.texture,t.unit),e.setUniform1i(t.texName,t.unit),e.setUniform2f(t.invDimName,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}class GI{constructor(e,t=1){this.textureBuffer=new jI(e,t),this.indexManager=new kI(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const e=this.indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this.indexManager.release(e)}}class BI{constructor(e,t=1){this.rctx=e,this.fieldCount=t,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this.buffers.forEach((e=>e.dispose())),this.buffers=[]}getBuffer(e){for(const t of this.buffers)if(t.availableCount>=e)return t;if(e>65536)return null;const t=new GI(this.rctx,this.fieldCount);return this.buffers.push(t),t}updateTextures(){for(const e of this.buffers)e.textureBuffer.updateTexture()}}const NI=d.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class qI{constructor(e){this._renderManager=e,this._objects=new wE,this._renderSubmit=new rI(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new BI(e.rctx)}dispose(){Vl(0===this._objects.count,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const t=new SE;return t.toMapSpace=e.toMapSpace.slice(),t.transform=e.transform,t.obb=lE(e.obb),t.components=new xE(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new ME(e.geometry.positionData,t.components),this._objects.add(e.visible?1:0,t),t}destroyObject(e){const t=e;this._objects.remove(t),t.dispose(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;if(t!==i.visible){const e=t?1|i.bucketKey:-2&i.bucketKey;this._objects.updateKey(i,e),this._notifyDirty()}}preSubmit(e){const t=e.camera.eye;this._objects.forEach(((e,i)=>{1&i&&e.forEach((e=>{const i=ot(t,e.obb.center);e.renderable.meta.cameraDepthSquared=i}))}))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.components.visibility.reset(t),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.components.visibility.componentCount();return{visible:i,invisible:t.components.count-i}}setComponentData(e,t){const i=e,r=i.renderable.material;if(function(e){return"function"==typeof e}(t)){const e=i.components,s=e.materialDataBuffer,a=e.materialDataIndices,n={castShadows:!0,pickable:!0,externalColor:hd(),externalColorMixMode:1},o=s.textureBuffer,l=new Uint8Array(4),c=new Uint32Array(l.buffer);let h=0,d=0,u=0,p=!1,m=0;for(let i=0;i<e.count;i++)t(i,n),h+=+(n.externalColor[3]<1),d+=+(3===n.externalColorMixMode&&1===n.externalColor[3]),u+=+n.castShadows,Gw(n.externalColor,n.externalColorMixMode,l),l[2]=254&l[2]|+n.castShadows,o.setData(a[i],0,l[0],l[1],l[2],l[3]),p=p||i>0&&m!==c[0],m=c[0],n.pickable!==PE(e.pickability,i)&&(e.pickability=TE(e.pickability,e.count,i,n.pickable));p?(r.componentParameters=new VI,r.componentParameters.castShadows=WI(u,e.count),r.componentParameters.transparent=WI(h,e.count),r.componentParameters.opaqueOverride=WI(d,e.count),r.componentParameters.texture=o,o.updateTexture()):(r.componentParameters=new FI,r.componentParameters.castShadows=n.castShadows?0:2,r.componentParameters.externalColor=n.externalColor,r.componentParameters.externalColorMixMode=n.externalColorMixMode)}else r.componentParameters=new FI,r.componentParameters.castShadows=t.castShadows?0:2,r.componentParameters.externalColor=t.externalColor,r.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty()}getComponentAabb(e,t,i){return e.intersectionGeometry.getComponentAabb(t,i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}intersect(e,t,i,r,s,a){const n=e;h(s)&&(s.localOrigin=n.transform.position);const o=Yr(ZI,n.transform.rotationScale);vt(QI,t,n.transform.position),vt(YI,i,n.transform.position),lt(QI,QI,o),lt(YI,YI,o);const l=Wr(ZI,o);return n.intersectionGeometry.intersect(QI,YI,r,l,s,a)}addEdges(e,t,i,r){const s=e,{indices:a,positions:n}=s.intersectionGeometry,o=s.components.offsets;return t.addComponentObject(e,s.transform,s.obb.center,n,a,o,i,r)}addComponentHighlight(e,t){const i=e.components;u(i.highlightCounts)&&(i.highlightCounts=new Uint32Array(i.count+1));0===i.highlightCounts[t]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,t){const i=e.components;if(u(i.highlightCounts))return void NI.warn("Removing non-existing highlight.");const r=i.highlightCounts[t],s=i.highlightCounts[i.count];if(0!==r){if(r>1)return i.highlightCounts[t]=r-1,void(i.highlightCounts[i.count]=s-1);i.highlightCounts[t]=0,i.highlightsDirty(),this._notifyDirty(),1===s?i.highlightCounts=null:i.highlightCounts[i.count]=s-1}else NI.warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;h(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects.getBucket(1)}get performanceInfo(){const e=this._objects.getPerformanceInfo(1);return{shown:e.added,hidden:e.removed}}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,s=r.vertices.layoutParameters,a=ec.createVertex(i,35044,r.vertices.data),n=x(r.indices,(e=>ec.createIndex(i,35044,e))),o=Eo(sI(s)),l=new Uint16Array(r.vertices.count);for(let e=0;e<t.count;e++){const i=t.offsets[e],s=t.offsets[e+1],a=t.materialDataIndices[e];if(h(r.indices))for(let e=i;e<s;e++){l[r.indices[e]]=a}else for(let e=i;e<s;e++)l[e]=a}const c=ec.createVertex(i,35044,l.buffer),d=new zI(e.transform.position),u=fn(e.transform.rotationScale);Yr(u,u),Wr(u,u);const p=new MI;Xe(p.worldFromModel_TL,d.low),Xe(p.worldFromModel_TH,d.high),Kr(p.worldFromModel_RS,e.transform.rotationScale),Kr(p.transformNormal_GlobalFromModel,u),Ts(p.toMapSpace,e.toMapSpace);const f=new II,g=new Jl(i,f.attributeLocations,{data:o,componentIndices:HI},{data:a,componentIndices:c},m(n)),v=new AE;return v.material=f,v.drawParameters=p,v.geometry=new EE(g,r.primitiveType,s,h(n)),v.meta.cameraDepthSquared=.5,v.meta.gpuMemoryEstimate=a.byteSize+c.byteSize+(h(n)?n.byteSize:0),v}_notifyDirty(){this._renderManager.notifyDirty()}}const HI=Eo(Io().u16("componentIndex"));function WI(e,t){return e===t?0:0===e?2:1}const ZI=mn(),QI=je(),YI=je();var $I=Object.freeze({__proto__:null,build:function(e){const t=new xn;return t.include(Rh),t.fragment.uniforms.add("tex","sampler2D"),0===e.function&&(e.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(bn`
      void main() {
        gl_FragColor = texture2D(tex, uv) * opacity;
      }`)):t.fragment.code.add(bn`
      void main() {
        gl_FragColor = texture2D(tex, uv);
      }`)),2===e.function&&t.fragment.code.add(bn`
    void main() {
      gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
    }`),3===e.function&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(bn`
    void main() {
      vec4 srcColor = texture2D(colorTexture, uv);
      float srcAlpha = texture2D(alphaTexture, uv).r;
      vec4 frontFace = texture2D(frontFaceTexture, uv);

      gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
    }`)),t}});class XI extends Tn{initializeProgram(e){const t=XI.shader.get().build(this.configuration);return new bo(e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),Pn)}initializePipeline(){if(2===this.configuration.function)return wo({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case 0:return wo({colorWrite:To});case 1:return wo({blending:Co(770,1,771,771),colorWrite:To});default:return wo({blending:Oo(1,771),colorWrite:To})}}}XI.shader=new Rn($I,(()=>Promise.resolve().then((function(){return $I}))));class KI extends Sn{constructor(){super(...arguments),this.function=0,this.alphaMode=0,this.hasOpacityFactor=!1}}e([Cn({count:4})],KI.prototype,"function",void 0),e([Cn({count:3})],KI.prototype,"alphaMode",void 0),e([Cn()],KI.prototype,"hasOpacityFactor",void 0);class JI{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._techniques=new Set}dispose(){this._techniques.forEach((e=>this._techniqueRepository.release(e))),this._techniques.clear(),h(this._vao)&&(this._vao.dispose(),this._vao=null)}composite(e,t=0,i=1){this.compositeInternal(e,t,i,0)}compositeTransparent(e,t,i,r=1){const s=this._rctx;eL.alphaMode=1,eL.function=3,eL.hasOpacityFactor=1!==r;const a=this._techniqueRepository.acquire(XI,eL);s.bindProgram(a.program),a.bindPipelineState(s),a.program.setUniform1i("colorTexture",1),s.bindTexture(e,1),a.program.setUniform1i("alphaTexture",2),s.bindTexture(t,2),a.program.setUniform1i("frontFaceTexture",3),s.bindTexture(i,3);const n=this.ensureVAO();s.bindVAO(n),s.drawArrays(5,0,Kl(n,"geometry")),this._techniqueRepository.release(a)}compositeSpecial(e,t){this.compositeInternal(e,0,1,t)}compositeInternal(e,t,i,r){const s=this._rctx;eL.alphaMode=t,eL.function=r,eL.hasOpacityFactor=1!==i;const a=this._techniqueRepository.acquire(XI,eL);s.bindProgram(a.program),a.bindPipelineState(s),a.program.setUniform1i("tex",1),eL.hasOpacityFactor&&a.program.setUniform1f("opacity",i),s.bindTexture(e,1);const n=this.ensureVAO();s.bindVAO(n),s.drawArrays(5,0,Kl(n,"geometry")),this._techniqueRepository.release(a)}ensureVAO(){return u(this._vao)&&(this._vao=Nl(this._rctx)),this._vao}}const eL=new KI;function tL(e,t,i){return Ul(t,e)*(i[1]-i[0])+i[0]}function iL(e,t,i){if(t.size<1e4)return dL.compute(e,t);const r=IE();return i.forEach((t=>{t.isVisible&&FE(r,function(e,t){if(!t.isVisible)return;const i=IE(),r=t.getObjects();t.getSpatialQueryAccelerator()?function(e,t,i){const r=t.eye,s=t.viewForward,a=t.frustum,n=e=>e.isVisible,o=i.objectCount;if(o<500)LE(cL,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,"front-to-back",cL,((i,r)=>{rL(e,t,i),cL.far=e.near,r.setRange(cL)}),a,n),LE(cL,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,"back-to-front",cL,((i,r)=>{rL(e,t,i),cL.near=e.far,r.setRange(cL)}),a,n);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(s,"front-to-back",a,n,r),c=i.findClosest(s,"back-to-front",a,n,r);l&&c&&(aL(e,t,l.getCenter(),l.getBSRadius()),aL(e,t,c.getCenter(),c.getBSRadius()))}}(i,e,t.getSpatialQueryAccelerator()):function(e,t,i){if(hL.clear(),i.forEach((e=>{e.isVisible&&hL.add(e)})),hL.empty)return;hL.sort(t),LE(cL,t.near,Math.min(e.near,t.far)),hL.forEachInDepthRange(cL,"front-to-back",((i,r)=>{r<e.near&&rL(e,t,i)})),LE(cL,Math.max(e.far,t.near),t.far),hL.forEachInDepthRange(cL,"back-to-front",((t,i,r)=>{e.far=Math.max(e.far,r)}))}(i,e,r);return i}(e,t))})),r}function rL(e,t,i){if(!i.isVisible)return;if(!nl.intersectsSphere(t.frustum.planes,jo.wrap(i.getBSRadius(),i.getCenter())))return;const r=i.objectTransformation,s=lL;i.geometryRecords.forEach((i=>{wi(s,r,i.getShaderTransformation());const a=Rt(s);sL(e,t,i.geometry.boundingInfo,s,a)}))}function sL(e,t,i,r,s){const a=t.eye,n=t.viewForward;it(oL,i.center,r);const o=n[0]*(oL[0]-a[0])+n[1]*(oL[1]-a[1])+n[2]*(oL[2]-a[2]),l=i.bsRadius*s;if(!(o-l>e.near&&o+l<e.far)&&nl.intersectsSphere(t.frustum.planes,jo.wrap(l,oL)))if(i.bsRadius>100&&i.getChildren()){const a=i.getChildren();for(let i=0;i<8;++i)a[i]&&sL(e,t,a[i],r,s)}else uL.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function aL(e,t,i,r){const s=t.eye,a=t.viewForward,n=(i[0]-s[0])*a[0]+(i[1]-s[1])*a[1]+(i[2]-s[2])*a[2];e.near=Math.min(e.near,n-r),e.far=Math.max(e.far,n+r)}const nL=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],oL=je(),lL=jr(),cL=IE(),hL=new class{constructor(){this._items=new R({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const r=e.obj,s=r.getCenter(),a=r.getBSRadius(),n=(s[0]-t[0])*i[0]+(s[1]-t[1])*i[1]+(s[2]-t[2])*i[2];e.distance=n,e.near=n-a,e.far=n+a})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if("front-to-back"===t)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}}},dL=new class{constructor(){this.view=jr(),this.viewProj=jr(),this.frustum=nl.create(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(e,t){this.reset(),_i(this.view,e.viewMatrix),wi(this.viewProj,e.projectionMatrix,this.view),nl.copy(e.frustum,this.frustum);const i=this.view,r=i[2],s=i[6],a=i[10],n=i[14],o=this.range;let l=0;if(t.forEach((e=>{if(!e.instanceParameters.visible)return;if(!e.castShadow)return;let t,i;e.hasShaderTransformation?(t=e.getBoundingSphere(e.getShaderTransformation(),1,oL),i=oL):(t=e.bsRadius,i=e.center);const o=r*i[0]+s*i[1]+a*i[2]+n,c=o-t,h=o+t;this.geometries[l]=e,this.near[l]=-h,this.far[l]=-c,++l})),0===this.geometries.length)return o;for(let e=0;e<this.geometries.length;++e)this.near[e]>o.far&&(o.far=this.near[e]),this.near[e]>2&&this.far[e]<o.near&&(o.near=this.far[e]);const c=this.looseRange;c.near=Math.max(.5*o.near,2),c.far=2*o.far;let h=0,d=0;for(let e=0;e<this.geometries.length;++e)this.near[e]<o.near&&(this.near[e]>=c.near?o.near=this.near[e]:this.nearCandidates[h++]=e),this.far[e]>o.far&&(this.far[e]<=c.far?o.far=this.far[e]:this.farCandidates[d++]=e);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return o;this.nearCandidates.sort(((e,t)=>this.near[e]<this.near[t]?-1:this.near[e]>this.near[t]?1:0)),this.farCandidates.sort(((e,t)=>this.far[e]<this.far[t]?1:this.far[e]>this.far[t]?-1:0));for(let e=0;e<this.nearCandidates.length;++e){const t=this.nearCandidates[e];if(this.near[t]<o.near){const e=this.geometries[t],i=e.boundingInfo;this.includeNearBoundingInfoRec(i,e.getShaderTransformation())}}for(let e=0;e<this.farCandidates.length;++e){const t=this.farCandidates[e];if(this.far[t]>o.far){const e=this.geometries[t],i=e.boundingInfo;this.includeFarBoundingInfoRec(i,e.getShaderTransformation())}}return o}reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}includeNearBoundingInfoRec(e,t){let i=e.getBSRadius();const r=e.getCenter();it(oL,r,t);const s=Rt(t),a=oL[0],n=oL[1],o=oL[2];i*=s;const{planes:l}=this.frustum;if(l[0][0]*a+l[0][1]*n+l[0][2]*o+l[0][3]>i)return;if(l[1][0]*a+l[1][1]*n+l[1][2]*o+l[1][3]>i)return;if(l[2][0]*a+l[2][1]*n+l[2][2]*o+l[2][3]>i)return;if(l[3][0]*a+l[3][1]*n+l[3][2]*o+l[3][3]>i)return;const c=this.view[2]*a+this.view[6]*n+this.view[10]*o+this.view[14],h=c+i;if(!(-(c-i)<2||-h>=this.range.near))if(-h>this.looseRange.near)this.range.near=-h;else{if(i>100){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this.includeNearBoundingInfoRec(i[e],t);return}}uL.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}includeFarBoundingInfoRec(e,t){let i=e.getBSRadius();const r=e.getCenter();it(oL,r,t);const s=Rt(t),a=oL[0],n=oL[1],o=oL[2];i*=s;const{planes:l}=this.frustum;if(l[0][0]*a+l[0][1]*n+l[0][2]*o+l[0][3]>i)return;if(l[1][0]*a+l[1][1]*n+l[1][2]*o+l[1][3]>i)return;if(l[2][0]*a+l[2][1]*n+l[2][2]*o+l[2][3]>i)return;if(l[3][0]*a+l[3][1]*n+l[3][2]*o+l[3][3]>i)return;const c=this.view[2]*a+this.view[6]*n+this.view[10]*o+this.view[14]-i;if(!(-c<=this.range.far))if(-c<this.looseRange.far)this.range.far=-c;else{if(i>100){const i=e.getChildren();if(void 0!==i){for(let e=0;e<8;++e)void 0!==i[e]&&this.includeFarBoundingInfoRec(i[e],t);return}}uL.unionDepthRangeWithAABB(this.range,this.viewProj,t,e.getBBMin(),e.getBBMax())}}},uL=new class{constructor(){this.modelViewProj=jr(),this.clipPosition=[Tr(),Tr(),Tr(),Tr(),Tr(),Tr(),Tr(),Tr()]}unionDepthRangeWithAABB(e,t,i,r,s){const a=this.modelViewProj;wi(a,t,i);let n=!1;for(let e=0;e<8;++e){const t=this.clipPosition[e],i=0===e||3===e||4===e||7===e?r[0]:s[0],n=0===e||1===e||4===e||5===e?r[1]:s[1],o=e<4?r[2]:s[2];t[0]=a[0]*i+a[4]*n+a[8]*o+a[12],t[1]=a[1]*i+a[5]*n+a[9]*o+a[13],t[2]=a[2]*i+a[6]*n+a[10]*o+a[14],t[3]=a[3]*i+a[7]*n+a[11]*o+a[15]}for(let t=0;t<12;++t){const i=this.clipPosition[nL[t][0]],r=this.clipPosition[nL[t][1]],s=this.clipPosition[nL[t][2]],a=this.clipTriangle(i,r,s);let o=!0;for(let e=0;e<a.length;++e){if(a[e][3]>=2){o=!1;break}}if(!o){n=!0;for(let t=0;t<a.length;++t){const i=a[t][3];i<e.near&&(e.near=i),i>e.far&&(e.far=i)}}}return n}inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void Vl(!1)}intersect(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),Ms(Tr(),e,t,r)}clipTriangle(e,t,i){let r=[e,t,i];for(let e=0;e<4;++e){const t=r;r=[];for(let i=0;i<t.length;++i){const s=t[i],a=t[(i+1)%t.length];this.inside(a,e)?(this.inside(s,e)||r.push(this.intersect(s,a,e)),r.push(a)):this.inside(s,e)&&r.push(this.intersect(s,a,e))}}return r}};let pL=class extends T{constructor(){super(...arguments),this._handles=new $t,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this.events=new se,this.tmpScreenPoint=Vt(),this.tmpRenderPoint=Nt()}get updating(){return u(this._imageSources)&&h(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this.updateResourceLoading(),this.events.emit("request-render")};h(this._magnifier)&&this._handles.add(this._magnifier.watch("version",t)),t()}get enabled(){return h(this._validMagnifier)}get _validMagnifier(){return h(this._magnifier)&&this._magnifier.visible&&h(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return h(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),h(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this.disposeResources()}render(e,t){const i=this._validMagnifier;if(u(i))return;const r=t.camera.pixelRatio,s=Math.ceil(r*i.size);if(this.updateResources(e,s),u(this._resources))return;const a=this._resources.textures,n=Math.ceil(1/this.factor*s);a.input.resize(n,n);const o=t.camera.fullWidth,l=t.camera.fullHeight;zt(i.position,this.tmpScreenPoint);const c=t.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),h=.5*n,d=.5*n;c[0]=Re(c[0],h,o-h-1),c[1]=Re(c[1],d,l-d-1);const p=Math.floor(c[0]-h),m=Math.floor(c[1]-d);e.bindTexture(a.input,0),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,p,m,n,n,0);const f=i.offsetX*r,g=i.offsetY*r,v=(c[0]+f)/o*2-1,y=(c[1]-g)/l*2-1,_=s/o*2,x=s/l*2;e.bindVAO(this._resources.vao),e.bindTexture(a.overlay,1),e.bindTexture(a.mask,2);const b=this._resources.program;e.bindProgram(b),b.setUniform1i("textureInput",0),b.setUniform1i("textureOverlay",1),b.setUniform1i("textureMask",2),b.setUniform4f("drawPosition",v,y,_,x),b.setUniform1i("maskEnabled",i.maskEnabled?1:0),b.setUniform1i("overlayEnabled",i.overlayEnabled?1:0),e.setPipelineState(this._resources.pipelineState),e.drawArrays(5,0,4)}updateResourceLoading(){const e=this._validMagnifier;if(u(e))return;const t=e.mask,i=e.overlay;!h(this._imageLoadTask)||this._imageLoadTask.mask===t&&this._imageLoadTask.overlay===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),h(this._imageSources)||h(this._imageLoadTask)||(this._imageLoadTask={mask:t,overlay:i,task:j((async e=>{const r=u(t)||u(i)?ch(e):null,s=h(t)?_n(t,{signal:e}):r.then((e=>e.mask)),a=h(i)?_n(i,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await s,overlay:await a},this.disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}updateResources(e,t){if(!this.enabled)return void this.disposeResources();if(h(this._resources)){if(this._resources.textures.size!==t){const i=this.createTextureResources(e,t);if(u(i))return void this.disposeResources();this.disposeTextureResources(this._resources.textures),this._resources.textures=i}return}const i=this.createTextureResources(e,t);u(i)||(this._resources={textures:i,program:this.createProgram(e),vao:this.createVAO(e),pipelineState:wo({blending:Oo(1,771),depthTest:null,depthWrite:null,colorWrite:To})})}disposeResources(){u(this._resources)||(this.disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}createTextureResources(e,t){if(u(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new Po(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.overlay),r=new Po(e,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},this._imageSources.mask);return{input:new Po(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1}),mask:r,overlay:i,size:t}}createProgram(e){const t=function(){const e=new xn;return e.attributes.add("position","vec2"),e.vertex.uniforms.add("proj","mat4"),e.vertex.uniforms.add("drawPosition","vec4"),e.varyings.add("vUV","vec2"),e.vertex.code.add(bn`
    void main(void) {
      vUV = position;
      gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
    }
  `),e.fragment.uniforms.add("textureInput","sampler2D"),e.fragment.uniforms.add("textureMask","sampler2D"),e.fragment.uniforms.add("textureOverlay","sampler2D"),e.fragment.uniforms.add("maskEnabled","bool"),e.fragment.uniforms.add("overlayEnabled","bool"),e.fragment.code.add(bn`
    const float barrelFactor = 1.1;

    vec2 barrel(vec2 uv) {
      vec2 uvn = uv * 2.0 - 1.0;

      if (uvn.x == 0.0 && uvn.y == 0.0) {
        return vec2(0.5, 0.5);
      }

      float theta = atan(uvn.y, uvn.x);
      float r = pow(length(uvn), barrelFactor);
      return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
    }

    void main() {
      float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
      vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
      vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);

      // Premultiply
      overlayColor.rgb *= overlayColor.a;

      gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
    }
  `),e}();return new bo(e,t.generateSource("vertex"),t.generateSource("fragment"),this.attributeLocations)}createVAO(e){return Nl(e,Yl,this.attributeLocations,0,1)}get attributeLocations(){return{position:0}}};e([S()],pL.prototype,"_imageSources",void 0),e([S()],pL.prototype,"_imageLoadTask",void 0),e([S({readOnly:!0,dependsOn:["_imageSources","_imageLoadTask"]})],pL.prototype,"updating",null),pL=e([re("esri/views/3d/webgl-engine/lib/MagnifierHelper")],pL);class mL{constructor(e,t=.9){this._alpha=.9,this._startTime=0,this._count=0,this._sum=0,this._smooth=0,this._min=0,this._max=0,this._name=e,this._alpha=t,this.reset()}reset(){this._count=0,this._sum=0,this._smooth=0,this._min=1/0,this._max=0}get name(){return this._name}get count(){return this._count}get average(){return this._count>0?this._sum/this._count:0}get smooth(){return this._smooth}get min(){return this._min}get max(){return this._max}begin(){this._startTime=performance.now()}end(){const e=performance.now()-this._startTime;this._count+=1,this._sum+=e,this._smooth=this._alpha*e+(1-this._alpha)*this._smooth,this._min=Math.min(this._min,e),this._max=Math.max(this._max,e)}toJSON(){return{name:this.name,count:this.count,average:this.average,smooth:this.smooth,min:this.min,max:this.max}}}!function(e){const t={},i={};function r(i){return i in t||(t[i]=new e(i)),t[i]}function s(e){console.log(r(e).toJSON())}e.get=r,e.begin=function(e){r(e).begin()},e.end=function(e,t=!0){r(e).end();const a=performance.now();t&&(!(e in i)||a>=i[e]+1e3)&&(s(e),i[e]=a)},e.log=s,e.logAll=function(){for(const e in t)s(e)}}(mL||(mL={}));var fL=mL;class gL{constructor(){this.identifier=0,this.transparent=!1,this.integratedMesh=!1,this.viewTransform=new qh.ViewProjectionTransform,this.transformNormal_ViewFromGlobal=Br(),this.cameraNearFar=cn(),this.slicePlane=Wo.create(),this.slicePlaneEnabled=!0,this.ambientOcclusionEnabled=!0,this.shadowsEnabled=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3}}class vL{constructor(){this.identifier=1,this.viewTransform=new qh.ViewProjectionTransform,this.cameraNearFar=cn(),this.slicePlane=Wo.create()}}class yL{constructor(){this.identifier=2,this.viewTransform=new qh.ViewProjectionTransform,this.slicePlane=Wo.create(),this.inverseViewport=cn(),this.viewport=Tr()}}class _L{constructor(e,t,i=0){this._rctx=e,this._techniqueRepository=t,this._sorting=i,this._draws=new R({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._passBoundTechniques=new Set,this._previouslyBoundMaterials=new Map,this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,s){const a=this._draws.pushNew();a.geometry=t,a.geometryRanges=i,a.material=e,a.bindDrawParams=r,a.depthSquaredHint=s,a.indexType=t.indexed?t.vao.indexBuffer.indexType:0}dispatch(e){const t=this._rctx;this._passBoundTechniques.clear(),this._previouslyBoundMaterials.clear(),this._previouslyBoundDraw.clear();let i=null;const r={repository:this._techniqueRepository},s=this._draws.length;for(let a=0;a<s;a++){const s=this._draws.data[a],n=s.geometry,o=s.material.getTechnique(r,e,n.parameters);if(this._passBoundTechniques.has(o)||(o.bindPass(t,e),this._passBoundTechniques.add(o)),t.bindVAO(n.vao),o===i&&3===o.configuration.transparencyPassType||(t.bindProgram(o.program),t.setPipelineState(o.pipeline),i=o),this._previouslyBoundMaterials.get(o)!==s.material&&(o.bindMaterial(t,s.material,e),this._previouslyBoundMaterials.set(o,s.material)),this._previouslyBoundDraw.get(o)!==s.bindDrawParams&&(o.bindDraw(s.bindDrawParams,s.material,e),this._previouslyBoundMaterials.set(o,s.material)),0!==s.indexType){const e=xL.get(s.indexType);for(let i=0;i<s.geometryRanges.length;i+=2){const r=s.geometryRanges[i],a=s.geometryRanges[i+1];t.drawElements(n.primitiveType,a,s.indexType,r*e)}}else for(let e=0;e<s.geometryRanges.length;e+=2){const i=s.geometryRanges[e],r=s.geometryRanges[e+1];t.drawArrays(n.primitiveType,i,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort(((t,i)=>{const r=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==r?r:t.geometry.vao.size-i.geometry.vao.size}))}get count(){return this._draws.length}}const xL=new Map;xL.set(5121,1),xL.set(5123,2),xL.set(5125,4);class bL{constructor(e,t){this.rctx=e,this.shaderTechniqueRepository=t,this.canRender=!0,this._materialPassParams=new gL,this._shadowPassParams=new vL,this._highlightPassParams=new yL,this._systems=new Set,this._passes=new Array,this._shadowMapPass=this._registerPass(new _L(e,this.shaderTechniqueRepository)),this.passes={materialOpaque:this._registerPass(new _L(e,this.shaderTechniqueRepository)),materialTransparent:this._registerPass(new _L(e,this.shaderTechniqueRepository,1)),materialIntegratedMesh:this._registerPass(new _L(e,this.shaderTechniqueRepository)),shadowMap:this._shadowMapPass,highlight:this._registerPass(new _L(e,this.shaderTechniqueRepository)),highlightIntegratedMesh:this._registerPass(new _L(e,this.shaderTechniqueRepository))}}register(e){this._systems.add(e)}prepareRender(e){this._passes.forEach((e=>e.prepareSubmit())),this._systems.forEach((t=>{t.submit(this.passes,{camera:e})})),this._passes.forEach((e=>e.finishSubmit())),this.shaderTechniqueRepository.frameUpdate()}render(e){if(4===e.slot)switch(this._configure(e),e.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 5:this.passes.highlight.dispatch(this._highlightPassParams);break;case 4:this._shadowMapPass.dispatch(this._shadowPassParams)}if(6===e.slot)switch(this._configure(e),e.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=1,this._configureMaterialColorPass(e),this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialTransparent.dispatch(this._materialPassParams)}if(1===e.slot)switch(this._configure(e),e.pass){case 0:this._materialPassParams.subPass=0,this._configureMaterialColorPass(e),this._materialPassParams.ssrParams=e.ssrParams,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 3:this._materialPassParams.subPass=3,this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 5:this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!0}notifyDirty(){this.initContext.requestRender()}slots(){return[4,6,1]}initializeRenderContext(e){this.initContext=e}uninitializeRenderContext(){}queryDepthRange(e){const t={near:1/0,far:-1/0};return this._systems.forEach((i=>{const r=i.queryShadowCasterDepthRange(e);h(r)&&FE(t,r,t)})),t}get shadowCastingEnabled(){return h(this.passes.shadowMap)}set shadowCastingEnabled(e){e?(this._materialPassParams.shadowsEnabled=!0,this.passes.shadowMap=this._shadowMapPass):(this._materialPassParams.shadowsEnabled=!1,this.passes.shadowMap=null)}get screenSpaceReflectionsEnabled(){return h(this._materialPassParams.ssrParams.ssrEnabled)}set screenSpaceReflectionsEnabled(e){this._materialPassParams.ssrParams.ssrEnabled=!!e}_configureMaterialColorPass(e){this._materialPassParams.shadowMap={bind:(t,i)=>{e.shadowMap.bind(t,i);const r=this._materialPassParams.viewTransform;Qe(wL,r.worldFromView_TL,r.worldFromView_TH),e.shadowMap.bindView(t,wL)}},this._materialPassParams.ambientOcclusion={bind:(t,i)=>{e.ssaoHelper.setUniforms(t,i)}},this._materialPassParams.ambientOcclusionEnabled=e.ssaoHelper.enabled,this._materialPassParams.sceneHasOcludees=e.hasOccludees}_configure(e){const t=4===e.pass?this._shadowPassParams:5===e.pass?this._highlightPassParams:this._materialPassParams;this._updateParameters(e,t)}_updateParameters(e,t){const i=e.camera,r=i.viewInverseTransposeMatrix;Ye(wL,r[3],r[7],r[11]),SL.set(wL),Xe(t.viewTransform.worldFromView_TH,SL.high),Xe(t.viewTransform.worldFromView_TL,SL.low),Qr(t.viewTransform.viewFromCameraRelative_RS,i.viewMatrix),_i(t.viewTransform.projFromView,i.projectionMatrix),0===t.identifier?(this._materialPassParams.transparent=6===e.slot,this._materialPassParams.integratedMesh=1===e.slot,this._materialPassParams.lighting=e.scenelightingData,Wr(CL,t.viewTransform.viewFromCameraRelative_RS),Yr(t.transformNormal_ViewFromGlobal,CL),ls(t.cameraNearFar,i.near,i.far)):1===t.identifier?ls(t.cameraNearFar,i.near,i.far):2===t.identifier&&(t.highlightDepthTexture=e.highlightDepthTexture,Ts(t.viewport,i.fullViewport),t.inverseViewport[0]=1/i.fullViewport[2],t.inverseViewport[1]=1/i.fullViewport[3]),Wo.copy(e.sliceHelper.plane,t.slicePlane),at(t.slicePlane.origin,t.slicePlane.origin,wL),t.slicePlaneEnabled=e.sliceHelper.isEnabled,this._materialPassParams.transparencyPassType=e.transparencyPassType}_registerPass(e){return this._passes.push(e),e}get needsHighlight(){return this.passes.highlight.count>0||this.passes.highlightIntegratedMesh.count>0}}const wL=je(),CL=Br(),SL=new zI;var TL=Object.freeze({__proto__:null,build:function(e){const t=new xn,i=t.vertex.code,r=t.fragment.code;return t.attributes.add("position","vec2"),2===e.highlightStage&&(i.add(bn`
    void main() {
      gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
    }`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("invFramebufferDim","vec2"),r.add(bn`
      void main() {
        vec2 coord = gl_FragCoord.xy * invFramebufferDim;
        vec4 value = texture2D(tex, coord);
        float mx = floor(max(value.g, value.b));
        gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
      }`)),0===e.highlightStage&&(t.attributes.add("uv0","vec2"),e.gridOptimization?(t.vertex.uniforms.add("coverageTex","sampler2D"),t.fragment.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinate","vec3")):(t.vertex.uniforms.add("blurSize","vec2"),t.varyings.add("blurCoordinates[5]","vec2")),i.add(bn`
    void main() {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e.gridOptimization?bn`
      vec4 cov = texture2D(coverageTex, uv0);
      if (cov.r == 0.0) {
        gl_Position = vec4(0.0);
      }
      blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
      `:bn`
      vec2 uv = position.xy * 0.5 + vec2(0.5);
      blurCoordinates[0] = uv;
      blurCoordinates[1] = uv + blurSize * 1.407333;
      blurCoordinates[2] = uv - blurSize * 1.407333;
      blurCoordinates[3] = uv + blurSize * 3.294215;
      blurCoordinates[4] = uv - blurSize * 3.294215;
          `}
    }`),t.fragment.uniforms.add("tex","sampler2D"),r.add(bn`
    void main() {
      ${e.gridOptimization?bn`
          vec2 uv = blurCoordinate.xy;
          vec4 center = texture2D(tex, uv);

          // do not blur if no pixel or all pixels in neighborhood are set
          if (blurCoordinate.z == 1.0) {
            gl_FragColor = center;
          } else {
            vec4 sum = vec4(0.0);
            sum += center * 0.204164;
            sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
            sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
            sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
            gl_FragColor = sum;
          }`:bn`
          vec4 sum = vec4(0.0);
          sum += texture2D(tex, blurCoordinates[0]) * 0.204164;
          sum += texture2D(tex, blurCoordinates[1]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[2]) * 0.304005;
          sum += texture2D(tex, blurCoordinates[3]) * 0.093913;
          sum += texture2D(tex, blurCoordinates[4]) * 0.093913;
          gl_FragColor = sum;`}
    }`)),1===e.highlightStage&&(t.varyings.add("uv","vec2"),e.gridOptimization&&(t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("coverageTex","sampler2D")),i.add(bn`
      void main() {
        ${e.gridOptimization?bn`
            vec4 cov = texture2D(coverageTex, uv0);
            // if no highlight pixel set in this block, hide block
            if (cov.r == 0.0) {
              gl_Position = vec4(0.0);
              return;
            }`:""}
        gl_Position = vec4(position, 0.0, 1.0);
        uv = position.xy * 0.5 + vec2(0.5);
      }`),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("origin","sampler2D"),t.fragment.uniforms.add("color","vec4"),t.fragment.uniforms.add("haloColor","vec4"),t.fragment.uniforms.add("outlineSize","float"),t.fragment.uniforms.add("blurSize","float"),t.fragment.uniforms.add("opacities","vec4"),r.add(bn`
      void main() {
        // Read the highlight intensity from the blurred highlight image
        vec4 blurredHighlightValue = texture2D(tex, uv);
        float highlightIntensity = blurredHighlightValue.a;

        // Discard all pixels which are not affected by highlight
        if (highlightIntensity == 0.0) {
          discard;
        }

        vec4 origin_color = texture2D(origin, uv);

        float outlineIntensity;
        float fillIntensity;

        // if occluded
        if (blurredHighlightValue.g > blurredHighlightValue.b) {
          outlineIntensity = haloColor.w * opacities[1];
          fillIntensity = color.w * opacities[3];
        }
        // if unoccluded
        else {
          outlineIntensity = haloColor.w * opacities[0];
          fillIntensity = color.w * opacities[2];
        }

        float inner = 1.0 - outlineSize / 9.0;
        float outer = 1.0 - (outlineSize + blurSize) / 9.0;

        float outlineFactor = smoothstep(outer, inner, highlightIntensity);
        //float fillFactor = smoothstep(0.6, 0.72, highlightIntensity);
        float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
        float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;

        // Blending equation: gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        // I.e., color should not be premultiplied with alpha
        gl_FragColor = vec4(mix(haloColor.rgb, color.rgb, fillFactor), intensity);
      }`)),t}});class PL extends Tn{initializeProgram(e){const t=PL.shader.get().build(this.configuration);return new bo(e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),Pn)}bindApplyPass(e){this.program.setUniform1i("tex",0),this.program.setUniform1i("origin",1),this.configuration.gridOptimization&&this.program.setUniform1i("coverageTex",2),this.program.setUniform4fv("color",e.color),this.program.setUniform4fv("haloColor",e.haloColor),this.program.setUniform1f("outlineSize",8.6),this.program.setUniform1f("blurSize",.4),this.program.setUniform4f("opacities",e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)}initializePipeline(){return 1===this.configuration.highlightStage?wo({blending:Co(770,1,771,771),colorWrite:To}):wo({colorWrite:To})}get primitiveType(){return this.configuration.gridOptimization?4:5}}PL.shader=new Rn(TL,(()=>Promise.resolve().then((function(){return TL}))));class RL extends Sn{constructor(){super(...arguments),this.highlightStage=0,this.gridOptimization=!1}}e([Cn({count:3})],RL.prototype,"highlightStage",void 0),e([Cn()],RL.prototype,"gridOptimization",void 0);class ML{constructor(e,t){this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0},this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null,this._rctx=t,this.viewportToRestore=Tr(),this.defaultOptions={color:cd(1,0,1,1),haloColor:cd(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05};const i=new RL,r=(t,i)=>e.acquireAndReleaseExisting(PL,t,i);i.highlightStage=0,i.gridOptimization=!1,this.blurTechnique=r(i,this.blurTechnique),i.highlightStage=0,i.gridOptimization=!0,this.blurGridTechnique=r(i,this.blurGridTechnique),i.highlightStage=1,i.gridOptimization=!1,this.applyTechnique=r(i,this.applyTechnique),i.highlightStage=1,i.gridOptimization=!0,this.applyGridTechnique=r(i,this.applyGridTechnique),i.highlightStage=2,i.gridOptimization=!1,this.downsampleTechnique=r(i,this.downsampleTechnique)}set enabled(e){e?this.enable():this.disable()}get enabled(){return null!==this.blur0Fbo}get profilingCallback(){return xc.HIGHLIGHTS_PROFILE_TO_CONSOLE?e=>console.log(e):null}setDefaultOptions(e){this.defaultOptions=e}render(e,t,i){const r=e.pixelRatio,s=!xc.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,a=this._rctx;Vl(this.enabled),Ts(this.viewportToRestore,e.fullViewport);const n=e.fullWidth,o=e.fullHeight,l=Math.ceil(n/r),c=Math.ceil(o/r);this.blur0Fbo.resize(l,c),this.blur1Fbo.resize(l,c),a.bindVAO(this.quadVAO);let h=null,d=null;s&&(this._gridUpdateResources(t,32),this._gridComputeMipmap()),s?(h=this._grid.vao,d=this.blurGridTechnique,a.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,1),d.program.setUniform1i("coverageTex",1)):(h=this.quadVAO,d=this.blurTechnique),d.bindPipelineState(a),a.bindProgram(d.program),a.bindVAO(h),a.bindFramebuffer(this.blur0Fbo),a.setViewport(0,0,l,c),a.setClearColor(0,0,0,0),a.clear(16384),d.program.setUniform1i("tex",0),a.bindTexture(t.colorTexture,0),d.program.setUniform2f("blurSize",1/l,0),a.drawArrays(d.primitiveType,0,Kl(h,"geometry")),a.bindFramebuffer(this.blur1Fbo),a.clear(16384),a.bindTexture(this.blur0Fbo.colorTexture,0),d.program.setUniform2f("blurSize",0,1/c),a.drawArrays(d.primitiveType,0,Kl(h,"geometry"));const u=s?this.applyGridTechnique:this.applyTechnique;if(a.bindFramebuffer(i),u.bindPipelineState(a),a.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),a.bindProgram(u.program),a.bindTexture(this.blur1Fbo.colorTexture,0),a.bindTexture(t.colorTexture,1),s){const e=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;a.bindTexture(e,2)}u.bindApplyPass(this.defaultOptions),a.drawArrays(u.primitiveType,0,Kl(h,"geometry")),a.bindVAO(null)}enable(){if(this.enabled)return;this.quadVAO=Nl(this._rctx);const e={colorTarget:0,depthStencilTarget:0,width:0,height:0},t={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new Do(this._rctx,e,t),this.blur1Fbo=new Do(this._rctx,e,t)}disable(){this.enabled&&(this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null)}_gridUpdateResources(e,t){const i=this._rctx,r=this._grid;let s=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],s=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(s=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,s=!0),s){for(let e=1;e<r.coverageMipmap.length;e++)r.coverageMipmap[e].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(let e=0;e<r.mipmapLevels;e++){const t=r.coverageMipmap[e],s={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)},a={colorTarget:0,depthStencilTarget:0,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)},n=new Do(i,a,s);r.coverageMipmap[e+1]=n}}const a=Math.ceil(e.height/r.cellPixelSize),n=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==a||r.horizontalCellCount!==n){r.verticalCellCount=a,r.horizontalCellCount=n;const e=a+1,t=n+1,s=1/a,o=1/n,l=6,c=4,h=new Float32Array(l*c*e*t);let d=0;for(let i=0;i<e;i++)for(let e=0;e<t;e++)h[d+0]=(e-.5)*o*2-1,h[d+1]=(i-.5)*s*2-1,h[d+2]=e*o,h[d+3]=i*s,h[d+4]=(e+.5)*o*2-1,h[d+5]=(i-.5)*s*2-1,h[d+6]=e*o,h[d+7]=i*s,h[d+8]=(e-.5)*o*2-1,h[d+9]=(i+.5)*s*2-1,h[d+10]=e*o,h[d+11]=i*s,h[d+12]=(e-.5)*o*2-1,h[d+13]=(i+.5)*s*2-1,h[d+14]=e*o,h[d+15]=i*s,h[d+16]=(e+.5)*o*2-1,h[d+17]=(i-.5)*s*2-1,h[d+18]=e*o,h[d+19]=i*s,h[d+20]=(e+.5)*o*2-1,h[d+21]=(i+.5)*s*2-1,h[d+22]=e*o,h[d+23]=i*s,d+=l*c;r.vao&&r.vao.dispose(!0),r.vao=new Jl(i,Pn,{geometry:Wl},{geometry:ec.createVertex(i,35044,h)})}}_gridComputeMipmap(){const e=this._rctx,t=this._grid,i=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(e),e.bindVAO(this.quadVAO);for(let r=0;r<t.mipmapLevels;r++){e.bindFramebuffer(t.coverageMipmap[r+1]),e.bindTexture(t.coverageMipmap[r].colorTexture,0);const s=t.coverageMipmap[r+1].width,a=t.coverageMipmap[r+1].height;e.bindProgram(i),i.setUniform1i("tex",0),i.setUniform2f("invFramebufferDim",1/s,1/a),e.setViewport(0,0,s,a),e.drawArrays(5,0,Kl(this.quadVAO,"geometry"))}}getGpuMemoryUsage(){let e=rc(this.blur0Fbo)+rc(this.blur1Fbo);if(this._grid&&this._grid.coverageMipmap)for(const t of this._grid.coverageMipmap)e+=rc(t);return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}const OL={dataType:5121},DL={};class AL{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this._nextId=1,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this._depthTextures.has(t)&&(this._depthTextures.get(t).dispose(),this._depthTextures.delete(t)),this._depthBuffers.has(t)&&(this._depthBuffers.get(t).dispose(),this._depthBuffers.delete(t)),this._colorTextures.has(t)&&(this._colorTextures.get(t).dispose(),this._colorTextures.delete(t)))}getDepthTexture(e,t){if(!this.depthTextureSupported)return;let i=this._depthTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new Po(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:t.width,height:t.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===t.width&&i.descriptor.height===t.height||i.resize(t.width,t.height):(i=new Ao(this.rctx,{internalFormat:34041,...t}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,t){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=void 0)),i||(i=new Po(this.rctx,{target:3553,pixelFormat:6408,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:9729,wrapMode:33071,width:t.width,height:t.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:this._nextId++,...DL,...e}}registerColorTarget(e={}){return{id:this._nextId++,...OL,...e}}getFramebuffer(e,t,i){const r=this.getKey(t,i);let s=this._framebuffers.get(r);const a=this.getColorTexture(t,e);if(this.depthTextureSupported){const t=i?this.getDepthTexture(i,e):void 0;if(!s)return s=i?new Do(this.rctx,{colorTarget:0,depthStencilTarget:4},a,t):new Do(this.rctx,{colorTarget:0,depthStencilTarget:0},a),this._framebuffers.set(r,s),s;return(s.width!==e.width||s.height!==e.height||s.colorTexture!==a||s.depthStencilTexture!==t)&&(s.detachColorTexture(),s.detachDepthStencilTexture(),s.resize(e.width,e.height),s.attachColorTexture(a),s.attachDepthStencilTexture(t)),s}{const t=i?this.getDepthBuffer(i,e):void 0;if(!s)return s=new Do(this.rctx,{colorTarget:0,depthStencilTarget:i?3:0},a,t),this._framebuffers.set(r,s),s;return(s.width!==e.width||s.height!==e.height||s.colorTexture!==a)&&(s.detachColorTexture(),s.detachDepthStencilBuffer(),s.resize(e.width,e.height),s.attachColorTexture(a),s.attachDepthStencilBuffer(t)),s}}getKey(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}getGpuMemoryUsage(){let e=0;const t=new Set,i=i=>{t.has(i)||(t.add(i),e+=rc(i))};return this._depthTextures.forEach(i),this._colorTextures.forEach(i),this._depthBuffers.forEach(i),this._framebuffers.forEach(i),e}}class EL{constructor(e,t){this._rctx=e,this._compositingHelper=t,this._currentRenderTarget=0,this.dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const i=this._rctx;this.renderTargetHelper=new AL(i);const r=this.renderTargetHelper;this.mainColorTarget0=r.registerColorTarget({name:"mainColorTarget0"}),this.mainColorTarget1=r.registerColorTarget({name:"mainColorTarget1"}),this.frontFaceTarget=r.registerColorTarget({name:"frontFaceTarget"});const s=e=>r.registerColorTarget({name:e,dataType:5126,samplingMode:9728});this.colorFloatTarget=s("colorFloatTarget"),this.alphaFloatTarget=s("alphaFloatTarget"),this.mainDepth=r.registerDepthTarget({name:"mainDepth"}),this.linearDepth=r.registerColorTarget({name:"linearDepth",samplingMode:9728}),this.normal=r.registerColorTarget({name:"normal"}),this.highlight=r.registerColorTarget({name:"highlight",dataType:32819}),this.hudVisibility=r.registerColorTarget({name:"hudVisibility",dataType:32819}),this.tmpColor=r.registerColorTarget({name:"tmpColor"}),this.tmpDepth=r.registerDepthTarget({name:"tmpDepth"}),this.hudColor=r.registerColorTarget({name:"hudColor"})}dispose(){this.renderTargetHelper.dispose()}get width(){return this.dimensions.width}get height(){return this.dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget0:this.mainColorTarget1}get previousColorTarget(){return 0===this._currentRenderTarget?this.mainColorTarget1:this.mainColorTarget0}get currentRenderTarget(){return this._currentRenderTarget}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this.renderTargetHelper.getFramebuffer(this.dimensions,e,t)}get colorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this.renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get lastFrameColorTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this.renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this.getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this.getColorTexture(this.tmpColor)}get hudColorTexture(){return this.getColorTexture(this.hudColor)}get mainColorTexture(){return this.getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._currentRenderTarget=0===this._currentRenderTarget&&this._needLastFrameColorTexture?1:0}initializeFrame(e){const t=this._rctx;this.dimensions.width=e.fullWidth,this.dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const i=this._background.color;t.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),t.clearSafe(17664)}composite(){this._compositingHelper.composite(this.colorTexture,0)}renderTmpAndCompositeToMain(e,t){this.renderToTargets(e,this.tmpColor,this.mainDepth,IL),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),t)}renderHUDVisibility(e){this.renderToTargets(e,this.hudVisibility,this.mainDepth,LL)}compositeTransparentTerrainOntoHUDVisibility(){this.renderToTargets((()=>{this._compositingHelper.compositeSpecial(this.getColorTexture(this.tmpColor),2)}),this.hudVisibility,this.mainDepth)}renderOITPass(e,t,i){let r,s;switch(t){case 0:r=this.colorFloatTarget,s=[0,0,0,0];break;case 1:r=this.alphaFloatTarget,s=[1,1,1,1];break;case 2:r=this.frontFaceTarget,s=[0,0,0,0]}i?this.renderToTargets(e,r,this.tmpDepth,s,!0,!0):this.renderToTargets(e,r,this.mainDepth,s,!1)}compositeTransparentTerrainOntoMain(){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2)}compositeOccludedOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(this.getColorTexture(this.tmpColor),2,e)}compositeTransparentOntoOpaque(e){e?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(16384,255)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(this.getColorTexture(this.colorFloatTarget),this.getColorTexture(this.alphaFloatTarget),this.getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this.renderTargetHelper.disposeTargetResource(e)}set needLastFrameColorTexture(e){!e&&this._needLastFrameColorTexture&&(this._currentRenderTarget=0,this.disposeTarget(this.mainColorTarget1)),this._needLastFrameColorTexture=e}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(e,t,i,r,s,a){const n=this._rctx,o=this.bindTarget(t,i);let l=0;if(r){const e=1e-13,t=Math.max(e,r[3]);n.setClearColor(r[0],r[1],r[2],t),l|=16384}return s&&(l|=256),a&&(l|=1024),l&&n.clearSafe(l,!0===a?255:!1===a?0:a),e(),n.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),o}bindTarget(e,t){const i=this.renderTargetHelper.getFramebuffer(this.dimensions,e,t);return this._rctx.bindFramebuffer(i),i}getColorTexture(e){return this.renderTargetHelper.getColorTexture(e,this.dimensions)}getGpuMemoryUsage(){let e=0;return this.renderTargetHelper&&(e+=this.renderTargetHelper.getGpuMemoryUsage()),e}}const IL=[0,0,0,0],LL=[0,1,0,1];class FL{constructor(e){this.pluginContext=e,this.renderPlugins=new Array,this.slots=[];for(let e=0;e<23;++e)this.slots[e]=[]}add(e,t){this.renderPlugins.push(t);for(let i=0;i<e.length;++i){const r=e[i];this.slots[r].push(t)}t.initializeRenderContext(this.pluginContext),this.pluginContext.requestRender()}remove(e){const t=this.renderPlugins.length;this.renderPlugins=this.renderPlugins.filter((t=>t!==e)),Vl(this.renderPlugins.length<t,"Removing non-added render plugin");for(let t=0;t<this.slots.length;++t)this.slots[t]=this.slots[t].filter((t=>t!==e));e.uninitializeRenderContext(),this.pluginContext.requestRender()}prepareRender(e){for(const t of this.renderPlugins)t.prepareRender&&t.prepareRender(e)}render(e,t){t.slot=e;const i=this.slots[e];let r=!1;for(const e of i)e.canRender&&e.render(t)&&(r=!0);return r}queryDepthRange(e){const t=VL;t.near=1/0,t.far=-1/0;for(const i of this.renderPlugins)if(i.queryDepthRange){const r=i.queryDepthRange(e);r&&FE(t,r,t)}return t}get needsHighlight(){return this.renderPlugins.some((e=>e.needsHighlight))}get needsLinearDepth(){return this.renderPlugins.some((e=>e.needsLinearDepth))}get needsLaserlineWithContrastControl(){const e=this.slots[17];return!!e&&e.length>0}get renderOccludedFlags(){let e=0;return this.renderPlugins.forEach((t=>{t.renderOccludedFlags&&(e|=t.renderOccludedFlags)})),e}}const VL={near:0,far:0};class zL{constructor(){this.camera=new rh,this.lightMat=jr()}}class UL{constructor(e,t){this.rctx=e,this.viewingMode=t,this._enabled=!1,this.textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.emptyTexture=Ql(this.rctx),this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(let e=0;e<4;++e)this.cascades.push(new zL)}dispose(){this.emptyTexture.dispose(),this.emptyTexture=null,this.discardDepthTexture()}set maxCascades(e){this.maxNumCascades=Re(Math.floor(e),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(e){this._enabled=e,e||this.discardDepthTexture()}get enabled(){return this._enabled}getDepthTexture(){return this.depthTexture}getCascades(){for(let e=0;e<this.numCascades;++e)JL[e]=this.cascades[e];return JL.length=this.numCascades,JL}prepare(e,t,i){Vl(this.enabled),this.textureSize=this.computeTextureSize(e.fullWidth,e.fullHeight),this.assertDepthTexture(),wi(jL,e.projectionMatrix,e.viewMatrix);let r=i.near,s=i.far;r<2&&(r=2),s<2&&(s=2),r>=s&&(r=2,s=4),this.numCascades=Math.min(1+Math.floor(zl(s/r,4)),this.maxNumCascades);const a=(s-r)/this.numCascades,n=Math.pow(s/r,1/this.numCascades);let o=r,l=r;for(let e=0;e<this.numCascades+1;++e)this.cascadeDistances[e]=De(o,l,this.splitSchemeLambda),o*=n,l+=a;xi(GL,jL);const c=1===this.viewingMode?e.eye:Ye(KL,0,0,1);bi(XL,[0,0,0],[-t[0],-t[1],-t[2]],c);const h=e.viewMatrix,d=e.projectionMatrix;for(let e=0;e<this.numCascades;++e){const i=this.cascades[e],a=-this.cascadeDistances[e],n=-this.cascadeDistances[e+1],o=(d[10]*a+d[14])/Math.abs(d[11]*a+d[15]),l=(d[10]*n+d[14])/Math.abs(d[11]*n+d[15]);Vl(o<l);for(let e=0;e<8;++e){bs(BL,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?o:l,1),ws(NL[e],BL,GL);for(let t=0;t<3;++t)NL[e][t]/=NL[e][3]}rt(KL,NL[0]),Mi(kL,XL,KL),i.camera.viewMatrix=kL;for(let e=0;e<8;++e)it(NL[e],NL[e],i.camera.viewMatrix);Xe(qL,NL[0]),Xe(HL,NL[0]);for(let e=1;e<8;++e)for(let t=0;t<3;++t)qL[t]=Math.min(qL[t],NL[e][t]),HL[t]=Math.max(HL[t],NL[e][t]);if(qL[2]-=200,HL[2]+=200,i.camera.near=-HL[2],i.camera.far=-qL[2],this.warp){r=1/NL[0][3],s=1/NL[4][3],Vl(r<s);let e=r+Math.sqrt(r*s);const a=Math.sin(Ie(h[2]*t[0]+h[6]*t[1]+h[10]*t[2]));e/=a,uF(NL,e,a,WL,ZL,QL,YL,$L),yF(WL,ZL,YL,$L,i.camera.projectionMatrix),i.camera.projectionMatrix[10]=2/(qL[2]-HL[2]),i.camera.projectionMatrix[14]=-(qL[2]+HL[2])/(qL[2]-HL[2])}else Ai(i.camera.projectionMatrix,qL[0],HL[0],qL[1],HL[1],i.camera.near,i.camera.far);wi(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const c=this.textureSize/2;i.camera.viewport[0]=e%2==0?0:c,i.camera.viewport[1]=0===Math.floor(e/2)?0:c,i.camera.viewport[2]=c,i.camera.viewport[3]=c}this.lastOrigin=null;const u=this.rctx;u.bindFramebuffer(this.fbo),u.bindTexture(null,7),u.setClearColor(1,1,1,1),u.clearSafe(16640)}finish(e){Vl(this.enabled),this.rctx.bindFramebuffer(e)}bind(e,t){const i=this.rctx;i.bindTexture(this.enabled?this.depthTexture:this.emptyTexture,t),i.bindProgram(e),e.setUniform1i("depthTex",t),e.setUniform1f("depthHalfPixelSz",this.enabled?.5/this.textureSize:-1),e.setUniform1i("shadowMapNum",this.numCascades),e.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.numCascades>1?this.cascadeDistances[1]:1/0,this.numCascades>2?this.cascadeDistances[2]:1/0,this.numCascades>3?this.cascadeDistances[3]:1/0)}bindToAllPrograms(e){const t=e.getProgramsUsingUniform("shadowMapDistance");for(let e=0;e<t.length;e++)this.bind(t[e],hh.SHADOW_MAP)}bindView(e,t){if(!this.enabled)return;const i=this.lastOrigin;if(!(i&&i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2])){this.lastOrigin=this.lastOrigin||je(),Xe(this.lastOrigin,t);for(let e=0;e<this.numCascades;++e){Mi(eF,this.cascades[e].lightMat,t);for(let t=0;t<16;++t)tF[16*e+t]=eF[t]}}e.setUniformMatrix4fv("shadowMapMatrix",tF)}computeTextureSize(e,t){const i=.5*Math.log(e*e+t*t)*Math.LOG2E,r=2**Math.round(i+.35);return Math.min(this.maxTextureSize,2*r)}assertDepthTexture(){if(null!=this.depthTexture&&this.depthTexture.descriptor.width===this.textureSize)return;this.discardDepthTexture();const e={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize};this.depthTexture=new Po(this.rctx,e),this.fbo=new Do(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this.depthTexture)}discardDepthTexture(){this.fbo&&(this.fbo.dispose(),this.fbo=null),this.depthTexture&&(this.depthTexture.dispose(),this.depthTexture=null)}getGpuMemoryUsage(){return rc(this.fbo)}get test(){const e=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,set splitSchemeLambda(t){e.splitSchemeLambda=t},get splitSchemeLambda(){return e.splitSchemeLambda},set warp(t){e.warp=t},get warp(){return e.warp}}}}const kL=jr(),jL=jr(),GL=jr(),BL=Tr(),NL=[];for(let e=0;e<8;++e)NL.push(Tr());const qL=je(),HL=je(),WL=cn(),ZL=cn(),QL=cn(),YL=cn(),$L=cn(),XL=jr(),KL=je(),JL=[],eF=jr(),tF=new Float32Array(64),iF=cn(),rF=cn(),sF=[cn(),cn(),cn(),cn()],aF=cn(),nF=cn(),oF=cn(),lF=cn(),cF=cn(),hF=cn(),dF=cn();function uF(e,t,i,r,s,a,n,o){ls(iF,0,0);for(let t=0;t<4;++t)fs(iF,iF,e[t]);ds(iF,iF,.25),ls(rF,0,0);for(let t=4;t<8;++t)fs(rF,rF,e[t]);ds(rF,rF,.25),ys(sF[0],e[4],e[5],.5),ys(sF[1],e[5],e[6],.5),ys(sF[2],e[6],e[7],.5),ys(sF[3],e[7],e[4],.5);let l=0,c=_s(sF[0],iF);for(let e=1;e<4;++e){const t=_s(sF[e],iF);t<c&&(c=t,l=e)}ms(aF,sF[l],e[l+4]);const h=aF[0];let d,u;aF[0]=-aF[1],aF[1]=h,ms(nF,rF,iF),us(nF,aF)<0&&xs(aF,aF),ys(aF,aF,nF,i),gs(aF,aF),d=u=us(ms(oF,e[0],iF),aF);for(let t=1;t<8;++t){const i=us(ms(oF,e[t],iF),aF);i<d?d=i:i>u&&(u=i)}hs(r,iF),ds(oF,aF,d-t),fs(r,r,oF);let p=-1,m=1,f=0,g=0;for(let t=0;t<8;++t){ms(lF,e[t],r),gs(lF,lF);const i=aF[0]*lF[1]-aF[1]*lF[0];i>0?i>p&&(p=i,f=t):i<m&&(m=i,g=t)}kl(p>0,"leftArea"),kl(m<0,"rightArea"),ds(cF,aF,d),fs(cF,cF,iF),ds(hF,aF,u),fs(hF,hF,iF),dF[0]=-aF[1],dF[1]=aF[0];const v=jl(r,e[g],hF,fs(oF,hF,dF),1,s),y=jl(r,e[f],hF,oF,1,a),_=jl(r,e[f],cF,fs(oF,cF,dF),1,n),x=jl(r,e[g],cF,oF,1,o);kl(v,"rayRay"),kl(y,"rayRay"),kl(_,"rayRay"),kl(x,"rayRay")}function pF(e,t){return 3*t+e}const mF=cn();function fF(e,t){return ls(mF,e[t],e[t+3]),mF}const gF=cn(),vF=Br();function yF(e,t,i,r,s){ms(gF,i,r),ds(gF,gF,.5),vF[0]=gF[0],vF[1]=gF[1],vF[2]=0,vF[3]=gF[1],vF[4]=-gF[0],vF[5]=0,vF[6]=gF[0]*gF[0]+gF[1]*gF[1],vF[7]=gF[0]*gF[1]-gF[1]*gF[0],vF[8]=1,vF[pF(0,2)]=-us(fF(vF,0),e),vF[pF(1,2)]=-us(fF(vF,1),e);let a=us(fF(vF,0),i)+vF[pF(0,2)],n=us(fF(vF,1),i)+vF[pF(1,2)],o=us(fF(vF,0),r)+vF[pF(0,2)],l=us(fF(vF,1),r)+vF[pF(1,2)];a=-(a+o)/(n+l),vF[pF(0,0)]+=vF[pF(1,0)]*a,vF[pF(0,1)]+=vF[pF(1,1)]*a,vF[pF(0,2)]+=vF[pF(1,2)]*a,a=1/(us(fF(vF,0),i)+vF[pF(0,2)]),n=1/(us(fF(vF,1),i)+vF[pF(1,2)]),vF[pF(0,0)]*=a,vF[pF(0,1)]*=a,vF[pF(0,2)]*=a,vF[pF(1,0)]*=n,vF[pF(1,1)]*=n,vF[pF(1,2)]*=n,vF[pF(2,0)]=vF[pF(1,0)],vF[pF(2,1)]=vF[pF(1,1)],vF[pF(2,2)]=vF[pF(1,2)],vF[pF(1,2)]+=1,a=us(fF(vF,1),t)+vF[pF(1,2)],n=us(fF(vF,2),t)+vF[pF(2,2)],o=us(fF(vF,1),i)+vF[pF(1,2)],l=us(fF(vF,2),i)+vF[pF(2,2)],a=-.5*(a/n+o/l),vF[pF(1,0)]+=vF[pF(2,0)]*a,vF[pF(1,1)]+=vF[pF(2,1)]*a,vF[pF(1,2)]+=vF[pF(2,2)]*a,a=us(fF(vF,1),t)+vF[pF(1,2)],n=us(fF(vF,2),t)+vF[pF(2,2)],o=-n/a,vF[pF(1,0)]*=o,vF[pF(1,1)]*=o,vF[pF(1,2)]*=o,s[0]=vF[0],s[1]=vF[1],s[2]=0,s[3]=vF[2],s[4]=vF[3],s[5]=vF[4],s[6]=0,s[7]=vF[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=vF[6],s[13]=vF[7],s[14]=0,s[15]=vF[8]}const _F=Wo.create();class xF{constructor(){this._worldPlane=_F}get isEnabled(){return this.plane!==_F}get plane(){return this._worldPlane}set plane(e){this._worldPlane=e||_F}}class bF{constructor(e){this.resourceLoadingPromise=null,this.isEnabled=!1,this.vertexAttributeLocations={vPosition:0},this.vertexBufferLayout=[{name:"vPosition",count:2,type:5126,offset:0,stride:8,normalized:!1}],this.rctx=e}loadResources(e){if(!this.data||!this.textureArea||!this.textureSearch){const t=this.resourceLoadingPromise||this.loadDataModule().then((()=>this.loadTextures()));return e&&t.then(e),this.resourceLoadingPromise||(this.resourceLoadingPromise=t,t.then((()=>this.resourceLoadingPromise=null))),!1}return!0}loadDataModule(){return this.data?k():import("../chunks/SmaaRenderPassData.js").then((e=>{this.data=e}))}loadTextures(){return X([this.loadTextureFromBase64(this.data.areaTexture,9729,6407),this.loadTextureFromBase64(this.data.searchTexure,9728,6409)]).then((([e,t])=>{this.textureArea=e,this.textureSearch=t}))}get isLoadingResources(){return null!=this.resourceLoadingPromise}enable(){if(this.isEnabled)return!0;if(!this.loadResources())return!1;const e=this.rctx;this.programEdgeDetect=new bo(e,this.data.edgeDetectShader.vertex,this.data.edgeDetectShader.fragment,this.vertexAttributeLocations),this.programBlendWeights=new bo(e,this.data.blendWeightShader.vertex,this.data.blendWeightShader.fragment,this.vertexAttributeLocations),this.programBlur=new bo(e,this.data.blurShader.vertex,this.data.blurShader.fragment,this.vertexAttributeLocations),this.pipelineState=wo({colorWrite:To});const t=new Float32Array([-1,-1,3,-1,-1,3]);return this.vao=new Jl(e,this.vertexAttributeLocations,{geometry:this.vertexBufferLayout},{geometry:new ec(e,34962,35044,t)}),this.tmpFramebufferEdges=new Do(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6407,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.tmpFramebufferBlend=new Do(this.rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:4,height:4}),this.isEnabled=!0,!0}disable(){this.isEnabled&&(this.programEdgeDetect.dispose(),this.programEdgeDetect=null,this.programBlendWeights.dispose(),this.programBlendWeights=null,this.programBlur.dispose(),this.programBlur=null,this.vao.dispose(),this.vao=null,this.textureArea.dispose(),this.textureArea=null,this.textureSearch.dispose(),this.textureSearch=null,this.tmpFramebufferBlend.dispose(),this.tmpFramebufferBlend=null,this.tmpFramebufferEdges.dispose(),this.tmpFramebufferEdges=null,this.isEnabled=!1)}render(e){this.enable();const t=this.rctx,i=t.getBoundFramebufferObject(),r={x:0,y:0,width:e.colorTexture.descriptor.width,height:e.colorTexture.descriptor.height};t.bindVAO(this.vao),t.setPipelineState(this.pipelineState),t.setViewport(r.x,r.y,r.width,r.height),this.tmpFramebufferEdges.resize(r.width,r.height),t.bindFramebuffer(this.tmpFramebufferEdges),t.setClearColor(0,0,0,1),t.clear(16384),t.bindProgram(this.programEdgeDetect),t.bindTexture(e.colorTexture,0),this.programEdgeDetect.setUniform1i("tColor",0),this.programEdgeDetect.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),t.drawArrays(4,0,3),this.tmpFramebufferBlend.resize(r.width,r.height),t.bindFramebuffer(this.tmpFramebufferBlend),t.setClearColor(0,0,1,1),t.clear(16384),t.bindProgram(this.programBlendWeights),this.programBlendWeights.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),t.bindTexture(this.textureSearch,1),this.programBlendWeights.setUniform1i("tSearch",1),t.bindTexture(this.textureArea,2),this.programBlendWeights.setUniform1i("tArea",2),t.bindTexture(this.tmpFramebufferEdges.colorTexture,3),this.programBlendWeights.setUniform1i("tEdges",3),t.drawArrays(4,0,3),t.bindFramebuffer(i),t.setClearColor(0,1,0,1),t.clear(16384),t.bindProgram(this.programBlur),this.programBlur.setUniform4f("uResolution",1/r.width,1/r.height,r.width,r.height),t.bindTexture(e.colorTexture,0),this.programBlur.setUniform1i("tColor",0),t.bindTexture(this.tmpFramebufferBlend.colorTexture,1),this.programBlur.setUniform1i("tBlendWeights",1),t.drawArrays(4,0,3)}loadTextureFromBase64(e,t,i){const r=new Po(this.rctx,{pixelFormat:i,dataType:5121,wrapMode:33071,samplingMode:t},null);return _n(e).then((e=>(r.resize(e.width,e.height),r.setData(e),r)))}}var wF=Object.freeze({__proto__:null,build:function(e){const t=new xn;return t.include(Rh),1===e.output&&(t.include(Mh),t.fragment.code.add(bn`
      #ifndef RADIUS
        #define RADIUS `+e.radius+"\n      #endif\n    "),t.fragment.uniforms.add("normalMap","sampler2D").add("depthMap","sampler2D").add("tex","sampler2D").add("blurSize","vec2").add("g_BlurFalloff","float").add("projScale","float").add("nearFar","vec2").add("zScale","vec2"),t.fragment.code.add(bn`
      float blurFunction(vec2 uv, float r, float center_d, inout float w_total, float sharpness) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r*r*g_BlurFalloff - ddiff*ddiff*sharpness);

        w_total += w;

        return w*c;
      }

      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/(center_d*zScale.x+zScale.y);
        for (int r = -RADIUS; r <= RADIUS; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf*blurSize;
          b += blurFunction(uvOffset, rf, center_d, w_total, sharpness);
        }

        gl_FragColor = vec4(b/w_total);
      }
    `)),0===e.output&&(t.include(Mh),t.include(Oh),t.fragment.uniforms.add("projMatrixInv","mat4").add("normalMap","sampler2D").add("depthMap","sampler2D").add("intensity","float").add("projScale","float").add("radius","float").add("nearFar","vec2").add("screenDimensions","vec2").add("rnmScale","vec2").add("rnm","sampler2D"),t.fragment.code.add(bn`
      #ifndef SAMPLES
        #define SAMPLES `+e.samples+"\n      #endif\n      uniform vec3 pSphere[SAMPLES]; //tap position\n    "),t.fragment.code.add(bn`
      float fallOffFunction(float vv, float vn, float bias) {
        float radius2 = radius * radius;

        // A: From the HPG12 paper
        // Note large epsilon to avoid overdarkening within cracks
        // return float(vv < radius2) * max((vn - bias) / (epsilon + vv), 0.0) * radius2 * 0.6;

        // B: Smoother transition to zero (lowers contrast, smoothing out corners). [Recommended]
        float f = max(radius2 - vv, 0.0); return f * f * f * max(vn-bias, 0.0);

        // C: Medium contrast (which looks better at high radii), no division.  Note that the
        // contribution still falls off with radius^2, but we've adjusted the rate in a way that is
        // more computationally efficient and happens to be aesthetically pleasing.
        // return 4.0 * max(1.0 - vv * invRadius2, 0.0) * max(vn - bias, 0.0);

        // D: Low contrast, no division operation
        // return 2.0 * float(vv < radius * radius) * max(vn - bias, 0.0);
      }
    `),t.fragment.code.add(bn`
      float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
        vec3 v = Q - C;
        float vv = dot(v, v);
        float vn = dot(normalize(v), n_C);
        return fallOffFunction(vv, vn, 0.1);
      }
    `),t.fragment.code.add(bn`
      void main(void) {
        //Hash function used in the HPG12 AlchemyAO paper
        //Not supported in WebGL -> using texture lookup as in old SSAO shader instead
        //ivec2 ssC = ivec2(gl_FragCoord.xy);
        //float randomPatternRotationAngle = float((3 * ssC.x ^ ssC.y + ssC.x * ssC.y) * 10);
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));

        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;

        vec4 occluderFragment;
        vec3 ray;

        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0*currentPixelPos.z*zScale.x+zScale.y);

        for(int i = 0; i < SAMPLES; ++i) {
          // get a vector (randomized inside of a sphere with radius 1.0) from a texture and reflect it
          //float ssR;
          //vec2 unitOffset = tapLocation(i, randomPatternRotationAngle, ssR);
          // get the depth of the occluder fragment
          //vec2 offset = vec2(-unitOffset*radius*ssR*ps);

          vec2 unitOffset = reflect(pSphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset*radius*ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenDimensions.x || tc.y > screenDimensions.y) continue;
          vec2 tcTap = tc/screenDimensions;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result

        float A = max(1.0-sum*intensity/float(SAMPLES),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther
        // (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;

        //gl_FragColor = vec4(norm/2.0+0.5, 1.0);
        //gl_FragColor = vec4(-currentPixelDepth/1000.0);
        //gl_FragColor = vec4(tapPixelPos.x/100.0);
        gl_FragColor = vec4(A);
      }
    `)),t}});class CF extends Tn{initializeProgram(e){const t=CF.shader.get(),i=this.configuration,r=t.build({output:i.output,samples:i.samples,radius:i.radius});return new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),Pn)}initializePipeline(){return wo({colorWrite:To})}}CF.shader=new Rn(wF,(()=>Promise.resolve().then((function(){return wF}))));class SF extends Sn{constructor(){super(...arguments),this.output=0,this.samples=64,this.radius=4}}e([Cn({count:2})],SF.prototype,"output",void 0),e([Cn()],SF.prototype,"samples",void 0),e([Cn()],SF.prototype,"radius",void 0);const TF=d.getLogger("esri.views.3d.webgl-engine.lib.SSAOHelper");class PF{constructor(e,t,i){this._enabled=!1,this._BLUR_F=2,this._attenuation=.5,this._radius=3,this._samples=16,this._viewportToRestore=Tr(),this.quadVAO=null,this._rctx=t,this._techniqueRep=e,this._requestRender=i,this._ssaoTechniqueConfig=new SF,this._emptyTexture=Zl(t,[1,1,1,1])}dispose(){this._emptyTexture.dispose(),this._emptyTexture=null,h(this.quadVAO)&&(this.quadVAO=y(this.quadVAO))}get isSupported(){const e=this._rctx,t=-1!==e.parameters.versionString.indexOf("WebGL 0.93"),i=-1!==e.parameters.versionString.indexOf("WebGL 0.94");return!(t||i)}set enabled(e){e?this.enable():this.disable()}get enabled(){return this._enabled}set attenuation(e){this._attenuation=e}get attenuation(){return this._attenuation}set radius(e){this._radius=e}get radius(){return this._radius}get filterRadius(){return 4}set samples(e){this._samples=e,this._enabled&&this.selectPrograms()}get samples(){return this._samples}computeSSAO(e,t,i){if(!this._noiseTexture)return;Vl(this.enabled);const r=this._rctx,s=e.fullViewport,a=s[2],n=s[3],o=a/this._BLUR_F,l=n/this._BLUR_F;this._ssaoFBO.resize(a,n),this._blur0FBO.resize(o,l),this._blur1FBO.resize(o,l);const c=1*a,d=1*n;r.bindFramebuffer(this._ssaoFBO),Ts(this._viewportToRestore,e.fullViewport),r.setViewport(0,0,a,n);const u=this._ssaoTechnique.program,p=this._blurTechnique.program;r.bindProgram(u),r.setPipelineState(this._ssaoTechnique.pipeline),u.setUniform2f("rnmScale",a/this._noiseTexture.descriptor.width,n/this._noiseTexture.descriptor.height),u.setUniform3fv("pSphere",this._samples<=8?this._data.random8:this._samples<=16?this._data.random16:this._samples<=32?this._data.random32:this._data.random64);const m=this._data.minDiscrepancy,f=this._samples<m.length?m[this._samples]:5779;u.setUniform1f("numSpiralTurns",f);const g=MF,v=RF;Gl(e.projectionMatrix,e.fullWidth,e.fullHeight,g,v),u.setUniform4fv("projInfo",g),u.setUniform2fv("zScale",v),u.setUniform2f("nearFar",e.near,e.far);let y=1/e.computeRenderPixelSizeAtDist(1);u.setUniform1f("projScale",1*y),u.setUniform2f("screenDimensions",c,d);let _=2*this._radius;const x=Ke(e.eye,e.center);_=20*e.computeRenderPixelSizeAtDist(x),_=Math.max(.1,_),u.setUniform1f("radius",_),u.setUniform1f("intensity",4*this._attenuation/Math.pow(_,6)),u.setUniform1i("rnm",0),u.setUniform1i("normalMap",1),u.setUniform1i("depthMap",2),r.bindTexture(this._noiseTexture,0),r.bindTexture(i,1),r.bindTexture(t,2),h(this.quadVAO)||(this.quadVAO=Nl(this._rctx));const b=this.quadVAO;r.bindVAO(b),r.drawArrays(5,0,Kl(b,"geometry"));r.bindTexture(this._ssaoFBO.colorTexture,0),r.setViewport(0,0,c/this._BLUR_F,d/this._BLUR_F),r.bindFramebuffer(this._blur0FBO),r.bindProgram(p),p.setUniform2f("screenDimensions",c,d),p.setUniform1i("tex",0),p.setUniform1i("normalMap",1),p.setUniform1i("depthMap",2),p.setUniform2f("blurSize",0,1*this._BLUR_F/d),p.setUniform1i("radius",4),p.setUniform1f("g_BlurFalloff",.08),p.setUniform2f("nearFar",e.near,e.far),x>5e4&&(y=Math.max(0,y-(x-5e4))),p.setUniform1f("projScale",y),p.setUniform2f("zScale",1,0),r.drawArrays(5,0,Kl(b,"geometry")),p.setUniform2f("blurSize",1*this._BLUR_F/c,0),r.bindFramebuffer(this._blur1FBO),r.bindTexture(this._blur0FBO.colorTexture,0),r.drawArrays(5,0,Kl(b,"geometry")),r.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}setUniforms(e,t){const i=this.enabled&&this._noiseTexture,r=this._rctx;r.bindTexture(i?this._blur1FBO.colorTexture:this._emptyTexture,t),r.setActiveTexture(0),e.setUniform1i("ssaoTex",t),i?e.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height):e.setUniform4f("viewportPixelSz",-1,-1,-1,-1)}bindToAllPrograms(e){const t=e.getProgramsUsingUniform("viewportPixelSz");for(let e=0;e<t.length;e++)this.setUniforms(t[e],hh.SSAO)}selectPrograms(){const e=this._samples<=8?8:this._samples<=16?16:this._samples<=32?32:64;this._ssaoTechniqueConfig.samples=e,this._ssaoTechniqueConfig.radius=4,this._ssaoTechniqueConfig.output=0,this._ssaoTechnique=this._techniqueRep.acquireAndReleaseExisting(CF,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=1,this._blurTechnique=this._techniqueRep.acquireAndReleaseExisting(CF,this._ssaoTechniqueConfig,this._blurTechnique)}enable(){this.enabled||(this.isSupported?(this._enabled=!0,this.loadResources((()=>{this._enabled&&this.initialize()}))):TF.warn("SSAO is not supported for this browser or hardware"))}loadResources(e){this._data?e():import("../chunks/SSAOHelperData.js").then((t=>{this._data=t,e()}))}initialize(){const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},t={colorTarget:0,depthStencilTarget:0};this._ssaoFBO=new Do(this._rctx,t,e),this._blur0FBO=new Do(this._rctx,t,e),this._blur1FBO=new Do(this._rctx,t,e),_n(this._data.noiseTexture).then((e=>{this._enabled&&(this._noiseTexture=new Po(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:e.width,height:e.height},e),this._requestRender())})),this.selectPrograms()}disable(){this.enabled&&(this._enabled=!1,this._noiseTexture&&(this._noiseTexture.dispose(),this._noiseTexture=null),this._blur1FBO&&(this._blur1FBO.dispose(),this._blur1FBO=null),this._blur0FBO&&(this._blur0FBO.dispose(),this._blur0FBO=null),this._ssaoFBO&&(this._ssaoFBO.dispose(),this._ssaoFBO=null))}getGpuMemoryUsage(){return rc(this._blur0FBO)+rc(this._blur1FBO)+rc(this._ssaoFBO)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const RF=cn(),MF=Tr();class OF{constructor(e){this.factory=e,this.originData=new Map}acquire(e){return this.register(this.factory.getOrigin(e))}register(e){const t=this.originData.get(e.id);return t?(t.refCount++,t.origin):(this.originData.set(e.id,{refCount:1,viewMatrix:jr(),origin:e}),e)}release(e){const t=this.originData.get(e.id);t&&(t.refCount--,0===t.refCount&&this.originData.delete(e.id))}updateViewMatrices(e){this.originData.forEach((t=>{_i(t.viewMatrix,e),function(e,t){const i=t,r=e[0],s=e[1],a=e[2];i[12]+=r*i[0]+s*i[4]+a*i[8],i[13]+=r*i[1]+s*i[5]+a*i[9],i[14]+=r*i[2]+s*i[6]+a*i[10],i[14]+=r*i[3]+s*i[7]+a*i[11]}(t.origin.vec3,t.viewMatrix)}))}getViewMatrix(e){return this.originData.get(e.id).viewMatrix}}function DF(e){const t=bn`
    bool isNaN( float val )
    {
      return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
      // important: some nVidias failed to cope with version below.
      // Probably wrong optimization.
      /*return ( val <= 0.0 || 0.0 <= val ) ? false : true;*/
    }
  `;e.code.add(t)}function AF(e,t){e.vertex.include(DF),e.include(qh,t);const i=e.vertex;i.uniforms.add("uDepthBias","vec2"),i.uniforms.add("uViewportDimInv","vec2"),t.legacy?(i.uniforms.add("uView","mat4"),i.uniforms.add("uProj","mat4")):i.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),t.legacy?i.code.add(bn`
      vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
        float offsetXY = uDepthBias.x;
        float offsetZ  = uDepthBias.y;

        // screen space pixel offset
        // we multiply by two to account for the fact that NDC go from -1 to 1
        // we multiply by projPos.w to compensate for the perspective division that happens later
        // normalizing over xyz means that the xy influence is reduced the more the normal is pointing
        // towards the camera
        vec4 projNormal = uProj * uView * vec4(globalNormal, 0.0);

        return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
      }
    `):i.code.add(bn`
      vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
        float offsetXY = uDepthBias.x;
        float offsetZ  = uDepthBias.y;

        // screen space pixel offset
        // we multiply by two to account for the fact that NDC go from -1 to 1
        // we multiply by projPos.w to compensate for the perspective division that happens later
        // normalizing over xyz means that the xy influence is reduced the more the normal is pointing
        // towards the camera
        vec4 projNormal = uTransform_ProjFromView * vec4(uTransformNormal_ViewFromGlobal * globalNormal, 0.0);

        return offsetXY * projPos.w * 2.0 * uViewportDimInv * normalize(projNormal.xyz).xy;
      }
    `),i.code.add(bn`
    // A z-offset, using a depth based heuristic.
    float _calculateProjectedBiasZ(vec4 projPos) {
      float offsetZ = uDepthBias.y;
      return sqrt(projPos.z) * offsetZ;
    }

    vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
      vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);

      // we currently have to do this check because some geometries come with 0 length edge normals.
      // see https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/12890
      if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
        projPos.xy += offsetXY;
      }

      projPos.z += _calculateProjectedBiasZ(projPos);

      return projPos;
    }
  `)}function EF(e,t){const i=e.fragment;i.defines.addFloat("COVERAGE_TEST_THRESHOLD",.01),t.antialiasing?i.code.add(bn`
      #define discardByCoverage(radius, coverage) { if (coverage < COVERAGE_TEST_THRESHOLD) discard; }
    `):i.code.add(bn`
      #define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? COVERAGE_TEST_THRESHOLD : 0.75; if (coverage < coverageLimit) discard; }
    `)}function IF(e,t){const i=e.vertex;t.silhouette?(i.code.add(bn`
      bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
        float faceAVisible = dot(viewDir, normalA);
        float faceBVisible = dot(viewDir, normalB);
        return faceAVisible * faceBVisible < 0.0;
      }
    `),t.legacy?i.code.add(bn`
        bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
          vec3 viewNormalA = _modelToViewNormal(normalA);
          vec3 viewNormalB = _modelToViewNormal(normalB);
          vec3 viewDir = -viewPos;

          if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
            return false;
          }

          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return true;
        }
      `):i.code.add(bn`
        bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
          vec3 worldNormalA = _modelToWorldNormal(normalA);
          vec3 worldNormalB = _modelToWorldNormal(normalB);
          vec3 viewDir = -worldPos;

          if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
            return false;
          }

          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return true;
        }
      `)):i.code.add(bn`
      bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
        return false;
      }
    `)}function LF(e,t){const i=e.vertex;switch(t.mode){case 1:i.code.add(bn`
        #define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}
      `);break;case 2:i.code.add(bn`
        #define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}
      `);break;case 0:i.code.add(bn`
        #define discardShortEdges(unpackedAttributes, lineLengthPixels) {}
      `)}}function FF(e,t){const i=e.vertex;i.uniforms.add("uDistanceFalloffFactor","float"),i.code.add(bn`
    float distanceBasedPerspectiveFactor(float distance) {
      return clamp(sqrt(uDistanceFalloffFactor / distance), 0.0, 1.0);
    }
  `),i.uniforms.add("uComponentDataTex","sampler2D"),i.uniforms.add("uComponentDataTexInvDim","vec2"),e.attributes.add("componentIndex","float"),i.defines.addFloat("COMPONENT_COLOR_FIELD_OFFSET",0),i.defines.addFloat("COMPONENT_OTHER_FIELDS_OFFSET",1),i.defines.addFloat("COMPONENT_FIELD_COUNT",2),i.defines.addFloat("LINE_WIDTH_FRACTION_FACTOR",8),i.defines.addFloat("EXTENSION_LENGTH_OFFSET",128),i.defines.addFloat("COMPONENT_TEX_WIDTH",4096),i.code.add(bn`
    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
      float fieldIndex = COMPONENT_FIELD_COUNT * componentIndex + fieldOffset;

      float rowIndex = floor(fieldIndex / COMPONENT_TEX_WIDTH);
      float colIndex = mod(fieldIndex, COMPONENT_TEX_WIDTH);

      vec2 linearIndex = vec2(
        (colIndex + 0.5) / COMPONENT_TEX_WIDTH,
        (rowIndex + 0.5) * uComponentDataTexInvDim.y
      );

      return linearIndex;
    }

    struct ComponentData {
      vec4 color;
      float lineWidth;
      float extensionLength;
      float type;
    };

    ComponentData readComponentData() {
      vec2 colorIndex = _componentTextureCoords(componentIndex, COMPONENT_COLOR_FIELD_OFFSET);
      vec2 otherIndex = _componentTextureCoords(componentIndex, COMPONENT_OTHER_FIELDS_OFFSET);

      vec4 colorValue = texture2D(uComponentDataTex, colorIndex);
      vec4 otherValue = texture2D(uComponentDataTex, otherIndex);

      return ComponentData(
        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity
        otherValue.x * (255.0 / LINE_WIDTH_FRACTION_FACTOR),
        otherValue.y * 255.0 - EXTENSION_LENGTH_OFFSET,
        -(otherValue.z * 255.0) + 0.5 // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;
      );
    }
  `),t.legacy?i.code.add(bn`
      vec3 _modelToWorldNormal(vec3 normal) {
        return (uModel * vec4(normal, 0.0)).xyz;
      }

      vec3 _modelToViewNormal(vec3 normal) {
        return (uView * uModel * vec4(normal, 0.0)).xyz;
      }
    `):(i.uniforms.add("uTransformNormal_GlobalFromModel ","mat3"),i.code.add(bn`
      vec3 _modelToWorldNormal(vec3 normal) {
        return uTransformNormal_GlobalFromModel * normal;
      }
    `)),t.silhouette?(e.attributes.add("normalA","vec3"),e.attributes.add("normalB","vec3"),i.code.add(bn`
      vec3 worldNormal() {
        return _modelToWorldNormal(normalize(normalA + normalB));
      }
    `)):(e.attributes.add("normal","vec3"),i.code.add(bn`
      vec3 worldNormal() {
        return _modelToWorldNormal(normal);
      }
    `)),t.legacy?i.code.add(bn`
      vec3 worldFromModelPosition(vec3 position) {
        return (uModel * vec4(position, 1.0)).xyz;
      }

      vec3 viewFromModelPosition(vec3 position) {
        return (uView * vec4(worldFromModelPosition(position), 1.0)).xyz;
      }

      vec4 projFromViewPosition(vec3 position) {
        return uProj * vec4(position, 1.0);
      }
    `):(e.vertex.include(Xh,t),i.code.add(bn`
      vec3 worldFromModelPosition(vec3 position) {
        vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * position;

        vec3 transform_CameraRelativeFromModel = dpAdd(
          uTransform_WorldFromModel_TL,
          uTransform_WorldFromModel_TH,
          -uTransform_WorldFromView_TL,
          -uTransform_WorldFromView_TH
        );

        return transform_CameraRelativeFromModel + rotatedModelPosition;
      }

      vec3 viewFromModelPosition(vec3 position) {
        return uTransform_ViewFromCameraRelative_RS * worldFromModelPosition(position);
      }

      vec4 projFromViewPosition(vec3 position) {
        return uTransform_ProjFromView * vec4(position, 1.0);
      }
    `)),i.code.add(bn`
    float calculateExtensionLength(float extensionLength, float lineLength) {
      return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
    }
  `)}function VF(e,t){const i=e.vertex;switch(e.include(FF,t),e.attributes.add("sideness","vec2"),2===t.mode?i.code.add(bn`
      struct UnpackedAttributes {
        vec2 sideness;
        vec2 sidenessNorm;
        float lineWidthPixels;
        float extensionLengthPixels;
        float type;
      };
    `):i.code.add(bn`
      struct UnpackedAttributes {
        vec2 sideness;
        vec2 sidenessNorm;
        float lineWidthPixels;
        float extensionLengthPixels;
      };
  `),t.mode){case 2:i.code.add(bn`
        UnpackedAttributes unpackAttributes(ComponentData component) {
          vec2 sidenessNorm = sideness;
          vec2 sideness = sidenessNorm * 2.0 - 1.0;
          float fType = component.type;
          float extensionLengthPixels = component.extensionLength;
          float lineWidth = component.lineWidth;

          if (fType <= 0.0) {
            extensionLengthPixels *= variantExtension * 2.0 - 1.0;
          }

          return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
        }
      `);break;case 1:i.code.add(bn`
        UnpackedAttributes unpackAttributes(ComponentData component) {
          vec2 sidenessNorm = sideness;
          vec2 sideness = sidenessNorm * 2.0 - 1.0;
          float extensionLengthPixels = component.extensionLength;
          extensionLengthPixels *= variantExtension * 2.0 - 1.0;
          float lineWidth = component.lineWidth;

          return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
        }
      `);break;case 0:i.code.add(bn`
        UnpackedAttributes unpackAttributes(ComponentData component) {
          vec2 sidenessNorm = sideness;
          vec2 sideness = sidenessNorm * 2.0 - 1.0;
          float extensionLengthPixels = component.extensionLength;
          float lineWidth = component.lineWidth;

          return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
        }
      `)}}function zF(e,t){const i=e.vertex;switch(e.include(VF,t),FF.usesSketchLogic(t)&&i.uniforms.add("uStrokesAmplitude","float"),t.mode){case 0:i.code.add(bn`
        float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
          return 0.0;
        }
      `);break;case 1:i.code.add(bn`
        float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
          return uStrokesAmplitude;
        }
      `);break;case 2:i.code.add(bn`
        float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
          float type = unpackedAttributes.type;

          if (type <= 0.0) {
            return uStrokesAmplitude;
          }
          else {
            return 0.0;
          }
        }
      `)}}function UF(e,t){const i=e.vertex;e.include(VF,t);const r=e.fragment;switch(FF.usesSketchLogic(t)&&(i.uniforms.add("uStrokesTextureScale","vec2"),i.uniforms.add("uStrokesLog2Resolution","float"),i.uniforms.add("uStrokeVariants","float"),e.varyings.add("vStrokeUV","vec2"),r.uniforms.add("uStrokesTexture","sampler2D"),r.uniforms.add("uStrokesNormalizationScale","float"),i.code.add(bn`
      void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
        vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

        float lineIndex = clamp(ceil(log2(lineLength)), 0.0, uStrokesLog2Resolution);

        vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * uStrokeVariants + variantStroke + 0.5) * uStrokesTextureScale;
        vStrokeUV.x += variantOffset;
      }
    `),e.fragment.include(yo),r.code.add(bn`
      float calculateLineOffsetSketch() {
        float offsetNorm = rgba2float(texture2D(uStrokesTexture, vStrokeUV));
        return (offsetNorm - 0.5) * uStrokesNormalizationScale;
      }

      float calculateLinePressureSketch() {
        return rgba2float(texture2D(uStrokesTexture, vStrokeUV + vec2(0.0, 0.5)));
      }
    `)),t.mode){case 0:i.code.add(bn`
        void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}
      `),r.code.add(bn`
        float calculateLineOffset() {
          return 0.0;
        }

        float calculateLinePressure() {
          return 1.0;
        }
      `);break;case 1:i.code.add(bn`
        void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
        {
          calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
        }
      `),r.code.add(bn`
        float calculateLineOffset() {
          return calculateLineOffsetSketch();
        }

        float calculateLinePressure() {
          return calculateLinePressureSketch();
        }
      `);break;case 2:e.varyings.add("vType","float"),i.code.add(bn`
        void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
        {
          vType = unpackedAttributes.type;

          if (unpackedAttributes.type <= 0.0) {
            calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
          }
        }
      `),r.code.add(bn`
        float calculateLineOffset() {
          if (vType <= 0.0) {
            return calculateLineOffsetSketch();
          }
          else {
            return 0.0;
          }
        }

        float calculateLinePressure() {
          if (vType <= 0.0) {
            return calculateLinePressureSketch();
          }
          else {
            return 1.0;
          }
        }
      `)}}!function(e){e.usesSketchLogic=function(e){return 1===e.mode||2===e.mode},e.usesSolidLogic=function(e){return 0===e.mode||2===e.mode}}(FF||(FF={}));var kF=Object.freeze({__proto__:null,attributeLocations:{position0:0,position1:1,componentIndex:2,packedAttributes:3,variantOffset:4,variantStroke:5,variantExtension:6,normal:7,normalA:7,normalB:8,sideness:9},build:function(e){const t=new xn,i=t.vertex,r=t.fragment;return e.legacy&&i.uniforms.add("uModel","mat4"),e.antialiasing&&(i.code.add(bn`
      #define ANTIALIASING 1
    `),r.code.add(bn`
      #define ANTIALIASING 1
    `)),t.include(AF,e),t.include(zF,e),t.include(FF,e),t.include(VF,e),t.include(UF,e),t.include(In,e),t.include(IF,e),t.include(EF,e),t.include(LF,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add("uPixelToNDC","vec2"),i.uniforms.add("uNDCToPixel","vec2"),i.uniforms.add("uPixelRatio","float"),t.attributes.add("position0","vec3"),t.attributes.add("position1","vec3"),t.attributes.add("variantOffset","float"),t.attributes.add("variantStroke","float"),t.attributes.add("variantExtension","float"),i.code.add(bn`
    const float opaqueCutoff = 1.0 / 255.0;

    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
      vec2 sideness = unpackedAttributes.sideness;
      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;

      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);

      vec4 projPosV0 = projFromViewPosition(viewPosV0);
      vec4 projPosV1 = projFromViewPosition(viewPosV1);
      vec4 projPos = projFromViewPosition(viewPos);

      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * uNDCToPixel;
      float lineLengthPixels = length(screenSpaceLinePixels);

      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;

      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * uPixelRatio;
      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;

      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * uPixelRatio;

      vSizeFalloffFactor = falloffFactor;

      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;

    #ifdef ANTIALIASING
      const float aaPaddingPixels = 1.0;

      // Line size with padding
      float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
      float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
    #else /* ANTIALIASING */

      // Even if there is no AA, we still want to do proper <1px rendering,
      // so we effectively clamp the pixel sizes to minimum of 1px and compute
      // coverage in the fragment shader
      float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
      float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
    #endif /* ANTIALIASING */

      // Half line width in NDC including padding for anti aliasing
      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * uPixelToNDC;
      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * uPixelToNDC;
      vec2 extensionLengthNDC = extensionLengthPixels * uPixelToNDC;

      // Compute screen space position of vertex, offsetting for line size and end caps
      vec2 ndcOffset = (
          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
      );

      projPos.xy += ndcOffset * projPos.w;
      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;

      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));

      // Line length with end caps
      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;

      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;

      // Position in pixels with origin at first vertex of line segment
      vPosition = vec3(
        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
        pixelPositionAlongLine,
        pixelPositionAlongLine / extendedLineLengthPixels
      );

      // The line width radius in pixels
      vRadius = lineWidthPixels * 0.5;
      vLineLengthPixels = extendedLineLengthPixels;

      // discard edges below a certain length threshold
      discardShortEdges(unpackedAttributes, lineLengthPixels);

      gl_Position = projPos;
    }

    void main() {
      ComponentData component = readComponentData();
      UnpackedAttributes unpackedAttributes = unpackAttributes(component);

      vec3 worldPosV0 = worldFromModelPosition(position0);
      vec3 worldPosV1 = worldFromModelPosition(position1);
      vec3 viewPosV0 = viewFromModelPosition(position0);
      vec3 viewPosV1 = viewFromModelPosition(position1);

      // Component color
      vColor = component.color;

      // Discard fully transparent edges
      if (vColor.a < opaqueCutoff) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
        return;
      }

      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
        return;
      }

      // General geometric computation for all types of edges
      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);

      // Specific computation for different edge styles
      calculateStyleOutputs(unpackedAttributes);
    }
  `),t.fragment.code.add(bn`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),t}});class jF extends Tn{bindPass(e,t){const i=this.program,{edgeRenderParameters:r,bindParameters:s}=t;qh.bindViewProjTransform(i,r.viewProjectionTransform),i.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",r.transformNormal_ViewFromGlobal),i.setUniformMatrix4fv("uProj",s.camera.projectionMatrix),i.setUniform2f("uDepthBias",.5,-4e-4),i.setUniform2f("uPixelToNDC",2/s.camera.fullViewport[2],2/s.camera.fullViewport[3]),i.setUniform2f("uNDCToPixel",s.camera.fullViewport[2]/2,s.camera.fullViewport[3]/2),i.setUniform1f("uDistanceFalloffFactor",r.distanceFalloffFactor),i.setUniform2f("uViewportDimInv",1/s.camera.fullViewport[2],1/s.camera.fullViewport[3]),i.setUniform1f("uPixelRatio",s.camera.pixelRatio||1)}initializeProgram(e){const t=jF.shader.get(),i=this.configuration,r=t.build({slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,silhouette:i.silhouette,legacy:i.legacy,antialiasing:i.antialiasing,mode:i.mode,doublePrecisionRequiresObfuscation:i.doublePrecisionRequiresObfuscation});return new bo(e.rctx,r.generateSource("vertex"),r.generateSource("fragment"),t.attributeLocations)}initializePipeline(e){const t=e.rctx.capabilities.blendMinMax;return wo(t?{blending:Co(1,1,0,1,32774,t.MAX),depthTest:{func:515},colorWrite:To}:{depthTest:{func:515},depthWrite:Ro,colorWrite:To})}}jF.shader=new Rn(kF,(()=>Promise.resolve().then((function(){return kF})))),function(t){class i extends Sn{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.mode=0,this.doublePrecisionRequiresObfuscation=!1}}e([Cn()],i.prototype,"slicePlaneEnabled",void 0),e([Cn()],i.prototype,"sliceHighlightDisabled",void 0),e([Cn()],i.prototype,"silhouette",void 0),e([Cn()],i.prototype,"legacy",void 0),e([Cn()],i.prototype,"antialiasing",void 0),e([Cn({count:3})],i.prototype,"mode",void 0),e([Cn()],i.prototype,"doublePrecisionRequiresObfuscation",void 0),t.Configuration=i}(jF||(jF={}));const GF={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class BF{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const NF={solid:0,sketch:1,uber:2};class qF{constructor(e,t,i){this.rctx=e,this.shaderTechniqueRepository=t,this.config=new jF.Configuration,this.technique=null,this.refCount=new BF,this.renderables=new Set,this.sortedRenderables={1:{1:new R,2:new R},2:{1:new R,2:new R}},this.renderablesDirty=!1,this.settings={...GF,...i},this.key=qF.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const r=this.settings.strokesTexture.variants;this.writerSettings={variants:r},this.config.legacy=this.settings.legacy,this.config.mode=NF[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=$h(e)}dispose(){this.technique&&(this.shaderTechniqueRepository.release(this.technique),this.technique=null)}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e)}bindRegularEdges(e,t){this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(jF,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)}bindSilhouetteEdges(e,t){this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.acquireAndReleaseExisting(jF,this.config,this.technique),this.technique.bindPass(this.rctx,{bindParameters:e,edgeRenderParameters:t}),this.rctx.setPipelineState(this.technique.pipeline),this.rctx.bindProgram(this.technique.program)}renderRegularEdges(e,t,i){this.render(this.technique.program,e,e.regular.vao,t,i)}renderSilhouetteEdges(e,t,i){this.render(this.technique.program,e,e.silhouette.vao,t,i)}render(e,t,i,r,s){this.setUniforms(e,t,r),this.rctx.bindVAO(i),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,s)}setUniforms(e,t,i){if(t.components.buffer.textureBuffer.bind(e,HF),"origin"in t.transform)e.setUniformMatrix4fv("uView",i.localViewMatrixForEdges),e.setUniformMatrix4fv("uModel",t.transform.modelMatrix),In.bindUniforms(e,this.settings,i.slicePlane,t.transform.origin.vec3);else{const r=new zI(t.transform.position),s=Wr(WF,Yr(WF,t.transform.rotationScale)),a=new MI;Xe(a.worldFromModel_TL,r.low),Xe(a.worldFromModel_TH,r.high),Kr(a.worldFromModel_RS,t.transform.rotationScale),Kr(a.transformNormal_GlobalFromModel,s),qh.bindModelTransform(e,a),e.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",a.transformNormal_GlobalFromModel);const n=i.camera.viewInverseTransposeMatrix,o=Ye(ZF,n[3],n[7],n[11]);In.bindUniforms(e,this.settings,i.slicePlane,o)}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(e),e.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(i.camera.fovY/2)/(i.camera.fullViewport[3]/2))}setSketchUniforms(e){const t=this.settings.strokesTexture,i=t.texture;u(i)||(this.rctx.bindTexture(i,0),e.setUniform1i("uStrokesTexture",0),e.setUniform2f("uStrokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",ze(t.resolution)),e.setUniform1f("uStrokesNormalizationScale",t.normalizationScale),e.setUniform1f("uStrokesAmplitude",t.amplitude),e.setUniform1f("uStrokeVariants",t.variants))}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e)}static getKey(e,t,i){return`edges-t:${e}:${t}:${i}`}}const HF={texName:"uComponentDataTex",invDimName:"uComponentDataTexInvDim",unit:2},WF=mn(),ZF=je();class QF extends Us{constructor(e){super("EdgeProcessingWorker","wrappedWork",e)}async process(e,t,i){if(i)return ru(e);const r=this._packInput(e),s=await this.invoke(r,t);return this._unpackOutput(s)}getTransferList(e){return[e.dataBuffer]}_packInput(e){const t={dataBuffer:e.data.buffer,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate};return e.originalIndices&&(t.originalIndicesBuffer=e.originalIndices.buffer,t.originalIndicesType=l(e.originalIndices)?"Uint32Array":"Uint16Array"),t}_unpackOutput(e){return{regular:{instancesData:su(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:su(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}}function YF(e,t){if(!e)return null;const i=e.length/2,r=$F*i,s=new Array(i);let a=0;const n=1===t;for(let t=0;t<e.length;t+=2){const i=(e[t]+e[t+1])/2;s[a++]=n?Math.min(r,1-(1-i)*XF):Math.min(r,i*XF)}return s}const $F=.1,XF=.5;class KF{constructor(e,t,i,r,s){this.resolution=e,this.normalizationScale=t,this.amplitude=i,this.variants=r,this.texture=s}dispose(){this.texture=y(this.texture)}}const JF={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function eV(e){let t=null;for(const i of e){const e=i.type;if(rV(i))if(u(t))t=e;else if(t!==e)return"uber"}return h(t)?t:"solid"}function tV(e){let t=0;for(const{material:i}of e)if(rV(i)){if(i.color[3]*i.opacity<1)return 1;t=2}return t}function iV(e){let t=0;for(const{material:i}of e)if(rV(i)){switch(i.objectTransparency){case 1:case 0:return 1;case 2:if(i.opacity<1)return 1}t=2}return t}function rV(e){return e.size*e.color[3]*e.opacity>0}function sV(e,t,i){return e.length-function(e,t){const i=L(e,t,!0);return-1===i?t<e[0]?0:e.length:i}(e,t*i.minimumEdgeLength)}function aV(e,t,i,r){for(let s=0;s<e.length;s++){const a=e[s].index,n=t[s],o=t[s+1];if(r)for(let e=n;e<o;e++){const t=r[e];i.set(t,a)}else for(let e=n;e<o;e++)i.set(e,a)}}class nV{constructor(e,t,i,r){this.rctx=e,this.techniqueRepository=t,this.callbacks=i,this.profilingCallback=null,this.perObjectData=new Map,this.renderers=new Map,this.localOrigins=new OF(new Lc),this.numberOfRenderedEdges=0,this.gpuMemoryUsage=0,this.workerAbort=z(),this.destroyed=!1,this.tmpModelPosition=je(),this.tmpCameraPosition=je(),this.componentColorManager=new BI(this.rctx,2),this.worker=new QF(r);const s=au.createBuffer(4);for(let e=0;e<4;e++)s.sideness.set(e,0,0===e||3===e?0:1),s.sideness.set(e,1,0===e||1===e?0:1);this.verticesBufferObject=ec.createVertex(this.rctx,35044,s.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach(((e,t)=>{this.perObjectData.delete(t),e.renderables.forEach((e=>{this.removeRenderable(e)}))})),this.strokesTexture=y(this.strokesTexture),this.componentColorManager=p(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=y(this.verticesBufferObject),this.perObjectData.clear(),this.renderers.clear(),this.destroyed=!0)}getUsedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,i,r,s,a,n,o){if(this.hasObject(e))return;let l;const c=new oV(W((e=>l=e)),i);this.perObjectData.set(e,c),await this.addComponentGeometry(t,c,r,s,a,n,o),this.callbacks.setNeedsRender(),l()}async addOrUpdateObject3D(e,t,i,r){const s=new Array;let a;const n=new oV(W((e=>a=e))),o=this.perObjectData.get(e);if(this.perObjectData.set(e,n),i.mergeGeometries&&e.geometries.length>1&&function(e){let t=null,i=null;for(let r=0;r<e.geometries.length;r++){const s=e.geometryRecords[r];if(s.material.supportsEdges){if(t){if(!E(t,s.transformation))return!1}else t=s.transformation;if(!i&&s.origin)i=s;else if(i&&s.origin&&i.origin.id!==s.origin.id)return!1}}return!0}(e))s.push(this.addObjectMergedGeometries(e,n,t,i,r));else for(let a=0;a<e.geometries.length;a++){const o=e.geometries[a],l=e.geometryRecords[a];l.material.supportsEdges&&s.push(this.addGeometryData(e,n,o.data,l,t[0],i,r))}await X(s),o&&o.waitLoaded((()=>{o.renderables.forEach((e=>this.removeRenderable(e))),this.callbacks.setNeedsRender()})),this.callbacks.setNeedsRender(),a()}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=t instanceof Array?e=>t[e]:()=>t;(await this.getObjectEntry(e)).renderables.forEach((e=>{const t=e.components.meta.length;for(let r=0;r<t;r++){const t=i(r),s=e.components.meta[r],a=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(a,1,3,255*t)}this.updateTransparency(e)})),this.callbacks.setNeedsRender()}async updateAllComponentMaterials(e,t,i,r){const s=e instanceof Wc,a=!!i.slicePlaneEnabled,n=eV(t),o=qF.getKey(n,a,s);(await this.getObjectEntry(e)).renderables.forEach((e=>{if(o!==e.rendererKey){const t=this.renderers.get(e.rendererKey),i=this.acquireRenderer(n,a,s);t.removeRenderable(e),t.refCount.decrement(),e.rendererKey=o,i.addRenderable(e)}for(let i=0;i<t.length;i++)e.components.meta[i].material=t[i];r&&this.updateComponentBuffer(e.components),this.updateTransparency(e)})),this.callbacks.setNeedsRender()}async updateObjectVisibility(e,t){(await this.getObjectEntry(e)).renderables.forEach((e=>e.visible=t)),this.callbacks.setNeedsRender()}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),t.waitLoaded((()=>{t.renderables.forEach((e=>this.removeRenderable(e))),this.callbacks.setNeedsRender()})))}async getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw"no object";return await t.loaded,t}removeAll(){this.perObjectData.forEach(((e,t)=>this.removeObject(t)))}render(e,t){if(u(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=je(),s=new zI,a=new qh.ViewProjectionTransform,n=Br();Ye(r,i[3],i[7],i[11]),s.set(r),Xe(a.worldFromView_TH,s.high),Xe(a.worldFromView_TL,s.low),Qr(a.viewFromCameraRelative_RS,e.camera.viewMatrix),_i(a.projFromView,e.camera.projectionMatrix);const o=Br();Wr(o,a.viewFromCameraRelative_RS),Yr(n,o),this.renderers.forEach((e=>{0===e.refCount.value&&(this.renderers.delete(e.key),e.dispose())})),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures();let l=0,c=0;if(this.renderers.forEach((e=>e.forEachRenderable((e=>{l+=e.statistics.averageEdgeLength,c++}),t))),0===c)return;const h={distanceFalloffFactor:40*l/c,minimumEdgeLength:function(e,t,i,r){return i*(r/e)*2*Math.tan(.5*t)}(e.camera.fullViewport[3],e.camera.fovY,1,3.5*e.camera.pixelRatio),transparency:t,viewProjectionTransform:a,transformNormal_ViewFromGlobal:n};this.updateObjectCameraDistances(e),this.numberOfRenderedEdges=0,this.renderers.forEach((t=>{this.renderRegularEdges(t,e,h),this.renderSilhouetteEdges(t,e,h)}))}updateTransparency(e){const t=tV(e.components.meta),i=iV(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this.renderers.get(e.rendererKey).setRenderablesDirty())}computeModelTransformWithLocalOrigin(e,t,i){if(e.getCombinedStaticTransformation(t,i),t.origin)this.localOrigins.register(t.origin);else{const e=Ye(this.tmpModelPosition,i[12],i[13],i[14]);t.origin=this.localOrigins.acquire(e)}return function(e,t){const i=t,r=-e[0],s=-e[1],a=-e[2],n=i[3],o=i[7],l=i[11],c=i[15];i[0]+=n*r,i[1]+=n*s,i[2]+=n*a,i[4]+=o*r,i[5]+=o*s,i[6]+=o*a,i[8]+=l*r,i[9]+=l*s,i[10]+=l*a,i[12]+=c*r,i[13]+=c*s,i[14]+=c*a}(t.origin.vec3,i),i}updateComponentBuffer(e){const{meta:t,buffer:i}=e;for(let e=0;e<t.length;e++){const r=t[e].material,s=t[e].index,a=Re(Math.round(8*r.size),0,255),n=Re(r.extensionLength,-128,127)+128,o="solid"===r.type?0:1,l=255*r.opacity,c=r.color,h=255*c[0],d=255*c[1],u=255*c[2],p=255*c[3];i.textureBuffer.setData(s,0,h,d,u,p),i.textureBuffer.setData(s,1,a,n,o,l)}}createComponentBuffers(e){if(u(this.componentColorManager))return null;const t=new Array,i=this.componentColorManager.getBuffer(e.length);for(let r=0;r<e.length;r++){const s=e[r],a=i.acquireIndex();t.push({index:a,material:s})}const r={meta:t,buffer:i};return this.updateComponentBuffer(r),r}extractEdges(e,t,i,r,s){return this.worker.process({data:t,originalIndices:s,writerSettings:e,skipDeduplicate:i},this.workerAbort.signal,r)}createEdgeResources(e){const t={};if(u(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const i=new Jl(this.rctx,nu,{vertices:ou,instances:lu.glLayout},{vertices:this.verticesBufferObject,instances:ec.createVertex(this.rctx,35044,e.regular.instancesData.buffer)});t.regular={vao:i,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const i=new Jl(this.rctx,nu,{vertices:ou,instances:cu.glLayout},{vertices:this.verticesBufferObject,instances:ec.createVertex(this.rctx,35044,e.silhouette.instancesData.buffer)});t.silhouette={vao:i,lod:e.silhouette.lodInfo}}return t}async addGeometryData(e,t,i,r,s,a,n){const o=i.getAttribute("position"),l=this.computeModelTransformWithLocalOrigin(e,r,jr()),c=r.origin,h={position:o,indices:i.getIndices("position"),modelTransform:l,origin:c};return this.addPositionData(t,h,s,a,n)}async addPositionData(e,t,i,r,s=!1){const a=this.createComponentBuffers([i]);if(u(a))return;const n=this.acquireRenderer(i.type,!!r.slicePlaneEnabled),{modelTransform:o,origin:l,indices:c}=t,h=t.position,d=h.data.length/h.strideIdx,p=hu.createBuffer(d);for(let e=0;e<d;e++)p.position.set(e,0,h.data[h.offsetIdx+e*h.strideIdx+0]),p.position.set(e,1,h.data[h.offsetIdx+e*h.strideIdx+1]),p.position.set(e,2,h.data[h.offsetIdx+e*h.strideIdx+2]);aV(a.meta,[0,p.componentIndex.count],p.componentIndex);const m=await this.extractEdges(n.writerSettings,p,!1,s,c),{regular:f,silhouette:g}=this.createEdgeResources(m),v=(f?f.vao.size:0)+(g?g.vao.size:0),y={regular:f,silhouette:g,transform:{modelMatrix:o,origin:l},statistics:{gpuMemoryUsage:v,averageEdgeLength:m.averageEdgeLength},components:a,visible:!0,edgeTransparency:tV(a.meta),objectTransparency:iV(a.meta),distanceToCamera:0,rendererKey:n.key};e.renderables.push(y),n.addRenderable(y),this.gpuMemoryUsage+=v}async addComponentGeometry(e,t,i,r,s,a,n){const o=this.createComponentBuffers(a);if(u(o))return;const l=eV(a),c=this.acquireRenderer(l,n.slicePlaneEnabled||!1,!1),h=hu.createBuffer(i.count);Kh(h.position,i),aV(o.meta,s,h.componentIndex,r);const d=c.writerSettings,p=await this.extractEdges(d,h,!0,!1,r),{regular:m,silhouette:f}=this.createEdgeResources(p),g=(m?m.vao.size:0)+(f?f.vao.size:0),v={regular:m,silhouette:f,transform:e,statistics:{gpuMemoryUsage:g,averageEdgeLength:p.averageEdgeLength},components:o,visible:!0,edgeTransparency:tV(o.meta),objectTransparency:iV(o.meta),distanceToCamera:0,rendererKey:c.key};t.renderables.push(v),c.addRenderable(v),this.gpuMemoryUsage+=g}async addObjectMergedGeometries(e,t,i,r,s){const a=new Map;let n=0,o=null,l=null;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t],r=e.geometryRecords[t];if(!r.material.supportsEdges)continue;!l&&r.origin&&(l=r);const s=i.data.getIndices("position");n+=s?s.length:0,(s&&null==o||o===Uint16Array)&&(o=c(s)?Uint16Array:Uint32Array)}const h=n?new o(n):null,d=[];let u=0;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t];if(!e.geometryRecords[t].material.supportsEdges)continue;const r=i.data.getAttribute("position"),s=i.data.getIndices("position");let n=a.get(r.data);if(null==n){n=d.length/3;for(let e=r.offsetIdx;e<r.data.length;e+=r.strideIdx)d.push(r.data[e+0]),d.push(r.data[e+1]),d.push(r.data[e+2]);a.set(r.data,n)}if(s)for(let e=0;e<s.length;e++)h[u++]=n+s[e]}const p=l||e.geometryRecords[0],m=this.computeModelTransformWithLocalOrigin(e,p,jr()),f=p.origin;for(let t=0;t<e.geometryRecords.length;t++)e.geometryRecords[t].origin=f;const g={position:{data:d,offsetIdx:0,strideIdx:3},indices:h,modelTransform:m,origin:f};await this.addPositionData(t,g,i[0],r,s)}acquireRenderer(e,t,i=!0){const r=qF.getKey(e,t,i);let s=this.renderers.get(r);return u(this.strokesTexture)&&(this.strokesTexture=function(e){const t=JF.resolution,i=t/2,r=new Uint8Array(4*t*t),s=4*t*i,a=JF.amplitude,n=2*a,o=4*t,l=ze(t)+1,c=JF.strokes.length;let h=(l-1)*c*o;for(const{distance:e,pressure:t}of JF.strokes){let i=e,a=t,d=h;for(let e=0;e<l;e++){0!==e&&(i=YF(i,0),a=YF(a,1));for(let e=0;e<JF.resolution;e++){const t=.5+(i?i[e%i.length]/n:0),o=a?a[e%a.length]:1;Bl(t,r,d),Bl(o,r,d+s),d+=4}d-=o*(c+1)}h+=o}const d=new Po(e,{pixelFormat:6408,dataType:5121,hasMipmap:!1,samplingMode:9729,width:t,height:t,wrapMode:10497},r);return new KF(t,n,a,c,d)}(this.rctx)),s||(s=new qF(this.rctx,this.techniqueRepository,{type:e,slicePlaneEnabled:t,strokesTexture:this.strokesTexture,legacy:i}),this.renderers.set(r,s)),s.refCount.increment(),s}removeRenderable(e){const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),function(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null);e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}(e),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}updateObjectCameraDistances(e){const t=e.camera.viewInverseTransposeMatrix;Ye(this.tmpCameraPosition,t[3],t[7],t[11]),this.perObjectData.forEach(((e,t)=>{const i=h(e.center)?e.center:t.getCenter(),r=Ke(i,this.tmpCameraPosition);e.renderables.forEach((e=>e.distanceToCamera=r))}))}renderRegularEdges(e,t,i){e.bindRegularEdges(t,i);const r=i.transparency;e.forEachRenderable((r=>{if(!r.visible||!r.regular)return;const s=sV(r.regular.lod.lengths,r.distanceToCamera,i);"origin"in r.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(r.transform.origin)),e.renderRegularEdges(r,t,s),this.numberOfRenderedEdges+=s}),r)}renderSilhouetteEdges(e,t,i){e.bindSilhouetteEdges(t,i);const r=i.transparency;e.forEachRenderable((r=>{if(!r.visible||!r.silhouette)return;const s=sV(r.silhouette.lod.lengths,r.distanceToCamera,i);"origin"in r.transform&&(t.localViewMatrixForEdges=this.localOrigins.getViewMatrix(r.transform.origin)),e.renderSilhouetteEdges(r,t,s),this.numberOfRenderedEdges+=s}),r)}}class oV{constructor(e,t=null){this.center=t,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>this.loaded=!0))}waitLoaded(e){!0===this.loaded?e():this.loaded.then((()=>e()))}}class lV{constructor(e,t,i,r,s,a,n,o,l){this._materialRep=e,this._rctx=r,this._compositingHelper=s,this._magnifierHelper=a,this.requestRender=n,this._stage=l,this._materialRenderers=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._hasWater=!1,this._camera=new rh(ke(0,100,-100)),this._content=new Map,this._isRendering=!1,this._bindParameters={slot:null,camera:null,inverseViewport:cn(),shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:new Fc},this._fallbackDepthStencilTexture=null,this.performanceInfo=new Vc,this._antialiasing=1,this._oitEnabled=!0,this._handles=new $t,this.renderHiddenTransparentEdges=()=>{},this._shaderTechniqueRepository=i,this._smaaPass=new bF(this._rctx),this.camera.viewport[2]=o[0],this.camera.viewport[3]=o[1],this.requestRender(),this._offscreenRendering=new EL(this._rctx,this._compositingHelper),this._sliceHelper=new xF,this._shadowMap=new UL(this._rctx,i.viewingMode),this._ssaoHelper=new PF(i,this._rctx,(()=>this.requestRender())),this._highlightHelper=new ML(i,this._rctx),this._renderPlugins=new FL({rctx:this._rctx,shaderTechniqueRep:i,textureRep:t,materialRep:this._materialRep,requestRender:this.requestRender}),this.renderPassManager=new bL(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._renderContext=new zc(this._rctx,this._offscreenRendering,this._bindParameters.lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderContext.ssrParams={camera:null,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1},this._handles.add(hi(xc,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",(e=>{this.renderHiddenTransparentEdges=e?()=>this.renderEdges(1):()=>{},this.requestRender()})))}dispose(){this._handles.destroy(),this._smaaPass.disable(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers=null,this._edgeView=p(this._edgeView),this._offscreenRendering=y(this._offscreenRendering),this._fallbackDepthStencilTexture=y(this._fallbackDepthStencilTexture),this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose()),this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose()),this._highlightHelper&&(this._highlightHelper.enabled=!1),$l.tmpIndices.prune(),this._content.clear(),this._content=null}get updating(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources}ensureEdgeView(){return u(this._edgeView)&&(this._edgeView=new nV(this._rctx,this._shaderTechniqueRepository,{setNeedsRender:()=>this.requestRender()},this._stage.scheduler)),this._edgeView}set camera(e){this._camera.copyFrom(e),this.requestRender()}get camera(){return this._camera}get edgeView(){return this._edgeView}get isCameraFinal(){return null===this._bindParameters.reprojectionMat||Ei(this._bindParameters.reprojectionMat,fV)}get hasShadowsEnabled(){var e;return!(null==(e=this._shadowMap)||!e.enabled)}setLighting(e){this._bindParameters.lighting.set(e)}setRenderParameters(e){void 0!==e.screenSpaceReflectionsEnabled&&(this.renderPassManager.screenSpaceReflectionsEnabled=e.screenSpaceReflectionsEnabled),void 0!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this.renderPassManager.shadowCastingEnabled=e.shadowMap),void 0!==e.shadowMapMaxCascades&&(this._shadowMap.maxCascades=e.shadowMapMaxCascades),this._highlightHelper.enabled=!0,void 0!==e.ssao&&(this._ssaoHelper.enabled=e.ssao),void 0!==e.ssaoAttenuation&&(this._ssaoHelper.attenuation=e.ssaoAttenuation),void 0!==e.ssaoRadius&&(this._ssaoHelper.radius=e.ssaoRadius),void 0!==e.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter."),void 0!==e.ssaoSamples&&(this._ssaoHelper.samples=e.ssaoSamples),e.background&&(this._offscreenRendering.background=e.background),void 0!==e.antialiasingEnabled&&(this._antialiasing=e.antialiasingEnabled?1:0),void 0!==e.orderIndependentTransparencyEnabled&&(this._oitEnabled=e.orderIndependentTransparencyEnabled),void 0!==e.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(e.defaultHighlightOptions),void 0!==e.slicePlane&&(this._sliceHelper.plane=m(e.slicePlane)),void 0!==e.waterReflectionEnabled&&(this._waterReflectionEnabled=this._rctx.parameters.maxTextureImageUnits>=10&&e.waterReflectionEnabled),this.requestRender()}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get canRender(){return this._camera.fullWidth>0&&this._camera.fullHeight>0}getFramebufferTexture(e){switch(e){case"color":return this._offscreenRendering.colorTexture;case"hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case"shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case"linearDepth":return this._offscreenRendering.linearDepthTexture;case"normals":return this._offscreenRendering.normalTexture;case"highlight":return this._offscreenRendering.highlightTexture;default:return null}}modify(e,t=(e?e.length:0),i,r=(i?i.length:0),s,a=(s?s.length:0)){this._isRendering&&console.warn("Renderer.modify called while rendering");for(let e=0;e<r;++e)this._content.delete(i[e].uniqueName);for(let i=0;i<t;++i)this._content.set(e[i].uniqueName,e[i]);if(t||r||a){const n=Uc({toAdd:e,numToAdd:t,toRemove:i,numToRemove:r,toUpdate:s,numToUpdate:a});let o=!1;n.forEach(((e,t)=>{let i=this._materialRenderers.get(t);!i&&e.toAdd.length>0&&(i=new kc(this._rctx,this._materialRep,t),this._materialRenderers.set(t,i)),i&&(i.modify(e),i.isEmpty&&(o=!0))})),o&&this._materialRenderers.forEach(((e,t)=>{e.isEmpty&&(this._materialRenderers.delete(t),e.dispose())})),this._hasHighlights=ua(this._materialRenderers,(e=>e.hasHighlights)),this._hasOccludees=ua(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=ua(this._materialRenderers,(e=>e.hasWater)),this.requestRender()}}updateLogic(e){let t=!1;return this._materialRenderers.forEach((i=>{i.updateLogic&&(t=i.updateLogic(e)||t)})),t}render(e,t,i){this.performanceInfo.prerender(this._rctx),this._isRendering=!0,this.setLighting(this._stage.lighting),this._renderContext.hasOccludees=this._hasOccludees,this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType;const r=this._offscreenRendering;r.needLastFrameColorTexture=this._waterReflectionEnabled,r.advanceCurrentRenderTarget();const s=this._sliceHelper.plane;i&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),t.setGLViewport(this._rctx),this._renderPlugins.prepareRender(t),this.performanceInfo.advance(0),this.renderShadowMap(e,t,this._stage.mainLightDirection),this.performanceInfo.advance(1),this.ensureBindParameters(this._renderContext,t),r.initializeFrame(t),this.renderLinearDepth(),this.performanceInfo.advance(2),this.renderNormal(),this.performanceInfo.advance(3),this.ensureBindParametersSSR(this._renderContext),this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(t,r.linearDepthTexture,r.normalTexture),this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this.performanceInfo.stats.reset(),this.performanceInfo.advance(4),this._renderContext.pass=0,r.bindFramebuffer(),this._renderPlugins.render(0,this._renderContext),this.renderOpaqueGeometry(this._renderContext),this.performanceInfo.advance(5),this.renderEdges(2),this.performanceInfo.advance(6),this.renderHiddenTransparentEdges(),this.renderOrderIndependentTransparency((()=>this.renderTransparentGeometry(this._renderContext)),!1),this.performanceInfo.advance(7),this.renderEdges(1),this.performanceInfo.advance(8);const a={hudVisibility:!1,transparentTerrain:!1};a.hudVisibility=this.renderHUDVisibility(this._renderContext),this.renderInternalSlot(20,this._renderContext),this.performanceInfo.advance(9),a.transparentTerrain=this.renderTransparentTerrain(this._renderContext),a.transparentTerrain&&a.hudVisibility&&(r.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,r.framebuffer),this.performanceInfo.advance(16)),this.performanceInfo.advance(10),a.transparentTerrain&&r.compositeTransparentTerrainOntoMain(),r.renderToTargets((()=>{this.renderInternalSlot(8,this._renderContext),this._renderPlugins.render(15,this._renderContext),this._renderPlugins.render(16,this._renderContext)}),r.currentColorTarget,r.mainDepth),this.performanceInfo.advance(11),this._renderPlugins.needsLaserlineWithContrastControl&&r.renderTmpAndCompositeToMain((()=>{this._renderPlugins.render(17,this._renderContext)}),2),this.performanceInfo.advance(12),this.renderOccluded(),this.performanceInfo.advance(13);const n=!i&&this._magnifierHelper.enabled,o=n&&u(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(o),this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0),this.performanceInfo.advance(14),this.renderHUD(1,o),this.performanceInfo.advance(17),this.renderHighlights(this._renderContext.camera,e),this.performanceInfo.advance(15),n&&this._magnifierHelper.render(this._rctx,this._bindParameters),o!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0)),this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera),this._sliceHelper.plane=s,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}readDepthPixels(e,t,i,r,s){const a=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this.needsLinearDepth()){this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const e=17664;this._rctx.clearSafe(e,255),this.renderGeometryPass(2),this._rctx.gl.flush(),this._rctx.gl.finish()}a.readPixels(e,t,i,r,6408,5121,s)}renderEdges(e){const t=this._edgeView;h(t)&&t.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>t.render(this._bindParameters,e)),1)}renderShadowMap(e,t,i){const r=this._shadowMap;if(r.enabled){xc.ENABLE_PROFILE_DEPTH_RANGE&&fL.begin("depthRange");const s=this.computeDepthRange(t);xc.ENABLE_PROFILE_DEPTH_RANGE&&fL.end("depthRange"),r.prepare(t,i,s);const a=r.getCascades();for(let e=0;e<a.length;++e){const t=a[e];t.camera.setGLViewport(this._rctx),this.ensureCameraBindParameters(this._renderContext,t.camera),this.renderGeometryPass(4)}r.finish(e),t.setGLViewport(this._rctx)}r.bindToAllPrograms(this._shaderTechniqueRepository)}needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled}renderLinearDepth(){this.needsLinearDepth()?this._offscreenRendering.renderToTargets((()=>this.renderGeometryPass(2)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)}renderNormal(){this._ssaoHelper.enabled?this._offscreenRendering.renderToTargets((()=>{this.renderGeometryPass(3)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}computeDepthRange(e){const t=iL(e,this._content,this._stage.getLayers());return FE(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}renderGeometryPass(e){this._renderContext.pass=e,this.renderOpaqueGeometry(this._renderContext),this.renderTransparentGeometry(this._renderContext),this.renderTransparentTerrain(this._renderContext)}renderOpaqueGeometry(e){this._renderPlugins.render(1,e),this._renderPlugins.render(2,e),this.renderInternalSlot(3,e),this._renderPlugins.render(4,e),e.ssaoHelper&&e.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository),this._renderPlugins.render(14,this._renderContext)}renderTransparentGeometry(e){this.renderInternalSlot(5,e),this._renderPlugins.render(6,e),e.ssaoHelper&&e.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)}renderTransparentTerrain(e){return this._renderPlugins.render(7,e)}renderHUDVisibility(e){let t=!1;return e.offscreenRenderingHelper&&e.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null,t=this.renderInternalSlot(12,e)})),t}renderHUD(e,t){this._oitEnabled?(this.renderOrderIndependentTransparency((()=>this.renderHUDElements(e)),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===e?this._offscreenRendering.renderToTargets((()=>this.renderHUDElements(0)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(e)}renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this.renderInternalSlot(21,this._renderContext),this.renderInternalSlot(18,this._renderContext),this.renderInternalSlot(19,this._renderContext)}renderHighlights(e,t){const i=this._highlightHelper;if(!(!!i&&i.enabled&&(this._hasHighlights||this._renderPlugins.needsHighlight)))return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const r=i.profilingCallback&&jc(this._renderContext.rctx);this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;const s=this._offscreenRendering.renderToTargets((()=>{this.renderGeometryPass(5),this._rctx.clearSafe(256),this.renderHUDElements(2)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);i.render(e,s,t),h(r)&&i.profilingCallback&&r.stop((e=>{i.profilingCallback&&i.profilingCallback(e)}))}renderOrderIndependentTransparency(e,t){if(this._oitEnabled&&this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat&&this._rctx.capabilities.colorBufferFloat&&this._rctx.capabilities.colorBufferFloat.textureFloat){const i=i=>{this._renderContext.transparencyPassType=i,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._offscreenRendering.renderOITPass((()=>e()),i,t)},r=this._renderContext.pass;this._renderContext.pass=1,i(1),this._renderContext.pass=0,i(0),i(2),this._offscreenRendering.compositeTransparentOntoOpaque(t),this._renderContext.transparencyPassType=3,this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType,this._renderContext.pass=r}else e()}renderOccluded(){let e=0;this._materialRenderers.forEach(((t,i)=>{i&&i.isVisible()&&8===i.renderOccluded&&(e|=i.renderOccluded,hV.push(i))}));const t=this._offscreenRendering,i=this._renderContext,r=(i,r,s=(()=>a(r)),n=!0,o=!0)=>{0!=(e&r)&&(t.renderToTargets(s,t.tmpColor,t.mainDepth,[0,0,0,0],n,o),t.compositeOccludedOntoMain(i))};0!==hV.length&&(this.renderInternalSlot(10,i,hV),r(.5,8,(()=>this.renderInternalSlot(11,i,hV)),!1,!1),hV.length=0),this._materialRenderers.forEach(((t,i)=>{i&&i.isVisible()&&(4===i.renderOccluded||2===i.renderOccluded||16===i.renderOccluded)&&(e|=i.renderOccluded,cV.push(i))}));const s=this._renderPlugins.renderOccludedFlags;if(e|=s,!e)return;const a=e=>{i.renderOccludedMask=e,s>1&&this._renderPlugins.render(9,i),this.renderInternalSlot(3,i,cV),this.renderInternalSlot(5,i,cV),this.renderInternalSlot(8,i,cV),i.resetRenderOccludedMask()};i.pass=0,r(.5,4,(()=>a(4)),!0,2),r(.5,2,(()=>a(2)),!0,2),r(1,16,(()=>a(16)),!0,2),cV.length=0}renderAntiAliasing(e,t){if(1===e){if(this._smaaPass.loadResources((()=>this.requestRender())),this._smaaPass.enable())return this._smaaPass.render({colorTexture:t}),!0}else this._smaaPass.disable();return!1}ensureCameraBindParameters(e,t){this._renderContext.camera=t,this._bindParameters.camera=e.camera,this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3]}ensureBindParameters(e,t){this.ensureCameraBindParameters(e,t);const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=e.shadowMap,this._bindParameters.shadowMappingEnabled=!!e.shadowMap&&e.shadowMap.enabled,this._bindParameters.ssaoEnabled=!!e.ssaoHelper&&e.ssaoHelper.enabled,this._bindParameters.slicePlane=e.sliceHelper&&e.sliceHelper.plane,this._bindParameters.hasOccludees=e.hasOccludees,this._bindParameters.linearDepthTextureID=3,this._bindParameters.lastFrameColorTextureID=4,this._bindParameters.hudVisibilityTexture=i?i.hudVisibilityTexture:null,this._bindParameters.highlightDepthTexture=i&&i.depthTexture||this.getFallbackDepthTexture()}ensureBindParametersSSR(e){this._waterReflectionEnabled?(Mi(dV,e.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),Mi(pV,e.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),xi(pV,pV),xi(uV,e.camera.projectionMatrix),wi(mV,pV,uV),wi(mV,dV,mV),wi(mV,e.lastFrameCamera.projectionMatrix,mV),this._renderContext.ssrParams.camera=e.camera,this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=mV,this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null,this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this._waterReflectionEnabled}renderInternalSlot(e,t,i){const r=0===t.pass?this.performanceInfo.stats:null;let s=!1;return this._bindParameters.slot=e,h(i)?i.forEach((i=>{if(!_o(i,t))return;const r=this._materialRenderers.get(i);h(r)&&(s=r.render(e,t,this._bindParameters)||s)})):this._materialRenderers.forEach(((i,a)=>{_o(a,t)&&(s=i.render(e,t,this._bindParameters,r)||s)})),s}getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=Xl(this._rctx)),this._fallbackDepthStencilTexture}getGpuMemoryUsage(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}}get test(){return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,materialRenderers:this._materialRenderers,oitEnabled:this._oitEnabled}}}const cV=[],hV=[],dV=jr(),uV=jr(),pV=jr(),mV=jr(),fV=jr(),gV=d.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");class vV{constructor(e,t,i,r){this._textures=t,this.rctx=r,this._idToRefCountedTexture=new Map,this._textureTechniqueConfig=new Gc,this._loadingCount=0,this._frameUpdates=new Map,this._fallbackTextureData=new Uint8Array(256),this._fallbackTextureTransparentData=new Uint8Array(256),this.events=new se,this._textureTechnique=i.acquireAndReleaseExisting(Bc,this._textureTechniqueConfig,this._textureTechnique);for(let e=0;e<this._fallbackTextureData.length;++e)this._fallbackTextureData[e]=255,this._fallbackTextureTransparentData[e]=(e+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:8,height:8,maxAnisotropy:this.rctx.parameters.maxMaxAnisotropy},this._frameTask=h(e)?e.registerTask(xr.TEXTURE_UNLOAD,(()=>{}),(()=>!1)):Cr}dispose(){this._frameTask.remove(),h(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null),h(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=null),this._textures.forEach((e=>e.unload()))}acquire(e,t=!1,i){const r=this._getOrCreateRef(e,t,i);return r.ref(),r}update(){let e=!1;this._frameUpdates.forEach((t=>{const i=t.texture.frameUpdate(this.rctx,this._textureTechnique,t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e&&this.events.emit("changed",0)}_getOrCreateRef(e,t,i){const r=this._idToRefCountedTexture.get(e);return r||this._createNewRef(e,t,i)}_createNewRef(e,t,i){const r=this._textures.get(e);Vl(void 0!==r);const s=r.events.on("unloaded",(()=>{s.remove(),this._onTextureUnloaded(e)})),a=new yV;this._idToRefCountedTexture.set(e,a);const n=r.load(this.rctx,this._textureTechnique);this._loadingCount++;const o=t=>(this._loadingCount--,this._updateGLTexture(a,t),i&&i(a),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),a),l=e=>{this._loadingCount--,U(e)||gV.error(e)};return K(n)?(this._updateGLTexture(a,t?this.fallbackTextureTransparent:this.fallbackTexture),n.then(o,l)):o(n),a}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1)}release(e){const t=this._idToRefCountedTexture.get(e);if(t&&(t.unref(),t.isUnreferenced)){const i=this._textures.get(e);this._frameTask.schedule((()=>{t.isUnreferenced&&i.unload()}))}}getTexture(e){return this._textures.get(e)}get loadingCount(){return this._loadingCount}_onTextureUnloaded(e){this._idToRefCountedTexture.delete(e),this._frameUpdates.delete(e)}get fallbackTexture(){return u(this._fallbackTexture)&&(this._fallbackTexture=new Po(this.rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture}get fallbackTextureTransparent(){return u(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new Po(this.rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent}}class yV{constructor(){this._refCount=0,this.glTexture=null}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}unref(){0!==this._refCount?--this._refCount:gV.error("Cannot dereference texture that has no references!")}}const _V=d.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils"),xV=[ve("esri/images/materials/water/normals.jpg"),ve("esri/images/materials/water/perturbation.jpg")];let bV=class extends T{constructor(){super(...arguments),this.data=[],this.loadingState=0}dispose(){this.loadingState=0,this.data.forEach((e=>{e.dispose(),e=null})),this.data=null}getTextureProps(e,t,i=!1){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:10497,samplingMode:9987,hasMipmap:i,maxAnisotropy:8,width:e,height:t}}get updating(){return 1===this.loadingState}get ready(){return 2===this.loadingState}loadTextures(e){this.loadingState=1,X(xV.map((e=>_n(e)))).then((t=>{t.forEach(((t,i)=>{this.data[i]=new Po(e,this.getTextureProps(t.width,t.height,!0),t)})),this.loadingState=2})).catch((e=>{_V.error("Failed to load textures for water material.",e),this.loadingState=0}))}bindRepo(e){for(let t=0;t<this.data.length;t++)e.bindTexture(this.data[t],t)}};e([S()],bV.prototype,"loadingState",void 0),e([S({type:Boolean,readOnly:!0,dependsOn:["loadingState"]})],bV.prototype,"updating",null),bV=e([re("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],bV);class wV extends ho{constructor(e,t,i,r=null,s,a=!0){super(),this._rctx=e,this._renderScene=t,this._requestRenderScene=i,this._renderOverlay=r,this.forceCameraHook=s,this.supersample=a,this._screenshotQueue=[]}dispose(){this._rctx=null}takeScreenshot(e){this._requestRenderScene();const t=V();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e){if(0!==this._screenshotQueue.length){for(const t of this._screenshotQueue){if(this.isDisposed){t.resolver.reject();continue}const i={...t.settings,pixelRatio:t.settings.pixelRatio*e.viewCamera.pixelRatio},r=this._ensureScreenshotEncodeCanvas(),s=this._renderScreenshot(e,i),a=Ar(s,i,r,{flipY:!0,premultipliedAlpha:!0});t.resolver(a)}this._screenshotQueue=[]}}_renderScreenshotOverlay(e,t,i){if(u(this._renderOverlay))return;e.width=t.width,e.height=t.height;const r=e.getContext("2d"),s=i.pixelRatio;r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(s,s),this._renderOverlay(e,t),r.restore()}_readbackScreenshot(e){return e.resample?this._readbackScreenshotResampled(e):this._readbackScreenshotImmediate(e)}_readbackScreenshotResampled(e){const{framebufferWidth:t,framebufferHeight:i,region:r,resample:s}=e,a=this._ensureScreenshotEncodeCanvas(),n=Er(t,i,a);this._rctx.gl.readPixels(0,0,t,i,6408,5121,new Uint8Array(n.data.buffer)),this._renderScreenshotOverlay(a,n,{...e,region:null});const o=Er(r.width,r.height,a);return Ir(n,o,!0,s.region.x,i-(s.region.y+s.region.height),s.region.width,s.region.height)}_readbackScreenshotImmediate(e){const{framebufferHeight:t,region:i}=e,r=this._ensureScreenshotEncodeCanvas(),s=Er(i.width,i.height,r);return this._rctx.gl.readPixels(i.x,t-(i.y+i.height),i.width,i.height,6408,5121,new Uint8Array(s.data.buffer)),this._renderScreenshotOverlay(r,s,e),s}_renderScreenshot(e,t){let i=null;const r=e.viewCamera,{framebufferWidth:s,framebufferHeight:a}=t;let n=!1;const o=t.disableDecorations&&e.frameHasDecorations,l=s!==r.fullWidth||a!==r.fullHeight,c=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,h=l||o||c;if(h){const e=r.clone();if(t.ignorePadding){const i=Dr(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=s,e.fullHeight=a,e.pixelRatio=t.pixelRatio;const o=r.fovX-e.fovX,l=r.fovY-e.fovY;o<0&&o<l?e.fovX=r.fovX:l<0&&l<o&&(e.fovY=r.fovY),this.forceCameraHook(e),n=!0,i=new Do(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:0,depthStencilTarget:3}),this._renderScene(i,e,t.disableDecorations)}const d=this._readbackScreenshot(t);if(h&&!this._rctx.contextAttributes.alpha)for(let e=3;e<d.data.length;e+=4)d.data[e]=255;return i&&i.dispose(),this._rctx.bindFramebuffer(null),n&&this.forceCameraHook(r),d}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const CV=d.getLogger("esri.views.3d.webgl-engine.parts.View");let SV=null,TV=class extends(xo(T)){constructor(e){super({}),this._stage=e,this.events=new se,this._stippleTextureRepository=new Ah,this.waterTextureRepository=new bV,this._magnifierHelper=new pL,this._commonUniformStore=new Nc,this._componentObjectCollection=null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._logicUpdateLast=0,this._container=this._stage.container,this._initializeContext(this._stage.options),hi(this.waterTextureRepository,"loadingState",(()=>this.setNeedsRender())),this._magnifierHelper.events.on("request-render",(()=>this.setNeedsRender())),this._shaderTechniqueRepository=new qc({rctx:this._rctx,viewingMode:this._stage.options.viewingMode,commonUniformStore:this._commonUniformStore,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new vV(this._stage.scheduler,this._stage.getAll(4),this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",(e=>this.setNeedsRender(e))),this._materialRepository=new Hc(this._textureRepository,this._shaderTechniqueRepository,(()=>this.setNeedsRender())),this._compositingHelper=new JI(this._rctx,this._shaderTechniqueRepository);const t=this._container.getBoundingClientRect();this._renderer=new lV(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,((e=1)=>this.setNeedsRender(e)),[t.width,t.height],this._stage),this._screenshotManager=new wV(this._rctx,((e,t,i)=>this._render(e,t,i)),(()=>this.setNeedsRender()),this._stage.options.screenshot.renderOverlay,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask()}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null,Jh(this._rctx),super.dispose(),this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}setNeedsRender(e=1){1===e?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0}get canRender(){return this._renderer.canRender}get needsUpdate(){return this._needsUpdate}get updating(){return this.evaluateUpdating()}evaluateUpdating(){return this.needsUpdate||this._renderer.updating||this._textureRepository.loadingCount>0||this.waterTextureRepository.updating||this._magnifierHelper.updating||this._stage.dirty}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}setRenderParameters(e){this.setNeedsRender(),void 0!==e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}has(e){switch(e){case 0:return!!this._rctx.capabilities.compressedTextureS3TC;case 1:return!!this._rctx.capabilities.shaderTextureLOD;case 2:return this._renderer.hasShadowsEnabled;default:return!1}}modify(e,t,i){this._renderer.modify(e,e.length,t,t.length,i,i.length)}setCamera(e){this._renderer.camera=e}getCamera(){return this._renderer.camera}getCanvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}getMinimalDepthForArea(e,t,i,r=80,s=1){const a=r*i.pixelRatio,n=i.constrainWindowSize(e,t,a,s);SV=new Uint8Array(4*n[2]*n[3]),this._renderer.readDepthPixels(n[0],n[1],n[2],n[3],SV);let o=Number.MAX_VALUE;for(let e=0;e<n[2]*n[3];e++){const t=tL(4*e,SV,i.nearFar);o>t&&t!==i.nearFar[0]&&t!==i.nearFar[1]&&(o=t)}return o===Number.MAX_VALUE?void 0:o}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}getGpuMemoryUsage(){return this._renderer.getGpuMemoryUsage()}async hotReloadShaders(){tO(),await this._shaderTechniqueRepository.hotReload(),this.setNeedsRender()}_registerFrameTask(){const e={viewCamera:this._renderer.camera,frameHasDecorations:!1};let t=!1;const i={preRender:e=>{t=this.evaluateUpdating();let i=!1;this._stage.processDirty();const r=oi(e.time-this._logicUpdateLast);if(r>JM){const t={camera:this._renderer.camera,dt:r};i=this._renderer.updateLogic(t),this._logicUpdateLast=e.time}i&&this.setNeedsRender(0)},render:()=>{!this.needsUpdate&&!this._needsRender&&this._idleSuspend&&this._renderer.isCameraFinal||!this.canRender||(this._needsRender=!1,this._needsUpdate=!1,this._render(null,this._renderer.camera,!1))},postRender:()=>{t!==this.evaluateUpdating()&&this.notifyChange("updating")},update:()=>{e.viewCamera=this._renderer.camera,e.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(e)}};this._frameTask=O(i)}_initializeContext(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil,powerPreference:"high-performance"},r=ba(this._canvas,t,e.renderContext),s={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{}};this._rctx=new Sh(r,s),null!=this._rctx.parameters.maxMaxAnisotropy&&(this._rctx.parameters.maxMaxAnisotropy=Math.min(this._rctx.parameters.maxMaxAnisotropy,8)),this._loadShaderOnlyExtensions(this._rctx),!e.alpha&&this._rctx.contextAttributes.alpha&&CV.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&i("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_render(e,t,i){this._renderer.render(e,t,i)}_loadShaderOnlyExtensions(e){const t=e.capabilities;t.standardDerivatives,t.shaderTextureLOD,t.textureFloat}get componentObjectCollection(){return u(this._componentObjectCollection)&&(this._componentObjectCollection=new qI(this._renderer.renderPassManager)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};var PV;e([S({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating","_magnifierHelper.updating"],autoTracked:!1})],TV.prototype,"updating",null),e([uo()],TV.prototype,"_rctx",void 0),e([uo()],TV.prototype,"_container",void 0),e([uo()],TV.prototype,"_canvas",void 0),e([uo()],TV.prototype,"_stippleTextureRepository",void 0),e([uo(),S()],TV.prototype,"waterTextureRepository",void 0),e([uo(),S()],TV.prototype,"_magnifierHelper",void 0),e([uo()],TV.prototype,"_textureRepository",void 0),e([uo()],TV.prototype,"_commonUniformStore",void 0),e([uo()],TV.prototype,"_compositingHelper",void 0),e([uo()],TV.prototype,"_renderer",void 0),e([uo()],TV.prototype,"_screenshotManager",void 0),e([uo()],TV.prototype,"componentObjectCollection",null),e([uo()],TV.prototype,"_componentObjectCollection",void 0),TV=e([re("esri.views.3d.webgl-engine.parts.RenderView")],TV);let RV=PV=class extends(xo(T)){constructor(e){super(e),this.model=new lA,this._viewContent=[],this._mainLightDirection=ke(0,1,0)}initialize(){this._set("renderView",new TV(this)),this.setLighting({lights:[new vc(ke(.7,.7,.7)),new yc(ke(.3,.3,.3))],groundLightingFactor:.5,globalFactor:.5})}destroy(){Xc.pool.prune(0),this.dispose()}get dirty(){return this.model.getDirtySet().hasDirtyGeometryRecords()}get mainLightDirection(){return this._mainLightDirection}get lighting(){return this._lighting}setLighting(e){Ye(this._mainLightDirection,0,0,0);for(const t of e.lights)if(t instanceof vc){rt(this._mainLightDirection,t.direction);break}this._lighting=e,this.renderView.setNeedsRender()}stopAnimationsAtTime(e){this.getAll(3).forEach((t=>{x(t.animation,(t=>t.stopAtTime(e)))})),this.renderView.setNeedsRender()}add(e,t){this.model.add(e,t),MV(t)&&t.addParentStage(this),this.renderView.setNeedsRender()}remove(e,t){this.renderView.setNeedsRender();const i=this.model.remove(e,t);return MV(i)&&i.removeParentStage(this),i}notifyDirty(e,t,i){this.destroyed||(this.model.notifyDirty(e,t,i),this.renderView.setNeedsRender())}processDirty(){const e=this.model.getDirtySet();if(!e.hasDirtyGeometryRecords())return;PV.DebugSettings.logDirtySet&&console.log("Dirty set: "+this.model.getDirtySet().formatDebugInfo());const t=e.commitLayers(this._viewContent);t[0].length+t[1].length+t[2].length>0&&this.renderView.modify(t[0],t[1],t[2]),PV.DebugSettings.logDirtySet&&(console.log("RGs add: "+t[0].map((e=>e.uniqueName))),console.log("RGs remove: "+t[1].map((e=>e.uniqueName)))),e.commit(),this.renderView.setNeedsRender()}processDirtyLayer(e){const t=this.model.getDirtySet().commitLayers([e]);t[0].length+t[1].length+t[2].length>0&&this.renderView.modify(t[0],t[1],t[2]),this.renderView.setNeedsRender()}getContent(e,t){return this.model.get(e,t)}getAll(e){return this.model.getAll(e)}getCount(e){return this.model.getAll(e).size}getCamera(){return this.renderView.getCamera()}setCamera(e){this.renderView.setCamera(e)}getLayers(){return this.model.getAll(0)}getViewContent(){return this._viewContent.slice(0)}addToViewContent(e){const t=[];for(let i=0;i<e.length;i++)-1===this._viewContent.indexOf(e[i])&&t.push(e[i]);if(e.length>0){this.processDirty();const e=this.model.getDirtySet().getResidentRenderGeometriesFilteredByLayers(t);this.renderView.modify(e,[],[]),this._viewContent.push.apply(this._viewContent,t)}}removeFromViewContent(e){this.processDirty();const t=this.model.getDirtySet(),i=this._viewContent,r=[];for(let t=0;t<e.length;t++){const s=i.indexOf(e[t]);s>-1&&(i[s]=i[i.length-1],i.pop(),r.push(e[t]))}const s=t.getResidentRenderGeometriesFilteredByLayers(r);this.renderView.modify([],s,[])}addRenderPlugin(e,t){"intersect"in t&&this.sceneIntersectionHelper.addIntersectionHandler(t),this.renderView.renderPlugins.add(e,t)}removeRenderPlugin(e){"intersect"in e&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this.model.getStats()}}};function MV(e){return"function"==typeof e.addParentStage&&"function"==typeof e.removeParentStage}RV.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},e([S({constructOnly:!0})],RV.prototype,"scheduler",void 0),e([S({constructOnly:!0})],RV.prototype,"options",void 0),e([S({constructOnly:!0})],RV.prototype,"sceneIntersectionHelper",void 0),e([S({constructOnly:!0})],RV.prototype,"viewingMode",void 0),e([S({constructOnly:!0})],RV.prototype,"container",void 0),e([uo(),S()],RV.prototype,"renderView",void 0),RV=PV=e([re("esri.views.3d.webgl-engine.Stage")],RV);let OV=class extends yn{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};e([S()],OV.prototype,"components",void 0),OV=e([re("esri.views.ui.3d.DefaultUI3D")],OV);var DV=OV;const AV=d.getLogger("esri.views.SceneView");let EV=class extends(an(va(nn(pa)))){constructor(e){super(e),this._clippingArea=null,this._userClippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new ld({slicePlane:ml},this),this._resourceController=function(e,t=(()=>performance.now())){return new tM.ResourceController({view:e,now:t})}(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new B_({view:this}),this.labeler=new LT({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new Vu,this.environmentManager=new Jp,this.extent=null,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new PP,this.scale=null,this.spatialReference=null,this.isHeightModelInfoRequired=!0,this.alphaCompositingEnabled=!1,this.supersampleScreenhotsEnabled=!0,this.type="3d",this.ui=new DV,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new jR,Sr(),e&&e.environment||(this._defaults.environment=new Hu,this.environment=this._defaults.environment);const t=()=>{this.notifyChange("dataExtent"),this.updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when()}catch{}this.updatingChanged()}))};this.handles.add([ci(this,"map.allLayers","after-changes",t,t,t,!0),this.allLayerViews.on("after-changes",(()=>this._updateUpdatingMonitors())),this.watch("map",(e=>{e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new h_({view:this});this.stateManager=new vR({view:this,updateDevicePixelRatio:()=>{const e=window.devicePixelRatio;e!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=e,this.notifyChange("pixelRatio"))}})}initialize(){this.groundView=new Wa({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(ci(this,"map.allLayers","after-changes",e,e,e)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),2),this.updatingHandles.add(this.qualitySettings,"frameRate",(e=>F(e>0?1e3/Math.ceil(e):0)),2),this.updatingHandles.add(xc,"SCENEVIEW_LOCKING_LOG",(e=>this.defaultsFromMap.logDebugInformation=e),2),this.updatingHandles.add(this,"map.ground",e,3),this.updatingHandles.add(this,"map.ground.opacity",(()=>this._updateDefaultHitTestOptions()),3),this.handles.add(this.watch("spatialReference",(()=>this.notifyChange("clippingArea")),!0))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController.destroy(),this._resourceController=null,this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView.destroy(),this.groundView=null)}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}get clippingArea(){if("global"===this.viewingMode)return null;let e=this._userClippingArea||this.get("map.clippingArea");if(!(!!this._userClippingArea||this.get("map.clippingEnabled"))||!e)return this._clippingArea=null,null;if(!(e instanceof Pe))return AV.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea;if(this.spatialReference){if(!Se(e.spatialReference,this.spatialReference))return AV.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea;e=Te(e,this.spatialReference)}return this._clippingArea&&e&&this._clippingArea.equals(e)?this._clippingArea:(this._clippingArea=e,e)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&e?AV.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"))}get dataExtent(){const e=[],t=this.spatialReference||ue.WGS84;let i=this.clippingArea;i&&(i=Te(i,t));const r=r=>{if(!r)return;let s=Te(r,t);s&&(i&&(s=s.intersection(i),!s)||e.push(s))},s=this.basemapTerrain;if(s&&s.spatialReference&&r(new Pe({xmin:s.extent[0],ymin:s.extent[1],zmin:0,xmax:s.extent[2],ymax:s.extent[3],zmax:0,spatialReference:s.spatialReference})),this.map&&this.map.allLayers.forEach((e=>r(e.fullExtent))),0===e.length)return new Pe({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:t});const a=e.reduce(((e,t)=>e.union(t)));return a.hasZ?(a.zmin=Math.min(0,a.zmin),a.zmax=Math.max(0,a.zmax)):(a.zmin=0,a.zmax=0),a}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof Hu?e:e instanceof vr?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):Hu.fromWebsceneEnvironment(e):ie(Hu,e):new Hu}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(e){h(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio")}get maximumPixelRatio(){let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.qualitySettings;if(null!=t&&(e=Math.min(e,t)),null!=i){const t=i/Math.max(this.width,this.height);e=Math.min(e,t)}return e}set maximumPixelRatio(e){h(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio")}get groundExtent(){const e=this._get("basemapTerrain");if(e&&e.spatialReference){const t=e.extent;return new Pe({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}const t=this.spatialReference||ue.WGS84;return new Pe({spatialReference:t})}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get interacting(){return this.navigating||h(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(u(this.state)||this.state.stationary)}set qualityProfile(e){UR.isValidProfile(e)&&(UR.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||UR.getDefaultProfile()}set slicePlane(e){if(this._stage.renderView.setRenderParameters({slicePlane:e}),u(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");Wo.copy(e,t),this._set("slicePlane",t)}get resolution(){return null!=this.spatialReference?da(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?yi.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;let r=0,s=0,a=!1;this.allLayerViews.forEach((e=>{if(e.isFulfilled()){if(e.updating){if(a=!0,e.suspended)return;++s,r+="updatingProgress"in e?e.updatingProgress:.5}}else++s}));for(const e of[this.graphicsView,this.basemapView,this.basemapTerrain,this.layerViewManager,this._resourceController,null==(n=this._stage)?void 0:n.renderView,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.updatingHandles,this.featureTreeDebugger]){var n;if(h(e)&&e.updating){const e=.1;s+=e,r+=.5*e}}for(const e of[this.deconflictor,this.labeler])h(e)&&e.updating&&(++s,r+=e.updatingProgress);if(a=!!(a||s>0||!this.ready||!this.stationary||this._createGraphicsViewController||null!=(e=this.inputManager)&&e.hasPendingInputs||null!=(t=this.map)&&null!=(i=t.allLayers)&&i.some((e=>!e.isFulfilled()))),a?(this._numUpdating=Math.max(s,this._numUpdating),r+=this._numUpdating-s):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=a?.5:1,this._get("updatingProgress")!==r){const e=this._resourceController.scheduler.now;if(r<1){const t=Math.min((e-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-t)+r*t}this._set("updatingProgress",r),this._lastUpdateTime=a&&r<1?e:0}return a}get viewingMode(){const e=this.get("map.initialViewProperties.viewingMode");if(e)return e;const t=this.spatialReference;return!t||mr(t,"global")?"global":"local"}set viewingMode(e){if(this.ready)AV.error("#viewingMode","viewingMode cannot be set once view is ready");else{["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}}get resourceController(){return this._resourceController}get performanceInfo(){return new ud(this)}on(e,t,i,r){const s=this.viewEvents.on(e,t,i,r);return s||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return AV.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=h(i.graphics)&&(h(i.graphics.include)||h(i.graphics.exclude)),s=_a(e)?xa(this,e):e,a=zt(s);i.enableDraped=i.include&&!i.include.has(eh)||i.exclude&&i.exclude.has(eh);const n=this.sceneIntersectionHelper,o=new ih(this.state.mode);if(o.options.selectionMode=!0,o.options.store=r?2:0,n.intersectIntersectorScreen(a,o,i),r){for(const e of o.results.all){const t=e.toGraphic(this);if(u(t))return this._intersectResultToMapPoint(e);if(this._testGraphicUidFilter(i.graphics,t))return this._intersectResultToMapPoint(e)}return null}return this._intersectResultToMapPoint(o.results.min)}toScreen(e){if(!this.ready)return AV.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=null==e.z&&Aa(this.elevationProvider,e)||0;return ir(e,LV,this.renderSpatialReference,t),this.state.camera.projectToScreen(LV,FV),Gt(FV[0],FV[1])}pixelSizeAt(e){return this.ready?e?(ir(e,LV,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(LV)):0:(AV.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return AV.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=_a(e)?xa(this,e):e,r=Vt(i.x,i.y),s=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const a=new ih(this.state.mode);a.options.selectionMode=!0,a.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(r,a,s);const n=this._intersectResultsToHits(a.results.all,s.graphics),o=a.results.ground,l=o.toOwner(this),c=h(l)&&"type"in l&&"integrated-mesh"===l.type?l:null,d={screenPoint:i,results:n,ground:{mapPoint:this._intersectResultToMapPoint(o),distance:o.hasIntersectionPoint?o.distanceInRenderSpace:0,layer:c}};return xc.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(d.intersector=a),k(d)}popupHitTest(e){return du(this,e).then((({results:t,ground:i})=>{let r=null;return!(0===t.length||Math.abs(t[0].distance-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}}))}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}whenLayerView(e){return super.whenLayerView(e)}takeScreenshot(e){return this.whenReady().then((()=>{const t=Lr(e,this);return t.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(Fr(t,this.supersampleScreenhotsEnabled,this.padding))}))}importLayerView(e){return vu(e)}hasLayerViewModule(e){return gu(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null}async validate(){let e=on();if(i("safari")&&i("safari")<9&&(e=new ee("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:i("safari")})),h(e))throw AV.warn("#validate()",e.message),e}isSpatialReferenceSupported(e,t,i){const r=e.isGeographic,s=e.isWebMercator,a=mr(e,"global"),n="local"===this.viewingMode,o=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(o){if(n&&r)return i&&i(`Layer ${t.id} is ignored because it is GCS and viewing mode is local`),!1;if(!n&&!a)return i&&i(`Layer ${t.id} is ignored because its spatial reference is not supported in global viewing mode`),!1}else if(r&&!a)return i&&i(`Layer ${t.id} is ignored because its spatial reference is geographic but unsupported`),!1;if(t)if(Ca(t)){let r;if(o){r=null!=wd(t,e,uu(this.viewingMode)).tileInfo}else{let i=wd(t,e,1);null==i.tileInfo&&(i=wd(t,e,2),null!=i.tileInfo&&s&&!this.ready&&(this.viewingMode="local")),r=null!=i.tileInfo}if(!r)return i&&i(`Layer ${t.id} is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode`),!1}else if((e.isWGS84||s)&&!n)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),o||this.ready||(this.viewingMode="global",i&&i(`Viewing mode locked to global due to reprojectable layer ${t.id}`)),i&&i(`Layer ${t.id} is ignored because it supports server-side reprojection`),!1;return!0}whenReady(){return W((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}computeMapPointFromVec3d(e,t){let i=this.spatialReference||ue.WGS84;return rr(e,this.renderSpatialReference,e,i)||(i=ue.WGS84,rr(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new _e(e,i),t}flushDisplayModifications(){this._stage.processDirty()}trackGraphicState(e){if(!e.graphic)return AV.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&h(t)&&"graphics3d"in t&&t.graphics3d&&t.graphics3d.graphicsCore&&(i=t.graphics3d.graphicsCore.trackGraphicState(e))};return h(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,h(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return w(e.map((e=>this.highlight(e))));if(ae.isCollection(e))return w(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):C()}maskOccludee(e){if(!e)return AV.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&h(t)&&"graphics3d"in t&&ya(t)&&(i=t.maskOccludee(e))};return h(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,h(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){h(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await ui(this,"graphicsView"),this.graphicsView;if(!e.layer||!this.map)throw new ee("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?W(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{-1!==s.added.indexOf(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,0),i=this._externalToInternalRenderItems(e.exclude,1);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){if(e.getIntersectionPoint(LV)){t=this.computeMapPointFromVec3d(LV,t);const i=this.basemapTerrain;return"TerrainRenderer"===e.intersector&&i&&(t.z=Aa(i,t)||0),t}return null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const a=e[s],n=a.toOwner(this);if(h(n)&&(n===this.map.ground||"type"in n&&"integrated-mesh"===n.type))break;const o=a.toGraphic(this);if(!h(o))continue;if(u(r)&&s!==e.length-1&&(r=new Set),h(r)){const e=this._getGraphicFilterUid(o);if(r.has(e))continue;r.add(e)}if(!this._testGraphicUidFilter(t,o))continue;const l=this._intersectResultToMapPoint(a),c=a.distanceInRenderSpace;i.push({graphic:o,mapPoint:l,distance:c})}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return`u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return u(e)||(u(e.include)||e.include.has(i))&&(u(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,i={layerUids:null,graphicUids:null}){return e?(e instanceof Qt?(!function(e,t){e.graphicUids||(e.graphicUids=new Set);e.graphicUids.add(t)}(i,this._getGraphicFilterUid(e)),0===t&&(h(this.graphicsView)&&e.layer===this?IV(i,this.graphicsView.mockLayerId):e.layer&&IV(i,e.layer.uid))):"forEach"in e?e.forEach((e=>{Array.isArray(e)?this._externalToInternalRenderItems(e,t,i):ae.isCollection(e)?e===this.graphics&&h(this.graphicsView)?IV(i,this.graphicsView.mockLayerId):this._externalToInternalRenderItems(e,t,i):e instanceof Yt?e===this.map.ground&&IV(i,eh):this._externalToInternalRenderItems(e,t,i)})):IV(i,e.uid),i):i}_viewingModeToManifold(e){switch(e){case 1:return"spherical";case 2:return"planar"}}_initBasemapTerrain(e){this._set("basemapTerrain",new YD({view:this,manifold:this._viewingModeToManifold(e)})),this._set("elevationProvider",new LR({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(e){this._initCoordinateSystem(e),this.state.init(e,this.spatialReference),this._initBasemapTerrain(e),this._set("pointsOfInterest",new NM({view:this})),this._set("featureTiles",new SP({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler}));const t=()=>{const e=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=Ji(this.basemapTerrain.extent,this.basemapTerrain.spatialReference);this.clippingArea?this.featureTiles.filterExtent=e.intersection(this.clippingArea):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(xc,"FEATURE_TILE_TREE_SHOW_TILES",(e=>{e&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import("../chunks/FeatureTileTree3DDebugger.js")).then((({FeatureTileTree3DDebugger:e})=>{!this.featureTreeDebugger&&xc.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new e({view:this}))})):e||!this.featureTreeDebugger||xc.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)}),3),this.updatingHandles.add(this,"clippingArea",t,3),this.updatingHandles.add(this,"basemapTerrain.extent",t,3)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(e){if(this.spatialReference){const t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new GR(this.map,t));const i=1===e,r=i?ei(t):t;r!==this.renderSpatialReference&&(this._set("renderCoordsHelper",YR.createMode(e,r)),i||this.handles.add(this.watch("basemapTerrain.extent",(e=>{0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||(this.renderCoordsHelper.extent=e)}),!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(ih.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(){this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.handles.add([e.watch(["updating","updatingProgress"],(()=>this.updatingChanged()),!0)],"updatingMonitors"),e.when((()=>this.updatingChanged()),(()=>this.updatingChanged())))})),this.updatingChanged()}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return;const i=e.getContext("2d");i.putImageData(t,0,0),this.overlay.renderCanvas(e);const r=i.getImageData(0,0,t.width,t.height);for(let e=0;e<r.data.length;e++)t.data[e]=r.data[e]}_initStage(e){const t={renderContext:this.renderContext,deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,viewingMode:e,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(e,t)=>this._renderScreenshotOverlay(e,t)}},i=new TR(e,{forEachLayer:e=>{this._stage.getLayers().forEach(e)}},this);this._set("sceneIntersectionHelper",i);const r=Fs(this.surface);this._stage=new RV({scheduler:this.resourceController.scheduler,viewingMode:e,container:r,options:t,sceneIntersectionHelper:i}),this._lostWebGLContextHandle=J(this._stage.renderView.getCanvas(),"webglcontextlost",(()=>this.fatalError=new ee("webgl-context-lost"))),this.handles.add([this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",(()=>{this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})}),2),this.updatingHandles.add(this.qualitySettings,"orderIndependentTransparencyEnabled",(()=>{this._stage.renderView.setRenderParameters({orderIndependentTransparencyEnabled:this.qualitySettings.orderIndependentTransparencyEnabled})}),2),hi(this,"magnifier",(e=>this._stage.renderView.magnifier=e),!0)],"stage");const s=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:jR.toEngineOptions(this.highlightOptions)})};for(const e of["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity"])this.handles.add(this.updatingHandles.add(this,e,s),"stage");s(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(ih.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.getCanvas())}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this._initStage(e),this._initGlobe(e),this.sharedSymbolResources=new rM({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new VT})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=z();const e=()=>{this._createGraphicsViewController=null,this.updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this.updatingChanged()}async _createGraphicsViewAsync(e){const t=(await import("../chunks/GraphicsView3D.js")).default;q(e),await fi(this.basemapTerrain,"ready",e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),h(this.graphicsView)&&(this.handles.remove(this.graphicsView.mockLayerId),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=uu(this.viewingMode);if(1===e&&(this._clippingArea=null),this._set("ready",!0),this._initSurface(e),this.handles.add(ci(this,"graphics","after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const e=this.get("map.initialViewProperties.environment");e&&(this.environment=e)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(eh);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(eh);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid)}}};function IV(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}e([S()],EV.prototype,"_resourceController",void 0),e([S()],EV.prototype,"_stage",void 0),e([S({readOnly:!0})],EV.prototype,"deconflictor",void 0),e([S({readOnly:!0})],EV.prototype,"labeler",void 0),e([S({type:ln,readOnly:!0,aliasOf:"state.animation"})],EV.prototype,"animation",void 0),e([S({readOnly:!0})],EV.prototype,"basemapTerrain",void 0),e([S({readOnly:!0})],EV.prototype,"elevationProvider",void 0),e([S({type:Dt,aliasOf:"stateManager.camera"})],EV.prototype,"camera",void 0),e([S({readOnly:!0})],EV.prototype,"canvas",void 0),e([S({type:_e,aliasOf:"stateManager.center"})],EV.prototype,"center",void 0),e([S({type:Pe,dependsOn:["map.clippingArea?","map.clippingEnabled?","viewingMode"],autoTracked:!1})],EV.prototype,"clippingArea",null),e([S({type:Vu})],EV.prototype,"constraints",void 0),e([S({type:Pe,dependsOn:["basemapTerrain.extent","clippingArea","map"],autoTracked:!1,readOnly:!0})],EV.prototype,"dataExtent",null),e([S({value:null,type:Hu})],EV.prototype,"environment",null),e([de("environment")],EV.prototype,"castEnvironment",null),e([S({readOnly:!0})],EV.prototype,"environmentManager",void 0),e([S({type:Pe,aliasOf:"stateManager.extent"})],EV.prototype,"extent",void 0),e([S({readOnly:!0,aliasOf:"stateManager.screenCenter"})],EV.prototype,"screenCenter",void 0),e([S({type:Number,dependsOn:["maximumPixelRatio"]})],EV.prototype,"pixelRatio",null),e([S({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"],autoTracked:!1})],EV.prototype,"maximumPixelRatio",null),e([S({aliasOf:"stateManager.frustum"})],EV.prototype,"frustum",void 0),e([S({type:Number,readOnly:!0})],EV.prototype,"fullOpacity",void 0),e([S({readOnly:!0})],EV.prototype,"graphicsView",void 0),e([S({type:Pe,dependsOn:["basemapTerrain.extent"],autoTracked:!1,readOnly:!0})],EV.prototype,"groundExtent",null),e([S()],EV.prototype,"groundView",void 0),e([S({type:Boolean,dependsOn:["stateManager.hasInitialView"]})],EV.prototype,"initialExtentRequired",null),e([S({type:Boolean,dependsOn:["navigating","activeTool"],readOnly:!0})],EV.prototype,"interacting",null),e([S({dependsOn:["animation","resizing","state.stationary"]})],EV.prototype,"stationary",null),e([S({aliasOf:"state.navigating"})],EV.prototype,"navigating",void 0),e([S()],EV.prototype,"map",void 0),e([S({readOnly:!0})],EV.prototype,"mapCoordsHelper",void 0),e([S({aliasOf:"stateManager.padding"})],EV.prototype,"padding",void 0),e([S({type:NM,readOnly:!0})],EV.prototype,"pointsOfInterest",void 0),e([S({type:SP,readOnly:!0})],EV.prototype,"featureTiles",void 0),e([S()],EV.prototype,"featureTreeDebugger",void 0),e([S({type:Boolean})],EV.prototype,"screenSizePerspectiveEnabled",void 0),e([S({constructOnly:!0})],EV.prototype,"deactivatedWebGLExtensions",void 0),e([S({constructOnly:!0})],EV.prototype,"debugWebGLExtensions",void 0),e([S({constructOnly:!0})],EV.prototype,"renderCanvas",void 0),e([S({constructOnly:!0})],EV.prototype,"state",void 0),e([S({readOnly:!0})],EV.prototype,"inputManager",void 0),e([S({readOnly:!0})],EV.prototype,"stateManager",void 0),e([S({type:["low","medium","high"]})],EV.prototype,"qualityProfile",null),e([S({type:QR,get(){let e=this._get("qualitySettings");return e||(e=new QR,UR.apply(this.qualityProfile,e)),e}})],EV.prototype,"qualitySettings",void 0),e([S()],EV.prototype,"slicePlane",null),e([S({dependsOn:["viewingMode"],autoTracked:!1})],EV.prototype,"preconditionsReady",void 0),e([S({readOnly:!0})],EV.prototype,"renderCoordsHelper",void 0),e([S({readOnly:!0})],EV.prototype,"sceneIntersectionHelper",void 0),e([S({type:Number,dependsOn:["scale","spatialReference"],autoTracked:!1,readOnly:!0})],EV.prototype,"resolution",null),e([S({type:Number,aliasOf:"stateManager.scale"})],EV.prototype,"scale",void 0),e([S({dependsOn:[],autoTracked:!1})],EV.prototype,"heightModelInfo",null),e([S({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"],autoTracked:!1})],EV.prototype,"spatialReference",void 0),e([S({type:Boolean,constructOnly:!0})],EV.prototype,"alphaCompositingEnabled",void 0),e([S({type:Boolean})],EV.prototype,"supersampleScreenhotsEnabled",void 0),e([S({readOnly:!0})],EV.prototype,"type",void 0),e([S({type:DV})],EV.prototype,"ui",void 0),e([S({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","_resourceController.updating","_stage.renderView.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs"],autoTracked:!1})],EV.prototype,"updating",null),e([S({type:Number,readOnly:!0,dependsOn:["updating"],autoTracked:!1})],EV.prototype,"updatingProgress",void 0),e([S({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"],autoTracked:!1})],EV.prototype,"viewingMode",null),e([S({type:li,aliasOf:"stateManager.viewpoint"})],EV.prototype,"viewpoint",void 0),e([S({type:Number,aliasOf:"stateManager.zoom"})],EV.prototype,"zoom",void 0),e([S({type:jR})],EV.prototype,"highlightOptions",void 0),EV=e([re("esri.views.SceneView")],EV);const LV=je(),FV=Vt();var VV=EV;export default VV;export{pE as A,mE as B,BT as F,dT as G,qM as L,nE as O,jp as S,ZM as T,ER as V,Xx as a,Db as b,Gu as c,Yx as d,pT as e,Ib as f,Bx as g,oE as h,Nx as i,jw as j,yE as k,hE as l,Mb as m,gE as n,sI as o,kp as p,lE as q,gP as r,fE as s,vP as t,WM as u,Fb as v,Vb as w,cE as x,uE as y,dE as z};
