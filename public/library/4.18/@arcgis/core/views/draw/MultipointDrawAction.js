/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../chunks/ArrayPool.js";import"../../chunks/object.js";import"../../chunks/deprecate.js";import"../../core/lang.js";import"../../config.js";import{i as t}from"../../chunks/Logger.js";import"../../chunks/string.js";import"../../chunks/metadata.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import"../../core/Accessor.js";import"../../chunks/PropertyOrigin.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../chunks/Message.js";import"../../core/Error.js";import"../../chunks/ensureType.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import"../../chunks/Evented.js";import"../../core/Collection.js";import"../../core/urlUtils.js";import"../../chunks/resourceExtension.js";import"../../chunks/screenUtils.js";import r from"../../core/Handles.js";import"../../chunks/Queue.js";import{V as o}from"../../chunks/InputManager.js";import{c as n}from"../../chunks/screenUtils2.js";import h from"./DrawAction.js";import{V as d,a as c,b as v,K as p,C as a,D as u}from"../../chunks/Keys.js";let l=class extends h{constructor(e){super(e),this._cursorMoved=!1,this._cursorScreenPoint=null,this._dragEnabled=!0,this._pointerDownEvent=null,this._viewHandles=new r,this.vertices=[]}initialize(){this._addViewHandles()}destroy(){this._removeViewHandles(),this._viewHandles.destroy(),this.emit("destroy")}addVertex(e,t){isNaN(t)?(t=this.vertices.length,this.vertices.push(e)):this.vertices.splice(t,0,e);const s={vertex:e,vertexIndex:t,undo:()=>this._undoVertexAdd(null,t),redo:()=>this._redoVertexAdd(null,e,t)};this.history.push(s),this._set("redoHistory",[]);const i=new d(this.view,null,t,this.vertices);this.emit("vertex-add",i),i.defaultPrevented&&(this._cursorMoved=!0,this.history.pop())}removeVertex(e){const t=this.vertices.splice(e,1)[0],s={vertex:t,vertexIndex:e,undo:()=>this._undoVertexRemove(null,t,e),redo:()=>this._redoVertexRemove(null,e)};this.history.push(s),this._set("redoHistory",[]),this.emit("vertex-remove",new c(this.view,null,e,this.vertices))}updateVertex(e,t){const s=this.vertices[t];this.vertices[t]=e;const i={vertex:e,vertexIndex:t,undo:()=>this._undoVertexUpdate(null,s,t),redo:()=>this._redoVertexUpdate(null,e,t)};this.history.push(i),this._set("redoHistory",[]),this.emit("vertex-update",new v(this.view,null,t,this.vertices))}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this._viewHandles.add([this.view.on("click",(e=>{e.stopPropagation()}),o.TOOL),this.view.on("pointer-down",(e=>{this._cursorMoved&&this.vertices.pop(),this._pointerDownEvent=e,this._cursorMoved=!1,this._cursorScreenPoint=n(e)}),o.TOOL),this.view.on("pointer-move",(e=>{this._cursorMoved&&this.vertices.pop(),this._cursorMoved=!0,this._cursorScreenPoint=n(e),this._cursorUpdateHandler(e)}),o.TOOL),this.view.on("pointer-up",(e=>{if(this._pointerDownEvent){if(this._cursorMoved)return this.vertices.pop(),void(this._cursorMoved=!1);this._pointerDownEvent=null,this._vertexAddHandler(e)}}),o.TOOL),this.view.on("drag",(e=>{this._dragEnabled&&this._pointerDownEvent&&e.stopPropagation()}),o.TOOL),this.view.on("drag",["Shift"],(e=>{e.stopPropagation()}),o.TOOL),this.view.on("double-click",(e=>{e.stopPropagation(),this._drawCompleteHandler(e)}),o.TOOL),this.view.on("double-click",["Control"],(e=>{e.stopPropagation(),this._drawCompleteHandler(e)}),o.TOOL),this.view.on("key-down",(e=>{e.key===p.vertexAddKey&&!e.repeat&&this._cursorScreenPoint?(this._cursorMoved&&(this.vertices.pop(),this._cursorMoved=!1),this._vertexAddHandler(e)):e.key===p.drawCompleteKey&&!e.repeat&&this._cursorScreenPoint?(this._cursorMoved&&(this.vertices.pop(),this._cursorMoved=!1),this._vertexAddHandler(e),this._drawCompleteHandler(e)):e.key!==p.undoKey||this.interactiveUndoDisabled||e.repeat?e.key!==p.redoKey||this.interactiveUndoDisabled||e.repeat||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo())}),o.TOOL)])}_removeViewHandles(){this._viewHandles.removeAll()}_addVertex(e,t){this.vertices.push(e);const s=this.vertices.indexOf(e),i={vertex:e,vertexIndex:s,undo:()=>this._undoVertexAdd(t,s),redo:()=>this._redoVertexAdd(t,e,s)};this.history.push(i),this._set("redoHistory",[]);const r=new d(this.view,t,s,this.vertices);this.emit("vertex-add",r),r.defaultPrevented&&(this._cursorMoved=!0,this.history.pop())}_updateCursor(e,t){this.vertices.push(e);const s=this.vertices.indexOf(e),i=new a(this.view,t,s,this.vertices);this.emit("cursor-update",i)}_completeDrawing(e){if(this._cursorMoved=!1,this._pointerDownEvent=null,this.vertices.length<1)return;const t=new u(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented?this._cursorMoved=!0:this._removeViewHandles()}_undoVertexAdd(e,t){this.vertices.splice(t,1),this.emit("undo",new c(this.view,e,t,this.vertices))}_redoVertexAdd(e,t,s){this.vertices.splice(s,0,t),this.emit("redo",new d(this.view,e,s,this.vertices))}_undoVertexRemove(e,t,s){this.vertices.splice(s,0,t),this.emit("undo",new d(this.view,e,s,this.vertices))}_redoVertexRemove(e,t){this.vertices.splice(t,1),this.emit("redo",new c(this.view,e,t,this.vertices))}_undoVertexUpdate(e,t,s){this.vertices[s]=t,this.emit("undo",new v(this.view,e,s,this.vertices))}_redoVertexUpdate(e,t,s){this.vertices[s]=t,this.emit("redo",new v(this.view,e,s,this.vertices))}_vertexAddHandler(e){const s=this.getCoordsFromScreenPoint(this._cursorScreenPoint);t(s)&&this._addVertex(s,e.native)}_cursorUpdateHandler(e){const s=this.getCoordsFromScreenPoint(this._cursorScreenPoint);t(s)&&this._updateCursor(s,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}};e([s({readOnly:!0})],l.prototype,"vertices",void 0),l=e([i("esri.views.draw.MultipointDrawAction")],l);export{l as MultipointDrawAction};
