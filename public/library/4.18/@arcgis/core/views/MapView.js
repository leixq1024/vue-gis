/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import"../chunks/ArrayPool.js";import{h as e}from"../chunks/object.js";import"../chunks/deprecate.js";import"../core/lang.js";import"../config.js";import{i,L as s,b as o}from"../chunks/Logger.js";import"../chunks/string.js";import"../chunks/metadata.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import n from"../core/Accessor.js";import"../chunks/PropertyOrigin.js";import{addFrameTask as r}from"../core/scheduling.js";import{reject as p,create as h,throwIfAborted as l,c,resolve as m,all as d}from"../core/promiseUtils.js";import"../chunks/Message.js";import u from"../core/Error.js";import"../chunks/compilerUtils.js";import"../chunks/ensureType.js";import{subclass as g}from"../core/accessorSupport/decorators/subclass.js";import{E as y}from"../chunks/Evented.js";import w from"../core/Collection.js";import"../chunks/collectionUtils.js";import"../chunks/JSONSupport.js";import"../chunks/Promise.js";import"../chunks/Loadable.js";import"../chunks/asyncUtils.js";import"../chunks/loadAll.js";import"../core/urlUtils.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/jsonMap.js";import"../chunks/enumeration.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../chunks/resourceExtension.js";import"../chunks/persistableUrlUtils.js";import v from"../geometry/SpatialReference.js";import"../chunks/locale.js";import"../chunks/number.js";import"../intl.js";import"../kernel.js";import"../request.js";import"../chunks/assets.js";import"../geometry/Geometry.js";import f from"../geometry/Point.js";import"../chunks/Ellipsoid.js";import{canProject as _,project as j}from"../geometry/support/webMercatorUtils.js";import k,{e as b,p as S}from"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../portal/PortalItem.js";import"../Basemap.js";import"../chunks/writeUtils.js";import"../chunks/mathUtils2.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../chunks/vec3.js";import"../chunks/mathUtils.js";import"../Camera.js";import"../chunks/colorUtils.js";import T from"../Color.js";import"../chunks/zmUtils.js";import"../geometry/Multipoint.js";import V,{p as D}from"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/domains.js";import"../chunks/arcadeOnDemand.js";import"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"../chunks/date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"../chunks/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"../chunks/Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import{c as x}from"../chunks/screenUtils.js";import"../chunks/opacityUtils.js";import"../chunks/materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/utils.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"../chunks/colors.js";import"../chunks/Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"../chunks/Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../chunks/Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../chunks/urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols/support/jsonUtils.js";import"../chunks/uid.js";import M from"../Graphic.js";import"../Ground.js";import O from"../core/Handles.js";import{C as R}from"../chunks/CollectionFlattener.js";import"../chunks/basemapUtils.js";import"../Map.js";import"../layers/Layer.js";import"../chunks/TablesMixin.js";import"../chunks/unitUtils.js";import"../geometry/support/normalizeUtils.js";import"../chunks/timeUtils.js";import"../TimeExtent.js";import C from"../Viewpoint.js";import{whenTrueOnce as z,init as P,whenNot as I,when as L}from"../core/watchUtils.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/fieldType.js";import E from"../webmap/background/ColorBackground.js";import"../geometry/HeightModelInfo.js";import"../chunks/mat4.js";import"../chunks/pe.js";import"../chunks/aaBoundingRect.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformationStep.js";import"../geometry/support/GeographicTransformation.js";import{isLoaded as N,project as U}from"../geometry/projection.js";import"../chunks/heightModelInfoUtils.js";import"../core/HandleOwner.js";import"../core/workers/Connection.js";import"../chunks/Scheduler.js";import{initialize as Z}from"../core/workers/workers.js";import{t as A}from"../chunks/screenshotUtils.js";import"../chunks/mat3.js";import{d as G,s as F,a as q,c as H}from"../chunks/vec2.js";import"../chunks/domUtils.js";import"../chunks/widgetUtils.js";import"../chunks/projector.js";import"../chunks/accessibleHandler.js";import"../chunks/messageBundle.js";import"../chunks/renderable.js";import"../chunks/vmEvent.js";import"../chunks/index.js";import"../widgets/support/widget.js";import"../widgets/Widget.js";import B from"../layers/support/LOD.js";import K from"../layers/support/TileInfo.js";import"../chunks/zscale.js";import"../chunks/queryZScale.js";import"../layers/support/Field.js";import"../tasks/support/FeatureSet.js";import"../chunks/DataLayerSource.js";import"../tasks/support/AttachmentQuery.js";import"../tasks/support/Query.js";import"../tasks/support/StatisticDefinition.js";import"../tasks/support/RelationshipQuery.js";import"../chunks/GraphicsCollection.js";import"../tasks/Task.js";import"../chunks/OptimizedGeometry.js";import"../chunks/featureConversionUtils.js";import"../tasks/QueryTask.js";import"../chunks/pbf.js";import"../chunks/pbfQueryUtils.js";import"../chunks/query.js";import"../layers/support/AttachmentInfo.js";import"./BasemapView.js";import{s as W}from"../chunks/MapUtils.js";import $ from"./View.js";import"../chunks/RefreshableLayerView.js";import"../chunks/Queue.js";import{I as Y,a as Q,V as X}from"../chunks/InputManager.js";import{D as J}from"../chunks/interactiveToolUtils.js";import"../chunks/throttle.js";import"../widgets/Attachments.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../widgets/Feature/FeatureViewModel.js";import"../widgets/Feature.js";import"../chunks/AnchorElementViewModel.js";import"../widgets/Spinner/SpinnerViewModel.js";import"../widgets/Popup.js";import"../chunks/layerViewUtils.js";import"../chunks/actions.js";import"../chunks/GoTo.js";import"../widgets/Popup/PopupViewModel.js";import{i as tt,a as et}from"../chunks/screenUtils2.js";import"./input/gamepad/GamepadInputDevice.js";import"./input/gamepad/GamepadSettings.js";import"./input/Input.js";import"./navigation/gamepad/GamepadSettings.js";import"./navigation/Navigation.js";import"../chunks/TileKey.js";import{e as it,p as st}from"../chunks/unitBezier.js";import"../chunks/capabilities2.js";import"../chunks/mat2d.js";import"../chunks/mat2df32.js";import"../chunks/vec2f32.js";import{P as ot,e as at,D as nt,r as rt,a as pt,i as ht,b as lt,B as ct,I as mt,S as dt,c as ut,d as gt,f as yt,g as wt}from"../chunks/WebGLRequirements.js";import vt from"./ViewAnimation.js";import"../chunks/mat2df64.js";import{c as ft}from"../chunks/vec2f64.js";import{c as _t,a as jt,b as kt,s as bt,r as St,d as Tt,e as Vt,f as Dt,g as xt,t as Mt,h as Ot}from"../chunks/viewpointUtils.js";import"../chunks/mat3f32.js";import Rt from"./2d/ViewState.js";import"../chunks/QueueProcessor.js";import"../chunks/TileStrategy.js";import{T as Ct}from"../chunks/TileInfoView.js";import{m as zt,P as Pt}from"../chunks/PointerClickHoldAndDrag.js";import"./ui/UI.js";import"../widgets/Attribution/AttributionViewModel.js";import"../widgets/Attribution.js";import"../widgets/Compass/CompassViewModel.js";import"../widgets/Compass.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/NavigationToggle.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";import It from"./ui/DefaultUI.js";class Lt{constructor(t,e,i,s){const o=t.targetGeometry,a=e.targetGeometry;s?"string"==typeof s&&(s=st(s)||it.ease):s=it.ease,this.easing=s,this.duration=i,this.sCenterX=o.x,this.sCenterY=o.y,this.sScale=t.scale,this.sRotation=t.rotation,this.tCenterX=a.x,this.tCenterY=a.y,this.tScale=e.scale,this.tRotation=e.rotation,this.dCenterX=this.tCenterX-this.sCenterX,this.dCenterY=this.tCenterY-this.sCenterY,this.dScale=this.tScale-this.sScale,this.dRotation=this.tRotation-this.sRotation,this.dRotation>180?this.dRotation-=360:this.dRotation<-180&&(this.dRotation+=360)}applyRatio(t,e){const i=this.easing(e);let s,o,a,n;e>=1?(s=this.tCenterX,o=this.tCenterY,a=this.tRotation,n=this.tScale):(s=this.sCenterX+i*this.dCenterX,o=this.sCenterY+i*this.dCenterY,a=this.sRotation+i*this.dRotation,n=this.sScale+i*this.dScale),t.targetGeometry.x=s,t.targetGeometry.y=o,t.scale=n,t.rotation=a}}let Et=class extends n{constructor(t){super(t),this.duration=200,this.transition=null,this.easing=it.ease,this.view=null,this.viewpoint=null,this.viewpoint=new C({targetGeometry:new f,scale:0,rotation:0}),this._updateTask=r({postRender:this._postRender.bind(this)}),this._updateTask.pause()}destroy(){this._updateTask.remove(),this._updateTask=null}animate(t,e,i){this.stop();const s=this.viewpoint;_t(s,e),this.transition=new Lt(this.viewpoint,t.target,i&&i.duration||this.duration,i&&i.easing||this.easing);const o=()=>{this.animation===t&&this._updateTask&&("finished"===t.state&&(this.transition.applyRatio(this.viewpoint,1),this.view.state&&(this.view.state.viewpoint=this.viewpoint.clone())),this.animation=null,this.updateFunction=null)};return t.when(o,o),this._startTime=performance.now(),this._updateTask.resume(),this.animation=t,t}animateContinous(t,e){this.stop(),this.updateFunction=e,this.viewpoint=t;const i=new vt({target:t.clone()}),s=()=>{this.animation===i&&this._updateTask&&(this.animation=null,this.updateFunction=null)};return i.when(s,s),this._startTime=performance.now(),this._updateTask.resume(),this.animation=i,i}stop(){this.animation&&(this.animation.stop(),this.animation=null,this.updateFunction=null)}_postRender(t){const e=this.animation;if(e&&e.state!==vt.State.STOPPED){if(this.updateFunction)this.updateFunction(this.viewpoint,t.deltaTime);else{const t=(performance.now()-this._startTime)/this.transition.duration,e=t>=1;this.transition.applyRatio(this.viewpoint,t),e&&this.animation.finish()}this.view.state&&(this.view.state.viewpoint=this.viewpoint.clone())}else this._updateTask.pause()}};t([a()],Et.prototype,"animation",void 0),t([a()],Et.prototype,"duration",void 0),t([a()],Et.prototype,"transition",void 0),t([a()],Et.prototype,"easing",void 0),t([a()],Et.prototype,"view",void 0),t([a()],Et.prototype,"viewpoint",void 0),Et=t([g("esri.views.2d.AnimationManager")],Et);var Nt=Et;class Ut{constructor(t){this.view=t,this._frameTaskHandle=null,this._updateRequested=!1,this.stationary=!0,this.updateEnabled=!0,this.animationInProgress=!1,this.prepare=()=>{this._updateParameters.state=this.view.state,this._updateParameters.stationary=this.view.stationary,this._updateParameters.pixelRatio=window.devicePixelRatio,this._updateParameters.renderingOptions=this.view.renderingOptions},this.update=()=>{if(this._updateRequested=!1,!this.updateEnabled)return;const{basemapView:t,graphicsView:e,labelManager:s,layerViews:o,state:{id:a}}=this.view;t.baseLayerViews.forEach(this._updateLayerView,this),o.forEach(this._updateLayerView,this),t.referenceLayerViews.forEach(this._updateLayerView,this),i(s)&&(s.lastUpdateId!==a&&(s.viewChange(),s.lastUpdateId=a),s.updateRequested&&s.processUpdate(this._updateParameters)),i(e)&&(e.lastUpdateId!==a&&(e.viewChange(),e.lastUpdateId=a),e.updateRequested&&e.processUpdate(this._updateParameters)),this.animationInProgress||this._updateRequested||this._frameTaskHandle.pause()}}destroy(){this.stop()}start(){this.stationary=this.view.stationary,this._updateParameters={state:this.view.state,pixelRatio:window.devicePixelRatio,stationary:this.stationary,renderingOptions:this.view.renderingOptions},this._stationaryHandle=this.view.watch("stationary",(t=>{this.stationary=t,this.requestFrame()})),this._frameTaskHandle=r(this)}stop(){this._frameTaskHandle&&(this._stationaryHandle.remove(),this._frameTaskHandle.remove(),this._updateParameters=this._stationaryHandle=this._frameTaskHandle=null,this.stationary=!0,this.animationInProgress=!1)}requestUpdate(){this._updateRequested||(this._updateRequested=!0,this.requestFrame())}requestFrame(){this._frameTaskHandle&&this._frameTaskHandle.resume()}_updateLayerView(t){const e=this.view.state,i=t.lastUpdateId;null!=i&&(this.stationary||t.moving)||(t.moving=!0,t.moveStart()),i!==e.id&&t.viewChange(),this.stationary&&t.moving&&(t.moving=!1,t.moveEnd()),t.lastUpdateId=e.id,t.updateRequested&&t.processUpdate(this._updateParameters),"layerViews"in t&&t.layerViews.forEach(this._updateLayerView,this)}}function Zt(){return Promise.all([import("../chunks/webgl.js"),import("../chunks/mapViewDeps.js")])}const At=()=>Zt().then((()=>import("../chunks/TileLayerView2D.js"))),Gt=()=>Zt().then((()=>import("../chunks/FeatureLayerView2D.js"))),Ft={"base-dynamic":()=>Zt().then((()=>import("../chunks/BaseDynamicLayerView2D.js"))),"base-tile":At,"bing-maps":At,csv:Gt,"geo-rss":()=>Zt().then((()=>import("../chunks/GeoRSSLayerView2D.js"))),feature:Gt,geojson:Gt,graphics:()=>Zt().then((()=>import("../chunks/GraphicsLayerView2D.js"))),group:()=>Zt().then((()=>import("../chunks/GroupLayerView2D.js"))),imagery:()=>Zt().then((()=>import("../chunks/ImageryLayerView2D.js"))),"imagery-tile":()=>Zt().then((()=>import("../chunks/ImageryTileLayerView2D.js"))),kml:()=>Zt().then((()=>import("../chunks/KMLLayerView2D.js"))),"map-image":()=>Zt().then((()=>import("../chunks/MapImageLayerView2D.js"))),"map-notes":()=>Zt().then((()=>import("../chunks/MapNotesLayerView2D.js"))),"ogc-feature":Gt,"open-street-map":At,route:()=>Zt().then((()=>import("../chunks/RouteLayerView2D.js"))),stream:()=>Zt().then((()=>import("../chunks/StreamLayerView2D.js"))),tile:At,"vector-tile":()=>Zt().then((()=>import("../chunks/VectorTileLayerView2D.js"))),wcs:()=>Zt().then((()=>import("../chunks/ImageryTileLayerView2D.js"))),"web-tile":At,wms:()=>Zt().then((()=>import("../chunks/WMSLayerView2D.js"))),wmts:()=>Zt().then((()=>import("../chunks/WMTSLayerView2D.js"))),"base-elevation":null,"building-scene":null,elevation:null,"integrated-mesh":null,"point-cloud":null,scene:null,unknown:null,unsupported:null};const qt=t=>i(Ft[t.type]),Ht=t=>{const e=Ft[t.type];if(!i(e))throw function(t){const e=t.declaredClass?t.declaredClass.slice(t.declaredClass.lastIndexOf(".")+1):"Unknown",i=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new u(`${i}:view-not-supported`,`${e} is not supported in 2D`)}(t);return e(t)};var Bt;const Kt=s.getLogger("esri.views.MapView");let Wt=Bt=class extends n{constructor(t){super(t),this.geometry=null,this.spatialReference=null}get normalizedGeometry(){return this.geometry&&this.spatialReference?this.spatialReference.equals(this.geometry.spatialReference)?this.geometry:_(this.geometry,this.spatialReference)?j(this.geometry,this.spatialReference):N()?U(this.geometry,this.spatialReference):(Kt.error("#constraints.geometry","unsupported coordinate system. The source geometry cannot be projected to the view's coordinate system. The projection engine cannot be loaded.",{geometry:this.geometry}),null):null}constrain(t,e){if(!this.normalizedGeometry)return t;const i=t.targetGeometry;if("extent"===this.normalizedGeometry.type?b(this.normalizedGeometry,i):S(this.normalizedGeometry,i))return t;const{coordinate:s}=function(t,e){const{spatialReference:i}=e,s=[e.x,e.y];let o=Number.POSITIVE_INFINITY,a=0,n=0;const r=[0,0],p="extent"===t.type?[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]:t.rings;for(const t of p)for(let e=0;e<t.length-1;e++){D(r,s,t,e);const i=G(s,r);i<o&&(o=i,a=r[0],n=r[1])}return{coordinate:new f({x:a,y:n,spatialReference:i}),distance:o}}(this.normalizedGeometry,i);return s?(t.targetGeometry=s,t):t}clone(){var t,e;return new Bt({geometry:null==(t=this.geometry)?void 0:t.clone(),spatialReference:null==(e=this.spatialReference)?void 0:e.clone()})}};var $t;t([a({constructOnly:!0})],Wt.prototype,"geometry",void 0),t([a({readOnly:!0,dependsOn:["geometry","spatialReference"]})],Wt.prototype,"normalizedGeometry",null),t([a({constructOnly:!0})],Wt.prototype,"spatialReference",void 0),Wt=Bt=t([g("esri.views.2d.constraints.GeometryConstraint")],Wt);let Yt=$t=class extends n{constructor(){super(...arguments),this.enabled=!0,this.rotationEnabled=!0}constrain(t,e){return this.enabled&&e?(this.rotationEnabled||(t.rotation=e.rotation),t):t}clone(){return new $t({enabled:this.enabled,rotationEnabled:this.rotationEnabled})}};t([a()],Yt.prototype,"enabled",void 0),t([a()],Yt.prototype,"rotationEnabled",void 0),Yt=$t=t([g("esri.views.2d.constraints.RotationConstraint")],Yt);var Qt,Xt=Yt;let Jt=Qt=class extends n{constructor(t){super(t),this._lodByScale={},this._scales=[],this.effectiveLODs=null,this.effectiveMinZoom=-1,this.effectiveMaxZoom=-1,this.effectiveMinScale=0,this.effectiveMaxScale=0,this.lods=null,this.minZoom=-1,this.maxZoom=-1,this.minScale=0,this.maxScale=0,this.snapToZoom=!0}initialize(){let t,{lods:e,minScale:i,maxScale:s,minZoom:o,maxZoom:a}=this,n=-1,r=-1,p=!1,h=!1;if(0!==i&&0!==s&&i<s&&([i,s]=[s,i]),!e||!e.length)return this._set("effectiveMinScale",i),void this._set("effectiveMaxScale",s);e=e.map((t=>t.clone())),e.sort(((t,e)=>e.scale-t.scale)),e.forEach(((t,e)=>t.level=e));for(const o of e)!p&&i>0&&i>=o.scale&&(n=o.level,p=!0),!h&&s>0&&s>=o.scale&&(r=t?t.level:-1,h=!0),t=o;-1===o&&(o=0===i?0:n),-1===a&&(a=0===s?e.length-1:r),o=Math.max(o,0),o=Math.min(o,e.length-1),a=Math.max(a,0),a=Math.min(a,e.length-1),o>a&&([o,a]=[a,o]),i=e[o].scale,s=e[a].scale,e.splice(0,o),e.splice(a-o+1,e.length),e.forEach(((t,e)=>{this._lodByScale[t.scale]=t,this._scales[e]=t.scale})),this._set("effectiveLODs",e),this._set("effectiveMinZoom",o),this._set("effectiveMaxZoom",a),this._set("effectiveMinScale",i),this._set("effectiveMaxScale",s)}constrain(t,e){if(e&&t.scale===e.scale)return t;const i=this.effectiveMinScale,s=this.effectiveMaxScale,o=t.targetGeometry,a=e&&e.targetGeometry,n=0!==s&&t.scale<s,r=0!==i&&t.scale>i;if(n||r){const n=r?i:s;if(a){const i=(n-e.scale)/(t.scale-e.scale);o.x=a.x+(o.x-a.x)*i,o.y=a.y+(o.y-a.y)*i}t.scale=n}return this.snapToZoom&&this.effectiveLODs&&(t.scale=this._getClosestScale(t.scale)),t}fit(t){if(!this.effectiveLODs||!this.snapToZoom)return this.constrain(t,null);const e=this.scaleToZoom(t.scale),i=Math.abs(e-Math.floor(e));return t.scale=this.zoomToScale(i>.99?Math.round(e):Math.floor(e)),t}zoomToScale(t){if(!this.effectiveLODs)return 0;t-=this.effectiveMinZoom,t=Math.max(0,t);const e=this._scales;if(t<=0)return e[0];if(t>=e.length)return e[e.length-1];const i=Math.round(t-.5),s=Math.round(t);return e[s]+(s-t)*(e[i]-e[s])}scaleToZoom(t){if(!this.effectiveLODs)return-1;const e=this._scales;let i,s;if(t>=e[0])return this.effectiveMinZoom;if(t<=e[e.length-1])return this.effectiveMaxZoom;for(let o=0;o<e.length-1;o++){if(i=e[o],s=e[o+1],s===t){return o+this.effectiveMinZoom+1}if(i>t&&s<t){return o+this.effectiveMinZoom+1-(t-s)/(i-s)}}}snapToClosestScale(t){if(!this.effectiveLODs)return t;const e=this.scaleToZoom(t);return this.zoomToScale(Math.round(e))}snapToNextScale(t,e=.5){if(!this.effectiveLODs)return t*e;const i=Math.round(this.scaleToZoom(t));return this.zoomToScale(i+1)}snapToPreviousScale(t,e=2){if(!this.effectiveLODs)return t*e;const i=Math.round(this.scaleToZoom(t));return this.zoomToScale(i-1)}clone(){return new Qt({lods:this.lods,minZoom:this.minZoom,maxZoom:this.maxZoom,minScale:this.minScale,maxScale:this.maxScale})}_getClosestScale(t){return this._lodByScale[t]||(t=this._scales.reduce(((e,i)=>Math.abs(i-t)<=Math.abs(e-t)?i:e),this._scales[0])),this._lodByScale[t].scale}};t([a({readOnly:!0})],Jt.prototype,"effectiveLODs",void 0),t([a({readOnly:!0})],Jt.prototype,"effectiveMinZoom",void 0),t([a({readOnly:!0})],Jt.prototype,"effectiveMaxZoom",void 0),t([a({readOnly:!0})],Jt.prototype,"effectiveMinScale",void 0),t([a({readOnly:!0})],Jt.prototype,"effectiveMaxScale",void 0),t([a({type:[B]})],Jt.prototype,"lods",void 0),t([a()],Jt.prototype,"minZoom",void 0),t([a()],Jt.prototype,"maxZoom",void 0),t([a()],Jt.prototype,"minScale",void 0),t([a()],Jt.prototype,"maxScale",void 0),t([a()],Jt.prototype,"snapToZoom",void 0),Jt=Qt=t([g("esri.views.2d.constraints.ZoomConstraint")],Jt);var te=Jt;const ee={base:null,key:"type",typeMap:{extent:k,polygon:V}};let ie=class extends y.EventedAccessor{constructor(){super(...arguments),this.lods=null,this.minScale=0,this.maxScale=0,this.minZoom=-1,this.maxZoom=-1,this.rotationEnabled=!0,this.snapToZoom=!0}initialize(){this.watch(["_zoom","_rotation"],this.emit.bind(this,"update"),!0)}destroy(){this.view=null,this._set("_zoom",null),this._set("_rotation",null)}set geometry(t){t?this._set("geometry",t):this._set("geometry",null)}get _defaultLODs(){const t=this.get("view.defaultsFromMap.tileInfo"),e=this.get("view.spatialReference");return t&&e&&t.spatialReference.equals(e)?t.lods:null}get _geometry(){return new Wt({geometry:this.geometry,spatialReference:this.view.spatialReference})}get _rotation(){return new Xt({rotationEnabled:this.rotationEnabled})}get _zoom(){return new te({lods:this.lods||this._defaultLODs,minZoom:this.minZoom,maxZoom:this.maxZoom,minScale:this.minScale,maxScale:this.maxScale,snapToZoom:this.snapToZoom})}canZoomInTo(t){const e=this.effectiveMaxScale;return 0===e||t>=e}canZoomOutTo(t){const e=this.effectiveMinScale;return 0===e||t<=e}constrain(t,e){return this._zoom.constrain(t,e),this._rotation.constrain(t,e),this._geometry.constrain(t,e),t}constrainByGeometry(t){return this._geometry.constrain(t)}fit(t){return this._zoom.fit(t)}zoomToScale(t){return this._zoom.zoomToScale(t)}scaleToZoom(t){return this._zoom.scaleToZoom(t)}snapScale(t){return this._zoom.snapToClosestScale(t)}snapToNextScale(t){return this._zoom.snapToNextScale(t)}snapToPreviousScale(t){return this._zoom.snapToPreviousScale(t)}};t([a({readOnly:!0,aliasOf:"_zoom.effectiveLODs"})],ie.prototype,"effectiveLODs",void 0),t([a({readOnly:!0,aliasOf:"_zoom.effectiveMinScale"})],ie.prototype,"effectiveMinScale",void 0),t([a({readOnly:!0,aliasOf:"_zoom.effectiveMaxScale"})],ie.prototype,"effectiveMaxScale",void 0),t([a({readOnly:!0,aliasOf:"_zoom.effectiveMinZoom"})],ie.prototype,"effectiveMinZoom",void 0),t([a({readOnly:!0,aliasOf:"_zoom.effectiveMaxZoom"})],ie.prototype,"effectiveMaxZoom",void 0),t([a({types:ee,value:null})],ie.prototype,"geometry",null),t([a({type:[B]})],ie.prototype,"lods",void 0),t([a()],ie.prototype,"minScale",void 0),t([a()],ie.prototype,"maxScale",void 0),t([a()],ie.prototype,"minZoom",void 0),t([a()],ie.prototype,"maxZoom",void 0),t([a()],ie.prototype,"rotationEnabled",void 0),t([a()],ie.prototype,"snapToZoom",void 0),t([a()],ie.prototype,"view",void 0),t([a({dependsOn:["view.spatialReference","view.defaultsFromMap.tileInfo"]})],ie.prototype,"_defaultLODs",null),t([a({type:Wt,dependsOn:["geometry","view.spatialReference"]})],ie.prototype,"_geometry",null),t([a({type:Xt,dependsOn:["rotationEnabled"]})],ie.prototype,"_rotation",null),t([a({readOnly:!0,type:te,dependsOn:["lods","minZoom","maxZoom","minScale","maxScale","snapToZoom","_defaultLODs"]})],ie.prototype,"_zoom",null),ie=t([g("esri.views.2d.MapViewConstraints")],ie);var se=ie;let oe=class extends n{constructor(){super(...arguments),this.left=0,this.top=0,this.right=0,this.bottom=0}};t([a()],oe.prototype,"left",void 0),t([a()],oe.prototype,"top",void 0),t([a()],oe.prototype,"right",void 0),t([a()],oe.prototype,"bottom",void 0),oe=t([g("esri.views.2d.PaddedViewState.Padding")],oe);let ae=class extends Rt{constructor(...t){super(...t),this.paddedViewState=new Rt,this._updateContent=(()=>{const t=ft();return()=>{const e=this._get("size"),i=this._get("padding");if(!e||!i)return;const s=this.paddedViewState;F(t,i.left+i.right,i.top+i.bottom),q(t,e,t),H(s.size,t);const o=s.viewpoint;o&&(this.viewpoint=o)}})(),this.watch(["size","padding"],this._updateContent,!0),this.padding=new oe,this.size=[0,0]}set padding(t){this._set("padding",t||new oe)}set viewpoint(t){if(t){const e=t.clone();this.paddedViewState.viewpoint=t,jt(e,t,this._get("size"),this._get("padding"));const i=this._viewpoint2D,s=e.targetGeometry;i.center[0]=s.x,i.center[1]=s.y,i.rotation=e.rotation,i.scale=e.scale,i.spatialReference=s.spatialReference,this._update()}}};t([a()],ae.prototype,"paddedViewState",void 0),t([a({type:oe})],ae.prototype,"padding",null),t([a()],ae.prototype,"viewpoint",null),ae=t([g("esri.views.2d.PaddedViewState")],ae);var ne=ae;class re{constructor(){this._names=new Map}begin(t){this._names.has(t)||(this._names.set(t,!1),(t=>-1!==t.indexOf("Brush"))(t)&&this.record("Esri.FirstDraw"),performance.mark(`Esri.${t}.Start`))}end(t){this._names.has(t)&&!this._names.get(t)&&(this._names.set(t,!0),performance.mark(`Esri.${t}.End`))}record(t){this._names.has(t)||(this._names.set(t,!0),performance.mark(`Esri.${t}`))}}const pe=s.getLogger("esri.views.MapView");let he=class extends(ot($)){constructor(t){super(t),this._stationaryTimer=null,this.frameTask=new Ut(this),this.featuresTilingScheme=null,this.fullOpacity=1,this.graphicsView=null,this.initialExtent=null,this.labelManager=null,this.renderingOptions={samplingMode:"dynamic",edgeLabelsVisible:!0,labelsAnimationTime:125,labelCollisionsEnabled:!0},this.resizeAlign="center",this.supportsGround=!1,this.timeline=new re,this.type="2d",this.constraints=new se,this.padding={top:0,right:0,bottom:0,left:0};const e=this.handles,i=()=>this.notifyChange("updating");e.add([this.watch("viewpoint",(()=>{this._lastStationaryEventTimestamp=performance.now(),this._flipStationary(160)}),!0),this.on("resize",(t=>this._resizeHandler(t))),this.watch("animationManager.animation",(t=>{this.animation=t})),this.allLayerViews.on("change",(()=>{i(),e.remove("map-view-base-layerViewsUpdating"),e.add(this.allLayerViews.map((t=>t.watch("updating",i))),"map-view-base-layerViewsUpdating")}))],"map-view-base")}destroy(){this.destroyed||(this._set("preconditionsReady",!1),this._gotoTask=this.frameTask=null)}set animation(t){const e=this._get("animation");if(t===e)return;if(e&&e.stop(),!t||t.isFulfilled())return void this._set("animation",null);this._set("animation",t),this.frameTask.animationInProgress=!0;const i=()=>{t===this._get("animation")&&(this._set("animation",null),this.frameTask.requestFrame()),this.frameTask.animationInProgress=!1};t.when(i,i)}get center(){if(!this.ready)return this._get("center");const{center:t,spatialReference:e}=this.state.paddedViewState;return new f({x:t[0],y:t[1],spatialReference:e})}set center(t){if(null==t)return;if(!this._normalizeInput(t))return void pe.error("#center",`incompatible spatialReference ${JSON.stringify(t.spatialReference)} with view's spatialReference ${JSON.stringify(this.spatialReference)}`);if(!this.ready)return this._set("center",t),void this.notifyChange("initialExtentRequired");const e=this.viewpoint;kt(e,e,t),this.viewpoint=e}set constraints(t){const e=this._get("constraints");e&&(this.handles.remove("map-view-base-constraints"),e.destroy()),this._set("constraints",t),t&&(t.view=this,this.ready&&(this.state.viewpoint=t.fit(this.state.paddedViewState.viewpoint)),this.handles.add(t.on("update",(()=>{this.ready&&this.state&&(this.state.viewpoint=t.fit(this.state.paddedViewState.viewpoint))})),"map-view-base-constraints"))}get extent(){return this.ready?this.state.paddedViewState.extent.clone():this._get("extent")}set extent(t){if(null==t)return;const e=this._normalizeInput(t);if(!e)return void pe.error("#center",`incompatible spatialReference ${JSON.stringify(t.spatialReference)} with view's spatialReference ${JSON.stringify(this.spatialReference)}`);if(!e.width||!e.height)return void pe.error("#extent","invalid extent size");if(!this.ready)return this._set("extent",e),this._set("center",null),this._set("viewpoint",null),this._set("scale",0),this._set("zoom",-1),void this.notifyChange("initialExtentRequired");const i=this.viewpoint;bt(i,i,e,this.size,{constraints:this.constraints}),this.viewpoint=i}get initialExtentRequired(){const{extent:t,center:e,scale:i,viewpoint:s,zoom:o}=this;return!this.get("map.initialViewProperties.viewpoint")&&(!t&&((!e||0===i&&-1===o)&&!s))}get padding(){return this.ready?this.state.padding:this._get("padding")}set padding(t){this.ready?(this.state.padding=t,this._set("padding",this.state.padding)):this._set("padding",t)}get resolution(){return this.state?this.state.resolution:0}get rotation(){return this.ready?this.state.rotation:this._get("rotation")}set rotation(t){if(isNaN(t))return;if(!this.ready)return void this._set("rotation",t);const e=this.viewpoint;St(e,e,t),this.viewpoint=e}get scale(){return this.ready?this.state.scale:this._get("scale")}set scale(t){if(!t||isNaN(t))return;if(!this.ready){this._set("scale",t),this._set("zoom",-1);const e=this._get("extent");return e&&(this._set("extent",null),this._set("center",e.center)),void this.notifyChange("initialExtentRequired")}const e=this.viewpoint;Tt(e,e,t),this.viewpoint=e}get stationary(){return!(this.animation||this.navigating||this._get("resizing")||this._stationaryTimer)}get updating(){return!this.destroyed&&(!0===this.get("layerViewManager.updating")||!0===this.get("labelManager.updating")||!0===this.get("graphicsView.updating")||this.allLayerViews.some((t=>!t.destroyed&&!("layerViews"in t)&&!0===t.updating)))}get viewpoint(){if(!this.ready)return this._get("viewpoint");const t=this.state.paddedViewState;return t&&t.viewpoint.clone()}set viewpoint(t){if(null==t)return;const e=this._normalizeInput(t);if(!e)return void(!t.scale||isNaN(t.scale)?pe.error("#viewpoint",`invalid scale value of ${t.scale}`):o(t.targetGeometry)?pe.error("#viewpoint","geometry not defined"):pe.error("#viewpoint",`incompatible spatialReference ${JSON.stringify(t.targetGeometry.spatialReference)} with view's spatialReference ${JSON.stringify(this.spatialReference)}`));if(!this.ready)return this._set("viewpoint",e),this._set("extent",null),this._set("center",null),this._set("zoom",-1),this._set("scale",0),void this.notifyChange("initialExtentRequired");const i=new C({targetGeometry:new f,scale:0,rotation:0});_t(i,e),this.constraints.constrain(i,this.state.paddedViewState.viewpoint),this.state.viewpoint=i,this.frameTask.requestFrame(),this._set("viewpoint",i)}get zoom(){return this.ready?this.constraints.scaleToZoom(this.scale):this._get("zoom")}set zoom(t){if(null==t)return;if(!this.ready){this.notifyChange("initialExtentRequired"),this._set("zoom",t),this._set("scale",0);const e=this._get("extent");e&&(this._set("extent",null),this._set("center",e.center))}if(!this.constraints.effectiveLODs)return;const e=this.viewpoint;Tt(e,e,this.constraints.zoomToScale(t)),this.viewpoint=e,this._set("zoom",this.constraints.scaleToZoom(this.scale))}goTo(t,e){if(t)return this.animation&&(this.animation=null),this._createAnimation(),z(this,"ready",e&&e.signal).then((()=>{const i={animate:!0,...e},s=Vt(t,this);return this.animation.update(s),this._gotoTask={},i.animate?this._gotoAnimated(s,i):this._gotoImmediate(s,i)}));pe.error("#goTo()","target cannot be null or undefined")}hitTest(t){return p("Should be implemented by subclasses")}popupHitTest(t){return this.hitTest(t).then((e=>({...e,mapPoint:this.toMap(t)})))}toMap(t){if(!this.ready)return null;const[e,i]=this.state.toMap([0,0],[t.x,t.y]),s=this.spatialReference;return new f({x:e,y:i,spatialReference:s})}isTileInfoRequired(){return!0}toScreen(t){if(!this.ready)return null;const e=this._normalizeInput(t),i=[e.x,e.y];return this.state.toScreen(i,i),x(i[0],i[1])}pixelSizeAt(){return this.ready?this.state.resolution:(pe.error("#pixelSizeAt()","Map view cannot be used before it is ready"),null)}requestUpdate(){this.ready&&this.frameTask.requestUpdate()}getDefaultSpatialReference(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||null}isSpatialReferenceSupported(t,e){return!(!e&&!this._get("ready"))||null!==this._getDefaultViewpoint()}importLayerView(t){return Ht(t)}hasLayerViewModule(t){return qt(t)}_createAnimation(){return this.animation&&!this.animation.done||(this.animation=new vt),this.animation}_cancellableGoTo(t,e,i){const s=()=>t===this._gotoTask,o=i.then((()=>{s()&&(this.animation=null)})).catch((t=>{throw s()&&(this.animation=null,e.done||(e.stop(),this.frameTask.animationInProgress=!1)),t})),a=h((t=>t(o)));return e.when().catch((()=>{s()&&a.cancel&&a.cancel()})),a}_gotoImmediate(t,e){const i=this._gotoTask,s=this.animation,o=t.then((t=>{if(l(e),i!==this._gotoTask)throw new u("view:goto-interrupted","Goto was interrupted");this.viewpoint=s.target=t,s.finish()}));return this._cancellableGoTo(i,s,o)}_gotoAnimated(t,e){const i=this._gotoTask,s=this.animation,o=t.then((t=>{if(l(e),i!==this._gotoTask)throw new u("view:goto-interrupted","Goto was interrupted");return s.update(t),this.animationManager.animate(s,this.viewpoint,e),s.when().then((()=>{}),(()=>{}))}));return this._cancellableGoTo(i,s,o)}_resizeHandler(t){const e=this.state;if(!e)return;let i=this.state.paddedViewState.viewpoint;const s=this.state.paddedViewState.size.concat();e.size=[t.width,t.height],Dt(i,i,s,this.state.paddedViewState.size,this.resizeAlign),i=this.constraints.constrain(i,null),this.state.viewpoint=i}_startup(){const t=this._getDefaultViewpoint();this.constraints.view=this,this.constraints.fit(t),this._set("animationManager",new Nt({view:this})),this._set("state",new ne({padding:this._get("padding"),size:this.size,viewpoint:t})),this._set("featuresTilingScheme",new Ct(K.create({spatialReference:this.spatialReference,size:512}))),this._set("ready",!0),this.frameTask&&this.frameTask.start()}_teardown(){this.frameTask&&this.frameTask.stop(),this._set("ready",!1),this._stationaryTimer&&(clearTimeout(this._stationaryTimer),this._stationaryTimer=null);const{center:[t,e],spatialReference:i,rotation:s,scale:o}=this.state.paddedViewState,a=new f({x:t,y:e,spatialReference:i});this._set("viewpoint",null),this._set("extent",null),this._set("center",a),this._set("zoom",-1),this._set("rotation",s),this._set("scale",o),this._set("spatialReference",i),this.constraints.view=null,this.animationManager.destroy(),this._set("animationManager",null),this._set("state",null),this.animation=null}_flipStationary(t){return null!==this._stationaryTimer||(this._stationaryTimer=setTimeout((()=>{this._stationaryTimer=null;const t=performance.now()-this._lastStationaryEventTimestamp;t<160&&(this._stationaryTimer=this._flipStationary(t))}),t)),this._stationaryTimer}_normalizeInput(t,e=this.spatialReference){const i=t&&t.targetGeometry||t;return e?i?e.equals(i.spatialReference)?t:_(i,e)?function(t){return t&&"esri.Viewpoint"===t.declaredClass}(t)?(t.targetGeometry=j(i,e),t):j(i,e):null:null:t}_getDefaultViewpoint(){const t=this.constraints,e={zoom:this._get("zoom"),scale:this._get("scale"),center:this._normalizeInput(this._get("center")),extent:this._normalizeInput(this._get("extent")),rotation:this._get("rotation"),viewpoint:this._normalizeInput(this._get("viewpoint")),spatialReference:this._userSpatialReference};t.effectiveLODs?-1!==e.zoom&&(e.scale=t.zoomToScale(e.zoom)):e.zoom=-1;let s=null,o=null,a=0;const n=e.viewpoint&&e.viewpoint.rotation,r=e.viewpoint&&e.viewpoint.targetGeometry;i(r)&&("extent"===r.type?s=r:"point"===r.type&&(o=r,a=e.viewpoint.scale));const p=this._normalizeInput(this.get("map.initialViewProperties.viewpoint.targetGeometry.extent")),h=this._normalizeInput(this.initialExtent),l=e.extent||s||p||h,c=e.center||o||l&&l.center,m=this.get("map.initialViewProperties.viewpoint.scale"),d=e.scale||a||m||l&&xt(l,this.size),u=this.get("map.initialViewProperties.viewpoint.rotation"),g=e.rotation||n||u||0;return c&&d?new C({targetGeometry:c,scale:d,rotation:g}):null}};t([a()],he.prototype,"_stationaryTimer",void 0),t([a()],he.prototype,"animation",null),t([a({readOnly:!0})],he.prototype,"animationManager",void 0),t([a({value:null,type:f,dependsOn:["state.id","ready"],autoTracked:!1})],he.prototype,"center",null),t([a({type:se})],he.prototype,"constraints",null),t([a({value:null,type:k,dependsOn:["state.id","ready"],autoTracked:!1})],he.prototype,"extent",null),t([a({readOnly:!0})],he.prototype,"featuresTilingScheme",void 0),t([a()],he.prototype,"fullOpacity",void 0),t([a()],he.prototype,"graphicsView",void 0),t([a({type:k})],he.prototype,"initialExtent",void 0),t([a({dependsOn:["map.initialViewProperties?.viewpoint"],autoTracked:!1})],he.prototype,"initialExtentRequired",null),t([a()],he.prototype,"labelManager",void 0),t([a({value:{top:0,right:0,bottom:0,left:0},cast:t=>({top:0,right:0,bottom:0,left:0,...t})})],he.prototype,"padding",null),t([a({type:Object})],he.prototype,"renderingOptions",void 0),t([a()],he.prototype,"resizeAlign",void 0),t([a({readOnly:!0,dependsOn:["state.id"],autoTracked:!1})],he.prototype,"resolution",null),t([a({value:0,type:Number,dependsOn:["state.id","ready"],autoTracked:!1})],he.prototype,"rotation",null),t([a({value:0,type:Number,dependsOn:["state.id","ready"],autoTracked:!1})],he.prototype,"scale",null),t([a({type:v,dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"],autoTracked:!1})],he.prototype,"spatialReference",void 0),t([a({readOnly:!0})],he.prototype,"state",void 0),t([a({dependsOn:["animation","navigating","resizing","_stationaryTimer"],autoTracked:!1})],he.prototype,"stationary",null),t([a({readOnly:!0})],he.prototype,"supportsGround",void 0),t([a({type:re,readOnly:!0})],he.prototype,"timeline",void 0),t([a({readOnly:!0})],he.prototype,"type",void 0),t([a({readOnly:!0,dependsOn:["layerViewManager.updating","labelManager.updating","graphicsView?.updating"],autoTracked:!1})],he.prototype,"updating",null),t([a({value:null,type:C,dependsOn:["state.id","ready"],autoTracked:!1})],he.prototype,"viewpoint",null),t([a({value:-1,dependsOn:["state.id"],autoTracked:!1})],he.prototype,"zoom",null),he=t([g("esri.views.MapViewBase")],he);var le=he;class ce extends Y{constructor(t,e){super(!0),this.view=t,this.registerIncoming("double-click",e,(t=>this._handleDoubleClick(t,e)))}_handleDoubleClick(t,e){at(t.data,"primary")&&(t.stopPropagation(),e?this.view.mapViewNavigation.zoomOut([t.data.x,t.data.y]):this.view.mapViewNavigation.zoomIn([t.data.x,t.data.y]))}}class me extends Y{constructor(t,e,i){super(!0),this.view=t,this.pointerType=e,this.registerIncoming("double-tap-drag",i,(t=>this._handleDoubleTapDrag(t)))}_handleDoubleTapDrag(t){const{data:e}=t,{pointerType:i}=e;if(i!==this.pointerType)return;t.stopPropagation();const{action:s,delta:o}=e,{view:a}=this,{mapViewNavigation:n}=a;switch(s){case"begin":{const{scale:t}=a;this._startScale=t,this._currentScale=t,this._previousDelta=o,n.begin();break}case"update":{if(this._previousDelta.y===o.y)return;this._previousDelta=o;const t=Math.pow(1.015,o.y),e=this._startScale*t,i=e/this._currentScale;n.setViewpointImmediate(i),this._currentScale=e;break}case"end":{const{constraints:t}=a,{effectiveLODs:e,snapToZoom:i}=t;if(!i||!e)return void n.end();const s=t.snapScale(this._currentScale),r=(o.y>0?Math.max(s,t.snapToPreviousScale(this._startScale)):Math.min(s,t.snapToNextScale(this._startScale)))/this._currentScale;n.zoom(r);break}}}}class de extends Y{constructor(t,e,i){super(!0),this.view=t,this.pointerAction=e,this.registerIncoming("drag",i,(t=>this._handleDrag(t))),this.registerIncoming("pointer-down",(()=>this.stopMomentumNavigation()));const s=this.view.mapViewNavigation;this.dragEventSeparator=new nt({start:(t,e)=>{s.pan.begin(this.view,e.data),e.stopPropagation()},update:(t,e)=>{s.pan.update(this.view,e.data),e.stopPropagation()},end:(t,e)=>{s.pan.end(this.view,e.data),e.stopPropagation()},condition:(t,e)=>1===t&&at(e.data,this.pointerAction)})}_handleDrag(t){const e=this.view.mapViewNavigation;e.pinch.zoomMomentum||e.pinch.rotateMomentum?this.stopMomentumNavigation():this.dragEventSeparator.handle(t)}stopMomentumNavigation(){this.view.mapViewNavigation.pan.stopMomentumNavigation()}}class ue extends Y{constructor(t,e,i){super(!0),this.view=t,this.pointerAction=e;const s=this.view.mapViewNavigation;this.dragEventSeparator=new nt({start:(t,e)=>{s.rotate.begin(this.view,e.data),e.stopPropagation()},update:(t,e)=>{s.rotate.update(this.view,e.data),e.stopPropagation()},end:(t,e)=>{s.rotate.end(),e.stopPropagation()},condition:(t,e)=>1===t&&at(e.data,this.pointerAction)}),this.registerIncoming("drag",i,(t=>this.dragEventSeparator.handle(t)))}}class ge extends Y{constructor(t){super(!0),this.view=t,this.frameTask=null,this.watchHandles=new O,this.currentDevice=null,this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.handle=this.registerIncoming("gamepad",(t=>this.handleEvent(t))),this.handle.pause()}onInstall(t){super.onInstall(t),this.watchHandles.add([P(this.view.navigation.gamepad,"enabled",(t=>{t?(this.handle.resume(),this.frameTask||(this.frameTask=r({update:t=>this.frameUpdate(t.deltaTime)}))):(this.handle.pause(),this.frameTask&&(this.frameTask.remove(),this.frameTask=null))}))])}onUninstall(){this.watchHandles.removeAll(),this.frameTask&&(this.frameTask.remove(),this.frameTask=null),super.onUninstall()}handleEvent(t){const e=this.view.navigation.gamepad.device;e&&t.data.device!==e||this.currentDevice&&this.currentDevice!==t.data.device||("end"===t.data.action?(this.currentDevice=null,rt(this.transformation)):(this.currentDevice=t.data.device,pt(t.data,this.view.navigation.gamepad,this.transformation)))}frameUpdate(t){const e=this.transformation;if(ht(e))return;const i=this.view.viewpoint.clone(),s=this.view.navigation.gamepad.velocityFactor,o=we*s*t;Mt(i,i,[e.translation[0]*o,-e.translation[1]*o]);const a=1+e.translation[2]*ve*t,n=this.view.constraints.rotationEnabled?-e.heading*ye*t:0,r=this.view.size,p=[r[0]/2,r[1]];Ot(i,i,a,n,p,r);const h=this.view.constraints.constrain(i,this.view.viewpoint);this.view.viewpoint=h}}const ye=.06,we=.7,ve=6e-4;class fe extends Y{constructor(t,e,i){super(!0),this.view=t,this.keys=e,this._pressed=!1,this._keyMap={[e.left]:"left",[e.right]:"right",[e.up]:"up",[e.down]:"down"},this.registerIncoming("key-down",i,(t=>this._handleKeyDown(t))),this.registerIncoming("key-up",i,(t=>this._handleKeyUp(t))),this.registerIncoming("blur",i,(()=>this._handleBlur()))}_handleKeyDown(t){t.data.repeat||this._handleKey(t,!0)}_handleKeyUp(t){this._handleKey(t,!1)}_handleBlur(){this._pressed&&(this._pressed=!1,this.view.mapViewNavigation.stop())}_handleKey(t,e){const i=this._keyMap[t.data.key];if(this._pressed=null!=i,this._pressed){if(e)switch(this.view.mapViewNavigation.begin(),i){case"left":this.view.mapViewNavigation.continousPanLeft();break;case"right":this.view.mapViewNavigation.continousPanRight();break;case"up":this.view.mapViewNavigation.continousPanUp();break;case"down":this.view.mapViewNavigation.continousPanDown()}else this._pressed=!1,this.view.mapViewNavigation.stop();t.stopPropagation()}}}class _e extends Y{constructor(t,e,i){super(!0),this.view=t,this.keys=e,this._pressed=!1,this._keyToDirection={[e.clockwiseOption1]:"clockwise",[e.clockwiseOption2]:"clockwise",[e.counterClockwiseOption1]:"counterClockwise",[e.counterClockwiseOption2]:"counterClockwise",[e.resetOption1]:"reset",[e.resetOption2]:"reset"},this.registerIncoming("key-down",i,(t=>this._handleKeyDown(t))),this.registerIncoming("key-up",i,(t=>this._handleKeyUp(t))),this.registerIncoming("blur",i,(()=>this._handleBlur()))}_handleKeyDown(t){t.data.repeat||this._handleKey(t,!0)}_handleKeyUp(t){this._handleKey(t,!1)}_handleBlur(){this._pressed&&(this._pressed=!1,this.view.mapViewNavigation.stop())}_handleKey(t,e){const i=t.modifiers;if(i.size>0&&!i.has("Shift")||!this.view.constraints.rotationEnabled)return;const s=this._keyToDirection[t.data.key];if(this._pressed=null!=s,this._pressed){if(e)switch(this.view.mapViewNavigation.begin(),s){case"clockwise":this.view.mapViewNavigation.continousRotateClockwise();break;case"counterClockwise":this.view.mapViewNavigation.continousRotateCounterclockwise();break;case"reset":this.view.mapViewNavigation.resetRotation()}else this._pressed=!1,this.view.mapViewNavigation.stop();t.stopPropagation()}}}class je extends Y{constructor(t,e,i){super(!0),this.view=t,this.keys=e,this._keysToZoomAction={},this.registerIncoming("key-down",i,(t=>this._handleKeyDown(t))),e.zoomIn.forEach((t=>this._keysToZoomAction[t]=0)),e.zoomOut.forEach((t=>this._keysToZoomAction[t]=1))}_handleKeyDown(t){this._handleKey(t)}_handleKey(t){const e=t.modifiers;if(e.size>0&&!e.has("Shift"))return;const{key:i}=t.data;if(!(i in this._keysToZoomAction))return;const s=this._keysToZoomAction[i],{mapViewNavigation:o}=this.view;let a=null;switch(s){case 0:a=o.zoomIn();break;case 1:a=o.zoomOut();break;default:return}o.begin(),a.then((()=>o.end())),t.stopPropagation()}}class ke extends Y{constructor(t,e){super(!0),this.view=t,this._canZoom=!0,this.registerIncoming("mouse-wheel",e,(t=>this._handleMouseWheel(t)))}_handleMouseWheel(t){if(!this.view.navigation.mouseWheelZoomEnabled)return;if(t.preventDefault(),t.stopPropagation(),!this._canZoom)return;const e=this.view.mapViewNavigation,{x:i,y:s,deltaY:o}=t.data,a=1/Math.pow(.6,1/60*o),n=e.zoom(a,[i,s]);n&&(this._canZoom=!1,n.catch((()=>{})).then((()=>{this._canZoom=!0,e.end()})))}}class be extends Y{constructor(t){super(!0),this.view=t,this.registerIncoming("drag",(t=>this._handleDrag(t))),this.registerIncoming("pointer-down",(()=>this.stopMomentumNavigation()));const e=this.view.mapViewNavigation;this.dragEventSeparator=new nt({start:(t,i)=>{e.pinch.begin(this.view,i.data),i.stopPropagation()},update:(t,i)=>{e.pinch.update(this.view,i.data),i.stopPropagation()},end:(t,i)=>{e.pinch.end(this.view),i.stopPropagation()},condition:t=>t>=2})}_handleDrag(t){this.dragEventSeparator.handle(t)}stopMomentumNavigation(){this.view.mapViewNavigation.pinch.stopMomentumNavigation()}}class Se extends Y{constructor(t=lt.maximumDoubleClickDelay,e=lt.maximumDoubleClickDistance,i=lt.maximumDoubleTouchDelay,s=lt.maximumDoubleTouchDistance,o=c){super(!1),this.maximumDoubleClickDelay=t,this.maximumDoubleClickDistance=e,this.maximumDoubleTouchDelay=i,this.maximumDoubleTouchDistance=s,this._clock=o,this._doubleTapDragReady=!1,this._doubleTapDragActive=!1,this._dragStartCenter=x(0,0),this._pointerState=new Map,this._doubleTapDrag=this.registerOutgoing("double-tap-drag"),this._dragEventSeparator=new nt({start:(t,e)=>this._dragStart(t,e),update:(t,e)=>this._dragUpdate(e),end:(t,e)=>this._dragEnd(e)}),this.registerIncoming("drag",(t=>this._dragEventSeparator.handle(t))),this.registerIncoming("pointer-down",(t=>this._handlePointerDown(t))),this.registerIncoming("pointer-up",(()=>this._handlePointerUp()))}onUninstall(){this._pointerState.forEach((t=>{null!=t.doubleTapTimeout&&(t.doubleTapTimeout.remove(),t.doubleTapTimeout=null)}))}get hasPendingInputs(){return W(this._pointerState,(t=>null!=t.doubleTapTimeout))}_clearPointerDown(t){const e=this._pointerState.get(t);e&&(e.doubleTapTimeout.remove(),e.doubleTapTimeout=null,this._pointerState.delete(t),this.refreshHasPendingInputs())}_createDoubleTapDragData(t,e,i){const{button:s,buttons:o,pointer:a,pointers:n,pointerType:r,timestamp:p}=i;return{action:t,delta:e,button:s,buttons:o,pointer:a,pointers:n,pointerType:r,timestamp:p}}_dragStart(t,e){if(!this._doubleTapDragReady||1!==t)return;this._doubleTapDragReady=!1,this._doubleTapDragActive=!0;const{data:i,modifiers:s}=e,{center:o}=i;this._dragStartCenter=o;const a=this._createDoubleTapDragData("begin",x(0,0),i);this._doubleTapDrag.emit(a,void 0,s),e.stopPropagation()}_dragUpdate(t){if(!this._doubleTapDragActive)return;const{data:e,modifiers:i}=t,{center:s}=e,o=x(s.x-this._dragStartCenter.x,s.y-this._dragStartCenter.y),a=this._createDoubleTapDragData("update",o,e);this._doubleTapDrag.emit(a,void 0,i),t.stopPropagation()}_dragEnd(t){if(!this._doubleTapDragActive)return;const{data:e,modifiers:i}=t,{center:s}=e,o=x(s.x-this._dragStartCenter.x,s.y-this._dragStartCenter.y),a=this._createDoubleTapDragData("end",o,e);this._doubleTapDrag.emit(a,void 0,i),this._doubleTapDragActive=!1,t.stopPropagation()}_handlePointerDown(t){const{data:e}=t,i=this._pointerId(e),s=this._pointerState.get(i),{pointerType:o}=e.native;if(s){const a="touch"===o?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;this._clearPointerDown(i),zt(s.event.data,e)>a?this._storePointerDown(t):this._doubleTapDragReady=!0}else this._storePointerDown(t)}_handlePointerUp(){this._doubleTapDragReady=!1}_pointerId(t){const{native:e}=t,{pointerId:i,button:s,pointerType:o}=e;return"mouse"===o?`${i}:${s}`:`${o}`}_storePointerDown(t){const{data:e}=t,{pointerType:i}=e.native,s=this._pointerId(e),o="touch"===i?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay,a=this._clock.setTimeout((()=>this._clearPointerDown(s)),o);this._pointerState.set(s,{event:t,doubleTapTimeout:a}),this.refreshHasPendingInputs()}}const Te="Ctrl",Ve={left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown"},De={zoomIn:["=","+"],zoomOut:["-","_"]},xe={clockwiseOption1:"a",clockwiseOption2:"A",counterClockwiseOption1:"d",counterClockwiseOption2:"D",resetOption1:"n",resetOption2:"N"};let Me=class extends n{constructor(){super(...arguments),this._handles=new O}initialize(){this._handles.add([I(this.view,"ready",(()=>this._disconnect())),L(this.view,"ready",(()=>this._connect()))])}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this._disconnect()}_disconnect(){this._inputManager&&(this.view.viewEvents.disconnect(),this._inputManager.destroy(),this._inputManager=null,this._source.destroy(),this._source=null)}_connect(){const t=this.view.surface,e=new ct(t,this.view.input),i=[new mt,new Pt,new dt,new ut(this.view.navigation),new Se],s=new Q({eventSource:e,recognizers:i});s.installHandlers("prevent-context-menu",[new gt],X.INTERNAL),s.installHandlers("navigation",[new be(this.view),new ge(this.view),new ke(this.view),new ce(this.view),new ce(this.view,[Te]),new de(this.view,"primary"),new fe(this.view,Ve),new je(this.view,De),new _e(this.view,xe),new ue(this.view,"secondary"),new me(this.view,"touch")],X.INTERNAL),this.view.viewEvents.connect(s),this._source=e,this._inputManager=s,P(this.view.navigation,"browserTouchPanEnabled",(t=>{this._source.browserTouchPanningEnabled=!t}))}get test(){return{inputManager:this._inputManager}}};t([a()],Me.prototype,"view",void 0),Me=t([g("esri.views.2d.input.MapViewInputManager")],Me);var Oe=Me;let Re=0,Ce=class extends n{constructor(){super(...arguments),this.color=new T([0,255,255]),this.haloOpacity=1,this.fillOpacity=.25}get version(){return Re++}};t([a({readOnly:!0,dependsOn:["color","haloColor","haloOpacity","fillOpacity"]})],Ce.prototype,"version",null),t([a({type:T})],Ce.prototype,"color",void 0),t([a({type:T})],Ce.prototype,"haloColor",void 0),t([a()],Ce.prototype,"haloOpacity",void 0),t([a()],Ce.prototype,"fillOpacity",void 0),Ce=t([g("esri.views.2d.support.HighlightOptions")],Ce);var ze=Ce;let Pe=class extends It{constructor(t){super(t),this.components=["attribution","zoom"]}};t([a()],Pe.prototype,"components",void 0),Pe=t([g("esri.views.ui.2d.DefaultUI2D")],Pe);var Ie=Pe;const Le=s.getLogger("esri.views.MapView");let Ee,Ne,Ue,Ze,Ae;function Ge(t,e,i){if(t)if(Array.isArray(t)||w.isCollection(t)){if(0===t.length)return;t.forEach((t=>Ge(t,e,i)))}else!function(t){return t instanceof M}(t)?i.add(t):e.add(t)}let Fe=class extends(yt(J(le))){constructor(t){super(t),this._magnifierView=null,this._stage=null,this._resolveWhenReady=[],this.rootLayerViews=new R({root:this,rootCollectionNames:["basemapView.baseLayerViews","layerViews","basemapView.referenceLayerViews"],getChildrenFunction:t=>null}),this.graphicsView=null,this.highlightOptions=new ze,this.inputManager=new Oe({view:this}),this.mapViewNavigation=null,this.supersampleScreenhotsEnabled=!0,this.ui=new Ie,this.rendering=!1,Z()}destroy(){this.rootLayerViews.destroy(),this.inputManager.destroy(),this._set("inputManager",null)}get background(){return this.get("map.initialViewProperties.background")||null}set background(t){void 0===t?this._clearOverride("background"):this._override("background",t)}get textureManager(){return this._stage.painter.textureManager}get navigating(){return!(!this.mapViewNavigation||!this.mapViewNavigation.interacting)}toMap(t){if(tt(t)){const e=et(this,t);return super.toMap(e)}return super.toMap(t)}hitTest(t,e){const i=tt(t)?et(this,t):t;if(!this.ready||isNaN(i.x)||isNaN(i.y))return m({screenPoint:i,results:[]});const s=this.toMap(i),o=[this.graphicsView];o.push.apply(o,this.allLayerViews.toArray().reverse());const a=new Set,n=new Set,r=new Set,p=new Set;return e&&(Ge(e&&e.include,a,r),Ge(e&&e.exclude,n,p)),d(o.map((t=>!t||!t.hitTest||r.size>0&&!t.layer||r.size>0&&t.layer&&!r.has(t.layer)||p.size>0&&t.layer&&p.has(t.layer)?null:t.hitTest(i.x,i.y)))).then((t=>({screenPoint:i,results:t.filter((t=>null!=t&&(!(a.size>0)||a.has(t))&&(!(n.size>0)||!n.has(t)))).map((t=>({mapPoint:s,graphic:t})))})))}takeScreenshot(t){return this.ready?this._stage.takeScreenshot(A(t,this),this.allLayerViews):p("Map view cannot be used before it is ready")}on(t,e,i,s){const o=this.inputManager&&this.viewEvents.on(t,e,i,s);return o||super.on(t,e)}hasEventListener(t){return super.hasEventListener(t)||this.viewEvents.hasHandler(t)}whenLayerView(t){return super.whenLayerView(t)}graphicChanged(t){if(this.graphicsView){this.graphicsView.graphicUpdateHandler(t)}}whenReady(){return h((t=>{this.ready?t(this):this._resolveWhenReady.push(t)}))}forceDOMReadyCycle(){this.forceReadyCycle()}validate(){let t=wt({checkMajorWebPerformanceCaveat:!1});return e("safari")&&e("safari")<9&&(t=new u("mapview:browser-not-supported","This browser is not supported by MapView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e("safari")})),i(t)?(Le.warn("#validate()",t.message),p(t)):async function(){const[,{GraphicsView2D:t,LabelManager:e,MapViewNavigation:i,MagnifierView2D:s,Stage:o}]=await Promise.all([import("../chunks/webgl.js"),import("../chunks/mapViewDeps.js")]);Ne=t,Ue=e,Ze=i,Ae=s,Ee=o}()}_startup(){this.timeline.begin("MapView Startup"),super._startup(),this.graphics.owner=this;const t={disabledExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions},e=new Ee(this.surface,{canvas:this.renderCanvas,supersampleScreenshots:this.supersampleScreenhotsEnabled,contextOptions:t,renderingOptions:this.renderingOptions,timeline:this.timeline}),i=new Ne({view:this,graphics:this.graphics,requestUpdateCallback:()=>this.requestUpdate()}),s=new Ze({view:this,animationManager:this.animationManager}),o=new Ue({view:this});this._magnifierView=new Ae,this._magnifierView.magnifier=this.magnifier,this._stage=e,this.frameTask.graphicsView=i,this._set("graphicsView",i),this._set("mapViewNavigation",s),this._set("labelManager",o),this.handles.add([this.rootLayerViews.on("change",(()=>this._updateStageChildren())),e.on("post-render",(()=>this._set("rendering",e.renderRequested))),e.on("will-render",(()=>this._set("rendering",e.renderRequested))),e.on("webgl-error",(t=>this.fatalError=t.error)),P(this,"stationary",(t=>e.stationary=t),!0),P(this,"state.id",(()=>e.state=this.state),!0),P(this,"background",(t=>{e.background=t,this._magnifierView.background=t}),!0),P(this,"magnifier",(t=>this._magnifierView.magnifier=t),!0),P(this,"renderingOptions",(t=>e.renderingOptions=t),!0),P(this,"highlightOptions",(()=>e.highlightOptions=this.highlightOptions),!0)],"map-view"),e.state=this.state,this._updateStageChildren();const a=this._resolveWhenReady;this._resolveWhenReady=[],a.forEach((t=>t(this))),this.timeline.end("MapView Startup")}_teardown(){this.handles.remove("map-view"),this.layerViewManager.clear(),this.labelManager.destroy(),this._magnifierView.destroy(),this._stage.destroy();this.graphicsView.destroy(),this.mapViewNavigation.destroy(),this._stage=null,this._set("graphicsView",null),this._magnifierView=null,this._set("labelManager",null),this._set("mapViewNavigation",null),this.graphics.owner=null,super._teardown()}_updateStageChildren(){this._stage.removeAllChildren(),this.rootLayerViews.forEach((t=>{this._stage.addChild(t.container)}));const t=this.graphicsView;this._stage.addChild(t.container),this._stage.addChild(this._magnifierView)}};t([a({type:E,dependsOn:["map.initialViewProperties?.background"]})],Fe.prototype,"background",null),t([a()],Fe.prototype,"graphicsView",void 0),t([a({type:ze})],Fe.prototype,"highlightOptions",void 0),t([a({readOnly:!0})],Fe.prototype,"inputManager",void 0),t([a({readOnly:!0})],Fe.prototype,"textureManager",null),t([a({readOnly:!0})],Fe.prototype,"mapViewNavigation",void 0),t([a({dependsOn:["mapViewNavigation.interacting"],type:Boolean})],Fe.prototype,"navigating",null),t([a({type:Boolean,constructOnly:!0})],Fe.prototype,"supersampleScreenhotsEnabled",void 0),t([a({type:Ie})],Fe.prototype,"ui",void 0),t([a({readOnly:!0})],Fe.prototype,"rendering",void 0),t([a({constructOnly:!0})],Fe.prototype,"renderCanvas",void 0),t([a({constructOnly:!0})],Fe.prototype,"deactivatedWebGLExtensions",void 0),t([a({constructOnly:!0})],Fe.prototype,"debugWebGLExtensions",void 0),Fe=t([g("esri.views.MapView")],Fe);var qe=Fe;export default qe;export{re as T};
