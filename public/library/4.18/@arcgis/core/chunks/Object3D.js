/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{O as t}from"./ArrayPool.js";import{i as e,b as s,c as i}from"./Logger.js";import{a as r,f as o,c as a}from"./vec3f64.js";import{i as n,b as h,k as c,g as m,f as l}from"./vec3.js";import{h as b}from"./mathUtils.js";import{m as d,c as u,a as g,b as _}from"./mat4.js";import{c as f,d as y,I as v}from"./quatf64.js";import{s as p,a as j}from"./Util.js";class S{constructor(){this._count=0}gen(t){return null==t&&(t="a"),t+"_"+this._count++}}class M{acquire(t,e,s,i,r,o){this.id=M._idGen.gen(t&&t.id),this.geometry=t,this.material=e,this.transformation=s,this.instanceParameters=i,this.origin=r,this.shaderTransformation=o}getStaticTransformation(){return this.transformation}getShaderTransformation(){return this.shaderTransformation?this.shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(t){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,t):this.geometry.computeAttachmentOrigin(t))&&(n(t,t,this.getStaticTransformation()),!0)}}M._idGen=new S,M.pool=new t(M);const R=new S;function A(t){const e=0===t?"highlight":"occludee";return{id:R.gen(e),channel:t}}class O{constructor(){this.items=[]}addObject(t,e){this.items.push({type:0,objectStateId:e,object:t})}addRenderGeometry(t,e,s){this.items.push({type:1,objectStateId:e,renderGeometry:t,owner:s})}addExternal(t,e){this.items.push({type:2,objectStateId:e,remove:t})}remove(t){for(let e=this.items.length-1;e>=0;--e){const s=this.items[e];s.objectStateId===t&&(this._removeObjectStateItem(s),this.items.splice(e,1))}}removeObject(t){for(let e=this.items.length-1;e>=0;--e){const s=this.items[e];0===s.type&&s.object===t&&(this._removeObjectStateItem(s),this.items.splice(e,1))}}removeRenderGeometry(t){for(let e=this.items.length-1;e>=0;--e){const s=this.items[e];1===s.type&&s.renderGeometry===t&&(this._removeObjectStateItem(s),this.items.splice(e,1))}}removeAll(){this.items.forEach((t=>{this._removeObjectStateItem(t)})),this.items=[]}_removeObjectStateItem(t){switch(t.type){case 0:0===t.objectStateId.channel?t.object.removeHighlight(t.objectStateId):1===t.objectStateId.channel&&t.object.removeOcclude(t.objectStateId);break;case 1:t.owner.removeRenderGeometryObjectState(t.renderGeometry,t.objectStateId);break;case 2:t.remove(t.objectStateId)}}}function T(t,e,s){for(let i=0;i<s;++i)e[2*i]=t[i],e[2*i+1]=t[i]-e[2*i]}function V(t,e,s,i){for(let r=0;r<i;++r)x[0]=t[r],T(x,B,1),e[r]=B[0],s[r]=B[1]}const x=new Float64Array(1),B=new Float32Array(2);function G(t,e){return s(t)&&(t=[]),t.push(e),t}function L(t,e){if(s(t))return t;const i=t.filter((t=>t!==e));return 0===i.length?null:i}function I(t){return!!e(t)&&!t.visible}function w(t,e){const s=new Map;return s.set(0,e.acquire(t,0)),s.set(1,e.acquire(t,7)),s.set(4,e.acquire(t,3)),s.set(3,e.acquire(t,2)),s.set(2,e.acquire(t,1)),s.set(5,e.acquire(t,4)),s}function D(t,e){e.release(t,0),e.release(t,7),e.release(t,3),e.release(t,2),e.release(t,1),e.release(t,4)}function E(t,s,i){const r=t.origin.vec3;p(C,-r[0],-r[1],-r[2]),e(t.transformation)?d(s,C,t.transformation):u(s,C),i&&(g(i,s),_(i,i))}function U(t,e,s,i,r){W[0]=t.get(e,0),W[1]=t.get(e,1),W[2]=t.get(e,2),T(W,N,3),s.set(r,0,N[0]),i.set(r,0,N[1]),s.set(r,1,N[2]),i.set(r,1,N[3]),s.set(r,2,N[4]),i.set(r,2,N[5])}const W=new Float64Array(3),N=new Float32Array(6),C=f();class X{constructor(t={}){this._objectTransformation=f(),this._bvObjectSpace=new q,this._bvWorldSpace=new q,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.id=X._idGen.gen(t.idHint),this.castShadow=null==t.castShadow||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new P),this.objectTransformation=f(),this._initializeGeometryRecords(t.geometries,t.materials,t.transformations,t.origins)}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get objectTransformation(){return this._objectTransformation}set objectTransformation(t){u(this._objectTransformation,t),this._invalidateBoundingVolume(),this._notifyDirty("objTransformation")}dispose(){for(const t of this._geometryRecords)M.pool.release(t);this._geometryRecords=null,this._geometries=null}_initializeGeometryRecords(t,e,s,i){if(!Array.isArray(t))return this._geometryRecords=[],void(this._geometries=[]);j(e.length===t.length,"Object3D: materials don't match geometries"),j(s.length===t.length,"Object3D: transformations don't match geometries"),this._geometryRecords=new Array(t.length),this._geometries=t.slice();for(let r=0;r<t.length;r++){const o={highlights:null,occludees:null,visible:!0};this._geometryRecords[r]=M.pool.acquire(t[r],e[r],y(s[r]),o,i&&i[r])}this._hasVolatileTransformation=!1}get parentLayer(){return this._parentLayer}set parentLayer(t){j(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t}getNumGeometryRecords(){return this._geometryRecords.length}getGeometryRecord(t){return j(t>=0&&t<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this._geometryRecords[t]}addGeometry(t,e,s,i,r,o){s=s||v,this._geometries.push(t);const a=M.pool.acquire(t,e,s,i||{highlights:null,occludees:null,visible:!0},r,o);return this._geometryRecords.push(a),this._hasVolatileTransformation=this._geometryRecords.some((t=>!!t.shaderTransformation)),this._notifyDirty("objGeometryAdded",a),this._invalidateBoundingVolume(),a}removeGeometry(t){const e=this._geometryRecords.splice(t,1)[0];return M.pool.release(e),this._hasVolatileTransformation=this._geometryRecords.some((t=>!!t.shaderTransformation)),this._geometries.splice(t,1),this._notifyDirty("objGeometryRemoved",e),this._invalidateBoundingVolume(),e}removeAllGeometries(){for(;this.getNumGeometryRecords()>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(t){this._notifyDirty("vertexAttrsUpdated",this._geometryRecords[t]),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(t){this._visible=t;for(const t of this._geometryRecords)t.instanceParameters.visible=this._visible;this._notifyDirty("visibilityChanged")}maskOccludee(){const t=A(1);for(const e of this._geometryRecords)e.instanceParameters.occludees=G(e.instanceParameters.occludees,t);return this._notifyDirty("occlusionChanged"),t}removeOcclude(t){for(const e of this._geometryRecords)e.instanceParameters.occludees=L(e.instanceParameters.occludees,t);this._notifyDirty("occlusionChanged")}highlight(){const t=A(0);for(const e of this._geometryRecords)e.instanceParameters.highlights=G(e.instanceParameters.highlights,t);return this._notifyDirty("highlightChanged"),t}removeHighlight(t){for(const e of this._geometryRecords)e.instanceParameters.highlights=L(e.instanceParameters.highlights,t);this._notifyDirty("highlightChanged")}getCombinedStaticTransformation(t,e){return d(i(e,f()),this.objectTransformation,t.getStaticTransformation())}getCombinedShaderTransformation(t,e){return e=e||f(),d(e,this.objectTransformation,t.getShaderTransformation()),e}hasVolativeTransformation(){return this._hasVolatileTransformation}getBBMin(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin}getBBMax(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax}getCenter(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.center:this._bvWorldSpace.center}getBSRadius(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let t=0;t<this._geometryRecords.length;++t){const e=this._geometries[t],s=this._geometryRecords[t],i=e.boundingInfo;this._calculateTransformedBoundingVolume(i,this._bvObjectSpace,s.getShaderTransformation()),this._calculateTransformedBoundingVolume(i,this._bvWorldSpace,this.getCombinedShaderTransformation(s))}h(this._bvObjectSpace.center,this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5),h(this._bvWorldSpace.center,this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5);const t=a(),e=a(),s=b(this.objectTransformation);for(let i=0;i<this._geometryRecords.length;++i){const r=this._geometries[i],o=this._geometryRecords[i].getShaderTransformation(),a=b(o),h=r.boundingInfo;n(t,h.getCenter(),o);const m=c(t,this._bvObjectSpace.center),l=h.getBSRadius()*a;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,m+l),n(e,t,this.objectTransformation);const d=c(e,this._bvWorldSpace.center),u=l*s;this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,d+u)}this._bvDirty=!1}_calculateTransformedBoundingVolume(t,e,s){const i=t.getBBMin(),o=t.getBBMax(),a=r(i),h=r(o);n(a,a,s),n(h,h,s);for(let t=0;t<3;++t)e.bbMin[t]=Math.min(e.bbMin[t],a[t],h[t]),e.bbMax[t]=Math.max(e.bbMax[t],a[t],h[t]);for(let t=0;t<3;++t){m(a,i),m(h,o),a[t]=o[t],h[t]=i[t],n(a,a,s),n(h,h,s);for(let t=0;t<3;++t)e.bbMin[t]=Math.min(e.bbMin[t],a[t],h[t]),e.bbMax[t]=Math.max(e.bbMax[t],a[t],h[t])}}_invalidateBoundingVolume(){this._bvDirty=!0,this._parentLayer&&this._parentLayer.notifyObjectBBChanged(this,{center:this._bvWorldSpace.center,radius:this._bvWorldSpace.bsRadius})}_notifyDirty(t,e,s,i){if(this._parentLayer){s=s||1;const r=i||this;this._parentLayer.notifyDirty(t,e,s,r)}}get test(){const t=this;return{hasGeometry:e=>t._geometries.indexOf(e)>-1,getGeometryIndex:e=>t._geometries.indexOf(e)}}}X._idGen=new S;class P{constructor(){this.bbMin=o(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.bbMax=o(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.bbMax[0]<this.bbMin[0]&&this.bbMax[1]<this.bbMin[1]&&this.bbMax[2]<this.bbMin[2]}}class q extends P{constructor(){super(),this.center=a(),this.bsRadius=0}init(){l(this.bbMin,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l(this.bbMax,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),l(this.center,0,0,0),this.bsRadius=0}getCenter(){return this.center}getBSRadius(){return this.bsRadius}}export{M as G,S as I,X as O,w as a,T as b,E as c,V as d,U as e,G as f,A as g,L as h,I as i,O as j,D as r};
