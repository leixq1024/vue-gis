/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{h as e}from"./object.js";import{clone as t}from"../core/lang.js";import{L as i,i as l,c as n}from"./Logger.js";import r from"../core/Error.js";import{t as a,a as s}from"./screenUtils.js";import{fromJSON as o}from"../symbols/support/jsonUtils.js";import{c as u}from"./clusterUtils2.js";import{b as c,a as f}from"./enums.js";import{a as d}from"./Utils10.js";import{c as p,h as m}from"./MaterialKey.js";import{t as y}from"./util2.js";import{g}from"./visualVariablesUtils2.js";const b=i.getLogger("esri.renderers.visualVariables.support.utils"),h=e=>{if(!("visualVariables"in e)||!e.visualVariables||!e.visualVariables.length)return e;const t=e.clone(),i=t.visualVariables.map((e=>v(e)?w(e):e));return t.visualVariables=i,t};function x(e){return e.map((e=>v(e)?w(e.clone()):e))}function v(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function w(e){return e.stops=function(e,t){if(t.length<=8)return t;if(b.warn(`Found ${t.length} Visual Variable stops, but MapView only supports 8. Displayed stops will be simplified.`),t.length>16)return function(e,t){const[i,...l]=t,n=l.pop(),r=l[0].value,s=l[l.length-1].value,o=(s-r)/6,u=[];for(let i=r;i<s;i+=o){let n=0;for(;i>=l[n].value;)n++;const r=l[n],s=t[n-1],o=i-s.value,c=r.value===s.value?1:o/(r.value-s.value);if("color"===e){const e=l[n],r=t[n-1],a=e.color.clone();a.r=E(r.color.r,a.r,c),a.g=E(r.color.g,a.g,c),a.b=E(r.color.b,a.b,c),a.a=E(r.color.a,a.a,c),u.push({value:i,color:a,label:e.label})}else if("size"===e){const e=l[n],r=t[n-1],s=a(e.size),o=E(a(r.size),s,c);u.push({value:i,size:o,label:e.label})}else{const e=l[n],r=E(t[n-1].opacity,e.opacity,c);u.push({value:i,opacity:r,label:e.label})}}return[i,...u,n]}(e,t);return function(e){const[t,...i]=e,l=i.pop();for(;i.length>6;){let e=0,t=0;for(let l=1;l<i.length;l++){const n=i[l-1],r=i[l],a=Math.abs(r.value-n.value);a>t&&(t=a,e=l)}i.splice(e,1)}return[t,...i,l]}(t)}(e.type,e.stops),e}function E(e,t,i){return(1-i)*e+i*t}const I=i.getLogger("esri.views.2d.layers.features.schemaUtils"),z={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function F(e){return m(e)}function S(e){switch(e.type){case"line-marker":var t;return{type:"line-marker",color:null==(t=e.color)?void 0:t.toJSON(),placement:e.placement,style:e.style};default:return o(e.toJSON()).toJSON()}}function T(e,t,i){if(!e)return null;let n=0,r=!1;switch(l(t)&&"visualVariables"in t&&(n=function(e){if(!e)return c.NONE;let t=0;for(const i of e)if("size"===i.type){const e=g(i);t|=e,"outline"===i.target&&(t|=e<<4)}else"color"===i.type?t|=c.COLOR:"opacity"===i.type?t|=c.OPACITY:"rotation"===i.type&&(t|=c.ROTATION);return t}(t.visualVariables||[]),r="dot-density"===t.type),e.type){case"simple-fill":case"picture-fill":return function(e,t,i,l){const n=p(f.FILL,t,!1,i),r=l?F(n):n,a=e.clone(),s=a.outline;a.outline=null;const o=[],u={materialKey:r,hash:a.hash(),...S(a)};if(o.push(u),s){const e=p(f.LINE,t,!0,!1),i={materialKey:l?F(e):e,hash:s.hash(),...S(s)};o.push(i)}return{type:"composite-symbol",layers:o,hash:o.reduce(((e,t)=>t.hash+e),"")}}(e,n,r,i);case"simple-marker":case"picture-marker":return function(e,t,i){const l=p(f.MARKER,t,!1,!1),n=i?F(l):l,r=S(e);return{materialKey:n,hash:e.hash(),...r,angle:e.angle}}(e,n,i);case"simple-line":return function(e,t,i){const l=p(f.LINE,t,!1,!1),n=i?F(l):l,r=e.clone(),a=r.marker;r.marker=null;const s=[];if(s.push({materialKey:n,hash:r.hash(),...S(r)}),a){var o;const e=p(f.MARKER,t,!1,!1),l=i?F(e):e;a.color=null!=(o=a.color)?o:r.color,s.push({materialKey:l,hash:a.hash(),lineWidth:r.width,...S(a)})}return{type:"composite-symbol",layers:s,hash:s.reduce(((e,t)=>t.hash+e),"")}}(e,n,i);case"text":return function(e,t,i){const l=p(f.TEXT,t,!1,!1),n=i?F(l):l,r=S(e);return{materialKey:n,hash:e.hash(),...r,angle:e.angle}}(e,n,i);case"label":return function(e,t,i){const l=p(f.LABEL,t,!1,!1,e.labelPlacement);return{materialKey:i?F(l):l,hash:e.hash(),...e.toJSON(),labelPlacement:e.labelPlacement}}(e,n,i);case"cim":return{type:"cim",rendererKey:n,data:e.data};case"web-style":return{...S(e),type:"web-style",hash:e.hash(),rendererKey:n};default:throw new Error(`symbol not supported ${e.type}`)}}function V(e,i){const l=t(e);return l.some((e=>function(e,t){const i=e.labelPlacement,l=z[t];if(!e.symbol)return I.warn("No LabelClass symbol specified."),!0;if(!l)return I.error(new r("mapview-labeling:unsupported-geometry-type",`Unable to create labels for Feature Layer, ${t} is not supported`)),!0;if(!l.some((e=>e===i))){const n=l[0];i&&I.warn(`Found invalid label placement type ${i} for ${t}. Defaulting to ${n}`),e.labelPlacement=n}return!1}(e,i)))?[]:l}function N(t){return e("esri-2d-update-debug")&&console.debug("Created new schema",O(t,!0)),O(t)}function O(e,t=!1){try{var i,l;const n=function(e,t=!1){const i=new Array;return i.push(function(e,t,i=!1){const l={indexCount:0,fields:{}},n="featureReduction"in e&&e.featureReduction,a=n?"aggregate":"feature";switch(e.renderer.type){case"heatmap":{const{blurRadius:t,fieldOffset:i,field:n}=e.renderer;return{type:"heatmap",aggregateFields:[],attributes:l,target:a,storage:null,mesh:{blurRadius:t,fieldOffset:i,field:M(l,{target:a,field:n,resultType:"numeric"}).field}}}default:{const t=[],s="aggregate"===a?u(t,e.renderer,n,null):e.renderer;!function(e,t){const i={mesh:!0,storage:!0};for(const l of t){const{name:t,outStatistic:n}=l,{statisticType:r,onStatisticField:a}=n;let s=null,o=null,u=null;const c="numeric",f="feature";if("onStatisticValueExpression"in n){o=k(e,{type:"expression",target:f,valueExpression:n.onStatisticValueExpression,resultType:c}).fieldIndex}else if("onStatisticNormalizationField"in n){s=k(e,{type:"field",target:f,field:a,resultType:c}).field,u=n.onStatisticNormalizationField}else{s=k(e,{type:"field",target:f,field:a,resultType:c}).field}k(e,{type:"statistic",target:"aggregate",name:t,context:i,inField:s,inNormalizationField:u,inFieldIndex:o,statisticType:r})}}(l,t);const o=J(l,a,s,i),c=function(e,t,i){switch(i.type){case"dot-density":return function(e,t,i){if(!i||!i.length)return{type:"dot-density",mapping:[],target:t};return{type:"dot-density",mapping:i.map(((i,l)=>{const{field:n,fieldIndex:r}=M(e,{valueExpression:i.valueExpression,field:i.field,resultType:"numeric",target:t});return{binding:l,field:n,fieldIndex:r}})),target:t}}(e,t,i.attributes);case"simple":case"class-breaks":case"unique-value":return function(e,t,i){if(!i||!i.length)return{type:"visual-variable",mapping:[],target:t};const l={storage:!0},n="numeric";return{type:"visual-variable",mapping:x(i).map((i=>{var r;const a=d(i.type),{field:s,fieldIndex:o}=M(e,{target:t,valueExpression:i.valueExpression,field:i.field,context:l,resultType:n});switch(i.type){case"size":return"$view.scale"===i.valueExpression?null:{type:"size",binding:a,field:s,fieldIndex:o,normalizationField:M(e,{target:t,field:i.normalizationField,context:l,resultType:n}).field,valueRepresentation:null!=(r=i.valueRepresentation)?r:null};case"color":return{type:"color",binding:a,field:s,fieldIndex:o,normalizationField:M(e,{target:t,field:i.normalizationField,context:l,resultType:n}).field};case"opacity":return{type:"opacity",binding:a,field:s,fieldIndex:o,normalizationField:M(e,{target:t,field:i.normalizationField,context:l,resultType:n}).field};case"rotation":return{type:"rotation",binding:a,field:s,fieldIndex:o}}})).filter((e=>e)),target:t}}(e,t,i.visualVariables);case"heatmap":case"dictionary":return null}}(l,a,s),f=y(e.geometryType);let p=e.labelsVisible&&e.labelingInfo||[],m=[];if(n){if("selection"===n.type)throw new r("ValidationError","Mapview does not support `selection` reduction type",n);m=n&&n.labelsVisible&&n.labelingInfo||[]}p=V(p,f),m=V(m,f);let g=0;const b=[...p.map((e=>K(s,l,e,"feature",g++,i))),...m.map((e=>K(s,l,e,"aggregate",g++,i)))];return{type:"symbol",target:a,attributes:l,aggregateFields:t,storage:c,mesh:{matcher:o,labels:b}}}}}(e,t)),i}(e,t),a={};n.map((t=>function(e,t,i){switch(i.target){case"feature":return void L(e,j(t),i);case"aggregate":{const l=t.featureReduction;if("selection"===l.type)throw new r("ValidationError","Mapview does not support `selection` reduction type",l);return L(e,j(t),i),void function(e,t,i){e.aggregate||(e.aggregate={name:"aggregate",input:"feature",filters:null,attributes:{},params:{clusterRadius:s(t.clusterRadius/2),clusterPixelBuffer:64*Math.ceil(s(t.clusterMaxSize)/64),fields:i.aggregateFields}});R(e.aggregate,i.attributes.fields)}(e,l,i)}}}(a,e,t)));return{source:{definitionExpression:e.definitionExpression,fields:e.fields.map((e=>e.toJSON())),gdbVersion:e.gdbVersion,historicMoment:null==(i=e.historicMoment)?void 0:i.getTime(),outFields:e.availableFields,pixelBuffer:e.pixelBuffer,spatialReference:e.spatialReference.toJSON(),timeExtent:null==(l=e.timeExtent)?void 0:l.toJSON()},attributes:{fields:{},indexCount:0},processors:n,targets:a}}catch(e){if("ValidationError"===e.fieldName)return I.error(e),null;throw e}}function R(e,t){for(const i in t){const l=t[i];if(l.target!==e.name)continue;const n=e.attributes[i];n?(n.context.mesh=n.context.mesh||l.context.mesh,n.context.storage=n.context.storage||l.context.storage):e.attributes[i]=l}return e}function j(e){var t,i,l,n,r;return[null!=(t=null==(i=e.filter)?void 0:i.toJSON())?t:null,null!=(l=null==(n=e.effect)||null==(r=n.filter)?void 0:r.toJSON())?l:null]}function L(e,t,i){return e.feature||(e.feature={name:"feature",input:"source",filters:t,attributes:{}}),R(e.feature,i.attributes.fields),e}function M(e,t){return t.field?k(e,{...t,type:"field",field:t.field}):t.valueExpression?k(e,{...t,type:"expression",valueExpression:t.valueExpression}):{field:null,fieldIndex:null}}function k(e,t){switch(t.type){case"expression":{const i=t.valueExpression;if(!e.fields[i]){const l=e.indexCount++;e.fields[i]={...t,name:i,fieldIndex:l}}return{fieldIndex:e.fields[i].fieldIndex}}case"label-expression":{const i=JSON.stringify(t.label);if(!e.fields[i]){const l=e.indexCount++;e.fields[i]={...t,name:i,fieldIndex:l}}return{fieldIndex:e.fields[i].fieldIndex}}case"field":{const i=t.field;return"aggregate"===t.target&&e.fields[i]||(e.fields[i]={...t,name:i}),{field:i}}case"statistic":return e.fields[t.name]={...t},{field:t.name}}}function K(e,t,i,l,n,r=!1){const a=k(t,{type:"label-expression",target:l,context:{mesh:!0},resultType:"string",label:{labelExpression:i.labelExpression,labelExpressionInfo:i.labelExpressionInfo?{expression:i.labelExpressionInfo.expression}:null,symbol:!!i.symbol,where:i.where}}),{fieldIndex:s}=a;return{...T(i,e,r),fieldIndex:s,target:l,index:n}}function J(e,t,i,l=!1){const a=n(e,{indexCount:0,fields:{}});switch(i.type){case"simple":case"dot-density":return function(e,t,i,l=!1){const n=t.getSymbols();return{type:"simple",symbol:T(n.length?n[0]:null,t,l),isDotDensity:i}}(0,i,"dot-density"===i.type,l);case"class-breaks":return function(e,t,i,l=!1){const n={mesh:!0,use:"renderer.field"},r=i.backgroundFillSymbol,{field:a,fieldIndex:s}=M(e,{target:t,field:i.field,valueExpression:i.valueExpression,resultType:"numeric",context:n}),o=i.normalizationType,u="log"===o?"esriNormalizeByLog":"percent-of-total"===o?"esriNormalizeByPercentOfTotal":"field"===o?"esriNormalizeByField":null,c=i.classBreakInfos.map((e=>({symbol:T(e.symbol,i,l),min:e.minValue,max:e.maxValue}))).sort(((e,t)=>e.min-t.min));return{type:"interval",attributes:e.fields,field:a,fieldIndex:s,backgroundFillSymbol:T(r,i,l),defaultSymbol:T(i.defaultSymbol,i,l),intervals:c,normalizationField:i.normalizationField,normalizationTotal:i.normalizationTotal,normalizationType:u,isMaxInclusive:i.isMaxInclusive}}(a,t,i,l);case"unique-value":return function(e,t,i,l=!1){const n=[],a=i.backgroundFillSymbol,s={target:t,context:{mesh:!0},resultType:"string"};if(i.field&&"string"!=typeof i.field)throw new r("ValidationError","Expected renderer.field to be a string",i);const{field:o,fieldIndex:u}=M(e,{...s,field:i.field,valueExpression:i.valueExpression});for(const e of i.uniqueValueInfos)n.push({value:""+e.value,symbol:T(e.symbol,i,l)});return{type:"map",attributes:e.fields,field:o,fieldIndex:u,field2:M(e,{...s,field:i.field2}).field,field3:M(e,{...s,field:i.field3}).field,fieldDelimiter:i.fieldDelimiter,backgroundFillSymbol:T(a,i),defaultSymbol:T(i.defaultSymbol,i),map:n}}(a,t,i,l);case"dictionary":return function(e,t,i=!1){return{type:"dictionary",renderer:t.toJSON()}}(0,i,l)}}export{T as a,N as b,J as c,h as s};
