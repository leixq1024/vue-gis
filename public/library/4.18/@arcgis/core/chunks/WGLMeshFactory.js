/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"./object.js";import{L as t,k as e,i as s,b as i,u as r,c as n}from"./Logger.js";import{all as o,reject as a,resolve as l,createResolver as h,create as c,isAbortError as u,isAborted as f}from"../core/promiseUtils.js";import m from"../core/Error.js";import{c as d,l as p,n as _}from"./mathUtils2.js";import{getJsonType as y}from"../geometry/support/jsonUtils.js";import{a as x}from"./arcadeOnDemand.js";import{a as g,t as M}from"./screenUtils.js";import w from"../symbols/WebStyleSymbol.js";import"../symbols/support/jsonUtils.js";import{d as b}from"./utils3.js";import{L as T}from"./LRUCache.js";import{s as v,t as L}from"./vec2.js";import{a as C,b as S,e as P}from"./defaults.js";import{b as z}from"./OptimizedGeometry.js";import{y as I,b as k}from"./featureConversionUtils.js";import{M as R,r as F,S as A,P as O,j as D,T as G,s as V,t as B}from"./definitions.js";import{s as j,c as E,g as W,a as K,b as Z,d as X,e as U,f as H}from"./BidiText.js";import{i as N,t as q,r as Y}from"./mat2d.js";import{c as Q}from"./mat2df32.js";import{f as $,c as J}from"./vec2f32.js";import{a as tt,i as et}from"./number2.js";import{c as st}from"./callExpressionWithFeature.js";import{p as it,a as rt}from"./visualVariablesUtils.js";import{a as nt}from"./enums.js";import{b as ot,d as at,e as lt}from"./Utils10.js";import{r as ht,d as ct}from"./GeometryUtils2.js";import{c as ut,b as ft,i as mt,L as dt,M as pt,F as _t,a as yt,T as xt}from"./MaterialKey.js";import{d as gt,a as Mt,n as wt,i as bt,S as Tt,t as vt,c as Lt,g as Ct}from"./TurboLine.js";import{g as St,c as Pt,a as zt,d as It,b as kt}from"./CIMSymbolHelper.js";import{T as Rt,a as Ft}from"./TileClipper.js";import{a as At,b as Ot}from"./cimAnalyzer.js";import{W as Dt,V as Gt,M as Vt,a as Bt}from"./VertexBuffer.js";import{a as jt}from"./schemaUtils.js";function Et(t,e){if(t&&"name"in t){const s=t;return e&&e.error(new m(s.name,s.message,s.details)),!1}return!0}const Wt={marker:nt.MARKER,fill:nt.FILL,line:nt.LINE,text:nt.TEXT};class Kt{constructor(t,e,s){this.layers=t,this.data=e,this.hash=this._createHash(),this.rendererKey=s;for(const e of t){const t=Wt[e.type];e.materialKey=ut(t,this.rendererKey,!1,!1)}}get type(){return"expanded-cim"}_createHash(){let t="";for(const e of this.layers)t+=e.templateHash;return t}}const Zt=async(t,e)=>new Kt(await At(t.data,e),t.data,t.rendererKey),Xt=async(t,e,s)=>{if(!t)return null;if("cim"===t.type)return Zt(t,e);if("web-style"===t.type){const i=w.fromJSON(t),r={type:"cim",data:(await i.fetchCIMSymbol(s)).data,rendererKey:t.rendererKey};return Zt(r,e)}return t},Ut=t.getLogger("esri/views/2d/engine/webgl/util/Matcher");class Ht{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,s){const i=new Ht;if(t.symbol){const r=await Xt(t.symbol,s),n=e.createTemplateGroup(r,null);i.setDefault(n)}return i}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,s,i,r){return this.getDefault()}async analyze(t,e,s,i,r){return null}}class Nt extends Ht{constructor(t,e,s,i){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=i,this._field=t,this._normalizationInfo=s}static async fromCBRenderer(t,e,s){const{isMaxInclusive:i,normalizationField:r,normalizationTotal:n,normalizationType:a}=t,l=t.field,h=new Nt(l,i,{normalizationField:r,normalizationTotal:n,normalizationType:a},t.fieldIndex),c=await Xt(t.backgroundFillSymbol,s);await o(t.intervals.map((async t=>{const i=await Xt(t.symbol,s),r=await e.createTemplateGroup(i,c),n={min:t.min,max:t.max};h.add(n,r)})));const u=await Xt(t.defaultSymbol,s);if(u){const t=await e.createTemplateGroup(u,c);h.setDefault(t)}return h}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort(((t,e)=>t.interval.min-e.interval.min))}size(){return super.size()+this._intervals.length}match(t,e,s,i,r){if(null==this._fieldIndex&&!this._field)return this.getDefault();const n=null!=this._fieldIndex?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(!n&&(null==n||isNaN(n)))return this.getDefault();for(let t=0;t<this._intervals.length;t++){const{interval:e,result:s}=this._intervals[t],i=n>=e.min,r=this._isMaxInclusive?n<=e.max:n<e.max;if(i&&r)return s}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization())return e;const{normalizationField:s,normalizationTotal:i,normalizationType:r}=this._normalizationInfo,n=!!s&&t.readAttribute(s);if(r)switch(r){case"esriNormalizeByField":return n?e/n:void 0;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/i*100;default:return void Ut.error(`Found unknown normalization type: ${r}`)}else Ut.error("Normalization is required, but no type was set!")}}class qt extends Ht{constructor(t,e,s){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=s,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,s){const i=t.fieldDelimiter,r=[t.field];t.field2&&r.push(t.field2),t.field3&&r.push(t.field3);const n=await Xt(t.backgroundFillSymbol,s),a=new qt(r,i,t.fieldIndex);await o(t.map.map((async t=>{const i=await Xt(t.symbol,s),r=await e.createTemplateGroup(i,n);"<Null>"===t.value?a.setNullResult(r):a.add(t.value,r)})));const l=await Xt(t.defaultSymbol,s);if(l){const t=await e.createTemplateGroup(l,n);a.setDefault(t)}return a}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,s,i,r){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const n=null!=this._fieldsIndex?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(null!==this._nullResult&&(null==n||""===n||"<Null>"===n))return this._nullResult;if(!n&&null==n)return this.getDefault();const o=n.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()}_getValueFromFields(t){const e=[];for(const s of this._fields){const i=t.readAttribute(s);e.push(i)}return e.join(this._seperator)}}class Yt extends Ht{constructor(t,e,s,i){super(),this.type="dictionary",this._groupIdCache=new T(100),this._renderer=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=s,this._scaleFn=i}static async fromDictionaryRenderer(t,e,s){const i=(await import("../renderers/DictionaryRenderer.js")).default.fromJSON(t.renderer);await i.fetchResources({spatialReference:s.spatialReference,fields:s.fields});const r=await async function(t,e){const s=t||1;if("number"==typeof s)return(t,e,i)=>s;const i=await x(s,e.spatialReference,e.fields);return(t,s,r)=>st(i,t,{$view:r},e.geometryType,s)||1}(i.scaleExpression,s);return new Yt(i,e,s,r)}async _analyzeFeature(t,e,s,i){const r=t.readLegacyFeature(),n=this._scaleFn(r,e,s),o=this._attributeHash(r)+"-"+n,a=this._groupIdCache.get(o);if(a)return a;const l={...s,spatialReference:this._info.spatialReference,abortOptions:i,fields:this._info.fields},h=await this._renderer.getSymbolAsync(r,l),c=jt(h,this._renderer),u=Xt(c,this._info,i).then((t=>{if("expanded-cim"!==t.type)return Ut.error(new m("mapview-bad-type",`Found unexpected type ${t.type} in dictionary response`)),null;t.hash+="-"+n;for(const e of t.layers)e.scaleFactor=n,e.templateHash+="-"+n,"text"===e.type&&"string"==typeof e.text&&e.text.indexOf("[")>-1&&(e.text=b(this._fieldMap,e.text,e.cim.textCase));return this._templates.createTemplateGroup(t,null)}));return this._groupIdCache.put(o,u,1),u}async analyze(t,e,s,i,r){const n=e.getCursor(),a=[];for(;n.next();)a.push(this._analyzeFeature(n,s,i,r));return o(a)}match(t,e,s,i,r){return null}_attributeHash(t){let e="";for(const s of this._symbolFields){const i=this._fieldMap[s];i&&(e+=t.attributes[i]+"-")}return e}}const Qt=t.getLogger("esri/views/2d/engine/webgl/mesh/factories/matcherUtils");async function $t(t,e,s){switch(t.type){case"simple":return Ht.fromBasicRenderer(t,e,s);case"map":return qt.fromUVRenderer(t,e,s);case"interval":return Nt.fromCBRenderer(t,e,s);case"dictionary":return Yt.fromDictionaryRenderer(t,e,s);default:return Qt.error(new m("mapview-mesh:invalid-renderer","Unable to handle unknown renderer type")),null}}class Jt{constructor(t,e){this.data=t,this.stride=e}get vertexCount(){const t=this.stride/4,e=this.data.length/t;return e!==(0|e)&&console.debug("Corrupted stride"),e}transfer(t,e){const s=this.data.buffer();t.vertexCount=this.vertexCount,t.data=s,t.stride=this.stride,e.push(s)}}class te{constructor(t,e,s=!1){this.geometryType=t,this.indexVector=new Dt(Uint32Array,6*e),this.namedVectors={};const i=ot(t,s);for(const t in i){const s=i[t];let r;switch(s%4){case 0:case 2:r=new Dt(Uint32Array,s*e);break;case 1:case 3:r=new Dt(Uint8Array,s*e)}this.namedVectors[t]=new Jt(r,s)}}get(t){return this.namedVectors[t].data}getVector(t){return this.namedVectors[t]}transfer(t,e){const s=this.indexVector.buffer(),i={};e.push(s);for(const t in this.namedVectors){const s=this.namedVectors[t];i[t]={},s.transfer(i[t],e)}t.geometryType=this.geometryType,t.indexBuffer=s,t.namedBuffers=i,this.destroy()}intoBuffers(){const t=Gt.fromVertexVectors(this);return this.destroy(),t}destroy(){this.indexVector=null,this.namedVectors=null}}function ee(t){return t.length-1}function se(t,e,s=1){const[i,r]=function(t,e){return t[e+1]}(t,e);return Math.sqrt(i*i+r*r)*s}class ie{constructor(t,e,s,i,r){this._segments=t,this._index=e,this._distance=s,this._xStart=i,this._yStart=r,this._done=!1}static create(t){return new ie(t,0,0,t[0][0],t[0][1])}clone(){return new ie(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(0===this._distance||1===t._distance)||t._index===this._index+1&&(1===this._distance||0===t._distance)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let s=Math.acos(e);return t>0&&(s=2*Math.PI-s),s}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<ee(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const s=this.backwardLength;if(t<=s)return this._distance=(s-t)/this.length,this;let i=this.backwardLength;for(;this.prev();){if(i+this.length>t)return this._seekBackwards(t-i);i+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let s=this.remainingLength;for(;this.next();){if(s+this.length>t)return this.seek(t-s,e);s+=this.length}return this._distance=1,e?this:null}}function re(t,e,s){const i=function(t){let e=0;for(let s=0;s<ee(t);s++)e+=se(t,s);return e}(t),r=ie.create(t),n=i/2,o=(i-e)/2,a=Math.floor(o/e),l=n-a*e;r.seek(l);for(let t=-a;t<=a;t++)r.x<512&&r.x>=0&&r.y<512&&r.y>=0&&s(r.clone(),t,n+t*e,i),r.seek(e)}function ne(t,e){const s=1e-6;if(e<=0)return;const i=t.length;if(i<3)return;const r=[];let n=0;r.push(0);for(let e=1;e<i;e++)n+=gt(t[e],t[e-1]),r.push(n);e=Math.min(e,.2*n);const o=[];o.push(t[0][0]),o.push(t[0][1]);const a=t[i-1][0],l=t[i-1][1],h=Mt([0,0],t[0],t[1]);wt(h),t[0][0]+=e*h[0],t[0][1]+=e*h[1],Mt(h,t[i-1],t[i-2]),wt(h),t[i-1][0]+=e*h[0],t[i-1][1]+=e*h[1];for(let t=1;t<i;t++)r[t]+=e;r[i-1]+=e;const c=.5*e;for(let n=1;n<i-1;n++){let a=0,l=0,h=0;for(let i=n-1;i>=0&&!(r[i+1]<r[n]-c);i--){const o=c+r[i+1]-r[n],u=r[i+1]-r[i],f=r[n]-r[i]<c?1:o/u;if(Math.abs(f)<s)break;const m=f*f,d=f*o-.5*m*u,p=f*u/e,_=t[i+1],y=t[i][0]-_[0],x=t[i][1]-_[1];a+=p/d*(_[0]*f*o+.5*m*(o*y-u*_[0])-m*f*u*y/3),l+=p/d*(_[1]*f*o+.5*m*(o*x-u*_[1])-m*f*u*x/3),h+=p}for(let o=n+1;o<i&&!(r[o-1]>r[n]+c);o++){const i=c-r[o-1]+r[n],u=r[o]-r[o-1],f=r[o]-r[n]<c?1:i/u;if(Math.abs(f)<s)break;const m=f*f,d=f*i-.5*m*u,p=f*u/e,_=t[o-1],y=t[o][0]-_[0],x=t[o][1]-_[1];a+=p/d*(_[0]*f*i+.5*m*(i*y-u*_[0])-m*f*u*y/3),l+=p/d*(_[1]*f*i+.5*m*(i*x-u*_[1])-m*f*u*x/3),h+=p}o.push(a/h),o.push(l/h)}o.push(a),o.push(l);for(let e=0,s=0;e<i;e++)t[e][0]=o[s++],t[e][1]=o[s++]}class oe{static getPlacement(t,e,s){const i=St(e);if(!i)return null;const r=Pt(t);return i.execute(r,e,s)}}const ae=t=>class extends t{constructor(...t){super(...t),this._isCIM=!1,this.geometryType=nt.TEXT,this._aux=tt(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,s){t&&t.length?this._shapingInfo=e(t,(t=>j(t,s,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:R*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM}))):this._shapingInfo=null}writeMeshWithGeometry(t,e,i,r,n,o){if(s(this._textPlacement)){const s=null!=o?o:i.readLegacyGeometry();return this._writePlacedText(t,e,n,s)}const a=o?I(k(o),2):"esriGeometryPolygon"===r?i.readCentroid():i.readUnquantizedGeometry();if(a){if(a.isPoint){const[s,i]=a.coords;return this._writeGlyphs(t,e,n,{x:s,y:i})}a.forEachVertex(((s,i)=>this._writeGlyphs(t,e,n,{x:s,y:i})))}}_writePlacedText(t,e,s,n){const o=this._shapingInfo;if(i(o))return;const a=ft.load(this._materialKey),l=r(this._textPlacement),h=oe.getPlacement(n,l,g(1));if(!h)return;let c,u,f=h.next();for(;null!=f;){u=et(Math.round(8*f.tx),Math.round(8*f.ty)),c=f.getAngle(),o.setRotation(c);for(const i of o.glyphs){a.textureBinding=i.textureBinding;const r=e.getVector("geometry").vertexCount,n=e.indexVector.length,o=this._writeIndices(e),l=this._writeVertex(e,s,u,i);t.writeDisplayRecord(this.geometryType,a.data,r,l,n,o)}o.setRotation(-c),f=h.next()}}_writeGlyphs(t,e,s,r){const n=this._shapingInfo;if(i(n))return;const o=ft.load(this._materialKey),a=et(Math.round(8*r.x),Math.round(8*r.y));for(const i of n.glyphs){o.textureBinding=i.textureBinding;const r=e.getVector("geometry").vertexCount,n=e.indexVector.length,l=this._writeIndices(e),h=this._writeVertex(e,s,a,i);t.writeDisplayRecord(this.geometryType,o.data,r,h,n,l)}}_writeVertexCommon(t,e,s,i){const r=this._color,n=this._haloColor,o=tt(0,0,this._referenceSize,this._bitset),a=tt(0,0,this._size,this._haloSize);t.push(s),t.push(e),t.push(r),t.push(n),t.push(a),t.push(o)}_writeVertex(t,e,s,i){const r=t.get("geometry");return this._writeVertexCommon(r,e,s,i),r.push(i.offsets.upperLeft),r.push(i.texcoords.upperLeft),this._writeVertexCommon(r,e,s,i),r.push(i.offsets.upperRight),r.push(i.texcoords.upperRight),this._writeVertexCommon(r,e,s,i),r.push(i.offsets.lowerLeft),r.push(i.texcoords.lowerLeft),this._writeVertexCommon(r,e,s,i),r.push(i.offsets.lowerRight),r.push(i.texcoords.lowerRight),4}_writeIndices(t){const e=t.getVector("geometry").vertexCount,s=t.indexVector;return s.push(e+0),s.push(e+1),s.push(e+2),s.push(e+1),s.push(e+3),s.push(e+2),6}};class le{static executeEffects(t,e){const s=Pt(e);let i=new kt(s);for(const e of t){const t=zt(e);t&&(i=t.execute(i,e,1.3333333333333333))}return i}static next(t){const e=t.next();return It(e),e}}class he{get needsPixelBuffer(){return!!this.effects||this.geometryType===nt.MARKER||this.geometryType===nt.TEXT||this.geometryType===nt.LABEL}writeMesh(t,e,s,r,n){if(i(this.effects))return this.writeMeshWithGeometry(t,e,s,r,n);const o=le.executeEffects(this.effects,s.readLegacyGeometry());let a=le.next(o);for(;a;)this.writeMeshWithGeometry(t,e,s,y(a),n,a),a=le.next(o)}writeMeshWithGeometry(t,e,s,i,r,n){}bindFeature(t,e,s){}}class ce extends(ae(he)){constructor(t,e,s,i,r,n,o,a,l,h,c,u,f,m,d,p,_,y=!1){super(),this._xOffset=g(u),this._yOffset=g(f),this._decoration=l||"none",this._color=i,this._haloColor=r,this._haloSize=Math.min(Math.floor(5*g(M(s))),127),this._size=Math.min(Math.round(g(e)),127);const x=Math.min(Math.round(g(e)),127);this._referenceSize=Math.round(Math.sqrt(256*x)),this._scale=this._size/24,this._angle=c,this._justify=E(n||"center"),this._xAlignD=W(n||"center"),this._yAlignD=K(o||"baseline"),this._baseline="baseline"===(o||"baseline"),this._bitset=(1===a?1:0)|(h?1:0)<<1;const w=ft.load(t);w.sdf=!0,this._materialKey=w.data,this._lineWidth=g(m)||512,this._lineHeight=d||1,this._textPlacement=p,this.effects=_,this._isCIM=y}static fromText(t,e){const s=new ce(t.materialKey,t.font.size,t.haloSize||0,t.color&&it(t.color)||0,t.haloColor&&it(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,0,t.font.decoration,!1,t.angle||0,t.xoffset,t.yoffset,t.lineWidth,t.lineHeight,null,null,!1),[,i]=Z(t.text);return s.bindTextInfo(e,i),s}static fromCIMText(t,e){const s=t.scaleFactor||1,i=new ce(t.materialKey,t.size*t.sizeRatio*s,t.outlineSize*t.sizeRatio,rt(t.color),rt(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked,t.angle,t.offsetX*t.sizeRatio*s,t.offsetY*t.sizeRatio*s,512,1,t.markerPlacement,t.effects,!0),[,r]=Z(t.text);return i.bindTextInfo(e,r),i}}const ue=t.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate");const fe=function(t){const e=new Map;return s=>(e.has(s)||e.set(s,t(s)),e.get(s))}((t=>{let e=0;if(0===t)return 1/0;for(;!(t%2);)e++,t/=2;return e})),me=t=>Math.floor(127*t+127),de=t=>Math.floor(10*t),pe=t=>Math.round(t*(254/360)),_e=(t,e)=>et(Math.round(8*t),Math.round(8*e));class ye extends ce{constructor(t,e,s,i){super(t,s.font.size,s.haloSize||0,s.color&&it(s.color)||0,s.haloColor&&it(s.haloColor)||0,s.horizontalAlignment,s.verticalAlignment,mt(e.labelPlacement)?1:0,s.font.decoration,!1,s.angle||0,s.xoffset,s.yoffset,s.lineWidth,s.lineHeight,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this.geometryType=nt.LABEL;const r=function(t,e){const s=!!t.minScale&&e.scaleToZoom(t.minScale)||0;return d(s,0,25.5)}(e,i),n=function(t,e){const s=!!t.maxScale&&e.scaleToZoom(t.maxScale)||255;return d(s,0,25.5)}(e,i),o=e.labelPlacement,[a,l]=X(o);this._xAlignD=a,this._yAlignD=l,this._minZoom=r,this._maxZoom=n,this._refPlacementPadding=g(s.haloSize)+F;const h=dt.load(t);h.sdf=!0,this._materialKey=h.data}static fromLabelClass(t,e){if("center-along"===t.labelPlacement){const e=t.symbol;e.xoffset=0,e.yoffset=0,e.angle=0,e.font.decoration="none"}return new ye(t.materialKey,t,t.symbol,e)}get _shapedBox(){return r(this._shapingInfo).bounds}bindReferenceTemplate(t){let e=U(this._xAlignD),s=H(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,i(t))return void(this._refSymbolAndPlacementOffset=tt(0,0,me(e),me(s)));if("circle"===t.boundsType&&(e||s)){const t=Math.sqrt(e*e+s*s);e/=t,s/=t}const r=Math.max(t.height,t.width),n=4*this._refPlacementPadding;this._refSymbolAndPlacementOffset=tt(n,r,me(e),me(s)),this._referenceSize=r,this._refPlacementDirX=e,this._refPlacementDirY=s,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}writeMesh(t,e,s,r,n,o){if(i(this._shapingInfo))return;const a=new Array,l=this._shapingInfo,h="esriGeometryPolygon"===s.geometryType?s.readLegacyCentroid():s.readLegacyGeometry();if(h){switch(this.current={out:t,outVecs:e,outMetrics:a,inId:n,inShaping:l,zoomLevel:o},r){case"esriGeometryPolyline":this._placeLineLabels(h);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(h);break;default:((t,e="mapview-labeling")=>{ue.error(new m(e,t))})("mapview-labeling",`Geometry of type ${r} is not supported`)}t.writeMetrics(this.current.outMetrics)}}_isVisible(t,e){const s=de(this.current.zoomLevel);return de(t)<=s&&s<=de(e)}_placePointLabels(t){const{out:e,outVecs:s,outMetrics:i,inId:r}=this.current;this._writeGlyphs(e,s,r,t,i)}_placeLineLabels(t){const e=function(t,e){const s=e;for(let e=0;e<t.length;e++){let i=t[e];const r=[];r.push(i[0]);for(let t=1;t<i.length;t++){let[e,s]=r[t-1];e+=i[t][0],s+=i[t][1],r.push([e,s])}ne(r,s);const n=[];n.push(r[0]);for(let t=1;t<r.length;t++){const[e,s]=r[t-1],[i,o]=r[t],a=Math.round(i-e),l=Math.round(o-s);n.push([a,l])}t[e]=n,i=n}return t}(t.paths,this.current.inShaping.bounds.width),s=this._placeSubdivGlyphs.bind(this),i=(this._shapedBox.width+128)/4;for(const t of e)re(t,i,s)}_placeSubdivGlyphs(t,e,s,i){const r=fe(e),n=this._shapedBox.width/4,o=Math.min(s,i-s),a=p(o/(4+n/2)),l=0===e?a:Math.min(r,a),h=Math.max(this._minZoom,this.current.zoomLevel+2-l),c=this.current.zoomLevel-h,u=this._shapedBox.width/2*Math.pow(2,c);this.current.inShaping.isMultiline?0===e&&this._placeStraight(t,h):this._placeCurved(t,h,u)}_placeStraight(t,e){const{out:s,outVecs:i,outMetrics:r,inId:n}=this.current;this._writeGlyphs(s,i,n,t,r,e)}_placeCurved(t,e,s){const i={from:this.current.out.currentDisplayRecordCount(),count:-1},r=new Vt(this.current.inId,i,t.x,t.y,e),n=t.clone(),o=t.angle*(180/Math.PI)%360,a=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=pe(o),this._placeFirst(n,r,e,1),this._placeBack(t,n,r,e,s,1),this._placeForward(t,n,r,e,s,1),this._outLineLabelAngle=pe(a),this._placeFirst(n,r,e,0),this._placeBack(t,n,r,e,s,0),this._placeForward(t,n,r,e,s,0),r.range.count=this.current.out.currentDisplayRecordCount()-r.range.from,r.bounds&&this.current.outMetrics.push(r)}_placeBack(t,e,s,i,r,n){const o=t.clone();let a=t.backwardLength+0;for(;o.prev()&&!(a>=r);)this._placeOnSegment(o,e,s,a,i,-1,n),a+=o.length+0}_placeForward(t,e,s,i,r,n){const o=t.clone();let a=t.remainingLength+0;for(;o.next()&&!(a>=r);)this._placeOnSegment(o,e,s,a,i,1,n),a+=o.length+0}_placeFirst(t,e,s,i){const r=t,n=this.current.inShaping,o=n.glyphs,a=this.current.zoomLevel,{out:l,outVecs:h,inId:c}=this.current,u=_e(r.x,r.y);for(const r of o){const o=r.x>n.bounds.x?i:1-i,f=o*t.remainingLength+(1-o)*t.backwardLength,m=Math.abs(r.x+r.width/2-n.bounds.x),d=Math.max(0,a+p(m/(f+0))),_=Math.max(s,d);r.maxZoom=25,r.angle=t.angle+(1-i)*Math.PI,r.minZoom=_,this._writeGlyph(l,h,r,c,u),i&&this._isVisible(r.minZoom,r.maxZoom)&&e.add(r.bounds,0,0)}}_placeOnSegment(t,e,s,i,r,n,o){const a=this.current.inShaping.glyphs,{out:l,outVecs:h,inId:c}=this.current,u=this.current.inShaping,f=this.current.zoomLevel,m=t.dx/t.length,d=t.dy/t.length,_={x:t.x+i*-n*m,y:t.y+i*-n*d},y=_e(_.x,_.y);for(const m of a){const a=m.x>u.bounds.x?o:1-o;if(!(a&&1===n||!a&&-1===n))continue;const d=Math.abs(m.x+m.width/2-u.bounds.x),_=Math.max(0,f+p(d/i)-.1),x=Math.max(r,f+p(d/(i+t.length+0)));0!==_&&(m.angle=t.angle+(1-o)*Math.PI,m.minZoom=x,m.maxZoom=_,this._writeGlyph(l,h,m,c,y),o&&this._isVisible(m.minZoom,m.maxZoom)&&s.add(m.bounds,t.x-e.x,t.y-e.y))}}_writeGlyphs(t,e,s,r,n,o=this._minZoom){const a=this._shapingInfo;if(i(a))return;if(r.x<0||r.x>=512||r.y<0||r.y>=512)return;const l=t.currentDisplayRecordCount(),h=_e(r.x+this._refOffsetX,r.y-this._refOffsetY),c=new Vt(s,{from:l,count:-1},r.x+this._refOffsetX,r.y-this._refOffsetY,o);for(const i of a.glyphs)i.minZoom=o,i.maxZoom=this._maxZoom,this._writeGlyph(t,e,i,s,h);c.range.count=t.currentDisplayRecordCount()-c.range.from,c.bounds=a.boundsT;const u=dt.load(this._materialKey),f=this._refPlacementDirX,m=this._refPlacementDirY,d=u.vvSizeFieldStops||u.vvSizeMinMaxValue||u.vvSizeScaleStops||u.vvSizeUnitValue;c.setPlacementOffset(d,this._referenceSize,this._refPlacementPadding,f,m),n.push(c)}_writeGlyph(t,e,s,i,r){const n=ft.load(this._materialKey);n.textureBinding=s.textureBinding;const o=e.indexVector.length,a=e.getVector("geometry").vertexCount,l=this._writeIndices(e),h=this._writeVertex(e,i,r,s);t.writeDisplayRecord(this.geometryType,n.data,a,h,o,l)}_writeVertexCommon(t,e,s,i){const r=this._color,n=this._haloColor,o=tt(0,0,this._size,this._haloSize),a=Math.max(i.minZoom,this._minZoom),l=Math.min(i.maxZoom,this._maxZoom),h=tt(de(a),de(l),this._outLineLabelAngle,0);t.push(s),t.push(e),t.push(r),t.push(n),t.push(o),t.push(this._refSymbolAndPlacementOffset),t.push(h)}}const xe=t=>class extends t{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this.geometryType=nt.MARKER}writeMeshWithGeometry(t,e,i,r,n,o){const a=e.indexVector,l=e.get("geometry"),h=e.getVector("geometry"),c=h.vertexCount,u=c,f=a.length;if(s(this._markerPlacement)){const t=null!=o?o:i.readLegacyGeometry();this._writePlacedMarkers(l,a,c,n,t)}else{const t=o?I(k(o),2):"esriGeometryPolygon"===r?i.readCentroid():i.readUnquantizedGeometry();if(!t)return;if(t.isPoint){const[e,s]=t.coords;this._writeVertices(l,n,this._getPos(e,s)),this._writeIndices(a,c)}else t.forEachVertex(((t,e)=>{const s=h.vertexCount;this._writeVertices(l,n,this._getPos(t,e)),this._writeIndices(a,s)}))}const m=e.getVector("geometry").vertexCount-u,d=a.length-f;t.writeDisplayRecord(this.geometryType,this._materialKey,u,m,f,d)}_applyTransformation(t,e,s=0){N(t),q(t,t,$(this.xOffset,-this.yOffset)),this.angle+s!==0&&Y(t,t,.017453292519944444*(this.angle+s));const i=this._computedWidth,r=this._computedHeight,n=(this._anchorX-.5)*i,o=(this._anchorY-.5)*r;v(e,n,o),L(e,e,t),this._offsetUpperLeft=et(16*e[0],16*e[1]),v(e,n+i,o),L(e,e,t),this._offsetUpperRight=et(16*e[0],16*e[1]),v(e,n,o+r),L(e,e,t),this._offsetBottomLeft=et(16*e[0],16*e[1]),v(e,n+i,o+r),L(e,e,t),this._offsetBottomRight=et(16*e[0],16*e[1])}_writePlacedMarkers(t,e,s,i,n){const o=oe.getPlacement(n,r(this._markerPlacement),g(1));if(!o)return;const a=J(),l=Q();let h=0,c=o.next();for(;null!=c;)c.tx>=-128&&c.tx<=640&&c.ty>=-128&&c.ty<=640&&(this._applyTransformation(l,a,c.getAngle()/.017453292519944444),this._writeVertices(t,i,this._getPos(c.tx,c.ty)),this._writeIndices(e,s+h),h+=4),c=o.next()}_getPos(t,e){return et(Math.round(8*t),Math.round(8*e))}_writeVertices(t,e,s){t.push(s),t.push(this._offsetUpperLeft),t.push(this._texUpperLeft),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(s),t.push(this._offsetUpperRight),t.push(this._texUpperRight),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(s),t.push(this._offsetBottomLeft),t.push(this._texBottomLeft),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth),t.push(s),t.push(this._offsetBottomRight),t.push(this._texBottomRight),t.push(this._bitestAndDistRatio),t.push(e),t.push(this._fillColor),t.push(this._outlineColor),t.push(this._sizeOutlineWidth)}_writeIndices(t,e){const s=e;t.push(s+0),t.push(s+1),t.push(s+2),t.push(s+1),t.push(s+3),t.push(s+2)}};class ge extends(xe(he)){constructor(t,e,s,i,r,n,o,a,l,h,c,u,f,m,d,p,_,y,x,g,M){super(),this.angle=i,this.height=o,this.width=n,this.xOffset=e*x,this.yOffset=s*x,this._markerPlacement=g,this.effects=M,this._anchorX=.5-(.5+p)*d.width/d.width,this._anchorY=.5-(.5+_)*d.height/d.height;const w=(1===m?1:0)|(c?1:0)<<1|(f?1:0)<<2|(u?1:0)<<3,b=d&&d.sdf,T=pt.load(t);T.sdf=b,T.pattern=!0,T.textureBinding=d.textureBinding,this._materialKey=T.data,this._fillColor=r,this._outlineColor=l,this._sizeOutlineWidth=tt(Math.round(Math.min(Math.sqrt(128*n),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*h),255)),Math.round(Math.min(Math.sqrt(128*a),255)));const v=d.rect.x+A,L=d.rect.y+A,C=v+d.width,S=L+d.height;this._texUpperLeft=et(v,L),this._texUpperRight=et(C,L),this._texBottomLeft=et(v,S),this._texBottomRight=et(C,S),n*=y,o*=y,n*=x,o*=x;const P=Math.round(Math.min(64*y,255));this._bitestAndDistRatio=tt(0,0,w,P),this._computedWidth=n,this._computedHeight=o;const z=J(),I=Q();this._applyTransformation(I,z)}static fromCIMMarker(t,e){const s=e&&e.width||1,i=e&&e.height||1,r=t.size,o=s/i*t.scaleX,a=t.scaleSymbolsProportionally&&t.frameHeight?r/t.frameHeight:1,l=rt(t.color),h=rt(t.outlineColor),c=g(r),u=c*o,f=g(t.offsetX||0),m=g(t.offsetY||0),d=g(t.outlineWidth||0)*a,p=t.alignment||0,_=g(t.referenceSize);let y=t.rotation||0;t.rotateClockwise||(y=-y);let x=0,M=0;const w=t.anchorPoint;return w&&(t.isAbsoluteAnchorPoint?r&&(x=-w.x/(r*o),M=w.y/r):(x=w.x,M=w.y)),new ge(t.materialKey,f,m,y,l,u,c,_,h,d,t.colorLocked,t.scaleSymbolsProportionally,!1,p,e,x,M,t.sizeRatio,n(t.scaleFactor,1),t.markerPlacement,t.effects)}static fromPictureMarker(t,e){const s=Math.round(g(t.width)),i=Math.round(g(t.height)),r=O,n=Math.round(g(t.xoffset||0)),o=Math.round(g(t.yoffset||0));return new ge(t.materialKey,n,o,t.angle,r,s,i,i,0,0,!1,!1,!1,0,e,0,0,1,1,null,null)}static fromSimpleMarker(t,e){const s=it(t.color),i=Math.round(g(t.size)),r=i,n=Math.round(g(t.xoffset||0)),o=Math.round(g(t.yoffset||0)),a=t.style,l=t.outline,h=0|(l&&l.color&&it(l.color)),c=0|(l&&l.width&&Math.round(g(l.width))),u=new ge(t.materialKey,n,o,t.angle,s,i,r,r,h,c,!1,!1,"esriSMSCross"===a||"esriSMSX"===a,0,e,0,0,126/64,1,null,null);return u.boundsType="esriSMSCircle"===a?"circle":"square",u}static fromLineSymbolMarker(t,e){const s=it(t.color),i=Math.round(g(6*t.lineWidth)),r=i,n="cross"===t.style||"x"===t.style;let o;switch(t.placement){case"begin-end":o="Both";break;case"begin":o="JustBegin";break;case"end":o="JustEnd";break;default:o="None"}const a={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:o,offsetAlongLine:0},l=new ge(t.materialKey,0,0,0,s,i,r,r/6,s,n?Math.round(g(t.lineWidth)):0,!1,!1,n,1,e,0,0,126/64,1,a,null);return l.boundsType="circle"===t.style?"circle":"square",l}}function Me(t,e,s,i,r,n,o){Ze=0;const a=(i-s)*n,l=r&&r.length,h=l?(r[0]-s)*n:a;let c,u,f,m,d,p=we(e,s,i,0,h,n,!0);if(p&&p.next!==p.prev){if(l&&(p=function(t,e,s,i,r,n){const o=new Array;for(let r=0,a=i.length;r<a;r++){const l=we(t,e,s,i[r]*n,r<a-1?i[r+1]*n:s*n,n,!1);l===l.next&&(l.steiner=!0),o.push(Pe(l))}o.sort(Ge);for(const t of o)ze(t,r),r=be(r,r.next);return r}(e,s,i,r,p,n)),a>80*n){c=f=e[0+s*n],u=m=e[1+s*n];for(let t=n;t<h;t+=n){const i=e[t+s*n],r=e[t+1+s*n];c=Math.min(c,i),u=Math.min(u,r),f=Math.max(f,i),m=Math.max(m,r)}d=Math.max(f-c,m-u),d=0!==d?1/d:0}Te(p,t,n,c,u,d,o,0)}}function we(t,e,s,i,r,n,o){let a;if(o===function(t,e,s,i,r,n){let o=0;for(let s=i,a=r-n;s<r;s+=n)o+=(t[a+e*n]-t[s+e*n])*(t[s+1+e*n]+t[a+1+e*n]),a=s;return o}(t,e,0,i,r,n)>0)for(let s=i;s<r;s+=n)a=Ce(s+e*n,t[s+e*n],t[s+1+e*n],a);else for(let s=r-n;s>=i;s-=n)a=Ce(s+e*n,t[s+e*n],t[s+1+e*n],a);return a&&De(a,a.next)&&(Se(a),a=a.next),a}function be(t,e=t){if(!t)return t;let s,i=t;do{if(s=!1,i.steiner||!De(i,i.next)&&0!==ke(i.prev,i,i.next))i=i.next;else{if(Se(i),i=e=i.prev,i===i.next)break;s=!0}}while(s||i!==e);return e}function Te(t,e,s,i,r,n,o,a){if(!t)return;!a&&n&&(t=Ie(t,i,r,n));let l=t;for(;t.prev!==t.next;){const h=t.prev,c=t.next;if(n?Le(t,i,r,n):ve(t))e.push(h.index/s+o),e.push(t.index/s+o),e.push(c.index/s+o),Se(t),t=c.next,l=c.next;else if((t=c)===l){a?1===a?Te(t=Ve(t,e,s,o),e,s,i,r,n,o,2):2===a&&Be(t,e,s,i,r,n,o):Te(be(t),e,s,i,r,n,o,1);break}}}function ve(t){const e=t.prev,s=t,i=t.next;if(ke(e,s,i)>=0)return!1;let r=t.next.next;const n=r;let o=0;for(;r!==t.prev&&(0===o||r!==n);){if(o++,Fe(e.x,e.y,s.x,s.y,i.x,i.y,r.x,r.y)&&ke(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Le(t,e,s,i){const r=t.prev,n=t,o=t.next;if(ke(r,n,o)>=0)return!1;const a=r.x<n.x?r.x<o.x?r.x:o.x:n.x<o.x?n.x:o.x,l=r.y<n.y?r.y<o.y?r.y:o.y:n.y<o.y?n.y:o.y,h=r.x>n.x?r.x>o.x?r.x:o.x:n.x>o.x?n.x:o.x,c=r.y>n.y?r.y>o.y?r.y:o.y:n.y>o.y?n.y:o.y,u=Oe(a,l,e,s,i),f=Oe(h,c,e,s,i);let m=t.prevZ,d=t.nextZ;for(;m&&m.z>=u&&d&&d.z<=f;){if(m!==t.prev&&m!==t.next&&Fe(r.x,r.y,n.x,n.y,o.x,o.y,m.x,m.y)&&ke(m.prev,m,m.next)>=0)return!1;if(m=m.prevZ,d!==t.prev&&d!==t.next&&Fe(r.x,r.y,n.x,n.y,o.x,o.y,d.x,d.y)&&ke(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;m&&m.z>=u;){if(m!==t.prev&&m!==t.next&&Fe(r.x,r.y,n.x,n.y,o.x,o.y,m.x,m.y)&&ke(m.prev,m,m.next)>=0)return!1;m=m.prevZ}for(;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&Fe(r.x,r.y,n.x,n.y,o.x,o.y,d.x,d.y)&&ke(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function Ce(t,e,s,i){const r=We.create(t,e,s);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Se(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Pe(t){let e=t,s=t;do{(e.x<s.x||e.x===s.x&&e.y<s.y)&&(s=e),e=e.next}while(e!==t);return s}function ze(t,e){if(e=function(t,e){let s=e;const i=t.x,r=t.y;let n,o=-1/0;do{if(r<=s.y&&r>=s.next.y&&s.next.y!==s.y){const t=s.x+(r-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(t<=i&&t>o){if(o=t,t===i){if(r===s.y)return s;if(r===s.next.y)return s.next}n=s.x<s.next.x?s:s.next}}s=s.next}while(s!==e);if(!n)return null;if(i===o)return n.prev;const a=n,l=n.x,h=n.y;let c,u=1/0;s=n.next;for(;s!==a;)i>=s.x&&s.x>=l&&i!==s.x&&Fe(r<h?i:o,r,l,h,r<h?o:i,r,s.x,s.y)&&(c=Math.abs(r-s.y)/(i-s.x),(c<u||c===u&&s.x>n.x)&&Ae(s,t)&&(n=s,u=c)),s=s.next;return n}(t,e)){const s=Ee(e,t);be(s,s.next)}}function Ie(t,e,s,i){for(let r;r!==t;r=r.next){if(r=r||t,null===r.z&&(r.z=Oe(r.x,r.y,e,s,i)),r.prev.next!==r||r.next.prev!==r)return r.prev.next=r,r.next.prev=r,Ie(t,e,s,i);r.prevZ=r.prev,r.nextZ=r.next}return t.prevZ.nextZ=null,t.prevZ=null,function(t){let e,s=1;for(;;){let i,r=t;t=null,e=null;let n=0;for(;r;){n++,i=r;let o=0;for(;o<s&&i;o++)i=i.nextZ;let a=s;for(;o>0||a>0&&i;){let s;0===o?(s=i,i=i.nextZ,a--):0!==a&&i?r.z<=i.z?(s=r,r=r.nextZ,o--):(s=i,i=i.nextZ,a--):(s=r,r=r.nextZ,o--),e?e.nextZ=s:t=s,s.prevZ=e,e=s}r=i}if(e.nextZ=null,s*=2,n<2)return t}}(t)}function ke(t,e,s){return(e.y-t.y)*(s.x-e.x)-(e.x-t.x)*(s.y-e.y)}function Re(t,e,s,i){return!!(De(t,e)&&De(s,i)||De(t,i)&&De(s,e))||ke(t,e,s)>0!=ke(t,e,i)>0&&ke(s,i,t)>0!=ke(s,i,e)>0}function Fe(t,e,s,i,r,n,o,a){return(r-o)*(e-a)-(t-o)*(n-a)>=0&&(t-o)*(i-a)-(s-o)*(e-a)>=0&&(s-o)*(n-a)-(r-o)*(i-a)>=0}function Ae(t,e){return ke(t.prev,t,t.next)<0?ke(t,e,t.next)>=0&&ke(t,t.prev,e)>=0:ke(t,e,t.prev)<0||ke(t,t.next,e)<0}function Oe(t,e,s,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function De(t,e){return t.x===e.x&&t.y===e.y}function Ge(t,e){return t.x-e.x}function Ve(t,e,s,i){let r=t;do{const n=r.prev,o=r.next.next;!De(n,o)&&Re(n,r,r.next,o)&&Ae(n,o)&&Ae(o,n)&&(e.push(n.index/s+i),e.push(r.index/s+i),e.push(o.index/s+i),Se(r),Se(r.next),r=t=o),r=r.next}while(r!==t);return r}function Be(t,e,s,i,r,n,o){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.index!==t.index&&je(a,t)){let l=Ee(a,t);return a=be(a,a.next),l=be(l,l.next),Te(a,e,s,i,r,n,o,0),void Te(l,e,s,i,r,n,o,0)}t=t.next}a=a.next}while(a!==t)}function je(t,e){return t.next.index!==e.index&&t.prev.index!==e.index&&!function(t,e){let s=t;do{if(s.index!==t.index&&s.next.index!==t.index&&s.index!==e.index&&s.next.index!==e.index&&Re(s,s.next,t,e))return!0;s=s.next}while(s!==t);return!1}(t,e)&&Ae(t,e)&&Ae(e,t)&&function(t,e){let s=t,i=!1;const r=(t.x+e.x)/2,n=(t.y+e.y)/2;do{s.y>n!=s.next.y>n&&s.next.y!==s.y&&r<(s.next.x-s.x)*(n-s.y)/(s.next.y-s.y)+s.x&&(i=!i),s=s.next}while(s!==t);return i}(t,e)}function Ee(t,e){const s=We.create(t.index,t.x,t.y),i=We.create(e.index,e.x,e.y),r=t.next,n=e.prev;return t.next=e,e.prev=t,s.next=r,r.prev=s,i.next=s,s.prev=i,n.next=i,i.prev=n,i}class We{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,s){const i=Ke[Ze++];return i.index=t,i.x=e,i.y=s,i.prev=null,i.next=null,i.z=null,i.prevZ=null,i.nextZ=null,i.steiner=!1,i}}const Ke=new Array;let Ze=0;for(let t=0;t<8096;t++)Ke.push(new We);const Xe=new Rt,Ue=new Ft(0,0,0,1,128);function He(t,e,s){let i=0;for(let r=1;r<s;r++){const s=t[2*(e+r-1)],n=t[2*(e+r-1)+1];i+=(t[2*(e+r)]-s)*(t[2*(e+r)+1]+n)}return i}function Ne(t,e,s,i,r){let n=0;for(let o=s;o<i;o+=3){const s=2*(t.getValue(o)-r),i=2*(t.getValue(o+1)-r),a=2*(t.getValue(o+2)-r);n+=Math.abs((e[s]-e[a])*(e[i+1]-e[s+1])-(e[s]-e[i])*(e[a+1]-e[s+1]))}return n}Ue.setExtent(D);const qe=t=>class extends t{constructor(...t){super(...t),this.forceLibtess=!1,this.geometryType=nt.FILL}writeMeshWithGeometry(t,e,s,i,r,n){const o=_t.load(this._materialKey),a=e.indexVector,l=e.getVector("geometry"),h=l.vertexCount,c=a.length;let u=n?I(k(n),2):s.readUnquantizedGeometry();if(!u)return;if(u=function(t){if(!function(t,e,s){let i=0;for(let r=0;r<t.lengths.length;r++){const n=t.lengths[r];for(let r=0;r<n;r++){const n=t.coords[2*(r+i)],o=t.coords[2*(r+i)+1];if(n<e||n>s||o<e||o>s)return!0}i+=n}return!1}(t,-128,D+128))return t;Ue.reset(3);let e=0;for(let s=0;s<t.lengths.length;s++){const i=t.lengths[s];let r=t.coords[2*(0+e)],n=t.coords[2*(0+e)+1];Ue.moveTo(r,n);for(let s=1;s<i;s++)r=t.coords[2*(s+e)],n=t.coords[2*(s+e)+1],Ue.lineTo(r,n);Ue.close(),e+=i}const s=Ue.result(!1);if(!s)return null;const i=[],r=[];for(const t of s){let e=0;for(const s of t)r.push(s.x),r.push(s.y),e++;i.push(e)}return new z(i,r)}(u),!u)return;let f=u.coords;!this.forceLibtess&&function(t,e,s){const{coords:i,lengths:r,hasIndeterminateRingOrder:n}=e;if(n)return!1;const o=t.length;let a=0;for(let e=0;e<r.length;){let n=e,l=r[e],h=He(i,a,l);const c=[];for(;++n<r.length;){const t=r[n],e=He(i,a+l,t);if(!(e>0))break;h+=e,c.push(a+l),l+=t}const u=t.length;Me(t,i,a,a+l,c,2,s);const f=Ne(t,i,u,t.length,s),m=Math.abs(h);if(Math.abs((f-m)/Math.max(1e-7,m))>1e-5)return t.seek(o),!1;e=n,a+=l}return!0}(a,u,h)||(f=[],function(t,e,s,i){const r=[],{coords:n,lengths:o}=s;Xe.beginPolygon(t,r);let a=0;for(let t=0;t<o.length;t++){const e=s.lengths[t];Xe.beginContour();for(let t=0;t<e;t++){const e=[n[2*(a+t)],n[2*(a+t)+1],0];Xe.addVertex(e,e)}Xe.endContour(),a+=e}Xe.endPolygon();for(let t=0;t<r.length;t++)e.push(r[t]+i)}(f,a,u,h)),this._write(l,s,r,f,o);const m=l.vertexCount-h,d=a.length-c;t.writeDisplayRecord(this.geometryType,this._materialKey,h,m,c,d)}_write(t,e,s,i,r){for(let n=0;n<i.length;n+=2){const o=et(1*i[n],1*i[n+1]);t.data.push(o),t.data.push(s),r.dotDensity?t.data.writeF32(1/Math.abs(e.readGeometryArea())):(t.data.push(this.fillColor),t.data.push(this.tl),t.data.push(this.br),t.data.push(this.aux1),t.data.push(this.aux2),t.data.push(this.aux3))}}},Ye=t.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class Qe extends he{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,e,s,i){const r=e.readLegacyFeature(),n=this._materialCache,o=this._cimLayer.materialHash;if(!o)return Ye.error("A Dynamic mesh template must have a material hash value or function!"),a(null);const h="function"==typeof o?o(r,s,i):o;if(n.has(h)){const t=n.get(h);return l(t)}if(this._ongoingMaterialRequestMap.has(h))return this._ongoingMaterialRequestMap.get(h);const c=Ot(this._cimLayer.cim,this._cimLayer.materialOverrides);c.mosaicHash=h;const u=t.getMosaicItem(c).then((t=>(this._ongoingMaterialRequestMap.delete(h),n.set(h,t),t))).catch((t=>(this._ongoingMaterialRequestMap.delete(h),Ye.error(".analyze()",t.message),null)));return this._ongoingMaterialRequestMap.set(h,u),u}}class $e extends(qe(Qe)){constructor(t){if(super(t),bt(t.color)){const e=(e,s,i)=>{const r=t.color(e,s,i);return r&&rt(r)||0};this._dynamicPropertyMap.set("_fillColor",e)}else{const e=t.color;this.fillColor=e&&rt(e)||0}let e=0;bt(t.height)||(e=t.height||0);this._dynamicPropertyMap.set("_height",((s,i,r)=>bt(t.height)?t.height(s,i,r):e));let s=0;bt(t.offsetX)||(s=g(t.offsetX||0)+128,s>255&&(s=255));this._dynamicPropertyMap.set("_offsetX",((e,i,r)=>{if(bt(t.offsetX)){let s=g(t.offsetX(e,i,r))+128;return s>255&&(s=255),s}return s}));let i=1;bt(t.scaleX)||(i=t.scaleX||1);this._dynamicPropertyMap.set("_scaleX",((e,s,r)=>bt(t.scaleX)?t.scaleX(e,s,r):i));let r=0;bt(t.offsetY)||(r=g(-t.offsetY||0)+128,r>255&&(r=255));this._dynamicPropertyMap.set("_offsetY",((e,s,i)=>{if(bt(t.offsetY)){let r=g(-t.offsetY(e,s,i))+128;return r>255&&(r=255),r}return r}));let n=0;bt(t.angle)||(n=ht(t.angle)||0);this._dynamicPropertyMap.set("_angle",((e,s,i)=>bt(t.angle)?ht(t.angle(e,s,i)):n)),this.effects=t.effects,this._cimFillLayer=t,this._fillMaterialKey=_t.load(t.materialKey)}static fromCIMFill(t){return new $e(t)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(i,e,s)}));const r=this._fillMaterialKey,n=this._materialCache,o=this._cimFillLayer;this.aux3=tt(0,0,this._angle,o.colorLocked?1:0);const a=(0,o.materialHash)(i,e,s),l=n.get(a);let h=null;if(l&&Et(l.spriteMosaicItem)&&(h=l.spriteMosaicItem),h){const{rect:t,width:e,height:s}=h,i=t.x+A,n=t.y+A,o=i+e,a=n+s;let l=_(g(this._height));l>255?l=255:l<=0&&(l=_(a-n));let c=_(g(this._height/s*e||0));c>255?c=255:c<=0&&(c=_(o-i));const u=this._scaleX,f=1;this.tl=et(i,n),this.br=et(o,a),this.aux1=tt(c,l,this._offsetX,this._offsetY),this.aux2=et(128*u,128*f),r.sdf=h.sdf,r.pattern=!0,r.textureBinding=h.textureBinding}else this.tl=0,this.br=0,this.aux1=0,this.aux2=0,r.sdf=!1,r.pattern=!1,r.textureBinding=0;this._materialKey=r.data}}const Je=D+16,ts=new Ft(0,0,0,1,16);ts.setExtent(D);const es=new Uint32Array(9),ss=new Uint32Array(36),is=new Uint32Array(3),rs=new Uint32Array(6),ns=t=>class extends t{constructor(...t){super(...t),this.tessellationProperties={_fillColor:null,_tl:null,_br:null,_halfWidth:null,_bitset:null,_halfReferenceWidth:null,id:null,indexBuf:null,indexCount:null,geometryBuf:null,vertexCount:null,offset:null},this._tessellationOptions={},this.geometryType=nt.LINE}writeMeshWithGeometry(t,e,s,i,r,n){const o=e.indexVector,a=e.get("geometry"),l=e.getVector("geometry").vertexCount,h=o.length,c=null!=n?n:s.readLegacyGeometry();if(!c)return;switch(i){case"esriGeometryPolyline":{const t=this._clipLines(c.paths);if(0===t.length)return;this._write(o,a,l,r,t);break}case"esriGeometryPolygon":{const t=this._clipLines(c.rings);if(0===t.length)return;this._write(o,a,l,r,t);break}}const u=this.tessellationProperties.vertexCount,f=this.tessellationProperties.indexCount;t.writeDisplayRecord(this.geometryType,this._materialKey,l,u,h,f)}_clipLines(t){const e=[];let s=!1,i=0;for(;i<t.length;){const r=[],n=t[i];ts.reset(2);let[o,a]=n[0];if(s)ts.moveTo(o,a);else{if(o<-16||o>Je||a<-16||a>Je){s=!0;continue}r.push({x:o,y:a})}let l=!1;const h=n.length;for(let t=1;t<h;++t)if(o+=n[t][0],a+=n[t][1],s)ts.lineTo(o,a);else{if(o<-16||o>Je||a<-16||a>Je){l=!0;break}r.push({x:o,y:a})}if(l)s=!0;else{if(s){const t=ts.resultWithStarts();if(t)for(const s of t)e.push(s)}else e.push({line:r,start:0});i++,s=!1}}return e}_write(t,e,s,i,r){this.tessellationProperties.id=i,this.tessellationProperties.indexBuf=t,this.tessellationProperties.indexCount=0,this.tessellationProperties.geometryBuf=e,this.tessellationProperties.vertexCount=0,this.tessellationProperties.offset=s;for(const t of r){const e=t.line;e.length<2||(this._tessellationOptions.initialDistance=t.start%65535,this._tessellationCallbacks instanceof Tt&&(this._tessellationCallbacks.capType=this._capType,this._tessellationCallbacks.joinType=this._joinType),vt(e,this._tessellationOptions,this._tessellationCallbacks),Lt())}}_initializeTessellator(t){const e=yt.load(this._materialKey);if(this._tessellationOptions.trackDistance=this._isDashed||this._hasPattern,this._tessellationOptions.thin=!t&&this.tessellationProperties._halfWidth<G/2&&!(e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue),this._tessellationOptions.wrapDistance=65535,this._tessellationOptions.outerBisectorAutoSplitThreshold=.2631578947368421,this._tessellationOptions.enableOuterBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.innerBisectorAutoSplitThreshold=.2631578947368421,this._tessellationOptions.enableInnerBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.thin)this._tessellationCallbacks={vertex:os(this.tessellationProperties),bridge:as(this.tessellationProperties)};else{const t=new Tt(ls(this.tessellationProperties),hs(this.tessellationProperties));t.miterLimitCosine=this._miterLimitCosine,t.textured=this._isDashed||this._hasPattern,t.joinOnUTurn=this._joinOnUTurn,this._tessellationCallbacks=t}}},os=t=>e=>{const s=Math.ceil(1024*t._halfWidth),i=Math.ceil(1024*t._halfReferenceWidth);e.entry0=t.offset+t.vertexCount++;{const r=et(e.distance,s),n=tt(Math.round(31*e.prevNormal.x),Math.round(31*e.prevNormal.y),Math.round(0),Math.round(-31)),o=tt(0,0,0,t._bitset);ss[0]=et(8*e.currentVertex.x,8*e.currentVertex.y),ss[1]=t.id,ss[2]=t._fillColor,ss[3]=n,ss[4]=r,ss[5]=t._tl,ss[6]=t._br,ss[7]=o,ss[8]=et(i,0)}e.entry2=t.offset+t.vertexCount++;{const r=et(e.distance,s),n=tt(Math.round(31*-e.prevNormal.x),Math.round(31*-e.prevNormal.y),Math.round(0),Math.round(31)),o=tt(0,0,0,t._bitset);ss[9]=et(8*e.currentVertex.x,8*e.currentVertex.y),ss[10]=t.id,ss[11]=t._fillColor,ss[12]=n,ss[13]=r,ss[14]=t._tl,ss[15]=t._br,ss[16]=o,ss[17]=et(i,0)}e.exit0=t.offset+t.vertexCount++;{const r=et(e.distance,s),n=tt(Math.round(31*e.nextNormal.x),Math.round(31*e.nextNormal.y),Math.round(0),Math.round(-31)),o=tt(0,0,0,t._bitset);ss[18]=et(8*e.currentVertex.x,8*e.currentVertex.y),ss[19]=t.id,ss[20]=t._fillColor,ss[21]=n,ss[22]=r,ss[23]=t._tl,ss[24]=t._br,ss[25]=o,ss[26]=et(i,0)}e.exit2=t.offset+t.vertexCount++;{const r=et(e.distance,s),n=tt(Math.round(31*-e.nextNormal.x),Math.round(31*-e.nextNormal.y),Math.round(0),Math.round(31)),o=tt(0,0,0,t._bitset);ss[27]=et(8*e.currentVertex.x,8*e.currentVertex.y),ss[28]=t.id,ss[29]=t._fillColor,ss[30]=n,ss[31]=r,ss[32]=t._tl,ss[33]=t._br,ss[34]=o,ss[35]=et(i,0)}t.geometryBuf.writeRegion(ss)},as=t=>e=>{rs[0]=e.leftExit0,rs[1]=e.rightEntry0,rs[2]=e.leftExit2,rs[3]=e.rightEntry0,rs[4]=e.rightEntry2,rs[5]=e.leftExit2,t.indexCount+=6,t.indexBuf.writeRegion(rs)},ls=t=>(e,s,i,r,n,o,a,l,h)=>{const c=et(h,Math.ceil(1024*t._halfWidth)),u=tt(Math.round(31*n),Math.round(31*o),Math.round(31*a),Math.round(31*l)),f=tt(31*i,31*r,0,t._bitset);return es[0]=et(8*e,8*s),es[1]=t.id,es[2]=t._fillColor,es[3]=u,es[4]=c,es[5]=t._tl,es[6]=t._br,es[7]=f,es[8]=et(Math.ceil(1024*t._halfReferenceWidth),0),t.geometryBuf.writeRegion(es),t.offset+t.vertexCount++},hs=t=>(e,s,i)=>{is[0]=e,is[1]=s,is[2]=i,t.indexCount+=3,t.indexBuf.writeRegion(is)};class cs extends(ns(Qe)){constructor(t){super(t),this._cimLineLayer=t;let e=0;bt(t.width)||(e=.5*g(t.width));if(this._dynamicPropertyMap.set("_halfWidth",((s,i,r)=>bt(t.width)?.5*g(t.width(s,i,r)):e)),bt(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,bt(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join,bt(t.color)){const e=(e,s,i)=>{const r=t.color(e,s,i);return r&&rt(r)||0};this._dynamicPropertyMap.set("_fillColor",e)}else{const e=t.color;this._fillColor=e&&rt(e)||0}if(bt(t.miterLimit)){const e=(e,s,i)=>Ct(t.miterLimit(e,s,i));this._dynamicPropertyMap.set("_miterLimitCosine",e)}else this._miterLimitCosine=Ct(t.miterLimit);this._scaleFactor=t.scaleFactor||1,this._isDashed=t.isDashed,this.effects=t.effects,this.tessellationProperties._bitset=t.colorLocked?1:0,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t){return new cs(t)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(i,e,s)})),this._halfWidth*=this._scaleFactor;const r=this._materialCache,n=(0,this._cimLineLayer.materialHash)(i,e,s),o=r.get(n);let a=null;if(o&&Et(o.spriteMosaicItem)&&(a=o.spriteMosaicItem),a){this._hasPattern=!0;const{rect:t,width:e,height:s}=a,i=t.x+A,r=t.y+A,n=i+e,o=r+s;this.tessellationProperties._tl=et(i,r),this.tessellationProperties._br=et(n,o)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const l=yt.load(this._materialKey);a&&(l.sdf=a.sdf,l.pattern=!0,l.textureBinding=a.textureBinding),this._materialKey=l.data}}const us=J(),fs=Q(),ms=t.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");class ds extends(xe(Qe)){constructor(t){if(super(t),this._cimMarkerLayer=t,bt(t.color)){const e=(e,s,i)=>rt(t.color(e,s,i));this._dynamicPropertyMap.set("_fillColor",e)}else this._fillColor=rt(t.color);if(bt(t.outlineColor)){const e=(e,s,i)=>rt(t.outlineColor(e,s,i));this._dynamicPropertyMap.set("_outlineColor",e)}else this._outlineColor=rt(t.outlineColor);if(bt(t.size)){const e=(e,s,i)=>g(t.size(e,s,i));this._dynamicPropertyMap.set("_size",e)}else this._size=g(t.size);if(bt(t.scaleX)?this._dynamicPropertyMap.set("_scaleX",t.scaleX):this._scaleX=t.scaleX,bt(t.offsetX)){const e=(e,s,i)=>g(t.offsetX(e,s,i));this._dynamicPropertyMap.set("xOffset",e)}else this.xOffset=g(t.offsetX);if(bt(t.offsetY)){const e=(e,s,i)=>g(t.offsetY(e,s,i));this._dynamicPropertyMap.set("yOffset",e)}else this.yOffset=g(t.offsetY);if(bt(t.outlineWidth)){const e=(e,s,i)=>g(t.outlineWidth(e,s,i));this._dynamicPropertyMap.set("_outlineWidth",e)}else this._outlineWidth=g(t.outlineWidth);bt(t.rotation)?this._dynamicPropertyMap.set("_angle",t.rotation):this._angle=t.rotation,this._scaleFactor=n(t.scaleFactor,1),this._markerPlacement=t.markerPlacement,this.effects=t.effects,this._bitSet=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t){return new ds(t)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(i,e,s)}));const r=this._cimMarkerLayer.materialHash,n="function"==typeof r?r(i,e,s):r,o=this._materialCache.get(n);if(!o||!Et(o.spriteMosaicItem)||!o.spriteMosaicItem)return void ms.error(new m("mapview-cim","Encountered an error when binding feature"));const a=o.spriteMosaicItem,l=this._cimMarkerLayer.sizeRatio,h=a.width/a.height*this._scaleX,c=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let u=this._size,f=u*h;const d=this.xOffset,p=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const _=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/g(this._cimMarkerLayer.frameHeight):1,y=this._outlineWidth*_,x=g(this._cimMarkerLayer.referenceSize);let M=0,w=0;const b=this._cimMarkerLayer.anchorPoint;b&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(M=-b.x/(this._size*h),w=b.y/this._size):(M=b.x,w=b.y)),this._sizeOutlineWidth=tt(Math.round(Math.min(Math.sqrt(128*f),255)),Math.round(Math.min(Math.sqrt(128*u),255)),Math.round(Math.min(Math.sqrt(128*y),255)),Math.round(Math.min(Math.sqrt(128*x),255))),this.angle=c;const T=Math.round(Math.min(64*l,255));this._bitestAndDistRatio=tt(0,0,this._bitSet,T);const v=a.rect.x+A,L=a.rect.y+A,C=v+a.width,S=L+a.height;this._texUpperLeft=et(v,L),this._texUpperRight=et(C,L),this._texBottomLeft=et(v,S),this._texBottomRight=et(C,S);const P=pt.load(this._materialKey);P.sdf=a.sdf,P.pattern=!0,P.textureBinding=a.textureBinding,this._materialKey=P.data,this._anchorX=.5-(.5+M)*a.width/a.width,this._anchorY=.5-(.5+w)*a.height/a.height,f*=l,u*=l,f*=this._scaleFactor,u*=this._scaleFactor,f*=a.rect.width/a.width,u*=a.rect.height/a.height,this._computedWidth=f,this._computedHeight=u,this._applyTransformation(fs,us),this.xOffset=d,this.yOffset=p}}function ps(t){const e=new Array(t.length);for(let s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e}class _s extends(ae(Qe)){constructor(t){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map;const e=t.scaleFactor||1;if(this._cimTextLayer=t,bt(t.color)){const e=(e,s,i)=>rt(t.color(e,s,i));this._dynamicPropertyMap.set("_color",e)}else this._color=rt(t.color);if(bt(t.color)){const e=(e,s,i)=>rt(t.outlineColor(e,s,i));this._dynamicPropertyMap.set("_haloColor",e)}else this._haloColor=rt(t.outlineColor);let s;bt(t.size)||(s=Math.min(Math.round(g(t.size*t.sizeRatio)),127));if(this._dynamicPropertyMap.set("_size",((e,i,r)=>bt(t.size)?Math.min(Math.round(g(t.size(e,i,r)*t.sizeRatio)),127):s)),bt(t.outlineSize)){const e=(e,s,i)=>Math.min(Math.floor(5*g(t.outlineSize(e,s,i)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",e)}else this._haloSize=Math.min(Math.floor(5*g(t.outlineSize*t.sizeRatio)),127);let i;bt(t.offsetX)||(i=Math.round(g(t.offsetX*t.sizeRatio)));let r;this._dynamicPropertyMap.set("_xOffset",((e,s,r)=>bt(t.offsetX)?Math.round(g(t.offsetX(e,s,r)*t.sizeRatio)):i)),bt(t.offsetY)||(r=Math.round(g(t.offsetY*t.sizeRatio)));this._dynamicPropertyMap.set("_yOffset",((e,s,i)=>bt(t.offsetY)?Math.round(g(t.offsetY(e,s,i)*t.sizeRatio)):r)),bt(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,bt(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,bt(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,this._scaleFactor=e,bt(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text;const n=Math.min(Math.round(g(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*n)),this._materialKey=t.materialKey;const o=xt.load(this._materialKey);o.sdf=!0,this._bitset=(1===t.alignment?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=o.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._textPlacement=t.markerPlacement,this.effects=t.effects,this._isCIM=!0}static fromCIMText(t){return new _s(t)}async analyze(t,e,s,i){const r=e.readLegacyFeature(),n=function(t,e,s,i){return"string"==typeof t.text?t.text:"function"==typeof t.text?t.text(e,s,i):""}(this._cimTextLayer,r,s,i),o=await t.getMosaicItem(this._cimTextLayer.cim,ps(n));return this._textToGlyphs.set(n,o.glyphMosaicItems),o}bindFeature(t,e,s){const i=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach(((t,r)=>{this[r]=t(i,e,s)})),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/24,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=W(this._horizontalAlignment||"center"),this._yAlignD=K(this._verticalAlignment||"baseline");const r=this._textToGlyphs.get(this._text);this.bindTextInfo(r,!1)}}class ys extends(qe(he)){constructor(t,e,s,i,r,n,o,a,l){super(),this.effects=l;const h=_t.load(t);e&&(h.sdf=e.sdf,h.pattern=!0,h.textureBinding=e.textureBinding),this.fillColor=s,this.tl=i,this.br=r,this.aux1=n,this.aux2=o,this.aux3=a,this._materialKey=h.data}static fromCIMFill(t,e){const s=t.color,i=s&&rt(s)||0,r=t.materialKey;if(!e){const e=tt(0,0,0,t.colorLocked?1:0);return new ys(r,null,i,0,0,0,0,e,t.effects)}const{rect:n,width:o,height:a}=e,l=n.x+A,h=n.y+A,c=l+o,u=h+a;let f=_(g(t.height||0));f>255?f=255:f<=0&&(f=_(u-h));let m=_(g(t.height/a*o||0));m>255?m=255:m<=0&&(m=_(c-l));let d=g(t.offsetX||0)+128;d>255&&(d=255);let p=g(-t.offsetY||0)+128;p>255&&(p=255);const y=t.scaleX||1,x=et(l,h),M=et(c,u),w=tt(m,f,d,p),b=et(128*y,128),T=tt(0,0,ct(t.angle),t.colorLocked?1:0);return new ys(r,e,i,x,M,w,b,T,t.effects)}static fromSimpleFill(t,e,s=!1){const{color:i}=t,r=i&&"esriSFSNull"!==t.style&&it(i)||0,n=tt(0,0,0,s?255:0),o=t.materialKey;if(!e)return new ys(o,null,r,0,0,0,0,n,null);const{rect:a,width:l,height:h}=e,c=a.x+A,u=a.y+A,f=c+l,m=u+h,d=et(c,u),p=et(f,m),y=tt(_(f-c),_(m-u),0,0),x=et(128,128);return new ys(o,e,r,d,p,y,x,n,null)}static fromPictureFill(t,e,s=!1){const i=O,{rect:r,width:n,height:o}=e,a=r.x+A,l=r.y+A,h=a+n,c=l+o,u=et(a,l),f=et(h,c);let m=_(g(t.width));m>255&&(m=255);let d=_(g(t.height));d>255&&(d=255);let p=g(t.xoffset)+128;p>255&&(p=255);let y=g(-t.yoffset)+128;y>255&&(y=255);const x=tt(m,d,p,y),M=et(128*t.xscale,128*t.yscale),w=tt(0,0,0,s?255:0),b=t.materialKey;return new ys(b,e,i,u,f,x,M,w,null)}}const xs=t.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate");class gs extends(ns(he)){constructor(t,e,s,i,r,n,o,a,l,h,c,u,f,m,d,p){super();const _=yt.load(t);e&&(_.sdf=e.sdf,_.pattern=!0,_.textureBinding=e.textureBinding),this._capType=i,this._joinType=r,this._miterLimitCosine=Ct(n),this.tessellationProperties._fillColor=o,this.tessellationProperties._tl=a,this.tessellationProperties._br=l,this._hasPattern=h,this._isDashed=c,this._joinOnUTurn=d,this._isColorLocked=u,this._zOrder=m,this.effects=p,this._materialKey=_.data,this.tessellationProperties._bitset=u?1:0,this.tessellationProperties._halfWidth=.5*s,this.tessellationProperties._halfReferenceWidth=.5*f,this._initializeTessellator(!1)}static fromCIMLine(t,e,s){const i=t.color,r=t.scaleFactor||1,n=t.isDashed;let o=t.cap;n&&1===o&&(o=2);const a=t.join,l=g(t.width)*r,h=g(t.referenceWidth),c=g(t.miterLimit),u=i&&rt(i)||0;if(!e)return new gs(t.materialKey,e,l,o,a,c,u,0,0,!1,n,t.colorLocked,h,t.zOrder,s,t.effects);const{rect:f,width:m,height:d}=e,p=f.x+A,_=f.y+A,y=p+m,x=_+d,M=et(p,_),w=et(y,x);return new gs(t.materialKey,e,l,o,a,c,u,M,w,!0,n,t.colorLocked,h,t.zOrder,s,t.effects)}static fromSimpleLine(t,e,s){const{color:i}=t,r="esriSLSSolid"!==t.style&&"esriSLSNull"!==t.style,n=at(t.cap||"round",r),o=lt(t.join||"round");let a=i&&"esriSLSNull"!==t.style&&it(i)||0;"esriSLSNull"===t.style&&(a=0);const l=g(t.width),h=t.miterLimit;if(!e)return new gs(t.materialKey,e,l,n,o,h,a,0,0,!1,r,!1,l,0,s,null);const{rect:c,width:u,height:f}=e,m=c.x+A,d=c.y+A,p=m+u,_=d+f,y=et(m,d),x=et(p,_);return new gs(t.materialKey,e,l,n,o,h,a,y,x,!0,r,!1,l,0,s,null)}static fromPictureLineSymbol(t,e,s,i){return xs.error("PictureLineSymbol support does not exist!"),null}}class Ms{constructor(){this._resolver=null}isHeld(){return!!this._resolver}acquire(){return this._resolver?this._resolver.promise.then((()=>this.acquire())):(this._resolver=h(),l())}release(){const t=this._resolver;this._resolver=null,t.resolve()}}const ws=t.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),bs=new Array;function Ts(t,e){const s=t.length;return t.push(null),e.then((e=>t[s]=e)),t}function vs(t){return!!(1&t)}class Ls{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new Ms,this._fetchResource=t,this._joinOnUTurn=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e){this._initErrorTemplates();const s=t.hash;if(this._symbolToTemplate.has(s))return this._symbolToTemplate.get(s);const i=new Array;e&&this._createMeshTemplates(i,e,!0),this._createMeshTemplates(i,t,!1);const r=this._createGroupId("expanded-cim"===t.type);return this._idToTemplateGroup.set(r,i),this._symbolToTemplate.set(s,r),r}getTemplateGroup(t){return this._idToTemplateGroup.has(t)?this._idToTemplateGroup.get(t):bs}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(vs(t)||ws.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):bs}getMosaicItem(t,e){const s=this._createTemplateId(),i=c((t=>this._idToResolver.set(s,t)));return this._fetchQueue.push({symbol:t,id:s,glyphIds:e}),i}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?function(t,e,s){return t.acquire().then((()=>e(s))).then((()=>t.release())).catch((e=>{throw t.release(),e}))}(this._lock,this._fetchAllQueuedResources.bind(this),t):l()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],jt(C),!1),marker:this._createMeshTemplates([],jt(S),!1),line:this._createMeshTemplates([],jt(P),!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return l();const e=this._fetchQueue,s=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],o(s).then((()=>this._fetchResource(e,t).then((t=>{for(const{id:e,mosaicItem:s}of t){this._idToResolver.get(e)(s),this._idToResolver.delete(e)}})))).catch((t=>{u(t)?this._fetchQueue=this._fetchQueue.concat(e):function(t){return"worker:port-closed"===t.name}(t)||ws.error(new m("mapview-template-store","Unable to fetch requested texture resources",t))}))}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return Et(e,ws)?ge.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return Et(e,ws)?ge.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return Et(s,ws)?ys.fromSimpleFill(t,s,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return Et(s,ws)?ys.fromPictureFill(t,s,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return Et(s,ws)?gs.fromSimpleLine(t,s,this._joinOnUTurn):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return Et(e,ws)?ge.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return ce.fromText(t,e)}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t.cim,ps(t.text));return t.cim.mosaicHash=t.materialHash,Et(e,ws)?ce.fromCIMText(t,e):this._textError}async _createCIMFill(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:e}=await this.getMosaicItem(t.cim);return Et(e,ws)?ys.fromCIMFill(t,e):this._fillError}async _createCIMLine(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:e}=await this.getMosaicItem(t.cim);return Et(e,ws)?gs.fromCIMLine(t,e,this._joinOnUTurn):this._lineError}async _createCIMMarker(t){t.cim.mosaicHash=t.materialHash;const{spriteMosaicItem:e}=await this.getMosaicItem(t.cim);return Et(e,ws)?ge.fromCIMMarker(t,e):this._markerError}async _createCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let s;switch(t.type){case"marker":s=this._createCIMMarker(t);break;case"line":s=this._createCIMLine(t);break;case"fill":s=this._createCIMFill(t);break;case"text":s=this._createCIMText(t)}return s.then((t=>this._cimTemplateCache.set(e,t))),s}_createDynamicCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let s;switch(t.type){case"marker":s=ds.fromCIMMarker(t);break;case"line":s=cs.fromCIMLine(t);break;case"fill":s=$e.fromCIMFill(t);break;case"text":s=_s.fromCIMText(t)}return this._cimTemplateCache.set(e,s),s}_createPrimitiveMeshTemplates(t,e,s){switch(e.type){case"esriSMS":return Ts(t,this._createSMS(e));case"esriPMS":return Ts(t,this._createPMS(e));case"esriSFS":return Ts(t,this._createSFS(e,s));case"line-marker":return Ts(t,this._createLMS(e));case"esriPFS":return Ts(t,this._createPFS(e,s));case"esriSLS":return Ts(t,this._createSLS(e,!1));case"esriTS":return Ts(t,this._createTS(e));default:return ws.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,s){if(-1!==e.type.indexOf("3d"))return ws.error("3D symbols are not supported with MapView"),t;if("expanded-cim"===e.type){for(const s of e.layers)"function"==typeof s.materialHash?t.push(this._createDynamicCIM(s)):Ts(t,this._createCIM(s));return t}if("composite-symbol"===e.type){for(const i of e.layers)this._createPrimitiveMeshTemplates(t,i,s);return t}return"cim"===e.type||"label"===e.type||"web-style"===e.type?t:this._createPrimitiveMeshTemplates(t,e,s)}}class Cs{constructor(t,e,s){this._isDD=!1,this._geometryType=t,this._idField=e,this._templateStore=s}update(t,e){this._isDD="simple"===t.mesh.matcher.type&&t.mesh.matcher.isDotDensity,s(t.mesh.labels)&&this._setLabelTemplates(t.mesh.labels,e)}_setLabelTemplates(t,e){this._labelTemplates=t.map((t=>ye.fromLabelClass(t,e)))}get templates(){return this._templateStore}createMeshData(t){const e=new Array(5),s=this._labelTemplates&&this._labelTemplates.length>0,i="esriGeometryPolyline"===this._geometryType?V:B;return e[nt.MARKER]=new te(nt.MARKER,4*t),e[nt.FILL]=new te(nt.FILL,t,this._isDD),e[nt.LINE]=new te(nt.LINE,t),e[nt.TEXT]=new te(nt.TEXT,4*t),e[nt.LABEL]=new te(nt.LABEL,s?4*i:0),new Bt(e,{features:t,records:t,metrics:0})}async analyze(t,e,s,i,r){if(f(r))return;let n;"dictionary"===e.type&&(n=await e.analyze(this._idField,t.copy(),s,i,r));let o=0;for(;t.next();){let r;if(r=n?n[o++]:e.match(this._idField,t,this._geometryType,s,i),t.setGroupId(r),vs(r)){const e=this._templateStore.getDynamicTemplateGroup(r);for(const r of e)r&&r.analyze&&r.analyze(this._templateStore,t,s,i)}}return this._templateStore.finalize(r)}async analyzeGraphics(t,e,s,i,r){if(f(r))return;const n=t.getCursor();for(e&&await e.analyze(this._idField,n.copy(),s,i,r);n.next();){let t=n.getGroupId();if(null!=t&&-1!==t||(t=e.match(this._idField,n,n.geometryType,s,i),n.setGroupId(t)),vs(t)){const e=this._templateStore.getDynamicTemplateGroup(t);for(const t of e)t&&t.analyze&&t.analyze(this._templateStore,n,s,i)}n.setGroupId(t)}return this._templateStore.finalize(r)}writeGraphic(t,e){const s=e.getGroupId(),i=e.getDisplayId(),r=this._templateStore.getTemplateGroup(s),n=e.geometryType;if(null!=i){if(vs(s))for(const t of r)t.bindFeature(e,null,null);if(r){t.writeDisplayObject(i,e.readGraphic().insertAfter);for(const s of r){if(!s)continue;const r=t.get(s.geometryType);s.writeMesh(t,r,e,n,i)}}}}writeCursor(t,e,i,r,n,o){const a=e.getGroupId(),l=e.getDisplayId(),h=this._templateStore.getTemplateGroup(a);if(null==l)return;if(!h)return;if(t.writeDisplayObject(l,0),vs(a))for(const t of h)t.bindFeature(e,i,r);for(const s of h){const i=t.get(s.geometryType);!s.needsPixelBuffer&&e.hasFilter()||s.writeMesh(t,i,e,this._geometryType,l)}const c=t.hasDisplayRecords();if(s(o)&&c){const s=o&&this._findLabelRef(h);this._writeLabels(t,e,l,o,s,n)}t.endDisplayObject()}_findLabelRef(t){for(const e of t)if(e instanceof ge)return e;return null}_writeLabels(t,e,i,r,n,o){for(const a of r)if(s(a)&&a){const{glyphs:s,rtl:r,index:l}=a,h=this._labelTemplates[l],c=t.get(h.geometryType);h.bindReferenceTemplate(n),h.bindTextInfo(s,r),h.writeMesh(t,c,e,this._geometryType,i,o)}}}export{Ls as W,Cs as a,ps as b,$t as c,Xt as e,Et as o};
