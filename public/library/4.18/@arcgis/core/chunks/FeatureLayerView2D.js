/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"./ArrayPool.js";import"./object.js";import"./deprecate.js";import{clone as t}from"../core/lang.js";import"../config.js";import{i,L as r,k as s,c as o,b as a}from"./Logger.js";import"./string.js";import"./metadata.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import"../core/Accessor.js";import"./PropertyOrigin.js";import{f as l}from"../core/scheduling.js";import{all as p,createResolver as u,createAbortController as h,ignoreAbortErrors as c,throwIfNotAbortError as d,debounce as m,isAbortError as y,eachAlwaysValues as f,after as g}from"../core/promiseUtils.js";import"./Message.js";import _ from"../core/Error.js";import"./compilerUtils.js";import"./ensureType.js";import{subclass as j}from"../core/accessorSupport/decorators/subclass.js";import"./Evented.js";import b from"../core/Collection.js";import"./collectionUtils.js";import"./JSONSupport.js";import{E as v}from"./Promise.js";import"./Loadable.js";import"../core/urlUtils.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"./jsonMap.js";import"./enumeration.js";import"./reader.js";import"./writer.js";import"./resourceExtension.js";import"./persistableUrlUtils.js";import"../geometry/SpatialReference.js";import"./locale.js";import"./number.js";import"../intl.js";import"../kernel.js";import"../request.js";import"./assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"./Ellipsoid.js";import"../geometry/support/webMercatorUtils.js";import R from"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import"./mathUtils2.js";import"./common.js";import"./colorUtils.js";import"../Color.js";import"./zmUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./domains.js";import"./arcadeOnDemand.js";import"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"./date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"./chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"./Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import{a as S}from"./screenUtils.js";import"./opacityUtils.js";import"./materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./utils.js";import"./Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"./colors.js";import"./Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"./Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"./Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"./urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols/support/jsonUtils.js";import"./uid.js";import w from"../Graphic.js";import"../core/Handles.js";import"./LegendOptions.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../renderers/visualVariables/SizeVariable.js";import"./sizeVariableUtils.js";import"./unitUtils.js";import"./lengthUtils.js";import"./visualVariableUtils.js";import"../geometry/support/normalizeUtils.js";import"./timeUtils.js";import"../TimeExtent.js";import{whenFalseOnce as x,init as I}from"../core/watchUtils.js";import"./fieldType.js";import"./mat4.js";import"./aaBoundingRect.js";import"./ElevationInfo.js";import"./unitConversionUtils.js";import"./commonProperties2.js";import"../core/HandleOwner.js";import"./_commonjsHelpers.js";import"../core/workers/Connection.js";import"./Scheduler.js";import{open as U}from"../core/workers/workers.js";import"./vec2.js";import"../layers/support/Field.js";import T from"../tasks/support/FeatureSet.js";import"./DataLayerSource.js";import C from"../tasks/support/Query.js";import"../tasks/support/StatisticDefinition.js";import{R as P}from"./RefreshableLayerView.js";import{T as F}from"./TileKey.js";import{v as E,k as O}from"./definitions.js";import{g as k}from"./capabilities2.js";import"./BidiText.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2f32.js";import"./number2.js";import"./Rect.js";import"./BidiEngine.js";import"./MD5.js";import{f as V,a as M,i as q,c as D}from"./clusterUtils2.js";import{a as L}from"./TileInfoView.js";import"./isWebGL2Context.js";import"./mat4f32.js";import"./RenderingContext.js";import"./DisplayObject.js";import H from"../views/layers/LayerView.js";import z from"../views/layers/support/FeatureFilter.js";import A from"../views/layers/support/FeatureEffect.js";import{E as G}from"./Container.js";import"./ClipRect.js";import{L as N}from"./LayerView2D.js";import"./enums.js";import"./Utils10.js";import"./MaterialKey.js";import{C as J,R as B}from"./CIMSymbolHelper.js";import{f as Q}from"./graphicsUtils.js";import{t as $}from"./util2.js";import{c as W,a as K}from"./drapedUtils.js";import"./visualVariablesUtils2.js";import{b as X}from"./schemaUtils.js";import"./popupUtils.js";import{F as Y}from"./FeatureLayerView.js";var Z;let ee=Z=class extends w{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer&&this.sourceLayer.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.objectId}clone(){return new Z({objectId:this.objectId,...this.cloneProperties()})}};e([n({type:Boolean})],ee.prototype,"isAggregate",void 0),e([n({type:Number,json:{read:!0}})],ee.prototype,"objectId",void 0),ee=Z=e([j("esri.AggregateGraphic")],ee);var te=ee;const ie={"simple-marker":1,"picture-marker":1,text:0,"simple-line":0,"simple-fill":0,"picture-fill":0,cim:1,"web-style":1};async function re(e,t,i){if(!e||i&&"cluster"===i.type)return 0;if("heatmap"===e.type)return Math.round(3*e.blurRadius);if("dot-density"===e.type)return 0;if("dictionary"===e.type)return"esriGeometryPoint"===t||"esriGeometryMultipoint"===t?100:200;const r=e.getSymbols(),s=function(e){if(!("visualVariables"in e))return 0;if(!e.hasVisualVariables("size"))return 0;const t=e.getVisualVariablesForType("size");if(!t[0])return 0;const i=t[0];return"stops"===i.transformationType?i.stops.map((e=>e.size)).reduce(ue,0):"clamped-linear"===i.transformationType?"number"==typeof i.maxSize?i.maxSize:i.maxSize.stops.map((e=>e.size)).reduce(ue,0):"real-world-size"===i.transformationType?30:void 0}(e),o=[];for(const e of r)o.push(le(e,s));const a=await p(o);return S(a.reduce(ue,0))}const se=[0,0,0,0];function oe(e,t){return null==e?t:e}const ae={sdf:!0,code:99,metrics:E.metrics,rect:new B(0,0,24,24),page:0,textureBinding:2};async function ne(e,t){if("simple-marker"===e.type){const i=Math.max(oe(e.size,12),t);return pe(e)+.707*i}if("picture-marker"===e.type){const i=Math.max(oe(e.height,12),t),r=oe(e.width,12)*(i/oe(e.height,12))/2,s=i/2;return pe(e)+Math.sqrt(r*r+s*s)}if("text"===e.type){const t=function(e){const t=e.text&&e.text.length;if(!t)return{glyphMosaicItems:[ae]};const i=[];for(let r=0;r<t;r++)i.push({...ae,code:e.text.charCodeAt(r)});return{glyphMosaicItems:i}}(e);Q(se,e.toJSON(),t);const i=Math.abs(se[0]),r=Math.abs(se[1]),s=se[2],o=se[3];return Math.max(i,r)+Math.max(s,o)}if("simple-line"===e.type){const i=e,r=Math.max(oe(i.width,.75),t)/2;return i.marker?Math.max(6*i.width,2*t):r}if("simple-fill"===e.type||"picture-fill"===e.type)return Math.max(function(e,t){return null==e.outline?t:oe(e.outline.width,t)}(e,0),t)/2;if("cim"===e.type){const t=J.getEnvelope(e.data);return t?Math.sqrt(t.width*t.width+t.height*t.height):0}return"web-style"===e.type?ne(await e.fetchCIMSymbol(),t):0}async function le(e,t){return function(e){return e.type in ie}(e)?Math.min(await ne(e,t),75):0}function pe(e){const t=oe(e.xoffset,0),i=oe(e.yoffset,0);return Math.sqrt(t*t+i*i)}function ue(e,t){return Math.max(e,t)}let he=class extends v{constructor(e){super(e),this._startupResolver=u(),this.isReady=!1}initialize(){this._controller=h(),this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(e){this.client.tileRenderer=e}get closed(){return this._connection.closed}async startup(e,t,i){await this.when();const r=this._controller.signal,s=(o=i.source,Array.isArray(o)?{transferList:i.source,signal:r}:void 0);var o;const a={service:i,config:t,tileInfo:e.tileInfo.toJSON()};await this._connection.invoke("startup",a,s),this._startupResolver.resolve(),this._set("isReady",!0)}async updateTiles(e){return await this._startupResolver.promise,c(this._connection.invoke("updateTiles",e))}async update(e,t){const i={config:e,pause:t};return await this._startupResolver.promise,this._connection.invoke("update",i)}async invalidate(e){return await this._startupResolver.promise,this._connection.invoke("invalidate",e)}async resume(){return await this._startupResolver.promise,c(this._connection.invoke("controller.resume"))}async setHighlight(e){return await this._startupResolver.promise,c(this._connection.invoke("controller.setHighlight",e))}async refresh(){return await this._startupResolver.promise,c(this._connection.invoke("controller.refresh"))}async setViewState(e){return await this._startupResolver.promise,c(this._connection.invoke("setViewState",e.toJSON()))}async queryFeatures(e,t){return await this._startupResolver.promise,this._connection.invoke("controller.queryFeatures",e.toJSON(),t)}async queryObjectIds(e,t){return await this._startupResolver.promise,this._connection.invoke("controller.queryObjectIds",e.toJSON(),t)}async queryFeatureCount(e,t){return await this._startupResolver.promise,this._connection.invoke("controller.queryFeatureCount",e.toJSON(),t)}async queryExtent(e,t){return this._connection.invoke("controller.queryExtent",e.toJSON(),t)}async queryLatestObservations(e,t){return await this._startupResolver.promise,this._connection.invoke("controller.queryLatestObservations",e.toJSON(),t)}async queryStatistics(e){return await this._startupResolver.promise,this._connection.invoke("controller.queryStatistics",e)}async getObjectId(e){return await this._startupResolver.promise,this._connection.invoke("controller.getObjectId",e)}async getDisplayId(e){return await this._startupResolver.promise,this._connection.invoke("controller.getDisplayId",e)}async getFeature(e){return await this._startupResolver.promise,this._connection.invoke("controller.getFeature",e)}async getAggregate(e){return await this._startupResolver.promise,this._connection.invoke("controller.getAggregate",e)}async getAggregateValueRanges(){return await this._startupResolver.promise,this._connection.invoke("controller.getAggregateValueRanges")}async mapValidDisplayIds(e){return await this._startupResolver.promise,this._connection.invoke("controller.mapValidDisplayIds",e)}async onEdits(e){await this._startupResolver.promise;const{addedFeatures:t,deletedFeatures:i,updatedFeatures:r}=e;return c(this._connection.invoke("controller.onEdits",{addedFeatures:t,deletedFeatures:i,updatedFeatures:r}))}async enableEvent(e,t){return await this._startupResolver.promise,c(this._connection.invoke("controller.enableEvent",{name:e,value:t}))}async _startWorker(e){try{this._connection=await U("Pipeline",{client:this.client,strategy:"dedicated",signal:e})}catch(e){d(e)}}};e([n()],he.prototype,"isReady",void 0),e([n()],he.prototype,"client",void 0),e([n()],he.prototype,"tileRenderer",null),he=e([j("esri.views.2d.layers.support.FeatureLayerProxy")],he);var ce=he;class de{constructor(e){this._tiles=new Map,this.buffer=0,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.buffer=e.buffer}destroy(){}clear(){this._tiles.forEach((e=>this._releaseTile(e)))}tileKeys(){const e=[];return this._tiles.forEach(((t,i)=>e.push(i))),e}update(e){const t=this.tileInfoView.getTileCoverage(e.state,this.buffer,"closest"),{spans:i,lodInfo:r}=t,{level:s}=r,o=[],a=[],n=new Set,l=new Set;for(const{row:e,colFrom:t,colTo:a}of i)for(let i=t;i<=a;i++){const t=F.getId(s,e,r.normalizeCol(i),r.getWorldForColumn(i)),a=this._getOrAcquireTile(o,t);n.add(t),a.isReady?a.visible=!0:l.add(a.key)}l.forEach((e=>this._addPlaceholders(n,e))),this._tiles.forEach((e=>{n.has(e.key.id)||(a.push(e.key.id),this._releaseTile(e))})),L.pool.release(t);return{hasMissingTiles:l.size>0,added:o,removed:a}}_getOrAcquireTile(e,t){if(!this._tiles.has(t)){const i=this.acquireTile(new F(t));e.push(t),this._tiles.set(t,i),i.visible=!1}return this._tiles.get(t)}_getTile(e){return this._tiles.get(e)}_releaseTile(e){this._tiles.delete(e.key.id),this.releaseTile(e)}_addPlaceholders(e,t){const i=this._addPlaceholderChildren(e,t);if(!(Math.abs(1-i)<1e-6)){if(!this._addPlaceholderParent(e,t)){this._getTile(t.id).visible=!0}}}_addPlaceholderChildren(e,t){let i=0;return this._tiles.forEach((r=>{i+=this._addPlaceholderChild(e,r,t)})),i}_addPlaceholderChild(e,t,i){if(t.key.level<=i.level||!t.hasData||!i.contains(t.key))return 0;t.visible=!0,e.add(t.key.id);return 1/(1<<2*(t.key.level-i.level))}_addPlaceholderParent(e,t){let r=t.getParentKey(),s=0,o=null;for(;i(r);){if(e.has(r.id))return!0;const t=this._getTile(r.id);if(null!=t&&t.isReady)return t.visible=!0,e.add(t.key.id),!0;null!=t&&t.hasData&&t.patchCount>s&&(s=t.patchCount,o=t),r=r.getParentKey()}return!!o&&(o.visible=!0,e.add(o.key.id),!0)}}const me=r.getLogger("esri.views.2d.layers.FeatureLayerView2D");let ye=class extends(Y(P(N(H)))){constructor(){super(...arguments),this._pipelineIsUpdating=!0,this._updatingPipelineConfig=!1,this._onGoingEdits=0,this._isRefreshing=!1,this._viewStateId=-1,this._visibilityOverrides=new Set,this._effect=null,this._highlightIds=new Map,this._lastPixelBuffer=0,this.filter=null,this.effectLists={included:new G,excluded:new G},this.doRefresh=m((async()=>{this._onGoingEdits=0,this.isUpdating()&&await x(this,"updating");try{this._set("_isRefreshing",!0),this._lockGPUUploads(),await this._proxy.refresh(),this._unlockGPUUploads(),this._set("_isRefreshing",!1)}catch(e){y(e)||me.error(e)}})),this._doUpdate=m((async()=>{if(this.destroyed||!this._hasRequiredSupport(this.layer))return;this._set("_updatingPipelineConfig",!0),await x(this,"_isRefreshing");const{effect:e,filter:t}=this;if(await this._updateRequiredFields(),this.destroyed)return;const{renderer:r}=this._getEffectiveRenderer();this._set("_effectiveRenderer",r);const s="feature"===this.layer.type?this.layer.historicMoment:null,o="feature"===this.layer.type?this.layer.gdbVersion:null,a={renderer:this.layer.renderer,spatialReference:this.layer.spatialReference,timeExtent:this.layer.timeExtent,definitionExpression:this.layer.definitionExpression,featureReduction:this.layer.featureReduction,fields:this.layer.fields,geometryType:this.layer.geometryType,historicMoment:s,labelsVisible:this.layer.labelsVisible,labelingInfo:this.layer.labelingInfo,availableFields:this.availableFields,effect:this.effect,filter:this.filter,gdbVersion:o,pixelBuffer:0},n=$(this.layer.geometryType),l=await re(r,n,this.layer.featureReduction),p=this._createConfiguration(a,t,e);this._lastPixelBuffer=0===l?0:Math.max(l,this._lastPixelBuffer),p.schema.source.pixelBuffer=this._lastPixelBuffer;const u=this._createTileRendererHash(r);if(!this.destroyed){if(u!==this._tileRendererHash){if(await this._initTileRenderer(r),this.destroyed)return;const e=await this._createServiceOptions();if(this.destroyed)return;if(this.effects.forEach((e=>i(e)&&i(e.filter)&&e.filter.enable())),this.tileRenderer.onConfigUpdate(r),await this._proxy.startup(this.view.featuresTilingScheme,p,e),await this._proxy.updateTiles({added:this._tileStrategy.tileKeys(),removed:[]}),this.destroyed)return;if(this.hasHighlight()&&await this._proxy.setHighlight(Array.from(this._highlightIds.keys())),this.destroyed)return;if(await this._onceTilesUpdated(),this.destroyed)return;this.tileRenderer.onConfigUpdate(r)}else{const e=await this._proxy.update(p,!0);if(this.destroyed)return;if(e.queryFilter){this._lockGPUUploads();try{await this._proxy.invalidate(e)}catch(e){y(e)||me.error(e)}if(this.destroyed)return;this._unlockGPUUploads()}else{try{await this._proxy.invalidate({...e,mesh:!1})}catch(e){y(e)||me.error(e)}if(this.destroyed)return;if(e.mesh){this._lockGPUUploads();try{var h;await this._proxy.invalidate({mesh:!0,targets:{aggregate:null==(h=e.targets)?void 0:h.aggregate}})}catch(e){y(e)||me.error(e)}this._unlockGPUUploads()}}if(this.destroyed)return;this._proxy.resume(),this.effects.forEach((e=>i(e)&&i(e.filter)&&e.filter.enable())),this.tileRenderer.onConfigUpdate(r),this._forceAttributeTextureUpload()}this._tileRendererHash=u,this.tileRenderer.invalidateLabels(),this.requestUpdate()}})),this._updateHighlight=m((async()=>this._proxy.setHighlight(Array.from(this._highlightIds.keys()))))}destroy(){var e,t;null==(e=this._proxy)||e.destroy(),s(this._updateClusterSizeTask,(e=>e.remove())),null==(t=this.tileRenderer)||t.destroy()}initialize(){this.addResolvingPromise(this._initProxy()),this.handles.add([this.on("valueRangesChanged",(e=>{this._set("_aggregateValueRanges",e.valueRanges)})),I(this,"effect",(e=>{this.effectLists.included.effect=null==e?void 0:e.includedEffect})),I(this,"effect",(e=>{this.effectLists.excluded.effect=null==e?void 0:e.excludedEffect}))])}async _initProxy(){if("stream"!==this.layer.type&&"ogc-feature"!==this.layer.type&&this.layer.isTable)throw new _("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:this.layer});this._proxy&&this._proxy.destroy();const e=this._createClientOptions();return this._set("_proxy",new ce({client:e})),this._proxy.when()}get labelsVisible(){return!this.suspended&&this.layer.labelingInfo&&this.layer.labelsVisible}get effect(){return o(this._effect,null)}set effect(e){const t=this._effect;i(t)&&i(t.filter)&&t.filter.enabled&&i(e)&&i(e.filter)&&e.filter.enable(),this._effect=e,this.notifyChange("effect")}get effects(){return this.effect&&[this.effect]||[]}get renderingConfigHash(){if(!this.layer)return null;const e=this.availableFields,t=this.layer,{definitionExpression:r,renderer:s,labelingInfo:o}=t,a="feature"===t.type?t.gdbVersion:void 0,n="feature"===t.type&&t.historicMoment?t.historicMoment.getTime():void 0,{timeExtent:l}=this,p="stream"===t.type?`${JSON.stringify(t.geometryDefinition)}${t.definitionExpression}`:null,u=JSON.stringify(this.clips),h=t.featureReduction&&t.featureReduction.toJSON();return JSON.stringify({filterHash:i(this.filter)&&this.filter.toJSON(),effectHash:i(this.effect)&&this.effect.toJSON(),streamFilter:p,gdbVersion:a,definitionExpression:r,historicMoment:n,availableFields:e,renderer:s,labelingInfo:t.labelsVisible&&o,timeExtent:l,clipsHash:u,featureReduction:h})}get hasEffects(){return this.effectLists.included.hasEffects||this.effectLists.excluded.hasEffects}highlight(e){let t;return e instanceof w?t=[e.getObjectId()]:"number"==typeof e?t=[e]:b.isCollection(e)?t=e.map((e=>e&&e.getAttribute(this.layer.objectIdField))).toArray():Array.isArray(e)&&e.length>0&&(t="number"==typeof e[0]?e:e.map((e=>e&&e.getAttribute(this.layer.objectIdField)))),t&&t.length?(t=t.filter((e=>null!=e)),this._addHighlight(t),{remove:()=>this._removeHighlight(t)}):{remove:()=>{}}}hasHighlight(){return!!this._highlightIds.size}hitTest(e,t){return this._hitTest(e,t)}queryStatistics(){return this._proxy.queryStatistics()}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then((e=>{const t=T.fromJSON(e);return t.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer})),t}))}queryFeaturesJSON(e,t){return this._proxy.queryFeatures(this._cleanUpQuery(e),t)}queryObjectIds(e,t){return this._proxy.queryObjectIds(this._cleanUpQuery(e),t)}queryFeatureCount(e,t){return this._proxy.queryFeatureCount(this._cleanUpQuery(e),t)}queryExtent(e,t){return this._proxy.queryExtent(this._cleanUpQuery(e),t).then((e=>({count:e.count,extent:R.fromJSON(e.extent)})))}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:t,added:i,removed:r}=this._tileStrategy.update(e);(i.length||r.length)&&this._proxy.updateTiles({added:i,removed:r}),t&&this.requestUpdate();const{state:s}=e;this._viewStateId!==s.id&&(this._proxy.setViewState(s),this._viewStateId=s.id),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new de({acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.handles.add(I(this,"renderingConfigHash",(()=>this._update())),"attach"),"stream"!==this.layer.type&&this.handles.add(this.layer.on("edits",(async e=>{this._set("_onGoingEdits",this._onGoingEdits+1),await this._proxy.onEdits(e),this._set("_onGoingEdits",Math.max(0,this._onGoingEdits-1))})),"attach")}detach(){this.container.removeAllChildren(),this.handles.remove("attach"),this._updatingPipelineConfig=!1,this.tileRenderer&&(this.tileRenderer.uninstall(this.container),this.tileRenderer=null),this._tileStrategy&&(this._tileStrategy.destroy(),this._tileStrategy=null),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}async fetchPopupFeatures(e,t){if(i(t)&&t.clientGraphics.length){const e=t.clientGraphics[0];if(e instanceof te)return[e]}const r=this.validateFetchPopupFeatures(t);if(r)throw r;if(i(t)&&0===t.clientGraphics.length)return[];const s=this.fetchClientPopupFeatures(t);if(!e)return s;const o=this._fetchServicePopupFeatures(e,t);return f([s,o]).then(l)}async _fetchServicePopupFeatures(e,t){if("stream"===this.layer.type)return[];const r=await this.createPopupQuery(t),{layer:s}=this,{renderer:o}=s,a=i(t)?t.event:null,n=W({renderer:o,event:a});r.geometry=this.createFetchPopupFeaturesQueryGeometry(e,n);const l=new Set,{objectIdField:p}=s,u=i(t)?t.clientGraphics:null;if(u)for(const e of u)l.add(e.attributes[p]);return s.queryFeatures(r).then((e=>e.features.filter((e=>!l.has(e.attributes[p])))))}createFetchPopupFeaturesQueryGeometry(e,t){return K(e,t,this.view)}isUpdating(){return null!=this.layer.renderer&&(null!=this._updatingRequiredFieldsPromise||null==this.tileRenderer||!this._proxy||!this._proxy.isReady||this._pipelineIsUpdating||this._updatingPipelineConfig||this.tileRenderer.updating||this._onGoingEdits>0)}_createClientOptions(){return{setUpdating:e=>{this._set("_pipelineIsUpdating",e)},emitEvent:e=>{this.emit(e.name,e.event)}}}async _createServiceOptions(){const e=this.layer;if("stream"===e.type)return null;const{capabilities:i,objectIdField:r}=e,s=e.fields.map((e=>e.toJSON())),o=e.fullExtent&&e.fullExtent.toJSON(),a=$(e.geometryType),n=e.timeInfo&&e.timeInfo.toJSON()||null,l=e.spatialReference?e.spatialReference.toJSON():null,p="feature"===e.type?e.customParameters:null;let u;return"ogc-feature"===e.type?u=function(e){const{capabilities:t,collectionId:i,source:{layerDefinition:r},url:s}=e;return{capabilities:t,collectionId:i,url:s,layerDefinition:r}}(e):!function(e){return e&&"openPorts"in e}(e.source)?e.parsedUrl&&(u=t(e.parsedUrl),"dynamicDataSource"in e&&e.dynamicDataSource&&(u.query={layer:JSON.stringify({source:e.dynamicDataSource})})):u=await e.source.openPorts(),{type:"on-demand",maxRecordCount:i.query.maxRecordCount,tileMaxRecordCount:i.query.tileMaxRecordCount,capabilities:i,fields:s,fullExtent:o,geometryType:a,objectIdField:r,source:u,timeInfo:n,spatialReference:l,customParameters:p}}async _createMemoryServiceOptions(e){const t=await e.openPorts();return{...this._createServiceOptions(),type:"memory",source:t}}_cleanUpQuery(e){const t=C.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}_createUpdateClusterSizeTask(e,t){return this.watch("_aggregateValueRanges",(async i=>{this._updateClusterEffectiveRendererSizeVariable(e,t,i),this._updatingPipelineConfig||this.tileRenderer.onConfigUpdate(this._effectiveRenderer)}))}async _updateClusterEffectiveRendererSizeVariable(e,t,r){if(e.dynamicClusterSize&&"visualVariables"in e&&e.visualVariables){const s=V(e.visualVariables);if(i(s)&&"cluster_count"===s.field){const i=e.visualVariables.indexOf(s);e.visualVariables[i]=M(t,r);const o=e.clone();o.dynamicClusterSize=!0,this._set("_effectiveRenderer",o)}}}_getEffectiveRenderer(){const e=this.layer.renderer,t=this.layer.featureReduction;if(i(this._updateClusterSizeTask)&&(this._updateClusterSizeTask.remove(),this._updateClusterSizeTask=null),t&&"cluster"===t.type&&q(e)){const i=t,r=[],o=D(r,e,i,this._aggregateValueRanges);return s(this._updateClusterSizeTask,(e=>e.remove())),this._updateClusterSizeTask=this._createUpdateClusterSizeTask(o,i),{renderer:o,aggregateFields:r,featureReduction:t}}return{renderer:e,aggregateFields:[],featureReduction:null}}_acquireTile(e){const t=this.tileRenderer.acquireTile(e);return t.once("attach",(()=>{this.requestUpdate()})),t}_releaseTile(e){this.tileRenderer.releaseTile(e)}async _initTileRenderer(e){const t=await async function(e,t){if(!e)return null;switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return new((await import("./SymbolTileRenderer.js")).default)(t);case"heatmap":return new((await import("./HeatmapTileRenderer.js")).default)(t)}}(e,{layerView:this,tileInfoView:this.view.featuresTilingScheme,layer:this.layer});return this.tileRenderer&&(this._tileStrategy.clear(),this.tileRenderer.uninstall(this.container),this.tileRenderer.destroy(),this.tileRenderer=null),this.destroyed?null:(this._proxy.tileRenderer=t,this._set("tileRenderer",t),this.tileRenderer.install(this.container),this.tileRenderer.onConfigUpdate(e),this.requestUpdate(),this.tileRenderer)}_createTileRendererHash(e){return`${"heatmap"===e.type?"heatmap":"symbol"}.${"dot-density"===e.type}`}_createFeatureDataHash(e,t,r){const s=e.getAttributeHash(),o=JSON.stringify(t),a=i(r)&&JSON.stringify(r.filter),n=JSON.stringify(this.timeExtent);let l="";return this._visibilityOverrides.forEach((e=>l+=e)),`${s}.${o}.${a}.${n}.${l}`}_injectOverrides(e){const t=i(e)?e.timeExtent:null,r=i(this.timeExtent)&&i(t)?this.timeExtent.intersection(t):this.timeExtent||t;if(!this._visibilityOverrides.size&&!r)return e;const s=i(e)&&e.clone()||new z;return s.hiddenIds=this._visibilityOverrides,s.timeExtent=r,s}_createConfiguration(e,t,r){const s="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,o="feature"===this.layer.type?this.layer.gdbVersion:void 0,n=new Array(O),l=this._injectOverrides(t);n[0]=i(l)?l.toJSON():null,n[1]=i(r)&&r.filter?r.filter.toJSON():null;const p=X(e);if(a(p))return null;const u=k();return{definitionExpression:this.layer.definitionExpression,availableFields:this.availableFields,gdbVersion:o,historicMoment:s,devicePixelRatio:window.devicePixelRatio||1,filters:n,schema:p,supportsTextureFloat:u.supportsTextureFloat,maxTextureSize:u.maxTextureSize}}_hasRequiredSupport(e){var t;return!("dot-density"===(null==(t=e.renderer)?void 0:t.type)&&!k().supportsTextureFloat)||(me.error(new _("webgl-missing-extension","Missing WebGL extension OES_Texture_Float which is required for DotDensity")),!1)}_onceTilesUpdated(){return this.requestUpdate(),x(this,"_pipelineIsUpdating",!1)}_lockGPUUploads(){this.tileRenderer&&this.tileRenderer.lockGPUUploads()}_unlockGPUUploads(){this.tileRenderer&&this.tileRenderer.unlockGPUUploads()}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_update(){this.view.timeline.begin(`${this.layer.title} (FeatureLayer) Initial Pipeline Config`);const e=this._doUpdate();this._updatingPromise=e;const t=()=>{e===this._updatingPromise&&this._set("_updatingPipelineConfig",!1),this.view&&this.view.timeline.end(`${this.layer.title} (FeatureLayer) Initial Pipeline Config`)};e.then(t).catch((e=>{y(e)||me.error(e),t()}))}_addHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t);this._highlightIds.set(t,e+1)}else this._highlightIds.set(t,1);this._updateHighlight().catch((e=>{y(e)||me.error(e)}))}_removeHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const e=this._highlightIds.get(t)-1;0===e?this._highlightIds.delete(t):this._highlightIds.set(t,e)}this._updateHighlight().catch((e=>{y(e)||me.error(e)}))}_createHittestResult(e){return e.layer=this.layer,e.sourceLayer=this.layer,i(e.geometry)&&(e.geometry.spatialReference=this.view.spatialReference),e}async _hitTest(e,t){if(this.suspended||!this.tileRenderer)return null;const r=await this.tileRenderer.hitTest(e,t);if(0===r.length)return await g(1),null;const o=r[0];if(!(e=>(2147483648&e)>>>31==1)(o)){const e=await this._proxy.getFeature(o);return s(e,(e=>this._createHittestResult(w.fromJSON(e))))}const n=await this._proxy.getAggregate(o);if(a(n))return null;if(i(n.referenceId)){const e=await this._proxy.getFeature(n.referenceId);return s(e,(e=>this._createHittestResult(w.fromJSON(e))))}return this._createHittestResult(te.fromJSON(n))}};e([n()],ye.prototype,"_proxy",void 0),e([n()],ye.prototype,"_pipelineIsUpdating",void 0),e([n()],ye.prototype,"_updatingPipelineConfig",void 0),e([n()],ye.prototype,"_effectiveRenderer",void 0),e([n()],ye.prototype,"_aggregateValueRanges",void 0),e([n()],ye.prototype,"_onGoingEdits",void 0),e([n()],ye.prototype,"_isRefreshing",void 0),e([n({dependsOn:["suspended","layer.labelingInfo","layer.labelsVisible"]})],ye.prototype,"labelsVisible",null),e([n({type:z})],ye.prototype,"filter",void 0),e([n({type:A})],ye.prototype,"effect",null),e([n({readOnly:!0,dependsOn:["effect"]})],ye.prototype,"effects",null),e([n({dependsOn:["layer.renderer","layer.outFields","layer.definitionExpression","layer.gdbVersion?","layer.geometryDefinition?","layer.historicMoment?","layer.labelingInfo","layer.labelsVisible","layer.featureReduction","filter","effect","timeExtent","clips"]})],ye.prototype,"renderingConfigHash",null),e([n()],ye.prototype,"tileRenderer",void 0),e([n({dependsOn:["layer.renderer","tileRenderer","tileRenderer.updating","_updatingPipelineConfig","_pipelineIsUpdating","_updatingRequiredFieldsPromise","_proxy","_proxy.isReady?","_onGoingEdits"]})],ye.prototype,"updating",void 0),ye=e([j("esri.views.2d.layers.FeatureLayerView2D")],ye);var fe=ye;export default fe;
