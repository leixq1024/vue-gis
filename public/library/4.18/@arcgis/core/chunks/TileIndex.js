/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{isAbortError as e,resolve as t}from"../core/promiseUtils.js";import{T as l}from"./TilemapCache.js";import{T as i}from"./TileKey.js";class r{constructor(e){if(e instanceof l)this._tilemapCache=e;else{if(!e||!("index"in e))throw new Error("Invalid tilemap!");this._tilemap=e.index}}dataKey(t,l){if(this._tilemapCache){const{level:r,row:a,col:o}=t,h=new i(t);return this._tilemapCache.fetchAvailabilityUpsample(r,a,o,h,l).then((()=>(h.world=t.world,h))).catch((t=>{if(e(t))throw t;return null}))}return this._getIndexedDataKey(t)}forEach(e,t,l,i,r){this._callback=r,this._maxLevel=t+e,this._forEach(this._tilemap,t,l,i)}_forEach(e,t,l,i){0!==e&&(this._callback(t,l,i),t!==this._maxLevel&&"object"==typeof e&&(this._forEach(e[0],t+1,2*l,2*i),this._forEach(e[1],t+1,2*l,2*i+1),this._forEach(e[2],t+1,2*l+1,2*i),this._forEach(e[3],t+1,2*l+1,2*i+1)))}_getIndexedDataKey(e){const l=[e];if(e.level<0||e.row<0||e.col<0||e.row>>e.level>0||e.col>>e.level>0)return t(null);let r=e;for(;0!==r.level;)r=new i(r.level-1,r.row>>1,r.col>>1,r.world),l.push(r);let a,o,h=this._tilemap,s=l.pop();if(1===h)return t(s);for(;l.length;)if(a=l.pop(),o=(1&a.col)+((1&a.row)<<1),h){if(0===h[o]){s=null;break}if(1===h[o]){s=a;break}s=a,h=h[o]}return t(s)}}export{r as T};
