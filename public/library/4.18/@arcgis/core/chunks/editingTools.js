/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"./ArrayPool.js";import{h as t}from"./object.js";import"./deprecate.js";import"../core/lang.js";import"../config.js";import{b as i,c as a,i as s,u as r,e as o}from"./Logger.js";import"./string.js";import{h as n,j as l,r as p,f as h}from"./metadata.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import"../core/Accessor.js";import"./PropertyOrigin.js";import{addFrameTask as u}from"../core/scheduling.js";import"../core/promiseUtils.js";import"./Message.js";import"../core/Error.js";import"./compilerUtils.js";import"./ensureType.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import{E as m}from"./Evented.js";import g from"../core/Collection.js";import"./collectionUtils.js";import"./JSONSupport.js";import"./Promise.js";import"./Loadable.js";import"../core/urlUtils.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"./jsonMap.js";import"./enumeration.js";import"./reader.js";import"./writer.js";import"./resourceExtension.js";import"./persistableUrlUtils.js";import"../geometry/SpatialReference.js";import"./locale.js";import"./number.js";import"../intl.js";import"../kernel.js";import"../request.js";import"./assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"./Ellipsoid.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import{d as y,c as v}from"./mathUtils2.js";import{c as f,f as _,a as M}from"./vec3f64.js";import{a as w,t as S}from"./common.js";import{f as x,a as j,s as E,p as D,c as O,n as G,d as A,e as P,l as I,h as V}from"./vec3.js";import{f as C,e as R}from"./mathUtils.js";import"./colorUtils.js";import T from"../Color.js";import"./zmUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./domains.js";import"./arcadeOnDemand.js";import"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"./date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"./chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"./Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import{g as k,b as z}from"./screenUtils.js";import"./opacityUtils.js";import"./materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./utils.js";import"./Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"./colors.js";import"./Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"./Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"./Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"./urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols/support/jsonUtils.js";import"./uid.js";import L from"../Graphic.js";import U from"../core/Handles.js";import"../layers/Layer.js";import"./unitUtils.js";import"./lengthUtils.js";import{b as F,t as H,d as Z}from"./colorUtils2.js";import"../geometry/support/normalizeUtils.js";import"./timeUtils.js";import"../TimeExtent.js";import{init as W}from"../core/watchUtils.js";import"./fieldType.js";import{u as N,i as B,v as Y,m as X,r as q,p as Q,t as J,e as K,s as $}from"./mat4.js";import"./pe.js";import{A as ee,c as te,e as ie,g as ae,n as se}from"./aaBoundingRect.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformationStep.js";import"../geometry/support/GeographicTransformation.js";import{projectVectorToVector as re,projectPointToVector as oe}from"../geometry/projection.js";import"./ElevationInfo.js";import"./unitConversionUtils.js";import"../core/HandleOwner.js";import"./_commonjsHelpers.js";import"../geometry/support/geodesicUtils.js";import"../geometry/Circle.js";import"./geometryEngineBase.js";import"./hydrated.js";import{convexHull as ne}from"../geometry/geometryEngine.js";import{a as le}from"./vec4f64.js";import"./earcut.js";import"./deduplicate.js";import"./triangulationUtils.js";import{c as pe}from"./quatf64.js";import"./mat3.js";import"./BufferView.js";import{k as he}from"./vec2.js";import{e as ce,c as ue}from"./vec4.js";import"./quat.js";import"./domUtils.js";import"./widgetUtils.js";import"./projector.js";import"./accessibleHandler.js";import"./messageBundle.js";import"./renderable.js";import"./vmEvent.js";import"./index.js";import"../widgets/support/widget.js";import"../widgets/Widget.js";import"./zscale.js";import"./queryZScale.js";import"../layers/support/Field.js";import"../tasks/support/FeatureSet.js";import"./BlendLayer.js";import"./ScaleRangeLayer.js";import"./defaultsJSON.js";import"./defaults.js";import"./DataLayerSource.js";import"../tasks/support/AttachmentQuery.js";import"../tasks/support/Query.js";import"../tasks/support/StatisticDefinition.js";import"../tasks/support/RelationshipQuery.js";import"./GraphicsCollection.js";import de from"../layers/GraphicsLayer.js";import"../tasks/Task.js";import"./OptimizedGeometry.js";import"./featureConversionUtils.js";import"../tasks/QueryTask.js";import"./pbf.js";import"./pbfQueryUtils.js";import"./query.js";import"../layers/support/AttachmentInfo.js";import{c as me,b as ge,F as ye}from"./aaBoundingBox.js";import"./MapUtils.js";import"./Queue.js";import"./InputManager.js";import"./interactiveToolUtils.js";import"./throttle.js";import"../widgets/Attachments.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../widgets/Feature/FeatureViewModel.js";import"../widgets/Feature.js";import"./AnchorElementViewModel.js";import"../widgets/Spinner/SpinnerViewModel.js";import"../widgets/Popup.js";import"./layerViewUtils.js";import"./actions.js";import"./GoTo.js";import"../widgets/Popup/PopupViewModel.js";import"./screenUtils2.js";import"./quantizationUtils.js";import"./mat2d.js";import{m as ve}from"./dehydratedFeatures.js";import"./ElevationProvider.js";import"./mat2df64.js";import{c as fe}from"./vec2f64.js";import"./PointerClickHoldAndDrag.js";import"./requestImageUtils.js";import"./PiUtils.glsl.js";import"./Program.js";import"./isWebGL2Context.js";import"./glUtil.js";import"./InterleavedLayout.js";import"./mat4f32.js";import"./vec3f32.js";import{c as _e,b as Me,p as we,r as be}from"./geometryUtils.js";import{G as Se,C as xe}from"./ColorMaterial.js";import"./Util.js";import{G as je}from"./Geometry.js";import"./VertexArrayObject.js";import{E as Ee}from"./sdfPrimitives.js";import"./lineUtils.js";import"./Object3D.js";import"./intersectorUtils.js";import"./Intersector.js";import"./Camera.js";import"./DefaultTextureUnits.js";import"./GLMaterialTexture.js";import"./VerticalOffset.glsl.js";import{e as De}from"./elevationAlignmentUtils.js";import{g as Oe,f as Ge,a as Ae}from"./mat2f64.js";import"./RenderingContext.js";import"./PhysicallyBasedRendering.glsl.js";import"./CameraSpace.glsl.js";import{c as Pe}from"./lineStippleUtils.js";import"./RenderGeometry.js";import"./Texture.js";import"./vec4f32.js";import"../views/draw/DrawAction.js";import"./Keys.js";import"../views/draw/MultipointDrawAction.js";import{S as Ie,b as Ve,c as Ce,E as Re,P as Te,e as ke,f as ze,g as Le,h as Ue}from"./DrawTool.js";export{b as DrawOperation}from"./DrawTool.js";import{e as Fe,d as He,g as Ze}from"./elevationInfoUtils.js";import{I as We,d as Ne,a as Be,c as Ye,b as Xe,e as qe,f as Qe,E as Je,g as Ke,h as $e,i as et,j as tt}from"./InteractiveToolBase.js";import{O as it,L as at}from"./RightAngleQuadVisualElement.js";import"./LaserLineRenderer.js";import"../views/draw/PointDrawAction.js";import"../views/draw/PolygonDrawAction.js";import"../views/draw/PolylineDrawAction.js";import{h as st,e as rt,f as ot,d as nt,g as lt,b as pt,a as ht}from"../views/draw/SegmentDrawAction.js";import"../views/draw/Draw.js";import"./drapedUtils.js";import{G as ct}from"./GraphicManipulator.js";import{b as ut,c as dt,d as mt,e as gt,a as yt}from"./dragEventPipeline3D.js";import{S as vt,e as ft,M as _t,a as Mt,g as wt,f as bt,p as St,d as xt}from"./manipulatorUtils.js";import{i as jt,a as Et}from"../widgets/Sketch/SketchViewModel.js";import{c as Dt}from"./manipulatorUtils2.js";import{O as Ot,G as Gt}from"./GraphicState.js";const At={main:new T([255,127,0]),selected:new T([255,255,255]),staged:new T([12,207,255]),outline:new T([0,0,0,.5]),selectedOutline:new T([255,255,255])};function Pt(e,t){const i=e.clone();return i.a*=t,i}function It(e,t){const i=e.clone(),a=F(i);a.s*=t;const s=H(a);return i.r=s.r,i.g=s.g,i.b=s.b,i}function Vt(e,t){if(t)for(const i in t)e[i]=t[i]}class Ct{constructor(e){this.color=At.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=16,Vt(this,e)}}class Rt{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=At.main,this.outlineColor=At.outline,this.renderOccluded=16,this.hoverOutlineColor=At.selectedOutline,Vt(this,e)}apply(e,t){const i=this[e];t.setParameterValues({color:Wt(i),transparent:"color"!==e||i.a<1,renderOccluded:this.renderOccluded})}}class Tt{constructor(e){this.vertex=new Rt({color:At.main,outlineColor:At.outline}),this.edge=new Rt({color:It(Pt(At.main,2/3),.5),outlineColor:Pt(At.outline,.5),size:8,collisionPadding:8}),this.selected=new Rt({color:At.selected,outlineColor:At.outline}),Vt(this,e)}}class kt{constructor(e){this.color=At.selected,this.width=1.5,this.stipplePattern=Pe([5,5]),this.stippleOffColor=At.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=At.selected,this.renderOccluded=4,Vt(this,e)}apply(e){e.color=Wt(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=Wt(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=Wt(this.innerColor),e.renderOccluded=this.renderOccluded}}class zt{constructor(e){this.color=At.selected,this.size=4,this.outlineSize=1,this.outlineColor=At.outline,this.shape="square",Vt(this,e)}apply(e){e.color=Wt(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=Wt(this.outlineColor),e.primitive=this.shape}}class Lt{constructor(e){this.innerColor=At.selected,this.innerWidth=1,this.glowColor=At.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.3,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=At.main,Vt(this,e)}apply(e,t=1){const i={glowColor:T.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:T.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*t,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=i:e.laserlineStyle=i}}class Ut{constructor(e){this.outline=new kt({color:At.outline,renderOccluded:8,stippleOffColor:At.selected,stipplePattern:Pe([5,5]),width:1.5,innerWidth:0}),this.staged=new kt({color:At.selected,renderOccluded:8,innerColor:At.staged,stippleOffColor:At.outline,stipplePattern:Pe([5,5]),width:1.5}),this.shadowStyle=new Lt({globalAlpha:.3,glowColor:At.main,glowFalloff:8,glowWidth:8,innerColor:At.selected,innerWidth:1}),Vt(this,e)}}class Ft{constructor(e){this.outline=new zt({color:At.selected,outlineColor:At.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Lt({globalAlpha:.3,glowColor:At.main,glowFalloff:1.5,glowWidth:6,innerColor:At.selected,innerWidth:1,radius:2}),Vt(this,e)}}class Ht extends kt{constructor(e){super(),this.extensionType=2,Vt(this,e)}}class Zt{constructor(e){this.lineGraphics=new Ut,this.pointGraphics=new Ft,this.heightPlane=new Lt({globalAlpha:.3,glowColor:At.main,glowFalloff:8,glowWidth:8,innerColor:At.selected,innerWidth:1}),this.heightBox=new Lt({globalAlpha:.3,glowColor:At.main,glowFalloff:8,glowWidth:8,innerColor:At.selected,innerWidth:0,heightFillColor:At.main}),this.zVerticalLine=new Ht({color:Pt(At.main,.5),falloff:2,innerColor:Pt(At.selected,0),renderOccluded:4,stipplePattern:null,width:5,extensionType:2}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,Vt(this,e)}}function Wt(e){return le(T.toUnitRGBA(e))}const Nt=new class{constructor(e){this.visualElements=new Zt,this.reshapeManipulators=new Tt,this.zManipulator=new Ct,Vt(this,e)}colorToVec4(e){return Wt(e)}};class Bt extends it{constructor(e){super(e),this.view=null,this._renderOccluded=4,this._vertices=null,this._spatialReference=null,this._color=Nt.colorToVec4(Nt.reshapeManipulators.vertex.color),this._size=Nt.reshapeManipulators.vertex.size,this._outlineColor=Nt.colorToVec4(Nt.reshapeManipulators.vertex.outlineColor),this._outlineSize=Nt.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial(),this.updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){ce(e,this._color)||(ue(this._color,e),this.updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){ce(e,this._outlineColor)||(ue(this._outlineColor,e),this.updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}updateMaterial(){this.attached&&this.vertexMaterial.setParameterValues(this.vertexMaterialParameters)}updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameterValues(this.vertexOutlineMaterialParameters)}createRenderGeometries(){const e=this.vertices;if(i(e)||0===e.length)return[];const t=Oe(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Ee.fromElevationInfo(this.elevationInfo)),a=[],s=t.numVertices,r=t.position;for(let e=0;e<s;++e){const t=x(Yt,r[3*e+0],r[3*e+1],r[3*e+2]),i=new je(Xt(.5,16,16,t),"VerticesVisualElement-vertex"),s=new je(Xt(.5,16,16,t),"VerticesVisualElement-vertexOutline");a.push({vertexGeometry:i,vertexOutlineGeometry:s})}return a}createGeometries(e){const t=this.createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:a}of t)e.addGeometry(i,this.vertexMaterial),e.addGeometry(a,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new vt({...this.vertexMaterialParameters,writeDepth:!0,cullFace:2,screenSizeEnabled:!0},"manipulator"),this.vertexOutlineMaterial=new vt({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:1,screenSizeEnabled:!0,shadingEnabled:!1},"manipulator-outline")}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalResource(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const Yt=f();function Xt(e,t,i,a){const s=Se.createSphereGeometry(e,t,i,{attributes:{position:ft.OFFSET,uv:null}});return s.indices[ft.POSITION]=new Uint32Array(s.indexCount),s.vertexAttributes[ft.POSITION]={size:3,data:Float64Array.from(a),offsetIdx:0,strideIdx:3},s}let qt=class extends(m.EventedMixin(We)){constructor(e){super(e),this.drawOperation=null,this._createGraphic=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._stagedVerticesVisualElement=null,this.hasZ=!0,this.defaultZ=0,this.elevationInfo=null,this.snapToScene=!1,this.snappingOptions=new Ie,this.mode=null,this.geometryType=null,this.type="draw-3d"}initialize(){const e=a(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this._internalGraphicsLayer=new de({elevationInfo:e}),this.view.map.layers.add(this._internalGraphicsLayer),this.drawOperation=new Ve({view:this.view,manipulators:this.manipulators,geometryType:Qt(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,snappingDrawSurface:new Ce(this.view,e,[this._internalGraphicsLayer]),hasM:!1,elevationInfo:e,snappingOptions:this.snappingOptions}),this.drawOperation.on("vertex-add",(e=>this.onVertexAdd(e))),this.drawOperation.on("vertex-remove",(e=>this.onVertexRemove(e))),this.drawOperation.on("vertex-update",(e=>this.onVertexUpdate(e))),this.drawOperation.on("cursor-update",(e=>this.onCursorUpdate(e))),this.drawOperation.on("complete",(e=>this.onComplete(e)))}destroy(){this.drawOperation.destroy(),this.drawOperation=null,this._destroyAllVisualisations(),this.view.map.remove(this._internalGraphicsLayer),this._set("view",null)}onInputEvent(e){this.drawOperation.onInputEvent(e)}_getCreateGeometry(e,t=!1){if(null==this.drawOperation)return null;const i=s(e)?e:this.drawOperation.hasStagedVertex?this.drawOperation.numVertices-1:null,a=this.drawOperation.vertices;if(0===a.length)return null;const r=this.drawOperation.spatialReference,o=a,n=o.slice(),l=[];s(i)&&(n.splice(i,1),l.push(o[i]));const p={regularVertices:null,stagedVertices:null,full:null,outline:null},h="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":p.regularVertices=n,p.stagedVertices=l,p.full=this.drawOperation.coordinateHelper.createPointFromArray(a[0]);break;case"polyline":p.regularVertices=n,p.stagedVertices=l,o.length>0&&(p.full=ht([o],r,h));break;case"polygon":p.regularVertices=n,p.stagedVertices=l,o.length>0&&(p.full=pt([o],r,h,!0));break;case"circle":if(o.length>0){const e=st(this.view,a[0]);if(1===o.length&&t){const t=o[0],i=e.makeMapPoint(t[0]+Jt*this.view.resolution,t[1]);p.full=nt([t,i],e,!0)}else 2===o.length&&(p.full=this.forceUniformSize?nt(a,e,this.centered):lt(a,e,this.centered))}break;case"rectangle":if(o.length>0){const e=st(this.view,a[0]);if(1===o.length&&t){const t=o[0],i=e.makeMapPoint(t[0]+Jt*this.view.resolution,t[1]);p.full=rt([t,i],e,!0)}else 2===o.length&&(p.full=this.forceUniformSize?rt(a,e,this.centered):ot(a,e,this.centered))}break;default:return null}switch(this.geometryType){case"point":break;case"polyline":o.length>1&&(p.outline=ht([o],r,h));break;case"polygon":o.length>1&&(p.outline=pt([o],r,h));break;case"circle":case"rectangle":s(p.full)&&"polygon"===p.full.type&&(p.outline=pt(p.full.rings,r,h))}return p}_destroyAllVisualisations(){this._destroyCreateGraphic(),this._destroyOutlineVisualElement(),this._destroyVerticesVisualElement(),this._destroyStagedVerticesVisualElement()}_destroyCreateGraphic(){s(this._createGraphic)&&(this._internalGraphicsLayer.remove(this._createGraphic),this._createGraphic.destroy(),this._createGraphic=null)}_destroyOutlineVisualElement(){s(this._outlineVisualElement)&&(this._outlineVisualElement.destroy(),this._outlineVisualElement=null)}_destroyVerticesVisualElement(){s(this._verticesVisualElement)&&(this._verticesVisualElement.destroy(),this._verticesVisualElement=null)}_destroyStagedVerticesVisualElement(){s(this._stagedVerticesVisualElement)&&(this._stagedVerticesVisualElement.destroy(),this._stagedVerticesVisualElement=null)}_updateCreateGraphic(e=null){const t=this._getCreateGeometry(e);if(i(t))return void this._destroyAllVisualisations();const a=this._internalGraphicsLayer.elevationInfo,o="on-the-ground"===Fe(this.hasZ,a);s(t.outline)?i(this._outlineVisualElement)?(this._outlineVisualElement=new Ot({view:this.view,geometry:t.outline,elevationInfo:r(a),isDraped:o,attached:!1}),Nt.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),Nt.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0):this._outlineVisualElement.geometry=t.outline:this._destroyOutlineVisualElement(),s(t.regularVertices)?i(this._verticesVisualElement)?(this._verticesVisualElement=new Bt({view:this.view,spatialReference:this.view.spatialReference,vertices:t.regularVertices,elevationInfo:r(this._internalGraphicsLayer.elevationInfo),renderOccluded:Nt.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0):this._verticesVisualElement.vertices=t.regularVertices:this._destroyVerticesVisualElement(),s(t.stagedVertices)?i(this._stagedVerticesVisualElement)?(this._stagedVerticesVisualElement=new Bt({view:this.view,spatialReference:this.view.spatialReference,vertices:t.stagedVertices,elevationInfo:r(this._internalGraphicsLayer.elevationInfo),renderOccluded:Nt.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._stagedVerticesVisualElement.color=Nt.colorToVec4(Nt.reshapeManipulators.selected.color),this._stagedVerticesVisualElement.attached=!0):this._stagedVerticesVisualElement.vertices=t.stagedVertices:this._destroyStagedVerticesVisualElement(),s(t.full)?i(this._createGraphic)?(this._createGraphic=new L({geometry:t.full,symbol:this.createGraphicSymbol}),this._internalGraphicsLayer.add(this._createGraphic),this.view.maskOccludee(this._createGraphic),this.notifyChange("createGraphic")):this._createGraphic.geometry=t.full:this._destroyCreateGraphic()}get createGraphic(){return this._createGraphic}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}set centered(e){this._set("centered",e),this._updateCreateGraphic()}set forceUniformSize(e){this._set("forceUniformSize",e),this._updateCreateGraphic()}reset(){}get canRedo(){return this.drawOperation.canRedo}redo(){this.drawOperation.redo()}get canUndo(){return this.drawOperation.canUndo}undo(){this.drawOperation.undo()}completeCreateOperation(){this.drawOperation.complete()}activate(){}deactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.vertices}onVertexAdd(e){this._updateCreateGraphic(),this.emit("vertex-add",e)}onVertexRemove(e){this._updateCreateGraphic(),this.emit("vertex-remove",e)}onVertexUpdate(e){this._updateCreateGraphic(),this.emit("vertex-update",e)}onCursorUpdate(e){this._updateCreateGraphic(1===e.vertices.length?e.vertices[0].vertexIndex:null),this.emit("cursor-update",e)}onComplete(e){this._updateCreateGraphic();let t=null;if(this.drawOperation.isCompleted){const e=this._getCreateGeometry(null,!0);s(e)&&(t=new L({geometry:e.full,symbol:this.createGraphicSymbol}))}this.emit("complete",{graphic:t,...e})}};function Qt(e){switch(e){case"point":case"polyline":case"polygon":return e;case"circle":case"rectangle":return"segment";default:return null}}e([c({constructOnly:!0,nonNullable:!0})],qt.prototype,"view",void 0),e([c()],qt.prototype,"createGraphicSymbol",void 0),e([c()],qt.prototype,"createGraphic",null),e([c({value:!0})],qt.prototype,"enabled",null),e([c({value:!0})],qt.prototype,"centered",null),e([c({value:!0})],qt.prototype,"forceUniformSize",null),e([c({constructOnly:!0})],qt.prototype,"hasZ",void 0),e([c({nonNullable:!0})],qt.prototype,"defaultZ",void 0),e([c({constructOnly:!0})],qt.prototype,"elevationInfo",void 0),e([c()],qt.prototype,"snapToScene",void 0),e([c()],qt.prototype,"snappingOptions",void 0),e([c({constructOnly:!0})],qt.prototype,"mode",void 0),e([c({constructOnly:!0})],qt.prototype,"geometryType",void 0),e([c({readOnly:!0})],qt.prototype,"type",void 0),qt=e([d("esri.views.3d.interactive.editingTools.draw3D.DrawTool")],qt);const Jt=48;class Kt{constructor(){this.grabbingState=0,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=0,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator(((e,t)=>{if(0===t&&(this.zManipulator=e),e instanceof _t&&(e.selected&&(0===this.numSelected&&(this.firstSelected=e),this.numSelected++),i(this.firstGrabbedXY)&&e.grabbing&&1===t&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=1,t){case 0:this.grabbingState|=2;break;case 1:this.grabbingState|=4}}))}}function $t(e){const{view:t,graphic:i}=e,a=new Gt({graphic:i}),r=function(e,t){const{view:i,graphic:a}=e,s=new Ot({view:i,geometry:ei(a)?a.geometry:null,elevationInfo:He(a),attached:!1});Nt.visualElements.lineGraphics.shadowStyle.apply(s);const r=()=>{s.attached=t.displaying};Nt.visualElements.lineGraphics.outline.apply(s);const o=[t.watch("displaying",r),t.watch("isDraped",(e=>s.isDraped=e)),t.on("changed",(()=>s.geometry=ei(a)?a.geometry:null)),l(s)];return r(),{visualElement:s,remove:()=>n(o).remove()}}(e,a),o=[r,function(e,t,i){const{graphic:a,view:r}=e,o=[],h=He(a),c="on-the-ground"===h.mode||!h.offset&&"absolute-height"!==h.mode,u=new Kt,d=new Re({view:r,extensionType:Nt.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});Nt.visualElements.pointGraphics.shadowStyle.apply(d);const m=y(Nt.visualElements.heightPlaneAngleCutoff),g=new at({view:r,attached:!1,angleCutoff:m});Nt.visualElements.heightPlane.apply(g);let v=1,f=1;const _=()=>{if(u.update(e),!i.displaying||c&&(i.isDraped||!ei(a)||!a.geometry.hasZ))return t.laserlineEnabled=!1,d.attached=!1,void(g.attached=!1);t.laserlineEnabled=!0;{const e=4&u.grabbingState?Nt.visualElements.laserlineAlphaMultiplier:1;e!==v&&(v=e,Nt.visualElements.lineGraphics.shadowStyle.apply(t,e),Nt.visualElements.pointGraphics.shadowStyle.apply(d,e))}{const e=2&u.grabbingState?Nt.visualElements.laserlineAlphaMultiplier:1;e!==f&&(f=e,Nt.visualElements.heightPlane.apply(g,e))}!function(e,t){const i=1===t.numSelected?t.firstSelected:t.numSelected>1&&s(t.firstGrabbedXY)?t.firstGrabbedXY:null;s(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}(d,u),function(e,t,i,a){if(a.numSelected>0){x(ti,0,0,0);let t=0;e.forEachManipulator(((e,i)=>{1===i&&e.selected&&e instanceof _t&&(j(ti,ti,e.renderLocation),t++)})),t>0?(i.heightManifoldTarget=E(ti,ti,1/t),i.attached=!0):i.attached=!1}else{const a=t.attachmentOrigin;s(a)&&e.view.renderCoordsHelper.toRenderCoords(a,ti)?(i.heightManifoldTarget=ti,i.attached=!0):i.attached=!1}}(e,t,g,u)};Nt.visualElements.zVerticalLine.apply(d),o.push(i.on("changed",_),i.watch("displaying",_),t.events.on("attachment-origin-changed",_),l(d),l(g));const M=[],w=()=>{n(M).remove(),M.length=0,e.forEachManipulator((e=>M.push(e.events.on("grab-changed",_)))),e.forEachManipulator((e=>M.push(e.events.on("select-changed",_)))),_()};return w(),o.push(e.onManipulatorsChanged(w),p((()=>n(M)))),n(o)}(e,r.visualElement,a),t.maskOccludee(i),t.trackGraphicState(a)];return{visualElement:r.visualElement,remove:()=>n(o).remove()}}function ei(e){return s(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const ti=f();function ii(e){const{view:t,graphic:i}=e,a=new Gt({graphic:i}),r=[],o=function(e,t,i){const{view:a,graphic:r}=e,o=new Te({view:a,geometry:ai(r)?r.geometry:null,elevationInfo:He(r),attached:!1});return function(e,t,i,a){const r=()=>t.attached=i.displaying;(function(e,t,i,a){const{view:r,graphic:o}=e;let n=null;const l=()=>{s(n)&&(n.remove(),n=null),i.isDraped&&ai(o)&&(n=function(e,t,i){const a=e.elevationProvider.spatialReference;oe(t,si,a);const s=si[0],r=si[1];return e.elevationProvider.on("elevation-change",(e=>{ee(e.extent,s,r)&&i()}))}(r,o.geometry,(()=>{t.geometry=o.geometry})))},h=()=>{l(),t.geometry=ai(o)?o.geometry:null};a.push(i.on("changed",h),p((()=>n))),h()})(e,t,i,a),Nt.visualElements.pointGraphics.outline.apply(t),a.push(W(i,"displaying",r))}(e,o,t,i),i.push(l(o)),o}(e,a,r);return function(e,t,i,a){const{view:s,graphic:r}=e,o=new Re({view:s,extensionType:Nt.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});Nt.visualElements.zVerticalLine.apply(o);const n=new at({view:s,intersectsLineInfinite:!0,attached:!1});Nt.visualElements.pointGraphics.shadowStyle.apply(n);const p=y(Nt.visualElements.heightPlaneAngleCutoff),h=new at({view:s,attached:!1,angleCutoff:p});Nt.visualElements.heightPlane.apply(h);const c=He(e.graphic),u=Ee.fromElevationInfo(c),d="on-the-ground"===c.mode||!c.offset&&"absolute-height"!==c.mode,m=new Kt;let g=1,v=1;const f=()=>{m.update(e);const i=d&&(t.isDraped||!ai(r)||!r.geometry.hasZ);let l=!0;if(!i&&ai(r)){const e=r.geometry,t=De(r.geometry,s.elevationProvider,u,s.renderCoordsHelper);x(si,e.x,e.y,t),re(si,e.spatialReference,si,s.renderCoordsHelper.spatialReference),o.setStartEndFromWorldDownAtLocation(si),n.intersectsWorldUpAtLocation=si}else l=!1;{const e=2&m.grabbingState?Nt.visualElements.laserlineAlphaMultiplier:1;e!==g&&(g=e,Nt.visualElements.heightPlane.apply(h,e))}{const e=ge(ri);!i&&t.displaying&&a.calculateMapBounds(e)&&re(ye(e,si),s.spatialReference,si,s.renderCoordsHelper.spatialReference)?(h.heightManifoldTarget=si,h.attached=!0):h.attached=!1}{const e=4&m.grabbingState?Nt.visualElements.laserlineAlphaMultiplier:1;e!==v&&(v=e,Nt.visualElements.pointGraphics.shadowStyle.apply(n,e))}const p=l&&t.displaying&&!i;n.attached=p,o.attached=p};i.push(t.watch(["displaying","isDraped"],f),t.on("changed",f)),e.forEachManipulator((e=>{i.push(e.events.on("grab-changed",f))})),i.push(l(n)),i.push(l(o)),i.push(l(h)),f()}(e,a,r,o),r.push(t.trackGraphicState(a)),{visualElement:o,remove(){n(r).remove()}}}function ai(e){return s(e.geometry)&&"point"===e.geometry.type}const si=f(),ri=me();function oi(e){switch(r(e.graphic.geometry).type){case"point":return ii(e);case"polygon":case"polyline":return $t(e);default:return null}}const ni=[1,.5,0],li=Math.ceil(70/3*2),pi=5*Math.PI/12,hi=1*Math.PI/3;class ci{constructor(){this._available=!0}set location(e){this.forEachManipulator3D((t=>t.location=e))}set elevationAlignedLocation(e){this.forEachManipulator3D((t=>t.elevationAlignedLocation=e))}set elevationInfo(e){this.forEachManipulator3D((t=>t.elevationInfo=e))}get available(){return this._available}set available(e){this._available=e,this.forEachManipulator3D((t=>t.available=e))}get grabbing(){return this.someManipulator((e=>e.grabbing))}get dragging(){return this.someManipulator((e=>e.dragging))}hasManipulator(e){return this.someManipulator((t=>t===e))}someManipulator(e){let t=!1;return this.forEachManipulator((i=>{!t&&e(i)&&(t=!0)})),t}forEachManipulator3D(e){this.forEachManipulator(((t,i)=>{t instanceof _t&&e(t,i)}))}}function ui(e,t,i){const a=e.graphic,s=(e,i)=>t({action:e,graphic:a,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY});return i(((e,t,i)=>{t.next((e=>("start"===e.action&&s("start",e),e))).next(Ne(a)).next((e=>{switch(e.action){case"start":case"update":(e.translationX||e.translationY||e.translationZ)&&s("update",e);break;case"end":s("end",e)}return e})),i.next(Be(a)).next((()=>{s("end",{screenDeltaX:0,screenDeltaY:0})}))}))}function di(e){if(i(e)||"polyline"!==e.type&&"polygon"!==e.type)return 0;const t=ne(e),a=t&&t.rings&&t.rings[0];if(!a)return 0;!function(e){let t=0,i=0;for(const a of e)t+=a[0],i+=a[1];t/=e.length,i/=e.length;for(const a of e)a[0]-=t,a[1]-=i}(a);const s=[];for(let e=0;e<a.length-1;e++){const t=Math.atan2(a[e+1][1]-a[e][1],a[e+1][0]-a[e][0]),i=C.normalize(t)%(Math.PI/2);s.push(i)}const r=s.sort(((e,t)=>e-t));let o=null,n=0,l=Number.POSITIVE_INFINITY,p=0;for(const e of r){if(e===o)continue;o=e,Ge(mi,e),ie(gi);for(const e of a)he(yi,e,mi),ae(gi,yi);const t=se(gi);((t>l?l/t:t/l)>=.99&&e<n||t<l)&&(n=e,l=t),p=Math.max(p,t)}return l/p>=.95?0:n}const mi=Ae(),gi=te(),yi=fe();class vi extends ci{constructor(e){super(),this._handles=new U,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this.createMaterial(),this._transparentMaterial=this.createMaterial(.5),this._angle=0,this._scale=1,this._radius=70,this._updateAfterDrag=!1,this.events=new m,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._handles.removeAll(),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){this._arrowManipulatorInfos.map((({manipulator:t})=>e(t,1)))}createGraphicDragPipeline(e,t){const i=e.graphic,a=He(i),s=r(i.geometry).spatialReference;return ui(e,t,(e=>this.createDragPipeline(e,a,s)))}createDragPipeline(e,t,i){return n(this._arrowManipulatorInfos.map((({manipulator:a},s)=>Ye(a,((a,r,o,n,l)=>{const p=r.next((e=>({...e,manipulatorType:1}))).next(Xe(this._view,a.elevationAlignedLocation)).next(ut(this._view,a.elevationAlignedLocation,t,i)).next(qe(a.location,this.angle+(s+1)*Math.PI*.5)).next(Qe());e(a,p,o,n,l)})))))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:t},i){const a=this._radius/70,s=54*a,r=Math.sqrt(s*s*3/4),o=Se.createExtrudedTriangle(r,s/2,s/2,.02);Se.transformInPlace(o,N(Me.get(),x(_e.get(),0,-r/3,0)));const n=new je(o,"move-xy-axis-arrow");e.renderObjects=[{geometry:n,material:this._opaqueMaterial,stateMask:2},{geometry:n,material:this._transparentMaterial,stateMask:1}],e.radius=r/3*2*1.2;const l=B(Me.get());Y(l,i*Math.PI/2);const p=B(Me.get());N(p,x(_e.get(),0,100*a,0)),X(t,l,p)}_createManipulators(){for(let e=0;e<4;e++){const t=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,t=B(Me.get());q(t,t,e,_(0,0,1));const i=Q(Me.get(),x(_e.get(),this.displayScale,this.displayScale,this.displayScale)),a=B(Me.get());X(a,i,t);for(const e of this._arrowManipulatorInfos){const t=X(Me.get(),a,e.transform);e.manipulator.modelTransform=t}}_createArrowManipulator(e){const t=new _t({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:_(0,0,1)}}),i={manipulator:t,transform:pe()};return this._updateArrowManipulator(i,e),this._handles.add(t.events.on("drag",(e=>{this._updateAfterDrag&&"end"===e.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}createMaterial(e=1){const t=T.toUnitRGBA(At.main);return t[3]*=e,new xe({color:t,transparent:1!==e,cullFace:2,renderOccluded:2},"graphic-transform")}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:e})=>e))}}}class fi{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Je,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&s(this.lastDragEvent)){const t=this.lastDragEvent.mapEnd,i=this.snap(this.lastDragEvent.screenEnd);if(s(i)){const a={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===e?i:t,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(a)}}this._enabled=e}snap(e){const t=s(this.view)?this.view.toMap(e,{exclude:[]}):null;return s(t)&&s(this.view)&&(t.z=Ze(t,this.view,this.elevationInfo)),t}createDragEventPipelineStep(e,t){return this.view=e,this.elevationInfo=t,this.lastDragEvent=null,e=>{if(this.lastDragEvent="end"!==e.action?{...e}:null,this._enabled){const t=this.snap(e.screenEnd);return s(t)?{action:e.action,mapStart:e.mapStart,mapEnd:t,screenStart:e.screenStart,screenEnd:e.screenEnd}:null}return{action:e.action,mapStart:e.mapStart,mapEnd:e.mapEnd,screenStart:e.screenStart,screenEnd:e.screenEnd}}}}class _i extends ci{constructor(e){super(),this._handles=new U,this._snapToScene=new fi,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=70,this._view=e.view,this._tool=e.tool,null!=e.snapToScene&&(this.snapToScene=e.snapToScene),null!=e.radius&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,t){const i=e.graphic,a=He(i),s=r(i.geometry).spatialReference;return ui(e,t,(e=>this.createDragPipeline(e,a,s)))}createDragPipeline(e,t,i){const a=this._view;return Ye(this._manipulator,((s,r,o,n,l)=>{const p=r.next(Xe(a,s.elevationAlignedLocation)).next(ut(a,s.elevationAlignedLocation,t,i)).next(this._snapToScene.createDragEventPipelineStep(a,t),this._snapToScene.next).next((e=>({...e,manipulatorType:1}))).next(Qe());e(s,p,o,n,l)}))}_updateManipulatorTransform(){const e=Q(Me.get(),x(_e.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new _t({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:_(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=new je(Se.createCylinderGeometry(.02,1,128,_(0,0,1),_(0,0,0)),"graphic-transform-disc"),t=Q(pe(),_(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:t,stateMask:2},{geometry:e,material:this._discMaterialTransparent,transform:t,stateMask:1}],this._manipulator.radius=this._radius/70*80}_createMaterial(e=1){const t=T.toUnitRGBA(At.main);return t[3]*=e,new xe({color:t,transparent:1!==e,cullFace:2,renderOccluded:2},"move-xy-disc")}get test(){return{discManipulator:this._manipulator}}}class Mi extends ci{constructor(e){super(),this._handles=new U,this._radius=70,this.events=new m,this._tool=e.tool,this._view=e.view,null!=e.radius&&(this._radius=e.radius),this.createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()}))}forEachManipulator(e){e(this._manipulator,0)}createGraphicDragPipeline(e,t){const i=r(e.graphic.geometry).spatialReference;return ui(e,t,(e=>this.createDragPipeline(e,i)))}createDragPipeline(e,t){const i=this._view;return Ye(this._manipulator,((a,s,r,o,n)=>{const l=s.next((e=>({...e,manipulatorType:0}))).next(dt(i,a.renderLocation,t)).next(Qe());e(a,l,r,o,n)}))}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this.updateManipulator())}updateManipulator(){const e=this._radius/70,t=Nt.zManipulator.height*e,i=Nt.zManipulator.coneHeight*e,a=Nt.zManipulator.coneWidth*e,s=Nt.zManipulator.width*e,r=[_(0,0,0),_(0,0,t)],o=new je(Se.createTubeGeometry(r,s/2,16,!1),"move-z"),n=Se.createConeGeometry(i,a/2,16,!1),l=new je(n),p=[_(0,0,0),_(0,0,t+i)],h=(e=>{const i=pe();if(J(i,i,[0,0,t]),K(i,i,Math.PI/2),e){const t=1+2*e/a;$(i,i,[t,t,t])}return i})(0),c=(e,t)=>{const i=Z(Nt.zManipulator.color,t);return[i.r/255,i.g/255,i.b/255,Nt.zManipulator.color.a*e]},u=Mt(c(1,.25),1),d=Mt(c(1,0),1),m=Mt(c(.7,0),Nt.zManipulator.renderOccluded),g=Mt(c(.85,0),Nt.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:h,material:u,stateMask:1},{geometry:o,material:u,stateMask:1},{geometry:l,transform:h,material:d,stateMask:2},{geometry:o,material:d,stateMask:2},{geometry:l,transform:h,material:m,stateMask:1},{geometry:o,material:m,stateMask:1},{geometry:l,transform:h,material:g,stateMask:2},{geometry:o,material:g,stateMask:2}],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[p]}}createManipulator(){const e=new _t({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const t=this._view.state.camera,i=wi;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,i);const a=D(t.eye,i),s=t.computeRenderPixelSizeAtDist(a),r=O(bi,i,t.eye);G(r,r);const o=Si;this._view.renderCoordsHelper.worldUpAtPosition(wi,o);const n=Math.abs(A(r,o)),l=P(bi,r,o),p=P(bi,l,o),h=v(n,.01,1),c=1-Math.sqrt(1-h*h)/h/t.fullWidth,u=this._radius/70,d=Nt.zManipulator.width*u;E(p,G(p,p),(1/c-1)*a+s*d),e[12]-=bi[0],e[13]-=bi[1],e[14]-=bi[2]},this._manipulator=e,this.updateManipulator()}}const wi=f(),bi=f(),Si=f();class xi extends ci{constructor(e){super(),this._handles=new U,this._angleDeferred=null,this._interactive=!0;const{tool:t,view:i,snapToScene:a,radius:s}=e;this._view=i,this.xyManipulation=new _i({tool:t,view:i,snapToScene:a,radius:s}),this.xyAxisManipulation=new vi({tool:t,view:i,radius:s}),this.zManipulation=new Mi({tool:t,view:i,radius:s}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this.autoHideXYAxis(),this.forEachManipulator((e=>{this._handles.add(e.events.on("grab-changed",(()=>this.updateManipulatorInteractivity())))}))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,t){return n([this.xyManipulation.createGraphicDragPipeline(e,t),this.xyAxisManipulation.createGraphicDragPipeline(e,t),this.zManipulation.createGraphicDragPipeline(e,t)])}createDragPipeline(e,t,i){return n([this.xyManipulation.createDragPipeline(e,t,i),this.xyAxisManipulation.createDragPipeline(e,t,i),this.zManipulation.createDragPipeline(e,i)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this.updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator((t=>e(t,1))),this.xyAxisManipulation.forEachManipulator((t=>e(t,1))),this.zManipulation.forEachManipulator((t=>e(t,0)))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator((e=>e.focused))||this.xyAxisManipulation.someManipulator((e=>e.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||e}autoHideXYAxis(){const e=this.xyAxisManipulation,i=this.xyManipulation;if(t("esri-mobile"))return;const a=[];i.forEachManipulator((e=>a.push(e))),e.forEachManipulator((e=>a.push(e)));const r=()=>{const t=[];this.xyAxisVisible?s(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator((e=>t.push(e.disableDisplay()))),this._handles.remove(ji),this._handles.add(t,ji)};for(const e of a)this._handles.add(e.events.on("focus-changed",r));this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",r)),r()}updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator((t=>{t.interactive=!e&&this._interactive||t.grabbing}))}static radiusForSymbol(e){const t=s(e)&&"point-3d"===e.type&&e.symbolLayers;return!!t&&t.length>0&&t.some((e=>"icon"===e.type))?li:70}}const ji="disable-xy-axis-display";class Ei extends ci{constructor(e){super(),this._handles=new U,this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,1)}createGraphicDragPipeline(e){return ui(this._graphicState,e,(e=>this.createDragPipeline(e)))}createDragPipeline(e){const t=this._view,i=this._graphicState.graphic,a=s(i.geometry)?i.geometry.spatialReference:null;return Ye(this._manipulator,((s,r,o,n,l)=>{const p=r.next(mt(l,t,i,a)).next(Ke()).next(Qe());e(s,p,o,n,l)}))}_createManipulator(){const e=this._view,t=this._graphicState.graphic;this._manipulator=new ct({graphic:t,view:e,selectable:!0,cursor:"move"})}}class Di{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class Oi{constructor(e,t,i){this.dx=e,this.dy=t,this.allGraphics=i,this.type="graphic-move"}}class Gi{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let Ai=class extends(m.EventedMixin(We)){constructor(e){super(e),this.graphics=new g,this.enableZ=!0,this.type="move-3d",this._toolHandles=new U,this._handles=new U}initialize(){this._toolHandles.add([this.graphics.on("change",(()=>this._refreshManipulators()))]),this._refreshManipulators()}destroy(){this._handles.destroy(),this._handles=null,this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}reset(){}_refreshManipulators(){this._handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const e=this.graphics.toArray().filter((e=>0===jt(e))).map((e=>new Pi(e)));e.length&&(this.createManipulators(e),this.createVisualElements(e),this._handles.add(e.map((e=>this.view.trackGraphicState(e.state)))),this.updateMoveManipulation(e))}createManipulators(e){for(const t of e){const i=t.state;t.manipulationXY=new Ei({tool:this,view:this.view,graphicState:i}),t.manipulationXY.forEachManipulator((e=>this._handles.add(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:i.graphic}),e.stopPropagation()}))))),this._handles.add(t.manipulationXY.createDragPipeline(((t,i,a)=>this.buildDragEventPipeline(t,i,a,e))))}this.createMoveManipulation(e)}createMoveManipulation(e){const t=new xi({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?xi.radiusForSymbol(e[0].graphic.symbol):70});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator((e=>{this._handles.add(e.events.on("immediate-click",(i=>{t.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.getItemAt(0)}),i.stopPropagation()})))}));const i=()=>this.updateMoveManipulation(e);for(const t of e)this._handles.add([t.state.on("changed",i),t.state.watch("displaying",i)]);const a=e[e.length-1];this._handles.add(a.state.on("changed",(()=>this.updateMoveManipulationAngle(a)))),this._handles.add(t.createDragPipeline(((t,i,a)=>{this.buildDragEventPipeline(t,i,a,e)}),He(a.graphic),r(a.graphic.geometry).spatialReference)),this.updateMoveManipulationAngle(a)}createVisualElements(e){for(const t of e){const i=t.graphic,a=oi({view:this.view,graphic:i,forEachManipulator:e=>{t.manipulationXY.forEachManipulator(e),this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>h()});t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof Ot&&this._handles.add([t.geometryRepresentation.events.on("attachment-origin-changed",(()=>{t.state.isDraped||this.updateMoveManipulation(e)})),t.state.watch("isDraped",(()=>this.updateMoveManipulation(e)))]),this._handles.add(a)}}updateMoveManipulationAngle(e){this._moveManipulation.angleDeferred=()=>di(e.graphic.geometry)}updateMoveManipulation(e){const t=ve(0,0,0,this.view.spatialReference);let i=0,a=!1;const r=this._moveManipulation;for(const r of e){if(!r.state.displaying)continue;const e=r.state.graphic;this.enableZ&&Dt(e)&&(a=!0);const o=r.geometryRepresentation instanceof Ot&&!r.state.isDraped?r.geometryRepresentation.attachmentOrigin:wt(this.view,e);s(o)&&(t.x+=o.x,t.y+=o.y,t.z+=o.z,i++)}i>0?(t.x/=i,t.y/=i,t.z/=i,r.location=t,r.xyManipulation.available=!0,r.xyAxisManipulation.available=!0,r.zManipulation.available=a):r.available=!1}buildDragEventPipeline(e,t,i,a){const s=[],r=[];let o=null,n=null;const l=()=>{for(const e of s)e.dragging=!1;s.length=0,r.length=0,o=null,n=null,this._moveManipulation.interactive=!0};t.next((t=>{if("start"===t.action){s.length=0,r.length=0;for(const t of a)t.dragging||!t.manipulationXY.hasManipulator(e)&&t.manipulationXY.grabbing||(s.push(t),r.push(t.graphic),t.dragging=!0);if(0!==r.length&&(this._moveManipulation.interactive=!1,o=$e(r),n=et(r),this.emit("graphic-move-start",new Di(r)),this.destroyed))return null}return 0!==r.length?t:null})).next((e=>o(e))).next((e=>{switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){const t=this.view.toScreen(e.mapStart),i=this.view.toScreen(e.mapEnd),a=i.x-t.x,s=i.y-t.y;if(this.emit("graphic-move",new Oi(a,s,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Gi(r)),this.destroyed)return null;l()}})),i.next((e=>n(e))).next((()=>{if(this.emit("graphic-move-stop",new Gi(r)),this.destroyed)return null;l()}))}};e([c({constructOnly:!0,nonNullable:!0})],Ai.prototype,"view",void 0),e([c({readOnly:!0})],Ai.prototype,"graphics",void 0),e([c({constructOnly:!0,nonNullable:!0})],Ai.prototype,"enableZ",void 0),e([c({readOnly:!0})],Ai.prototype,"type",void 0),Ai=e([d("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],Ai);class Pi{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new Gt({graphic:e})}get graphic(){return this.state.graphic}}let Ii=class extends m.EventedAccessor{constructor(e){super(e),this._vertexManipulatorMaterial=Mt(Nt.colorToVec4(Nt.reshapeManipulators.vertex.color),Nt.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=bt(Nt.colorToVec4(Nt.reshapeManipulators.vertex.outlineColor),Nt.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=bt(Nt.colorToVec4(Nt.reshapeManipulators.vertex.hoverOutlineColor),Nt.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=Mt(Nt.colorToVec4(Nt.reshapeManipulators.edge.color),Nt.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=bt(Nt.colorToVec4(Nt.reshapeManipulators.edge.outlineColor),Nt.reshapeManipulators.edge.renderOccluded),this._selectedManipulatorMaterial=Mt(Nt.colorToVec4(Nt.reshapeManipulators.selected.color),Nt.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=bt(Nt.colorToVec4(Nt.reshapeManipulators.selected.outlineColor),Nt.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=bt(Nt.colorToVec4(Nt.reshapeManipulators.selected.hoverOutlineColor),Nt.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._handles=new U,this._manipulatorHandles=new U,this._manipulatorInfos=[],this._reshapeHelper=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=0,this._outlineVisualElement=null,this.tool=null,this.outputGeometry=null,this._vertexLaserLineVisualElement=null,this.snappingEngine=new ke(e.tool.snappingOptions)}initialize(){const e=new Gt({graphic:this.graphic});this._graphicState=e,this._handles.add([e.watch("displaying",(e=>{for(const t of this._manipulatorInfos)t.manipulator.available=e})),this.view.trackGraphicState(e)])}destroy(){this._clear(),this._handles.destroy(),this.snappingEngine.destroy()}get inputGeometry(){return s(this._reshapeHelper)?this._reshapeHelper.geometry:null}set inputGeometry(e){this._recreateManipulators(e)}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZ(){return this.tool.enableZ}get enableMoveGraphic(){return this.tool.enableMoveGraphic}removeSelectedVertices(){const e=this._manipulatorInfos.filter((e=>e.manipulator.selected&&"vertex"===e.handle.type));this._removeVertices(e)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_clear(){this._moveManipulation=o(this._moveManipulation),this._graphicMoveManipulation=o(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[],this._reshapeHelper=null,this._numGrabbing=0,this._numDragging=0}_recreateManipulators(e=this.inputGeometry){if(this._clear(),i(e))return;this._reshapeHelper=new zi(ze.fromGeometry(e,this.view.viewingMode),e.type);const t=He(this.graphic);for(const e of this._reshapeHelper.data.components){for(const i of e.vertices)this._createPerVertexManipulator(i,t);for(const i of e.edges)this._createPerVertexManipulator(i,t)}this._createGraphicMoveManipulators(t)}_perGraphicManipulatorDragAction(e,t){if("end"===t.action)return;const i=[],a=this._manipulatorInfos.some((e=>"vertex"===e.handle.type&&e.manipulator.selected)),s=1===e&&a,o=r(this._reshapeHelper);for(const e of this._manipulatorInfos)"vertex"===e.handle.type&&(e.manipulator.grabbing||s&&!e.manipulator.selected||(r(o).moveVertices([e.handle],t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ),i.push(e.handle.pos),this._updateManipulatorPosition(e)));if(0===i.length)return;let n=0;for(const e of this._manipulatorInfos)"vertex"===e.handle.type&&n++;this.outputGeometry=o.geometry;if(i.length===n){if(this._updateEventState(1),this.destroyed)return;if(this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic}),this.destroyed)return}else{if(this._updateEventState(2),this.destroyed)return;if(this.emit("reshape",{type:"reshape",mover:this.graphic}),this.destroyed)return}}isMultiVertexSelection(){let e=0;for(const t of this._manipulatorInfos)Ci(t)&&t.manipulator.selected&&e++;return e>1}_perVertexManipulatorDragAction(e){if(this._updateEventState(2),this.destroyed)return;const t=e.mapDeltaX,i=e.mapDeltaY,a=e.mapDeltaZ;if(!t&&!i&&!a)return;const s=[];for(const t of this._manipulatorInfos)Ci(t)&&(t.manipulator.selected&&!t.manipulator.grabbing||t===e.info)&&s.push(t);const o=r(this._reshapeHelper);for(const e of s)o.moveVertices([e.handle],t,i,a);this.outputGeometry=o.geometry;for(const e of s)this._updateManipulatorPosition(e);this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}_createGraphicMoveManipulators(e){this._graphicMoveManipulation=new Ei({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic?this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((e,t,i)=>{t.next((e=>this._trackNumDragging(e))).next((e=>{this._perGraphicManipulatorDragAction(0,e)})),i.next(this._cancelDragOperation())}))):this._graphicMoveManipulation.forEachManipulator((e=>{e.grabbable=!1,e.cursor=null})),this._graphicMoveManipulation.forEachManipulator((e=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(e=>{this._manipulatorInfos.some((e=>e.manipulator.selected))?this._clearSelection():this.emit("immediate-click"),e.stopPropagation()}))]))),this._moveManipulation=new xi({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Dt(this.graphic),snapToScene:!1,radius:xi.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((e=>{this._handles.add([this._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(t=>{this._moveManipulation.zManipulation.hasManipulator(e)||this._manipulatorInfos.some((e=>e.manipulator.selected))||this.emit("immediate-click"),t.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const t=r(this.graphic.geometry).spatialReference;let i=null;this._handles.add([this._moveManipulation.createDragPipeline(((t,a,o,n)=>{a.next((e=>this._trackNumDragging(e))).next((t=>{if("start"===t.action){const a=this._manipulatorInfos.filter((e=>Ci(e)&&e.manipulator.selected));if(1===t.manipulatorType&&1===a.length){const t=a[0].handle;i=new Le(r(this._reshapeHelper),this.view,e,n,t)}}return s(i)&&(t.mapEnd=this.snappingEngine.snap(t.mapEnd,i)),"end"===t.action&&(this.snappingEngine.doneSnapping(),i=null),t})).next(Ke()).next((e=>{this._perGraphicManipulatorDragAction(1,e)})),o.next(this._cancelDragOperation())}),e,t),W(this._graphicState,"displaying",(()=>{this._updateMoveManipulationPosition()})),this._graphicState.on("changed",(()=>this._updateMoveManipulationPosition())),W(this._graphicState,"isDraped",(()=>{const e="align-move-manipulation";this._graphicState.isDraped?this._handles.add(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this._handles.remove(e)}))]),this._updateMoveManipulationPosition();const a=oi({view:this.view,graphic:this.graphic,forEachManipulator:e=>{if(!this.destroyed){s(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(e);for(const t of this._manipulatorInfos)e(t.manipulator,1);this._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:e=>this.on("manipulators-changed",e)});this._outlineVisualElement=a.visualElement instanceof Ot?a.visualElement:null,s(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(()=>this._updateMoveManipulationPosition()))]),this._manipulatorHandles.add(a)}_createPerVertexManipulator(e,t=He(this.graphic)){if(i(this._vertexManipulatorGeometry)||i(this._vertexManipulatorOutlineGeometry)){const e=Nt.reshapeManipulators.vertex,t=e.size/2,i=t+e.collisionPadding,a=t/i;this._vertexManipulatorGeometry=new je(Se.createSphereGeometry(a,16,16),"reshape-manipulator");const s=(t+e.outlineSize)/i;this._vertexManipulatorOutlineGeometry=new je(Se.createSphereGeometry(s,16,16),"reshape-manipulator-outline")}if(i(this._edgeManipulatorGeometry)||i(this._edgeManipulatorOutlineGeometry)){const e=Nt.reshapeManipulators.edge,t=e.size/2,i=t+e.collisionPadding,a=t/i;this._edgeManipulatorGeometry=new je(Se.createSphereGeometry(a,16,16),"reshape-manipulator");const s=(t+e.outlineSize)/i;this._edgeManipulatorOutlineGeometry=new je(Se.createSphereGeometry(s,16,16),"reshape-manipulator-outline")}const a=new _t({view:this.view,renderObjects:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|ki.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|ki.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|ki.Vertex},{geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|ki.Edge},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|ki.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|ki.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|ki.Edge},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}],elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,e,t);const s="edge"===e.type?{manipulator:a,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(s),this.manipulators.add(a),this._updateManipulatorPosition(s),"edge"===s.type){const e=this._getManipulatorInfoFromHandle(s.handle.left).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(s))),t=this._getManipulatorInfoFromHandle(s.handle.right).manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(s)));s.locationUpdateHandle=n([e,t]),this._manipulatorHandles.add(s.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const r=Ye(a,((e,i,a,r)=>{i.next((e=>this._trackNumDragging(e))).next((e=>Ri(s)?{...e,info:this._splitEdgeManipulator(s)}:{...e,info:s})).next(Xe(this.view,e.elevationAlignedLocation)).next(gt(this.view,this.graphic,e.elevationAlignedLocation,e.location.spatialReference)).next(this._snapDrag(t,r)).next(Ke()).next((e=>{this._perVertexManipulatorDragAction(e)})),a.next(this._cancelDragOperation())}));return this._manipulatorHandles.add(r,a),this._manipulatorHandles.add([a.events.on("immediate-click",(e=>this._manipulatorClickCallback(e,s))),a.events.on("select-changed",(()=>{s.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}))]),this.emit("manipulators-changed"),a}_snapDrag(e,t){let i=null;const a=r(this._reshapeHelper);return r=>{if("start"===r.action&&(this.isMultiVertexSelection()||(i={context:new Le(a,this.view,e,t,r.info.handle),originalPos:a.data.coordinateHelper.createDehydratedPoint(r.info.handle.pos)})),s(i)){const e={...i.originalPos};e.x+=r.mapEnd.x-r.mapStart.x,e.y+=r.mapEnd.y-r.mapStart.y;const t=this.snappingEngine.snap(e,i.context);r.mapEnd.x=t.x+(r.mapStart.x-i.originalPos.x),r.mapEnd.y=t.y+(r.mapStart.y-i.originalPos.y)}return"end"===r.action&&(this.snappingEngine.doneSnapping(),i=null),r}}_trackNumDragging(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}_cancelDragOperation(){const e=s(this._reshapeHelper)?this._reshapeHelper.geometry.clone():null;return()=>{switch(this._numDragging--,this.inputGeometry=e,this.outputGeometry=e,this.snappingEngine.doneSnapping(),this._reshapeEventState){case 0:break;case 1:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape",mover:this.graphic})}this.destroyed||this._updateEventState(0)}}_setTypeSpecificManipulatorSettings(e,t,i){switch(t.type){case"vertex":e.state=ki.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=Nt.reshapeManipulators.vertex.size/2+Nt.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i;break;case"edge":e.state=ki.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=Nt.reshapeManipulators.edge.size/2+Nt.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"===i.mode?i:{mode:"absolute-height",offset:0}}}_watchAndUpdateGrabState(e,t){return e.events.on("grab-changed",(i=>{if("start"===i.action)t&&this._updateSelection(e),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(0),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing}))}_clearSelection(){for(const e of this._manipulatorInfos)e.manipulator.grabbing||(e.manipulator.selected=!1)}_updateSelection(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(e){if(e)for(const t of this._manipulatorInfos)if(e===t.handle)return t;return null}_updateManipulatorPosition(e){if(!e)return;const t=r(this._reshapeHelper);if("vertex"===e.handle.type)e.manipulator.location=t.data.coordinateHelper.toPoint(e.handle.pos,Ti),e.manipulator.grabbing&&s(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){const i=this._getManipulatorInfoFromHandle(e.handle.left).manipulator,a=this._getManipulatorInfoFromHandle(e.handle.right).manipulator;if(s(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){const s=i.location,r=a.location,o=.5,n=s.x+o*(r.x-s.x),l=s.y+o*(r.y-s.y),p=s.hasZ&&r.hasZ?0:void 0;e.manipulator.location=ve(n,l,p,t.geometry.spatialReference)}else{const s=i.elevationAlignedLocation,r=a.elevationAlignedLocation,o=.5,n=s.x+o*(r.x-s.x),l=s.y+o*(r.y-s.y),p=s.hasZ&&r.hasZ?s.z+o*(r.z-s.z):void 0;e.manipulator.elevationAlignedLocation=ve(n,l,p,t.geometry.spatialReference)}}}_splitEdgeManipulator(e){const t=r(this._reshapeHelper),i=r(t.splitEdge(e.handle,.5).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;const a=e;a.handle=i,a.type="vertex";const s=He(this.graphic);this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,s),i.left&&this._createPerVertexManipulator(i.left),i.right&&this._createPerVertexManipulator(i.right),this.outputGeometry=t.geometry,this._updateManipulatorPosition(a),this._updateSelection(e.manipulator);const o=this._updateEventState(2),n=t.data.coordinateHelper.toArray(a.handle.pos),l=t.data.components.indexOf(i.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:n,componentIndex:l,vertexIndex:r(i.index)}],added:n}),o&&this._updateEventState(0),a}_updateMoveManipulationPosition(){const e=_e.get();x(e,0,0,0);let t=0,a=!1,o=null,n=null;for(const s of this._manipulatorInfos)Ci(s)&&(s.manipulator.selected?(t++,j(e,e,s.manipulator.renderLocation),i(o)||s.selectedIndex>o.selectedIndex?(n=o,o=s):(i(n)||s.selectedIndex>n.selectedIndex)&&(n=s)):a=!0);if(0!==t){const e=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.zManipulation.available=e&&this.enableZ&&Dt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e&&1!==t}else{const e=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=e,this._moveManipulation.xyAxisManipulation.available=e,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=e,this._moveManipulation.zManipulation.available=e&&this.enableZ&&Dt(this.graphic)}if(0!==t){let e=0;if(s(o)){const t=o.handle.pos,i=s(n)?n.handle.pos:o.handle.left&&o.handle.left.left?o.handle.left.left.pos:null,a=!s(n)&&o.handle.right&&o.handle.right.right?o.handle.right.right.pos:null;i&&a?this._moveManipulation.xyAxisManipulation.available=!1:i?e=Vi(i,t):a&&(e=Vi(t,a))}this._moveManipulation.angle=e,this._moveManipulation.radius=li}else this._moveManipulation.angleDeferred=()=>di(r(this.graphic.geometry)),this._moveManipulation.radius=xi.radiusForSymbol(this.graphic.symbol);0!==t&&a?(E(e,e,1/t),Ti.spatialReference=r(this._reshapeHelper).geometry.spatialReference,Ti.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(e,Ti),this._moveManipulation.elevationAlignedLocation=Ti):s(this._outlineVisualElement)&&!this._graphicState.isDraped&&s(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:St(this.view,this._moveManipulation,this.graphic)}_removeVertices(e){const t=[],i=r(this._reshapeHelper);for(const a of e)if("vertex"===a.handle.type&&i.canRemoveVertex()){t.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.right));const e=r(i.removeVertices([a.handle]).removedVertices[0].createdEdge);e&&this._createPerVertexManipulator(e)}if(t.length>0){const e=t.map((e=>{const t=i.data.components.indexOf(e.component);return{coordinates:i.data.coordinateHelper.toArray(e.pos),componentIndex:t,vertexIndex:r(e.index)}}));this.outputGeometry=i.geometry;const a=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:e.map((e=>e.coordinates)),vertices:e}),this.destroyed)return;if(a&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}}_manipulatorClickCallback(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),Ri(t)&&0===e.button&&this._splitEdgeManipulator(t),e.stopPropagation()}};function Vi(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function Ci(e){return"vertex"===e.handle.type}function Ri(e){return"edge"===e.handle.type}e([c({constructOnly:!0})],Ii.prototype,"tool",void 0),e([c()],Ii.prototype,"inputGeometry",null),e([c()],Ii.prototype,"outputGeometry",void 0),Ii=e([d("esri.views.3d.interactive.editingTools.graphicReshape3D.ReshapeOperation")],Ii);const Ti=ve(0,0,null,null);var ki;!function(e){e.Vertex=16,e.Edge=32}(ki||(ki={}));class zi extends Ue{constructor(e,t){super(e,t),this.type=t,this._geometry=null}get geometry(){if(this._dirty){switch(this.type){case"polyline":this._geometry=this.data.toPolyline();break;case"polygon":this._geometry=this.data.toPolygon()}this._dirty=!1}return this._geometry}}let Li=class extends(m.EventedMixin(We)){constructor(e){super(e),this._handles=new U,this._reshapeOperation=null,this._internalGeometryUpdate=!1,this.enableZ=!0,this.enableMoveGraphic=!0,this.type="reshape-3d",this.snappingOptions=new Ie}destroy(){this._handles.removeAll(),this._reshapeOperation&&(this._reshapeOperation.destroy(),this._reshapeOperation=null),this._set("view",null),this._set("graphic",null)}get selectionManagementDisabled(){return!0}_updateGeometry(){const e=this.graphic.geometry;0!==Et(this.graphic)||!s(e)||"polygon"!==e.type&&"polyline"!==e.type?this._reshapeOperation.inputGeometry=null:this._reshapeOperation.inputGeometry=e.clone()}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),0!==Et(this.graphic))return;const e=this.watch("graphic.geometry",(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),!0);this._handles.add(e,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_onReshapeGeometryChanged(){i(this.graphic)||(this._internalGeometryUpdate=!0,this.graphic.geometry=this._reshapeOperation.outputGeometry.clone(),this._internalGeometryUpdate=!1)}initialize(){this._reshapeOperation=new Ii({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",(e=>{"reshape"===e.type&&this._onReshapeGeometryChanged(),this.emit("reshape",e)})),this._reshapeOperation.on("move",(e=>{"move"===e.type&&this._onReshapeGeometryChanged(),this.emit("move",e)})),this._reshapeOperation.on("vertex-add",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)})),this._reshapeOperation.on("vertex-remove",(e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)})),this._reshapeOperation.on("immediate-click",(()=>this.emit("immediate-click"))),W(this,"graphic",(()=>{this._updateGraphic()}),!0)])}beforeUndo(){this._reshapeOperation.snappingEngine.doneSnapping()}onInputEvent(e){"key-down"!==e.type||"Delete"!==e.key&&"Backspace"!==e.key||this._reshapeOperation.removeSelectedVertices()}reset(){}};var Ui;e([c({constructOnly:!0,nonNullable:!0})],Li.prototype,"view",void 0),e([c({constructOnly:!0})],Li.prototype,"graphic",void 0),e([c({constructOnly:!0,nonNullable:!0})],Li.prototype,"enableZ",void 0),e([c({constructOnly:!0,nonNullable:!0})],Li.prototype,"enableMoveGraphic",void 0),e([c({readOnly:!0})],Li.prototype,"type",void 0),e([c()],Li.prototype,"snappingOptions",void 0),Li=e([d("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],Li),function(e){e.ScaleIn=32,e.ScaleOut=64,e.RotateLeft=128,e.RotateRight=256,e.Unlocked=1024,e.DelayedFocused=2048,e.TouchInput=32768}(Ui||(Ui={}));class Fi{constructor(e){this.mode=null,this._handles=new U,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new m,this.getFocused=()=>this.ringManipulator.focused,this.getScale=()=>s(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this._scaleRotateDragData.scale:1,this.tool=e.tool,this.mode=e.mode,this.createManipulator(),this.updateDragState(),this.updateManipulatorTransform()}destroy(){s(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles.removeAll(),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}startAnimation(e){this.cancelActiveAnimation(),e.start();const t=u({update:({deltaTime:t})=>{e.update(t)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:t}}cancelActiveAnimation(){s(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)}forEachManipulator(e){e(this.ringManipulator,2)}createManipulator(){this.ringManipulator=this.createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);const e=this.ringManipulator,t=this.tool.graphicState.graphic,a=Ye(e,((e,a,r)=>{this._scaleRotateDragData=null;const o=function(e,t){const a=e.allLayerViews.find((e=>e.layer===t.layer));if(i(t.symbol))return null;const s=t.symbol;return{symbolLayers:s.symbolLayers.map((e=>{let t=null,i=null;return"object"===e.type&&(t=e.heading),i=a.getSymbolLayerSize(s,e),{heading:t,size:i}})).toArray()}}(this.tool.view,t);if(i(o))return this.updateDragState(),null;const n={mode:"none",origin:M(e.renderLocation),angle:0,startAngle:this.tool.symbolRotationAngle,angleDir:0,scale:1,scaleDir:0,startSymbolData:o};this._scaleRotateDragData=n,this.updateDragState();const l=_e.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,l),a.next(yt(this.tool.view,we.fromPositionAndNormal(e.renderLocation,l))).next((e=>{const i=we.normal(e.plane),a=xt(e.renderStart,e.renderEnd,n.origin,i),r=R.shortestSignedDiff(n.angle,a);n.angleDir=v(n.angleDir+r,-.3,.3),n.angle=a;const o=function(e,t){const i=O(_e.get(),t.renderStart,e.origin),a=O(_e.get(),t.renderEnd,e.origin),s=I(i),r=I(a);if(0===s)return 0;return r/s}(n,e),l=o-n.scale;if(n.scaleDir=v(n.scaleDir+l,-.2,.2),n.scale=o,this.onScaleChanged(),"none"===n.mode){const i=this.mode||function(e,t,i,a){const{renderStart:s,renderEnd:r}=e,o=Hi(s,a,_e.get()),n=Hi(r,a,_e.get());if(V(o,n)<100)return null;const l=O(_e.get(),s,i),p=P(_e.get(),l,t),h=s,c=j(_e.get(),h,p),u=Hi(i,a,_e.get()),d=o,m=Hi(c,a,_e.get()),g=O(_e.get(),m,d),y=O(_e.get(),o,u),v=be.wrap(d,g),f=be.wrap(u,y);if(be.distance2(v,n)<be.distance2(f,n))return"rotate";return"scale"}(e,e.plane,n.origin,this.tool.view.state.camera);if(s(i)){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:t,angle:n.angle});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:t,scale:n.scale})}n.mode=i}}if(this.updateDragState(),s(t.symbol)){const e=t.symbol.clone();let i=0,a=1;switch(n.mode){default:case"none":break;case"scale":a=n.scale;break;case"rotate":i=n.angle}this.applySymbolData(e,n.startSymbolData,i,a),t.symbol=e,this.updateManipulatorTransform()}switch(e.action){case"start":case"update":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:t,angle:n.angle});break;case"scale":this.tool.emit("graphic-scale",{graphic:t,scale:n.scale})}break;case"end":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:n.angle});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,scale:n.scale});break;default:case"none":}}"end"===e.action&&(this.startAnimation(Zi(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null,this.updateDragState())})),r.next(tt(t)).next((()=>{if(s(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:t,angle:this._scaleRotateDragData.startAngle});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:t,scale:1})}this.startAnimation(Zi(this,(()=>this.onScaleChanged()))),this._scaleRotateDragData=null}}))}));this._handles.add(a),this._handles.add([this.ringManipulator.events.on("focus-changed",(e=>{"focus"===e.action?this.startAnimation(function(e,t){let i=0,a=null;const s=()=>!1;return{start:()=>{a=e.getFocused,e.getFocused=s,i=0,t()},update:e=>(i+=e,!a()||i>200?1:0),destroy:()=>{e.getFocused=a,t()}}}(this,(()=>this.updateDelayedFocusedState()))):this.updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(e=>{e.stopPropagation()})),W(this.tool.graphicState,"displaying",(e=>this.ringManipulator.available=e)),this.tool.graphicState.on("changed",(()=>St(this.tool.view,this.ringManipulator,t)))]),St(this.tool.view,this.ringManipulator,t)}onScaleChanged(){this.events.emit("scale-changed"),this.updateManipulatorTransform()}updateDelayedFocusedState(){this.ringManipulator.updateStateEnabled(Ui.DelayedFocused,this.getFocused())}updateDragState(){if(this.ringManipulator.updateStateEnabled(Ui.Unlocked,!(s(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),s(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(Ui.ScaleIn|Ui.ScaleOut,!1),this.ringManipulator.updateStateEnabled(Ui.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(Ui.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(Ui.RotateLeft|Ui.RotateRight,!1),this.ringManipulator.updateStateEnabled(Ui.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(Ui.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(Ui.ScaleIn|Ui.ScaleOut|Ui.RotateLeft|Ui.RotateRight,!1)}updateManipulatorTransform(){const e=B(Me.get()),t=this.tool.symbolRotationAngle;q(e,e,t,_(0,0,1));const i=this.getScale(),a=Q(Me.get(),x(_e.get(),i,i,i)),s=B(Me.get());X(s,a,e),this.ringManipulator.modelTransform=s}createRingManipulator(){const e=(e,t,i)=>{const a=[],s=Math.ceil(128*(t-e)/(2*Math.PI));for(let r=0;r<s+1;r++){const o=e+r*(t-e)/s;a.push(_(i*Math.cos(o),i*Math.sin(o),0))}return a},t=t=>e(0,2*Math.PI,t),i=(e,t)=>new je(Se.createPathExtrusionGeometry((e=>[[-e/2,0],[e/2,0],[e/2,.25],[-e/2,.25]])(t),e,[],[],!1),"graphic-transform-ring"),a=t(160),s=i(a,24),r={left:[],right:[]},o=[];for(let t=0;t<2;t++){const a=t*Math.PI-Math.PI/4,s=Math.PI/2-pi,n=a+s,l=a+Math.PI/2-s,p=e(n,l,190),h=i(p,9);o.push(p),o.push(e(n,l,201)),r.left.push(h),r.right.push(h);for(let e=0;e<2;e++){const t=0===e,i=pe();if(t){$(i,i,[1,-1,1]),q(i,i,-n,[0,0,1]);const e=Math.round(.2*(p.length-1));i[12]=p[e][0],i[13]=p[e][1],i[14]=p[e][2]}else{q(i,i,l,[0,0,1]);const e=Math.round(.8*(p.length-1));i[12]=p[e][0],i[13]=p[e][1],i[14]=p[e][2]}const a=Se.createExtrudedTriangle(60,0,23,.5);Se.transformInPlace(a,i);const s=new je(a,"graphic-transform-ring-rotate");(t?r.left:r.right).push(s)}}const n=[];for(let t=0;t<2;t++){const a=t*Math.PI-Math.PI/4,s=Math.PI/2-hi,r=a+s,o=a+Math.PI/2-s,l=e(r,o,213);n.push(i(l,9))}const l=t(190),p=t(213),h=i(l,9),c=i(p,9),u=t(130),d=t(107),m=i(u,9),g=i(d,9),y=this.createMaterial(),v=this.createMaterial(.66),f=this.createMaterial(.5),M=this.createMaterial(.33);let w=[{geometry:s,material:y,stateMask:Ui.DelayedFocused},{geometry:s,material:f,stateMask:0}];this.mode&&"scale"!==this.mode||(w=w.concat([{geometry:n,material:y,stateMask:Ui.DelayedFocused|Ui.Unlocked},{geometry:h,material:v,stateMask:Ui.DelayedFocused|Ui.ScaleIn},{geometry:c,material:M,stateMask:Ui.DelayedFocused|Ui.ScaleIn},{geometry:m,material:v,stateMask:Ui.DelayedFocused|Ui.ScaleOut},{geometry:g,material:M,stateMask:Ui.DelayedFocused|Ui.ScaleOut}])),this.mode&&"rotate"!==this.mode||(w=w.concat([{geometry:r.right,material:y,stateMask:Ui.DelayedFocused|Ui.Unlocked},{geometry:r.left,material:y,stateMask:Ui.DelayedFocused|Ui.RotateLeft},{geometry:r.right,material:y,stateMask:Ui.DelayedFocused|Ui.RotateRight}]));const b=[a,...o];return new _t({view:this.tool.view,renderObjects:w,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:He(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:b,direction:_(0,0,1)}})}createMaterial(e=1){const t=[...ni,e];return new xe({color:t,transparent:1!==e,cullFace:2,renderOccluded:2},"graphic-transform")}applySymbolData(e,t,i,a){e.symbolLayers.forEach(((e,r)=>{const{heading:o,size:n}=t.symbolLayers[r];"object"===e.type&&(e.heading=(s(o)?o:0)-w(i),s(n)&&"width"in n&&(n.width=this.enforceNonZeroSize(n.width),n.height=this.enforceNonZeroSize(n.height),n.depth=this.enforceNonZeroSize(n.depth),e.width=n.width*a,e.depth=n.depth*a,e.height=n.height*a))}))}enforceNonZeroSize(e){return e||this.tool.view.state.camera.computeRenderPixelSizeAt(this.ringManipulator.renderLocation)}get test(){return{ringManipulator:this.ringManipulator}}}function Hi(e,t,i){const a=t.projectToRenderScreen(e,k(Wi)),s=t.renderToScreen(a,Ni);return x(i,s[0],s[1],0)}function Zi(e,t){let i=null,a=1;const s=()=>a;return{start:()=>{a=e.getScale(),i=e.getScale,e.getScale=s,t()},update:e=>(a+=((a+1)/2-a)*Math.min(3*e,1),t(),Math.abs(a-1)<.01?1:0),destroy:()=>{e.getScale=i,t()}}}const Wi=f(),Ni=z();let Bi=class extends(m.EventedMixin(We)){constructor(e){super(e),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.type="transform-3d",this.handles=new U,this.scaleRotate=null}initialize(){if(this.graphicState=new Gt({graphic:this.graphic}),this.moveManipulation=new xi({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Dt(this.graphic),radius:xi.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((e=>this.handles.add(e.events.on("immediate-click",(e=>e.stopPropagation()))))),this.moveManipulation.elevationInfo=He(this.graphic),this.moveManipulation.createGraphicDragPipeline(this.graphicState,(e=>{const{action:t,graphic:i,dxScreen:a,dyScreen:s}=e,r={graphic:i,dxScreen:a,dyScreen:s};switch(t){case"start":this.emit("graphic-translate-start",r);break;case"update":this.emit("graphic-translate",r);break;case"end":this.emit("graphic-translate-stop",r)}})),this.moveManipulation.angle=this.symbolRotationAngle,this.enableScaling||this.enableRotation){const e=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new Fi({tool:this,mode:e}),this.handles.add(this.scaleRotate.events.on("scale-changed",(()=>this.onScaleChanged())))}this.handles.add([oi({view:this.view,graphic:this.graphic,forEachManipulator:e=>this.forEachManipulator(e),onManipulatorsChanged:()=>h()}),this.graphic.watch("symbol",(()=>this.updateMoveAngle())),this.graphicState.on("changed",(()=>this.onGeometryChanged())),this.hideManipulatorsForGraphicState(),this.view.watch("scale",(()=>this.updateMoveAngle()))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this.onGeometryChanged()}forEachManipulator(e){this.moveManipulation.forEachManipulator(e),s(this.scaleRotate)&&this.scaleRotate.forEachManipulator(e)}hideManipulatorsForGraphicState(){return this.graphicState.watch("displaying",(e=>{this.forEachManipulator((t=>t.available=e)),this.moveManipulation.zManipulation.available=e&&this.enableZ&&Dt(this.graphic)}))}destroy(){this.handles.destroy(),this.moveManipulation.destroy(),s(this.scaleRotate)&&(this.scaleRotate.destroy(),this.scaleRotate=null),this._set("view",null),this._set("graphic",null)}set snapToScene(e){this.moveManipulation&&(this.moveManipulation.snapToScene=e),this._set("snapToScene",e)}get symbolRotationAngle(){const e=this.graphic.symbol;if(e){const t=e.symbolLayers.find((e=>"object"===e.type)),i=t&&t.heading||0;return S(-i)}return 0}reset(){}onDetach(){s(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onHide(){s(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}onScaleChanged(){if(i(this.scaleRotate))return;const e=this.scaleRotate.getScale();this.moveManipulation.displayScale=e}updateMoveAngle(){"local"===this.view.viewingMode||this.view.scale<1e6?this.moveManipulation.angle=this.symbolRotationAngle:this.moveManipulation.angle=0}onGeometryChanged(){St(this.view,this.moveManipulation,this.graphic)}get test(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,ringManipulator:s(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}};e([c({constructOnly:!0,nonNullable:!0})],Bi.prototype,"view",void 0),e([c({constructOnly:!0,nonNullable:!0})],Bi.prototype,"graphic",void 0),e([c({constructOnly:!0,nonNullable:!0})],Bi.prototype,"enableZ",void 0),e([c()],Bi.prototype,"enableRotation",void 0),e([c()],Bi.prototype,"enableScaling",void 0),e([c({value:!1})],Bi.prototype,"snapToScene",null),e([c({readOnly:!0})],Bi.prototype,"type",void 0),Bi=e([d("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],Bi);export{qt as DrawGraphicTool,Ai as GraphicMoveTool,Li as GraphicReshapeTool,Bi as GraphicTransformTool};
