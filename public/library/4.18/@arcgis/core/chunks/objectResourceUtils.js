/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{mixin as e}from"../core/lang.js";import{L as t,i as r,u as s,g as o,b as a}from"./Logger.js";import{throwIfAbortError as n,resolve as i,all as u}from"../core/promiseUtils.js";import l from"../core/Error.js";import{r as c}from"./asyncUtils.js";import m from"../request.js";import{b as d,c as f}from"./vec3f64.js";import{i as p,c as x,C as g,l as h,n as b,b as y}from"./vec3.js";import{a as v}from"./devEnvironmentUtils.js";import{V as w}from"./Version.js";import{a as M}from"./mat4.js";import{c as R,a as B}from"./quatf64.js";import{n as A}from"./mat3.js";import{a as E,b as T,e as C,h as j,k as I,l as O,m as S}from"./BufferView.js";import{t as U,a as P,s as F}from"./vec32.js";import{b as L,p as N}from"./aaBoundingBox.js";import{r as k}from"./requestImageUtils.js";import{G as _,a as q}from"./Geometry.js";import{D as z,l as D,b as V,n as $,o as G,t as W,p as K,s as Q,q as H,r as J,k as X,u as Y,v as Z,w as ee}from"./vec42.js";import{T as te}from"./Texture.js";const re=t.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function se(e,t){const o=await async function(e,t){const o=r(t)&&t.streamDataRequester;if(o)return async function(e,t,r){const s=await c(t.request(e,"json",r));if(!0===s.ok)return s.value;return n(s.error),void oe(s.error.details.url)}(e,o,t);const a=await c(m(e,s(t)));if(!0===a.ok)return a.value.data;return n(a.error),void oe(a.error)}(e,t);return{resource:o,textures:await async function(e,t){const s=[];for(const o in e){const a=e[o],n=a.images[0].data;if(!n){re.warn("Externally referenced texture data is not yet supported");continue}const u=a.encoding+";base64,"+n,l="/textureDefinitions/"+o,c={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0},m=r(t)&&t.disableTextures?i(null):k(u,t);s.push(m.then((e=>({refId:l,image:e,params:c,alphaChannelUsage:"rgba"===a.channels?a.alphaChannelUsage||"transparency":"none"}))))}const o=await u(s),a={};for(const e of o)a[e.refId]=e;return a}(o.textureDefinitions,t)}}function oe(e){throw new l("",`Request for object resource failed: ${e}`)}function ae(e){const t=e.params,r=t.topology;let s=!0;switch(t.vertexAttributes||(re.warn("Geometry must specify vertex attributes"),s=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const e=t.faces;if(e){if(t.vertexAttributes)for(const r in t.vertexAttributes){const t=e[r];t&&t.values?(null!=t.valueType&&"UInt32"!==t.valueType&&(re.warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),s=!1),null!=t.valuesPerElement&&1!==t.valuesPerElement&&(re.warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),s=!1)):(re.warn(`Indexed geometry does not specify face indices for '${r}' attribute`),s=!1)}}else re.warn("Indexed geometries must specify faces"),s=!1;break}default:re.warn(`Unsupported topology '${r}'`),s=!1}e.params.material||(re.warn("Geometry requires material"),s=!1);const o=e.params.vertexAttributes;for(const e in o){o[e].values||(re.warn("Geometries with externally defined attributes are not yet supported"),s=!1)}return s}function ne(e){const t=L();return e.forEach((e=>{const r=e.boundingInfo;N(t,r.getBBMin()),N(t,r.getBBMax())})),t}function ie(e){switch(e){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;case"transparency":default:return 0}}function ue(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}function le(e){const t=new Uint32Array(e);for(let r=0;r<e;r++)t[r]=r;return t}const ce=new w(1,2,"wosr");async function me(t,s){const n=de(v(t));if("wosr"===n.fileType){const t=await(s.cache?s.cache.loadWOSR(n.url,s):se(n.url,s)),o=function(t,s){const o=[],a=[],n=[],i=[],u=t.resource,l=w.parse(u.version||"1.0","wosr");ce.validate(l);const c=u.model.name,m=u.model.geometries,f=u.materialDefinitions,p=t.textures;let x=0;const g=new Map;for(let t=0;t<m.length;t++){const u=m[t];if(!ae(u))continue;const l=ue(u),h=u.params.vertexAttributes,b={};for(const e in h){const t=h[e],r=t.values;b[e]={data:r,size:t.valuesPerElement}}const y={};if("PerAttributeArray"===u.params.topology){const e=le(b.position.data.length/b.position.size);for(const t in b)y[t]=e}else{const e=u.params.faces;for(const t in e)y[t]=new Uint32Array(e[t].values)}const v=p&&p[l.texture];if(v&&!g.has(l.texture)){const{image:e,params:t}=v,r=new te(e,c,t);i.push(r),g.set(l.texture,r)}const w=g.get(l.texture),M=w?w.id:void 0;let R=n[l.material]?n[l.material][l.texture]:null;if(!R){const t=f[l.material.substring(l.material.lastIndexOf("/")+1)].params;1===t.transparency&&(t.transparency=0);const o=v&&v.alphaChannelUsage,a=t.transparency>0||"transparency"===o||"maskAndTransparency"===o,i={ambient:d(t.diffuse),diffuse:d(t.diffuse),opacity:1-(t.transparency||0),transparent:a,textureAlphaMode:v?ie(v.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:M,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:t.externalColorMixMode||"tint",textureAlphaPremultiplied:!0};r(s)&&s.materialParamsMixin&&e(i,s.materialParamsMixin),R=new z(i,c),n[l.material]||(n[l.material]={}),n[l.material][l.texture]=R}a.push(R);const B=new _(new q(b,y),c);x+=y.position?y.position.length:0,o.push(B)}return{name:c,stageResources:{textures:i,materials:a,geometries:o},pivotOffset:u.model.pivotOffset,boundingBox:ne(o),numberOfVertices:x,lodThreshold:null}}(t,s);return{lods:[o],referenceBoundingBox:o.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:t.remove}}const i=await(s.cache?s.cache.loadGLTF(n.url,s):D(new V(s.streamDataRequester),n.url,s)),u=o(i.model.meta,"ESRI_proxyEllipsoid");i.meta.isEsriSymbolResource&&r(u)&&-1!==i.meta.uri.indexOf("/RealisticTrees/")&&function(e,t){for(let r=0;r<e.model.lods.length;++r){const s=e.model.lods[r];e.customMeta.esriTreeRendering=!0;for(const o of s.parts){const s=o.attributes.normal;if(a(s))return;const n=o.attributes.position,i=n.count,u=f(),l=f(),c=f(),m=G(j,i),d=G(E,i),v=M(R(),o.transform);for(let a=0;a<i;a++){n.getVec(a,l),s.getVec(a,u),p(l,l,o.transform),x(c,l,t.center),g(c,c,t.radius);const i=c[2],f=h(c),w=Math.min(.45+.55*f*f,1);g(c,c,t.radius),p(c,c,v),b(c,c),r+1!==e.model.lods.length&&e.model.lods.length>1&&y(c,c,u,i>-1?.2:Math.min(-4*i-3.8,1)),d.setVec(a,c),m.set(a,0,255*w),m.set(a,1,255*w),m.set(a,2,255*w),m.set(a,3,255)}o.attributes.normal=d,o.attributes.color=m}}}(i,u);const l=i.meta.isEsriSymbolResource?{usePBR:s.usePBR,isSchematic:!1,treeRendering:i.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:!0,isSchematic:!1,mrrFactors:[0,1,.5]},c={...s.materialParamsMixin,treeRendering:i.customMeta.esriTreeRendering};if(null!=n.specifiedLodIndex){const e=fe(i,l,c,n.specifiedLodIndex);let t=e[0].boundingBox;if(0!==n.specifiedLodIndex){t=fe(i,l,c,0)[0].boundingBox}return{lods:e,referenceBoundingBox:t,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1,remove:i.remove}}const m=fe(i,l,c);return{lods:m,referenceBoundingBox:m[0].boundingBox,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1,remove:i.remove}}function de(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);if(t)return{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null};return e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function fe(e,t,s,o){const a=e.model,n=B(),i=new Array,u=new Map,l=new Map;return a.lods.forEach(((e,c)=>{if(void 0!==o&&c!==o)return;let m=0;const d={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:r(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:L()};i.push(d),e.parts.forEach((o=>{const i=o.material+(o.attributes.normal?"_normal":"")+(o.attributes.color?"_color":"")+(o.attributes.texCoord0?"_texCoord0":"")+(o.attributes.tangent?"_tangent":""),c=a.materials.get(o.material),f=r(o.attributes.texCoord0),p=r(o.attributes.normal);if(!u.has(i)){if(f){if(r(c.textureColor)&&!l.has(c.textureColor)){const e=a.textures.get(c.textureColor),t={...e.parameters,preMultiplyAlpha:!0};l.set(c.textureColor,new te(e.data,c.textureColor,t))}if(r(c.textureNormal)&&!l.has(c.textureNormal)){const e=a.textures.get(c.textureNormal),t={...e.parameters,preMultiplyAlpha:!0};l.set(c.textureNormal,new te(e.data,c.textureNormal,t))}if(r(c.textureOcclusion)&&!l.has(c.textureOcclusion)){const e=a.textures.get(c.textureOcclusion),t={...e.parameters,preMultiplyAlpha:!0};l.set(c.textureOcclusion,new te(e.data,c.textureOcclusion,t))}if(r(c.textureEmissive)&&!l.has(c.textureEmissive)){const e=a.textures.get(c.textureEmissive),t={...e.parameters,preMultiplyAlpha:!0};l.set(c.textureEmissive,new te(e.data,c.textureEmissive,t))}if(r(c.textureMetallicRoughness)&&!l.has(c.textureMetallicRoughness)){const e=a.textures.get(c.textureMetallicRoughness),t={...e.parameters,preMultiplyAlpha:!0};l.set(c.textureMetallicRoughness,new te(e.data,c.textureMetallicRoughness,t))}}const e=Math.pow(c.color[0],1/$),n=Math.pow(c.color[1],1/$),m=Math.pow(c.color[2],1/$),d=Math.pow(c.emissiveFactor[0],1/$),x=Math.pow(c.emissiveFactor[1],1/$),g=Math.pow(c.emissiveFactor[2],1/$);u.set(i,new z({...t,transparent:"BLEND"===c.alphaMode,textureAlphaMode:pe(c.alphaMode),textureAlphaCutoff:c.alphaCutoff,diffuse:[e,n,m],ambient:[e,n,m],opacity:c.opacity,doubleSided:c.doubleSided,doubleSidedType:"winding-order",cullFace:c.doubleSided?0:2,vertexColors:!!o.attributes.color,vertexTangents:!!o.attributes.tangent,normals:p?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:r(c.textureColor)&&f?l.get(c.textureColor).id:void 0,colorMixMode:c.colorMixMode,normalTextureId:r(c.textureNormal)&&f?l.get(c.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:r(c.textureOcclusion)&&f?l.get(c.textureOcclusion).id:void 0,emissiveTextureId:r(c.textureEmissive)&&f?l.get(c.textureEmissive).id:void 0,metallicRoughnessTextureId:r(c.textureMetallicRoughness)&&f?l.get(c.textureMetallicRoughness).id:void 0,emissiveFactor:[d,x,g],mrrFactors:[c.metallicFactor,c.roughnessFactor,t.mrrFactors[2]],isSchematic:!1,...s},i))}const x=function(e,t){switch(t){case 4:return ee(e);case 5:return Z(e);case 6:return Y(e)}}(o.indices||o.attributes.position.count,o.primitiveType),g={},h={},b=o.attributes.position.count,y=G(E,b);if(U(y,o.attributes.position,o.transform),h.position={data:y.typedBuffer,size:y.elementCount},g.position=x,r(o.attributes.normal)){const e=G(E,b);A(n,o.transform),P(e,o.attributes.normal,n),h.normal={data:e.typedBuffer,size:e.elementCount},g.normal=x}if(r(o.attributes.tangent)){const e=G(T,b);A(n,o.transform),W(e,o.attributes.tangent,n),h.tangent={data:e.typedBuffer,size:e.elementCount},g.tangent=x}if(r(o.attributes.texCoord0)){const e=G(C,b);K(e,o.attributes.texCoord0),h.uv0={data:e.typedBuffer,size:e.elementCount},g.uv0=x}if(r(o.attributes.color)){const e=G(j,b);if(4===o.attributes.color.elementCount)o.attributes.color instanceof T?Q(e,o.attributes.color,255):o.attributes.color instanceof j?H(e,o.attributes.color):o.attributes.color instanceof I&&Q(e,o.attributes.color,1/256);else{J(e,255,255,255,255);const t=new O(e.buffer,0,4);o.attributes.color instanceof E?F(t,o.attributes.color,255):o.attributes.color instanceof O?X(t,o.attributes.color):o.attributes.color instanceof S&&F(t,o.attributes.color,1/256)}h.color={data:e.typedBuffer,size:e.elementCount},g.color=x}const v=new _(new q(h,g),`gltf_${e.name}_${m++}`);d.stageResources.geometries.push(v),d.stageResources.materials.push(u.get(i)),f&&(r(c.textureColor)&&d.stageResources.textures.push(l.get(c.textureColor)),r(c.textureNormal)&&d.stageResources.textures.push(l.get(c.textureNormal)),r(c.textureOcclusion)&&d.stageResources.textures.push(l.get(c.textureOcclusion)),r(c.textureEmissive)&&d.stageResources.textures.push(l.get(c.textureEmissive)),r(c.textureMetallicRoughness)&&d.stageResources.textures.push(l.get(c.textureMetallicRoughness))),d.numberOfVertices+=b;const w=v.boundingInfo;N(d.boundingBox,w.getBBMin()),N(d.boundingBox,w.getBBMax())}))})),i}function pe(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":return 1;default:return 0}}var xe=Object.freeze({__proto__:null,fetch:me,parseUrl:de,gltfToEngineResources:fe});export{me as f,se as l,xe as o};
