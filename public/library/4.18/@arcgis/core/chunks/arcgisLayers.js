/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"./object.js";import"../core/lang.js";import"../config.js";import{b as e,i as r}from"./Logger.js";import"./string.js";import"../core/promiseUtils.js";import"./Message.js";import a from"../core/Error.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../kernel.js";import t from"../request.js";import{p as l}from"./arcgisLayerUrl.js";import{l as s}from"./lazyLayerLoader.js";async function n(t){const n=await async function(r){const t=l(r);if(e(t))throw new a("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:r});const{serverType:n,sublayer:o}=t;let c;const y={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(n){case"MapServer":c=null!=o?"FeatureLayer":async function(e){return(await u(e)).tileInfo}(r).then((e=>e?"TileLayer":"MapImageLayer"));break;case"ImageServer":c=u(r).then((e=>{const r=e.tileInfo&&e.tileInfo.format;return e.tileInfo?!r||"LERC"!==r.toUpperCase()||e.cacheType&&"elevation"!==e.cacheType.toLowerCase()?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"}));break;case"SceneServer":c=u(t.url.path).then((e=>{const r={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};if(e&&Array.isArray(e.layers)&&e.layers.length>0){const a=e.layers[0].layerType;if(null!=r[a])return r[a]}return"SceneLayer"}));break;default:c=y[n]}const d={FeatureLayer:!0,SceneLayer:!0},f="FeatureServer"===n,I={parsedUrl:t,Constructor:null,layerOrTableId:f?o:null,sublayerIds:null,tableIds:null},p=await c;if(d[p]&&null==o){const e=await async function(e,r){var a,t;let l,s=!1;if("FeatureServer"===r){const r=await async function(e){var r,a;let t=await u(e);t=t||{},t.layers=(null==(r=t.layers)?void 0:r.filter(i))||[];const l={serviceJSON:t};if(t.currentVersion<10.5)return l;const s=await u(e+"/layers");return l.layersJSON={layers:(null==s||null==(a=s.layers)?void 0:a.filter(i))||[],tables:(null==s?void 0:s.tables)||[]},l}(e);s=!!r.layersJSON,l=r.layersJSON||r.serviceJSON}else l=await u(e);const n=null==(a=l)?void 0:a.layers,o=null==(t=l)?void 0:t.tables;return{layerIds:(null==n?void 0:n.map((e=>e.id)).reverse())||[],tableIds:(null==o?void 0:o.map((e=>e.id)).reverse())||[],layerInfos:s?n:[],tableInfos:s?o:[]}}(r,n);f&&(I.sublayerInfos=e.layerInfos,I.tableInfos=e.tableInfos);if(1!==e.layerIds.length+e.tableIds.length)I.sublayerIds=e.layerIds,I.tableIds=e.tableIds;else if(f){var b,m;I.layerOrTableId=null!=(b=e.layerIds[0])?b:e.tableIds[0],I.sourceJSON=null!=(m=e.layerInfos[0])?m:e.tableInfos[0]}}return I.Constructor=await async function(e){return(0,s[e])()}(p),I}(t.url),c={...t.properties,url:t.url};if(!n.sublayerIds)return null!=n.layerOrTableId&&(c.layerId=n.layerOrTableId,c.sourceJSON=n.sourceJSON),new n.Constructor(c);const y=new(0,(await import("../layers/GroupLayer.js")).default)({title:n.parsedUrl.title});return function(e,a,t){function l(e,l){const s={...t,layerId:e,sublayerTitleMode:"service-name"};return r(l)&&(s.sourceJSON=l),new a.Constructor(s)}a.sublayerIds.forEach((r=>{const t=l(r,o(a.sublayerInfos,r));e.add(t)})),a.tableIds.forEach((r=>{const t=l(r,o(a.tableInfos,r));e.tables.add(t)}))}(y,n,c),y}function o(e,r){return e?e.find((e=>e.id===r)):null}function i(e){return!e.type||"Feature Layer"===e.type}async function u(e){return(await t(e,{responseType:"json",query:{f:"json"}})).data}export{n as fromUrl};
