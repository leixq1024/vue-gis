/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import"./ArrayPool.js";import{h as e}from"./object.js";import"./deprecate.js";import"../core/lang.js";import"../config.js";import{L as s,k as o,u as r,b as i,i as p}from"./Logger.js";import"./string.js";import"./metadata.js";import"../core/accessorSupport/decorators/property.js";import"../core/Accessor.js";import"./PropertyOrigin.js";import"../core/scheduling.js";import{throwIfAborted as m,isAbortError as a}from"../core/promiseUtils.js";import"./Message.js";import"../core/Error.js";import"./compilerUtils.js";import"./ensureType.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import"./Evented.js";import"../core/Collection.js";import"./collectionUtils.js";import"./JSONSupport.js";import"./Promise.js";import"./Loadable.js";import"../core/urlUtils.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"./jsonMap.js";import"./enumeration.js";import"./reader.js";import"./writer.js";import"./resourceExtension.js";import"./persistableUrlUtils.js";import n from"../geometry/SpatialReference.js";import"./locale.js";import"./number.js";import"../intl.js";import"../kernel.js";import"../request.js";import"./assets.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"./Ellipsoid.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import"./mathUtils2.js";import"./colorUtils.js";import"../Color.js";import"./zmUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./domains.js";import"./arcadeOnDemand.js";import"../layers/support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"./date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"./MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"./chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"./Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import"./screenUtils.js";import"./opacityUtils.js";import"./materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./utils.js";import"./Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"./colors.js";import"./Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"./Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"./Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"./urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols/support/jsonUtils.js";import"./uid.js";import"../Graphic.js";import"../core/Handles.js";import"./LegendOptions.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../renderers/visualVariables/SizeVariable.js";import"./sizeVariableUtils.js";import"./unitUtils.js";import"./lengthUtils.js";import"./visualVariableUtils.js";import{d as c,h as j}from"./diffUtils.js";import"./MemCache.js";import"./utils3.js";import"./LRUCache.js";import"./timeUtils.js";import"../TimeExtent.js";import"../core/watchUtils.js";import"./fieldType.js";import"./aaBoundingRect.js";import"../core/HandleOwner.js";import"./_commonjsHelpers.js";import"./vec2.js";import"../layers/support/Field.js";import"./defaultsJSON.js";import"./defaults.js";import"../layers/support/FieldsIndex.js";import"./DataLayerSource.js";import"../tasks/support/Query.js";import"../tasks/support/StatisticDefinition.js";import"./OptimizedGeometry.js";import"./featureConversionUtils.js";import"./TileKey.js";import{j as y,w as u}from"./definitions.js";import"./quantizationUtils.js";import{b as d}from"./BidiText.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2f32.js";import"./number2.js";import"./Rect.js";import"./BidiEngine.js";import"./MD5.js";import"./clusterUtils2.js";import"./TileInfoView.js";import"./isWebGL2Context.js";import"./RenderingContext.js";import"./callExpressionWithFeature.js";import"./visualVariablesUtils.js";import"./enums.js";import"./Utils10.js";import"./GeometryUtils2.js";import"./MaterialKey.js";import"./TurboLine.js";import"./CIMSymbolHelper.js";import"./util2.js";import"./centroid.js";import"./FeatureSetReader.js";import"./quickselect.js";import"./rbush.js";import{i as h}from"./TileStore.js";import"./visualVariablesUtils2.js";import"./TileClipper.js";import"./cimAnalyzer.js";import{c as b,a as g,b as f,W as S}from"./WGLMeshFactory.js";import"./VertexBuffer.js";import"./schemaUtils.js";import{B as _}from"./BaseProcessor.js";class U{constructor(t,e=2){this._bucketSize=t,this._rowsLength=y/t,this._colsLength=y/t,this._elementsPerBucket=e,this._grid=this._initGrid()}checkOverlap(t,e){const s=Math.floor(t/this._bucketSize),o=Math.floor(e/this._bucketSize);return s<0||s>=this._rowsLength||o<0||o>=this._colsLength||this._grid[o*this._colsLength+s]>=this._elementsPerBucket}markUsed(t,e){const s=Math.floor(t/this._bucketSize),o=Math.floor(e/this._bucketSize);this._grid[o*this._colsLength+s]+=1}reset(){this._grid=this._initGrid()}_initGrid(){return new Uint8Array(this._rowsLength*this._colsLength)}}s.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");let D=class extends _{constructor(){super(...arguments),this.type="symbol"}destroy(){}get supportsTileUpdates(){return!0}async update(t,s){const o=s.schema.processors[0];if("symbol"!==o.type)return;const r=c(this._schema,o);j(r,"mesh")&&(e("esri-2d-update-debug")&&console.debug("Applying Update - Processor:",r),t.mesh=!0,t.why.mesh.push("Symbology changed"),this._schema=o,this._factory=this._createFactory(o),this._factory.update(o,this.tileStore.tileScheme.tileInfo))}onTileData(t,e,s){return m(s),this._onTileData(t,e,s)}onTileError(t,e,s){const o=s.signal,r={tileKey:t.id,error:e};return this.remoteClient.invoke("tileRenderer.onTileError",r,{signal:o})}_createFactory(t){const{geometryType:e,objectIdField:s,fields:o}=this.service,r={geometryType:e,fields:o,spatialReference:n.fromJSON(this.spatialReference)},i=new S(((t,e)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",t,e)),!1);return this._store=i,this._matcher=b(t.mesh.matcher,i,r),new g(e,s,i)}async _onTileData(t,e,s){const{type:i,addOrUpdate:p,remove:a,end:l}=e;if(!p){const e={type:i,addOrUpdate:null,remove:a,clear:!1,end:l};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:e},s)}const n=this._processFeatures(t,p,s),c=s.signal;try{const e=await n,s=o(e,(t=>t.message)),p=o(e,(t=>t.transferList))||[],j={type:i,addOrUpdate:s,remove:a,clear:!1,end:l},y={transferList:r(p)||[],signal:c};return m(y),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:j},y)}catch(e){this._handleError(t,e,s)}}async _processFeatures(t,e,s){if(i(e)||!e.hasFeatures)return null;const o={transform:t.transform,hasZ:!1,hasM:!1},r=this._factory,p={viewingMode:"",scale:t.scale},a=await this._matcher;m(s);const l=this._getLabelInfos(t,e);return await r.analyze(e.getCursor(),a,o,p),m(s),this._writeFeatureSet(t,e,o,l,r)}_writeFeatureSet(t,e,s,o,r){const i=r.createMeshData(e.getApproximateSize()),m={viewingMode:"",scale:t.scale},a=e.getCursor();for(;a.next();)try{const e=a.getDisplayId(),l=p(o)?o.get(e):null;r.writeCursor(i,a,s,m,t.level,l)}catch(t){}return this._encodeDisplayData(i)}_encodeDisplayData(t){const e={},s=new Array;return t.encode(e,s),{message:e,transferList:s}}_handleError(t,e,s){if(!a(e)){const o={tileKey:t.id,error:e.message};return this.remoteClient.invoke("tileRenderer.onTileError",o,{signal:s.signal})}}_shouldDiscard(t,e){switch(this.service.geometryType){case"esriGeometryPoint":{const s=e.readLegacyPointGeometry();return!s||t.checkOverlap(s.x,s.y)}case"esriGeometryPolygon":{const s=e.readLegacyCentroid();return!s||t.checkOverlap(s.x,s.y)}default:return!1}}_markUsed(t,e){switch(this.service.geometryType){case"esriGeometryPoint":{const{x:s,y:o}=e.readLegacyPointGeometry();return t.markUsed(s,o)}case"esriGeometryPolygon":{const{x:s,y:o}=e.readLegacyCentroid();return t.markUsed(s,o)}}}_getLabelInfos(t,e){const s=this._schema.mesh.labels,r=o(s,(e=>e.filter((e=>function(t,e){return(!t.minScale||t.minScale>=e)&&(!t.maxScale||t.maxScale<=e)}(e,t.scale)))));if(i(r)||0===r.length)return null;const p=new Map,m=new U(u),a=e.getCursor();for(;a.next();){const t=a.getDisplayId();if(this._shouldDiscard(m,a)){p.has(t)||p.set(t,null);continue}let e=!1;const s=[],o=h(t),i=o&&1!==a.readAttribute("cluster_count")?"aggregate":"feature";for(const p of r){if(p.target!==i)continue;const r=a.getStorage(),m=o&&"feature"===i?r.getComputedStringAtIndex(a.readAttribute("referenceId"),p.fieldIndex):r.getComputedStringAtIndex(t,p.fieldIndex);if(!m)continue;const l=d(m.toString()),n=l[0],c=l[1];this._store.getMosaicItem(p.symbol,f(n)).then((t=>{s[p.index]={glyphs:t.glyphMosaicItems,rtl:c,index:p.index}})),e=!0}p.set(t,s),e&&this._markUsed(m,a)}return p}};D=t([l("esri.views.2d.layers.features.processors.SymbolProcessor")],D);var L=D;export default L;
