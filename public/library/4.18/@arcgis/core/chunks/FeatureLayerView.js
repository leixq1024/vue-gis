/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"./object.js";import{L as t,i as r}from"./Logger.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import{eachAlways as s,resolve as o}from"../core/promiseUtils.js";import a from"../core/Error.js";import"./ensureType.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"./resourceExtension.js";import{l as n}from"./arcadeOnDemand.js";import{fixFields as u,unpackFieldNames as p,collectLabelingFields as d,collectElevationFields as m,collectFilterFields as c,collectFeatureReductionFields as f,collectFields as y,collectField as h,featureHasFields as F}from"../layers/support/fieldUtils.js";import{init as w}from"../core/watchUtils.js";import{c as g}from"./commonProperties2.js";import x from"../tasks/support/Query.js";import E from"../views/layers/support/FeatureFilter.js";import v from"../views/layers/support/FeatureEffect.js";import{g as j,a as b}from"./popupUtils.js";const q=t.getLogger("esri.views.layers.FeatureLayerView"),R=t=>{let R=class extends t{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.effect=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){w(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","timeExtent"],(()=>this._handleRequiredFieldsChange()),!0)}get availableFields(){const{layer:e,layer:{fields:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?u(t,[...p(t,e.outFields),...r]):u(t,r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){q.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=r(this.filter)?this.filter.createQuery(e):new x(e);return r(this.timeExtent)&&(t.timeExtent=r(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}_loadArcadeModules(e){if(e.get("expressionInfos.length"))return n()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then((()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)}))}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fields:i,objectIdField:o,renderer:a,displayField:l}}=this,n=t.featureReduction,u=new Set,p=await s([a?a.collectRequiredFields(u,i):null,d(u,t),e?m(u,t):null,r(this.filter)?c(u,t,this.filter):null,this.effect?c(u,t,this.effect.filter):null,n?f(u,t,n):null]);t.timeInfo&&this.timeExtent&&y(u,t.fields,[t.timeInfo.startField,t.timeInfo.endField]);for(const e of p)e.error&&q.error(e.error);h(u,i,o),e&&l&&h(u,i,l);const F=Array.from(u).sort();this._set("requiredFields",F)}validateFetchPopupFeatures(e){const{layer:t,layer:{popupEnabled:r}}=this;if(!r)return new a("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:t});return j(this.layer,e)?void 0:new a("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:t})}async fetchClientPopupFeatures(e){const t=r(e)?e.clientGraphics:null;if(!t||0===t.length)return o([]);const i=[],s=[],{layer:a}=this,l=j(a,e);if(!r(l))return o([]);const n=await this._loadArcadeModules(l),u=n&&n.arcadeUtils.hasGeometryOperations(l),d=await this.createPopupQuery(e),m=p(a.fields,d.outFields);for(const e of t)u||!F(m,e)?s.push(e):i.push(e);return"stream"===a.type||0===s.length?o(i):(d.objectIds=s.map((e=>e.attributes[a.objectIdField])),a.queryFeatures(d).then((e=>i.concat(e.features))).catch((()=>s)))}async createPopupQuery(e){const t=this.layer,i=t.createQuery(),s=j(t,e),o=r(s)&&await this._loadArcadeModules(s),a=r(s)&&o&&o.arcadeUtils.hasGeometryOperations(s),l=!("point"!==t.geometryType&&!a);return i.returnGeometry=l,i.returnZ=l,i.returnM=l,i.outFields=await b(this.layer,s),i.outSpatialReference=this.view.spatialReference,i}canResume(){return!!super.canResume()&&(!r(this.timeExtent)||!this.timeExtent.isEmpty)}};return e([i()],R.prototype,"_updatingRequiredFieldsPromise",void 0),e([i({readOnly:!0,dependsOn:["layer.outFields?","requiredFields"]})],R.prototype,"availableFields",null),e([i({type:v})],R.prototype,"effect",void 0),e([i({type:E})],R.prototype,"filter",void 0),e([i(g)],R.prototype,"timeExtent",void 0),e([i()],R.prototype,"layer",void 0),e([i({type:Number})],R.prototype,"maximumNumberOfFeatures",null),e([i({readOnly:!0,type:Boolean})],R.prototype,"maximumNumberOfFeaturesExceeded",null),e([i({readOnly:!0})],R.prototype,"requiredFields",void 0),e([i({dependsOn:["timeExtent"]})],R.prototype,"suspended",void 0),e([i()],R.prototype,"view",void 0),R=e([l("esri.views.layers.FeatureLayerView")],R),R};export{R as F};
