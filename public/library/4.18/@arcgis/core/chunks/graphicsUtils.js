/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"./object.js";import{u as t}from"./Logger.js";import e,{g as n}from"../geometry/SpatialReference.js";import{a as s}from"../geometry/Extent.js";import{d as i}from"./extentUtils.js";import{isPoint as a,isMultipoint as r,isExtent as o,isPolygon as m,isPolyline as c}from"../geometry/support/jsonUtils.js";import{a as l}from"./screenUtils.js";import{normalizeMapX as f}from"../geometry/support/normalizeUtils.js";import{c as x}from"./aaBoundingRect.js";import{s as u,a as h,b as p,i as y,t as g}from"./vec2.js";import{b as d,s as M,g as b,a as S}from"./BidiText.js";import{i as I,t as j,r as w,s as v}from"./mat2d.js";import{c as L}from"./mat2df32.js";import{c as P}from"./vec2f32.js";import{C as R}from"./CIMSymbolHelper.js";const W=Math.PI/180,A=L(),X=P(),k=x();function z(t,e,s,r,o,m,c){if(!r||!s.symbol)return t[0]=t[1]=t[2]=t[3]=0,e[0]=e[1]=e[2]=e[3]=0,t;const l=r;if(!a(l)){i(t,l);let n=e[0];0===n&&(n=Q(s),e[0]=n);const a=o*n/2;return t[0]-=a,t[1]-=a,t[2]+=a,t[3]+=a,t}{const i=l.x,a=l.y;"esriTS"===s.symbol.type&&0===e[2]&&0===e[3]&&V(e,s.symbol,s.mosaicItem),function(t,e,s,i,a,r,o,m){let c;switch(i.type){case"esriSMS":case"esriPMS":c=F(e,s,i,r,o,0);break;case"esriTS":c=D(e,s,i,a,r,0);break;case"cim":case"CIMSymbolReference":case"expanded-cim":c=G(e,s,i,r,o,0)}let l,x,u=0;for(let t=0;t<c.rings[0].length-1;t++)x=c.rings[0][t],l=(e-x[0])*(e-x[0])+(s-x[1])*(s-x[1]),u=Math.max(u,l);u=Math.sqrt(u);let h=f(e-u,m),p=f(e+u,m);if(h>p){const t=n(m);if(t){const[e,n]=t.valid;h=e,p=n}}t[0]=h,t[1]=s-u,t[2]=p,t[3]=s+u}(t,i,a,s.symbol,e,o,m,c)}return t}function O(t){return"simple-marker"===t||"picture-marker"===t||"text"===t}function C(e){switch(t(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}const H=P(),T=P(),U=P(),q=P(),E=P(),J=P(),N=P();function B(t,e,n,s){u(U,e,n);const i=t.paths;let a,r,o,m,c,l,f,x,g,d=1/0;for(let t=0;t<i.length;t++){const M=i[t];if(!(M.length<2))for(let t=1;t<M.length;t++)a=M[t-1][0],o=M[t-1][1],r=M[t][0],m=M[t][1],c=Math.min(a,r)-s,l=Math.min(o,m)-s,f=Math.max(a,r)+s,x=Math.max(o,m)+s,e<c||e>f||n<l||n>x||(u(H,a,o),u(T,r,m),h(q,T,H),h(E,H,U),p(J,q,y(q,E)/y(q,q)),h(N,E,J),g=y(N,N),d>g&&(d=g))}return Math.sqrt(d)<=s}function F(t,e,n,s,i,a){let r,o;const m=l(n.xoffset),c=l(n.yoffset),f=W*n.angle,x=W*a;switch(n.type){case"esriSMS":r=o=l(n.size);break;case"esriPMS":r=l(n.width),o=l(n.height)}i<.04&&(s=.04*s/i);const h=I(A);j(h,h,u(X,t,e)),w(h,h,x-f),v(h,h,u(X,s,-s)),j(h,h,u(X,m,-c));const p=[0,0];g(p,u(X,-.5*r,-.5*o),h);const y=[0,0];g(y,u(X,-.5*r,.5*o),h);const d=[0,0];g(d,u(X,.5*r,-.5*o),h);const M=[0,0];return g(M,u(X,.5*r,.5*o),h),{rings:[[p,d,M,y,p]]}}function G(t,e,n,s,i,a){const r=R.getEnvelope(n.data);if(!r)return null;i<.04&&(s=.04*s/i);const o=l(r.width),m=l(r.height),c=l(r.x),f=l(r.y),x=0*W,h=W*a,p=I(A);j(p,p,u(X,t,e)),w(p,p,h-x),v(p,p,u(X,s,s));const y=[0,0];g(y,u(X,c,f+m),p);const d=[0,0];g(d,u(X,c,f),p);const M=[0,0];g(M,u(X,c+o,f+m),p);const b=[0,0];return g(b,u(X,c+o,f),p),{rings:[[y,M,b,d,y]]}}function D(t,e,n,s,i,a){const r=l(n.xoffset),o=l(n.yoffset),m=W*n.angle,c=W*a,f=I(A);j(f,f,u(X,t,e)),w(f,f,c),v(f,f,u(X,i,-i));const x=s[0]+s[2]/2,h=s[1]+s[3]/2;j(f,f,u(X,r,-o)),j(f,f,u(X,x,h)),w(f,f,m),j(f,f,u(X,-x,-h));const p=[0,0];g(p,u(X,s[0],s[1]),f);const y=[0,0];g(y,u(X,s[0],s[1]+s[3]),f);const d=[0,0];g(d,u(X,s[0]+s[2],s[1]),f);const M=[0,0];return g(M,u(X,s[0]+s[2],s[1]+s[3]),f),{rings:[[p,d,M,y,p]]}}function K(t){let e,l,f,x,u,h,p,y,g,d=null;if(!t)return null;if("mesh"===t.type)return t.toJSON();if(e=t.spatialReference,l=n(e),!l)return t.toJSON();f=e.isWebMercator,h=f?102100:4326,x=Y[h].maxX,u=Y[h].minX,p=Y[h].plus180Line,y=Y[h].minus180Line;const M=t.toJSON();if(a(M))g=et(M,x,u);else if(r(M))M.points=M.points.map((t=>et(t,x,u))),g=M;else if(o(M))g=function(t,e){if(!e)return t;const n=function(t,e){const n=[],{ymin:s,ymax:i}=t,a=t.xmax-t.xmin,r=t.xmin,o=t.xmax;let m;const[c,l]=e.valid;m=$(t.xmin,e);const f=m.x,x=m.frameId;m=$(t.xmax,e);const u=m.x,h=m.frameId,p=f===u&&a>0;if(a>2*l){const t={xmin:r<o?f:u,ymin:s,xmax:l,ymax:i},e={xmin:c,ymin:s,xmax:r<o?u:f,ymax:i},a={xmin:0,ymin:s,xmax:l,ymax:i},m={xmin:c,ymin:s,xmax:0,ymax:i},p=[],y=[];_(t,a)&&p.push(x),_(t,m)&&y.push(x),_(e,a)&&p.push(h),_(e,m)&&y.push(h);for(let t=x+1;t<h;t++)p.push(t),y.push(t);n.push({extent:t,frameIds:[x]},{extent:e,frameIds:[h]},{extent:a,frameIds:p},{extent:m,frameIds:y})}else f>u||p?n.push({extent:{xmin:f,ymin:s,xmax:l,ymax:i},frameIds:[x]},{extent:{xmin:c,ymin:s,xmax:u,ymax:i},frameIds:[h]}):n.push({extent:{xmin:f,ymin:s,xmax:u,ymax:i},frameIds:[x]});return n}(t,e).map((t=>t.extent));if(n.length<2)return n[0]||t;if(n.length>2)return t.xmin=e.valid[0],t.xmax=e.valid[1],t;return{rings:n.map((t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]))}}(M,l);else if(m(M)||c(M)){const t=k;i(t,M);const e={xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3]},n=Z(e.xmin,u)*(2*x),a=0===n?M:function(t,e){const n=function(t){if(m(t))return t.rings;return t.paths}(t);for(const t of n)for(const n of t)n[0]+=e;return t}(M,n);e.xmin+=n,e.xmax+=n,s(e,p)&&e.xmax!==x||s(e,y)&&e.xmin!==u?d=a:g=a}else g=t.clone();if(null!==d){return(new nt).cut(d,x)}return g}function Q(t){switch(t.symbol.type){case"esriSFS":case"esriPFS":{const e=t.symbol.outline;return e?e.width:0}case"esriSLS":return l(t.symbol.width);case"esriSMS":return l(t.symbol.size);case"esriPMS":return l(Math.max(t.symbol.width,t.symbol.height));case"esriTS":{const e=[0,0,0,0];V(e,t.symbol,t.mosaicItem);const n=Math.max(Math.abs(e[0]),Math.abs(e[1]));return Math.max(e[2],e[3])+n}case"expanded-cim":{const e=R.getEnvelope(t.symbol.data);return l(Math.sqrt(e.width*e.width+e.height*e.height))}case"composite-symbol":{if(!t.symbol.layers.length)return 0;const e=t.symbol.layers.length-1;return Q({symbol:t.symbol.layers[e],mosaicItem:null})}case"label":default:return 0}}function V(t,e,n){if(!n||0===n.glyphMosaicItems.length)return t;const s=d(e.text)[1],i=n.glyphMosaicItems,a=M(i,s,{scale:l(e.font.size)/24,angle:e.angle,xOffset:e.xoffset,yOffset:e.yoffset,hAlign:b(e.horizontalAlignment||"center"),vAlign:S(e.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(e.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(e.lineHeight||1,4)),decoration:e.font.decoration||"none",isCIM:!1}).bounds;return t[0]=l(a.x-a.halfWidth),t[1]=l(a.y-a.halfHeight),t[2]=l(a.width),t[3]=l(a.height),t}const Y={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:{paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:e.WebMercator},minus180Line:{paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:e.WebMercator}},4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:e.WGS84},minus180Line:{paths:[[[-180,-180],[-180,180]]],spatialReference:e.WGS84}}};function Z(t,e){return Math.ceil((t-e)/(2*e))}function $(t,e){const[n,s]=e.valid,i=2*s;let a,r=0;return t>s?(a=Math.ceil(Math.abs(t-s)/i),t-=a*i,r=a):t<n&&(a=Math.ceil(Math.abs(t-n)/i),t+=a*i,r=-a),{x:t,frameId:r}}function _(t,e){const{xmin:n,ymin:s,xmax:i,ymax:a}=e;return tt(t,n,s)&&tt(t,n,a)&&tt(t,i,a)&&tt(t,i,s)}function tt(t,e,n){return e>=t.xmin&&e<=t.xmax&&n>=t.ymin&&n<=t.ymax}function et(t,e,n){if(Array.isArray(t)){const s=t[0];if(s>e){const n=Z(s,e);t[0]=s+n*(-2*e)}else if(s<n){const e=Z(s,n);t[0]=s+e*(-2*n)}}else{const s=t.x;if(s>e){const n=Z(s,e);t.x+=n*(-2*e)}else if(s<n){const e=Z(s,n);t.x+=e*(-2*n)}}return t}class nt{cut(t,e){let n;if(t.rings)this.closed=!0,n=t.rings,this.minPts=4;else{if(!t.paths)return null;this.closed=!1,n=t.paths,this.minPts=2}const s=n.length,i=-2*e;for(let t=0;t<s;t++){const e=n[t];if(e&&e.length>=this.minPts){const t=[];for(const n of e)t.push([n[0]+i,n[1]]);n.push(t)}}return this.closed?t.rings=n:t.paths=n,t}}export{D as a,F as b,B as c,G as d,C as e,V as f,z as g,O as i,K as n};
