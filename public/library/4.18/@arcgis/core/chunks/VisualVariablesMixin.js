/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as r}from"./tslib.es6.js";import"./object.js";import{L as s}from"./Logger.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import e from"../core/Accessor.js";import"./ensureType.js";import{subclass as i,W as t}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import{J as o}from"./jsonMap.js";import{r as l}from"./reader.js";import{w as n}from"./writer.js";import"./resourceExtension.js";import{collectField as u,collectArcadeFieldNames as p}from"../layers/support/fieldUtils.js";import V from"../renderers/visualVariables/VisualVariable.js";import b from"../renderers/visualVariables/ColorVariable.js";import c from"../renderers/visualVariables/OpacityVariable.js";import h from"../renderers/visualVariables/RotationVariable.js";import y from"../renderers/visualVariables/SizeVariable.js";const f=s.getLogger("esri.renderers.visualVariables.VisualVariableFactory"),v={color:b,size:y,opacity:c,rotation:h},m=new o({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),d=/^\[([^\]]+)\]$/i;let g=class extends e{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(r){if(this._resetVariables(),(r=r&&r.filter((r=>!!r)))&&r.length){for(const s of r)switch(s.type){case"color":this.colorVariables.push(s);break;case"opacity":this.opacityVariables.push(s);break;case"rotation":this.rotationVariables.push(s);break;case"size":this.sizeVariables.push(s)}if(this.sizeVariables.length){this.sizeVariables.some((r=>!!r.target))&&r.sort(((r,s)=>{let a=null;return a=r.target===s.target?0:r.target?1:-1,a}))}for(let s=0;s<r.length;s++){r[s].index=s}this._set("visualVariables",r)}else this._set("visualVariables",r)}readVariables(r,s,a){const{rotationExpression:e,rotationType:i}=s,o=e&&e.match(d),l=o&&o[1];if(l&&(r||(r=[]),r.push({type:"rotationInfo",rotationType:i,field:l})),r)return r.map((r=>{const s=m.read(r.type),e=v[s];e||(f.warn(`Unknown variable type: ${s}`),a&&a.messages&&a.messages.push(new t("visual-variable:unsupported",`visualVariable of type '${s}' is not supported`,{definition:r,context:a})));const i=new e;return i.read(r,a),i}))}writeVariables(r,s){const a=[];for(const e of r){const r=e.toJSON(s);r&&a.push(r)}return a}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};r([a()],g.prototype,"visualVariables",null),g=r([i("esri.renderers.visualVariables.VisualVariableFactory")],g);var j=g;const F={base:V,key:"type",typeMap:{opacity:c,color:b,rotation:h,size:y}},w=s=>{let e=class extends s{constructor(){super(...arguments),this._vvFactory=new j}set visualVariables(r){this._vvFactory.visualVariables=r,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(r,s,a){return this._vvFactory.readVariables(r,s,a)}writeVisualVariables(r,s,a,e){s[a]=this._vvFactory.writeVariables(r,e)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const r of this.visualVariables)if(r.arcadeRequired)return!0;return!1}hasVisualVariables(r,s){return r?!!this.getVisualVariablesForType(r,s):!!(this.getVisualVariablesForType("size",s)||this.getVisualVariablesForType("color",s)||this.getVisualVariablesForType("opacity",s)||this.getVisualVariablesForType("rotation",s))}getVisualVariablesForType(r,s){const a=this.visualVariables;if(!a)return;const e=a.filter((a=>a.type===r&&("string"==typeof s?a.target===s:!1!==s||!a.target)));return e&&0===e.length?void 0:e}async collectVVRequiredFields(r,s){let a=[];this.visualVariables&&(a=a.concat(this.visualVariables));for(const e of a)e&&(e.field&&u(r,s,e.field),e.normalizationField&&u(r,s,e.normalizationField),e.valueExpression&&await p(r,s,e.valueExpression))}};return r([a({types:[F],value:null,json:{write:!0}})],e.prototype,"visualVariables",null),r([l("visualVariables",["visualVariables","rotationType","rotationExpression"])],e.prototype,"readVisualVariables",null),r([n("visualVariables")],e.prototype,"writeVisualVariables",null),e=r([i("esri.renderers.mixins.VisualVariablesMixin")],e),e};export{w as V};
