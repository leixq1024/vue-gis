/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{h as e}from"./object.js";import{i as t,b as o,g as r}from"./Logger.js";import{resolve as s}from"../core/promiseUtils.js";import{f as n}from"./asyncUtils.js";import i from"../request.js";import{g as l}from"./assets.js";import{O as a}from"./vec3f64.js";import c from"../Color.js";import{a as u,p as f}from"./screenUtils.js";import{S as m}from"./Symbol3DMaterial.js";import{i as p,c as y}from"../symbols/support/jsonUtils.js";import{I as h}from"./ItemCache.js";import{getCIMSymbolColor as b}from"../symbols/support/cimSymbolUtils.js";const d=l("esri/symbols/patterns/"),w=new h(1e3);function g(e){const t=e.style;let o=null;if(e)switch(e.type){case"simple-marker":"cross"!==t&&"x"!==t&&(o=e.color);break;case"simple-fill":"solid"===t?o=e.color:"none"!==t&&(o={type:"pattern",x:0,y:0,src:d+t+".png",width:5,height:5});break;case"picture-fill":o={type:"pattern",src:e.url,width:u(e.width)*e.xscale,height:u(e.height)*e.yscale,x:u(e.xoffset),y:u(e.yoffset)};break;case"text":o=e.color;break;case"cim":o=b(e)}return o}function j(e,t){const o=e+"-"+t;return void 0!==w.get(o)?s(w.get(o)):i(e,{responseType:"image"}).then((e=>{const r=e.data,s=r.naturalWidth,n=r.naturalHeight,i=document.createElement("canvas");i.width=s,i.height=n;const l=i.getContext("2d");l.fillStyle=t,l.fillRect(0,0,s,n),l.globalCompositeOperation="destination-in",l.drawImage(r,0,0);const a=i.toDataURL();return w.put(o,a),a}))}function k(e){if(!e)return null;let t;switch(e.type){case"simple-fill":case"picture-fill":case"simple-marker":t=k(e.outline);break;case"simple-line":{const o=u(e.width);"none"!==e.style&&0!==o&&(t={color:e.color,style:L(e.style),width:o,cap:e.cap,join:"miter"===e.join?u(e.miterLimit):e.join});break}default:t=null}return t}const L=function(){const e={};return function(t){if(e[t])return e[t];const o=t.replace(/-/g,"");return e[t]=o,o}}(),x=new c([128,128,128]),v=/\/resource\/(.*?)\.svg$/,z=new c("white");function S(e){if(!e)return 0;if(p(e)){const o=function(e){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const o=e.symbolLayers.getItemAt(t-1);return"outline"in o?r(o,"outline","size"):void 0}(e);return t(o)?o:0}const o=k(e);return o&&f(o.width)||0}function U(e){if(!e||!e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}}function C(t,o){const r=o.resource.href;return!e("esri-canvas-svg-support")&&t.styleOrigin&&v.test(r)?r.replace(v,"/resource/png/$1.png"):r}function I(e,t){if(null==t)return e;const o=e.toRgba();return o[3]=o[3]*t,new c(o)}function O(e,r,s){e&&(r||null!=s)&&(r&&(r=new c(r)),p(e)?function(e,r,s){const n=e.symbolLayers;if(!n)return;const i=e=>{const o=t(e)?e:null;return I(r=r||o||null!=s&&z,s)};n.forEach((e=>{if("object"!==e.type||null==e.resource.href||r)if("water"===e.type)e.color=i(e.color);else{const r=t(e.material)?e.material.color:null,n=i(r);o(e.material)?e.material=new m({color:n}):e.material.color=n,null!=s&&"outline"in e&&t(e.outline)&&t(e.outline.color)&&(e.outline.color=I(e.outline.color,s))}}))}(e,r,s):y(e)&&function(e,t,o){(t=t||e.color)&&(e.color=I(t,o)),null!=o&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=I(e.outline.color,o))}(e,r,s))}async function R(e,o){const r=e.symbolLayers;r&&await n(r,(async e=>async function(e,o){switch(e.type){case"extrude":!function(e,t){e.size="number"==typeof t[2]?t[2]:0}(e,o);break;case"icon":case"line":case"text":!function(e,o){const r=E(o);t(r)&&(e.size=r)}(e,o);break;case"path":!function(e,t){const o=D(t,a,[e.width,void 0,e.height]);e.width=$(t[0],e.width,1,o),e.height=$(t[2],e.height,1,o)}(e,o);break;case"object":await async function(e,t){const{resourceSize:o,symbolSize:r}=await async function(e){const t=await import("./symbolLayerUtils.js"),o=await t.computeObjectLayerResourceSize(e,10),{width:r,height:s,depth:n}=e,i=[r,n,s];let l=1;for(let e=0;e<3;e++)if(null!=i[e]){l=i[e]/o[e];break}for(let e=0;e<3;e++)null==i[e]&&(i[e]=o[e]*l);return{resourceSize:o,symbolSize:i}}(e),s=D(t,o,r);e.width=$(t[0],r[0],o[0],s),e.depth=$(t[1],r[1],o[1],s),e.height=$(t[2],r[2],o[2],s)}(e,o)}}(e,o)))}function E(e){for(const t of e)if("number"==typeof t)return t;return null}function D(e,t,o){for(let r=0;r<3;r++){const s=e[r];switch(s){case"symbol-value":return null!=o[r]?o[r]/t[r]:1;case"proportional":break;default:if(s&&t[r])return s/t[r]}}return 1}function $(e,t,o,r){switch(e){case"proportional":return o*r;case"symbol-value":return null!=t?t:o;default:return e}}async function q(e,t){if(e&&t)return p(e)?R(e,t):void(y(e)&&function(e,t){const r=E(t);if(!o(r))switch(e.type){case"simple-marker":e.size=r;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=r,e.height=r*t):(e.width=r*t,e.height=r);break}case"simple-line":e.width=r;break;case"text":e.font.size=r}}(e,t))}function A(e,t,o){if(e&&null!=t)if(p(e)){const r=e.symbolLayers;r&&r.forEach((e=>{if(e&&"object"===e.type)switch(o){case"tilt":e.tilt=t;break;case"roll":e.roll=t;break;default:e.heading=t}}))}else y(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle=t))}export{q as a,A as b,O as c,k as d,g as e,S as f,C as g,j as h,U as i,x as j};
