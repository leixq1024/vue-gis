/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{A as t}from"./ArrayPool.js";import{h as i}from"./object.js";import{i as s}from"./Logger.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import{f as n,addFrameTask as r}from"../core/scheduling.js";import{eachAlwaysValues as o,resolve as l,c as h}from"../core/promiseUtils.js";import u from"../core/Error.js";import"./ensureType.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import"../core/urlUtils.js";import"./resourceExtension.js";import{s as p}from"./mathUtils2.js";import{s as d}from"./vec3.js";import{c as m}from"./screenUtils.js";import g from"../core/Handles.js";import{M as v}from"./timeUtils.js";import{init as b}from"../core/watchUtils.js";import{s as w}from"./MapUtils.js";import{e as _,I as f}from"./InputManager.js";import{b as P}from"./screenUtils2.js";import y from"../views/input/gamepad/GamepadInputDevice.js";import{g as k}from"./capabilities2.js";import{m as x,f as D}from"./PointerClickHoldAndDrag.js";const C={widthBreakpoint:{getValue(e){const t=e.viewSize[0],i=e.breakpoints,s=this.values;return t<=i.xsmall?s.xsmall:t<=i.small?s.small:t<=i.medium?s.medium:t<=i.large?s.large:s.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],i=e.breakpoints,s=this.values;return t<=i.xsmall?s.xsmall:t<=i.small?s.small:t<=i.medium?s.medium:t<=i.large?s.large:s.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,i=t[0],s=t[1],a=this.values;return s>=i?a.portrait:a.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},T={xsmall:544,small:768,medium:992,large:1200};function E(e,t){return t?C[e].valueToClassName[t].split(" "):[]}const S=i=>{let s=class extends i{constructor(...e){super(...e),this._breakpointsHandles=new g,this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=T}initialize(){this._breakpointsHandles.add(b(this,["breakpoints","size"],this._updateClassNames))}destroy(){this.destroyed||(this._removeActiveClassNames(),this._breakpointsHandles.destroy(),this._breakpointsHandles=null)}set breakpoints(e){if(e===this._get("breakpoints"))return;const t=function(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}(e);if(!t){const e=JSON.stringify(T,null,2);console.warn("provided breakpoints are not valid, using defaults:"+e)}e=t?e:T,this._set("breakpoints",{...e})}_updateClassNames(){if(!this.container)return;const e=t.acquire(),i=t.acquire();let s,a=!1;for(s in C){const t=this[s],n=C[s].getValue({viewSize:this.size,breakpoints:this.breakpoints});t!==n&&(a=!0,this[s]=n,E(s,t).forEach((e=>i.push(e))),E(s,n).forEach((t=>e.push(t))))}a&&(this._applyClassNameChanges(e,i),t.release(e),t.release(i))}_applyClassNameChanges(e,t){const i=this.container;i&&(t.forEach((e=>i.classList.remove(e))),e.forEach((e=>i.classList.add(e))))}_removeActiveClassNames(){const e=this.container;if(!e)return;let t;for(t in C)E(t,this[t]).forEach((t=>e.classList.remove(t)))}};return e([a()],s.prototype,"breakpoints",null),e([a()],s.prototype,"orientation",void 0),e([a()],s.prototype,"widthBreakpoint",void 0),e([a()],s.prototype,"heightBreakpoint",void 0),s=e([c("esri.views.BreakpointsOwner")],s),s},L=t=>{let i=class extends t{async fetchPopupFeatures(e,t){await this.when();const{location:i,queryArea:s,layerViewsAndGraphics:a,clientOnlyGraphics:r}=await this._prepareFetchPopupFeatures(e,t),h=l(r),u=this._queryLayerPopupFeatures({queryArea:s,layerViewsAndGraphics:a,options:t}),c=u.map((e=>e.promise));return{location:i,clientOnlyGraphics:r,allGraphicsPromise:o([h,...c]).then(n),promisesPerLayerView:u}}_queryLayerPopupFeatures({queryArea:e,layerViewsAndGraphics:t,options:i}){return t.map((({layerView:t,graphics:a})=>{const n={clientGraphics:a,event:s(i)?i.event:null,signal:s(i)?i.signal:null,defaultPopupTemplateEnabled:!!s(i)&&!!i.defaultPopupTemplateEnabled},r=t.fetchPopupFeatures(e,n);return{layerView:t,promise:r}}))}_isValidPopupGraphic(e,t){return e&&!!e.getEffectivePopupTemplate(s(t)&&t.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(e,t){const{clientGraphics:i,queryArea:s,location:a}=await this._popupHitTestGraphics(e,t),n=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:r,clientOnlyGraphics:o}=this._graphicsPerFetchPopupLayerView(i,n);return{clientOnlyGraphics:o,layerViewsAndGraphics:r,queryArea:s,location:a}}async _popupHitTestGraphics(e,t){const{results:i,mapPoint:s}=await this.popupHitTest(e),a=i.filter((e=>this._isValidPopupGraphic(e.graphic,t))),n=a.length?a[0].mapPoint:null;return{clientGraphics:a.map((e=>e.graphic)),queryArea:s,location:s||n}}_getFetchPopupLayerViews(){const e=[];return this.allLayerViews.forEach((t=>{this._isValidPopupLayerView(t)&&e.push(t)})),s(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&e.push(this.graphicsView),e.reverse()}_isValidPopupLayerView(e){return s(e)&&(!("layer"in e)||!e.suspended)&&"fetchPopupFeatures"in e}_graphicsPerFetchPopupLayerView(e,t){const i=[],s=new Map,a=t.map((e=>{const t=[];return"layer"in e?s.set(e.layer,t):s.set(e.graphics,t),{layerView:e,graphics:t}}));for(const t of e){const e=s.get(t.layer)||null;e?e.push(t):i.push(t)}return{layerViewsAndGraphics:a,clientOnlyGraphics:i}}};return i=e([c("esri.views.PopupView")],i),i};function I(e,t){switch(t){case"primary":return"touch"===e.pointerType||0===e.button;case"secondary":return"touch"!==e.pointerType&&2===e.button;case"tertiary":return"touch"!==e.pointerType&&1===e.button}}function A(e,t){if("touch"===e.pointerType)return!1;switch(t){case"primary":return 0===e.button;case"secondary":return 2===e.button;case"tertiary":return 1===e.button}}class M{constructor(e){this.callbacks=e,this.currentCount=0,this.callbacks.condition||(this.callbacks.condition=()=>!0)}handle(e){const t=e.data,i=t.pointers.size;switch(t.action){case"start":this.currentCount=i,this.emitStart(e);break;case"added":this.emitEnd(this.previousEvent),this.currentCount=i,this.emitStart(e);break;case"update":this.emitUpdate(e);break;case"removed":this.startEvent&&this.emitEnd(this.previousEvent),this.currentCount=i,this.emitStart(e);break;case"end":this.emitEnd(e),this.currentCount=0}this.previousEvent=e}emitStart(e){this.startEvent=e,this.callbacks.condition(this.currentCount,e)&&this.callbacks.start(this.currentCount,e,this.startEvent)}emitUpdate(e){this.callbacks.condition(this.currentCount,e)&&this.callbacks.update(this.currentCount,e,this.startEvent)}emitEnd(e){this.callbacks.condition(this.currentCount,e)&&this.callbacks.end(this.currentCount,e,this.startEvent),this.startEvent=null}}function G(e){let t=e*e;return e<0&&(t*=-1),t}function V(e){return e.translation[0]=0,e.translation[1]=0,e.translation[2]=0,e.heading=0,e.tilt=0,e}function j(e,t,i){const s=i,a=e.state,n=e.device,r="forward-down"===t.tiltDirection?1:-1;return"standard"===n.deviceType?(s.translation[0]=G(a.axes[0]),s.translation[1]=G(a.axes[1]),s.translation[2]=G(a.buttons[7])-G(a.buttons[6]),s.heading=G(a.axes[2]),s.tilt=G(a.axes[3])):"spacemouse"===n.deviceType&&(s.translation[0]=1.2*G(a.axes[0]),s.translation[1]=1.2*G(a.axes[1]),s.translation[2]=2*-G(a.axes[2]),s.heading=1.2*G(a.axes[5]),s.tilt=1.2*G(a.axes[3])),s.tilt*=r,d(s.translation,s.translation,1),s}function U(e,t){const i=t;return i.translation[0]=e[1]-e[0],i.translation[1]=e[3]-e[2],i.translation[2]=e[4]-e[5],i.heading=e[7]-e[6],i.tilt=e[8]-e[9],i.zoom=e[10]-e[11],i}function q(e){return 0===e.translation[0]&&0===e.translation[1]&&0===e.translation[2]&&0===e.heading&&0===e.tilt&&0===e.zoom}function H(e){const t=e.native;return t?{buttons:t.buttons.map((e=>e.pressed?e.value?e.value:1:0)),axes:t.axes.map((t=>function(e,t){const i=Math.abs(e);if(i<t)return 0;return p(e)*(i-t)/(1-t)}(t,e.axisThreshold)))}:{buttons:[],axes:[]}}class F{constructor(e,t){this.element=e,this.input=t,this._hasEventListeners=!1,this.onConnectGamepad=e=>{this.connectGamepad(e.gamepad)},this.onDisconnectGamepad=e=>{const t=e.gamepad,i=t.index,s=this.inputDevices[i];s&&(this.emitGamepadEvent(t,H(s),!1),this.inputDevices.splice(i,1),this.latestUpdate.splice(i,1),this.input.gamepad.devices.remove(s),this.ensurePollingState())},this.frameTask=null,this.latestUpdate=new Array,this.inputDevices=new Array,this.callback=null,this.supported="getGamepads"in window.navigator,this.supported&&(this.forEachGamepad(this.connectGamepad),window.addEventListener("gamepadconnected",this.onConnectGamepad),window.addEventListener("gamepaddisconnected",this.onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this.onConnectGamepad),window.removeEventListener("gamepaddisconnected",this.onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get eventsEnabled(){return this.supported&&this.inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this.callback=e}connectGamepad(e){const t=new y(e);"unknown"!==t.deviceType&&(this.inputDevices[e.index]=t,this.input.gamepad.devices.add(t)),this.ensurePollingState()}ensurePollingState(){this.eventsEnabled?this.startPolling():this.stopPolling()}startPolling(){null==this.frameTask&&(this.frameTask=r({update:()=>this.readGamepadState()}))}stopPolling(){null!=this.frameTask&&(this.frameTask.remove(),this.frameTask=null,this.latestUpdate=new Array)}readGamepadState(){const e=document.hasFocus(),t=this.element.contains(document.activeElement),i="document"===this.input.gamepad.enabledFocusMode&&!e||"view"===this.input.gamepad.enabledFocusMode&&!t;this.forEachGamepad((e=>{const t=this.inputDevices[e.index];if(!t)return;const s=this.latestUpdate[e.index],a=H(t),n=i||function(e){for(let t=0;t<e.axes.length;t++)if(0!==e.axes[t])return!1;for(let t=0;t<e.buttons.length;t++)if(0!==e.buttons[t])return!1;return!0}(a);if(s){if(s.timestamp===e.timestamp)return;if(!s.active&&n)return;if(function(e,t){if(e.axes.length!==t.axes.length)return!1;if(e.buttons.length!==t.buttons.length)return!1;for(let i=0;i<e.axes.length;i++)if(e.axes[i]!==t.axes[i])return!1;for(let i=0;i<e.buttons.length;i++)if(e.buttons[i]!==t.buttons[i])return!1;return!0}(s.state,a))return}this.emitGamepadEvent(e,a,!n)}))}forEachGamepad(e){const t=window.navigator.getGamepads();for(let i=0;i<t.length;i++){const s=t[i];this.validate(s)&&e(s)}}emitGamepadEvent(e,t,i){const s=this.latestUpdate[e.index],a=s&&s.active;if(!a&&!i)return;const n=!a&&i?"start":a&&i?"update":"end";this.latestUpdate[e.index]={timestamp:e.timestamp,state:t,active:i},this.callback&&this.callback({device:this.inputDevices[e.index],state:t,action:n})}validate(e){if(!e)return!1;if(!e.connected)return!1;for(let t=0;t<e.axes.length;t++)if(isNaN(e.axes[t]))return!1;return!0}}const z=i("trident"),N=i("edge"),B=i("chrome"),O=i("ff"),W=i("safari"),K="esri-view-surface--touch-none",$="esri-view-surface--touch-pan";class R{constructor(e,t){this.input=t,this._active={},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new F(e,this.input),this._gamepadSource.onEvent=e=>this._callback("gamepad",e)}destroy(){this._callback=null,this.activeEvents=null,this._activePointerCaptures.forEach((e=>{this._releasePointerCaptureSafe(e)})),this._gamepadSource&&(this._gamepadSource.destroy(),this._gamepadSource=null),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const t in this._active)if(!e||!e.has(t)){const e=this._active[t];this._element.removeEventListener(Y[t],e),delete this._active[t]}e&&e.forEach((e=>{if(!this._active[e]&&Y[e]){const t=(this._eventHandlers[e]||this._handleDefault).bind(this,e);this._element.addEventListener(Y[e],t),this._active[e]=t}})),this._gamepadSource.hasEventListeners=e&&e.has("gamepad")}setPointerCapture(e,t){t?(this._element.setPointerCapture(e.pointerId),this._activePointerCaptures.add(e.pointerId)):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?K:$),this._element.classList.add(this._browserTouchPanningEnabled?$:K)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(K),this._element.classList.remove($),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch(e){}}_updateNormalizedPointerLikeEvent(e,t){const i=P(this._element,e);return R.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),t.x=i.x,t.y=i.y,t}_handleKey(e,t){const i=_(t);i&&"key-up"===e&&this._keyDownState.delete(i);const s={native:t,key:i,repeat:i&&this._keyDownState.has(i)};i&&"key-down"===e&&this._keyDownState.add(s.key),this._callback(e,s)}_handlePointer(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});this._callback(e,i)}_handlePointerPreventDefault(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});t.preventDefault(),this._callback(e,i)}_handleMouseWheel(e,t){let i=t.deltaY;switch(t.deltaMode){case 0:(z||N)&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}z||N?i*=.7:B||W?i*=.6:O&&(i*=1.375);const s=Math.abs(i);if(s>100){const e=.02;i=i/s*200/(1+Math.exp(-e*(s-100)))}const a=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,deltaY:i});this._callback(e,a)}_handlePointerCaptureLost(e,t){this._activePointerCaptures.delete(t.pointerId),this._handleDefault(e,t)}_handleDefault(e,t){const i={native:t};t.preventDefault(),this._callback(e,i)}_preventAltKeyDefault(e){"Alt"===e.key&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}}R.test={disableSubpixelCoordinates:!1};const Y={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class J extends f{constructor(){super(!0),this.registerIncoming("context-menu",(e=>{e.data.native.preventDefault()}))}}const Q={maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};class X extends f{constructor(e=Q.maximumDoubleClickDelay,t=Q.maximumDoubleClickDistance,i=Q.maximumDoubleTouchDelay,s=Q.maximumDoubleTouchDistance,a=h){super(!1),this.maximumDoubleClickDelay=e,this.maximumDoubleClickDistance=t,this.maximumDoubleTouchDelay=i,this.maximumDoubleTouchDistance=s,this._clock=a,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("drag",this._handleDrag.bind(this))}onUninstall(){this._pointerState.forEach((e=>{null!=e.doubleClickTimeout&&(e.doubleClickTimeout.remove(),e.doubleClickTimeout=null)}))}get hasPendingInputs(){return w(this._pointerState,(e=>null!=e.doubleClickTimeout))}_pointerId(e){const t=e.native;return"mouse"===t.pointerType?`${t.pointerId}:${t.button}`:`${t.pointerType}`}_handleImmediateClick(e){const t=e.data,i=this._pointerId(t),s=this._pointerState.get(i);if(s){const a="touch"===t.native.pointerType?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;x(s.event.data,t)>a?(this._clearDoubleClickTimeout(i,!0),this._startClick(e)):(this._clearDoubleClickTimeout(i,!1),this._doubleClick.emit(s.event.data,void 0,s.event.modifiers))}else this._startClick(e)}_startClick(e){const t=this._pointerId(e.data),i="touch"===e.data.native.pointerType?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;this._pointerState.set(t,{event:e,doubleClickTimeout:this._clock.setTimeout((()=>this._doubleClickTimeoutExceeded(t)),i)}),this.refreshHasPendingInputs()}_handlePointerDrag(e){const t=this._pointerId(e.data.currentEvent);this._clearDoubleClickTimeout(t,!0)}_handleDrag(e){const t=this._pointerId(e.data.pointer);this._clearDoubleClickTimeout(t,!0)}_clearDoubleClickTimeout(e,t){const i=this._pointerState.get(e);i&&(i.doubleClickTimeout.remove(),i.doubleClickTimeout=null,t&&this._doubleClickTimeoutExceeded(e),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const t=this._pointerState.get(e);this._click.emit(t.event.data,void 0,t.event.modifiers),t.doubleClickTimeout=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}}class Z extends f{constructor(e){super(!1),this.navigationTouch=e,this.startStateModifiers=new Set,this.activePointerMap=new Map,this.isDragging=!1,this.isCurrentDragSuppressed=!1,this.drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this.handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this.handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this.handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this.handlePointerUpAndPointerLost.bind(this))}createPayload(e,t,i,s){return{action:e,pointerType:this.pointerType,button:this.mouseButton,buttons:t.buttons,timestamp:s,pointers:ie(this.activePointerMap),pointer:t,angle:i.angle,radius:i.radius,center:i.center}}addPointer(e){const t=e.native.pointerId,i=te(this.activePointerMap).angle,s={event:e,initialAngle:0,lastAngle:0};this.activePointerMap.set(t,s);const a=se(s,ee(this.activePointerMap));s.initialAngle=a,s.lastAngle=a,this.updatePointerAngles(i)}updatePointer(e){if(e&&null==e.x&&null==e.y)return;const t=e.native.pointerId,i=this.activePointerMap.get(t);i?i.event=e:this.addPointer(e)}removePointer(e){const t=te(this.activePointerMap).angle;this.activePointerMap.delete(e),this.updatePointerAngles(t)}updatePointerAngles(e){const t=te(this.activePointerMap);this.activePointerMap.forEach((i=>{i.initialAngle=se(i,t)-e,i.lastAngle=se(i,t)-e}))}emitEvent(e,t,i){const s=te(this.activePointerMap);this.drag.emit(this.createPayload(e,t,s,i),void 0,this.startStateModifiers)}handlePointerUpAndPointerLost(e){const t=e.data.native.pointerId,i=v(e.timestamp);this.activePointerMap.get(t)&&(1===this.activePointerMap.size?(this.updatePointer(e.data),!this.isCurrentDragSuppressed&&this.emitEvent("end",e.data,i),this.isDragging=!1,this.isCurrentDragSuppressed=!1,this.removePointer(t)):(this.removePointer(t),this.emitEvent("removed",e.data,v(e.timestamp))))}handlePointerDrag(e){const t=e.data,i=t.currentEvent,s=v(e.timestamp);switch(t.action){case"start":case"update":this.isDragging?this.activePointerMap.has(i.native.pointerId)?(this.updatePointer(i),!this.isCurrentDragSuppressed&&this.emitEvent("update",i,s)):(this.addPointer(i),this.emitEvent("added",i,s),this.isCurrentDragSuppressed=this.isSuppressed):(this.updatePointer(i),this.pointerType=e.data.startEvent.pointerType,this.mouseButton=e.data.startEvent.button,this.startStateModifiers=e.modifiers,this.isDragging=!0,this.isCurrentDragSuppressed=this.isSuppressed,!this.isCurrentDragSuppressed&&this.emitEvent("start",i,s))}}get isSuppressed(){return this.navigationTouch&&!this.navigationTouch.browserTouchPanEnabled&&"touch"===this.pointerType&&1===this.activePointerMap.size}}function ee(e){const t=[];return e.forEach((e=>{t.push(m(e.event.x,e.event.y))})),D(t)}function te(e){const t=ee(e);let i=0;return e.forEach((e=>{let s=se(e,t),a=s-e.lastAngle;for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;s=e.lastAngle+a,e.lastAngle=s;const n=s-e.initialAngle;i+=n})),i/=e.size||1,{angle:i,radius:t.radius,center:t.center}}function ie(e){const t=new Map;return e.forEach(((e,i)=>t.set(i,e.event))),t}function se(e,t){const i=e.event,s=i.x-t.center.x,a=i.y-t.center.y;return Math.atan2(a,s)}var ae;!function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right",e[e.Back=3]="Back",e[e.Forward=4]="Forward",e[e.Undefined=-1]="Undefined"}(ae||(ae={}));class ne extends f{constructor(e=Q.maximumDoubleClickDelay,t=Q.maximumDoubleClickDistance,i=Q.maximumDoubleTouchDelay,s=Q.maximumDoubleTouchDistance,a=h){super(!1),this.maximumDoubleClickDelay=e,this.maximumDoubleClickDistance=t,this.maximumDoubleTouchDelay=i,this.maximumDoubleTouchDistance=s,this._clock=a,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",(e=>{this._handlePointerLoss(e,"pointer-up")})),this.registerIncoming("pointer-capture-lost",(e=>{this._handlePointerLoss(e,"pointer-capture-lost")})),this.registerIncoming("pointer-cancel",(e=>{this._handlePointerLoss(e,"pointer-cancel")}))}onUninstall(){this._pointerState.forEach((e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()})),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=this._pointerId(t);if(!this._pointerState.has(i)){const e={downButton:t.native.button,immediateDoubleClick:null};this._pointerState.set(i,e),this.startCapturingPointer(t.native)}}_handlePointerLoss(e,t){const i=e.data,s=this._pointerId(i),a=this._pointerState.get(s);if(a&&"pointer-up"===t&&a.downButton===i.native.button){const t=a.immediateDoubleClick;if(t){t.timeoutHandle.remove();const s="touch"===e.data.native.pointerType?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;x(t,e.data)>s?this._startImmediateDoubleClick(e,a):(this._immediateDoubleClick.emit(e.data,void 0,t.modifiers),this._removeState(i))}else this._startImmediateDoubleClick(e,a)}}_startImmediateDoubleClick(e,t){const i="touch"===e.data.native.pointerType?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;t.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout((()=>this._removeState(e.data)),i)}}_pointerId(e){const t=e.native;return"mouse"===t.pointerType?`${t.pointerId}:${t.button}`:`${t.pointerType}`}_removeState(e){const t=this._pointerId(e);this._pointerState.delete(t),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}}const re={checkMajorWebPerformanceCaveat:!0};function oe(e){e={...re,...e};const t=k();return t.available?e.checkMajorWebPerformanceCaveat&&t.majorPerformanceCaveat?new u("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist."):t.supportsHighPrecisionFragment?t.supportsVertexShaderSamplers?t.supportsElementIndexUint?t.supportsStandardDerivatives?t.supportsInstancedArrays?null:new u("webgl:instanced-arrays-required","WebGL support for instanced rendering is required but not supported."):new u("webgl:standard-derivatives-required","WebGL support for standard derivatives is required but not supported."):new u("webgl:element-index-uint-required","WebGL support for uint vertex indices is required but not supported."):new u("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new u("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new u("webgl:required","WebGL is required but not supported.")}export{R as B,M as D,ne as I,L as P,X as S,j as a,Q as b,Z as c,J as d,I as e,S as f,oe as g,A as h,q as i,U as j,V as r};
