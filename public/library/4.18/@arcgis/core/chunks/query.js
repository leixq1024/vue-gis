/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{i as t}from"./Logger.js";import{resolve as e}from"../core/promiseUtils.js";import{join as r,urlToObject as n}from"../core/urlUtils.js";import o from"../request.js";import{getJsonType as i}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as s}from"../geometry/support/normalizeUtils.js";import{a as u}from"./queryZScale.js";import{p as a}from"./pbfQueryUtils.js";function l(t){const e={};for(const r in t){if("declaredClass"===r)continue;const n=t[r];if(null!=n&&"function"!=typeof n)if(Array.isArray(n)){e[r]=[];for(let t=0;t<n.length;t++)e[r][t]=l(n[t])}else"object"==typeof n?n.toJSON&&(e[r]=JSON.stringify(n)):e[r]=n}return e}function y(e,r){const n=e.geometry,o=e.toJSON(),s=o;if(t(n)&&(s.geometry=JSON.stringify(n),s.geometryType=i(n),s.inSR=n.spatialReference.wkid||JSON.stringify(n.spatialReference)),o.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=o.groupByFieldsForStatistics.join(",")),o.objectIds&&(s.objectIds=o.objectIds.join(",")),o.orderByFields&&(s.orderByFields=o.orderByFields.join(",")),!o.outFields||!o.returnDistinctValues&&(null!=r&&r.returnCountOnly||null!=r&&r.returnExtentOnly||null!=r&&r.returnIdsOnly)?delete s.outFields:-1!==o.outFields.indexOf("*")?s.outFields="*":s.outFields=o.outFields.join(","),o.outSR?s.outSR=o.outSR.wkid||JSON.stringify(o.outSR):n&&(o.returnGeometry||o.returnCentroid)&&(s.outSR=s.inSR),o.returnGeometry&&delete o.returnGeometry,o.outStatistics&&(s.outStatistics=JSON.stringify(o.outStatistics)),o.pixelSize&&(s.pixelSize=JSON.stringify(o.pixelSize)),o.quantizationParameters&&(s.quantizationParameters=JSON.stringify(o.quantizationParameters)),o.parameterValues&&(s.parameterValues=JSON.stringify(o.parameterValues)),o.rangeValues&&(s.rangeValues=JSON.stringify(o.rangeValues)),o.dynamicDataSource&&(s.layer=JSON.stringify({source:o.dynamicDataSource}),delete o.dynamicDataSource),o.timeExtent){const t=o.timeExtent,{start:e,end:r}=t;null==e&&null==r||(s.time=e===r?e:`${null==e?"null":e},${null==r?"null":r}`),delete o.timeExtent}return s}async function c(e,r,n,o){const i=t(r.timeExtent)&&r.timeExtent.isEmpty?{data:{features:[]}}:await x(e,r,"json",o);return u(r,n,i.data),i}async function m(r,n,o,i){if(t(n.timeExtent)&&n.timeExtent.isEmpty)return e({data:o.createFeatureResult()});const s=await f(r,n,i),u=s;return u.data=a(s.data,o),u}function f(t,e,r){return x(t,e,"pbf",r)}function d(r,n,o){return t(n.timeExtent)&&n.timeExtent.isEmpty?e({data:{objectIds:[]}}):x(r,n,"json",o,{returnIdsOnly:!0})}function p(r,n,o){return t(n.timeExtent)&&n.timeExtent.isEmpty?e({data:{count:0}}):x(r,n,"json",o,{returnIdsOnly:!0,returnCountOnly:!0})}function S(r,n,o){return t(n.timeExtent)&&n.timeExtent.isEmpty?e({data:{count:0,extent:null}}):x(r,n,"json",o,{returnExtentOnly:!0,returnCountOnly:!0}).then((t=>{const e=t.data;if(e.hasOwnProperty("extent"))return t;if(e.features)throw new Error("Layer does not support extent calculation.");if(e.hasOwnProperty("count"))throw new Error("Layer does not support extent calculation.");return t}))}function x(e,i,u,a={},c){const m="string"==typeof e?n(e):e,f=i.geometry?[i.geometry]:[];return a.responseType="pbf"===u?"array-buffer":"json",s(f,null,a).then((e=>{const n=e&&e[0];t(n)&&((i=i.clone()).geometry=n);const s=l({...m.query,f:u,...c,...y(i,c)});return o(r(m.path,"query"),{...a,query:{...s,...a.query}})}))}var g=Object.freeze({__proto__:null,queryToQueryStringParameters:y,executeQuery:c,executeQueryPBF:m,executeQueryPBFBuffer:f,executeQueryForIds:d,executeQueryForCount:p,executeQueryForExtent:S,runQuery:x});export{c as a,p as b,S as c,d,m as e,f,l as m,g as q,x as r};
