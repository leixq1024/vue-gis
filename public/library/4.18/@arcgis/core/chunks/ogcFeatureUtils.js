/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{L as e,i as t,b as i}from"./Logger.js";import n from"../core/Error.js";import{W as a,e as r}from"../geometry/SpatialReference.js";import o from"../request.js";import{k as s}from"./fieldType.js";import l from"../tasks/support/FeatureSet.js";import d from"../layers/support/FieldsIndex.js";import{O as f}from"./OptimizedGeometry.js";import{a as m,b as c,c as u}from"./featureConversionUtils.js";import{c as y,p}from"./projectionSupport.js";import{v as g,i as F,c as I}from"./geojson.js";import{c as j}from"./clientSideDefaults.js";const b=e.getLogger("esri.layers.graphics.sources.ogcfeature");async function w(e,t,i,r,l=5){try{await y(a,i.spatialReference)}catch{throw new n("ogc-feature-layer:projection-not-supported","Projection not supported")}const f=`${e}/collections/${t}/items`,{data:m}=await o(f,{signal:r,query:{limit:l,f:"json"}});await g(m);const c=F(m,{geometryType:i.geometryType}),u=i.fields||c.fields||[],p=null!=i.hasZ?i.hasZ:c.hasZ,I=c.geometryType,w=i.objectIdField||c.objectIdFieldName||"OBJECTID";let T=i.timeInfo;const h=u.find((e=>e.name===w));if(!h){if(!c.objectIdFieldType)throw new n("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");u.unshift({name:w,alias:w,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else h.type="esriFieldTypeOID",h.editable=!1,h.nullable=!1;if(w!==c.objectIdFieldName){const e=u.find((e=>e.name===c.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}if(!I)throw new n("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");u===c.fields&&c.unknownFields.length>0&&b.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:c.unknownFields}});for(const e of u){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new n("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(-1===s.jsonValues.indexOf(e.type))throw new n("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(T){const e=new d(u);if(T.startTimeField){const t=e.get(T.startTimeField);t?(T.startTimeField=t.name,t.type="esriFieldTypeDate"):T.startTimeField=null}if(T.endTimeField){const t=e.get(T.endTimeField);t?(T.endTimeField=t.name,t.type="esriFieldTypeDate"):T.endTimeField=null}if(T.trackIdField){const t=e.get(T.trackIdField);t?T.trackIdField=t.name:(T.trackIdField=null,b.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:T}}))}T.startTimeField||T.endTimeField||(b.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:T}}),T=null)}return{drawingInfo:j(I),geometryType:I,fields:u,hasZ:!!p,objectIdField:w,timeInfo:T}}async function T(e,t,i){const n=`${e}/collections/${t}`,{data:a}=await o(n,{signal:i,query:{f:"json"}});return a}async function h(e,t){const i=`${e}/conformance`,{data:n}=await o(i,{signal:t,query:{f:"json"}});return n}async function $(e,t){const{data:i}=await o(e,{signal:t,query:{f:"json"}});return i}async function k(e,t,i){const n=await x(e,t,i);return l.fromJSON(n)}async function x(e,t,i){const n=await v(e,t,i);return m(n)}async function v(e,n,s){var l;const{capabilities:{query:{maxRecordCount:d}},collectionId:m,layerDefinition:y,url:g}=e,F=`${g}/collections/${m}/items`,{geometry:j,num:b,start:w,timeExtent:T,where:h}=n,$=t(n.outSpatialReference)?n.outSpatialReference:a,k=function(e){if(i(e))return null;const{xmin:t,ymin:n,xmax:a,ymax:r}=e;return`${t},${n},${a},${r}`}(p(j,a)),x=function(e){if(i(e))return null;const{start:t,end:n}=e;return`${t?t.toISOString():".."}/${n?n.toISOString():".."}`}(T),v=function(e){if(i(e)||!e||"1=1"===e)return null;return e}(h),S=null!=b?b:null!=w&&void 0!==w?10:d,{data:q}=await o(F,{...s,query:{bbox:k,datetime:x,query:v,limit:S,startindex:w,f:"json"}}),O=null==(l=q.links)?void 0:l.filter((e=>"next"===e.rel)),D=0!==(null==O?void 0:O.length),{fields:N,globalIdField:Z,hasM:R,hasZ:C,objectIdField:L}=y,E=y.geometryType,G=I(q,{geometryType:E,hasZ:C,objectIdFieldName:L});if(!r($,a))for(const e of G)e.geometry&&(e.geometry=c(p(u(e.geometry,E,C,!1),a,$)));for(const e of G)e.objectId=e.attributes[L];const J=new f;return J.exceededTransferLimit=D,J.features=G,J.fields=N,J.geometryType=E,J.globalIdFieldName=Z,J.hasM=R,J.hasZ=C,J.objectIdFieldName=L,J.spatialReference=$||a,J}export{h as a,T as b,w as c,x as d,v as e,$ as g,k as q};
