/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{h as e}from"./object.js";import{L as t,b as s,u as a}from"./Logger.js";import{all as r}from"../core/promiseUtils.js";import{E as i}from"./Evented.js";import{a as n}from"./arcadeOnDemand.js";import{d as o,h as d}from"./diffUtils.js";import{C as c}from"./aaBoundingBox.js";import{r as u}from"./rbush.js";const h=import("./labelFormatUtils.js");class l{constructor(e,t){this._canCacheExpressionValue=!1,this._sourceInfo=e,this._bitsets={computed:t.getBitset(t.createBitset())}}async updateSchema(t,a){const i=o(this._schema,a);if(this._schema=a,!a||s(i)||!d(i,"attributes"))return;e("esri-2d-update-debug")&&console.debug("Applying Update - Store:",i),this._bitsets.computed.clear(),t.targets[a.name]=!0;const n=a.attributes,c=[],u=[];for(const e in n){const t=n[e];switch(t.type){case"field":break;case"expression":c.push(this._createArcadeComputedField(t));break;case"label-expression":c.push(this._createLabelArcadeComputedField(t));break;case"statistic":u.push(t)}}this._computedFields=await r(c),this._canCacheExpressionValue=!this._computedFields.some((e=>"expression"===e.type&&e.expression.referencesScale())),this._statisticFields=u}setComputedAttributes(e,t,s,a){const r=this._bitsets.computed;if(!this._canCacheExpressionValue||!r.has(s)){r.set(s);for(const r of this._computedFields){const i=this._evaluateField(t,r,a);switch(r.resultType){case"numeric":e.setComputedNumericAtIndex(s,r.fieldIndex,i);break;case"string":e.setComputedStringAtIndex(s,r.fieldIndex,i)}}}}async _createArcadeComputedField(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fieldsIndex;return{...e,expression:await n(e.valueExpression,t,s)}}async _createLabelArcadeComputedField(e){const t=this._sourceInfo.spatialReference,s=this._sourceInfo.fields,{createLabelFunction:a}=await h,r=await a(e.label,s,t);return{...e,builder:r}}_evaluateField(e,s,a){switch(s.type){case"label-expression":{const t=e.readArcadeFeature();return s.builder.evaluate(t)||""}case"expression":{const{expression:r}=s;return function(e,s,a){e.referencesGeometry();const r=s.readArcadeFeature();try{return e.evaluate({...a,$feature:r})}catch(e){return t.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",e),null}}(r,e,{$view:{scale:a}})}}}}function p(e){return(4294901760&e)>>>16}function I(e){return 65535&e}const _={getObjectId:e=>e.getObjectId(),getAttributes:e=>e.readAttributes(),getAttribute:(e,t)=>e.readAttribute(t),cloneWithGeometry:(e,t)=>e,getGeometry:e=>e.readHydratedGeometry(),getCentroid:(e,t)=>e.readCentroid()};class g extends l{constructor(e,t){super(e,t),this.featureAdapter=_,this.events=new i,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._index=u(9,(e=>({minX:this._storage.getXMin(e),minY:this._storage.getYMin(e),maxX:this._storage.getXMax(e),maxY:this._storage.getYMax(e)})))}get storeStatistics(){return{featureCount:0,vertexCount:0}}onTileData(e,t,a){if(s(t.addOrUpdate))return t;this._featureSetsByInstance.set(t.addOrUpdate.instance,t.addOrUpdate),this._storage=a,t.addOrUpdate._storage=a;const r=t.addOrUpdate.getCursor();for(;r.next();){const t=r.getObjectId(),s=(i=r.instance,n=r.getIndex(),i<<16|n);let o=this._objectIdToDisplayId.get(t);o||(o=a.createDisplayId(),this._objectIdToDisplayId.set(t,o),this._spatialIndexInvalid=!0),r.setDisplayId(o),a.setInstanceId(o,s),this.setComputedAttributes(a,r,o,e.scale)}var i,n;return"update"===t.type&&(this._spatialIndexInvalid=!0),this.events.emit("changed"),t}forEach(e){this._objectIdToDisplayId.forEach((t=>{const s=this._storage.getInstanceId(t),a=this._lookupFeature(s);e(a)}))}forEachUnsafe(e){this._objectIdToDisplayId.forEach((t=>{const s=this._storage.getInstanceId(t),a=p(s),r=I(s),i=this._getFeatureSet(a);i.setIndex(r),e(i)}))}forEachInBounds(e,t){const s=this._searchIndex(e);for(const e of s){const s=this.lookupFeatureByDisplayId(e,this._storage);t(a(s))}}forEachBounds(e,t,s){this._rebuildIndex();const a=[0,0,0,0];for(const r of e){if(!r.readGeometry())continue;const e=r.getDisplayId();a[0]=this._storage.getXMin(e),a[1]=this._storage.getYMin(e),a[2]=this._storage.getXMax(e),a[3]=this._storage.getYMax(e),t(c(s,a))}}sweepFeatures(e,t,s){this._objectIdToDisplayId.forEach(((a,r)=>{e.has(a)||(t.releaseDisplayId(a),s.unsetAttributeData(a),this._objectIdToDisplayId.delete(r))})),this.events.emit("changed")}sweepFeatureSets(e){this._featureSetsByInstance.forEach(((t,s)=>{e.has(s)||this._featureSetsByInstance.delete(s)}))}lookupObjectId(e,t){const a=this.lookupFeatureByDisplayId(e,t);return s(a)?null:a.getObjectId()}lookupDisplayId(e){return this._objectIdToDisplayId.get(e)}lookupFeatureByDisplayId(e,t){const s=t.getInstanceId(e);return this._lookupFeature(s)}lookupByDisplayIdUnsafe(e){const t=this._storage.getInstanceId(e),s=p(t),a=I(t),r=this._getFeatureSet(s);return r?(r.setIndex(a),r):null}hasInstance(e){return this._featureSetsByInstance.has(e)}_rebuildIndex(){if(!this._spatialIndexInvalid)return;this._index.clear();const e=[];this._objectIdToDisplayId.forEach((t=>{const s=this._storage.getInstanceId(t);this._storage.setBounds(t,this._lookupFeature(s))&&e.push(t)})),this._index.load(e),this._spatialIndexInvalid=!1}_lookupFeature(e){const t=p(e),s=I(e),a=this._getFeatureSet(t);if(!a)return null;const r=a.getCursor();return r.setIndex(s),r}_getFeatureSet(e){return this._featureSetsByInstance.get(e)}_searchIndex(e){this._rebuildIndex();const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}}export{g as F,l as S,_ as f};
