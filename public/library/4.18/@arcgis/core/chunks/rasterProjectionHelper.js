/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{g as n}from"../geometry/SpatialReference.js";import t from"../geometry/Point.js";import{project as a}from"../geometry/support/webMercatorUtils.js";import o from"../geometry/Extent.js";import"../geometry.js";import{a as i}from"./unitUtils.js";import{isLoaded as r,isSupported as s,load as l,project as c}from"../geometry/projection.js";const x=function(e,n){const t=(e.isWGS84||e.isWebMercator)&&(n.isWGS84||n.isWebMercator);return!(e.equals(n)||t)};async function m(){if(r()||!s())return null;await l()}function u(n,t,i,s=null){if(n.spatialReference.equals(t))return n;const l=x(n.spatialReference,t);if(l&&!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");const m=i.center,u=new o({xmin:m.x-n.x/2,xmax:m.x+n.x/2,ymin:m.y-n.y/2,ymax:m.y+n.y/2,spatialReference:n.spatialReference}),p=l?c(u,t,s):a(u,t);if(null==p)return null;return{x:p.xmax-p.xmin,y:p.ymax-p.ymin}}function p(e,n=.01){return i(e)?n/i(e):0}function f(t,o,i=null,s=!0){const l=t.spatialReference;if(l.equals(o))return t;const m=x(l,o);if(m&&!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");const u=m?c(t,o,i):a(t,o);if(u&&s&&o.isGeographic){var f,h;const[e,a]=l.isWebMercator?n(l).origin:null!=(f=null==(h=n(l))?void 0:h.valid)?f:[],o=p(l);o&&null!=e&&null!=a&&(Math.abs(t.x-e)<o&&Math.abs(180-u.x)<5e-4?u.x-=360:Math.abs(t.x-a)<o&&Math.abs(180+u.x)<5e-4&&(u.x+=360))}return u}function h(o,i,s=null,l=!0){var m,u,h,y;const M=o.spatialReference;if(M.equals(i))return o;const w=x(M,i);if(w&&!r())throw new e("rasterprojectionhelper-projectExtent","projection engine is not loaded");const d=w?c(o,i,s):a(o,i);let[g,j]=null!=(m=null==(u=n(M))?void 0:u.origin)?m:[];if(d&&l&&M.isWebMercator&&i.isGeographic&&null!=g&&null!=j){const e=.001,n=1e3;if(Math.abs(o.xmin-g)<e&&Math.abs(j-o.xmax)>n&&Math.abs(180-d.xmax)<5e-4){d.xmin=-180;const e=[];e.push(new t(o.xmax,o.ymin,M)),e.push(new t(o.xmax,(o.ymin+o.ymax)/2,M)),e.push(new t(o.xmax,o.ymax,M));const n=e.map((e=>f(e,i,s))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));d.xmax=Math.max.apply(null,n)}if(Math.abs(o.xmax-j)<e&&Math.abs(g-o.xmin)>n&&Math.abs(180+d.xmin)<5e-4){d.xmax=180;const e=[];e.push(new t(o.xmin,o.ymin,M)),e.push(new t(o.xmin,(o.ymin+o.ymax)/2,M)),e.push(new t(o.xmin,o.ymax,M));const n=e.map((e=>f(e,i,s))).filter((e=>!isNaN(null==e?void 0:e.x))).map((e=>e.x));d.xmin=Math.min.apply(null,n)}}[g,j]=i.isWebMercator?n(i).origin:null!=(h=null==(y=n(i))?void 0:y.valid)?h:[];const R=p(i);return R&&null!=g&&null!=j&&(Math.abs(d.xmin-g)<R&&(d.xmin=g),Math.abs(d.xmax-j)<R&&(d.xmax=j)),d}function y(a,o,i,s=null,l=null,c=!1,m=[32,32]){var u,p;if(x(a.spatialReference,o.spatialReference)&&!r())throw new e("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(a&&o&&i))return null;const{xmin:h,ymin:y,xmax:M,ymax:w}=a,d=a.spatialReference,g=o.spatialReference,[j,R]=null!=(u=null==(p=n(d))?void 0:p.valid)?u:[],b={x:m[0]*i.x,y:m[1]*i.y},v={cols:Math.ceil((M-h)/b.x-.1)+1,rows:Math.ceil((w-y)/b.y-.1)+1},N=b.x,S=b.y,z=[];let W,G=!1;for(let e=0;e<v.cols;e++){const n=[];for(let a=0;a<v.rows;a++){let i=f(new t({x:h+N*e,y:w-S*a,spatialReference:d}),g,s);l&&(i=l.inverseTransform(i)),n.push(i),e>0&&c&&i&&W[a]&&null!=j&&i.x<W[a].x&&(i.x+=R-j),i?(z.push((i.x-o.xmin)/(o.xmax-o.xmin)),z.push((o.ymax-i.y)/(o.ymax-o.ymin))):(z.push(NaN),z.push(NaN),G=!0)}W=n}const P=function(e,n){const t=(e[0]+e[4]+e[4*n.cols]+e[4*n.cols+4])/4,a=(e[1]+e[5]+e[4*n.rows+1]+e[4*n.rows+5])/4;return[Math.abs(t-e[2*n.rows+2]),Math.abs(a-e[2*n.rows+3])]}(z,v),L=new Float32Array((v.cols-1)*(v.rows-1)*2*6),q=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),A=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let e=0;e<v.cols-1;e++){for(let n=0;n<v.rows-1;n++){let t=e*v.rows*2+2*n;const a=z[t],o=z[t+1],i=z[t+2],r=z[t+3];t+=2*v.rows;const s=z[t],l=z[t+1],c=z[t+2],x=z[t+3];let m=0,u=12*(n*(v.cols-1)+e);for(let e=0;e<3;e++)L[u++]=q[m++]*a+q[m++]*i+q[m++]*c;m=0;for(let e=0;e<3;e++)L[u++]=q[m++]*o+q[m++]*r+q[m++]*x;m=0;for(let e=0;e<3;e++)L[u++]=A[m++]*a+A[m++]*s+A[m++]*c;m=0;for(let e=0;e<3;e++)L[u++]=A[m++]*o+A[m++]*l+A[m++]*x}if(G)for(let e=0;e<L.length;e++)isNaN(L[e])&&(L[e]=-1)}return{offsets:z,error:P,coefficients:L,spacing:m,size:[v.cols-1,v.rows-1]}}function M(e,n,a){const o=Math.log(e.x/n.pixelSize.x)/Math.LN2,i=Math.log(e.y/n.pixelSize.y)/Math.LN2,r=n.storageInfo.maximumPyramidLevel||0;let s="down"===a?Math.floor(Math.min(o,i)):"up"===a?Math.ceil(Math.max(o,i)):Math.round((o+i)/2),l=!1;s<0?s=0:s>r&&(l=s>r+3,s=r);const c=Math.pow(2,s);return{pyramidLevel:s,pyramidResolution:new t({x:c*n.nativePixelSize.x,y:c*n.nativePixelSize.y,spatialReference:n.spatialReference}),excessiveReading:l}}function w(e,n,a=512,o=!0){const{extent:r,spatialReference:s,pixelSize:l}=e,c=u(new t({x:l.x,y:l.y,spatialReference:s}),n,r);if(null==c)return{projectedPixelSize:null,scales:null,srcResolutions:null};const x=(c.x+c.y)/2,m=i(n),p=x*m*96*39.37,f=n.isGeographic?512/a*295828763.7958547:512/a*591657527.591555;let y=!1;if(o&&(n.isGeographic||n.isWebMercator)){const e=h(r,n);y=e.xmin*e.xmax<0}let M,w=p;const d=1.001;if(y){w=f;const e=w/(96*m*39.37);M=u(new t({x:e,y:e,spatialReference:n}),s,r)}else{M={x:l.x,y:l.y};const n=Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2);let t=0;for(;w<.5005*f&&t<n;)t++,w*=2,M.x*=2,M.y*=2;Math.max(w,f)/Math.min(w,f)<=d&&(w=f)}const g=[],j=[],R=Math.min(70.5310735,p)/d;for(;w>=R;)g.push(w),j.push({x:M.x,y:M.y}),w/=2,M.x/=2,M.y/=2;return{projectedPixelSize:c,scales:g,srcResolutions:j}}export{u as a,h as b,w as c,y as g,m as l,f as p,M as s};
