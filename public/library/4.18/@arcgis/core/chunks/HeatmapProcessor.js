/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"./ArrayPool.js";import"./object.js";import"./deprecate.js";import"../core/lang.js";import"../config.js";import{i as t}from"./Logger.js";import"./string.js";import"./metadata.js";import"../core/accessorSupport/decorators/property.js";import"../core/Accessor.js";import"./PropertyOrigin.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"./Message.js";import"../core/Error.js";import"./ensureType.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import"./Evented.js";import"../core/Collection.js";import"../core/urlUtils.js";import"./resourceExtension.js";import"./mathUtils2.js";import"../core/Handles.js";import{d as s}from"./diffUtils.js";import"../core/watchUtils.js";import"../core/HandleOwner.js";import{b as o}from"./heatmapUtils.js";import{B as i}from"./BaseProcessor.js";let a=class extends i{constructor(){super(...arguments),this.type="heatmap",this._tileKeyToFeatureSets=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])}async update(e,t){const r=t.schema.processors[0];if("heatmap"!==r.type)return;s(this._schema,r)&&(e.mesh=!0,this._schema=r)}onTileUpdate(e){for(const t of e.removed)this._tileKeyToFeatureSets.delete(t.key.id)}async onTileData(e,r,s){this._tileKeyToFeatureSets.has(e.key.id)&&"replace"!==r.type||this._tileKeyToFeatureSets.set(e.key.id,new Map);const i=this._tileKeyToFeatureSets.get(e.key.id);t(r.addOrUpdate)&&i.set(r.addOrUpdate.instance,r);let a=r.end;if(i.forEach((e=>a=a||e.end)),!a)return;const p=[];i.forEach((e=>{t(e.addOrUpdate)&&p.push(e.addOrUpdate)}));const m=o(p,this._schema.mesh,512,512),n={tileKey:e.key.id,intensityInfo:m},c=[m.matrix];return this.remoteClient.invoke("tileRenderer.onTileData",n,{...s,transferList:c})}onTileError(e,t,r){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:t},r)}};a=e([r("esri.views.2d.layers.features.processors.HeatmapProcessor")],a);var p=a;export default p;
