/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{n as e}from"./compilerUtils.js";import{c as t}from"./vec3f64.js";import{c as n}from"./mat4.js";import{projectBuffer as o,computeLinearTransformation as r}from"../geometry/projection.js";import{c as a}from"./quatf64.js";import{i as s}from"./dehydratedFeatures.js";import{i,g as l}from"./ElevationProvider.js";import{u as c}from"./ColorMaterial.js";function u(e,t,n,r,a,s,i,l,c,u,f){const d=E[f.mode];let m,p,g=0;if(o(e,t,n,r,c.spatialReference,a,l))return d.requiresAlignment(f)?(g=d.applyElevationAlignmentBuffer(r,a,s,i,l,c,u,f),m=s,p=i):(m=r,p=a),o(m,c.spatialReference,p,s,u.spatialReference,i,l)?g:void 0}function f(t,n,o,r,a){const c=(s(t)?t.z:i(t)?t.array[t.offset+2]:t[2])||0;switch(o.mode){case"on-the-ground":{const e=l(n,t,"ground")||0;return a&&(a.verticalDistanceToGround=0,a.sampledElevation=e),e}case"relative-to-ground":{const e=l(n,t,"ground")||0,s=o.geometryZWithOffset(c,r);return a&&(a.verticalDistanceToGround=s,a.sampledElevation=e),s+e}case"relative-to-scene":{const e=l(n,t,"scene")||0,s=o.geometryZWithOffset(c,r);return a&&(a.verticalDistanceToGround=s,a.sampledElevation=e),s+e}case"absolute-height":{const e=o.geometryZWithOffset(c,r);if(a){const o=l(n,t,"ground")||0;a.verticalDistanceToGround=e-o,a.sampledElevation=o}return e}default:return e(o.mode),0}}function d(e,t,n){return null==t||null==n?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===n?e.staysOnTheGround:t===n||"on-the-ground"!==t&&"on-the-ground"!==n?v.UPDATE:e.onTheGroundChanged}function m(e){return"relative-to-ground"===e||"relative-to-scene"===e}function p(e){return"absolute-height"!==e}function g(e,t,o,a,s){const i=f(t,o,s,a,y);c(e,y.verticalDistanceToGround);const l=y.sampledElevation,u=n(h,e.objectTransformation);A[0]=t.x,A[1]=t.y,A[2]=i;return r(t.spatialReference,A,u,a.spatialReference)?e.objectTransformation=u:console.warn("Could not locate symbol object properly, it might be misplaced"),l}var v;!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(v||(v={}));const E={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,n,o,r,a,s,i){const l=i.calculateOffsetRenderUnits(s),c=i.featureExpressionInfoContext;t*=3,o*=3;for(let a=0;a<r;++a){const r=e[t+0],a=e[t+1],s=e[t+2];n[o+0]=r,n[o+1]=a,n[o+2]=null==c?s+l:l,t+=3,o+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return 0!==t||null!=n}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,n,o,r,a){let s=0;const i=a.spatialReference;t*=3,o*=3;for(let l=0;l<r;++l){const r=e[t+0],l=e[t+1],c=e[t+2],u=a.getElevation(r,l,c,i,"ground")||0;s+=u,n[o+0]=r,n[o+1]=l,n[o+2]=u,t+=3,o+=3}return s/r},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,n,o,r,a,s,i){let l=0;const c=i.calculateOffsetRenderUnits(s),u=i.featureExpressionInfoContext,f=a.spatialReference;t*=3,o*=3;for(let s=0;s<r;++s){const r=e[t+0],s=e[t+1],i=e[t+2],d=a.getElevation(r,s,i,f,"ground")||0;l+=d,n[o+0]=r,n[o+1]=s,n[o+2]=null==u?i+d+c:d+c,t+=3,o+=3}return l/r},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,n,o,r,a,s,i){let l=0;const c=i.calculateOffsetRenderUnits(s),u=i.featureExpressionInfoContext,f=a.spatialReference;t*=3,o*=3;for(let s=0;s<r;++s){const r=e[t+0],s=e[t+1],i=e[t+2],d=a.getElevation(r,s,i,f,"scene")||0;l+=d,n[o+0]=r,n[o+1]=s,n[o+2]=null==u?i+d+c:d+c,t+=3,o+=3}return l/r},requiresAlignment:()=>!0}},h=a(),y={verticalDistanceToGround:0,sampledElevation:0},A=t();export{v as S,d as a,u as b,p as c,g as d,f as e,m as n};
