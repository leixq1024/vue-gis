/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{i as t,g as e,b as n}from"./Logger.js";import{all as r}from"../core/promiseUtils.js";import o from"../core/Collection.js";import a,{j as s,g as i}from"../geometry/SpatialReference.js";import c from"../geometry/Geometry.js";import u from"../geometry/Point.js";import{e as f}from"./Ellipsoid.js";import{canProject as l,project as m}from"../geometry/support/webMercatorUtils.js";import y from"../geometry/Extent.js";import{t as p,a as g}from"./common.js";import{a as x}from"./unitUtils.js";import b from"../Viewpoint.js";import{s as h,c as d,n as w,b as j,e as G,t as A,f as M,a as R,g as v,h as S,i as k,l as q}from"./vec2.js";import{i as F,t as I,r as N,s as P,f as z,a as L,b as V}from"./mat2d.js";import{c as E}from"./mat2df64.js";import{c as O,f as W}from"./vec2f64.js";const C=180/Math.PI;function U(t,e,n,r){return r&&n&&!r.equals(n)&&l(r,n)&&r.isWebMercator?r.isWebMercator?function(t,e){let n=e[1];return n>89.99999?n=89.99999:n<-89.99999&&(n=-89.99999),n=Math.sin(p(n)),h(t,p(e[0])*f.radius,.5*f.radius*Math.log((1+n)/(1-n)))}(t,e):function(t,e,n){const r=g(e[0]/f.radius);return h(t,n?r:r-360*Math.floor((r+180)/360),g(.5*Math.PI-2*Math.atan(Math.exp(-1*e[1]/f.radius))))}(t,e):d(t,e)}function Q(t){return t.wkid?t:t.spatialReference||a.WGS84}function B(t,e){return e.type?h(t,e.x,e.y):d(t,e)}function D(t){return x(t)}function T(t,e){return Math.max(t.width/e[0],t.height/e[1])*(n=t.spatialReference,s(n)?39.37*D(n)*96:1);var n}async function H(a,s,i,f){let p,g;if(!a)return null;if(Array.isArray(a)&&!a.length)return null;if(o.isCollection(a)&&(a=a.toArray()),Array.isArray(a)&&a.length&&"object"==typeof a[0]){const e=a.every((t=>"attributes"in t)),n=a.some((t=>!t.geometry));let o=a;if(e&&n&&s&&s.allLayerViews){const e=new Map;for(const t of a){const n=t.layer,r=e.get(n)||[],o=t.attributes[n.objectIdField];null!=o&&r.push(o),e.set(n,r)}const n=[];e.forEach(((t,e)=>{const r=s.allLayerViews.find((t=>t.layer.id===e.id));if("queryFeatures"in r){const o=e.createQuery();o.objectIds=t,o.returnGeometry=!0,n.push(r.queryFeatures(o))}}));const i=await r(n),c=[];for(const e of i)if(e&&e.features&&e.features.length)for(const n of e.features)t(n.geometry)&&c.push(n.geometry);o=c}for(const t of o)f=await H(t,s,i,f);return f}if(Array.isArray(a)&&2===a.length&&"number"==typeof a[0]&&"number"==typeof a[1])p=new u(a);else if(a instanceof c)p=a;else if("geometry"in a)if(a.geometry)p=a.geometry;else if(a.layer){const t=a.layer,n=s.allLayerViews.find((e=>e.layer.id===t.id));if("queryFeatures"in n){const r=t.createQuery();r.objectIds=[a.attributes[t.objectIdField]],r.returnGeometry=!0;const o=await n.queryFeatures(r);p=e(o,"features",0,"geometry")}}if(n(p))return null;if(g="point"===p.type?new y({xmin:p.x,ymin:p.y,xmax:p.x,ymax:p.y,spatialReference:p.spatialReference}):p.extent,!g)return null;const x=l(g,i);if(!g.spatialReference.equals(i)&&x)g=m(g,i);else if(!x)return null;return f=f?f.union(g):g.clone()}async function J(e,n){if(!e||!n)return new b({targetGeometry:new u,scale:0,rotation:0});let r=n.spatialReference;const{constraints:o,padding:a,viewpoint:s,size:i}=n,c=[a?i[0]-a.left-a.right:i[0],a?i[1]-a.top-a.bottom:i[1]];let f=null;e instanceof b?f=e:e.viewpoint?f=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(f=e.target);let p=null;f&&f.targetGeometry?p=f.targetGeometry:e instanceof y?p=e:(e||e&&("center"in e||"extent"in e||"target"in e))&&(p=await H(e.center,n,r)||await H(e.extent,n,r)||await H(e.target,n,r)||await H(e,n,r)),!p&&s&&s.targetGeometry?p=s.targetGeometry:!p&&n.extent&&(p=n.extent);const g=Q(p);if(r||(r=Q(n.spatialReference||n.extent||p)),!l(p,r)&&g&&!g.equals(r))return null;const x=B(O(),p.center?p.center:p),h=new u(U(x,x,g,r),r);let d=null;d=f&&t(f.targetGeometry)&&"point"===f.targetGeometry.type?f.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&o&&o.effectiveLODs?o.zoomToScale(e.zoom):Array.isArray(p)||"point"===p.type||"extent"===p.type&&0===p.width&&0===p.height?n.extent&&l(n.extent,r)?T(m(n.extent,r),c):n.extent?T(n.extent,c):s.scale:l(p.extent,r)?T(m(p.extent,r),c):T(p.extent,c);const w=function(t){if(t&&(!Array.isArray(t)||"number"!=typeof t[0])&&("object"==typeof t||Array.isArray(t)&&"object"==typeof t[0])){if("layer"in t&&t.layer&&t.layer.minScale&&t.layer.maxScale){const e=t.layer;return{min:e.minScale,max:e.maxScale}}if(Array.isArray(t)&&t.length&&t.every((t=>"layer"in t))){let e=0,n=0;for(const r of t){const t=r.layer;t&&t.minScale&&t.maxScale&&(e=t.minScale<e?t.minScale:e,n=t.maxScale>n?t.maxScale:n)}return e&&n?{min:e,max:n}:null}}}(e);w&&(w.min&&w.min>d?d=w.min:w.max&&w.max<d&&(d=w.max));let j=0;f?j=f.rotation:e.hasOwnProperty("rotation")?j=e.rotation:s&&(j=s.rotation);let G=new b({targetGeometry:h,scale:d,rotation:j});return o&&(G=o.fit(G),o.constrainByGeometry(G),o.rotationEnabled||(G.rotation=j)),G}function K(t,e){const n=t.targetGeometry,r=e.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function X(t,e,n){return n?h(t,.5*(e[0]-n.right+n.left),.5*(e[1]-n.bottom+n.top)):j(t,e,.5)}const Y=function(){const t=O();return function(e,n,r){const o=n.targetGeometry;B(t,o);const a=.5*tt(n);return e.xmin=t[0]-a*r[0],e.ymin=t[1]-a*r[1],e.xmax=t[0]+a*r[0],e.ymax=t[1]+a*r[1],e.spatialReference=o.spatialReference,e}}();function Z(t,e,n,r,o){return ut(t,e,n.center),t.scale=T(n,r),o&&o.constraints&&o.constraints.constrain(t),t}const $=function(){const t=O();return function(e,n,r){return G(e,function(t,e){return j(t,e,.5)}(e,n),X(t,n,r))}}(),_=function(){const t=E(),e=O();return function(n,r,o,a){const s=tt(r),i=et(r);return h(e,s,s),L(t,e),N(t,t,i),I(t,t,$(e,o,a)),I(t,t,[0,a.top-a.bottom]),h(n,t[4],t[5])}}();function tt(e){return e.scale*(n=e.targetGeometry,t(n)&&s(n.spatialReference)?1/(39.37*D(n.spatialReference)*96):1);var n}function et(t){return p(t.rotation)||0}const nt=function(){const t=O(),e=O(),n=O();return function(r,o,a,s,i,c){return w(t,o),j(e,a,.5*c),h(n,1/s*c,-1/s*c),F(r),I(r,r,e),i&&N(r,r,i),P(r,r,n),I(r,r,t),r}}(),rt=function(){const t=O();return function(e,n,r,o){const a=tt(n),s=et(n);return B(t,n.targetGeometry),nt(e,t,r,a,s,o)}}(),ot=function(){const t=O();return function(e,n,r,o){const a=tt(n);return B(t,n.targetGeometry),nt(e,t,r,a,0,o)}}();function at(t,e){return Math.round(function(t){if(t.isWrappable){const e=i(t);return e.valid[1]-e.valid[0]}return 0}(t)/e)}function st(t,e){return J(t,e)}const it=function(){const t=O(),e=O(),n=[0,0,0];return function(r,o,a){R(t,r,o),v(t,t),R(e,r,a),v(e,e),S(n,t,e);let s=Math.acos(k(t,e)/(q(t)*q(e)))*C;return n[2]<0&&(s=-s),isNaN(s)&&(s=0),s}}(),ct=function(){const t=O();return function(e,n,r,o){const a=e.targetGeometry;return K(e,n),_(t,n,r,o),a.x+=t[0],a.y+=t[1],e}}(),ut=function(){const t=O();return function(e,n,r){K(e,n);const o=e.targetGeometry,a=Q(r),s=Q(o);return B(t,r),U(t,t,a,s),o.x=t[0],o.y=t[1],e}}(),ft=function(){const t=O();return function(e,n,r,o,a){a||(a="center"),G(t,r,o),j(t,t,.5);const s=t[0],i=t[1];switch(a){case"center":h(t,0,0);break;case"left":h(t,-s,0);break;case"top":h(t,0,i);break;case"right":h(t,s,0);break;case"bottom":h(t,0,-i);break;case"top-left":h(t,-s,i);break;case"bottom-left":h(t,-s,-i);break;case"top-right":h(t,s,i);break;case"bottom-right":h(t,s,-i)}return dt(e,n,t),e}}();function lt(t,e,n){return K(t,e),t.rotation+=n,t}function mt(t,e,n){return K(t,e),t.rotation=n,t}const yt=function(){const t=O();return function(e,n,r,o,a){return K(e,n),isNaN(r)||0===r||(bt(t,o,n,a),e.scale=n.scale*r,ht(t,t,e,a),dt(e,e,h(t,t[0]-o[0],o[1]-t[1]))),e}}();function pt(t,e,n){return K(t,e),t.scale=n,t}const gt=function(){const t=O();return function(e,n,r,o,a,s){return K(e,n),isNaN(r)||0===r||(bt(t,a,n,s),e.scale=n.scale*r,e.rotation+=o,ht(t,t,e,s),dt(e,e,h(t,t[0]-a[0],a[1]-t[1]))),e}}(),xt=function(){const t=O(),e=O();return function(n,r,o,a,s,i,c){return $(e,i,c),M(t,s,e),a?gt(n,r,o,a,t,i):yt(n,r,o,t,i)}}(),bt=function(){const t=E();return function(e,n,r,o){return A(e,n,function(t,e,n,r){return rt(t,e,n,r),V(t,t)}(t,r,o,1))}}(),ht=function(){const t=E();return function(e,n,r,o){return A(e,n,rt(t,r,o,1))}}(),dt=function(){const t=O(),e=E();return function(n,r,o){K(n,r);const a=tt(r),s=n.targetGeometry;return z(e,et(r)),P(e,e,W(a,a)),A(t,o,e),s.x+=t[0],s.y+=t[1],n}}();export{ct as a,ut as b,K as c,pt as d,st as e,ft as f,T as g,gt as h,nt as i,tt as j,Y as k,rt as l,ot as m,at as n,$ as o,X as p,lt as q,mt as r,Z as s,dt as t,it as u,xt as v};
