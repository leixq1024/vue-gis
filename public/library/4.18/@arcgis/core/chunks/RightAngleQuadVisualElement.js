/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{i as e,b as t}from"./Logger.js";import{c as i,a as s}from"./vec3f64.js";import{g as r,k as n,n as a,c as h,a as o}from"./vec3.js";import l from"../core/Handles.js";import{i as c,t as d,s as u}from"./mat4.js";import{c as _}from"./quatf64.js";import{c as f}from"./vec4.js";import{u as g,c as m}from"./geometryUtils.js";import{L as p,C as y,R as P,G as L}from"./ColorMaterial.js";import{G as b,a as R}from"./Geometry.js";import{O as M}from"./Object3D.js";import{T as v}from"./Texture.js";import{f as V}from"./vec4f32.js";import{d as E,L as w}from"./LaserLineRenderer.js";class C{constructor(e){this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e,this.view.watch("ready",(e=>{this._resourcesCreated&&(e?this._createResources():this._destroyResources())}))}applyProps(e){let t=!1;for(const i in e)i in this?"attached"===i?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.attached=!1}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources())}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.visible||this.updateVisibility(!1)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}}class S extends C{constructor(e){super(e.view),this._angleCutoff=E,this._style={},this._heightManifoldTarget=i(),this._heightManifoldEnabled=!1,this._intersectsLine=g.create(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this.renderer}createResources(){this.ensureRenderer()}destroyResources(){this.disposeRenderer()}updateVisibility(){this.syncHeightManifold(),this.syncIntersectsLine(),this.syncPathVerticalPlane(),this.syncLineVerticalPlane(),this.syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this.syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this.syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(t){e(t)?(r(this._heightManifoldTarget,t),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this.syncRenderer(),this.syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(t(e))return void(this.intersectsLine=null);const i=this.view.renderCoordsHelper.worldUpAtPosition(e,O);this.intersectsLine=g.fromValues(e,i),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(t){e(t)?(g.copy(t,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this.syncIntersectsLine(),this.syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this.syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(t){this._lineVerticalPlaneSegment=e(t)?g.copy(t):null,this.syncLineVerticalPlane(),this.syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this.syncPathVerticalPlane(),this.syncLineVerticalPlane(),this.syncPointDistance(),this.syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(t){this._pointDistanceLine=e(t)?{origin:s(t.origin),target:s(t.target)}:null,this.syncPointDistance(),this.syncRenderer()}syncRenderer(){this.attached&&(this._intersectsLineEnabled||this._heightManifoldEnabled||e(this._pointDistanceLine)||e(this._pathVerticalPlaneBuffers))?this.ensureRenderer():this.disposeRenderer()}ensureRenderer(){e(this.renderer)||(this.renderer=new w(this.view.renderCoordsHelper,void 0,{contrastControlEnabled:!0}),this.syncStyle(),this.syncHeightManifold(),this.syncIntersectsLine(),this.syncIntersectsLineInfinite(),this.syncPathVerticalPlane(),this.syncLineVerticalPlane(),this.syncPointDistance(),this.syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this.renderer.renderSlots,this.renderer))}syncStyle(){t(this.renderer)||(this.renderer.setParameterValues(this._style),null!=this._style.intersectsLineRadius&&(this.renderer.intersectsLineRadius=this._style.intersectsLineRadius))}syncAngleCutoff(){t(this.renderer)||this.renderer.setParameterValues({angleCutoff:this._angleCutoff})}syncHeightManifold(){t(this.renderer)||(this.renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this.renderer.heightManifoldTarget=this._heightManifoldTarget))}syncIntersectsLine(){t(this.renderer)||(this.renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this.renderer.intersectsLineSegment=this._intersectsLine))}syncIntersectsLineInfinite(){t(this.renderer)||(this.renderer.intersectsLineInfinite=this._intersectsLineInfinite)}syncPathVerticalPlane(){t(this.renderer)||(this.renderer.pathVerticalPlaneEnabled=e(this._pathVerticalPlaneBuffers)&&this.visible,e(this._pathVerticalPlaneBuffers)&&(this.renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}syncLineVerticalPlane(){t(this.renderer)||(this.renderer.lineVerticalPlaneEnabled=e(this._lineVerticalPlaneSegment)&&this.visible,e(this._lineVerticalPlaneSegment)&&(this.renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}syncPointDistance(){t(this.renderer)||(this.renderer.pointDistanceEnabled=e(this._pointDistanceLine)&&this.visible,e(this._pointDistanceLine)&&(this.renderer.pointDistanceOrigin=this._pointDistanceLine.origin,this.renderer.pointDistanceTarget=this._pointDistanceLine.target))}disposeRenderer(){e(this.renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this.renderer),this.renderer=null)}}const O=i();class j extends C{constructor(e){super(e.view),this._resources=null}get object(){return e(this._resources)?this._resources.object:null}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(t(this._resources))return;const e=this._resources.object,i=this.view._stage;e.geometries.forEach((e=>{i.remove(2,e.id)})),e.removeAllGeometries(),this.createGeometries(e),this.visible||e.setVisible(this.visible),e.geometries.forEach((e=>{i.add(2,e)}))}createResources(){this.destroyResources();const e=this.view._stage;if(!e)return;const t=new p("element",{isPickable:!1});e.add(0,t),e.addToViewContent([t.id]);const i=new M({idHint:"element",castShadow:!1});this.createExternalResources(),this.createGeometries(i),i.geometries.forEach((t=>{e.add(2,t)})),this.forEachExternalResource((t=>{e.add(this._contentTypeFromResource(t),t)})),e.add(1,i),t.addObject(i),this.visible||i.setVisible(!1),this._resources={layer:t,object:i}}_contentTypeFromResource(e){return e instanceof b?2:e instanceof v?4:3}destroyResources(){const e=this.view._stage;!t(this._resources)&&e&&(e.remove(1,this._resources.object.id),e.remove(0,this._resources.layer.id),this.forEachExternalResource((t=>{e.remove(this._contentTypeFromResource(t),t.id),t.dispose()})),this._resources.object.geometries.forEach((t=>{e.remove(2,t.id)})),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){t(this._resources)||this._resources.object.setVisible(e)}}class D extends j{constructor(e){super(e),this._handles=new l,this._quadMaterial=null,this._outlineMaterial=null,this._maxSize=0,this._position=i(),this._up=i(),this._right=i(),this._transform=_(),this._renderOccluded=4,this._color=V(1,0,0,1),this._outlineColor=V(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=16,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){f(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){f(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const t=0===this._outlineSize!=(0===e);this._outlineSize=e,t?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:t,next:i}){this._maxSize=Math.min(n(t,e),n(t,i))/3,a(this._up,h(this._up,e,t)),a(this._right,h(this._right,i,t)),r(this._position,t),this.recreateGeometry()}createExternalResources(){this._quadMaterial=new y(this.quadMaterialParameters,"right-angle-quad"),this._outlineMaterial=new P(this.outlineMaterialParameters,"right-angle-quad-outline"),this._handles.add(this.view.state.watch("camera",(()=>{this._updateTransform()})))}destroyExternalResources(){this._quadMaterial=null,this._outlineMaterial=null,this._handles.removeAll()}forEachExternalResource(e){e(this._quadMaterial),e(this._outlineMaterial)}createGeometries(e){this._createQuadGeometry(e),this._createOutlineGeometry(e),this._updateTransform(e)}_createQuadGeometry(e){const t=new b(this._quadGeometryData(this._up,this._right),"right-angle-quad");e.addGeometry(t,this._quadMaterial)}_createOutlineGeometry(e){if(0===this._outlineSize)return;const t=o(m.get(),this._up,this._right),i=new b(L.createPolylineGeometry([this._up,t,this._right]),"right-angle-quad-outline");e.addGeometry(i,this._outlineMaterial)}_updateTransform(t=this.object){const i=this.view.state.camera,s=this._size*i.computeScreenPixelSizeAt(this._position),r=Math.min(this._maxSize,s);c(this._transform),d(this._transform,this._transform,this._position),u(this._transform,this._transform,[r,r,r]),e(t)&&(t.objectTransformation=this._transform)}_quadGeometryData(e,t){const i=o(m.get(),e,t);return new R({position:{size:3,data:[0,0,0,...t,...e,...i]}},{position:new Uint32Array([0,1,2,1,2,3])})}get quadMaterialParameters(){return{color:this._color,transparent:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded}}_updateQuadMaterial(){this._quadMaterial&&this._quadMaterial.setParameterValues(this.quadMaterialParameters)}get outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded}}_updateOutlineMaterial(){this._outlineMaterial&&this._outlineMaterial.setParameterValues(this.outlineMaterialParameters)}}export{S as L,j as O,D as R,C as V};
