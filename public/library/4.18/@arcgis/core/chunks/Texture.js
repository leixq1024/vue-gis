/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{f as e,d as t}from"../core/lang.js";import{L as r,b as a,i}from"./Logger.js";import{createAbortController as s,create as o,onAbort as n,createAbortError as h}from"../core/promiseUtils.js";import l from"../core/Error.js";import{n as m}from"./compilerUtils.js";import{E as d}from"./Evented.js";import{isBlobProtocol as p,isDataProtocol as u}from"../core/urlUtils.js";import{l as c}from"../request.js";import{m as g,n as f}from"./mathUtils2.js";import{r as w}from"./requestImageUtils.js";import{T,i as x,F as M}from"./isWebGL2Context.js";import{a as D}from"./Util.js";import{c as F}from"./Geometry.js";import{v as y}from"./VertexArrayObject.js";import{I as b}from"./Object3D.js";const I=r.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function v(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const E=v("DXT1"),A=v("DXT3"),O=v("DXT5");function C(e,t,r,a){const{textureData:i,internalFormat:s,width:o,height:n}=function(e,t){const r=new Int32Array(e,0,31);if(542327876!==r[0])return I.error("Invalid magic number in DDS header"),null;if(!(4&r[20]))return I.error("Unsupported format, must contain a FourCC code"),null;const a=r[21];let i,s;switch(a){case E:i=8,s=33776;break;case A:i=16,s=33778;break;case O:i=16,s=33779;break;default:return I.error("Unsupported FourCC code:",(o=a,String.fromCharCode(255&o,o>>8&255,o>>16&255,o>>24&255))),null}var o;let n=1,h=r[4],l=r[3];0==(3&h)&&0==(3&l)||(I.warn("Rounding up compressed texture size to nearest multiple of 4."),h=h+3&-4,l=l+3&-4);const m=h,d=l;131072&r[2]&&!1!==t&&(n=Math.max(1,r[7]));1===n||g(h)&&g(l)||(I.warn("Ignoring mipmaps of non power of two sized compressed texture."),n=1);let p,u,c=r[1]+4;const f=[];for(let t=0;t<n;++t)u=(h+3>>2)*(l+3>>2)*i,p=new Uint8Array(e,c,u),f.push(p),c+=u,h=Math.max(1,h>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:f},internalFormat:s,width:m,height:d}}(r,a);t.samplingMode=i.levels.length>1?9987:9729,t.hasMipmap=i.levels.length>1,t.internalFormat=s,t.width=o,t.height=n;const h=new T(e,t,i);return e.bindTexture(h,0),h}class P{constructor(e,t,r){this.data=e,this.glTexture=null,this.powerOfTwoStretchInfo=null,this.loadingPromise=null,this.loadingController=null,this.events=new d,this.data=e,this.id=P.idGen.gen(t),this.params=r||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:10497,t:10497},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||1,this.estimatedTexMemRequired=P.estimateTexMemRequired(this.data,this.params),this.startPreload()}startPreload(){const e=this.data;a(e)||(e instanceof HTMLVideoElement?this.startPreloadVideoElement(e):e instanceof HTMLImageElement&&this.startPreloadImageElement(e))}startPreloadVideoElement(e){p(e.src)||"auto"===e.preload&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)}startPreloadImageElement(e){u(e.src)||p(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static estimateTexMemRequired(r,i){if(a(r))return 0;if(e(r)||t(r))return r.byteLength;const{width:s,height:o}=r instanceof Image||r instanceof ImageData||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement?P.getDataDimensions(r):i;return(i.mipmap?4/3:1)*s*o*(i.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}createDescriptor(e){const t=this.params.mipmap&&!this.params.disableAnisotropy;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:t?e.parameters.maxMaxAnisotropy:void 0}}load(r,s){if(i(this.glTexture))return this.glTexture;if(i(this.loadingPromise))return this.loadingPromise;const o=this.data;return a(o)?(this.glTexture=new T(r,this.createDescriptor(r),null),r.bindTexture(this.glTexture,0),this.glTexture):"string"==typeof o?this.loadFromURL(r,s,o):o instanceof Image?this.loadFromImageElement(r,s,o):o instanceof HTMLVideoElement?this.loadFromVideoElement(r,s,o):o instanceof ImageData||o instanceof HTMLCanvasElement?this.loadFromImage(r,o,s):(e(o)||t(o))&&this.params.encoding===P.DDS_ENCODING?this.loadFromDDSData(r,o):t(o)?this.loadFromPixelData(r,o):e(o)?this.loadFromPixelData(r,new Uint8Array(o)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(e,t,r){if(!(this.data instanceof HTMLVideoElement)||a(this.glTexture))return r;if(this.data.readyState<2||r===this.data.currentTime)return r;if(i(this.powerOfTwoStretchInfo)){const{framebuffer:r,vao:a,sourceTexture:i}=this.powerOfTwoStretchInfo;i.setData(this.data),this.drawStretchedTexture(e,t,r,a,i,this.glTexture)}else{const{width:e,height:t}=this.data,{width:r,height:a}=this.glTexture.descriptor;e!==r||t!==a?this.glTexture.updateData(0,0,0,Math.min(e,r),Math.min(t,a),this.data):this.glTexture.setData(this.data)}return this.glTexture.descriptor.hasMipmap&&this.glTexture.generateMipmap(),this.data.currentTime}loadFromDDSData(e,t){return this.glTexture=C(e,this.createDescriptor(e),t,this.params.mipmap),e.bindTexture(this.glTexture,0),this.glTexture}loadFromPixelData(e,t){D(this.params.width>0&&this.params.height>0);const r=this.createDescriptor(e);return r.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408,r.width=this.params.width,r.height=this.params.height,this.glTexture=new T(e,r,t),e.bindTexture(this.glTexture,0),this.glTexture}async loadAsync(e){const t=s();this.loadingController=t;const r=e(t.signal);this.loadingPromise=r;const a=()=>{this.loadingController===t&&(this.loadingController=null),this.loadingPromise===r&&(this.loadingPromise=null)};return r.then(a,a),r}loadFromURL(e,t,r){return this.loadAsync((async a=>{const i=await w(r,{signal:a});return this.loadFromImage(e,i,t)}))}loadFromImageElement(e,t,r){return r.complete?this.loadFromImage(e,r,t):this.loadAsync((async a=>{const i=await c(r,r.src,!1,a);return this.loadFromImage(e,i,t)}))}loadFromVideoElement(e,t,r){return r.readyState>=2?this.loadFromImage(e,r,t):this.loadFromVideoElementAsync(e,t,r)}loadFromVideoElementAsync(e,t,r){return this.loadAsync((a=>o(((s,o)=>{const m=()=>{r.removeEventListener("loadeddata",d),r.removeEventListener("error",p),i(u)&&u.remove()},d=()=>{r.readyState>=2&&(m(),s(this.loadFromImage(e,r,t)))},p=e=>{m(),o(e||new l("Failed to load video"))};r.addEventListener("loadeddata",d),r.addEventListener("error",p);const u=n(a,(()=>p(h())))}))))}loadFromImage(e,t,r){const a=P.getDataDimensions(t);this.params.width=a.width,this.params.height=a.height;const i=this.createDescriptor(e);return i.pixelFormat=3===this.params.components?6407:6408,!this.requiresPowerOfTwo(e,i)||g(a.width)&&g(a.height)?(i.width=a.width,i.height=a.height,this.glTexture=new T(e,i,t),e.bindTexture(this.glTexture,0),this.glTexture):(this.glTexture=this.makePowerOfTwoTexture(e,t,a,i,r),e.bindTexture(this.glTexture,0),this.glTexture)}requiresPowerOfTwo(e,t){const r=33071,a="number"==typeof t.wrapMode?t.wrapMode===r:t.wrapMode.s===r&&t.wrapMode.t===r;return!x(e.gl)&&(t.hasMipmap||!a)}makePowerOfTwoTexture(e,t,r,a,i){const{width:s,height:o}=r,n=f(s),h=f(o);let l;switch(a.width=n,a.height=h,this.params.powerOfTwoResizeMode){case 2:a.textureCoordinateScaleFactor=[s/n,o/h],l=new T(e,a),l.updateData(0,0,0,s,o,t);break;case 1:case null:case void 0:l=this.stretchToPowerOfTwo(e,t,a,i);break;default:m(this.params.powerOfTwoResizeMode)}return a.hasMipmap&&l.generateMipmap(),l}stretchToPowerOfTwo(e,t,r,a){const i=new T(e,r),s=new M(e,{colorTarget:0,depthStencilTarget:0},i),o=new T(e,{target:3553,pixelFormat:r.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},t),n=F(e);return this.drawStretchedTexture(e,a,s,n,o,i),this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:n,sourceTexture:o,framebuffer:s}:(n.dispose(!0),o.dispose(),s.detachColorTexture(),e.bindFramebuffer(null),s.dispose()),i}drawStretchedTexture(e,t,r,a,i,s){e.bindFramebuffer(r);const o=e.getViewport();e.setViewport(0,0,s.descriptor.width,s.descriptor.height);const n=t.program;e.bindProgram(n),n.setUniform4f("color",1,1,1,1),n.setUniform1i("tex",0),e.bindTexture(i,0),e.bindVAO(a),e.setPipelineState(t.pipeline),e.drawArrays(5,0,y(a,"geometry")),e.bindFramebuffer(null),e.setViewport(o.x,o.y,o.width,o.height)}unload(){if(i(this.powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:r}=this.powerOfTwoStretchInfo;t.dispose(!0),r.dispose(),e.dispose(),this.glTexture=null,this.powerOfTwoStretchInfo=null}if(i(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null),i(this.loadingController)){const e=this.loadingController;this.loadingController=null,this.loadingPromise=null,e.abort()}this.events.emit("unloaded")}}P.idGen=new b,P.DDS_ENCODING="image/vnd-ms.dds";export{P as T};
