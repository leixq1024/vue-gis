/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import"./object.js";import{b as e,i as t}from"./Logger.js";import{resolve as a,whenOrAbort as i,eachAlways as r}from"../core/promiseUtils.js";import{hasField as n}from"../layers/support/fieldUtils.js";import{p as s}from"./screenUtils.js";import{t as l}from"../symbols/support/jsonUtils.js";import o from"../Graphic.js";import{a as c}from"./sizeVariableUtils.js";import{m as u}from"./lengthUtils.js";import{getVisualVariableValues as p}from"./visualVariableUtils.js";import{d as y}from"./diffUtils.js";import{getDisplayedSymbol as d}from"../symbols/support/symbolUtils.js";import{h as f}from"./hitTestSelectUtils.js";import{c as m,a as g}from"./drapedUtils.js";function b(e){const t=e.layer,a=function(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":return!0;default:return!1}}(t.renderer)&&p(t.renderer,e),i=a?a.map((e=>e.variable)):[],r=i.filter((e=>"rotation"===e.type&&(!e.axis||"heading"===e.axis))),n=r[0],s=1===r.length&&n.field&&!n.valueExpression,l=i.filter((e=>"size"===e.type)),o=l[0],u=1===l.length&&"real-world-size"===c(o)&&o.field&&!o.useSymbolValue&&!o.valueExpression;return{rotation:s?h(n,t):null,size:u?v(o,t):null}}function h(e,t){const i="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,r=e.field,n=t.fields&&t.fields.filter((e=>e.name===r)),s=n&&1===n.length?n[0].type:"double",l={initial:0,current:0};return{field:r,getDefault:()=>a(0),getValue:e=>(l.current=l.initial-i*e,w((l.current+360)%360,s)),initValue:e=>{l.initial=null!=e?e:l.current,l.current=0},isUpdatingInteractively:!1}}function v(t,a){const i=t.field,r=t.axis,n=a.fields&&a.fields.filter((e=>e.name===i)),s=n&&1===n.length?n[0].type:"double",o={updating:!1,initial:0,current:0},c=u[t.valueUnit];let p;return p="area"===t.valueRepresentation?e=>Math.pow(e*c/2,2)*Math.PI:"radius"===t.valueRepresentation||"distance"===t.valueRepresentation?e=>e*c/2:e=>e*c,{field:i,getDefault:async(t,a)=>w(p(await async function(t,a,i){if(e(a))return 0;const{symbol:r}=l(a);if(e(r)||"web-style"===r.type)return 0;const n=r.symbolLayers.getItemAt(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("./symbolLayerUtils.js");return n.size||Math.min(F.icon,(await e(n,F.icon))[0])||F.icon}case"text":return n.size||F.text;case"line":return n.size||F.line;case"object":{const{computeObjectLayerResourceSize:e}=await import("./symbolLayerUtils.js");return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await e(n,t.scale/F.viewScaleSizeFactor),i)}case"path":case"extrude":return n.size||t.scale/F.viewScaleSizeFactor;case"fill":case"water":default:return 0}}(a,t,r)),s),getValue:(e,t)=>(o.initial||(o.initial=t.pixelSizeAt(t.center)),o.current=o.initial*e,w(o.current,s)),initValue:e=>{o.initial=null!=e?e:o.current,o.current=0},isUpdatingInteractively:!1}}function w(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}async function j(e){const a=await d(e,{ignoreGraphicSymbol:!0}),i=y(e.symbol,a);t(i)&&(e.symbol=a)}async function I(t,a,i,r){const n=a.layer;await async function(t,a,i){var r;if("3d"!==i.type)return;const n=a.layer,s={...a.template.prototype.attributes},l=new o({layer:n,sourceLayer:n,attributes:s}),{rotation:c,size:u}=b(l);let p=await d(l),y=!1;for(const t of[u,c]){if(e(t))continue;null==s[t.field]&&(s[t.field]=await t.getDefault(p,i),y=!0)}y&&(p=await d(l));switch(null==(r=p)?void 0:r.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=p;break;case"simple-line":case"line-3d":t.polylineSymbol=p;break;case"simple-marker":case"point-3d":t.pointSymbol=p}}(t,a,i),t.layer.elevationInfo=n.elevationInfo;const s=()=>t.create(n.geometryType,{hasZ:n.capabilities.data.supportsZ});await s();const l=t.on("create",(async e=>{const{state:i,graphic:l}=e;if("cancel"!==i){if("complete"===i){const e=l.clone();e.attributes={...a.template.prototype.attributes},e.layer=n,t.layer.remove(l),await j(e),r(e)}}else s()}));return i.map.add(t.layer),{remove:()=>{l.remove(),i.map.remove(t.layer),t.cancel()}}}function U(e,t){return e&&e.find((e=>e.layer===t))}async function S(e,t,a,s){if(0===e.length)return[];const{updatable:l,graphicsByLayer:o}=await a.async((async()=>{const{results:r}=await i(f(t,a),s),n=new Map;r.forEach((({graphic:e})=>(({layer:e})=>{const t=n.get(e);if(!t){const t=new Array;return n.set(e,t),t}return t})(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.indexOf("update")>-1&&n.has(t)));return 0!==l.length&&a.stopPropagation(),{updatable:l,graphicsByLayer:n}}));return r(l.map((async({layer:e})=>{const{objectIdField:t,displayField:a}=e,i=[t];n(e.fields,a)&&i.push(a);const r=o.get(e);if(!!r.some((e=>i.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=i,t.returnGeometry=!1,t.objectIds=r.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:s}).then((({features:e})=>e))}return r})),s)}async function V(e,t,a,s){switch(t.type){case"3d":return S(e,t,a,s);case"2d":return async function(e,t,a,s){if(0===e.length)return[];const{results:l}=await i(t.hitTest(a),s);if(0===l.length)return[];const o=new Set;return l.forEach((({graphic:e})=>o.add(e.layer))),r(e.items.filter((({layer:e,supports:t})=>t.indexOf("update")>-1&&o.has(e))).map((({layer:e})=>{const{objectIdField:i,displayField:r}=e,l=[i];n(e.fields,r)&&l.push(r);const o=e.createQuery();o.outFields=l,o.returnGeometry=!1;const c=m({renderer:e.renderer,event:a});return o.geometry=g(a.mapPoint,c,t),e.queryFeatures(o,{signal:s}).then((({features:e})=>e))})),s)}(e,t,a,s)}}async function x(e,t,a){const i=e.layer,r=i.createQuery();return r.objectIds=[e.getAttribute(i.objectIdField)],r.outFields=["*"],r.outSpatialReference=t.spatialReference,r.returnM=i.capabilities.data.supportsM,r.returnZ=i.capabilities.data.supportsZ,(await i.queryFeatures(r,{signal:a})).features[0]}async function z(a,i,r,n,s){const l=a.clone();await j(l),r.layer.add(l),l.sourceLayer=a.layer;const o=(()=>{const{layer:e}=a;if("graphics"===e.type)return{remove(){}};const{objectIdField:t}=e,i=a.attributes[t],r=n.whenLayerView(e);return r.then((e=>e.setVisibility(i,!1)),(()=>{})),{remove(){r.then((e=>e.setVisibility(i,!0)),(()=>{}))}}})(),c=a.layer,u=i.size,p=i.rotation,y={multipleSelectionEnabled:!1};"point"===c.geometryType&&(y.enableRotation=!!p,y.enableScaling=!!u),r.layer.elevationInfo=c.elevationInfo,r.update(l,y);const d=(t(u)||t(p))&&a.watch("attributes",(async e=>{let a=!1;for(const i in e){const r=e[i];r!==l.attributes[i]&&(l.setAttribute(i,r),a=!0,t(u)&&!u.isUpdatingInteractively&&u.field===i&&u.initValue(r),t(p)&&!p.isUpdatingInteractively&&p.field===i&&p.initValue(r))}a&&"3d"===n.type&&await j(l)}));[p,u].forEach((async t=>{if(e(t))return;const i=a.attributes[t.field];if(null!=i)t.initValue(i);else{const e=await t.getDefault(l.symbol,n);t.initValue(e),l.setAttribute(t.field,e),"3d"===n.type&&await j(l)}}));const f=r.on("update",(async e=>{const{graphics:[a],state:i,toolEventInfo:o}=e;if("complete"===i)return void r.update(a,y);const c=o;if(t(p)&&c){const{field:e,getValue:t,initValue:a}=p;"rotate-stop"===c.type?(p.isUpdatingInteractively=!1,a()):null!=c.angle&&(p.isUpdatingInteractively=!0,l.attributes[e]=t(c.angle/Math.PI*180,n))}const d=o;if(t(u)&&d){const{field:e,getValue:t,initValue:a}=u;"scale-stop"===d.type?(u.isUpdatingInteractively=!1,a()):null!=d.xScale&&(u.isUpdatingInteractively=!0,l.attributes[e]=t(d.xScale,n))}"3d"===n.type&&await j(l),s(a.clone())}));n.map.add(r.layer);const m=()=>{};return{interactive:{remove(){f.remove(),r.cancel(),d&&d.remove(),this.remove=m}},visual:{remove(){o.remove(),n.map.remove(r.layer),r.layer.removeAll(),this.remove=m}}}}const F={icon:s(24),text:s(12),line:s(1),viewScaleSizeFactor:100};export{z as a,V as b,x as c,U as f,b as g,I as s};
