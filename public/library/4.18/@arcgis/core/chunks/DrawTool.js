/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"./object.js";import{i as t,b as i,u as r,c as s}from"./Logger.js";import{h as n,j as o,f as a}from"./metadata.js";import{property as h}from"../core/accessorSupport/decorators/property.js";import l from"../core/Accessor.js";import"./ensureType.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{E as d}from"./Evented.js";import p from"../core/Collection.js";import{a as u}from"./JSONSupport.js";import"../core/urlUtils.js";import"./resourceExtension.js";import{g}from"../geometry/SpatialReference.js";import m from"../geometry/Point.js";import{c as f,n as y,s as v}from"./mathUtils2.js";import{f as _,c as x,b as w}from"./vec3f64.js";import{b,g as S,c as T,u as E,o as P,f as V,n as R,a as H}from"./vec3.js";import O from"../Color.js";import C from"../geometry/Polygon.js";import j from"../geometry/Polyline.js";import"../geometry.js";import{b as I,c as z}from"./screenUtils.js";import L from"../core/Handles.js";import{init as A,watch as M}from"../core/watchUtils.js";import{projectVectorToVector as D}from"../geometry/projection.js";import{c as k,f as F,a as G}from"./vec4f64.js";import{I as N}from"./quatf64.js";import{m as Z,d as q,f as U,p as W,a as B,b as X,l as Y,i as J,q as K,g as Q,s as $,j as ee}from"./vec2.js";import{l as te,e as ie,c as re}from"./vec4.js";import{k as se}from"./aaBoundingBox.js";import{m as ne}from"./dehydratedFeatures.js";import{c as oe,f as ae,d as he}from"./vec2f64.js";import{J as le,u as ce,r as de,K as pe,w as ue,L as ge,M as me,c as fe}from"./geometryUtils.js";import{R as ye,G as ve,f as _e,L as xe}from"./ColorMaterial.js";import{V as we}from"./Util.js";import{G as be}from"./Geometry.js";import{H as Se,i as Te,E as Ee}from"./sdfPrimitives.js";import{O as Pe}from"./Object3D.js";import{e as Ve}from"./elevationAlignmentUtils.js";import{T as Re}from"./Texture.js";import{f as He,a as Oe}from"./vec4f32.js";import{g as Ce,a as je,b as Ie}from"./elevationInfoUtils.js";import{c as ze,I as Le}from"./InteractiveToolBase.js";import{O as Ae,L as Me,R as De}from"./RightAngleQuadVisualElement.js";class ke{constructor(e,t){this.spatialReference=e,this.viewingMode=t,this._unnormalizationInfo=qe(e,t)}tag(e){return e}createNew(){return this.tag(oe())}fromPoint(e){return this.tag(ae(e.x,e.y))}fromArray(e){return this.tag(ae(e[0],e[1]))}toArray(e){return[e[0],e[1]]}clone(e){return this.tag(he(e))}toPoint(e,t){return t.x=e[0],t.y=e[1],t.hasZ=!1,t.hasM=!1,t.spatialReference=this.spatialReference,t}createPoint(e){return new m({x:e[0],y:e[1],z:void 0,m:void 0,spatialReference:this.spatialReference})}createPointFromArray(e){return new m({x:e[0],y:e[1],z:void 0,m:void 0,spatialReference:this.spatialReference})}createDehydratedPoint(e){return{x:e[0],y:e[1],z:void 0,m:void 0,hasZ:!1,hasM:!1,spatialReference:this.spatialReference,type:"point"}}lerp(e,t,i,r){return Z(r,e,t,i)}addDelta(e,t,i){e[0]+=t,e[1]+=i}pointToArray(e){return[e.x,e.y]}zFromArray(e){}hasZ(){return!1}unnormalize(e){Ze(e,this._unnormalizationInfo)}fromXYZ(e){return this.tag(ae(e[0],e[1]))}toXYZ(e,t=0){return _(e[0],e[1],t)}}class Fe{constructor(e,t,i){this.valueType=e,this.spatialReference=t,this._unnormalizationInfo=qe(t,i)}tag(e){return e}createNew(){return this.tag(x())}fromPoint(e){return this.tag(_(e.x,e.y,0===this.valueType?e.z:e.m))}fromArray(e){return this.tag(_(e[0],e[1],e[2]||0))}toArray(e){return[e[0],e[1],e[2]]}clone(e){return this.tag(w(e))}toPoint(e,t){return t.x=e[0],t.y=e[1],0===this.valueType?(t.z=e[2],t.hasZ=!0,t.hasM=!1):(t.m=e[2],t.hasZ=!1,t.hasM=!0),t.spatialReference=this.spatialReference,t}createPoint(e){return new m({x:e[0],y:e[1],z:0===this.valueType?e[2]:void 0,m:1===this.valueType?e[2]:void 0,spatialReference:this.spatialReference})}createPointFromArray(e){return new m({x:e[0],y:e[1],z:0===this.valueType?e[2]:void 0,m:1===this.valueType?e[2]:void 0,spatialReference:this.spatialReference})}createDehydratedPoint(e){const t=0===this.valueType,i=1===this.valueType;return{x:e[0],y:e[1],z:t?e[2]:void 0,m:i?e[2]:void 0,hasZ:t,hasM:i,spatialReference:this.spatialReference,type:"point"}}lerp(e,t,i,r){return b(r,e,t,i)}addDelta(e,t,i,r){e[0]+=t,e[1]+=i,0===this.valueType&&(e[2]+=r)}pointToArray(e){return 0===this.valueType?[e.x,e.y,e.z]:[e.x,e.y,e.m]}zFromArray(e){return 0===this.valueType?e[2]:void 0}hasZ(){return 0===this.valueType}unnormalize(e){Ze(e,this._unnormalizationInfo)}fromXYZ(e,t=0,i=0){return this.tag(_(e[0],e[1],0===this.valueType?e.length>2?e[2]:t:i))}toXYZ(e,t=0){return this.tag(_(e[0],e[1],0===this.valueType?e[2]:t))}}class Ge{constructor(e,t){this.spatialReference=e,this._unnormalizationInfo=qe(e,t)}tag(e){return e}createNew(){return this.tag(k())}fromPoint(e){return this.tag(F(e.x,e.y,e.z,e.m))}fromArray(e){return this.tag(F(e[0],e[1],e[2]||0,e[3]||0))}toArray(e){return[e[0],e[1],e[2],e[3]]}clone(e){return this.tag(G(e))}toPoint(e,t){return t.x=e[0],t.y=e[1],t.z=e[2],t.m=e[3],t.hasZ=!0,t.hasM=!0,t.spatialReference=this.spatialReference,t}createPoint(e){return new m({x:e[0],y:e[1],z:e[2],m:e[3],spatialReference:this.spatialReference})}createPointFromArray(e){return new m({x:e[0],y:e[1],z:e[2],m:e[3],spatialReference:this.spatialReference})}createDehydratedPoint(e){return{x:e[0],y:e[1],z:e[2],m:e[3],hasZ:!0,hasM:!0,spatialReference:this.spatialReference,type:"point"}}lerp(e,t,i,r){return te(r,e,t,i)}addDelta(e,t,i,r){e[0]+=t,e[1]+=i,e[2]+=r}pointToArray(e){return[e.x,e.y,e.z,e.m]}zFromArray(e){return e[2]}hasZ(){return!0}unnormalize(e){Ze(e,this._unnormalizationInfo)}fromXYZ(e,t=0,i=0){return this.tag(F(e[0],e[1],e.length>2?e[2]:t,i))}toXYZ(e){return _(e[0],e[1],e[2])}}function Ne(e,t,i,r){return e&&t?new Ge(i,r):t?new Fe(1,i,r):e?new Fe(0,i,r):new ke(i,r)}function Ze(e,t){if(!t.supported)return;let i=1/0,r=-1/0;const s=t.upperBoundX-t.lowerBoundX;e.forEach((e=>{let n=e.pos[0];for(;n<t.lowerBoundX;)n+=s;for(;n>t.upperBoundX;)n-=s;i=Math.min(i,n),r=Math.max(r,n),e.pos[0]=n}));const n=r-i;s-n<n&&e.forEach((e=>{e.pos[0]<0&&(e.pos[0]+=s)}))}function qe(e,t){const i=g(e);return"global"===t&&i?{supported:!0,lowerBoundX:i.valid[0],upperBoundX:i.valid[1]}:{supported:!1,lowerBoundX:null,upperBoundX:null}}class Ue{constructor({grabbableForEvent:e}){this.events=new d,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=e}intersectionDistance(e,t){return 0}attach(){}detach(){}}class We{constructor(e,t,i){this.elevationInfo=e,this.defaultZ=t,this.view=i}screenToMap(e){if(t(this.defaultZ))return this.view.sceneIntersectionHelper.intersectElevationFromScreen(I(e.x,e.y),this.elevationInfo,this.defaultZ);const i=this.view.sceneIntersectionHelper.intersectElevationFromScreen(I(e.x,e.y),this.elevationInfo,0);return t(i)&&(i.z=void 0),i}mapToScreen(e){const t=ne(e.x,e.y,je(this.view,e,this.elevationInfo),e.spatialReference);return this.view.toScreen(t)}}class Be{constructor(e,t,i=[]){this.view=e,this.elevationInfo=t,this.exclude=i}screenToMap(e){const i=this.view.toMap(e,{exclude:this.exclude});return t(i)&&(i.z=Ce(i,this.view,this.elevationInfo)),i}mapToScreen(e){let i=e;return t(this.elevationInfo)&&(i=ne(e.x,e.y,je(this.view,e,this.elevationInfo),e.spatialReference)),this.view.toScreen(i)}}class Xe{constructor(e){this.left=null,this.right=null,this.type="vertex",this.index=null,this.component=e}get pos(){return this._pos}set pos(e){this._pos=e,this.component.unnormalizeVertexPositions()}}class Ye{constructor(e,t,i){this.type="edge",this.component=e,this.left=t,this.right=i,t.right=this,i.left=this}}class Je{constructor(e){this.vertices=[],this.edges=[],this.data=e}unnormalizeVertexPositions(){this.vertices.length<=1||this.data.coordinateHelper.unnormalize(this.vertices)}updateVertexIndex(e,t){if(0===this.vertices.length)return;const i=this.vertices[0];let r=null,s=e,n=t;do{r=s,r.index=n++,s=r.right?r.right.right:null}while(null!=s&&s!==i);r.left&&r!==this.vertices[this.vertices.length-1]&&this.swapVertices(this.vertices.indexOf(r),this.vertices.length-1)}findEndVertex(){return 0===this.vertices.length?null:this.vertices[this.vertices.length-1]}swapVertices(e,t){const i=this.vertices[e];this.vertices[e]=this.vertices[t],this.vertices[t]=i}}class Ke{constructor(e){this.coordinateHelper=e,this.undoStack=[],this.redoStack=[],this.components=[]}apply(e){e.apply(),this.undoStack.push(e),this.redoStack=[]}undo(){if(this.undoStack.length>0){const e=this.undoStack.pop();e.undo(),this.redoStack.push(e)}}get canUndo(){return this.undoStack.length>0}get lastOperation(){return this.undoStack.length>0?this.undoStack[this.undoStack.length-1]:null}redo(){if(this.redoStack.length>0){const e=this.redoStack.pop();e.apply(),this.undoStack.push(e)}}get canRedo(){return this.redoStack.length>0}toPoint(){return 0===this.components.length||0===this.components[0].vertices.length?null:this.coordinateHelper.createPoint(this.components[0].vertices[0].pos)}toPolyline(){const e=[],t=this.coordinateHelper.toArray;return this.components.forEach(((i,r)=>{const s=[];let n=i.vertices.find((e=>null==e.left));const o=n;do{s.push(t(n.pos)),n=n.right?n.right.right:null}while(n&&n!==o);e.push(s)})),new j({paths:e,spatialReference:this.coordinateHelper.spatialReference})}toPolygon(){const e=[],t=this.coordinateHelper.toArray;return this.components.forEach(((i,r)=>{const s=[],n=i.vertices[0];let o=n;const a=o;do{s.push(t(o.pos)),o=o.right.right}while(o&&o!==a);s.push(t(n.pos)),e.push(s)})),new C({rings:e,spatialReference:this.coordinateHelper.spatialReference})}static fromGeometry(e,t){const i=Ne(e.hasZ,e.hasM,e.spatialReference,t),r=new Ke(i);switch(e.type){case"polygon":{const t=e.rings;for(let e=0;e<t.length;++e){const s=t[e],n=new Je(r),o=s.length-1;for(let e=0;e<o;++e){const t=i.fromArray(s[e]),r=new Xe(n);n.vertices.push(r),r.pos=t,r.index=e}const a=n.vertices.length-1;for(let e=0;e<a;++e){const t=n.vertices[e],i=n.vertices[e+1],r=new Ye(n,t,i);n.edges.push(r)}const h=new Ye(n,n.vertices[n.vertices.length-1],n.vertices[0]);n.edges.push(h),r.components.push(n)}}break;case"polyline":{const t=e.paths;for(let e=0;e<t.length;++e){const s=t[e],n=new Je(r),o=s.length;for(let e=0;e<o;++e){const t=i.fromArray(s[e]),r=new Xe(n);n.vertices.push(r),r.pos=t,r.index=e}const a=n.vertices.length-1;for(let e=0;e<a;++e){const t=n.vertices[e],i=n.vertices[e+1],r=new Ye(n,t,i);n.edges.push(r)}r.components.push(n)}}}return r}}class Qe extends d{constructor(e,t){super(),this.data=e,this.type=t,this._dirty=!0,this._geometry=null}splitEdge(e,t){const i=new $e(this,e,t);return this.data.apply(i),this._dirty=!0,i}moveVertices(e,t,i,r){let s=null;return this.data.lastOperation instanceof et&&this.data.lastOperation.canAccumulate(e)?(s=this.data.lastOperation,s.accumulate(t,i,r)):(s=new et(this,e,t,i,r),this.data.apply(s)),this._dirty=!0,s}removeVertices(e){let t=0;switch(this.type){case"point":t=1;break;case"polyline":t=2;break;case"polygon":t=3}const i=new tt(this,e,t);return this.data.apply(i),this._dirty=!0,i}appendVertex(e){if(0===this.data.components.length)return null;const t=new it(this,this.data.components[0],e);return this.data.apply(t),this._dirty=!0,t}canRemoveVertex(){let e=0;switch(this.type){case"point":e=1;break;case"polyline":e=2;break;case"polygon":e=3}return this.data.components[0].vertices.length>e}undo(){this.data.undo(),this._dirty=!0}get canUndo(){return this.data.canUndo}redo(){this.data.redo(),this._dirty=!0}get canRedo(){return this.data.canRedo}get geometry(){if(this._dirty){switch(this.type){case"point":this._geometry=this.data.toPoint();break;case"polyline":this._geometry=this.data.toPolyline();break;case"polygon":this._geometry=this.data.toPolygon()}this._dirty=!1}return this._geometry}}class $e{constructor(e,t,i){this.helper=e,this.edge=t,this.t=i,this.createdVertex=null,this.left=null,this.right=null}apply(){let e="redo";const t=this.edge,r=t.component,s=t.component.data,n=t.left,o=t.right;r.edges.splice(r.edges.indexOf(t),1),i(this.createdVertex)&&(e="apply",this.createdVertex=new Xe(t.component)),r.vertices.push(this.createdVertex),this.createdVertex.pos=s.coordinateHelper.lerp(t.left.pos,t.right.pos,this.t,s.coordinateHelper.createNew()),i(this.left)&&(this.left=new Ye(r,n,this.createdVertex)),this.left.left.left?r.edges.push(this.left):r.edges.unshift(this.left),n.right=this.left,i(this.right)&&(this.right=new Ye(r,this.createdVertex,o)),r.edges.push(this.right),o.left=this.right,r.updateVertexIndex(this.createdVertex,n.index+1);const a={type:"vertex-add",vertices:[this.createdVertex],operation:e};this.helper.emit("vertex-add",a)}undo(){if(i(this.createdVertex)||i(this.left)||i(this.right))return null;const e=this.edge,t=e.component,r=this.createdVertex.left,s=this.createdVertex.right,n=r.left,o=s.right;t.vertices.splice(t.vertices.indexOf(this.createdVertex),1),t.edges.splice(t.edges.indexOf(this.left),1),t.edges.splice(t.edges.indexOf(this.right),1),this.edge.left.left?t.edges.push(this.edge):t.edges.unshift(this.edge),n.right=e,o.left=e,t.updateVertexIndex(n,n.index);const a={type:"vertex-remove",vertices:[this.createdVertex],operation:"undo"};this.helper.emit("vertex-remove",a)}}class et{constructor(e,t,i,r,s){this.helper=e,this.applied=!1,this.vertices=t,this.dx=i,this.dy=r,this.dz=s}apply(){this.vertices.forEach((e=>{this.helper.data.coordinateHelper.addDelta(e.pos,this.dx,this.dy,this.dz)})),this.helper.data.components.forEach((e=>{e.unnormalizeVertexPositions()}));const e={type:"vertex-update",vertices:this.vertices,operation:this.applied?"redo":"apply"};this.helper.emit("vertex-update",e),this.applied=!0}undo(){this.vertices.forEach((e=>{this.helper.data.coordinateHelper.addDelta(e.pos,-this.dx,-this.dy,-this.dz)}));const e={type:"vertex-update",vertices:this.vertices,operation:"undo"};this.helper.emit("vertex-update",e)}canAccumulate(e){if(e.length!==this.vertices.length)return!1;for(let t=0;t<e.length;++t)if(e[t]!==this.vertices[t])return!1;return!0}accumulate(e,t,i){this.vertices.forEach((r=>{this.helper.data.coordinateHelper.addDelta(r.pos,e,t,i)})),this.dx+=e,this.dy+=t,this.dz+=i;const r={type:"vertex-update",vertices:this.vertices,operation:"apply"};this.helper.emit("vertex-update",r)}}class tt{constructor(e,t,i=0){this.helper=e,this.removedVertices=null,this._minNumberOfVertices=0,this.vertices=t,this._minNumberOfVertices=i}apply(){let e="redo";null==this.removedVertices?(this.removedVertices=[],this.vertices.forEach((e=>{const i=this._removeVertex(e);t(i)&&this.removedVertices.push(i)})),e="apply"):this.removedVertices.forEach((e=>{this._redoRemoveVertex(e)}));const i={type:"vertex-remove",vertices:this.vertices,operation:e};this.helper.emit("vertex-remove",i)}undo(){this.removedVertices.forEach((e=>{this._undoRemoveVertex(e)}));const e={type:"vertex-add",vertices:this.vertices,operation:"undo"};this.helper.emit("vertex-add",e)}_removeVertex(e){const t=e.component;if(t.vertices.length<=this._minNumberOfVertices)return null;const i={removedVertex:e,createdEdge:null},r=e.left,s=e.right;return t.vertices.splice(t.vertices.indexOf(e),1),r&&(t.edges.splice(t.edges.indexOf(r),1),r.left.right=null),s&&(t.edges.splice(t.edges.indexOf(s),1),s.right.left=null),0===e.index&&s&&this.vertices.length>0&&t.swapVertices(t.vertices.indexOf(s.right),0),r&&s&&(i.createdEdge=new Ye(t,r.left,s.right),t.edges.push(i.createdEdge)),s&&t.updateVertexIndex(s.right,s.right.index-1),i}_redoRemoveVertex(e){console.warn("redo remove vertex not implemented yet")}_undoRemoveVertex(e){const t=e.removedVertex,i=e.removedVertex.component,r=t.left,s=t.right;e.createdEdge&&i.edges.splice(i.edges.indexOf(e.createdEdge),1),i.vertices.push(t),r&&(i.edges.push(r),r.left.right=r),s&&(i.edges.push(s),s.right.left=s),i.updateVertexIndex(t,t.index)}}class it{constructor(e,t,i){this.helper=e,this.component=t,this.pos=i,this.addedVertex=null,this.originalEdge=null,this.left=null,this.right=null}apply(){let e="redo";if(i(this.addedVertex)&&(e="apply",this.addedVertex=new Xe(this.component)),0===this.component.vertices.length)this.component.vertices.push(this.addedVertex),this.addedVertex.pos=this.pos,this.addedVertex.index=0;else{const e=r(this.component.findEndVertex());let s=null;e.right&&(this.originalEdge=e.right,s=this.originalEdge.right,this.component.edges.splice(this.component.edges.indexOf(this.originalEdge),1)),this.component.vertices.push(this.addedVertex),this.addedVertex.pos=this.pos,i(this.left)&&(this.left=new Ye(this.component,e,this.addedVertex)),this.component.edges.push(this.left),e.right=this.left,t(this.originalEdge)&&t(s)&&(i(this.right)&&(this.right=new Ye(this.component,this.addedVertex,s)),this.component.edges.push(this.right),s.left=this.right),this.component.updateVertexIndex(this.addedVertex,e.index+1)}const s={type:"vertex-add",vertices:[this.addedVertex],operation:e};this.helper.emit("vertex-add",s)}undo(){if(i(this.addedVertex))return null;this.component.vertices.splice(this.component.vertices.indexOf(this.addedVertex),1),t(this.left)&&(this.component.edges.splice(this.component.edges.indexOf(this.left),1),this.left.left.right=null),t(this.right)&&(this.component.edges.splice(this.component.edges.indexOf(this.right),1),this.right.right.left=null),t(this.originalEdge)&&(this.component.edges.push(this.originalEdge),this.originalEdge.left.right=this.originalEdge,this.originalEdge.right.left=this.originalEdge),t(this.left)?this.component.updateVertexIndex(this.left.left,this.left.left.index):this.component.updateVertexIndex(this.addedVertex,0);const e={type:"vertex-remove",vertices:[this.addedVertex],operation:"undo"};this.helper.emit("vertex-remove",e)}}const rt=["freehand","hybrid","click"],st="click";let nt=class extends u{constructor(){super(...arguments),this.enabled=!0}};e([h({type:Boolean})],nt.prototype,"enabled",void 0),nt=e([c("esri.views.3d.interactive.editingTools.snapping.Settings.LineSnapperDefaults")],nt);let ot=class extends u{constructor(){super(...arguments),this.enabled=!0}};e([h({type:Boolean})],ot.prototype,"enabled",void 0),ot=e([c("esri.views.3d.interactive.editingTools.snapping.Settings.ParallelLineSnapperDefaults")],ot);let at=class extends u{constructor(){super(...arguments),this.enabled=!0}};e([h({type:Boolean})],at.prototype,"enabled",void 0),at=e([c("esri.views.3d.interactive.editingTools.snapping.Settings.RightAngleSnapperDefaults")],at);let ht=class extends u{constructor(){super(...arguments),this.enabled=!0}};e([h({type:Boolean})],ht.prototype,"enabled",void 0),ht=e([c("esri.views.3d.interactive.editingTools.snapping.Settings.RightAngleTriangleSnapperDefaults")],ht);let lt=class extends u{constructor(e){super(e),this.lineSnapper=new nt,this.parallelLineSnapper=new ot,this.rightAngleSnapper=new at,this.rightAngleTriangleSnapper=new ht,this.shortLineThreshold=15,this.lineProximityThreshold=5,this.circleProximityThreshold=5,this.pointProximityThreshold=5,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new O([255,127,0]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5}};e([h({type:nt,constructOnly:!0,nonNullable:!0,json:{write:!0}})],lt.prototype,"lineSnapper",void 0),e([h({type:ot,constructOnly:!0,nonNullable:!0,json:{write:!0}})],lt.prototype,"parallelLineSnapper",void 0),e([h({type:at,constructOnly:!0,nonNullable:!0,json:{write:!0}})],lt.prototype,"rightAngleSnapper",void 0),e([h({type:ht,constructOnly:!0,nonNullable:!0,json:{write:!0}})],lt.prototype,"rightAngleTriangleSnapper",void 0),e([h({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],lt.prototype,"shortLineThreshold",void 0),e([h({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],lt.prototype,"lineProximityThreshold",void 0),e([h({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],lt.prototype,"circleProximityThreshold",void 0),e([h({type:Number,nonNullable:!0,range:{min:1,max:50,step:1},json:{write:!0}})],lt.prototype,"pointProximityThreshold",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],lt.prototype,"intersectionParallelLineThreshold",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],lt.prototype,"parallelLineThreshold",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],lt.prototype,"touchSensitivityMultiplier",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],lt.prototype,"pointOnLineThreshold",void 0),e([h({type:O,nonNullable:!0})],lt.prototype,"orange",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],lt.prototype,"lineHintWidthReference",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],lt.prototype,"lineHintWidthTarget",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],lt.prototype,"lineHintFadedExtensions",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],lt.prototype,"parallelLineHintWidth",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],lt.prototype,"parallelLineHintLength",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],lt.prototype,"parallelLineHintOffset",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],lt.prototype,"rightAngleHintSize",void 0),e([h({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],lt.prototype,"rightAngleHintOutlineSize",void 0),lt=e([c("esri.views.3d.interactive.editingTools.snapping.Settings.Defaults")],lt);const ct=new lt;class dt extends Ae{constructor(e){super(e),this._ray=de.create(),this._externalResources=null,this._handles=new L,this._isWorldDown=!1,this._start=x(),this._end=_(1,0,0),this._width=1,this._color=He(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=He(1,1,1,1),this._stippleIntegerRepeats=!0,this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._extensionType=0,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=4,this._fadedExtensions=ft,this.applyProps(e)}createExternalResources(){const e=new ye(this.materialParameters,"lineVisualElement");this._handles.add(this.view.state.watch("camera",(()=>{this.updateGeometry()})));const t=new Me({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:t}}destroyExternalResources(){t(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalResource(e){t(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const t=[x(),x()],i=3===this.extensionType;i&&t.push(x(),x());const s=new be(ve.createPolylineGeometry(t),"lineVisualElement");i&&(s.data.vertexAttributes[_e.COLOR]={size:4,data:new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]),offsetIdx:0,strideIdx:4},s.data.indices[_e.COLOR]=new Uint32Array([0,1,2,3])),e.addGeometry(s,r(this._externalResources).material),this.updateVertices(s)}updateVisibility(e){super.updateVisibility(e),t(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,S(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),T(this._end,e,this._end),de.fromPoints(this._start,this._end,this._ray),this.updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,E(this._start,e)||(S(this._start,e),de.fromPoints(this._start,this._end,this._ray),this.updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,E(this._end,e)||(S(this._end,e),de.fromPoints(this._start,this._end,this._ray),this.updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get color(){return this._color}set color(e){ie(e,this._color)||(re(this._color,e),this.updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this.updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this.updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){ie(e,this._innerColor)||(re(this._innerColor,e),this.updateMaterial())}get stippleIntegerRepeats(){return this._stippleIntegerRepeats}set stippleIntegerRepeats(e){e!==this._stippleIntegerRepeats&&(this._stippleIntegerRepeats=e,this.updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=t(e)!==t(this._stipplePattern);this._stipplePattern=e,i?this.recreate():this.updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(i(e)||i(this._stippleOffColor)||!ie(e,this._stippleOffColor))&&(this._stippleOffColor=t(e)?Oe(e):null,this.updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&t(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,t(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,t(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,t(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=s(e,ft),this.recreateGeometry()}updateMaterial(){if(i(this._externalResources))return;this._externalResources.material.setParameterValues(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stippleIntegerRepeats:this._stippleIntegerRepeats,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}updateGeometry(){t(this.object)&&this.updateVertices(this.object.geometries[0])}updateVertices(e){const i=3===this._extensionType?this.updateLineSegmentFinite(mt):this.updateLineSegmentInfinite(this._extensionType,mt);this.updateVertexAttributes(e,i),t(this._externalResources)&&(this._externalResources.laserline.intersectsLine=i)}updateLineSegmentFinite(e){return ce.fromPoints(this._start,this._end,e)}updateLineSegmentInfinite(e,t){const i=this.view.state.camera;switch(pe(this._ray,pt),e){case 0:pt.c0=-Number.MAX_VALUE;break;case 1:case 2:{const e=this._ray.origin,t=this.view.elevationProvider.getElevation(e[0],e[1],e[2],this.view.renderCoordsHelper.spatialReference,"ground")||0,i=this.view.renderCoordsHelper.getAltitude(e);this._isWorldDown&&i<t&&P(pt.ray.direction,pt.ray.direction),2===this._extensionType&&null!=t&&(pt.c1=Math.abs(i-t));break}}if(!ue.intersectClipRay(i.frustum.planes,pt))return ce.fromPoints(this._start,this._end,t);const r=ge(pt,ut),s=me(pt,gt);return ce.fromPoints(r,s,t)}updateVertexAttributes(e,i){const r=e.data.getVertexAttr()[_e.POSITION].data;if(3===this.extensionType){{const e=ce.pointAt(i,-this.fadedExtensions.start,ut);r[0]=e[0],r[1]=e[1],r[2]=e[2]}{const e=ce.pointAt(i,0,ut);r[3]=e[0],r[4]=e[1],r[5]=e[2]}{const e=ce.pointAt(i,1,ut);r[6]=e[0],r[7]=e[1],r[8]=e[2]}{const e=ce.pointAt(i,1+this.fadedExtensions.end,ut);r[9]=e[0],r[10]=e[1],r[11]=e[2]}}else{{const e=ce.pointAt(i,0,ut);r[0]=e[0],r[1]=e[1],r[2]=e[2]}{const e=ce.pointAt(i,1,ut);r[3]=e[0],r[4]=e[1],r[5]=e[2]}}t(this.object)&&this.object.geometryVertexAttrsUpdated(0)}}const pt=le(),ut=x(),gt=x(),mt=ce.create(),ft={start:.3333333333333333,end:.3333333333333333};function yt(e,t){const i=e.x-t.x,r=e.y-t.y;return i*i+r*r}function vt(e,t){const i=e.length===t.length&&e[0]===t[0]&&e[1]===t[1];switch(e.length){case 2:return i;case 3:return i&&e[2]===t[2];case 4:return i&&e[3]===t[3]}return!1}function _t(e,t,i,r){return xt(e,t,i,r,Tt),r.state.camera.projectToScreen(Tt,Et),z(Et[0],Et[1])}function xt(e,t,i,r,s=x()){const n=t.toXYZ(e);return n[2]=Ie(r,n,t.spatialReference,i),r.renderCoordsHelper.toRenderCoords(n,t.spatialReference,s),s}function wt(e,t,i,r,s,n){return bt(e,n,xt(t,r,s,n),xt(i,r,s,n))}function bt(e,t,i,r,s=!0,n=!0){const o=new dt({view:t,extensionType:3,start:i,end:r,color:O.toUnitRGBA(ct.orange),renderOccluded:16});switch(e){case 0:o.width=ct.lineHintWidthTarget,o.fadedExtensions={start:0,end:ct.lineHintFadedExtensions};break;case 3:o.width=ct.lineHintWidthReference,o.fadedExtensions={start:0,end:0};break;case 1:case 2:o.width=ct.lineHintWidthReference,o.fadedExtensions={start:s?ct.lineHintFadedExtensions:0,end:n?ct.lineHintFadedExtensions:0}}return o.attached=!0,o}function St(e,t,i,r,s,n){return new De({view:n,attached:!0,color:O.toUnitRGBA(ct.orange),renderOccluded:2,outlineRenderOccluded:16,outlineColor:O.toUnitRGBA(ct.orange),outlineSize:ct.rightAngleHintOutlineSize,size:ct.rightAngleHintSize,geometry:{previous:xt(e,r,s,n),center:xt(t,r,s,n),next:xt(i,r,s,n)}})}const Tt=x(),Et=I();class Pt{constructor({proximityThreshold:e,enabled:t=!0,shortLineThreshold:i=ct.shortLineThreshold}){this.enabled=t,this.squaredShortLineThreshold=i*i;const r=e*ct.touchSensitivityMultiplier;this._squaredTouchProximityThreshold=r*r,this._squaredMouseProximityTreshold=e*e}snap(e,i){return this.enabled?t(i.vertexHandle)?"vertex"!==i.vertexHandle.type?[]:this.snapExistingVertex(e,i):this.snapNewVertex(e,i):[]}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(e.left.pos,e.right.pos,t)}exceedsShortLineThreshold(e,t,{elevationInfo:i,view:r,geometry:s}){const n=s.data.coordinateHelper;return 0===this.squaredShortLineThreshold||yt(_t(t,n,i,r),_t(e,n,i,r))>this.squaredShortLineThreshold}squaredProximityTreshold(e){return"touch"===e?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}}class Vt{constructor(e,t,i,r,s=null){this.geometry=e,this.view=t,this.elevationInfo=i,this.pointer=r,this.vertexHandle=s}}function Rt(e,t){return e[0]*t[1]-e[1]*t[0]}function Ht(e,t,i){const r=(t[0]-e[0])*(i[1]-e[1])-(t[1]-e[1])*(i[0]-e[0]);return Math.abs(r)/q(t,i)}function Ot(e,t,i,r,s=i){return B(Ct,r,i),B(jt,t,s),function(e,t,i){const r=J(i,t)/K(i);X(e,i,r)}(It,jt,Ct),U(e,s,It)}const Ct=oe(),jt=oe(),It=oe();class zt{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return t(this._resources)?this._resources.object:null}get resources(){return t(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const e=this.resourceFactory.view._stage;if(i(this._resources)||!e)return;const t=this._resources.object;this._resources.external.forEach((t=>{t instanceof be&&e.remove(2,t.id)})),t.removeAllGeometries();const r=this.resourceFactory.recreateGeometry(this._resources.external,t,this._resources.layer);for(const t of r)e.add(2,t)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory.view._stage;if(!e)return;const t=new xe("element",{isPickable:!1});e.add(0,t),e.addToViewContent([t.id]);const i=new Pe({idHint:"element",castShadow:!1}),r=this.resourceFactory.createResources(i,t);r.forEach((t=>{e.add(this._contentTypeFromResource(t),t)})),e.add(1,i),t.addObject(i),i.setVisible(this._visible);const s=this.resourceFactory.cameraChanged?A(this.resourceFactory.view.state,"camera",(e=>this.resourceFactory.cameraChanged(e))):null;this._resources={layer:t,object:i,external:r,cameraHandle:s}}_contentTypeFromResource(e){return e instanceof be?2:e instanceof Re?4:3}_destroyResources(){if(i(this._resources))return;const e=this.resourceFactory.view._stage;null==e||e.remove(1,this._resources.object.id),null==e||e.remove(0,this._resources.layer.id),this._resources.external.forEach((t=>{null==e||e.remove(this._contentTypeFromResource(t),t.id),"dispose"in t&&t.dispose()})),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){i(this._resources)||this._resources.object.setVisible(this._visible)}}class Lt{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=F(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=F(1,1,1,1),this._elevationInfo=null,this.resources=new zt({view:e.view,createResources:e=>this.createResources(e),recreateGeometry:(e,i)=>(e.geometry=this.recreateGeometry(i,e.material),t(e.geometry)?[e.geometry]:[])});let i=!0;for(const t in e)t in this?"attached"===t?i=e[t]:this[t]=e[t]:console.error("Cannot set unknown property",t);this.attached=i}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e}get attached(){return this.resources.attached}set attached(e){this.resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const i=this.preferredTextureSize;this._size=e,i<this.preferredTextureSize?t(this.resources)&&this.resources.recreate():this.updateSizeAttribute()}}get color(){return this._color}set color(e){ie(e,this._color)||(re(this._color,e),this.updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this.updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,t(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){ie(e,this._outlineColor)||(re(this._outlineColor,e),this.updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}updateMaterial(){const e=this.resources.resources;i(e)||e.material.setParameterValues(this.materialParameters(e.texture.id))}updateSizeAttribute(){const e=this.resources.resources,t=this.resources.object;if(i(e)||i(t))return;const r=e.geometry;if(i(r))return;const s=r.data.getVertexAttr()[we.SIZE].data,n=this.geometrySize;s[0]=n,s[1]=n,t.geometryVertexAttrsUpdated(0)}materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:Mt,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/At}recreateGeometry(e,i){const r=this.createRenderGeometry();return t(r)&&e.addGeometry(r,i),r}createResources(e){const i=this.createTexture(),r=new Se(this.materialParameters(i.id),"pointVisualElement"),s=this.recreateGeometry(e,r);return{material:r,texture:i,geometry:s,forEach(e){e(i),e(r),t(this.geometry)&&e(this.geometry)}}}get preferredTextureSize(){return f(y(2*this.geometrySize),16,128)}createTexture(){const e=this.preferredTextureSize;return new Re(Te(this._primitive,e,e*At),"pointVisualElement",{mipmap:!1,wrap:{s:33071,t:33071},width:e,height:e,components:4,noUnpackFlip:!0})}calculateMapBounds(e){if(i(this.resources.resources)||i(this.resources.resources.geometry))return!1;const t=this.resources.resources.geometry.data.getAttribute("position");return D(t.data,this.view.renderCoordsHelper.spatialReference,Dt,this.view.spatialReference),se(e,Dt),!0}createRenderGeometry(){const e=this.geometry;if(i(e))return null;const t=this.view.renderCoordsHelper,r=Ve(e,this.view.elevationProvider,Ee.fromElevationInfo(this.elevationInfo),t),s=V(fe.get(),e.x,e.y,r),n=fe.get();D(s,e.spatialReference,n,t.spatialReference);const o=this.geometrySize,a=ve.createPointGeometry(null,n,null,[o,o],[0,0,0,1]);return new be(a)}}const At=.5,Mt=[At/2,At/2,1-At/2,1-At/2],Dt=x();class kt{constructor(e,t,i){this.coordinateHelper=e,this.targetPoint=t,this.constraint=i}visualize(e,t,i){return n([this.visualizeTargetHints(e,t,i),this.visualizeReferenceHints(e,t,i)])}}class Ft{}class Gt extends Ft{constructor(e,t){super(),this.start=e,this.end=t}objectEqual(e){return e instanceof Gt&&(vt(this.start,e.start)&&vt(this.end,e.end))}}class Nt extends Gt{constructor(e,t){super(e,t),this.dir=oe(),this.p=oe()}objectEqual(e){return e instanceof Nt&&super.objectEqual(e)}check(e){return B(this.dir,this.end,this.start),B(this.p,e,this.start),J(this.dir,this.p)>=0&&Ht(e,this.start,this.end)<ct.pointOnLineThreshold}}class Zt extends Gt{constructor(e,t){super(e,t)}objectEqual(e){return e instanceof Zt&&super.objectEqual(e)}check(e){return Ht(e,this.start,this.end)<ct.pointOnLineThreshold}}class qt extends Ft{constructor(e,t){super(),this.left=e,this.right=t}objectEqual(e){return e instanceof qt&&(this.left.objectEqual(e.left)&&this.right.objectEqual(e.right))}check(){return!1}}class Ut extends Ft{constructor(e,t){super(),this.point1=e,this.point2=t}objectEqual(e){return e instanceof Ut&&(vt(this.point1,e.point1)&&vt(this.point2,e.point2))}check(){return!1}}class Wt extends kt{constructor(e,t,i,r){super(e,t,new qt(i.constraint,r.constraint)),this.left=i,this.right=r}visualizeTargetHints(e,t,i){return n([this.left.visualize(e,t,i),this.right.visualize(e,t,i)])}visualizeReferenceHints(e,t,i){return o(new Lt({view:e,primitive:"circle",geometry:this.coordinateHelper.createPoint(i),elevationInfo:t,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:O.toUnitRGBA(ct.orange),pixelSnappingEnabled:!1}))}}class Bt extends kt{constructor({coordinateHelper:e,lineStart:t,lineEnd:i,targetPoint:r}){super(e,r,new Zt(t,i))}visualizeReferenceHints(e,t){return o(wt(3,this.lineStart(),this.lineEnd(),this.coordinateHelper,t,e))}visualizeTargetHints(e,t,i){return o(wt(0,this.lineEndClosestToTarget(),i,this.coordinateHelper,t,e))}lineEndClosestToTarget(){const e=this.lineStart(),t=this.lineEnd();return v(J(B(Yt,t,e),B(Xt,this.targetPoint,e)))>0?t:e}lineStart(){return this.constraint.start}lineEnd(){return this.constraint.end}}const Xt=oe(),Yt=oe();class Jt extends Pt{constructor({enabled:e=ct.lineSnapper.enabled,proximityThreshold:t=ct.lineProximityThreshold,shortLineThreshold:i=ct.shortLineThreshold}={}){super({enabled:e,proximityThreshold:t,shortLineThreshold:i})}snapNewVertex(e,t){const i=t.geometry.data.components[0],r=i.edges.length,s=[];if(r<1)return s;const n=t.geometry.data.coordinateHelper,o=_t(n.fromPoint(e),n,t.elevationInfo,t.view),a=i.edges[r-1];let h=a;do{this.edgeExceedsShortLineThreshold(h,t)&&this._processCandidateProposal(h.left.pos,h.right.pos,e,o,t,s),h=h.left.left}while(h&&h!==a);return s}snapExistingVertex(e,t){const i=[],s=r(t.vertexHandle),n=s.component;if(n.edges.length<2)return i;const o=t.geometry.data.coordinateHelper,a=_t(o.fromPoint(e),o,t.elevationInfo,t.view),h=s.left,l=s.right;h&&l&&this.edgeExceedsShortLineThreshold(h,t)&&this.edgeExceedsShortLineThreshold(l,t)&&this._processCandidateProposal(h.left.pos,l.right.pos,e,a,t,i);const c=n.edges[0];let d=c;do{d!==s.left&&d!==s.right&&this.edgeExceedsShortLineThreshold(d,t)&&this._processCandidateProposal(d.left.pos,d.right.pos,e,a,t,i),d=d.right.right}while(d&&d!==c);return i}_processCandidateProposal(e,t,i,r,s,n){const o=Ot(oe(),ae(i.x,i.y),e,t),a=s.geometry.data.coordinateHelper,h=a.fromXYZ(o,i.hasZ?i.z:0);yt(r,_t(h,a,s.elevationInfo,s.view))<this.squaredProximityTreshold(s.pointer)&&n.push(new Bt({coordinateHelper:s.geometry.data.coordinateHelper,lineStart:e,lineEnd:t,targetPoint:h}))}}class Kt extends Ae{constructor(e){super(e),this._handles=new L,this._location=x(),this._direction=_(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=He(1,0,1,1),this._renderOccluded=4,this.applyProps(e)}get location(){return this._location}set location(e){E(this._location,e)||(S(this._location,e),this.updateGeometry())}get direction(){return this._direction}set direction(e){E(this._direction,e)||(S(this._direction,e),this.updateGeometry())}setDirectionFromPoints(e,t){R(this._direction,T(this._direction,t,e)),this.updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this.updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this.updateGeometry())}get color(){return this._color}set color(e){ie(e,this._color)||(re(this._color,e),this.updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}createExternalResources(){const e=new ye(this.materialParameters,"parallelLineVisualElement");this._handles.add(this.view.state.watch("camera",(()=>{this.updateGeometry()}))),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const t=new be(ve.createPolylineGeometry([x(),x()]),"parallelLineVisualElement"),i=new be(ve.createPolylineGeometry([x(),x()]),"parallelLineVisualElement"),s=r(this._externalResources).material;e.addGeometry(t,s,N),e.addGeometry(i,s,N),this.updateVertices(e)}forEachExternalResource(e){t(this._externalResources)&&e(this._externalResources.material)}updateMaterial(){if(i(this._externalResources))return;this._externalResources.material.setParameterValues(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}updateGeometry(){const e=this.object;i(e)||this.updateVertices(e)}updateVertices(e){const t=this.view.state.camera;t.projectToScreen(this.location,$t),H(Qt,this.location,this.direction),t.projectToScreen(Qt,ei),Q(ei,B(ei,ei,$t)),this.updateVertexAttributes(t,e,0,$t,ei,1),this.updateVertexAttributes(t,e,1,$t,ei,-1)}updateVertexAttributes(e,t,i,r,s,n){const o=t.geometryRecords[i].geometry.data.getVertexAttr()[_e.POSITION].data,a=X(ti,$(ti,s[1]*n,s[0]*-n),this.offset+this.width/2),h=U(ii,U(ii,U(ii,r,X(ii,s,this.length/2)),a),a),l=U(ri,h,X(ri,s,-this.length));e.unprojectFromScreen(h,Qt),o[0]=Qt[0],o[1]=Qt[1],o[2]=Qt[2],e.unprojectFromScreen(l,Qt),o[3]=Qt[0],o[4]=Qt[1],o[5]=Qt[2],t.geometryVertexAttrsUpdated(i)}}const Qt=x(),$t=I(),ei=I(),ti=I(),ii=I(),ri=I();class si extends kt{constructor({coordinateHelper:e,referenceLine:t,lineStart:i,targetPoint:r}){const s=e.clone(i);B(s,U(s,s,t.right.pos),t.left.pos),super(e,r,new Zt(i,s)),this._referenceLines=[{edge:t,fadeLeft:!0,fadeRight:!0}]}visualizeReferenceHints(e,t,i){return n([...this._referenceLines.map((i=>o(function(e,t,i,r,s,n=!0,o=!0){return bt(e,s,xt(t.left.pos,i,r,s),xt(t.right.pos,i,r,s),n,o)}(1,i.edge,this.coordinateHelper,t,e,i.fadeLeft,i.fadeRight)))),o(this.createParallelLineVisualElement(e,t,this.constraint.start,i))])}visualizeTargetHints(e,t,i){return n([o(wt(0,this.constraint.start,i,this.coordinateHelper,t,e))])}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach((i=>{e.right.right===i.edge&&(i.fadeLeft=!1,t.fadeRight=!1),e.left.left===i.edge&&(i.fadeRight=!1,t.fadeLeft=!1)})),this._referenceLines.push(t)}createParallelLineVisualElement(e,t,i,r){const s=xt(i,this.coordinateHelper,t,e),n=xt(r,this.coordinateHelper,t,e),o=b(n,s,n,.5),a=new Kt({view:e,attached:!1,offset:ct.parallelLineHintOffset,length:ct.parallelLineHintLength,width:ct.parallelLineHintWidth,color:O.toUnitRGBA(ct.orange),location:o,renderOccluded:16});return a.setDirectionFromPoints(s,o),a.attached=!0,a}}class ni extends Pt{constructor({enabled:e=ct.lineSnapper.enabled,proximityThreshold:t=ct.lineProximityThreshold,shortLineThreshold:i=ct.shortLineThreshold}={}){super({enabled:e,proximityThreshold:t,shortLineThreshold:i}),this._tmpProjection=oe()}snapNewVertex(e,t){const i=t.geometry.data.components[0],r=i.edges.length,s=i.vertices.length,n=[];if(r<2)return n;const o=_t(t.geometry.data.coordinateHelper.fromPoint(e),t.geometry.data.coordinateHelper,t.elevationInfo,t.view),a=i.vertices[s-1],h=i.vertices[0],l=i.edges[r-1];let c=l;do{this.edgeExceedsShortLineThreshold(c,t)&&(this._checkEdgeForParalleLines(c,a.pos,e,o,t,n),this._checkEdgeForParalleLines(c,h.pos,e,o,t,n)),c=c.left.left}while(c&&c!==l);return n}snapExistingVertex(e,t){const i=[],s=r(t.vertexHandle),n=s.component;if(n.edges.length<3)return i;const o=_t(t.geometry.data.coordinateHelper.fromPoint(e),t.geometry.data.coordinateHelper,t.elevationInfo,t.view),a=s.left,h=s.right,l=n.vertices[0],c=n.vertices.length,d=n.vertices[c-1],p=n.edges[0];let u=p;do{u!==a&&u!==h&&this.edgeExceedsShortLineThreshold(u,t)&&(a&&this._checkEdgeForParalleLines(u,a.left.pos,e,o,t,i),h&&this._checkEdgeForParalleLines(u,h.right.pos,e,o,t,i),s===l?this._checkEdgeForParalleLines(u,d.pos,e,o,t,i):s===d&&this._checkEdgeForParalleLines(u,l.pos,e,o,t,i)),u=u.right.right}while(u&&u!==p);return i}_checkEdgeForParalleLines(e,t,i,r,s,n){const o=e.left.pos,a=e.right.pos;if(Ot(this._tmpProjection,t,o,a),ee(this._tmpProjection,t)<ct.parallelLineThreshold)return;Ot(this._tmpProjection,ae(i.x,i.y),o,a,t);const h=s.geometry.data.coordinateHelper,l=h.fromXYZ(this._tmpProjection,i.hasZ?i.z:0);if(yt(r,_t(l,h,s.elevationInfo,s.view))<this.squaredProximityTreshold(s.pointer)){if(this.parallelToPreviousCandidate(e,n))return;n.push(new si({coordinateHelper:h,referenceLine:e,lineStart:t,targetPoint:l}))}}parallelToPreviousCandidate(e,t){const i=e.left.pos,r=e.right.pos;for(const s of t)if(Ot(this._tmpProjection,r,s.constraint.start,s.constraint.end,i),ee(this._tmpProjection,r)<ct.parallelLineThreshold)return s.addReferenceLine(e),!0;return!1}}class oi extends kt{constructor({coordinateHelper:e,targetPoint:t,constraint:i,previousVertex:r,centerVertex:s}){super(e,t,i),this._previousVertex=r,this._centerVertex=s}visualizeTargetHints(e,t,i){return o(wt(0,this.constraint.start,i,this.coordinateHelper,t,e))}visualizeReferenceHints(e,t,i){return n([o(wt(2,this._previousVertex,this.constraint.start,this.coordinateHelper,t,e)),o(St(this._previousVertex,this._centerVertex,i,this.coordinateHelper,t,e))])}}class ai extends Pt{constructor({enabled:e=ct.lineSnapper.enabled,proximityThreshold:t=ct.lineProximityThreshold,shortLineThreshold:i=ct.shortLineThreshold}={}){super({enabled:e,proximityThreshold:t,shortLineThreshold:i}),this._tmp=oe()}snapNewVertex(e,t){const i=t.geometry.data.components[0],r=i.vertices.length,s=[];if(r<2)return s;const n=t.geometry.data.coordinateHelper,o=_t(n.fromPoint(e),t.geometry.data.coordinateHelper,t.elevationInfo,t.view),a=i.vertices[r-1];this._checkForSnappingCandidate(s,a.left,a.pos,n.fromPoint(e),a.left.left.pos,a.pos,t,e,o);const h=i.vertices[0];return this._checkForSnappingCandidate(s,h.right,h.pos,n.fromPoint(e),h.right.right.pos,h.pos,t,e,o),s}snapExistingVertex(e,t){const i=[],s=r(t.vertexHandle),n=s.component,o=n.vertices.length;if(o<3)return i;const a=t.geometry.data.coordinateHelper.fromPoint(e),h=_t(a,t.geometry.data.coordinateHelper,t.elevationInfo,t.view),l=s.left,c=s.right,d=n.vertices[0],p=n.vertices[o-1];if(!l)return this._checkForSnappingCandidate(i,d.right.right.right,d.right.right.pos,a,d.right.right.right.right.pos,d.right.right.pos,t,e,h),i;if(!c)return this._checkForSnappingCandidate(i,p.left.left.left,p.left.left.pos,a,p.left.left.left.left.pos,p.left.left.pos,t,e,h),i;if(l&&l.left.left){const r=l.left.left;this._checkForSnappingCandidate(i,r,l.left.pos,a,r.left.pos,l.left.pos,t,e,h)}if(c&&c.right.right){const r=c.right.right;this._checkForSnappingCandidate(i,r,c.right.pos,a,r.right.pos,c.right.pos,t,e,h)}return i}_checkForSnappingCandidate(e,t,i,r,s,n,o,a,h){if(!this.edgeExceedsShortLineThreshold(t,o))return;B(this._tmp,t.right.pos,t.left.pos);const l=ae(this._tmp[1],-this._tmp[0]),c=J(l,B(this._tmp,r,i))/K(l),d=o.geometry.data.coordinateHelper,p=d.fromXYZ(W(oe(),n,l,c),a.hasZ?a.z:0);yt(h,_t(p,d,o.elevationInfo,o.view))<this.squaredProximityTreshold(o.pointer)&&e.push(new oi({coordinateHelper:d,targetPoint:p,constraint:new Nt(n,W(d.createNew(),n,l,v(c))),previousVertex:s,centerVertex:n}))}}class hi extends kt{constructor({coordinateHelper:e,targetPoint:t,point1:i,point2:r}){super(e,t,new Ut(i,r))}visualizeTargetHints(){return o(null)}visualizeReferenceHints(e,t,i){return n([o(wt(2,i,this.constraint.point1,this.coordinateHelper,t,e)),o(wt(2,i,this.constraint.point2,this.coordinateHelper,t,e)),o(St(this.constraint.point1,i,this.constraint.point2,this.coordinateHelper,t,e))])}}class li extends Pt{constructor({enabled:e=ct.lineSnapper.enabled,proximityThreshold:t=ct.lineProximityThreshold,shortLineThreshold:i=ct.shortLineThreshold}={}){super({enabled:e,proximityThreshold:t,shortLineThreshold:i})}snapNewVertex(e,t){const i=t.geometry.data.components[0],r=[],s=i.vertices.length;if("polygon"!==t.geometry.type||s<2)return r;const n=i.vertices[0],o=i.vertices[s-1];return this._processCandidateProposal(n.pos,o.pos,e,t,r),r}snapExistingVertex(e,t){const i=[],s=r(t.vertexHandle),n=s.component;return n.edges.length<2?i:"polyline"!==t.geometry.type||0!==s.index&&s.index!==n.vertices.length-1?(this._processCandidateProposal(s.left.left.pos,s.right.right.pos,e,t,i),i):i}_processCandidateProposal(e,t,i,r,s){if(!this.exceedsShortLineThreshold(e,t,r))return;const n=Z(oe(),e,t,.5),o=.5*q(e,t),a=function(e,t,i,r){B(Ct,t,i);const s=r/Y(Ct);return W(e,i,Ct,s)}(oe(),[i.x,i.y],n,o),h=r.geometry.data.coordinateHelper,l=h.fromXYZ(a,i.hasZ?i.z:0);yt(_t(h.fromPoint(i),h,r.elevationInfo,r.view),_t(l,h,r.elevationInfo,r.view))<this.squaredProximityTreshold(r.pointer)&&s.push(new hi({coordinateHelper:h,targetPoint:l,point1:e,point2:t}))}}class ci{constructor(e){this._snapper=new p,this._currentSnappingCandidate=null,this._visualElementHandles=a(),this._optionsHandle=a(),this._squaredMouseProximityTreshold=ct.pointProximityThreshold*ct.pointProximityThreshold,this._squaredTouchProximityThreshold=ct.pointProximityThreshold*ct.pointProximityThreshold*ct.touchSensitivityMultiplier*ct.touchSensitivityMultiplier,this._snapper.push(new ni({enabled:e.effectiveSelfEnabled})),this._snapper.push(new Jt({enabled:e.effectiveSelfEnabled})),this._snapper.push(new ai({enabled:e.effectiveSelfEnabled})),this._snapper.push(new li({enabled:e.effectiveSelfEnabled})),this._optionsHandle=M(e,"effectiveSelfEnabled",(()=>{for(const t of this._snapper)t.enabled=e.effectiveSelfEnabled;this.doneSnapping()}))}snap(e,t){const i=[];for(const r of this._snapper.items)i.push(...r.snap(e,t));return this._aggregateSnappingCandidates(i,e,t)}destroy(){this.doneSnapping(),this._optionsHandle.remove()}doneSnapping(){this._visualElementHandles.remove(),this._currentSnappingCandidate=null}_aggregateSnappingCandidates(e,i,r){const s=e.length,n=r.geometry.data.coordinateHelper.fromPoint(i);if(t(this._currentSnappingCandidate)){if(this.isCurrentIntersectionConstraintStillActive(e)&&q(n,this._currentSnappingCandidate.targetPoint)<this.squaredPointProximityThreshold(r.pointer))return r.geometry.data.coordinateHelper.createDehydratedPoint(this._currentSnappingCandidate.targetPoint);const i=di(e,this._currentSnappingCandidate);if(this.doneSnapping(),i>=0){const o=e[i],a=[];if(o.constraint instanceof Gt){for(let h=0;h<s;++h){if(h===i)continue;const s=e[h];if(s.constraint instanceof Gt){const e=this._intersectRaysAndLines(o,s,r);if(t(e)){const t=yt(_t(n,r.geometry.data.coordinateHelper,r.elevationInfo,r.view),_t(e.targetPoint,r.geometry.data.coordinateHelper,r.elevationInfo,r.view));a.push([e,t])}}}if(a.length>0&&(a.sort(((e,t)=>e[1]-t[1])),a[0][1]<this.squaredPointProximityThreshold(r.pointer)))return this.updateSnappingCandidate(a[0][0],e,r)}return this.updateSnappingCandidate(o,e,r)}}if(s>0){let t=0,i=q(n,e[0].targetPoint);for(let r=1;r<s;++r){const s=q(n,e[r].targetPoint);s<i&&(i=s,t=r)}return this.updateSnappingCandidate(e[t],e,r)}return i}_intersectRaysAndLines(e,t,i){const r=e.constraint.start,s=e.constraint.end,n=t.constraint.start,o=t.constraint.end,a=B(oe(),s,r),h=B(oe(),o,n),l=Rt(a,h);if(Math.abs(l)<=ct.intersectionParallelLineThreshold)return null;const c=B(oe(),r,n),d=Rt(h,c)/l,p=Rt(a,c)/l,u=i.geometry.data.coordinateHelper;if(d>=0){if(p>=0||t.constraint instanceof Zt){const i=u.clone(e.targetPoint);return W(i,r,a,d),new Wt(u,i,e,t)}}else if(e.constraint instanceof Zt&&(p>=0||t.constraint instanceof Zt)){const i=u.clone(e.targetPoint);return W(i,r,a,d),new Wt(u,i,e,t)}return null}isCurrentIntersectionConstraintStillActive(e){if(this._currentSnappingCandidate instanceof Wt){const t=this._currentSnappingCandidate.left,i=this._currentSnappingCandidate.right,r=di(e,t),s=di(e,i);return r>=0&&s>=0}return!1}updateSnappingCandidate(e,t,i){this._currentSnappingCandidate=e;const r=this._currentSnappingCandidate.targetPoint,s=[e.visualize(i.view,i.elevationInfo,r)];for(const n of t){if(e instanceof Wt){if(n.constraint.objectEqual(e.left.constraint)||n.constraint.objectEqual(e.right.constraint))continue}else if(n.constraint.objectEqual(e.constraint))continue;n.constraint.check(r)&&s.push(n.visualizeReferenceHints(i.view,i.elevationInfo,r))}return this._visualElementHandles=n(s),i.geometry.data.coordinateHelper.createDehydratedPoint(r)}squaredPointProximityThreshold(e){return"touch"===e?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}}function di(e,t){let i=-1;for(let r=0;r<e.length;++r)if(t.constraint.objectEqual(e[r].constraint)){i=r;break}return i}let pi=class extends d{constructor(e){super(),this._manipulator=null,this._stagedVertex=null,this.geometryType=null,this.elevationInfo=null,this.snapToSceneEnabled=null,this._handles=new L,this._defaultZ=0,this._elevationDrawSurface=null,this._snappingDrawSurface=null,this._snappingEnabled=!1,this._createOperationCompleted=!1,this._pointerDownStates=new Set,this.view=e.view,this.drawingMode=s(e.drawingMode,"click"),this.geometryType=e.geometryType,this.elevationInfo=e.elevationInfo,this.coordinateHelper=Ne(e.hasZ,e.hasM,this.view.spatialReference,this.view.viewingMode),this._defaultZ=e.defaultZ,this.snapToSceneEnabled=e.snapToSceneEnabled,this.snappingEngine=new ci(e.snappingOptions),this._snappingEnabled=e.snappingOptions.selfEnabled,this._handles.add(M(e.snappingOptions,"selfEnabled",(()=>{this._snappingEnabled=e.snappingOptions.selfEnabled}))),this._snappingDrawSurface=r(e.snappingDrawSurface),this._elevationDrawSurface=new We(this.elevationInfo,this._defaultZ,this.view),this._editGeometry=new Qe(new Ke(this.coordinateHelper),"segment"===this.geometryType?"polyline":this.geometryType),this._activeComponent=new Je(this._editGeometry.data),this._editGeometry.data.components.push(this._activeComponent),this._editGeometry.on(["vertex-add","vertex-update","vertex-remove"],(e=>{const t=e.vertices.map((e=>({componentIndex:0,vertexIndex:e.index,coordinates:this.coordinateHelper.toArray(e.pos)}))),i=t.map((e=>e.coordinates));switch(e.type){case"vertex-add":this.emit(e.type,{...e,added:i,vertices:t});break;case"vertex-update":this.emit(e.type,{...e,updated:i,vertices:t});break;case"vertex-remove":this.emit(e.type,{...e,removed:i,vertices:t})}})),this._manipulator=new Ue({grabbableForEvent:e=>"click"!==this.drawingMode||"touch"===e.pointerType&&this._snappingEnabled&&1===this._pointerDownStates.size}),e.manipulators.add(this._manipulator),this._manipulator.grabbable="point"!==this.geometryType;const i=this.createManipulatorDragPipeline(this._manipulator),n=this._manipulator.events.on("immediate-double-click",(e=>{this._manipulator.dragging||"point"!==this.geometryType&&(this.complete(),e.stopPropagation())})),o=this._manipulator.events.on("immediate-click",(e=>{if(this._manipulator.dragging)return;const i=this._activeComponent,r=this._closeOnClickVertexIndex(e.screenPoint);if(t(r))this.discardStagedVertex(),this.complete();else{const r=this._screenToMap(e.screenPoint);if(t(r))switch(this.drawingMode){case"freehand":break;case"click":case"hybrid":this.hasStagedVertex?this.commitStagedVertex():this._editGeometry.appendVertex(this.coordinateHelper.fromPoint(r)),("point"===this.geometryType||"segment"===this.geometryType&&2===i.vertices.length||"segment"===this.geometryType&&"hybrid"===this.drawingMode&&1===i.vertices.length)&&this.complete()}}e.stopPropagation()}));this._handles.add([i,o,n])}get isCompleted(){return this._createOperationCompleted}createManipulatorDragPipeline(e){switch(this.drawingMode){case"click":return this.createManipulatorDragPipelineClick(e);case"freehand":return this.createManipulatorDragPipelineFreehand(e);case"hybrid":return this.createManipulatorDragPipelineHybrid(e)}}createManipulatorDragPipelineClick(e){return ze(e,((e,t,i,s)=>{const n="touch"===s&&this._snappingEnabled;if(this.isCompleted||!n)return;let o=null;t.next(this._screenToMapDragEventStep()).next((e=>("start"===e.action&&(this.stagedVertex=e.mapStart,("segment"===this.geometryType||n&&0===this.vertices.length)&&this.commitStagedVertex()),e))).next((e=>{switch(e.action){case"start":case"update":"start"===e.action&&n&&(o=new Vt(this._editGeometry,this.view,this.elevationInfo,s)),n&&(this.stagedVertex=this.snappingEngine.snap(e.mapEnd,r(o)));break;case"end":"segment"!==this.geometryType&&"point"!==this.geometryType||this.complete(),n&&(this.commitStagedVertex(),this.snappingEngine.doneSnapping())}return e})),i.next((()=>{n&&this.snappingEngine.doneSnapping()}))}))}createManipulatorDragPipelineFreehand(e){return ze(e,((e,t)=>{this.isCompleted||t.next(this._screenToMapDragEventStep()).next((e=>("start"===e.action&&(this.stagedVertex=e.mapStart,"segment"===this.geometryType&&this.commitStagedVertex()),e))).next((e=>{switch(e.action){case"start":case"update":this.stagedVertex=e.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":this.complete()}return e}))}))}createManipulatorDragPipelineHybrid(e){return ze(e,((e,t)=>{this.isCompleted||t.next(this._screenToMapDragEventStep()).next((e=>("start"===e.action&&(this.stagedVertex=e.mapStart,this.commitStagedVertex()),e))).next((e=>{switch(e.action){case"start":case"update":this.stagedVertex=e.mapEnd,"polygon"!==this.geometryType&&"polyline"!==this.geometryType||this.commitStagedVertex();break;case"end":"segment"!==this.geometryType&&"point"!==this.geometryType||this.complete()}return e}))}))}destroy(){this._handles.destroy(),this._handles=null}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":{if(this._manipulator.dragging||this._pointerDownStates.has(e.pointerId)||this._manipulator.grabbing||!this._manipulator.interactive)return;const i=z(e.x,e.y),r=this._closeOnClickVertexIndex(i);if(t(r)){this.discardStagedVertex();const e={componentIndex:0,vertexIndex:r,coordinates:this.coordinateHelper.toArray(this._activeComponent.vertices[r].pos)};this.emit("cursor-update",{updated:null,vertices:[e],operation:"apply",type:"vertex-update"})}else{const r=this._screenToMap(i);t(r)?(this.stagedVertex=this.snappingEngine.snap(r,new Vt(this._editGeometry,this.view,this.elevationInfo,e.pointerType)),this._manipulator.cursor="crosshair"):this._manipulator.cursor=null}e.stopPropagation();break}case"hold":"click"===this.drawingMode&&"touch"===e.pointerType&&this._snappingEnabled&&(this.stagedVertex=e.mapPoint),e.stopPropagation()}}get canRedo(){return this._editGeometry.canRedo}redo(){this._editGeometry.redo()}get canUndo(){return this._editGeometry.canUndo}undo(){this.snappingEngine.doneSnapping(),this._editGeometry.undo()}complete(e=!1){this.commitStagedVertex(),this._createOperationCompleted=!0,this.snappingEngine.doneSnapping(),this.emit("complete",{vertices:this.vertices.map(((e,t)=>({componentIndex:0,vertexIndex:t,coordinates:e}))),aborted:e,type:"complete"})}cancel(){this.complete(!0)}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get numVertices(){return t(this._stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get numCommittedVertices(){return this._activeComponent.vertices.length}get vertices(){const e=this._activeComponent.vertices.map((e=>this.coordinateHelper.toArray(e.pos)));return t(this._stagedVertex)&&e.push(this.coordinateHelper.pointToArray(this._stagedVertex)),e}get spatialReference(){return this.view.spatialReference}get hasStagedVertex(){return t(this._stagedVertex)}get stagedVertex(){return this._stagedVertex}set stagedVertex(e){if(i(e))return void this.discardStagedVertex();this._stagedVertex=e;const t={componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(e)};this.emit("cursor-update",{updated:null,vertices:[t],operation:"apply",type:"vertex-update"})}commitStagedVertex(){if(t(this._stagedVertex)){const e=this._stagedVertex;this._stagedVertex=null,this._editGeometry.appendVertex(this.coordinateHelper.fromPoint(e))}}discardStagedVertex(){this._stagedVertex=null}_screenToMapDragEventStep(){let e=null;return r=>{if("start"===r.action&&(e=this._screenToMap(r.screenStart)),i(e))return null;const s=this._screenToMap(r.screenEnd);return t(s)?{...r,mapStart:e,mapEnd:s}:null}}_screenToMap(e){return this._getDrawSurface().screenToMap(e)}_mapToScreen(e){return this._getDrawSurface().mapToScreen(e)}_getDrawSurface(){let e=null;if(this.coordinateHelper.hasZ){let i=this._defaultZ,r=!1;t(this.elevationInfo)&&"absolute-height"===this.elevationInfo.mode&&(r=!0),t(this.snapToSceneEnabled)&&(r=this.snapToSceneEnabled),t(this.elevationInfo)&&"on-the-ground"===this.elevationInfo.mode&&(r=!1);const s=this._activeComponent.vertices.length;("segment"===this.geometryType||"polygon"===this.geometryType)&&s>0&&(i=this.coordinateHelper.zFromArray(this._activeComponent.vertices[0].pos),r=!1),r?e=this._snappingDrawSurface:(this._elevationDrawSurface.defaultZ=i,e=this._elevationDrawSurface)}else this._elevationDrawSurface.defaultZ=null,e=this._elevationDrawSurface;return e}_vertexWithinPointerDistance(e,i){const r=this._mapToScreen(e);return!!t(r)&&function(e,t,i){const r=e.x-t.x,s=e.y-t.y;return r*r+s*s<=i}(r,i,25)}_closeOnClickVertexIndex(e){const t=this._activeComponent;if("polygon"===this.geometryType&&t.vertices.length>2){if(this._vertexWithinPointerDistance(this.coordinateHelper.toPoint(t.vertices[0].pos,ui),e))return 0;if(this._vertexWithinPointerDistance(this.coordinateHelper.toPoint(t.vertices[t.vertices.length-1].pos,ui),e))return t.vertices.length-1}return null}};pi=e([c("esri.views.3d.interactive.editingTools.draw3D.DrawOperation")],pi);const ui=new m({x:0,y:0,z:0});let gi=class extends l{constructor(){super(...arguments),this.selfEnabled=!1,this.selfEnabledToggled=!1}get effectiveSelfEnabled(){return this.selfEnabledToggled?!this.selfEnabled:this.selfEnabled}};e([h()],gi.prototype,"selfEnabled",void 0),e([h()],gi.prototype,"selfEnabledToggled",void 0),e([h({readOnly:!0})],gi.prototype,"effectiveSelfEnabled",null),gi=e([c("esri.views.interactive.snapping.SnappingOptions")],gi);let mi=class extends(d.EventedMixin(Le)){constructor(e){super(e),this.drawOperation=null,this.hasZ=!0,this.defaultZ=0,this.elevationInfo=null,this.snapToScene=null,this.snappingOptions=new gi,this.mode=null,this.geometryType=null,this.type="draw-3d"}initialize(){const e=s(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this.drawOperation=new pi({view:this.view,manipulators:this.manipulators,geometryType:this.geometryType,drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,snappingDrawSurface:new Be(this.view,e),hasM:!1,elevationInfo:e,snappingOptions:this.snappingOptions}),this.drawOperation.on("vertex-add",(e=>this.onVertexAdd(e))),this.drawOperation.on("vertex-remove",(e=>this.onVertexRemove(e))),this.drawOperation.on("vertex-update",(e=>this.onVertexUpdate(e))),this.drawOperation.on("cursor-update",(e=>this.onCursorUpdate(e))),this.drawOperation.on("complete",(e=>this.onComplete(e)))}destroy(){this.drawOperation.destroy(),this.drawOperation=null,this._set("view",null)}onInputEvent(e){this.drawOperation.onInputEvent(e)}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}reset(){}get canRedo(){return this.drawOperation.canRedo}redo(){this.drawOperation.redo()}get canUndo(){return this.drawOperation.canUndo}undo(){this.drawOperation.undo()}completeCreateOperation(){this.drawOperation.complete()}activate(){}deactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.vertices}onVertexAdd(e){this.emit("vertex-add",e)}onVertexRemove(e){this.emit("vertex-remove",e)}onVertexUpdate(e){this.emit("vertex-update",e)}onCursorUpdate(e){this.emit("cursor-update",e)}onComplete(e){this.emit("complete",e)}};e([h({constructOnly:!0,nonNullable:!0})],mi.prototype,"view",void 0),e([h({value:!0})],mi.prototype,"enabled",null),e([h({constructOnly:!0})],mi.prototype,"hasZ",void 0),e([h({constructOnly:!0,nonNullable:!0})],mi.prototype,"defaultZ",void 0),e([h({constructOnly:!0})],mi.prototype,"elevationInfo",void 0),e([h()],mi.prototype,"snapToScene",void 0),e([h({constructOnly:!0})],mi.prototype,"snappingOptions",void 0),e([h({constructOnly:!0})],mi.prototype,"mode",void 0),e([h({constructOnly:!0})],mi.prototype,"geometryType",void 0),e([h({readOnly:!0})],mi.prototype,"type",void 0),mi=e([c("esri.views.3d.interactive.editingTools.draw.DrawTool")],mi);export{mi as D,dt as E,Lt as P,gi as S,zt as V,rt as a,pi as b,Be as c,st as d,ci as e,Ke as f,Vt as g,Qe as h};
