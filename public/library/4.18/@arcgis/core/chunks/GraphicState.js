/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"./object.js";import{i as t,b as r,u as s}from"./Logger.js";import{property as i}from"../core/accessorSupport/decorators/property.js";import a from"../core/Accessor.js";import"./ensureType.js";import{subclass as o}from"../core/accessorSupport/decorators/subclass.js";import{E as n}from"./Evented.js";import"../core/urlUtils.js";import"./resourceExtension.js";import{c as h}from"./vec3f64.js";import{f as l,a as c,s as d}from"./vec3.js";import{I as u}from"./Identifiable.js";import{projectBuffer as p}from"../geometry/projection.js";import{e as m,c as _}from"./vec4.js";import{c as f,b as g,k as y}from"./aaBoundingBox.js";import{m as v}from"./dehydratedFeatures.js";import{E as R}from"./PiUtils.glsl.js";import{R as w,f as O}from"./ColorMaterial.js";import{G as b}from"./Geometry.js";import{E as G}from"./sdfPrimitives.js";import{a as C,c as D,g as j}from"./lineUtils.js";import{R as E}from"./RenderGeometry.js";import{f as A,a as P}from"./vec4f32.js";import{V as M}from"./DrawTool.js";import{L as S}from"./RightAngleQuadVisualElement.js";class T{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return t(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?r(this._resources)||(this.ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?r(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var e;this._destroyResources();const t=this.resourceFactory.createResources();this._resources={layerView:new V({view:this.resourceFactory.view}),external:t,geometriesAdded:!1},this._syncGeometriesToRenderer();const r=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;r&&r.registerDrapeSource(this._resources.layerView)}_destroyResources(){var e;if(r(this._resources))return;this.ensureRenderGeometriesRemoved();const t=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;t&&t.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this.ensureRenderGeometriesAdded():this.ensureRenderGeometriesRemoved()}ensureRenderGeometriesRemoved(){var e;if(r(this._resources)||null==(e=this.resourceFactory.view)||!e.basemapTerrain)return;if(!this._resources.geometriesAdded)return;this.resourceFactory.view.basemapTerrain.overlayManager.renderer.removeGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!1}ensureRenderGeometriesAdded(){if(r(this._resources))return;if(this._resources.geometriesAdded)return;this.resourceFactory.view.basemapTerrain.overlayManager.renderer.addGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!0}}let V=class extends(u(a)){constructor(e){super(e),this.drapeSourceType=1}};e([i({constructOnly:!0})],V.prototype,"view",void 0),e([i({readOnly:!0})],V.prototype,"drapeSourceType",void 0),V=e([o("DrapedVisualElementLayerView")],V);class I{constructor(e){this.view=null,this._attachmentOrigin=v(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new n,this._isDraped=!1,this._geometry=null,this._width=1,this._color=A(1,0,1,1),this._innerWidth=0,this._innerColor=A(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=8,this.resources=new M({view:e.view,createResources:e=>this.createResources(e),recreateGeometry:(e,t)=>(e.geometries.length=0,this.recreateGeometry(t,e.material,e.geometries),e.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new T({view:e.view,createResources:()=>this.createDrapedResources(),recreateGeometry:e=>{e.geometries=this.createRenderGeometriesDraped(e.material),this.attachmentOriginChanged()}});let t=!0;this._laserline=new S({view:e.view});for(const r in e)r in this?"attached"===r?t=e[r]:this[r]=e[r]:console.error("Cannot set unknown property",r);this.attached=t}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&t(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(e){this.updateAttached(e)}updateAttached(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this.attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this.updateMaterial())}get color(){return this._color}set color(e){m(e,this._color)||(_(this._color,e),this.updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){m(e,this._innerColor)||(_(this._innerColor,e),this.updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const r=t(e)!==t(this._stipplePattern);this._stipplePattern=e,r?this.resources.recreate():this.updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&m(e,this._stippleOffColor)||(this._stippleOffColor=e?P(e):null,this.updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,t(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=t(this.resources.resources)?this.resources.resources.geometries:null;if(!e||0===e.length)return null;l(W,0,0,0);const r=O.POSITION;let i=0;for(const t of e){const e=t.getAttribute(r),a=t.getIndices(r),o=s(this.resources.resources).material.isClosed(e.data,a);R(e,a,o,x)&&(c(W,W,x),i++)}return 0===i?null:(d(W,W,1/i),this.view.renderCoordsHelper.fromRenderCoords(W,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}updateMaterial(){t(this.resources.resources)&&this.resources.resources.material.setParameterValues(this.materialParameters),t(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameterValues(this.materialParameters)}get isClosed(){return t(this.geometry)&&"polygon"===this.geometry.type}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",stippleIntegerRepeats:!0,polygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&8===this._renderOccluded?4:this._renderOccluded}recreateGeometry(e,t,r){const s=this.createRenderGeometries();for(const i of s)e.addGeometry(i,t),r.push(i);this.attachmentOriginChanged()}attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}createResources(e){const t=new w(this.materialParameters,"lineVisualElement"),r=[];return this.recreateGeometry(e,t,r),{material:t,geometries:r,forEach:e=>{e(t),r.forEach(e)}}}createDrapedResources(){const e=new w(this.materialParameters,"lineVisualElement");return{material:e,geometries:this.createRenderGeometriesDraped(e)}}createRenderGeometriesDraped(e){const t=this.geometry;if(r(t))return[];const s=C(t,this.view.basemapTerrain.spatialReference),i=[];for(const{position:t}of s.lines){const r={attributeData:{position:t},removeDuplicateStartEnd:this.isClosed?1:0},s=new E(D(r));s.material=e;const a=g(F);y(a,t),l(s.center,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0),s.bsRadius=.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1])),i.push(s)}return i}calculateMapBounds(e){if(r(this.resources.resources))return!1;const t=this.view.renderCoordsHelper;for(const r of this.resources.resources.geometries){const s=r.data.getAttribute("position"),i=s.data,a=new Float64Array(i.length);p(s.data,t.spatialReference,0,a,this.view.spatialReference,0,i.length/3),y(e,a)}return!0}createRenderGeometries(){const e=this.geometry;if(r(e))return[];const t=j(e,this.view.elevationProvider,this.view.renderCoordsHelper,G.fromElevationInfo(this.elevationInfo)),s=[],i=[];for(const{position:e,mapPosition:r}of t.lines){const t={attributeData:{position:e,mapPosition:r},removeDuplicateStartEnd:this.isClosed?1:0},a=D(t);s.push(new b(a,"geometryOutlineVisualElement")),i.push(e)}return this._laserline.pathVerticalPlane=i,s}}const F=f(),x=h(),W=h();let k=class extends n.EventedAccessor{constructor(e){super(e),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};e([i({constructOnly:!0})],k.prototype,"graphic",void 0),e([i()],k.prototype,"tracking",void 0),e([i()],k.prototype,"displaying",void 0),e([i()],k.prototype,"isDraped",void 0),k=e([o("esri.views.3d.layers.graphics.GraphicState")],k);export{k as G,I as O};
