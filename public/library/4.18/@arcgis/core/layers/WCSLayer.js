/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../chunks/ArrayPool.js";import"../chunks/object.js";import"../chunks/deprecate.js";import"../core/lang.js";import"../config.js";import{i as t,u as s}from"../chunks/Logger.js";import"../chunks/string.js";import"../chunks/metadata.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import"../core/Accessor.js";import"../chunks/PropertyOrigin.js";import"../core/scheduling.js";import{isAbortError as i,resolve as r}from"../core/promiseUtils.js";import"../chunks/Message.js";import n from"../core/Error.js";import"../chunks/compilerUtils.js";import"../chunks/ensureType.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import"../chunks/Evented.js";import"../core/Collection.js";import"../chunks/collectionUtils.js";import"../chunks/JSONSupport.js";import"../chunks/Promise.js";import"../chunks/Loadable.js";import"../chunks/asyncUtils.js";import"../core/urlUtils.js";import"../core/accessorSupport/decorators/aliasOf.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/jsonMap.js";import"../chunks/enumeration.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../chunks/resourceExtension.js";import"../chunks/persistableUrlUtils.js";import"../geometry/SpatialReference.js";import"../chunks/locale.js";import"../chunks/number.js";import"../intl.js";import"../kernel.js";import"../request.js";import"../chunks/assets.js";import"../geometry/Geometry.js";import l from"../geometry/Point.js";import"../chunks/Ellipsoid.js";import"../geometry/support/webMercatorUtils.js";import p from"../geometry/Extent.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalUser.js";import"../portal/Portal.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../portal/PortalItem.js";import"../chunks/mathUtils2.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../chunks/vec3.js";import"../chunks/colorUtils.js";import"../Color.js";import"../chunks/zmUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry.js";import"./support/CodedValueDomain.js";import"./support/Domain.js";import"./support/InheritedDomain.js";import"./support/RangeDomain.js";import"../chunks/domains.js";import"../chunks/arcadeOnDemand.js";import"./support/fieldUtils.js";import"../popup/content/Content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/CustomContent.js";import"../chunks/date.js";import"../popup/support/FieldInfoFormat.js";import"../popup/FieldInfo.js";import"../popup/content/FieldsContent.js";import"../chunks/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/MediaContent.js";import"../popup/content/TextContent.js";import"../popup/content.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/RelatedRecordsInfo.js";import"../chunks/Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../PopupTemplate.js";import"../symbols/Symbol.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol3DLayer.js";import"../chunks/screenUtils.js";import"../chunks/opacityUtils.js";import"../chunks/materialUtils.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/utils.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/FillSymbol.js";import"../symbols/patterns/StylePattern3D.js";import"../symbols/FillSymbol3DLayer.js";import"../chunks/colors.js";import"../chunks/Symbol3DOutline.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/Symbol3D.js";import"../chunks/Thumbnail.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../chunks/Symbol3DVerticalOffset.js";import"../symbols/LabelSymbol3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../chunks/urlUtils.js";import"../symbols/PictureFillSymbol.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../symbols/support/jsonUtils.js";import"../chunks/uid.js";import"../Graphic.js";import m from"./Layer.js";import"../chunks/LegendOptions.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../tasks/support/ColorRamp.js";import"../tasks/support/AlgorithmicColorRamp.js";import"../tasks/support/MultipartColorRamp.js";import"../chunks/colorRamps.js";import"../renderers/Renderer.js";import"../renderers/visualVariables/VisualVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../renderers/visualVariables/SizeVariable.js";import"../chunks/sizeVariableUtils.js";import"../chunks/unitUtils.js";import"../chunks/lengthUtils.js";import"../chunks/visualVariableUtils.js";import"../chunks/VisualVariablesMixin.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/support/ColormapInfo.js";import"../chunks/colorUtils2.js";import"../chunks/colorRampUtils.js";import"../renderers/RasterColormapRenderer.js";import"../renderers/RasterShadedReliefRenderer.js";import"../renderers/RasterStretchRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/devEnvironmentUtils.js";import"../chunks/styleUtils.js";import"../renderers/UniqueValueRenderer.js";import"../geometry/support/normalizeUtils.js";import"./support/PixelBlock.js";import"../renderers/VectorFieldRenderer.js";import"../chunks/MemCache.js";import"../chunks/ItemCache.js";import"../chunks/utils3.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils2.js";import"../rasterRenderers.js";import"../chunks/timeUtils.js";import"../TimeExtent.js";import"../chunks/ReadOnlyMultiOriginJSONSupport.js";import{M as c}from"../chunks/MultiOriginJSONSupport.js";import"../core/watchUtils.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/fieldType.js";import"../chunks/mat4.js";import"../chunks/pe.js";import"../chunks/aaBoundingRect.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformationStep.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/projection.js";import{O as u}from"../chunks/OperationalLayer.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import{p as d}from"../chunks/commonProperties2.js";import"../chunks/_commonjsHelpers.js";import"../core/workers/Connection.js";import"../chunks/Scheduler.js";import"../core/workers/workers.js";import"./support/LOD.js";import"./support/TileInfo.js";import h from"./support/Field.js";import{P as f}from"../chunks/PortalLayer.js";import{R as g}from"../chunks/RefreshableLayer.js";import{S as y}from"../chunks/ScaleRangeLayer.js";import{createPopupTemplate as b}from"../support/popupUtils.js";import v from"./support/DimensionalDefinition.js";import j from"./support/RasterInfo.js";import"../chunks/rasterRendererHelper.js";import"../chunks/RasterSymbolizer.js";import"../chunks/LercCodec.js";import"../chunks/ClassBreaksDefinition.js";import{j as x}from"../chunks/pixelUtils.js";import{g as w,b as S,a as C,e as k,f as I,i as D,h as L,B as R,I as O}from"../chunks/xmlUtilities.js";import"../chunks/RawBlockCache.js";import"../chunks/rasterProjectionHelper.js";import{c as P}from"../chunks/wmsUtils.js";function T(e){const t=function(e){var t;const s=null==(t=e.getHeader("Content-Type"))?void 0:t.split(";"),o=null==s?void 0:s[0];if("multipart/related"!==o&&"multipart/mixed"!==o)return null;const i={boundary:"",start:"",type:""};for(let e=1;e<s.length;e++){const t=s[e].split("=");i[t[0].trim()]=t[1].trim().slice(1,t[1].length-1)}return i}(e);if(!t)return{isMultipart:!1,data:null};return{isMultipart:!0,data:function(e,t){const s="--"+t.boundary,o=[];for(let e=0;e<s.length;e++)o.push(s.charCodeAt(e));const i=[],r="\n--"+t.boundary+"--";for(let e=0;e<r.length;e++)i.push(r.charCodeAt(e));const n=[10],a=[13,10],l=[],p=o.length,m=new Uint8Array(e),c=Math.min(1e4,m.length-p);let u=0,d=0;for(let e=0;e<c;e++){for(d=0;d<p&&m[e+d]===o[d];d++);d===p&&(u&&l.push(M(m.subarray(u,e),t)),e+=p-1,m[e+1]===n[0]?e+=1:m[e+1]===a[0]&&m[e+2]===a[1]&&(e+=2),u=e+1)}const h=i.length;for(let e=m.length-h-10;e<m.length-h;e++){for(d=0;d<h&&m[e+d]===i[d];d++);if(d===h){l.push(M(m.subarray(u,e),t));break}}return l}(e.data,t)}}function M(e,t){const s=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split("\n"),o=Math.min(s.length,7),i={};let r=0;for(let a=0;a<o;a++){var n;if(s[a].length<4)r=r+s[a].length+1;else if("content"===s[a].slice(0,7).toLowerCase()){if(r=r+s[a].length+1,-1===s[a].indexOf(":"))continue;const e=s[a].substring(0,s[a].indexOf(":")).trim(),t=s[a].substring(s[a].indexOf(":")+1).trim();switch(e.toLowerCase()){case"content-type":i.contentType=t;break;case"content-description":i.contentDescription=t;break;case"content-transfer-encoding":i.contentTransferEncoding=t;break;case"content-id":i.contentID=t;break;case"content-disposition":i.contentDisposition=t;break;case"content-location":i.contentLocation=t}}else{if(i.contentDisposition&&s[a].length>=4&&(null==(n=i.contentType)?void 0:n.toLowerCase().indexOf("image"))>-1){const t=new ArrayBuffer(e.length-r);new Uint8Array(t).set(e.subarray(r,e.length)),i.contentData=t;break}if((""===t.start||i.contentID===t.start)&&i.contentType){if(i.contentType.indexOf("text")>-1){i.contentData=String.fromCharCode.apply(null,e.subarray(r,e.length));break}i.contentData=e.subarray(r,e.length)}}}return i}function U(e){return e.indexOf("?")===e.length-1?e.substring(0,e.length-1):e}function E(e){const t={};for(let s=0;s<e.childNodes.length;s++){const o=e.childNodes[s];if(1!==o.nodeType)continue;const i=L(o).toLowerCase();switch(i){case"title":case"abstract":t[i]=w(o);break;case"identifier":t.id=w(o);break;case"wgs84boundingbox":{const e=k(o,"LowerCorner"),s=k(o,"UpperCorner");t.lonLatEnvelope=new p({xmin:e[0],ymin:e[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(E(o))}}return t}function A(e,t){if(e.coverageSummaries)for(let s=0;s<e.coverageSummaries.length;s++)e.coverageSummaries[s].abstract=e.coverageSummaries[s].abstract||e.abstract,e.coverageSummaries[s].lonLatEnvelope=e.coverageSummaries[s].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[s].title=e.coverageSummaries[s].title||e.title,A(e.coverageSummaries[s],t);null!=e.id&&t.push(e)}function V(e){const t=S(e.querySelector("Operation[name=GetCapabilities]"),"Get").getAttribute("xlink:href")||"",s=S(e.querySelector("Operation[name=DescribeCoverage]"),"Get").getAttribute("xlink:href")||"",o=S(e.querySelector("Operation[name=GetCoverage]"),"Get").getAttribute("xlink:href")||"";return{getCapabilities:U(t),describeCoverage:U(s),getCoverage:U(o)}}function F(e,t=null){let s=null;if("string"==typeof e){s=(new DOMParser).parseFromString(e,"text/xml")}else s=e;const o=s.documentElement.getAttribute("version"),i=(o||t||"1.0.0").slice(0,3);let r;if("2.0"===i)r=function(e){const t=S(e,"ServiceIdentification"),s=w(t,"Title"),o=I(t,"ServiceTypeVersion"),i=I(t,"Profile"),r=V(S(e,"OperationsMetadata")),n=C(e,"Contents/CoverageSummary"),a=[];for(let e=0;e<n.length;e++){const t=n[e],s=w(t,"CoverageId"),o=S(t,"WGS84BoundingBox");let i;if(o){const e=k(o,"LowerCorner"),t=k(o,"UpperCorner");i=new p({xmin:e[0],ymin:e[1],xmax:t[0],ymax:t[1],spatialReference:{wkid:4326}})}a.push({id:s,lonLatEnvelope:i})}const l=S(e,"ServiceMetadata");return{name:s,supportedVersions:o,supportedFormats:I(l,"formatSupported"),supportedInterpolations:I(l,"interpolationSupported"),onlineResources:r,profiles:i,coverages:a}}(s);else if("1.1"===i)r=function(e){const t=w(e,"ServiceIdentification/Title"),s=I(e,"ServiceIdentification/ServiceTypeVersion"),o=V(S(e,"OperationsMetadata")),i=[],r=S(e,"Contents");for(let e=0;e<r.childNodes.length;e++){const t=r.childNodes[e];1===t.nodeType&&D(t,"CoverageSummary")&&A(E(t),i)}return{name:t,onlineResources:o,coverages:i,supportedVersions:s,supportedFormats:I(r,"SupportedFormat")}}(s);else{if("1.0"!==i)throw new n("wcsraster:parsecapabilities","the capabilities version is not supported");r=function(e){var t,s,o;const i=w(e,"Service/name"),r=S(e,"Capability"),n=null!=(t=S(r,"GetCapabilities/Get/OnlineResource").getAttribute("xlink:href"))?t:"",a=null!=(s=S(r,"DescribeCoverage/Get/OnlineResource").getAttribute("xlink:href"))?s:"",l=null!=(o=S(r,"GetCoverage/Get/OnlineResource").getAttribute("xlink:href"))?o:"",m={getCapabilities:U(n),describeCoverage:U(a),getCoverage:U(l)},c=C(e,"CoverageOfferingBrief"),u=[];for(let e=0;e<c.length;e++){const t=c[e],s=w(t,"name"),o=C(t,"pos"),i=k(o[0]),r=k(o[1]),n=new p({xmin:i[0],ymin:i[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}});u.push({id:s,lonLatEnvelope:n})}return{name:i,onlineResources:m,coverages:u,supportedVersions:["1.0.0"]}}(s)}return r.capabilitiesVersion=o,r}function $(e){const t=I(e,"interpolationMethod"),s=e.getAttribute("default");return null!=s?[s].concat(t.filter((e=>e.toLowerCase()!==s.toLowerCase()))):t}function G(e){return null==e?["nearest"]:e.map((e=>{const t=e.toLowerCase();return t.indexOf("nearest")>-1?"nearest":t.indexOf("linear")>-1?"bilinear":t.indexOf("cubic")>-1?"cubic":null})).filter((e=>!!e))}function N(e){const t=C(e,"pos"),s=k(t[0]),o=k(t[1]);return new p({xmin:s[0],ymin:s[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:4326}})}function _(e){const t=[],s=C(e,"RangeSet");let o=[];for(let e=0;e<s.length;e++){const i=w(s[e],"name"),r=w(s[e],"label"),n=[],a=C(s[e],"AxisDescription");for(let e=0;e<a.length;e++){const t=w(a[e],"name"),s=w(a[e],"label"),i=I(a[e],"singleValue");if(0===i.length){const t=w(a[e],"min"),s=w(a[e],"max"),o=Number(w(a[e],"res"))||1;if(null!==t&&null!==s)for(let e=parseInt(t,10);e<=parseInt(s,10);e+=o)i.push(e.toString())}"band"===t.toLowerCase()&&(o=i),n.push({name:t,label:s,values:i})}t.push({name:i,label:r,axis:n})}return{rangeSet:t,bandNames:o}}function B(e){const t=C(e,"timeposition");if(t.length>0){const e=[];for(let s=0;s<t.length;s++)e.push(new Date(w(t[s])));return{begin:e[0],end:e[e.length-1],values:e}}const s=S(e,"timePeriod");if(s){return{begin:new Date(w(s,"beginPosition")),end:new Date(w(s,"endPosition")),...function(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const s=["Y","M","D"],o=["H","M","S"],i=["Years","Months","Days","Hours","Minutes","Seconds"];let r,n,a;return-1===t.indexOf("PT")?(t=t.slice(1),a=s.findIndex((e=>t.indexOf(e)>-1)),a>-1&&(r=i[a]),n=parseFloat(t.substring(0,t.length-1))):(t=t.slice(2),a=o.findIndex((e=>t.indexOf(e)>-1)),r=i[3+a],n=parseFloat(t.substring(0,t.length-1))),{resolution:n,units:r}}(w(s,"timeResolution"))}}return null}function q(e){const t=S(e,"spatialDomain"),s=S(t,"Envelope")||S(t,"EnvelopeWithTimePeriod"),o=s.getAttribute("srsName").split(":"),i=o[o.length-1],r=C(s,"pos"),n=k(r[0]),a=k(r[1]),l=new p({xmin:n[0],ymin:n[1],xmax:a[0],ymax:a[1],spatialReference:{wkid:parseInt(i,10)}}),m=S(t,"RectifiedGrid"),c=w(m,"low").split(" "),u=w(m,"high").split(" "),d=parseInt(u[0],10)-parseInt(c[0],10)+1,h=parseInt(u[1],10)-parseInt(c[1],10)+1,f=k(t,"origin/pos"),g=C(t,"offsetVector"),y={envelope:l,columns:d,rows:h,offset:{x:parseFloat(w(g[0]).split(" ")[0]),y:parseFloat(w(g[1]).split(" ")[1])},origin:{x:f[0],y:f[1]}},b=S(e,"temporalDomain");return{spatialDomain:y,temporalDomain:b?B(b):null}}function z(e){const t=[],s=C(e,"Field");let o=[];for(let e=0;e<s.length;e++){const i=w(s[e],"Identifier"),r=w(s[e],"Description"),n=w(s[e],"Definition"),a=w(s[e],"Abstract"),l=w(s[e],"Title"),p=I(s[e],"InterpolationMethod"),m=[],c=C(s[e],"Axis");for(let e=0;e<c.length;e++){const t=c[e].getAttribute("identifier"),s=w(c[e],"valuesUnit"),i=w(c[e],"DataType"),r=I(c[e],"Key");"band"===t.toLowerCase()&&(o=r),m.push({identifier:t,valuesUnit:s,dataType:i,values:r})}t.push({identifier:i,description:r,definition:n,abstract:a,title:l,supportedInterpolations:p,axis:m})}return{rangeSet:t,bandNames:o}}function W(e){var t;const s=S(e,"SpatialDomain"),o=S(s,"GridCRS"),i=w(o,"GridBaseCRS"),r=w(o,"GridOrigin"),n=null!=(t=null==r?void 0:r.split(" ").map((e=>parseFloat(e))))?t:[0,0],a=k(o,"GridOffsets"),l=C(s,"BoundingBox");let m,c,u,d;for(let e=0;e<l.length;e++){var h;const t=null==(h=l[e].getAttribute("crs"))?void 0:h.toLowerCase();if(null!=t)if(t.indexOf("imagecrs")>-1){const t=k(l[e],"LowerCorner"),s=k(l[e],"UpperCorner");m=s[0]-t[0]+1,c=s[1]-t[1]+1}else if(t.indexOf("epsg")>0){const s=t.split(":");u=parseInt(s[s.length-1],10);const o=k(l[e],"LowerCorner"),i=k(l[e],"UpperCorner");d=new p({xmin:o[0],ymin:o[1],xmax:i[0],ymax:i[1],spatialReference:{wkid:u}})}}const f=m>c,g=d.xmax-d.xmin>d.ymax-d.ymin;let y=!1;P(u)&&(f===g?y=!1:(y=!0,d=new p({xmin:d.ymin,ymin:d.xmin,xmax:d.ymax,ymax:d.xmax,spatialReference:{wkid:u}})));const b={columns:m,rows:c,origin:{x:n[0],y:n[1]},offset:{x:a[0],y:a[1]},gridBaseCRS:i,envelope:d,useEPSGAxis:y},v=S(e,"temporalDomain");return{spatialDomain:b,temporalDomain:v?B(v):null}}function H(e,t){const s=[],o=[],i={supportedFormats:s,supportedCRSs:o,version:"1.1"};let r;for(let t=0;t<e.childNodes.length;t++){const n=e.childNodes[t];if(1!==n.nodeType)continue;const a=L(n).toLowerCase();switch(a){case"title":case"abstract":case"identifier":i[a]=w(n);break;case"supportedformat":{const e=w(n);-1===s.indexOf(e)&&s.push(e)}break;case"supportedcrs":{const e=w(n);-1===o.indexOf(e)&&o.push(e)}break;case"range":{const e=z(n);i.range=e.rangeSet,r=e.bandNames}break;case"domain":i.domain=W(n)}}const n=G(i.range[0].supportedInterpolations),{identifier:a,abstract:l,title:p,domain:m,range:c}=i,u={x:Math.abs(m.spatialDomain.offset.x),y:Math.abs(m.spatialDomain.offset.y)},d=function(e,t){const s=e.filter((e=>-1===e.identifier.toLowerCase().indexOf("field_1")&&!e.axis.some((e=>"band"===e.identifier.toLowerCase())))),o=[];if(s.length&&s.forEach((e=>{var t;const s=e.axis.map((e=>{const t=e.values.map((e=>parseFloat(e.trim()))),s=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.valuesUnit?e.valuesUnit.trim():"",hasRegularIntervals:!1,values:t,extent:s}}));o.push({name:e.identifier.trim(),description:null!=(t=null==e?void 0:e.description.trim())?t:"",unit:"",dimensions:s})})),t.temporalDomain){const{begin:e,end:s,values:i,units:r,resolution:n}=t.temporalDomain;o.forEach((t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:null==i?void 0:i.map((e=>e.getTime())),hasRegularIntervals:!i,interval:n,intervalUnit:r,extent:[e.getTime(),s.getTime()]})}))}return o.length?{variables:o}:null}(c,m),h=new j({width:m.spatialDomain.columns,height:m.spatialDomain.rows,pixelSize:u,extent:m.spatialDomain.envelope,spatialReference:m.spatialDomain.envelope.spatialReference,bandCount:r.length||1,multidimensionalInfo:d});return{id:a,title:i.title,description:l||p,lonLatEnvelope:null,bandNames:r,rasterInfo:h,supportedFormats:s,supportedInterpolations:n,coverageDescription:i,version:t,useEPSGAxis:m.spatialDomain.useEPSGAxis}}function J(e){const t=S(e,"Envelope")||S(e,"EnvelopeWithTimePeriod"),s=t.getAttribute("srsName"),o=s.slice(s.lastIndexOf("/")+1),i=t.getAttribute("axisLabels"),r=k(t,"lowerCorner"),n=k(t,"upperCorner"),a=!["y","lat","latitude","north","nor","n","b"].some((e=>e===i[0].toLowerCase()));let l;l=new p(a?{xmin:r[0],ymin:r[1],xmax:n[0],ymax:n[1],spatialReference:{wkid:parseInt(o,10)}}:{xmin:r[1],ymin:r[0],xmax:n[1],ymax:n[0],spatialReference:{wkid:parseInt(o,10)}});const m={mins:r,maxs:n},c=t.getAttribute("uomLabels").trim().split(" ");let u,d;return D(t,"EnvelopeWithTimePeriod")&&(u=new Date(w(e,"beginPosition")),d=new Date(w(e,"endPosition"))),{envelope:l,axisLabels:i,uomLabels:c.length?c:null,envelopeAllDims:m,beginPosition:u,endPosition:d,isEastFirst:a}}function Y(e){const t=[],s=C(e,"DataRecord"),o=[];for(let e=0;e<s.length;e++){const i=C(s[e],"field"),r=[];for(let e=0;e<i.length;e++){const t=i[e].getAttribute("name"),s=w(i[e],"description")||"",n=S(i[e],"uom").getAttribute("code")||"",a=k(i[e],"interval");t.toLowerCase().indexOf("band")>-1&&o.push(t),r.push({name:t,description:s,uom:n,allowedValues:a})}t.push(r)}return{rangeType:t,bandNames:o}}function Q(e){let t=1,s="";const o=.01;return Math.abs(e-1/24)<1/24*o?s="Hours":Math.abs(e-1)<.01?s="Days":e<1?(t=Math.round(24*e),s="Hours"):e>27.99&&e<31.01||Math.round(e/30)<12?s="Months":e>364.99&&e<366.01&&(s="Years"),{interval:t,intervalUnit:s}}function K(e){const t=S(e,"RectifiedGrid"),s=k(t,"low"),o=k(t,"high"),i=[];for(let e=0;e<s.length;e++)i.push(o[e]-s[e]+1);const r=w(t,"axisLabels").split(" "),n=k(t,"origin/pos"),a=C(t,"offsetVector"),l=[];for(let e=0;e<a.length;e++)l.push(parseFloat(w(a[e]).split(" ")[e]));let p,m,c;return["y","lat","latitude","north","nor","n","b"].some((e=>e===r[0].toLowerCase()))?(p=i[1],m=i[0],c={y:Math.abs(l[0]),x:Math.abs(l[1])}):(p=i[0],m=i[1],c={x:Math.abs(l[0]),y:Math.abs(l[1])}),{columns:p,rows:m,origin:n,offset:l,resolution:c,gridSamples:i,axisLabels:r}}function X(e){const t={version:"2.0"};let s=[];for(let o=0;o<e.childNodes.length;o++){const i=e.childNodes[o];if(1===i.nodeType)if(D(i,"coverageId"))t.coverageId=w(i);else if(D(i,"ServiceParameters"))t.serviceParameters={supportedFormats:I(i,"nativeFormat")};else if(D(i,"boundedBy"))t.boundedBy=J(i);else if(D(i,"rangeType")){const e=Y(i);t.rangeType=e.rangeType,s=e.bandNames}else D(i,"domainSet")&&(t.domainSet=K(i))}const{coverageId:o,boundedBy:i,domainSet:r,rangeType:n,serviceParameters:a}=t,l=function(e,t,s){const o=[];for(let t=0;t<e.length;t++){const s=e[t];for(let e=0;e<s.length;e++)-1===s[e].name.toLowerCase().indexOf("band")&&o.push(s[e])}const i=[];if(o.length){const e=[];for(let o=2;o<s.axisLabels.length;o++){const i=(t.uomLabels&&t.uomLabels.length)>o?t.uomLabels[o]:"",r=s.axisLabels[o].toLowerCase().indexOf("time")>-1||"iso8601"===i.toLowerCase();let n,a;if(r){const e=Q(s.offset[o]);n=e.interval,a=e.intervalUnit}else n=s.offset[o],a=i;const l=[];r?(l.push((new Date).setTime(24*(t.envelopeAllDims.mins[o]-25569)*3600*1e3)),l.push((new Date).setTime(24*(t.envelopeAllDims.maxs[o]-25569)*3600*1e3))):(l.push(t.envelopeAllDims.mins[o]),l.push(t.envelopeAllDims.maxs[o])),e.push({name:s.axisLabels[o].trim(),description:s.axisLabels[o].trim(),unit:t.uomLabels&&t.uomLabels.length>o?t.uomLabels[o].trim():"",hasRegularIntervals:!0,extent:l,interval:n,intervalUnit:a})}if(o.forEach((t=>i.push({name:t.name.trim(),description:t.description.trim(),unit:t.uom.trim(),dimensions:e}))),i.length)return{variables:i}}return null}(n,i,r);return{id:o,title:o,description:o,lonLatEnvelope:null,bandNames:s,rasterInfo:new j({width:r.columns,height:r.rows,pixelSize:r.resolution,extent:i.envelope,spatialReference:i.envelope.spatialReference,bandCount:s.length||1,multidimensionalInfo:l}),supportedFormats:a.supportedFormats,supportedInterpolations:null,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}function Z(e,t){let s=null;if("string"==typeof e){s=(new DOMParser).parseFromString(e,"text/xml")}else s=e;if("1.0.0"===t){return C(s,"CoverageOffering").map((e=>function(e){const t={version:"1.0"};let s=[];for(let i=0;i<e.childNodes.length;i++){const r=e.childNodes[i];if(1===r.nodeType)if(D(r,"description"))t.description=w(r);else if(D(r,"name"))t.name=w(r);else if(D(r,"label"))t.label=w(r);else if(D(r,"supportedFormats"))t.supportedFormats=I(r,"formats");else if(D(r,"supportedCRSs"))t.supportedCRSs={requestResponseCRSs:I(o=r,"requestResponseCRSs").map((e=>e.split(":")[1])),nativeCRSs:I(o,"nativeCRSs").map((e=>e.split(":")[1]))};else if(D(r,"supportedInterpolations"))t.supportedInterpolations=$(r);else if(D(r,"lonLatEnvelope"))t.lonLatEnvelope=N(r);else if(D(r,"rangeSet")){const e=_(r);t.rangeSet=e.rangeSet,s=e.bandNames}else D(r,"domainSet")&&(t.domainSet=q(r))}var o;const i=G(t.supportedInterpolations),{name:r,description:n,label:a,lonLatEnvelope:l,supportedFormats:p}=t,{spatialDomain:m}=t.domainSet,c={x:Math.abs(m.offset.x),y:Math.abs(m.offset.y)},u=new j({width:m.columns,height:m.rows,pixelSize:c,extent:m.envelope,spatialReference:m.envelope.spatialReference,bandCount:s.length||1});return{id:r,title:t.name,description:n||a,lonLatEnvelope:l,rasterInfo:u,bandNames:s,supportedFormats:p,supportedInterpolations:i,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}(e)))}const o=C(s,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?o.map((e=>H(e,t))):o.map((e=>X(e)))}const ee=["nearest neighbor","bilinear","bicubic"],te=["nearest","linear","cubic"],se=["nearest-neighbor","linear","cubic"];let oe=class extends R{constructor(){super(...arguments),this.datasetFormat="WCSServer"}async open(e){await this.init();const t=null==e?void 0:e.signal,s=await this._getCapabilities(t);if(this.capabilities=s,!this.version){var o;let e=null==(o=s.capabilitiesVersion)?void 0:o.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=s.capabilitiesVersion:(e=s.supportedVersions.find((e=>"2.0.1"===e))||s.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||s.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||s.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}this.coverageId||(this.coverageId=s.coverages[0].id);const i=s.coverages.filter((e=>e.id===this.coverageId))[0];if(null==i)throw new n("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);const r=await this._describeCoverage(t);this.coverageInfo=r[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=i.lonLatEnvelope,this.coverageInfo.supportedInterpolations=G(s.supportedInterpolations)),this.datasetName=this.coverageInfo.title;const{rasterInfo:a}=this.coverageInfo;this.createRemoteDatasetStorageInfo(a,512,512),this._set("rasterInfo",a);const{pixelType:l,bandCount:p}=await this._getPixelTypeAndBandCount(t);a.pixelType=l,1===a.bandCount&&p>1&&(a.bandCount=p),this.updateTileInfo()}async fetchRawTile(e,t,s,o={}){const{tileInfo:i,maximumPyramidLevel:r}=this.rasterInfo.storageInfo,a=i.lodAt(Math.max(r-e,0)),p=new l({x:a.resolution,y:a.resolution,spatialReference:i.spatialReference}),m=this.getTileExtent(p,t,s,i);let[c,u]=i.size;const d=this.rasterInfo.extent,h=m.xmax>d.xmax||m.ymin<d.ymin;let f=m;if(h&&(f=m.clone().intersection(d),c=Math.floor((f.xmax-f.xmin)/a.resolution),u=Math.floor((f.ymax-f.ymin)/a.resolution)),c<=1||u<=1)return null;const g=await this._getCoverage(f,c,u,o);if(!g)return null;let y=await this.decodePixelBlock(g,{width:c,height:u,planes:null,pixelType:null});if(y&&(y.width!==c||y.height!==u))throw new n("wcsraster-fetch",`the reponse has unexpected dimension width: ${y.width}, height: {pixelBlock.height}`);return h&&(y=x(y,{x:0,y:0},{width:i.size[0],height:i.size[1]})),y}async _getCapabilities(e){const t={service:"WCS",request:"GetCapabilities"};this.version&&(t.version=this.version,t.acceptVersions=this.version);try{const{data:s}=await this.request(this.url,{query:t,responseType:"xml",signal:e});return F(s)}catch(e){if(!i(e))throw new n("wcslayer:open","wcs capabilities is not valid or supported");throw e}}async _describeCoverage(e){const t={service:"WCS",request:"DescribeCoverage",version:this.version},s=this.version.slice(0,3);"1.0"===s?t.coverage=this.coverageId:"1.1"===s?t.identifiers=this.coverageId:"2.0"===s&&(t.coverageId=this.coverageId);try{const{data:s}=await this.request(this.url,{query:t,responseType:"xml",signal:e});return Z(s,this.version)}catch(e){if(!i(e))throw new n("wcslayer:open","wcs coverage description is not valid or supported");throw e}}async _getPixelTypeAndBandCount(e){const{pixelSize:o,extent:i,multidimensionalInfo:r}=this.rasterInfo,a=i.center,l=new p({xmin:a.x-o.x,xmax:a.x+o.x,ymin:a.y-o.y,ymax:a.y+o.y,spatialReference:i.spatialReference});let m;if(t(r)){const e=r.variables[0];m=[],e.dimensions.forEach((t=>{m.push(new v({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent[0]:t.values[0],isSlice:!0}))}))}const c=await this._getCoverage(l,2,2,{multidimensionalDefinition:m,signal:s(e)});if(!c)throw new n("wcsraster-open","unable to determine pixel type");const u=await this.decodePixelBlock(c,{width:2,height:2,planes:null,pixelType:null});return{pixelType:u.pixelType,bandCount:u.getPlaneCount()}}async _getCoverage(e,t,s,o){const{coverageDescription:i}=this.coverageInfo,{version:r}=i,a="2.0"===i.version?this._getCoverage201Parameters(e,t,s,o,i):"1.1"===i.version?this._getCoverage110Parameters(e,t,s,o,i):this._getCoverage100Parameters(e,t,s,o),l=await this.request(this.url,{query:a,signal:o.signal,responseType:"array-buffer"});if("1.0"===r)return l.data;const p=T(l);if(p.isMultipart){return p.data.filter((e=>{var t;return(null==(t=e.contentType)?void 0:t.toLowerCase().indexOf("image"))>-1}))[0].contentData}throw new n("wcsraster:getcoverage","response is not a valid coverage")}_getInterpolationIndex(e){return-1===this.coverageInfo.supportedInterpolations.indexOf(e)||"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0}_getCoverage100Parameters(e,t,s,o){const i=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,r=e.spatialReference.wkid,n=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"GEOTIFF",{bandIds:a,interpolation:l}=o,p=this._getInterpolationIndex(l),m=a?a.map((e=>this.coverageInfo.bandNames[e])):null,c=ee[p];return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:n,crs:`EPSG:${r}`,bbox:i,width:t,height:s,interpolation:c,band:null==m?void 0:m.join(",")}}_getCoverage110Parameters(e,t,s,o,i){const{multidimensionalDefinition:r,bandIds:n,interpolation:a}=o,l=e.spatialReference.wkid,p=`urn:ogc:def:crs:EPSG::${l}`,m=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"image/tiff",c=this._getInterpolationIndex(a),u=te[c],d=i.domain.spatialDomain,h=d.origin.x<=d.envelope.xmin&&d.origin.y<=d.envelope.ymin,f=e.width/t,g=e.height/s*(h?1:-1),y=h?[e.xmin,e.ymin]:[e.xmin,e.ymax],b=d.useEPSGAxis&&P(l),v=b?`${y[1]},${y[0]}`:`${y[0]},${y[1]}`,j=b?`${g},0,0,${f}`:`${f},0,0,${g}`,x=f/2,w=e.xmin+x,S=e.xmax-x,C=Math.abs(g)/2,k=e.ymin+C,I=e.ymax-C,D=b?`${k},${w},${I},${S},${p}`:`${w},${k},${S},${I},${p}`,L=i.range.filter((e=>e.axis.some((e=>e.identifier.toLowerCase().indexOf("band")>-1))))[0];let R,O=L&&u&&n?`${L.identifier}:${u}[${L.axis[0].identifier}[${n.join(",")}]]`:null;if(r)for(let e=0;e<r.length;e++){let t=r[e].values;const s=r[e].dimensionName.toLowerCase(),o=r[e].variableName.toLowerCase();if(t.length>0)if(t[0]instanceof Array&&(t=t[0]),"stdtime"===s)R=t.map((e=>this._convertToISOTime(e))).join(",");else{const e=i.range.filter((e=>e.identifier.toLowerCase()===o))[0];if(e){const o=e.axis.filter((e=>e.identifier.toLowerCase()===s))[0];o&&(O=e.identifier+":"+u+"["+o.identifier+"["+t.join(",")+"]]")}}}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:m,crs:`EPSG:${l}`,boundingbox:D,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:v,gridOffsets:j,gridBaseCRS:p,timeSequence:R,rangeSubset:O}}_convertToISOTime(e,t=!1){return(t?new Date(24*(e-25569)*60*60*1e3):new Date(e)).toISOString()}_getCoverage201Parameters(e,t,s,o,i){const{multidimensionalDefinition:r,interpolation:n}=o,a=this._getInterpolationIndex(n),l="http://www.opengis.net/def/interpolation/OGC/1/"+se[a],p=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().indexOf("tiff")>-1))||"image/tiff",{bandNames:m}=this.coverageInfo,{boundedBy:c,domainSet:u,rangeType:d}=i,h=c.isEastFirst?0:1,f=1-h,{axisLabels:g}=u,y=g[h],b=g[f],v=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,j=[];j.push(`${y},${v}(${e.xmin},${e.xmax})`),j.push(`${b},${v}(${e.ymin},${e.ymax})`);const x=[];if(g.length>2)for(let e=2;e<g.length;e++){const t=u.origin[e];if(g[e].toLowerCase().indexOf("time")>-1){let s=t.toString();c.uomLabels[e].toLowerCase().indexOf("ole")>-1&&(x.push(g[e]),s=this._convertToISOTime(t,!0)),j.push(g[e]+",http://www.opengis.net("+s+")")}else j.push(g[e]+",http://www.opengis.net("+t+")")}let w=null;if(r){const e=[];d.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let s=0;s<r.length;s++){const o=g.find((e=>e===r[s].dimensionName)),i=e.find((e=>e===r[s].variableName));if(-1===t.indexOf(i)&&t.push(i),o){let e=r[s].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=o.toLowerCase().indexOf("time")>-1?e.map((e=>this._convertToISOTime(e))).join(","):e.join(",");const s=j.findIndex((e=>0===e.indexOf(o+",http://www.opengis.net")));-1===s&&j.push(o+",http://www.opengis.net("+t+")"),-1!==s&&-1===j[s].indexOf("("+t+")")&&j.splice(s,1,o+",http://www.opengis.net("+t+")")}}}t.length&&(w=t.join(","))}else if(null!=m&&m.length){w=(o.bandIds?o.bandIds.map((e=>m[e])):m).join(",")}const S=j.join("&subset="),C=`${y}(${t}),${b}(${s})`;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:w,interpolation:l,scaleSize:C,subset:S,format:p,outputcrs:v}}};e([o({type:String,json:{write:!0}})],oe.prototype,"datasetFormat",void 0),e([o()],oe.prototype,"tileType",void 0),e([o({type:String,json:{write:!0}})],oe.prototype,"version",void 0),e([o({type:String,json:{write:!0}})],oe.prototype,"coverageId",void 0),oe=e([a("esri.layers.support.rasterDatasets.ImageServerRaster")],oe);var ie=oe;let re=class extends(y(g(u(f(O(c(m))))))){constructor(...e){super(...e),this.coverageId=null,this.customParameters=null,this.version=null,this.isReference=null,this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const s=t(e)?e.signal:null;return this.addResolvingPromise(this._openRaster(s)),r(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get fields(){return[new h({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})]}createPopupTemplate(e){return b(this,e)}async _openRaster(e){const t=new ie({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",customFetchParameters:this.customParameters}});if(await t.open({signal:e}),!t.rasterInfo)throw t.destroy(),new n("wcs-layer:load","cannot load resources on "+this.url);null==this.title&&this.setAtOrigin("title",t.datasetName,"service"),this.raster=t,this._configDefaultSettings()}};e([o()],re.prototype,"coverageId",void 0),e([o({json:{type:Object,write:!0}})],re.prototype,"customParameters",void 0),e([o()],re.prototype,"version",void 0),e([o()],re.prototype,"isReference",void 0),e([o({readOnly:!0})],re.prototype,"type",void 0),e([o(d)],re.prototype,"popupEnabled",void 0),e([o()],re.prototype,"popupTemplate",void 0),e([o({readOnly:!0,dependsOn:["title"]})],re.prototype,"defaultPopupTemplate",null),e([o({readOnly:!0,dependsOn:["rasterInfo"]})],re.prototype,"fields",null),re=e([a("esri.layers.WCSLayer")],re);var ne=re;export default ne;
