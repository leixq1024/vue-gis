/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{O as t,A as e}from"../chunks/ArrayPool.js";import"../chunks/object.js";import{d as s}from"../chunks/deprecate.js";import{clone as r,equals as i}from"./lang.js";import"../config.js";import{L as o,n}from"../chunks/Logger.js";import"../chunks/string.js";import{p as a,g as c,d as l,e as h,o as u,c as d}from"../chunks/metadata.js";import{g as p,v as _,property as f,s as g}from"./accessorSupport/decorators/property.js";import{a as v,n as y}from"../chunks/PropertyOrigin.js";import{schedule as m}from"./scheduling.js";import"./promiseUtils.js";import"../chunks/Message.js";import"./Error.js";import"../chunks/ensureType.js";import{subclass as b}from"./accessorSupport/decorators/subclass.js";let O=!1;function w(t){return void 0!==t.flags}class A{constructor(t,e){this._observers=t,this._observer=e}remove(){this._observers.delete(this._observer)}}class P{constructor(t,e){this.propertyName=t,this.metadata=e,this.flags=1,this._observers=null,this._accessedProperties=null,this._observationHandles=[],this.flags=1|(e.nonNullable?8:0)|(e.hasOwnProperty("value")?16:0)|(void 0===e.get?32:0)|(void 0===e.dependsOn?64:0)}destroy(){this._accessedProperties&&(this._accessedProperties.clear(),this._accessedProperties=null),this._observers&&(this._observers.clear(),this._observers=null),this._clearObservationHandles()}onPropertyAccessed(t){t!==this&&(null===this._accessedProperties&&(this._accessedProperties=new Set),this._accessedProperties.add(t))}onTrackingEnd(){this._clearObservationHandles(),this.flags|=32;const t=this._accessedProperties;if(null===t)return;const e=this._observationHandles;for(const s of t)e.push(s.observe(this));t.clear()}observe(t){return null===this._observers&&(this._observers=new Set),new A(this._observers.add(t),t)}notify(){2&~this.flags&&(this.flags|=1),this._notifyObservers()}invalidate(){this.notify()}commit(){this.flags&=-2,this._notifyObservers()}_notifyObservers(){if(null===this._observers)return;const t=this._observers.size,e=new Array(t);let s=t-1;for(const t of this._observers)e[s--]=t;const r=!O;for(;e.length;){const t=e.pop();if(w(t)){if(2&~t.flags&&(t.flags|=1),null===t._observers)continue;for(const s of t._observers)e.push(s)}else r&&t.notify()}}_clearObservationHandles(){for(const t of this._observationHandles)t.remove();this._observationHandles.length=0}}class j{constructor(){this._values=new Map}clone(t){const e=new j;return this._values.forEach(((s,i)=>{t&&t.has(i)||e.set(i,r(s))})),e}get(t){return this._values.get(t)}originOf(){return 6}keys(){return[...this._values.keys()]}set(t,e){this._values.set(t,e)}delete(t){this._values.delete(t)}has(t){return this._values.has(t)}forEach(t){this._values.forEach(t)}}let k,S=[];const H=o.getLogger("esri.core.Accessor");function E(t){void 0!==k&&k.onPropertyAccessed(t)}let z=!1,q=!1;function C(t,e,s){if(z)return I(t,e,s);V(t);const r=e.call(s);return $(),r}function I(t,e,s){const r=z;z=!0,V(t);let i=null;try{i=e.call(s)}catch(t){q&&H.error(t)}return $(),z=r,i}function V(t){k=t,S.push(t)}function $(){const t=S.pop();k=S.length>0?S[S.length-1]:void 0,void 0!==t&&t.onTrackingEnd()}function D(t,e){if(32&e.flags)return;const s=q;q=!1,64&e.flags?I(e,e.metadata.get,t):M(t,e),q=s}const x=[];function M(t,e){128&e.flags||(e.flags|=128,I(e,(()=>{const s=e.metadata.dependsOn||x;for(const e of s)if("string"==typeof e&&-1===e.indexOf("."))N(t,e,!1);else{const s=a(e);for(let e=0,r=t;e<s.length&&null!=r&&"object"==typeof r;++e)r=N(r,s[e],e!==s.length-1)}})),e.flags&=-129)}function N(t,e,s){const r="?"===e[e.length-1]?e.slice(0,-1):e;if(null!=t.getItemAt||Array.isArray(t)){const e=parseInt(r,10);if(!isNaN(e))return Array.isArray(t)?t[e]:t.getItemAt(e)}const i=c(t),o=null==i?void 0:i.properties.get(r);return o&&(E(o),D(t,o)),s?t[r]:void 0}o.getLogger("esri.core.accessorSupport.Properties");function L(t,e,s){return void 0!==t}function T(t,e,s,r){return void 0!==t&&(!(null==s&&8&t.flags)||(r.lifecycle,!1))}class G{constructor(t){this.host=t,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=0,this.store=new j,this._origin=6;const e=this.host.constructor.__accessorMetadata__,s=e.properties;for(const t in s){const e=new P(t,s[t]);this.properties.set(t,e)}this.metadatas=s,this._autoDestroy=e.autoDestroy}initialize(){this.lifecycle=1}constructed(){this.lifecycle=2}destroy(){if(this.destroyed=!0,this._autoDestroy)for(const[e,s]of this.properties){const r=this.internalGet(e);r&&((t=r)&&"function"==typeof t.destroy)&&(r.destroy(),8&~s.flags&&this._internalSet(s,null)),s.destroy()}else for(const[t,e]of this.properties)e.destroy();var t}get initialized(){return 0!==this.lifecycle}get(t){return this.properties.get(t).metadata.get?this.getterComputed(t):this.getterStatic(t)}getterStatic(t){const e=this.properties.get(t);if(void 0!==e)return E(e),this.store.has(t)?this.store.get(t):e.metadata.value}getterComputed(t){const e=this.properties.get(t);E(e);const s=this.store,r=e.flags,i=this.store.get(t);if(4&r)return i;if(s.has(t)&&(1&~r||O))return i;let o;e.flags|=4;const n=e.metadata.get;64&r?o=C(e,n,this.host):(M(this.host,e),o=n.call(this.host)),s.set(t,o,1);const a=this.store.get(t);return a===i?e.flags&=-2:e.commit(),e.flags&=-5,a}originOf(t){const e=this.store.originOf(t);if(void 0===e){const e=this.properties.get(t);if(void 0!==e&&16&e.flags)return"defaults"}return v(e)}has(t){return!!this.properties.has(t)&&this.store.has(t)}keys(){return[...this.properties.keys()]}internalGet(t){const e=this.properties.get(t);if(L(e))return this.store.has(t)?this.store.get(t):e.metadata.value}internalSet(t,e){const s=this.properties.get(t);L(s)&&this._internalSet(s,e)}getDependsInfo(t,e,s,r){const i=this.properties.get(s);if(!L(i))return"";let o=`${r}${e}.${s}: ${p(t,s)}\n`;if(!i.metadata.dependsOn||0===i.metadata.dependsOn.length)return o;r+="  ";for(const e of i.metadata.dependsOn){const s=e.split(".");if(1===s.length)o+=`${r}${e}: ${p(t,e)}\n`;else{const i=s[s.length-1];--s.length;const n=s.join("."),a=p(t,n),l=c(a);o+=l?l.getDependsInfo(a,n,i,r):`${r}${e}: undefined\n`}}return o}setAtOrigin(t,e,s){const r=this.properties.get(t);if(L(r))return this._setAtOrigin(r,e,s)}isOverridden(t){const e=this.properties.get(t);return void 0!==e&&!!(2&e.flags)}clearOverride(t){const e=this.properties.get(t);void 0!==e&&2&e.flags&&(e.flags&=-3,e.invalidate())}override(t,e){const s=this.properties.get(t);if(!T(s,0,e,this))return;const r=s.metadata.cast;if(r){const t=this._cast(r,e),{valid:s,value:i}=t;if(U.release(t),!s)return;e=i}s.flags|=2,this._internalSet(s,e)}set(t,e){const s=this.properties.get(t);if(!T(s,0,e,this))return;const r=s.metadata.cast;if(r){const t=this._cast(r,e),{valid:s,value:i}=t;if(U.release(t),!s)return;e=i}const i=s.metadata.set;i?i.call(this.host,e):this._internalSet(s,e)}setDefaultOrigin(t){this._origin=y(t)}getDefaultOrigin(){return v(this._origin)}propertyInvalidated(t){const e=this.properties.get(t);void 0!==e&&e.invalidate()}propertyCommitted(t){const e=this.properties.get(t);void 0!==e&&e.commit()}_internalSet(t,e){const s=0!==this.lifecycle?this._origin:0;this._setAtOrigin(t,e,s)}_setAtOrigin(t,e,s){const r=this.store,o=t.propertyName;r.has(o,s)&&i(e,r.get(o))&&2&~t.flags&&s===r.originOf(o)||(O=!0,t.invalidate(),O=!1,r.set(o,e,s),t.commit(),D(this.host,t))}_cast(t,e){const s=U.acquire();return s.valid=!0,s.value=e,t&&(s.value=t.call(this.host,e,s)),s}}const U=new t(class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}});class B extends t{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=n(this._set)}acquire(...t){const e=super.acquire(...t);return this._set.delete(e),e}release(t){t&&!this._set.has(t)&&(super.release(t),this._set.add(t))}_dispose(t){this._set.delete(t),super._dispose(t)}}class R{constructor(t){this.notify=t,this._accessedProperties=new Set,this._observationHandles=[]}destroy(){this._accessedProperties.clear(),this.clearObservationHandles()}onPropertyAccessed(t){this._accessedProperties.add(t)}onTrackingEnd(){this._accessedProperties.forEach((t=>{this._observationHandles.push(t.observe(this))})),this._accessedProperties.clear()}clearObservationHandles(){for(const t of this._observationHandles)t.remove();this._observationHandles.length=0}}function F(t,e){let s=new R((function(){if(!s||i)return;const o=r;s.clearObservationHandles(),i=!0,r=C(s,t),i=!1,e(o,r)})),r=null,i=!1;return i=!0,r=C(s,t),i=!1,{remove:function(){s&&(s.destroy(),s=null,r=null)}}}class J{constructor(){this.uid=0,this.target=null,this.path=null,this.oldValue=null,this.callback=null,this.getValue=null,this.removed=!1,this.propertyPath=null}acquire(t,e,s,r,i){this.target=t,this.path=e,this.oldValue=s,this.callback=r,this.getValue=i,this.propertyPath=l(e),this.uid=++J.uid,this.removed=!1}release(){this.target=this.path=this.propertyPath=this.callback=this.oldValue=null,this.uid=++J.uid,this.removed=!0}}J.pool=new B(J),J.uid=0;const K=new e,Q=new Set;let W,X=K.acquire();function Y(t){Q.has(t)?X.splice(X.indexOf(t),1):Q.add(t),X.push(t),W||(W=m(et))}function Z(t){if(t.removed)return;const{callback:e,path:s,oldValue:r,target:i}=t,o=t.getValue();tt(r,o)&&(t.oldValue=o,e.call(i,o,r,s,i))}function tt(t,e){return!i(t,e)}function et(){let t=10;for(;W&&t--;){W=null;const t=X;X=K.acquire(),Q.clear();const e=K.acquire();for(const s of t){const t=s.uid;Z(s),t===s.uid&&s.removed&&e.push(s)}for(let t=0;t<X.length;t++){const s=X[t];s.removed&&(e.push(s),Q.delete(s),X.splice(t,1),t-=1)}for(let t=0;t<e.length;t++)J.pool.release(e[t]);K.release(t),K.release(e),st.forEach((t=>t()))}}const st=new Set;function rt(t){return st.add(t),{remove(){st.delete(t)}}}function it(t,e,s){let r=h(t,e,s,((t,e,s)=>{let i,o,n=function(t,e){let s=new R((function(){e(r,i)})),r=null;function i(){return s?(s.clearObservationHandles(),r=C(s,t),r):null}return i(),{remove:function(){s&&(s.destroy(),s=null),r=null}}}((()=>_(t,e)),((n,a)=>{t.__accessor__.destroyed||i&&i.uid!==o?r.remove():(i||(i=J.pool.acquire(t,e,n,s,a),o=i.uid),Y(i))}));return{remove:u((function(){n.remove(),i&&(i.uid!==o||i.removed||(i.removed=!0,Y(i)),i=null),r=n=null}))}}));return r}function ot(t,e,s,r=!1){return!t.__accessor__||t.__accessor__.destroyed?{remove(){}}:r?function(t,e,s){const r=h(t,e,s,((t,e,s)=>{let i=!1;return F((()=>_(t,e)),((o,n)=>{t.__accessor__.destroyed?r.remove():i||(i=!0,tt(o,n)&&s.call(t,n,o,e,t),i=!1)}))}));return r}(t,e,s):it(t,e,s)}function nt(t){return X.some((e=>e.oldValue===t))}function at(t){if(null==t)return{value:t};if(Array.isArray(t))return{type:[t[0]],value:null};switch(typeof t){case"object":return t.constructor&&t.constructor.__accessorMetadata__||t instanceof Date?{type:t.constructor,value:t}:t;case"boolean":return{type:Boolean,value:t};case"string":return{type:String,value:t};case"number":return{type:Number,value:t};case"function":return{type:t,value:null};default:return}}class ct{constructor(...t){if(this.constructor===ct)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new G(this)}),t.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,t))}static createSubclass(t={}){if(Array.isArray(t))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:e,declaredClass:s,constructor:r}=t;delete t.declaredClass,delete t.properties,delete t.constructor;const i=this;class o extends i{constructor(...t){super(...t),this.inherited=null,r&&r.apply(this,t)}}d(o.prototype);for(const e in t){const s=t[e];o.prototype[e]="function"==typeof s?function(...t){const r=this.inherited;let o;this.inherited=function(...t){if(i.prototype[e])return i.prototype[e].apply(this,t)};try{o=s.apply(this,t)}catch(t){throw this.inherited=r,t}return this.inherited=r,o}:t[e]}for(const t in e){const s=at(e[t]);f(s)(o.prototype,t)}return b(s)(o)}postscript(t){const e=this.__accessor__,s=e.ctorArgs||t;e.initialize(),s&&(this.set(s),e.ctorArgs=null),e.constructed(),this.initialize()}initialize(){}destroy(){this.destroyed||(!function(t){for(let e=0;e<X.length;e++){const s=X[e];s.target===t&&(s.removed=!0)}}(this),this.__accessor__.destroy())}get initialized(){return this.__accessor__&&this.__accessor__.initialized||!1}get constructed(){return this.__accessor__&&2===this.__accessor__.lifecycle||!1}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}get(t){return p(this,t)}hasOwnProperty(t){return this.__accessor__?this.__accessor__.has(t):Object.prototype.hasOwnProperty.call(this,t)}isInstanceOf(t){return s(o.getLogger(this.declaredClass),"isInstanceOf",{replacement:"Use instanceof directly",version:"4.16"}),this instanceof t}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(t,e){return g(this,t,e),this}watch(t,e,s){return ot(this,t,e,s)}_clearOverride(t){return this.__accessor__.clearOverride(t)}_override(t,e){return this.__accessor__.override(t,e)}_isOverridden(t){return this.__accessor__.isOverridden(t)}notifyChange(t){this.__accessor__.propertyInvalidated(t)}_get(t){return this.__accessor__.internalGet(t)}_set(t,e){return this.__accessor__.internalSet(t,e),this}}export default ct;export{B as R,rt as a,nt as i,F as w};
