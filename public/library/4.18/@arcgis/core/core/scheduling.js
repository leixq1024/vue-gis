/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.18/esri/copyright.txt for details.
*/
import{a as t}from"../chunks/object.js";import"./lang.js";import"../config.js";import{a as e}from"../chunks/Logger.js";import"../chunks/string.js";import{createResolver as n,isAborted as r,createAbortError as s}from"./promiseUtils.js";import"../chunks/Message.js";import"./Error.js";const i=t.queueMicrotask?t.queueMicrotask:e=>{t.Promise.resolve().then(e)},a=[];let o=[];function h(t){a.push(t),1===a.length&&i((()=>{for(const t of o)t();const t=a.slice();a.length=0;for(const e of t)e()}))}!function(t){t.before=function(t){return o.push(t),{remove(){o=o.filter((e=>e!==t))}}}}(h||(h={}));var l=h;class c{constructor(t,e=29){this.name=t,this._counter=0,this._items=new Array(e)}record(t){this._items[++this._counter%this._items.length]=t}get median(){return this._items.slice().sort()[Math.floor(this._items.length/2)]}get average(){return this._items.reduce(((t,e)=>t+e),0)/this._items.length}get last(){return this._items[this._counter%this._items.length]}}class u{constructor(t=1){this._seed=t}set seed(t){this._seed=null==t?Math.random()*u._m:t}getInt(){return this._seed=(u._a*this._seed+u._c)%u._m,this._seed}getFloat(){return this.getInt()/(u._m-1)}getIntRange(t,e){return Math.round(this.getFloatRange(t,e))}getFloatRange(t,e){const n=e-t,r=this.getInt()/u._m;return t+Math.floor(r*n)}}function f(t){if(!t)return;const e=t.length;return e>0?t[e-1]:void 0}function d(t){return t}function g(t,e=d){if(!t||0===t.length)return;let n=t[0],r=e(n);for(let s=1;s<t.length;++s){const i=t[s],a=Number(e(i));a>r&&(r=a,n=i)}return n}function m(t,e=d){return g(t,(t=>-e(t)))}function _(t,e){return e?t.filter(((t,n,r)=>r.findIndex(e.bind(null,t))===n)):t.filter(((t,e,n)=>n.indexOf(t)===e))}function p(t,e,n){if(!t&&!e)return!0;if(!t||!e||t.length!==e.length)return!1;if(n){for(let r=0;r<t.length;r++)if(!n(t[r],e[r]))return!1}else for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}function v(t,e,n){let r,s;return n?(r=e.filter((e=>!t.some((t=>n(t,e))))),s=t.filter((t=>!e.some((e=>n(e,t)))))):(r=e.filter((e=>!t.includes(e))),s=t.filter((t=>!e.includes(t)))),{added:r,removed:s}}function w(t,e,n){return t&&e?n?t.filter((function(t){return e.findIndex((function(e){return n(t,e)}))>-1})):t.filter((function(t){return e.indexOf(t)>-1})):[]}function k(t){return t&&"number"==typeof t.length}function M(t,e){const n=t.length;if(0===n)return[];const r=[];for(let s=0;s<n;s+=e)r.push(t.slice(s,s+e));return r}u._m=2147483647,u._a=48271,u._c=0;const y=!!Array.prototype.fill;function A(t,e){if(y)return new Array(t).fill(e);const n=new Array(t);for(let r=0;r<t;r++)n[r]=e;return n}function x(t,e){void 0===e&&(e=t,t=0);const n=new Array(e-t);for(let r=t;r<e;r++)n[r-t]=r;return n}function b(t,e,n){const r=t.length;let s=0,i=r-1;for(;s<i;){const n=s+Math.floor((i-s)/2);e>t[n]?s=n+1:i=n}const a=t[s];return n?e>=t[r-1]?-1:a===e?s:s-1:a===e?s:-1}function F(t,e,n){if(!t||0===t.length)return;const r=t.length-1,s=t[0];if(e<=n(s))return s;const i=t[r];if(e>=n(i))return i;let a=0,o=0,h=r;for(;a<h;){o=a+Math.floor((h-a)/2);const s=t[o],i=n(s);if(i===e)return s;if(e<i){if(o>0){const r=t[o-1],a=n(r);if(e>a)return e-a>=i-e?s:r}h=o}else{if(o<r){const r=t[o+1],a=n(r);if(e<a)return e-i>=a-e?r:s}a=o+1}}return t[o]}function I(t){return t.reduce(((t,e)=>t.concat(e||[])),[])}class j{constructor(){this.last=0}}const T=new j;function q(t,e,n,r){r=r||T;const s=Math.max(0,r.last-10);for(let i=s;i<n;++i)if(t[i]===e)return r.last=i,i;const i=Math.min(s,n);for(let n=0;n<i;++n)if(t[n]===e)return r.last=n,n;return-1}function R(t,e,n,r){const s=null==n?t.length:n,i=q(t,e,s,r);if(-1!==i)return t[i]=t[s-1],null==n&&t.pop(),e}const S=new Set;function D(t,e,n){const r=t.length;if(e>=r)return t.slice(0);const s=N(n),i=new Set,a=[];for(;a.length<e;){const e=Math.floor(s()*r);i.has(e)||(i.add(e),a.push(t[e]))}return a}function N(t){return t?(z.seed=t,()=>z.getFloat()):Math.random}function U(t,e){const n=N(e);for(let e=t.length-1;e>0;e--){const r=Math.floor(n()*(e+1)),s=t[e];t[e]=t[r],t[r]=s}return t}const z=new u;function E(t,e){const n=t.indexOf(e);return-1!==n?(t.splice(n,1),e):null}var O;!function(t){function e(t,e,n,r){let s=e,i=e;const a=n>>>1,o=t[s-1];for(;i<=a;){i=s<<1,i<n&&r(t[i-1],t[i])<0&&++i;const e=t[i-1];if(r(e,o)<=0)break;t[s-1]=e,s=i}t[s-1]=o}function n(t,e){return t<e?-1:t>e?1:0}t.sort=function(t,r,s,i){void 0===r&&(r=0),void 0===s&&(s=t.length),void 0===i&&(i=n);for(let n=s>>>1;n>r;n--)e(t,n,s,i);const a=r+1;for(let n=s-1;n>r;n--){const s=t[r];t[r]=t[n],t[n]=s,e(t,a,n,i)}},t.iterableSort=function*(t,r,s,i){void 0===r&&(r=0),void 0===s&&(s=t.length),void 0===i&&(i=n);for(let n=s>>>1;n>r;n--)e(t,n,s,i),yield;const a=r+1;for(let n=s-1;n>r;n--){const s=t[r];t[r]=t[n],t[n]=s,e(t,a,n,i),yield}}}(O||(O={}));var P=O;class L{constructor(t){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new j,t&&(t.initialSize&&(this.data=new Array(t.initialSize)),t.allocator&&(this._allocator=t.allocator),void 0!==t.deallocator&&(this._deallocator=t.deallocator),t.shrink&&(this._shrink=()=>{this.data.length>1.5*this.length&&(this.data.length=Math.floor(1.1*this.length))}))}toArray(){return this.data.slice(0,this.length)}getItemAt(t){if(!(t<0||t>=this._length))return this.data[t]}get length(){return this._length}set length(t){if(t>this._length){if(this._allocator){for(;this._length<t;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=t}else{if(this._deallocator)for(let e=t;e<this._length;++e)this.data[e]=this._deallocator(this.data[e]);this._length=t,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(t){this.data[this._length++]=t}pushArray(t,e=t.length){for(let n=0;n<e;n++)this.data[this._length++]=t[n]}fill(t,e){for(let n=0;n<e;n++)this.data[this._length++]=t}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const t=this.data[this._length];return++this._length,t}pop(){if(0===this.length)return;const t=this.data[this.length-1];return this.length=this.length-1,this._shrink(),t}*iterableRemoveMany(t){const e=new Array;for(let n=0;n<this.length&&!(n>=this.length);++n)q(t.data,this.data[n],t.length,t._hint)<0&&e.push(this.data[n]),yield;this.data=e,this._length=this.data.length}remove(t){const e=q(this.data,t,this.length,this._hint);if(-1!==e)return this.data.splice(e,1),this.length=this.length-1,t}removeUnordered(t){const e=R(this.data,t,this.length,this._hint);return void 0!==e&&(this.length=this.length-1),e}removeUnorderedIndex(t){if(!(t>=this.length||t<0))return this.swapElements(t,this.length-1),this.pop()}removeUnorderedMany(t,e=t.length,n){this.length=function(t,e,n=t.length,r=e.length,s,i){if(0===r||0===n)return n;S.clear();for(let t=0;t<r;++t)S.add(e[t]);s=s||T;const a=Math.max(0,s.last-10);for(let e=a;e<n;++e)if(S.has(t[e])&&(i&&i.push(t[e]),S.delete(t[e]),t[e]=t[n-1],--n,--e,0===S.size||0===n))return S.clear(),n;for(let e=0;e<a;++e)if(S.has(t[e])&&(i&&i.push(t[e]),S.delete(t[e]),t[e]=t[n-1],--n,--e,0===S.size||0===n))return S.clear(),n;return S.clear(),n}(this.data,t,this.length,e,this._hint,n)}front(){if(0!==this.length)return this.data[0]}back(){if(0!==this.length)return this.data[this.length-1]}swapElements(t,e){t>=this.length||e>=this.length||t===e||([this.data[t],this.data[e]]=[this.data[e],this.data[t]])}sort(t){P.sort(this.data,0,this.length,t)}iterableSort(t){return P.iterableSort(this.data,0,this.length,t)}some(t,e){for(let n=0;n<this.length;++n)if(t.call(e,this.data[n],n,this.data))return!0;return!1}filterInPlace(t,e){let n=0;for(let r=0;r<this._length;++r){const s=this.data[r];t.call(e,s,r,this.data)&&(this.data[r]=this.data[n],this.data[n]=s,n++)}if(this._deallocator)for(let t=n;t<this._length;t++)this.data[t]=this._deallocator(this.data[t]);return this._length=n,this}forAll(t,e){const n=this.length,r=this.data;for(let s=0;s<n;++s)t.call(e,r[s],s,r)}*iterableForEach(){for(let t=0;t<this.length;++t)yield this.data[t]}map(t,e){const n=new Array(this.length);for(let r=0;r<this.length;++r)n[r]=t.call(e,this.data[r],r,this.data);return n}reduce(t,e){let n=e;for(let e=0;e<this.length;++e)n=t(n,this.data[e],e,this.data);return n}}class B{constructor(t){this.phases=t,this.paused=!1,this.ticks=-1,this.removed=!1}}class C{constructor(t){this.callback=t,this.isActive=!0}remove(){this.isActive=!1}}let G=-1,H=0;const J={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},K=["prepare","preRender","render","postRender","update"],Q=[],V=new L;class W{constructor(t){this._task=t}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const X={frameTasks:V,rafId:null,requestNextFrame:null,willDispatch:!1,clearFrameTasks:function(t=!1){V.forAll((t=>{t.removed=!0})),t&&rt()},dispatch:st,executeFrameTasks:function(t=performance.now()){G<0&&(G=t);const e=t-G,n=H>0?H:1e3/60,r=Math.max(0,e-n);G=t;const s=performance.now();for(let s=0;s<K.length;s++){const i=performance.now(),a=K[s];V.forAll((i=>{var o;if(i.paused||i.removed)return;0===s&&i.ticks++;i.phases[a]&&(J.time=t,J.deltaTime=0===i.ticks?0:e,J.elapsedFrameTime=performance.now()-t,J.frameDuration=n-r,null==(o=i.phases[a])||o.call(i,J))})),ot[s].record(performance.now()-i)}rt(),ht.record(performance.now()-s)}};function Y(t){const e=new C(t);return Q.push(e),X.willDispatch||(X.willDispatch=!0,l(st)),e}function Z(t){const e=new B(t);return V.push(e),X.rafId||(G=-1,X.rafId=et()),new W(e)}function $(t){H=Math.max(0,t)}function tt(t=performance.now()){X.rafId=null,V.length>0&&(X.rafId=et()),X.executeFrameTasks(t)}function et(){return X.requestNextFrame?X.requestNextFrame(it):it()}const nt=new L;function rt(){V.forAll((t=>{t.removed&&nt.push(t)})),V.removeUnorderedMany(nt.data,nt.length),nt.clear()}function st(){for(;Q.length;){const t=e(Q.shift());t.isActive&&t.callback()}X.willDispatch=!1}function it(){return requestAnimationFrame(tt)}function at(t=1,e){const i=n(),a=()=>{r(e)?i.reject(s()):0===t?i():(--t,l((()=>a())))};return a(),i.promise}const ot=K.map((t=>new c(t))),ht=new c("total");export{W as FrameTaskHandle,L as P,u as R,c as a,Z as addFrameTask,E as b,A as c,v as d,X as debug,p as e,I as f,b as g,x as h,w as i,F as j,m as k,f as l,g as m,l as n,q as o,D as p,ot as performanceInfo,ht as performanceTotal,j as q,R as r,et as requestNextFrame,M as s,Y as schedule,$ as setFrameDuration,k as t,_ as u,U as v,at as waitTicks};
