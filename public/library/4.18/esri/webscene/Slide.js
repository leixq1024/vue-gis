// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/maybe ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/accessorSupport/decorators/cast ../core/jsonMap ../core/accessorSupport/decorators/subclass ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../core/promiseUtils ../core/JSONSupport ../core/Collection ../core/collectionUtils ../core/asyncUtils ../Basemap ../chunks/vec3f64 ../chunks/vec3 ../views/3d/support/mathUtils ../support/basemapUtils ../layers/Layer ../Viewpoint ../webdoc/support/Thumbnail ./Lighting ../layers/mixins/OperationalLayer ./support/Description ./support/SlideEnvironment ./support/SlideGround ./support/SlideVisibleLayer ./support/Title".split(" "),
function(C,g,f,D,P,x,m,q,ea,Q,fa,ha,ia,u,R,E,S,T,U,y,F,V,G,W,X,p,Y,Z,v,H,I,J,r){function K(d){if("building-scene"===d.type||"map-image"===d.type)return d.allSublayers.toArray()}function L(d){if(d=K(d))return d.filter(k=>k.visible).map(k=>k.id)}function aa(d,k){d=k-d;43200<d&&(d-=86400);-43200>d&&(d+=86400);return d}let ba=0;const z=E.ofType(J["default"]),ca=P.getLogger("esri.webscene.Slide");f=function(d){function k(a){a=d.call(this,a)||this;a._applyToController=null;a.id=Date.now().toString(16)+
"-slide-"+ba++;a.title=new r;a.description=new v;a.thumbnail=new p;a.viewpoint=null;a.basemap=null;a.ground=null;a.environment=new H.SlideEnvironment;a.visibleLayers=new z;return a}C._inheritsLoose(k,d);var e=k.prototype;e.destroy=function(){this.visibleLayers.removeAll();this.basemap=null;this.thumbnail&&this.thumbnail.destroy();this.thumbnail=this.title=this.description=null};e.castTitle=function(a){return"string"===typeof a?new r({text:a}):x.ensureType(r,a)};e.castDescription=function(a){return"string"===
typeof a?new v({text:a}):x.ensureType(v,a)};e.castThumbnail=function(a){return"string"===typeof a?new p({url:a}):x.ensureType(p,a)};e.castBasemap=function(a){return G.ensureType(a)};e.castVisibleLayers=function(a){return a&&"function"===typeof a.map?a.map(b=>{if("string"===typeof b)return{id:b};if(b instanceof W){const c=L(b);return{id:b.id,sublayerIds:c}}if(b.id)return{id:b.id,sublayerIds:b.sublayerIds};ca.warn('Invalid visible layer, expected { id }, Layer or "id"');return b}):null};e.clone=function(){return new this.constructor({id:this.id,
title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})};e._updateVisibleLayersFrom=function(a){const b=[];return u.eachAlways(this._allLayers(a.map).map(c=>a.whenLayerView(c).then(h=>
{if(h.visible){const l=L(c);b.push(new J["default"]({id:h.layer.id,sublayerIds:l}))}})).toArray()).then(()=>{this.visibleLayers.removeAll();this.visibleLayers.addMany(b)})};e.updateFrom=function(a,b){b={screenshot:{format:"png",quality:80,width:120,height:75,disableDecorations:!0,...b&&b.screenshot}};return a.when(()=>{this.viewpoint=a.viewpoint.clone();this.environment.lighting=Y.prototype.clone.apply(a.environment.lighting);this.basemap=a.map.basemap&&a.map.basemap.clone()||null;this.ground=a.map.ground?
I.fromGround(a.map.ground):null;return this._updateVisibleLayersFrom(a)}).then(()=>a.takeScreenshot(b.screenshot)).then(c=>{this.thumbnail=new p({url:c.dataUrl});return this})};e.applyTo=async function(a,b){var c;this._applyToController&&this._applyToController.abort();let h=u.createAbortController();this._applyToController=h;let l=u.onAbortOrThrow(b,()=>h.abort());const w={animate:!0,...b,signal:this._applyToController.signal};b=await T.result((async()=>{await this._applyBasemap(a,w);this._applyLayerVisibility(a);
this._applyGround(a);await this._applyViewpoint(a,w)})());this._applyToController===h&&(this._applyToController=null);null==(c=l)?void 0:c.remove();h=l=null;if(!1===b.ok)throw b.error;return this};e._applyBasemap=async function(a,b){if(this.basemap){try{await this.basemap.load(b)}catch(c){if(u.isAbortError(c))throw c;}a.map.basemap=G.clonePreservingTiledLayers(this.basemap,a.map.basemap)}};e._applyGround=function(a){this.ground&&(a.map.ground=this.ground.cloneAndApplyTo(a.map.ground))};e._allLayers=
function(a){const b=new E;this._collectLayers(a,b);this._collectLayers(a.ground,b);return b};e._collectLayers=function(a,b){a.layers.forEach(c=>{Z.isOperationalLayer(c)&&(b.add(c),c.layers&&this._collectLayers(c,b))})};e._applyLayerVisibility=function(a){this.visibleLayers&&this._allLayers(a.map).forEach(b=>{var c=this.visibleLayers.find(l=>l.id===b.id);b.visible=null!=c;const h=c&&c.sublayerIds;c=K(b);h&&c&&c.forEach(l=>l.visible=0<=h.indexOf(l.id))})};e._applyViewpoint=async function(a,b){if(this.viewpoint&&
!b.ignoreViewpoint){D.isSome(this.viewpoint.camera)&&(this.viewpoint.camera.fov=a.camera.fov);if(b.animate&&this.get("environment.lighting.date")){await this._animateToLighting(a,b);return}b.animate&&(a.environment.updateLighting(this.environment.lighting.clone()),await a.goTo(this.viewpoint,b));a.viewpoint=this.viewpoint}a.environment.updateLighting(this.environment.lighting.clone())};e._animateToLighting=async function(a,b){let c=null;"global"===a.viewingMode&&(c=this._animateLightingWithCamera(a));
a.environment.lighting.cameraTrackingEnabled=!1;a.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled;null!=this.environment.lighting.displayUTCOffset&&(a.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);return a.goTo(this.viewpoint,b).then(()=>{a.environment.updateLighting(this.environment.lighting.clone());c&&c.remove();a.environment.lighting.cameraTrackingEnabled=!0},h=>{c&&c.remove();a.environment.lighting.cameraTrackingEnabled=
!0;throw h;})};e._getTime=function(a){const b=a.getTime();a=3600*a.getUTCHours()+60*a.getUTCMinutes()+a.getUTCSeconds();return[b,a]};e._setTime=function(a,b,c){a.setTime(b);a.setUTCHours(c/3600);a.setUTCMinutes(c%3600/60);a.setUTCSeconds(c%3600%60);return a};e._animateLightingWithCamera=function(a){const [b,c]=this._getTime(new Date(a.environment.lighting.date.toString())),[h,l]=this._getTime(this.environment.lighting.date),w=aa(c,l),A=a.renderCoordsHelper,M=y.create();A.toRenderCoords(a.camera.position,
M);const N=y.create(),B=y.create();D.isSome(this.viewpoint.camera)&&A.toRenderCoords(this.viewpoint.camera.position,N);const da=new Date;return a.watch("camera",n=>{A.toRenderCoords(n.position,B);var t=F.squaredDistance(M,B);const O=F.squaredDistance(N,B);n=0;0!==t+O&&(n=t/(t+O));t=b+(h-b)*n;n=V.moduloPositive(c+w*n,86400);a.environment.lighting.date=this._setTime(da,t,n)})};k.createFrom=function(a,b){return(new this).updateFrom(a,b)};C._createClass(k,[{key:"visibleLayers",set:function(a){this._set("visibleLayers",
S.referenceSetter(a,this._get("visibleLayers"),z))}}]);return k}(R.JSONSupport);g.__decorate([m.property({type:String,json:{write:{isRequired:!0}}})],f.prototype,"id",void 0);g.__decorate([m.property({type:r,json:{default:()=>new r({text:""}),write:{isRequired:!0}}})],f.prototype,"title",void 0);g.__decorate([q.cast("title")],f.prototype,"castTitle",null);g.__decorate([m.property({type:v,json:{write:{overridePolicy(d){return{enabled:!(!d||!d.text)}}}}})],f.prototype,"description",void 0);g.__decorate([q.cast("description")],
f.prototype,"castDescription",null);g.__decorate([m.property({type:p,json:{default:()=>new p({url:""}),write:{isRequired:!0}}})],f.prototype,"thumbnail",void 0);g.__decorate([q.cast("thumbnail")],f.prototype,"castThumbnail",null);g.__decorate([m.property({type:X,nonNullable:!0,json:{write:{isRequired:!0}}})],f.prototype,"viewpoint",void 0);g.__decorate([m.property({type:U,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],f.prototype,"basemap",void 0);g.__decorate([q.cast("basemap")],f.prototype,
"castBasemap",null);g.__decorate([m.property({type:I,json:{write:!0}})],f.prototype,"ground",void 0);g.__decorate([m.property({type:z,json:{write:{isRequired:!0}}})],f.prototype,"visibleLayers",null);g.__decorate([q.cast("visibleLayers")],f.prototype,"castVisibleLayers",null);g.__decorate([m.property({type:H.SlideEnvironment,json:{write:!0}})],f.prototype,"environment",void 0);return f=g.__decorate([Q.subclass("esri.webscene.Slide")],f)});