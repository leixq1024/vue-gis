// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/Error ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/promiseUtils ../../support/arcadeOnDemand ../../layers/support/fieldUtils ../../core/watchUtils ../../layers/support/commonProperties ../../tasks/support/Query ./support/FeatureFilter ./support/FeatureEffect ./support/popupUtils".split(" "),
function(w,x,h,J,m,B,K,k,L,C,y,M,N,O,r,D,g,E,F,G,H,I,t){const z=B.getLogger("esri.views.layers.FeatureLayerView");w.FeatureLayerView=e=>{e=function(v){function u(...a){a=v.call(this,...a)||this;a._updatingRequiredFieldsPromise=null;a.effect=null;a.filter=null;a.timeExtent=null;a.layer=null;a.requiredFields=[];a.view=null;return a}x._inheritsLoose(u,v);var f=u.prototype;f.initialize=function(){E.init(this,"layer.renderer layer.labelingInfo layer.elevationInfo.featureExpressionInfo layer.displayField filter effect layer.timeInfo timeExtent".split(" "),
()=>this._handleRequiredFieldsChange(),!0)};f.highlight=function(a){throw Error("missing implementation");};f.createQuery=function(){var a={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};a=m.isSome(this.filter)?this.filter.createQuery(a):new G(a);m.isSome(this.timeExtent)&&(a.timeExtent=m.isSome(a.timeExtent)?a.timeExtent.intersection(this.timeExtent):this.timeExtent.clone());return a};f.queryFeatures=function(a,b){throw Error("missing implementation");};f.queryObjectIds=
function(a,b){throw Error("missing implementation");};f.queryFeatureCount=function(a,b){throw Error("missing implementation");};f.queryExtent=function(a,b){throw Error("missing implementation");};f._loadArcadeModules=function(a){if(a.get("expressionInfos.length"))return D.loadArcade()};f._handleRequiredFieldsChange=function(){const a=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",a);a.then(()=>{this._updatingRequiredFieldsPromise===a&&this._set("_updatingRequiredFieldsPromise",
null)})};f._updateRequiredFields=async function(){if(this.layer&&this.view){var a="3d"===this.view.type,{layer:b,layer:{fields:c,objectIdField:l,renderer:p,displayField:q}}=this,n=b.featureReduction,d=new Set;n=await r.eachAlways([p?p.collectRequiredFields(d,c):null,g.collectLabelingFields(d,b),a?g.collectElevationFields(d,b):null,m.isSome(this.filter)?g.collectFilterFields(d,b,this.filter):null,this.effect?g.collectFilterFields(d,b,this.effect.filter):null,n?g.collectFeatureReductionFields(d,b,n):
null]);b.timeInfo&&this.timeExtent&&g.collectFields(d,b.fields,[b.timeInfo.startField,b.timeInfo.endField]);for(const A of n)A.error&&z.error(A.error);g.collectField(d,c,l);a&&q&&g.collectField(d,c,q);a=Array.from(d).sort();this._set("requiredFields",a)}};f.validateFetchPopupFeatures=function(a){const {layer:b,layer:{popupEnabled:c}}=this;if(!c)return new y("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:b});if(!t.getFetchPopupTemplate(this.layer,a))return new y("featurelayerview:fetchPopupFeatures",
"Layer does not define a popup template",{layer:b})};f.fetchClientPopupFeatures=async function(a){const b=m.isSome(a)?a.clientGraphics:null;if(!b||0===b.length)return r.resolve([]);const c=[],l=[],{layer:p}=this;var q=t.getFetchPopupTemplate(p,a);if(!m.isSome(q))return r.resolve([]);var n=await this._loadArcadeModules(q);q=n&&n.arcadeUtils.hasGeometryOperations(q);a=await this.createPopupQuery(a);n=g.unpackFieldNames(p.fields,a.outFields);for(const d of b)q||!g.featureHasFields(n,d)?l.push(d):c.push(d);
if("stream"===p.type||0===l.length)return r.resolve(c);a.objectIds=l.map(d=>d.attributes[p.objectIdField]);return p.queryFeatures(a).then(d=>c.concat(d.features)).catch(()=>l)};f.createPopupQuery=async function(a){var b=this.layer;const c=b.createQuery();a=t.getFetchPopupTemplate(b,a);var l=m.isSome(a)&&await this._loadArcadeModules(a);l=m.isSome(a)&&l&&l.arcadeUtils.hasGeometryOperations(a);b=!("point"!==b.geometryType&&!l);c.returnGeometry=b;c.returnZ=b;c.returnM=b;c.outFields=await t.getRequiredFields(this.layer,
a);c.outSpatialReference=this.view.spatialReference;return c};f.canResume=function(){return!v.prototype.canResume.call(this)||m.isSome(this.timeExtent)&&this.timeExtent.isEmpty?!1:!0};x._createClass(u,[{key:"availableFields",get:function(){const {layer:a,layer:{fields:b},requiredFields:c}=this;return"outFields"in a&&a.outFields?g.fixFields(b,[...g.unpackFieldNames(b,a.outFields),...c]):g.fixFields(b,c)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(a){z.error("#maximumNumberOfFeatures\x3d",
"Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]);return u}(e);h.__decorate([k.property()],e.prototype,"_updatingRequiredFieldsPromise",void 0);h.__decorate([k.property({readOnly:!0,dependsOn:["layer.outFields?","requiredFields"]})],e.prototype,"availableFields",null);h.__decorate([k.property({type:I})],e.prototype,"effect",void 0);h.__decorate([k.property({type:H})],e.prototype,"filter",void 0);h.__decorate([k.property(F.combinedViewLayerTimeExtentProperty)],
e.prototype,"timeExtent",void 0);h.__decorate([k.property()],e.prototype,"layer",void 0);h.__decorate([k.property({type:Number})],e.prototype,"maximumNumberOfFeatures",null);h.__decorate([k.property({readOnly:!0,type:Boolean})],e.prototype,"maximumNumberOfFeaturesExceeded",null);h.__decorate([k.property({readOnly:!0})],e.prototype,"requiredFields",void 0);h.__decorate([k.property({dependsOn:["timeExtent"]})],e.prototype,"suspended",void 0);h.__decorate([k.property()],e.prototype,"view",void 0);return e=
h.__decorate([C.subclass("esri.views.layers.FeatureLayerView")],e)};Object.defineProperty(w,"__esModule",{value:!0})});