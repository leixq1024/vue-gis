// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/scheduling ../../../../core/Accessor ../../../../core/Evented ../../../../layers/support/timeUtils ../../../../core/watchUtils ../../../webgl/context-util ../lib/AutoDisposable ../../../webgl/RenderingContext ../core/shaderTechnique/CommonUniformStore ../core/shaderTechnique/ShaderTechniqueRepository ../lib/GLMaterialRep ../materials/lineStippleUtils ../lib/WebGLDriverTest ../../support/animationUtils ./requireUtils ../statistics/tracer ../collections/Component/ComponentObjectCollection ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/MagnifierHelper ../lib/Renderer ../lib/TextureRepository ../materials/internal/WaterTextureRepository ./ScreenshotManager".split(" "),
function(e,r,f,t,u,v,U,m,V,w,W,X,Y,x,y,z,A,B,C,g,D,E,F,G,H,I,J,K,n,L,M,N,O,P,Q,R,S){const T=v.getLogger("esri.views.3d.webgl-engine.parts.View");let p=null;e.RenderView=function(q){function l(b){var a=q.call(this,{})||this;a._stage=b;a.events=new z;a._stippleTextureRepository=new H.StippleTextureRepository;a.waterTextureRepository=new R.WaterTextureRepository;a._magnifierHelper=new O.MagnifierHelper;a._commonUniformStore=new E.CommonUniformStore;a._componentObjectCollection=null;a._needsUpdate=!0;
a._needsRender=!0;a._idleSuspend=!0;a._logicUpdateLast=0;a._container=a._stage.container;a._initializeContext(a._stage.options);B.init(a.waterTextureRepository,"loadingState",()=>a.setNeedsRender());a._magnifierHelper.events.on("request-render",()=>a.setNeedsRender());a._shaderTechniqueRepository=new F.ShaderTechniqueRepository({rctx:a._rctx,viewingMode:a._stage.options.viewingMode,commonUniformStore:a._commonUniformStore,stippleTextureRepository:a._stippleTextureRepository,waterTextureRepository:a.waterTextureRepository});
a._textureRepository=new Q.TextureRepository(a._stage.scheduler,a._stage.getAll(4),a._shaderTechniqueRepository,a._rctx);a._textureRepository.events.on("changed",c=>a.setNeedsRender(c));a._materialRepository=new G(a._textureRepository,a._shaderTechniqueRepository,()=>a.setNeedsRender());a._compositingHelper=new M(a._rctx,a._shaderTechniqueRepository);b=a._container.getBoundingClientRect();a._renderer=new P(a._materialRepository,a._textureRepository,a._shaderTechniqueRepository,a._rctx,a._compositingHelper,
a._magnifierHelper,(c=1)=>a.setNeedsRender(c),[b.width,b.height],a._stage);a._screenshotManager=new S.ScreenshotManager(a._rctx,(c,k,h)=>a._render(c,k,h),()=>a.setNeedsRender(),a._stage.options.screenshot.renderOverlay,c=>a.events.emit("force-camera-for-screenshot",c));a._registerFrameTask();return a}r._inheritsLoose(l,q);var d=l.prototype;d.normalizeCtorArgs=function(){return{}};d.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask&&
(this._frameTask.remove(),this._frameTask=null);this._shaderTechniqueRepository.dispose();this._shaderTechniqueRepository=null;I.clearTestWebGLDriver(this._rctx);q.prototype.dispose.call(this);this._rctx=null};d.setNeedsRender=function(b=1){1===b?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0};d.evaluateUpdating=function(){return this.needsUpdate||this._renderer.updating||0<this._textureRepository.loadingCount||this.waterTextureRepository.updating||this._magnifierHelper.updating||
this._stage.dirty};d.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};d.setRenderParameters=function(b){this.setNeedsRender();void 0!==b.idleSuspend&&(this._idleSuspend=!!b.idleSuspend);this._renderer.setRenderParameters(b)};d.has=function(b){switch(b){case 0:return!!this._rctx.capabilities.compressedTextureS3TC;case 1:return!!this._rctx.capabilities.shaderTextureLOD;case 2:return this._renderer.hasShadowsEnabled;default:return!1}};d.modify=function(b,a,c){this._renderer.modify(b,
b.length,a,a.length,c,c.length)};d.setCamera=function(b){this._renderer.camera=b};d.getCamera=function(){return this._renderer.camera};d.getCanvas=function(){return this._canvas};d.takeScreenshot=function(b){return this._screenshotManager.takeScreenshot(b)};d.getMinimalDepthForArea=function(b,a,c,k=80,h=1){b=c.constrainWindowSize(b,a,k*c.pixelRatio,h);p=new Uint8Array(4*b[2]*b[3]);this._renderer.readDepthPixels(b[0],b[1],b[2],b[3],p);a=Number.MAX_VALUE;for(k=0;k<b[2]*b[3];k++)h=N.texure2depth(4*k,
p,c.nearFar),a>h&&h!==c.nearFar[0]&&h!==c.nearFar[1]&&(a=h);return a===Number.MAX_VALUE?void 0:a};d.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()};d.hotReloadShaders=async function(){K.removeLoadedShaderModules();await this._shaderTechniqueRepository.hotReload();this.setNeedsRender()};d._registerFrameTask=function(){const b={viewCamera:this._renderer.camera,frameHasDecorations:!1};let a=!1;this._frameTask=x.addFrameTask({preRender:c=>{a=this.evaluateUpdating();n.begin();let k=
!1;this._stage.processDirty();const h=A.Milliseconds(c.time-this._logicUpdateLast);h>J.DESIRED_ANIMATION_MS&&(k=this._renderer.updateLogic({camera:this._renderer.camera,dt:h}),this._logicUpdateLast=c.time);k&&this.setNeedsRender(0)},render:()=>{!this.needsUpdate&&!this._needsRender&&this._idleSuspend&&this._renderer.isCameraFinal||!this.canRender||(this._needsUpdate=this._needsRender=!1,this._render(null,this._renderer.camera,!1))},postRender:()=>{a!==this.evaluateUpdating()&&this.notifyChange("updating");
n.end()},update:()=>{b.viewCamera=this._renderer.camera;b.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled;this._textureRepository.update();this._screenshotManager.update(b)}})};d._initializeContext=function(b){this._canvas=b.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const a=n.instrumentContext(C.createContextOrErrorHTML(this._canvas,{alpha:b.alpha||!1,premultipliedAlpha:!0,
antialias:!1,depth:!0,stencil:null==b.stencil?!0:b.stencil,powerPreference:"high-performance"},b.renderContext));this._rctx=new D(a,{disabledExtensions:b.deactivatedWebGLExtensions||{},debugWebGLExtensions:b.debugWebGLExtensions||{}});null!=this._rctx.parameters.maxMaxAnisotropy&&(this._rctx.parameters.maxMaxAnisotropy=Math.min(this._rctx.parameters.maxMaxAnisotropy,8));this._loadShaderOnlyExtensions(this._rctx);!b.alpha&&this._rctx.contextAttributes.alpha&&T.error("WebGL context has alpha channel even though no alpha channel was requested");
!this._rctx.contextAttributes.alpha&&11<=t("safari")&&(this._container.style.backgroundColor="black");this._container.appendChild(this._canvas)};d._render=function(b,a,c){this._renderer.render(b,a,c)};d._loadShaderOnlyExtensions=function(b){b=b.capabilities;b.standardDerivatives;b.shaderTextureLOD;b.textureFloat};r._createClass(l,[{key:"performanceInfo",get:function(){const b=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==b.getUsedTextureMemory?b.getUsedTextureMemory():
void 0,renderbufferMemory:void 0!==b.getUsedRenderbufferMemory?b.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==b.getUsedVBOMemory?b.getUsedVBOMemory():void 0}}},{key:"canRender",get:function(){return this._renderer.canRender}},{key:"needsUpdate",get:function(){return this._needsUpdate}},{key:"updating",get:function(){return this.evaluateUpdating()}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",
get:function(){return this._compositingHelper}},{key:"magnifier",set:function(b){this._magnifierHelper.magnifier=b}},{key:"renderingContext",get:function(){return this._rctx}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},{key:"test",get:function(){return{renderer:this._renderer}}},{key:"componentObjectCollection",get:function(){u.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new L.ComponentObjectCollection(this._renderer.renderPassManager));
return this._componentObjectCollection},set:function(b){this._componentObjectCollection=b}}]);return l}(g.AutoDisposableMixin(y));f.__decorate([m.property({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating","_magnifierHelper.updating"],autoTracked:!1})],e.RenderView.prototype,"updating",null);f.__decorate([g.autoDispose()],e.RenderView.prototype,"_rctx",void 0);f.__decorate([g.autoDispose()],e.RenderView.prototype,"_container",void 0);f.__decorate([g.autoDispose()],e.RenderView.prototype,
"_canvas",void 0);f.__decorate([g.autoDispose()],e.RenderView.prototype,"_stippleTextureRepository",void 0);f.__decorate([g.autoDispose(),m.property()],e.RenderView.prototype,"waterTextureRepository",void 0);f.__decorate([g.autoDispose(),m.property()],e.RenderView.prototype,"_magnifierHelper",void 0);f.__decorate([g.autoDispose()],e.RenderView.prototype,"_textureRepository",void 0);f.__decorate([g.autoDispose()],e.RenderView.prototype,"_commonUniformStore",void 0);f.__decorate([g.autoDispose()],e.RenderView.prototype,
"_compositingHelper",void 0);f.__decorate([g.autoDispose()],e.RenderView.prototype,"_renderer",void 0);f.__decorate([g.autoDispose()],e.RenderView.prototype,"_screenshotManager",void 0);f.__decorate([g.autoDispose()],e.RenderView.prototype,"componentObjectCollection",null);f.__decorate([g.autoDispose()],e.RenderView.prototype,"_componentObjectCollection",void 0);e.RenderView=f.__decorate([w.subclass("esri.views.3d.webgl-engine.parts.RenderView")],e.RenderView);Object.defineProperty(e,"__esModule",
{value:!0})});