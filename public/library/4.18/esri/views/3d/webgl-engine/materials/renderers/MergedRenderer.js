// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../chunks/mat4 ../../../../../core/MapUtils ../../../../../chunks/mat4f64 ../../../support/buffer/glUtil ../../lib/Util ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject ./utils ../../lib/ResizableFloat32Array ../WaterGLMaterial ./Instance ../../statistics/RendererPerformanceInfo".split(" "),function(H,t,z,D,A,I,y,J,K,L,B,M,N,v,E){function O(w,n,c,a){const d=new Map,
f=n.vertexBufferLayout.stride/4,h=(e,l)=>{var b=e.origin;const g=w.get(b.id);let m=d.get(b.id);null==m&&(m={optimalCount:null==g?0:g.optimalCount,sparseCount:null==g?0:g.buffer.size,toAdd:[],toRemove:[],origin:b.vec3},d.set(b.id,m));b=n.elementCount(e.data)*f;l?(m.optimalCount+=b,m.sparseCount+=b,m.toAdd.push(e)):(m.optimalCount-=b,m.toRemove.push(e))};for(const e of c)h(e,!0);for(const e of a)h(e,!1);return d}let R=function(){function w(c,a,d){this.type="MergedRenderer";this._dataByOrigin=new Map;
this._hasOccludees=this._hasHighlights=!1;this._rctx=c;this._material=d;this._materialRep=a;this._glMaterials=B.acquireMaterials(this._material,this._materialRep);this._bufferWriter=d.createBufferWriter()}var n=w.prototype;n.dispose=function(){B.releaseMaterials(this._material,this._materialRep);this._dataByOrigin&&(this._dataByOrigin.forEach(c=>{c.vao.dispose(!0);c.vao=null}),this._dataByOrigin.clear(),this._dataByOrigin=null);this._glMaterials&&(this._glMaterials.forEach(c=>{c&&c.dispose()}),this._glMaterials.clear(),
this._glMaterials=null)};n.modify=function(c){this.updateGeometries(c.toUpdate);this.addAndRemoveGeometries(c.toAdd,c.toRemove);this.updateRenderCommands()};n.addAndRemoveGeometries=function(c,a){const d=this._bufferWriter,f=d.vertexBufferLayout,h=f.stride/4,e=this._dataByOrigin,l=O(e,d,c,a);l.forEach((b,g)=>{l.delete(g);var m=b.optimalCount;const q=b.sparseCount;let k=e.get(g);if(null==k)y.assert(0<m),k=this.createData(f,m,b.origin),e.set(g,k);else if(0===m){k.vao.dispose(!0);k.vao=null;e.delete(g);
return}const r=m<b.sparseCount/2;g=P;const p=k.buffer.size,x=k.buffer.array;m=k.buffer.resize(r?m:q,!1);r||m?this.removeAndRebuild(k,b.toRemove,h,x,g):0<b.toRemove.length?(this.removeByErasing(k,b.toRemove,h,g),0<b.toAdd.length&&(g.end=p)):(g.begin=p,g.end=p);m=Q;y.setMatrixTranslation3(m,-b.origin[0],-b.origin[1],-b.origin[2]);this.append(k,b.toAdd,h,m,g);b=k.vao.vertexBuffers.geometry;if(b.byteSize!==k.buffer.array.buffer.byteLength)b.setData(k.buffer.array);else{const {begin:F,end:G}=g;F<G&&(g=
4*F,b.setSubData(k.buffer.array,g,g,4*G))}k.drawCommandsDirty=!0})};n.updateGeometries=function(c){const a=this._bufferWriter,d=a.vertexBufferLayout.stride/4;for(const e of c){var f=e.updateType;c=e.renderGeometry;const l=this._dataByOrigin.get(c.origin.id),b=l&&l.instances.get(c.uniqueName);if(!b)break;f&1&&(b.isVisible=c.instanceParameters.visible);if(f&9){var h=c.instanceParameters.visible;b.hasHighlights=!!c.instanceParameters.highlights&&h}f&16&&(b.hasOccludees=!!c.instanceParameters.occludees);
f&6&&(f=l.buffer.array,h=l.vao,B.calculateTransformRelToOrigin(c,C,u),a.write({transformation:C,invTranspTransformation:u},c.data,a.vertexBufferLayout.createView(f.buffer),b.from),y.assert(b.from+a.elementCount(c.data)===b.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(f,b.from*d*4,b.from*d*4,b.to*d*4));l.drawCommandsDirty=!0}};n.updateRenderCommands=function(){this._hasOccludees=this._hasHighlights=!1;this._dataByOrigin.forEach(a=>{a.hasHiddenInstances=!1;a.hasHighlights=
!1;a.hasOccludees=!1;D.someMap(a.instances,d=>{d.isVisible?(d.hasHighlights&&(this._hasHighlights=!0,a.hasHighlights=!0),d.hasOccludees&&(this._hasOccludees=!0,a.hasOccludees=!0)):a.hasHiddenInstances=!0;return a.hasHiddenInstances&&a.hasHighlights&&a.hasOccludees})});const c=a=>{a.drawCommandsDefault=null;a.drawCommandsHighlight=null;a.drawCommandsOccludees=null;a.stats={default:0,highlight:0,occludees:0};if(0!==a.instances.size)if(a.hasOccludees||a.hasHighlights||a.hasHiddenInstances){var d=v.sortInstancesAccordingToRange([...a.instances.values()]);
a.drawCommandsDefault=[];a.drawCommandsHighlight=[];a.drawCommandsOccludees=[];for(const f of d)f.isVisible&&(f.hasOccludees?v.addOrMerge(a.drawCommandsOccludees,f):v.addOrMerge(a.drawCommandsDefault,f),f.hasHighlights&&v.addOrMerge(a.drawCommandsHighlight,f));d=f=>{let h=0;for(const e of f)h+=e.count;return h/3};a.stats={default:d(a.drawCommandsDefault),highlight:d(a.drawCommandsHighlight),occludees:d(a.drawCommandsOccludees)}}else d=4*a.buffer.size/K.getStride(a.vao.layout.geometry),a.drawCommandsDefault=
[{first:0,count:d}],a.stats={default:d,highlight:0,occludees:0}};this._dataByOrigin.forEach(a=>{a.drawCommandsDirty&&(c(a),a.drawCommandsDirty=!1)})};n.updateLogic=function(c){return this._material.update(c)};n.render=function(c,a,d,f){const h=this._rctx,e=this._glMaterials.get(a.pass),l=5===a.pass;let b=c;3===a.pass&&null===b&&(b=22);if(!e||2!==e.ensureResources(h)||null!=b&&!e.beginSlot(b)||l&&!this._hasHighlights)return!1;e.ensureParameters(d);const g=e.getTechnique(),m=e.getPipelineState(b,!1);
h.setPipelineState(m);e.bind(h,d);let q=!1;this._dataByOrigin.forEach(k=>{if(!(t.isNone(k.drawCommandsDefault)&&t.isNone(k.drawCommandsHighlight)&&t.isNone(k.drawCommandsOccludees)||l&&!k.hasHighlights)){d.origin=k.origin;g.bindDraw(d);g.ensureAttributeLocations(k.vao);h.bindVAO(k.vao);var r=g.primitiveType,p=l?k.drawCommandsHighlight:k.drawCommandsDefault,x=l?k.stats.highlight:k.stats.default;t.isSome(p)&&(this.renderCommands(h,r,p),E.addToRenderStats(p.length,x,f),q=!0);l||(p=k.drawCommandsOccludees,
t.isSome(p)&&(x=e.getPipelineState(b,!0),h.setPipelineState(x),this.renderCommands(h,r,p),h.setPipelineState(m),E.addToRenderStats(p.length,k.stats.occludees,f),q=!0))}});return q};n.renderCommands=function(c,a,d){for(let f=0;f<d.length;f++)c.drawArrays(a,d[f].first,d[f].count)};n.createData=function(c,a,d){return{instances:new Map,vao:new L(this._rctx,this._material.vertexAttributeLocations,{geometry:I.glLayout(c)},{geometry:J.createVertex(this._rctx,35044)}),buffer:new M.ResizableFloat32Array(a),
optimalCount:0,origin:d,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,stats:{default:0,highlight:0,occludees:0}}};n.removeAndRebuild=function(c,a,d,f,h){for(const q of a){a=q.uniqueName;const k=c.instances.get(a);c.optimalCount-=(k.to-k.from)*d;c.instances.delete(a)}let e=0;const l=c.buffer.array;h.begin=0;h.end=0;let b=-1,g=-1,m=0;c.instances.forEach(q=>{const k=q.from*d,r=q.to*d,p=r-k;b!==
g&&g!==k?(l.set(f.subarray(b,g),m),m+=g-b,b=k):-1===b&&(b=k);g=r;q.from=e/d;e+=p;q.to=e/d});b!==g&&l.set(f.subarray(b,g),m);h.end=e};n.removeByErasing=function(c,a,d,f){f.begin=Infinity;f.end=-Infinity;let h=-1,e=-1;for(const b of a){a=b.uniqueName;var l=c.instances.get(a);const g=l.from*d;l=l.to*d;h!==e&&e!==g?(c.buffer.erase(h,e),h=g):-1===h&&(h=g);e=l;c.instances.delete(a);c.optimalCount-=l-g;g<f.begin&&(f.begin=g);l>f.end&&(f.end=l)}h!==e&&c.buffer.erase(h,e)};n.append=function(c,a,d,f,h){const e=
this._bufferWriter;for(const b of a){var l=t.isSome(b.transformation)?z.multiply(C,f,b.transformation):f;z.invert(u,l);z.transpose(u,u);a=h.end;e.write({transformation:l,invTranspTransformation:u},b.data,e.vertexBufferLayout.createView(c.buffer.array.buffer),h.end/d);l=e.elementCount(b.data)*d;const g=a+l;y.assert(null==c.instances.get(b.uniqueName));const m=b.instanceParameters.visible;a=new v.Instance(a/d,g/d,m,!!b.instanceParameters.highlights&&m,!!b.instanceParameters.occludees);c.instances.set(b.uniqueName,
a);c.optimalCount+=l;h.end+=l}};H._createClass(w,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&D.someMap(this._glMaterials,c=>c instanceof N.WaterGLMaterial)}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"test",get:function(){return{material:this._material,
glMaterials:this._glMaterials}}}]);return w}();const P={begin:0,end:0},Q=A.create(),C=A.create(),u=A.create();return R});