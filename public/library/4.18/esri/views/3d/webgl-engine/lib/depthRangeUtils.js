// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/PooledArray ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../support/mathUtils ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec4f64 ../../../../chunks/vec4 ../../support/geometryUtils ./Util ./depthRange".split(" "),function(y,L,M,N,B,C,z,A,q,O,v,G,t){function H(h,g){if(g.isVisible){var a=t.empty(),b=g.getObjects();g.getSpatialQueryAccelerator()?P(a,h,g.getSpatialQueryAccelerator()):Q(a,
h,b);return a}}function P(h,g,a){var b=g.eye;const c=g.viewForward,d=g.frustum,e=l=>l.isVisible;var f=a.objectCount;500>f?(t.set(p,g.near,Math.min(h.near,g.far)),a.forEachInDepthRange(b,c,"front-to-back",p,(l,m)=>{D(h,g,l);p.far=h.near;m.setRange(p)},d,e),t.set(p,Math.max(h.far,g.near),g.far),a.forEachInDepthRange(b,c,"back-to-front",p,(l,m)=>{D(h,g,l);p.near=h.far;m.setRange(p)},d,e)):(f=Math.max(Math.min(f,500),Math.ceil(.1*f)),b=a.findClosest(c,"front-to-back",d,e,f),a=a.findClosest(c,"back-to-front",
d,e,f),b&&a&&(I(h,g,b.getCenter(),b.getBSRadius()),I(h,g,a.getCenter(),a.getBSRadius())))}function Q(h,g,a){w.clear();a.forEach(b=>{b.isVisible&&w.add(b)});w.empty||(w.sort(g),t.set(p,g.near,Math.min(h.near,g.far)),w.forEachInDepthRange(p,"front-to-back",(b,c)=>{c<h.near&&D(h,g,b)}),t.set(p,Math.max(h.far,g.near),g.far),w.forEachInDepthRange(p,"back-to-front",(b,c,d)=>{h.far=Math.max(h.far,d)}))}function D(h,g,a){if(a.isVisible&&v.frustum.intersectsSphere(g.frustum.planes,v.sphere.wrap(a.getBSRadius(),
a.getCenter()))){var b=a.objectTransformation,c=R;a.geometryRecords.forEach(d=>{z.multiply(c,b,d.getShaderTransformation());const e=C.maxScale(c);J(h,g,d.geometry.boundingInfo,c,e)})}}function J(h,g,a,b,c){var d=g.eye,e=g.viewForward;B.transformMat4(n,a.center,b);d=e[0]*(n[0]-d[0])+e[1]*(n[1]-d[1])+e[2]*(n[2]-d[2]);e=a.bsRadius*c;if(!(d-e>h.near&&d+e<h.far)&&v.frustum.intersectsSphere(g.frustum.planes,v.sphere.wrap(e,n)))if(100<a.bsRadius&&a.getChildren())for(a=a.getChildren(),d=0;8>d;++d)a[d]&&J(h,
g,a[d],b,c);else E.unionDepthRangeWithAABB(h,g.viewProjectionMatrix,b,a.bbMin,a.bbMax)}function I(h,g,a,b){const c=g.eye;g=g.viewForward;a=(a[0]-c[0])*g[0]+(a[1]-c[1])*g[1]+(a[2]-c[2])*g[2];h.near=Math.min(h.near,a-b);h.far=Math.max(h.far,a+b)}let S=function(){function h(){this._items=new M({allocator:a=>a||{obj:null,distance:0,near:0,far:0},deallocator:a=>{a.obj=null;a.distance=0;a.near=0;a.far=0;return a}})}var g=h.prototype;g.clear=function(){this._items.clear()};g.add=function(a){this._items.pushNew().obj=
a};g.sort=function(a){const b=a.eye,c=a.viewForward;this._items.forAll(d=>{var e=d.obj,f=e.getCenter();e=e.getBSRadius();f=(f[0]-b[0])*c[0]+(f[1]-b[1])*c[1]+(f[2]-b[2])*c[2];d.distance=f;d.near=f-e;d.far=f+e});this._items.sort((d,e)=>d.distance-e.distance)};g.forEachInDepthRange=function(a,b,c){if("front-to-back"===b)for(b=0;b<this._items.length;++b){var d=this._items.data[b];d.far<a.near||d.near>a.far||c(d.obj,d.near,d.far)}else for(b=this._items.length-1;0<=b;--b)d=this._items.data[b],d.far<a.near||
d.near>a.far||c(d.obj,d.near,d.far)};L._createClass(h,[{key:"length",get:function(){return this._items.length}},{key:"empty",get:function(){return 0===this._items.length}}]);return h}(),K=function(){function h(){this.view=A.create();this.viewProj=A.create();this.frustum=v.frustum.create();this.geometries=[];this.near=[];this.far=[];this.nearCandidates=[];this.farCandidates=[];this.range={near:0,far:0};this.looseRange={near:0,far:0}}var g=h.prototype;g.compute=function(a,b){this.reset();z.copy(this.view,
a.viewMatrix);z.multiply(this.viewProj,a.projectionMatrix,this.view);v.frustum.copy(a.frustum,this.frustum);a=this.view;const c=a[2],d=a[6],e=a[10],f=a[14];a=this.range;let l=0;b.forEach(k=>{if(k.instanceParameters.visible&&k.castShadow){if(k.hasShaderTransformation){var r=k.getBoundingSphere(k.getShaderTransformation(),1,n);var u=n}else r=k.bsRadius,u=k.center;u=c*u[0]+d*u[1]+e*u[2]+f;this.geometries[l]=k;this.near[l]=-(u+r);this.far[l]=-(u-r);++l}});if(0===this.geometries.length)return a;for(b=
0;b<this.geometries.length;++b)this.near[b]>a.far&&(a.far=this.near[b]),2<this.near[b]&&this.far[b]<a.near&&(a.near=this.far[b]);b=this.looseRange;b.near=Math.max(.5*a.near,2);b.far=2*a.far;var m=0;let x=0;for(let k=0;k<this.geometries.length;++k)this.near[k]<a.near&&(this.near[k]>=b.near?a.near=this.near[k]:this.nearCandidates[m++]=k),this.far[k]>a.far&&(this.far[k]<=b.far?a.far=this.far[k]:this.farCandidates[x++]=k);if(0===this.nearCandidates.length&&0===this.farCandidates.length)return a;this.nearCandidates.sort((k,
r)=>this.near[k]<this.near[r]?-1:this.near[k]>this.near[r]?1:0);this.farCandidates.sort((k,r)=>this.far[k]<this.far[r]?1:this.far[k]>this.far[r]?-1:0);for(b=0;b<this.nearCandidates.length;++b)m=this.nearCandidates[b],this.near[m]<a.near&&(m=this.geometries[m],this.includeNearBoundingInfoRec(m.boundingInfo,m.getShaderTransformation()));for(b=0;b<this.farCandidates.length;++b)m=this.farCandidates[b],this.far[m]>a.far&&(m=this.geometries[m],this.includeFarBoundingInfoRec(m.boundingInfo,m.getShaderTransformation()));
return a};g.reset=function(){this.geometries.length=0;this.near.length=0;this.far.length=0;this.nearCandidates.length=0;this.farCandidates.length=0;this.range.near=Number.MAX_VALUE;this.range.far=-Number.MAX_VALUE};g.includeNearBoundingInfoRec=function(a,b){var c=a.getBSRadius(),d=a.getCenter();B.transformMat4(n,d,b);var e=C.maxScale(b);d=n[0];var f=n[1];const l=n[2];c*=e;({planes:e}=this.frustum);if(!(e[0][0]*d+e[0][1]*f+e[0][2]*l+e[0][3]>c||e[1][0]*d+e[1][1]*f+e[1][2]*l+e[1][3]>c||e[2][0]*d+e[2][1]*
f+e[2][2]*l+e[2][3]>c||e[3][0]*d+e[3][1]*f+e[3][2]*l+e[3][3]>c||(d=this.view[2]*d+this.view[6]*f+this.view[10]*l+this.view[14],f=d+c,2>-(d-c)||-f>=this.range.near)))if(-f>this.looseRange.near)this.range.near=-f;else{if(100<c&&(c=a.getChildren(),void 0!==c)){for(a=0;8>a;++a)void 0!==c[a]&&this.includeNearBoundingInfoRec(c[a],b);return}E.unionDepthRangeWithAABB(this.range,this.viewProj,b,a.getBBMin(),a.getBBMax())}};g.includeFarBoundingInfoRec=function(a,b){var c=a.getBSRadius(),d=a.getCenter();B.transformMat4(n,
d,b);var e=C.maxScale(b);d=n[0];const f=n[1],l=n[2];c*=e;({planes:e}=this.frustum);if(!(e[0][0]*d+e[0][1]*f+e[0][2]*l+e[0][3]>c||e[1][0]*d+e[1][1]*f+e[1][2]*l+e[1][3]>c||e[2][0]*d+e[2][1]*f+e[2][2]*l+e[2][3]>c||e[3][0]*d+e[3][1]*f+e[3][2]*l+e[3][3]>c||(d=this.view[2]*d+this.view[6]*f+this.view[10]*l+this.view[14]-c,-d<=this.range.far)))if(-d<this.looseRange.far)this.range.far=-d;else{if(100<c&&(c=a.getChildren(),void 0!==c)){for(a=0;8>a;++a)void 0!==c[a]&&this.includeFarBoundingInfoRec(c[a],b);return}E.unionDepthRangeWithAABB(this.range,
this.viewProj,b,a.getBBMin(),a.getBBMax())}};return h}(),T=function(){function h(){this.modelViewProj=A.create();this.clipPosition=[q.create(),q.create(),q.create(),q.create(),q.create(),q.create(),q.create(),q.create()]}var g=h.prototype;g.unionDepthRangeWithAABB=function(a,b,c,d,e){var f=this.modelViewProj;z.multiply(f,b,c);b=!1;for(c=0;8>c;++c){const l=this.clipPosition[c],m=0===c||3===c||4===c||7===c?d[0]:e[0],x=0===c||1===c||4===c||5===c?d[1]:e[1],k=4>c?d[2]:e[2];l[0]=f[0]*m+f[4]*x+f[8]*k+f[12];
l[1]=f[1]*m+f[5]*x+f[9]*k+f[13];l[2]=f[2]*m+f[6]*x+f[10]*k+f[14];l[3]=f[3]*m+f[7]*x+f[11]*k+f[15]}for(d=0;12>d;++d){e=this.clipTriangle(this.clipPosition[F[d][0]],this.clipPosition[F[d][1]],this.clipPosition[F[d][2]]);f=!0;for(c=0;c<e.length;++c)if(2<=e[c][3]){f=!1;break}if(!f)for(b=!0,f=0;f<e.length;++f)c=e[f][3],c<a.near&&(a.near=c),c>a.far&&(a.far=c)}return b};g.inside=function(a,b){if(0===b)return a[0]>=-a[3];if(1===b)return a[1]>=-a[3];if(2===b)return a[0]<=a[3];if(3===b)return a[1]<=a[3];G.assert(!1)};
g.intersect=function(a,b,c){let d=0;0===c?d=(-a[3]-a[0])/(b[0]-a[0]+b[3]-a[3]):1===c?d=(-a[3]-a[1])/(b[1]-a[1]+b[3]-a[3]):2===c?d=(a[3]-a[0])/(b[0]-a[0]-b[3]+a[3]):3===c&&(d=(a[3]-a[1])/(b[1]-a[1]-b[3]+a[3]));return O.lerp(q.create(),a,b,d)};g.clipTriangle=function(a,b,c){a=[a,b,c];for(b=0;4>b;++b){c=a;a=[];for(let d=0;d<c.length;++d){const e=c[d],f=c[(d+1)%c.length];this.inside(f,b)?(this.inside(e,b)||a.push(this.intersect(e,f,b)),a.push(f)):this.inside(e,b)&&a.push(this.intersect(e,f,b))}}return a};
return h}();const F=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],n=N.create(),R=A.create(),p=t.empty(),w=new S,U=new K,E=new T;y.DepthRangeFromRenderGeometries=K;y.depthRangeFromLayer=H;y.depthRangeFromScene=function(h,g,a){if(1E4>g.size)return U.compute(h,g);const b=t.empty();a.forEach(c=>{c.isVisible&&t.union(b,H(h,c))});return b};y.texure2depth=function(h,g,a){return G.unpackFloatRGBA(g,h)*(a[1]-a[0])+a[0]};Object.defineProperty(y,"__esModule",
{value:!0})});