// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../support/mathUtils ../../../../chunks/mat4 ../../../../chunks/mat4f64 ./Util ./IdGen ./GeometryRecord ./Object3DStateSet ../materials/renderers/utils".split(" "),function(v,B,n,h,w,u,p,q,C,r,x,t){let A=function(){function l(a={}){this._objectTransformation=p.create();this._bvObjectSpace=new y;this._bvWorldSpace=new y;this._bvDirty=!0;this._hasVolatileTransformation=!1;
this._visible=!0;this.id=l._idGen.gen(a.idHint);this.castShadow=null!=a.castShadow?a.castShadow:!0;(this.metadata=a.metadata)&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new z);this.objectTransformation=p.create();this._initializeGeometryRecords(a.geometries,a.materials,a.transformations,a.origins)}var c=l.prototype;c.dispose=function(){for(const a of this._geometryRecords)r.pool.release(a);this._geometries=this._geometryRecords=null};c._initializeGeometryRecords=function(a,
b,f,k){if(Array.isArray(a)){q.assert(b.length===a.length,"Object3D: materials don't match geometries");q.assert(f.length===a.length,"Object3D: transformations don't match geometries");this._geometryRecords=Array(a.length);this._geometries=a.slice();for(let d=0;d<a.length;d++)this._geometryRecords[d]=r.pool.acquire(a[d],b[d],p.clone(f[d]),{highlights:null,occludees:null,visible:!0},k&&k[d]);this._hasVolatileTransformation=!1}else this._geometryRecords=[],this._geometries=[]};c.getNumGeometryRecords=
function(){return this._geometryRecords.length};c.getGeometryRecord=function(a){q.assert(0<=a&&a<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range");return this._geometryRecords[a]};c.addGeometry=function(a,b,f,k,d,g){f=f?f:p.IDENTITY;this._geometries.push(a);a=r.pool.acquire(a,b,f,k||{highlights:null,occludees:null,visible:!0},d,g);this._geometryRecords.push(a);this._hasVolatileTransformation=this._geometryRecords.some(e=>!!e.shaderTransformation);this._notifyDirty("objGeometryAdded",
a);this._invalidateBoundingVolume();return a};c.removeGeometry=function(a){const b=this._geometryRecords.splice(a,1)[0];r.pool.release(b);this._hasVolatileTransformation=this._geometryRecords.some(f=>!!f.shaderTransformation);this._geometries.splice(a,1);this._notifyDirty("objGeometryRemoved",b);this._invalidateBoundingVolume();return b};c.removeAllGeometries=function(){for(;0<this.getNumGeometryRecords();)this.removeGeometry(0)};c.geometryVertexAttrsUpdated=function(a){this._notifyDirty("vertexAttrsUpdated",
this._geometryRecords[a]);this._invalidateBoundingVolume()};c.setVisible=function(a){this._visible=a;for(const b of this._geometryRecords)b.instanceParameters.visible=this._visible;this._notifyDirty("visibilityChanged")};c.maskOccludee=function(){const a=x.generateObject3DStateId(1);for(const b of this._geometryRecords)b.instanceParameters.occludees=t.addObject3DStateID(b.instanceParameters.occludees,a);this._notifyDirty("occlusionChanged");return a};c.removeOcclude=function(a){for(const b of this._geometryRecords)b.instanceParameters.occludees=
t.removeObject3DStateID(b.instanceParameters.occludees,a);this._notifyDirty("occlusionChanged")};c.highlight=function(){const a=x.generateObject3DStateId(0);for(const b of this._geometryRecords)b.instanceParameters.highlights=t.addObject3DStateID(b.instanceParameters.highlights,a);this._notifyDirty("highlightChanged");return a};c.removeHighlight=function(a){for(const b of this._geometryRecords)b.instanceParameters.highlights=t.removeObject3DStateID(b.instanceParameters.highlights,a);this._notifyDirty("highlightChanged")};
c.getCombinedStaticTransformation=function(a,b){return u.multiply(B.unwrapOr(b,p.create()),this.objectTransformation,a.getStaticTransformation())};c.getCombinedShaderTransformation=function(a,b){b=b||p.create();u.multiply(b,this.objectTransformation,a.getShaderTransformation());return b};c.hasVolativeTransformation=function(){return this._hasVolatileTransformation};c.getBBMin=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin};c.getBBMax=function(a){this._validateBoundingVolume();
return a?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax};c.getCenter=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.center:this._bvWorldSpace.center};c.getBSRadius=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius};c._validateBoundingVolume=function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init();this._bvWorldSpace.init();for(var a=0;a<this._geometryRecords.length;++a){var b=this._geometryRecords[a],
f=this._geometries[a].boundingInfo;this._calculateTransformedBoundingVolume(f,this._bvObjectSpace,b.getShaderTransformation());this._calculateTransformedBoundingVolume(f,this._bvWorldSpace,this.getCombinedShaderTransformation(b))}h.lerp(this._bvObjectSpace.center,this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5);h.lerp(this._bvWorldSpace.center,this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5);a=n.create();b=n.create();f=w.maxScale(this.objectTransformation);for(let e=0;e<this._geometryRecords.length;++e){var k=
this._geometries[e],d=this._geometryRecords[e].getShaderTransformation(),g=w.maxScale(d);k=k.boundingInfo;h.transformMat4(a,k.getCenter(),d);d=h.distance(a,this._bvObjectSpace.center);g*=k.getBSRadius();this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,d+g);h.transformMat4(b,a,this.objectTransformation);d=h.distance(b,this._bvWorldSpace.center);this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,d+g*f)}this._bvDirty=!1}};c._calculateTransformedBoundingVolume=function(a,
b,f){const k=a.getBBMin();a=a.getBBMax();const d=n.clone(k),g=n.clone(a);h.transformMat4(d,d,f);h.transformMat4(g,g,f);for(var e=0;3>e;++e)b.bbMin[e]=Math.min(b.bbMin[e],d[e],g[e]),b.bbMax[e]=Math.max(b.bbMax[e],d[e],g[e]);for(e=0;3>e;++e){h.copy(d,k);h.copy(g,a);d[e]=a[e];g[e]=k[e];h.transformMat4(d,d,f);h.transformMat4(g,g,f);for(let m=0;3>m;++m)b.bbMin[m]=Math.min(b.bbMin[m],d[m],g[m]),b.bbMax[m]=Math.max(b.bbMax[m],d[m],g[m])}};c._invalidateBoundingVolume=function(){this._bvDirty=!0;this._parentLayer&&
this._parentLayer.notifyObjectBBChanged(this,{center:this._bvWorldSpace.center,radius:this._bvWorldSpace.bsRadius})};c._notifyDirty=function(a,b,f,k){this._parentLayer&&this._parentLayer.notifyDirty(a,b,f||1,k||this)};v._createClass(l,[{key:"geometryRecords",get:function(){return this._geometryRecords}},{key:"geometries",get:function(){return this._geometries}},{key:"objectTransformation",get:function(){return this._objectTransformation},set:function(a){u.copy(this._objectTransformation,a);this._invalidateBoundingVolume();
this._notifyDirty("objTransformation")}},{key:"parentLayer",get:function(){return this._parentLayer},set:function(a){q.assert(null==this._parentLayer||null==a,"Object3D can only be added to a single Layer");this._parentLayer=a}},{key:"isVisible",get:function(){return this._visible}},{key:"test",get:function(){const a=this;return{hasGeometry:b=>-1<a._geometries.indexOf(b),getGeometryIndex:b=>a._geometries.indexOf(b)}}}]);return l}();A._idGen=new C.IdGen;let z=function(){function l(){this.bbMin=n.fromValues(Number.MAX_VALUE,
Number.MAX_VALUE,Number.MAX_VALUE);this.bbMax=n.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}l.prototype.isEmpty=function(){return this.bbMax[0]<this.bbMin[0]&&this.bbMax[1]<this.bbMin[1]&&this.bbMax[2]<this.bbMin[2]};return l}(),y=function(l){function c(){var b=l.call(this)||this;b.center=n.create();b.bsRadius=0;return b}v._inheritsLoose(c,l);var a=c.prototype;a.init=function(){h.set(this.bbMin,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);h.set(this.bbMax,-Number.MAX_VALUE,
-Number.MAX_VALUE,-Number.MAX_VALUE);h.set(this.center,0,0,0);this.bsRadius=0};a.getCenter=function(){return this.center};a.getBSRadius=function(){return this.bsRadius};return c}(z);return A});