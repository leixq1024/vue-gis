// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/mathUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/mat4 ../../../../chunks/mat3f64 ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec4f64 ../../../../chunks/vec2 ../../../../chunks/vec4 ./Util ../../../webgl/Texture ../../../webgl/Util ./glUtil3D ./Camera ./DefaultTextureUnits ../../../webgl/FramebufferObject".split(" "),function(oa,V,T,J,H,pa,K,m,Z,d,aa,r,qa,ra,sa,ta,ua,va){function w(E,
t){d.set(ba,E[t],E[t+3]);return ba}let wa=function(){this.camera=new ta;this.lightMat=K.create()},ya=function(){function E(c,f){this.rctx=c;this.viewingMode=f;this._enabled=!1;this.maxTextureSize=this.textureSize=0;this.numCascades=1;this.maxNumCascades=4;this.splitSchemeLambda=0;this.warp=!0;this.cascadeDistances=[0,0,0,0,0];this.cascades=[];this.emptyTexture=sa.createEmptyTexture(this.rctx);this.maxTextureSize=this.rctx.parameters.maxTextureSize;for(c=0;4>c;++c)this.cascades.push(new wa)}var t=
E.prototype;t.dispose=function(){this.emptyTexture.dispose();this.emptyTexture=null;this.discardDepthTexture()};t.getDepthTexture=function(){return this.depthTexture};t.getCascades=function(){for(let c=0;c<this.numCascades;++c)W[c]=this.cascades[c];W.length=this.numCascades;return W};t.prepare=function(c,f,k){r.assert(this.enabled);this.textureSize=this.computeTextureSize(c.fullWidth,c.fullHeight);this.assertDepthTexture();H.multiply(ca,c.projectionMatrix,c.viewMatrix);var b=k.near,e=k.far;2>b&&(b=
2);2>e&&(e=2);b>=e&&(b=2,e=4);this.numCascades=Math.min(1+Math.floor(r.logWithBase(e/b,4)),this.maxNumCascades);k=(e-b)/this.numCascades;var F=Math.pow(e/b,1/this.numCascades),n=b;for(e=0;e<this.numCascades+1;++e)this.cascadeDistances[e]=V.lerp(n,b,this.splitSchemeLambda),n*=F,b+=k;H.invert(da,ca);k=1===this.viewingMode?c.eye:J.set(X,0,0,1);H.lookAt(ea,[0,0,0],[-f[0],-f[1],-f[2]],k);k=c.viewMatrix;c=c.projectionMatrix;for(F=0;F<this.numCascades;++F){n=this.cascades[F];b=-this.cascadeDistances[F];
e=-this.cascadeDistances[F+1];b=(c[10]*b+c[14])/Math.abs(c[11]*b+c[15]);e=(c[10]*e+c[14])/Math.abs(c[11]*e+c[15]);r.assert(b<e);for(var g=0;8>g;++g){aa.set(fa,0===g%4||3===g%4?-1:1,0===g%4||1===g%4?-1:1,4>g?b:e,1);aa.transformMat4(u[g],fa,da);for(var q=0;3>q;++q)u[g][q]/=u[g][3]}J.negate(X,u[0]);H.translate(ha,ea,X);n.camera.viewMatrix=ha;for(b=0;8>b;++b)J.transformMat4(u[b],u[b],n.camera.viewMatrix);J.copy(B,u[0]);J.copy(C,u[0]);for(b=1;8>b;++b)for(e=0;3>e;++e)B[e]=Math.min(B[e],u[b][e]),C[e]=Math.max(C[e],
u[b][e]);B[2]-=200;C[2]+=200;n.camera.near=-C[2];n.camera.far=-B[2];if(this.warp){b=1/u[0][3];e=1/u[4][3];r.assert(b<e);g=b+Math.sqrt(b*e);e=Math.sin(V.acosClamped(k[2]*f[0]+k[6]*f[1]+k[10]*f[2]));g/=e;var L=void 0,p=void 0;b=u;var x=g;L=e;e=ia;var y=ja,h=xa;q=ka;g=la;d.set(z,0,0);for(p=0;4>p;++p)d.add(z,z,b[p]);d.scale(z,z,.25);d.set(M,0,0);for(p=4;8>p;++p)d.add(M,M,b[p]);d.scale(M,M,.25);d.lerp(I[0],b[4],b[5],.5);d.lerp(I[1],b[5],b[6],.5);d.lerp(I[2],b[6],b[7],.5);d.lerp(I[3],b[7],b[4],.5);p=0;
var D=d.squaredDistance(I[0],z);for(var A=1;4>A;++A){var N=d.squaredDistance(I[A],z);N<D&&(D=N,p=A)}d.subtract(l,I[p],b[p+4]);p=l[0];l[0]=-l[1];l[1]=p;d.subtract(Y,M,z);0>d.dot(Y,l)&&d.negate(l,l);d.lerp(l,l,Y,L);d.normalize(l,l);p=L=d.dot(d.subtract(G,b[0],z),l);for(D=1;8>D;++D)A=d.dot(d.subtract(G,b[D],z),l),A<p?p=A:A>L&&(L=A);d.copy(e,z);d.scale(G,l,p-x);d.add(e,e,G);A=-1;N=1;x=D=0;for(let Q=0;8>Q;++Q){d.subtract(R,b[Q],e);d.normalize(R,R);const S=l[0]*R[1]-l[1]*R[0];0<S?S>A&&(A=S,D=Q):S<N&&(N=
S,x=Q)}r.verify(0<A,"leftArea");r.verify(0>N,"rightArea");d.scale(O,l,p);d.add(O,O,z);d.scale(P,l,L);d.add(P,P,z);U[0]=-l[1];U[1]=l[0];y=r.rayRay2D(e,b[x],P,d.add(G,P,U),1,y);h=r.rayRay2D(e,b[D],P,G,1,h);q=r.rayRay2D(e,b[D],O,d.add(G,O,U),1,q);b=r.rayRay2D(e,b[x],O,G,1,g);r.verify(y,"rayRay");r.verify(h,"rayRay");r.verify(q,"rayRay");r.verify(b,"rayRay");h=ia;b=ja;e=ka;q=la;g=n.camera.projectionMatrix;d.subtract(v,e,q);d.scale(v,v,.5);a[0]=v[0];a[1]=v[1];a[2]=0;a[3]=v[1];a[4]=-v[0];a[5]=0;a[6]=v[0]*
v[0]+v[1]*v[1];a[7]=v[0]*v[1]-v[1]*v[0];a[8]=1;a[6]=-d.dot(w(a,0),h);a[7]=-d.dot(w(a,1),h);h=d.dot(w(a,0),e)+a[6];y=d.dot(w(a,1),e)+a[7];x=d.dot(w(a,0),q)+a[6];q=d.dot(w(a,1),q)+a[7];h=-(h+x)/(y+q);a[0]+=a[1]*h;a[3]+=a[4]*h;a[6]+=a[7]*h;h=1/(d.dot(w(a,0),e)+a[6]);y=1/(d.dot(w(a,1),e)+a[7]);a[0]*=h;a[3]*=h;a[6]*=h;a[1]*=y;a[4]*=y;a[7]*=y;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;h=d.dot(w(a,1),b)+a[7];y=d.dot(w(a,2),b)+a[8];x=d.dot(w(a,1),e)+a[7];q=d.dot(w(a,2),e)+a[8];h=-.5*(h/y+x/q);a[1]+=a[2]*h;a[4]+=
a[5]*h;a[7]+=a[8]*h;h=d.dot(w(a,1),b)+a[7];y=d.dot(w(a,2),b)+a[8];x=-y/h;a[1]*=x;a[4]*=x;a[7]*=x;g[0]=a[0];g[1]=a[1];g[2]=0;g[3]=a[2];g[4]=a[3];g[5]=a[4];g[6]=0;g[7]=a[5];g[8]=0;g[9]=0;g[10]=1;g[11]=0;g[12]=a[6];g[13]=a[7];g[14]=0;g[15]=a[8];n.camera.projectionMatrix[10]=2/(B[2]-C[2]);n.camera.projectionMatrix[14]=-(B[2]+C[2])/(B[2]-C[2])}else H.ortho(n.camera.projectionMatrix,B[0],C[0],B[1],C[1],n.camera.near,n.camera.far);H.multiply(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);b=this.textureSize/
2;n.camera.viewport[0]=0===F%2?0:b;n.camera.viewport[1]=0===Math.floor(F/2)?0:b;n.camera.viewport[2]=b;n.camera.viewport[3]=b}this.lastOrigin=null;f=this.rctx;f.bindFramebuffer(this.fbo);f.bindTexture(null,7);f.setClearColor(1,1,1,1);f.clearSafe(16640)};t.finish=function(c){r.assert(this.enabled);this.rctx.bindFramebuffer(c)};t.bind=function(c,f){const k=this.rctx;k.bindTexture(this.enabled?this.depthTexture:this.emptyTexture,f);k.bindProgram(c);c.setUniform1i("depthTex",f);c.setUniform1f("depthHalfPixelSz",
this.enabled?.5/this.textureSize:-1);c.setUniform1i("shadowMapNum",this.numCascades);c.setUniform4f("shadowMapDistance",this.cascadeDistances[0],1<this.numCascades?this.cascadeDistances[1]:Infinity,2<this.numCascades?this.cascadeDistances[2]:Infinity,3<this.numCascades?this.cascadeDistances[3]:Infinity)};t.bindToAllPrograms=function(c){c=c.getProgramsUsingUniform("shadowMapDistance");for(let f=0;f<c.length;f++)this.bind(c[f],ua.DefaultTextureUnits.SHADOW_MAP)};t.bindView=function(c,f){if(this.enabled){var k=
this.lastOrigin;if(!k||k[0]!==f[0]||k[1]!==f[1]||k[2]!==f[2])for(this.lastOrigin=this.lastOrigin||T.create(),J.copy(this.lastOrigin,f),k=0;k<this.numCascades;++k){H.translate(ma,this.cascades[k].lightMat,f);for(let b=0;16>b;++b)na[16*k+b]=ma[b]}c.setUniformMatrix4fv("shadowMapMatrix",na)}};t.computeTextureSize=function(c,f){return Math.min(this.maxTextureSize,2*2**Math.round(.5*Math.log(c*c+f*f)*Math.LOG2E+.35))};t.assertDepthTexture=function(){if(null==this.depthTexture||this.depthTexture.descriptor.width!==
this.textureSize)this.discardDepthTexture(),this.depthTexture=new qa(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureSize,height:this.textureSize}),this.fbo=new va(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureSize,height:this.textureSize},this.depthTexture)};t.discardDepthTexture=function(){this.fbo&&(this.fbo.dispose(),this.fbo=null);this.depthTexture&&(this.depthTexture.dispose(),this.depthTexture=null)};t.getGpuMemoryUsage=
function(){return ra.getGpuMemoryUsage(this.fbo)};oa._createClass(E,[{key:"maxCascades",set:function(c){this.maxNumCascades=V.clamp(Math.floor(c),1,4)},get:function(){return this.maxNumCascades}},{key:"enabled",set:function(c){(this._enabled=c)||this.discardDepthTexture()},get:function(){return this._enabled}},{key:"test",get:function(){const c=this;return{maxNumCascades:this.maxNumCascades,cascades:this.cascades,textureSize:this.textureSize,set splitSchemeLambda(f){c.splitSchemeLambda=f},get splitSchemeLambda(){return c.splitSchemeLambda},
set warp(f){c.warp=f},get warp(){return c.warp}}}}]);return E}();const ha=K.create(),ca=K.create(),da=K.create(),fa=Z.create(),u=[];for(let E=0;8>E;++E)u.push(Z.create());const B=T.create(),C=T.create(),ia=m.create(),ja=m.create(),xa=m.create(),ka=m.create(),la=m.create(),ea=K.create(),X=T.create(),W=[],ma=K.create(),na=new Float32Array(64),z=m.create(),M=m.create(),I=[m.create(),m.create(),m.create(),m.create()],l=m.create(),Y=m.create(),G=m.create(),R=m.create(),O=m.create(),P=m.create(),U=m.create(),
ba=m.create(),v=m.create(),a=pa.create();return ya});