// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/PooledArray ../../../../core/Accessor ../../../../core/MapUtils ./Material ./rendererUtils ../materials/renderers/MergedRenderer".split(" "),
function(g,q,h,C,t,D,E,n,F,u,G,H,I,k,v,p,w,x,y){let z=function(){};g.SortedRenderGeometryRenderer=function(r){function l(){var a=r.apply(this,arguments)||this;a._pendingAddsRemoves=new Map;a._adds=new k;a._removes=new k;a._updates=new k({allocator:c=>c||new z,deallocator:c=>{c.renderGeometry=null;return c}});a._materialRenderers=new Map;a._sortedMaterialRenderers=new k;a._hasHighlights=!1;a._hasWater=!1;return a}q._inheritsLoose(l,r);var f=l.prototype;f.dispose=function(){this._adds.prune();this._removes.prune();
this._updates.prune();this._materialRenderers&&(this._materialRenderers.forEach(a=>a.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear())};f.stopAnimationsAtTime=function(a){this._sortedMaterialRenderers.forAll(c=>t.applySome(c.material.animation,b=>b.stopAtTime(a)))};f.commitChanges=function(){let a=!1;if(!this.updating)return!1;this.updateAddsRemoves();let c=!1,b=!1;x.splitRenderGeometryChangeSetByMaterial({numToAdd:this._adds.length,toAdd:this._adds.data,numToRemove:this._removes.length,
toRemove:this._removes.data,numToUpdate:this._updates.length,toUpdate:this._updates.data}).forEach((d,m)=>{let e=this._materialRenderers.get(m);!e&&0<d.toAdd.length&&(e=new y(this.rctx,this.materialRepository,m),this._materialRenderers.set(m,e),b=c=a=!0);if(e){var A=c||e.hasHighlights,B=b||e.hasWater;e.modify(d);c=c||A!==e.hasHighlights;b=b||B!==e.hasWater;e.isEmpty&&(this._materialRenderers.delete(m),e.dispose(),a=!0)}});this._adds.clear();this._removes.clear();this._updates.clear();this._pendingAddsRemoves.clear();
a&&this.updateSortedMaterialRenderers();c&&(this._hasHighlights=p.someMap(this._materialRenderers,d=>d.hasHighlights));b&&(this._hasWater=p.someMap(this._materialRenderers,d=>d.hasWater));this.notifyChange("updating");return!0};f.add=function(a){if(0!==a.length){var c=0===this._pendingAddsRemoves.size;for(const b of a)this._pendingAddsRemoves.set(b,0);c&&this.notifyChange("updating")}};f.remove=function(a){const c=0===this._pendingAddsRemoves.size;for(const b of a)a=this._pendingAddsRemoves.get(b),
0===a?this._pendingAddsRemoves.set(b,2):2!==a&&this._pendingAddsRemoves.set(b,1);c&&0<this._pendingAddsRemoves.size&&this.notifyChange("updating")};f.modify=function(a,c){const b=0===this._updates.length;for(const d of a)a=this._updates.pushNew(),a.renderGeometry=d,a.updateType=c;b&&0<this._updates.length&&this.notifyChange("updating")};f.updateLogic=function(a){let c=!1;this._sortedMaterialRenderers.forAll(({materialRenderer:b})=>{b.updateLogic&&b.updateLogic(a)&&(c=!0)});return c};f.draw=function(a,
c){for(let b=0;b<this._sortedMaterialRenderers.length;b++){const d=this._sortedMaterialRenderers.data[b];w.materialPredicate(d.material,a)&&d.materialRenderer.render(null,a,c,null)}};f.updateSortedMaterialRenderers=function(){this._sortedMaterialRenderers.clear();let a=0;this._materialRenderers.forEach((c,b)=>{b.insertOrder=a++;this._sortedMaterialRenderers.push({material:b,materialRenderer:c})});this._sortedMaterialRenderers.sort((c,b)=>{const d=b.material.renderPriority-c.material.renderPriority;
return 0!==d?d:c.material.insertOrder-b.material.insertOrder})};f.updateAddsRemoves=function(){this._adds.clear();this._removes.clear();this._pendingAddsRemoves.forEach((c,b)=>{switch(c){case 0:this._adds.push(b);break;case 1:this._removes.push(b)}});let a=0;for(;a<this._updates.length;)this._pendingAddsRemoves.has(this._updates.data[a].renderGeometry)?this._updates.removeUnorderedIndex(a):a++};q._createClass(l,[{key:"updating",get:function(){return 0<this._pendingAddsRemoves.size||0<this._updates.length}},
{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return p.someMap(this._materialRenderers,a=>a.rendersOccluded)}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size}},{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]);return l}(v);h.__decorate([n.property()],g.SortedRenderGeometryRenderer.prototype,"rctx",void 0);h.__decorate([n.property()],
g.SortedRenderGeometryRenderer.prototype,"materialRepository",void 0);h.__decorate([n.property()],g.SortedRenderGeometryRenderer.prototype,"updating",null);g.SortedRenderGeometryRenderer=h.__decorate([u.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],g.SortedRenderGeometryRenderer);Object.defineProperty(g,"__esModule",{value:!0})});