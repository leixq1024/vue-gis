// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/maybe ../../../../chunks/vec3f64 ../../../../core/Handles ../../../../core/watchUtils ../../../../chunks/mat4 ../../../../core/MapUtils ../../../../core/TimeProfiler ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ./glUtil3D ./Camera ../../support/debugFlags ./Material ./BoundingInfo ./RenderContext ./rendererUtils ../../../webgl/Measurement ../statistics/RendererPerformanceInfo ../materials/renderers/MergedRenderer ../lighting/SceneLighting ./depthRange ./depthRangeUtils ../core/renderPasses/RenderPassManager ./HighlightHelper ./OffscreenRendering ./RenderPluginManager ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./edgeRendering/EdgeView".split(" "),
function(F,A,m,G,H,I,p,x,B,t,J,K,L,y,C,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,aa,ba,ca,da){A=function(){function z(a,b,c,d,f,g,k,h,l){this._materialRep=a;this._rctx=d;this._compositingHelper=f;this._magnifierHelper=g;this.requestRender=k;this._stage=l;this._materialRenderers=new Map;this._hasWater=this._hasOccludees=this._hasHighlights=!1;this._camera=new L(G.fromValues(0,100,-100));this._content=new Map;this._isRendering=!1;this._bindParameters={slot:null,camera:null,inverseViewport:J.create(),shadowMappingEnabled:!1,
ssaoEnabled:!1,origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:new S.SceneLighting};this._fallbackDepthStencilTexture=null;this.performanceInfo=new Q.RendererPerformanceInfo;this._antialiasing=1;this._oitEnabled=!0;this._handles=new H;this.renderHiddenTransparentEdges=()=>{};this._shaderTechniqueRepository=
c;this._smaaPass=new ba(this._rctx);this.camera.viewport[2]=h[0];this.camera.viewport[3]=h[1];this.requestRender();this._offscreenRendering=new X.OffscreenRendering(this._rctx,this._compositingHelper);this._sliceHelper=new aa;this._shadowMap=new Z(this._rctx,c.viewingMode);this._ssaoHelper=new ca(c,this._rctx,()=>this.requestRender());this._highlightHelper=new W(c,this._rctx);this._renderPlugins=new Y.RenderPluginManager({rctx:this._rctx,shaderTechniqueRep:c,textureRep:b,materialRep:this._materialRep,
requestRender:this.requestRender});this.renderPassManager=new V.RenderPassManager(this._rctx,this._shaderTechniqueRepository);this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager);this._renderContext=new N(this._rctx,this._offscreenRendering,this._bindParameters.lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper);this._renderContext.ssrParams={camera:null,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,
ssrEnabled:!1};this._handles.add(I.init(y,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",n=>{this.renderHiddenTransparentEdges=n?()=>this.renderEdges(1):()=>{};this.requestRender()}))}var e=z.prototype;e.dispose=function(){this._handles.destroy();this._smaaPass.disable();this._materialRenderers.forEach(a=>a.dispose());this._materialRenderers=null;this._edgeView=m.destroyMaybe(this._edgeView);this._offscreenRendering=m.disposeMaybe(this._offscreenRendering);this._fallbackDepthStencilTexture=m.disposeMaybe(this._fallbackDepthStencilTexture);
this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose());this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose());this._highlightHelper&&(this._highlightHelper.enabled=!1);M.tmpIndices.prune();this._content.clear();this._content=null};e.ensureEdgeView=function(){m.isNone(this._edgeView)&&(this._edgeView=new da.EdgeView(this._rctx,this._shaderTechniqueRepository,{setNeedsRender:()=>this.requestRender()},this._stage.scheduler));return this._edgeView};e.setLighting=function(a){this._bindParameters.lighting.set(a)};
e.setRenderParameters=function(a){void 0!==a.screenSpaceReflectionsEnabled&&(this.renderPassManager.screenSpaceReflectionsEnabled=a.screenSpaceReflectionsEnabled);void 0!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap,this.renderPassManager.shadowCastingEnabled=a.shadowMap);void 0!==a.shadowMapMaxCascades&&(this._shadowMap.maxCascades=a.shadowMapMaxCascades);this._highlightHelper.enabled=!0;void 0!==a.ssao&&(this._ssaoHelper.enabled=a.ssao);void 0!==a.ssaoAttenuation&&(this._ssaoHelper.attenuation=
a.ssaoAttenuation);void 0!==a.ssaoRadius&&(this._ssaoHelper.radius=a.ssaoRadius);void 0!==a.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter.");void 0!==a.ssaoSamples&&(this._ssaoHelper.samples=a.ssaoSamples);a.background&&(this._offscreenRendering.background=a.background);void 0!==a.antialiasingEnabled&&(this._antialiasing=a.antialiasingEnabled?1:0);void 0!==a.orderIndependentTransparencyEnabled&&(this._oitEnabled=a.orderIndependentTransparencyEnabled);
void 0!==a.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(a.defaultHighlightOptions);void 0!==a.slicePlane&&(this._sliceHelper.plane=m.unwrap(a.slicePlane));void 0!==a.waterReflectionEnabled&&(this._waterReflectionEnabled=10<=this._rctx.parameters.maxTextureImageUnits&&a.waterReflectionEnabled);this.requestRender()};e.getFramebufferTexture=function(a){switch(a){case "color":return this._offscreenRendering.colorTexture;case "hudVisibility":return this._offscreenRendering.hudVisibilityTexture;
case "shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case "linearDepth":return this._offscreenRendering.linearDepthTexture;case "normals":return this._offscreenRendering.normalTexture;case "highlight":return this._offscreenRendering.highlightTexture;default:return null}};e.modify=function(a,b=a?a.length:0,c,d=c?c.length:0,f,g=f?f.length:0){this._isRendering&&console.warn("Renderer.modify called while rendering");for(var k=0;k<d;++k)this._content.delete(c[k].uniqueName);for(k=
0;k<b;++k)this._content.set(a[k].uniqueName,a[k]);if(b||d||g){let h=!1;O.splitRenderGeometryChangeSetByMaterial({toAdd:a,numToAdd:b,toRemove:c,numToRemove:d,toUpdate:f,numToUpdate:g}).forEach((l,n)=>{let q=this._materialRenderers.get(n);!q&&0<l.toAdd.length&&(q=new R(this._rctx,this._materialRep,n),this._materialRenderers.set(n,q));q&&(q.modify(l),q.isEmpty&&(h=!0))});h&&this._materialRenderers.forEach((l,n)=>{l.isEmpty&&(this._materialRenderers.delete(n),l.dispose())});this._hasHighlights=x.someMap(this._materialRenderers,
l=>l.hasHighlights);this._hasOccludees=x.someMap(this._materialRenderers,l=>l.hasOccludees);this._hasWater=x.someMap(this._materialRenderers,l=>l.hasWater);this.requestRender()}};e.updateLogic=function(a){let b=!1;this._materialRenderers.forEach(c=>{c.updateLogic&&(b=c.updateLogic(a)||b)});return b};e.render=function(a,b,c){this.performanceInfo.prerender(this._rctx);this._isRendering=!0;this.setLighting(this._stage.lighting);this._renderContext.hasOccludees=this._hasOccludees;this._renderContext.transparencyPassType=
3;this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType;var d=this._offscreenRendering;d.needLastFrameColorTexture=this._waterReflectionEnabled;d.advanceCurrentRenderTarget();const f=this._sliceHelper.plane;c&&(this._sliceHelper.plane=null);this._rctx.bindFramebuffer(a);b.setGLViewport(this._rctx);this._renderPlugins.prepareRender(b);this.performanceInfo.advance(0);this.renderShadowMap(a,b,this._stage.mainLightDirection);this.performanceInfo.advance(1);this.ensureBindParameters(this._renderContext,
b);d.initializeFrame(b);this.renderLinearDepth();this.performanceInfo.advance(2);this.renderNormal();this.performanceInfo.advance(3);this.ensureBindParametersSSR(this._renderContext);this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(b,d.linearDepthTexture,d.normalTexture);this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this.performanceInfo.stats.reset();this.performanceInfo.advance(4);this._renderContext.pass=0;d.bindFramebuffer();this._renderPlugins.render(0,this._renderContext);
this.renderOpaqueGeometry(this._renderContext);this.performanceInfo.advance(5);this.renderEdges(2);this.performanceInfo.advance(6);this.renderHiddenTransparentEdges();this.renderOrderIndependentTransparency(()=>this.renderTransparentGeometry(this._renderContext),!1);this.performanceInfo.advance(7);this.renderEdges(1);this.performanceInfo.advance(8);var g=b=!1;b=this.renderHUDVisibility(this._renderContext);this.renderInternalSlot(20,this._renderContext);this.performanceInfo.advance(9);(g=this.renderTransparentTerrain(this._renderContext))&&
b&&(d.compositeTransparentTerrainOntoHUDVisibility(),this.renderHUD(0,d.framebuffer),this.performanceInfo.advance(16));this.performanceInfo.advance(10);g&&d.compositeTransparentTerrainOntoMain();d.renderToTargets(()=>{this.renderInternalSlot(8,this._renderContext);this._renderPlugins.render(15,this._renderContext);this._renderPlugins.render(16,this._renderContext)},d.currentColorTarget,d.mainDepth);this.performanceInfo.advance(11);this._renderPlugins.needsLaserlineWithContrastControl&&d.renderTmpAndCompositeToMain(()=>
{this._renderPlugins.render(17,this._renderContext)},2);this.performanceInfo.advance(12);this.renderOccluded();this.performanceInfo.advance(13);d=(c=!c&&this._magnifierHelper.enabled)&&m.isNone(a)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):a;this._rctx.bindFramebuffer(d);this.renderAntiAliasing(this._antialiasing,this._offscreenRendering.colorTexture)||this._compositingHelper.composite(this._offscreenRendering.colorTexture,0);this.performanceInfo.advance(14);
this.renderHUD(1,d);this.performanceInfo.advance(17);this.renderHighlights(this._renderContext.camera,a);this.performanceInfo.advance(15);c&&this._magnifierHelper.render(this._rctx,this._bindParameters);d!==a&&(this._rctx.bindFramebuffer(a),this._compositingHelper.composite(this._offscreenRendering.tmpColorTexture,0));this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera);this._sliceHelper.plane=f;this._isRendering=!1;if(this.onPostRender)this.onPostRender();this.performanceInfo.postrender()};
e.readDepthPixels=function(a,b,c,d,f){const g=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);this.needsLinearDepth()||(this._renderContext.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(17664,255),this.renderGeometryPass(2),this._rctx.gl.flush(),this._rctx.gl.finish());g.readPixels(a,b,c,d,6408,5121,f)};e.renderEdges=function(a){const b=this._edgeView;m.isSome(b)&&b.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain(()=>
b.render(this._bindParameters,a),1)};e.renderShadowMap=function(a,b,c){const d=this._shadowMap;if(d.enabled){y.ENABLE_PROFILE_DEPTH_RANGE&&B.begin("depthRange");var f=this.computeDepthRange(b);y.ENABLE_PROFILE_DEPTH_RANGE&&B.end("depthRange");d.prepare(b,c,f);c=d.getCascades();for(f=0;f<c.length;++f){const g=c[f];g.camera.setGLViewport(this._rctx);this.ensureCameraBindParameters(this._renderContext,g.camera);this.renderGeometryPass(4)}d.finish(a);b.setGLViewport(this._rctx)}d.bindToAllPrograms(this._shaderTechniqueRepository)};
e.needsLinearDepth=function(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled};e.renderLinearDepth=function(){this.needsLinearDepth()?this._offscreenRendering.renderToTargets(()=>this.renderGeometryPass(2),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)};e.renderNormal=function(){this._ssaoHelper.enabled?this._offscreenRendering.renderToTargets(()=>
{this.renderGeometryPass(3)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)};e.computeDepthRange=function(a){const b=U.depthRangeFromScene(a,this._content,this._stage.getLayers());T.union(b,this.renderPlugins.queryDepthRange(a));b.near=Math.max(a.near,b.near);b.far=Math.min(a.far,b.far);return b};e.renderGeometryPass=function(a){this._renderContext.pass=a;this.renderOpaqueGeometry(this._renderContext);
this.renderTransparentGeometry(this._renderContext);this.renderTransparentTerrain(this._renderContext)};e.renderOpaqueGeometry=function(a){this._renderPlugins.render(1,a);this._renderPlugins.render(2,a);this.renderInternalSlot(3,a);this._renderPlugins.render(4,a);a.ssaoHelper&&a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this._renderPlugins.render(14,this._renderContext)};e.renderTransparentGeometry=function(a){this.renderInternalSlot(5,a);this._renderPlugins.render(6,a);a.ssaoHelper&&
a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)};e.renderTransparentTerrain=function(a){return this._renderPlugins.render(7,a)};e.renderHUDVisibility=function(a){let b=!1;a.offscreenRenderingHelper&&a.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null;b=this.renderInternalSlot(12,a)});return b};e.renderHUD=function(a,b){this._oitEnabled?
(this.renderOrderIndependentTransparency(()=>this.renderHUDElements(a),!0),this._rctx.bindFramebuffer(b),this._compositingHelper.composite(this._offscreenRendering.hudColorTexture,2)):0===a?this._offscreenRendering.renderToTargets(()=>this.renderHUDElements(0),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this.renderHUDElements(a)};e.renderHUDElements=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this.renderInternalSlot(21,this._renderContext);
this.renderInternalSlot(18,this._renderContext);this.renderInternalSlot(19,this._renderContext)};e.renderHighlights=function(a,b){const c=this._highlightHelper;if(c&&c.enabled&&(this._hasHighlights||this._renderPlugins.needsHighlight)){var d=c.profilingCallback&&P.startMeasurement(this._renderContext.rctx);this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;var f=this._offscreenRendering.renderToTargets(()=>{this.renderGeometryPass(5);this._rctx.clearSafe(256);this.renderHUDElements(2)},
this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);c.render(a,f,b);m.isSome(d)&&c.profilingCallback&&d.stop(g=>{c.profilingCallback&&c.profilingCallback(g)})}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};e.renderOrderIndependentTransparency=function(a,b){if(this._oitEnabled&&this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat&&this._rctx.capabilities.colorBufferFloat&&this._rctx.capabilities.colorBufferFloat.textureFloat){const c=
f=>{this._renderContext.transparencyPassType=f;this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType;this._offscreenRendering.renderOITPass(()=>a(),f,b)},d=this._renderContext.pass;this._renderContext.pass=1;c(1);this._renderContext.pass=0;c(0);c(2);this._offscreenRendering.compositeTransparentOntoOpaque(b);this._renderContext.transparencyPassType=3;this._bindParameters.transparencyPassType=this._renderContext.transparencyPassType;this._renderContext.pass=d}else a()};
e.renderOccluded=function(){let a=0;this._materialRenderers.forEach((k,h)=>{h&&h.isVisible()&&8===h.renderOccluded&&(a|=h.renderOccluded,u.push(h))});const b=this._offscreenRendering,c=this._renderContext,d=(k,h,l=()=>g(h),n=!0,q=!0)=>{0!==(a&h)&&(b.renderToTargets(l,b.tmpColor,b.mainDepth,[0,0,0,0],n,q),b.compositeOccludedOntoMain(k))};0!==u.length&&(this.renderInternalSlot(10,c,u),d(.5,8,()=>this.renderInternalSlot(11,c,u),!1,!1),u.length=0);this._materialRenderers.forEach((k,h)=>{h&&h.isVisible()&&
(4===h.renderOccluded||2===h.renderOccluded||16===h.renderOccluded)&&(a|=h.renderOccluded,v.push(h))});const f=this._renderPlugins.renderOccludedFlags;if(a|=f){var g=k=>{c.renderOccludedMask=k;1<f&&this._renderPlugins.render(9,c);this.renderInternalSlot(3,c,v);this.renderInternalSlot(5,c,v);this.renderInternalSlot(8,c,v);c.resetRenderOccludedMask()};c.pass=0;d(.5,4,()=>g(4),!0,2);d(.5,2,()=>g(2),!0,2);d(1,16,()=>g(16),!0,2);v.length=0}};e.renderAntiAliasing=function(a,b){if(1===a){if(this._smaaPass.loadResources(()=>
this.requestRender()),this._smaaPass.enable())return this._smaaPass.render({colorTexture:b}),!0}else this._smaaPass.disable();return!1};e.ensureCameraBindParameters=function(a,b){this._renderContext.camera=b;this._bindParameters.camera=a.camera;this._bindParameters.inverseViewport[0]=1/a.camera.fullViewport[2];this._bindParameters.inverseViewport[1]=1/a.camera.fullViewport[3]};e.ensureBindParameters=function(a,b){this.ensureCameraBindParameters(a,b);b=this._renderContext.offscreenRenderingHelper;
this._bindParameters.shadowMap=a.shadowMap;this._bindParameters.shadowMappingEnabled=!!a.shadowMap&&a.shadowMap.enabled;this._bindParameters.ssaoEnabled=!!a.ssaoHelper&&a.ssaoHelper.enabled;this._bindParameters.slicePlane=a.sliceHelper&&a.sliceHelper.plane;this._bindParameters.hasOccludees=a.hasOccludees;this._bindParameters.linearDepthTextureID=3;this._bindParameters.lastFrameColorTextureID=4;this._bindParameters.hudVisibilityTexture=b?b.hudVisibilityTexture:null;this._bindParameters.highlightDepthTexture=
b&&b.depthTexture||this.getFallbackDepthTexture()};e.ensureBindParametersSSR=function(a){this._waterReflectionEnabled?(p.translate(D,a.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),p.translate(w,a.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),p.invert(w,w),p.invert(E,a.camera.projectionMatrix),p.multiply(r,w,E),p.multiply(r,D,r),p.multiply(r,a.lastFrameCamera.projectionMatrix,r),this._renderContext.ssrParams.camera=
a.camera,this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=r,this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture,this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null;this._renderContext.ssrParams.ssrEnabled=
this._bindParameters.ssrEnabled=this._waterReflectionEnabled};e.renderInternalSlot=function(a,b,c){const d=0===b.pass?this.performanceInfo.stats:null;let f=!1;this._bindParameters.slot=a;m.isSome(c)?c.forEach(g=>{C.materialPredicate(g,b)&&(g=this._materialRenderers.get(g),m.isSome(g)&&(f=g.render(a,b,this._bindParameters)||f))}):this._materialRenderers.forEach((g,k)=>{C.materialPredicate(k,b)&&(f=g.render(a,b,this._bindParameters,d)||f)});return f};e.getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||
(this._fallbackDepthStencilTexture=K.createEmptyDepthTexture(this._rctx));return this._fallbackDepthStencilTexture};e.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}};F._createClass(z,[{key:"updating",get:function(){return 1===this._antialiasing&&
this._smaaPass.isLoadingResources}},{key:"camera",set:function(a){this._camera.copyFrom(a);this.requestRender()},get:function(){return this._camera}},{key:"edgeView",get:function(){return this._edgeView}},{key:"isCameraFinal",get:function(){return null===this._bindParameters.reprojectionMat?!0:p.equals(this._bindParameters.reprojectionMat,ea)}},{key:"hasShadowsEnabled",get:function(){var a;return!(null==(a=this._shadowMap)||!a.enabled)}},{key:"hasSlicePlane",get:function(){return!!this._sliceHelper.plane}},
{key:"renderPlugins",get:function(){return this._renderPlugins}},{key:"canRender",get:function(){return 0<this._camera.fullWidth&&0<this._camera.fullHeight}},{key:"test",get:function(){return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,materialRenderers:this._materialRenderers,oitEnabled:this._oitEnabled}}}]);return z}();const v=[],u=[],D=t.create(),E=t.create(),w=t.create(),r=t.create(),ea=t.create();
return A});