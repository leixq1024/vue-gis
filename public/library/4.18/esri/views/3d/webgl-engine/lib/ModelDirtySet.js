// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define(["../../../../chunks/_rollupPluginBabelHelpers","../../../../core/MapUtils","./Util"],function(y,w,q){return function(){function t(a){this._residentGeomRecords=new Map;this._dirtyGeomRecords=new Map;this._model=a}var d=t.prototype;d.hasDirtyGeometryRecords=function(){return w.someMap(this._dirtyGeomRecords,a=>w.someMap(a,b=>b&&0<b.size))};d.handleUpdate=function(a,b,c){q.assert(this[b],"ModelDirtySet doesn't know how to process "+b);return this[b](a,c)};d.shaderTransformationChanged=function(a){(a=
this._residentGeomRecords.get(a.id))&&a.forEach((b,c)=>{(c=this._model.get(1,c))&&c.hasVolativeTransformation()&&b.forEach(e=>{for(const f of e[1])f.shaderTransformationChanged()})})};d.commit=function(){return this.commitLayers(this._dirtyGeomRecords.keys())};d.commitLayers=function(a){const b=[],c=[],e=[];for(const f of a)if(a=this._dirtyGeomRecords.get(f))a.forEach((k,h)=>{const l=this._ensureGeomRecord(f,h);k.forEach((g,m)=>{const u=g[0];var n=g[1];const x=g[2];g=!1;if(n&2){var p=l.get(m);if(p){p=
p[1];if(x&4){const v=this._model.get(1,h);for(var r of p)if(this._model.updateRenderGeometryTransformation(v,u,r)){g=!0;break}}if(!g)for(const v of p)e.push({renderGeometry:v,updateType:x})}else q.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(n&4||g)(r=l.get(m))?c.push.apply(c,r[1]):4===n&&q.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove"),r&&l.delete(m);if(n&1||g)n=[u,[]],g=this._model.get(1,h),this._model.getGeometryRenderGeometries(g,
u,n[1]),b.push.apply(b,n[1]),l.set(m,n)});0===l.size&&this._residentGeomRecords.get(f).delete(h)}),0===this._residentGeomRecords.get(f).size&&this._residentGeomRecords.delete(f),this._dirtyGeomRecords.delete(f);return[b,c,e]};d.getResidentRenderGeometries=function(){return this.getResidentRenderGeometriesFilteredByLayers([...this._residentGeomRecords.keys()])};d.getResidentRenderGeometriesFilteredByLayers=function(a){const b=[];for(let c=0;c<a.length;c++){const e=this._residentGeomRecords.get(a[c]);
e&&e.forEach(f=>{f.forEach(k=>{b.push(...k[1])})})}return b};d._objectStateChanged=function(a,b,c,e){if(null!=c)this._componentPropertyChanged(b,c,e,a);else for(const f of b.geometryRecords)this._componentPropertyChanged(b,f,e,a)};d.visibilityChanged=function(a,b,c){this._objectStateChanged(1,a,b,c)};d.highlightChanged=function(a,b,c){this._objectStateChanged(8,a,b,c)};d.occlusionChanged=function(a,b,c){this._objectStateChanged(16,a,b,c)};d.vertexAttrsUpdated=function(a,b,c){this._updateOrCreateDirtyRecord(a,
b,c,2,0,0,2,5,2)};d.layerAdded=function(a){const b=a.getObjects();for(let c=0;c<b.length;c++)this.layerObjectAdded(a,b[c])};d.layerRemoved=function(a){const b=a.getObjects();for(let c=0;c<b.length;c++)this.layerObjectRemoved(a,b[c])};d.layerObjectAdded=function(a,b){a=a.id;const c=b.geometryRecords;for(let e=0;e<c.length;e++)this.objGeometryAdded(b,c[e],a)};d.layerObjectRemoved=function(a,b){a=a.id;const c=b.geometryRecords;for(let e=0;e<c.length;e++)this.objGeometryRemoved(b,c[e],a)};d.layObjectReplaced=
function(a,b){this.layerObjectRemoved(a,b[0]);this.layerObjectAdded(a,b[1])};d.objTransformation=function(a,b){b=b||this._getParentLayerId(a);this._ensureGeomRecord(b,a.id).forEach(c=>{this._updateOrCreateDirtyRecord(a,c[0],b,2,0,0,2,5,4)})};d.objGeometryAdded=function(a,b,c){this._updateOrCreateDirtyRecord(a,b,c,1,4,0,0,0)};d.objGeometryRemoved=function(a,b,c){this._updateOrCreateDirtyRecord(a,b,c,4,1,2,0,0)};d._componentPropertyChanged=function(a,b,c,e){this._updateOrCreateDirtyRecord(a,b,c,2,0,
0,2,5,e)};d._updateOrCreateDirtyRecord=function(a,b,c,e,f,k,h,l,g){c=c||this._getParentLayerId(a);const m=b.id;a=this._ensureDirtyRecord(c,a.id);(c=a.get(m))?(b=c[1],b&f?a.delete(m):b&k?(c[1]=e,c[2]=g):b&h?c[2]|=g:b&l||q.assert(!1,"ModelDirtySet.objGeometryAdded: inconsistent state")):a.set(m,[b,e,g])};d._ensureGeomRecord=function(a,b){let c=this._residentGeomRecords.get(a);c||(c=new Map,this._residentGeomRecords.set(a,c));a=c.get(b);a||(a=new Map,c.set(b,a));return a};d._ensureDirtyRecord=function(a,
b){let c=this._dirtyGeomRecords.get(a);c||(c=new Map,this._dirtyGeomRecords.set(a,c));a=c.get(b);a||(a=new Map,c.set(b,a));return a};d._getParentLayerId=function(a){return a.parentLayer.id};d.formatDebugInfo=function(){const a=["ADD","UPD",void 0,"REM"];let b="";this._dirtyGeomRecords.forEach((c,e)=>{c.forEach((f,k)=>{0<b.length&&(b+="\n");b+=e+"."+k;const h=[];f.forEach(l=>{const g=l[1];h[g]||(h[g]=[]);h[g].push(l[0].geometry.id)});for(f=0;f<h.length;f++)if(h[f])for(b+=" "+a[f-1]+": ",k=0;k<h[f].length;k++)b+=
h[f][k]+", "})});return b};y._createClass(t,[{key:"residentLayerCount",get:function(){return this._residentGeomRecords.size}},{key:"residentObjectCount",get:function(){let a=0;this._residentGeomRecords.forEach(b=>{a+=b.size});return a}}]);return t}()});