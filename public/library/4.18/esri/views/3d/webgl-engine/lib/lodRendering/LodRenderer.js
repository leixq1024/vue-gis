// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/vec3f64 ../../../../../chunks/vec3 ../../../../../chunks/mat4f64 ../../../../../chunks/vec2f64 ../../../../../chunks/vec4f64 ../../../../../geometry/support/aaBoundingBox ../DefaultVertexAttributeLocations ../../../support/buffer/glUtil ../Util ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject ../../materials/renderers/utils ../intersectorUtils ../Camera ../../../support/debugFlags ../../materials/internal/MaterialUtil ../../core/shaderLibrary/output/OutputHighlight.glsl ../../materials/DefaultMaterial ./InstanceData ./InstanceOctree ./LevelSelector ./RenderInstanceData".split(" "),
function(w,B,x,v,S,T,U,y,C,F,z,V,G,W,D,X,Y,H,Z,aa,ba,n,ca,da,I){function J(l,k,a,b){D.encodeDoubleVec3(l.modelOrigin,k,a.modelOriginHi,a.modelOriginLo,b);a.model.copyFrom(b,l.model,k);a.modelNormal.copyFrom(b,l.modelNormal,k);l.color&&a.color&&a.color.copyFrom(b,l.color,k);l.featureAttribute&&a.featureAttribute&&a.featureAttribute.copyFrom(b,l.featureAttribute,k)}let K=function(l){const k=l.baseBoundingSphere.radius;l=l.levels.map(a=>a.minScreenSpaceRadius);return new da.LevelSelector(k,l)},L=function(){function l(a,
b){const d=a.rctx,e=b.geometry;b=b.material;const f=e.data.toRenderData();this.materialRep=a.materialRep;b.setParameterValues({instancedDoublePrecision:!0});a=b.createBufferWriter();const g=a.vertexBufferLayout,c=a.elementCount(f),h=a.allocate(c);a.write({},f,h,0);this.geometry=e;this.material=b;this.glMaterials=D.acquireMaterials(b,this.materialRep);this.vertexBufferLayout=g;this.vbo=V.createVertex(d,35044,h.buffer);this.vao=new W(d,C.Default3D,{geometry:F.glLayout(g)},{geometry:this.vbo});this.vertexCount=
c}var k=l.prototype;k.destroy=function(){D.releaseMaterials(this.material,this.materialRep);this.vbo.dispose();this.vao.dispose()};k.intersect=function(a,b,d,e,f,g){const c=this.geometry.id,h=f.toString();this.material.intersect(this.geometry,null,a.transform.transform,a,d,e,(m,r,t,p)=>{if(0<=m&&(null==b||b(a.rayBeginPoint,a.rayEndPoint,m))){var q={type:"external",metadata:{layerUid:g.layerUid,graphicUid:g.graphicUid(f)}};if(null==a.results.min.drapedLayerOrder||p>=a.results.min.drapedLayerOrder)if(null==
a.results.min.dist||m<a.results.min.dist)a.results.min.set(q,h,m,r,a.transform.transform,p,null,c,t),a.results.min.intersector="LodRenderer";0!==a.options.store&&(null==a.results.max.drapedLayerOrder||p>=a.results.max.drapedLayerOrder)&&(null==a.results.max.dist||m>a.results.max.dist)&&(a.results.max.set(q,h,m,r,a.transform.transform,p,null,c,t),a.results.min.intersector="LodRenderer");if(2===a.options.store){const E=new X.IntersectorResult(a.results.min.ray);E.set(q,h,m,r,a.transform.transform,p,
null,c,t);E.intersector="LodRenderer";a.results.all.push(E)}}})};B._createClass(l,[{key:"boundingInfo",get:function(){return this.geometry.boundingInfo}},{key:"triangleCount",get:function(){return this.vertexCount/3}}]);return l}(),M=function(){function l(a,b){this.components=[];this.minScreenSpaceRadius=b.minScreenSpaceRadius;b.components.forEach(d=>{this.components.push(new L(a,d))})}var k=l.prototype;k.destroy=function(){this.components.forEach(a=>{a.destroy()})};k.intersect=function(a,b,d,e,f,
g){this.components.forEach(c=>{c.intersect(a,b,d,e,f,g)})};B._createClass(l,[{key:"boundingBox",get:function(){if(!this._boundingBox){const a=y.empty();this.components.forEach(b=>{y.expandWithVec3(a,b.boundingInfo.bbMin);y.expandWithVec3(a,b.boundingInfo.bbMax)});this._boundingBox=a}return this._boundingBox}},{key:"boundingSphere",get:function(){if(!this._boundingSphere){const a=this.boundingBox,b=x.create();y.center(a,b);this._boundingSphere={center:b,radius:.5*y.diameter(a)}}return this._boundingSphere}},
{key:"triangleCount",get:function(){return this.components.reduce((a,b)=>a+b.triangleCount,0)}}]);return l}(),ea=function(){function l(a,b,d,e){this.type="Lod";this.isGround=!1;this._inverseViewport=T.create();this._levels=[];this._renderInstanceData=[];this._highlightRenderInstanceData=[];this._instanceIndex=0;this._slicePlane=!1;this._enableLevelSelection=!0;this._lastCamera=new Y;this._updateCyclesWithStaticCamera=-1;this._needFullCycle=!1;this.canRender=!0;this._symbol=a;this._optionalFields=
b;this._metadata=d;this._instanceBufferLayout=ba.DefaultMaterial.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:b});this._glInstanceBufferLayout=F.glLayout(this._instanceBufferLayout,{divisor:1});this._instanceData=new n.InstanceData(this._optionalFields,e);this._instanceData.on("instance-added",()=>{this.requestUpdateCycle()});this._instanceData.on("instance-removed",()=>{this.requestUpdateCycle()});this._instanceData.on("instance-transform-changed",f=>{this.requestUpdateCycle();
this._metadata.notifyGraphicUpdate(f.index,2)});this._instanceData.on("instance-visibility-changed",f=>{this.requestUpdateCycle(!0);this._metadata.notifyGraphicUpdate(f.index,1)});this._instanceData.on("instance-highlight-changed",()=>{this.requestUpdateCycle(!0)});this._enableLevelSelection=1<this._symbol.levels.length;A.push(this)}var k=l.prototype;k.destroy=function(){A.splice(A.indexOf(this),1)};k.initializeRenderContext=function(a){this._initContext=a;const b=a.rctx;this._symbol.levels.forEach(d=>
{this._levels.push(new M(a,d));this._renderInstanceData.push(new I.RenderInstanceData(b,this._instanceBufferLayout));this._highlightRenderInstanceData.push(new I.RenderInstanceData(b,this._instanceBufferLayout))});this._levelSelector=K(this)};k.uninitializeRenderContext=function(){this.invalidateOctree();this._levels.forEach(a=>{a.destroy()});this._renderInstanceData.forEach(a=>{a.destroy()});this._highlightRenderInstanceData.forEach(a=>{a.destroy()})};k.prepareRender=function(a){this.runUpdates(a)};
k.render=function(a){const b=a.rctx,d=4===a.slot?3:6===a.slot?5:null;if(d){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(a.pass))return!1;var e=a.camera;this._inverseViewport[0]=1/e.fullViewport[2];this._inverseViewport[1]=1/e.fullViewport[3];var f={slot:d,origin:[0,0,0],camera:e,inverseViewport:this._inverseViewport,shadowMap:a.shadowMap,shadowMappingEnabled:!!a.shadowMap&&a.shadowMap.enabled,ssaoEnabled:!!a.ssaoHelper&&a.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,
slicePlane:a.sliceHelper&&a.sliceHelper.plane,hudVisibilityTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:a.scenelightingData,transparencyPassType:a.transparencyPassType};b.bindVAO();for(let g=0;g<this._levels.length;++g){const c=
a.isHighlightPass?this._highlightRenderInstanceData[g]:this._renderInstanceData[g];this._levels[g].components.forEach(h=>{this.renderComponent(a,d,f,c,h,g)})}return!0}};k.intersect=function(a,b,d,e){if(this.baseMaterial.isVisible()){var f=x.create();v.subtract(f,e,d);var g=c=>{this._instanceData.getCombinedModelTransform(c,N);a.transform.set(N);v.transformMat4(O,d,a.transform.inverse);v.transformMat4(P,e,a.transform.inverse);const h=this._instanceData.getState(c),m=this._instanceData.getLodLevel(c);
z.assert(h&n.StateFlags.ACTIVE,"invalid instance state");z.assert(0<=m&&m<this._levels.length,"invaid lod level");this._levels[m].intersect(a,b,O,P,c,this._metadata)};this.baseMaterial.params.verticalOffset?this.octree.forEach(g):this.octree.forEachAlongRay(d,f,g)}};k.queryDepthRange=function(a){return this.queryDepthRangeOctree(a)};k.notifyShaderTransformationChanged=function(){this.invalidateOctree()};k.requestUpdateCycle=function(a=!1){this._updateCyclesWithStaticCamera=-1;a&&(this._needFullCycle=
!0);this.needsUpdates&&this._initContext.requestRender()};k.runUpdates=function(a){if(!H.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var b=a.equals(this._lastCamera);this._lastCamera.copyFrom(a);b||this.requestUpdateCycle()}b=this._needFullCycle?this._instanceData.size:2E3;this._needFullCycle=!1;this.updateInstances(a,b);this.needsUpdates&&this._initContext.requestRender()}};k.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)};k.buildOctree=
function(){const a=new ca.InstanceOctree(this._instanceData,this.baseBoundingSphere);var b=this._instanceData;b=b.view?b.view.state:null;for(let d=0;d<this._instanceData.capacity;++d)b.get(d)&n.StateFlags.ACTIVE&&a.addInstance(d);return a};k.queryDepthRangeOctree=function(a){var b=a.eye;const d=a.viewForward;var e=this.octree.findClosest(d,"front-to-back",a.frustum);const f=this.octree.findClosest(d,"back-to-front",a.frustum);return null!=e&&null!=f?(this._instanceData.view.boundingSphere.getVec(e,
u),v.subtract(u,u,b),e=v.dot(u,d)-u[3],this._instanceData.view.boundingSphere.getVec(f,u),v.subtract(u,u,b),b=v.dot(u,d)+u[3],{near:Math.max(a.near,e),far:Math.min(a.far,b)}):{near:Infinity,far:-Infinity}};k.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._renderInstanceData.forEach(a=>{a.startUpdateCylce()});this._highlightRenderInstanceData.forEach(a=>{a.startUpdateCylce()});this.needsUpdates&&this._initContext.requestRender()};k.updateInstances=function(a,b){const d=this._enableLevelSelection,
e=this._levelSelector;e.updateCamera(a);this._renderInstanceData.forEach(p=>{p.beginUpdate()});this._highlightRenderInstanceData.forEach(p=>{p.beginUpdate()});a=this._instanceData;const f=this._instanceData.view,g=a.capacity;let c=this._instanceIndex;b=Math.min(a.size,b);for(let p=0;p<b;++p){0===c&&this.startUpdateCycle();const q=f.state.get(c);var h=0;if(q&n.StateFlags.ALLOCATED){var m=f.lodLevel.get(c);q&n.StateFlags.ACTIVE&&this._renderInstanceData[m].freeTail();q&n.StateFlags.HIGHLIGHT_ACTIVE&&
this._highlightRenderInstanceData[m].freeTail();if(q&n.StateFlags.REMOVE)a.freeInstance(c);else if(q&n.StateFlags.VISIBLE){m=0;d&&(f.modelOrigin.getVec(c,Q),m=e.selectLevel(Q,a.getCombinedMedianScaleFactor(c)));h=q&~(n.StateFlags.ACTIVE|n.StateFlags.HIGHLIGHT_ACTIVE|n.StateFlags.TRANSFORM_CHANGED);if(0<=m){var r=this._renderInstanceData[m],t=r.allocateHead();J(f,c,r.view,t);h|=n.StateFlags.ACTIVE;q&n.StateFlags.HIGHLIGHT&&(r=this._highlightRenderInstanceData[m],t=r.allocateHead(),J(f,c,r.view,t),
h|=n.StateFlags.HIGHLIGHT_ACTIVE)}f.state.set(c,h);f.lodLevel.set(c,m)}else h=q&~(n.StateFlags.ACTIVE|n.StateFlags.HIGHLIGHT_ACTIVE|n.StateFlags.TRANSFORM_CHANGED),f.state.set(c,h);this._octree&&(m=!!(q&n.StateFlags.ACTIVE),h=!!(h&n.StateFlags.ACTIVE),!m&&h?this._octree.addInstance(c):m&&!h?this._octree.removeInstance(c):m&&h&&q&n.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(c),this._octree.addInstance(c)));c=(c+1)%g}else c=(c+1)%g,b++}this._instanceIndex=c;this._renderInstanceData.forEach(p=>
{p.endUpdate()});this._highlightRenderInstanceData.forEach(p=>{p.endUpdate()})};k.renderComponent=function(a,b,d,e,f,g){var c=f.glMaterials.get(a.pass);if(c&&c.beginSlot(b)&&0!==e.size){var h=a.rctx,m=h.capabilities.instancing;c.ensureParameters(d);var r=c.getTechnique();b=c.getPipelineState(b);h.setPipelineState(b);c.bind(h,d);h.bindVAO(f.vao);r.ensureAttributeLocations(f.vao);c=r.program;a.isHighlightPass&&aa.OutputHighlight.bindOutputHighlight(h,c,d);r.bindDraw(d);H.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&
0===a.pass&&(c.setUniform4fv("externalColor",R[Math.min(g,R.length-1)]),c.setUniform1i("colorMixMode",Z.colorMixModes.replace));a=e.capacity;d=e.headIndex;g=e.tailIndex;c=e.firstIndex;var t=this._glInstanceBufferLayout;b=(p,q)=>{G.bindVertexBufferLayout(h,C.Default3D,e.buffer,t,p);m.drawArraysInstanced(r.primitiveType,0,f.vertexCount,q-p);G.unbindVertexBufferLayout(h,C.Default3D,e.buffer,t)};f.material.params.transparent&&null!=c?d>g?(z.assert(c>=g&&c<=d,"invalid firstIndex"),b(c,d),b(g,c)):d<g&&
(c<=d?(z.assert(0<=c&&c<=d,"invalid firstIndex"),b(c,d),b(g,a),b(0,c)):(z.assert(c>=g&&c<=a,"invalid firstIndex"),b(c,a),b(0,d),b(g,c))):d>g?b(g,d):d<g&&(b(0,d),b(g,a));h.bindVAO(null)}};B._createClass(l,[{key:"levels",get:function(){return this._levels}},{key:"baseBoundingBox",get:function(){return this._levels[this._levels.length-1].boundingBox}},{key:"baseBoundingSphere",get:function(){return this._levels[this._levels.length-1].boundingSphere}},{key:"baseMaterial",get:function(){return this._levels[this._levels.length-
1].components[0].material}},{key:"slicePlane",get:function(){return this._slicePlane},set:function(a){this._slicePlane=a}},{key:"intersectionHandlerId",get:function(){return this._metadata.layerUid}},{key:"instanceData",get:function(){return this._instanceData}},{key:"memoryUsage",get:function(){const a={cpu:0,gpu:0};this._renderInstanceData.forEach(b=>{b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});this._highlightRenderInstanceData.forEach(b=>{b=b.memoryUsage;a.cpu+=b.cpu;a.gpu+=b.gpu});return a}},
{key:"renderStats",get:function(){const a=this._instanceData.size,b=[];this._levels.forEach((d,e)=>{e=this._renderInstanceData[e].size+this._highlightRenderInstanceData[e].size;d=d.triangleCount;b.push({renderedInstances:e,renderedTriangles:e*d,trianglesPerInstance:d})});return{totalInstances:a,renderedInstances:b.reduce((d,e)=>d+e.renderedInstances,0),renderedTriangles:b.reduce((d,e)=>d+e.renderedTriangles,0),levels:b}}},{key:"slots",get:function(){return[4,6]}},{key:"needsHighlight",get:function(){return 0<
this._highlightRenderInstanceData.reduce((a,b)=>a+b.size,0)}},{key:"needsUpdates",get:function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera}},{key:"octree",get:function(){this._octree||(this._octree=this.buildOctree());return this._octree}}]);return l}();const A=[],Q=x.create(),u=U.create(),N=S.create(),O=x.create(),P=x.create(),R=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];w.LodComponentData=L;w.LodLevelData=M;w.LodRenderer=ea;w.lodRenderers=A;w.setLevelSelectorFactory=
function(l){K=l};Object.defineProperty(w,"__esModule",{value:!0})});