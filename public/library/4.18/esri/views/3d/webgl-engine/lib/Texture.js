// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/compilerUtils ../../../../core/typedArrayUtil ../../../../core/maybe ../../../../core/Error ../../../../core/urlUtils ../../../../core/promiseUtils ../../../../core/Evented ../../../../core/mathUtils ../../../../support/requestUtils ../../../../support/requestImageUtils ./Util ../../../webgl/Texture ../../../webgl/Util ./glUtil3D ./IdGen ../../../webgl/FramebufferObject ../../../webgl/capabilities/isWebGL2Context ./DDSUtil".split(" "),
function(x,y,n,h,z,u,r,A,t,B,C,D,p,E,F,G,H,I,J){let v=function(){function k(a,c,b){this.data=a;this.loadingController=this.loadingPromise=this.powerOfTwoStretchInfo=this.glTexture=null;this.events=new A;this.data=a;this.id=k.idGen.gen(c);this.params=b||{};this.params.mipmap=!1!==this.params.mipmap;this.params.noUnpackFlip=this.params.noUnpackFlip||!1;this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1;this.params.wrap=this.params.wrap||{s:10497,t:10497};this.params.powerOfTwoResizeMode=
this.params.powerOfTwoResizeMode||1;this.estimatedTexMemRequired=k.estimateTexMemRequired(this.data,this.params);this.startPreload()}var g=k.prototype;g.startPreload=function(){const a=this.data;h.isNone(a)||(a instanceof HTMLVideoElement?this.startPreloadVideoElement(a):a instanceof HTMLImageElement&&this.startPreloadImageElement(a))};g.startPreloadVideoElement=function(a){u.isBlobProtocol(a.src)||"auto"===a.preload&&a.crossOrigin||(a.preload="auto",a.crossOrigin="anonymous",a.src=a.src)};g.startPreloadImageElement=
function(a){u.isDataProtocol(a.src)||u.isBlobProtocol(a.src)||a.crossOrigin||(a.crossOrigin="anonymous",a.src=a.src)};k.getDataDimensions=function(a){return a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a};k.estimateTexMemRequired=function(a,c){if(h.isNone(a))return 0;if(n.isArrayBuffer(a)||n.isUint8Array(a))return a.byteLength;const {width:b,height:d}=a instanceof Image||a instanceof ImageData||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?k.getDataDimensions(a):
c;return(c.mipmap?4/3:1)*b*d*(c.components||4)||0};g.dispose=function(){this.data=void 0};g.createDescriptor=function(a){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.mipmap&&!this.params.disableAnisotropy?a.parameters.maxMaxAnisotropy:void 0}};g.load=function(a,c){if(h.isSome(this.glTexture))return this.glTexture;
if(h.isSome(this.loadingPromise))return this.loadingPromise;const b=this.data;return h.isNone(b)?(this.glTexture=new p(a,this.createDescriptor(a),null),a.bindTexture(this.glTexture,0),this.glTexture):"string"===typeof b?this.loadFromURL(a,c,b):b instanceof Image?this.loadFromImageElement(a,c,b):b instanceof HTMLVideoElement?this.loadFromVideoElement(a,c,b):b instanceof ImageData||b instanceof HTMLCanvasElement?this.loadFromImage(a,b,c):(n.isArrayBuffer(b)||n.isUint8Array(b))&&this.params.encoding===
k.DDS_ENCODING?this.loadFromDDSData(a,b):n.isUint8Array(b)?this.loadFromPixelData(a,b):n.isArrayBuffer(b)?this.loadFromPixelData(a,new Uint8Array(b)):null};g.frameUpdate=function(a,c,b){if(!(this.data instanceof HTMLVideoElement)||h.isNone(this.glTexture)||2>this.data.readyState||b===this.data.currentTime)return b;if(h.isSome(this.powerOfTwoStretchInfo)){const {framebuffer:d,vao:f,sourceTexture:e}=this.powerOfTwoStretchInfo;e.setData(this.data);this.drawStretchedTexture(a,c,d,f,e,this.glTexture)}else{const {width:d,
height:f}=this.data,{width:e,height:l}=this.glTexture.descriptor;d!==e||f!==l?this.glTexture.updateData(0,0,0,Math.min(d,e),Math.min(f,l),this.data):this.glTexture.setData(this.data)}this.glTexture.descriptor.hasMipmap&&this.glTexture.generateMipmap();return this.data.currentTime};g.loadFromDDSData=function(a,c){this.glTexture=J.createDDSTexture(a,this.createDescriptor(a),c,this.params.mipmap);a.bindTexture(this.glTexture,0);return this.glTexture};g.loadFromPixelData=function(a,c){D.assert(0<this.params.width&&
0<this.params.height);const b=this.createDescriptor(a);b.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408;b.width=this.params.width;b.height=this.params.height;this.glTexture=new p(a,b,c);a.bindTexture(this.glTexture,0);return this.glTexture};g.loadAsync=async function(a){const c=r.createAbortController();this.loadingController=c;const b=a(c.signal);this.loadingPromise=b;a=()=>{this.loadingController===c&&(this.loadingController=null);this.loadingPromise===b&&(this.loadingPromise=
null)};b.then(a,a);return b};g.loadFromURL=function(a,c,b){return this.loadAsync(async d=>{d=await C.requestImage(b,{signal:d});return this.loadFromImage(a,d,c)})};g.loadFromImageElement=function(a,c,b){return b.complete?this.loadFromImage(a,b,c):this.loadAsync(async d=>{d=await B.loadImageAsync(b,b.src,!1,d);return this.loadFromImage(a,d,c)})};g.loadFromVideoElement=function(a,c,b){return 2<=b.readyState?this.loadFromImage(a,b,c):this.loadFromVideoElementAsync(a,c,b)};g.loadFromVideoElementAsync=
function(a,c,b){return this.loadAsync(d=>r.create((f,e)=>{const l=()=>{b.removeEventListener("loadeddata",q);b.removeEventListener("error",m);h.isSome(w)&&w.remove()},q=()=>{2<=b.readyState&&(l(),f(this.loadFromImage(a,b,c)))},m=K=>{l();e(K||new z("Failed to load video"))};b.addEventListener("loadeddata",q);b.addEventListener("error",m);const w=r.onAbort(d,()=>m(r.createAbortError()))}))};g.loadFromImage=function(a,c,b){const d=k.getDataDimensions(c);this.params.width=d.width;this.params.height=d.height;
const f=this.createDescriptor(a);f.pixelFormat=3===this.params.components?6407:6408;if(this.requiresPowerOfTwo(a,f)&&(!t.isPowerOfTwo(d.width)||!t.isPowerOfTwo(d.height)))return this.glTexture=this.makePowerOfTwoTexture(a,c,d,f,b),a.bindTexture(this.glTexture,0),this.glTexture;f.width=d.width;f.height=d.height;this.glTexture=new p(a,f,c);a.bindTexture(this.glTexture,0);return this.glTexture};g.requiresPowerOfTwo=function(a,c){const b="number"===typeof c.wrapMode?33071===c.wrapMode:33071===c.wrapMode.s&&
33071===c.wrapMode.t;return!I(a.gl)&&(c.hasMipmap||!b)};g.makePowerOfTwoTexture=function(a,c,b,d,f){const {width:e,height:l}=b;b=t.nextHighestPowerOfTwo(e);const q=t.nextHighestPowerOfTwo(l);d.width=b;d.height=q;let m;switch(this.params.powerOfTwoResizeMode){case 2:d.textureCoordinateScaleFactor=[e/b,l/q];m=new p(a,d);m.updateData(0,0,0,e,l,c);break;case 1:case null:case void 0:m=this.stretchToPowerOfTwo(a,c,d,f);break;default:y.neverReached(this.params.powerOfTwoResizeMode)}d.hasMipmap&&m.generateMipmap();
return m};g.stretchToPowerOfTwo=function(a,c,b,d){const f=new p(a,b),e=new H(a,{colorTarget:0,depthStencilTarget:0},f);c=new p(a,{target:3553,pixelFormat:b.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!b.flipped,maxAnisotropy:8,preMultiplyAlpha:b.preMultiplyAlpha},c);b=F.createQuadVAO(a);this.drawStretchedTexture(a,d,e,b,c,f);this.requiresFrameUpdates?this.powerOfTwoStretchInfo={vao:b,sourceTexture:c,framebuffer:e}:(b.dispose(!0),c.dispose(),e.detachColorTexture(),a.bindFramebuffer(null),
e.dispose());return f};g.drawStretchedTexture=function(a,c,b,d,f,e){a.bindFramebuffer(b);b=a.getViewport();a.setViewport(0,0,e.descriptor.width,e.descriptor.height);e=c.program;a.bindProgram(e);e.setUniform4f("color",1,1,1,1);e.setUniform1i("tex",0);a.bindTexture(f,0);a.bindVAO(d);a.setPipelineState(c.pipeline);a.drawArrays(5,0,E.vertexCount(d,"geometry"));a.bindFramebuffer(null);a.setViewport(b.x,b.y,b.width,b.height)};g.unload=function(){if(h.isSome(this.powerOfTwoStretchInfo)){const {framebuffer:a,
vao:c,sourceTexture:b}=this.powerOfTwoStretchInfo;c.dispose(!0);b.dispose();a.dispose();this.powerOfTwoStretchInfo=this.glTexture=null}h.isSome(this.glTexture)&&(this.glTexture.dispose(),this.glTexture=null);if(h.isSome(this.loadingController)){const a=this.loadingController;this.loadingPromise=this.loadingController=null;a.abort()}this.events.emit("unloaded")};x._createClass(k,[{key:"width",get:function(){return this.params.width}},{key:"height",get:function(){return this.params.height}},{key:"requiresFrameUpdates",
get:function(){return this.data instanceof HTMLVideoElement}}]);return k}();v.idGen=new G.IdGen;v.DDS_ENCODING="image/vnd-ms.dds";return v});