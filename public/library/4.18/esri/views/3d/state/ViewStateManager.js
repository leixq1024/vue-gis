// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/scheduling ../../../core/Accessor ../../../geometry/support/webMercatorUtils ../../../geometry/Point ../../../geometry/Extent ../../../core/screenUtils ../../../Camera ../../../core/Handles ../../../Viewpoint ../../../core/watchUtils ../../../chunks/vec4f64 ../../../chunks/vec4 ../camera/intersectionUtils ../camera/constraintUtils ../webgl-engine/lib/Camera ../support/cameraUtils ./Frustum ../support/PropertiesPool ./ConstraintsManager ./controllers/SurfaceCollisionCorrectionController ../support/viewpointUtils ./GoToOperation".split(" "),
function(w,e,f,k,D,Y,l,Z,E,aa,ba,ca,F,G,H,I,y,J,r,K,x,t,L,z,A,M,N,g,O,P,Q,R,B,S){const n=D.getLogger("esri.views.3d.state.ViewStateManager");f=function(C){function u(a){a=C.call(this,a)||this;a.propertiesPool=new P.PropertiesPool({frustum:O.Frustum},w._assertThisInitialized(a));a.handles=new K;a.cameraSetByUser=!1;a.internalSetOrder=[];a.gotoOperation=null;a.ready=!1;a.updateDevicePixelRatio=null;return a}w._inheritsLoose(u,C);var d=u.prototype;d.paddingToArray=function(a,b,c){a?z.set(c,a.top||0,
a.right||0,a.bottom||0,a.left||0):z.set(c,0,0,0,0);for(a=0;4>a;a++)c[a]=Math.round(c[a]*b)};d.initialize=function(){this.handles.add([this.view.state.watch("camera",a=>this.cameraChangedSync(a),!0),t.on(this.view,"state.events","before-camera-change",a=>this.updateElevation(a.camera))]);t.once(this.view.state,"camera",a=>this.updateElevation(a),!0);this.handles.add(F.addFrameTask({prepare:()=>this.prepareFrame()}));this.handles.add(this.view.state.watch("cameraController",()=>{this.cameraSetByUser=
!0;this.handles.remove("pending-initial-view")}));this.handles.add(t.on(this.view,"state.events","camera-projection-changed",()=>this.notifyChange("scale")))};d.destroy=function(){this.deinit();this.handles&&(this.handles.destroy(),this.handles=null);this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)};d.init=function(){this.constraintsManager=new Q["default"]({view:this.view});this.prepareFrame();var a=this.getInitialProperties();this.cameraSetByUser=!1;this._set("ready",
!0);for(const b of a)this.set(b.name,b.value);this.cameraSetByUser||((a=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent)&&this.isCompatible(a)?this.setInitialView(a):2===this.view.state.mode&&this.handles.add(t.whenOnce(this.view.basemapTerrain,"ready",()=>{this.handles.remove("pending-initial-view");this.setInitialView(this.view.groundExtent)}),"pending-initial-view"))};d.deinit=function(){this.cancelGoToOperation();this.ready&&(this._override("padding",this.padding),
this._set("ready",!1),this._clearOverride("hasInitialView"),this.internalSetOrder.length=0,this.cameraSetByUser=!1,this.handles.remove("pending-initial-view"),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))};d.goTo=async function(a,b){b={animate:!0,...b};return this.gotoOperation=k.isSome(this.gotoOperation)?this.gotoOperation.goTo(a,b):new S.GoToOperation(a,b,this.view)};d.debugSetCameraOnContent=function(){this.setStateCamera(A.cameraOnContentAlongViewDirection(this.view),
{applyConstraints:!1})};d.step=function(a){const b=this.view.state,c=b&&this.view.state.cameraController;c&&(b.updateCamera(h=>{c.stepController(a,h)}),c.steppingFinished&&c.finishController())};d.cancelGoToOperation=function(){k.isSome(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)};d.getInitialProperties=function(){const a=new Set,b=[];for(const {propertyName:c,overrides:h}of T){const m=a.has(c),p=this._isOverridden(c);!m&&p&&b.push({name:c,value:this._get(c)});this._clearOverride(c);
(m||p)&&h.forEach(U=>a.add(U))}return b};d.setInitialView=function(a){if(a&&!this.cameraSetByUser)if(a instanceof r)this.setStateCamera(g.externalToInternal(this.view,a),{applyConstraints:!1});else if(a instanceof x)if(a.targetGeometry instanceof y){var b=g.fromExtent(this.view,a.targetGeometry,0,.5,0);k.isSome(b)&&this.setStateCamera(g.externalToInternal(this.view,b),{applyConstraints:!0})}else b={applyConstraints:!a.camera},a=this.viewpointToCamera(a),this.setStateCamera(a,b);else b=g.fromExtent(this.view,
a,0,.5,0),k.isSome(b)&&this.setStateCamera(g.externalToInternal(this.view,b),{applyConstraints:!0})};d.updatePropertyBeforeReady=function(a,b){if(!this.ready){this._override(a,b);const c=this.internalSetOrder.indexOf(a);-1!==c&&(this.internalSetOrder=this.internalSetOrder.splice(c,1));b&&(this.internalSetOrder.push(a),-1!==V.indexOf(a)&&this._override("hasInitialView",!0));return!0}return!1};d.isCompatible=function(a){return k.isNone(a)?!1:a instanceof x?a.camera?this.isCompatible(a.camera):this.isCompatible(a.targetGeometry):
a instanceof r?this.isCompatible(a.position):a.spatialReference&&H.canProject(a.spatialReference,this.view.spatialReference)};d.getPreservingHeadingTilt=function(a=W){this.cameraSetByUser?(a.heading=this.camera.heading,a.tilt=this.camera.tilt):(a.heading=0,a.tilt=.5);return a};d.centerPointAtDistanceToCamera=function(a,b,c=q){const {heading:h,tilt:m}=this.getPreservingHeadingTilt();a=g.getObserverForPointAtDistance(this.view,h,m,a,b,1);if(k.isNone(a))return null;c.copyFrom(this.view.state.camera);
c.eye=a.eye;c.center=a.center;c.up=a.up;return c};d.centerToCamera=function(a){const b=this.view.pointsOfInterest.centerOnContent;b.update();return this.centerPointAtDistanceToCamera(a,b.distance)};d.extentToCamera=function(a){const {heading:b,tilt:c}=this.getPreservingHeadingTilt();a=g.fromExtent(this.view,a,b,c,1,X);return k.isSome(a)?g.externalToInternal(this.view,a):null};d.scaleToCamera=function(a){if(null==a)return null;const b=this.view.pointsOfInterest.centerOnContent;b.update();const c=b.renderLocation;
a=g.scaleToDistance(this.view,a,b.location.latitude);return this.centerPointAtDistanceToCamera(c,a)};d.zoomToCamera=function(a){return this.scaleToCamera(g.zoomToScale(this.view,a))};d.viewpointToCamera=function(a){a=B.toCamera(this.view,a);return k.isSome(a)?g.externalToInternal(this.view,a):null};d.setStateCamera=function(a,b){if(k.isNone(a)||!this.view.state.stopActiveCameraController())return!1;this.cameraSetByUser=!0;b.doNotCancelGoToOperation||this.cancelGoToOperation();this.view.state.updateCamera(c=>
{b.positionAndOrientationOnly?(c.eye=a.eye,c.center=a.center,c.up=a.up):c.copyFrom(a);b.applyConstraints&&M.applyAll(this.view,c)});b.applyConstraints||(this.view.state.cameraController=new R.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:a}));return!0};d.prepareFrame=function(){const {container:a,canvas:b}=this.view;if(a&&b){k.isSome(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();var c=this.view.pixelRatio,h=Math.round(a.clientWidth*c),m=Math.round(a.clientHeight*
c);if(0!==h&&0!==m){if(b.width!==h||b.height!==m)b.width=h,b.height=m;if(this.view.state){const p=this.view.state.camera;if(p.fullWidth!==h||p.fullHeight!==m||p.pixelRatio!==c)q.copyFrom(p),q.pixelRatio!==c&&(this.paddingToArray(this.padding,c,v),q.padding=v),q.fullWidth=h,q.fullHeight=m,q.pixelRatio=c,this.view.state.camera=q}}}};d.updateElevation=function(a){var b=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference;const c=this.view.renderCoordsHelper.getAltitude(a.eye);b=b?A.surfaceElevationBelowRenderLocation(this.view,
a.eye):0;a.relativeElevation=c-b};d.cameraChangedSync=function(a){a&&this.view._stage&&this.view._stage.setCamera(a)};w._createClass(u,[{key:"camera",get:function(){if(!this.ready)return this._get("camera");const a=g.internalToExternal(this.view,this.view.state.camera),b=this._get("camera");return a&&b&&a.equals(b)?b:a},set:function(a){this.updatePropertyBeforeReady("camera",a)||this.setStateCamera(g.externalToInternal(this.view,a),{applyConstraints:!1})||n.error("#camera\x3d","Invalid camera",a)}},
{key:"center",get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(a){this.updatePropertyBeforeReady("center",a)||(a?this.isCompatible(a)?this.setStateCamera(this.centerToCamera(a),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.update():n.error("#center\x3d","Invalid center",a):n.error("#center\x3d","Center has an incompatible spatial reference (center: "+(a.spatialReference?a.spatialReference.wkid:"none")+", view: "+
this.view.spatialReference.wkid+")",a):n.error("#center\x3d","Center may not be null or undefined"))}},{key:"extent",get:function(){if(!this.ready)return this._get("extent");var a=this.view;a=g.toExtent(a,a.state.camera,a.pointsOfInterest.centerOnContent.renderLocation);return k.isSome(a)?a:this._get("extent")},set:function(a){this.updatePropertyBeforeReady("extent",a)||(a?this.isCompatible(a)?this.setStateCamera(this.extentToCamera(a),{applyConstraints:!0})||n.error("#extent\x3d","Invalid extent",
a):n.error("#extent\x3d","Extent has an incompatible spatial reference (extent: "+(a.spatialReference?a.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a):n.error("#extent\x3d","Extent may not be null or undefined"))}},{key:"frustum",get:function(){const a=this.propertiesPool.get("frustum");a.renderCoordsHelper=this.view.renderCoordsHelper;a.update(this.view.state.camera);return a}},{key:"hasInitialView",get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")}},
{key:"scale",get:function(){if(!this.ready)return this._get("scale");const a=this.view.pointsOfInterest.centerOnContent;return g.distanceToScale(this.view,a.distance,a.location.latitude)},set:function(a){this.updatePropertyBeforeReady("scale",a)||this.setStateCamera(this.scaleToCamera(a),{applyConstraints:!0})||n.error("#scale\x3d","Invalid scale",a)}},{key:"padding",get:function(){if(!this.ready)return this._get("padding");var a=this.view.state.camera,b=a.padding;const c=a.pixelRatio;a=this._get("padding");
const h=Math.round(b[0]/c),m=Math.round(b[1]/c),p=Math.round(b[2]/c);b=Math.round(b[3]/c);return null!=a&&a.top===h&&a.right===m&&a.bottom===p&&a.left===b?a:{top:h,right:m,bottom:p,left:b}},set:function(a){this.updatePropertyBeforeReady("padding",a)||(this.paddingToArray(a,this.view.state.camera.pixelRatio,v),this.view.state.updateCamera(b=>b.padding=v))}},{key:"screenCenter",get:function(){const a=this.padding;return J.createScreenPoint((this.view.width-(a.left+a.right))/2+a.left,(this.view.height-
(a.top+a.bottom))/2+a.top)}},{key:"viewpoint",get:function(){return this.ready?B.fromCamera(this.view,this.camera):this._get("viewpoint")},set:function(a){if(!this.updatePropertyBeforeReady("viewpoint",a))if(a)if(this.isCompatible(a))this.setStateCamera(this.viewpointToCamera(a),{applyConstraints:!a.camera})||n.error("#viewpoint\x3d","Invalid viewpoint",a);else{var b=k.isSome(a.camera)?a.camera.position:a.targetGeometry;b=k.isSome(b)&&b.spatialReference;n.error("#viewpoint\x3d","Viewpoint has an incompatible spatial reference (viewpoint: "+
(b?b.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a)}else n.error("#viewpoint\x3d","Viewpoint may not be null or undefined")}},{key:"zoom",get:function(){return this.ready?g.scaleToZoom(this.view,this.scale):this._get("zoom")},set:function(a){this.updatePropertyBeforeReady("zoom",a)||this.setStateCamera(this.zoomToCamera(a),{applyConstraints:!0})||n.error("#zoom\x3d","Invalid zoom",a)}}]);return u}(G);e.__decorate([l.property({type:r,dependsOn:["view.state.camera","ready"],autoTracked:!1})],
f.prototype,"camera",null);e.__decorate([l.property({type:I,dependsOn:["view.pointsOfInterest.centerOnContent.location","ready"]})],f.prototype,"center",null);e.__decorate([l.property({type:y,dependsOn:["view.state.camera","ready","view.pointsOfInterest.centerOnContent.location"]})],f.prototype,"extent",null);e.__decorate([l.property({readOnly:!0,dependsOn:["view.state.camera","ready"]})],f.prototype,"frustum",null);e.__decorate([l.property({readOnly:!0,dependsOn:["view.map.initialViewProperties?.viewpoint"]})],
f.prototype,"hasInitialView",null);e.__decorate([l.property({readOnly:!0,type:Boolean})],f.prototype,"ready",void 0);e.__decorate([l.property({dependsOn:["view.pointsOfInterest.centerOnContent.distance","ready"],type:Number})],f.prototype,"scale",null);e.__decorate([l.property({dependsOn:["view.state.camera","ready"]})],f.prototype,"padding",null);e.__decorate([l.property({readOnly:!0,dependsOn:["view.width","view.height","padding"]})],f.prototype,"screenCenter",null);e.__decorate([l.property({constructOnly:!0})],
f.prototype,"view",void 0);e.__decorate([l.property({type:x,dependsOn:["camera","ready"]})],f.prototype,"viewpoint",null);e.__decorate([l.property({type:Number,dependsOn:["scale"]})],f.prototype,"zoom",null);e.__decorate([l.property({constructOnly:!0})],f.prototype,"updateDevicePixelRatio",void 0);e=f=e.__decorate([E.subclass("esri.views.3d.state.ViewStateManager")],f);const V="camera viewpoint extent scale center zoom".split(" "),T=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",
overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],W={heading:0,tilt:0},X=new r,q=new N,v=L.create();return e});