// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../core/scheduling ../../../../../core/Evented ../../../../../core/mathUtils ../../../../../core/screenUtils ../../../../../chunks/vec3f64 ../../../../../chunks/common ../../../../../chunks/vec3 ../../../support/mathUtils ../../../../../core/Handles ../../../../../core/watchUtils ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../support/elevationInfoUtils ../../../support/stack ../../../support/geometryUtils ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Geometry ../../../webgl-engine/materials/ColorMaterial ../../../../interactive/dragEventPipeline ../dragEventPipeline3D ../../Manipulator3D ../../manipulatorUtils ../manipulations/config".split(" "),
function(J,T,v,U,V,K,L,C,W,w,X,Y,Z,z,aa,ba,r,B,G,M,ca,N,da,ea,H,d){function fa(e,c){var a=w.subtract(r.sv3d.get(),c.renderStart,e.origin);e=w.subtract(r.sv3d.get(),c.renderEnd,e.origin);a=w.length(a);e=w.length(e);return 0===a?0:e/a}function ha(e,c){const a=e.allLayerViews.find(f=>f.layer===c.layer);if(v.isNone(c.symbol))return null;const b=c.symbol;return{symbolLayers:b.symbolLayers.map(f=>{let n=null,p=null;"object"===f.type&&(n=f.heading);p=a.getSymbolLayerSize(b,f);return{heading:n,size:p}}).toArray()}}
function ia(e,c,a,b){const {renderStart:f,renderEnd:n}=e;var p=F(f,b,r.sv3d.get());e=F(n,b,r.sv3d.get());if(w.squaredDistance(p,e)<d.DRAG_THRESHOLD_PX*d.DRAG_THRESHOLD_PX)return null;const t=w.subtract(r.sv3d.get(),f,a);c=w.cross(r.sv3d.get(),t,c);c=w.add(r.sv3d.get(),f,c);a=F(a,b,r.sv3d.get());b=F(c,b,r.sv3d.get());c=w.subtract(r.sv3d.get(),b,p);b=w.subtract(r.sv3d.get(),p,a);p=B.ray.wrap(p,c);b=B.ray.wrap(a,b);return B.ray.distance2(p,e)<B.ray.distance2(b,e)?"rotate":"scale"}function F(e,c,a){e=
c.projectToRenderScreen(e,L.castRenderScreenPointArray(ja));c=c.renderToScreen(e,ka);return w.set(a,c[0],c[1],0)}function O(e,c){let a=null,b=1;const f=()=>b;return{start:()=>{b=e.getScale();a=e.getScale;e.getScale=f;c()},update:n=>{b+=((b+1)/2-b)*Math.min(n*d.RING_RESET_ANIMATION_SPEED_FACTOR,1);c();return.01>Math.abs(b-1)?1:0},destroy:()=>{e.getScale=a;c()}}}function la(e,c){let a=0,b=null;const f=()=>!1;return{start:()=>{b=e.getFocused;e.getFocused=f;a=0;c()},update:n=>{a+=n;return!b()||a>d.RING_INDICATOR_DELAY_MS?
1:0},destroy:()=>{e.getFocused=b;c()}}}var g;(function(e){e.ScaleIn=32;e.ScaleOut=64;e.RotateLeft=128;e.RotateRight=256;e.Unlocked=1024;e.DelayedFocused=2048;e.TouchInput=32768})(g||(g={}));let ma=function(){function e(a){this.mode=null;this._handles=new Y;this._activeAnimation=this._scaleRotateDragData=null;this.events=new V;this.getFocused=()=>this.ringManipulator.focused;this.getScale=()=>v.isSome(this._scaleRotateDragData)&&"scale"===this._scaleRotateDragData.mode?this._scaleRotateDragData.scale:
1;this.tool=a.tool;this.mode=a.mode;this.createManipulator();this.updateDragState();this.updateManipulatorTransform()}var c=e.prototype;c.destroy=function(){v.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null);this._handles.removeAll();this.tool.manipulators.remove(this.ringManipulator);this.ringManipulator=null};c.startAnimation=function(a){this.cancelActiveAnimation();a.start();const b=U.addFrameTask({update:({deltaTime:f})=>{a.update(f)&&this.cancelActiveAnimation()}});
this._activeAnimation={...a,frameTask:b}};c.cancelActiveAnimation=function(){v.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)};c.forEachManipulator=function(a){a(this.ringManipulator,2)};c.createManipulator=function(){this.ringManipulator=this.createRingManipulator();this.tool.manipulators.add(this.ringManipulator);const a=this.tool.graphicState.graphic,b=N.createManipulatorDragEventPipeline(this.ringManipulator,
(f,n,p)=>{this._scaleRotateDragData=null;var t=ha(this.tool.view,a);if(v.isNone(t))return this.updateDragState(),null;const h={mode:"none",origin:C.clone(f.renderLocation),angle:0,startAngle:this.tool.symbolRotationAngle,angleDir:0,scale:1,scaleDir:0,startSymbolData:t};this._scaleRotateDragData=h;this.updateDragState();t=r.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(f.renderLocation,t);n.next(da.screenToRenderPlane(this.tool.view,B.plane.fromPositionAndNormal(f.renderLocation,t))).next(m=>
{var k=B.plane.normal(m.plane);k=H.calculateInputRotationTransform(m.renderStart,m.renderEnd,h.origin,k);var l=X.cyclicalPI.shortestSignedDiff(h.angle,k);h.angleDir=K.clamp(h.angleDir+l,-d.ROTATE_INDICATOR_DIRECTION_BUFFER,d.ROTATE_INDICATOR_DIRECTION_BUFFER);h.angle=k;k=fa(h,m);h.scaleDir=K.clamp(h.scaleDir+(k-h.scale),-d.SCALE_INDICATOR_DIRECTION_BUFFER,d.SCALE_INDICATOR_DIRECTION_BUFFER);h.scale=k;this.onScaleChanged();if("none"===h.mode&&(k=this.mode||ia(m,m.plane,h.origin,this.tool.view.state.camera),
v.isSome(k))){switch(k){case "rotate":this.tool.emit("graphic-rotate-start",{graphic:a,angle:h.angle});break;case "scale":this.tool.emit("graphic-scale-start",{graphic:a,scale:h.scale})}h.mode=k}this.updateDragState();if(v.isSome(a.symbol)){k=a.symbol.clone();l=0;let u=1;switch(h.mode){default:case "none":break;case "scale":u=h.scale;break;case "rotate":l=h.angle}this.applySymbolData(k,h.startSymbolData,l,u);a.symbol=k;this.updateManipulatorTransform()}switch(m.action){case "start":case "update":switch(h.mode){case "rotate":this.tool.emit("graphic-rotate",
{graphic:a,angle:h.angle});break;case "scale":this.tool.emit("graphic-scale",{graphic:a,scale:h.scale})}break;case "end":switch(h.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:h.angle});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:a,scale:h.scale})}}"end"===m.action&&(this.startAnimation(O(this,()=>this.onScaleChanged())),this._scaleRotateDragData=null,this.updateDragState())});p.next(N.resetSymbol(a)).next(()=>{if(v.isSome(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case "rotate":this.tool.emit("graphic-rotate-stop",
{graphic:a,angle:this._scaleRotateDragData.startAngle});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:a,scale:1})}this.startAnimation(O(this,()=>this.onScaleChanged()));this._scaleRotateDragData=null}})});this._handles.add(b);this._handles.add([this.ringManipulator.events.on("focus-changed",f=>{"focus"===f.action?this.startAnimation(la(this,()=>this.updateDelayedFocusedState())):this.updateDelayedFocusedState()}),this.ringManipulator.events.on("immediate-click",f=>{f.stopPropagation()}),
Z.init(this.tool.graphicState,"displaying",f=>this.ringManipulator.available=f),this.tool.graphicState.on("changed",()=>H.placeAtGraphic(this.tool.view,this.ringManipulator,a))]);H.placeAtGraphic(this.tool.view,this.ringManipulator,a)};c.onScaleChanged=function(){this.events.emit("scale-changed");this.updateManipulatorTransform()};c.updateDelayedFocusedState=function(){this.ringManipulator.updateStateEnabled(g.DelayedFocused,this.getFocused())};c.updateDragState=function(){this.ringManipulator.updateStateEnabled(g.Unlocked,
!(v.isSome(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode));if(v.isSome(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case "rotate":this.ringManipulator.updateStateEnabled(g.ScaleIn|g.ScaleOut,!1);this.ringManipulator.updateStateEnabled(g.RotateLeft,0>this._scaleRotateDragData.angleDir);this.ringManipulator.updateStateEnabled(g.RotateRight,0<=this._scaleRotateDragData.angleDir);break;case "scale":this.ringManipulator.updateStateEnabled(g.RotateLeft|g.RotateRight,
!1),this.ringManipulator.updateStateEnabled(g.ScaleIn,0>this._scaleRotateDragData.scaleDir),this.ringManipulator.updateStateEnabled(g.ScaleOut,0<=this._scaleRotateDragData.scaleDir)}else this.ringManipulator.updateStateEnabled(g.ScaleIn|g.ScaleOut|g.RotateLeft|g.RotateRight,!1)};c.updateManipulatorTransform=function(){const a=z.identity(r.sm4d.get());z.rotate(a,a,this.tool.symbolRotationAngle,C.fromValues(0,0,1));var b=this.getScale();b=z.fromScaling(r.sm4d.get(),w.set(r.sv3d.get(),b,b,b));const f=
z.identity(r.sm4d.get());z.multiply(f,b,a);this.ringManipulator.modelTransform=f};c.createRingManipulator=function(){var a=(D,A,P)=>{const Q=[],R=Math.ceil(d.GEOMETRY_SEGMENTS*(A-D)/(2*Math.PI));for(let I=0;I<R+1;I++){const S=D+I*(A-D)/R;Q.push(C.fromValues(P*Math.cos(S),P*Math.sin(S),0))}return Q},b=(D,A)=>new M(G.createPathExtrusionGeometry([[-A/2,0],[A/2,0],[A/2,d.RING_HEIGHT/2],[-A/2,d.RING_HEIGHT/2]],D,[],[],!1),"graphic-transform-ring"),f=a(0,2*Math.PI,d.RING_RADIUS),n=b(f,d.RING_THICKNESS),
p=[],t=[];const h=[];for(var m=0;2>m;m++){var k=m*Math.PI-Math.PI/4,l=Math.PI/2-d.ROTATE_INDICATOR_ARC_LENGTH,u=k+l;k=k+Math.PI/2-l;l=a(u,k,d.INNER_INDICATOR_RADIUS);var x=b(l,d.INDICATOR_THICKNESS);h.push(l);h.push(a(u,k,d.OUTER_INDICATOR_RADIUS-d.RING_THICKNESS/2));p.push(x);t.push(x);for(x=0;2>x;x++){var E=0===x,q=aa.create();if(E){z.scale(q,q,[1,-1,1]);z.rotate(q,q,-u,[0,0,1]);var y=Math.round(d.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(l.length-1));q[12]=l[y][0];q[13]=l[y][1];q[14]=l[y][2]}else z.rotate(q,
q,k,[0,0,1]),y=Math.round((1-d.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(l.length-1)),q[12]=l[y][0],q[13]=l[y][1],q[14]=l[y][2];y=G.createExtrudedTriangle(d.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,d.ROTATE_INDICATOR_ARROW_TIP_RADIUS,d.RING_HEIGHT);G.transformInPlace(y,q);q=new M(y,"graphic-transform-ring-rotate");(E?p:t).push(q)}}m=[];for(u=0;2>u;u++)k=u*Math.PI-Math.PI/4,l=Math.PI/2-d.SCALE_INDICATOR_ARC_LENGTH,k=a(k+l,k+Math.PI/2-l,d.OUTER_INDICATOR_RADIUS),m.push(b(k,d.INDICATOR_THICKNESS));u=
a(0,2*Math.PI,d.RING_RADIUS+d.SCALE_INDICATOR_OFFSET1);k=a(0,2*Math.PI,d.RING_RADIUS+d.SCALE_INDICATOR_OFFSET2);u=b(u,d.INDICATOR_THICKNESS);k=b(k,d.INDICATOR_THICKNESS);l=a(0,2*Math.PI,d.RING_RADIUS-d.SCALE_INDICATOR_OFFSET1);x=a(0,2*Math.PI,d.RING_RADIUS-d.SCALE_INDICATOR_OFFSET2);a=b(l,d.INDICATOR_THICKNESS);b=b(x,d.INDICATOR_THICKNESS);l=this.createMaterial();x=this.createMaterial(.66);q=this.createMaterial(.5);E=this.createMaterial(.33);n=[{geometry:n,material:l,stateMask:g.DelayedFocused},{geometry:n,
material:q,stateMask:0}];this.mode&&"scale"!==this.mode||(n=n.concat([{geometry:m,material:l,stateMask:g.DelayedFocused|g.Unlocked},{geometry:u,material:x,stateMask:g.DelayedFocused|g.ScaleIn},{geometry:k,material:E,stateMask:g.DelayedFocused|g.ScaleIn},{geometry:a,material:x,stateMask:g.DelayedFocused|g.ScaleOut},{geometry:b,material:E,stateMask:g.DelayedFocused|g.ScaleOut}]));this.mode&&"rotate"!==this.mode||(n=n.concat([{geometry:t,material:l,stateMask:g.DelayedFocused|g.Unlocked},{geometry:p,
material:l,stateMask:g.DelayedFocused|g.RotateLeft},{geometry:t,material:l,stateMask:g.DelayedFocused|g.RotateRight}]));f=[f,...h];return new ea.Manipulator3D({view:this.tool.view,renderObjects:n,autoScaleRenderObjects:!1,worldOriented:!0,radius:d.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:ba.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:f,direction:C.fromValues(0,0,1)}})};c.createMaterial=function(a=1){const b=[...d.HANDLE_COLOR,
a];return new ca.ColorMaterial({color:b,transparent:1!==a,cullFace:2,renderOccluded:2},"graphic-transform")};c.applySymbolData=function(a,b,f,n){a.symbolLayers.forEach((p,t)=>{const {heading:h,size:m}=b.symbolLayers[t];"object"===p.type&&(p.heading=(v.isSome(h)?h:0)-W.toDegree(f),v.isSome(m)&&"width"in m&&(m.width=this.enforceNonZeroSize(m.width),m.height=this.enforceNonZeroSize(m.height),m.depth=this.enforceNonZeroSize(m.depth),p.width=m.width*n,p.depth=m.depth*n,p.height=m.height*n))})};c.enforceNonZeroSize=
function(a){return a||this.tool.view.state.camera.computeRenderPixelSizeAt(this.ringManipulator.renderLocation)};T._createClass(e,[{key:"test",get:function(){return{ringManipulator:this.ringManipulator}}}]);return e}();const ja=C.create(),ka=L.createScreenPointArray();J.GraphicScaleRotateTransform=ma;Object.defineProperty(J,"__esModule",{value:!0})});