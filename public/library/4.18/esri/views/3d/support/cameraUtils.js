// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../core/maybe ../../../core/Logger ../../../core/promiseUtils ../../../geometry/SpatialReference ../../../geometry/Point ../../../core/mathUtils ../../../chunks/vec3f64 ../../../chunks/vec3 ./mathUtils ../../../Camera ../../../geometry/projectionEllipsoid ../../../geometry/projection ../../support/spatialReferenceSupport ../../../geometry/support/scaleUtils ./ElevationProvider ./earthUtils ../camera/intersectionUtils ../../../chunks/cameraUtilsPlanar ../../../chunks/cameraUtilsSpherical".split(" "),
function(m,u,V,W,A,v,D,q,w,L,H,X,p,Y,Z,M,aa,ba,N,O){function x(a){return"global"===a.viewingMode?O.cameraUtilsSpherical:N.cameraUtilsPlanar}function P(a,b,c){var d=a.state.camera;const e=d.fovX;d=d.width/2/d.pixelRatio;"global"===a.viewingMode&&null!=c&&(b*=Math.cos(D.deg2rad(c)));b/=a.renderCoordsHelper.unitInMeters;return d/(96*39.37/b)/Math.tan(e/2)}function Q(a,b,c){const d=a.state.camera;b=96*39.37/(d.width/2/d.pixelRatio/(b*Math.tan(d.fovX/2)));"global"===a.viewingMode&&(b/=Math.cos(D.deg2rad(c)));
return b*=a.renderCoordsHelper.unitInMeters}function R(a,b,c,d,e,f){if(B(f)){const k=new I(f.signal);E(a,d.heading,d.tilt,b,c,e,k);k.resolver.promise.then(g=>{g=F(a,g,d.fov);if(u.isNone(g))f.resolver.reject();else return f.resolver.resolve(g)},g=>f.resolver.reject(g))}else return b=E(a,d.heading,d.tilt,b,c,e),F(a,b,d.fov,f)}function S(a,b,c,d,e){return x(a).directionToHeadingTilt(b,c,d,e)}function ca(a,b){return!!(a.basemapTerrain&&a.renderCoordsHelper.fromRenderCoords(b,y,a.spatialReference)&&M.getElevationAtPoint(a.elevationProvider,
y)>y.z-1)}async function da(a,b,c){return a.renderCoordsHelper.fromRenderCoords(b,y,a.spatialReference)?await a.elevationProvider.queryElevation(y.x,y.y,y.z,y.spatialReference,"ground",c)>y.z-1:!1}async function ea(a,b,c){const d=q.create();b?b instanceof v?(p.projectPointToVector(b,d,a.renderSpatialReference),null==b.z&&null!=a.basemapTerrain&&(b=await a.elevationProvider.queryElevation(b.x,b.y,b.z,b.spatialReference,"ground",c),null!=b&&a.renderCoordsHelper.setAltitude(b,d))):w.copy(d,b):w.copy(d,
a.state.camera.center);return d}function fa(a,b){const c=q.create();b&&b instanceof v?(p.projectPointToVector(b,c,a.renderSpatialReference),null==b.z&&null!=a.basemapTerrain&&(b=M.getElevationAtPoint(a.elevationProvider,b),null!=b&&a.renderCoordsHelper.setAltitude(b,c))):b?w.copy(c,b):w.copy(c,a.state.camera.center);return c}function E(a,b,c,d,e,f,k){const g=d&&d instanceof v?d:null;if(B(k))return ea(a,d,k.signal).then(h=>{J(a,b,c,g,h,e,f,k)},h=>k.resolver.reject(h)),null;d=fa(a,d);return J(a,b,c,
g,d,e,f,k)}function J(a,b,c,d,e,f,k,g){if(!d&&(d=p.projectVectorToPoint(e,a.renderSpatialReference,a.spatialReference||A.WGS84),!d))return null;f=Math.max(f,a.state.constraints.minimumPoiDistance);var h=ha(a,b,c,e,f,k);const z=x(a).eyeForCenterWithHeadingTilt,l=z(e,f,h.heading,h.tilt);if(1===k&&"global"===a.viewingMode&&0<c){const r=()=>{var n=f,t=f;var K=a.state.constraints.tilt(t);t=x(a).eyeTiltToLookAtTilt(c,e,t);t=Math.min(t,.5*Math.PI);K=K.min*(1-.7)+.7*t;n=x(a).lookAtTiltToEyeTilt(K,e,n);k=
1>c-n?0:1;return J(a,b,n,d,e,f,k,g)};h=a.map.ground.navigationConstraint;if(!h||"stay-above"===h.type){if(ca(a,l.eye))return r();if(B(g))return da(a,l.eye,g.signal).then(n=>{if(n)return r();g.resolver.resolve({eye:l.eye,up:l.up,center:q.clone(e),heading:l.heading,tilt:l.tilt});return null}),null}}h=!g||B(g)?{center:q.create(),eye:q.create(),up:q.create(),tilt:0,heading:0}:g;h.eye=l.eye;h.up=l.up;h.center=q.clone(e);h.heading=l.heading;h.tilt=l.tilt;B(g)&&g.resolver.resolve(h);return h}function ha(a,
b,c,d,e,f){var k=0;if(f=1===f)if(k=a.pointsOfInterest.centerOnSurfaceFrequent.distance,8<Math.log(e/k)/Math.LN2)f=!0;else{var g=a.renderSpatialReference,h=a.spatialReference||A.WGS84;f=p.projectVectorToPoint(d,g,h);g=p.projectVectorToPoint(a.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,g,h);u.isNone(f)||u.isNone(g)?f=!1:(k*=Math.tan(.5*a.state.camera.fov),f=5<g.distance(f)/k)}f?(b=0,f=a.state.constraints.tilt(e),f.max=Math.min(f.max,.5*Math.PI),f=f.min*(1-.7)+.7*f.max,c=x(a).eyeTiltToLookAtTilt(c,
d,e),k=Math.min(c,f)):k=x(a).eyeTiltToLookAtTilt(c,d,e);c=k=a.state.constraints.clampTilt(e,k);c=x(a).lookAtTiltToEyeTilt(c,d,e);return{heading:b,tilt:c}}function F(a,b,c,d){if(u.isNone(b))return null;a=p.projectVectorToPoint(b.eye,a.renderSpatialReference,a.spatialReference||A.WGS84);return u.isNone(a)?null:u.isSome(d)?(d.position=a,d.heading=b.heading,d.tilt=b.tilt,d.fov=c,d):new H(a,b.heading,b.tilt,c)}function B(a){return a&&"resolver"in a}const T=V.getLogger("esri.views.3d.support.cameraUtils"),
U=q.create(),G=q.create(),ia=q.create(),ja={heading:0,tilt:0},y=new v,ka=new L.Cyclical(-2.0037508342788905E7,2.0037508342788905E7),la=new L.Cyclical(-180,180),C=q.create();let I=function(a){this.signal=a;this.resolver=W.createResolver()};m.AsyncContext=I;m.computeScale=function(a,b,c){const d=a.renderSpatialReference;b||(b=a.state.camera);var e=A.WGS84;b instanceof H?(e=b.position.latitude,p.projectPointToVector(b.position,U,d),p.projectPointToVector(c,G,d),b=w.distance(U,G)):(p.projectVectorToVector(b.center,
d,G,e),e=G[1],b=b.distance);return Q(a,b,e)};m.directionToHeadingTilt=S;m.distanceToScale=Q;m.externalToInternal=function(a,b){var c=a.renderSpatialReference;const d=x(a).headingTiltToDirectionUp,e=q.create();if(!p.projectPointToVector(b.position,e,c))return null;c=d(e,b.heading,b.tilt);w.scale(c.direction,c.direction,a.state.camera.distance);w.add(c.direction,c.direction,e);a=ba.cameraOnContentAlongViewDirection(a,e,c.direction,c.up);a.fov=D.deg2rad(b.fov);return a};m.fromCenterDistance=R;m.fromCenterScale=
function(a,b,c,d,e,f){c=P(a,c,b.latitude);return R(a,b,c,d,e,f)};m.fromExtent=function(a,b,c,d,e,f=null){let k;var g=0;null!=b.zmax&&null!=b.zmin&&(k=(b.zmax+b.zmin)/2,g=b.zmax-b.zmin);if("global"===a.viewingMode){if(!Y.isSpatialReferenceSupported(b.spatialReference,"global"))return B(f)&&f.resolver.reject(),null;var h=new v(b.xmin,b.ymin,b.spatialReference);const n=new v(b.xmax,b.ymax,b.spatialReference),t=b.spatialReference.isGeographic?la:ka;var z=new v(t.center(h.x,n.x),(n.y+h.y)/2,b.spatialReference);
null!=k&&(z.z=k);b=X.getReferenceEllipsoid(b.spatialReference);var l=aa.getGreatCircleSpanAt(z,h,n);var r=l.lon;l=l.lat;t.diff(h.x,n.x)>t.range/2&&(r+=b.halfCircumference);r=Math.min(r,b.halfCircumference);l=Math.min(l,b.halfCircumference)}else z=a.spatialReference||A.WGS84,r=b.xmax-b.xmin,l=b.ymax-b.ymin,z=new v({x:b.xmin+.5*r,y:b.ymin+.5*l,z:k,spatialReference:z});h=a.state.camera;g=Math.max(1/Math.tan(h.fovX/2)*r*.5,1/Math.tan(h.fovY/2)*l*.5,1/Math.tan(h.fov/2)*g*.5)/1;if(B(f))r=new I(f.signal),
E(a,c,d,z,g,e,r),r.resolver.promise.then(n=>{n=F(a,n,a.camera.fov);if(u.isNone(n))f.resolver.reject();else return f.resolver.resolve(n)},n=>f.resolver.reject(n));else return c=E(a,c,d,z,g,e),F(a,c,a.camera.fov,f)};m.getObserverForPointAtDistance=E;m.headingTiltToDirectionUp=function(a,b,c,d,e){return x(a).headingTiltToDirectionUp(b,c,d,e)};m.internalToExternal=function(a,b,c){const d=a.renderSpatialReference;var e=w.copy(ia,b.viewForward);e=S(a,b.eye,e,b.up,ja);a=a.spatialReference||A.WGS84;p.projectVectorToVector(b.eye,
d,C,a)||(a=A.WGS84,p.projectVectorToVector(b.eye,d,C,a));if(u.isNone(c))return new H(new v(C,a),e.heading,e.tilt,D.rad2deg(b.fov));c.position.x=C[0];c.position.y=C[1];c.position.z=C[2];c.position.spatialReference=a;c.heading=e.heading;c.tilt=e.tilt;c.fov=D.rad2deg(b.fov);return c};m.observerToCamera=F;m.scaleToDistance=P;m.scaleToResolution=function(a,b){return a.spatialReference?Z.getResolutionForScale(b,a.spatialReference):void 0};m.scaleToZoom=function(a,b){if(a=a.basemapTerrain&&a.basemapTerrain.tilingScheme)return a.levelAtScale(b);
T.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")};m.toExtent=function(a,b,c){var d=a.renderSpatialReference;const e=w.dist(b.eye,c);c=p.projectVectorToPoint(c,d,a.spatialReference||A.WGS84);if(u.isNone(c))return null;d=2*e*Math.tan(b.fovX/2);b=2*e*Math.tan(b.fovY/2);return"global"===a.viewingMode?O.toExtent(a,c,d,b):N.toExtent(a,c,d,b)};m.zoomToScale=function(a,b){if(a=a.basemapTerrain&&a.basemapTerrain.tilingScheme)return a.scaleAtLevel(b);T.error("#zoomToScale()",
"Cannot compute scale from zoom without a tiling scheme")};Object.defineProperty(m,"__esModule",{value:!0})});