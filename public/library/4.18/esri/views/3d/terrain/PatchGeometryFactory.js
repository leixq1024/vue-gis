// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../core/maybe ../../../core/mathUtils ../../../chunks/vec3f64 ../../../chunks/vec3 ../../../chunks/vec4f64 ../../../chunks/vec4 ../../../geometry/support/aaBoundingBox ./TerrainConst ../support/buffer/InterleavedLayout ../webgl-engine/lib/Util ../webgl-engine/materials/internal/MaterialUtil ./ElevationData ../support/buffer/BufferPool".split(" "),function(N,ia,ja,W,R,ka,X,S,L,la,Y,ma,Z,na){function aa(a,c,h,g){const G=0<(h&2),H=c+(g?1024:0)+(G?2048:0);var m=T.get(H);if(!m){{m=
c-1;const y=c-1,J=c*c;var b=2*m+2*y;let C=m*y*6,E=6*b,t=6*(2*m+y-1);g&&(C*=2,E*=2,t*=2);b=65536<J+b?new Uint32Array(C+E):new Uint16Array(C+E);let v=0,d=0,e=C,k,n;let A=0;for(let l=0;l<=y;l++){G&&(A=0===l?t:l===y?-t:0);e+=A;for(let q=0;q<=m;q++){var f=U(q,l,m,y);if(-1<f){var p=0===l&&q!==m?1:q===m&&l!==y?m+1:l===y&&0!==q?-1:0===q&&0!==l?-(m+1):0;0!==p&&(k=v,n=J+f,f=J+(0===q&&1===l?0:f+1),p=v+p,g?(b[e+0]=k,b[e+1]=n,b[e+2]=n,b[e+3]=f,b[e+4]=f,b[e+5]=k,b[e+6]=f,b[e+7]=p,b[e+8]=p,b[e+9]=k,b[e+10]=k,b[e+
11]=f,e+=12):(b[e+0]=k,b[e+1]=n,b[e+2]=f,b[e+3]=f,b[e+4]=p,b[e+5]=k,e+=6))}++v;q<m&&l<y&&(k=l*(m+1)+q,n=k+1,f=n+(m+1),p=f-1,g?(b[d+0]=k,b[d+1]=n,b[d+2]=n,b[d+3]=f,b[d+4]=f,b[d+5]=k,b[d+6]=f,b[d+7]=p,b[d+8]=p,b[d+9]=k,b[d+10]=k,b[d+11]=f,d+=12):(b[d+0]=k,b[d+1]=n,b[d+2]=f,b[d+3]=f,b[d+4]=p,b[d+5]=k,d+=6))}e-=A}m=new oa(b,C,E)}T.set(H,m)}a.indices=m.values;a.numSurfaceIndices=m.numSurfaceIndices;a.numSkirtIndices=m.numSkirtIndices;a.numWithoutSkirtIndices=a.numSurfaceIndices+(h?6*(c-1)*(g?2:1):0)}function V(a,
c,h,g){a<g[0]&&(g[0]=a);a>g[3]&&(g[3]=a);c<g[1]&&(g[1]=c);c>g[4]&&(g[4]=c);h<g[2]&&(g[2]=h);h>g[5]&&(g[5]=h)}function ba(a,c){const h=c>a?1:0;return 2+4*h+(1-2*h)*(a+c)}function U(a,c,h,g){return 0===c?a:a===h?h+c:c===g?h+g+(h-a):0===a&&0<c?2*h+g+(g-c):-1}const pa=la.newLayout().vec3f(Y.VertexAttrConstants.POSITION).vec2f(Y.VertexAttrConstants.UV0),Q=new na.BufferPool(a=>pa.createBuffer(a),a=>a.count);let oa=function(a,c,h){this.values=a;this.numSurfaceIndices=c;this.numSkirtIndices=h};const T=new Map,
ca=2**-52,da=Array(L.MAX_PATCH_TESSELATION+1),ea=Array(L.MAX_PATCH_TESSELATION+1),fa=Array(L.MAX_PATCH_TESSELATION+1),ha=Array(L.MAX_PATCH_TESSELATION+1),I=W.create(),qa=W.create();N.PatchGeometry=function(){this.vertexAttributes=this.indices=null;this.boundingBox=S.empty();this.skirtLength=this.numVertsPerRow=this.numWithoutSkirtIndices=this.numSkirtIndices=this.numSurfaceIndices=0;this.uvOffsetAndScale=ka.create()};N.clearCaches=function(){Q.clear();T.clear()};N.createPlanarGlobePatch=function(a,
c,h,g){const G=c[0],H=c[1],m=c[2]-G,b=c[3]-H,f=a.clippingArea,p=f?Math.max(0,(f[0]-c[0])/m):0,y=f?Math.max(0,(f[1]-c[1])/b):0,J=f?Math.min(1,(f[2]-c[0])/m):1;c=f?Math.min(1,(f[3]-c[1])/b):1;const C=J>p?1/(J-p):1,E=c>y?1/(c-y):1,t=-p*C,v=-y*E,d=.1*m,e=a.numVertsPerRow-1,k=a.numVertsPerRow-1,n=a.numVertsPerRow*a.numVertsPerRow,A=Q.acquire(n+(2*e+2*k)),l=A.position.typedBuffer,q=A.uv0.typedBuffer,u=g.geometryInfo.boundingBox;S.empty(u);let z=0;for(let B=0;B<=k;B++){var w=B/k;let D=v+w*E;w=H+w*b;f&&(w<
f[1]?(w=f[1],D=0):w>f[3]&&(w=f[3],D=1));for(let M=0;M<=e;M++){var x=M/e;let K=t+x*C;x=G+x*m;f&&(x<f[0]?(x=f[0],K=0):x>f[2]&&(x=f[2],K=1));var F=a.samplerData?Z.ElevationData.sample(x,w,a.samplerData)||0:0;x-=h[0];const O=w-h[1];F-=h[2];V(x,O,F,u);var r=L.GEOMETRY_VERTEX_STRIDE*z;l[r+0]=x;l[r+1]=O;l[r+2]=F;q[r+0]=K;q[r+1]=D;r=U(M,B,e,e);-1<r&&(r=L.GEOMETRY_VERTEX_STRIDE*(n+r),l[r+0]=x,l[r+1]=O,l[r+2]=F,q[r+0]=ba(K,D),q[r+1]=d);++z}}g.geometryInfo.numVertsPerRow=a.numVertsPerRow;g.geometryInfo.vertexAttributes=
A;g.geometryInfo.skirtLength=d;X.set(g.geometryInfo.uvOffsetAndScale,p,y,J-p,c-y);aa(g.geometryInfo,a.numVertsPerRow,0,a.wireframe)};N.createSphericalGlobePatch=function(a,c,h,g,G,H,m,b){var f=G[0];const p=G[1];var y=G[2];G=G[3];const J=.1*m.radius*(G-p),C=a.numVertsPerRow-1,E=a.numVertsPerRow-1,t=a.numVertsPerRow*a.numVertsPerRow,v=Q.acquire(t+(2*C+2*E)),d=v.position.typedBuffer,e=v.uv0.typedBuffer,k=g.geometryInfo.boundingBox;S.empty(k);var n=c[2]-c[0];const A=c[3]-c[1];var l=y-f;y=h[0];const q=
h[1];h=h[2];for(var u=0;u<=C;u++){var z=u/C,w=f+z*l;da[u]=Math.sin(w);ea[u]=Math.cos(w);fa[u]=z;ha[u]=c[0]+z*n}f=H&&!!(b&1);n=H&&!!(b&2);l=0;for(u=0;u<=E;u++){z=u/E;var x=ja.lerp(p,G,z);w=Math.cos(x);const M=Math.sin(x);H?(x=m.halfSemiMajorAxis*Math.log((1+M)/(1-M)),z=(x-c[1])/A):x=180*x/Math.PI;for(let K=0;K<=C;K++){const O=fa[K];var F=da[K],r=ea[K],B=m.radius;a.samplerData&&(B+=Z.ElevationData.sample(ha[K],x,a.samplerData)||0);r=r*w*B-y;F=F*w*B-q;B=M*B-h;V(r,F,B,k);var D=L.GEOMETRY_VERTEX_STRIDE*
l;d[D+0]=r;d[D+1]=F;d[D+2]=B;e[D+0]=O;e[D+1]=z;D=U(K,u,C,E);if(-1<D){D=L.GEOMETRY_VERTEX_STRIDE*(t+D);const P=f&&0===u?-1:n&&u===E?1:0;r=0===P?r:-y;F=0===P?F:-q;B=0===P?B:m.radius*P-h;d[D+0]=r;d[D+1]=F;d[D+2]=B;e[D+0]=0===P?ba(O,z):O;e[D+1]=0===P?J:z;0!==P&&V(r,F,B,k)}++l}}g.geometryInfo.numVertsPerRow=a.numVertsPerRow;g.geometryInfo.vertexAttributes=v;g.geometryInfo.skirtLength=J;X.set(g.geometryInfo.uvOffsetAndScale,0,0,1,1);aa(g.geometryInfo,a.numVertsPerRow,H?b:0,a.wireframe)};N.intersectSkirts=
function(a,c,h,g,G,H,m,b,f){const p=H.position;H=H.uv0;const y=a[0],J=a[1];a=a[2];const C=c[0]-y,E=c[1]-J;c=c[2]-a;h*=3;for(g*=3;h<g;h+=3){var t=G[h],v=G[h+1],d=G[h+2],e=p.get(t,0),k=p.get(t,1),n=p.get(t,2),A=p.get(v,0),l=p.get(v,1),q=p.get(v,2),u=p.get(d,0),z=p.get(d,1),w=p.get(d,2);t=H.get(t,0);v=H.get(v,0);d=H.get(d,0);2<=t&&(R.set(I,e,k,n),m(I),e+=I[0],k+=I[1],n+=I[2]);2<=v&&(R.set(I,A,l,q),m(I),A+=I[0],l+=I[1],q+=I[2]);2<=d&&(R.set(I,u,z,w),m(I),u+=I[0],z+=I[1],w+=I[2]);ia.isSome(b)&&([e,k,n]=
b.applyToVertex(e,k,n),[A,l,q]=b.applyToVertex(A,l,q),[u,z,w]=b.applyToVertex(u,z,w));A-=e;l-=k;q-=n;u-=e;z-=k;w-=n;t=E*w-z*c;v=c*u-w*C;const x=C*z-u*E;d=A*t+l*v+q*x;const F=y-e,r=J-k,B=a-n;n=r*q-l*B;k=B*A-q*F;e=F*l-A*r;if(d>ca){t=F*t+r*v+B*x;if(0>t||t>d)continue;v=C*n+E*k+c*e;if(0>v||t+v>d)continue}else if(d<-ca){t=F*t+r*v+B*x;if(0<t||t<d)continue;v=C*n+E*k+c*e;if(0<v||t+v<d)continue}else continue;n=(u*n+z*k+w*e)/d;0<=n&&(A=ma.computeNormal(A,l,q,u,z,w,qa),f(n,A))}};N.releaseGeometry=function(a){Q.release(a.vertexAttributes);
a.vertexAttributes=null;a.indices=null};Object.defineProperty(N,"__esModule",{value:!0})});