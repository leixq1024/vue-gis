// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/ObjectPool ../../../core/arrayUtils ../../../core/promiseUtils ../../../core/mathUtils ../../../chunks/vec3f64 ../../../chunks/vec3 ../../../geometry/projectionEllipsoid ../../../geometry/support/aaBoundingRect ../../../chunks/vec2f64 ../../../chunks/vec4f64 ../../../chunks/vec2 ../../../chunks/vec4 ./TerrainConst ../../webgl/Util ../support/StreamDataLoader ../../2d/engine/vectorTiles/VectorTile ./RasterTile ./TileTexture ./terrainUtils ./ElevationBounds ./tileUtils ./TileAgent ./ElevationTileAgent ./MapTileAgent ./TilePerLayerInfo".split(" "),
function(x,T,J,U,V,W,q,g,X,z,Y,A,B,Z,C,D,K,L,M,N,E,O,r,n,P,Q,R){function y(p){p.dispose();p instanceof P?F.release(p):p instanceof Q&&G.release(p)}const H=E.weakAssert,I=q.create(),u=q.create(),m=q.create(),t=A.create();A=function(){function p(a){this._numSubdivisionAtLevel=a;this.lij=[0,0,0];this._children=[null,null,null,null];this._dirty=!0;this._previouslyRendered=!1;this.extent=z.create();this._elevationBounds=Y.create();this.layerInfo=Array(2);this.extentInRadians=z.create();this.centerAtSeaLevel=
q.create();this._center=[q.create(),q.create(),q.create()];this.up=q.unitZ();this._intersectsClippingArea=this._isWithinClippingArea=!0;this._clippingArea=null;this._maxTesselation=0;this._usedMemory=-1;this._curvatureHeight=this._radius=this._edgeLen2=this._edgeLen=this.renderOrder=this._screenDepth=this._mapDataRefCount=this._mapTileMemory=0}var e=p.prototype;e.init=function(a,b,c){this.lij[0]=a[0];this.lij[1]=a[1];this.lij[2]=a[2];this.ellipsoid=X.getReferenceEllipsoid(c.tilingScheme.spatialReference);
c.tilingScheme.getExtent(a[0],a[1],a[2],this.extent);c.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians);this._intersectsClippingArea=this._isWithinClippingArea=!0;this._clippingArea=null;this._mapDataRefCount=0;c.upsampleMapCache.pop(r.tile2str(this));this._radius=this._edgeLen2=this._edgeLen=0;this.vlevel=a?a[0]:0;b&&b._elevationBounds?B.copy(this._elevationBounds,b.elevationBounds):B.set(this._elevationBounds,0,0);this._pendingUpdates=0;this.renderData=null;this._screenDepth=
0;this._previouslyRendered=this._visible=!1;this._parent=b;this.unsetChildren();this._surface=c;this.updateVisibility();for(a=0;2>a;a++){b=c.numLayers(a);let f=this.layerInfo[a];this.layerInfo[a]?f.length=b:(f=Array(b),this.layerInfo[a]=f);for(let d=0;d<b;d++)f[d]=R.TilePerLayerInfo.makeEmptyLayerInfo(a,this._surface.upsampleInfoPool,f[d]),0===a&&this.findElevationBoundsForLayer(d,-1)}this.computeElevationBounds();this._maxTesselation=Math.min(c.tilingScheme.pixelSize,C.MAX_PATCH_TESSELATION)};e.release=
function(){H(!this.renderData,"tile.renderData was not unloaded");this._surface.upsampleMapCache.pop(r.tile2str(this));for(let a=0;2>a;a++)for(const b of this.layerInfo[a])b.dispose();this._surface=this._parent=null;this._usedMemory=-1};e.refMapData=function(){++this._mapDataRefCount;this.isCached||this._surface.upsampleMapCache.pop(r.tile2str(this))};e.unrefMapData=function(){--this._mapDataRefCount;if(this.isCached){const a=this.cachedMemory;0<a&&(this._surface.upsampleMapCache.put(r.tile2str(this),
this,a),this.setMemoryDirty())}};e.setMemoryDirty=function(){this._usedMemory=-1};e._updateMemoryUsed=function(){this._mapTileMemory=this._usedMemory=0;var a=this.cpuImageMemorySize;for(const b of this.layerInfo[1]){const c=b.data;c instanceof N?this._mapTileMemory+=D.getGpuMemoryUsage(c.texture):c instanceof HTMLImageElement||c instanceof K.ImageWithType?this._mapTileMemory+=a:c instanceof M&&(this._mapTileMemory+=c.getMemoryUsage())}for(const b of this.layerInfo[0])this._usedMemory+=b.data?a:0;
this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,a=this.renderData.textureDescriptor)&&(this._mapTileMemory+=D.getGpuMemoryUsage(a));this.isCached&&this._surface.upsampleMapCache.updateSize(r.tile2str(this),this,this.cachedMemory)};e.getUsedMemoryForLayer=function(a,b){b=this.layerInfo[a][b];if(!b||!b.data)return 0;if(1===a&&!this.isCached){a=b.data;if(a instanceof N)return D.getGpuMemoryUsage(a.texture);if(a instanceof HTMLImageElement||a instanceof K.ImageWithType)return this.cpuImageMemorySize;
if(a instanceof L.VectorTile||a instanceof M)return a.getMemoryUsage()}else if(0===a)return this.cpuImageMemorySize;return 0};e.updateScreenDepth=function(a){g.copy(t,this._center[0]);t[3]=1;Z.transformMat4(t,t,a);this._screenDepth=0>t[2]?0:t[2]/t[3]};e.shouldSplit=function(a,b,c){const f=this.level;g.subtract(I,this._center[0],b);var d=g.squaredLength(I);let l=0;g.subtract(u,this._center[1],b);var h=g.squaredLength(u);h<d&&(d=h,l=1);g.subtract(u,this._center[2],b);h=g.squaredLength(u);h<d&&(d=h,
l=2);if(this._edgeLen2>d&&f<a.maxLod)return 2;d=Math.sqrt(d);const k=this._edgeLen/(a.fovX*d*2);h=()=>{const S=f+Math.ceil(-W.log2(a.relativeWidthLimit/k));return S!==this.vlevel?(this.vlevel=S,4):1};if(1===c&&1===this._surface.snapLevel-f)return f>=a.maxLod?h():2;const v=g.dot(this.up,I);c=this._elevationBounds[1]-this._elevationBounds[0];const w=c/this.edgeLen;return a.aboveGround&&0<v&&.001>w&&0<v/d-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-w?0:k<a.relativeWidthLimit?
this.vlevel!==this.level?(this.vlevel=this.level,4):0:f>=a.maxLod?h():6<f&&(g.subtract(u,this._center[l],b),g.scale(m,this.up,v),g.subtract(m,m,u),h=g.squaredLength(m),h>this._radius*this._radius&&(g.scale(m,m,this._radius/Math.sqrt(h)),g.add(m,m,this._center[l]),g.subtract(m,b,m),Math.min(1,(Math.abs(g.dot(m,this.up))+.5*c+this._curvatureHeight)/g.length(m))*(this._edgeLen/(a.fovY*d*2))<.1/a.angledSplitBias*a.relativeHeightLimit))?0:2};e.setChildren=function(a,b,c,f){H(!!(a&&b&&c&&f),"Null child passed");
this._children[0]=a;this._children[1]=b;this._children[2]=c;this._children[3]=f};e.unsetChildren=function(){this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null};e.load=function(a){this.refMapData();for(let b=0;2>b;b++)this.layerInfo[b]&&this._createOrUpdateAgents(0,b);a.loadTile(this)};e.unload=function(a){a.unloadTile(this);for(a=0;2>a;a++){const b=this.layerInfo[a];for(const c of b)c.loadingAgent&&c.loadingAgent!==n.TILE_AGENT_DONE&&(y(c.loadingAgent),c.loadingAgent=
null),c.pendingUpdates=0}this.resetPendingUpdate(32);this.resetPendingUpdate(64);this.unrefMapData()};e.unloadMapData=function(){const a=this.layerInfo[1];for(const b of a)b.loadingAgent&&b.loadingAgent!==n.TILE_AGENT_DONE&&(y(b.loadingAgent),b.loadingAgent=null),b.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture();this.setMemoryDirty()};e.updateClippingStatus=function(a){if(z.equals(a,this._clippingArea))return!1;var b=this._intersectsClippingArea;const c=this._isWithinClippingArea;
a?(this._intersectsClippingArea=this.intersectsExtent(a),this._isWithinClippingArea=this.isWithinExtent(a)):this._isWithinClippingArea=this._intersectsClippingArea=!0;this._clippingArea=a;this.updateVisibility();a=c&&this._isWithinClippingArea;b=!c&&!b&&!this._isWithinClippingArea&&!this._intersectsClippingArea;!this.renderData||a||b||this.setPendingUpdate(32);return!0};e.updateVisibility=function(){this._dirty=!0;this._surface.setTileTreeDirty()};e.getLayerInfo=function(a,b){return this.layerInfo[b][a]};
e.hasLayerData=function(a,b){a=this.layerInfo[b][a];return!(!a||!a.data||a.dataInvalidated)};e.isSuspended=function(a){return this.hasPendingUpdate(2)?!0:0===a?!1:!this.visible};e.hasPendingUpdate=function(a){return(this._pendingUpdates&a)===a};e.setPendingUpdate=function(a){this._pendingUpdates|=a;2===a||8===a?this._surface.setTileTreeDirty():this._surface.pendingUpdates=!0};e.resetPendingUpdate=function(a){return this.hasPendingUpdate(a)?(this._pendingUpdates&=~a,!0):!1};e.requestLayerData=function(a,
b,c){const f=this.layerInfo[b][a];if(-1<f.waitingAgents.indexOf(c))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),b,a),!0;f.waitingAgents.push(c);if(f.data&&!f.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),b,a),c.dataArrived(this),!0;if(f.requestPromise)return!0;f.requestAbort=V.createAbortController();
const d=this._surface.requestTileData(this,a,b,f.requestAbort);if(!d)return f.requestAbort=null,!1;a=()=>{f.requestPromise===d&&(f.requestPromise=null,f.requestAbort=null)};f.requestPromise=d;d.then(a,a);return!!f.requestPromise};e.hasLij=function(a){return this.lij[0]===a[0]&&this.lij[1]===a[1]&&this.lij[2]===a[2]};e.findByLij=function(a){return this.hasLij(a)?this:this.isLeaf?null:(a=this._children[0].findByLij(a)||this._children[1].findByLij(a)||this._children[2].findByLij(a)||this._children[3].findByLij(a))?
a:null};e.distanceToSquared=function(a){return g.squaredLength(g.subtract(m,this._center[0],a))};e.containsPoint=function(a){const b=this.extent;return a[0]>=b[0]&&a[1]>=b[1]&&a[0]<=b[2]&&a[1]<=b[3]};e.unrequestLayerData=function(a,b,c){a=this.layerInfo[b][a];b=a.waitingAgents;c=null!=U.removeUnordered(b,c);H(c,"agent has not requested this piece of map data");1>b.length&&(a.abortRequest(),this._updateMemoryUsed())};e.dataArrived=function(a,b,c){a=this.layerInfo[b][a];a.data=c;a.dataInvalidated=!1;
for(c=0;c<a.waitingAgents.length;c++)a.waitingAgents[c].dataArrived(this);a.waitingAgents.length=0;this._updateMemoryUsed()};e.dataMissing=function(a,b,c){c.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${b}/${a} error ${c}`);a=this.layerInfo[b][a];a.dataMissing=!0;for(b=0;b<a.waitingAgents.length;b++)a.waitingAgents[b].dataMissing();a.waitingAgents.length=0;this._updateMemoryUsed()};e.updateRenderData=function(a){switch(a){case 1:return this.updateTexture();case 0:return this.updateGeometry()}};
e.updateTexture=function(){this.renderData&&this.setPendingUpdate(64)};e.updateGeometry=function(){this.setPendingUpdate(32);for(const a of this.layerInfo[0])a.pendingUpdates|=32};e.invalidateLayerData=function(a,b){this.layerInfo[b][a].invalidateSourceData();this.restartAgents(b)};e.computeElevationBounds=function(){B.set(this._elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);const a=this.layerInfo[0];let b=!0;for(const c of a)c.elevationBounds&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],
c.elevationBounds.min),this._elevationBounds[1]=Math.max(this._elevationBounds[1],c.elevationBounds.max),c.elevationBounds.hasNoDataValues||(b=!1));b&&(this._elevationBounds[0]=Math.min(this._elevationBounds[0],0),this._elevationBounds[1]=Math.max(this._elevationBounds[1],0));this.updateRadiusAndCenter();this.surface.setTileTreeDirty()};e._updateCenter=function(){g.scale(m,this.up,.5*(this._elevationBounds[0]+this._elevationBounds[1]));g.add(this._center[0],this.centerAtSeaLevel,m);g.scale(m,this.up,
this._elevationBounds[0]);g.add(this._center[1],this.centerAtSeaLevel,m);g.scale(m,this.up,this._elevationBounds[1]);g.add(this._center[2],this.centerAtSeaLevel,m)};e.findElevationBoundsForLayer=function(a,b){const c=this.layerInfo[0][a];if(!c.elevationBounds||c.elevationBounds.level<b)if(b=this._surface.layerViewByIndex(a,0),b=E.getLayerWithExtentRange(b),r.fallsWithinLayer(this,b,!1)){b=aa;let f=!1;if(c.data)a=c.data,b.min=a.bounds[0],b.max=a.bounds[1],b.hasNoDataValues=a.hasNoDataValues,b.level=
this.lij[0],f=!0;else{let d=0,l,h;for(let k=this._parent;k&&(!h||d<C.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&!(d=this.vlevel-k.level,l=h||l,h=k.layerInfo[0][a].data,!h&&l&&d>=C.ELEVATION_DESIRED_RESOLUTION_LEVEL);k=k._parent);if(h=h||l)h.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],b),Infinity!==b.min&&(b.level=h.level,f=!0)}f&&(c.elevationBounds||(c.elevationBounds=new O.ElevationBounds),c.elevationBounds.copyFrom(b))}};e.modifyLayers=function(a,b,c){const f=this.layerInfo[c];for(var d of f)d.loadingAgent&&
d.loadingAgent!==n.TILE_AGENT_DONE&&(y(d.loadingAgent),d.loadingAgent=null),d.waitingAgents.length=0;if(1===c)for(d=0;d<f.length;++d)void 0===a[d]&&f[d].dispose();a=b.length;d=Array(a);for(let l=0;l<a;l++){const h=b[l];d[l]=-1<h?f[h]:R.TilePerLayerInfo.makeEmptyLayerInfo(c,this._surface.upsampleInfoPool)}this.layerInfo[c]=d;this._updateMemoryUsed()};e.restartAgents=function(a){this.renderData&&(this._createOrUpdateAgents(0,a),this.updateRenderData(a))};e.updateAgents=function(a){if(this.renderData){const b=
this.layerInfo[a];for(let c=0;c<b.length;c++){const f=b[c];f.loadingAgent===n.TILE_AGENT_DONE&&(f.loadingAgent=null)}this._createOrUpdateAgents(0,a)}};e.updateAgentSuspension=function(){for(let a=0;2>a;a++){const b=this.isSuspended(a);for(const c of this.layerInfo[a])c.loadingAgent&&c.loadingAgent!==n.TILE_AGENT_DONE&&(c.loadingAgent.setSuspension(b),c.loadingAgent===n.TILE_AGENT_DONE&&this.updateRenderData(a))}};e.removeLayerAgent=function(a,b){a=this.layerInfo[b][a];a.loadingAgent&&a.loadingAgent!==
n.TILE_AGENT_DONE&&a.loadingAgent.dispose();a.loadingAgent=null};e.agentDone=function(a,b){const c=this.layerInfo[b][a];c.loadingAgent=n.TILE_AGENT_DONE;c.data||c.upsampleInfo||this._createOrUpdateAgents(a+1,b)};e._createOrUpdateAgents=function(a,b){const c=this.isSuspended(b),f=this.layerInfo[b];for(;a<f.length;++a){const k=f[a];var d=!1;const v=this._surface.layerViewByIndex(a,b);var l=E.getLayerWithExtentRange(v);if(k.loadingAgent)r.fallsWithinLayer(this,l,!1)?(k.loadingAgent!==n.TILE_AGENT_DONE&&
k.loadingAgent.setSuspension(c),k.loadingAgent!==n.TILE_AGENT_DONE&&(d=k.loadingAgent.update())):k.dispose();else if(r.fallsWithinLayer(this,l,!1)){{d=a;l=b;var h=c;const w=0===l?F.acquire():G.acquire();w.init(this,d,l,h);d=w}k.loadingAgent=d;(d=k.loadingAgent.startLoading())?k.loadingAgent===n.TILE_AGENT_DONE&&this.setPendingUpdate(32):(y(k.loadingAgent),k.loadingAgent=n.TILE_AGENT_DONE)}k.loadingAgent===n.TILE_AGENT_DONE&&this.updateRenderData(b);if(d&&v.isOpaque)break}};e.isWithinExtent=function(a){const b=
this.extent;return b[0]>=a[0]&&a[2]>=b[2]&&b[1]>=a[1]&&a[3]>=b[3]};e.intersectsExtent=function(a){const b=this.extent;return b[2]>=a[0]&&a[2]>=b[0]&&b[3]>=a[1]&&a[3]>=b[1]};T._createClass(p,[{key:"usedMemory",get:function(){-1===this._usedMemory&&this._updateMemoryUsed();return this._usedMemory+(this.isCached?0:this.mapTileMemory)}},{key:"cachedMemory",get:function(){return this.isCached?this.mapTileMemory:0}},{key:"mapTileMemory",get:function(){-1===this._usedMemory&&this._updateMemoryUsed();let a=
this._mapTileMemory;for(const {data:b}of this.layerInfo[1])b instanceof L.VectorTile&&(a+=b.getMemoryUsage());return a}},{key:"isCached",get:function(){return!this.shouldRender&&0>=this._mapDataRefCount}},{key:"maxTesselation",get:function(){return this._maxTesselation}},{key:"numSubdivisionsAtLevel",get:function(){return this._numSubdivisionAtLevel}},{key:"isWithinClippingArea",get:function(){return this._isWithinClippingArea}},{key:"intersectsClippingArea",get:function(){return this._intersectsClippingArea}},
{key:"clippingArea",get:function(){return this._clippingArea}},{key:"parent",get:function(){return this._parent}},{key:"children",get:function(){return this._children}},{key:"surface",get:function(){return this._surface}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"level",get:function(){return this.lij[0]}},{key:"edgeLen",get:function(){return this._edgeLen}},{key:"radius",get:function(){return this._radius}},{key:"screenDepth",get:function(){return this._screenDepth}},
{key:"visible",get:function(){if(this._dirty){const a=this._isVisible();a!==this._visible&&(this._visible=a,this.updateAgentSuspension(),this.surface.emit("tiles-visibility-changed"),this.surface.renderer.setNeedsRender());this._dirty=!1}return this._visible}},{key:"rendered",get:function(){const a=!!this.renderData;a!==this._previouslyRendered&&(this.surface.emit("tiles-visibility-changed"),this._previouslyRendered=a,this.surface.renderer.setNeedsRender());return a}},{key:"shouldRender",get:function(){if(!this.visible)return!1;
if(1===this.surface.lodSnapping){const a=this.level-this._surface.snapLevel;if(0===a)return!0;if(1===a)return!1}return this.isLeaf}},{key:"cpuImageMemorySize",get:function(){const a=this._surface.tilingScheme.pixelSize;return a*a*4}},{key:"updating",get:function(){if(this.hasPendingUpdates)return!0;for(let a=0;2>a;a++){const b=this.layerInfo[a];for(const c of b)if(c.loadingAgent&&c.loadingAgent!==n.TILE_AGENT_DONE&&c.loadingAgent.updating)return!0}return!1}},{key:"hasPendingUpdates",get:function(){return 0!==
this._pendingUpdates}},{key:"isLeaf",get:function(){return null==this._children[0]}},{key:"test",get:function(){return{cachedMemory:this.cachedMemory}}}]);return p}();const G=new J(Q),F=new J(P),aa=new O.ElevationBounds;x.SplitLimits=function(){this.angledSplitBias=this.maxLod=this.relativeHeightLimit=this.relativeWidthLimit=this.fovY=this.fovX=0;this.aboveGround=!0};x.default=A;x.pruneAgents=function(){G.prune(0);F.prune(0)};Object.defineProperty(x,"__esModule",{value:!0})});