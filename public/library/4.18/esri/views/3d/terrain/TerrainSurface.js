// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/decorators/aliasOf ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/ObjectPool ../../../core/arrayUtils ../../../core/PooledArray ../../../core/promiseUtils ../../../core/Accessor ../../../geometry/support/spatialReferenceUtils ../../../core/Evented ../../../core/mathUtils ../../../Color ../../../chunks/vec3f64 ../../../chunks/vec3 ../../../core/Handles ../../../core/CollectionFlattener ../../../geometry/projectionEllipsoid ../../../core/watchUtils ../../../chunks/mat4 ../../../geometry/support/aaBoundingRect ../../../geometry/projection ../../support/Scheduler ../../../chunks/mat4f64 ../../../chunks/vec4f64 ../../../layers/support/LercDecoder ../../../layers/support/layerUtils ./TerrainConst ../../../chunks/mat3f32 ../support/geometryUtils ../support/debugFlags ../support/extentUtils ./terrainUtils ../../2d/engine/vectorTiles/decluttering/jobsUtil ../layers/ElevationLayerView3D ./ElevationBounds ./ElevationData ./OverlayManager ./tileUtils ./Tile ./PlanarPatch ./SphericalPatch ./SurfaceExtentHelper ./SurfaceTilingSchemeLogic ./TerrainRenderer ./TerrainSurfacePerformanceInfo ./UpsampleInfo".split(" "),
function(Z,M,k,l,w,aa,Da,m,D,Ea,ba,Fa,Ga,Ha,E,ca,K,u,da,ea,fa,N,ha,O,ia,ja,ka,la,z,ma,r,L,P,na,oa,Q,pa,v,qa,R,S,ra,n,sa,ta,ua,T,va,A,U,wa,xa,V,ya,za,Aa,Ba){function W(q,x){return q[0]===x[0]&&q[1]===x[1]&&q[2]===x[2]}function B(q){return q.isLeaf?!1:q.children[0].shouldRender||q.children[1].shouldRender||q.children[2].shouldRender||q.children[3].shouldRender||B(q.children[0])||B(q.children[1])||B(q.children[2])||B(q.children[3])}const t=aa.getLogger("esri.views.3d.terrain.TerrainSurface");l=function(q){function x(a){a=
q.call(this,a)||this;a._clippingExtent=null;a._dataExtent=null;a._elevationBounds=new ua.ElevationBounds;a._rootExtent=r.create();a._iteratorPool=new E(A.IteratorPreorder);a._postorderIterator=new A.IteratorPostorder;a.pendingUpdates=!1;a._asyncWorkItems=0;a._allTilesDirty=!0;a._allTilesSorted=!0;a._visible=!1;a._usedMemory=-1;a._performanceInfo=new Aa;a._viewChanged=!1;a._inFrameTask=!1;a._viewChangeUpdateDirty=!1;a._overlayOpacity=1;a._eyePosRenderSR=O.create();a._eyePosSurfaceSR=O.create();a._splitLimits=
new U.SplitLimits;a._snapLevel=Infinity;a._frustum=R.frustum.create();a._viewProjectionMatrix=na.create();a._layerViews=[[],[]];a._layerIndexByLayerViewId=[new Map,new Map];a._basemapLayerViewHandles=new Map;a._handles=new ja;a._allTiles=new K;a._upsampleInfoPool=new E(Ba.UpsampleInfo);a._visibleLevels=new K({deallocator:null});a._getElevationData={spatialReference:null,rootTiles:null};a.maxTextureScale=1.2;a.rootTiles=null;a.backgroundImage=v.DEFAULT_TILE_BACKGROUND;a.backgroundColor=null;a._layerViewsDirty=
!1;return a}M._inheritsLoose(x,q);var h=x.prototype;h.initialize=function(){this._stage=this.view._stage;this._lercDecoder=Q.acquireDecoder(this.view.resourceController.scheduler);this._tilePool="planar"===this.manifold?new E(wa.PlanarPatch):new E(xa.SphericalPatch);this._upsampleMapCache=this.view.resourceController.memoryController.getMemCache("esri.views.3d.terrain.upsample",b=>b.unloadMapData());this._set("overlayManager",new va.OverlayManager({surface:this}));this._handles.add([this.watch("overlayManager.hasHighlights",
b=>this._renderer.setNeedsHighlight(b)),this.watch("overlayManager.rendersOccluded",b=>this._renderer.setRenderOccludedOverlay(b))],"overlayManager");this._renderer=new za({manifold:this.manifold,overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:la.getReferenceEllipsoid(this.view.spatialReference).radius});this._renderer.install(this.view._stage);this._handles.add([z.init(this,"baseOpacity",b=>{this._handleLayerViewChanges();this._updateBaseOpacity(b)},!0),z.init(this,"_background",()=>
{this._handleLayerViewChanges();this._renderer.setTileBackground(this._background)},!0),this.view.watch("pointsOfInterest",b=>{this._renderer.pointsOfInterest=b;this._handles.remove("poi");b&&this._handles.add(b.focus.watch("renderLocation",()=>this._allTilesSorted=!1),"poi")}),z.whenTrue(S,"TERRAIN_DEBUG_POPUP",()=>{(new Promise(function(b,c){Z(["./support/TerrainDebugPopupOpener"],b,c)})).then(b=>{const c=new b.TerrainDebugPopupOpener({surface:this});z.whenFalseOnce(S,"TERRAIN_DEBUG_POPUP",()=>
c.destroy())})})]);var a={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper="spherical"===this.manifold?new V.SurfaceExtentHelperGlobal(a):new V.SurfaceExtentHelperLocal(a);this._handles.add(z.init(this.extentHelper,"stencilEnabledExtents",b=>this._renderer.setStencilEnabledLayerExtents(b)),"extentHelper");a=this.view.defaultsFromMap?new ka({root:this.view.map,rootCollectionNames:this.view.defaultsFromMap.mapCollectionPaths,
getChildrenFunction:b=>b.layers}):this.view.map.allLayers;a=new ya({layers:a,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",a);this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",()=>this._updateTilingSchemeAndExtent(),!0),this.tilingSchemeLogic.watch("extent",()=>this._updateTilingSchemeAndExtent(),!0)],"tilingSchemeLogic");this._updateTilingSchemeAndExtent();this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0);
this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);this._frameTask=this.view.resourceController.scheduler.registerTask(P.Task.TERRAIN_SURFACE,b=>this._update(b),()=>this.updating);this.view.resourceController.memoryController.events.on("quality-changed",()=>this._viewChangeUpdate());this._handles.add([this.view.on("resize",()=>this._viewChangeUpdate()),this.view.watch("state.camera",()=>this._viewChangeUpdate(),!0),this.view.watch("qualitySettings.tiledSurface.lodBias",
()=>this._viewChangeUpdate()),z.init(this.view,"qualitySettings.tiledSurface.textureFadeDuration",b=>this._renderer.textureFadingEnabled=0<b),this.view.watch("lodSnapping",()=>this._viewChangeUpdate()),this.view.watch("clippingArea",()=>this._clippingChanged())]);this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0));this._layerViewsDirty=!0;this._handleLayerViewChanges();this._updateClippingExtent();this.notifyChange("extent")};h.destroy=function(){this._frameTask.remove();
this._handles.destroy();Q.releaseDecoder(this._lercDecoder);this._lercDecoder=null;this._removeAllTiles();this._upsampleMapCache=w.destroyMaybe(this._upsampleMapCache);this._set("tilingSchemeLogic",w.destroyMaybe(this.tilingSchemeLogic));this.extentHelper=w.destroyMaybe(this.extentHelper);this._basemapLayerViewHandles.forEach((a,b)=>this._unregisterTiledLayerView(b));this._mapDataRequester=this._elevationDataRequester=null;this._set("overlayManager",w.destroyMaybe(this.overlayManager));this._tilePool=
w.destroyMaybe(this._tilePool);U.pruneAgents();this._renderer.uninstall(this._stage);this._renderer=w.destroyMaybe(this._renderer);this._iteratorPool=w.destroyMaybe(this._iteratorPool);this._set("view",null);this._stage=null;this._upsampleInfoPool=w.destroyMaybe(this._upsampleInfoPool)};h.isOpaque=function(){return this._renderer.opaque};h.intersect=function(a,b,c,d){this._renderer.intersect(a,b,c,d)};h.getElevation=function(a,b,c,d){const f=this._getElevationData.rootTiles;if(!f||!f.length||0===
f[0].layerInfo[0].length)return null;const e=C;e[0]=a;e[1]=b;e[2]=c;if(!L.projectVectorToVector(e,d,e,this._getElevationData.spatialReference))return t.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(var g of f)if(g.containsPoint(e)){for(;g&&!g.rendered&&!g.isLeaf;)a=0,e[0]>.5*(g.extent[0]+g.extent[2])&&(a+=1),e[1]<.5*(g.extent[1]+g.extent[3])&&(a+=2),g=g.children[a];if(g=(g=g.renderData)&&g.geometryState?g.geometryState.samplerData:
null)return T.ElevationData.sample(e[0],e[1],g);break}return null};h.getScale=function(a){if(this.tilingScheme){if(!L.projectPointToVector(a,C,this.spatialReference))return t.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;if(a=this.rootTiles)for(let b of a)if(b.containsPoint(C)){for(;null!=b.children[0];)a=0,C[0]>b.children[0].extent[2]&&(a+=1),C[1]<b.children[0].extent[1]&&(a+=2),b=b.children[a];return this._getLodBiasCorrectedScale(b.level)}}return 1E100};
h.queryVisibleScaleRange=function(a,b,c,d){b=b?this.tilingScheme.levelAtScale(b):0;c=c?this.tilingScheme.levelAtScale(c):Infinity;const f=this.lodBias;this._renderer.queryVisibleLevelRange(a,b+f,c+f,d)};h._updateBaseOpacity=function(a){const b=this._renderer.opaque;this._renderer.opaque=1<=a;this._renderer.isTransparent=this.allTransparentSurfaceLayers();this._updateTileTextures(b!==this._renderer.opaque)};h._updateTilingSchemeAndExtent=function(){var a=this.tilingSchemeLogic.extent;const b=a&&!r.equals(a,
this._dataExtent);b&&(this._dataExtent?r.set(this._dataExtent,a):this._dataExtent=r.create(a));a=this.tilingSchemeLogic.tilingScheme;const c=a!==this.tilingScheme;c&&(n.weakAssert(!!a,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",a),this._updateClippingExtent(),a&&(this._updateTiledLayers(),this._renderer.setTileSize(a.pixelSize),this.overlayManager.setSpatialReference(a.spatialReference,"spherical"===this.manifold)));(b||c)&&this._updateRootTiles()};
h._acquireTile=function(a,b,c,d){const f=this._tilePool.acquire();F[0]=a;F[1]=b;F[2]=c;f.init(F,d,this);return f};h._updateRootTiles=function(){var a=this._clippingExtent||this._dataExtent;const b=this.tilingScheme;if(a&&b){var c=Ca,d=b.rootTilesInExtent(a,c,5*v.MAX_ROOT_TILES),f=e=>{e=this._acquireTile(0,e[1],e[2],null);2===e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&e.setPendingUpdate(2);this._loadTile(e);return e};if(this.rootTiles){if(d.length>v.MAX_ROOT_TILES){t.warn(v.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);
return}a=this.rootTiles.map(g=>g.lij);const e=ca.difference(a,d,W);if(0<e.removed.length||0<e.added.length){const g=this.rootTiles.filter(p=>-1<e.removed.findIndex(W.bind(null,p.lij))?(this._purgeTile(p),!1):!0);e.added.forEach(p=>g.push(f(p)));this._setRootTiles(g)}}else d.length>v.MAX_ROOT_TILES&&(t.warn(v.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),d=b.rootTilesInExtent(a,c,v.MAX_ROOT_TILES)),this._setRootTiles(d.map(e=>f(e)));r.equals(c,this._rootExtent)||(this._rootExtent=r.create(c),this._hasFixedExtent()||
this.notifyChange("extent"));this.visible=!0;this._viewChangeUpdate();this.overlayManager.setOverlayPlacementDirty();this.notifyChange("ready")}};h._setRootTiles=function(a){this._set("rootTiles",a);this._allTiles.clear();if(a){const b=this._iteratorPool.acquire();for(b.reset(a);!b.done;)this._allTiles.push(b.next());this._iteratorPool.release(b)}this._getElevationData.rootTiles=a;this._renderer.setRootTiles(this.rootTiles);this._updateTileVisibility(a)};h._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&
(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())};h._viewChangeUpdate=function(){this._stage&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTileVisibility(this.rootTiles)))};h._updateClippingStatus=function(a){a.updateClippingStatus(this._clippingExtent)&&a.resetPendingUpdate(32)&&this._updateTileGeometry(a)};
h._updateTileVisibility=function(a){if(a){var b=this._iteratorPool.acquire();b.reset(a);if(A.hasVisibleSiblings(a)){a=this._elevationBounds.min;var c=this._elevationBounds.max}else a=Infinity,c=-Infinity;for(;!b.done;){const d=b.next();this._updateClippingStatus(d);d.updateVisibility();d.setPendingUpdate(16);d.visible?(d.updateScreenDepth(this._viewProjectionMatrix),d.renderData&&(a=Math.min(d.elevationBounds[0],a),c=Math.max(d.elevationBounds[1],c))):b.skipSubtree()}this._iteratorPool.release(b);
this._allTilesDirty=this._viewChanged=!0;isFinite(a)&&isFinite(c)&&(this._elevationBounds.min!==a||this._elevationBounds.max!==c)&&(this._elevationBounds.min=a,this._elevationBounds.max=c,this.emit("elevation-bounds-change",null))}};h._updateViewDependentParameters=function(){const a=this.view.state.camera,b=Math.tan(.5*a.fovX),c=Math.tan(.5*a.fovY),d=this.tilingScheme.pixelSize,f=Math.pow(2,-this.lodBias)*a.pixelRatio;this._splitLimits.aboveGround=a.aboveGround;this._splitLimits.fovX=b;this._splitLimits.fovY=
c;this._splitLimits.relativeWidthLimit=d/a.width*this.maxTextureScale*f;this._splitLimits.relativeHeightLimit=d/a.height*this.maxTextureScale*f;this._splitLimits.maxLod=this.tilingScheme.getMaxLod();this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias;R.frustum.copy(a.frustum,this._frustum);ma.multiply(this._viewProjectionMatrix,a.projectionMatrix,a.viewMatrix);ia.copy(this._eyePosRenderSR,a.eye);L.projectVectorToVector(this._eyePosRenderSR,this.view.renderSpatialReference,
this._eyePosSurfaceSR,this.spatialReference)};h._updateSnapLevel=function(){if(0===this.lodSnapping)return!1;const a=this._computeSnapLevel();if(.25>Math.abs(this._snapLevel-a))return!1;const b=this.snapLevel;this._snapLevel=a;return b!==this.snapLevel};h._computeSnapLevel=function(){if(0>=this._visibleLevels.length)return this._snapLevel;const a=this._visibleLevels,b=Math.round(a.length*(Math.abs(this.view.camera.tilt-90)/90*.4+.3));if(b>=a.length)return this._snapLevel;a.sort((f,e)=>f-e);let c=
0;for(var d=b;d<a.length;++d)c+=a.getItemAt(d);d=a.getItemAt(Math.round(.95*a.length)-1);return N.clamp(c/(a.length-b),d-1,this._splitLimits.maxLod)};h._updateSkirts=function(){const a=this.view.state.camera;this.skirtScale=n.computeSkirtScale(this,this._eyePosSurfaceSR,this.view.state.constraints.collision.enabled?0:1.11*a.near)};h._updateRenderData=function(a){a.rendered&&!a.shouldRender&&(B(a)?this._loadChildren(a):a.isLeaf&&a.parent&&a.parent.shouldRender&&this._loadParent(a))};h._updateTileGeometry=
function(a){a.updateVisibility();this._renderer.updateTileGeometry(a);this._elevationUpdate(a);this._usedMemory=-1};h._elevationUpdate=function(a){G.spatialReference=this.spatialReference;G.tile=a;G.extent=a.extent;this.emit("elevation-change",G);r.containsPoint(a.extent,this._eyePosSurfaceSR)&&this._updateSkirts()};h._update=function(a){this._handleLayerViewChanges(a);this._inFrameTask=!0;this.pendingUpdates=!1;this._updateTileStatus(a);this._sortTiles(a);this._mergeAndSplit(a);a.run(()=>this._updateElevation(a));
a.run(()=>this._updateTextures(a));this._inFrameTask=!1;this._runViewChangeUpdateIfDirty();a.done&&(this.pendingUpdates=!0)};h._updateTileStatus=function(a){if(this._viewChanged&&this.rootTiles&&!a.done){this._viewChanged=!1;var b=this._iteratorPool.acquire();for(b.reset(this.rootTiles);!b.done;){var c=b.next();if(c.visible){var d=c.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===d){c.resetPendingUpdate(8);c.isLeaf&&(c.setPendingUpdate(2),b.skipSubtree());continue}c.resetPendingUpdate(2)&&
c.updateAgentSuspension();4===d&&c.updateAgents(0)}b.skipSubtree();if(!c.isLeaf){c.setPendingUpdate(8);c.resetPendingUpdate(2);d=this._iteratorPool.acquire();d.resetOne(c);for(c=d.next();!d.done;c=d.next())this._updateClippingStatus(c),c.updateVisibility(),c.visible&&c.updateScreenDepth(this._viewProjectionMatrix);this._iteratorPool.release(d)}}this._iteratorPool.release(b);this.pendingUpdates=!0;a.madeProgress()}};h._sortTiles=function(a){a.done||this._allTilesSorted||(A.sortTilesByPOI(this._allTiles,
this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,a.madeProgress())};h._mergeAndSplit=function(a){if(!this.suspended&&this._allTilesDirty&&!a.done){this._allTilesDirty=!1;this.pendingUpdates=!0;for(var b=this._eyePosRenderSR,c=0,d=1===this.lodSnapping?f=>{const e=f.shouldSplit(this._splitLimits,b,0);f.visible&&(2!==e&&f.parent&&2===f.parent.shouldSplit(this._splitLimits,b,0)?1===e?this._visibleLevels.fill(f.level+1,4):this._visibleLevels.push(f.level):f.isLeaf&&2===e&&this._visibleLevels.fill(f.level+
1,3))}:()=>{};!a.done;){let f=!1;c=0;this._visibleLevels.clear();const e=!this._allTiles.some(g=>{c+=g.usedMemory;d(g);g.resetPendingUpdate(8)?(this._mergeTile(g),f=!0,a.madeProgress()):g.resetPendingUpdate(2)&&(this._splitTile(g),f=!0,a.madeProgress());g.resetPendingUpdate(16)&&(this._updateRenderData(g),a.madeProgress());return a.done});f&&(this._allTilesSorted=!1,this._allTilesDirty=!0);if(e){if(this._usedMemory=c,!f)if(this._updateSnapLevel())this._updateTileVisibility(this.rootTiles);else break}else this._allTilesDirty=
!0}0===c&&(this._allTilesDirty=!0);this._visibleLevels.clear();this._sortTiles(a)}};h._updateElevation=function(a){this._allTiles.some(b=>{b.resetPendingUpdate(32)&&(this._updateTileGeometry(b),a.madeProgress());return a.done});return a.hasProgressed};h._updateTextures=function(a){this._allTiles.some(b=>{b.resetPendingUpdate(64)&&(this._renderer.updateTileTexture(b),this._usedMemory=-1,a.madeProgress());return a.done});return a.hasProgressed};h._updateClippingExtent=function(){if(!this.spatialReference)return!1;
const a=r.create();let b=null;ra.toBoundingRect(this.view.clippingArea,a,this.spatialReference)&&(b=a);if(r.equals(b,this._clippingExtent))return!1;this._clippingExtent=b;this._renderer.clippingExtent=b;this.notifyChange("extent");this.updateTileOverlayParams();this.overlayManager.setOverlayPlacementDirty();return!0};h._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()};h._getLodBiasCorrectedScale=function(a){const b=this.tilingScheme.levels;a=N.clamp(a-this.lodBias,
0,b.length-1);const c=a-Math.floor(a);return b[Math.floor(a)].scale*(1-c)+b[Math.ceil(a)].scale*c};h._removeAllTiles=function(){this.rootTiles&&(this.rootTiles.forEach(a=>this._purgeTile(a)),this._setRootTiles(null),this.notifyChange("ready"));this._allTiles.clear();this.visible=!1};h._purgeChildTiles=function(a){if(a.isLeaf)return!1;let b=this._purgeTile(a.children[0]);b=this._purgeTile(a.children[1])||b;b=this._purgeTile(a.children[2])||b;b=this._purgeTile(a.children[3])||b;a.unsetChildren();return b};
h._purgeTile=function(a){const b=this._purgeChildTiles(a)||a.rendered;this._allTiles.removeUnordered(a);a.unload(this._renderer);this._tilePool.release(a);return b};h._splitTile=function(a){n.weakAssert(a.isLeaf,"tile that is already split should not be split again!");const b=a.level+1,c=2*a.lij[1],d=2*a.lij[2];a.setChildren(this._createTile(b,c,d,a),this._createTile(b,c,d+1,a),this._createTile(b,c+1,d,a),this._createTile(b,c+1,d+1,a));a.setPendingUpdate(16);a.updateAgentSuspension();this._allTiles.pushArray(a.children);
this._allTilesDirty=!0;this._emitTileScaleChange(a,b);++this._performanceInfo.numSplit};h._emitTileScaleChange=function(a,b=a.level){H.spatialReference=this.spatialReference;H.extent=a.extent;H.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",H)};h._createTile=function(a,b,c,d){n.weakAssert(!!d,"_createTile sanity check");a=this._acquireTile(a,b,c,d);a.updateClippingStatus(this._clippingExtent);a.visible&&(a.updateScreenDepth(this._viewProjectionMatrix),2===a.shouldSplit(this._splitLimits,
this._eyePosRenderSR,this.lodSnapping)&&a.setPendingUpdate(2));return a};h._mergeTile=function(a){n.weakAssert(!a.hasPendingUpdate(2),"_mergeTile sanity check");this._purgeChildTiles(a)&&(n.weakAssert(!a.renderData,"_mergeTile sanity check"),this._loadTile(a));this._allTilesDirty=!0;++this._performanceInfo.numMerged;this._emitTileScaleChange(a)};h._loadChildren=function(a){n.weakAssert(a.rendered,"parent should be rendered");a.unload(this._renderer);this._loadTile(a.children[0]);this._loadTile(a.children[1]);
this._loadTile(a.children[2]);this._loadTile(a.children[3])};h._loadParent=function(a){a=a.parent;this._unloadChildren(a);this._loadTile(a)};h._unloadChildren=function(a){a.isLeaf||(this._unloadChildren(a.children[0]),a.children[0].unload(this._renderer),this._unloadChildren(a.children[1]),a.children[1].unload(this._renderer),this._unloadChildren(a.children[2]),a.children[2].unload(this._renderer),this._unloadChildren(a.children[3]),a.children[3].unload(this._renderer))};h._loadTile=function(a){a.load(this._renderer);
a.setPendingUpdate(16);this.pendingUpdates=!0;this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(a);this._elevationUpdate(a)};h._elevationDataArrived=function(a,b,c){c=new T.ElevationData(a.lij,a.extent,c);a.dataArrived(b,0,c);c=[a];a=a.level;const d=this._iteratorPool.acquire();for(d.reset(c);!d.done;){const f=d.next();f.findElevationBoundsForLayer(b,a);f.computeElevationBounds()}this._iteratorPool.release(d);this._updateTileVisibility(c)};h._handleLayerViewChanges=
function(a=P.noBudget){if(this._layerViewsDirty){var b=this._layerViewsDirty=!1,c=new Set,d=-1;for(const e of this.view.allLayerViews.items)if(c.add(e.uid),n.isSurfaceLayerView(e))if(this._basemapLayerViewHandles.has(e.uid)){var f=this.layerClassFromLayerView(e);f=this._layerIndexByLayerViewId[f].get(e.uid);f<d&&(b=!0);d=f}else this._registerTiledLayerView(e),e.layer.loaded&&(b=!0);this._basemapLayerViewHandles.forEach((e,g)=>{c.has(g)||(this._unregisterTiledLayerView(g),b=!0)});b&&this._updateTiledLayers();
this._renderer.isTransparent=this.allTransparentSurfaceLayers();a.madeProgress()}};h.allTransparentSurfaceLayers=function(){let a=0===this.view.map.ground.opacity;for(const b of this.view.allLayerViews.items)if(n.isSurfaceLayerView(b)&&!n.isElevationLayerView(b)&&!pa.isBaseLayer(b.layer)&&0!==b.fullOpacity){a=!1;break}return a};h.layerClassFromLayerView=function(a){return n.isElevationLayerView(a)?0:1};h._registerTiledLayerView=function(a){const b=[],c=this.layerClassFromLayerView(a);b.push(a.watch("suspended",
()=>this._updateTiledLayers()));b.push(a.watch("fullOpacity",()=>this._updateTileTextures(!1)));b.push(a.layer.watch("scaleRangeId",()=>this._restartAllAgents(c)));a.on("data-changed",()=>{const d=this._layerIndexByLayerViewId[c].get(a.uid);null!=d&&this._invalidateLayerData(d,c)});this._basemapLayerViewHandles.set(a.uid,b)};h._unregisterTiledLayerView=function(a){const b=this._basemapLayerViewHandles.get(a);if(b){for(let c=0;c<b.length;c++)b[c].remove();this._basemapLayerViewHandles.delete(a)}};
h._updateTiledLayers=function(){if(this.tilingScheme&&!this.view.suspended){var a=this.view.allLayerViews,b=[[],[]],c=null,d=r.empty();a.forEach(e=>{var g=e.layer;if(g&&!e.suspended&&n.isSurfaceLayerView(e)){var p=e.fullExtent;p?this.tilingScheme.compatibleWith(e.tileInfo)?(r.expand(d,p),g=this.layerClassFromLayerView(e),1===g&&(p=e.displayLevelRange,Infinity!==p.maxLevel&&(null===c||p.maxLevel>c)&&(c=p.maxLevel)),b[g].push(e)):t.warn("Terrain: tiling scheme of layer "+g.id+" is incompatible with other tiled layers, will not be drawn"):
t.warn("Terrain: Map or elevation layer does not have fullExtent: "+g.id)}});for(a=0;2>a;a++){var f=this._layerViews[a];const e=b[a];e.reverse();const g=e.length;let p=f.length!==g;const X=Array(g),Y=Array(f.length);this._layerIndexByLayerViewId[a].clear();for(let y=0;y<g;y++){this._layerIndexByLayerViewId[a].set(e[y].uid,y);const I=f.indexOf(e[y]);X[y]=I;y!==I&&(p=!0);-1<I&&(Y[I]=y)}if(p){f=this._postorderIterator;for(f.reset(this.rootTiles);!f.done;)f.next().modifyLayers(Y,X,a);this._layerViews[a]=
e;this._restartAllAgents(a);this._updateTileVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(c)&&this._viewChangeUpdate()}};h._restartAllAgents=function(a){const b=this._postorderIterator;for(b.reset(this.rootTiles);!b.done;){const c=b.next();c.restartAgents(a);0===a&&c.computeElevationBounds()}};h._hasFixedExtent=function(){return!!this._clippingExtent};h.layerViewByIndex=function(a,b){return this._layerViews[b][a]};h.numLayers=function(a){return this._layerViews[a].length};h._updateTileTextures=
function(a){this._allTiles.forAll(b=>{b.updateAgents(1);a?this.renderer.updateTileTexture(b):b.updateRenderData(1)});this._renderer.isTransparent=this.allTransparentSurfaceLayers()};h._invalidateLayerData=function(a,b){this._allTiles.forAll(c=>c.removeLayerAgent(a,b));this._allTiles.forAll(c=>c.invalidateLayerData(a,b))};h.setTileTreeDirty=function(){this._allTilesDirty=!0};h.requestRender=function(a=1){this.renderer.setNeedsRender(a)};h.requestTileData=function(a,b,c,d){const f=this.layerViewByIndex(b,
c);b=f.layer;if(!b.tilemapCache||n.isVectorTileLayerView(f))return this._requestTileData(a,c,f,d);++this._asyncWorkItems;return b.tilemapCache.fetchAvailability(a.lij[0],a.lij[1],a.lij[2],{...d,timeout:6E3}).then(()=>--this._asyncWorkItems).catch(e=>{--this._asyncWorkItems;u.isAbortError(e)||this._dataMissing(a,c,f,{notInTilemap:!0});throw e;}).then(()=>this._frameTask.schedule(()=>this._requestTileData(a,c,f,d),d.signal))};h._requestTileData=function(a,b,c,d){return 0===b?this._requestElevationTileData(a,
c,d):this._requestMapTileData(a,c,d)};h._requestElevationTileData=function(a,b,c){if(n.isElevationLayerView(b)){var d=g=>{--this._asyncWorkItems;if(!u.isAborted(c)){var p=this._layerIndexByLayerViewId[0].get(b.uid);null==p?t.warn("TerrainSurface: received data from unknown layer %d %s",0,a.lij.toString()):(this._usedMemory=-1,this.pendingUpdates=!0,this._elevationDataArrived(a,p,g))}},f=g=>{--this._asyncWorkItems;u.isAbortError(g)||(this._dataMissing(a,0,b,g),this.pendingUpdates=!0)};++this._asyncWorkItems;
if(n.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],{noDataValue:v.ELEVATION_NODATA_VALUE,signal:c.signal}).then(g=>{u.isAborted(c)?(t.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),f(u.createAbortError())):d(g)},f);var e=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);return this._elevationDataRequester.request(e,"binary",c).then(g=>this._lercDecoder.decode(g,{noDataValue:v.ELEVATION_NODATA_VALUE},
c.signal)).then(g=>{d({values:g.pixelData,width:g.width,height:g.height,noDataValue:g.noDataValue,minValue:g.minValue,maxValue:g.maxValue})},f)}n.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views")};h._requestMapTileData=function(a,b,c){if(b instanceof ta)return u.reject();++this._asyncWorkItems;const d=g=>this._frameTask.schedule(()=>{--this._asyncWorkItems;this.pendingUpdates=!0;u.isAborted(c)?n.releaseTileData(g):this._dataArrived(a,1,b,g)},c.signal).catch(f),
f=g=>this._frameTask.schedule(()=>{--this._asyncWorkItems;u.isAborted(c)||(this._dataMissing(a,1,b,g),this.pendingUpdates=!0)});if(n.isVectorTileLayerView(b)){var e=b.schemaHelper.getLevelRowColumn(a.lij);return b.tileHandler.getVectorTile(e[0],e[1],e[2],c).then(g=>{g.neededForCoverage=!0;g.transforms.tileUnitsToPixels=qa.fromValues(.125,0,0,0,.125,0,0,0,1);sa.declutterSingleTile(g,b.layer.styleRepository);d(g)},f)}if(n.isImageryTileLayerView(b))return b.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(d,
f);if(n.useFetchTileForLayer(b.layer)&&n.isTileLayerView(b))return b.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(g=>{u.isAborted(c)?(t.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),f(u.createAbortError())):d(g)},f);e=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);null!=b.refreshInterval&&b.refreshTimestamp&&(e+=`${-1<e.indexOf("?")?"\x26":"?"}_ts=${b.refreshTimestamp}`);return this._mapDataRequester.request(e,
b.hasMixedImageFormats?"image+type":"image",c).then(d,f)};h._dataArrived=function(a,b,c,d){c=this._layerIndexByLayerViewId[b].get(c.uid);null!=c?a.dataArrived(c,b,d):t.warn("TerrainSurface: received data from unknown layer")};h._dataMissing=function(a,b,c,d){c=this._layerIndexByLayerViewId[b].get(c.uid);null!=c?a.dataMissing(c,b,d):t.warn("TerrainSurface: received data from unknown layer")};h.updateTileOverlayParams=function(){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll(a=>{a.renderData&&
this.overlayManager.setTileParameters(a)}),this._renderer.setNeedsRender())};h.updateOverlayOpacity=function(){if(this.overlayManager){var a=this.overlayManager.computeOpacity(this._eyePosSurfaceSR[2]);a!==this._overlayOpacity&&(this._overlayOpacity=a,this._renderer.overlayOpacity=a,this._renderer.setNeedsRender())}};h.getUsedMemory=function(){if(!this.tilingScheme)return 0;-1===this._usedMemory&&(this._usedMemory=0,this._allTiles.forAll(a=>this._usedMemory+=a.usedMemory));return this._usedMemory};
h.getUsedMemoryForLayerView=function(a){let b=0;const c=this.layerClassFromLayerView(a),d=this._layerIndexByLayerViewId[c].get(a.uid);this._allTiles.forAll(f=>b+=f.getUsedMemoryForLayer(c,d));return b};h.getTile=function(a){const b=a.split("/").map(e=>+e);if(0===b[0])return this.rootTiles.find(e=>e.lij[1]===b[1]&&e.lij[2]===b[2]);a=Math.pow(2,b[0]);const c=Math.floor(b[1]/a),d=Math.floor(b[2]/a);let f;this.rootTiles.some(e=>e.lij[1]===c&&e.lij[2]===d?(f=e,!0):!1);if(f){for(a=1<<b[0]-1;f.lij[0]<b[0];){let e=
b[1]&a?2:0;0<(b[2]&a)&&e++;if(!f.children[e])return null;f=f.children[e];a>>=1}n.weakAssert(f.lij[0]===b[0]&&f.lij[1]===b[1]&&f.lij[2]===b[2],"not the right tile?");return f}return null};h.getRenderedTiles=function(){J.clear();this._allTiles.forAll(a=>{a.visible&&a.rendered&&J.push(a)});A.sortTiles(this.renderOrder,J);return J.toArray()};M._createClass(x,[{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){return Math.round(this._snapLevel)}},
{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",get:function(){return this._upsampleMapCache}},{key:"extent",get:function(){return this._clippingExtent||this._rootExtent}},{key:"updating",get:function(){return!(!(this.pendingUpdates||this._viewChanged||this._allTilesDirty||0<this._asyncWorkItems||!this._allTilesSorted||this._renderer.updating||this.overlayManager.updating||this._layerViewsDirty||this._frameTask.updating)||!this.ready||this.suspended)}},
{key:"ready",get:function(){return!!this.rootTiles}},{key:"renderOrder",set:function(a){this._renderer.renderOrder=a;this._set("renderOrder",a)}},{key:"skirtScale",set:function(a){this._renderer.skirtScale=a},get:function(){return this._renderer.skirtScale}},{key:"spatialReference",get:function(){const a=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=a}},{key:"_background",get:function(){return null!=this.backgroundColor?this.backgroundColor:
this.backgroundImage}},{key:"slicePlaneEnabled",set:function(a){this._renderer.slicePlane=a;this._set("slicePlaneEnabled",a)}},{key:"velvetOverground",set:function(a){a!==this.velvetOverground&&(this._renderer.velvetOverground=a);this._set("velvetOverground",a)}},{key:"visible",set:function(a){a!==this._visible&&(this._visible=a,this._renderer.setVisibility(a),this.suspended=!a)}},{key:"suspended",set:function(a){this._set("suspended",a);this._viewChangeUpdate()}},{key:"lodSnapping",get:function(){return ea.isEarth(this.spatialReference)?
this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?1:0:0}},{key:"elevationBounds",get:function(){return this._elevationBounds}},{key:"lodBias",get:function(){return this.view.qualitySettings.tiledSurface.lodBias-(1-this.view.resourceController.memoryController.memoryFactor)*v.MAX_MEMORY_LOD_BIAS}},{key:"performanceInfo",get:function(){const a=this._performanceInfo;a.numNodes=this._allTiles.length;a.numLeaves=a.numVisible=a.numRendered=a.numLoadedPerLevel.length=a.numRenderedPerLevel.length=
0;this._allTiles.forAll(b=>{b.isLeaf&&a.numLeaves++;const c=b.level;b.renderData&&(a.numLoadedPerLevel[c]=(a.numLoadedPerLevel[c]||0)+1);b.visible&&(a.numVisible++,b.rendered&&(a.numRenderedPerLevel[c]=(a.numRenderedPerLevel[c]||0)+1,a.numRendered++))});return a}},{key:"test",get:function(){const a=this;return{renderer:a._renderer,lercDecoder:a._lercDecoder,forceReload:()=>{a._mergeTile(a.rootTiles[0]);a._viewChangeUpdate()},getTiles:()=>a._allTiles.toArray()}}}]);return x}(fa.EventedMixin(da));k.__decorate([m.property()],
l.prototype,"_renderer",void 0);k.__decorate([m.property()],l.prototype,"pendingUpdates",void 0);k.__decorate([m.property()],l.prototype,"_asyncWorkItems",void 0);k.__decorate([m.property()],l.prototype,"_allTilesDirty",void 0);k.__decorate([m.property()],l.prototype,"_allTilesSorted",void 0);k.__decorate([m.property()],l.prototype,"_viewChanged",void 0);k.__decorate([m.property()],l.prototype,"_frameTask",void 0);k.__decorate([m.property({constructOnly:!0})],l.prototype,"view",void 0);k.__decorate([D.aliasOf("_renderer.cullBackFaces")],
l.prototype,"cullBackFaces",void 0);k.__decorate([m.property({readOnly:!0,dependsOn:[],autoTracked:!1})],l.prototype,"extent",null);k.__decorate([m.property({readOnly:!0,dependsOn:"ready suspended pendingUpdates _asyncWorkItems _allTilesDirty _allTilesSorted _renderer.updating _layerViewsDirty overlayManager.updating _frameTask.updating".split(" ")})],l.prototype,"updating",null);k.__decorate([m.property({aliasOf:"view.map.ground.opacity"})],l.prototype,"baseOpacity",void 0);k.__decorate([m.property({readOnly:!0})],
l.prototype,"overlayManager",void 0);k.__decorate([m.property({constructOnly:!0})],l.prototype,"manifold",void 0);k.__decorate([m.property()],l.prototype,"maxTextureScale",void 0);k.__decorate([m.property({readOnly:!0,autoTracked:!0})],l.prototype,"ready",null);k.__decorate([m.property({value:1})],l.prototype,"renderOrder",null);k.__decorate([m.property({readOnly:!0})],l.prototype,"rootTiles",void 0);k.__decorate([m.property({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],l.prototype,
"spatialReference",null);k.__decorate([m.property()],l.prototype,"backgroundImage",void 0);k.__decorate([m.property({type:ha,aliasOf:"view.map.ground.surfaceColor"})],l.prototype,"backgroundColor",void 0);k.__decorate([m.property({dependsOn:["backgroundColor","backgroundImage"]})],l.prototype,"_background",null);k.__decorate([m.property({value:!1})],l.prototype,"slicePlaneEnabled",null);k.__decorate([m.property({readOnly:!0})],l.prototype,"tilingScheme",void 0);k.__decorate([m.property({readOnly:!0,
aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],l.prototype,"tilingSchemeLocked",void 0);k.__decorate([m.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],l.prototype,"tilingSchemeDone",void 0);k.__decorate([m.property({readOnly:!0})],l.prototype,"tilingSchemeLogic",void 0);k.__decorate([m.property({value:!0})],l.prototype,"velvetOverground",null);k.__decorate([D.aliasOf("_renderer.wireframe")],l.prototype,"wireframe",void 0);k.__decorate([m.property({value:!1})],l.prototype,
"suspended",null);k.__decorate([m.property({readOnly:!0,dependsOn:["view.qualitySettings.tiledSurface.reduceTileLevelDifferences"]})],l.prototype,"lodSnapping",null);k.__decorate([m.property({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],l.prototype,"textureFadeDuration",void 0);k.__decorate([m.property()],l.prototype,"_layerViewsDirty",void 0);k.__decorate([D.aliasOf("_renderer.renderPatchBorders")],l.prototype,"renderPatchBorders",void 0);k.__decorate([D.aliasOf("_renderer.renderingDisabled")],
l.prototype,"renderingDisabled",void 0);k=l=k.__decorate([ba.subclass("esri.views.3d.terrain.TerrainSurface")],l);const C=oa.create(),Ca=r.create(),F=[0,0,0],J=new K,G={spatialReference:null,tile:null,extent:null,context:"ground"},H={spatialReference:null,extent:null,scale:0};return k});