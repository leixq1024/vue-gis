// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../core/mathUtils ../../../chunks/vec2f64 ../../../chunks/vec2 ../../../layers/support/layerUtils ../../webgl/Program ../../webgl/BufferObject ../../webgl/Texture ../../webgl/Util ../../webgl/VertexArrayObject ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/Renderbuffer ../../webgl/FramebufferObject ../../webgl/ProgramCache ../../webgl/RenderingContext ../../webgl/ShaderCompiler ../support/StreamDataLoader ../../webgl/rasterUtils ./TileTexture ./terrainUtils ../../2d/engine/vectorTiles/tileRendererHelper3D ./BlendLayersTechnique ./RasterColorizerTechnique ./support/FBOPool".split(" "),
function(G,q,H,C,D,I,P,Q,y,J,R,K,w,S,T,U,V,W,L,M,u,v,N,z,E,O){function A(p,h,a){a.layerIndex=h;const b=p.layerInfo[1][h];return b.data?(D.set(a.offset,0,0),a.tile=p,a.scale=1,a.sourceLod=p.lij,a.sourceLayerInfo=b,a):(p=b.upsampleInfo)?(h=p.tile.layerInfo[1][h],a.tile=p.tile,D.copy(a.offset,p.offset),a.scale=p.scale,a.sourceLod=p.tile.lij,a.sourceLayerInfo=h,a):null}const F=[],B={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};return function(){function p(a,b,c){this._rctx=
a;this.tileSize=b;this._blackTex=this._backgroundTexture=null;this._vectorTileHelper=new N.VectorTileRendererHelper3D;this._rctx.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy);this._vaoQuad=w.createQuadVAO(this._rctx,K.Pos2Tex);a=new z.BlendLayersTechniqueConfiguration;a.mode=2;this._blendLayersTechnique=c.acquireAndReleaseExisting(z.BlendLayersTechnique,a,this._blendLayersTechnique);a.mode=1;this._applyOpacityTechnique=c.acquireAndReleaseExisting(z.BlendLayersTechnique,
a,this._applyOpacityTechnique);this._techniqueRep=c;this._blackTex=new u(w.createColorTexture(this._rctx,[0,0,0,1]));this._fboPool=new O.FBOPool(this._rctx)}var h=p.prototype;h.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null);this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null);q.isSome(this._backgroundTexture)&&(this._backgroundTexture.release(),this._backgroundTexture=null);this._blackTex&&(this._blackTex.release(),this._blackTex=null);this._blendLayersTechnique&&
(this._blendLayersTechnique.dispose(),this._blendLayersTechnique=null);this._applyOpacityTechnique&&(this._applyOpacityTechnique.dispose(),this._applyOpacityTechnique=null);this._rasterColorizerTechnique&&(this._rasterColorizerTechnique.dispose(),this._rasterColorizerTechnique=null);this._vectorTileHelper&&(this._vectorTileHelper.dispose(),this._vectorTileHelper=null)};h.updateTileTexture=function(a){var b=a.layerInfo[1];for(var c of b)c.pendingUpdates&=-65;if(a.renderData){var d=a.surface,e=d.baseOpacity,
g=0;c=0;for(var f=this.tileSize,m=!1,k=d.view.pixelRatio,r=b.length,l=0;l<b.length&&!m;l++){const t=d.layerViewByIndex(l,1),n=t.fullOpacity;F[l]=n;I.isBaseLayer(t.layer)&&r>=b.length&&(r=l);if(0===n)continue;++c;const x=A(a,l,B);x&&(v.isVectorTileLayerView(t)?f=Math.max(f,this.tileSize*k):1===e&&1===n&&(t.isOpaque||this._dataToTexture(x)&&q.isSome(x.sourceLayerInfo.data)&&x.sourceLayerInfo.data.descriptor.isOpaque)&&(m=!0),++g)}this._cleanupFBOPool(k,b.length);e=f;f=H.nextHighestPowerOfTwo(e);b=f*
f;d=e*e;b===d?f=e:(e=f/2,f=b-d<d-e*e?f:e);b=f/this.tileSize;--l;if(0===g){g=0;if(a.surface.view.layerViewManager.updating||0<c)g=5E3;this._backgroundTexture&&q.isNone(a.renderData.textureReference)&&(g=0);this._useBackgroundTexture(a,g)}else 1===g&&m?this._useLayerTexture(a,l):this._composeMapLayers(a,l,r,m,F,f,b)}};h.setBackground=function(a){q.isSome(this._backgroundTexture)&&this._backgroundTexture.release();this._backgroundTexture=a instanceof HTMLImageElement?this._buildTexture(a):new u(w.createColorTexture(this._rctx,
a))};h._buildTexture=function(a){if(q.isNone(a))return null;const b={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},c=this._rctx;let d;if("number"===typeof a)b.width=b.height=a,d=new u(new y(c,b));else if(a instanceof L.ImageWithType)b.isOpaque=a.isOpaque,d=new u(new y(c,b,a.image)),a.release();else try{d=new u(new y(c,b,a))}catch(e){d=new u(w.createEmptyTexture(c)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}c.bindTexture(d.texture,
0);d.generateMipmap();return d};h._drawQuad=function(a){this._rctx.bindVAO(this._vaoQuad);a.assertCompatibleVertexAttributeLocations(this._vaoQuad);this._rctx.drawArrays(5,0,J.vertexCount(this._vaoQuad,"geometry"))};h._drawRasterData=function(a,b,c,d,e=1){if(!q.isNone(b)){var g=this._rctx,f=a.program;g.setPipelineState(a.pipeline);g.bindProgram(f);g.bindTexture(b,0);f.setUniform1i("tex",0);f.setUniform1f("scale",c);f.setUniform2f("offset",d[0],d[1]);f.setUniform1f("opacity",e);this._drawQuad(f)}};
h._drawImageryTileData=function(a,b=1){const c=a.sourceLayerInfo.data;if(!q.isNone(c)&&c.source){a.tile.surface.layerViewByIndex(a.layerIndex,1).ensureSymbolizerParameters(c);var d=this._getRasterColorizerTechnique(c.symbolizerParameters.type,!!c.symbolizerParameters.colormap),e=this._rctx,g=d.program;e.setPipelineState(d.pipeline);e.bindProgram(g);if(c.bind(e)){c.opacity=b;c.scale=a.scale;c.offset=a.offset;var {names:f,textures:m}=c.getTextures();M.setTextures(e,g,f,m);a=c.getUniforms();d.bindPass(e,
a);this._drawQuad(g);e.bindVAO()}}};h._getRasterColorizerTechnique=function(a,b){a=["stretch","lut","hillshade"].indexOf(a);this._rasterColorizerConfig||(this._rasterColorizerConfig=new E.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float"));this._rasterColorizerConfig.colorizerType=a;this._rasterColorizerConfig.applyColormap=b;return this._rasterColorizerTechnique=this._techniqueRep.acquireAndReleaseExisting(E.RasterColorizerTechnique,
this._rasterColorizerConfig,this._rasterColorizerTechnique)};h._drawVectorData=function(a,b,c,d,e,g,f){const m=b.sourceLayerInfo.data;if(q.isNone(m))return f;const k=this._rctx,r=b.tile.surface.layerViewByIndex(b.layerIndex,1);let l;k.setPipelineState(a.pipeline);const t=1>d;t?(l=this._fboPool.acquire(e),k.bindFramebuffer(l),k.setClearColor(1,1,1,0),k.clearSafe(16640)):f&&k.clearSafe(256);this._vectorTileHelper.render(k,b.sourceLod,m,r.painter,r.layer.styleRepository,r.schemaHelper,Math.round(1/b.scale),
b.offset,this.tileSize,c);return t?(k.bindFramebuffer(g),this._drawRasterData(a,l.colorTexture,1,[0,0],d),this._fboPool.release(l),f):!0};h._useBackgroundTexture=function(a,b){a.renderData.opacity=a.surface.baseOpacity;a.renderData.setTextureReference(this._backgroundTexture,0,0,1,b)};h._useLayerTexture=function(a,b){a.renderData.opacity=a.surface.baseOpacity;b=A(a,b,B);if(this._dataToTexture(b)){const c=b.offset;a.renderData.setTextureReference(b.sourceLayerInfo.data,c[0],c[1],b.scale)}};h._composeMapLayers=
function(a,b,c,d,e,g,f){const m=a.renderData.ensureTexture(g,()=>this._buildTexture(g));if(!q.isNone(m)){var k=this._rctx,r=this._fboPool.acquire(g);k.bindFramebuffer(r);k.setViewport(0,0,g,g);k.setClearColor(0,0,0,0);k.setClearDepth(1);k.clearSafe(16640);var l=!1;!d&&q.isSome(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,C.ZEROS);d=a.surface.baseOpacity;for(var t=!1;0<=b;b--){const n=A(a,b,B);n&&(b<c&&1>d&&!t&&(this._drawRasterData(this._applyOpacityTechnique,
this._blackTex.texture,1,C.ZEROS,d),t=!0),0!==e[b]&&(v.isVectorTileRenderInfo(n)?l=this._drawVectorData(this._blendLayersTechnique,n,f,e[b],g,r,l):v.isImageryTileRenderInfo(n)?this._drawImageryTileData(n,e[b]):this._dataToTexture(n)&&q.isSome(n.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,n.sourceLayerInfo.data.texture,n.scale,n.offset,e[b])))}k.bindTexture(m.texture,0);c=m.descriptor;k.gl.copyTexImage2D(k.gl.TEXTURE_2D,0,c.pixelFormat,0,0,c.width,c.height,0);m.generateMipmap();
k.bindFramebuffer(null);this._fboPool.release(r);a.renderData.opacity=t?1:d;a.renderData.setTextureReference(m,0,0,1)}};h._dataToTexture=function(a){v.isRasterTileRenderInfo(a)&&this._rasterDataToTexture(a);return v.isTextureTileRenderInfo(a)};h._rasterDataToTexture=function(a){const b=a.sourceLayerInfo;b.data=this._buildTexture(b.data);a.tile.setMemoryDirty()};h._cleanupFBOPool=function(a,b){if(a!==this._lastPixelRatio||b!==this._lastNumLayers)this._fboPool.clear(),this._lastPixelRatio=a,this._lastNumLayers=
b};G._createClass(p,[{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]);return p}()});