// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ./TerrainConst ./terrainUtils ./tileUtils".split(" "),function(m,n,r,w,x,y){const t=Error("Abstract method called on TileAgent");let v=function(){function h(){}var b=h.prototype;b.init=function(a,g,c,e){this.tile=a;this._layerIdx=g;this._layerClass=c;this._suspended=e;this._tileLayerInfo=a.getLayerInfo(g,c);this._tileRequested=null;a=this._findAncestorWithData();this._setUpsampleTile(a)};b.startLoading=function(){return this._requestNext()};
b.dispose=function(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null);this._tileLayerInfo=this.tile=null};b.setSuspension=function(a){a!==this._suspended&&((this._suspended=a)?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())};b.update=function(){const a=this._findAncestorWithData();this._setUpsampleTile(a);
return this._requestNext()};b.dataArrived=function(a){this._setUpsampleTile(a);this._tileRequested=null;a===this.tile?this.tile.updateRenderData(this._layerClass):this._requestNext()};b.dataMissing=function(){this._tileRequested=null;this._tileLayerInfo.disposeData();this._requestNext()};b._agentDone=function(){this.tile.agentDone(this._layerIdx,this._layerClass);this.dispose()};b._requestNext=function(){if(this._suspended)return!0;const a=this._findNextDownload();if(this._tileRequested){if(a===this._tileRequested)return!0;
this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this);this._tileRequested=null}a?a.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=a):this._agentDone();return!!this._tileRequested};b._findNextDownload=function(){const a=this._layerIdx,g=this._layerClass;var c=this.tile.surface.layerViewByIndex(a,g);const e=x.getLayerWithExtentRange(c),{minLevel:z,maxLevel:A}=c.dataLevelRange;c=this._desiredMinLevelDelta;const B=this._loadingLevelDelta+c,C=this._scaleRangeEnabled?
y.fallsWithinLayer:()=>!0;let f,d=this.tile,p=0;var k=this._tileLayerInfo.upsampleInfo;k=k?k.tile.level:-1;const u=r.get(e,"tilemapCache");for(;d&&C(d,e,!1)&&d.level>=z;){const q=d.level,l=d.layerInfo[g][a];if(l.data&&p>=c){q>k&&this._setUpsampleTile(d);l.dataInvalidated&&(f=d);break}if((r.isNone(u)||"unavailable"!==u.getAvailability(d.lij[0],d.lij[1],d.lij[2]))&&q<=A&&!l.data&&!l.dataMissing){if(!f||0===q%w.LOADING_LEVEL_MODULO||this.tile.level-f.level<c)f=d;if(p>=B)break}d=d.parent;p++}f&&this.tile.level-
f.level<c&&this._tileLayerInfo.upsampleInfo&&(f=null);return f};b._findAncestorWithData=function(){const a=this.tile.vlevel,g=this._desiredMinLevelDelta;let c;for(let e=this.tile;e;e=e.parent)if(e.hasLayerData(this._layerIdx,this._layerClass)){if(a-e.level>=g)return e;c=e}return c};b._setUpsampleTile=function(a){this._tileLayerInfo.setUpsampleInfo(this.tile,a);this.tile.updateRenderData(this._layerClass)};n._createClass(h,[{key:"updating",get:function(){return!!this._tileRequested}},{key:"test",get:function(){return{findNextDownload:()=>
this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}]);return h}();const D=new (function(h){function b(){return h.apply(this,arguments)||this}n._inheritsLoose(b,h);n._createClass(b,[{key:"_desiredMinLevelDelta",get:function(){throw t;}},{key:"_loadingLevelDelta",get:function(){throw t;}}]);return b}(v));m.TILE_AGENT_DONE=D;m.TileAgent=v;Object.defineProperty(m,"__esModule",{value:!0})});