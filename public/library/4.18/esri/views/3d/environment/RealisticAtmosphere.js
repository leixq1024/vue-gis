// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../core/promiseUtils ../../../geometry/support/Ellipsoid ../../../chunks/vec3f64 ../../../chunks/vec3 ../../../core/Handles ../../../core/watchUtils ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2f64 ../../../chunks/vec4f64 ../../../chunks/vec2 ../../../chunks/vec4 ../webgl-engine/lib/DefaultVertexAttributeLocations ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../../webgl/BufferObject ../../webgl/VertexArrayObject ./atmosphereUtils ./RealisticAtmosphereTechnique".split(" "),
function(t,F,l,g,h,G,u,v,w,n,m,x,y,H,I,J,K,L,z,p){let M=function(){function q(a,b){this._view=a;this.canRender=!0;this._skyslot=14;this._hazeSlot=15;this._renderData={texDepth:n.create(),cameraPosition:g.create(),projectionInverse:w.create(),viewInverse:w.create(),heightParameters:m.create(),atmosphereParameters1:m.create(),atmosphereParameters2:m.create(),atmosphereParameters3:g.create(),invWavelength:A,invWavelengthScaled:k,radii:n.create(),scale:0,scaleDepth:.25,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,
oneOverScaleDepth:0,scaleDepthBlue:.05,oneOverScaleDepthBlue:20,scaleOverScaleDepthBlue:0,g:-.99999,g2:-.99999*-.99999,miePhaseCoefficients:B,nearFar:n.create(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0};this._lowerElevationBoundRadius=0;this._lowerBoundEarthRadius=l.earth.radius;this._updateRadius(l.earth.radius);this._techniqueRepository=b;this._atmosphereTechniqueConfig=new p.RealisticAtmosphereTechniqueConfiguration}var c=q.prototype;c.destroy=function(){this._handles&&
(this._handles.destroy(),this._handles=null);this._vao&&(this._vao.dispose(),this._vao=null)};c.when=function(){return F.resolve()};c.initializeRenderContext=function(a){a=a.rctx;this._handles=new G;this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"});this._handles.add(u.on(this._view,"basemapTerrain","elevation-change",b=>this._updateElevation(b),()=>this._updateElevation()));
this._handles.add(u.on(this._view,"basemapTerrain","elevation-bounds-change",()=>this._updateVisibleElevationBounds(),()=>this._updateVisibleElevationBounds()));this._atmosphereTechniqueConfig.haze=!1;this._atmosphereTechnique=this._techniqueRepository.acquireAndReleaseExisting(p.RealisticAtmosphereTechnique,this._atmosphereTechniqueConfig,this._atmosphereTechnique);this._atmosphereTechniqueConfig.haze=!0;this._atmosphereHazeTechnique=this._techniqueRepository.acquireAndReleaseExisting(p.RealisticAtmosphereTechnique,
this._atmosphereTechniqueConfig,this._atmosphereHazeTechnique);this._vao=this._createVertexArrayObject(a)};c.uninitializeRenderContext=function(){this.destroy()};c.render=function(a){if(a.slot!==this._hazeSlot&&a.slot!==this._skyslot||0!==a.pass)return!1;this._update(a.camera);a.slot===this._skyslot&&this._renderSky(a);a.slot===this._hazeSlot&&this._renderHaze(a);return!0};c._renderSky=function(a){const b=a.rctx,d=this._atmosphereTechnique.program;b.bindProgram(d);this._atmosphereTechnique.bindPipelineState(b);
d.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3);this._renderCommon(d,a)};c._renderHaze=function(a){const b=a.rctx,d=a.offscreenRenderingHelper,f=this._atmosphereHazeTechnique.program;b.bindProgram(f);this._atmosphereHazeTechnique.bindPipelineState(b);d.renderDepthDetached(()=>{b.bindTexture(d.depthTexture,0);f.setUniform1i("depthTex",0);this._renderCommon(f,a)})};c._renderCommon=function(a,b){const d=b.rctx;a.setUniform3fv("invWavelength",this._renderData.invWavelength);
a.setUniform3fv("invWavelengthScaled",this._renderData.invWavelengthScaled);b.scenelightingData.setLightDirectionUniform(a);a.setUniform4fv("heightParameters",this._renderData.heightParameters);a.setUniform3fv("cameraPosition",this._renderData.cameraPosition);a.setUniformMatrix4fv("projectionInverse",this._renderData.projectionInverse);a.setUniformMatrix4fv("viewInverse",this._renderData.viewInverse);a.setUniform2fv("nearFar",this._renderData.nearFar);a.setUniform2fv("radii",this._renderData.radii);
a.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1);a.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2);a.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance);a.setUniform1f("altitudeFade",this._renderData.altitudeFade);d.bindVAO(this._vao);a.assertCompatibleVertexAttributeLocations(this._vao);d.drawArrays(5,0,4)};c._createVertexArrayObject=function(a){const b=C.createBuffer(4);b.position.setVec(0,[-1,-1]);b.position.setVec(1,
[1,-1]);b.position.setVec(2,[-1,1]);b.position.setVec(3,[1,1]);b.uv0.setVec(0,[0,0]);b.uv0.setVec(1,[1,0]);b.uv0.setVec(2,[0,1]);b.uv0.setVec(3,[1,1]);return new L(a,H.Default3D,{geometry:I.glLayout(C)},{geometry:K.createVertex(a,35044,b.buffer)})};c._adjustRadiusForTesselation=function(a){return a*Math.cos(Math.PI/Math.pow(2,4)/16)};c._updateElevation=function(a){a=a?a.tile:this._view.basemapTerrain.rootTiles[0];0===a.lij[0]&&(a=this._adjustRadiusForTesselation(l.earth.radius+a.elevationBounds[0]),
a!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=a,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds()))};c._updateVisibleElevationBounds=function(){const a=this._adjustRadiusForTesselation(l.earth.radius+this._view.basemapTerrain.elevationBounds.min);(0>this._lowerBoundEarthRadius||a<this._lowerBoundEarthRadius)&&this._updateRadius(a)};c._updateRadius=function(a){this._lowerBoundEarthRadius=a;var b=a/10*10.25;const d=1/(b-a),f=d/.25,D=d/.05,E=.3*(b-a)+a,e=this._renderData;
y.set(e.atmosphereParameters1,d,.25,f,4);y.set(e.atmosphereParameters2,-.99999,.05,D,20);h.set(e.atmosphereParameters3,-.99999*-.99999,B,E);x.set(e.radii,a,b);e.scale=d;e.lowerAlphaBlendBound=E;e.scaleOverScaleDepth=f;e.scaleOverScaleDepthBlue=D;b=z.INNER_ATMOSPHERE_DEPTH;e.innerFadeDistance=2*Math.sqrt((2*a-b)*b)};c._update=function(a){a&&(this._renderData.cameraHeight=h.length(a.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-
this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=m.fromValues(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),h.copy(this._renderData.cameraPosition,a.eye),v.invert(this._renderData.projectionInverse,a.projectionMatrix),v.invert(this._renderData.viewInverse,a.viewMatrix),x.set(this._renderData.nearFar,
a.near,a.far),this._renderData.altitudeFade=z.computeInnerAltitudeFade(this._renderData.cameraHeight-this._lowerBoundEarthRadius))};q.isSupported=function(a){return a.rctx.capabilities.depthTexture};return q}();const N=.02*Math.PI,r=.004*Math.PI,A=g.fromValues(1/Math.pow(.65,4),1/Math.pow(.57,4),1/Math.pow(.475,4)),k=g.clone(A);h.scale(k,k,N);h.add(k,k,g.fromValues(r,r,r));const B=(1- -.99999*-.99999)/(2+-.99999*-.99999)*1.5,C=J.newLayout().vec2f("position").vec2f("uv0");t.RealisticAtmosphere=M;Object.defineProperty(t,
"__esModule",{value:!0})});