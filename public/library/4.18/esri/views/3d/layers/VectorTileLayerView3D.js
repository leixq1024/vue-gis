// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../core/watchUtils ../../2d/engine/vectorTiles/SchemaHelper ../../2d/engine/vectorTiles/style/StyleRepository ../terrain/terrainUtils ./LayerView3D ./TiledLayerView3D ../../layers/LayerView ../../2d/engine/vectorTiles/TileHandler ../../2d/engine/vectorTiles/VTLPainter3D".split(" "),
function(l,e,c,N,O,f,P,z,Q,R,S,g,A,B,m,C,D,E,F,n,p){c=function(q){function h(a){return q.call(this,a)||this}l._inheritsLoose(h,q);var r=h.prototype;r.initialize=function(){var a=this._getTileInfoSupportError(C.test.force512VTL?this.layer.tileInfo:this.layer.compatibleTileInfo256,this.layer.fullExtent);if(a)this.addResolvingPromise(g.reject(a));else{a=A.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then(()=>{var b=this.view.basemapTerrain.tilingScheme,d=b.pixelSize;this.schemaHelper=
new B(d,this.view.spatialReference.isGeographic);d=256===d?this.layer.compatibleTileInfo256:this.view.spatialReference.isGeographic?this.layer.compatibleTileInfo512:this.layer.tileInfo;if(b=this._getTileInfoCompatibilityError(d,b))throw b;this._set("tileInfo",d)});this._tileHandlerController=g.createAbortController();this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,b=>this.tileHandler.releaseVectorTile(b));var t=this.view.resourceController.scheduler,{style:G,
spriteUrl:H,glyphsUrl:I}=this.layer.currentStyleInfo;this.tileHandler=new n.TileHandler(this.layer,new m(G,{spriteUrl:H,glyphsUrl:I}),this.view.pixelRatio,this._memCache);var u=this.tileHandler.start({signal:this._tileHandlerController.signal,scheduler:t}),v=this.tileHandler.spriteMosaic;v.then(b=>this.painter=new p(b,this.tileHandler.glyphMosaic));u.then(()=>this._tileHandlerController=null);var y=()=>{this._tileHandlerController&&this._tileHandlerController.abort();this._tileHandlerController=g.createAbortController();
this._memCache.clear();const {style:b,spriteUrl:d,glyphsUrl:J}=this.layer.currentStyleInfo,k=new n.TileHandler(this.layer,new m(b,{spriteUrl:d,glyphsUrl:J}),this.view.pixelRatio,this._memCache),w=k.start({signal:this._tileHandlerController.signal,scheduler:t}),K=k.spriteMosaic;w.then(()=>this._tileHandlerController=null);this.updatingHandles.addPromise(g.all([w,K]).then(([,L])=>{const M=this.tileHandler,x=this.painter;this.painter=new p(L,k.glyphMosaic);this.tileHandler=k;this.emit("data-changed");
M.destroy();x&&x.dispose()}))};this.updatingHandles.add(this,"layer.currentStyleInfo",y);this.updatingHandles.add(this,"view.pixelRatio",y);a=g.all([a,u,v]);this.addResolvingPromise(a)}};r.destroy=function(){this._memCache&&(this._memCache.destroy(),this._memCache=null);this.painter&&(this.painter.dispose(),this.painter=null);this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null);this.tileHandler&&(this.tileHandler.destroy(),this.tileHandler=null)};l._createClass(h,
[{key:"dataLevelRange",get:function(){var a=this.tileInfo.lods;a=this.levelRangeFromScaleRange(a[0].scale,a[a.length-1].scale);1===a.minLevel&&256===this.tileInfo.size[0]&&(a.minLevel=0);return a}}]);return h}(E.TiledLayerView3D(D.LayerView3D(F)));e.__decorate([f.property({aliasOf:"layer.fullExtent"})],c.prototype,"fullExtent",void 0);e.__decorate([f.property()],c.prototype,"layer",void 0);e.__decorate([f.property()],c.prototype,"tileInfo",void 0);e.__decorate([f.property()],c.prototype,"dataLevelRange",
null);e.__decorate([f.property()],c.prototype,"updatingProgressValue",void 0);return c=e.__decorate([z.subclass("esri.views.3d.layers.VectorTileLayerView3D")],c)});