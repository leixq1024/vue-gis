// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/arrayUtils ../../../../core/Accessor ../../../../geometry/SpatialReference ../../../../geometry/support/webMercatorUtils ../../../../geometry ../../../../chunks/vec3 ../../../../core/unitUtils ../../../../core/watchUtils ../../../../geometry/support/aaBoundingRect ../../../../geometry/projection ../../../../core/sql/WhereClause ../../../../geometry/support/aaBoundingBox ../../../layers/support/FeatureFilter ./I3SUtil".split(" "),
function(T,n,M,r,na,v,U,oa,t,pa,V,qa,ra,sa,N,W,D,E,ta,u,X,Y,F,y,Z,aa,ba,O){async function ca(){return q?q:q=await new Promise(function(c,b){T(["../../../../geometry/geometryEngine"],c,b)})}function C(c,b){if(!c)return null;if("disjoint"===b&&"polygon"===c.type){const a=Array(c.rings.length);for(b=0;b<c.rings.length;++b){var h=F.fromValues(Infinity,Infinity,-Infinity,-Infinity);F.expandWithNestedArray(h,c.rings[b]);a[b]={type:"polygon",rings:[c.rings[b]],spatialReference:c.spatialReference,aabr:h}}a.sort((e,
f)=>e.aabr[0]-f.aabr[0]);const k=new Set,p=new N.PositionHint;for(c=0;c<a.length;++c){const e=a[c];for(b=c+1;b<a.length;++b){h=a[b];if(h.aabr[0]>=e.aabr[2])break;k.add(h)}k.forEach(f=>{e!==f&&(f.aabr[2]<=e.aabr[0]?k.delete(f):q.intersects(e,f)&&(e.rings=e.rings.concat(f.rings),F.expand(e.aabr,f.aabr),delete e._geVersion,k.delete(f),f=N.indexOf(a,f,a.length,p),a.splice(f,1)))});k.add(e)}for(const e of a)delete e.aabr;return a}return[c]}function da(c,b,h,a,k,p,e){const f=p[0].spatialReference||a.spatialReference;
if(y.projectBoundingSphere(b.node.mbs,k,P,f)){var l=ea(e,a,f,h,b.objectHandle);h=fa(P,l);for(const d of p){if(0===c.length)break;switch(ha(d,h,e)){case 1:c.length=0;return;case 0:continue}O.filterInPlace(c,b.featureIds,g=>ia(d,g,l))}}else A.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter")}function ea(c,b,h,a,k){b=b.renderSpatialReference;const p=new Map,e={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:h};
e.rings[0][3]=e.rings[0][0];let f,l;switch(c){case "intersects":f=(d,g)=>q.intersects(d,g)?0:2;l=G;break;case "contains":f=(d,g)=>q.contains(d,g)?2:1;l=G;break;default:f=(d,g)=>q.disjoint(d,g)?2:1,l=Q}return{collection:a,object:k,type:c,maskSR:h,renderSR:b,aabbCache:p,triangle:e,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:f,geometryTest:l}}function fa(c,b){const h={x:c[0],y:c[1],hasZ:!1,hasM:!1,type:"point",spatialReference:b.maskSR};c=b.maskSR.isWGS84||b.maskSR.isWebMercator?
q.geodesicBuffer(h,c[3],1):q.buffer(h,c[3],1);c.type="polygon";return c}function ha(c,b,h){switch(h){case "intersects":case "contains":return G(c,b);case "disjoint":return Q(c,b)}}function G(c,b){return q.intersects(c,b)?q.contains(c,b)?0:2:1}function Q(c,b){return q.intersects(c,b)?q.contains(c,b)?1:2:0}function ia(c,b,h){const {collection:a,object:k,renderSR:p,maskSR:e,geometryTest:f,aabbCache:l}=h;var d=l.get(b);if(!d){d=a.getObjectTransform(k);a.getComponentAabb(k,b,w);var g=[[w[0],w[1],0],[w[0],
w[4],0],[w[3],w[4],0],[w[3],w[1],0]];for(var m=0;4>m;++m)u.transformMat3(g[m],g[m],d.rotationScale),u.add(g[m],g[m],d.position),y.projectVectorToVector(g[m],p,g[m],e);d={rings:[g],hasZ:!1,hasM:!1,type:"polygon",spatialReference:e};d.rings[0][4]=d.rings[0][0];l.set(b,d)}switch(f(c,d)){case 1:return!1;case 0:return!0}const {triangle:B,triangleTest:ja,positions:R}=h;d=B.rings[0][0];g=B.rings[0][1];m=B.rings[0][2];const z=a.getObjectTransform(k);a.getComponentPositions(k,b,R);const {indices:H,data:x,
stride:I,startIndex:ka,endIndex:la}=R;for(b=ka;b<la;b+=3){const J=I*H[b+0],K=I*H[b+1],L=I*H[b+2];u.set(d,x[J+0],x[J+1],x[J+2]);u.set(g,x[K+0],x[K+1],x[K+2]);u.set(m,x[L+0],x[L+1],x[L+2]);u.transformMat3(d,d,z.rotationScale);u.transformMat3(g,g,z.rotationScale);u.transformMat3(m,m,z.rotationScale);u.add(d,d,z.position);u.add(g,g,z.position);u.add(m,m,z.position);y.projectVectorToVector(d,p,d,e);y.projectVectorToVector(g,p,g,e);y.projectVectorToVector(m,p,m,e);if(!(Math.abs((g[0]-d[0])*(m[1]-d[1])-
(g[1]-d[1])*(m[0]-d[0]))<ma))switch(delete B._geVersion,ja(c,B)){case 1:return!1;case 0:return!0}}switch(h.type){case "intersects":return!1;default:return!0}}const A=U.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");n.I3SMeshViewFilter=function(c){function b(a){a=c.call(this,a)||this;a._projectionEngineLoaded=!1;return a}M._inheritsLoose(b,c);var h=b.prototype;h.initialize=function(){Y.whenOnce(this,"filter.geometry").then(()=>this.loadAsyncModule(ca().then(a=>{this.destroyed||(this._geometryEngine=
a,this.applyFilters())})))};h.addFilters=function(a,k,p,e){const f=this.sortedObjectIds;v.isSome(f)&&a.push(d=>O.objectIdFilter(f,!0,d));this.addSqlFilter(a,this.parsedWhereClause);const l=this.parsedGeometry;if(v.isSome(l)){const d=this.spatialRelationship;a.push((g,m)=>da(g,m,e,k,p,l,d))}};b.checkSupport=function(a){if(a.timeExtent)return A.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1;a=a.spatialRelationship;return null!=a&&0<=S.indexOf(a)?!0:(A.warn(`Filters with spatialRelationship other than ${S.join(", ")} are not supported for mesh scene layers`),
!1)};M._createClass(b,[{key:"sortedObjectIds",get:function(){if(v.isNone(this.filter.objectIds))return null;const a=new Float64Array(this.filter.objectIds);a.sort();return a}},{key:"parsedWhereClause",get:function(){const a=v.isSome(this.filter)?this.filter.where:null;if(v.isNone(a)||!a)return null;try{return Z.WhereClause.create(a,this.layerFieldsIndex)}catch(k){A.error(`Failed to parse filter where clause: ${k}`)}return null}},{key:"parsedGeometry",get:function(){if(v.isNone(this.filter)||!this._geometryEngine)return null;
var {geometry:a}=this.filter;if(v.isNone(a))return null;const {distance:k,units:p}=this.filter,e=this.spatialRelationship;a="mesh"===a.type?a.extent:a;if(v.isNone(k)||0===k)return C(a,e);const f=p||X.getUnitString(a.spatialReference);if(a.spatialReference.isWGS84)return a=this._geometryEngine.geodesicBuffer(a,k,f),C(a,e);if(E.canProject(a,D.WGS84))return a=E.project(this._geometryEngine.geodesicBuffer(E.project(a,D.WGS84),k,f),a.spatialReference),C(a,e);if(!this._projectionEngineLoaded&&(this.loadAsyncModule(y.load().then(()=>
this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;let l=null;try{l=y.project(a,D.WGS84)}catch(d){}if(l)try{l=y.project(this._geometryEngine.geodesicBuffer(l,k,f),a.spatialReference)}catch(d){l=null}l||A.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${a.spatialReference.wkid}) to WGS84.`);return C(l,e)}},{key:"spatialRelationship",get:function(){return v.isSome(this.filter)?this.filter.spatialRelationship:"intersects"}}]);return b}(W);
r.__decorate([t.property({type:ba})],n.I3SMeshViewFilter.prototype,"filter",void 0);r.__decorate([t.property()],n.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0);r.__decorate([t.property()],n.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0);r.__decorate([t.property()],n.I3SMeshViewFilter.prototype,"applyFilters",void 0);r.__decorate([t.property()],n.I3SMeshViewFilter.prototype,"addSqlFilter",void 0);r.__decorate([t.property({readOnly:!0})],n.I3SMeshViewFilter.prototype,"sortedObjectIds",
null);r.__decorate([t.property({readOnly:!0})],n.I3SMeshViewFilter.prototype,"parsedWhereClause",null);r.__decorate([t.property({readOnly:!0})],n.I3SMeshViewFilter.prototype,"parsedGeometry",null);r.__decorate([t.property({readOnly:!0})],n.I3SMeshViewFilter.prototype,"spatialRelationship",null);r.__decorate([t.property({})],n.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0);r.__decorate([t.property({})],n.I3SMeshViewFilter.prototype,"_geometryEngine",void 0);n.I3SMeshViewFilter=r.__decorate([V.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],
n.I3SMeshViewFilter);let q;const S=["contains","intersects","disjoint"],P=[0,0,0,0],ma=2**-32,w=aa.create();Object.defineProperty(n,"__esModule",{value:!0})});