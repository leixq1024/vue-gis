// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec4 ../../../../geometry/support/aaBoundingBox ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../../../chunks/mat4f32 ../../../../chunks/vec3f32 ../../support/geometryUtils ../../../webgl/BufferObject ../../../webgl/VertexArrayObject ../../webgl-engine/lib/intersectorUtils ../../webgl-engine/core/shaderLibrary/Slice.glsl ../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl ../../support/orientedBoundingBox ./PointHighlights ../../webgl-engine/shaders/PointRendererTechnique".split(" "),
function(N,aa,C,H,p,S,ba,ca,q,da,ea,fa,W,X,ha,ia,ja,ka,O,la,Y){function I(h,g,a,c,b){if(a.drawScreenSpace)return a.fixedSize*g*c;b=(b?256:64)*g*c;return a.drawFixedSize?Math.min(a.fixedSize/2,b):0<a.screenMinSize?Math.min(Math.max(a.screenMinSize*g*c,h/2),b):Math.min(h/2,b)}function Z(h){return C.isSome(h.component)?h.component:-1}function ma(h,g){if(C.isNone(h))return h;h=h.filter(a=>a.id!==g);return 0===h.length?null:h}const na={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],
colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};N.PointRenderer=function(){function h(a){this._params=a;this.type="Point";this.isGround=!1;this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null};this._highlights=new la.PointHighlights({forEachNode:c=>this.forEachNode(c),addHighlight:(c,b,d)=>this.addHighlight(c,b,d),removeHighlight:(c,b)=>this.removeHighlight(c,b)});this.canRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=
0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=q.create(q.POSITIVE_INFINITY);this._techniqueConfig=new Y.PointRendererTechniqueConfiguration;this.tempMatrix4=ea.create();this.tempVec3=fa.create();this.nodes=[]}var g=h.prototype;g.initializeRenderContext=function(a){this._initContext=a;this._techniqueRep=this._initContext.shaderTechniqueRep;a.requestRender()};g.uninitializeRenderContext=function(){};g.intersect=function(a,c,b,d){var k=H.create();
const e=H.create(),t=H.create(),z=H.create(),J=W.plane.create(),l=a.camera.perScreenPixelRatio/2,m=a.camera.near,x=this._getSizeParams();p.subtract(e,d,b);const P=1/p.length(e);p.scale(e,e,P);p.negate(t,e);ca.set(J,e[0],e[1],e[2],-p.dot(e,b));let T=function(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""};var r=new T;const y=new T;var K=[];const Q=q.create(),R=q.create(this._clipBox);q.offset(R,-b[0],-b[1],-b[2],R);for(const f of this.nodes){const n=f.splatSize*this._scaleFactor;
var A=O.minimumDistancePlane(f.obb,J),u=O.maximumDistancePlane(f.obb,J);A-=x.drawScreenSpace?0:I(n,A+m,x,l,f.isLeaf);u-=x.drawScreenSpace?0:I(n,u+m,x,l,f.isLeaf);A=null!=r.dist&&null!=y.dist&&r.dist<A*P&&y.dist>u*P;if(0>u||A)continue;u=I(n,u+m,x,l,f.isLeaf);if(!O.intersectLine(f.obb,b,e,u))continue;u*=u;O.toAaBoundingBox(f.obb,Q);q.offset(Q,-b[0],-b[1],-b[2],Q);A=!q.contains(R,Q);p.subtract(z,f.origin,b);const L=f.coordinates.length/3;for(let v=0;v<L;v++){k[0]=z[0]+f.coordinates[3*v];k[1]=z[1]+f.coordinates[3*
v+1];k[2]=z[2]+f.coordinates[3*v+2];if(A&&!q.containsPoint(R,k))continue;var w=p.dot(k,e),M=p.squaredLength(k)-w*w;if(M>u)continue;var D=w+m;const U=x.drawScreenSpace?0:I(n,D,x,l,f.isLeaf);if(0>w-U)continue;D-=U;D=I(n,D,x,l,f.isLeaf);if(M>D*D)continue;const E=(w-U)*P;w=B=>{var F=f,V=v,G=B.point;null==G&&(G=H.create());G[0]=F.origin[0]+F.coordinates[3*V];G[1]=F.origin[1]+F.coordinates[3*V+1];G[2]=F.origin[2]+F.coordinates[3*V+2];B.point=G;B.dist=E;B.normal=t;B.node=f;B.pointId=v;B.layerUid=this.layerUid};
(null==r.dist||E<r.dist)&&(null==c||c(b,d,E))&&w(r);0!==a.options.store&&(null==y.dist||E>y.dist)&&(null==c||c(b,d,E))&&w(y);2!==a.options.store||null!=c&&!c(b,d,E)||(M=new T,w(M),K.push(M))}}const oa=f=>{const {layerUid:n,node:L,pointId:v}=f;return{type:"external",point:f.point,metadata:{layerUid:n,createGraphic:()=>this._params.createGraphic(L,v,f.point)}}};c=(f,n)=>{const L=oa(n);f.set(L,`${n.layerUid}/${n.node.id}/${n.pointId}`,n.dist,n.normal,ba.IDENTITY,void 0);f.intersector="PointRenderer"};
null!=r.dist&&(k=a.results.min,(null==k.dist||r.dist<k.dist)&&c(k,r));null!=y.dist&&0!==a.options.store&&(r=a.results.max,(null==r.dist||y.dist>r.dist)&&c(r,y));if(2===a.options.store){b=W.ray.fromPoints(b,d);for(const f of K)K=new ia.IntersectorResult(b),c(K,f),a.results.all.push(K)}};g.render=function(a){if(0!==a.pass&&2!==a.pass&&5!==a.pass)return!1;var c=2===a.pass;const b=a.rctx;for(var d of this.nodes)null==d.vao&&this._initNode(a,d);d=this._getSizeParams();const k=this.selectTechnique(a,d),
e=k.program;if(null==e||0===this.nodes.length)return!0;const t=this._clipBox,z=!q.equals(t,q.POSITIVE_INFINITY,(l,m)=>l===m);z||(p.set(this.tempVec3,-Infinity,-Infinity,-Infinity),e.setUniform3fv("uClipMin",this.tempVec3),p.set(this.tempVec3,Infinity,Infinity,Infinity),e.setUniform3fv("uClipMax",this.tempVec3));b.bindProgram(e);k.bindPipelineState(b);e.setUniformMatrix4fv("uProjectionMatrix",a.camera.projectionMatrix);c&&e.setUniform2f("nearFar",a.camera.near,a.camera.far);a.isHighlightPass&&(this._bindParameters.inverseViewport[0]=
1/a.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/a.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=a.highlightDepthTexture,ka.OutputHighlight.bindOutputHighlight(b,e,this._bindParameters));c=a.camera.pixelRatio;d.drawFixedSize&&e.setUniform2f("uPointScale",d.fixedSize*c,a.camera.fullHeight);const J=this._slicePlaneEnabled?a.sliceHelper&&a.sliceHelper.plane:null;for(const l of this.nodes){if(0===l.coordinates.length)continue;if(a.isHighlightPass&&!l.highlights)continue;
e.setUniform2f("uScreenMinMaxSize",d.screenMinSize*c,(l.isLeaf?256:64)*c);d.drawFixedSize||e.setUniform2f("uPointScale",l.splatSize*this._scaleFactor*c,a.camera.fullHeight/c);const m=l.origin;z&&(p.set(this.tempVec3,t[0]-m[0],t[1]-m[1],t[2]-m[2]),e.setUniform3fv("uClipMin",this.tempVec3),p.set(this.tempVec3,t[3]-m[0],t[4]-m[1],t[5]-m[2]),e.setUniform3fv("uClipMax",this.tempVec3));S.identity(this.tempMatrix4);S.translate(this.tempMatrix4,this.tempMatrix4,m);S.multiply(this.tempMatrix4,a.camera.viewMatrix,
this.tempMatrix4);e.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4);ja.Slice.bindUniforms(e,k.configuration,J,m);b.bindVAO(l.vao);a.isHighlightPass?this._renderHighlightFragments(b,l):b.drawArrays(0,0,l.coordinates.length/3)}return!0};g._renderHighlightFragments=function(a,c){var b=c.highlights;if(!C.isNone(b)){c=C.unwrap(b[0].component);var d=c+1;for(let k=1;k<b.length;k++){const e=C.unwrap(b[k].component);e!==d&&(d-=c,0<d&&a.drawArrays(0,c,d),c=e);d=e+1}b=d-c;0<b&&a.drawArrays(0,c,b)}};
g.addNode=function(a){this.nodes.push(a);this._highlights.nodeAdded(a);this._requestRender()};g.removeNode=function(a){let c=null;this.nodes=this.nodes.filter(b=>b.id===a?(c=b,b.vao&&(b.vao.dispose(!0),b.vao=null),this._highlights.nodeRemoved(b),!1):!0);this._requestRender();return c};g.forEachNode=function(a){this.nodes.forEach(a)};g.removeAll=function(){this.nodes.forEach(a=>{a.vao&&(a.vao.dispose(!0),a.vao=null)});this._highlights.removeAll();this.nodes=[];this._requestRender()};g.highlight=function(a){return this._highlights.add(a)};
g.addHighlight=function(a,c,b){var d=a.highlights;C.isNone(d)&&(d=[]);c={component:c,id:b};d.push(c);c=Z(c);for(b=d.length-1;0<b&&c<Z(d[b-1]);)[d[b-1],d[b]]=[d[b],d[b-1]],--b;a.highlights=d;this._requestRender()};g.removeHighlight=function(a,c){a.highlights=ma(a.highlights,c);this._requestRender()};g._initNode=function(a,c){a=a.rctx;c.vao=new ha(a,da.Default3D,na,{positions:X.createVertex(a,35044,c.coordinates),colors:X.createVertex(a,35044,c.rgb)})};g._requestRender=function(){this._initContext&&
this._initContext.requestRender()};g._getSizeParams=function(){const a=this._useFixedSizes,c=a&&!this._useRealWorldSymbolSizes,b=c?this._sizePx:this._size;let d=this._minSizePx;a&&(d=0);return{drawScreenSpace:c,drawFixedSize:a,fixedSize:b,screenMinSize:d}};g.selectTechnique=function(a,c){this._techniqueConfig.drawScreenSize=c.drawScreenSpace;this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled;this._techniqueConfig.sceneHasOcludees=a.hasOccludees;this._techniqueConfig.output=2===a.pass?
1:5===a.pass?4:0;return this._techniqueRep.acquireAndReleaseExisting(Y.PointRendererTechnique,this._techniqueConfig,this._technique)};aa._createClass(h,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())},get:function(){return this._useFixedSizes}},{key:"scaleFactor",set:function(a){this._scaleFactor!==a&&(this._scaleFactor=a,this._requestRender())},get:function(){return this._scaleFactor}},
{key:"minSizePx",set:function(a){this._minSizePx!==a&&(this._minSizePx=a,this._requestRender())},get:function(){return this._minSizePx}},{key:"useRealWorldSymbolSizes",set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())},get:function(){return this._useRealWorldSymbolSizes}},{key:"size",set:function(a){this._size!==a&&(this._size=a,this._requestRender())},get:function(){return this._size}},{key:"sizePx",set:function(a){this._sizePx!==a&&(this._sizePx=
a,this._requestRender())},get:function(){return this._sizePx}},{key:"clippingBox",set:function(a){q.set(this._clipBox,a||q.POSITIVE_INFINITY)}},{key:"slicePlane",get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender())}},{key:"intersectionHandlerId",get:function(){return this.layerUid}}]);return h}();(function(h){h.isInstanceOfNode=function(g){return g.hasOwnProperty("splatSize")}})(N.PointRenderer||(N.PointRenderer=
{}));Object.defineProperty(N,"__esModule",{value:!0})});