// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/Logger ../../../../core/arrayUtils ../../../../core/promiseUtils ../../../../intl/number ../../../../request ../../../../core/asyncUtils ../../../../core/byteSizeEstimations ../../../../layers/support/featureQueryAll".split(" "),function(v,z,h,q,w,r,A,B,t,x,u){const C=q.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides");q=function(){function p(a,b){this.layer=a;this.warnMaximumChangedObjectsExceeded=
!1;this.changedObjectIds=new Set;this.pendingFetchAbortController=r.createAbortController();this.interactiveEditingSessions=null;this.memCache=b.getMemCache(`${a.uid}-attribute-overrides`);this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal);this.pendingFetchChangedObjectIds.then(()=>this.pendingFetchAbortController=null)}var g=p.prototype;g.destroy=function(){this.layer=null;this.memCache.destroy();this.memCache=null;this.pendingFetchAbortController&&
(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null);this.pendingFetchChangedObjectIds=null};g.createInteractiveEditSession=function(a){this.changedObjectIds.add(a);h.isNone(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);const b=this.interactiveEditingSessions,c=new D(a,{rollback:()=>{w.remove(b,c);0===b.length&&(this.interactiveEditingSessions=null)},commit:d=>{for(const [e,k]of d)this.updateValue(a,e,k)}});b.unshift(c);return c};g.apply=async function(a,
b,c){if(!h.isNone(b)){var {loadedAttributes:d,attributeData:e}=b;if(!h.isNone(d)&&0!==d.length&&!h.isNone(e)&&(await r.whenOrAbort(this.pendingFetchChangedObjectIds,c),0!==this.changedObjectIds.size)){b={loadedAttributes:d,attributeData:e};var k=this.getOverridesFromCache(a,b,this.changedObjectIds),{objectIds:f,fieldNames:n}=k;c=await this.queryOverridesFromAssociatedLayer(f,n,c);h.isNone(c)||this.processOverridesFromAssociatedLayer(a,c,n,b)}}};g.updateValue=function(a,b,c){this.changedObjectIds.add(a);
this.cacheValue(a,b,c)};g.cacheValue=function(a,b,c){this.memCache.put(this.getCacheKey(a,b),c,this.memCacheValueSize(c))};g.getOverridesFromCache=function(a,{loadedAttributes:b,attributeData:c},d){const e=new Set,k=[];for(var f of b)k[f.index]=c[f.name];c=new Set;for(f=0;f<a.length;f++){const n=a[f];if(d.has(n))for(const l of b){const m=this.fromCache(n,l.index);void 0!==m?k[l.index][f]=m:(e.add(n),c.add(l.name))}}return{objectIds:Array.from(e),fieldNames:Array.from(c)}};g.fromCache=function(a,b){const c=
this.fromInteractiveEditingSession(a,b);if(void 0!==c)return c;a=this.getCacheKey(a,b);return this.memCache.get(a)};g.fromInteractiveEditingSession=function(a,b){if(!h.isNone(this.interactiveEditingSessions))for(const c of this.interactiveEditingSessions){if(c.objectId!==a)continue;const d=c.get(b);if(void 0!==d)return d}};g.getCacheKey=function(a,b){return`${a}-${b}`};g.queryOverridesFromAssociatedLayer=async function(a,b,c){if(0===a.length||0===b.length)return null;a=a.sort((k,f)=>k-f);this.warnMaximumChangedObjectsExceeded&&
(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning());const d=h.unwrap(this.layer.associatedLayer),e=d.createQuery();e.where="1\x3d1";e.returnGeometry=!1;e.outFields=[d.objectIdField,...b];e.cacheHint=!0;e.objectIds=a;b=u.getMaximumQuerySize(d);a=a.length>b?w.splitIntoChunks(a,b).map(k=>{const f=e.clone();f.objectIds=k;return t.resultOrAbort(u.queryAllJSON(d,f,{signal:c}))}):[t.resultOrAbort(u.queryAllJSON(d,e,{signal:c}))];return(await r.all(a)).reduce((k,f)=>k.concat(f.ok?
f.value.features:[]),[])};g.logMaximumObjectsExceededWarning=function(){let a=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${A.formatNumber(5E4)} objects. Please consider re-caching the scene service`;const b=this.layer.portalItem;a=b&&b.loaded?a+` (${b.portal.url}/home/item.html?id=${b.id}#settings)`:a+` (${this.layer.parsedUrl.path})`;C.warn(`("${this.layer.title}"):`,`${a}.`)};g.processOverridesFromAssociatedLayer=
function(a,b,c,{loadedAttributes:d,attributeData:e}){const k=h.unwrap(this.layer.associatedLayer).objectIdField,f=c.map(l=>e[l]),n=new Map(d.map(l=>[l.name,l.index]));d=c.map(l=>n.get(l));a=new Map(Array.from(a,(l,m)=>[l,m]));for(const l of b){b=l.attributes[k];for(let m=0;m<c.length;m++){const E=d[m],F=a.get(b),y=l.attributes[c[m]];f[m][F]=y;this.cacheValue(b,E,y)}}};g.memCacheValueSize=function(a){return"string"===typeof a?x.estimateStringByteSize(a):x.estimateNumberByteSize()};g.fetchChangedObjectIds=
async function(a){var b,c,d,e=this.layer;this.changedObjectIds.clear();if(!h.isNone(e.associatedLayer)&&null!=(b=e.associatedLayer.capabilities)&&null!=(c=b.operations)&&c.supportsChangeTracking){b=this.getFetchChangedObjectIdsServerGen();if(h.isNone(b))return null;c=e.associatedLayer.layerId;a=await t.result(B(`${e.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`${c}`,returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:c,
serverGen:b}])},timeout:1E4,signal:a}));a=a.ok&&null!=(d=a.value.data)&&d.edits?h.get(a.value.data.edits[0],"objectIds","updates"):null;if(h.isSome(a))for(d=Math.min(5E4,a.length),d<a.length&&(this.warnMaximumChangedObjectsExceeded=!0),a=a.sort((k,f)=>k-f),e=0;e<d;e++)this.changedObjectIds.add(a[e])}};g.getFetchChangedObjectIdsServerGen=function(){var a=this.layer;if(h.isSome(a.serviceUpdateTimeStamp)&&h.isSome(a.serviceUpdateTimeStamp.lastUpdate))return a.serviceUpdateTimeStamp.lastUpdate;a=a.associatedLayer;
return h.isSome(a)&&h.isSome(a.serverGens)&&h.isSome(a.serverGens.minServerGen)?a.serverGens.minServerGen:null};return p}();let D=function(){function p(a,b){this.objectId=a;this.options=b;this.updates=new Map;this.state=0}var g=p.prototype;g.get=function(a){return this.updates.get(a)};g.set=function(a,b){this.isActive&&this.updates.set(a,b)};g.rollback=function(){this.isActive&&(this.state=2,this.options.rollback())};g.commit=function(){this.isActive&&(this.state=1,this.options.commit(this.updates),
this.updates.clear())};z._createClass(p,[{key:"isActive",get:function(){return 0===this.state}}]);return p}();v.I3SAttributeOverrides=q;Object.defineProperty(v,"__esModule",{value:!0})});