// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../layers/support/fieldUtils ../../../Graphic ../../support/Scheduler ../../../tasks/support/Query ./LayerView3D ./support/layerViewUpdatingProperties ../../layers/support/FeatureFilter ../../layers/SceneLayerView ./i3s/I3SUtil ./i3s/I3SGeometryUtil ./I3SMeshView3D ./i3s/I3SMeshViewFilter ./i3s/I3SQueryEngine ./i3s/I3SQueryFeatureAdapter ./i3s/I3SQueryFeatureStore ./support/DefinitionExpressionSceneLayerView ./support/PopupSceneLayerView ./i3s/attributeEditing ./support/fieldProperties".split(" "),
function(u,f,q,h,z,R,g,S,A,T,U,V,B,r,C,D,t,d,E,F,G,H,I,J,v,K,L,M,N,O,w,P){const x=z.getLogger("esri.views.3d.layers.SceneLayerView3D");q=P.defineFieldProperties();d=function(n){function p(){var a=n.apply(this,arguments)||this;a.requiredFields=[];a.lodFactor=1;a.progressiveLoadFactor=1;a._elevationContext="scene";a._isIntegratedMesh=!1;a._supportsLabeling=!0;a._queryEngine=null;return a}u._inheritsLoose(p,n);var c=p.prototype;c.initialize=function(){for(const a of["layer.renderer","layer.labelingInfo",
"layer.labelsVisible","definitionExpressionFields","filter"])this.updatingHandles.add(this,a,()=>this.updatingHandles.addPromise(this._updateRequiredFields()));this._updateRequiredFields();this.updatingHandles.add(this.layer,"rangeInfos",a=>this._rangeInfosChanged(a),2);this.updatingHandles.add(this.layer,"renderer",a=>this.updatingHandles.addPromise(this._rendererChange(a)),2);for(const a of["parsedDefinitionExpression","filter","viewFilter.parsedWhereClause","viewFilter.parsedGeometry","viewFilter.sortedObjectIds"])this.updatingHandles.add(this,
a,()=>this._filterChange());this.handles.add(this.layer.on("apply-edits",a=>this.updatingHandles.addPromise(a.result)));this.handles.add(this.layer.on("edits",a=>this._handleEdits(a)))};c.destroy=function(){};c._updateRequiredFields=async function(){const {layer:a,layer:{fields:b,renderer:e,labelsVisible:k},definitionExpressionFields:l}=this,m=new Set,Q=await B.eachAlways([e?e.collectRequiredFields(m,b):null,k?r.collectLabelingFields(m,a):null,h.isSome(this.filter)?r.collectFilterFields(m,a,this.filter):
null]);for(const y of Q)y.error&&x.error(y.error);r.collectFields(m,b,l);this._set("requiredFields",Array.from(m).sort())};c._rangeInfosChanged=function(a){null!=a&&0<a.length&&x.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};c.createQuery=function(){const a={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return h.isSome(this.filter)?this.filter.createQuery(a):new t(a)};c.queryExtent=function(a,
b){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(a),null==b?void 0:b.signal)};c.queryFeatureCount=function(a,b){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(a),null==b?void 0:b.signal)};c.queryFeatures=function(a,b){return this._ensureQueryEngine().executeQuery(this._ensureQuery(a),null==b?void 0:b.signal).then(e=>{if(null==e||!e.features)return e;const k=this.layer;for(const l of e.features)l.layer=k,l.sourceLayer=k;return e})};c.queryObjectIds=
function(a,b){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(a),null==b?void 0:b.signal)};c._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};c._createQueryEngine=function(){const a=I.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new K["default"]({layerView:this,task:D.Task.FEATURE_QUERY_ENGINE,spatialIndex:new M["default"]({featureAdapter:new L.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,
attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:a}),forAllFeatures:(b,e)=>this._forAllFeatures((k,l,m)=>b({id:k,index:l,meta:m}),e,2),getFeatureExtent:a,sourceSpatialReference:H.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})};c.highlight=function(a){const b=this._highlights;if(a instanceof t){const {set:e,handle:k}=b.acquireSet();this.queryObjectIds(a).then(l=>b.setFeatureIds(e,l));return k}return n.prototype.highlight.call(this,a)};c.createInteractiveEditSession=
function(a){return w.createInteractiveEditSession(this.attributeEditingContext,a)};c._createLayerGraphic=function(a){a=new C(null,null,a);a.layer=this.layer;a.sourceLayer=this.layer;return a};c.canResume=function(){return n.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)};c.getFilters=function(){const a=n.prototype.getFilters.call(this);this.addSqlFilter(a,this.parsedDefinitionExpression,this.logError);h.isSome(this.viewFilter)&&this.viewFilter.addFilters(a,this.view,
this._controller.crsIndex,this._collection);return a};c._ensureQuery=function(a){return this._addDefinitionExpressionToQuery(h.isNone(a)?this.createQuery():t.from(a))};c._handleEdits=function(a){w.processAttributeEdits(this.attributeEditingContext,a)};u._createClass(p,[{key:"filter",get:function(){return h.isSome(this.viewFilter)?this.viewFilter.filter:null},set:function(a){h.isNone(a)||!v.I3SMeshViewFilter.checkSupport(a)?this.viewFilter=null:h.isSome(this.viewFilter)?this.viewFilter.filter=a:this.viewFilter=
new v.I3SMeshViewFilter({filter:a,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:b=>this._loadAsyncModule(b),applyFilters:()=>this._applyFilters(!0),addSqlFilter:(b,e)=>this.addSqlFilter(b,e,this.logError)})}},{key:"lodCrossfadeinDuration",get:function(){var a,b;return null!=(a=null==(b=this.view)?void 0:b.qualitySettings.sceneService["3dObject"].lodCrossfadeinDuration)?a:0}},{key:"lodCrossfadeoutDuration",get:function(){var a,b;return null!=(a=null==(b=this.view)?void 0:b.qualitySettings.sceneService["3dObject"].lodCrossfadeoutDuration)?
a:0}},{key:"lodCrossfadeUncoveredDuration",get:function(){var a,b;return null!=(a=null==(b=this.view)?void 0:b.qualitySettings.sceneService["3dObject"].lodCrossfadeUncoveredDuration)?a:0}},{key:"attributeEditingContext",get:function(){return{fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:a=>this._forAllNodes(b=>h.isSome(b)?a(b.node,b.featureIds):null),attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this.attributeOverrides,getAttributeData:a=>
this.getAttributeData(a),setAttributeData:(a,b)=>this.setAttributeData(a,b),clearMemCache:()=>this.clearMemCache()}}}]);return p}(J.I3SMeshView3D(N.DefinitionExpressionSceneLayerView(O.PopupSceneLayerView(d.LayerView3D(G)))));f.__decorate([g.property()],d.prototype,"layer",void 0);f.__decorate([g.property({aliasOf:"layer"})],d.prototype,"i3slayer",void 0);f.__decorate([g.property({dependsOn:["_controller.rootNodeVisible"]})],d.prototype,"suspended",void 0);f.__decorate([g.property(E.updatingProgress)],
d.prototype,"updatingProgress",void 0);f.__decorate([g.property({type:F})],d.prototype,"filter",null);f.__decorate([g.property()],d.prototype,"viewFilter",void 0);f.__decorate([g.property(q.requiredFields)],d.prototype,"requiredFields",void 0);f.__decorate([g.property(q.availableFields)],d.prototype,"availableFields",void 0);f.__decorate([g.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],d.prototype,"lodFactor",void 0);f.__decorate([g.property({readOnly:!0,
aliasOf:"_controller.updatingProgress"})],d.prototype,"updatingProgressValue",void 0);return d=f.__decorate([A.subclass("esri.views.3d.layers.SceneLayerView3D")],d)});