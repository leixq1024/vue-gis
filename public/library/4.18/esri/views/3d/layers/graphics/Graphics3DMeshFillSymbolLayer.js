// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/maybe ../../../../Color ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/mat4 ../../../../geometry/projection ../../../../chunks/mat3f64 ../../../../chunks/mat4f64 ../../../../chunks/vec4f64 ../../../../geometry/support/MeshMaterialMetallicRoughness ../../../../geometry/support/MeshComponent ../../../../chunks/mat3 ../../../../geometry/support/meshUtils/projection ../../../../geometry/support/aaBoundingBox ../../webgl-engine/lib/Util ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../support/debugFlags ./elevationAlignmentUtils ./ElevationAligners ./ElevationContext ./Graphics3DObject3DGraphicLayer ../../webgl-engine/lib/Geometry ../support/edgeUtils ./Graphics3DSymbolLayer ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/lib/Texture ../support/symbolColorUtils ../../webgl-engine/materials/NativeLineMaterial".split(" "),
function(M,Z,F,A,G,z,v,aa,H,ba,E,R,ca,da,S,T,I,ea,N,fa,U,V,ha,ia,ja,O,ka,la,ma,na,W,X){const n=ea.VertexAttrConstants;F=function(P){function J(a,b,c,d){a=P.call(this,a,b,c,d)||this;a._materials=new Map;a._textures=new Map;a.ensureDrapedStatus(!1);return a}Z._inheritsLoose(J,P);var g=J.prototype;g.doLoad=async function(){U.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new X.NativeLineMaterial({color:[1,0,1,1]},"debugVertexNormal"),this._debugFaceNormalMaterial=new X.NativeLineMaterial({color:[0,
1,1,1]},"debugFAceNormal"))};g.destroy=function(){P.prototype.destroy.call(this);this._materials.forEach(a=>{this._context.stage.remove(3,a.material.id)});this._textures.forEach(a=>{this._context.stage.remove(4,a.id)});this._materials.clear();this._textures.clear()};g.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometryType(b.geometry,J.validGeometryTypes,"fill on mesh-3d")||!this._validateGeometry(b.geometry))return null;const c="graphic"+b.uid,d=this.setGraphicElevationContext(b,
new ia.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,d,c,b.uid)};g.layerOpacityChanged=function(a,b){const c=this._getLayerOpacity();this._materials.forEach(d=>{d.material.setParameterValues({layerOpacity:c});const e=d.material.params;this._setMaterialTransparentParameter(e,d);d.material.setParameterValues({transparent:e.transparent})});a.forEach(d=>{d=b(d);A.isSome(d)&&d.layerOpacityChanged(c,this._context.isAsync)});return!0};g.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,
b,V.needsElevationUpdates3D)};g.slicePlaneEnabledChanged=function(a,b){this._materials.forEach(c=>{c.material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})});a.forEach(c=>{c=b(c);A.isSome(c)&&c.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0};g.physicalBasedRenderingChanged=function(){this._materials.forEach(a=>{const {isSchematic:b}=a.material.params;a.material.setParameterValues({usePBR:this._usePBR(b)})});return!0};g.pixelRatioChanged=
function(){return!0};g._requiresSymbolVertexColors=function(){return this._drivenProperties.color||this._drivenProperties.opacity};g._colorOrTextureUid=function(a){return a?a instanceof G?a.toHex():a.contentHash:"-"};g._materialPropertiesDefault=function(a,b){const c=this._requiresSymbolVertexColors(),d=!!a.vertexAttributes.color;a=!!a.vertexAttributes.tangent;return{hasSymbolVertexColors:c,hasVertexColors:d,hasVertexTangents:a,uid:`vc:${d},vt:${a},vct${b},svc:${c}`}};g._materialProperties=function(a,
b,c){a=this._materialPropertiesDefault(a,c);if(!b.material)return a;const {color:d,colorTexture:e,normalTexture:f,doubleSided:h,alphaCutoff:m,alphaMode:u}=b.material;c=this._colorOrTextureUid(d);var w=this._colorOrTextureUid(e),l=this._colorOrTextureUid(f);a.color=d;a.colorTexture=e;a.normalTexture=f;a.uid=`${a.uid},cmuid:${c},ctmuid:${w},ntmuid:${l},ds:${h},ac:${m},am:${u}`;if(b.material instanceof ca){const {metallic:y,roughness:p,metallicRoughnessTexture:t,emissiveColor:q,emissiveTexture:x,occlusionTexture:r}=
b.material;b=this._colorOrTextureUid(t);c=this._colorOrTextureUid(q);w=this._colorOrTextureUid(x);l=this._colorOrTextureUid(r);a.metallic=y;a.roughness=p;a.metallicRoughnessTexture=t;a.emissiveColor=q;a.emissiveTexture=x;a.occlusionTexture=r;a.uid=`${a.uid},mrm:${y},mrr:${p},mrt:${b},emuid:${c},etmuid:${w},otmuid:${l}`}return a};g._setInternalColorValueParameters=function(a,b){b.diffuse=G.toUnitRGB(a);b.opacity=a.a};g._getLoadableTextureResource=function(a){return a.data?a.data:a.url};g._getInternalTextureId=
function(a,b){const c=this._getLoadableTextureResource(a);if(c){var d=a.contentHash,e=this._textures.get(d);e||(e=new na(c,`${b}_${d}_tex`,{mipmap:!0,wrap:this._castTextureWrap(a.wrap),noUnpackFlip:!0,preMultiplyAlpha:!0}),this._textures.set(d,e),this._context.stage.add(4,e));return e.id}};g._castTextureWrap=function(a="repeat"){return"string"===typeof a?(a=this._castTextureWrapIndividual(a),{s:a,t:a}):{s:this._castTextureWrapIndividual(a.horizontal),t:this._castTextureWrapIndividual(a.vertical)}};
g._castTextureWrapIndividual=function(a){switch(a){case "clamp":return 33071;case "mirror":return 33648;default:return 10497}};g._setInternalMaterialParameters=function(a,b,c){a.color&&this._setInternalColorValueParameters(a.color,c);a.colorTexture&&(c.textureId=this._getInternalTextureId(a.colorTexture,b));a.normalTexture&&(c.normalTextureId=this._getInternalTextureId(a.normalTexture,b));a.emissiveColor&&(c.emissiveFactor=G.toUnitRGB(a.emissiveColor));a.emissiveTexture&&(c.emissiveTextureId=this._getInternalTextureId(a.emissiveTexture,
b));a.occlusionTexture&&(c.occlusionTextureId=this._getInternalTextureId(a.occlusionTexture,b));a.metallicRoughnessTexture&&(c.metallicRoughnessTextureId=this._getInternalTextureId(a.metallicRoughnessTexture,b))};g._setExternalMaterialParameters=function(a){var b=this._drivenProperties.color;let c=A.isSome(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;b?a.externalColor=R.ONES:(b=A.isSome(this.symbolLayer.material)?this.symbolLayer.material.color:null,A.isSome(b)?a.externalColor=
G.toUnitRGBA(b):(c=null,a.externalColor=R.ONES));c&&(a.colorMixMode=c);a.castShadows=!!this.symbolLayer.castShadows};g._hasTransparentVertexColors=function(a){a=a.vertexAttributes.color;if(!a)return!1;for(let b=3;b<a.length;b+=4)if(255!==a[b])return!0;return!1};g._getOrCreateMaterial=function(a,b){var c=b.material&&b.material.color,d=b.material&&b.material.colorTexture,e=b.material&&"blend"===b.material.alphaMode;c=!(b.material&&"opaque"===b.material.alphaMode)&&(this._hasTransparentVertexColors(a)||
c&&1>c.a||d&&d.transparent||e);a=this._materialProperties(a,b,c);if(d=this._materials.get(a.uid))return d.material;c={material:null,isComponentTransparent:c,alphaMode:b.material?b.material.alphaMode:"opaque"};d=this._getIdHint();e=null==a.metallicRoughnessTexture&&null==a.metallic&&null==a.roughness;const f={usePBR:this._usePBR(e),isSchematic:e,vertexColors:a.hasVertexColors,symbolColors:a.hasSymbolVertexColors,vertexTangents:a.hasVertexTangents,ambient:z.ZEROS,diffuse:z.ONES,opacity:1,doubleSided:!0,
doubleSidedType:"winding-order",cullFace:0,textureAlphaPremultiplied:!0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};e||(f.mrrFactors=[null!=a.metallic?a.metallic:1,null!=a.roughness?a.roughness:1,.5]);b.material&&(f.doubleSided=b.material.doubleSided,f.cullFace=b.material.doubleSided?0:2,f.textureAlphaCutoff=b.material.alphaCutoff);this._setInternalMaterialParameters(a,d,f);this._setExternalMaterialParameters(f);this._setMaterialTransparentParameter(f,
c);b=new ma.DefaultMaterial(f,`${d}_${a.uid}_mat`);c.material=b;this._materials.set(a.uid,c);this._context.stage.add(3,b);return b};g._usePBR=function(a){return a?this._context.physicalBasedRenderingEnabled:!0};g._setMaterialTransparentParameter=function(a,b){a.transparent=this.needsDrivenTransparentPass||b.isComponentTransparent||1>a.layerOpacity||1>a.opacity||a.externalColor&&1>a.externalColor[3];a.textureAlphaMode="auto"===b.alphaMode?a.transparent?3:1:"opaque"===b.alphaMode?1:"mask"===b.alphaMode?
2:0};g._addDebugNormals=function(a,b,c,d){var e=b.length,f=a.spatialReference.isGeographic?20015077/180:1;const h=.1*Math.max(a.extent.width*f,a.extent.height*f,a.extent.zmax-a.extent.zmin),m=[];var u=[];f=[];a=[];for(let q=0;q<e;q++){var w=b[q],l=w.data.getAttribute(n.POSITION),y=w.data.getAttribute(n.NORMAL);const x=w.data.getIndices(n.POSITION);w=w.data.getIndices(n.NORMAL);l=l.data;y=y.data;for(let r=0;r<x.length;r++){var p=3*x[r];const oa=3*w[r];for(var t=0;3>t;t++)m.push(l[p+t]);for(t=0;3>t;t++)m.push(l[p+
t]+y[oa+t]*h);u.push(u.length);u.push(u.length);if(0===r%3){this._calculateFaceNormal(l,x,r,B);this._getFaceVertices(l,x,r,k,C,D);v.add(k,k,C);v.add(k,k,D);v.scale(k,k,1/3);for(p=0;3>p;p++)f.push(k[p]);for(p=0;3>p;p++)f.push(k[p]+B[p]*h);a.push(a.length);a.push(a.length)}}}e={[n.POSITION]:{data:new Float64Array(m),size:3}};u={[n.POSITION]:new Uint32Array(u)};e=new N.GeometryData(e,u,"line");e=new O(e,"debugVertexNormal");b.push(e);c.push(this._debugVertexNormalMaterial);d.push(E.clone(d[0]));f={[n.POSITION]:{data:new Float64Array(f),
size:3}};a={[n.POSITION]:new Uint32Array(a)};a=new N.GeometryData(f,a,"line");a=new O(a,"debugFaceNormal");b.push(a);c.push(this._debugFaceNormalMaterial);d.push(E.clone(d[0]))};g._createAs3DShape=function(a,b,c,d,e){a=a.geometry;if("mesh"!==a.type)return null;b=this._createGeometryInfo(a,b,d);if(!b)return null;const {geometries:f,materials:h,transformations:m,objectTransformation:u}=b;U.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(a,f,h,m);e=new fa({geometries:f,materials:h,transformations:m,
castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:e},idHint:d});e.objectTransformation=u;d=ha.perObjectElevationAligner;b=this._createEdgeMaterial();b=A.isSome(b)?{baseMaterial:h[0],edgeMaterials:[b],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null;e=new ja(this,e,f,null,null,d,c,b);e.needsElevationUpdates=V.needsElevationUpdates3D(c.mode);c=a.extent.center.clone();c.z=0;e.elevationContext.centerPointInElevationSR=c;e.alignedSampledElevation=
d(e,e.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper);return e};g._createComponentNormals=function(a,b,c,d){switch(c.shading||"flat"){case "source":return this._createComponentNormalsSource(a,b,c,d);case "flat":return this._createComponentNormalsFlat(a,d);case "smooth":return this._createComponentNormalsSmooth(a,d)}};g._createComponentNormalsSource=function(a,b,c,d){if(!b)return this._createComponentNormalsFlat(a,d);let e=!1;if(!c.trustSourceNormals)for(c=0;c<d.length;c+=
3){this._calculateFaceNormal(a,d,c,B);for(let f=0;3>f;f++){const h=3*d[c+f];k[0]=b[h+0];k[1]=b[h+1];k[2]=b[h+2];0>v.dot(B,k)&&(b[h+0]=-b[h+0],b[h+1]=-b[h+1],b[h+2]=-b[h+2],e=!0)}}return{normals:b,indices:d,didFlipNormals:e}};g._createComponentNormalsFlat=function(a,b){const c=new Float32Array(b.length),d=new Uint32Array(3*b.length);for(let e=0;e<b.length;e+=3){const f=this._calculateFaceNormal(a,b,e,B);for(let h=0;3>h;h++)c[e+h]=f[h],d[e+h]=e/3}return{normals:c,indices:d,didFlipNormals:!1}};g._createComponentNormalsSmooth=
function(a,b){const c={};for(var d=0;d<b.length;d+=3){var e=this._calculateFaceNormal(a,b,d,B);for(var f=0;3>f;f++){var h=b[d+f];let m=c[h];m||(m={normal:z.create(),count:0},c[h]=m);v.add(m.normal,m.normal,e);m.count++}}a=new Float32Array(3*b.length);d=new Uint32Array(3*b.length);for(e=0;e<b.length;e++){f=c[b[e]];1!==f.count&&(v.normalize(f.normal,f.normal),f.count=1);for(h=0;3>h;h++)a[3*e+h]=f.normal[h];d[e]=e}return{normals:a,indices:d,didFlipNormals:!1}};g._getFaceVertices=function(a,b,c,d,e,f){const h=
3*b[c+0],m=3*b[c+1];b=3*b[c+2];d[0]=a[h+0];d[1]=a[h+1];d[2]=a[h+2];e[0]=a[m+0];e[1]=a[m+1];e[2]=a[m+2];f[0]=a[b+0];f[1]=a[b+1];f[2]=a[b+2]};g._calculateFaceNormal=function(a,b,c,d){this._getFaceVertices(a,b,c,k,C,D);v.subtract(C,C,k);v.subtract(D,D,k);v.cross(k,C,D);v.normalize(d,k);return d};g._getOrCreateComponents=function(a){return a.components?a.components:pa};g._createPositionBuffer=function(a){const b=a.vertexAttributes.position,c=new Float64Array(b.length);H.projectBuffer(a.vertexAttributes.position,
a.spatialReference,0,c,this._context.renderCoordsHelper.spatialReference,0,b.length/3);return c};g._createNormalBuffer=function(a,b){const c=a.vertexAttributes.normal;if(!c)return null;if("local"===this._context.layerView.view.viewingMode)return c;const d=a.vertexAttributes.position,e=new Float32Array(c.length);return T.projectNormalToECEF(c,d,b,a.spatialReference,e)};g._createTangentBuffer=function(a,b){const c=a.vertexAttributes.tangent;if(!c)return null;if("local"===this._context.layerView.view.viewingMode)return c;
const d=a.vertexAttributes.position,e=new Float32Array(c.length);return T.projectTangentToECEF(c,d,b,a.spatialReference,e)};g._createColorBuffer=function(a){return a.vertexAttributes.color};g._createSymbolColorBuffer=function(a){if(this._requiresSymbolVertexColors()){a=this._getVertexOpacityAndColor(a);const b=W.parseColorMixMode(A.get(this.symbolLayer,"material","colorMixMode")),c=new Uint8Array(4);W.encodeSymbolColor(a,b,c);return c}return null};g._createColorIndices=function(a){a=new Uint32Array(a.length);
for(let b=0;b<a.length;b++)a[b]=0;return a};g._createBuffers=function(a,b){var c=a.vertexAttributes&&a.vertexAttributes.position;if(!c)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;var d=a.vertexAttributes.normal;const e=a.vertexAttributes.uv;var f=a.vertexAttributes.tangent;if(d&&d.length!==c.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(f&&f.length/4!==c.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),
null;if(e&&e.length/2!==c.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;c=this._createPositionBuffer(a);d=this._createColorBuffer(a);b=this._createSymbolColorBuffer(b);f=this._createNormalBuffer(a,c);const h=this._createTangentBuffer(a,c);a=this._transformCenterLocal(a,c,f);return{positionBuffer:c,normalBuffer:f,tangentBuffer:h,uvBuffer:e,colorBuffer:d,symbolColorBuffer:b,objectTransformation:a}};g._transformCenterLocal=
function(a,b,c){var d=a.extent.center;const e=this._context.renderCoordsHelper.spatialReference;K[0]=d.x;K[1]=d.y;K[2]=0;d=E.create();H.computeLinearTransformation(a.spatialReference,K,d,e);aa.invert(Y,d);for(a=0;a<b.length;a+=3)k[0]=b[a+0],k[1]=b[a+1],k[2]=b[a+2],v.transformMat4(k,k,Y),b[a+0]=k[0],b[a+1]=k[1],b[a+2]=k[2];if(c)for(S.fromMat4(L,d),S.transpose(L,L),b=0;b<c.length;b+=3)k[0]=c[b+0],k[1]=c[b+1],k[2]=c[b+2],v.transformMat3(k,k,L),c[b+0]=k[0],c[b+1]=k[1],c[b+2]=k[2];return d};g._validateFaces=
function(a,b){a=a.vertexAttributes.position.length/3;if(b=b.faces){let c=-1;for(let d=0;d<b.length;d++){const e=b[d];e>c&&(c=e)}if(a<=c)return this.logger.warn(`Vertex index ${c} is out of bounds of the mesh position buffer`),!1}else if(0!==a%3)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0};g._getOrCreateFaces=function(a,b){if(b.faces)return b.faces;a=new Uint32Array(a.vertexAttributes.position.length/
3);for(b=0;b<a.length;b++)a[b]=b;return a};g._isOutsideClippingArea=function(a){if(!this._context.clippingExtent)return!1;var b=a.vertexAttributes&&a.vertexAttributes.position;if(!b)return!1;const c=this._context.elevationProvider.spatialReference,d=b.length/3;a.spatialReference.equals(c)||(b=new Float64Array(b.length),H.projectBuffer(a.vertexAttributes.position,a.spatialReference,0,b,c,0,d));I.empty(Q);I.expandWithBuffer(Q,b,0,d);return!I.intersectsClippingArea(Q,this._context.clippingExtent)};g._createGeometryInfo=
function(a,b,c){if(!H.canProjectWithoutEngine(a.spatialReference,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(a))return null;b=this._createBuffers(a,b);if(!b)return null;const {positionBuffer:d,uvBuffer:e,colorBuffer:f,symbolColorBuffer:h,normalBuffer:m,tangentBuffer:u,objectTransformation:w}=b;var l=this._getOrCreateComponents(a);b=[];const y=[],p=[];let t=!1;for(const x of l){if(!this._validateFaces(a,
x))return null;l=this._getOrCreateFaces(a,x);if(0===l.length)continue;var q=this._createComponentNormals(d,m,x,l);q.didFlipNormals&&(t=!0);const r={[n.POSITION]:{size:3,data:d},[n.NORMAL]:{size:3,data:q.normals}};q={[n.POSITION]:l,[n.NORMAL]:q.indices};f&&(r[n.COLOR]={size:4,data:f},q[n.COLOR]=l);h&&(r[n.SYMBOLCOLOR]={size:4,data:h},q[n.SYMBOLCOLOR]=this._createColorIndices(l));a.vertexAttributes.uv&&(r[n.UV0]={size:2,data:e},q[n.UV0]=l);a.vertexAttributes.tangent&&(r[n.TANGENT]={size:4,data:u},q[n.TANGENT]=
l);l=new N.GeometryData(r,q);l=new O(l,`${c}_mesh`);b.push(l);y.push(E.create());p.push(this._getOrCreateMaterial(a,x))}t&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals.");return{geometries:b,transformations:y,materials:p,objectTransformation:w}};g._createEdgeMaterial=function(){const a={opacity:this._getLayerOpacity()};return ka.createMaterial(this.symbolLayer,
a)};return J}(la.Graphics3DSymbolLayer);F.validGeometryTypes=["mesh"];const K=z.create(),k=z.create(),C=z.create(),D=z.create(),B=z.create(),Y=E.create(),L=ba.create(),Q=I.create(),pa=[new da];M.Graphics3DMeshFillSymbolLayer=F;M.default=F;Object.defineProperty(M,"__esModule",{value:!0})});