// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/PooledArray ../../../../core/Accessor ../../../../core/mathUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../geometry/projectionEllipsoid ../../../../chunks/mat4 ../../../../geometry/support/aaBoundingRect ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec4f64 ../../../../chunks/vec4 ../../../../chunks/sphere ../../support/geometryUtils ../../webgl-engine/lib/Util ../../webgl-engine/lib/Camera ../../support/debugFlags ./deconflictorDebug ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/materials/HUDMaterial".split(" "),
function(n,z,A,ia,w,ja,ka,E,la,L,ma,na,oa,F,M,G,r,t,N,O,p,P,Q,H,x,R,u,I,S,T,B,U,V){function*J(h){if(Map.prototype.entries){h=h.entries();for(let k=h.next();!k.done;k=h.next())yield k.value[1]}else yield*h.values()}function*W(h,k,g){k.clear();h.forEach((c,b)=>{const d=k.pushNew();d.id=b;d.prio=c.info?-c.info[g].distance:Number.MAX_VALUE});yield;const a=k.iterableSort((c,b)=>b.prio-c.prio);for(let c=a.next();!c.done;c=a.next())yield;k.forAll(c=>{const b=h.get(c.id);b&&(h.delete(c.id),h.set(c.id,b))});
k.clear()}const m=r.create(),v=H.create(),y=H.create(),C=r.create(),X=P.create(),Y=u.sphere.create(),D=u.ray.create(),Z=r.create(),aa=p.create();let ba=function(){this.aabr=p.create();this.distance=0;this.visible=this.culled=!1},ca=function(){function h(){this.active=new Map;this.visible=new Map}h.prototype.clear=function(){this.active.clear();this.visible.clear()};return h}(),da=function(){},ea=function(){this.sortArray=new F({allocator:h=>h||new da})},K=function(){function h(){this.camera=new S;
this.slicePlane=u.boundedPlane.create();this.slicePlaneEnabled=!1}h.prototype.copyFrom=function(k){this.camera.copyFrom(k.camera);u.boundedPlane.copy(k.slicePlane,this.slicePlane);this.slicePlaneEnabled=k.slicePlaneEnabled};return h}();n.Deconflictor=function(h){function k(){var a=h.apply(this,arguments)||this;a._dirty=!1;a._runningViewState=new K;a._state=0;a.graphics=new ca;a.iterators=new ea;a.accBinsNumX=15;a.accBinsNumY=20;a.accBinsSizeX=0;a.accBinsSizeY=0;a.accBins=null;a.accNumTests=0;return a}
z._inheritsLoose(k,h);var g=k.prototype;g.destroy=function(){this.graphics.clear();this.iterators=null};g.setDirty=function(){!this._dirty&&0<this.graphics.active.size&&(this._dirty=!0,this.notifyChange("updating"))};g.needsUpdate=function(){return this.view.ready&&null!=this.view.state&&this.updating};g.update=function(a){switch(this._state){case 0:this.startUpdate(),a.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(a))break;case 2:if(this._state=2,!this.sortVisibleGraphics(a))break;
case 3:if(this._state=3,!this.deconflictVisibleGraphics(a))break;default:B.drawAccelerationStruct(this,this.graphics.visible),this._state=0,this.notifyChange("updating")}};g.modifyGraphics=function(a,c){c?a.forEach(b=>this.addToActiveGraphics(b)):a.forEach(b=>this.removeFromActiveGraphics(b));this.setDirty()};g.layerSupportsDeconfliction=function(a){if(w.isNone(a)||"object3d"!==a.type)return!1;a=a.stageObject;return 1===(a?a.getNumGeometryRecords():0)&&a.getGeometryRecord(0).material instanceof V.HUDMaterial?
!0:!1};g.startUpdate=function(){B.prepare(this.view);this._dirty=!1;this._runningViewState.copyFrom(this.viewState);const {fullWidth:a,fullHeight:c}=this._runningViewState.camera;this.initBins(a,c);this.resetIterators()};g.addToActiveGraphics=function(a){a.info[this.visibilityGroup]=new ba;this.graphics.active.set(a.graphics3DGraphic.graphic.uid,a);this.setDirty()};g.removeFromActiveGraphics=function(a){this.removeFromVisibleGraphics(a);{const c=a.graphics3DGraphic;c.destroyed||c.clearVisibilityFlag(3,
this.visibilityGroup)}delete a.info[this.visibilityGroup];this.graphics.active.delete(a.graphics3DGraphic.graphic.uid);this.setDirty()};g.addToVisibleGraphics=function(a){this.graphics.visible.set(a.graphics3DGraphic.graphic.uid,a)};g.removeFromVisibleGraphics=function(a){this.graphics.visible.delete(a.graphics3DGraphic.graphic.uid)};g.processActiveGraphics=function(a){const c=this.ensureActiveGraphicsIterator(),b=O.invert(X,this._runningViewState.camera.projectionMatrix),d="global"===this.view.viewingMode&&
1===this.view.map.ground.opacity&&0<this._runningViewState.camera.relativeElevation?Y:null;let e=0;w.isSome(d)&&(t.transformMat4(d.center,r.ZEROS,this._runningViewState.camera.viewMatrix),d.radius=N.getReferenceEllipsoid(this.view.spatialReference).radius,e=u.sphere.distanceToSilhouette(d,r.ZEROS));for(;!a.done;){a.madeProgress();var f=c.next();if(f.done)return this.resetActiveGraphicsIterator(),!0;const l=(f=f.value)&&f.info[this.visibilityGroup];l&&(this.collectGraphics3DGraphics(f,b,d,e),l.culled?
this.removeFromVisibleGraphics(f):this.addToVisibleGraphics(f))}return!1};g.sortVisibleGraphics=function(a){const c=this.ensureSortGraphicsIterator();for(;!a.done;){const b=c.next();a.madeProgress();if(b.done)return this.resetSortGraphicsIterator(),!0}return!1};g.deconflictVisibleGraphics=function(a){const c=this.ensureVisibleGraphicsIterator(),b=1===this.visibilityGroup;for(;!a.done;){a.madeProgress();var d=c.next();if(d.done)return this.resetVisibleGraphicsIterator(),!0;d=d.value;const f=d.info[this.visibilityGroup];
if(f&&!f.culled){var e=d.graphics3DGraphic;(e=(!b||e.isVisible())&&!this.isConflicted(d))&&this.addToBins(d);f.visible=e;this.setGraphicVisibility(d,e);B.drawPoly(f,e)}}return!1};g.resetIterators=function(){this.iterators.active=null;this.iterators.visible=null;this.iterators.sort=null};g.ensureActiveGraphicsIterator=function(){this.iterators.active||(this.iterators.active=J(this.graphics.active));return this.iterators.active};g.resetActiveGraphicsIterator=function(){this.iterators.active=null};g.ensureVisibleGraphicsIterator=
function(){this.iterators.visible||(this.iterators.visible=J(this.graphics.visible));return this.iterators.visible};g.resetVisibleGraphicsIterator=function(){this.iterators.visible=null};g.ensureSortGraphicsIterator=function(){this.iterators.sort||(this.iterators.sort=W(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup));return this.iterators.sort};g.resetSortGraphicsIterator=function(){this.iterators.sort=null};g.collectGraphics3DGraphics=function(a,c,b,d){var e=a.graphics3DGraphic;
if(!e.destroyed){var f=a.info[this.visibilityGroup];if(e.isVisible(0,3)){var l=this.getGraphicsLayers(e);p.empty(f.aabr);e=null;for(const q of l)if(this.layerSupportsDeconfliction(q)){l=q.stageObject.getGeometryRecord(0).material;if(w.isNone(e)){e=this.getProjectionInfo(q,c,fa);if(e.isOutsideScreen||this.isCulledBySlice(a,m)||w.isSome(b)&&this.isCulledByHorizon(e,b,d)){f.culled=!0;return}!T.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&f.visible&&(e.distance*=.7)}this.expandBoundingRect(f,q,l,e)}w.isNone(e)?
f.culled=!0:(f.distance=e.distance,f.culled=!1)}else f.culled=!0}};g.getProjectionInfo=function(a,c,b){const d=this._runningViewState.camera;a=a.stageObject;var e=a.getGeometryRecord(0);const f=e.material;var l=a.getCenter();t.transformMat4(m,l,d.viewMatrix);e=e.geometry.data.getVertexAttr();l=e[I.VertexAttrConstants.AUXPOS1].data;f.applyShaderOffsetsView(m,e[I.VertexAttrConstants.NORMAL].data,a.objectTransformation,l,d,b.scaleInfo,m);x.set(v,m[0],m[1],m[2],1);x.transformMat4(y,v,d.projectionMatrix);
t.scale(b.positionNDC,y,1/y[3]);f.applyShaderOffsetsNDC(b.positionNDC,l,d,b.positionNDC,C);b.distanceWithoutPolygonOffset=d.depthNDCToWorld(C[2]);b.distance=C[2]===b.positionNDC[2]?b.distanceWithoutPolygonOffset:d.depthNDCToWorld(b.positionNDC[2]);x.set(y,b.positionNDC[0],b.positionNDC[1],b.positionNDC[2],1);x.transformMat4(v,y,c);x.scale(v,v,1/v[3]);t.set(b.positionView,m[0],m[1],m[2]);return b};g.isCulledByHorizon=function(a,c,b){t.copy(D.direction,a.positionView);t.set(D.origin,0,0,0);return R.intersectRay(c,
D,Z)?a.distanceWithoutPolygonOffset>b:!1};g.isCulledBySlice=function(a,c){return a.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&u.boundedPlane.extrusionContainsPoint(this._runningViewState.slicePlane,c)};g.expandBoundingRect=function(a,c,b,{positionNDC:d,scaleInfo:e}){const f=this._runningViewState.camera;c=c.getScreenSize(ha);U.applyPrecomputedScaleFactor(c,e.factor,c);c[0]*=f.pixelRatio;c[1]*=f.pixelRatio;b=p.offset(b.calculateRelativeScreenBounds(c,e.factorAlignment.scale,aa),G.lerp(0,
f.fullWidth,.5+.5*d[0]),G.lerp(0,f.fullHeight,.5+.5*d[1]));d=this.iconMarginFactor;0!==d&&(d*=Math.min(p.width(b),p.height(b)),b[0]-=d,b[1]-=d,b[2]+=d,b[3]+=d);p.expand(a.aabr,b)};g.isConflicted=function(a){const c=a.graphics3DGraphic.graphic.uid;a=a.info[this.visibilityGroup];for(let b=Math.floor(a.aabr[0]/this.accBinsSizeX);b<=Math.floor(a.aabr[2]/this.accBinsSizeX);b++)if(!(0>b||b>=this.accBinsNumX))for(let d=Math.floor(a.aabr[1]/this.accBinsSizeY);d<=Math.floor(a.aabr[3]/this.accBinsSizeY);d++){if(0>
d||d>=this.accBinsNumY)continue;const e=this.accBins[b][d];for(let f=0;f<e.length;f++){const l=e.data[f],q=l.info[this.visibilityGroup];if(q&&q.visible&&l.graphics3DGraphic.graphic.uid!==c&&(this.accNumTests++,p.intersects(q.aabr,a.aabr)))return!0}}return!1};g.initBins=function(a,c){if(null==this.accBins){this.accBins=[];for(var b=0;b<this.accBinsNumX;b++){this.accBins.push([]);var d=this.accBins[this.accBins.length-1];for(let e=0;e<this.accBinsNumY;e++)d.push(new F)}}else for(b=0;b<this.accBinsNumX;b++)for(d=
0;d<this.accBinsNumY;d++)this.accBins[b][d].clear();this.accBinsSizeX=a/this.accBinsNumX;this.accBinsSizeY=c/this.accBinsNumY;this.accNumTests=0};g.addToBins=function(a){var c=a.info[this.visibilityGroup],b=Math.floor(c.aabr[0]/this.accBinsSizeX);const d=Math.floor(c.aabr[2]/this.accBinsSizeX),e=Math.floor(c.aabr[1]/this.accBinsSizeY);for(c=Math.floor(c.aabr[3]/this.accBinsSizeY);b<=d;b++)if(!(0>b||b>=this.accBinsNumX))for(let f=e;f<=c;f++)0>f||f>=this.accBinsNumY||this.accBins[b][f].push(a)};g.setGraphicVisibility=
function(a,c){a=a.graphics3DGraphic;a.destroyed||(a.setVisibilityFlag(3,c,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(a,c))};z._createClass(k,[{key:"dirty",get:function(){return this._dirty}},{key:"state",get:function(){return this._state}},{key:"updating",get:function(){return 0!==this._state||this._dirty}},{key:"updatingProgress",get:function(){if(!this.updating)return 1;const a=this._state/4;return this._dirty?.5*a:a}}]);return k}(M);A.__decorate([E.property({constructOnly:!0})],
n.Deconflictor.prototype,"view",void 0);A.__decorate([E.property({type:Boolean,readOnly:!0})],n.Deconflictor.prototype,"updating",null);n.Deconflictor=A.__decorate([L.subclass("esri.views.3d.layers.graphics.Deconflictor")],n.Deconflictor);const ha=Q.create(),fa=new (function(){function h(){this.positionView=r.create();this.positionNDC=r.create();this.distanceWithoutPolygonOffset=this.distance=0;this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,
minPixelSize:0,paddingPixels:0}}}z._createClass(h,[{key:"isOutsideScreen",get:function(){const k=this.positionNDC;return-1>k[0]||-1>k[1]||-1>k[2]||1<=k[0]||1<=k[1]}}]);return h}());n.DeconflictorGraphic=function(h,k,g={}){this.graphics3DGraphic=h;this.slicePlaneEnabled=k;this.info=g};n.DeconflictorViewState=K;Object.defineProperty(n,"__esModule",{value:!0})});