// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/lang ../../../../core/maybe ../../../../core/Error ../../../../core/urlUtils ../../../../core/promiseUtils ../../../../support/arcadeOnDemand ../../../../Color ../../../../symbols/CIMSymbol ../../../../core/screenUtils ../../../../symbols/support/IconSymbol3DLayerResource ../../../../chunks/symbols ../../../../core/asyncUtils ../../../../chunks/vec3f64 ../../../../symbols/support/utils ../../../../geometry/projection ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec4f64 ../../../../geometry/support/aaBoundingBox ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/materials/HUDMaterial ./graphicUtils ./elevationAlignmentUtils ./ElevationAligners ./ElevationContext ./Graphics3DObject3DGraphicLayer ../../webgl-engine/lib/Geometry ./Graphics3DSymbolLayer ./pointUtils ../../terrain/OverlayRenderer ../../../2d/arcade/callExpressionWithFeature ./constants ./Graphics3DDrapedGraphicLayer ./sdfPrimitives ../support/FastSymbolUpdates ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture".split(" "),
function(L,A,M,N,O,m,B,G,C,P,Q,R,u,S,v,T,p,U,V,W,D,X,Y,H,I,x,q,Z,aa,ba,ca,da,E,ea,fa,ha,ia,t,y,ja,J){function F(r){return m.isSome(r)?"cross"===r||"x"===r:!1}const ka=W.create(),K=p.fromValues(0,0,1),la=[.25,.25,.75,.75];v=function(r){function z(a,c,b,d){a=r.call(this,a,c,b,d)||this;a._cimLayers=null;a._cimSymbolMaterials=new Map;a._cimSymbolTextures=new Map;a._cimMaterialParametersInfo=null;a._cimRequiredFields=null;a._cimScaleFactorOrFunction=null;a._size=null;a._symbolTextureRatio=1;a._outlineSize=
0;a._texture=null;a._releaseTexture=null;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0};return a}M._inheritsLoose(z,r);var f=z.prototype;f.getCachedSize=function(){return{size:this._getIconSize()}};f.doLoad=async function(a){this._validateOrThrow();const c=this._prepareMaterialParameters();var b=this._getPrimitive();if(m.isSome(b))this._prepareResourcesPrimitive(c,b);else{b=U.getIconHref(this.symbol,this.symbolLayer);const d=G.dataComponents(b);d&&"application/json"===d.mediaType?
await this._prepareResourcesCIM(c,JSON.parse(d.data),a):await this._prepareResourcesHref(c,b,a)}};f._validateOrThrow=function(){if(!this._drivenProperties.size){var a=x.validateSymbolLayerSize(this._getIconSize());if(a)throw new B("graphics3diconsymbollayer:invalid-size",a);}};f._getIconSize=function(){var a=this.symbolLayer;a=Math.round(null!=a.size?u.pt2px(a.size):16);return this._drivenProperties.size?Math.max(a,64):a};f._generateTextureCIM=function(a){const c=this._getGraphicHash(a);let b=""===
c?null:this._cimSymbolTextures.get(c);b||(a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,a,"esriGeometryPoint",{scaleFactor:this._cimScaleFactorOrFunction},null,null),this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",a.anchorPosition),b=new J(a.imageData,"symbol",{width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:2}),this._cimSymbolTextures.set(c,b),this._context.stage.add(4,b));return b};f._computeSize=function(a,
c){a=a.width/a.height;return 1<a?[c,Math.round(c/a)]:[Math.round(c*a),c]};f._prepareMaterialParameters=function(){const a={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},c=this.symbol;if(c&&"point-3d"===c.type&&c.hasVisibleVerticalOffset()){const {screenLength:b,minWorldLength:d,maxWorldLength:e}=c.verticalOffset;a.verticalOffset={screenLength:u.pt2px(b),minWorldLength:d||0,maxWorldLength:null!=e?e:Infinity}}this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=
this._context.sharedResources.screenSizePerspectiveSettings);a.occlusionTest=!0;a.slicePlaneEnabled=this._context.slicePlaneEnabled;return a};f._prepareResourcesPrimitive=function(a,c){var b=this._getOutlineSize();if(F(c)&&0===b)throw Error("Nothing to render");this._outlineSize=b;a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;const d=this._context.sharedResources.textures.fromData(c,()=>{switch(c){case "circle":var e=t.createCircle(128,64);break;
case "square":e=t.createSquare(128,64);break;case "kite":e=t.createKite(128,64);break;case "cross":e=t.createCross(128,64);break;case "x":e=t.createX(128,64);break;case "triangle":e=t.createTriangle(128,64)}return e=new J(e,"sdf_"+c,{mipmap:!1,wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})});this._texture=d.texture;this._releaseTexture=()=>this._context.sharedResources.textures.release(d.uid);a.textureIsSignedDistanceField=!0;a.distanceFieldBoundingBox=la;a.textureId=this._texture.id;
b=this._getIconSize();this._size=[b,b];this._symbolTextureRatio=2;this._createMaterialAndAddToStage(a,this._context.stage)};f._prepareResourcesHref=async function(a,c,b){if(!N("esri-canvas-svg-support")&&G.isSVG(c))throw new B("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize();a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;a.textureIsSignedDistanceField=
!1;const d=this._getIconSize();b=await T.result(this._context.sharedResources.textures.fromUrl(c,d*this._context.layerView.view.pixelRatio,{signal:b}));if(!1===b.ok)throw C.throwIfAbortError(b.error),new B("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${c})`);const {uid:e,texture:g}=b.value;this._releaseTexture=()=>this._context.sharedResources.textures.release(e);this._size=this._computeSize(g.params,d);a.textureId=g.id;this._createMaterialAndAddToStage(a,
this._context.stage)};f._prepareResourcesCIM=async function(a,c,b){c=new R({data:c});if(!this._context.sharedResources.cimSymbolRasterizer){var d=(await new Promise(function(l,h){L(["../../../../symbols/cim/CIMSymbolRasterizer"],l,h)})).CIMSymbolRasterizer;C.throwIfAborted(b);this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new d(this._context.renderCoordsHelper.spatialReference,!0))}d=this._context.layer.fields?this._context.layer.fields.map(l=>
l.toJSON()):null;this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(c,d,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:b});let e;if(this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression)if(c=this._context.renderer,isNaN(c.scaleExpression)){const l=await P.createRendererExpression(c.scaleExpression,this._context.layer.spatialReference,
d);e=(h,n,w)=>{h=fa(l,h,{$view:w},"esriGeometryPoint",n);return null!==h?h:1}}else var g=Number(c.scaleExpression);this._cimScaleFactorOrFunction=g||e||1;g=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fields):[];C.throwIfAborted(b);const k=this._context.layer.fieldsIndex;this._cimRequiredFields=g.map(l=>k.get(l).name);this._cimMaterialParametersInfo=a;this._cimMaterialParametersInfo.color=this._getFillColor();this._cimMaterialParametersInfo.outlineColor=
[0,0,0,0];this._cimMaterialParametersInfo.outlineSize=0;this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1};f._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||S.defaultPrimitive};f._getOutlineSize=function(){var a=0;a=this.symbolLayer;if(m.isSome(a.outline)&&null!=a.outline.size)return Math.max(u.pt2px(a.outline.size),0);a=this._getPrimitive();a=F(a)?1.5:0;return Math.max(a,0)};
f._getOutlineColor=function(){const a=this._getLayerOpacity(),c=m.get(this.symbolLayer,"outline","color");if(m.isSome(c)){const b=Q.toUnitRGB(c);return[b[0],b[1],b[2],c.a*a]}return[0,0,0,0]};f._getFillColor=function(){if(F(this._getPrimitive()))return ha.TRANSPARENT_UNIT;const a=m.isNone(this._getPrimitive()),c=m.get(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(c,{hasIntrinsicColor:a})};f._getAnchorPos=function(a,c){return"relative"===a?D.fromValues((c.x||0)+.5,-(c.y||
0)+.5):a in x.namedAnchorToHUDMaterialAnchorPos?x.namedAnchorToHUDMaterialAnchorPos[a]:x.namedAnchorToHUDMaterialAnchorPos.center};f._createMaterialAndAddToStage=function(a,c){this._fastUpdates=this._cimLayers?{enabled:!1}:y.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled&&O.mixin(a,this._fastUpdates.materialParameters);if(this._cimLayers){let b=this._cimSymbolMaterials.get(a.textureId);b||(b=new I.HUDMaterial(a,this._getIdHint("_icon")),
this._cimSymbolMaterials.set(a.textureId,b),c.add(3,b));return b}this._material=new I.HUDMaterial(a,this._getIdHint("_icon"));c.add(3,this._material);return this._material};f._setDrapingDependentMaterialParameters=function(){this.draped&&(this._forEachMaterial(a=>{a.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())};f.destroy=function(){r.prototype.destroy.call(this);this._forEachMaterial(a=>
{this._context.stage.remove(3,a.id)});m.isSome(this._material)&&(this._material=null);this._cimSymbolMaterials.clear();this._cimSymbolTextures.forEach(a=>{this._context.stage.remove(4,a.id)});this._cimSymbolTextures.clear();this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)};f._getScaleFactor=function(a,c){if(this._drivenProperties.size&&a.size){for(let b=0;3>b;b++){const d=a.size[b];d&&"symbol-value"!==d&&"proportional"!==d&&(a.size[b]=u.pt2px(d))}if("symbol-value"===a.size[0])return 1;
if(isFinite(+a.size[0]))return+a.size[0]/c;if(isFinite(+a.size[2]))return+a.size[2]/c}return 1};f.createGraphics3DGraphic=function(a){var c=a.renderingInfo;const b=a.graphic;let d;if(this._cimLayers){if(!this._cimLayers.length)return null;var e=this._generateTextureCIM(b);d=this._createMaterialAndAddToStage({textureId:e.id,...this._cimMaterialParametersInfo},this._context.stage);var g=[e.params.width,e.params.height]}else g=this._size,d=m.unwrap(this._material);if(!this._validateGeometry(b.geometry))return null;
e=E.placePointOnGeometry(b.geometry);if(m.isNone(e))return this.logger.warn(`unsupported geometry type for icon symbol: ${b.geometry.type}`),null;const k="graphic"+b.uid,l=this._getVertexOpacityAndColor(c);let h=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(h=this._getScaleFactor(c,g[0]>g[1]?g[0]:g[1]));h*=this._symbolTextureRatio;c=[g[0]*h,g[1]*h];g=this.setGraphicElevationContext(b,new aa.ElevationContext);this.ensureDrapedStatus("on-the-ground"===g.mode)&&this._setDrapingDependentMaterialParameters();
return this.draped?this._createAsOverlay(b,e,d,l,c,a.layer.uid):this._createAs3DShape(b,e,d,l,c,g,k,b.uid)};f.layerOpacityChanged=function(){const a=this._getFillColor(),c=this._getOutlineColor();this._forEachMaterial(b=>{b.setParameterValues({color:a});b.setParameterValues({outlineColor:c})});return!0};f.layerElevationInfoChanged=function(a,c,b){const d=this._elevationContext.mode;b=q.elevationModeChangeUpdateType(z.elevationModeChangeTypes,b,d);if(b!==q.SymbolUpdateType.UPDATE)return b;const e=
q.needsElevationUpdates2D(d)||"absolute-height"===d;return this.updateGraphics3DGraphicElevationInfo(a,c,()=>e)};f.slicePlaneEnabledChanged=function(){this.draped||this._forEachMaterial(a=>{a.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled})});return!0};f.physicalBasedRenderingChanged=function(){return!0};f.pixelRatioChanged=function(){return this._getPrimitive()?!0:!1};f.applyRendererDiff=function(a,c){for(const b in a.diff)switch(b){case "visualVariables":if(y.updateFastSymbolUpdatesState(this._fastUpdates,
c,this._fastVisualVariableConvertOptions()))m.isSome(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};f._defaultElevationInfoNoZ=function(){return ma};f._createAs3DShape=function(a,c,b,d,e,g,k,l){const h=this.getFastUpdateAttrValues(a);a=h?w=>y.evaluateModelTransform(this._fastUpdates.materialParameters,h,w):null;d=H.createPointGeometry(K,null,d,e,na,null,h);d=[new ca(d,k)];k=E.createStageObjectForHUD(this._context,
c,d,[b],null,null,g,k,this._context.layer.uid,l,a);if(null===k)return null;const n=new ba(this,k.object,d,null,null,Z.perObjectElevationAligner,g);n.alignedSampledElevation=k.sampledElevation;n.needsElevationUpdates=q.needsElevationUpdates2D(g.mode)||"absolute-height"===g.mode;n.getScreenSize=this._createScreenSizeGetter(e,a);n.calculateRelativeScreenBounds=w=>b.calculateRelativeScreenBounds(n.getScreenSize(),1,w);E.extendPointGraphicElevationContext(n,c,this._context.elevationProvider);return n};
f._createAsOverlay=function(a,c,b,d,e,g){b.renderPriority=this._renderPriority;const k=p.create();V.projectPointToVector(c,k,this._context.overlaySR);k[2]=ea.DRAPED_Z;c=this._context.clippingExtent;if(m.isSome(c)&&!Y.containsPoint(c,k))return null;const l=this.getFastUpdateAttrValues(a);c=l?n=>y.evaluateModelTransform(this._fastUpdates.materialParameters,l,n):null;d=H.createPointGeometry(K,k,d,e,null,null,l);d=new ja(d);d.material=b;d.center=k;d.bsRadius=0;d.data.layerUid=g;d.data.graphicUid=a.uid;
d.calculateShaderTransformation=c;const h=new ia(this,[d],null);h.getScreenSize=this._createScreenSizeGetter(e,c);h.calculateRelativeScreenBounds=n=>b.calculateRelativeScreenBounds(h.getScreenSize(),1,n);return h};f._createScreenSizeGetter=function(a,c){const b=this._outlineSize+2;if(this._fastUpdates.enabled){const d=a[0]/this._symbolTextureRatio,e=a[1]/this._symbolTextureRatio;return(g=D.create())=>{const k=c(ka);g[0]=k[0]*d+b;g[1]=k[5]*e+b;return g}}{const d=a[0]/this._symbolTextureRatio+b,e=a[1]/
this._symbolTextureRatio+b;return(g=D.create())=>{g[0]=d;g[1]=e;return g}}};f._fastVisualVariableConvertOptions=function(){var a=this._size[0]>this._size[1]?this._size[0]:this._size[1];const c=p.fromValues(a,a,a),b=u.px2pt(1);a*=b;a=p.fromValues(a,a,a);return{modelSize:c,symbolSize:a,unitInMeters:b,transformation:{anchor:p.ZEROS,scale:p.ONES,rotation:p.ZEROS}}};f._getGraphicHash=function(a){let c="";for(const b of this._cimRequiredFields)c+=b+a.attributes[b];return c};f._forEachMaterial=function(a){m.isSome(this._material)&&
a(this._material);this._cimSymbolMaterials.forEach(a)};return z}(da.Graphics3DSymbolLayer);v.PRIMITIVE_SIZE=[64,64];v.elevationModeChangeTypes={definedChanged:q.SymbolUpdateType.UPDATE,staysOnTheGround:q.SymbolUpdateType.NONE,onTheGroundChanged:q.SymbolUpdateType.RECREATE};const ma={mode:"relative-to-ground",offset:0},na=X.fromValues(0,0,0,1);A.Graphics3DIconSymbolLayer=v;A.default=v;Object.defineProperty(A,"__esModule",{value:!0})});