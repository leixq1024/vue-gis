// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/Error ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/mat4 ../../../../geometry/projection ../../../../chunks/mat3f64 ../../../../chunks/mat4f64 ../../../../core/libs/earcut/earcut ../../../../chunks/mat3 ../../support/buffer/BufferView ../../../../chunks/vec32 ../../../../geometry/support/aaBoundingBox ../../support/ElevationProvider ../../webgl-engine/lib/Util ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ./graphicUtils ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ../../webgl-engine/lib/Geometry ../support/edgeUtils ./Graphics3DSymbolLayer ../../../../renderers/support/renderingInfoUtils ./polygonUtils ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(W,ta,L,ua,C,B,ba,va,wa,Q,xa,ya,ca,da,T,za,E,Aa,Ba,ea,X,Ca,Da,fa,Ea,R,Fa,ha,ia){function Ga(f,m,e,a,b,c,d,k,t,p,u,l,h,z){let q=0;var v=2*a.count;{var g=a.index,r=a.count,w=e.length/3,n=t;B.copy(A,h);const x=0<l?1:-1;g*=3;let y=n;h=3*y;let D=n+r;n=3*D;for(let F=0;F<r;++F)z&&(A[0]=f[g+0],A[1]=f[g+1],A[2]=f[g+2],B.normalize(A,A)),b[h+0]=f[g+0],b[h+1]=f[g+1],b[h+2]=f[g+2],c[h+0]=m[g+0],c[h+1]=m[g+1],c[h+2]=m[g+2],d[h+0]=-x*A[0],d[h+1]=-x*A[1],d[h+2]=-x*A[2],k[y]=0,b[n+0]=f[g+0]+l*A[0],b[n+1]=
f[g+1]+l*A[1],b[n+2]=f[g+2]+l*A[2],c[n+0]=m[g+0],c[n+1]=m[g+1],c[n+2]=m[g+2],d[n+0]=x*A[0],d[n+1]=x*A[1],d[n+2]=x*A[2],k[D]=l,h+=3,n+=3,g+=3,y+=1,D+=1;h=g=0;n=3*v;f=0>l?ja:ka;m=0>l?ka:ja;for(z=0;z<w;++z)u[h+0]=e[g+f[0]],u[h+1]=e[g+f[1]],u[h+2]=e[g+f[2]],p[n+0]=e[g+m[0]]+r,p[n+1]=e[g+m[1]]+r,p[n+2]=e[g+m[2]]+r,h+=3,n+=3,g+=3}t+=2*a.count;v=0;la(b,c,k,d,q,a.pathLengths[0],a.count,t,p,v,l);t+=4*a.pathLengths[0];v+=2*a.pathLengths[0];q+=a.pathLengths[0];for(e=1;e<a.pathLengths.length;++e)la(b,c,k,d,q,
a.pathLengths[e],a.count,t,p,v,l),t+=4*a.pathLengths[e],v+=2*a.pathLengths[e],q+=a.pathLengths[e]}function U(f,m,e,a,b,c,d){a[c]=a[d];d*=3;c*=3;f[c+0]=f[d+0];f[c+1]=f[d+1];f[c+2]=f[d+2];m[c+0]=m[d+0];m[c+1]=m[d+1];m[c+2]=m[d+2];e[c+0]=b[0];e[c+1]=b[1];e[c+2]=b[2]}function la(f,m,e,a,b,c,d,k,t,p,u){let l=b,h=b+1,z=b+d,q=b+d+1,v=k,g=k+1,r=k+2*c;k=k+2*c+1;0>u&&(l=b+d+1,q=b);p*=3;for(let F=0;F<c;++F){F===c-1&&(0<u?(h=b,q=b+d):(h=b,l=b+d));var w=f,n=l,x=h,y=z,D=S;n*=3;x*=3;y*=3;B.set(Y,w[n++],w[n++],w[n++]);
B.set(ma,w[x++],w[x++],w[x++]);B.set(na,w[y++],w[y++],w[y++]);B.subtract(oa,ma,Y);B.subtract(pa,na,Y);B.cross(D,pa,oa);B.normalize(D,D);U(f,m,a,e,S,v,l);U(f,m,a,e,S,g,h);U(f,m,a,e,S,r,z);U(f,m,a,e,S,k,q);t[p++]=v;t[p++]=r;t[p++]=k;t[p++]=v;t[p++]=k;t[p++]=g;l++;h++;z++;q++;v+=2;g+=2;r+=2;k+=2}}function Ha(f,m,e,a){f=f.stageObject;const b=f.geometryRecords,c=b.length,d="absolute-height"!==m.mode;let k=0;const t=f.objectTransformation,p=ba.invert(Q.create(),t);for(let h=0;h<c;h+=2){const z=b[h].geometry;
var u=z.data.getVertexAttr();const q=u[E.VertexAttrConstants.POSITION].data,v=u[E.VertexAttrConstants.SIZE].data;u=new za.SamplePosition(u.mapPos.data);const g=q.length/3;let r=0,w=!1,n=0;for(let x=0;x<g;x++){O[0]=q[r];O[1]=q[r+1];O[2]=q[r+2];var l=X.evaluateElevationAlignmentAtPoint(u,e,m,a,d?qa:null);d&&(n+=qa.sampledElevation);B.set(G,q[r+0],q[r+1],q[r+2]);B.transformMat4(G,G,t);a.setAltitude(l+v[r/3],G);B.transformMat4(G,G,p);q[r]=G[0];q[r+1]=G[1];q[r+2]=G[2];l=.01/a.unitInMeters;if(Math.abs(O[0]-
q[r])>l||Math.abs(O[1]-q[r+1])>l||Math.abs(O[2]-q[r+2])>l)w=!0;u.offset+=3;r+=3}w&&(z.invalidateBoundingInfo(),f.geometryVertexAttrsUpdated(h),b[h+1].geometry.invalidateBoundingInfo(),f.geometryVertexAttrsUpdated(h+1));k+=n/g}return k/c}R=function(f){function m(a,b,c,d){a=f.call(this,a,b,c,d)||this;a.ensureDrapedStatus(!1);return a}ta._inheritsLoose(m,f);var e=m.prototype;e.doLoad=async function(){if(!this._drivenProperties.size){var a=ea.validateSymbolLayerSize(this._getSymbolSize());if(a)throw new ua("graphics3dextrudesymbollayer:invalid-size",
a);}a=L.get(this.symbolLayer,"material","color");var b=this._getCombinedOpacityAndColor(a);a=C.fromArray(b);b=b[3];a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:b,transparent:1>b||this.needsDrivenTransparentPass,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new ia.DefaultMaterial(a,this._getIdHint("_3dlinemat"));this._bottomMaterial=new ia.DefaultMaterial({...a,
cullFace:2},this._getIdHint("_3dlinematbot"));this._context.stage.add(3,this._material);this._context.stage.add(3,this._bottomMaterial)};e.destroy=function(){f.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._context.stage.remove(3,this._bottomMaterial.id))};e.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometryType(b.geometry,m.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;
const c="graphic"+b.uid,d=this._getVertexOpacityAndColor(a.renderingInfo,Float32Array,255),k=this.setGraphicElevationContext(b,new Ca.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,d,k,c,b.uid)};e.layerOpacityChanged=function(a,b){var c=L.get(this.symbolLayer,"material","color");c=this._getCombinedOpacity(c);const d=1>c||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:c,transparent:d});this._bottomMaterial.setParameterValues({opacity:c,transparent:d});
const k=this._getLayerOpacity();a.forEach(t=>{t=b(t);L.isSome(t)&&t.layerOpacityChanged(k,this._context.isAsync)});return!0};e.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,X.needsElevationUpdates3D)};e.slicePlaneEnabledChanged=function(a,b){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});this._bottomMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});a.forEach(c=>{c=b(c);L.isSome(c)&&
c.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0};e.physicalBasedRenderingChanged=function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._bottomMaterial.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};e.pixelRatioChanged=function(){return!0};e._getExtrusionSize=function(a){if(a.size&&this._drivenProperties.size){var b;a=null!=(b=Fa.getDriverAxisSizeValue(a.size,
2))?b:0}else a=this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};e._getSymbolSize=function(){var a;return null!=(a=this.symbolLayer.size)?a:1};e._createAs3DShape=function(a,b,c,d,k,t){var p=ha.geometryAsPolygon(a.geometry);if(L.isNone(p))return null;a=ha.geometryToRenderInfo(p,this._context.elevationProvider,this._context.renderCoordsHelper,d);this._logGeometryCreationWarnings(a,p.rings,"rings","ExtrudeSymbol3DLayer");if(0===p.rings.length||!p.rings.some(M=>0<M.length))return null;
var u=ea.computeCentroid(p);if(L.isNone(u))return null;var l=[];const h=[],z=[],q=T.create(),v=Q.create(),g=C.create(),r=1===this._context.renderCoordsHelper.viewingMode;r||this._context.renderCoordsHelper.worldUpAtPosition(null,g);va.computeLinearTransformation(p.spatialReference,[u.x,u.y,0],v,this._context.renderCoordsHelper.spatialReference);p=Q.create();ba.invert(p,v);u=wa.create();ya.normalFromMat4(u,p);const {polygons:w,mapPosition:n,position:x}=a;var y=x.length/3;const D=new Float64Array(18*
y),F=new Float64Array(18*y),ra=new Float64Array(18*y);y=new Float64Array(6*y);let N=0;for(let M=0;M<w.length;++M){var H=w[M];const Z=H.count;if(this._context.clippingExtent&&(T.empty(q),T.expandWithBuffer(q,H.mapPosition),!T.intersectsClippingArea(q,this._context.clippingExtent)))continue;const V=xa.earcut(H.mapPosition,H.holeIndices,3);if(0===V.length)continue;const sa=new Uint32Array(6*Z+V.length);var P=new Uint32Array(V.length),K=6*Z,I=3*D.BYTES_PER_ELEMENT;I=new ca.BufferViewVec3f64(D.buffer,
N*I,I,(N+K)*I);var J=3*F.BYTES_PER_ELEMENT;J=new ca.BufferViewVec3f64(F.buffer,N*J,J,(N+K)*J);const aa=new Float64Array(ra.buffer,3*N*ra.BYTES_PER_ELEMENT,3*K);K=new Float64Array(y.buffer,1*N*y.BYTES_PER_ELEMENT,1*K);const Ia=this._getExtrusionSize(b);Ga(x,n,V,H,I.typedBuffer,aa,J.typedBuffer,K,0,sa,P,Ia,g,r);da.transformMat4(I,I,p);da.transformMat3(J,J,u);N+=6*Z;H=this._createExtrudeGeometry(sa,{positions:I.typedBuffer,elevation:aa,normals:J.typedBuffer,heights:K},c);H=new fa(H,k+"path"+M);l.push(H);
h.push(this._material);z.push(Q.IDENTITY);P=this._createExtrudeGeometry(P,{positions:I.typedBuffer,elevation:aa,normals:J.typedBuffer,heights:K},c);P=new fa(P,k+"bottompath"+M);l.push(P);h.push(this._bottomMaterial);z.push(Q.IDENTITY)}if(0===l.length)return null;b=new Ba({geometries:l,materials:h,transformations:z,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:t,isElevationSource:!0},idHint:k});b.objectTransformation=v;c=this._createEdgeMaterial();c=L.isSome(c)?{baseMaterial:this._material,
edgeMaterials:[c],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null;l=new Da(this,b,l,null,null,Ha,d,c);l.alignedSampledElevation=a.sampledElevation;l.needsElevationUpdates=X.needsElevationUpdates3D(d.mode);return l};e._createExtrudeGeometry=function(a,b,c){var d=new Uint32Array(a.length);const k={};k[E.VertexAttrConstants.POSITION]=a;k[E.VertexAttrConstants.NORMAL]=a;k[E.VertexAttrConstants.COLOR]=d;d={};d[E.VertexAttrConstants.POSITION]={size:3,data:b.positions};
d[E.VertexAttrConstants.NORMAL]={size:3,data:b.normals};d[E.VertexAttrConstants.COLOR]={size:4,data:c};d[E.VertexAttrConstants.SIZE]={size:1,data:b.heights};b.elevation&&(d.mapPos={size:3,data:b.elevation},k.mapPos=a);return new Aa.GeometryData(d,k)};e._createEdgeMaterial=function(){const a={opacity:this._getLayerOpacity()};return Ea.createMaterial(this.symbolLayer,a)};return m}(R.Graphics3DSymbolLayer);R.validGeometryTypes=["polygon","extent"];const S=C.create(),Y=C.create(),ma=C.create(),na=C.create(),
oa=C.create(),pa=C.create(),O=C.create(),G=C.create(),A=C.create(),ka=[0,2,1],ja=[0,1,2],qa={verticalDistanceToGround:0,sampledElevation:0};W.Graphics3DExtrudeSymbolLayer=R;W.default=R;Object.defineProperty(W,"__esModule",{value:!0})});