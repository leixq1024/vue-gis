// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/promiseUtils ../../../../core/Accessor ../../../../core/Handles ../../../../core/watchUtils ../../../support/Scheduler ../../../layers/support/FeatureFilter ./QueryEngine".split(" "),
function(e,h,k,z,g,n,A,p,B,q,C,D,E,r,t,u,v,l,w,x){const y=n.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");e.Graphics3DFilterVisibility=function(m){function f(...a){a=m.call(this,...a)||this;a.filter=null;a._dirty=!1;a._querying=!1;a._handles=new u;return a}h._inheritsLoose(f,m);var c=f.prototype;c.setup=function(a,b){this._layerView=a;this._core=b;this._objectIdField=a.layer.objectIdField;this._queryEngine=new x["default"]({layerView:this._layerView,task:l.Task.FILTER_VISIBILITY});
this._handles.add(this._layerView.view.resourceController.scheduler.registerTask(l.Task.FILTER_VISIBILITY,d=>this._update(d),()=>this._needsUpdate()));this._handles.add(v.on(b.owner,"loadedGraphics","after-changes",d=>this._graphicsChanged(d),()=>this.dirty=!0));this.filterChanged()};c.destroy=function(){this._handles.destroy();this._handles=null;this.clear();this._core=this._layerView=null};c.clear=function(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities(a=>a.clearVisibilityFlag(2)),
this._queryResult=null,this._querying=!1);this.dirty=!1;this.notifyChange("updating")};c._graphicsChanged=function(a){this._queryEngine&&0===(a.type&1)||(this.dirty=!0)};c.updateVisibility=function(a){this.active&&(a.hasVisibilityFlag(2,0)||a.setVisibilityFlag(2,!1,0),this.dirty=!0)};c.filterChanged=function(){const a=this.recomputeFilter();a!==this.filter&&(this.filter=a,this.dirty=!0)};c.recomputeFilter=function(){var a="filter"in this._layerView?this._layerView.filter:null;const b="timeExtent"in
this._layerView?this._layerView.timeExtent:null;if(g.isNone(b))return a;a=g.isSome(a)?a.clone():new w;a.timeExtent=g.isSome(a.timeExtent)?a.timeExtent.intersection(b):b;return a};c._needsUpdate=function(){return this._dirty&&!this._querying||null!=this._queryResult};c._update=function(a){this.active?(!this._dirty||this._querying||a.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this.filter).then(b=>{this._queryResult=b;this._querying=!1}).catch(b=>{r.isAbortError(b)||
(y.warn("FeatureFilter query failed: "+b,{error:b}),this._queryResult=new Set,this._core.graphics3DGraphics.forEach(d=>this._queryResult.add(this._getFeatureId(d.graphic))),this._querying=!1)}),a.madeProgress()),this._queryResult&&!a.done&&(this._core.modifyGraphics3DGraphicVisibilities(b=>{if(a.done)return!1;const d=this._queryResult.has(this._getFeatureId(b.graphic));return b.setVisibilityFlag(2,d,0)?(a.madeProgress(),!0):!1}),a.done||(this._queryResult=null)),this.notifyChange("updating")):this.clear()};
c._getFeatureId=function(a){return null==a.objectId?a.attributes[this._objectIdField]:a.objectId};h._createClass(f,[{key:"updating",get:function(){return this._dirty||this._querying||null!=this._queryResult}},{key:"active",get:function(){return this.filter&&0<this._core.graphics3DGraphics.size}},{key:"dirty",set:function(a){this._dirty!==a&&(this._dirty=a,this.notifyChange("updating"))}}]);return f}(t);k.__decorate([p.property({readOnly:!0})],e.Graphics3DFilterVisibility.prototype,"updating",null);
e.Graphics3DFilterVisibility=k.__decorate([q.subclass("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],e.Graphics3DFilterVisibility);Object.defineProperty(e,"__esModule",{value:!0})});