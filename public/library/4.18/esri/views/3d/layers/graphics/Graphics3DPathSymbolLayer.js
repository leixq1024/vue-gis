// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/lang ../../../../core/maybe ../../../../core/Error ../../../../core/mathUtils ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../geometry/projection ../../../../chunks/vec2f64 ../../../../chunks/vec2 ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ../../../../chunks/vec3f32 ../../webgl-engine/lib/Object3D ./graphicUtils ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ../../webgl-engine/lib/Geometry ./Graphics3DSymbolLayer ../../webgl-engine/materials/DefaultMaterial ../support/FastSymbolUpdates ../../../../chunks/mat2 ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/PathMaterial".split(" "),
function(B,X,Y,C,Z,E,N,n,O,aa,P,F,ba,Q,ca,R,G,da,ea,fa,H,ha,S,ia,k,ja){function T(g,v,l){switch(v){case "world":for(const a of g.vertices)n.add(y,a.pos,g.offset),l.worldUpAtPosition(y,w),a.setFrameFromUpVector(w),a.computeRotationAxisAndAngleFromUpVector();break;case "path":n.add(y,g.vertices[0].pos,g.offset);l.worldUpAtPosition(y,w);k.computeMinimumRotationTangentFrame(g,w);for(const a of g.vertices)g=E.sign(n.dot(a.frame.right,a.vRight)),n.cross(a.rotationFrame.up,a.vRight,a.vLeft),n.scale(a.rotationFrame.up,
a.rotationFrame.up,g),n.normalize(a.rotationFrame.up,a.rotationFrame.up),v=n.dot(a.rotationFrame.up,a.frame.up),l=n.dot(a.rotationFrame.up,a.frame.right),n.scale(y,a.frame.up,-l),n.scale(U,a.frame.right,v),n.add(y,y,U),n.normalize(a.rotationFrame.right,y),k.vertexSpaceToProfileSpace(a.rotationRight,a.frame,a.rotationFrame.right),n.negate(y,a.vLeft),a.rotationAngle=-g*(Math.PI-E.acosClamped(n.dot(y,a.vRight))),0<Math.abs(a.rotationAngle)&&(g=E.reciprocalClamped(Math.cos(.5*a.rotationAngle)),ia.set(a.miterStretch,
1+(g-1)*a.rotationRight[0]*a.rotationRight[0],(g-1)*a.rotationRight[0]*a.rotationRight[1],(g-1)*a.rotationRight[0]*a.rotationRight[1],1+(g-1)*a.rotationRight[1]*a.rotationRight[1])),a.maxStretchDistance=Math.abs(Math.min(a.vLeftLength,a.vRightLength)*E.reciprocalClamped(Math.cos(.5*(Math.PI-a.rotationAngle))))}}function V(g,v,l){switch(g){case "symbol-value":return l;case "proportional":return v;default:return g}}function ka(g,v,l,a){g=g.stageObject;const b=g.geometryRecords,d=b.length;var e=0;la.spatialReference=
a.spatialReference;for(let t=0;t<d;t++){const z=b[t].geometry,x=z.metadata,A=x.pathGeometry,f=A.builder.path;{var h=f;var c=v,u=l,r=a;let m=0;for(const p of h.vertices){const q=G.evaluateElevationAlignmentAtPoint(p.posES,u,c,r,W);m+=W.sampledElevation;n.add(w,p.pos,h.offset);r.setAltitude(q,w);n.subtract(p.pos,w,h.offset)}h.updatePathVertexInformation();h=m/h.vertices.length}e+=h;"world"!==f.upVector&&T(f,x.upVectorAlignment,a);A.onPathChanged();z.invalidateBoundingInfo();g.geometryVertexAttrsUpdated(t)}return e/
d}let M=function(g){function v(a,b,d,e){a=g.call(this,a,b,d,e)||this;a._intrinsicSize=aa.fromValues(1,1);a.upVectorAlignment="path";a.stencilWidth=.1;a.ensureDrapedStatus(!1);return a}X._inheritsLoose(v,g);var l=v.prototype;l.doLoad=async function(){const a=C.isSome(this.symbolLayer.width)?this.symbolLayer.width:C.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,b=C.isSome(this.symbolLayer.height)?this.symbolLayer.height:a;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[a,
1,b],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?S.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};var d=this.symbolLayer.anchor||"center";this.upVectorAlignment="path";"heading"===this.symbolLayer.profileRotation&&
(this.upVectorAlignment="world");var e=this.symbolLayer.profile||"circle";switch(e){default:this._profile=k.Profile.circle(10);break;case "quad":this._profile=k.Profile.rect()}var h=[0,0];"center"!==d&&(h={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[d],this._profile.translate(h[0],h[1]));switch(this.symbolLayer.join||"simple"){case "round":this._extruder=new k.MiterExtruder(0,3);break;case "bevel":this._extruder=new k.MiterExtruder(0,1);break;case "miter":this._extruder=new k.MiterExtruder(.8*
Math.PI,1);break;default:this._extruder=new k.SimpleExtruder}d=this.symbolLayer.cap||"butt";switch(d){case "none":this._startCap=new k.NoCapBuilder;this._endCap=new k.NoCapBuilder;break;default:this._startCap=new k.TriangulationCapBuilder(this._profile,0);this._endCap=new k.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new k.TriangulationCapBuilder(this._profile,-.5);this._endCap=new k.TriangulationCapBuilder(this._profile,.5,!0);break;case "round":e="quad"===e?!0:
!1,this._startCap=new k.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:e,subdivisions:3}),this._endCap=new k.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:e,subdivisions:3})}e=this._getIdHint();h=C.get(this.symbolLayer,"material","color");var c=this._getCombinedOpacityAndColor(h);h=N.fromArray(c);c=c[3];d={diffuse:h,ambient:h,opacity:c,transparent:1>c||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,
cullFace:"none"===d?0:void 0,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(P.set(this._intrinsicSize,a,b),!R.isValidSize(this._intrinsicSize[0])||!R.isValidSize(this._intrinsicSize[1])))throw new Z("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||P.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);this._fastUpdates.enabled?(Y.mixin(d,
this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new ja.PathMaterial(d,`${e}_pathmat`)):(d.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new ha.DefaultMaterial(d,`${e}_pathmat`));this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._context.stage.add(3,this._material)};l.destroy=function(){g.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,
this._material.id),this._material=null)};l.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometryType(b.geometry,v.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;const d="graphic"+b.uid,e=this.setGraphicElevationContext(b,new da.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,e,d,b.uid)};l.layerOpacityChanged=function(){var a=C.get(this.symbolLayer,"material","color");a=this._getCombinedOpacity(a);this._material.setParameterValues({opacity:a,
transparent:1>a||this.needsDrivenTransparentPass});return!0};l.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,G.needsElevationUpdates3D)};l.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};l.physicalBasedRenderingChanged=function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};l.pixelRatioChanged=function(){return!0};
l.applyRendererDiff=function(a,b){for(const d in a.diff)switch(d){case "visualVariables":if(S.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};l.getVertexData=function(a){let b=0;const d=a.paths,e=[],h=a.spatialReference,c=this._context.elevationProvider.spatialReference,u=this._context.renderCoordsHelper.spatialReference;for(var r of d)b+=r.length;r=new Float64Array(3*
b);const t=new Float64Array(3*b),z=new Float64Array(3*b);let x=0;for(const A of d){e.push({index:x,numVertices:A.length});for(const f of A)r[x++]=f[0],r[x++]=f[1],r[x++]=a.hasZ?f[2]:0}a=!0;h.equals(c)?this._copyVertices(r,0,t,0,b):a=O.projectBuffer(r,h,0,t,c,0,b);c.equals(u)?this._copyVertices(t,0,z,0,b):O.projectBuffer(t,c,0,z,u,0,b);return{pathVertexDataInfos:e,vertexDataGS:r,vertexDataES:t,vertexDataRS:z,projectionSuccess:a,terrainElevation:0}};l._copyVertices=function(a,b,d,e,h){b*=3;e*=3;for(let c=
0;c<h;++c)d[e++]=a[b++],d[e++]=a[b++],d[e++]=a[b++]};l._createAs3DShape=function(a,b,d,e,h){var c=a.geometry,u=[];const r=[],t=[],z=c.spatialReference,x=F.create(),A=this._context.renderCoordsHelper;c=this.getVertexData(c);if(!c.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0<c.pathVertexDataInfos.length){for(let I=0;I<c.pathVertexDataInfos.length;++I){var f=c.pathVertexDataInfos[I],m=f.index;
f=f.numVertices;if(2>f)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");else{if(C.isSome(this._context.clippingExtent)&&(F.empty(x),F.expandWithBuffer(x,c.vertexDataES,3*m,f),!F.intersectsClippingArea(x,this._context.clippingExtent)))continue;var p=[];for(var q=m;q<m+3*f;){const J=q++,K=q++,L=q++,D=new k.PathVertex;n.set(D.posGS,c.vertexDataGS[J],c.vertexDataGS[K],c.vertexDataGS[L]);n.set(D.posES,c.vertexDataES[J],c.vertexDataES[K],c.vertexDataES[L]);
const ma=G.evaluateElevationAlignmentAtPoint(D.posES,this._context.elevationProvider,d,A,null);n.set(w,c.vertexDataRS[J],c.vertexDataRS[K],c.vertexDataRS[L]);A.setAltitude(ma,w);n.set(D.pos,w[0],w[1],w[2]);p.push(D)}m=new k.Path(p);T(m,this.upVectorAlignment,this._context.renderCoordsHelper);m=new k.Builder(m,this._profile,this._extruder,this._startCap,this._endCap);f=null;this._fastUpdates.enabled?(q=this._fastUpdates.visualVariables,f=q.size?H.getAttributeValue(q.size.field,a):0,p=q.color?H.getAttributeValue(q.color.field,
a):0,q=q.opacity?H.getAttributeValue(q.opacity.field,a):0,f=new k.FastUpdatePathGeometry(m,f,p,q)):(f=[this._intrinsicSize[0],this._intrinsicSize[1]],this._drivenProperties.size&&(f[0]*=V(b.size[0],"symbol-value"===b.size[2]?this.symbolLayer.height||0:b.size[2],this.symbolLayer.width||0),f[1]*=V(b.size[2],"symbol-value"===b.size[0]?this.symbolLayer.width||0:b.size[0],this.symbolLayer.height||0)),p=null,this._drivenProperties.color&&(p=b.color),this._drivenProperties.opacity&&null!=b.opacity&&(p=p?
[p[0],p[1],p[2],b.opacity]:[1,1,1,b.opacity]),m=new k.StaticPathGeometry(m),m.bake(f),p&&m.bakeVertexColors(p),f=m);m=f.createGeometryData();m=new fa(m,e+"path"+I);m.metadata={pathGeometry:f,geometrySR:z,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};u.push(m);r.push(this._material);t.push(f.xform)}}a={layerUid:this._context.layer.uid,graphicUid:h};if(0<u.length)return e=new ca({geometries:u,materials:r,transformations:t,castShadow:!0,metadata:a,idHint:e}),u=new ea(this,
e,u,null,null,ka,d),u.alignedSampledElevation=c.terrainElevation,u.needsElevationUpdates=G.needsElevationUpdates3D(d.mode),u}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null};return v}(H.Graphics3DSymbolLayer);M.validGeometryTypes=["polyline"];const la=ba.makeDehydratedPoint(0,0,0,null),w=N.create(),y=Q.create(),U=Q.create(),W={verticalDistanceToGround:0,sampledElevation:0};B.Graphics3DPathSymbolLayer=M;B.NUM_CIRCLE_PROFILE_SUBDIVISIONS=
10;B.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3;B.NUM_ROUND_JOIN_SUBDIVISIONS=3;B.default=M;Object.defineProperty(B,"__esModule",{value:!0})});