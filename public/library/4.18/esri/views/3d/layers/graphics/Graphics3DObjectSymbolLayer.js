// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/lang ../../../../core/maybe ../../../../Color ../../../../core/screenUtils ../../../../symbols/support/ObjectSymbol3DLayerResource ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/mat4 ../../../../geometry/projection ../../../../chunks/mat4f64 ../../../../chunks/vec4f64 ../../../../geometry/support/aaBoundingBox ../../webgl-engine/lib/Util ./graphicUtils ./elevationAlignmentUtils ./ElevationAligners ./ElevationContext ./primitiveObjectSymbolUtils ../../webgl-engine/lib/lodRendering/LodResources ./symbolComplexity ./Graphics3DSymbolLayer ./pointUtils ../../webgl-engine/materials/DefaultMaterial ../support/FastSymbolUpdates ../../../../symbols/support/symbolLayerUtils3D ./Graphics3DLodInstanceGraphicLayer ./lodResourceUtils ./objectResourceUtils ../../webgl-engine/lib/lodRendering/LodRenderer".split(" "),
function(O,S,T,f,P,U,aa,l,t,G,V,W,z,v,ba,D,Q,ca,da,X,x,ea,H,I,fa,A,J,ha,Y,ia,ja){H=function(K){function L(b,a,c,d){b=K.call(this,b,a,c,d)||this;b._resources=null;b._optionalFields=[];b._instanceIndexToGraphicUid=new Map;b.ensureDrapedStatus(!1);return b}S._inheritsLoose(L,K);var g=L.prototype;g.getCachedSize=function(){const [b,a,c]=f.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:b,depth:a,height:c}};g.doLoad=async function(b){const a=this._getIdHint("_objectmat");if(!this._drivenProperties.size&&
D.validateSymbolLayerSize(this.symbolLayer))throw Error();const c=this.symbolLayer;this._resources=this.isPrimitive?this._createResourcesForPrimitive(c.resource?c.resource.primitive:aa.defaultPrimitive,a):await this._createResourcesForUrl(c.resource.href,b);this.complexity=this.computeComplexity()};g.setMaterialTransparencyParams=function(b,a=f.get(this.symbolLayer,"material","color")){a=this._getCombinedOpacity(a);b.transparent=1>a||this.needsDrivenTransparentPass;b.opacity=a;return b};g._createResourcesForPrimitive=
function(b,a){if(!X.isValidPrimitive(b))throw Error(`Unknown object symbol primitive: ${b}`);var c=this.symbolLayer;const d=v.create(J.objectSymbolLayerPrimitiveBoundingBox(b)),e=l.fromArray(v.size(d)),h=l.fromArray(J.objectSymbolLayerSizeWithResourceSize(e,c)),m=t.length(h);var k={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:l.ONES,diffuse:l.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,
offsetTransparentBackfaces:!this.symbolLayer.isPrimitive};const n=k.usePBR;this.setMaterialTransparencyParams(k);const p=this.symbol;if("point-3d"===p.type&&p.verticalOffset){const {screenLength:y,minWorldLength:u,maxWorldLength:r}=p.verticalOffset;k.verticalOffset={screenLength:U.pt2px(y),minWorldLength:u||0,maxWorldLength:null!=r?r:Infinity};k.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(k.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._drivenProperties.color?
k.externalColor=z.ONES:(c=f.isSome(c.material)&&c.material.color,c=f.isSome(c)?P.toUnitRGBA(c):z.ONES,k.externalColor=c);this._fastUpdates=A.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(d,h,e,f.none));this._fastUpdates.enabled?(T.mixin(k,this._fastUpdates.materialParameters),k.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(k.instanced.push("color"),this._optionalFields.push("color"));k=new fa.DefaultMaterial(k,
a);a=X.primitiveLodResources(b,k,a);if(!a)throw Error(`Unknown object symbol primitive: ${b}`);b=x.materialsFromLodResources(a).map(y=>({opacity:1,transparent:y.params.transparent}));k=this._createStageResources(a,n);c=this._createLodRenderer(a);return{lodResources:a,lodRenderer:c,stageResources:k,symbolSize:h,extentPadding:m,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:b,physicalBasedRenderingEnabled:n,resourceBoundingBox:d,resourceSize:e,dispose:f.none,pivotOffset:f.none}};g._createResourcesForUrl=
async function(b,a){var c=["transformation"],d={materialParamsMixin:{instanced:c,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=A.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(f.none,f.none,f.none,f.none));this._fastUpdates.enabled?(T.mixin(d.materialParamsMixin,this._fastUpdates.materialParameters),
c.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(c.push("color"),this._optionalFields.push("color"));c=this.symbol;if("point-3d"===c.type&&c.verticalOffset){const {screenLength:q,minWorldLength:B,maxWorldLength:E}=c.verticalOffset;d.materialParamsMixin.verticalOffset={screenLength:U.pt2px(q),minWorldLength:B||0,maxWorldLength:null!=E?E:Infinity};d.materialParamsMixin.castShadows=!1}d.signal=a;d.usePBR=this._context.physicalBasedRenderingEnabled;
a=d.usePBR;var e=await ia.fetch(b,d);b=e.isEsriSymbolResource;d=e.isWosr;c=e.remove;const h=Y.makeLodResources(e.lods);Y.fillEstimatedMinScreenSpaceRadius(h);h.levels.sort((q,B)=>q.minScreenSpaceRadius-B.minScreenSpaceRadius);h.levels[0].minScreenSpaceRadius=Math.min(2,h.levels[0].minScreenSpaceRadius);const m=this._context,k=this._getExternalColorParameters(this.symbolLayer.material);var n=f.get(this.symbolLayer,"material","color");const p=this._getCombinedOpacity(n,{hasIntrinsicColor:!0}),y=this.needsDrivenTransparentPass;
var u=x.materialsFromLodResources(h);n=x.materialsFromLodResources(h).map(q=>{q=q.params;return{opacity:q.opacity||1,transparent:q.transparent}});u.forEach(q=>{const B=q.params;q.setParameterValues(k);const E=B.opacity*p;q.setParameterValues({opacity:E,transparent:1>E||y||B.transparent});m.screenSizePerspectiveEnabled&&q.setParameterValues({screenSizePerspective:m.sharedResources.screenSizePerspectiveSettings})});e=e.referenceBoundingBox;const r=l.fromArray(v.size(e)),w=l.fromArray(h.levels[0].pivotOffset),
F=l.fromArray(J.objectSymbolLayerSizeWithResourceSize(r,this.symbolLayer)),ka=t.length(F);A.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(e,F,r,w))&&u.forEach(q=>q.setParameterValues(this._fastUpdates.materialParameters));u=this._createStageResources(h,a);const la=this._createLodRenderer(h);return{lodResources:h,lodRenderer:la,stageResources:u,symbolSize:F,extentPadding:ka,isEsriSymbolResource:b,isWosr:d,originalMaterialParameters:n,physicalBasedRenderingEnabled:a,
resourceBoundingBox:e,resourceSize:r,dispose:c,pivotOffset:w}};g._createStageResources=function(b,a){const c=this._context.stage,d=x.materialsFromLodResources(b);a!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();for(const e of d)c.add(3,e);a=x.texturesFromLodResources(b);for(const e of a)c.add(4,e);b=x.geometriesFromLodResources(b);for(const e of b)c.add(2,e);return{materials:d,textures:a,geometries:b}};g._createLodRenderer=function(b){const a=this._context.stage;
b=new ja.LodRenderer(b,this._optionalFields,{layerUid:this._context.layer.uid,graphicUid:c=>this._instanceIndexToGraphicUid.get(c),notifyGraphicUpdate:(c,d)=>this._context.notifyGraphicUpdate(this._instanceIndexToGraphicUid.get(c),d)},this._fastUpdates.enabled?{applyTransform:(c,d,e)=>{c.getFeatureAttribute(d,M);G.copy(e,A.evaluateModelTransform(this._fastUpdates.materialParameters,M,e))},scaleFactor:(c,d,e)=>{d.getFeatureAttribute(e,M);return A.evaluateModelTransformScale(c,this._fastUpdates.materialParameters,
M)}}:null);b.slicePlane=this._context.slicePlaneEnabled;a.addRenderPlugin(b.slots,b);return b};g._getExternalColorParameters=function(b){const a={};this._drivenProperties.color?a.externalColor=z.ONES:f.isSome(b)&&f.isSome(b.color)?a.externalColor=P.toUnitRGBA(b.color):(a.externalColor=z.ONES,a.colorMixMode="ignore");return a};g.destroy=function(){K.prototype.destroy.call(this);const b=this._context.stage;if(f.isSome(this._resources)){b.removeRenderPlugin(this._resources.lodRenderer);this._resources.lodRenderer.destroy();
const a=this._resources.stageResources;for(const c of a.materials)b.remove(3,c.id);for(const c of a.textures)b.remove(4,c.id);for(const c of a.geometries)b.remove(2,c.id);f.isSome(this._resources.dispose)&&this._resources.dispose()}this._resources=null};g.createGraphics3DGraphic=function(b){const a=b.graphic;if(!this._validateGeometry(a.geometry))return null;const c=I.placePointOnGeometry(a.geometry);if(f.isNone(c))return this.logger.warn(`unsupported geometry type for icon symbol: ${a.geometry.type}`),
null;const d=this.setGraphicElevationContext(a,new da.ElevationContext);return this._createAs3DShape(a,c,b.renderingInfo,d,a.uid)};g.notifyDestroyGraphicLayer=function(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)};g.graphicLayerToGraphicId=function(){return 0};g.layerOpacityChanged=function(){if(f.isNone(this._resources))return!0;const b=this._drivenProperties.opacity,a=!this.isPrimitive,c=this._resources.stageResources.materials,d=this._resources.originalMaterialParameters;for(let h=
0;h<c.length;h++){const m=c[h];var e=f.get(this.symbolLayer,"material","color");const k=d[h];e=this._getCombinedOpacity(e,{hasIntrinsicColor:a})*k.opacity;m.setParameterValues({opacity:e,transparent:1>e||b||k.transparent})}return!0};g.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,Q.needsElevationUpdates3D)};g.slicePlaneEnabledChanged=function(){if(f.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;
for(const b of this._resources.stageResources.materials)b.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};g.physicalBasedRenderingChanged=function(){if(f.isNone(this._resources))return!0;const {stageResources:b,isEsriSymbolResource:a,isWosr:c}=this._resources;for(const d of b.materials)this.isPrimitive?d.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):a&&!c&&d.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!1});return!0};g.pixelRatioChanged=function(){return!0};g.applyRendererDiff=function(b,a){if(f.isNone(this._resources))return!0;const {stageResources:{materials:c},lodRenderer:d,resourceBoundingBox:e,symbolSize:h,resourceSize:m,pivotOffset:k}=this._resources;for(const n in b.diff)switch(n){case "visualVariables":if(A.updateFastSymbolUpdatesState(this._fastUpdates,a,this._fastVisualVariableConvertOptions(e,h,m,k))){for(const p of c)p.setParameterValues(this._fastUpdates.materialParameters);
d.notifyShaderTransformationChanged()}else return!1;break;default:return!1}return!0};g.computeComplexity=function(){if(f.isNone(this._resources))return K.prototype.computeComplexity.call(this);const b=x.geometriesFromLodLevelResources(this._resources.lodResources.levels[0]).reduce((c,d)=>c+d.data.getIndices(ba.VertexAttrConstants.POSITION).length,0)/3,a=ea.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer);return{primitivesPerFeature:b,primitivesPerCoordinate:0,drawCallsPerFeature:0,
estimated:!1,memory:a}};g.hasLodRenderer=function(){return f.isSome(this._resources)};g._createAs3DShape=function(b,a,c,d,e){if(!this.hasLodRenderer()||f.isNone(this._resources))return null;b=this.getFastUpdateAttrValues(b);const h=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?D.mixinColorAndOpacity(c.color,c.opacity):null;var m=this._context.clippingExtent;V.projectPointToVector(a,C,this._context.elevationProvider.spatialReference);if(f.isSome(m)&&!v.containsPoint(m,C))return null;m=this._requiresTerrainElevation(d);
const k=this._computeGlobalTransform(a,d,R,m?N:null);c=this._computeLocalTransform(this._resources,this.symbolLayer,c,Z);const n=this._resources.lodRenderer.instanceData,p=n.addInstance();this._instanceIndexToGraphicUid.set(p,e);n.setLocalTransform(p,c,!1);n.setGlobalTransform(p,k);b&&n.setFeatureAttribute(p,b);h&&n.setColor(p,h);e=new ha(this,p,ca.perLodInstanceElevationAligner,d);m&&(e.alignedSampledElevation=N.sampledElevation);e.needsElevationUpdates=Q.needsElevationUpdates3D(d.mode);I.extendPointGraphicElevationContext(e,
a,this._context.elevationProvider);return e};g._computeGlobalTransform=function(b,a,c,d){a=Q.evaluateElevationAlignmentAtPoint(b,this._context.elevationProvider,a,this._context.renderCoordsHelper,d);C[0]=b.x;C[1]=b.y;C[2]=a;V.computeLinearTransformation(b.spatialReference,C,c,this._context.renderCoordsHelper.spatialReference);return c};g._computeLocalTransform=function(b,a,c,d){G.identity(d);this._applyObjectRotation(c,!1,d);this._applyObjectRotation(a,!0,d);this._applyObjectScale(b,c,d);this._applyAnchor(b,
a,d);return d};g._applyObjectScale=function(b,a,c){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=D.computeObjectScale(this._drivenProperties.size&&a.size?a.size:b.symbolSize,b.symbolSize,b.resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||G.scale(c,c,b))};g.prepareSymbolLayerPatch=function(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);this._preparePatchColor(b,a)}};g.updateGeometry=function(b,
a){if(f.isNone(this._resources))return!0;const c=a&&I.placePointOnGeometry(a);if(f.isNone(c))return!1;a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==a)return!1;a=this._requiresTerrainElevation(b.elevationContext);this._computeGlobalTransform(c,b.elevationContext,R,a?N:null);a&&(b.alignedSampledElevation=N.sampledElevation);this._resources.lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,R,!0);I.extendPointGraphicElevationContext(b,c,this._context.elevationProvider);return!0};
g._preparePatchTransform=function(b,a){if((a.heading||a.tilt||a.roll||a.width||a.height||a.depth||a.anchor||a.anchorPosition)&&!f.isNone(this._resources)){var c=(r,w,F)=>f.unwrapOr(null!=r&&"complete"===r.type?r.newValue:w,F),d=c(a.heading,this.symbolLayer.heading,0),e=c(a.tilt,this.symbolLayer.tilt,0),h=c(a.roll,this.symbolLayer.roll,0),m=c(a.width,this.symbolLayer.width,void 0),k=c(a.height,this.symbolLayer.height,void 0),n=c(a.depth,this.symbolLayer.depth,void 0),p=c(a.anchor,this.symbolLayer.anchor,
void 0);c=c(a.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;delete a.depth;delete a.anchor;delete a.anchorPosition;var y={heading:d,tilt:e,roll:h,anchor:p,anchorPosition:c},u=this._resources;1===this.loadStatus&&b.symbolLayerStatePatches.push(()=>{u.symbolSize=l.fromArray(J.objectSymbolLayerSizeWithResourceSize(u.resourceSize,{width:m,height:k,depth:n,isPrimitive:this.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push((r,
w)=>{w=this._computeLocalTransform(u,y,w,Z);u.lodRenderer.instanceData.setLocalTransform(r.instanceIndex,w,!0)})}};g._preparePatchColor=function(b,a){if(a.material&&"partial"===a.material.type&&(a=a.material.diff,a.color&&"complete"===a.color.type&&null!=a.color.newValue&&null!=a.color.oldValue)){var c=a.color.newValue,d=f.isSome(c)?P.toUnitRGBA(c):z.ONES;delete a.color;var e=this._resources;f.isNone(e)||b.graphics3DGraphicPatches.push(h=>{this._hasPerInstanceColor()?(e.lodRenderer.instanceData.setColor(h.instanceIndex,
d),h=this.setMaterialTransparencyParams({},c)):h=this.setMaterialTransparencyParams({externalColor:d},c);for(const m of e.stageResources.materials)m.setParameterValues(h)})}};g._requiresTerrainElevation=function(b){return"absolute-height"!==b.mode};g._applyObjectRotation=function(b,a,c){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&a))return D.computeObjectRotation(b.heading,b.tilt,b.roll,c)};g._computeAnchor=function(b,a,c){const d=l.create();switch(c.anchor){case "center":t.copy(d,
v.center(b));t.negate(d,d);break;case "top":a=v.center(b);t.set(d,-a[0],-a[1],-b[5]);break;case "bottom":a=v.center(b);t.set(d,-a[0],-a[1],-b[2]);break;case "relative":a=v.center(b);b=v.size(b);c=(c=c.anchorPosition)?l.fromValues(c.x,c.y,c.z):l.ZEROS;t.multiply(d,b,c);t.add(d,d,a);t.negate(d,d);break;default:f.isSome(a)?t.negate(d,a):t.copy(d,l.ZEROS)}return d};g._applyAnchor=function(b,a,c){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._computeAnchor(b.resourceBoundingBox,
b.pivotOffset,a))&&G.translate(c,c,b)};g._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity};g._fastVisualVariableConvertOptions=function(b,a,c,d){const e=f.isSome(b)?l.fromArray(v.size(b)):l.ONES;b=f.isSome(b)?this._computeAnchor(b,d,this.symbolLayer):l.ZEROS;d=this._context.renderCoordsHelper.unitInMeters;c=D.computeObjectScale(f.isSome(a)?a:void 0,a,c,d);const h=l.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||
0);return{modelSize:e,symbolSize:f.isSome(a)?a:l.ONES,unitInMeters:d,transformation:{anchor:b,scale:c,rotation:h}}};S._createClass(L,[{key:"extentPadding",get:function(){return f.isSome(this._resources)?this._resources.extentPadding:0}},{key:"isPrimitive",get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return f.get(this._resources,"lodRenderer")}}]);return L}(H.Graphics3DSymbolLayer);const C=l.create(),Z=W.create(),R=W.create(),
M=z.create(),N={verticalDistanceToGround:0,sampledElevation:0};O.Graphics3DObjectSymbolLayer=H;O.default=H;Object.defineProperty(O,"__esModule",{value:!0})});