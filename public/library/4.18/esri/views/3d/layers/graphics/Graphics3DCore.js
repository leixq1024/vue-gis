// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/has ../../../../core/maybe ../../../../core/Logger ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/property ../../../../core/jsonMap ../../../../core/accessorSupport/decorators/subclass ../../../../core/Error ../../../../core/urlUtils ../../../../core/uuid ../../../../portal/support/resourceExtension ../../../../core/ObjectPool ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/scheduling ../../../../core/Accessor ../../../../geometry/Point ../../../../geometry/Extent ../../../../geometry ../../../../support/arcadeOnDemand ../../../../core/mathUtils ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/WebStyleSymbol ../../../../chunks/symbols ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../core/Handles ../../../../layers/Layer ../../../../renderers/Renderer ../../../../renderers/ClassBreaksRenderer ../../../../core/accessorSupport/diffUtils ../../../../renderers/UniqueValueRenderer ../../../../renderers/DictionaryRenderer ../../../../renderers/DotDensityRenderer ../../../../renderers/HeatmapRenderer ../../../../renderers/SimpleRenderer ../../../../renderers/support/jsonUtils ../../../../core/watchUtils ../../../../geometry/support/aaBoundingRect ../../../../geometry/projection ../../../support/Scheduler ../../../../core/MapUtils ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ./graphicUtils ./featureExpressionInfoUtils ./symbolComplexity ./Graphics3DGraphicCreationContext ./Graphics3DGraphic ../../webgl-engine/lib/Layer ../../webgl-engine/lib/GridLocalOriginFactory ./Graphics3DWebStyleSymbol ../../support/extentUtils ../../support/PropertiesPool ./ElevationQuery ../../../../renderers/support/rendererConversion ../../../../symbols/support/defaults3D ./Graphics3DFeatureStore ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./GraphicStateTracking ./SpatialIndex2D ../support/StageLayerElevationProvider".split(" "),
function(k,M,l,Ga,g,Z,Ha,m,Ia,aa,B,Ja,Ka,La,ba,G,r,ca,da,ea,fa,Ma,ha,y,U,ia,ja,V,H,C,ka,la,Na,Oa,N,I,Pa,Qa,Ra,Sa,Ta,D,ma,x,J,W,E,O,P,na,K,X,oa,pa,qa,ra,sa,ta,ua,va,Y,wa,xa,ya,za,Aa,Ba,Ca){var Q;const R=H.create(),n=E.create(),t=Z.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");k.Graphics3DCore=Q=function(F){function L(a){a=F.call(this,a)||this;a.propertiesPool=new ua.PropertiesPool({computedExtent:fa},M._assertThisInitialized(a));a.computedExtent=null;a.currentRenderer=null;a.rendererHasGeometryOperations=
!1;a.graphicStateTracking=null;a.symbolCreationContext=new ya.Graphics3DSymbolCreationContext;a.graphics3DGraphics=new Map;a.stageLayer=null;a.stage=null;a.graphicsDrapedUids=new Set;a.graphicsBySymbol=new Map;a.symbolConversionCache=new Map;a.symbols=new Map;a.graphicsWithoutSymbol=new Map;a.graphicsWaitingForSymbol=new Set;a._handles=new ka;a._frameTask=J.ImmediateTask;a.suspendSymbolCleanup=!1;a._spatialReference=null;a.arcadeOnDemand=null;a.rendererChangeAbortController=null;a.elevationInfoChangeAbortController=
null;a.setupAbortController=null;a.elevationAlignment=null;a.scaleVisibility=null;a.filterVisibility=null;a._spatialIndex=null;a.extentPadding=0;a._updatingPendingLoadedGraphicsChange=null;a.featureStore=null;a.deconflictor=null;a.labeler=null;a.objectStates=null;a.viewElevationProvider=null;a.stageLayerElevationProvider=null;a.sharedSymbolResourcesOwnerHandle=null;a.whenGraphics3DGraphicRequests={};a.pendingUpdates=new Map;a.numberOfGraphics=0;a.numberOfGraphicsProvidingElevation=0;a.pendingAdds=
0;a.pendingRemoves=0;a.pendingUpdatesPool=new G({allocator:b=>b||new Da,deallocator:b=>{b.clear();return b}});a.symbolWarningLogged=!1;a.geometryWarningLogged=!1;a.objectIdInvisibleSet=new Set;a._whenSymbolRemoved=new G;a.preferredUpdatePolicy=0;a.forcedUpdatePolicy=null;a._asyncUpdates=!1;a.elevationFeatureExpressionEnabled=!0;a.owner=null;a.layer=null;a.graphicSymbolSupported=!0;a.getRenderingInfoWithoutRenderer=!1;a.hasZ=null;a.hasM=null;a._usedMemory=0;a._visible=void 0;a._startCreateGraphics=
!1;a.maxPendingUpdates=0;return a}M._inheritsLoose(L,F);var e=L.prototype;e.getConvertedSymbol=function(a){if("web-style"===a.type)return a.clone();var b=this.symbolConversionCache.get(a.id);if(void 0!==b)return b;b=V.to3D(a,!0,!1,this.hasLabelingContext(a));const c=b.symbol||null;c||b.error&&t.error(b.error.message);this.symbolConversionCache.set(a.id,c);return c};e.getSymbolComplexitiesUsedOrRenderer=function(a){if(g.isNone(a))return[];var b=a.getSymbols(),c="backgroundFillSymbol"in a&&a.backgroundFillSymbol;
if(!(c||b&&b.length))return[];a=[];c=this.getSymbolComplexityUsedOrRenderer(c);g.isSome(c)&&a.push(c);for(const d of b)b=this.getSymbolComplexityUsedOrRenderer(d),g.isSome(b)&&a.push(b);return a};e.getSymbolComplexityUsedOrRenderer=function(a){if(g.isNone(a))return null;const b=this.symbols.get(a.id);return g.isSome(b)?b.complexity:(a=this.getConvertedSymbol(a))?X.defaultSymbolComplexity(a):null};e.getSymbolComplexitiesUsed=function(){const a=[];this.symbols.forEach(b=>{g.isSome(b)&&a.push(b.complexity)});
return a};e.initialize=function(){this._spatialReference=this.owner.view.spatialReference;this._set("featureStore",new xa["default"]({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,getSpatialIndex:()=>this.spatialIndex,forAllGraphics:a=>this.graphics3DGraphics.forEach(a)}))};e.setup=async function(a){this.setupAbortController=r.createAbortController();const b=this.setupAbortController.signal;this._set("elevationAlignment",
a.elevationAlignment);this._set("scaleVisibility",a.scaleVisibility);this._set("filterVisibility",a.filterVisibility);this._set("deconflictor",a.deconflictor);this._set("labeler",a.labeler);this._set("objectStates",a.objectStates);const c=this.owner.view;this.viewElevationProvider=new va.ViewElevationProvider(this._spatialReference,c);this.initializeStage(c,this.layer.uid);this.symbolCreationContext.sharedResources=c.sharedSymbolResources;this.sharedSymbolResourcesOwnerHandle=c.sharedSymbolResources.addGraphicsOwner(this.owner);
g.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer);this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataRequester=c.sharedSymbolResources.streamDataRequester;this.symbolCreationContext.renderCoordsHelper=c.renderCoordsHelper;this.symbolCreationContext.layer=this.layer;this.symbolCreationContext.layerView=this.owner;this.symbolCreationContext.localOriginFactory=new ra;this.symbolCreationContext.elevationProvider=c.elevationProvider;
this.symbolCreationContext.notifyGraphicUpdate=(d,f)=>this.notifyGraphicUpdate(d,f);a=K.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await K.createContext(a,this._spatialReference,t);r.throwIfAborted(b);this.symbolCreationContext.screenSizePerspectiveEnabled=c.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;
this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled;a="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled";this._handles.add([this.watch("suspendedOrOutsideOfView",()=>this.updateLayerVisibility()),this.owner.watch(a,()=>{const d=c.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;d!==this.symbolCreationContext.screenSizePerspectiveEnabled&&
(this.symbolCreationContext.screenSizePerspectiveEnabled=d,this.recreateAllGraphics())}),D.init(this,"preferredUpdatePolicy",()=>this.updateUpdatePolicy(),!0),this.owner.watch("slicePlaneEnabled",d=>this.slicePlaneEnabledChange(!!d)),this.owner.view.watch("pixelRatio",()=>this.pixelRatioChange()),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",d=>this.physicalBasedRenderingChange(d)),D.when(c.basemapTerrain,"tilingScheme",d=>{d.spatialReference.equals(this.symbolCreationContext.overlaySR)||
(this.symbolCreationContext.overlaySR=c.basemapTerrain.spatialReference);this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([D.on(this.owner,"loadedGraphics","change",f=>this.graphicsCollectionChanged(f),()=>this.recreateAllGraphics()),D.on(this.owner,"loadedGraphics","after-changes",()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange(),()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange())],"loaded-graphics")})]);this._frameTask=c.resourceController.scheduler.registerTask(J.Task.GRAPHICS_CORE,
d=>this.update(d),()=>this.needsUpdate());this.owner.layer&&"featureReduction"in this.owner.layer&&this._handles.add(this.owner.watch("layer.featureReduction",()=>this.deconflictor.featureReductionChange()));this.notifyChange("averageSymbolComplexity");try{await this.rendererChange(this.layer.renderer)}catch{}r.throwIfAborted(b);this.setupAbortController=null};e.abortSetup=function(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)};e.destroy=function(){this.abortSetup();
this.abortRendererChange();this.abortElevationInfoChange();this.owner.view.deconflictor.removeGraphicsOwner(this);this.owner.view.labeler.removeGraphicsOwner(this);this._updatingPendingLoadedGraphicsChange&&(this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=null);this.clear();g.isSome(this.graphicStateTracking)&&(this.graphicStateTracking.destroy(),this.graphicStateTracking=null);this.stage&&(this.stage.removeFromViewContent([this.stageLayer.id]),this.stage.remove(0,
this.stageLayer.id),this.stage=this.stageLayer=null);this._handles=g.destroyMaybe(this._handles);this._frameTask.remove();this._frameTask=J.ImmediateTask;this._spatialReference=null;this._set("owner",null);for(const a in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[a].reject(new B("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null;this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=
null);this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null);this.pendingUpdatesPool=null;this.symbolConversionCache.clear();this.objectIdInvisibleSet.clear();this._spatialIndex&&(this._spatialIndex.destroy(),this._spatialIndex=null);this.featureStore&&(this.featureStore.destroy(),this._set("featureStore",null))};e.clear=function(){this.objectStates&&this.objectStates.allGraphicsDeleted();g.isSome(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted();this.graphics3DGraphics.forEach(a=>
a.destroy());this._spatialIndex&&this._spatialIndex.clear();this.graphics3DGraphics.clear();this._usedMemory=this.numberOfGraphics=0;this.updateLayerVisibility();this.symbols.forEach(a=>{g.isSome(a)&&a.destroy()});this.symbols.clear();this.graphicsBySymbol.clear();this.graphicsWithoutSymbol.clear();this.graphicsWaitingForSymbol.clear();this.pendingUpdates.clear();this.pendingUpdatesPool.clear();this.pendingRemoves=this.pendingAdds=this.maxPendingUpdates=0;this.notifyChange("updating");this.notifyChange("updatingTotal");
this.notifyChange("updatingRemaining");this.featureStore.events.emit("changed")};e.initializeStage=function(a,b){this.stage=a._stage;this.stageLayer=new qa(b,{isPickable:!this.suspendedOrOutsideOfView},b);this.stage.add(0,this.stageLayer);this.stage.addToViewContent([this.stageLayer.id]);this.stageLayer.on("dirty",c=>{if(this.graphicStateTracking)switch(c.dirtyType){case "objTransformation":case "objGeometryAdded":case "objGeometryRemoved":case "shaderTransformationChanged":case "vertexAttrsUpdated":this.notifyGraphicUpdate(c.origin.metadata.graphicUid,
2);break;case "visibilityChanged":this.notifyGraphicUpdate(c.origin.metadata.graphicUid,1)}})};e.notifyGraphicUpdate=function(a,b){switch(b){case 1:this.notifyGraphicVisibilityChanged(a);break;case 2:this.notifyGraphicGeometryChanged(a)}};e.notifyGraphicGeometryChanged=function(a){g.isNone(this.graphicStateTracking)||(a=this.graphics3DGraphics.get(a))&&this.graphicStateTracking.updateGraphicGeometry(a)};e.notifyGraphicVisibilityChanged=function(a){g.isNone(this.graphicStateTracking)||(a=this.graphics3DGraphics.get(a))&&
this.graphicStateTracking.updateGraphicVisibility(a)};e.updateLayerVisibility=function(){var a=this.numberOfGraphics>10*this.displayFeatureLimit.maximumNumberOfFeatures;a=!this.suspendedOrOutsideOfView&&!a;a!==this._visible&&((this._visible=a)?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())};e.updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||
0<this.layer.opacity)};e.getGraphics3DGraphicById=function(a){return this.graphics3DGraphics.get(a)};e.getGraphics3DGraphicByObjectId=function(a){var b;return null!=(b=this.owner.layer)&&b.objectIdField?this._findGraphics3DGraphicByObjectId(a):null};e._getGraphicObjectID=function(a,b=this.owner.layer&&this.owner.layer.objectIdField){return O.getObjectId(a,b)};e.updateLabelingInfo=async function(a){const b=this.deconflictor&&this.deconflictor.labelingInfoChange(a);a=this.labeler&&this.labeler.labelingInfoChange(a);
await r.eachAlways([b,a])};e.updateVisibilityInfo=function(){this.deconflictor&&this.deconflictor.labelingInfoChange();this.labeler&&this.labeler.visibilityInfoChange()};e.needsUpdate=function(){return 0<this.pendingUpdates.size};e.update=function(a){this._applyPendingUpdates(a);this.needsUpdate()||this.notifyChange("updating")};e.setObjectIdVisibility=function(a,b){b?this.objectIdInvisibleSet.delete(a):this.objectIdInvisibleSet.add(a);a=this._findGraphics3DGraphicByObjectId(a);g.isSome(a)&&this._updateUserVisibility(a)};
e._findGraphics3DGraphicByObjectId=function(a){return W.findInMap(this.graphics3DGraphics,b=>this._getGraphicObjectID(b.graphic)===a)};e._updateUserVisibility=function(a){if(g.isNone(a))return!1;var b=a.graphic;const c=this._getGraphicObjectID(b);b=b.visible&&!this.owner.suspended&&(g.isNone(c)||!this.objectIdInvisibleSet.has(c));return a.setVisibilityFlag(0,b,0)};e.whenGraphics3DGraphic=function(a){var b=this.graphics3DGraphics.get(a.uid);if(b)return r.resolve(b);if(b=this.whenGraphics3DGraphicRequests[a.uid])return b.promise;
b=r.createDeferred();this.whenGraphics3DGraphicRequests[a.uid]=b;return b.promise};e.boundsForGraphics3DGraphic=async function(a,b){const c=this._spatialReference,d=this.owner.view.renderSpatialReference,f=this.owner.view.basemapTerrain.spatialReference;var h=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:g.isSome(b)&&b.useViewElevation,minDemResolution:g.isSome(b)&&b.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null;a=await a.getProjectedBoundingBox((q,
p,w)=>x.projectBuffer(q,d,p,q,c,p,w),(q,p,w)=>x.projectBuffer(q,f,p,q,c,p,w),h,g.get(b,"signal"));if(!a)return null;b=a.boundingBox;a.requiresDrapedElevation&&(h=this.symbolCreationContext.elevationProvider)&&(E.center(b,R),h=h.getElevation(R[0],R[1],0,c,"ground")||0,b[2]=Math.min(b[2],h),b[5]=Math.max(b[5],h));return{boundingBox:b,screenSpaceObjects:a.screenSpaceObjects}};e.whenGraphicBounds=function(a,b){return D.whenOnce(this.owner,"loadedGraphics").then(()=>{const c=this.owner.layer&&this.owner.layer.objectIdField,
d=this.owner.loadedGraphics.find(f=>f===a?!0:c&&f.attributes&&a.attributes&&f.attributes[c]===a.attributes[c]);if(d)return this.whenGraphics3DGraphic(d);throw new B("internal:graphic-not-part-of-view","Graphic is not part of this view");}).then(c=>this.boundsForGraphics3DGraphic(c,b))};e.computeAttachmentOrigin=function(a,b){a=this.graphics3DGraphics.get(a.uid);if(!a)return null;var c=a.computeAttachmentOrigin();if(0===c.render.num&&0===c.draped.num)return null;C.set(u,0,0,0);a=0;if(0<c.render.num){if(!x.projectVectorToVector(c.render.origin,
this.symbolCreationContext.renderCoordsHelper.spatialReference,z,b))return null;C.add(u,u,z);a++}if(0<c.draped.num){const [d,f]=c.draped.origin;c=this.viewElevationProvider.getElevation(d,f,"ground")||0;C.set(z,d,f,c);if(!x.projectVectorToVector(z,this.viewElevationProvider.spatialReference,z,b))return null;C.add(u,u,z);a++}1<a&&C.scale(u,u,1/a);return new ea({x:u[0],y:u[1],z:u[2],spatialReference:b})};e.getSymbolLayerSize=function(a,b){var c=this.symbols.get(a.id);if(g.isNone(c))throw new B("internal:symbol-not-part-of-view",
"Symbol is not part of this view");a=a.symbolLayers.indexOf(b);if(-1===a)throw new B("internal:missing-symbol-layer","Symbol layer is not in symbol");c=c.getSymbolLayerSize(a);if(null==c)throw new B("internal:missing-size","Symbol layer has no valid size");return c};e.graphicsCollectionChanged=function(a){this._startCreateGraphics&&(this.add(a.added),this.remove(a.removed))};e.graphicUpdateHandler=function(a){var b=a.graphic.uid;const c=this.graphics3DGraphics.get(b);b=this.graphicsWithoutSymbol.get(b);
if(c||b)switch(a.property){case "visible":this.graphicUpdateVisibleHandler(c);break;case "geometry":this.graphicUpdateGeometryHandler(c,a);break;case "symbol":this.graphicUpdateSymbolHandler(c,a)}};e.graphicUpdateGeometryHandler=function(a,b){const c=b.graphic.geometry;if(g.isNone(c))this.recreateGraphic(b.graphic);else if(g.isNone(a)){if(a=b.graphic.symbol&&b.graphic.symbol.id)if(a=this.symbols.get(a),g.isSome(a)&&0===a.loadStatus)return;this.recreateGraphic(b.graphic)}else a.graphics3DSymbol.updateGeometry(a,
b.newValue)||this.recreateGraphic(a.graphic),this.expandComputedExtent(c)};e.graphicUpdateSymbolHandler=function(a,b){var c=b.graphic;const d=g.isSome(a)?a.graphics3DSymbol:b.oldValue&&this.symbols.get(b.oldValue.id);if(g.isNone(d))this.recreateGraphic(c);else{var f=d.symbol;b=this.getConvertedSymbol(b.newValue);if(b.type!==f.type||"web-style"===b.type||"web-style"===f.type)this.recreateGraphic(c);else{var h=this.graphicsBySymbol.get(f.id);if(h&&1!==h.size)this.recreateGraphic(c);else if(h=N.diff(f,
b),g.isNone(h))this.updateSymbolMapping(f.id,b);else if(h={diff:h,graphics3DGraphicPatches:[],symbolStatePatches:[]},d.prepareSymbolPatch(h),N.isEmpty(h.diff)){var q=d.extentPadding;for(const p of h.symbolStatePatches)p();q!==d.extentPadding&&this.recomputeExtentPadding();c=this._getRenderingInfo(c);if(g.isSome(a))for(const p of h.graphics3DGraphicPatches)p(a,c);this.updateSymbolMapping(f.id,b)}else this.recreateGraphic(c)}}};e.graphicUpdateVisibleHandler=function(a){this._updateUserVisibility(a)&&
(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};e.recreateGraphics=function(a){this.suspendSymbolCleanup=!0;this.remove(a);this.add(a);this.suspendSymbolCleanup=!1;this.asyncUpdates||this._cleanupSymbols()};e.recreateGraphic=function(a){this.recreateGraphics([a])};e._beginGraphicUpdate=function(a){this.graphicsWaitingForSymbol.add(a.uid);1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating");this._get("symbolsUpdating")||this._set("symbolsUpdating",
!0)};e._endGraphicUpdate=function(a){a&&(this.graphicsWaitingForSymbol.delete(a.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"),this._get("symbolsUpdating")&&(this.owner.view.flushDisplayModifications(),this._set("symbolsUpdating",!1))))};e.recomputeExtentPadding=function(){let a=0;this.symbols.forEach(b=>{g.isSome(b)&&(a=Math.max(a,b.extentPadding))});this._set("extentPadding",a)};e.expandComputedExtent=function(a){var b=a.spatialReference;O.computeAABB(a,
n);a=this._spatialReference;var c=Q.tmpVec;!b.equals(a)&&x.projectXYZToVector(n[0],n[1],0,b,c,a)&&(n[0]=c[0],n[1]=c[1],x.projectXYZToVector(n[3],n[4],0,b,c,a),n[3]=c[0],n[4]=c[1]);if(y.isFinite(n[0])&&y.isFinite(n[3])&&y.isFinite(n[1])&&y.isFinite(n[4])){b=this.computedExtent;c=null;var d=y.isFinite(n[2])&&y.isFinite(n[5]),f=d&&(!b||null==b.zmin||n[2]<b.zmin);d=d&&(!b||null==b.zmax||n[5]>b.zmax);if(b){if(n[0]<b.xmin||n[1]<b.ymin||n[3]>b.xmax||n[4]>b.ymax||f||d)c=this.propertiesPool.get("computedExtent"),
c.xmin=Math.min(n[0],b.xmin),c.ymin=Math.min(n[1],b.ymin),c.xmax=Math.max(n[3],b.xmax),c.ymax=Math.max(n[4],b.ymax),c.spatialReference=a}else c=this.propertiesPool.get("computedExtent"),c.xmin=n[0],c.ymin=n[1],c.xmax=n[3],c.ymax=n[4],c.spatialReference=a;c&&(f&&(c.zmin=n[2]),d&&(c.zmax=n[5]),this._set("computedExtent",c))}};e.abortElevationInfoChange=function(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)};
e.elevationInfoChange=async function(){this.abortElevationInfoChange();const a=r.createAbortController();this.elevationInfoChangeAbortController=a;const b=K.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await K.createContext(b,this._spatialReference,t);r.throwIfAborted(a);this.elevationInfoChangeAbortController=null;this.labeler&&this.labeler.elevationInfoChange();this.forEachGraphics3DSymbol((c,d,f)=>
{c.globalPropertyChanged("elevationInfo",d)?d.forEach(h=>{const q=h.graphic;h=h.labelGraphics;for(const p of h)p.graphics3DSymbolLayer.updateGraphicElevationContext(q,p)}):this._recreateSymbol(f)});this.updateStageLayerElevationProvider();this.elevationAlignment&&this.elevationAlignment.elevationInfoChange()};e.updateStageLayerElevationProvider=function(){if(this.stageLayerElevationProvider){if(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),
this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&0<this.numberOfGraphicsProvidingElevation&&(this.stageLayerElevationProvider=new Ca.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))};e.clearSymbolsAndGraphics=function(){this.clear();
this.filterVisibility&&this.filterVisibility.clear();this.labeler&&this.labeler.reset();this.deconflictor&&this.deconflictor.clear();this.elevationAlignment&&this.elevationAlignment.clear();this.stageLayer&&this.stageLayer.invalidateSpatialQueryAccelerator();this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)};e.startCreateGraphics=function(){this._startCreateGraphics=
!0;this.recreateAllGraphics()};e.recreateAllGraphics=function(){this._startCreateGraphics&&(this.clearSymbolsAndGraphics(),this._set("computedExtent",null),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.owner.loadedGraphics&&this.owner.loadedGraphics.length&&this.owner.view.basemapTerrain.tilingScheme&&this.add(this.owner.loadedGraphics.toArray()))};
e._recreateSymbol=function(a){var b=this.graphicsBySymbol.get(a);const c=[];b&&(b.forEach((d,f)=>{const h=d.usedMemory;this._conditionalRemove(d,f);this._spatialIndex&&this._spatialIndex.remove(d);c.push(d.graphic);d.destroy();this.removeGraphics3DGraphic(f,h);this.updateLayerVisibility();this.featureStore.events.emit("changed")}),this.graphicsBySymbol.set(a,new Map));b=this.symbols.get(a);g.isSome(b)&&b.destroy();this.symbols.delete(a);this.add(c)};e._conditionalRemove=function(a,b){a.isDraped&&
this.graphicsDrapedUids.delete(b);this.objectStates&&this.objectStates.removeGraphic(a);this.labeler&&this.labeler.removeGraphic(a);this.deconflictor&&this.deconflictor.removeGraphic(a);g.isSome(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(a)};e.add=function(a){a&&0!==a.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this.asyncUpdates?this._addDelayed(a):this._addImmediate(a),this.notifyChange("updating")):t.error("#add()","Cannot add graphics before terrain surface has been initialized"))};
e._addImmediate=function(a){this.symbolWarningLogged=this.geometryWarningLogged=!1;v.clear();for(const b of a)this._startAddGraphic(b,this._getRenderingInfo(b,t),v);v.forEach(b=>this._finishAddGraphics(b));v.clear();this._cleanupSymbols();this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols());this.owner.view.deconflictor.setDirty()};e._addDelayed=function(a){for(const b of a){a=b.uid;let c=this.pendingUpdates.get(a);c?c.add?0!==c.state&&c.abortController.abort():this.pendingAdds++:
(c=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(a,c));c.add=b}this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size);this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining")};e.remove=function(a){this.asyncUpdates?this._removeDelayed(a):this._removeImmediate(a);this.notifyChange("updating")};e._removeImmediate=function(a){for(const b of a)this._removeGraphic(b);this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();
this.owner.view.deconflictor.setDirty()};e._removeDelayed=function(a){for(const c of a){a=c.uid;var b=this.pendingUpdates.get(a);b?b.add&&(b.remove?b.add=null:this.pendingUpdates.delete(a),1===b.state&&b.abortController.abort(),this.pendingAdds--):(b=this.pendingUpdatesPool.pushNew(),b.remove=c,this.pendingUpdates.set(a,b),this.pendingRemoves++)}0===this.pendingUpdates.size&&this._finishPendingUpdates();this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size);this.notifyChange("updatingTotal");
this.notifyChange("updatingRemaining")};e._finishPendingUpdates=function(){this.pendingUpdatesPool.clear();this.maxPendingUpdates=0;this._cleanupSymbols();(this.pendingAdds||this.pendingRemoves)&&t.warn("pendingAdds/Removes in inconsistent state!");this.pendingRemoves=this.pendingAdds=0};e._applyPendingUpdates=function(a){this.symbolWarningLogged=this.geometryWarningLogged=!1;const b=2===a.state?1E3:100;let c=0;v.clear();for(const [d,f]of this.pendingUpdates){f.add&&0===f.state&&this._startAddRenderingInfo(f);
!f.remove||f.add&&2!==f.state||(this.pendingRemoves--,a.madeProgress(),this._removeGraphic(f.remove),f.remove=null);if(f.add)switch(f.state){case 2:this._startAddGraphic(f.add,f.renderingInfo,v)&&c++;f.add=null;this.pendingAdds--;a.madeProgress();break;case 3:f.add=null,this.pendingAdds--}c>b&&(v.forEach(h=>this._finishAddGraphics(h)),v.clear(),c=0);null==f.remove&&null==f.add&&this.pendingUpdates.delete(d);if(a.done)break}v.forEach(d=>this._finishAddGraphics(d));v.clear();0===this.pendingUpdates.size&&
this._finishPendingUpdates();this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining")};e._startAddRenderingInfo=function(a){g.isSome(this.layer.renderer)&&"dictionary"===this.layer.renderer.type?(a.state=1,a.abortController=r.createAbortController(),this._getRenderingInfoAsync(a.add,{signal:a.abortController.signal}).then(b=>{g.isNone(b)||g.isNone(b.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),
a.renderingInfo=null):a.renderingInfo=b;a.state=2},b=>{a.abortController=null;r.isAbortError(b)?a.state=0:a.state=3})):(a.renderingInfo=this._getRenderingInfo(a.add,t),a.state=2)};e._startAddGraphic=function(a,b,c){this.graphicsWithoutSymbol.set(a.uid,a);if(!b||g.isNone(b.symbol)||!O.hasGeometry(a))return!1;const d=this.getOrCreateGraphics3DSymbol(b.symbol,b.renderer);if(g.isNone(d))return!1;this.expandComputedExtent(a.geometry);this._beginGraphicUpdate(a);a=new oa(a,b,this.layer);b=d.symbol.id;var f=
c.get(b);f?f.graphics.push(a):(f=S.acquire(),f.clear(),f.push(a),c.set(b,{asyncSymbol:d,graphics:f}));return!0};e._finishAddGraphics=function(a){let b=!1;const c=d=>{d===a.asyncSymbol.symbol.id&&(b=!0)};this._whenSymbolRemoved.push(c);a.asyncSymbol.load(()=>{this.destroyed||(this._whenSymbolRemoved.removeUnordered(c),A.clear(),a.graphics.forAll(d=>{const f=d.graphic;b||a.asyncSymbol.destroyed||this.graphicSymbolSupported&&f.symbol&&f.symbol.id!==a.asyncSymbol.symbol.id||(this.graphicsWaitingForSymbol.has(f.uid)&&
(d=this.createGraphics3DGraphic(a.asyncSymbol,d),this._spatialIndex&&g.isSome(d)&&A.push(d)),this._endGraphicUpdate(f));--a.asyncSymbol.referenced}),0<A.length&&(this._spatialIndex.addMany(A.data,A.length),A.clear()),this.featureStore.events.emit("changed"),a.graphics.clear(),S.release(a.graphics),this.labeler&&this.owner.view.labeler.setDirty())},d=>{this.destroyed||(this._whenSymbolRemoved.removeUnordered(c),b||(r.isAbortError(d)?this.add(a.graphics.map(f=>f.graphic)):a.asyncSymbol.destroyed||a.graphics.forAll(({graphic:f})=>
this._endGraphicUpdate(f))),a.graphics.clear(),S.release(a.graphics))})};e._removeGraphic=function(a){a=a.uid;const b=this.graphics3DGraphics.get(a);if(b){b.graphics3DSymbol.onRemoveGraphic(b);const c=b.usedMemory,d=b.isElevationSource;this._conditionalRemove(b,a);this._spatialIndex&&this._spatialIndex.remove(b);this.graphicsBySymbol.get(b.graphics3DSymbol.symbol.id).delete(a);this.graphicsWithoutSymbol.delete(a);this.removeGraphics3DGraphic(a,c,d);b.destroy();this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(a),
this.graphicsWaitingForSymbol.delete(a)};e.hasLabelingContext=function(a){if(a instanceof U||a instanceof ia){const b=this.symbolCreationContext.layer;return b.labelingInfo?b.labelingInfo.some(c=>c.symbol===a):!1}return!1};e.hasValidSymbolCreationContext=function(a){return a instanceof U&&!this.hasLabelingContext(a)?(t.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0};e._getRenderingInfo=function(a,b){const c=a.geometry;
if(g.isNone(c))return b&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!x.canProjectWithoutEngine(c.spatialReference,this._spatialReference))return b&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&g.isSome(a.symbol))return b&&!this.symbolWarningLogged&&
(this.symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?P.hydrateGraphic(a,this.layer):a;a=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||g.isSome(this.currentRenderer))?this.owner.getRenderingInfo(a,this.currentRenderer,g.unwrap(this.arcadeOnDemand)):{symbol:a.symbol||wa.getDefaultSymbol3D(a.geometry)};return!a||g.isNone(a.symbol)?(b&&!this.symbolWarningLogged&&
(this.symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):a};e._getRenderingInfoAsync=function(a,b){if(g.isNone(a.geometry))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&g.isSome(a.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),
null;a=this.rendererHasGeometryOperations?P.hydrateGraphic(a,this.layer):a;return this.owner.getRenderingInfoAsync(a,g.unwrap(this.currentRenderer),g.unwrap(this.arcadeOnDemand),b)};e.createGraphics3DSymbol=function(a,b){if(!this.hasValidSymbolCreationContext(a))return null;a=this.getConvertedSymbol(a);if(!a)return null;let c;g.isSome(b)&&"backgroundFillSymbol"in b&&b.backgroundFillSymbol&&(b=V.to3D(b.backgroundFillSymbol,!1,!0),b.symbol&&"web-style"!==b.symbol.type&&(c=b.symbol.symbolLayers));const d=
za.make(a,this.symbolCreationContext,c);d.load(()=>{const f=d.extentPadding;f>this.extentPadding&&this._set("extentPadding",f);this.notifyChange("averageSymbolComplexity")},()=>{});return d};e.getOrCreateGraphics3DSymbol=function(a,b){let c=this.symbols.get(a.id);void 0===c&&(c=a instanceof ja?new sa(a,d=>this.createGraphics3DSymbol(d,b)):this.createGraphics3DSymbol(a,b),this.symbols.set(a.id,c));g.isSome(c)&&++c.referenced;return c};e.trackGraphicState=function(a){g.isNone(this.graphicStateTracking)&&
(this.graphicStateTracking=new Aa.GraphicStateTracking(this));return this.graphicStateTracking.add(a)};e.addGraphics3DGraphic=function(a){this._usedMemory+=a.usedMemory;this.graphics3DGraphics.set(a.graphic.uid,a);this.numberOfGraphics++;a.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider());this.updateLayerVisibility()};e.removeGraphics3DGraphic=function(a,b,c=!1){this._usedMemory-=b;this.graphics3DGraphics.delete(a);this.numberOfGraphics--;c&&(this.numberOfGraphicsProvidingElevation--,
this.updateStageLayerElevationProvider());this.updateLayerVisibility()};e.createGraphics3DGraphic=function(a,b){const c=b.graphic;this.graphicsWithoutSymbol.delete(c.uid);if(!this.symbols.has(a.symbol.id))return this.add([c]),null;if(this.graphics3DGraphics.has(c.uid))return null;b=a.createGraphics3DGraphic(b);if(g.isNone(b))return null;this.addGraphics3DGraphic(b);a=a.symbol.id;this.graphicsBySymbol.has(a)||this.graphicsBySymbol.set(a,new Map);this.graphicsBySymbol.get(a).set(c.uid,b);b.isDraped&&
this.graphicsDrapedUids.add(c.uid);b.centroid=null;g.isSome(c.geometry)&&"point"!==c.geometry.type&&b instanceof pa&&(b.centroid=na.computeCentroid(c.geometry,this._spatialReference));this._updateUserVisibility(b);this.scaleVisibility&&this.scaleVisibility.updateVisibility(b);this.filterVisibility&&this.filterVisibility.updateVisibility(b);this.deconflictor&&this.deconflictor.addGraphic(b);this.labeler&&this.labeler.addGraphic(b);this.objectStates&&this.objectStates.addGraphic(b);this.deconflictor&&
this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,b);b.initialize(this.stage,this.stageLayer,this.owner);g.isSome(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(b);if(a=this.whenGraphics3DGraphicRequests[c.uid])delete this.whenGraphics3DGraphicRequests[c.uid],a.resolve(b);return b};e.abortRendererChange=function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)};e.rendererChange=async function(a){this.abortRendererChange();
if(a!==this.currentRenderer)if(this.validateRenderer(a),Y.isSupportedRenderer3D(a))if(g.isSome(a)&&a.arcadeRequired){var b=r.createAbortController();this.rendererChangeAbortController=b;const {arcadeUtils:c}=await this.ensureArcade();r.throwIfAborted(b);c.hasGeometryOperations(a)&&(await c.enableGeometryOperations(),r.throwIfAborted(b));this.asyncUpdates?await this._frameTask.schedule(()=>this.currentRendererChange(a,!0),b.signal):this.currentRendererChange(a,!0);this.rendererChangeAbortController=
null}else this.asyncUpdates?(this.rendererChangeAbortController=b=r.createAbortController(),await this._frameTask.schedule(()=>this.currentRendererChange(a,!1),b.signal),this.rendererChangeAbortController=null):this.currentRendererChange(a,!1);else this.currentRendererChange(null,!1)};e.ensureArcade=async function(){g.isNone(this.arcadeOnDemand)&&(this.arcadeOnDemand=await ha.loadArcade());return this.arcadeOnDemand};e.currentRendererChange=function(a,b){this.currentRenderer=a;this.rendererHasGeometryOperations=
b;this.symbolCreationContext.arcade=g.unwrap(this.arcadeOnDemand);b=this.symbolCreationContext.renderer;if(a!==b)if(this.updateUpdatePolicy(),this.symbolConversionCache.clear(),g.isNone(a))this.symbolCreationContext.renderer=null,this.recreateAllGraphics();else{var c=N.diff(b,a);this.updateUnchangedSymbolMappings(c,a,b);this.symbolCreationContext.renderer=a;g.isNone(c)||("complete"===c.type?this.recreateAllGraphics():"partial"===c.type&&(this.applyRendererDiff(c,a,b)?this.volatileGraphicsUpdated():
this.recreateAllGraphics()),this.notifyChange("averageSymbolComplexity"))}};e.diffHasSymbolChange=function(a){for(const b in a.diff)switch(b){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;case "authoringInfo":case "fieldDelimiter":delete a.diff[b];break;default:return!0}return!1};e.applySymbolSetDiff=function(a,b,c){a=a||[];b=b||[];const d=[];for(const f of b){const h=this.graphicsBySymbol.get(f.id);h&&h.forEach((q,p)=>{var w=q.graphic,T=this.layer instanceof la?this.layer:
null;const Ea=g.unwrap(this.arcadeOnDemand);if(f!==c.defaultSymbol||c.getSymbol(P.hydrateGraphic(w,T),{arcade:Ea})!==c.defaultSymbol)T=q.usedMemory,a.length||c.defaultSymbol?d.push(w):this.graphicsWithoutSymbol.set(p,w),w=this.graphics3DGraphics.get(p),this._conditionalRemove(w,p),q.destroy(),h.delete(p),this.removeGraphics3DGraphic(p,T),this.updateLayerVisibility()});this._whenSymbolRemoved.forAll(q=>q(f.id))}if(a.length||d.length)this.graphicsWithoutSymbol.forEach(f=>d.push(f)),this.graphicsWithoutSymbol.clear(),
this.add(d);this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};e.applyUniqueValueRendererDiff=function(a,b,c){const d=a.diff.defaultSymbol,f=a.diff.uniqueValueInfos;if(d||f){const h=f?f.added.map(p=>p.symbol):[],q=f?f.removed.map(p=>p.symbol):[];if(f)for(let p=0;p<f.changed.length;p++)h.push(f.changed[p].newValue.symbol),q.push(f.changed[p].oldValue.symbol);d?(c.defaultSymbol&&q.push(c.defaultSymbol),b.defaultSymbol&&h.push(b.defaultSymbol)):
c.defaultSymbol&&h.length&&q.push(b.defaultSymbol);this.applySymbolSetDiff(h,q,b);delete a.diff.defaultSymbol;delete a.diff.uniqueValueInfos;return!0}return!1};e.calculateUnchangedSymbolMapping=function(a,b,c){const d=h=>g.isSome(h)?h.id:null;if(b instanceof I&&c instanceof I&&(g.isNone(a)||"partial"===a.type)){var f=a&&a.diff;a=f&&f.defaultSymbol;f=(f=f&&f.uniqueValueInfos)?f.unchanged.map(h=>({oldId:d(h.oldValue.symbol),newId:d(h.newValue.symbol)})):c.uniqueValueInfos.map((h,q)=>({oldId:d(h.symbol),
newId:d(b.uniqueValueInfos[q].symbol)}));!a&&c.defaultSymbol&&f.push({oldId:d(c.defaultSymbol),newId:d(b.defaultSymbol)});return f}return[]};e.updateSymbolMapping=function(a,b){const c=b?"string"===typeof b?b:b.id:null;b="string"===typeof b?null:b;if(a&&a!==c){var d=this.graphicsBySymbol.get(a);this.graphicsBySymbol.delete(a);void 0!==d&&this.graphicsBySymbol.set(c,d);d=this.symbols.get(a);void 0!==d&&(this.symbols.delete(a),this.symbols.set(c,d),g.isSome(d)&&(g.isSome(b)?d.symbol=b:d.symbol.id=c))}};
e.updateUnchangedSymbolMappings=function(a,b,c){a=this.calculateUnchangedSymbolMapping(a,b,c);for(const {oldId:d,newId:f}of a)this.updateSymbolMapping(d,f)};e.applyRendererDiff=function(a,b,c){if(this.diffHasSymbolChange(a))return!1;if(b instanceof I&&c instanceof I&&this.applyUniqueValueRendererDiff(a,b,c)&&0===Object.keys(a.diff).length)return!0;for(const [d]of this.graphicsBySymbol)if(c=this.symbols.get(d),g.isSome(c)&&!c.applyRendererDiff(a,b))return!1;return!0};e.opacityChange=function(){this.forEachGraphics3DSymbol((a,
b)=>a.globalPropertyChanged("opacity",b));this.updateStageLayerVisibility()};e.updateUpdatePolicy=function(){const a=g.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type;g.isSome(this.forcedUpdatePolicy)?this._asyncUpdates=1===this.forcedUpdatePolicy:this._asyncUpdates=1===this.preferredUpdatePolicy||a;(this.symbolCreationContext.isAsync=this._asyncUpdates)||this.update(J.noBudget)};e.slicePlaneEnabledChange=function(a){a!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=
a,this.stageLayer.isSliceable=a,this.forEachGraphics3DSymbol((b,c)=>b.globalPropertyChanged("slicePlaneEnabled",c)),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())};e.physicalBasedRenderingChange=function(a){a!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=a,this.forEachGraphics3DSymbol((b,c)=>b.globalPropertyChanged("physicalBasedRenderingEnabled",c)))};e.pixelRatioChange=
function(){this.forEachGraphics3DSymbol((a,b,c)=>{a.globalPropertyChanged("pixelRatio",b)||this._recreateSymbol(c)})};e._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove();this._updatingPendingLoadedGraphicsChange=ca.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})};e.setClippingExtent=function(a,b){const c=this.symbolCreationContext.clippingExtent,d=ma.create();ta.toBoundingRect(a,d,
b)?this.symbolCreationContext.clippingExtent=E.fromRect(E.create(),d):this.symbolCreationContext.clippingExtent=null;return!E.equals(this.symbolCreationContext.clippingExtent,c)};e.modifyGraphics3DGraphicVisibilities=function(a){let b=!1;this.graphics3DGraphics.forEach(c=>{a(c)&&(b=!0)});b&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};e.forEachGraphics3DSymbol=function(a){for(const [b,c]of this.symbols){if(g.isNone(c))break;const d=this.graphicsBySymbol.get(b);
a(c,d||Fa,b)}};e.updateAllGraphicsVisibility=function(){this.filterVisibility&&(this.filterVisibility.dirty=!0);this.modifyGraphics3DGraphicVisibilities(a=>{const b=this._updateUserVisibility(a);a=this.scaleVisibility&&this.scaleVisibility.updateVisibility(a);return b||a})};e.hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities(a=>a.setVisibilityFlag(0,!1,0))};e.validateRenderer=function(a){(a=Y.validateTo3D(a))&&t.warn(`Renderer for layer '${this.layer.title?`${this.layer.title}, `:
""}, id:${this.layer.id}' is not supported in a SceneView`,a.message)};e.volatileGraphicsUpdated=function(){this.labeler&&this.labeler.reset();this.stageLayer.invalidateSpatialQueryAccelerator();this.stageLayer.shaderTransformationChanged();this.notifyChange("updating")};e._cleanupSymbols=function(){if(!(0<this.graphicsWaitingForSymbol.size||this.suspendSymbolCleanup)){var a=!1;this.symbols.forEach((b,c)=>{if(!(g.isNone(b)||0<b.referenced)){var d=this.graphicsBySymbol.get(c);d&&0!==d.size||(this.graphicsBySymbol.delete(c),
this.symbols.delete(c),b&&b.destroy(),a=!0)}});a&&(this.recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}};e.snapshotInternals=function(){return{graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this.symbols.keys()].sort(),graphicsBySymbol:[...this.graphicsBySymbol.keys()].sort().map(a=>({symbolId:a,graphics:[...this.graphicsBySymbol.get(a).keys()].sort()})),graphicsWithoutSymbol:[...this.graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this.graphicsDrapedUids].sort(),
pendingUpdates:this.pendingUpdates}};M._createClass(L,[{key:"spatialIndex",get:function(){if(!this._spatialIndex){this._spatialIndex=new Ba["default"]({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM});let a=0;const b=Array(this.graphics3DGraphics.size);this.graphics3DGraphics.forEach(c=>b[a++]=c);this._spatialIndex.addMany(b)}return this._spatialIndex}},{key:"asyncUpdates",get:function(){return this._asyncUpdates}},
{key:"updating",get:function(){return!!(0<this.graphicsWaitingForSymbol.size||this.needsUpdate()||this.elevationAlignment&&this.elevationAlignment.updating||this.scaleVisibility&&this.scaleVisibility.updating||this.filterVisibility&&this.filterVisibility.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating)}},{key:"suspendedOrOutsideOfView",get:function(){var a;return this.owner.suspended||(null==
(a=this.owner.suspendInfo)?void 0:a.outsideOfView)}},{key:"updatingRemaining",get:function(){return this.updating?this.pendingUpdates.size:0}},{key:"updatingTotal",get:function(){return this.updating?this.maxPendingUpdates:0}},{key:"displayFeatureLimit",get:function(){var a=this.owner&&this.owner.view&&this.owner.view.qualitySettings;const b=a?a.graphics3D.minTotalNumberOfFeatures:0,c=a?a.graphics3D.maxTotalNumberOfFeatures:0;a=a?a.graphics3D.maxTotalNumberOfPrimitives:0;const d=this.averageSymbolComplexity;
var f=Math.max(1,g.isSome(d)?d.primitivesPerFeature:1),h=g.isSome(d)&&0<d.drawCallsPerFeature?c/d.drawCallsPerFeature*.3:c;f=Math.max(b,Math.min(c,Math.ceil(a/f),h));return(h=this._get("displayFeatureLimit"))&&h.minimumTotalNumberOfFeatures===b&&h.maximumTotalNumberOfFeatures===c&&h.maximumTotalNumberOfPrimitives===a&&h.averageSymbolComplexity===d&&h.maximumNumberOfFeatures===f?h:{minimumTotalNumberOfFeatures:b,maximumTotalNumberOfFeatures:c,maximumTotalNumberOfPrimitives:a,averageSymbolComplexity:d,
maximumNumberOfFeatures:f}}},{key:"averageSymbolComplexity",get:function(){const a=X.averageSymbolComplexities(this.symbolComplexities),b=this._get("averageSymbolComplexity");return 0===a.numComplexities||g.isSome(b)&&(a.estimated&&(b.primitivesPerFeature>=a.primitivesPerFeature||b.primitivesPerCoordinate>=a.primitivesPerCoordinate||b.drawCallsPerFeature>=a.drawCallsPerFeature)||b.primitivesPerFeature===a.primitivesPerFeature&&b.primitivesPerCoordinate===a.primitivesPerCoordinate&&b.drawCallsPerFeature===
a.drawCallsPerFeature)?b:a}},{key:"spatialReference",get:function(){return this._spatialReference}},{key:"usedMemory",get:function(){const a=g.isSome(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+a}},{key:"usedMemoryPerGraphic",get:function(){return this._usedMemory&&this.numberOfGraphics?this._usedMemory/this.numberOfGraphics:g.isSome(this.averageSymbolComplexity)?this.averageSymbolComplexity.memory.bytesPerFeature+
(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}},{key:"unprocessedMemoryEstimate",get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}},{key:"symbolComplexities",get:function(){return this.currentRenderer?this.getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this.getSymbolComplexitiesUsed()}},{key:"graphics3DGraphicsByObjectID",get:function(){const a=this.owner.layer&&this.owner.layer.objectIdField;if(!a)return null;
const b=new Map;this.graphics3DGraphics.forEach(c=>{if(c){var d=this._getGraphicObjectID(c.graphic,a);g.isSome(d)&&b.set(d,c)}});return b}},{key:"labelsEnabled",get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())}},{key:"symbolUpdateType",get:function(){if(0<this.pendingUpdates.size)return"unknown";let a=0,b=0;return W.someMap(this.symbols,(c,d)=>{if(g.isSome(c)){c=c.getFastUpdateStatus();if(0<c.loading)return!0;this.graphicsBySymbol.has(d)&&(b+=c.fast,a+=c.slow)}return!1})?
"unknown":0<=b&&0===a?"fast":0<=a&&0===b?"slow":"mixed"}},{key:"test",get:function(){return{symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:a=>{this.forcedUpdatePolicy=a;this.updateUpdatePolicy()}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}}]);return L}(da);k.Graphics3DCore.tmpVec=H.create();l.__decorate([m.property({readOnly:!0})],
k.Graphics3DCore.prototype,"computedExtent",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"currentRenderer",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_frameTask",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"rendererChangeAbortController",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"elevationInfoChangeAbortController",void 0);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"setupAbortController",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"elevationAlignment",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"scaleVisibility",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"filterVisibility",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"extentPadding",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",
void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"featureStore",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"deconflictor",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"labeler",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"objectStates",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,
"elevationFeatureExpressionEnabled",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"owner",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"layer",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"symbolsUpdating",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"graphicSymbolSupported",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"getRenderingInfoWithoutRenderer",
void 0);l.__decorate([m.property({readOnly:!0,dependsOn:"elevationAlignment.updating scaleVisibility.updating filterVisibility.updating rendererChangeAbortController elevationInfoChangeAbortController _updatingPendingLoadedGraphicsChange _frameTask.updating".split(" ")})],k.Graphics3DCore.prototype,"updating",null);l.__decorate([m.property({readOnly:!0,dependsOn:["owner.suspended","owner.suspendInfo"]})],k.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null);l.__decorate([m.property({readOnly:!0,
dependsOn:[],autoTracked:!1})],k.Graphics3DCore.prototype,"updatingRemaining",null);l.__decorate([m.property({readOnly:!0,dependsOn:[],autoTracked:!1})],k.Graphics3DCore.prototype,"updatingTotal",null);l.__decorate([m.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"],autoTracked:!1})],k.Graphics3DCore.prototype,"displayFeatureLimit",null);l.__decorate([m.property({readOnly:!0,
dependsOn:[],autoTracked:!1})],k.Graphics3DCore.prototype,"averageSymbolComplexity",null);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"hasZ",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"hasM",void 0);k.Graphics3DCore=Q=l.__decorate([aa.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],k.Graphics3DCore);const v=new Map,A=new G,S=new ba(G);let Da=function(){function F(){this.renderingInfo=this.add=null;this.state=0;this.remove=
null}F.prototype.clear=function(){this.renderingInfo=this.add=null;this.state=0;this.remove=this.abortController=null};return F}();const u=H.create(),z=H.create(),Fa=new Map;Object.defineProperty(k,"__esModule",{value:!0})});