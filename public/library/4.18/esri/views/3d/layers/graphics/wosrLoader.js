// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/lang ../../../../core/maybe ../../../../core/Logger ../../../../core/Error ../../../../core/promiseUtils ../../../../request ../../../../core/asyncUtils ../../../../chunks/vec3f64 ../../../../core/Version ../../../../geometry/support/aaBoundingBox ../../../../support/requestImageUtils ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Geometry ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/lib/Texture".split(" "),function(u,I,v,J,K,w,L,C,D,
E,z,M,N,O,P,Q){async function R(a,c){const h=v.isSome(c)&&c.streamDataRequester;if(h)return S(a,h,c);a=await C.result(L(a,v.unwrap(c)));if(!0===a.ok)return a.value.data;w.throwIfAbortError(a.error);F(a.error)}async function S(a,c,h){a=await C.result(c.request(a,"json",h));if(!0===a.ok)return a.value;w.throwIfAbortError(a.error);F(a.error.details.url)}function F(a){throw new K("",`Request for object resource failed: ${a}`);}function T(a){const c=z.empty();a.forEach(h=>{h=h.boundingInfo;z.expandWithVec3(c,
h.getBBMin());z.expandWithVec3(c,h.getBBMax())});return c}async function G(a,c){const h=[];for(const m in a){const r=a[m];var n=r.images[0].data;if(!n){p.warn("Externally referenced texture data is not yet supported");continue}n=r.encoding+";base64,"+n;const t="/textureDefinitions/"+m,q={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0};n=v.isSome(c)&&c.disableTextures?w.resolve(null):M.requestImage(n,c);h.push(n.then(x=>({refId:t,image:x,params:q,alphaChannelUsage:"rgba"===r.channels?r.alphaChannelUsage||
"transparency":"none"})))}a=await w.all(h);c={};for(const m of a)c[m.refId]=m;return c}function U(a){switch(a){case "mask":return 2;case "maskAndTransparency":return 3;case "none":return 1;case "transparency":return 0;default:return 0}}const p=J.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),V=new E.Version(1,2,"wosr");u.createTextureResources=G;u.load=async function(a,c){a=await R(a,c);c=await G(a.textureDefinitions,c);return{resource:a,textures:c}};u.processLoadResult=function(a,
c){const h=[],n=[],m=[],r=[],t=a.resource;var q=E.Version.parse(t.version||"1.0","wosr");V.validate(q);q=t.model.name;const x=t.model.geometries,W=t.materialDefinitions;a=a.textures;let H=0;const A=new Map;for(let B=0;B<x.length;B++){var e=x[B],l=e,d=l.params,g=d.topology;var b=!0;d.vertexAttributes||(p.warn("Geometry must specify vertex attributes"),b=!1);switch(d.topology){case "PerAttributeArray":break;case "Indexed":case null:case void 0:g=d.faces;if(!g)p.warn("Indexed geometries must specify faces"),
b=!1;else if(d.vertexAttributes)for(const k in d.vertexAttributes)(d=g[k])&&d.values?(null!=d.valueType&&"UInt32"!==d.valueType&&(p.warn(`Unsupported indexed geometry indices type '${d.valueType}', only UInt32 is currently supported`),b=!1),null!=d.valuesPerElement&&1!==d.valuesPerElement&&(p.warn(`Unsupported indexed geometry values per element '${d.valuesPerElement}', only 1 is currently supported`),b=!1)):(p.warn(`Indexed geometry does not specify face indices for '${k}' attribute`),b=!1);break;
default:p.warn(`Unsupported topology '${g}'`),b=!1}l.params.material||(p.warn("Geometry requires material"),b=!1);l=l.params.vertexAttributes;for(const k in l)l[k].values||(p.warn("Geometries with externally defined attributes are not yet supported"),b=!1);if(b){b=e.params;b={id:1,material:b.material,texture:b.texture,region:b.texture};d=e.params.vertexAttributes;l={};for(const k in d)g=d[k],l[k]={data:g.values,size:g.valuesPerElement};d={};if("PerAttributeArray"===e.params.topology){e=l.position.data.length/
l.position.size;g=new Uint32Array(e);for(var f=0;f<e;f++)g[f]=f;e=g;for(const k in l)d[k]=e}else{e=e.params.faces;for(const k in e)d[k]=new Uint32Array(e[k].values)}if((e=a&&a[b.texture])&&!A.has(b.texture)){const {image:k,params:X}=e;g=new Q(k,q,X);r.push(g);A.set(b.texture,g)}g=(g=A.get(b.texture))?g.id:void 0;f=m[b.material]?m[b.material][b.texture]:null;if(!f){f=b.material.substring(b.material.lastIndexOf("/")+1);f=W[f].params;1===f.transparency&&(f.transparency=0);var y=e&&e.alphaChannelUsage;
y=0<f.transparency||"transparency"===y||"maskAndTransparency"===y;e={ambient:D.fromArray(f.diffuse),diffuse:D.fromArray(f.diffuse),opacity:1-(f.transparency||0),transparent:y,textureAlphaMode:e?U(e.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:g,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:f.externalColorMixMode||"tint",textureAlphaPremultiplied:!0};v.isSome(c)&&c.materialParamsMixin&&I.mixin(e,c.materialParamsMixin);f=new P.DefaultMaterial(e,q);m[b.material]||(m[b.material]=
{});m[b.material][b.texture]=f}n.push(f);b=new O(new N.GeometryData(l,d),q);H+=d.position?d.position.length:0;h.push(b)}}return{name:q,stageResources:{textures:r,materials:n,geometries:h},pivotOffset:t.model.pivotOffset,boundingBox:T(h),numberOfVertices:H,lodThreshold:null}};Object.defineProperty(u,"__esModule",{value:!0})});