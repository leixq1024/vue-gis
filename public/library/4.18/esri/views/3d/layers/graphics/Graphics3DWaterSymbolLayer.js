// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../Color ../../../../chunks/common ../../../../core/unitUtils ../../../../geometry/support/aaBoundingRect ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../core/libs/earcut/earcut ../../../../chunks/vec2 ../../../../chunks/vec4 ../../../../geometry/support/aaBoundingBox ../../webgl-engine/lib/Object3D ./elevationAlignmentUtils ./ElevationAligners ./ElevationContext ./Graphics3DObject3DGraphicLayer ../../webgl-engine/lib/Geometry ./Graphics3DSymbolLayer ./polygonUtils ./Graphics3DDrapedGraphicLayer ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/internal/waterMaterialUtils ../../webgl-engine/materials/WaterMaterial".split(" "),
function(x,C,k,G,H,I,y,J,v,D,K,L,m,M,q,N,O,P,Q,r,t,R,S,E,T){r=function(z){function l(a,b,c,d){return z.call(this,a,b,c,d)||this}C._inheritsLoose(l,z);var h=l.prototype;h.doLoad=async function(){};h.destroy=function(){z.prototype.destroy.call(this);k.isSome(this._material)&&(this._context.stage.remove(3,this._material.id),this._material=null)};h.createGraphics3DGraphic=function(a){a=a.graphic;if(!this._validateGeometryType(a.geometry,l.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(a.geometry))return null;
const b="graphic"+a.uid,c=this.setGraphicElevationContext(a,new O.ElevationContext);this.ensureDrapedStatus("on-the-ground"===c.mode);this.ensureMaterial();return this.draped?this._createAsOverlay(a,b):this._createAs3DShape(a,c,b,a.uid)};h.ensureMaterial=function(){if(!k.isSome(this._material)){var a={...E.defaultWaterMaterialParameters},b=this.symbolLayer.color;k.isSome(b)&&(a.color=G.toUnitRGBA(b));b=this._getCombinedOpacity(b,{hasIntrinsicColor:!0});a.color=[a.color[0],a.color[1],a.color[2],b];
a.transparent=1>b||this.needsDrivenTransparentPass;a.waveDirection=k.isSome(this.symbolLayer.waveDirection)?l.headingVectorFromAngle(this.symbolLayer.waveDirection):v.fromValues(0,0);b=E.wavePresets[this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize];a.waveStrength=b.waveStrength;a.waveTextureRepeat=b.textureRepeat;a.waveVelocity=b.waveVelocity;a.flowStrength=b.perturbationStrength;a.slicePlaneEnabled=this._context.slicePlaneEnabled;a.isDraped=this.draped;this._material=new T.WaterMaterial(a,
"water");this._context.stage.add(3,this._material)}};h.layerOpacityChanged=function(){if(k.isNone(this._material))return!0;const a=this._material.params.color,b=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0});this._material.setParameterValues({color:[a[0],a[1],a[2],b],transparent:1>b||this.needsDrivenTransparentPass});return!0};h.layerElevationInfoChanged=function(a,b,c){const d=this._elevationContext.mode;c=q.elevationModeChangeUpdateType(l.elevationModeChangeTypes,c,d);if(c!==
q.SymbolUpdateType.UPDATE)return c;const e=q.needsElevationUpdates2D(d);return this.updateGraphics3DGraphicElevationInfo(a,b,()=>e)};h.slicePlaneEnabledChanged=function(){k.isSome(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};h.physicalBasedRenderingChanged=function(){return!0};h.pixelRatioChanged=function(){return!0};h._createAs3DShape=function(a,b,c,d){a=t.geometryAsPolygon(a.geometry);if(k.isNone(a))return null;f.renderData=t.geometryToRenderInfo(a,
this._context.elevationProvider,this._context.renderCoordsHelper,b);const e=f.renderData.position.length/3;f.uvCoords=new Float64Array(2*e);f.idHint=c;f.outNum=0;f.outGeometries=[];f.outTransforms=[];f.outMaterials=[];this._create3DShapeGeometries(f);this._logGeometryCreationWarnings(f.renderData,a.rings,"rings","WaterSymbol3DLayer");if(0===f.outNum)return null;this._createUVCoordsFromVertices(f.uvCoords,f.renderData.mapPosition,e,this._context.elevationProvider.spatialReference);c=new M({geometries:f.outGeometries,
materials:f.outMaterials,transformations:f.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:d},idHint:c});c=new P(this,c,f.outGeometries,null,null,N.perVertexElevationAligner,b);c.alignedSampledElevation=f.renderData.sampledElevation;c.needsElevationUpdates=q.needsElevationUpdates2D(b.mode);return c};h._createUVCoordsFromVertices=function(a,b,c,d){d=I.getMetersPerUnitForSR(d);y.empty(n);for(var e=0;e<c;e++)K.set(F,b[3*e],b[3*e+1]),y.expandPointInPlace(n,F);L.scale(n,
n,d);e=n[1]%l.unitSizeOfTexture;w[0]=n[0]-n[0]%l.unitSizeOfTexture;w[1]=n[1]-e;for(e=0;e<c;e++)a[2*e]=(b[3*e]*d-w[0])/l.unitSizeOfTexture,a[2*e+1]=(b[3*e+1]*d-w[1])/l.unitSizeOfTexture};h._create3DShapeGeometries=function(a){var b=a.renderData.polygons;const c=a.uvCoords;for(const {count:d,index:e,position:A,mapPosition:u,holeIndices:B}of b){if(k.isSome(this._context.clippingExtent)&&(m.empty(p),m.expandWithBuffer(p,u),!m.intersectsClippingArea(p,this._context.clippingExtent)))continue;b=D.earcut(u,
B,3);if(0===b.length)continue;b=new Uint32Array(b);const U=new Float64Array(c.buffer,2*e*c.BYTES_PER_ELEMENT,2*d);b=t.createWaterGeometryData({indices:b,attributeData:{position:A,uv0:U,mapPosition:u}});b=new Q(b,a.idHint);a.outGeometries.push(b);a.outMaterials.push(k.unwrap(this._material));a.outTransforms.push(J.IDENTITY);a.outNum++}};h._createAsOverlay=function(a,b){const c=t.geometryAsPolygon(a.geometry);if(k.isNone(c))return null;k.unwrap(this._material).renderPriority=this._renderPriority;g.renderData=
t.geometryToRenderInfoDraped(c,this._context.overlaySR);g.idHint=b;b=g.renderData.position.length/3;g.uvCoords=new Float64Array(2*b);g.outNum=0;g.outGeometries=[];g.outBoundingBox=m.empty();g.layerUid=this._context.layer.uid;g.graphicsUid=a.uid;this._createAsOverlayWater(g);this._logGeometryCreationWarnings(g.renderData,c.rings,"rings","WaterSymbol3DLayer");if(0===g.outNum)return null;this._createUVCoordsFromVertices(g.uvCoords,g.renderData.position,b,this._context.overlaySR);return 0<g.outNum?new R(this,
g.outGeometries,g.outBoundingBox):null};h._createAsOverlayWater=function(a){const b=a.uvCoords;var c=a.renderData.polygons;for(const {position:e,holeIndices:A,index:u,count:B}of c)if(m.empty(p),m.expandWithBuffer(p,e),m.intersectsClippingArea(p,this._context.clippingExtent)&&(m.expandWithAABB(a.outBoundingBox,p),c=D.earcut(e,A,3),0!==c.length)){c=new Uint32Array(c);var d=new Float64Array(b.buffer,2*u*b.BYTES_PER_ELEMENT,2*B);c=t.createWaterGeometryData({indices:c,attributeData:{position:e,uv0:d}});
c=new S(c);c.data.layerUid=a.layerUid;c.data.graphicUid=a.graphicsUid;c.material=k.unwrap(this._material);d=p;c.center=[.5*(d[0]+d[3]),.5*(d[1]+d[4]),0];c.bsRadius=.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]));a.outGeometries.push(c);a.outNum++}};l.headingVectorFromAngle=function(a){const b=v.create();a=H.toRadian(a);b[0]=Math.sin(a);b[1]=Math.cos(a);return b};C._createClass(l,[{key:"test",get:function(){return{create3DShape:a=>this._createAs3DShape(a.graphic,a.elevationContext,a.idHint,
a.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}]);return l}(r.Graphics3DSymbolLayer);r.validGeometryTypes=["polyline","polygon","extent"];r.unitSizeOfTexture=100;r.elevationModeChangeTypes={definedChanged:q.SymbolUpdateType.RECREATE,staysOnTheGround:q.SymbolUpdateType.NONE,onTheGroundChanged:q.SymbolUpdateType.RECREATE};const w=v.create(),n=y.create(),F=v.create(),p=m.create(),f={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,
outTransforms:null},g={idHint:null,renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};x.Graphics3DWaterSymbolLayer=r;x.default=r;Object.defineProperty(x,"__esModule",{value:!0})});