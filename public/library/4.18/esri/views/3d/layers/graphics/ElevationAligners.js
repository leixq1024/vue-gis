// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/maybe ../../../../geometry/Point ../../../../chunks/vec3f64 ../../../../chunks/vec3 ../../../../chunks/mat4 ../../../../geometry/projection ../../../../chunks/mat4f64 ../../support/buffer/BufferView ../../webgl-engine/lib/Util ../../support/debugFlags ./graphicUtils ./elevationAlignmentUtils ../support/uvUtils".split(" "),function(t,P,Q,B,G,R,H,I,w,S,D,T,C,J){function K(b,a,d,c){b=b.stageObject;x.spatialReference=d.spatialReference;const f=b.geometryRecords,h=f.length,
l="absolute-height"!==a.mode;let n=0;for(let y=0;y<h;y++){var e=f[y].geometry,p=f[y].getShaderTransformation();q[0]=p[12];q[1]=p[13];q[2]=p[14];e.invalidateBoundingInfo();p=e.data.getVertexAttr();var z=p[u.POSITION];e=z.data;p=p.mapPos.data;z=z.size;const L=e.length/z;let k=0,E=0,F=!1,M=0;for(let N=0;N<L;N++){x.x=p[E++];x.y=p[E++];x.z=p[E++];v[0]=e[k];v[1]=e[k+1];v[2]=e[k+2];var A=C.evaluateElevationAlignmentAtPoint(x,d,a,c,l?r:null);l&&(M+=r.sampledElevation);g[0]=e[k]+q[0];g[1]=e[k+1]+q[1];g[2]=
e[k+2]+q[2];c.setAltitude(A,g);e[k]=g[0]-q[0];e[k+1]=g[1]-q[1];e[k+2]=g[2]-q[2];if(D.TESTS_DISABLE_UPDATE_THRESHOLDS)F=!0;else if(A=.01/c.unitInMeters,Math.abs(v[0]-e[k])>=A||Math.abs(v[1]-e[k+1])>=A||Math.abs(v[2]-e[k+2])>=A)F=!0;k+=z}n+=M/L;F&&b.geometryVertexAttrsUpdated(y)}return n/h}const u=S.VertexAttrConstants,U=I.create(),x=new Q,g=B.create(),q=B.create(),v=B.create(),m=I.create(),O=B.create(),r={verticalDistanceToGround:0,sampledElevation:0};t.iterativeUpdatesEnabled=!0;t.perLodInstanceElevationAligner=
function(b,a,d,c){const f=b.graphics3DSymbolLayer.lodRenderer;if(P.isNone(f))return 0;const h=a.centerPointInElevationSR;let l=0,n=0;const e="absolute-height"!==a.mode;l=C.evaluateElevationAlignmentAtPoint(h,d,a,c,e?r:null);e&&(n=r.sampledElevation);a=f.instanceData;b=b.instanceIndex;a.getGlobalTransform(b,m);d=G.set(O,m[12],m[13],m[14]);D.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(g[0]=h.x,g[1]=h.y,g[2]=l,H.computeLinearTransformation(h.spatialReference,g,m,c.spatialReference)&&a.setGlobalTransform(b,
m)):c.setAltitudeOfTransformation(l,m);c=.01/c.unitInMeters;(Math.abs(m[12]-d[0])>=c||Math.abs(m[13]-d[1])>=c||Math.abs(m[14]-d[2])>=c)&&a.setGlobalTransform(b,m);return n};t.perObjectElevationAligner=function(b,a,d,c){b=b.stageObject;const f=a.centerPointInElevationSR;let h=0,l=0;if(b.metadata.usesVerticalDistanceToGround)h=C.evaluateElevationAlignmentAtPoint(f,d,a,c,r),T.updateVertexAttributeAuxpos1w(b,r.verticalDistanceToGround),l=r.sampledElevation;else{const n="absolute-height"!==a.mode;h=C.evaluateElevationAlignmentAtPoint(f,
d,a,c,n?r:null);n&&(l=r.sampledElevation)}a=R.copy(U,b.objectTransformation);d=G.set(O,a[12],a[13],a[14]);D.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(g[0]=f.x,g[1]=f.y,g[2]=h,H.computeLinearTransformation(f.spatialReference,g,a,c.spatialReference)&&(b.objectTransformation=a)):c.setAltitudeOfTransformation(h,a);c=.01/c.unitInMeters;if(Math.abs(a[12]-d[0])>=c||Math.abs(a[13]-d[1])>=c||Math.abs(a[14]-d[2])>=c)b.objectTransformation=a;return l};t.perVertexElevationAligner=K;t.updateThresholdInMeters=
.01;t.uvElevationAligner=function(b,a,d,c){a=K(b,a,d,c);b=b.stageObject.geometryRecords;for(d=0;d<b.length;d++)if(J.requiresUVUpdates(b[d])){const f=b[d].geometry.data.getVertexAttr(),h=f[u.POSITION].data,l=f[u.BOUND1].data,n=f[u.BOUND2].data,e=f[u.BOUND3].data;J.createMapSpaceUVCoords(w.BufferViewVec4f.fromTypedArray(f[u.UVMAPSPACE].data),w.BufferViewVec3f64.fromTypedArray(h),c,w.BufferViewVec3f64.fromTypedArray(l),w.BufferViewVec3f64.fromTypedArray(n),w.BufferViewVec3f64.fromTypedArray(e))}return a};
Object.defineProperty(t,"__esModule",{value:!0})});