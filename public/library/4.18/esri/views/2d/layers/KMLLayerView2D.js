// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../core/scheduling ../../../geometry/support/webMercatorUtils ../../../geometry/Extent ../../../core/Collection ../../../request ../../../core/Handles ../../../core/watchUtils ../../../support/GraphicsCollection ../../../layers/support/kmlUtils ../../layers/LayerView ./graphics/GraphicsView2D ../engine/Bitmap ../engine/BitmapContainer ./LayerView2D".split(" "),
function(u,g,f,I,J,h,K,v,L,M,N,k,w,q,x,y,z,A,B,m,l,C,n,D,E,F){f=function(r){function p(){var a=r.apply(this,arguments)||this;a._handles=new A;a._bitmapIndex=new Map;a._mapImageContainer=new E.BitmapContainer;a._featuresMap=new Map;a.allVisiblePoints=new m.GraphicsCollection;a.allVisiblePolylines=new m.GraphicsCollection;a.allVisiblePolygons=new m.GraphicsCollection;a.allVisibleMapImages=new y;return a}u._inheritsLoose(p,r);var e=p.prototype;e.hitTest=function(a,b){if(this.suspended||!this._pointsView&&
!this._polylinesView&&!this._polygonsView)return k.resolve(null);a=[this._pointsView.hitTest(a,b),this._polylinesView.hitTest(a,b),this._polygonsView.hitTest(a,b)];return k.all(a).then(d=>d.filter(c=>{c&&(c.layer=this.layer,c.sourceLayer=this.layer);return!!c})[0]||null)};e.update=function(a){this._polygonsView&&this._polygonsView.processUpdate(a);this._polylinesView&&this._polylinesView.processUpdate(a);this._pointsView&&this._pointsView.processUpdate(a)};e.attach=function(){this._handles.add([this.allVisibleMapImages.on("change",
a=>{a.added.forEach(b=>this._addMapImage(b));a.removed.forEach(b=>this._removeMapImage(b))})]);this.container.addChild(this._mapImageContainer);this._polygonsView=new n({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate()});this.container.addChild(this._polygonsView.container);this._polylinesView=new n({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate()});this.container.addChild(this._polylinesView.container);
this._pointsView=new n({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate()});this.container.addChild(this._pointsView.container);this.watch("layer.visibleSublayers",()=>this._refreshCollections());this._fetchingPromise=this._fetchService().then(()=>{this._fetchingPromise=null;this.notifyChange("updating")})};e.detach=function(){this._handles.removeAll();this._mapImageContainer.removeAllChildren();this.container.removeAllChildren();this._bitmapIndex.clear();
this._polygonsView&&(this._polygonsView.destroy(),this._polygonsView=null);this._polylinesView&&(this._polylinesView.destroy(),this._polylinesView=null);this._pointsView&&(this._pointsView.destroy(),this._pointsView=null)};e.moveStart=function(){};e.viewChange=function(){this._polygonsView.viewChange();this._polylinesView.viewChange();this._pointsView.viewChange()};e.moveEnd=function(){};e.isUpdating=function(){return null!=this._fetchingPromise||this._pointsView.updating||this._polygonsView.updating||
this._polylinesView.updating};e._addMapImage=function(a){(this.view.spatialReference.isWGS84||this.view.spatialReference.isWebMercator)&&z(a.href,{responseType:"image"}).then(({data:b})=>{let d=x.fromJSON(a.extent);q.canProject(d,this.view.spatialReference)&&(d=q.project(d,this.view.spatialReference));const c=new D.Bitmap(b);c.x=d.xmin;c.y=d.ymax;c.resolution=d.width/b.naturalWidth;c.rotation=a.rotation;this._mapImageContainer.addChild(c);this._bitmapIndex.set(a,c)})};e._fetchService=function(){this._handles.remove("refresh-collections");
return this._getParsedKML().then(a=>this._fetchSublayerService(this.layer,a))};e._fetchSublayerService=function(a,b){a=a.sublayers;if(!a||0===a.length)return k.resolve();const d=[];a.forEach(c=>{const H=B.whenTrueOnce(c,"visible").then(()=>c.load()).then(()=>this._getGraphicsForSublayer(c,b)).then(G=>k.create(t=>{c.networkLink?t():(this._featuresMap.set(c,G),this._handles.add(w.schedule(()=>{this._refreshCollections();t()}),"refresh-collections"))})).then(()=>this._fetchSublayerService(c,c.sourceJSON||
b));c.visible&&d.push(H)});return k.all(d).then(()=>{})};e._getParsedKML=function(){return l.fetchService(this.layer.url,this.view.spatialReference,this.layer.refreshInterval).then(a=>l.parseKML(a.data))};e._getGraphicsForSublayer=async function(a,b){let d=null;return b.sublayers.some(c=>{d=c;return c.id===a.id})?{points:d.points&&await l.getGraphics(d.points),polylines:d.polylines&&await l.getGraphics(d.polylines),polygons:d.polygons&&await l.getGraphics(d.polygons),mapImages:d.mapImages}:null};
e._refreshCollections=function(){const a=this.get("layer.visibleSublayers");this.allVisiblePoints.removeAll();this.allVisiblePolylines.removeAll();this.allVisiblePolygons.removeAll();this.allVisibleMapImages.removeAll();a&&a.length&&a.forEach(b=>{if(b=this._featuresMap.get(b))this.allVisiblePoints.addMany(b.points),this.allVisiblePolylines.addMany(b.polylines),this.allVisiblePolygons.addMany(b.polygons),this.allVisibleMapImages.addMany(b.mapImages)})};e._removeMapImage=function(a){const b=this._bitmapIndex.get(a);
b&&(this._mapImageContainer.removeChild(b),this._bitmapIndex.delete(a))};return p}(F.LayerView2DMixin(C));g.__decorate([h.property()],f.prototype,"_pointsView",void 0);g.__decorate([h.property()],f.prototype,"_polylinesView",void 0);g.__decorate([h.property()],f.prototype,"_polygonsView",void 0);g.__decorate([h.property()],f.prototype,"_fetchingPromise",void 0);g.__decorate([h.property({dependsOn:["_fetchingPromise","_pointsView.updating","_polygonsView.updating","_polylinesView.updating"]})],f.prototype,
"updating",void 0);return f=g.__decorate([v.subclass("esri.views.2d.layers.KMLLayerView2D")],f)});