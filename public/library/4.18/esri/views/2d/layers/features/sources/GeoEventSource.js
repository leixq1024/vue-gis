// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/maybe ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/featureConversionUtils ../support/FeatureSetReaderJSON ../../../../../chunks/rbush ../../../../../layers/graphics/data/StreamFeatureManager ../../../../../layers/graphics/sources/connections/createConnection ./DataTileSource".split(" "),function(y,t,z,m,A,u,B,E,F,G,H){function I(e,d){const c=e.weakClone(),
a=u.quantizeX(d,e.geometry.coords[0]);e=u.quantizeY(d,e.geometry.coords[1]);c.geometry=new A([],[a,e]);return c}function J(e){switch(e){case "esriGeometryPoint":return I;default:return(d,c)=>{const a=d.weakClone(),b=new A;d=u.quantizeOptimizedGeometry(b,d.geometry,!1,!1,e,c,!1,!1);a.geometry=d;return a}}}function K(e){switch(e){case "esriGeometryPoint":return d=>({minX:d.geometry.coords[0],minY:d.geometry.coords[1],maxX:d.geometry.coords[0],maxY:d.geometry.coords[1]});default:return d=>{let c=Infinity,
a=Infinity,b=-Infinity,g=-Infinity;d.geometry.forEachVertex((h,f)=>{c=Math.min(c,h);a=Math.min(a,f);b=Math.max(b,h);g=Math.max(g,f)});return{minX:c,minY:a,maxX:b,maxY:g}}}}function v(e,d){d=E.rbush(9,K(d));d.load(e);return d}function w(e,d){return e.search({minX:d.bounds[0],minY:d.bounds[1],maxX:d.bounds[2],maxY:d.bounds[3]})}let L=function(){function e(c,a){this.onUpdate=c;this._geometryType=a;this._objectIdToFeature=new Map}var d=e.prototype;d.add=function(c){this._objectIdToFeature.set(c.objectId,
c);this._index=null};d.get=function(c){return this._objectIdToFeature.has(c)?this._objectIdToFeature.get(c):null};d.forEach=function(c){this._objectIdToFeature.forEach(c)};d.search=function(c){this._index||(this._index=v(this._features,this._geometryType));return w(this._index,c)};d.removeById=function(c){const a=this._objectIdToFeature.get(c);return a?(this._objectIdToFeature.delete(c),this._index=null,a):null};d.update=function(c,a){this.onUpdate(c,a)};t._createClass(e,[{key:"_features",get:function(){const c=
[];this._objectIdToFeature.forEach(a=>c.push(a));return c}},{key:"size",get:function(){return this._objectIdToFeature.size}}]);return e}();z=function(e){function d(a){var b=e.call(this,a)||this;b.type="geoevent";b._dataReceiveEventEnabled=!1;b._updateInfo={websocket:0,client:0};var {outSR:g}=a;const {geometryType:h,objectIdField:f,timeInfo:x,purgeOptions:n,source:p,spatialReference:k,serviceFilter:q,maxReconnectionAttempts:M,maxReconnectionInterval:N,updateInterval:O}=a.serviceInfo,C=new L(b._onUpdate.bind(t._assertThisInitialized(b)),
h),P=new F["default"](C,f,x,n);g=G.createConnection(p,k,g,h,q,M,N);b._store=C;b._manager=P;b._connection=g;b._quantize=J(h);b._handles=[b._connection.on("feature",l=>b._onFeature(l)),b._connection.watch("connectionStatus",l=>b.events.emit("connectionStatus",l)),b._connection.watch("errorString",l=>b.events.emit("errorString",l))];let D=performance.now();b._updateIntervalId=setInterval(()=>{var l=performance.now(),r=l-D;2500<r&&(D=l,l=Math.round(b._updateInfo.client/(r/1E3)),r=Math.round(b._updateInfo.websocket/
(r/1E3)),b._updateInfo.client=0,b._updateInfo.websocket=0,b.events.emit("updateRate",{client:l,websocket:r}));a.canAcceptRequest()&&b._manager.checkForUpdates()},O);return b}t._inheritsLoose(d,e);var c=d.prototype;c.destroy=function(){clearInterval(this._updateIntervalId);this._handles.forEach(a=>a.remove());this._connection.destroy()};c._fetchDataTile=function(){};c.enableEvent=function(a,b){"data-received"===a&&(this._dataReceiveEventEnabled=b)};c.subscribe=function(a){e.prototype.subscribe.call(this,
a);const b=this._getTileFeatures(a);this._onRequest({tile:a,id:a.key.id,features:b,end:!0},"new")};c.unsubscribe=function(a){e.prototype.unsubscribe.call(this,a)};c.forEachRequest=function(a,b){const g=this._subscriptions.get(a),{tile:h,signal:f}=g;a={tile:h,id:a,features:this._getTileFeatures(h),end:!0};b(a,{signal:f})};c.resend=async function(a){this._subscriptions.forEach(b=>{({tile:b}=b);b={tile:b,id:b.id,features:this._getTileFeatures(b),end:!0};this._onRequest(b,"update",a)})};c._getTileFeatures=
function(a){const b=this._store.search(a).map(g=>this._quantize(g,a.transform));return B.FeatureSetReaderJSON.fromOptimizedFeatures(b,this.geometryType,a.transform)};c._onFeature=function(a){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",a);const b=u.convertFromFeature(a,this.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(b)}catch(b){}};c._onUpdate=async function(a,b){const g=m.andThen(a,f=>v(f,this.geometryType)),h=m.andThen(b,f=>
v(f,this.geometryType));m.isSome(a)&&(this._updateInfo.client+=a.length);this._subscriptions.forEach((f,x)=>{const n=f.tile;f=m.andThen(g,k=>w(k,n));f=m.andThen(f,k=>k.map(q=>this._quantize(q,n.transform)));f=m.andThen(f,k=>B.FeatureSetReaderJSON.fromOptimizedFeatures(k,this.geometryType,n.transform));var p=m.andThen(h,k=>w(k,n));p=m.andThen(p,k=>k.map(q=>q.objectId));this._onRequest({tile:n,id:x,features:f,remove:m.unwrapOr(p,[]),end:!0},"update")})};t._createClass(d,[{key:"updating",get:function(){return!1}}]);
return d}(H.DataTileSource);y.GeoEventSource=z;Object.defineProperty(y,"__esModule",{value:!0})});