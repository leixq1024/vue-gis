// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/has ../../../../core/maybe ../../../../core/promiseUtils ../../../../support/arcadeOnDemand ../../../../core/accessorSupport/diffUtils ../../arcade/callExpressionWithCursor".split(" "),function(m,k,n,p,q,r,l,t){const u=new Promise(function(g,f){m(["../../../../layers/support/labelFormatUtils"],g,f)});let v=function(){function g(b,a){this._canCacheExpressionValue=!1;this._sourceInfo=b;this._bitsets={computed:a.getBitset(a.createBitset())}}var f=g.prototype;
f.updateSchema=async function(b,a){var c=l.diff(this._schema,a);if((this._schema=a)&&!p.isNone(c)&&l.hasDiff(c,"attributes")){n("esri-2d-update-debug")&&console.debug("Applying Update - Store:",c);this._bitsets.computed.clear();b.targets[a.name]=!0;b=a.attributes;a=[];c=[];for(const e in b){const d=b[e];switch(d.type){case "expression":a.push(this._createArcadeComputedField(d));break;case "label-expression":a.push(this._createLabelArcadeComputedField(d));break;case "statistic":c.push(d)}}this._computedFields=
await q.all(a);this._canCacheExpressionValue=!this._computedFields.some(e=>"expression"===e.type&&e.expression.referencesScale());this._statisticFields=c}};f.setComputedAttributes=function(b,a,c,e){var d=this._bitsets.computed;if(!this._canCacheExpressionValue||!d.has(c)){d.set(c);for(const h of this._computedFields)switch(d=this._evaluateField(a,h,e),h.resultType){case "numeric":b.setComputedNumericAtIndex(c,h.fieldIndex,d);break;case "string":b.setComputedStringAtIndex(c,h.fieldIndex,d)}}};f._createArcadeComputedField=
async function(b){return{...b,expression:await r.createRendererExpression(b.valueExpression,this._sourceInfo.spatialReference,this._sourceInfo.fieldsIndex)}};f._createLabelArcadeComputedField=async function(b){var a=this._sourceInfo.spatialReference;const c=this._sourceInfo.fields,{createLabelFunction:e}=await u;a=await e(b.label,c,a);return{...b,builder:a}};f._evaluateField=function(b,a,c){switch(a.type){case "label-expression":return b=b.readArcadeFeature(),a.builder.evaluate(b)||"";case "expression":return{expression:a}=
a,t(a,b,{$view:{scale:c}})}};return g}();k.Store2D=v;Object.defineProperty(k,"__esModule",{value:!0})});