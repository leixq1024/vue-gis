// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Logger ../../../../../core/Error ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/featureConversionUtils ./FeatureSetReader ../../../../../core/pbf ./FeatureSetReaderPBFHeader".split(" "),function(x,y,u,H,I,r,z,A,J,K){function L(g){var h=g.getLength();for(h=g.pos()+h;g.pos()<h&&g.next();)switch(g.tag()){case 1:return g=g.getString(),""===
g?null:g;case 2:return g.getFloat();case 3:return g.getDouble();case 4:return g.getSInt32();case 5:return g.getUInt32();case 6:return g.getInt64();case 7:return g.getUInt64();case 8:return g.getSInt64();case 9:return g.getBool();default:return g.skip(),null}return null}const M=u.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF");u=function(g){function h(a,b,c,f){a=g.call(this,a)||this;a._hasNext=!1;a._isPoints=!1;a._isPolygons=!1;a._featureIndex=-1;a._featureOffset=0;a._cache={area:0,
unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0};a._geometryType=f;a._reader=b;a._header=c;a._hasNext=c.hasFeatures;a._isPoints="esriGeometryPoint"===f;a._isPolygons="esriGeometryPolygon"===f;return a}y._inheritsLoose(h,g);h.fromBuffer=function(a,b){a:{try{const e=new J(new Uint8Array(a),new DataView(a));for(;e.next();)switch(e.tag()){case 2:b:{for(var c=e.getMessage();c.next();)switch(c.tag()){case 1:var f=c.getMessage();break b;default:c.skip()}f=null}break a;
default:e.skip()}}catch(e){a=new H("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e}),M.error(a)}f=null}a=f;f=K.parseHeader(a,"esriGeometryPoint"===b);c=A.FeatureSetReader.createInstance();return new h(c,a,f,b)};var d=h.prototype;d.getApproximateSize=function(){return this._hasFilter?Math.max(Math.round(this.size*Math.abs(this._xmax-this._xmin)*Math.abs(this._ymax-this._ymin)/262144),0):this.size};d.getQuantizationTransform=function(){return this._header.transform};d.getCursor=
function(){return this.copy()};d.getIndex=function(){return this._featureIndex};d.setIndex=function(a){this._cache.area=0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;this._cache.optFeature=void 0;this._featureIndex=a};d.getAttributeHash=function(){let a="";this._header.fieldIndexMap.forEach(b=>{a+=this._readAttributeAtIndex(b)+"."});return a};d.getObjectId=function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)};
d.getDisplayId=function(){return this._header.displayIds[this._featureIndex]};d.setDisplayId=function(a){this._header.displayIds[this._featureIndex]=a};d.getGroupId=function(){return this._header.groupIds[this._featureIndex]};d.setGroupId=function(a){this._header.groupIds[this._featureIndex]=a};d.readLegacyFeature=function(){if(void 0===this._cache.legacyFeature){var a,b=this.readCentroid();b={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),
centroid:null!=(a=b&&{x:b.coords[0],y:b.coords[1]})?a:null};return this._cache.legacyFeature=b}return this._cache.legacyFeature};d.readOptimizedFeature=function(){if(void 0===this._cache.optFeature){const a=new I(this.readGeometry(),this.readAttributes(),this.readCentroid());return this._cache.optFeature=a}return this._cache.optFeature};d.getXHydrate=function(){const a=this._header.centroid[2*this._featureIndex],b=this.getQuantizationTransform();return a*b.scale[0]+b.translate[0]};d.getYHydrate=function(){const a=
this._header.centroid[2*this._featureIndex+1],b=this.getQuantizationTransform();return b.translate[1]-a*b.scale[1]};d.readLegacyPointGeometry=function(){return{x:this._header.centroid[2*this._featureIndex]+this._tx,y:this._header.centroid[2*this._featureIndex+1]+this._ty}};d.readLegacyGeometry=function(){const a=this.readGeometry();return z.convertToGeometry(a,this.geometryType,!1,!1)};d.readLegacyCentroid=function(){const a=this.readCentroid();if(!a)return null;const [b,c]=a.coords;return{x:b,y:c}};
d.readGeometryArea=function(){this._cache.area||this.readGeometry();return this._cache.area};d.readUnquantizedGeometry=function(){if(void 0===this._cache.unquantGeometry){var a=this.readGeometry();if(!a)return this._cache.unquantGeometry=null;a=a.clone();const b=a.lengths,c=a.coords;for(let f=0,e=2;f<b.length;f++,e+=2){const l=b[f];for(let k=1;k<l;k+=1,e+=2)c[e]+=c[e-2],c[e+1]+=c[e-1]}return this._cache.unquantGeometry=a}return this._cache.unquantGeometry};d.readHydratedGeometry=function(){var a=
this.readGeometry();if(!a)return null;a=a.clone();this._isPoints&&(a.coords[0]-=this._tx,a.coords[1]-=this._ty);z.unquantizeOptimizedGeometry(a,a,this.hasZ,this.hasM,this.getQuantizationTransform());return a};d.readGeometry=function(){if(void 0===this._cache.geometry){let a=null;if(this._isPoints)a=new r([],[this._header.centroid[2*this._featureIndex]+this._tx,this._header.centroid[2*this._featureIndex+1]+this._ty]);else{const b=this._header.offsets.geometry[this._featureIndex],c=this._reader;if(0===
b)return null;c.move(b);try{a=this._parseGeometry(c)}catch(f){return console.error("Failed to parse geometry!",f),null}}return this._cache.geometry=a}return this._cache.geometry};d.readCentroid=function(){if(void 0===this._cache.centroid){var a=null;a=this._header.centroid[2*this._featureIndex]+this._tx;const b=this._header.centroid[2*this._featureIndex+1]+this._ty;if(268435455===a){if(a=this._computeCentroid())this._header.centroid[2*this._featureIndex]=a.coords[0]-this._tx,this._header.centroid[2*
this._featureIndex+1]=a.coords[1]-this._ty}else a=new r([],[a,b]);return this._cache.centroid=a}return this._cache.centroid};d.copy=function(){var a=this._reader.clone();a=new h(this.instance,a,this._header,this.geometryType);this.copyInto(a);return a};d.next=function(){this._cache.area=0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;this._cache.optFeature=void 0;if(!this._hasFilter)return++this._featureIndex<this.size;
for(;++this._featureIndex<this.size&&!this._passesFilter(););return this._featureIndex<this.size};d._readAttribute=function(a,b){a=this._header.hasFieldIndex(a)?a:a.toLowerCase().trim();var c=this._header.getFieldIndex(a);if(null!=c)return c=this._readAttributeAtIndex(c),b?this._header.isDateField(a)?new Date(c):c:c};d._readAttributes=function(){const a={};this._header.fieldIndexMap.forEach((b,c)=>{a[c]=this._readAttributeAtIndex(b)});return a};d.copyInto=function(a){g.prototype.copyInto.call(this,
a);a._featureIndex=this._featureIndex;a._featureOffset=this._featureOffset;a._hasNext=this._hasNext};d._passesFilter=function(){if(!this._hasFilter)return!0;let a=this._header.centroid[2*this._featureIndex],b=this._header.centroid[2*this._featureIndex+1];if(268435455===a){if(this._isPolygons&&!this.readCentroid())return!1;a=this._header.centroid[2*this._featureIndex];b=this._header.centroid[2*this._featureIndex+1]}return a>=this._xmin&&a<=this._xmax&&b>=this._ymin&&b<=this._ymax?!0:!1};d._readAttributeAtIndex=
function(a){const b=this._reader;b.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]);return L(b)};d._preprocessPolygon=function(a,b){let c=0,f=0,e=0;var l=!1,k=!1;let B=!1,C=-1;const v=[];let D=0,E=!1;for(let w=0;w<b.length;w++){const t=b[w];var m=a[2*c],q=a[2*c+1],n=0;for(var p=1;p<t;p++){const F=m+a[2*(c+p)],G=q+a[2*(c+p)+1],N=(F-m)*(G+q);m=F;q=G;n+=.5*N}(m=0<n)&&E&&(f+=t);m||(C++,E=!1);if(1E6<=C)break;D+=n;l&&m&&k&&(B=!0);a[2*e]=a[2*f];a[2*e++ +1]=a[2*f++ +1];
l=1;k=a[2*f];n=a[2*f++ +1];for(m=2;m<t;m++)q=a[2*f],p=a[2*f++ +1],0===k*p-q*n?(k+=q,n+=p):(a[2*e]=k,a[2*e++ +1]=n,l++,k=q,n=p);a[2*e]=k;a[2*e++ +1]=n;l++;v.push(l);l=!1;k=!0;c+=t}return v.length?(this._cache.area=Math.abs(D),new r(v,a,B)):null};d._parseGeometry=function(a){var b=a.getLength();const c=a.pos()+b;b=[];const f=[];for(;a.pos()<c&&a.next();)switch(a.tag()){case 2:var e=a.getUInt32();for(e=a.pos()+e;a.pos()<e;)f.push(a.getUInt32());break;case 3:e=a.getUInt32();for(e=a.pos()+e;a.pos()<e;)b.push(a.getSInt32()),
b.push(a.getSInt32()),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();break;default:a.skip()}a=0;for(const l of f)b[2*a]+=this._tx,b[2*a+1]+=this._ty,a+=l;return this._isPolygons?this._preprocessPolygon(b,f):new r(f,b)};y._createClass(h,[{key:"geometryType",get:function(){return this._geometryType}},{key:"size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?
1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}}]);return h}(A.FeatureSetReader);x.FeatureSetReaderPBF=u;Object.defineProperty(x,"__esModule",{value:!0})});