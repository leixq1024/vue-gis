// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define(["./TileKey","./TileCoverage","./TileCache"],function(D,z,E){const k=new D(0,0,0,0),d=new Map,l=[],r=[];return function(){function A(a){this._previousScale=Number.POSITIVE_INFINITY;this.cachePolicy="keep";this.coveragePolicy="closest";this.resampling=!0;this.tileIndex=new Map;this.tiles=[];this.buffer=192;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;this.resampling=null==a.resampling||!!a.resampling;a.cachePolicy&&(this.cachePolicy=a.cachePolicy);
a.coveragePolicy&&(this.coveragePolicy=a.coveragePolicy);null!=a.buffer&&(this.buffer=a.buffer);a.cacheSize&&(this._tileCache=new E(a.cacheSize,this.tileInfoView,e=>{this.releaseTile(e)}))}var t=A.prototype;t.destroy=function(){this.tileIndex.clear()};t.update=function(a){const {resampling:e,tileIndex:b}=this,m=this.tileInfoView.getTileCoverage(a.state,this.buffer,this.coveragePolicy);r.length=0;l.length=0;d.clear();if(m){var {minScale:F,maxScale:G}=this.tileInfoView.tileInfo,{spans:B,lodInfo:w}=
m,{level:n}=w,{scale:u,center:H,resolution:I}=a.state,x=!a.stationary&&u>this._previousScale;this._previousScale=u;this.tiles.length=0;if(!e&&(u>F||u<G))return this.tiles.length=0,d.clear(),b.forEach(c=>{this.releaseTile(c)}),b.clear(),r.length=0,l.length=0,d.clear(),z.pool.release(m),!0;b.forEach(c=>c.visible=!0);var y=a=0;if(0<B.length)for(const {row:c,colFrom:g,colTo:p}of B)for(let v=g;v<=p;v++){a++;const f=k.set(n,c,w.normalizeCol(v),w.getWorldForColumn(v)).id;if(b.has(f)){var h=b.get(f);h.isReady?
(d.set(f,h),y++):x||this._addParentTile(f,d)}else{if(this._tileCache&&this._tileCache.has(f)){if(h=this._tileCache.pop(f),this.tileIndex.set(f,h),h.isReady){d.set(f,h);y++;continue}}else h=this.acquireTile(k),this.tileIndex.set(f,h);x||this._addParentTile(f,d)}}var C=y===a;b.forEach((c,g)=>{k.set(g);if(!d.has(g)){var p=this.tileInfoView.intersects(m,k);!p||!x&&C?"purge"===this.cachePolicy?k.level===n&&p||l.push(g):(k.level>n||!p)&&l.push(g):c.isReady?r.push(g):k.level>n&&l.push(g)}});for(var q of r)(a=
b.get(q))&&a.isReady&&d.set(q,a);for(const c of l)q=b.get(c),this._tileCache?this._tileCache.add(q):this.releaseTile(q),b.delete(c);d.forEach(c=>this.tiles.push(c));b.forEach(c=>{d.has(c.key.id)||(c.visible=!1)});this._tileCache&&this._tileCache.prune(n,H,I);z.pool.release(m);d.clear();return C}};t.clear=function(a=!0){const {tileIndex:e}=this;a&&e.forEach(b=>{this.releaseTile(b)});e.clear()};t._addParentTile=function(a,e){let b=null;for(;;){a=this.tileInfoView.getTileParentId(a);if(!a)break;if(this.tileIndex.has(a)){if((b=
this.tileIndex.get(a))&&b.isReady){e.has(b.key.id)||e.set(b.key.id,b);break}}else if(this._tileCache&&this._tileCache.has(a)&&(b=this._tileCache.pop(a),this.tileIndex.set(a,b),b&&b.isReady)){e.has(b.key.id)||e.set(b.key.id,b);break}}};return A}()});