// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/Error","../../../../../core/promiseUtils"],function(t,v,u){function w(d){if(!d||0===d.byteLength)return!1;d=d.constructor===Uint8Array?d:new Uint8Array(d);return 71===d[0]&&73===d[1]&&70===d[2]&&56===d[3]}let y=function(){function d(){this.playing=this.paused=!1;this.waitTillDone=!0;this.firstFrameOnly=this.loading=!1;this.frames=[];this.comment="";this.frameCount=this.currentFrameNumber=this.length=0;this.playSpeed=1;this.lastFrame=null;this.playOnLoad=!0;this.complete=
!1;this.interlaceOffsets=[0,4,2,1];this.interlaceSteps=[8,8,4,2];this._lastUsedFrame=-1}d.create=async function(a,c){const b=new d;try{await b._load(a,c)}catch(f){if(!u.isAbortError(f))return new v("invalid-resource",`Could not load PNG: ${f.message}`)}return b};var e=d.prototype;e.play=function(){this.playing||(this.paused=!1,this.playing=!0,this._play())};e.pause=function(){this.paused=!0;this.playing=!1;clearTimeout(this.timerID)};e.togglePlay=function(){this.paused||!this.playing?this.play():
this.pause()};e.bindFrame=function(a,c,b){a.bindTexture(c,b);if(a=this.frameChanged())b=this.currentFrame,c.updateData(0,0,0,b.width,b.height,b.frameData),this.updateUsedFrame();return a};e.seekFrame=function(a){clearTimeout(this.timerID);this.currentFrameNumber=a%this.frames.length;this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)};e.seek=function(a){clearTimeout(this.timerID);0>a&&(a=0);a=1E3*a%this.length;let c=0;for(;a>this.frames[c].time+this.frames[c].delay&&c<this.frames.length;)c+=
1;this.currentFrameNumber=c;this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)};e.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber};e.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber};e._load=async function(a,c){try{this.loading=!0,await this._parse(a,c),this.loading=!1,this.play()}catch(b){if(!u.isAbortError(b))return new v("invalid-resource","Could not parse gif!")}};e._parse=function(a,c){const b=new x(a);b.pos+=6;this.width=
b.data[b.pos++]+(b.data[b.pos++]<<8);this.height=b.data[b.pos++]+(b.data[b.pos++]<<8);a=b.data[b.pos++];this.globalColourCount=1<<(a&7)+1;b.pos++;b.pos++;a&128&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,b));return u.create((f,k)=>{setTimeout(()=>this._parseBlock(b,f,k,c),0)})};e._parseBlock=async function(a,c,b,f){if(f&&f.signal&&u.isAborted(f.signal))b(u.createAbortError());else{var k=a.data[a.pos++];if(44===k){if(this._parseImg(a),this.firstFrameOnly){this._finishedLoading();
c();return}}else{if(59===k){this._finishedLoading();c();return}this._parseExt(a)}if("function"===typeof this.onprogress)this.onprogress({bytesRead:a.pos,totalBytes:a.data.length,frame:this.frames.length});setTimeout(()=>this._parseBlock(a,c,b,f),0)}};e._parseColourTable=function(a,c){const b=[];for(let f=0;f<a;f++)b.push([c.data[c.pos++],c.data[c.pos++],c.data[c.pos++]]);return b};e._parseImg=function(a){const c=k=>{const l=this.pixelBufSize/k;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=
new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);let n=0;for(let m=0;4>m;m++)for(let g=this.interlaceOffsets[m];g<l;g+=this.interlaceSteps[m])this.deinterlaceBuf.set(this.pixelBuf.subarray(n,n+k),g*k),n+=k},b={};this.frames.push(b);b.disposalMethod=this.disposalMethod;b.time=this.length;b.delay=10*this.delayTime;this.length+=b.delay;b.transparencyIndex=this.transparencyGiven?this.transparencyIndex:void 0;b.leftPos=a.data[a.pos++]+(a.data[a.pos++]<<8);b.topPos=a.data[a.pos++]+
(a.data[a.pos++]<<8);b.width=a.data[a.pos++]+(a.data[a.pos++]<<8);b.height=a.data[a.pos++]+(a.data[a.pos++]<<8);const f=a.data[a.pos++];b.localColourTableFlag=f&128?!0:!1;b.localColourTableFlag&&(b.localColourTable=this._parseColourTable(1<<(f&7)+1,a));this.pixelBufSize!==b.width*b.height&&(this.pixelBuf=new Uint8Array(b.width*b.height),this.pixelBufSize=b.width*b.height);this._lzwDecode(a.data[a.pos++],a.readSubBlocksB());f&64?(b.interlaced=!0,c(b.width)):b.interlaced=!1;this._processFrame(b)};e._lzwDecode=
function(a,c){let b,f,k,l,n,m,g;let r,p;k=f=0;let h=[];l=1<<a;n=l+1;m=a+1;for(p=!1;!p;){var q=g;for(b=g=0;b<m;b++)c[k>>3]&1<<(k&7)&&(g|=1<<b),k++;if(g===l){h=[];m=a+1;for(b=0;b<l;b++)h[b]=[b];h[l]=[];h[n]=null}else{if(g===n){p=!0;break}g>=h.length?h.push(h[q].concat(h[q][0])):q!==l&&h.push(h[q].concat(h[g][0]));q=h[g];r=q.length;for(b=0;b<r;b++)this.pixelBuf[f++]=q[b];h.length===1<<m&&12>m&&m++}}};e._processFrame=function(a){a.image=document.createElement("canvas");a.image.width=this.width;a.image.height=
this.height;a.ctx=a.image.getContext("2d");const c=a.localColourTableFlag?a.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=a);const b=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod?!0:!1;b||a.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);const f=a.ctx.getImageData(a.leftPos,a.topPos,a.width,a.height),k=a.transparencyIndex,l=f.data,n=a.interlaced?this.deinterlaceBuf:this.pixelBuf,m=n.length;let g=0,r,p;for(let h=0;h<m;h++)r=n[h],
p=c[r],k!==r?(l[g++]=p[0],l[g++]=p[1],l[g++]=p[2],l[g++]=255):(b&&(l[g+3]=0),g+=4);a.ctx.putImageData(f,a.leftPos,a.topPos);this.lastFrame=a};e._parseExt=function(a){const c=a.data[a.pos++];249===c?this._parseGCExt(a):254===c?this.comment+=a.readSubBlocks():255===c?this._parseAppExt(a):(1===c&&(a.pos+=13),a.readSubBlocks())};e._parseAppExt=function(a){a.pos+=1;"NETSCAPE"===a.getString(8)?a.pos+=8:(a.pos+=3,a.readSubBlocks())};e._parseGCExt=function(a){let c;a.pos++;c=a.data[a.pos++];this.disposalMethod=
(c&28)>>2;this.transparencyGiven=c&1?!0:!1;this.delayTime=a.data[a.pos++]+(a.data[a.pos++]<<8);this.transparencyIndex=a.data[a.pos++];a.pos++};e._finishedLoading=function(){this.loading=!1;this.frameCount=this.frames.length;this.lastFrame=null;this.complete=!0;this.deinterlaceBuf=this.pixelBufSize=this.deinterlaceBuf=this.pixelBuf=this.waitTillDone=this.transparencyIndex=this.delayTime=this.transparencyGiven=this.disposalMethod=void 0;this.currentFrameNumber=0;0<this.frames.length&&this._setCurrentFrame(0);
this.playOnLoad&&this.play()};e._play=function(){if(0===this.playSpeed)this.pause();else{if(0>this.playSpeed){--this.currentFrameNumber;0>this.currentFrameNumber&&(this.currentFrameNumber=this.frames.length-1);var a=this.currentFrameNumber;--a;0>a&&(a=this.frames.length-1);a=-this.frames[a].delay/this.playSpeed}else this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,a=1*this.frames[this.currentFrameNumber].delay/this.playSpeed;this._setCurrentFrame(this.currentFrameNumber);this.timerID=
window.setTimeout(()=>this._play(),a)}};e._setCurrentFrame=function(a){this.currentFrame={frameData:this.frames[a].image,top:0,left:0,width:this.width,height:this.height}};return d}(),x=function(){function d(a){this.pos=0;this.data=new Uint8ClampedArray(a);this.len=this.data.length}var e=d.prototype;e.getString=function(a){let c="";for(;a--;)c+=String.fromCharCode(this.data[this.pos++]);return c};e.readSubBlocks=function(){let a,c,b="";do for(c=a=this.data[this.pos++];c--;)b+=String.fromCharCode(this.data[this.pos++]);
while(0!==a&&this.pos<this.len);return b};e.readSubBlocksB=function(){let a,c;const b=[];do for(c=a=this.data[this.pos++];c--;)b.push(this.data[this.pos++]);while(0!==a&&this.pos<this.len);return b};return d}();t.default=y;t.getGIFSize=function(d){var e=new Uint8ClampedArray(d);let a=6;d=e[a++]+(e[a++]<<8);e=e[a++]+(e[a++]<<8);return[d,e]};t.isAnimatedGIF=function(d){if(!d||0===d.byteLength)return!1;d=new Uint8Array(d);if(!w(d))return!1;let e=0;for(let a=0,c=d.length-9;a<c&&(0!==d[a]||33!==d[a+1]||
249!==d[a+2]||4!==d[a+3]||0!==d[a+8]||44!==d[a+9]&&33!==d[a+9]||(e++,!(1<e)));++a);return 1<e};t.isGIF=w;Object.defineProperty(t,"__esModule",{value:!0})});