// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/maybe ../../../../../../core/Logger ../../../../../../core/Error ../../../../../../core/mathUtils ../../../../../../core/screenUtils ../../definitions ../../alignmentUtils ../../number ../../enums ./meshUtils ../../materialKey/MaterialKey ../../color ../../collisions/Metric ./segmentUtils ./WGLTextTemplate".split(" "),function(A,v,F,G,u,H,I,x,q,J,K,y,B,C,D,L){const M=F.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),
N=(n,l="mapview-labeling")=>M.error(new G(l,n)),O=function(n){const l=new Map;return h=>{l.has(h)||l.set(h,n(h));return l.get(h)}}(n=>{let l=0;if(0===n)return Infinity;for(;!(n%2);)l++,n/=2;return l});return function(n){function l(a,d,b,c){var e=n.call(this,a,b.font.size,b.haloSize||0,b.color&&B.premultiplyAlphaRGBAArray(b.color)||0,b.haloColor&&B.premultiplyAlphaRGBAArray(b.haloColor)||0,b.horizontalAlignment,b.verticalAlignment,K.isMapAligned(d.labelPlacement)?1:0,b.font.decoration,!1,b.angle||
0,b.xoffset,b.yoffset,b.lineWidth,b.lineHeight,null,null)||this;e._outLineLabelAngle=0;e._refPlacementPadding=0;e._refPlacementDirX=0;e._refPlacementDirY=0;e._refOffsetX=0;e._refOffsetY=0;e.geometryType=J.WGLGeometryType.LABEL;var f=!!d.minScale&&c.scaleToZoom(d.minScale)||0;f=u.clamp(f,0,25.5);c=!!d.maxScale&&c.scaleToZoom(d.maxScale)||255;c=u.clamp(c,0,25.5);const [g,k]=x.getAlignmentFromPlacement(d.labelPlacement);e._xAlignD=g;e._yAlignD=k;e._minZoom=f;e._maxZoom=c;e._refPlacementPadding=H.pt2px(b.haloSize)+
I.TEXT_PLACEMENT_PADDING;a=y.LabelMaterialKey.load(a);a.sdf=!0;e._materialKey=a.data;return e}A._inheritsLoose(l,n);l.fromLabelClass=function(a,d){if("center-along"===a.labelPlacement){const b=a.symbol;b.xoffset=0;b.yoffset=0;b.angle=0;b.font.decoration="none"}return new l(a.materialKey,a,a.symbol,d)};var h=l.prototype;h.bindReferenceTemplate=function(a){let d=x.getXDirection(this._xAlignD),b=x.getYDirection(this._yAlignD);this._refOffsetY=this._refOffsetX=0;if(v.isNone(a))this._refSymbolAndPlacementOffset=
q.i8888to32(0,0,Math.floor(127*d+127),Math.floor(127*b+127));else{if("circle"===a.boundsType&&(d||b)){var c=Math.sqrt(d*d+b*b);d/=c;b/=c}c=Math.max(a.height,a.width);this._refSymbolAndPlacementOffset=q.i8888to32(4*this._refPlacementPadding,c,Math.floor(127*d+127),Math.floor(127*b+127));this._referenceSize=c;this._refPlacementDirX=d;this._refPlacementDirY=b;this._refOffsetX=a.xOffset;this._refOffsetY=a.yOffset}};h.writeMesh=function(a,d,b,c,e,f){if(!v.isNone(this._shapingInfo)){var g=[],k=this._shapingInfo;
if(b="esriGeometryPolygon"===b.geometryType?b.readLegacyCentroid():b.readLegacyGeometry()){this.current={out:a,outVecs:d,outMetrics:g,inId:e,inShaping:k,zoomLevel:f};switch(c){case "esriGeometryPolyline":this._placeLineLabels(b);break;case "esriGeometryPoint":case "esriGeometryPolygon":this._placePointLabels(b);break;default:N("mapview-labeling",`Geometry of type ${c} is not supported`)}a.writeMetrics(this.current.outMetrics)}}};h._isVisible=function(a,d){const b=Math.floor(10*this.current.zoomLevel);
return Math.floor(10*a)<=b&&b<=Math.floor(10*d)};h._placePointLabels=function(a){const {out:d,outVecs:b,outMetrics:c,inId:e}=this.current;this._writeGlyphs(d,b,e,a,c)};h._placeLineLabels=function(a){a=D.smoothPaths(a.paths,this.current.inShaping.bounds.width);const d=this._placeSubdivGlyphs.bind(this),b=(this._shapedBox.width+128)/4;for(const c of a)D.pathDivide(c,b,d)};h._placeSubdivGlyphs=function(a,d,b,c){var e=O(d);b=u.log2(Math.min(b,c-b)/(4+this._shapedBox.width/4/2));e=Math.max(this._minZoom,
this.current.zoomLevel+2-(0===d?b:Math.min(e,b)));b=this._shapedBox.width/2*Math.pow(2,this.current.zoomLevel-e);this.current.inShaping.isMultiline?0===d&&this._placeStraight(a,e):this._placeCurved(a,e,b)};h._placeStraight=function(a,d){const {out:b,outVecs:c,outMetrics:e,inId:f}=this.current;this._writeGlyphs(b,c,f,a,e,d)};h._placeCurved=function(a,d,b){var c={from:this.current.out.currentDisplayRecordCount(),count:-1};c=new C(this.current.inId,c,a.x,a.y,d);const e=a.clone(),f=(180/Math.PI*a.angle+
180)%360;this._outLineLabelAngle=Math.round(180/Math.PI*a.angle%360*(254/360));this._placeFirst(e,c,d,1);this._placeBack(a,e,c,d,b,1);this._placeForward(a,e,c,d,b,1);this._outLineLabelAngle=Math.round(254/360*f);this._placeFirst(e,c,d,0);this._placeBack(a,e,c,d,b,0);this._placeForward(a,e,c,d,b,0);c.range.count=this.current.out.currentDisplayRecordCount()-c.range.from;c.bounds&&this.current.outMetrics.push(c)};h._placeBack=function(a,d,b,c,e,f){const g=a.clone();for(a=a.backwardLength+0;g.prev()&&
!(a>=e);)this._placeOnSegment(g,d,b,a,c,-1,f),a+=g.length+0};h._placeForward=function(a,d,b,c,e,f){const g=a.clone();for(a=a.remainingLength+0;g.next()&&!(a>=e);)this._placeOnSegment(g,d,b,a,c,1,f),a+=g.length+0};h._placeFirst=function(a,d,b,c){const e=this.current.inShaping;var f=e.glyphs;const g=this.current.zoomLevel,{out:k,outVecs:r,inId:t}=this.current,z=q.i1616to32(Math.round(8*a.x),Math.round(8*a.y));for(const m of f)f=m.x>e.bounds.x?c:1-c,f=Math.max(0,g+u.log2(Math.abs(m.x+m.width/2-e.bounds.x)/
(f*a.remainingLength+(1-f)*a.backwardLength))),f=Math.max(b,f),m.maxZoom=25,m.angle=a.angle+(1-c)*Math.PI,m.minZoom=f,this._writeGlyph(k,r,m,t,z),c&&this._isVisible(m.minZoom,m.maxZoom)&&d.add(m.bounds,0,0)};h._placeOnSegment=function(a,d,b,c,e,f,g){var k=this.current.inShaping.glyphs;const {out:r,outVecs:t,inId:z}=this.current,m=this.current.inShaping,E=this.current.zoomLevel,P=q.i1616to32(Math.round(8*(a.x+a.dx/a.length*-f*c)),Math.round(8*(a.y+a.dy/a.length*-f*c)));for(const p of k)if((k=p.x>m.bounds.x?
g:1-g)&&1===f||!k&&-1===f){var w=Math.abs(p.x+p.width/2-m.bounds.x);k=Math.max(0,E+u.log2(w/c)-.1);w=Math.max(e,E+u.log2(w/(c+a.length+0)));0!==k&&(p.angle=a.angle+(1-g)*Math.PI,p.minZoom=w,p.maxZoom=k,this._writeGlyph(r,t,p,z,P),g&&this._isVisible(p.minZoom,p.maxZoom)&&b.add(p.bounds,a.x-d.x,a.y-d.y))}};h._writeGlyphs=function(a,d,b,c,e,f=this._minZoom){const g=this._shapingInfo;if(!(v.isNone(g)||0>c.x||512<=c.x||0>c.y||512<=c.y)){var k=a.currentDisplayRecordCount(),r=q.i1616to32(Math.round(8*(c.x+
this._refOffsetX)),Math.round(8*(c.y-this._refOffsetY)));c=new C(b,{from:k,count:-1},c.x+this._refOffsetX,c.y-this._refOffsetY,f);for(const t of g.glyphs)t.minZoom=f,t.maxZoom=this._maxZoom,this._writeGlyph(a,d,t,b,r);c.range.count=a.currentDisplayRecordCount()-c.range.from;c.bounds=g.boundsT;a=y.LabelMaterialKey.load(this._materialKey);c.setPlacementOffset(a.vvSizeFieldStops||a.vvSizeMinMaxValue||a.vvSizeScaleStops||a.vvSizeUnitValue,this._referenceSize,this._refPlacementPadding,this._refPlacementDirX,
this._refPlacementDirY);e.push(c)}};h._writeGlyph=function(a,d,b,c,e){const f=y.MaterialKeyBase.load(this._materialKey);f.textureBinding=b.textureBinding;const g=d.indexVector.length,k=d.getVector("geometry").vertexCount,r=this._writeIndices(d);d=this._writeVertex(d,c,e,b);a.writeDisplayRecord(this.geometryType,f.data,k,d,g,r)};h._writeVertexCommon=function(a,d,b,c){const e=this._color,f=this._haloColor,g=q.i8888to32(0,0,this._size,this._haloSize);c=q.i8888to32(Math.floor(10*Math.max(c.minZoom,this._minZoom)),
Math.floor(10*Math.min(c.maxZoom,this._maxZoom)),this._outLineLabelAngle,0);a.push(b);a.push(d);a.push(e);a.push(f);a.push(g);a.push(this._refSymbolAndPlacementOffset);a.push(c)};A._createClass(l,[{key:"_shapedBox",get:function(){return v.unwrap(this._shapingInfo).bounds}}]);return l}(L)});