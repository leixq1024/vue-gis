// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Logger ../../../../../core/Error ../../../../../core/mathUtils ../definitions ./CollisionBucket ./LayerCollisionInfo".split(" "),function(A,C,x,D,y,r,E,t){const u=r.TILE_SIZE/r.COLLISION_BUCKET_SIZE,F=x.getLogger("esri.views.2d.engine.webgl.collisions.CollisionEngine");x=function(){function z(a){this._layers=new Map;this._collisionBuckets=new Map;this._didError=!1;this._tilingScheme=a}var h=z.prototype;h.registerLayerView=
function(a,b){if(!this._layers.has(a)){var c=t["default"].create(a,b,this.collisionInfos,this._tilingScheme);this._layers.set(a,c);this._collisionBuckets.forEach(d=>d.onRegisterLayer(c.index))}};h.unregisterLayerView=function(a){if(this._layers.has(a)){var b=this._layers.get(a);t["default"].delete(b.index,this.collisionInfos);this._layers.delete(a);this._collisionBuckets.forEach((c,d)=>{const f=c.getTile(b.index);f&&(c.onUnregisterLayer(b.index),c.canDelete()&&this._collisionBuckets.delete(d),f.reference&&
(f.reference.isDirty=!1))})}};h.addTile=function(a,b){const c=b.key.id;this._layers.has(a)&&(this._collisionBuckets.has(c)||this._collisionBuckets.set(c,new E(b.key,this._layers.size)),a=this._getIndex(a),this._collisionBuckets.get(c).getTile(a).reference=b)};h.removeTile=function(a,b){this._layers.has(a)&&this._collisionBuckets.has(b)&&(a=this._getIndex(a),b=this._collisionBuckets.get(b).getTile(a),b.dirty=!1,b.reference=null)};h.run=function(a,b){const c=Array.from(this._collisionBuckets.values()).sort((e,
k)=>e.key.compareRowMajor(k.key));let d=!0;const f=a.renderingOptions.labelCollisionsEnabled&&!this._didError,l=this.collisionInfos;try{for(const e of c){d=d||e.isDirty;e.computeNeighbors(this._collisionBuckets);for(let k=0;k<this._layers.size;k++){const m=t["default"].find(k,l);e.reset(a,d,m)}}for(a=0;a<this._layers.size;a++){const e=t["default"].find(a,l);for(const k of c)this._run(f,k,e,b)}}catch(e){F.error(new D("mapview-labeling","Encountered an error during decluttering. Disabling collisions",
e)),this._didError=!0}for(const e of c)e.ready()};h._run=function(a,b,c,d){const f=b.getReference(c.index);f&&f.hasData&&(f.key.level!==d?this._resetLabelsMinZoom(b,c):this._runVisibility(a,b,f,c,d))};h._resetLabelsMinZoom=function(a,b){if(a&&"polyline"!==b.geometryType&&(a=a.getReference(b.index))&&a.hasData){b=b.layerView.tileRenderer.featuresView.attributeView;a=a.displayObjects;for(const c of a)b.setLabelMinZoom(c.id,255)}};h._checkLabelsVisible=function(a,b){const c=!b.effect||b.effect.excludedLabelsVisible||
!!(a&r.EFFECT_FLAG_0);return(!b.filter||!!(a&r.FILTER_FLAG_0))&&c};h._runVisibility=function(a,b,c,d,f){const l=d.layerView.tileRenderer.featuresView.attributeView;var e=c.displayObjects.sort((g,n)=>{g=l.getLabelMinZoom(g.id);n=l.getLabelMinZoom(n.id);return g-n});c=d.zoomRanges.some(g=>"none"===g.deconflictionStrategy);for(const g of e)if(g.metrics.length){e="polyline"===d.geometryType?0:10*(f-1);var k=l.getFilterFlags(g.id);k=this._checkLabelsVisible(k,d.layerView);if(a&&!c)for(let n=0;n<g.metrics.length;n++){var m=
g.metrics[n];m=k?-1!==m.minZoom?m.minZoom:this._computeLabelVisibility(g,m,d.index,b,m.baseZoom,f):255;e=Math.max(m,e)}e=Math.max(e,0);l.setLabelMinZoom(g.id,e);for(const n of g.metrics)n.minZoom=e}};h._computeLabelVisibility=function(a,b,c,d,f,l){const {xBucket:e,yBucket:k,xOverflow:m,yOverflow:g}=b,n=e-m,G=e+m+1;var p=k-g;const H=k+g+1;for(;p<H;p++)for(let q=n;q<G;q++)if(!(q<-u||p<-u||q>u||p>u))for(let v=0;v<=c;v++){var w=this._getRelativeSubBucket(v,d,q,p);if(w)for(const B of w)if(v!==c||B.id!==
a.id)w=this._compareLabels(b,B,f,l),f=Math.max(w,f)}return f};h._compareLabels=function(a,b,c,d){if(-1===b.minZoom||b.minZoom>10*(d+1))return c;a=a.findCollisionDelta(b);d=y.clamp(Math.ceil(10*(a+d)),0,255);return b.minZoom>=d?c:Math.max(c,d)};h._getNeighboringTile=function(a,b,c,d){return(b=b.neighbors[3*(1+d)+(1+c)])&&b.getTile(a)};h._getRelativeSubBucket=function(a,b,c,d){const f=y.sign(Math.floor(c/4)),l=y.sign(Math.floor(d/4));return(a=this._getNeighboringTile(a,b,f,l))&&a.reference&&a.index&&
a.reference.hasData?a.index[d-4*l][c-4*f]:null};h._getIndex=function(a){return this._layers.get(a).index};C._createClass(z,[{key:"collisionInfos",get:function(){return Array.from(this._layers.values())}}]);return z}();A.CollisionEngine=x;Object.defineProperty(A,"__esModule",{value:!0})});