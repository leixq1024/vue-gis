// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/maybe ../../../../core/CircularArray ../../../../chunks/vec2 ./definitions ../../../../chunks/mat2d ../../../../chunks/mat2df32 ../../../../chunks/vec2f32 ./TiledDisplayObject ./enums ./DirtyMap ./DisplayRecordStore ./Fader ./WGLBuffers".split(" "),function(z,A,B,C,E,F,q,v,G,H,I,w,D,x,J,K){const y=new Set;B=function(r){function t(a,c,b=!1){a=r.call(this,a,c,[q.TILE_SIZE,q.TILE_SIZE])||this;a._data=null;
a._displayList=null;a._wglBuffers=null;a._deferPatches=!1;a._dirtyMap=new D;a._labelIndex=null;a._lastCommitTime=0;a._patchQueue=new E(100);a.fader=new J;a._dirty=!0;a._replaceBuffers=!1;a._uploadsLocked=!1;a._hasData=!1;a._invalidated=!1;a.transforms.labelMat2d=G.create();a._ensureCorrectZOrder=b;a._deferPatches=!b;return a}A._inheritsLoose(t,r);var h=t.prototype;h.destroy=function(){r.prototype.destroy.call(this);this.clear()};h.getGeometry=function(a){return this._wglBuffers&&this._wglBuffers.has(a)?
this._wglBuffers.get(a):null};h.getDisplayList=function(){return this._displayList};h.setTransform=function(a,c){r.prototype.setTransform.call(this,a,c);const b=this.transforms.labelMat2d;c=a.getScreenTransform(b,c);const e=H.create();F.transformMat2d(e,this.coords,c);v.identity(b);v.translate(b,b,e);v.multiply(b,a.viewMat2d,b)};h.setData=function(a){const c=a.addOrUpdate,b=a.remove;a.clear&&(this.clear(),this._patchQueue.clear(),this._hasData=!1);"replace"===a.type&&(this._replaceBuffers=!0,this._patchQueue.clear(),
this._data=null);!this._data&&c&&c.tileDisplayData.displayObjects.length?(c.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new D,this._dispRecStore=x.fromTileData(c,this._dirtyMap),this._data=c,this._dirtyMap.markAllDirty(),this._hasData=!0,a.end&&this.ready()):this._data?c&&c.tileDisplayData.displayObjects.length||b.length?this._deferPatches?this._patchQueue.enqueue(a):this._doPatchData(a):a.end&&this.ready():a.end&&this.ready();a.end&&!this._data&&this.clear();this.requestRender();
this.emit("change")};h.lockUploads=function(){this._uploadsLocked=!0};h.unlockUploads=function(){this._uploadsLocked=!1;this.requestRender()};h.commitChanges=function(a){if(!a.time||a.time!==this._lastCommitTime){this._lastCommitTime=a.time;this.fader.step()||this.requestRender();if(this._patchQueue.size){var c=this._patchQueue.dequeue();C.isSome(c)&&(c.end&&this.ready(),this._doPatchData(c),this.requestRender(),this._hasData=!0)}if(this._uploadsLocked)this.requestRender();else if(this.visible&&this._data){if(this._replaceBuffers)for(this._wglBuffers&&
this._wglBuffers.dispose(),this._wglBuffers=null,this._replaceBuffers=!1;this._patchQueue.size;)c=this._patchQueue.dequeue(),C.isSome(c)&&(c.end&&this.ready(),this._doPatchData(c),this._hasData=!0);this._wglBuffers||(this._wglBuffers=new K(a.context));if(this._dirtyMap.hasDirty()||this._invalidated)this._invalidated=!1,this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._displayList=this._data.tileDisplayData.displayList.clone(),this._displayObjects=this._data.tileDisplayData.displayObjects.slice(),
this._rebuildLabelIndex(),this._dirtyMap.markAllClean()}}};h.clear=function(){this._dispRecStore=this._displayList=this._data=null;this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null)};h._doPatchData=function(a){try{if("new"===a.type){if(!a.addOrUpdate)return;this._invalidated=!0;const c=this._bulkAddFeatures(a);c&&(this._dirtyMap.markAllDirty(),this._data.reshuffleBulkAdd(a,c.objectIndex,c.recordIndex),this._dispRecStore=x.fromTileData(this._data,this._dirtyMap))}else this._invalidated=
!0,this._patchData(a)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=x.fromTileData(this._data,this._dirtyMap))}catch(c){}this.requestRender()};h._rebuildLabelIndex=function(){var a,c;if(null!=(a=this._data)&&null!=(c=a.tileBufferData.geometries[w.WGLGeometryType.LABEL])&&c.indexBuffer.length){this.isDirty=!0;this._labelIndex=this._initLabelIndex();for(const b of this.displayObjects)for(const e of b.metrics)this._insertIntoLabelIndex(e)}};h._insertIntoLabelIndex=function(a){0>
a.xBucket||0>a.yBucket||3<a.yBucket||3<a.xBucket||this.labelIndex[a.yBucket][a.xBucket].push(a)};h._initLabelIndex=function(){const a=[];for(let c=0;c<q.TILE_SIZE/q.COLLISION_BUCKET_SIZE;c++){a.push([]);for(let b=0;b<q.TILE_SIZE/q.COLLISION_BUCKET_SIZE;b++)a[c].push([])}return a};h._bulkAddFeatures=function(a){const c=a.addOrUpdate.tileDisplayData.displayObjects,b=this._data.tileDisplayData.displayObjects,e=this._data.tileDisplayData.displayObjectRegistry;for(let d=0;d<c.length;d++){const f=c[d],
g=e.get(f.id);for(let m=0;m<f.displayRecords.length;++m){const k=f.displayRecords[m];if(g){if(k.geometryType!==w.WGLGeometryType.FILL&&k.geometryType!==w.WGLGeometryType.LINE)continue;g.displayRecords.push(k)}if(!this._dispRecStore.tryAddMeshData(k,a.addOrUpdate.tileBufferData.geometries[k.geometryType]))return{objectIndex:d,recordIndex:m}}g||(e.set(f.id,f),b.push(f))}return null};h._patchData=function(a){let c=!0;var b=a.addOrUpdate&&a.addOrUpdate.tileDisplayData&&a.addOrUpdate.tileDisplayData.displayObjects||
[],e=(a.remove||[]).slice();for(var d of b)null!=d.insertAfter&&e.push(d.id);for(var f of e)if(e=this._data.tileDisplayData.displayObjectRegistry.get(f)){this._data.tileDisplayData.displayList.removeFromList(e.displayRecords);for(var g of e.displayRecords)this._dispRecStore.delete(g);this._data.tileDisplayData.displayObjectRegistry.delete(f);e=this._data.tileDisplayData.displayObjects.indexOf(e);this._data.tileDisplayData.displayObjects.splice(e,1)}for(const l of b){b=this._data.tileDisplayData.displayObjectRegistry.get(l.id);
let n;if(b){f=b.displayRecords;b.set(l);b.displayRecords=f;f=b.displayRecords.length;for(g=0;g<f;++g)if(e=b.displayRecords[g],d=l.displayRecords[g],g>=l.displayRecords.length||e.geometryType!==d.geometryType||e.symbolLevel!==d.symbolLevel||e.zOrder!==d.zOrder||e.materialKey!==d.materialKey)this._dispRecStore.delete(b.displayRecords[g]),g<l.displayRecords.length&&(b.displayRecords[g]=void 0);b.displayRecords.length=l.displayRecords.length;b.metrics=l.metrics}else if(b=l.copy(),b.displayRecords=[],
this._data.tileDisplayData.displayObjectRegistry.set(l.id,b),f=this._data.tileDisplayData.displayObjects,null!=b.insertAfter?(n={},0<=b.insertAfter?(g=this._data.tileDisplayData.displayObjectRegistry.get(b.insertAfter))?(d=f.indexOf(g)+1,d<f.length?f.splice(d,0,b):(f.push(b),d=f.length)):(f.push(b),d=f.length):(f.unshift(b),d=0)):(f.push(b),d=f.length),n){if(this._data.tileDisplayData.displayList.unified)g=0<l.displayRecords.length?1:0;else{y.clear();for(const u of l.displayRecords)g=this._data.tileDisplayData.displayList.getDPInfoType(u.geometryType),
y.add(g);g=y.size}e=0;for(--d;0<=d&&e<g;--d)for(var m=f[d].displayRecords.length-1;0<=m&&e<g;--m){var k=f[d].displayRecords[m],p=this._data.tileDisplayData.displayList.getDPInfoType(k.geometryType);n[p]||(n[p]=k,++e)}}f=l.displayRecords.length;for(g=0;g<f;++g){e=l.displayRecords[g];(d=b.displayRecords[g])?(d.meshData=e.meshData,d.materialKey=e.materialKey):(d=e.copy(),d.vertexFrom=void 0,d.indexFrom=void 0,b.displayRecords[g]=d);k=e.geometryType;m=this._data.tileDisplayData.displayList.getDPInfoType(k);
p=a.addOrUpdate.tileBufferData.geometries[k];k=p.vertexBuffer;p=p.indexBuffer;let u=void 0;n&&(u=n[m]?this._data.tileDisplayData.displayList.splitAfter(n[m]):-1);c=this._dispRecStore.setMeshData(d,e,k,p,u)&&c;n&&null!=d.indexFrom&&null!=d.indexFrom&&(n[m]=d)}}return c};A._createClass(t,[{key:"displayObjects",get:function(){var a;return null!=(a=this._displayObjects)?a:[]}},{key:"isDirty",get:function(){return this._dirty},set:function(a){this._dirty=a;this.requestRender()}},{key:"hasData",get:function(){return!!this._hasData}},
{key:"labelIndex",get:function(){return this._labelIndex}}]);return t}(I.TiledDisplayObject);z.WGLTile=B;Object.defineProperty(z,"__esModule",{value:!0})});