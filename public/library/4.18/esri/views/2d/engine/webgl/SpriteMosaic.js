// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/maybe ../../../../core/Error ./definitions ../../../webgl/Program ../../../webgl/BufferObject ../../../webgl/Texture ../../../webgl/VertexArrayObject ../../../webgl/Renderbuffer ../../../webgl/FramebufferObject ../../../webgl/ProgramCache ../../../webgl/RenderingContext ../../../webgl/ShaderCompiler ./Rect ./GeometryUtils ./RectangleBinPack".split(" "),function(z,u,A,B,p,C,D,v,E,F,G,H,I,J,w,x,y){function n(m){return m&&
"static"===m.type}return function(){function m(a,b,c,d=0){this._mosaicPages=[];this._currentPage=this._maxItemSize=0;this._fixSpriteLocationsTable=u("fix-sprite-locations");this._testId=u("test-id");this._pageHeight=this._pageWidth=0;this._mosaicRects=new Map;this._spriteCopyQueue=[];this.pixelRatio=1;(0>=b||0>=c)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");this._pageWidth=b;this._pageHeight=c;this._requestRender=a;0<d&&(this._maxItemSize=d);this.pixelRatio=
window.devicePixelRatio||1;if(this._fixSpriteLocationsTable){a=[];for(const f in this._fixSpriteLocationsTable[this._testId])b=this._fixSpriteLocationsTable[this._testId][f],a[b.page]=b.pageSize;for(const f of a)this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(f[0]*f[1])},size:[f[0],f[1]],dirty:!0,texture:void 0})}this._binPack=new y(this._pageWidth,this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight))},
size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}var h=m.prototype;h.getWidth=function(a){return a>=this._mosaicPages.length?-1:this._mosaicPages[a].size[0]};h.getHeight=function(a){return a>=this._mosaicPages.length?-1:this._mosaicPages[a].size[1]};h.getPageTexture=function(a){return a<this._mosaicPages.length?this._mosaicPages[a].texture:null};h.has=function(a){return this._mosaicRects.has(a)};h.getSpriteItem=function(a){return this._mosaicRects.get(a)};h.addSpriteItem=function(a,
b,c,d,f,e){if(this._mosaicRects.has(a))return this._mosaicRects.get(a);let g,k;if(n(c))if(this._fixSpriteLocationsTable&&this._fixSpriteLocationsTable[this._testId]&&this._fixSpriteLocationsTable[this._testId][a]){var l=this._fixSpriteLocationsTable[this._testId][a];g=l.rect;k=l.page;l=l.pageSize}else[g,k,l]=this._allocateImage(b[0],b[1]);else g=new w(0,0,b[0],b[1]),k=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:c,size:b,dirty:!0,texture:void 0});if(0>=g.width||0>=g.height)return null;
e={rect:g,width:b[0],height:b[1],sdf:f,simplePattern:e,pixelRatio:1,page:k};this._mosaicRects.set(a,e);n(c)&&this._copy({rect:g,spriteSize:b,spriteData:c.data,page:k,pageSize:l,repeat:d,sdf:f});return e};h.hasItemsToProcess=function(){return 0!==this._spriteCopyQueue.length};h.processNextItem=function(){const a=this._spriteCopyQueue.pop();a&&this._copy(a)};h.getSpriteItems=function(a){const b={};for(const c of a)b[c]=this.getSpriteItem(c);return b};h.getMosaicItemPosition=function(a){const b=(a=this.getSpriteItem(a))&&
a.rect;if(!b)return null;b.width=a.width;b.height=a.height;const c=p.SPRITE_PADDING,d=this._mosaicPages[a.page];return{size:[a.width,a.height],tl:[(b.x+c)/d[0],(b.y+c)/d[1]],br:[(b.x+c+a.width)/d[0],(b.y+c+a.height)/d[1]],page:a.page}};h.bind=function(a,b,c=0,d=0){c=this._mosaicPages[c];var f=c.mosaicsData,e=c.texture;e||(e=c.size,e=n(f)?new v(a,{pixelFormat:6408,dataType:5121,width:e[0],height:e[1]},new Uint8Array(f.data.buffer)):new v(a,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,
width:e[0],height:e[1]},null),c.texture=e);e.setSamplingMode(b);n(f)?(a.bindTexture(e,d),c.dirty&&(e.setData(new Uint8Array(f.data.buffer)),e.generateMipmap())):(b=f.data,f=b.bindFrame(a,e,d),A.isSome(this._requestRender)&&f&&0<b.frameCount&&this._requestRender.requestRender(),b.bindFrame(a,e,d));c.dirty=!1};m._copyBits=function(a,b,c,d,f,e,g,k,l,r,q){let t=d*b+c;g=k*e+g;if(q)for(g-=e,q=-1;q<=r;q++,t=((q+r)%r+d)*b+c,g+=e)for(k=-1;k<=l;k++)f[g+k]=a[t+(k+l)%l];else for(c=0;c<r;c++){for(d=0;d<l;d++)f[g+
d]=a[t+d];t+=b;g+=e}};h._copy=function(a){if(!(a.page>=this._mosaicPages.length)){var b=this._mosaicPages[a.page],c=b.mosaicsData;if(!n(b.mosaicsData))throw new B("mapview-invalid-resource","unsuitable data type!");var d=a.spriteData;(c=c.data)&&d||console.error("Source or target images are uninitialized!");m._copyBits(d,a.spriteSize[0],0,0,c,a.pageSize[0],a.rect.x+p.SPRITE_PADDING,a.rect.y+p.SPRITE_PADDING,a.spriteSize[0],a.spriteSize[1],a.repeat);b.dirty=!0}};h._allocateImage=function(a,b){a+=2*
p.SPRITE_PADDING;b+=2*p.SPRITE_PADDING;var c=Math.max(a,b);if(this._maxItemSize&&this._maxItemSize<c){c=Math.pow(2,Math.ceil(x.log2(a)));const d=Math.pow(2,Math.ceil(x.log2(b)));a=new w(0,0,a,b);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(c*d)},size:[c,d],dirty:!0,texture:void 0});return[a,this._mosaicPages.length-1,[c,d]]}c=this._binPack.allocate(a,b);return 0>=c.width?(c=this._mosaicPages[this._currentPage],!c.dirty&&n(c.mosaicsData)&&(c.mosaicsData.data=null),this._currentPage=
this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new y(this._pageWidth,this._pageHeight),this._allocateImage(a,b)):[c,this._currentPage,[this._pageWidth,this._pageHeight]]};h.dispose=function(){this._binPack=null;for(const b of this._mosaicPages){var a=b.texture;a&&a.dispose();a=b.mosaicsData;n(a)||a.data.pause()}this._mosaicPages=null;
this._mosaicRects.clear()};z._createClass(m,[{key:"itemCount",get:function(){return this._mosaicRects.size}}]);return m}()});