// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../config ../../../../core/maybe ../../../../core/Logger ../../../../core/Error ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../request ../../../../chunks/vec2 ./definitions ../../../../chunks/vec2f32 ./util/BidiText ../../../../symbols/cim/Rasterizer ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./animatedFormats/apng ./animatedFormats/gif ./util/Result ./util/symbolUtils".split(" "),
function(E,F,G,H,l,t,u,v,B,n,I,J,K,p,L,M,N,O,P,w,x,y,Q){function R(e){switch(e.type){case "CIMSolidStroke":case "CIMSolidFill":return!0;case "esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case "esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}function q(e){switch(e.type){case "esriSMS":case "esriPMS":case "CIMPointSymbol":case "CIMVectorMarker":case "CIMPictureMarker":case "CIMCharacterMarker":return!1;default:return!0}}async function S(e){e=window.URL.createObjectURL(e);
try{const {data:g}=await v(e,{responseType:"image"});window.URL.revokeObjectURL(e);return g}catch(g){return window.URL.revokeObjectURL(e),new l("mapview-invalid-resource",`Could not fetch requested resource at ${e}`)}}async function T(e,g){e=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;var a;if(-1!==e.indexOf(";base64,")){g=e.indexOf(";base64,")+8;g=e.substring(g);g=atob(g);e=new Uint8Array(g.length);for(a=0;a<g.length;a++)e[a]=g.charCodeAt(a);a=e.buffer}else try{const {data:b}=
await v(e,{responseType:"array-buffer",...g});a=b}catch(b){if(!t.isAbortError(b))return new l("mapview-invalid-resource",`Could not fetch requested resource at ${e}`)}return a}function C(e,g){g=Math.round(u.pt2px(g)*window.devicePixelRatio);return Math.min(e,g*(128<=g?2:4))}const D=I.create(),r=H.getLogger("esri.views.2d.engine.webgl.TextureManager");let U=function(){function e(g,a,b){this.mosaicType=g;this.page=a;this.sdf=b}e.fromMosaic=function(g,a){return new e(g,a.page,a.sdf)};return e}();return function(){function e(a){this._invalidFontsMap=
new Map;this._sdfConverter=new O(126);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._rasterizer=new K;this._ongoingRasterizations=new Map;this._spriteMosaic=new P(a,2048,2048,500);this._glyphSource=new N(`${F.fontsUrl}/{fontstack}/{range}.pbf`);this._glyphMosaic=new M(1024,1024,this._glyphSource)}var g=e.prototype;g.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizer.dispose();this._sdfConverter.dispose();this._sdfConverter=this._rasterizer=this._glyphMosaic=
this._spriteMosaic=null;this._hashToBindingIndex.clear();this._bindingInfos=this._hashToBindingIndex=null;this._ongoingRasterizations.clear();this._ongoingRasterizations=null};g.rasterizeItem=async function(a,b,c,d){if(G.isNone(a))return r.error(new l("mapview-null-resource","Unable to rasterize null resource",void 0)),null;switch(a.type){case "CIMTextSymbol":case "esriTS":return a=await this._rasterizeText(a,c,d),a.forEach(f=>this._setTextureBinding(p.MosaicType.GLYPH,f)),{glyphMosaicItems:a};default:if(a.type&&
-1!==a.type.toLowerCase().indexOf("3d"))return r.error(new l("mapview-invalid-type",`MapView does not support symbol type: ${a.type}`,a)),null;a=await this._rasterizeSpriteSymbol(a,b,d);y.ok(a)&&a&&this._setTextureBinding(p.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}};g.bindTextures=function(a,b,c,d=!1){if(0!==c.textureBinding){var f=this._bindingInfos[c.textureBinding-1];c=f.page;d=d?9987:9729;switch(f.mosaicType){case p.MosaicType.SPRITE:{f=this.sprites.getWidth(c);const h=this.sprites.getHeight(c);
f=B.set(D,f,h);this._spriteMosaic.bind(a,d,c,n.TEXTURE_BINDING_SPRITE_ATLAS);b.setUniform1i("u_texture",n.TEXTURE_BINDING_SPRITE_ATLAS);b.setUniform2fv("u_mosaicSize",f);break}case p.MosaicType.GLYPH:f=B.set(D,this.glyphs.width,this.glyphs.height);this._glyphMosaic.bind(a,d,c,n.TEXTURE_BINDING_GLYPH_ATLAS);b.setUniform1i("u_texture",n.TEXTURE_BINDING_GLYPH_ATLAS);b.setUniform2fv("u_mosaicSize",f);break;default:r.error("mapview-texture-manager",`Cannot handle unknown type ${f.mosaicType}`)}}};g._hashMosaic=
function(a,b){return 1|a<<1|(b.sdf?1:0)<<2|b.page<<3};g._setTextureBinding=function(a,b){const c=this._hashMosaic(a,b);this._hashToBindingIndex.has(c)||(a=U.fromMosaic(a,b),this._hashToBindingIndex.set(c,this._bindingInfos.length+1),this._bindingInfos.push(a));b.textureBinding=this._hashToBindingIndex.get(c)};g._rasterizeText=async function(a,b,c){const d=L.getFullyQualifiedFontName(a.font),f=this._invalidFontsMap.has(d);if(b)a=b;else{a=J.bidiText(a.text)[0];b=[];for(let h=0;h<a.length;h++)b.push(a.charCodeAt(h));
a=b}try{return await this._glyphMosaic.getGlyphItems(f?"arial-unicode-ms-regular":d,a,c)}catch(h){return r.error(new l("mapview-invalid-resource",`Couldn't find font ${d}. Falling back to Arial Unicode MS Regular`,void 0)),this._invalidFontsMap.set(d,!0),this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",a,c)}};g._rasterizeSpriteSymbol=async function(a,b,c){if(R(a))return null;const d=Q.keyFromSymbol(a);if(this._spriteMosaic.has(d))return this._spriteMosaic.getSpriteItem(d);if("esriSMS"===
a.type&&a.path||a.url||a.imageData)return this._handleAsyncResource(d,a,c);if(b=this._rasterizer.rasterizeJSONResource(a,b)){const {size:f,image:h,sdf:k,simplePattern:m}=b;return this._addItemToMosaic(d,f,{type:"static",data:h},q(a),k,m)}return new l("TextureManager","unrecognized or null rasterized image")};g._handleAsyncResource=async function(a,b,c){if(this._ongoingRasterizations.has(a))return this._ongoingRasterizations.get(a);b="esriSMS"===b.type&&b.path?this._handleSVG(b,a,c):this._handleImage(b,
a,c);this._ongoingRasterizations.set(a,b);try{await b,this._ongoingRasterizations.delete(a)}catch{this._ongoingRasterizations.delete(a)}return b};g._handleSVG=async function(a,b,c){a=await this._sdfConverter.draw(a.path,c);return this._addItemToMosaic(b,[126,126],{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0)};g._handleGIFOrPNG=async function(a,b,c){var d=await T(a,c);if(y.ok(d)){var f=x.isGIF(d);const h=w.isPNG(d);if(!f&&!h)return new l("mapview-invalid-resource","Image data is neither GIF nor PNG!");
let k;try{f&&x.isAnimatedGIF(d)?k=await x["default"].create(d,c):h&&w.isAnimatedPNG(d)&&(k=await w["default"].create(d,c))}catch(m){if(!t.isAbortError(m))return new l("mapview-invalid-resource","Could not fetch requested resource!")}if(k&&y.ok(k))return this._addItemToMosaic(b,[k.width,k.height],{type:"animated",data:k},q(a),!1,!1);c=new Blob([d],{type:f?"image/gif":"image/png"});if((c=await S(c))&&c instanceof HTMLImageElement){d=c.width;f=c.height;"esriPMS"===a.type&&(d=Math.round(C(c.width,a.width)),
f=Math.round(d/c.width*c.height));const {size:m,sdf:z,image:A}=this._rasterizer.rasterizeImageResource(d,f,c,a.colorSubstitutions);return this._addItemToMosaic(b,m,{type:"static",data:A},q(a),z,!1)}}return new l("mapview-invalid-resource","Could not handle resource!")};g._handleImage=async function(a,b,c){var d;(d=a.url&&-1!==a.url.indexOf(".gif")||a.contentType&&"image/gif"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/gif"))||(d=a.url&&-1!==a.url.indexOf(".png")||a.contentType&&
"image/png"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/png"));if(d)return this._handleGIFOrPNG(a,b,c);d=a.imageData?`data:${a.contentType};base64,${a.imageData}`:a.url;try{const {data:f}=await v(d,{responseType:"image",...c});-1!==d.indexOf("data:image/svg+xml")&&(f.width=u.pt2px(a.width),f.height=u.pt2px(a.height));let h=f.width,k=f.height;"esriPMS"===a.type&&(h=Math.round(C(f.width,a.width)),k=Math.round(h/f.width*f.height));const {size:m,sdf:z,image:A}=this._rasterizer.rasterizeImageResource(h,
k,f,a.colorSubstitutions);return this._addItemToMosaic(b,m,{type:"static",data:A},q(a),z,!1)}catch(f){if(!t.isAbortError(f))return new l("mapview-invalid-resource",`Could not fetch requested resource at ${d}`)}};g._addItemToMosaic=function(a,b,c,d,f,h){return this._spriteMosaic.addSpriteItem(a,b,c,d,f,h)};E._createClass(e,[{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}}]);return e}()});