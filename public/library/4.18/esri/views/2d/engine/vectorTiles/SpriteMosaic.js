// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../webgl/Program ../../../webgl/BufferObject ../../../webgl/Texture ../../../webgl/VertexArrayObject ../../../webgl/Renderbuffer ../../../webgl/FramebufferObject ../../../webgl/ProgramCache ../../../webgl/RenderingContext ../../../webgl/ShaderCompiler ../webgl/Rect ./RectangleBinPack".split(" "),function(v,w,t,x,y,z,A,B,C,u,r){return function(){function m(b,c,a=0){this._size=[];this._mosaicsData=[];this._textures=[];this._dirties=[];this._pageHeight=this._pageWidth=this._currentPage=
this._maxItemSize=0;this._mosaicRects={};this.pixelRatio=1;(0>=b||0>=c)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");this._pageWidth=b;this._pageHeight=c;0<a&&(this._maxItemSize=a);this._binPack=new r(b-4,c-4)}var g=m.prototype;g.getWidth=function(b){return b>=this._size.length?-1:this._size[b][0]};g.getHeight=function(b){return b>=this._size.length?-1:this._size[b][1]};g.setSpriteSource=function(b){this.dispose();this.pixelRatio=b.devicePixelRatio;if(0===
this._mosaicsData.length){this._binPack=new r(this._pageWidth-4,this._pageHeight-4);const c=new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight));this._mosaicsData[0]=c;this._dirties.push(!0);this._size.push([this._pageWidth,this._pageHeight]);this._textures.push(void 0)}this._sprites=b};g.getSpriteItem=function(b,c=!1){var a=this._mosaicRects[b];if(a)return a;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;a=this._sprites.getSpriteInfo(b);if(!a||!a.width||!a.height||
0>a.width||0>a.height)return null;const d=a.width,h=a.height,[f,e,k]=this._allocateImage(d,h);if(0>=f.width)return null;this._copy(f,a,e,k,c);a={rect:f,width:d,height:h,sdf:a.sdf,simplePattern:!1,pixelRatio:a.pixelRatio,page:e};return this._mosaicRects[b]=a};g.preloadSpriteItems=function(){for(const b of this._sprites.spriteNames)this.getSpriteItem(b,!0)};g.getSpriteItems=function(b){const c={};for(const a of b)c[a]=this.getSpriteItem(a);return c};g.getMosaicItemPosition=function(b,c){c=(b=this.getSpriteItem(b,
c))&&b.rect;if(!c)return null;c.width=b.width;c.height=b.height;const a=this._size[b.page];return{size:[b.width,b.height],tl:[(c.x+2)/a[0],(c.y+2)/a[1]],br:[(c.x+2+b.width)/a[0],(c.y+2+b.height)/a[1]],page:b.page}};g.bind=function(b,c,a=0,d=0){this._textures[a]||(this._textures[a]=new t(b,{pixelFormat:6408,dataType:5121,wrapMode:33071,width:this._size[a][0],height:this._size[a][1]},new Uint8Array(this._mosaicsData[a].buffer)));const h=this._textures[a];h.setSamplingMode(c);this._dirties[a]&&h.setData(new Uint8Array(this._mosaicsData[a].buffer));
b.bindTexture(h,d);this._dirties[a]=!1};m._copyBits=function(b,c,a,d,h,f,e,k,n,p,l){let q=d*c+a;e=k*f+e;if(l)for(e-=f,l=-1;l<=p;l++,q=((l+p)%p+d)*c+a,e+=f)for(k=-1;k<=n;k++)h[e+k]=b[q+(k+n)%n];else for(a=0;a<p;a++){for(d=0;d<n;d++)h[e+d]=b[q+d];q+=c;e+=f}};g._copy=function(b,c,a,d,h,f){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(a>=this._mosaicsData.length)){var e=new Uint32Array(f?f.buffer:this._sprites.image.buffer),k=this._mosaicsData[a];k&&e||console.error("Source or target images are uninitialized!");
m._copyBits(e,f?c.width:this._sprites.width,c.x,c.y,k,d[0],b.x+2,b.y+2,c.width,c.height,h);this._dirties[a]=!0}};g._allocateImage=function(b,c){b+=2;c+=2;var a=Math.max(b,c);if(this._maxItemSize&&this._maxItemSize<a)return a=new u(0,0,b,c),this._mosaicsData.push(new Uint32Array(b*c)),this._dirties.push(!0),this._size.push([b,c]),this._textures.push(void 0),[a,this._mosaicsData.length-1,[b,c]];a=b%4?4-b%4:4;let d=c%4?4-c%4:4;1===a&&(a=5);1===d&&(d=5);a=this._binPack.allocate(b+a,c+d);return 0>=a.width?
(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new r(this._pageWidth-4,this._pageHeight-4),this._allocateImage(b,c)):[a,this._currentPage,[this._pageWidth,this._pageHeight]]};g.dispose=function(){this._binPack=null;this._mosaicRects={};
for(const b of this._textures)b&&b.dispose();this._textures.length=0};return m}()});