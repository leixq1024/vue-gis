// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/PerformanceSampler ../../core/PooledArray ../../core/promiseUtils ../../core/Accessor ../../core/watchUtils ../../layers/support/PromiseQueue ./debugFlags".split(" "),
function(e,q,x,y,z,G,P,H,Q,I,R,S,T,A,t,B,J,K,L,M){function u(d){return d in v?v[d]:"number"===typeof d?d:1}const N=G.getLogger("esri.views.support.Scheduler");(function(d){d.REMOTE_CLIENT="remote client";d.STREAM_DATA_LOADER="stream loader";d.ELEVATION_QUERY="elevation query";d.TERRAIN_SURFACE="terrain surface";d.SURFACE_GEOMETRY_UPDATES="surface geometry updates";d.GRAPHICS_CORE="Graphics3D";d.I3S_CONTROLLER="I3S";d.POINT_CLOUD_LAYER="point cloud";d.FEATURE_TILE_FETCHER="feature fetcher";d.FEATURE_FETCH_QUEUE=
"feature fetch queue";d.LABELER="labeler";d.GRAPHICS_DECONFLICTOR="graphics deconflictor";d.FILTER_VISIBILITY="Graphics3D filter visibility";d.FEATURE_QUERY_ENGINE="feature query";d.SCALE_VISIBILITY="Graphics3D scale visibility";d.FRUSTUM_VISIBILITY="Graphics3D frustum visibility";d.POINT_OF_INTEREST_FREQUENT="POI frequent";d.POINT_OF_INTEREST_INFREQUENT="POI infrequent";d.FEATURE_TILE_TREE="feature tile tree";d.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree";d.ELEVATION_ALIGNMENT="elevation alignment";
d.TEXT_TEXTURE_ATLAS="text texture atlas";d.TEXTURE_UNLOAD="texture unload";d.OVERLAY_MANAGER="overlay manager";d.LINE_OF_SIGHT_TOOL="line of sight tool";d.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool";d.ELEVATION_PROFILE="elevation profile";d[d.TEST_PRIO=1]="TEST_PRIO"})(e.Task||(e.Task={}));const v={[e.Task.REMOTE_CLIENT]:1,[e.Task.STREAM_DATA_LOADER]:1,[e.Task.FEATURE_FETCH_QUEUE]:1,[e.Task.ELEVATION_QUERY]:1,[e.Task.TERRAIN_SURFACE]:2,[e.Task.SURFACE_GEOMETRY_UPDATES]:2,[e.Task.GRAPHICS_CORE]:3,
[e.Task.I3S_CONTROLLER]:4,[e.Task.POINT_CLOUD_LAYER]:4,[e.Task.FEATURE_TILE_FETCHER]:4,[e.Task.LABELER]:8,[e.Task.GRAPHICS_DECONFLICTOR]:8,[e.Task.FILTER_VISIBILITY]:8,[e.Task.FEATURE_QUERY_ENGINE]:8,[e.Task.SCALE_VISIBILITY]:8,[e.Task.FRUSTUM_VISIBILITY]:8,[e.Task.POINT_OF_INTEREST_FREQUENT]:6,[e.Task.POINT_OF_INTEREST_INFREQUENT]:30,[e.Task.FEATURE_TILE_TREE]:16,[e.Task.FEATURE_TILE_TREE_ACTIVE]:1,[e.Task.ELEVATION_ALIGNMENT]:12,[e.Task.TEXT_TEXTURE_ATLAS]:12,[e.Task.TEXTURE_UNLOAD]:12,[e.Task.OVERLAY_MANAGER]:12,
[e.Task.LINE_OF_SIGHT_TOOL]:16,[e.Task.LINE_OF_SIGHT_TOOL_INTERACTIVE]:1},C=1E3/30;var r;(function(d){let p=function(){function k(b){this._now=b;this.updating=!0;this.performanceInfo={total:new A("total"),tasks:[]};this._budget=null;this._state=1;this._tasks=new t;this._runQueue=new t;this._load=0;this._idleStateCallbacks=new t;this._idleUpdatesStartFired=!1;this._maxReschedule=w;this._forceTask=!1;this._safetyBudget=0;this._debug=!1;this._debugHandle=K.init(M,"SCHEDULER_LOG_SLOW_TASKS",g=>this._debug=
g);this._budget=new D(b);m.length=0;for(const g in e.Task)E.set(e.Task[g],this.performanceInfo.tasks.length),this.performanceInfo.tasks.push(new A(e.Task[g])),m.push(0);let a;const c=this;this._test={get state(){return z.isNone(a)?c._state:a},set state(g){a=g},FRAME_SAFETY_BUDGET:5,INTERACTING_BUDGET:C,IDLE_BUDGET:100,get budget(){return c._budget.budget},usedBudget:0,updateTask:g=>this._updateTask(g),getState:g=>this._getState(g),getRuntime:g=>this._getRuntime(g),resetRuntimes:()=>this._resetRuntimes(),
getRunning:()=>this._getRunning()}}var f=k.prototype;f.destroy=function(){this._debugHandle&&this._debugHandle.remove()};f.registerTask=function(b,a,c){const g=u(b);b=new l(this,b,a,c,g);this._tasks.push(b);return b};f.registerIdleStateCallbacks=function(b,a){const c={idleBegin:b,idleEnd:a};this._idleStateCallbacks.push(c);2===this.state&&this._idleUpdatesStartFired&&c.idleBegin();const g=this;return{remove:()=>this._removeIdleStateCallbacks(c),set idleBegin(n){g._idleUpdatesStartFired&&(c.idleEnd(),
2===g._state&&n());c.idleBegin=n},set idleEnd(n){c.idleEnd=n}}};f.updateBudget=function(b){this._test.usedBudget=0;this._safetyBudget=5;let a=b.frameDuration,c=1;switch(this.state){case 2:this._safetyBudget=0;a=Math.max(100,b.frameDuration);c=30;break;case 1:a=Math.max(C,b.frameDuration)}a-=b.elapsedFrameTime+this._safetyBudget;if(2!==this.state&&0>a&&!this._forceTask)return this._forceTask=!0,!1;a=Math.max(a,c);this._budget.reset(a,this.state);this._maxReschedule=w;this._updateLoad();return this._schedule()};
f.frame=function(){this._forceTask=!1;switch(this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(b=>b.idleBegin()));this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed};f._removeIdleStateCallbacks=function(b){this._idleUpdatesStartFired&&b.idleEnd();this._idleStateCallbacks.removeUnordered(b)};f.removeTask=function(b){this._tasks.removeUnordered(b);this._runQueue.removeUnordered(b)};
f._updateTask=function(b){this._tasks.forAll(a=>{a.name===b&&a.setPriority(b)})};f._getState=function(b){if(this._runQueue.some(c=>c.name===b))return e.TaskState.SCHEDULED;let a=e.TaskState.IDLE;this._tasks.forAll(c=>{c.name===b&&c.needsUpdate&&(1>=c.schedulePriority?a=e.TaskState.READY:a!==e.TaskState.READY&&(a=e.TaskState.WAITING))});return a};f._getRuntime=function(b){let a=0;this._tasks.forAll(c=>{c.name===b&&(a+=c.runtime)});return a};f._resetRuntimes=function(){this._tasks.forAll(b=>b.runtime=
0)};f._getRunning=function(){const b=new Map;this._tasks.forAll(c=>{c.needsUpdate&&b.set(c.name,(b.get(c.name)||0)+1)});if(0===b.size)return null;let a="";b.forEach((c,g)=>{a=1<c?a+` ${c}x ${g}`:a+` ${g}`});return a};f._runIdle=function(){this._run()};f._runInteracting=function(){this._run()};f._runAnimating=function(){this._run()};f._updateLoad=function(){const b=this._tasks.reduce((a,c)=>c.needsUpdate?++a:a,0);this._load=.9*this._load+b*(1-.9)};f._schedule=function(){if(0>=this._maxReschedule)return!1;
for(this._runQueue.filterInPlace(b=>{if(b.needsUpdate)return!0;b.schedulePriority=b.priority;return!1});0===this._runQueue.length;){let b=!1,a=0;this._tasks.forAll(c=>{if(0!==c.schedulePriority&&c.needsUpdate)switch(b=!0,a=Math.max(a,c.priority),c.schedulePriority){case 1:c.schedulePriority=0;this._runQueue.push(c);break;default:--c.schedulePriority}});if(!b)return this.updating=!1;this._maxReschedule===w&&(this._maxReschedule=a);--this._maxReschedule}return this.updating=!0};f._run=function(){const b=
this._budget.now();for(var a=0;a<m.length;++a)m[a]=0;do for(;0<this._runQueue.length;){var c=this._budget.now();a=this._runQueue.pop();this._budget.resetProgress();try{a.processQueue(this._budget),!this._budget.done&&a.needsUpdate&&a.update(this._budget)}catch(g){N.error(`Exception in task "${a.name}"`,g)}a.schedulePriority=a.priority;c=this._budget.now()-c;a.runtime+=c;m[E.get(a.task)]+=c;this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",a.name,"used",this._budget.elapsed,
"of max",this._budget.budget,"ms");if(0>=this._budget.remaining){this._recordFrameTaskTimes(m,this._budget.now()-b);return}}while(this._schedule());this._recordFrameTaskTimes(m,this._budget.now()-b)};f._recordFrameTaskTimes=function(b,a){for(let c=0;c<b.length;++c)this.performanceInfo.tasks[c].record(b[c]);this.performanceInfo.total.record(a)};q._createClass(k,[{key:"now",get:function(){return this._now()}},{key:"load",get:function(){return this._load}},{key:"state",set:function(b){this._state!==
b&&(this._state=b,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(a=>a.idleEnd())))},get:function(){return z.isNone(this._test.state)?this._state:this._test.state}},{key:"test",get:function(){return this._test}}]);return k}();d.Scheduler=p;let l=function(k){function f(a,c,g,n,O){var h=k.call(this,{})||this;h._scheduler=a;h.name=c;h.update=g;h._needsUpdateCB=n;h._priority=O;h.runtime=0;h._queue=new L;h.updating=!1;h.schedulePriority=h._priority;
return h}q._inheritsLoose(f,k);var b=f.prototype;b.normalizeCtorArgs=function(){return{}};b.remove=function(){this.processQueue(F);this._scheduler.removeTask(this)};b.setPriority=function(a){this.name=a;this._priority=u(a);0!==this.schedulePriority&&(this.schedulePriority=this._priority)};b.schedule=function(a,c){this.updating=!0;return this._queue.push(a,c)};b.reschedule=function(a,c){this.updating=!0;return this._queue.unshift(a,c)};b.processQueue=function(a){for(;!a.done&&this._queue.process();)a.madeProgress();
0===this._queue.length&&(this.updating=!1)};q._createClass(f,[{key:"priority",get:function(){return this._priority}},{key:"task",get:function(){return this.name},set:function(a){this.setPriority(a)}},{key:"needsUpdate",get:function(){return 0<this._queue.length||this._needsUpdateCB()}}]);return f}(J);x.__decorate([H.property()],l.prototype,"updating",void 0);l=x.__decorate([I.subclass("esri.views.support.SchedulerTask")],l);let D=function(){function k(b){this.now=b;this._budget=this._begin=0;this._state=
2;this._didWork=!1;this._enabled=!0}var f=k.prototype;f.run=function(b){if(this.done)return!1;!0===b()&&(this._didWork=!0);return!0};f.madeProgress=function(){this._didWork=!0};f.reset=function(b,a){this._begin=this.now();this._budget=b;this._state=a;this._didWork=!1};f.resetProgress=function(){this._didWork=!1};q._createClass(k,[{key:"done",get:function(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}},{key:"budget",get:function(){return this._budget}},{key:"state",get:function(){return this._state}},
{key:"enabled",get:function(){return this._enabled},set:function(b){this._enabled=b}},{key:"remaining",get:function(){return Math.max(this._budget-this.elapsed,0)}},{key:"elapsed",get:function(){return this.now()-this._begin}},{key:"hasProgressed",get:function(){return this._didWork}}]);return k}();d.Budget=D})(r||(r={}));(function(d){d.SCHEDULED="s";d.READY="r";d.WAITING="w";d.IDLE="i"})(e.TaskState||(e.TaskState={}));const F=(()=>{const d=new r.Budget(()=>performance.now());d.enabled=!1;return d})();
y=new (function(){function d(){}var p=d.prototype;p.remove=function(){};p.schedule=function(l){return B.when(l())};p.reschedule=function(l){return B.when(l())};return d}());const w=Number.MAX_SAFE_INTEGER,E=new Map,m=[];e.ImmediateTask=y;e.getTaskPriority=u;e.newScheduler=function(d){return new r.Scheduler(d)};e.noBudget=F;e.taskPriorities=v;Object.defineProperty(e,"__esModule",{value:!0})});