// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../core/maybe ../../core/promiseUtils ../../core/scheduling ../../core/Queue".split(" "),function(n,q,k,g,r,t){let u=function(h,b){this.item=h;this.controller=b;this.promise=null},w=function(){function h(a){this._deferreds=new Map;this._controllers=new Map;this._processingItems=new Map;this._isPaused=!1;this._task=this._schedule=null;this.concurrency=1;a.concurrency&&(this.concurrency=a.concurrency);this._queue=new t(a.peeker);this.process=
a.process;const c=a.scheduler;a.task&&k.isSome(c)&&(this._task=c.registerTask(a.task,d=>this.update(d),()=>this.needsUpdate()))}var b=h.prototype;b.destroy=function(){this.clear();this._schedule&&(this._schedule.remove(),this._schedule=null);this._task&&(this._task.remove(),this._task=null)};b.abort=function(a){(a=this._controllers.get(a))&&a.abort()};b.clear=function(){this._queue.clear();const a=[];this._controllers.forEach(c=>a.push(c));this._controllers.clear();a.forEach(c=>c.abort());this._processingItems.clear();
this._cancelNext()};b.forEach=function(a){this._deferreds.forEach((c,d)=>a(d))};b.get=function(a){return(a=this._deferreds.get(a))?a.promise:void 0};b.isOngoing=function(a){return this._processingItems.has(a)};b.has=function(a){return this._deferreds.has(a)};b.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())};b.push=function(a,c){const d=this.get(a);if(d)return d;let e;const f=g.createAbortController();let l=null;c&&(l=g.onAbort(c,()=>f.abort()));const m=()=>{v.remove();k.isSome(l)&&
l.remove();this._deferreds.delete(a);this._controllers.delete(a);this._queue.remove(a);this._processingItems.delete(a);this._scheduleNext()},v=g.onAbortOrThrow(f.signal,()=>{const p=this._processingItems.get(a);p&&p.controller.abort();m();e.reject(g.createAbortError())});e=g.createDeferred();this._deferreds.set(a,e);this._controllers.set(a,f);e.promise.then(m,m);this._queue.push(a);this._scheduleNext();return e.promise};b.reset=function(){const a=[];this._processingItems.forEach(c=>a.push(c));this._processingItems.clear();
for(const c of a)this._queue.push(c.item),c.controller.abort();this._scheduleNext()};b.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())};b.takeAll=function(){const a=[];for(;this._queue.length;)a.push(this._queue.pop());this.clear();return a};b.needsUpdate=function(){return!this._isPaused&&0<this._queue.length&&this._processingItems.size<this.concurrency};b.update=function(a){for(;!a.done&&0<this._queue.length&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),
a.madeProgress()};b._scheduleNext=function(){this._task||this._isPaused||this._schedule||(this._schedule=r.schedule(()=>{this._schedule=null;this._next()}))};b._next=function(){for(;0<this._queue.length&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())};b._cancelNext=function(){this._schedule&&(this._schedule.remove(),this._schedule=null)};b._processResult=function(a,c){this._canProcessFulfillment(a)&&(this._scheduleNext(),this._deferreds.get(a.item).resolve(c))};b._processError=
function(a,c){this._canProcessFulfillment(a)&&(this._scheduleNext(),this._deferreds.get(a.item).reject(c))};b._canProcessFulfillment=function(a){return this._deferreds.get(a.item)&&this._processingItems.get(a.item)===a?!0:!1};b._process=function(a){if(!k.isNone(a)){var c=g.createAbortController(),d=new u(a,c);this._processingItems.set(a,d);try{var e=this.process(a,c.signal)}catch(f){this._processError(d,f)}e&&"function"===typeof e.then?(d.promise=e,e.then(f=>this._processResult(d,f),f=>this._processError(d,
f))):this._processResult(d,e)}};q._createClass(h,[{key:"length",get:function(){return this._processingItems.size+this._queue.length}},{key:"test",get:function(){return{update:a=>this.update(a)}}}]);return h}();n.QueueProcessor=w;Object.defineProperty(n,"__esModule",{value:!0})});