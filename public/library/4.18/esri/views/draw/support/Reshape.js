// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../geometry/Point ../../../geometry/support/coordsUtils ../../../geometry ../../../core/Evented ../../../symbols/SimpleMarkerSymbol ../../../Graphic ../../../core/Handles ../../../core/watchUtils ../../input/InputManager ./drawUtils ./layerUtils ./GraphicMover ./settings".split(" "),
function(H,u,r,A,da,ea,v,fa,J,ha,ia,ja,C,E,ka,t,y,z,I,D,K,L,M,N,O){let P=function(m,p,d){this.graphic=m;this.mover=p;this.selected=d;this.type="reshape-start"},Q=function(m,p,d){this.graphic=m;this.mover=p;this.selected=d;this.type="reshape"},R=function(m,p,d){this.graphic=m;this.mover=p;this.selected=d;this.type="reshape-stop"},S=function(m,p,d){this.mover=m;this.dx=p;this.dy=d;this.type="move-start"},T=function(m,p,d){this.mover=m;this.dx=p;this.dy=d;this.type="move"},U=function(m,p,d){this.mover=
m;this.dx=p;this.dy=d;this.type="move-stop"},V=function(m){this.added=m;this.type="vertex-select"},W=function(m){this.removed=m;this.type="vertex-deselect"},X=function(m,p,d,a){this.added=m;this.graphic=p;this.oldGraphic=d;this.vertices=a;this.type="vertex-add"},Y=function(m,p,d,a){this.removed=m;this.graphic=p;this.oldGraphic=d;this.vertices=a;this.type="vertex-remove"};var Z=["Backspace","Delete"];r=O.settings.reshapeGraphics;const F={vertices:{default:new y({style:"circle",size:r.vertex.size,color:r.vertex.color,
outline:{color:r.vertex.outlineColor,width:1}}),hover:new y({style:"circle",size:r.vertex.hoverSize,color:r.vertex.hoverColor,outline:{color:r.vertex.hoverOutlineColor,width:1}}),selected:new y({style:"circle",size:r.selected.size,color:r.selected.color,outline:{color:r.selected.outlineColor,width:1}})},midpoints:{default:new y({style:"circle",size:r.midpoint.size,color:r.midpoint.color,outline:{color:r.midpoint.outlineColor,width:1}}),hover:new y({style:"circle",size:r.midpoint.size,color:r.midpoint.color,
outline:{color:r.midpoint.outlineColor,width:1}})}};t=function(m){function p(a){a=m.call(this,a)||this;a._handles=new I;a._graphicAttributes={esriSketchTool:"box"};a._mover=null;a._viewHandles=new I;a._totalDx=0;a._totalDy=0;a.callbacks={onReshapeStart(){},onReshape(){},onReshapeStop(){},onMoveStart(){},onMove(){},onMoveStop(){},onGraphicClick(){}};a.enableMidpoints=!0;a.graphic=null;a.handleGraphics=[];a.layer=null;a.midpointGraphics=[];a.midpointSymbol=new y({style:"circle",size:6,color:[200,200,
200],outline:{color:[100,100,100],width:1}});a.selectedHandles=[];a.type="reshape";a.view=null;return a}H._inheritsLoose(p,m);var d=p.prototype;d.initialize=function(){this._setup();this._handles.add([D.whenOnce(this,"view.ready",()=>{const {layer:a,view:b}=this;M.addUniqueLayer(b,a);this._viewHandles.add([b.on("key-down",c=>this._keyDownHandler(c),K.ViewEventPriorities.TOOL)])}),D.pausable(this,"graphic",()=>this.refresh()),D.pausable(this,"layer",(a,b)=>{b&&(this._clearSelection(),this._resetGraphics(b));
this.refresh()}),D.pausable(this,"enableMidpoints",()=>{this.refresh()})])};d.destroy=function(){this._reset();this._mover&&this._mover.destroy();this._mover=null;this._handles.removeAll();this._handles=null;this._viewHandles.removeAll();this._viewHandles=null};d.isUIGraphic=function(a){const b=[];this.graphic&&b.push(this.graphic);b.concat(this.handleGraphics,this.midpointGraphics);return b.length&&b.includes(a)};d.refresh=function(){this._reset();this._setup()};d.reset=function(){this.graphic=null};
d.clearSelection=function(){this._clearSelection()};d.removeSelectedHandles=function(){this.selectedHandles.length&&this._removeVertex(this.selectedHandles)};d._setup=function(){this.graphic&&this.layer&&(this._setupGraphics(),this._setupMover())};d._reset=function(){this._clearSelection();this._resetGraphicStateVars();this._resetGraphics();this._mover&&this._mover.destroy();this._mover=null;this.view.cursor="default"};d._resetGraphicStateVars=function(){this._totalDy=this._totalDx=0};d._resetGraphics=
function(a){if(a=a||this.layer)a.removeMany(this.handleGraphics),a.removeMany(this.midpointGraphics);this.handleGraphics.forEach(b=>b.destroy());this.midpointGraphics.forEach(b=>b.destroy());this._set("handleGraphics",[]);this._set("midpointGraphics",[]);this._set("selectedHandles",[])};d._setupGraphics=function(){var a=A.unwrap(this.graphic.geometry);const b=E.geometryToCoordinates(a.clone());if("polygon"===a.type)for(const c of b)a=c[c.length-1],c[0][0]===a[0]&&c[0][1]===a[1]&&2<c.length&&c.pop();
this._set("handleGraphics",this._createHandleGraphics(b));this.enableMidpoints&&this._set("midpointGraphics",this._createMidpointGraphics(b));this._saveRelatedIndices(this.handleGraphics);this.layer.addMany(this.midpointGraphics);this.layer.addMany(this.handleGraphics)};d._createHandleGraphics=function(a){const {_graphicAttributes:b,symbols:c,view:{spatialReference:f}}=this,e=[];null==a?void 0:a.forEach((h,q)=>{h.forEach((n,k)=>{var g;const [l,w]=n;e.push(new z({geometry:new C({x:l,y:w,spatialReference:f}),
symbol:null==c?void 0:null==(g=c.vertices)?void 0:g.default,attributes:{...b,pathIndex:q,pointIndex:k}}))})});return e};d._createMidpointGraphics=function(a){const {_graphicAttributes:b,symbols:c,view:{spatialReference:f}}=this,e=[];null==a?void 0:a.forEach((h,q)=>{h.forEach((n,k)=>{const [g,l]=n;n=h[k+1]?k+1:0;if("polygon"===A.get(this.graphic.geometry,"type")||0!==n){const [w,x]=h[n],[B,G]=E.getMidpoint([g,l],[w,x]);e.push(new z({geometry:new C({x:B,y:G,spatialReference:f}),symbol:c.midpoints.default,
attributes:{...b,pathIndex:q,pointIndexStart:k,pointIndexEnd:n}}))}})});return e};d._saveRelatedIndices=function(a){if(a){var b=a.map(({geometry:c})=>({x:c.x,y:c.y}));for(let c=0;c<b.length;c++){const f=[];for(let e=0;e<b.length;e++){if(c===e)continue;const h=b[c],q=b[e];h.x===q.x&&h.y===q.y&&f.push(e)}a[c].attributes.relatedGraphicIndices=f}}};d._setupMover=function(){this._mover=new N({enableMoveAllGraphics:!1,graphics:[].concat(this.handleGraphics,this.midpointGraphics,this.graphic),view:this.view,
callbacks:{onGraphicClick:a=>this._onGraphicClickCallback(a),onGraphicMoveStart:a=>this._onGraphicMoveStartCallback(a),onGraphicMove:a=>this._onGraphicMoveCallback(a),onGraphicMoveStop:a=>this._onGraphicMoveStopCallback(a),onGraphicPointerOver:a=>this._onGraphicPointerOverCallback(a),onGraphicPointerOut:a=>this._onGraphicPointerOutCallback(a)}})};d._onGraphicClickCallback=function(a){a.viewEvent.stopPropagation();const b=a.graphic;if(b===this.graphic){if(this.clearSelection(),this.emit("graphic-click",
a),this.callbacks.onGraphicClick)this.callbacks.onGraphicClick(a)}else if(this._isMidpoint(b)){if(2!==a.viewEvent.button){a=this.graphic.clone();var c=this._createHandleFromMidpoint(b);this.refresh();this._emitVertexAddEvent([b],a,c)}}else this._isHandle(b)&&(a.viewEvent.stopPropagation(),2===a.viewEvent.button?this._removeVertex(b):(a.viewEvent.native.shiftKey||this._clearSelection(),this.selectedHandles.includes(b)?this._removeFromSelection(b,!0):this._addToSelection(b)))};d._onGraphicMoveStartCallback=
function(a){const b=a.graphic;this._resetGraphicStateVars();if(b===this.graphic){const {dx:c,dy:f}=a;this.handleGraphics.forEach(e=>e.visible=!1);this.midpointGraphics.forEach(e=>e.visible=!1);this._clearSelection();this._emitMoveStartEvent(c,f)}else{if(this._isMidpoint(b)){this._clearSelection();a=this.graphic.clone();const c=this._createHandleFromMidpoint(b);this._emitVertexAddEvent([b],a,c);this._addToSelection(b)}else this.selectedHandles.includes(b)||(this._clearSelection(),this._addToSelection(b));
this._emitReshapeStartEvent(b)}};d._onGraphicMoveCallback=function(a){const {graphic:b,dx:c,dy:f}=a;this._totalDx+=c;this._totalDy+=f;b===this.graphic?this._emitMoveEvent(c,f):(this._syncGeometryAfterHandleMove(b,c,f),this._emitReshapeEvent(b))};d._onGraphicMoveStopCallback=function(a){const {graphic:b,dx:c,dy:f}=a;this._totalDx+=c;this._totalDy+=f;if(b===this.graphic){for(const e of[].concat(this.handleGraphics,this.midpointGraphics))e.visible=!0;this._syncGraphicsWithGeometry();this._emitMoveStopEvent()}else this._syncGeometryAfterHandleMove(b,
c,f),this._isMidpoint(b)&&this.refresh(),this._emitReshapeStopEvent(b);this._resetGraphicStateVars()};d._syncGraphicsWithGeometry=function(){var a=this.graphic.geometry;a="polyline"===a.type?a.paths:a.rings;this._updateHandleGraphicLocations(a);this._updateMidpointGraphicLocations(a)};d._updateHandleGraphicLocations=function(a){for(const b of this.handleGraphics){const {pathIndex:c,pointIndex:f}=b.attributes,[e,h]=a[c][f];b.set("geometry",new C(e,h,this.view.spatialReference))}};d._updateMidpointGraphicLocations=
function(a){for(const b of this.midpointGraphics){const {pathIndex:c,pointIndexStart:f,pointIndexEnd:e}=b.attributes,[h,q]=a[c][f],[n,k]=a[c][e],[g,l]=E.getMidpoint([h,q],[n,k]);b.geometry=new C({x:g,y:l,spatialReference:this.view.spatialReference})}};d._syncGeometryAfterHandleMove=function(a,b,c){const f=A.unwrap(this.graphic.geometry).clone(),e="polyline"===f.type?f.paths:f.rings,{pathIndex:h,pointIndex:q}=a.attributes,{x:n,y:k}=a.geometry;var g=e[h].length-1;e[h][q]=[n,k];"polygon"===f.type&&(0===
q?e[h][g]=[n,k]:q===g&&(e[h][0]=[n,k]));if(this._isHandle(a)){({relatedGraphicIndices:g}=a.attributes);for(var l of g){g=this.handleGraphics[l];const {pathIndex:w,pointIndex:x}=g.attributes;e[w][x]=[n,k];g.geometry=a.geometry}for(const w of this.selectedHandles)if(w!==a){const {pathIndex:x,pointIndex:B,relatedGraphicIndices:G}=w.attributes;l=L.cloneMove(w.geometry,b,c,this.view);g=e[x].length-1;e[x][B]=[l.x,l.y];w.geometry=l;"polygon"===f.type&&(0===B?e[x][g]=[l.x,l.y]:B===g&&(e[x][0]=[l.x,l.y]));
for(const aa of G){g=this.handleGraphics[aa];const {pathIndex:ba,pointIndex:ca}=g.attributes;e[ba][ca]=[l.x,l.y];g.geometry=l}}this._updateMidpointGraphicLocations(e)}this.graphic.geometry=f};d._onGraphicPointerOverCallback=function(a){a=a.graphic;this._isHandle(a)&&!this._isSelected(a)&&(a.symbol=this.symbols.vertices.hover);this._updateHoverCursor(a)};d._onGraphicPointerOutCallback=function(a){a=a.graphic;this._isHandle(a)&&!this._isSelected(a)&&(a.symbol=this.symbols.vertices.default);this.view.cursor=
"default"};d._createHandleFromMidpoint=function(a){const {_graphicAttributes:b}=this,c=[],f=A.unwrap(this.graphic.geometry).clone(),{pathIndex:e,pointIndexStart:h,pointIndexEnd:q}=a.attributes,{x:n,y:k}=a.geometry,g=0===q?h+1:q,l="polyline"===f.type?f.paths:f.rings;l[e].splice(g,0,[n,k]);a.attributes={...b,pathIndex:e,pointIndex:g,relatedGraphicIndices:[]};c.push({coordinates:l[e][g],componentIndex:e,vertexIndex:g});this.graphic.geometry=f;return c};d._removeHandles=function(a){const b=A.unwrap(this.graphic.geometry).clone(),
c="polygon"===b.type?b.rings:b.paths,f=[];a instanceof z&&(a=[a]);for(const e of a){const {x:h,y:q}=e.geometry;for(a=0;a<c.length;a++){const n=c[a];for(let k=0;k<n.length;k++){const [g,l]=n[k];h===g&&q===l&&(f.push({coordinates:c[a][k],componentIndex:a,vertexIndex:k}),c[a].splice(Number(k),1))}}}if("polygon"===b.type)for(const e of c){const [h,q]=e[0],[n,k]=e[e.length-1];(1===e.length||3>e.length&&h===n&&q===k)&&c.splice(c.indexOf(e),1);2<e.length&&(h!==n||q!==k)&&e.push(e[0])}else for(const e of c)1===
e.length&&c.splice(c.indexOf(e),1);this.graphic.geometry=b;return f};d._addToSelection=function(a){a instanceof z&&(a=[a]);for(const b of a)b.symbol=this.symbols.vertices.selected;this._set("selectedHandles",this.selectedHandles.concat(a));this._emitSelectEvent(a)};d._removeFromSelection=function(a,b){const {vertices:c}=this.symbols;b=b?c.hover:c.default;a instanceof z&&(a=[a]);for(const f of a)this.selectedHandles.splice(this.selectedHandles.indexOf(f),1),this._set("selectedHandles",this.selectedHandles),
f.set("symbol",b);this._emitDeselectEvent(a)};d._clearSelection=function(){if(this.selectedHandles.length){const a=this.selectedHandles;for(const b of this.selectedHandles)b.set("symbol",this.symbols.vertices.default);this._set("selectedHandles",[]);this._emitDeselectEvent(a)}};d._keyDownHandler=function(a){Z.includes(a.key)&&!a.repeat&&this.selectedHandles.length&&this._removeVertex(this.selectedHandles)};d._removeVertex=function(a){if(!("polygon"===this.graphic.geometry.type&&4>this.handleGraphics.length||
3>this.handleGraphics.length)){var b=this.graphic.clone();a instanceof z&&(a=[a]);var c=this._removeHandles(a);this.refresh();this._emitVertexRemoveEvent(a,b,c)}};d._isHandle=function(a){return this.handleGraphics.includes(a)};d._isSelected=function(a){return this._isHandle(a)&&this.selectedHandles.includes(a)};d._isMidpoint=function(a){return this.midpointGraphics.includes(a)};d._updateHoverCursor=function(a){this.view.cursor=this._isMidpoint(a)?"copy":"move"};d._emitMoveStartEvent=function(a,b){a=
new S(this.graphic,a,b);this.emit("move-start",a);if(this.callbacks.onMoveStart)this.callbacks.onMoveStart(a)};d._emitMoveEvent=function(a,b){a=new T(this.graphic,a,b);this.emit("move",a);if(this.callbacks.onMove)this.callbacks.onMove(a)};d._emitMoveStopEvent=function(){const a=new U(this.graphic,this._totalDx,this._totalDy);this.emit("move-stop",a);if(this.callbacks.onMoveStop)this.callbacks.onMoveStop(a)};d._emitReshapeStartEvent=function(a){a=new P(this.graphic,a,this.selectedHandles);this.emit("reshape-start",
a);if(this.callbacks.onReshapeStart)this.callbacks.onReshapeStart(a)};d._emitReshapeEvent=function(a){a=new Q(this.graphic,a,this.selectedHandles);this.emit("reshape",a);if(this.callbacks.onReshape)this.callbacks.onReshape(a)};d._emitReshapeStopEvent=function(a){a=new R(this.graphic,a,this.selectedHandles);this.emit("reshape-stop",a);if(this.callbacks.onReshapeStop)this.callbacks.onReshapeStop(a)};d._emitSelectEvent=function(a){a=new V(a);this.emit("select",a);if(this.callbacks.onVertexSelect)this.callbacks.onVertexSelect(a)};
d._emitDeselectEvent=function(a){a=new W(a);this.emit("deselect",a);if(this.callbacks.onVertexDeselect)this.callbacks.onVertexDeselect(a)};d._emitVertexAddEvent=function(a,b,c){a=new X(a,this.graphic,b,c);this.emit("vertex-add",a);if(this.callbacks.onVertexAdd)this.callbacks.onVertexAdd(a)};d._emitVertexRemoveEvent=function(a,b,c){a=new Y(a,this.graphic,b,c);this.emit("vertex-remove",a);if(this.callbacks.onVertexRemove)this.callbacks.onVertexRemove(a)};H._createClass(p,[{key:"state",get:function(){const a=
!!this.get("view.ready"),b=!(!this.get("graphic")||!this.get("layer"));return a&&b?"active":a?"ready":"disabled"}},{key:"symbols",set:function(a){const {midpoints:b=F.midpoints,vertices:c=F.vertices}=a||{};this._set("symbols",{midpoints:b,vertices:c})}}]);return p}(t.EventedAccessor);u.__decorate([v.property()],t.prototype,"callbacks",void 0);u.__decorate([v.property()],t.prototype,"enableMidpoints",void 0);u.__decorate([v.property()],t.prototype,"graphic",void 0);u.__decorate([v.property({readOnly:!0})],
t.prototype,"handleGraphics",void 0);u.__decorate([v.property()],t.prototype,"layer",void 0);u.__decorate([v.property({readOnly:!0})],t.prototype,"midpointGraphics",void 0);u.__decorate([v.property()],t.prototype,"midpointSymbol",void 0);u.__decorate([v.property({readOnly:!0})],t.prototype,"selectedHandles",void 0);u.__decorate([v.property({dependsOn:["view.ready","graphic","layer"],readOnly:!0})],t.prototype,"state",null);u.__decorate([v.property({value:F})],t.prototype,"symbols",null);u.__decorate([v.property({readOnly:!0})],
t.prototype,"type",void 0);u.__decorate([v.property()],t.prototype,"view",void 0);return t=u.__decorate([J.subclass("esri.views.draw.support.Reshape")],t)});