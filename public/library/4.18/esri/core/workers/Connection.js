// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define(["../../chunks/_rollupPluginBabelHelpers","../Logger","../handleUtils","../promiseUtils","./RemoteClient"],function(p,q,r,g,n){const t=q.getLogger("esri.core.workers.Connection");return function(){function l(){this._clients=[];this._clientPromises=[];this._clientIdx=0}var h=l.prototype;h.destroy=function(){this.close()};h.open=function(a,b){return g.create((c,d)=>{let e=!0;const k=f=>{g.throwIfAborted(b.signal);e&&(e=!1,f())};this._clients.length=a.length;this._clientPromises.length=a.length;
for(let f=0;f<a.length;++f){const m=a[f];g.isThenable(m)?this._clientPromises[f]=m.then(u=>{this._clients[f]=new n(u,b);k(c);return this._clients[f]},()=>{k(d);return null}):(this._clients[f]=new n(m,b),this._clientPromises[f]=g.resolve(this._clients[f]),k(c))}})};h.broadcast=function(a,b,c){const d=Array(this._clientPromises.length);for(let e=0;e<this._clientPromises.length;++e)d[e]=this._clientPromises[e].then(k=>k.invoke(a,b,c));return d};h.close=function(){for(const a of this._clientPromises)a.then(b=>
b.close());this._clients.length=0;this._clientPromises.length=0};h.getAvailableClient=function(){let a;for(let b=0;b<this._clients.length;++b){const c=this._clients[b];if(!c)a=a||[],a.push(this._clientPromises[b]);else if(!c.isBusy())return g.resolve(c)}return a?g.first(a):(this._clientIdx=(this._clientIdx+1)%this._clients.length,g.resolve(this._clients[this._clientIdx]))};h.invoke=function(a,b,c){let d=null;Array.isArray(c)?(t.warn("invoke()","The transferList parameter is deprecated, use the options object instead"),
d={transferList:c}):d=c;return this.closed?g.reject(Error("Connection closed")):this.getAvailableClient().then(e=>e.invoke(a,b,d))};h.on=function(a,b){return g.all(this._clientPromises).then(()=>r.handlesGroup(this._clients.map(c=>c.on(a,b))))};h.openPorts=function(){return g.create(a=>{const b=Array(this._clientPromises.length);let c=b.length;for(let d=0;d<this._clientPromises.length;++d)this._clientPromises[d].then(e=>{b[d]=e.openPort();0===--c&&a(b)})})};p._createClass(l,[{key:"closed",get:function(){return!this._clients||
!this._clients.length}},{key:"test",get:function(){return{numClients:this._clients.length}}}]);return l}()});