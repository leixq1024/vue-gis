// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/global ../core/has ../core/lang ../core/object ../config ../core/string ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/jsonMap ../core/accessorSupport/decorators/subclass ../core/Error ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../core/events ../core/promiseUtils ../core/Evented ../kernel ../request ../core/cookie ./IdentityForm ./IdentityModal ./OAuthCredential ./OAuthInfo ./ServerInfo".split(" "),
function(v,M,A,N,Z,G,H,J,W,aa,ba,C,ca,O,z,x,da,ea,X,D,P,y,F,Q,Y,R,S,T,K){const I={},U=B=>{const E=(new x.Url(B.owningSystemUrl)).host;B=(new x.Url(B.server)).host;const k=/.+\.arcgis\.com$/i;return k.test(E)&&k.test(B)},L=(B,E)=>!!(U(B)&&E&&E.some(k=>k.test(B.server)));v.IdentityManagerBase=function(B){function E(){var a=B.call(this)||this;a._portalConfig=N.esriGeowConfig;a.serverInfos=[];a.oAuthInfos=[];a.credentials=[];a._soReqs=[];a._xoReqs=[];a._portals=[];a.defaultOAuthInfo=null;a.defaultTokenValidity=
60;a.dialog=null;a.formConstructor=Y;a.tokenValidity=null;a.signInPage=null;a.useSignInPage=!0;a.normalizeWebTierAuth=!1;a._busy=null;a._rejectOnPersistedPageShow=!1;a._oAuthHash=null;a._gwTokenUrl="/sharing/rest/generateToken";a._agsRest="/rest/services";a._agsPortal=/\/sharing(\/|$)/i;a._agsAdmin=/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i;a._adminSvcs=/\/rest\/admin\/services(\/|$)/i;a._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},
{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},
{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}];a._legacyFed=[];a._regexSDirUrl=/http.+\/rest\/services\/?/gi;a._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|MapServer|MobileServer|NAServer|NetworkDiagramServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer)).*/gi;
a._gwUser=/http.+\/users\/([^\/]+)\/?.*/i;a._gwItem=/http.+\/items\/([^\/]+)\/?.*/i;a._gwGroup=/http.+\/groups\/([^\/]+)\/?.*/i;a._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i;a._createDefaultOAuthInfo=!0;a._hasTestedIfAppIsOnPortal=!1;a._getOAuthHash();window.addEventListener("pageshow",b=>{a._pageShowHandler(b)});return a}M._inheritsLoose(E,B);var k=E.prototype;k.registerServers=function(a){const b=this.serverInfos;b?(a=a.filter(c=>!this.findServerInfo(c.server)),this.serverInfos=b.concat(a)):
this.serverInfos=a;a.forEach(c=>{c.owningSystemUrl&&this._portals.push(c.owningSystemUrl);c.hasPortal&&this._portals.push(c.server)})};k.registerOAuthInfos=function(a){const b=this.oAuthInfos;b?(a=a.filter(c=>!this.findOAuthInfo(c.portalUrl)),this.oAuthInfos=b.concat(a)):this.oAuthInfos=a};k.registerToken=function(a){a={...a};const b=this._sanitizeUrl(a.server),c=this._isServerRsrc(b);let d=this.findServerInfo(b),e=!0,h;d||(d=new K,d.server=this._getServerInstanceRoot(b),c?d.hasServer=!0:(d.tokenServiceUrl=
this._getTokenSvcUrl(b),d.hasPortal=!0),this.registerServers([d]));(h=this._findCredential(b))?(delete a.server,G.mixin(h,a),e=!1):(h=new v.Credential({userId:a.userId,server:d.server,token:a.token,expires:a.expires,ssl:a.ssl,scope:c?"server":"portal"}),h.resources=[b],this.credentials.push(h));h.emitTokenChange(!1);e||h.refreshServerTokens()};k.toJSON=function(){return G.fixJson({serverInfos:this.serverInfos.map(a=>a.toJSON()),oAuthInfos:this.oAuthInfos.map(a=>a.toJSON()),credentials:this.credentials.map(a=>
a.toJSON())})};k.initialize=function(a){if(a){"string"===typeof a&&(a=JSON.parse(a));var b=a.serverInfos,c=a.oAuthInfos;a=a.credentials;if(b){const d=[];b.forEach(e=>{e.server&&e.tokenServiceUrl&&d.push(e.declaredClass?e:new K(e))});d.length&&this.registerServers(d)}if(c){const d=[];c.forEach(e=>{e.appId&&d.push(e.declaredClass?e:new T(e))});d.length&&this.registerOAuthInfos(d)}a&&a.forEach(d=>{d.server&&d.token&&d.expires&&d.expires>Date.now()&&(d=d.declaredClass?d:new v.Credential(d),d.emitTokenChange(),
this.credentials.push(d))})}};k.findServerInfo=function(a){let b;a=this._sanitizeUrl(a);for(const c of this.serverInfos)if(this._hasSameServerInstance(c.server,a)){b=c;break}return b};k.findOAuthInfo=function(a){let b;a=this._sanitizeUrl(a);for(const c of this.oAuthInfos)if(this._hasSameServerInstance(c.portalUrl,a)){b=c;break}return b};k.findCredential=function(a,b){let c,d;a=this._sanitizeUrl(a);d=this._isServerRsrc(a)?"server":"portal";if(b)for(const e of this.credentials){if(this._hasSameServerInstance(e.server,
a)&&b===e.userId&&e.scope===d){c=e;break}}else for(const e of this.credentials)if(this._hasSameServerInstance(e.server,a)&&-1!==this._getIdenticalSvcIdx(a,e)&&e.scope===d){c=e;break}return c};k.getCredential=function(a,b){let c=!0;if(b){var d=!!b.token;var e=b.error;c=!1!==b.prompt}b={...b};a=this._sanitizeUrl(a);const h=D.createAbortController(),l=D.createResolver();if(b.signal)D.onAbort(b.signal,()=>{h.abort()});D.onAbort(h,()=>{l.reject(new z("identity-manager:user-aborted","ABORTED"))});if(D.isAborted(h))return l.promise;
b.signal=h.signal;const q=this._isAdminResource(a);var f=d&&this._doPortalSignIn(a)?this._getEsriAuthCookie():null;if((d=d?this.findCredential(a):null)&&e&&e.details&&498===e.details.httpStatus)d.destroy(),f&&f.token===b.token&&(Q.writeCookie("esri_auth",null,{expires:-1,path:"/",domain:document.domain}),window.location.hostname.endsWith(".arcgis.com")&&Q.writeCookie("esri_auth",null,{expires:-1,path:"/",domain:"arcgis.com"}));else if(f||d)return a=new z("identity-manager:not-authorized","You are currently signed in as: '"+
(f&&f.email||d&&d.userId)+"'. You do not have access to this resource: "+a,{error:e}),l.reject(a),l.promise;if(e=this._findCredential(a,b))return l.resolve(e),l.promise;e=this.findServerInfo(a);if(e)!e.hasServer&&this._isServerRsrc(a)&&(e._restInfoPms=this._getTokenSvcUrl(a),e.hasServer=!0);else{f=this._getTokenSvcUrl(a);if(!f)return a=new z("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),l.reject(a),l.promise;e=new K;e.server=this._getServerInstanceRoot(a);
"string"===typeof f?(e.tokenServiceUrl=f,e.hasPortal=!0):(e._restInfoPms=f,e.hasServer=!0);this.registerServers([e])}c&&e.hasPortal&&void 0===e._selfReq&&!this._findOAuthInfo(a)&&(e._selfReq={owningTenant:b&&b.owningTenant,selfDfd:this._getPortalSelf(e.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),a)});return this._enqueue(a,e,b,l,q)};k.getResourceName=function(a){return this._isRESTService(a)?a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(a)&&
a.replace(this._gwUser,"$1")||this._gwItem.test(a)&&a.replace(this._gwItem,"$1")||this._gwGroup.test(a)&&a.replace(this._gwGroup,"$1")||""};k.generateToken=function(a,b,c){const d=this._rePortalTokenSvc.test(a.tokenServiceUrl),e=new x.Url(window.location.href.toLowerCase()),h=this._getEsriAuthCookie();var l=a.shortLivedTokenValidity;let q,f,g,r,n,t,u,m;b&&(m=this.tokenValidity||l||this.defaultTokenValidity,m>l&&0<l&&(m=l));c&&(f=c.isAdmin,g=c.serverUrl,r=c.token,t=c.signal,u=c.ssl,a.customParameters=
c.customParameters);f?l=a.adminTokenServiceUrl:(l=a.tokenServiceUrl,n=new x.Url(l.toLowerCase()),h&&(q=(q=h.auth_tier)&&q.toLowerCase()),("web"===q||a.webTierAuth)&&c&&c.serverUrl&&!u&&"http"===e.scheme&&(x.hasSameOrigin(e.uri,l,!0)||"https"===n.scheme&&e.host===n.host&&"7080"===e.port&&"7443"===n.port)&&(l=l.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));c=G.mixin({query:G.mixin({request:"getToken",username:b&&b.username,password:b&&b.password,serverUrl:g,token:r,expiration:m,referer:f||
d?window.location.host:null,client:f?"referer":null,f:"json"},a.customParameters),method:"post",authMode:"anonymous",useProxy:this._useProxy(a,c),signal:t},c&&c.ioArgs);d||(c.withCredentials=!1);return F(l,c).then(p=>{p=p.data;if(!p||!p.token)return new z("identity-manager:authentication-failed","Unable to generate token");const w=a.server;I[w]||(I[w]={});b&&(I[w][b.username]=b.password);p.validity=m;return p})};k.isBusy=function(){return!!this._busy};k.checkSignInStatus=function(a){return this.checkAppAccess(a,
"").then(b=>b.credential)};k.checkAppAccess=function(a,b,c){let d=!1;return this.getCredential(a,{prompt:!1}).then(e=>{let h;const l={f:"json"};if("portal"===e.scope)if(b&&(this._doPortalSignIn(a,!0)||c&&c.force))h=e.server+"/sharing/rest/oauth2/validateAppAccess",l.client_id=b;else if(e.token)h=e.server+"/sharing/rest";else return{credential:e};else if(e.token)h=e.server+"/rest/services";else return{credential:e};e.token&&(l.token=e.token);return F(h,{query:l,authMode:"anonymous"}).then(q=>{if(!1===
q.data.valid)throw new z("identity-manager:not-authorized",`You are currently signed in as: '${e.userId}'.`,q.data);d=!!q.data.viewOnlyUserTypeApp;return{credential:e}}).catch(q=>{if("identity-manager:not-authorized"===q.name)throw q;q=q.details&&q.details.httpStatus;if(498===q)throw e.destroy(),new z("identity-manager:not-authenticated","User is not signed in.");if(400===q)throw new z("identity-manager:invalid-request");return{credential:e}})}).then(e=>({credential:e.credential,viewOnly:d}))};k.setOAuthResponseHash=
function(a){var b;const c=this._oAuthDfd;this._oAuthDfd=null;if(c&&a)if(clearInterval(this._oAuthIntervalId),null==(b=this._oAuthOnHashHandle)?void 0:b.remove(),"#"===a.charAt(0)&&(a=a.substring(1)),a=x.queryToObject(a),a.error)b="access_denied"===a.error,a=new z(b?"identity-manager:user-aborted":"identity-manager:authentication-failed",b?"ABORTED":"OAuth: "+a.error+" - "+a.error_description),c.reject(a);else{b=c.oinfo_;const d=b._oAuthCred,e=new v.Credential({userId:a.username,server:c.sinfo_.server,
token:a.access_token,expires:Date.now()+1E3*Number(a.expires_in),ssl:"true"===a.ssl,_oAuthCred:d});b.userId=e.userId;d.storage=a.persist?window.localStorage:window.sessionStorage;d.token=e.token;d.expires=e.expires;d.userId=e.userId;d.ssl=e.ssl;d.save();c.resolve(e)}};k.setRedirectionHandler=function(a){this._redirectFunc=a};k.setOAuthRedirectionHandler=function(a){this._oAuthRedirectFunc=a};k.setProtocolErrorHandler=function(a){this._protocolFunc=a};k.signIn=function(a,b,c={}){const d=D.createResolver(),
e=()=>{var r,n,t,u,m;null==(r=q)?void 0:r.remove();null==(n=f)?void 0:n.remove();null==(t=g)?void 0:t.remove();null==(u=l)?void 0:u.destroy();null==(m=this.dialog)?void 0:m.destroy();this.dialog=l=q=f=g=null},h=()=>{e();this._oAuthDfd=null;d.reject(new z("identity-manager:user-aborted","ABORTED"))};if(c.signal)D.onAbort(c.signal,()=>{h()});let l=new this.formConstructor;l.resource=this.getResourceName(a);l.server=b.server;this.dialog=new R;this.dialog.content=l;this.dialog.open=!0;this.emit("dialog-create");
let q=l.on("cancel",h),f=this.dialog.watch("open",h),g=l.on("submit",r=>{this.generateToken(b,r,{isAdmin:c.isAdmin,signal:c.signal}).then(n=>{e();n=new v.Credential({userId:r.username,server:b.server,token:n.token,expires:null!=n.expires?Number(n.expires):null,ssl:!!n.ssl,isAdmin:c.isAdmin,validity:n.validity});d.resolve(n)}).catch(n=>{l.error=n;l.signingIn=!1})});return d.promise};k.oAuthSignIn=function(a,b,c,d){const e=this._oAuthDfd=D.createResolver();if(null!=d&&d.signal)D.onAbort(d.signal,()=>
{const n=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;n&&!n.closed?n.close():this.dialog&&l()});e.resUrl_=a;e.sinfo_=b;e.oinfo_=c;d=!d||!1!==d.oAuthPopupConfirmation;if(!c.popup||!d)return this._doOAuthSignIn(a,b,c),e.promise;const h=new this.formConstructor;h.oAuthPrompt=!0;h.server=b.server;this.dialog=new R;this.dialog.content=h;this.dialog.open=!0;this.emit("dialog-create");const l=()=>{r();this._oAuthDfd=null;e.reject(new z("identity-manager:user-aborted","ABORTED"))},q=h.on("cancel",l),f=this.dialog.watch("open",
l),g=h.on("submit",()=>{r();this._doOAuthSignIn(a,b,c)}),r=()=>{q.remove();f.remove();g.remove();h.destroy();this.dialog.destroy();this.dialog=null};return e.promise};k.destroyCredentials=function(){this.credentials&&this.credentials.slice().forEach(a=>{a.destroy()});this.emit("credentials-destroy")};k._getOAuthHash=function(){var a=window.location.hash;if(a){"#"===a.charAt(0)&&(a=a.substring(1));a=x.queryToObject(a);let b=!1;a.access_token&&a.expires_in&&a.state&&a.hasOwnProperty("username")?(a.state=
JSON.parse(a.state),this._oAuthHash=a,b=!0):a.error&&a.error_description&&(console.log("IdentityManager OAuth Error: ",a.error," - ",a.error_description),"access_denied"===a.error&&(b=!0));b&&(window.location.hash="object"===typeof a.state&&a.state.hash||"")}};k._pageShowHandler=function(a){a.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow&&(a=new z("identity-manager:user-aborted","ABORTED"),this._errbackFunc(a))};k._findCredential=function(a,b){let c=-1,d,e,h;const l=b&&b.token;b=b&&b.resource;
const q=this._isServerRsrc(a)?"server":"portal",f=this.credentials.filter(g=>this._hasSameServerInstance(g.server,a)&&g.scope===q);a=b||a;if(f.length)if(1===f.length)if(b=f[0],e=(d=(h=this.findServerInfo(b.server))&&h.owningSystemUrl)&&this.findCredential(d,b.userId),c=this._getIdenticalSvcIdx(a,b),l)-1!==c&&(b.resources.splice(c,1),this._removeResource(a,e));else return-1===c&&b.resources.push(a),this._addResource(a,e),b;else{let g,r;f.some(n=>{r=this._getIdenticalSvcIdx(a,n);return-1!==r?(g=n,e=
(d=(h=this.findServerInfo(g.server))&&h.owningSystemUrl)&&this.findCredential(d,g.userId),c=r,!0):!1});if(l)g&&(g.resources.splice(c,1),this._removeResource(a,e));else if(g)return this._addResource(a,e),g}};k._findOAuthInfo=function(a){let b=this.findOAuthInfo(a);if(!b)for(const c of this.oAuthInfos)if(this._isIdProvider(c.portalUrl,a)){b=c;break}return b};k._addResource=function(a,b){b&&-1===this._getIdenticalSvcIdx(a,b)&&b.resources.push(a)};k._removeResource=function(a,b){let c=-1;b&&(c=this._getIdenticalSvcIdx(a,
b),-1<c&&b.resources.splice(c,1))};k._useProxy=function(a,b){return b&&b.isAdmin&&!x.hasSameOrigin(a.adminTokenServiceUrl,window.location.href)||!this._isPortalDomain(a.tokenServiceUrl)&&"10.1"===String(a.currentVersion)&&!x.hasSameOrigin(a.tokenServiceUrl,window.location.href)};k._getOrigin=function(a){a=new x.Url(a);return a.scheme+"://"+a.host+(null!=a.port?":"+a.port:"")};k._getServerInstanceRoot=function(a){const b=a.toLowerCase();let c=b.indexOf(this._agsRest);-1===c&&this._isAdminResource(a)&&
(c=this._agsAdmin.test(a)?a.replace(this._agsAdmin,"$1").length:a.search(this._adminSvcs));-1===c&&(c=b.indexOf("/sharing"));-1===c&&"/"===b.substr(-1)&&(c=b.length-1);return-1<c?a.substring(0,c):a};k._hasSameServerInstance=function(a,b){"/"===a.substr(-1)&&(a=a.slice(0,-1));a=a.toLowerCase();b=this._getServerInstanceRoot(b).toLowerCase();a=this._normalizeAGOLorgDomain(a);b=this._normalizeAGOLorgDomain(b);a=a.substr(a.indexOf(":"));b=b.substr(b.indexOf(":"));return a===b};k._normalizeAGOLorgDomain=
function(a){const b=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,c=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,d=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;b.test(a)?a=a.replace(b,"https://www.arcgis.com"):c.test(a)?a=a.replace(c,"https://devext.arcgis.com"):d.test(a)&&(a=a.replace(d,"https://qaext.arcgis.com"));return a};k._sanitizeUrl=function(a){const b=(J.request.proxyUrl||"").toLowerCase(),c=b?a.toLowerCase().indexOf(b+"?"):-1;-1!==c&&(a=a.substring(c+b.length+
1));a=x.normalize(a);return x.urlToObject(a).path};k._isRESTService=function(a){return-1<a.indexOf(this._agsRest)};k._isAdminResource=function(a){return this._agsAdmin.test(a)||this._adminSvcs.test(a)};k._isServerRsrc=function(a){return this._isRESTService(a)||this._isAdminResource(a)};k._isIdenticalService=function(a,b){if(this._isRESTService(a)&&this._isRESTService(b)){a=this._getSuffix(a).toLowerCase();b=this._getSuffix(b).toLowerCase();var c=a===b;c||(c=/(.*)\/(MapServer|FeatureServer).*/gi,c=
a.replace(c,"$1")===b.replace(c,"$1"))}else this._isAdminResource(a)&&this._isAdminResource(b)?c=!0:this._isServerRsrc(a)||this._isServerRsrc(b)||!this._isPortalDomain(a)||(c=!0);return c};k._isPortalDomain=function(a){const b=new x.Url(a.toLowerCase());a=this._portalConfig;let c=this._gwDomains.some(d=>d.regex.test(b.uri));!c&&a&&(c=this._hasSameServerInstance(this._getServerInstanceRoot(a.restBaseUrl),b.uri));c||J.portalUrl&&(c=x.hasSameOrigin(b,J.portalUrl,!0));c||(c=this._portals.some(d=>this._hasSameServerInstance(d,
b.uri)));return c=c||this._agsPortal.test(b.path)};k._isIdProvider=function(a,b){let c=-1,d=-1;this._gwDomains.forEach((h,l)=>{-1===c&&h.regex.test(a)&&(c=l);-1===d&&h.regex.test(b)&&(d=l)});let e=!1;if(-1<c&&-1<d)if(0===c||4===c){if(0===d||4===d)e=!0}else if(1===c){if(1===d||2===d)e=!0}else 2===c?2===d&&(e=!0):3===c&&3===d&&(e=!0);if(!e){const h=this.findServerInfo(b),l=h&&h.owningSystemUrl;l&&U(h)&&this._isPortalDomain(l)&&this._isIdProvider(a,l)&&(e=!0)}return e};k._getIdenticalSvcIdx=function(a,
b){let c=-1;for(let d=0;d<b.resources.length;d++)if(this._isIdenticalService(a,b.resources[d])){c=d;break}return c};k._getSuffix=function(a){return a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")};k._getTokenSvcUrl=function(a){if(this._isRESTService(a)||this._isAdminResource(a)){var b=this._getServerInstanceRoot(a);var c=b+"/admin/generateToken";a=b+"/rest/info";b=F(a,{query:{f:"json"}}).then(d=>d.data);return{adminUrl:c,promise:b}}if(this._isPortalDomain(a)){let d="";this._gwDomains.some(e=>
{e.regex.test(a)&&(d=e.tokenServiceUrl);return!!d});d||this._portals.some(e=>{this._hasSameServerInstance(e,a)&&(d=e+this._gwTokenUrl);return!!d});d||(c=a.toLowerCase().indexOf("/sharing"),-1!==c&&(d=a.substring(0,c)+this._gwTokenUrl));d||(d=this._getOrigin(a)+this._gwTokenUrl);d&&(c=(new x.Url(a)).port,/^http:\/\//i.test(a)&&"7080"===c&&(d=d.replace(/:7080/i,":7443")),d=d.replace(/http:/i,"https:"));return d}if(-1!==a.toLowerCase().indexOf("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"};
k._exchangeToken=function(a,b,c){return F(`${a}/sharing/rest/oauth2/exchangeToken`,{authMode:"anonymous",method:"post",query:{f:"json",client_id:b,token:c}}).then(d=>d.data.token)};k._getPortalSelf=function(a,b){let c;this._gwDomains.some(d=>{d.regex.test(a)&&(c=d.customBaseUrl);return!!c});if(c)return D.resolve({allSSL:!0,currentVersion:"4.4",customBaseUrl:c,portalMode:"multitenant",supportsOAuth:!0});"https:"===window.location.protocol?a=a.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(b)&&
(a=a.replace(/^https:/i,"http:").replace(/:7443/i,":7080"));return F(a,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then(d=>d.data)};k._hasPortalSession=function(){return!!this._getEsriAuthCookie()};k._getEsriAuthCookie=function(){let a=null;if(navigator.cookieEnabled){var b=this._getAllCookies("esri_auth");let c;for(let d=0;d<b.length;d++){const e=JSON.parse(b[d]);if(e.portalApp){a=e;break}c?c.push(e):c=[e]}if(!a&&c)for(const d of c)if(d.urlKey&&window.location.hostname===`${d.urlKey.toLowerCase()}.${d.customBaseUrl}`){a=
d;break}}a&&(b=null,a.expires&&("number"===typeof a.expires?b=a.expires:"string"===typeof a.expires&&(b=Date.parse(a.expires)),isNaN(b)&&(b=null),a.expires=b),b&&b<Date.now()&&(a=null));return a};k._getAllCookies=function(a){const b=[];if(a=document.cookie.match(new RegExp("(?:^|; )"+W.escapeRegExpString(a)+"\x3d([^;]*)","g")))for(let c=0;c<a.length;c++){let d=a[c];const e=d.indexOf("\x3d");-1<e&&(d=d.substring(e+1),b.push(decodeURIComponent(d)))}return b};k._doPortalSignIn=function(a,b){if(navigator.cookieEnabled){const c=
this._getEsriAuthCookie(),d=this._portalConfig,e=window.location.href,h=this.findServerInfo(a);if((b||this.useSignInPage)&&(d||this._isPortalDomain(e)||c)&&(h?h.hasPortal||h.owningSystemUrl&&this._isPortalDomain(h.owningSystemUrl):this._isPortalDomain(a))&&(this._isIdProvider(e,a)||d&&(this._hasSameServerInstance(this._getServerInstanceRoot(d.restBaseUrl),a)||this._isIdProvider(d.restBaseUrl,a))||x.hasSameOrigin(e,a,!0)))return!0}return!1};k._canUsePortalSignInWorkflow=function(a){return this._doPortalSignIn(a)&&
(window===window.top||this._hasPortalSession())};k._checkProtocol=function(a,b,c,d){let e=!0;d=d?b.adminTokenServiceUrl:b.tokenServiceUrl;0===d.trim().toLowerCase().indexOf("https:")&&0!==window.location.href.toLowerCase().indexOf("https:")&&x.getProxyRule(d)&&(e=this._protocolFunc?!!this._protocolFunc({resourceUrl:a,serverInfo:b}):!1,e||(a=new z("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection."),c(a)));return e};k._enqueue=function(a,b,c,
d,e,h){d||(d=D.createResolver());d.resUrl_=a;d.sinfo_=b;d.options_=c;d.admin_=e;d.refresh_=h;this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(a),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(d)):this._xoReqs.push(d):this._doSignIn(d);return d.promise};k._doSignIn=function(a){this._busy=a;this._rejectOnPersistedPageShow=!1;const b=f=>{var g=a.options_&&a.options_.resource;const r=a.resUrl_,n=a.refresh_;let t=!1;-1===
this.credentials.indexOf(f)&&(n&&-1!==this.credentials.indexOf(n)?(n.userId=f.userId,n.token=f.token,n.expires=f.expires,n.validity=f.validity,n.ssl=f.ssl,n.creationTime=f.creationTime,t=!0,f=n):this.credentials.push(f));f.resources||(f.resources=[]);f.resources.push(g||r);f.scope=this._isServerRsrc(r)?"server":"portal";f.emitTokenChange();g=this._soReqs;const u={};this._soReqs=[];g.forEach(m=>{if(!this._isIdenticalService(r,m.resUrl_)){const p=this._getSuffix(m.resUrl_);u[p]||(u[p]=!0,f.resources.push(m.resUrl_))}});
a.resolve(f);g.forEach(m=>{this._hasSameServerInstance(this._getServerInstanceRoot(r),m.resUrl_)?m.resolve(f):this._soReqs.push(m)});this._busy=a.resUrl_=a.sinfo_=a.refresh_=null;t||this.emit("credential-create",{credential:f});this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},c=f=>{a.reject(f);this._busy=a.resUrl_=a.sinfo_=a.refresh_=null;this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},
d=(f,g,r,n)=>{var t=a.sinfo_,u=!a.options_||!1!==a.options_.prompt,m=t.hasPortal&&this._findOAuthInfo(a.resUrl_);let p;if(this._canUsePortalSignInWorkflow(a.resUrl_))g=this._getEsriAuthCookie(),f=this._portalConfig,g?(t.webTierAuth||"web"!==(g.auth_tier&&g.auth_tier.toLowerCase())||(t.webTierAuth=!0),p=new v.Credential({userId:g.email,server:t.server,token:t.webTierAuth?null:g.token,expires:g.expires}),p.token?a._pendingDfd=this._exchangeToken(p.server,m?m.appId:"arcgisonline",p.token).then(w=>{p.token=
w;b(p)}).catch(()=>{b(p)}):b(p)):u?(m="",u=window.location.href,m=this.signInPage?this.signInPage:f?f.baseUrl+f.signin:this._isIdProvider(u,a.resUrl_)?this._getOrigin(u)+"/home/signin.html":t.tokenServiceUrl.replace(this._rePortalTokenSvc,"")+"/home/signin.html",m=m.replace(/http:/i,"https:"),f&&!1===f.useSSL&&(m=m.replace(/https:/i,"http:")),0===u.toLowerCase().replace("https","http").indexOf(m.toLowerCase().replace("https","http"))?(t=new z("identity-manager:unexpected-error","Cannot redirect to Sign-In page from within Sign-In page. URL of the resource that triggered this workflow: "+
a.resUrl_),c(t)):(this._rejectOnPersistedPageShow=!0,this._redirectFunc?this._redirectFunc({signInPage:m,returnUrlParamName:"returnUrl",returnUrl:u,resourceUrl:a.resUrl_,serverInfo:t}):window.location.href=m+"?returnUrl\x3d"+encodeURIComponent(u))):(t=new z("identity-manager:not-authenticated","User is not signed in."),c(t));else if(f)b(new v.Credential({userId:f,server:t.server,token:r,expires:null!=n?Number(n):null,ssl:!!g}));else if(m){let w=m._oAuthCred;w||(f=new S(m,window.localStorage),g=new S(m,
window.sessionStorage),f.isValid()&&g.isValid()?f.expires>g.expires?(w=f,g.destroy()):(w=g,f.destroy()):w=f.isValid()?f:g,m._oAuthCred=w);w.isValid()?(p=new v.Credential({userId:w.userId,server:t.server,token:w.token,expires:w.expires,ssl:w.ssl,_oAuthCred:w}),m.appId!==w.appId&&this._doPortalSignIn(a.resUrl_,!0)?a._pendingDfd=this._exchangeToken(p.server,m.appId,p.token).then(V=>{p.token=V;w.token=V;w.save();b(p)}).catch(()=>{b(p)}):b(p)):this._oAuthHash&&this._oAuthHash.state.portalUrl===m.portalUrl?
(u=this._oAuthHash,p=new v.Credential({userId:u.username,server:t.server,token:u.access_token,expires:Date.now()+1E3*Number(u.expires_in),ssl:"true"===u.ssl,oAuthState:u.state,_oAuthCred:w}),m.userId=p.userId,w.storage=u.persist?window.localStorage:window.sessionStorage,w.token=p.token,w.expires=p.expires,w.userId=p.userId,w.ssl=p.ssl,w.save(),this._oAuthHash=null,b(p)):u?a._pendingDfd=this.oAuthSignIn(a.resUrl_,t,m,a.options_).then(b,c):(t=new z("identity-manager:not-authenticated","User is not signed in."),
c(t))}else u?this._checkProtocol(a.resUrl_,t,c,a.admin_)&&(m=a.options_,a.admin_&&(m=m||{},m.isAdmin=!0),a._pendingDfd=this.signIn(a.resUrl_,t,m).then(b,c)):(t=new z("identity-manager:not-authenticated","User is not signed in."),c(t))},e=()=>{const f=a.sinfo_;var g=f.owningSystemUrl;const r=a.options_;let n,t,u,m;r&&(n=r.token,t=r.error,u=r.prompt);m=this._findCredential(g,{token:n,resource:a.resUrl_});if(!m)for(const p of this.credentials)if(this._isIdProvider(g,p.server)){m=p;break}m?(g=this.findCredential(a.resUrl_,
m.userId))?b(g):L(f,this._legacyFed)?(g=m.toJSON(),g.server=f.server,g.resources=null,b(new v.Credential(g))):(a._pendingDfd=this.generateToken(this.findServerInfo(m.server),null,{serverUrl:a.resUrl_,token:m.token,signal:a.options_.signal,ssl:m.ssl})).then(p=>{b(new v.Credential({userId:m.userId,server:f.server,token:p.token,expires:null!=p.expires?Number(p.expires):null,ssl:!!p.ssl,isAdmin:a.admin_,validity:p.validity}))},c):(this._busy=null,n&&(a.options_.token=null),(a._pendingDfd=this.getCredential(g.replace(/\/?$/,
"/sharing"),{resource:a.resUrl_,owningTenant:f.owningTenant,signal:a.options_.signal,token:n,error:t,prompt:u})).then(()=>{this._enqueue(a.resUrl_,a.sinfo_,a.options_,a,a.admin_)},p=>{c(p)}))};this._errbackFunc=c;const h=a.sinfo_.owningSystemUrl,l=this._isServerRsrc(a.resUrl_),q=a.sinfo_._restInfoPms;q?q.promise.then(f=>{const g=a.sinfo_;g._restInfoPms&&(g.adminTokenServiceUrl=g._restInfoPms.adminUrl,g._restInfoPms=null,g.tokenServiceUrl=H.getDeepValue("authInfo.tokenServicesUrl",f)||H.getDeepValue("authInfo.tokenServiceUrl",
f)||H.getDeepValue("tokenServiceUrl",f),g.shortLivedTokenValidity=H.getDeepValue("authInfo.shortLivedTokenValidity",f),g.currentVersion=f.currentVersion,g.owningTenant=f.owningTenant,(f=g.owningSystemUrl=f.owningSystemUrl)&&this._portals.push(f));l&&g.owningSystemUrl?e():d()},()=>{a.sinfo_._restInfoPms=null;const f=new z("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");c(f)}):l&&h?e():a.sinfo_._selfReq?a.sinfo_._selfReq.selfDfd.then(f=>{const g=
{};let r,n,t,u;f&&(r=f.user&&f.user.username,g.username=r,g.allSSL=f.allSSL,n=f.supportsOAuth,t=f.currentVersion,"multitenant"===f.portalMode&&(u=f.customBaseUrl));a.sinfo_.webTierAuth=!!r;return r&&this.normalizeWebTierAuth?this.generateToken(a.sinfo_,null,{ssl:g.allSSL}).catch(()=>null).then(m=>{g.portalToken=m&&m.token;g.tokenExpiration=m&&m.expires;return g}):!r&&n&&4.4<=parseFloat(t)&&!this._canUsePortalSignInWorkflow(a.resUrl_)?this._generateOAuthInfo({portalUrl:a.sinfo_.server,customBaseUrl:u,
owningTenant:a.sinfo_._selfReq.owningTenant}).catch(()=>null).then(()=>g):g}).catch(()=>null).then(f=>{a.sinfo_._selfReq=null;f?d(f.username,f.allSSL,f.portalToken,f.tokenExpiration):d()}):d()};k._generateOAuthInfo=function(a){let b,c=a.portalUrl;const d=a.customBaseUrl,e=a.owningTenant;if(a=!this.defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal){b=window.location.href;let h=b.indexOf("?");-1<h&&(b=b.slice(0,h));h=b.search(/\/(apps|home)\//);b=-1<h?b.slice(0,h):null}a&&
b?(this._hasTestedIfAppIsOnPortal=!0,a=F(b+"/sharing/rest",{query:{f:"json"}}).then(()=>{this.defaultOAuthInfo=new T({appId:"arcgisonline",popup:!0,popupCallbackUrl:b+"/home/oauth-callback.html"})})):a=D.resolve();return a.then(()=>{if(this.defaultOAuthInfo)return c=c.replace(/^http:/i,"https:"),F(c+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:e,client_id:this.defaultOAuthInfo.appId,redirect_uri:x.makeAbsolute(this.defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then(h=>{if(h.data.valid){const l=
this.defaultOAuthInfo.clone();l.portalUrl=h.data.urlKey&&d?"https://"+h.data.urlKey.toLowerCase()+"."+d:c;this.oAuthInfos.push(l)}})})};k._doOAuthSignIn=function(a,b,c){var d={portalUrl:c.portalUrl};!c.popup&&c.preserveUrlHash&&window.location.hash&&(d.hash=window.location.hash);d={client_id:c.appId,response_type:"token",state:JSON.stringify(d),expiration:c.expiration,locale:c.locale,redirect_uri:c.popup?x.makeAbsolute(c.popupCallbackUrl):window.location.href.replace(/#.*$/,"")};c.forceLogin&&(d.force_login=
!0);c.forceUserId&&c.userId&&(d.prepopulatedusername=c.userId);const e=c.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",h=e+"?"+x.objectToQuery(d);if(c.popup){const l=window.open(h,"esriJSAPIOAuth",c.popupWindowFeatures);l?(l.focus(),this._oAuthDfd.oAuthWin_=l,this._oAuthIntervalId=setInterval(()=>{if(l.closed){clearInterval(this._oAuthIntervalId);this._oAuthOnHashHandle.remove();const q=this._oAuthDfd;if(q){const f=new z("identity-manager:user-aborted","ABORTED");q.reject(f)}}},
500),this._oAuthOnHashHandle=X.on(N,"arcgis:auth:hash",q=>{this.setOAuthResponseHash(q.detail)})):(a=new z("identity-manager:popup-blocked","ABORTED"),this._oAuthDfd.reject(a))}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:d,authorizeUrl:e,resourceUrl:a,serverInfo:b,oAuthInfo:c}):window.location.href=h};return E}(P);v.IdentityManagerBase=A.__decorate([O.subclass("esri.identity.IdentityManagerBase")],v.IdentityManagerBase);v.Credential=function(B){function E(a){var b=
B.call(this,a)||this;b._oAuthCred=null;b.tokenRefreshBuffer=2;a&&a._oAuthCred&&(b._oAuthCred=a._oAuthCred);return b}M._inheritsLoose(E,B);var k=E.prototype;k.initialize=function(){this.resources=this.resources||[];null==this.creationTime&&(this.creationTime=Date.now())};k.refreshToken=function(){const a=y.id.findServerInfo(this.server),b=a&&a.owningSystemUrl,c=!!b&&"server"===this.scope,d=c&&L(a,y.id._legacyFed);var e=a.webTierAuth;const h=e&&y.id.normalizeWebTierAuth;var l=I[this.server];l=l&&l[this.userId];
let q=this.resources&&this.resources[0],f=c&&y.id.findServerInfo(b),g={username:this.userId,password:l},r;if(!e||h)if(c&&!f&&y.id.serverInfos.some(n=>{y.id._isIdProvider(b,n.server)&&(f=n);return!!f}),e=f&&y.id.findCredential(f.server,this.userId),!c||e)if(d)e.refreshToken();else{if(c)r={serverUrl:q,token:e&&e.token,ssl:e&&e.ssl};else if(h)g=null,r={ssl:this.ssl};else if(l)this.isAdmin&&(r={isAdmin:!0});else{let n;q&&(q=y.id._sanitizeUrl(q),this._enqueued=1,n=y.id._enqueue(q,a,null,null,this.isAdmin,
this),n.then(()=>{this._enqueued=0;this.refreshServerTokens()}).catch(()=>{this._enqueued=0}));return n}return y.id.generateToken(c?f:a,c?null:g,r).then(n=>{this.token=n.token;this.expires=null!=n.expires?Number(n.expires):null;this.creationTime=Date.now();this.validity=n.validity;this.emitTokenChange();this.refreshServerTokens()}).catch(()=>{})}};k.refreshServerTokens=function(){"portal"===this.scope&&y.id.credentials.forEach(a=>{const b=y.id.findServerInfo(a.server),c=b&&b.owningSystemUrl;a!==this&&
a.userId===this.userId&&c&&"server"===a.scope&&(y.id._hasSameServerInstance(this.server,c)||y.id._isIdProvider(c,this.server))&&(L(b,y.id._legacyFed)?(a.token=this.token,a.expires=this.expires,a.creationTime=this.creationTime,a.validity=this.validity,a.emitTokenChange()):a.refreshToken())})};k.emitTokenChange=function(a){clearTimeout(this._refreshTimer);var b=this.server&&y.id.findServerInfo(this.server);const c=(b=b&&b.owningSystemUrl)&&y.id.findServerInfo(b);!1===a||b&&"portal"!==this.scope&&(!c||
!c.webTierAuth||y.id.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer();this.emit("token-change")};k.destroy=function(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null;this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);const a=y.id.credentials.indexOf(this);-1<a&&y.id.credentials.splice(a,1);this.emitTokenChange();this.emit("destroy")};k.toJSON=function(){const a=G.fixJson({userId:this.userId,
server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),b=this.resources;b&&0<b.length&&(a.resources=b.slice());return a};k._startRefreshTimer=function(){clearTimeout(this._refreshTimer);const a=6E4*this.tokenRefreshBuffer;let b=(this.validity?this.creationTime+6E4*this.validity:this.expires)-Date.now();0>b&&(b=0);this._refreshTimer=setTimeout(this.refreshToken.bind(this),b>a?b-a:b)};return E}(P.EventedAccessor);
A.__decorate([C.property()],v.Credential.prototype,"creationTime",void 0);A.__decorate([C.property()],v.Credential.prototype,"expires",void 0);A.__decorate([C.property()],v.Credential.prototype,"isAdmin",void 0);A.__decorate([C.property()],v.Credential.prototype,"oAuthState",void 0);A.__decorate([C.property()],v.Credential.prototype,"resources",void 0);A.__decorate([C.property()],v.Credential.prototype,"scope",void 0);A.__decorate([C.property()],v.Credential.prototype,"server",void 0);A.__decorate([C.property()],
v.Credential.prototype,"ssl",void 0);A.__decorate([C.property()],v.Credential.prototype,"token",void 0);A.__decorate([C.property()],v.Credential.prototype,"tokenRefreshBuffer",void 0);A.__decorate([C.property()],v.Credential.prototype,"userId",void 0);A.__decorate([C.property()],v.Credential.prototype,"validity",void 0);v.Credential=A.__decorate([O.subclass("esri.identity.Credential")],v.Credential);Object.defineProperty(v,"__esModule",{value:!0})});