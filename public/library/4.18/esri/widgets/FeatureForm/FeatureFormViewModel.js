// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/Logger ../../core/accessorSupport/decorators/property ../../core/accessorSupport/decorators/cast ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/ReentrantObjectPool ../../core/Evented ../../support/arcadeOnDemand ../../intl/locale ../../intl/messages ../../intl ../../Graphic ../../core/watchUtils ../../form/FormTemplate ../../core/HandleOwner ./FieldConfig ./FieldGroupConfig ./InputField ./InputFieldGroup ./support/formTemplateUtils".split(" "),
function(z,d,c,H,f,I,Y,J,Z,aa,ba,A,K,L,M,N,ca,O,P,Q,R,B,C,S,T,U){function V(t){return!!t.fieldConfig}const D=new O({attributes:{}}),W=H.getLogger("esri.widgets.FeatureForm.FeatureFormViewModel");c=function(t){function u(a){a=t.call(this,a)||this;a._arcade=null;a._fieldPool=new A.ReentrantObjectPool(S);a._fieldGroupPool=new A.ReentrantObjectPool(T);a._featureClone=D.clone();a._needsArcade=!1;a.messages=null;a.strict=!1;return a}z._inheritsLoose(u,t);var l=u.prototype;l.initialize=function(){const a=
async()=>this.messages=await N.fetchMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm");a();this.handles.add(M.onLocaleChange(a));const b=P.init(this,"fieldConfig",async e=>{const g=[];e&&e.forEach(h=>{g.push(h.visibilityExpression);h.fieldConfig?h.fieldConfig.forEach(({requiredExpression:k,visibilityExpression:q})=>{g.push(k,q)}):g.push(h.requiredExpression)});e=g.filter(h=>!!h);const m=0<e.length;if(m){const h=await L.loadArcade(),{arcadeUtils:k}=h;e.some(q=>k.hasGeometryOperations(q))&&(await k.enableGeometryOperations(),
b.remove());this._arcade=h;this.notifyChange("inputFields")}this._needsArcade=m});this.handles.add(b)};l.destroy=function(){this.layer=this.feature=this.fieldConfig=null;this._fieldPool.destroy();this._fieldGroupPool.destroy()};l.castFieldConfig=function(a){return a?a.map(b=>b instanceof B||b instanceof C?b:b.fieldConfig?new C(b):new B(b)):null};l.findField=function(a){return this._allInputFields.find(b=>b.name===a)};l.getValue=function(a){const {_featureClone:b}=this;return b.attributes?b.get(`attributes.${a}`):
void 0};l.setValue=function(a,b){const {_featureClone:e,strict:g}=this;if(e.attributes){var m=this.findField(a);b=""===b?null:b;if(m&&e.attributes[a]!==b){m.value=b;if(this.get("layer.typeIdField")===m.name){const h=new Set;this.layer.types.forEach(k=>Object.keys(k.domains).forEach(q=>h.add(q)));h.forEach(k=>{(k=this.findField(k))&&k.notifyChange("domain")})}if(!g||m.valid)e.attributes[a]=b,this.notifyChange("inputFields"),this._emitChangeEvent(m)}}};l.getValues=function(){return{...this._featureClone.attributes}};
l.submit=function(){var a=this._allInputFields;const b=a.filter(g=>g.valid).map(({name:g})=>g);a=a.filter(g=>!g.valid).map(({name:g})=>g);const e=this.getValues();this.emit("submit",{valid:b,invalid:a,values:e})};l._disposeInputOrGroup=function(a){a.inputFields?this._disposeGroup(a):this._disposeInput(a)};l._disposeGroup=function(a){a.inputFields.forEach(b=>this._disposeInput(b));this._fieldGroupPool.release(a)};l._disposeInput=function(a){this._fieldPool.release(a)};l._emitChangeEvent=function({name:a,
valid:b,value:e}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:a,value:e,valid:b})};z._createClass(u,[{key:"_allInputFields",get:function(){return this.inputFields.reduce((a,b)=>b.inputFields?[...a,...b.inputFields]:[...a,b],[])}},{key:"_inputFieldCache",get:function(){const a=this._get("_inputFieldCache")||new Map;a.forEach(b=>this._disposeInputOrGroup(b));a.clear();(this.get("layer.fields")||[]).forEach(b=>a.set(b,this._fieldPool.acquire()));return a}},{key:"_inputFieldGroupCache",
get:function(){const a=this._get("_inputFieldGroupCache")||new Map;a.forEach(b=>this._disposeInputOrGroup(b));a.clear();(this.fieldConfig||[]).filter(V).forEach(b=>a.set(b,this._fieldGroupPool.acquire()));return a}},{key:"description",get:function(){var a;return null==(a=this.formTemplate)?void 0:a.description},set:function(a){void 0===a?this._clearOverride("description"):this._override("description",a)}},{key:"feature",get:function(){return this._get("feature")},set:function(a){this._featureClone=
a?a.clone():D.clone();this._set("feature",a)}},{key:"fieldConfig",get:function(){const {formTemplate:a}=this;if(!a)return null;const {config:b,encounteredUnsupportedTypes:e}=U.fieldConfigsFromFormTemplate(a);0<e.length&&W.warn("form-info::unsupported-type","encountered unsupported elements/types when parsing form info",e);return b},set:function(a){a?this._override("fieldConfig",a):this._clearOverride("fieldConfig")}},{key:"formTemplate",get:function(){var a;return null==(a=this.layer)?void 0:a.formTemplate},
set:function(a){void 0===a?this._clearOverride("formTemplate"):this._override("formTemplate",a)}},{key:"inputFields",get:function(){const {_arcade:a,_inputFieldCache:b,_inputFieldGroupCache:e,_featureClone:g,messages:m,_needsArcade:h,layer:k,state:q}=this,v=g.clone();if("ready"!==q||h&&!a)return[];const x=this.get("layer.fields")||[],E=this.fieldConfig||[];return(0!==E.length?E.map(n=>{if(n.fieldConfig){const r=e.get(n);var p=n.fieldConfig.map(w=>{const y=x.find(X=>X.name===w.name),F=b.get(y);F.set({arcade:a,
field:y,config:w,feature:v,group:r,layer:k,messages:m,value:this.getValue(y.name)});return F}).filter(w=>w.visible);r.set({arcade:a,config:n,feature:v,inputFields:p});return r}p=x.find(r=>r.name===n.name);const G=b.get(p);G.set({arcade:a,field:p,config:n,feature:v,group:null,layer:k,messages:m,value:this.getValue(p.name)});return G}):x.map(n=>{const p=b.get(n);p.set({arcade:a,config:null,field:n,feature:v,group:null,layer:k,messages:m,value:this.getValue(n.name)});return p})).filter(n=>n.visible)}},
{key:"layer",get:function(){return this.get("feature.layer")},set:function(a){a?this._override("layer",a):this._clearOverride("layer")}},{key:"state",get:function(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}},{key:"title",get:function(){var a;return null==(a=this.formTemplate)?void 0:a.title},set:function(a){void 0===a?this._clearOverride("title"):this._override("title",a)}},{key:"valid",get:function(){const a=this._allInputFields;return 0<a.length&&a.every(({valid:b})=>b)}}]);
return u}(R.HandleOwnerMixin(K.EventedAccessor));d.__decorate([f.property({readOnly:!0,dependsOn:["inputFields"]})],c.prototype,"_allInputFields",null);d.__decorate([f.property({dependsOn:["layer.fields"],readOnly:!0})],c.prototype,"_inputFieldCache",null);d.__decorate([f.property({dependsOn:["fieldConfig"],readOnly:!0})],c.prototype,"_inputFieldGroupCache",null);d.__decorate([f.property({dependsOn:["formTemplate"]})],c.prototype,"description",null);d.__decorate([f.property()],c.prototype,"feature",
null);d.__decorate([f.property({dependsOn:["formTemplate"]})],c.prototype,"fieldConfig",null);d.__decorate([I.cast("fieldConfig")],c.prototype,"castFieldConfig",null);d.__decorate([f.property({dependsOn:["layer?.formTemplate"],type:Q})],c.prototype,"formTemplate",null);d.__decorate([f.property({readOnly:!0,dependsOn:"messages feature fieldConfig layer.fields layer.loaded state".split(" "),autoTracked:!1})],c.prototype,"inputFields",null);d.__decorate([f.property({dependsOn:["feature.layer"]})],c.prototype,
"layer",null);d.__decorate([f.property()],c.prototype,"messages",void 0);d.__decorate([f.property({dependsOn:["messages","layer.loaded"]})],c.prototype,"state",null);d.__decorate([f.property()],c.prototype,"strict",void 0);d.__decorate([f.property({dependsOn:["formTemplate"]})],c.prototype,"title",null);d.__decorate([f.property({dependsOn:["_allInputFields"]})],c.prototype,"valid",null);d.__decorate([f.property()],c.prototype,"getValues",null);d.__decorate([f.property()],c.prototype,"submit",null);
return c=d.__decorate([J.subclass("esri.widgets.FeatureForm.FeatureFormViewModel")],c)});