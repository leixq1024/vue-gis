// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("require exports ../../core/has ../../core/maybe ../../core/promiseUtils ../../layers/support/fieldUtils ../../core/screenUtils ../../chunks/symbols ../../Graphic ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/support/lengthUtils ../../renderers/visualVariables/support/visualVariableUtils ../../core/accessorSupport/diffUtils ../../views/support/hitTestSelectUtils ../../renderers/support/clickToleranceUtils ../../views/support/drapedUtils ../../symbols/support/symbolUtils".split(" "),
function(G,v,aa,r,z,H,B,K,L,M,N,O,P,Q,R,S,C){function I(a){const b=a.layer;a:switch(b.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":var c=!0;break a;default:c=!1}var d=(a=c&&O.getVisualVariableValues(b.renderer,a))?a.map(h=>h.variable):[];c=d.filter(h=>"rotation"===h.type&&(!h.axis||"heading"===h.axis));a=c[0];c=1===c.length&&a.field&&!a.valueExpression;var f=d.filter(h=>"size"===h.type);d=f[0];f=1===f.length&&"real-world-size"===M.getTransformationType(d)&&
d.field&&!d.useSymbolValue&&!d.valueExpression;return{rotation:c?T(a,b):null,size:f?U(d,b):null}}function T(a,b){const c="heading"===(a.axis||"heading")&&"arithmetic"===a.rotationType?-1:1,d=a.field,f=(a=b.fields&&b.fields.filter(k=>k.name===d))&&1===a.length?a[0].type:"double";var h=0,g=0;return{field:d,getDefault:()=>z.resolve(0),getValue:k=>{g=h-c*k;return D((g+360)%360,f)},initValue:k=>{h=null!=k?k:g;g=0},isUpdatingInteractively:!1}}function V(a,b){switch(b){case "width":return a[0];case "depth":return a[1];
case "height":return a[2];default:return a[2]||a[1]||a[0]}}async function W(a,b,c){if(r.isNone(b))return 0;({symbol:b}=K.to3D(b));if(r.isNone(b)||"web-style"===b.type)return 0;b=b.symbolLayers.getItemAt(0);if(!b)return 0;switch(b.type){case "icon":return{computeIconLayerResourceSize:c}=await new Promise(function(d,f){G(["../../symbols/support/symbolLayerUtils"],d,f)}),b.size||Math.min(w.icon,(await c(b,w.icon))[0])||w.icon;case "text":return b.size||w.text;case "line":return b.size||w.line;case "object":{const {computeObjectLayerResourceSize:d}=
await new Promise(function(f,h){G(["../../symbols/support/symbolLayerUtils"],f,h)});a=await d(b,a.scale/w.viewScaleSizeFactor);return V(a,c)}case "path":case "extrude":return b.size||a.scale/w.viewScaleSizeFactor;case "fill":case "water":return 0;default:return 0}}function U(a,b){const c=a.field,d=a.axis,f=(b=b.fields&&b.fields.filter(e=>e.name===c))&&1===b.length?b[0].type:"double";var h=0,g=0;const k=N.meterIn[a.valueUnit];let l;l="area"===a.valueRepresentation?e=>Math.pow(e*k/2,2)*Math.PI:"radius"===
a.valueRepresentation||"distance"===a.valueRepresentation?e=>e*k/2:e=>e*k;return{field:c,getDefault:async(e,m)=>D(l(await W(m,e,d)),f),getValue:(e,m)=>{h||(h=m.pixelSizeAt(m.center));g=h*e;return D(g,f)},initValue:e=>{h=null!=e?e:g;g=0},isUpdatingInteractively:!1}}function D(a,b){switch(b){case "small-integer":case "integer":case "long":return Math.round(a);case "double":case "single":return a;default:return 0}}async function A(a){const b=await C.getDisplayedSymbol(a,{ignoreGraphicSymbol:!0}),c=P.diff(a.symbol,
b);r.isSome(c)&&(a.symbol=b)}async function X(a,b,c){var d;if("3d"===c.type){var f=b.layer;b={...b.template.prototype.attributes};f=new L({layer:f,sourceLayer:f,attributes:b});var {rotation:h,size:g}=I(f),k=await C.getDisplayedSymbol(f),l=!1;for(const e of[g,h])r.isNone(e)||null!=b[e.field]||(b[e.field]=await e.getDefault(k,c),l=!0);l&&(k=await C.getDisplayedSymbol(f));switch(null==(d=k)?void 0:d.type){case "simple-fill":case "polygon-3d":a.polygonSymbol=k;break;case "simple-line":case "line-3d":a.polylineSymbol=
k;break;case "simple-marker":case "point-3d":a.pointSymbol=k}}}async function Y(a,b,c,d){if(0===a.length)return[];const {updatable:f,graphicsByLayer:h}=await c.async(async()=>{var {results:g}=await z.whenOrAbort(Q.hitTestSelectSameDistance(b,c),d);const k=new Map,l=({layer:e})=>{var m=k.get(e);return m?m:(m=[],k.set(e,m),m)};g.forEach(({graphic:e})=>l(e).push(e));g=a.filter(({supports:e,layer:m})=>-1<e.indexOf("update")&&k.has(m));0!==g.length&&c.stopPropagation();return{updatable:g,graphicsByLayer:k}});
return z.eachAlways(f.map(async({layer:g})=>{const {objectIdField:k,displayField:l}=g,e=[k];H.hasField(g.fields,l)&&e.push(l);const m=h.get(g);if(m.some(t=>e.some(x=>!(x in t.attributes)))){const t=g.createQuery();t.outFields=e;t.returnGeometry=!1;t.objectIds=m.map(x=>x.getObjectId());return g.queryFeatures(t,{signal:d}).then(({features:x})=>x)}return m}),d)}async function Z(a,b,c,d){if(0===a.length)return[];const {results:f}=await z.whenOrAbort(b.hitTest(c),d);if(0===f.length)return[];const h=new Set;
f.forEach(({graphic:g})=>h.add(g.layer));return z.eachAlways(a.items.filter(({layer:g,supports:k})=>-1<k.indexOf("update")&&h.has(g)).map(({layer:g})=>{const {objectIdField:k,displayField:l}=g;var e=[k];H.hasField(g.fields,l)&&e.push(l);const m=g.createQuery();m.outFields=e;m.returnGeometry=!1;e=R.calculateTolerance({renderer:g.renderer,event:c});m.geometry=S.createQueryGeometry(c.mapPoint,e,b);return g.queryFeatures(m,{signal:d}).then(({features:t})=>t)}),d)}const w={icon:B.px2pt(24),text:B.px2pt(12),
line:B.px2pt(1),viewScaleSizeFactor:100};v.fetchCandidates=async function(a,b,c,d){switch(b.type){case "3d":return Y(a,b,c,d);case "2d":return Z(a,b,c,d)}};v.fetchFullFeature=async function(a,b,c){const d=a.layer,f=d.createQuery();f.objectIds=[a.getAttribute(d.objectIdField)];f.outFields=["*"];f.outSpatialReference=b.spatialReference;f.returnM=d.capabilities.data.supportsM;f.returnZ=d.capabilities.data.supportsZ;return(await d.queryFeatures(f,{signal:c})).features[0]};v.findLayerInfo=function(a,b){return a&&
a.find(c=>c.layer===b)};v.getVisualVariableAttributes=I;v.setUpFeatureAdd=async function(a,b,c,d){const f=b.layer;await X(a,b,c);a.layer.elevationInfo=f.elevationInfo;await a.create(f.geometryType,{hasZ:f.capabilities.data.supportsZ});const h=a.on("create",async g=>{const {state:k,graphic:l}=g;"cancel"===k?a.create(f.geometryType,{hasZ:f.capabilities.data.supportsZ}):"complete"===k&&(g=l.clone(),g.attributes={...b.template.prototype.attributes},g.layer=f,a.layer.remove(l),await A(g),d(g))});c.map.add(a.layer);
return{remove:()=>{h.remove();c.map.remove(a.layer);a.cancel()}}};v.setUpGeometryUpdate=async function(a,b,c,d,f){const h=a.clone();await A(h);c.layer.add(h);h.sourceLayer=a.layer;const g=(()=>{const {layer:p}=a;if("graphics"===p.type)return{remove(){}};const {objectIdField:q}=p,u=a.attributes[q],n=d.whenLayerView(p);n.then(y=>y.setVisibility(u,!1),()=>{});return{remove(){n.then(y=>y.setVisibility(u,!0),()=>{})}}})(),k=a.layer,l=b.size,e=b.rotation,m={multipleSelectionEnabled:!1};"point"===k.geometryType&&
(m.enableRotation=!!e,m.enableScaling=!!l);c.layer.elevationInfo=k.elevationInfo;c.update(h,m);const t=(r.isSome(l)||r.isSome(e))&&a.watch("attributes",async p=>{let q=!1;for(const u in p){const n=p[u];n!==h.attributes[u]&&(h.setAttribute(u,n),q=!0,r.isSome(l)&&!l.isUpdatingInteractively&&l.field===u&&l.initValue(n),r.isSome(e)&&!e.isUpdatingInteractively&&e.field===u&&e.initValue(n))}q&&"3d"===d.type&&await A(h)});[e,l].forEach(async p=>{if(!r.isNone(p)){var q=a.attributes[p.field];null!=q?p.initValue(q):
(q=await p.getDefault(h.symbol,d),p.initValue(q),h.setAttribute(p.field,q),"3d"===d.type&&await A(h))}});const x=c.on("update",async p=>{const {graphics:[q],state:u,toolEventInfo:n}=p;if("complete"===u)c.update(q,m);else{if(r.isSome(e)&&n){const {field:y,getValue:E,initValue:F}=e;"rotate-stop"===n.type?(e.isUpdatingInteractively=!1,F()):null!=n.angle&&(e.isUpdatingInteractively=!0,h.attributes[y]=E(n.angle/Math.PI*180,d))}if(r.isSome(l)&&n){const {field:y,getValue:E,initValue:F}=l;"scale-stop"===
n.type?(l.isUpdatingInteractively=!1,F()):null!=n.xScale&&(l.isUpdatingInteractively=!0,h.attributes[y]=E(n.xScale,d))}"3d"===d.type&&await A(h);f(q.clone())}});d.map.add(c.layer);const J=()=>{};return{interactive:{remove(){x.remove();c.cancel();t&&t.remove();this.remove=J}},visual:{remove(){g.remove();d.map.remove(c.layer);c.layer.removeAll();this.remove=J}}}};v.sizeDefaults=w;Object.defineProperty(v,"__esModule",{value:!0})});