// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/Error ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/promiseUtils ../../core/Evented ../../core/Collection ../../intl/locale ../../Color ../../symbols/SimpleLineSymbol ../../symbols/PictureMarkerSymbol ../../symbols/SimpleMarkerSymbol ../../chunks/symbols ../../Graphic ../../core/Handles ../../core/watchUtils ../../tasks/support/FeatureSet ../../layers/GraphicsLayer ../support/GoTo ../../tasks/RouteTask ../../geometry/support/graphicsUtils ../../tasks/support/RouteParameters ./support/directionsUtils".split(" "),
function(F,g,f,M,N,aa,h,ba,O,w,ca,da,ea,t,P,G,Q,R,S,H,A,fa,T,U,B,V,C,W,I,X,J,u){const Y=N.getLogger("esri.widgets.Directions.DirectionsViewModel"),K={first:new A({color:[105,220,255,1],size:19,outline:{color:[51,51,51,1],width:3}}),middle:new A({color:[51,51,51,1],size:12,outline:{color:[105,220,255,1],width:3}}),last:new H({width:23,height:23,url:`data:image/svg+xml;base64,${btoa('\x3csvg width\x3d"30" height\x3d"30" viewBox\x3d"0 0 30 30" xmlns\x3d"http://www.w3.org/2000/svg"\x3e\x3cg fill-rule\x3d"nonzero" fill\x3d"none"\x3e\x3cpath d\x3d"M15.15.3C6.9.3.3 6.9.3 15.15S6.9 29.7 15.15 29.7 29.7 23.1 29.7 15.15C29.7 6.9 23.25.3 15.15.3z" fill\x3d"#333"/\x3e\x3cpath d\x3d"M15 4.8C9.3 4.8 4.8 9.45 4.8 15c0 5.55 4.65 10.2 10.2 10.2 5.55 0 10.2-4.5 10.2-10.2 0-5.55-4.5-10.2-10.2-10.2z" fill\x3d"#69DCFF"/\x3e\x3cpath fill\x3d"#333" d\x3d"M10.5 10.5h9v9h-9z"/\x3e\x3c/g\x3e\x3c/svg\x3e')}`}),
unlocated:new H({height:18,width:18,url:`data:image/svg+xml;base64,${btoa('\x3csvg width\x3d"20" height\x3d"20" viewBox\x3d"0 0 20 20" xmlns\x3d"http://www.w3.org/2000/svg"\x3e\x3cg fill\x3d"none" fill-rule\x3d"evenodd"\x3e\x3cpath d\x3d"M10.1.2C4.6.2.2 4.6.2 10.1s4.4 9.7 9.9 9.7 9.7-4.4 9.7-9.7c0-5.5-4.3-9.9-9.7-9.9z" fill\x3d"#333" fill-rule\x3d"nonzero"/\x3e\x3cpath d\x3d"M10 2.7c-4.08 0-7.3 3.328-7.3 7.3s3.328 7.3 7.3 7.3 7.3-3.22 7.3-7.3c0-3.972-3.22-7.3-7.3-7.3z" fill\x3d"#69DCFF" fill-rule\x3d"nonzero"/\x3e\x3cpath d\x3d"M11.414 10l5.304-5.303-1.415-1.415L10 8.586 4.697 3.282 3.282 4.697 8.586 10l-5.304 5.303 1.415 1.415L10 11.414l5.303 5.304 1.415-1.415L11.414 10z" fill\x3d"#333"/\x3e\x3c/g\x3e\x3c/svg\x3e')}`}),
waypoint:new A({color:[255,255,255,1],size:10,outline:{color:[20,89,127,1],width:2.5}})};f=function(L){function x(a){a=L.call(this,a)||this;a._handles=new U;a._routeLayer=new C({listMode:"hide"});a._highlightLayer=new C({listMode:"hide"});a._stopId=9999;a._stopLayer=new C({listMode:"hide"});a._serviceDescriptionLoadStatus=0;a.departureTime="now";a.lastRoute=null;a.routeSymbol=new S({color:[105,220,255,1],width:7,cap:"round",join:"round"});a.routeParameters=new J({doNotLocateOnRestrictedElements:!0,
ignoreInvalidLocations:!0,directionsOutputType:"complete",findBestSequence:!1,preserveFirstStop:!0,preserveLastStop:!0,restrictUTurns:"at-dead-ends-and-intersections",directionsLengthUnits:"kilometers",returnBarriers:!1,returnDirections:!0,returnPolygonBarriers:!1,returnPolylineBarriers:!1,returnRoutes:!1,returnStops:!0,returnZ:!0,startTime:null,startTimeIsUTC:!0,stops:null,useHierarchy:!0,useTimeWindows:!1});a.routeServiceUrl="https://route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World";
a.serviceDescription=null;a.error=null;a.stops=new G;a.view=null;return a}F._inheritsLoose(x,L);var m=x.prototype;m.initialize=function(){this._handles.add([B.on(this,"stops","change",()=>{this.clearResults();this._addStopsToLayer()}),B.init(this,"view.map",(a,c)=>{const e=[this._routeLayer,this._stopLayer,this._highlightLayer];c&&c.removeMany(e);a&&a.addMany(e)}),B.watch(this,"lastRoute",()=>this._addRouteToLayer())])};m.destroy=function(){this.stops.destroy();const a=this.get("view.map");a&&a.removeMany([this._routeLayer,
this._stopLayer,this._highlightLayer])};m.load=async function(){if(!this.serviceDescription)try{this._serviceDescriptionLoadStatus=1,this.notifyChange("state"),await this._loadServiceDescription(),this._serviceDescriptionLoadStatus=2,this.notifyChange("state")}catch(c){var a="identity-manager:user-aborted"===c.name;this._serviceDescriptionLoadStatus=a?4:3;this.notifyChange("state");if(!a)throw a=new w("directions-view-model:service-metadata-unavailable","Cannot load route service metadata",{error:c}),
this._set("error",a),a;}};m.highlightSegment=function(a){const {view:c,_highlightLayer:e}=this;if(c&&!M.isNone(a.symbol)){this.clearHighlights();var d=a.symbol.clone();d.color=new R([0,0,0,.8]);d.width=Math.ceil(d.width/2);a=new T({geometry:a.geometry,symbol:d});e.graphics.add(a)}};m.clearHighlights=function(){this._highlightLayer.graphics.removeAll()};m.centerAt=function(a){const {view:c}=this;c&&this.callGoTo({target:a})};m.clearResults=function(){this._set("lastRoute",null)};m.getDirections=function(){var {state:a}=
this;if("unauthenticated"===a||"initializing"===a||"disabled"===a||3===this._serviceDescriptionLoadStatus)return t.reject(new w("directions-view-model:not-loaded","Cannot get directions until view model loads."));this._set("error",null);this._activeRouteController&&(this._activeRouteController.abort(),this._activeRouteController=null);var {departureTime:c}=this;a="now"===c;c="now"===c?new Date:c;if(!a){const d=6E4*c.getTimezoneOffset();c.setTime(c.getTime()-d)}this.routeParameters.set({startTime:c,
startTimeIsUTC:a,directionsLanguage:this._directionsLanguage});this.selectedTravelMode&&this.routeParameters.set({travelMode:this.selectedTravelMode});if(1>=this.stops.length)return a=new w("directions-view-model:not-enough-stops","Not enough stops for routing"),this._set("error",a),t.reject(a);a=new AbortController;const {signal:e}=a;this._activeRouteController=a;a=this._enqueue(()=>{const d=this.stops.clone().toArray(),l={},v=b=>{const r=b&&b.routeResults&&b.routeResults[0]&&b.routeResults[0].stops||
[];(b&&b.routeResults&&b.routeResults[0]&&b.routeResults[0].directions&&b.routeResults[0].directions.features||[]).map(k=>{for(let n=0;n<d.length;n++)if(-1<k.attributes.text.indexOf(d[n].attributes.Name)){const y=d[n].attributes.Name;k.attributes.text=k.attributes.text.replace(y,l[y]);k._associatedStop=d[n];break}});d.map(k=>k.attributes.Name=l[k.attributes.Name]);r.map(k=>{k.attributes.Name=l[k.attributes.Name]})},E=b=>{if(b&&b.routeResults&&b.routeResults[0]){b=b.routeResults[0];const r=b.stops||
[],k=this.stops.clone().toArray();let n=b.directions&&b.directions.routeName||b.routeName||"";r.map((y,Z)=>{const p=y.attributes,q=k[Z].attributes;n=n.replace(p.Name,q.Name);Object.keys(p).forEach(D=>{0===D.indexOf("Cumul_")&&(q[D]=p[D])});q.ArriveCurbApproach=p.ArriveCurbApproach;q.ArriveTime=p.ArriveTime;q.ArriveTimeUTC=p.ArriveTimeUTC;q.DepartCurbApproach=p.DepartCurbApproach;q.DepartTime=p.DepartTime;q.DepartTimeUTC=p.DepartTimeUTC;q.Sequence=p.Sequence;q.Status=p.Status});b.directions&&(b.directions.routeName=
n);null!==b.route&&(b.route.attributes.Name=n);b.routeName=n}},z=b=>{b=b&&b.routeResults&&b.routeResults[0]&&b.routeResults[0].stops||[];const r=this.stops.toArray();let k=b.length===r.length,n=0;for(;k&&n<b.length;)k=k&&l[b[n].attributes.Name]===r[n++].attributes.Name;return k};(()=>{d.map(b=>{b=b.attributes;const r=`${(b.Name||"[not yet geocoded]").substr(0,100)}_#${++this._stopId}`;l[r]=b.Name;b.Name=r})})();this.routeParameters.set({stops:new V({features:d})});return this._routeTask.solve(this.routeParameters,
{signal:e}).then(b=>{if(z(b))return E(b),v(b),this._set("lastRoute",b),b;Y.warn("Response stops don't match current stops of the ViewModel, invalidating the results.");this._set("lastRoute",null);return null}).catch(b=>{v(null);throw b;})}).then(d=>{this._activeRouteController=null;this.notifyChange("state");this.zoomToRoute();return d}).catch(d=>{this._activeRouteController=null;this.notifyChange("state");if(!t.isAbortError(d))throw d=new w("directions-view-model:unable-to-route","Unable to route to these addresses",
{error:d}),this._set("error",d),d;});this.notifyChange("state");return a};m.getCostAttribute=function(a){const c=this.serviceDescription&&this.serviceDescription.networkDataset.networkAttributes||[];let e="";for(let d=0;d<c.length;d++)if(c[d].name===a&&"esriNAUTCost"===c[d].usageType){e=c[d];break}return e};m.reset=function(){this.stops.removeAll();this.clearHighlights();this._set("lastRoute",null)};m.zoomToRoute=function(){const {directionLines:a,view:c}=this;if(a&&c){var e=X.graphicsExtent(a);this.callGoTo({target:e.expand(e.width>
e.height?2:1)})}};m._loadServiceDescription=async function(){const a=await this._routeTask.getServiceDescription();this._set("serviceDescription",a)};m._enqueue=function(a){this._requestQueueTail||(this._requestQueueTail=t.resolve());const c=t.create((e,d)=>{this._requestQueueTail.catch(()=>{}).then(()=>{try{const l=a.call(this);t.isPromiseLike(l)?l.then(e,d):e(l)}catch(l){d(l)}})});return this._requestQueueTail=c};m._addStopsToLayer=function(){this._stopLayer.graphics.removeAll();const a=this.stops.clone().map((c,
e)=>{const {first:d,middle:l,last:v,unlocated:E,waypoint:z}=this.stopSymbols;u.isWaypoint(c)?c.symbol=z:c.symbol=void 0===c.attributes.Status?0===e?d:e===this.stops.length-1?v:l:u.isWaypoint(c)?z:u.isStopLocated(c)?u.isFirstStop(c)?d:u.isLastStop(c)?v:l:E;return c});this._stopLayer.graphics.addMany(a)};m._addRouteToLayer=function(){this._routeLayer.graphics.removeAll();const {directionLines:a}=this;a&&(a.forEach(c=>{c.symbol=this.routeSymbol}),this._routeLayer.graphics.addMany(a))};F._createClass(x,
[{key:"_directionsLanguage",get:function(){const {routeParameters:a,serviceDescription:c}=this,{directionsSupportedLanguages:e}=c;if(e){var d=(a.directionsLanguage||Q.getLocale()).slice(0,2);return e.find(l=>l.toLowerCase().slice(0,2)===d)}}},{key:"_routeTask",get:function(){return new I(this.routeServiceUrl)}},{key:"impedanceAttribute",get:function(){const a=this.get("routeParameters.travelMode.impedanceAttributeName")||this.get("routeParameters.impedanceAttribute")||this.get("serviceDescription.impedance");
return this.getCostAttribute(a)}},{key:"maxStops",set:function(a){this._set("maxStops",2>=a?2:50<a?50:a)}},{key:"selectedTravelMode",get:function(){var {serviceDescription:a}=this;if(!a)return null;const {defaultTravelMode:c,supportedTravelModes:e=[]}=a;a=null;for(let d=0;d<e.length;d++)e[d].id===c&&(a=e[d]);return a||e[0]||null},set:function(a){void 0===a?this._clearOverride("selectedTravelMode"):this._override("selectedTravelMode",a)}},{key:"state",get:function(){const a=this._serviceDescriptionLoadStatus;
return 4===a?"unauthenticated":0===a?"disabled":1===a?"initializing":this._activeRouteController?"routing":3===a||this.error?"error":"ready"}},{key:"stopSymbols",set:function(a){this._set("stopSymbols",{...K,...a})}},{key:"timeAttribute",get:function(){const a=this.get("routeParameters.travelMode.timeAttributeName")||this.get("routeParameters.directionsTimeAttribute")||this.get("serviceDescription.directionsTimeAttribute");return this.getCostAttribute(a)}},{key:"travelModes",get:function(){return this.get("serviceDescription.supportedTravelModes")||
[]}}]);return x}(W.GoToMixin(P.EventedAccessor));g.__decorate([h.property({dependsOn:["serviceDescription","routeParameters.directionsLanguage"]})],f.prototype,"_directionsLanguage",null);g.__decorate([h.property({dependsOn:["routeServiceUrl"],type:I})],f.prototype,"_routeTask",null);g.__decorate([h.property()],f.prototype,"departureTime",void 0);g.__decorate([h.property({aliasOf:"lastRoute.routeResults.0.directions.features"})],f.prototype,"directionLines",void 0);g.__decorate([h.property({readOnly:!0,
dependsOn:["routeParameters","serviceDescription"]})],f.prototype,"impedanceAttribute",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"lastRoute",void 0);g.__decorate([h.property({value:50})],f.prototype,"maxStops",null);g.__decorate([h.property()],f.prototype,"routeSymbol",void 0);g.__decorate([h.property({type:J})],f.prototype,"routeParameters",void 0);g.__decorate([h.property()],f.prototype,"routeServiceUrl",void 0);g.__decorate([h.property({dependsOn:["serviceDescription"]})],f.prototype,
"selectedTravelMode",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"serviceDescription",void 0);g.__decorate([h.property({dependsOn:["error"],readOnly:!0})],f.prototype,"state",null);g.__decorate([h.property()],f.prototype,"error",void 0);g.__decorate([h.property({type:G})],f.prototype,"stops",void 0);g.__decorate([h.property({value:K})],f.prototype,"stopSymbols",null);g.__decorate([h.property({readOnly:!0,dependsOn:["routeParameters","serviceDescription"]})],f.prototype,"timeAttribute",
null);g.__decorate([h.property({dependsOn:["serviceDescription"]})],f.prototype,"travelModes",null);g.__decorate([h.property()],f.prototype,"view",void 0);g.__decorate([h.property()],f.prototype,"getDirections",null);g.__decorate([h.property()],f.prototype,"zoomToRoute",null);return f=g.__decorate([O.subclass("esri.widgets.Directions.DirectionsViewModel")],f)});