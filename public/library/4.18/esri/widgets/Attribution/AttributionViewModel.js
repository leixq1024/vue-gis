// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../geometry/SpatialReference ../../geometry/support/webMercatorUtils ../../geometry/support/contains ../../geometry ../../core/Collection ../../core/asyncUtils ../../core/watchUtils ../../core/HandleOwner".split(" "),
function(r,t,q,F,G,v,H,z,I,J,K,A,w,B,L,x,C,y,D){function E(m,h){return m.length!==h.length||m.some((l,b)=>l.text!==h[b].text)}function u(m,h,l){l&&h&&(m.find(b=>b.layerView===h&&b.text===l)||m.push({text:l,layerView:h}))}const n=[];q=function(m){function h(b){var a=m.call(this,b)||this;a.clear=()=>{a._fetchedAttributionData.clear();a._pendingAttributions.clear();a.handles.remove("suspension");a.notifyChange("state")};a._pendingAttributions=new Set;a._fetchedAttributionData=new Map;a.items=new x;a.view=
null;a._allLayerViewsChange=d=>{a.handles.remove("suspension");const e=a.get("view.allLayerViews");e&&a.handles.add(e.map(c=>c.watch(["suspended","attributionVisible"],a._updateAttributionItems)),"suspension");d&&d.removed&&d.removed.forEach(c=>{a._pendingAttributions.delete(c);a._fetchedAttributionData.delete(c)});a._updateAttributionItems()};a._updateAttributionItems=()=>{const d=a.get("view.allLayerViews");n.length=0;d?(d.forEach(e=>{if(!e.suspended&&e.get("layer.attributionVisible")){var c=e.layer;
if(c&&"copyright"in c&&"function"===typeof c.originOf&&"user"===c.originOf("copyright"))u(n,e,c.copyright);else if(c.hasAttributionData)if(a._fetchedAttributionData.has(e)){var f=a._fetchedAttributionData.get(e);f&&u(n,e,a._getDynamicAttribution(f,a.view,c))}else a._fetchAttributionData(e);else(f=c.get("portalItem.accessInformation"))?u(n,e,f):u(n,e,c.copyright)}}),E(a.items,n)&&(a.items.removeAll(),a.items.addMany(n)),n.length=0,a.notifyChange("state")):a.clear()};a.handles.add([y.on(r._assertThisInitialized(a),
"view.allLayerViews","change",a._allLayerViewsChange,a._allLayerViewsChange,a.clear),y.whenTrue(r._assertThisInitialized(a),"view.stationary",()=>a._updateAttributionItems())]);return a}r._inheritsLoose(h,m);var l=h.prototype;l.destroy=function(){this.view=null;this._fetchedAttributionData.clear();this._pendingAttributions.clear();this.items.removeAll()};l._fetchAttributionData=async function(b){if(!this._pendingAttributions.has(b)){this._pendingAttributions.add(b);var a=await C.result(b.layer.fetchAttributionData());
this._pendingAttributions.has(b)&&(a=a.ok?this._createContributionIndex(a.value,"bing-maps"===b.layer.type):null,this._pendingAttributions.delete(b),this._fetchedAttributionData.set(b,a));this._updateAttributionItems()}};l._createContributionIndex=function(b,a){b=b.contributors;const d={};if(!b)return d;for(let p=0;p<b.length;p++){const k=b[p];var e=k.coverageAreas;if(!e)return;for(const g of e){var c=g.bbox,f=g.zoomMin-(a&&g.zoomMin?1:0);e=g.zoomMax-(a&&g.zoomMax?1:0);for(c={extent:w.geographicToWebMercator({xmin:c[1],
ymin:c[0],xmax:c[3],ymax:c[2],spatialReference:A.WGS84}),attribution:k.attribution||"",score:null!=g.score?g.score:100,id:p};f<=e;f++)d[f]=d[f]||[],d[f].push(c)}}d.maxKey=Math.max.apply(null,Object.keys(d));return d};l._getDynamicAttribution=function(b,a,d){const {extent:e,scale:c}=a;d=d.tileInfo.scaleToZoom(c);d=Math.min(b.maxKey,Math.round(d));if(!e||null==d||-1>=d)return"";b=b[d];const f=w.project(e.center.clone().normalize(),a.spatialReference),p={};return b?b.filter(k=>{const g=!p[k.id]&&f&&
B.extentContainsPoint(k.extent,f);g&&(p[k.id]=!0);return g}).sort((k,g)=>g.score-k.score||k.objectId-g.objectId).map(k=>k.attribution).join(", "):""};r._createClass(h,[{key:"state",get:function(){return this.get("view.ready")?0<this._pendingAttributions.size?"loading":"ready":"disabled"}}]);return h}(D.HandleOwner);t.__decorate([v.property({readOnly:!0,type:x})],q.prototype,"items",void 0);t.__decorate([v.property({dependsOn:["view.ready"],readOnly:!0})],q.prototype,"state",null);t.__decorate([v.property()],
q.prototype,"view",void 0);return q=t.__decorate([z.subclass("esri.widgets.Attribution.AttributionViewModel")],q)});