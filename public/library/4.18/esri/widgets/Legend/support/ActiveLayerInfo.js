// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../core/Accessor ../../../core/Collection ../../../layers/support/fieldUtils ../../../Color ../../../core/screenUtils ../../../kernel ../../../request ../../../symbols/SimpleFillSymbol ../../../symbols/SimpleMarkerSymbol ../../../chunks/symbols ../../../core/Handles ../../../renderers/visualVariables/support/SizeVariableLegendOptions ../../../symbols/support/cimSymbolUtils ../../../symbols/support/utils ../../../renderers/support/jsonUtils ../../../core/watchUtils ../../../layers/support/ExportImageParameters ../../../symbols/support/symbolUtils ./clusterUtils ./utils ./colorRampUtils ./heatmapRampUtils ./relationshipRampUtils ./sizeRampUtils".split(" "),
function(Q,R,v,u,G,da,Ga,w,ea,fa,ha,Ha,Ia,z,ia,ja,ka,S,la,ma,T,na,U,Ja,oa,pa,qa,ra,sa,D,V,C,ta,ua,H,va,W,L){function E(q){return"esri.renderers.SimpleRenderer"===q.declaredClass}function F(q){return"esri.renderers.ClassBreaksRenderer"===q.declaredClass}function M(q){return"esri.renderers.UniqueValueRenderer"===q.declaredClass}function X(q){return"esri.renderers.HeatmapRenderer"===q.declaredClass}function N(q){return"esri.renderers.PointCloudClassBreaksRenderer"===q.declaredClass}function O(q){return"esri.renderers.PointCloudStretchRenderer"===
q.declaredClass}function P(q){return"esri.renderers.PointCloudUniqueValueRenderer"===q.declaredClass}function Y(q){return"esri.renderers.DotDensityRenderer"===q.declaredClass}function Z(q){return"esri.layers.BuildingSceneLayer"===q.declaredClass}function wa(q){q="authoringInfo"in q&&(null==q?void 0:q.authoringInfo);return"univariate-color-size"===(null==q?void 0:q.type)&&"above-and-below"===(null==q?void 0:q.univariateTheme)}const A=da.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),I=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,
xa=new ea.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),ya={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-3.4*1E39,3.4*1E39],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},J=new U({size:6,outline:{color:[128,128,128,.5],width:.5}}),za=new na({style:"solid"}),Aa=new U({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",
size:15,outline:{width:1,color:[85,85,85,1]}});let B={};u=function(q){function K(a){a=q.call(this,a)||this;a._handles=new oa;a._hasColorRamp=!1;a._hasOpacityRamp=!1;a._hasSizeRamp=!1;a._webStyleSymbolCache=new Map;a._dotDensityUrlCache=new Map;a._scaleDrivenSizeVariable=null;a._hasClusterSizeVariable=!1;a.children=new ja;a.layerView=null;a.layer=null;a.legendElements=[];a.parent=null;a.keepCacheOnDestroy=!1;a.respectLayerVisibility=!0;a.sublayerIds=[];a.title=null;a.view=null;return a}R._inheritsLoose(K,
q);var l=K.prototype;l.initialize=function(){const a=()=>this.notifyChange("ready");this._handles.add([D.on(this,"children","change",b=>{const {added:c,removed:d}=b,e=this._handles;c.map(g=>{const f=`activeLayerInfo-ready-watcher-${g.layer.uid}`;e.add(D.init(g,"ready",a),f)});d.forEach(g=>e.remove(g.layer.uid));a()})]);this.keepCacheOnDestroy||(B={})};l.destroy=function(){this._handles.destroy();this._scaleDrivenSizeVariable=this._dotDensityUrlCache=this._webStyleSymbolCache=this._handles=null;this.keepCacheOnDestroy||
(B=null)};l.buildLegendElementsForFeatureCollections=async function(a){a=a.map(b=>{if("esri.layers.FeatureLayer"===b.declaredClass)return this._getRendererLegendElements(b.renderer,{title:b.title});if(b.featureSet&&b.featureSet.features.length){var c=b.layerDefinition,d=c&&c.drawingInfo;d=d&&sa.fromJSON(d.renderer);c=xa.read(c.geometryType);return d?this._getRendererLegendElements(d,{title:b.name,geometryType:c}):(A.warn("drawingInfo not available!"),null)}return null});try{const b=[];await z.eachAlways(a).then(c=>
{c.forEach(({value:d})=>d&&b.push(...d))});this.legendElements=b;this.notifyChange("ready")}catch(b){A.warn("error while building legend for layer!",b)}};l.buildLegendElementsForRenderer=async function(a){try{this.legendElements=await this._getRendererLegendElements(a),this.notifyChange("ready")}catch(b){A.warn("error while building legend for layer!",b)}};l.buildLegendElementsForTools=async function(){const a=this.layer;"esri.layers.WMTSLayer"===a.declaredClass?this._constructLegendElementsForWMTSlayer():
"esri.layers.WMSLayer"===a.declaredClass?await this._constructLegendElementsForWMSSublayers():Z(a)?await this._constructLegendElementsForBuildingSceneLayer():"esri.layers.MapImageLayer"===a.declaredClass||"esri.layers.TileLayer"===a.declaredClass||Z(a)?await this._constructLegendElementsForSublayers():(this._handles.remove("imageryLayers-watcher"),await this._getLegendLayers().then(b=>{this.legendElements=[];b.forEach(c=>{if("esri.layers.ImageryLayer"===a.declaredClass){const d=a.watch(["renderingRule",
"bandIds"],()=>{B["default"]=null;this.buildLegendElementsForTools()});this._handles.add(d,"imageryLayers-watcher")}(c=this._generateSymbolTableElementForLegendLayer(c))&&c.infos.length&&("esri.layers.ImageryLayer"===a.declaredClass&&(c.title=a.title),this.legendElements.push(c));this.notifyChange("ready")});this.notifyChange("ready")}).catch(b=>{A.warn("Request to server for legend has failed!",b)}))};l._getParentLayerOpacity=function(a){let b=1;const c=a.parent;c&&"uid"in c&&(b=this._getParentLayerOpacity(c));
return a.opacity*b};l._isGroupActive=function(){const a=this.children;return a.length?a.some(b=>b.ready):!1};l._isScaleDrivenSizeVariable=function(a){if(a&&"size"!==a.type)return!1;const b=a.minSize,c=a.maxSize;return"object"===typeof b&&b?this._isScaleDrivenSizeVariable(b):"object"===typeof c&&c?this._isScaleDrivenSizeVariable(c):!!a.expression||I.test(a.valueExpression)};l._isLayerScaleDriven=function(a){if("minScale"in a&&0<a.minScale||"maxScale"in a&&0<a.maxScale)return!0;if("sublayers"in a&&
a.sublayers)return a.sublayers.some(c=>this._isLayerScaleDriven(c));const b=a.parent;if(!1===a.loaded&&b&&"esri.layers.MapImageLayer"===b.declaredClass&&"source"in a&&a.source&&"map-layer"===a.source.type)for(const c of b.sourceJSON.layers)if(c.id===a.source.mapLayerId&&(0<c.minScale||0<c.maxScale))return!0;return!1};l._constructLegendElementsForWMTSlayer=function(){this.legendElements=[];this._handles.remove("wmts-activeLayer-watcher");const a=this.layer.activeLayer;this._handles.add(D.watch(this.layer,
"activeLayer",()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");if(a.styleId&&a.styles){let b=null;a.styles.some(c=>a.styleId===c.id?(b=c.legendUrl,!0):!1);b&&(this.legendElements=[{type:"symbol-table",title:a.title,infos:[{src:b,opacity:this.opacity}]}])}this.notifyChange("ready")};l._constructLegendElementsForWMSSublayers=async function(){this.legendElements=[];this._handles.remove("wms-sublayers-watcher");const a=this.layer;let b=null;if(a.customParameters||a.customLayerParameters)b=
{...a.customParameters,...a.customLayerParameters};this._handles.add(D.watch(this.layer,"sublayers",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");this.legendElements=await this._generateLegendElementsForWMSSublayers(a.sublayers,b);this.notifyChange("ready")};l._generateLegendElementsForWMSSublayers=async function(a,b){const c=[];this._handles.add(a.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");a=a.toArray();for(const d of a)a=
d.watch(["title","visible","legendEnabled"],()=>this._constructLegendElementsForWMSSublayers()),this._handles.add(a,"wms-sublayers-watcher"),d.visible&&d.legendEnabled&&(a=await this._generateSymbolTableElementForWMSSublayer(d,b))&&a.infos.length&&c.unshift(a);return c};l._generateSymbolTableElementForWMSSublayer=async function(a,b){return!a.legendUrl&&a.sublayers?(b=(await this._generateLegendElementsForWMSSublayers(a.sublayers,b)).filter(c=>c),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendUrl(a,
b)};l._generateSymbolTableElementForLegendUrl=async function(a,b){var c;let d=a.legendUrl;if(d){var e={type:"symbol-table",title:a.title||a.name||a.id&&a.id+"",infos:[]};b&&(d+="?"+ha.objectToQuery(b));b=null;a=null==(c=a.layer)?void 0:c.opacity;try{if(b=(await T(d,{responseType:"image"})).data)b.style.opacity=a}catch{}e.infos.push({src:d,preview:b,opacity:a});return e}};l._getLegendLayers=function(a){const b=(a=a&&a.hasDynamicLayers?a.dynamicLayers:null)||"default",c=B&&B[b];return c?z.resolve(c):
this._legendRequest(a).then(d=>{d=d.layers;return B[b]=d})};l._legendRequest=function(a){var b=this.layer;a={f:"json",dynamicLayers:a};if("esri.layers.ImageryLayer"===b.declaredClass){var c=b.exportImageServiceParameters.renderingRule;c&&(a.renderingRule=JSON.stringify(c.toJSON()));b.bandIds&&(a.bandIds=b.bandIds.join());if(b.raster||b.viewId){const {raster:d,viewId:e}=b;a={raster:d,viewId:e,...a}}}c=b.url.replace(/(\/)+$/,"");"version"in b&&10.01<=b.version?(b=c.indexOf("?"),c=-1<b?c.substring(0,
b)+"/legend"+c.substring(b):c+"/legend"):(b=c.toLowerCase().indexOf("/rest/"),b=c.substring(0,b)+c.substring(b+5,c.length),c="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+encodeURI(b)+"\x26returnbytes\x3dtrue");return T(c,{query:a}).then(d=>d.data)};l._constructLegendElementsForBuildingSceneLayer=async function(){this.legendElements=[];this._handles.remove("sublayers-watcher");const a=this.layer;this._handles.add(D.watch(a,"sublayers",()=>this._constructLegendElementsForBuildingSceneLayer()),
"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){A.warn("Request to server for legend has failed!",b)}};l._generateLegendElementsForBuildingSublayers=async function(a,b){let c=[];this._handles.add(a.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");a=a.toArray();for(const e of a)if(a=e.watch(["renderer","opacity","title","visible"],()=>this._constructLegendElementsForBuildingSceneLayer()),
this._handles.add(a,"sublayers-watcher"),e.visible){a=e&&null!=e.opacity?e.opacity:null;var d=null!=a?a*b:b;"building-group"===e.type?(a={type:"symbol-table",title:e.title,infos:[]},d=await this._generateLegendElementsForBuildingSublayers(e.sublayers,d),a.infos.push(...d),c=[a,...c]):e.renderer&&(c=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:d,sublayer:e}),...c])}return c.filter(e=>!!e&&("infos"in e?0<e.infos.length:!0))};l._constructLegendElementsForSublayers=async function(){this.legendElements=
[];this._handles.remove("sublayers-watcher");const a=this.layer;this._handles.add(D.watch(a,"sublayers",()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){A.warn("Request to server for legend has failed!",b)}};l._generateLegendElementsForSublayers=async function(a,b,c){let d=[];this._handles.add(a.on("change",()=>this._constructLegendElementsForSublayers()),
"sublayers-watcher");a=a.toArray();if(!c&&this.sublayerIds&&this.sublayerIds.length){const f=this.layer;a=this.sublayerIds.map(k=>f.findSublayerById(k)).filter(Boolean)}const e=new V.ExportImageParameters({layer:this.layer}),g=e.hasDynamicLayers&&e.dynamicLayers||"default";e.destroy();for(const f of a)if(a=f.watch("renderer, opacity, title, visible, legendEnabled",(k,m,y)=>{var h;(k=B&&B[g])&&!c&&(c=new Map,k.forEach(n=>c.set(n.layerId,n)));k=null==(h=c)?void 0:h.get(f.id);("renderer"!==y||2<f.originIdOf("renderer")||
!k)&&this._constructLegendElementsForSublayers()}),this._handles.add(a,"sublayers-watcher"),f.visible&&f.legendEnabled)if(a=f&&null!=f.opacity?f.opacity:null,a=null!=a?a*b:b,f.renderer&&!f.sublayers&&2<f.originIdOf("renderer")){if(!this.respectLayerVisibility||this._isSublayerInScale(f))await f.load(),d=[...await this._getRendererLegendElements(f.renderer,{title:f.title,opacity:a,sublayer:f}),...d]}else(a=await this._generateSymbolTableElementForSublayer(f,a,c))&&d.unshift(a);return d.filter(f=>!!f&&
("infos"in f?0<f.infos.length:!0))};l._generateSymbolTableElementForSublayer=async function(a,b,c){if(!c){c=new Map;var d=new V.ExportImageParameters({layer:this.layer});try{(await this._getLegendLayers(d)).forEach(e=>c.set(e.layerId,e))}finally{d.destroy()}}d=c.get(a.id);return!d&&a.sublayers?(b=await this._generateLegendElementsForSublayers(a.sublayers,b,c),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendLayer(d,a,b)};l._generateSymbolTableElementForLegendLayer=
function(a,b,c){if(!a||!a.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(a,b))return null;var d=b&&b.renderer,e=b&&b.title||a.layerName;d&&(d=b&&b.title||this._getRendererTitle(d,b))&&(e&&"string"!==typeof d&&"title"in d&&(d.title=e),e=d);e={type:"symbol-table",title:e,infos:[]};a.legendType&&(e.legendType=a.legendType);b=b?this._sanitizeLegendForSublayer(a.legend.slice(),b):a.legend;e.infos=b.map(g=>{let f=g.url;if(g.imageData&&0<g.imageData.length)f=`data:image/png;base64,${g.imageData}`;
else if(0!==f.indexOf("http"))f=ma.addTokenParameter(`${this.layer.url}/${a.layerId}/images/${f}`);else return null;return{label:g.label,src:f,opacity:null==c?this.opacity:c,width:g.width,height:g.height}}).filter(g=>!!g);return e.infos.length?e:null};l._isSublayerInScale=function(a){const b=a.minScale||0;a=a.maxScale||0;return 0<b&&b<this.scale||a>this.scale?!1:!0};l._isLegendLayerInScale=function(a,b){b=b||this.layer;let c=null,d=null,e=!0;!b.minScale&&0!==b.minScale||!b.maxScale&&0!==b.maxScale?
(0===a.minScale&&b.tileInfo&&(c=b.tileInfo.lods[0].scale),0===a.maxScale&&b.tileInfo&&(d=b.tileInfo.lods[b.tileInfo.lods.length-1].scale)):(c=Math.min(b.minScale,a.minScale)||b.minScale||a.minScale,d=Math.max(b.maxScale,a.maxScale));if(0<c&&c<this.scale||d>this.scale)e=!1;return e};l._sanitizeLegendForSublayer=function(a,b){if("version"in this.layer&&10.1>this.layer.version||0===a.length)return a;b=b.renderer;let c=null,d=null;a.some(e=>e.values)&&a.some((e,g)=>{e.values||(c=g,d=e,d.label||(d.label=
"others"));return null!=d});b?"unique-value"===b.type?d&&(a.splice(c,1),a.push(d)):"class-breaks"===b.type&&(d&&a.splice(c,1),a.reverse(),d&&a.push(d)):d&&(a.splice(c,1),a.push(d));return a};l._getRendererLegendElements=async function(a,b={}){return E(a)||F(a)||M(a)||"raster-stretch"===a.type||"raster-colormap"===a.type||X(a)||N(a)||O(a)||P(a)||Y(a)||"vector-field"===a.type||"raster-shaded-relief"===a.type?N(a)||O(a)||P(a)||"esri.renderers.PointCloudRGBRenderer"===a.declaredClass?this._constructPointCloudRendererLegendElements(a,
b):Y(a)?this._constructDotDensityRendererLegendElements(a):this._constructRendererLegendElements(a,b):(A.warn("Renderer not supported!"),[])};l._getPointCloudRendererTitle=function(a){return a.legendOptions&&a.legendOptions.title||a.field};l._constructPointCloudRendererLegendElements=function(a,b={}){b=b.title;const c=[];let d=null;var e=null;if(N(a))d={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorClassBreakInfos.forEach(g=>{d.infos.unshift({label:g.label||g.minValue+
" - "+g.maxValue,value:[g.minValue,g.maxValue],symbol:this._getAppliedCloneSymbol(J,g.color)})});else if(O(a)){e=a.stops;let g=null;if(e.length&&(1===e.length&&(g=e[0].color),!g)){const f=e[0].value,k=e[e.length-1].value;null!=f&&null!=k&&(g=H.getColorFromPointCloudStops(f+(k-f)/2,e))}d={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(J,g||J.color)}]};e=H.getRampStopsForPointCloud(a.stops);e={type:"color-ramp",title:b||this._getPointCloudRendererTitle(a),
infos:e,preview:C.renderColorRampPreviewHTML(e.map(f=>f.color))}}else P(a)&&(d={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorUniqueValueInfos.forEach(g=>{d.infos.push({label:g.label||g.values.join(", "),value:g.values.join(", "),symbol:this._getAppliedCloneSymbol(J,g.color)})}));d&&d.infos.length&&c.push(d);e&&e.infos.length&&c.push(e);b=c.reduce((g,f)=>g.concat(f.infos),[]).filter(g=>!!g.symbol).map(g=>this._getSymbolPreview(g,this.opacity,{symbolConfig:{applyColorModulation:!!a.colorModulation}}));
return z.eachAlways(b).then(()=>c)};l._getElementInfoForDotDensity=function(a,b){const {backgroundColor:c,outline:d,dotSize:e}=a,g=e+"-"+b+"-"+c+"-"+(d&&JSON.stringify(d.toJSON())),f=this._dotDensityUrlCache;a=f.has(g)?f.get(g):C.renderDotDensityPreviewHTML(a,b);f.set(g,a);return{opacity:1,src:a.src,preview:a,width:a.width,height:a.height}};l._constructDotDensityRendererLegendElements=function(a){const b=a.calculateDotValue(this.view.scale),c={type:"symbol-table",title:{value:b&&Math.round(b),unit:a.legendOptions&&
a.legendOptions.unit||""},infos:[]};a.attributes.forEach(d=>{const e=this._getElementInfoForDotDensity(a,d.color);e.label=d.label||d.valueExpressionTitle||d.field;c.infos.push(e)});return z.resolve([c])};l._constructRendererLegendElements=async function(a,b={}){const {title:c,sublayer:d}=b,e=d||this.layer;a=await this._loadRenderer(a);this._hasSizeRamp=this._hasOpacityRamp=this._hasColorRamp=!1;this._scaleDrivenSizeVariable=null;const g=await this._getVisualVariableLegendElements(a,e)||[],f={type:"symbol-table",
title:c||this._getRendererTitle(a,e),infos:[]};let k=null,m=!1;const y=new Set;if(wa(a)){var h={type:"univariate-above-and-below-ramp",title:c,infos:[]},n=g.findIndex(p=>"color-ramp"===p.type);n=g.splice(n,1)[0];var t=g.findIndex(p=>"size-ramp"===p.type);t=g.splice(t,1)[0];n&&(h.title=n.title,h.infos.push(n));t&&(h.title=t.title,h.infos.push(t));g.push(h)}else if(X(a))h=va.getHeatmapRampStops(a),g.push({type:"heatmap-ramp",title:c,infos:h,preview:C.renderColorRampPreviewHTML(h.map(p=>p.color))});
else if(M(a)){if((n=a&&a.authoringInfo)&&"relationship"===n.type){const {focus:p,numClasses:x,field1:aa,field2:ba}=n;if(x&&aa&&ba){t=[aa,ba];n=W.getRotationAngleForFocus(p)||0;for(h of t){const {field:Ba,normalizationField:ca,label:Ca}=h;t=Ca||{field:this._getFieldAlias(Ba,e),normField:ca&&this._getFieldAlias(ca,e)};var r=Aa.clone();r.angle=n;f.infos.push({label:t,symbol:r});y.add(r);n+=90}h=W.getRelationshipRampElement({focus:p,numClasses:x,infos:a.uniqueValueInfos});g.unshift(h)}}else{const p=a.field;
a.uniqueValueInfos.forEach(x=>{x.symbol&&f.infos.push({label:x.label||this._getDomainName(p,x.value,e)||x.value,value:x.value,symbol:x.symbol})})}a.defaultSymbol&&(f.infos.push({label:a.defaultLabel||"others",symbol:a.defaultSymbol}),m=!0)}else if(F(a))k=this._isUnclassedRenderer(a),k&&this._hasSizeRamp||(a.classBreakInfos.forEach(p=>{p.symbol&&f.infos.unshift({label:p.label||(k?null:p.minValue+" - "+p.maxValue),value:[p.minValue,p.maxValue],symbol:p.symbol})}),k&&(f.title=null),this._updateInfosforClassedSizeRenderer(a,
f.infos)),a.defaultSymbol&&!k&&(f.infos.push({label:a.defaultLabel||"others",symbol:a.defaultSymbol}),m=!0);else if("raster-stretch"===a.type)if("esri.layers.ImageryTileLayer"===this.layer.declaredClass||"esri.layers.WCSLayer"===this.layer.declaredClass)h=this._constructTileImageryStretchRendererElements(a),"stretch-ramp"===h.type?g.push(h):f.infos=h;else{h=this.layer;a.statistics&&a.statistics.length&&(n=a.statistics[0].min||a.statistics[0][0],t=a.statistics[0].max||a.statistics[0][1]);r=[];r=G.unwrap(h.renderingRule?
await h.generateRasterInfo(h.renderingRule):h.serviceRasterInfo);const p=r.keyProperties.BandProperties;1===r.bandCount?(n=n||r.statistics&&r.statistics[0].min,t=t||r.statistics&&r.statistics[0].max,n||t?g.push(this._getStretchLegendElements(a,{min:n,max:t})):this.buildLegendElementsForTools()):h.bandIds&&1===h.bandIds.length?(n=n||r.statistics&&r.statistics[h.bandIds[0]].min,t=t||r.statistics&&r.statistics[h.bandIds[0]].max,n||t?g.push(this._getStretchLegendElements(a,{min:n,max:t})):this.buildLegendElementsForTools()):
3<=r.bandCount?p&&p.length>=r.bandCount?h.bandIds&&3===h.bandIds.length?(r=h.bandIds.map(x=>p[x].BandName),f.infos=this._createSymbolTableElementMultiBand(r)):"lerc"===h.format?(r=[0,1,2].map(x=>p[x].BandName),f.infos=this._createSymbolTableElementMultiBand(r)):this.buildLegendElementsForTools():"lerc"===h.format?(r=["band1","band2","band3"],f.infos=this._createSymbolTableElementMultiBand(r)):this.buildLegendElementsForTools():this.buildLegendElementsForTools()}else if("raster-colormap"===a.type)a.colormapInfos.forEach(p=>
{f.infos.push({label:p.label,value:p.value,symbol:this._getAppliedCloneSymbol(za,p.color)})});else if(E(a)){h=a.symbol;switch(b.geometryType){case "point":h="pointSymbol"in e&&e.pointSymbol;break;case "polyline":h="lineSymbol"in e&&e.lineSymbol;break;case "polygon":h="polygonSymbol"in e&&e.polygonSymbol}a.symbol&&!this._hasSizeRamp&&f.infos.push({label:a.label,symbol:h})}else"vector-field"===a.type?(a.outputUnit&&(this.title="("+a.toJSON().outputUnit+")"),f.title=a.attributeField,h=a.getClassBreakInfos(),
null!=h&&h.length?h.forEach(p=>{f.infos.push({label:p.minValue+" - "+p.maxValue,symbol:p.symbol})}):f.infos.push({label:a.attributeField,symbol:a.getDefaultSymbol()})):"raster-shaded-relief"===a.type&&g.push(this._getStretchLegendElements(a,{min:0,max:255}));h=a.defaultSymbol;!h||m||E(a)||k&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||g.push({type:"symbol-table",infos:[{label:a.defaultLabel||"others",symbol:h}]});f.infos.length&&g.unshift(f);const Da=null==b.opacity?this.opacity:
b.opacity,Ea=this._isTallSymbol("visualVariables"in a&&a.visualVariables),Fa="esri.layers.ImageryLayer"===this.layer.declaredClass;b=g.reduce((p,x)=>p.concat(this._getAllInfos(x)),[]).filter(p=>!(!p||!p.symbol)).map(p=>this._getSymbolPreview(p,Da,{applyScaleDrivenSize:!y.has(p.symbol),symbolConfig:{isTall:Ea,isSquareFill:Fa}}));a=null;await z.eachAlways(b);return g};l._getAllInfos=function(a){const b=null==a?void 0:a.infos;return b?b.reduce((c,d)=>c.concat(this._getAllInfos(d)),[]):[a]};l._constructTileImageryStretchRendererElements=
function(a){function b(m){var y;const h=((null==c?void 0:null==(y=c.bandIds)?void 0:y.length)===d.bandCount?c.bandIds:Array.from(Array(Math.min(d.bandCount,3)).keys())).map(n=>m&&m[n]&&m[n].BandName||"band"+(n+1));3>h.length?h.push(h[1]):3<h.length&&h.splice(3);return h}const c=this.layer,d=c.rasterInfo,e=d.bandCount||a.statistics.length;let g;var f=[];f=d.keyProperties&&d.keyProperties.BandProperties;if(a.statistics&&a.statistics.length){g=void 0!==a.statistics[0].min?a.statistics[0].min:a.statistics[0][0];
var k=a.statistics[0].max||a.statistics[0][1]}else"esri.layers.WCSLayer"===c.declaredClass&&(k=ya[c.rasterInfo.pixelType.toLowerCase()],g=k[0],k=k[1]);if(1===d.bandCount)return this._getStretchLegendElements(a,{min:g,max:k});f=f&&f.length>=e?b(f):b();return this._createSymbolTableElementMultiBand(f)};l._getStretchLegendElements=function(a,b){a=H.getStrectchRampStops(a.colorRamp,b);return{type:"stretch-ramp",title:"",infos:a,preview:C.renderColorRampPreviewHTML(a.map(c=>c.color))}};l._createSymbolTableElementMultiBand=
function(a){const b=[],c=["red","green","blue"];a.forEach((d,e)=>{b.push({label:{colorName:c[e],bandName:d},src:ua.RGB_IMG_SOURCE[e],opacity:1})});return b};l._updateInfosforClassedSizeRenderer=function(a,b){const c=a.authoringInfo&&"class-breaks-size"===a.authoringInfo.type,d=a.classBreakInfos.some(e=>ra.isVolumetricSymbol(e.symbol));if(c&&d){const e=L.REAL_WORLD_MAX_SIZE;a=a.classBreakInfos.length;const g=(e-L.REAL_WORLD_MIN_SIZE)/(1<a?a-1:a);b.forEach((f,k)=>{f.size=e-g*k})}};l._isTallSymbol=function(a){let b=
!1,c=!1;if(a)for(let d=0;d<a.length&&(!b||!c);d++){const e=a[d];"size"===e.type&&("height"===e.axis&&(b=!0),"width-and-depth"===e.axis&&(c=!0))}return b&&c};l._getSymbolPreview=async function(a,b,c){var d=null==a.size&&this._hasSizeRamp?la.px2pt(22):a.size;this._scaleDrivenSizeVariable&&null!=c&&c.applyScaleDrivenSize&&({getSize:d}=await new Promise(function(e,g){Q(["../../../renderers/visualVariables/support/visualVariableUtils"],e,g)}),d=d(this._scaleDrivenSizeVariable,null,{view:this.view.type,
scale:this.scale,shape:"simple-marker"===a.symbol.type?a.symbol.style:null}));return C.renderPreviewHTML(a.symbol,{size:d,opacity:b,scale:!1,symbolConfig:null==c?void 0:c.symbolConfig,rotation:a.symbol.angle}).then(e=>{a.preview=e;return a}).catch(()=>{a.preview=null;return a})};l._loadRenderer=async function(a){var b,c;const d=[];var e=this.layer;a=a.clone();this._hasClusterSizeVariable=!1;const g="visualVariables"in a&&(null==(b=a.visualVariables)?void 0:b.some(k=>"size"===k.type&&"outline"!==k.target&&
!I.test(k.valueExpression)));if(a&&"visualVariables"in a&&!g&&"featureReduction"in e&&"cluster"===(null==(c=e.featureReduction)?void 0:c.type)&&(b=G.unwrap(ta.getClusterSizeVariable(this.layerView._effectiveRenderer,this.view)))){e=e.featureReduction;if("clusterMinSize"in e&&"clusterMaxSize"in e){const {clusterMinSize:k,clusterMaxSize:m}=e;b.legendOptions=new pa({showLegend:k!==m})}a.visualVariables=(a.visualVariables||[]).concat([b]);this._hasClusterSizeVariable=!0}const f=await this._getMedianColor(a);
if(F(a)||M(a))e=(a.classBreakInfos||a.uniqueValueInfos).map(k=>this._fetchSymbol(k.symbol,f).then(m=>{k.symbol=m}).catch(()=>{k.symbol=null})),Array.prototype.push.apply(d,e);d.push(this._fetchSymbol(a.symbol||a.defaultSymbol,a.defaultSymbol?null:f).then(k=>{this._applySymbolToRenderer(a,k,E(a))}).catch(()=>{this._applySymbolToRenderer(a,null,E(a))}));return z.eachAlways(d).then(()=>a)};l._applySymbolToRenderer=function(a,b,c){c?a.symbol=b:a.defaultSymbol=b};l._getMedianColor=async function(a){if(!("visualVariables"in
a&&a.visualVariables))return null;a=a.visualVariables.find(d=>"color"===d.type);if(!a)return null;var b=null,c=null;if(a.stops){if(1===a.stops.length)return a.stops[0].color;b=a.stops[0].value;c=a.stops[a.stops.length-1].value}b+=(c-b)/2;({getColor:c}=await new Promise(function(d,e){Q(["../../../renderers/visualVariables/support/visualVariableUtils"],d,e)}));return c(a,b)};l._fetchSymbol=function(a,b){if(!a)return z.reject();if("web-style"===a.type){var c=a.portal;c=a.name+"-"+a.styleName+"-"+a.styleUrl+
"-"+(c&&c.url)+"-"+(c&&c.user&&c.user.username);const d=this._webStyleSymbolCache;d.has(c)||("2d"===this.view.type?d.set(c,a.fetchCIMSymbol()):d.set(c,a.fetchSymbol()));return d.get(c).then(e=>this._getAppliedCloneSymbol(e,b)).catch(()=>{A.warn("Fetching web-style failed!");return z.reject()})}return z.resolve(this._getAppliedCloneSymbol(a,b))};l._getAppliedCloneSymbol=function(a,b){if(!a||!b)return a;a=a.clone();const c=b&&b.toRgba();-1<a.type.indexOf("3d")?this._applyColorTo3dSymbol(a,c):"cim"===
a.type?qa.applyCIMSymbolColor(a,b):a.color&&(a.color=new S(c||a.color));return a};l._applyColorTo3dSymbol=function(a,b){b&&a.symbolLayers.forEach(c=>{c&&(c.material||(c.material={}),c.material.color=new S(b))})};l._getVisualVariableLegendElements=async function(a,b){if(!("visualVariables"in a&&a.visualVariables)||"vector-field"===a.type)return null;var c=a.visualVariables,d=[];const e=[],g=[];for(const m of c)"color"===m.type?d.push(m):"size"===m.type?e.push(m):"opacity"===m.type&&g.push(m);c=[...d,
...e,...g];let f;if(0===d.length&&F(a)&&a.classBreakInfos&&1===a.classBreakInfos.length)var k=(k=a.classBreakInfos[0])&&k.symbol;0===d.length&&E(a)&&(k=a.symbol);k&&(-1<k.type.indexOf("3d")?(d=k.symbolLayers.getItemAt(0),"water"===d.type?G.isSome(d.color)&&(f=d.color):G.isSome(d.material)&&G.isSome(d.material.color)&&(f=d.material.color)):k.url||(f=k.color));return(await z.all(c.map(async m=>{if(!m.legendOptions||!1!==m.legendOptions.showLegend){const h=this._getRampTitle(m,b);let n=null;var y="getField"in
b&&b.getField&&b.getField(m.field);y=y&&ka.isDateField(y);"color"===m.type?(m=await H.getRampStops(m,null,y,a),n={type:"color-ramp",title:h,infos:m,preview:C.renderColorRampPreviewHTML(m.map(t=>t.color))},this._hasColorRamp||(this._hasColorRamp=!(null==n.infos||!n.infos.length))):"size"===m.type&&"outline"!==m.target?I.test(m.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=m):(n={type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(m):h,infos:await L.getRampStops(a,
m,await this._getMedianColor(a),this.scale,this.view.type,y)},this._hasSizeRamp||(this._hasSizeRamp=!(null==n.infos||!n.infos.length))):"opacity"===m.type&&(m=await H.getRampStops(m,f,y),n={type:"opacity-ramp",title:h,infos:m,preview:C.renderColorRampPreviewHTML(m.map(t=>t.color))},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==n.infos||!n.infos.length)));return n&&n.infos?n:null}}))).filter(m=>!!m)};l._getDomainName=function(a,b,c){return a&&"function"!==typeof a?(c=(a="getField"in c&&c.getField&&
c.getField(a))&&"getFieldDomain"in c&&c.getFieldDomain?c.getFieldDomain(a.name):null)&&"coded-value"===c.type?c.getName(b):null:null};l._getClusterTitle=function(a){var b=this.layer;a=a.field;if("featureReduction"in b&&b.featureReduction&&"cluster"===b.featureReduction.type&&(b=b.featureReduction,b=(b="popupTemplate"in b&&b.popupTemplate)&&b.fieldInfos))for(const c of b)if(c.fieldName===a)return"cluster_count"===a?c.label||{showCount:!0}:c.label;return{showCount:!0}};l._getRampTitle=function(a,b){let c=
a.field,d=a.normalizationField,e=!1,g=!1,f=!1;var k=null;c="function"===typeof c?null:c;d="function"===typeof d?null:d;k=a.legendOptions&&a.legendOptions.title;if(null==k)if(a.valueExpressionTitle)k=a.valueExpressionTitle;else{if("renderer"in b&&b.renderer&&"authoringInfo"in b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables)for(a=b.renderer.authoringInfo.visualVariables,k=0;k<a.length;k++){const m=a[k];if("color"===m.type){if("ratio"===m.style){e=!0;break}if("percent"===
m.style){g=!0;break}if("percent-of-total"===m.style){f=!0;break}}}k={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),ratio:e,ratioPercent:g,ratioPercentTotal:f}}return k};l._getRendererTitle=function(a,b){if(a.legendOptions&&a.legendOptions.title)return a.legendOptions.title;if(a.valueExpressionTitle)return a.valueExpressionTitle;let c=a.field,d=null,e=null;F(a)&&(d=a.normalizationField,e="percent-of-total"===a.normalizationType);c="function"===typeof c?null:c;d="function"===
typeof d?null:d;a=null;if(c||d)a={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),normByPct:e};return a};l._getFieldAlias=function(a,b){var c="popupTemplate"in b&&b.popupTemplate;c=c&&c.fieldInfos;let d=null;c&&c.some(g=>a===g.fieldName?(d=g,!0):!1);c=null;"getField"in b&&b.getField?c=b.getField(a):"fieldsIndex"in b&&b.fieldsIndex&&(c=b.fieldsIndex.get(a));b=d||c;let e=null;b&&(e=d&&d.label||c&&c.alias||"name"in b&&b.name||"fieldName"in b&&b.fieldName);return e};l._isUnclassedRenderer=
function(a){const b=a.visualVariables;let c=!1;F(a)&&a.classBreakInfos&&1===a.classBreakInfos.length&&b&&(c=a.field?b.some(d=>!(!d||a.field!==d.field||(a.normalizationField||d.normalizationField)&&a.normalizationField!==d.normalizationField)):!!b.length);return c};R._createClass(K,[{key:"opacity",get:function(){var a;const b=this.layer.opacity,c=null==(a=this.parent)?void 0:a.opacity;a=(a=this.layer.parent)&&"uid"in a?this._getParentLayerOpacity(a):null;return null!=c?c*b:null!=a?a*b:b}},{key:"ready",
get:function(){return null===this.layer?!0:0<this.children.length?this._isGroupActive():0<this.legendElements.length}},{key:"scale",get:function(){return this.view&&this.view.scale}},{key:"isScaleDriven",get:function(){var a=this.layer;if(null===a)return!1;if("featureReduction"in a&&a.featureReduction&&"cluster"===a.featureReduction.type)return!0;if("renderer"in a&&a.renderer){if("dot-density"===a.renderer.type)return!0;const b=a.get("renderer.valueExpression");if(I.test(b))return!0;if(a=a.get("renderer.visualVariables"))return a.some(c=>
this._isScaleDrivenSizeVariable(c))}return this._isLayerScaleDriven(this.layer)}},{key:"version",get:function(){return this._get("version")+1}}]);return K}(ia);v.__decorate([w.property()],u.prototype,"children",void 0);v.__decorate([w.property()],u.prototype,"layerView",void 0);v.__decorate([w.property()],u.prototype,"layer",void 0);v.__decorate([w.property()],u.prototype,"legendElements",void 0);v.__decorate([w.property({dependsOn:["parent","parent.opacity","layer","layer.opacity"],readOnly:!0})],
u.prototype,"opacity",null);v.__decorate([w.property()],u.prototype,"parent",void 0);v.__decorate([w.property({readOnly:!0,dependsOn:[],autoTracked:!1})],u.prototype,"ready",null);v.__decorate([w.property()],u.prototype,"keepCacheOnDestroy",void 0);v.__decorate([w.property()],u.prototype,"respectLayerVisibility",void 0);v.__decorate([w.property({dependsOn:["view.scale"],readOnly:!0})],u.prototype,"scale",null);v.__decorate([w.property()],u.prototype,"sublayerIds",void 0);v.__decorate([w.property({dependsOn:["layer.renderer?.valueExpression?",
"layer.renderer?.visualVariables?","layer.featureReduction?","scale"],readOnly:!0})],u.prototype,"isScaleDriven",null);v.__decorate([w.property()],u.prototype,"title",void 0);v.__decorate([w.property({readOnly:!0,dependsOn:["ready"],autoTracked:!1,value:0})],u.prototype,"version",null);v.__decorate([w.property()],u.prototype,"view",void 0);return u=v.__decorate([fa.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],u)});