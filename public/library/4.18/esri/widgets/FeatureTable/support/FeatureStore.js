// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/lang ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/arrayUtils ../../../core/promiseUtils ../../../core/Accessor ../../../core/Collection ../../../Graphic ../../../tasks/support/AttachmentQuery ../../../tasks/support/Query".split(" "),
function(z,h,g,D,E,L,k,M,F,r,N,O,P,t,n,G,v,H,I,w){function x(u,l,d){J.error(new r(u,l,d))}const J=E.getLogger("esri.widgets.FeatureTable.support.FeatureStore");g=function(u){function l(a){a=u.call(this,a)||this;a._loaded=!1;a._loadError=!1;a._loading=!1;a._editOperationQueue=[];a._queryOperationQueue=[];a._objectIds=new v;a._hasStaleCache=!1;a.attachmentsEnabled=!1;a.count=0;a.failures=new v;a.itemCache=new v;a.relatedRecordsEnabled=!1;return a}z._inheritsLoose(l,u);var d=l.prototype;d.destroy=function(){this.layer=
null;this.itemCache&&this.itemCache.destroy();this.failures&&this.failures.destroy();this._set("itemCache",null)};d.load=async function(){this._reset();const {layer:a}=this;if(!a)return n.resolve();this._loading=!0;this.notifyChange("state");try{await a.when(),await this._syncLayerInfo(),this._loading=!1,this._loaded=!0,this.notifyChange("state")}catch(b){throw this._reset(),this._loadError=!0,this.notifyChange("state"),x("store:load-error","An error ocurred.",{error:b}),b;}};d.addItems=async function(a){};
d.fetchItems=async function(a){const {page:b,pageSize:c}=a;a=b*c;const e=a+c,{layer:f,state:p}=this;if(!f||"loaded"!==p)return n.resolve([]);this.notifyChange("querying");a=await this._query({start:a,num:e,page:b,pageSize:c});this.notifyChange("state");return a};d.query=async function(a){const {layer:b,state:c}=this;if(!b||"loaded"!==c)return[];this.notifyChange("querying");a=await this._query(a);this.notifyChange("state");return a};d.removeItemAt=async function(a){};d.reset=async function(){this._reset()};
d.updateItem=async function(a){return this._update(a)};d.getItemByObjectId=function(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.find(e=>e.feature.attributes[c]===a)};d.getLocalItemAt=function(a){return this.itemCache.getItemAt(a)};d.getItemAt=function(a){return n.resolve(this.itemCache.getItemAt(a))};d.getObjectIdIndex=function(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.findIndex(e=>e.feature.attributes[c]===a)};d._reset=function(){this.itemCache.removeAll();this.failures.removeAll();
this._editOperationQueue=[];this._queryOperationQueue=[];this._loadError=this._loaded=this._loading=this._hasStaleCache=!1;this._set("count",0);this._objectIds.removeAll();this.notifyChange("querying");this.notifyChange("syncing");this.notifyChange("state")};d._getIdsFromFeatures=function(a){return a.map(b=>b.attributes[this.layer.objectIdField])};d._toFeatureData=function(a,b){const {layer:{objectIdField:c}}=this;return a.map(e=>{var {attributes:f}=e;f=f[c];return{objectId:f,feature:e,attachments:b?
b[f]:null,relatedRecords:null}})};d._update=async function(a){const {layer:b}=this,{operations:c}=b.capabilities;if(!c.supportsUpdate)throw new r("store:update-error","Update is not supported.");const {index:e,name:f,value:p}=a;a=await this.getItemAt(e);if(!a||!a.feature)throw new r("store:update-error","Feature with provided 'objectId' not found.");const {feature:q}=a,m=D.clone(q.attributes);m[f]=p;a=new H({attributes:m});const C=b.applyEdits({updateFeatures:[a]}).then(A=>{const {updateFeatureResults:y}=
A,B=y.find(K=>!!K.error);if(B)throw B.error;-1<this._editOperationQueue.indexOf(()=>C)&&y&&y.length&&(q.attributes=m);return A});return this._queueEditOperation(()=>C)};d._query=async function(a){const {refresh:b}=a;if(!0===b)return this.itemCache.removeAll(),this._syncLayerInfo().then(()=>this._queryFeatureData(a));this._hasStaleCache&&(await this._updateIds(),this._hasStaleCache=!1);return this._queryFeatureData(a)};d._queryFeatureData=async function(a){return this._queueQueryOperation(async()=>
{const {features:b}=await this._queryFeatures(a);var c=this._getIdsFromFeatures(b);c=await this._queryAttachments(c);return this._toFeatureData(b,c)||[]})};d._syncLayerInfo=async function(){await this._updateCount();await this._updateIds()};d._updateCount=async function(){await this._queryCount().then(a=>this._set("count",a))};d._updateIds=async function(){var a,b,c;null!=(a=this.layer)&&null!=(b=a.capabilities)&&null!=(c=b.query)&&c.supportsPagination||(this._objectIds.removeAll(),await this._queryObjectIds().then(e=>
this._objectIds.addMany(e)))};d._queryCount=function(){const {layer:a}=this;return a.queryFeatureCount(new w({returnGeometry:!1,where:this._getWhere()}))};d._queryObjectIds=function(){const {layer:a,orderByFields:b}=this,{capabilities:{query:{supportsCacheHint:c,supportsOrderBy:e}}}=a,f=new w({outFields:[a.objectIdField],returnGeometry:!1,where:this._getWhere()});e&&(f.orderByFields=b);c&&(f.cacheHint=!0);return a.queryObjectIds(f)};d._queryFeatures=async function(a){const {layer:b}=this;if(!b.capabilities.operations.supportsQuery)return n.reject(new r("store:query-error",
"Layer does not support query operation."));const {layer:{capabilities:{query:{supportsCacheHint:c,supportsOrderBy:e,supportsPagination:f}}},orderByFields:p}=this,{start:q,num:m}=a;a=new w({returnGeometry:!1,outFields:["*"]});f?(a.start=q,a.num=m,a.where=this._getWhere()):a.objectIds=this._getObjectIdsForPage(q,m);e&&(a.orderByFields=p);c&&(a.cacheHint=!0);return b.queryFeatures(a)};d._getObjectIdsForPage=function(a,b){const c=this._objectIds.toArray();return c.length>=a+b?c.slice(a,a+b):c.slice(a)};
d._queryAttachments=function(a){const {attachmentsEnabled:b,layer:c}=this,{capabilities:{data:{supportsAttachment:e},operations:{supportsQueryAttachments:f}}}=c;return b&&e&&f?c.queryAttachments(new I({objectIds:a,where:this._getWhere()})):n.resolve(null)};d._queueQueryOperation=function(a){this._queryOperationQueue.push(a);this.notifyChange("querying");return a().then(b=>-1<this._queryOperationQueue.indexOf(a)?(this.itemCache.addMany(b),b):[]).catch(b=>{x("store:query-error","An error ocurred.",
{error:b});const c={error:b,retry:()=>{this.failures.remove(c);this._queueQueryOperation(a)},cancel:()=>this.failures.remove(c)};this.failures.add(c);return[]}).then(b=>{t.remove(this._queryOperationQueue,a);this.notifyChange("querying");return b})};d._queueEditOperation=function(a){this._editOperationQueue.push(a);this.notifyChange("syncing");return a().then(()=>{t.remove(this._editOperationQueue,a);this.notifyChange("syncing")}).catch(b=>{x("store:edit-error","An error ocurred.",{error:b});const c=
{error:b,retry:()=>{this.failures.remove(c);this._queueEditOperation(a)},cancel:()=>this.failures.remove(c)};this.failures.add(c);t.remove(this._editOperationQueue,a);this.notifyChange("syncing");throw b;})};d._getWhere=function(){return this.where||this.layer.definitionExpression||"1\x3d1"};z._createClass(l,[{key:"layer",get:function(){return this._get("layer")||null},set:function(a){this._reset();this._set("layer",a);this.notifyChange("state")}},{key:"orderByFields",get:function(){return this._get("orderByFields")||
[]},set:function(a){t.equals(a,this.orderByFields)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",a))}},{key:"querying",get:function(){return 0<this._queryOperationQueue.length}},{key:"state",get:function(){const {layer:a,_loaded:b,_loadError:c,_loading:e}=this;return c?"error":!a||this.get("layer.loadError")?"disabled":e?"loading":"loaded"===this.get("layer.loadStatus")&&b?"loaded":"ready"}},{key:"syncing",get:function(){return 0<this._editOperationQueue.length}},{key:"where",
get:function(){return this._get("where")||null},set:function(a){this._reset();this._set("where",a);this.notifyChange("state")}}]);return l}(G);h.__decorate([k.property()],g.prototype,"attachmentsEnabled",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"count",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"failures",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"itemCache",void 0);h.__decorate([k.property()],g.prototype,"layer",null);h.__decorate([k.property()],
g.prototype,"orderByFields",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"querying",null);h.__decorate([k.property()],g.prototype,"relatedRecordsEnabled",void 0);h.__decorate([k.property({readOnly:!0,dependsOn:["layer","layer.loadError","layer.loadStatus"]})],g.prototype,"state",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"syncing",null);h.__decorate([k.property()],g.prototype,"where",null);return g=h.__decorate([F.subclass("esri.widgets.FeatureTable.support.FeatureStore")],
g)});