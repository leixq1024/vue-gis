// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/Error ../../../core/promiseUtils ../../../layers/support/fieldUtils ../../../request ../../../tasks/support/StatisticDefinition ../../../tasks/support/Query ../../../tasks/QueryTask ./featureUtils".split(" "),function(h,v,n,m,p,w,x,q,y,z){function A(b,a){if(!a.relationships)return null;let c=null;({relationships:a}=a);a.some(e=>e.id===parseInt(b,10)?(c=e,!0):!1);return c}function r({originRelationship:b,relationships:a,layerId:c}){let e;a&&a.some(d=>
{`${d.relatedTableId}`===c&&d.id===b.id&&(e=d);return!!e});return e}async function B(b,a,c,e){var d;c=c.layerId.toString();const {layerInfo:f,queryTask:k,relation:l}=a;if(c=null==(d=r({originRelationship:l,relationships:f.relationships,layerId:c}))?void 0:d.keyField){d=p.isNumericField(p.getField(f.fields,c));a:{b=b.attributes;const C=l.keyField.toLowerCase();for(g in b)if(g.toLowerCase()===C){var g=b[g];break a}g=null}g=d?`${c}=${g}`:`${c}='${g}'`;c=k.execute(new q({where:g,outFields:a.relatedFields}),
e);a=a.outStatistics&&0<a.outStatistics.length&&f.supportsStatistics?k.execute(new q({where:g,outFields:a.relatedFields,outStatistics:a.outStatistics}),e):null;e={features:c};a&&(e.statsFeatures=a);return m.eachAlways(e)}return null}const t=v.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),u=new Map;h.createRelatedInfo=function(b,a){if(b=A(b,a)){var c=`${a.url}/${b.relatedTableId}`;a=new y({url:c,sourceSpatialReference:a.spatialReference});return{url:c,queryTask:a,relation:b,relatedFields:[],
outStatistics:[]}}};h.getDestinationRelation=r;h.getRelatedFieldInfo=function(b){if(!z.isRelatedField(b))return null;const [a,c]=b.split("/").slice(1);return{layerId:a,fieldName:c}};h.queryLayerInfos=function({relatedInfos:b,layer:a},c){const e={};b.forEach((d,f)=>{({relation:d}=d);if(!d)throw f=new n("relation-required","A relation is required on a layer to retrieve related records."),t.error(f),f;({relatedTableId:d}=d);if("number"!==typeof d)throw f=new n("A related table ID is required on a layer to retrieve related records."),
t.error(f),f;d=`${a.url}/${d}`;const k=u.get(d),l=k?k:w(d,{query:{f:"json"},signal:c&&c.signal});k||u.set(d,l);e[f]=l});return m.eachAlways(e)};h.queryRelatedFeatures=function({graphic:b,relatedInfos:a,layer:c},e){const d={};a.forEach((f,k)=>{f.layerInfo&&(d[k]=B(b,f,c,e))});return m.eachAlways(d)};h.setRelatedFeatures=function(b,a){if(a&&b){var {features:c,statsFeatures:e}=b;b=c&&c.value;a.relatedFeatures=b?b.features:[];b=e&&e.value;a.relatedStatsFeatures=b?b.features:[]}};h.updateRelatedInfo=function({relatedInfo:b,
fieldName:a,fieldInfo:c}){b.relatedFields.push(a);c.statisticType&&(a=new x({statisticType:c.statisticType,onStatisticField:a,outStatisticFieldName:a}),b.outStatistics.push(a))};Object.defineProperty(h,"__esModule",{value:!0})});