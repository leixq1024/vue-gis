// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../core/promiseUtils ../../core/Accessor ../../popup/content/TextContent ../../Graphic ../../core/Handles ../../core/watchUtils ../../core/throttle ./support/featureUtils ../Attachments/AttachmentsViewModel ./FeatureContent/FeatureContentViewModel ./FeatureFields/FeatureFieldsViewModel ./support/relatedFeatureUtils ./FeatureMedia/FeatureMediaViewModel ./support/arcadeFeatureUtils".split(" "),
function(v,l,h,z,D,P,m,Q,E,R,S,T,y,F,G,H,I,J,K,n,L,A,M,u,w,N){const O=D.getLogger("esri.widgets.FeatureViewModel");h=function(B){function x(a){var b=B.call(this,a)||this;b._handles=new I;b._featureAbortController=null;b.graphicChangedThrottled=K.throttle(b.graphicChanged,1,v._assertThisInitialized(b));b.content=null;b.contentViewModels=[];b.defaultPopupTemplateEnabled=!1;b.formattedAttributes=null;b.lastEditInfo=null;b.relatedInfos=new Map;b.title="";b.view=null;b._handles.add(J.init(v._assertThisInitialized(b),
["graphic","_effectivePopupTemplate"],()=>b.graphicChangedThrottled()));return b}v._inheritsLoose(x,B);var f=x.prototype;f.destroy=function(){this._clear();this._cancelFeatureQuery();this._handles.destroy();this.graphic=this._handles=null;this._destroyContentViewModels();this.relatedInfos.clear()};f.setActiveMedia=function(a,b){a=this.contentViewModels[a];a instanceof w&&a.setActiveMedia(b)};f.nextMedia=function(a){a=this.contentViewModels[a];a instanceof w&&a.next()};f.previousMedia=function(a){a=
this.contentViewModels[a];a instanceof w&&a.previous()};f._clear=function(){this._set("title","");this._set("content",null);this._set("formattedAttributes",null)};f.graphicChanged=async function(){this._cancelFeatureQuery();this._clear();const {graphic:a}=this;if(a){var b=y.createAbortController();this._featureAbortController=b;try{await this._queryFeature({signal:b.signal})}catch(c){O.error("error","error loading popupTemplate for graphic",{error:c,graphic:a})}this._featureAbortController===b&&(this._featureAbortController=
null)}};f._cancelFeatureQuery=function(){const {_featureAbortController:a}=this;a&&a.abort();this._featureAbortController=null};f._compileContent=function(a){this._destroyContentViewModels();if(this.graphic)return Array.isArray(a)?a.map((b,c)=>{if("attachments"===b.type)return this._compileAttachments(b,c);if("custom"===b.type)return this._compileCustom(b,c);if("fields"===b.type)return this._compileFields(b,c);if("media"===b.type)return this._compileMedia(b,c);if("text"===b.type)return this._compileText(b,
c)}):"string"===typeof a?this._compileText(new G({text:a}),0).text:a};f._destroyContentViewModels=function(){this.contentViewModels.forEach(a=>a&&!a.destroyed&&a.destroy());this._set("contentViewModels",[])};f._compileAttachments=function(a,b){const {graphic:c}=this;this.contentViewModels[b]=new L({graphic:c});return a};f._compileCustom=function(a,b){const {graphic:c}=this,{creator:d,destroyer:e}=a;this.contentViewModels[b]=new A({graphic:c,creator:d,destroyer:e});return a};f._compileFields=function(a,
b){const {_effectivePopupTemplate:c,formattedAttributes:d}=this,e=a.clone();a=new M({attributes:{...d.global,...d.content[b]},expressionInfos:null==c?void 0:c.expressionInfos,fieldInfos:(null==a?void 0:a.fieldInfos)||(null==c?void 0:c.fieldInfos)});this.contentViewModels[b]=a;e.fieldInfos=a.formattedFieldInfos.slice(0);return e};f._compileMedia=function(a,b){const {graphic:c,_fieldInfoMap:d,_effectivePopupTemplate:e,relatedInfos:g,_sourceLayer:q}=this;var {attributes:p}=c;const r=this.formattedAttributes.global;
a=a.clone();const {mediaInfos:k}=a;p=new w({activeMediaInfoIndex:a.activeMediaInfoIndex||0,attributes:p,layer:q,fieldInfoMap:d,formattedAttributes:r,mediaInfos:k,popupTemplate:e,relatedInfos:g});a.mediaInfos=p.formattedMediaInfos.slice(0);this.contentViewModels[b]=p;return a};f._compileText=function(a,b){a=a.clone();const {graphic:c,_fieldInfoMap:d,_sourceLayer:e}=this;if(a&&a.text){var {attributes:g}=c;const q=this.formattedAttributes.global;g=n.processFieldsInLinks(a.text,{...q,...g},e);a.text=
n.substituteAttributes({formattedAttributes:q,template:g,fieldInfoMap:d})}this.contentViewModels[b]=new A({graphic:c,creator:a.text});return a};f._compileLastEditInfo=function(){const {_effectivePopupTemplate:a,_sourceLayer:b,graphic:c}=this;if(a){var {lastEditInfoEnabled:d}=a,e=null==b?void 0:b.editFieldsInfo;if(d&&e)return n.formatEditInfo(e,c.attributes)}};f._compileTitle=function(a){const {_fieldInfoMap:b,_sourceLayer:c,graphic:d}=this,{attributes:e}=d,g=this.formattedAttributes.global;return a?
(a=n.processFieldsInLinks(a,{...g,...e},c),n.substituteAttributes({formattedAttributes:g,template:a,fieldInfoMap:b})):""};f._getTitle=async function(){const {_effectivePopupTemplate:a,graphic:b}=this;return n.graphicCallback(null==a?void 0:a.title,{graphic:b})};f._getContent=async function(){const {_effectivePopupTemplate:a,graphic:b}=this;return n.graphicCallback(null==a?void 0:a.content,{graphic:b})};f._queryFeature=async function(a){const {_featureAbortController:b,_sourceLayer:c,graphic:d,_effectivePopupTemplate:e,
spatialReference:g,map:q}=this,{content:{value:p},title:{value:r}}=await y.eachAlways({content:this._getContent(),title:this._getTitle()});b===this._featureAbortController&&d&&({expressionAttributes:{value:a}}=await y.eachAlways({checkForRelatedFeatures:this._checkForRelatedFeatures(a),expressionAttributes:N.createFormattedExpressions({popupTemplate:this._effectivePopupTemplate,spatialReference:g,graphic:d,map:q}),queryUpdatedFeature:n.queryUpdatedFeature({graphic:d,popupTemplate:e,layer:c},a)}),
b===this._featureAbortController&&d&&(this._set("formattedAttributes",this._createFormattedAttributes(p,a)),this._set("title",this._compileTitle(r)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(p)||null)))};f._createFormattedAttributes=function(a,b){const {_effectivePopupTemplate:c,graphic:d,relatedInfos:e,_sourceLayer:g,_fieldInfoMap:q}=this,p={...d.attributes,...b},r={global:n.formatAttributes({fieldInfos:null==c?void 0:c.fieldInfos,graphic:d,
attributes:p,layer:g,fieldInfoMap:q,relatedInfos:e}),content:[]};Array.isArray(a)&&a.forEach((k,t)=>{"fields"===k.type&&k.fieldInfos&&(r.content[t]=n.formatAttributes({fieldInfos:k.fieldInfos,graphic:d,attributes:p,layer:g,fieldInfoMap:q,relatedInfos:e}))});return r};f._checkForRelatedFeatures=function(a){const {graphic:b,_effectivePopupTemplate:c}=this;return this._queryRelatedInfos(b,n.getAllFieldInfos(c),a)};f._queryRelatedInfos=async function(a,b,c){const {relatedInfos:d,_sourceLayer:e}=this;
d.clear();const g=z.isSome(e.associatedLayer)?await e.associatedLayer.load(c):e;if(g){var q=b.filter(k=>k&&n.isRelatedField(k.fieldName));if(q&&q.length){b.forEach(k=>this._configureRelatedInfo(k,g));var p=await u.queryLayerInfos({relatedInfos:d,layer:g},c);Object.keys(p).forEach(k=>{var t;const C=d.get(k.toString());k=null==(t=p[k])?void 0:t.value;C&&k&&(C.layerInfo=k.data)});var r=await u.queryRelatedFeatures({graphic:a,relatedInfos:d,layer:g},c);Object.keys(r).forEach(k=>{var t;u.setRelatedFeatures(null==
(t=r[k])?void 0:t.value,d.get(k.toString()))})}}};f._configureRelatedInfo=function(a,b){const {relatedInfos:c}=this,d=u.getRelatedFieldInfo(a.fieldName);if(d){var {layerId:e,fieldName:g}=d;e&&(b=c.get(e.toString())||u.createRelatedInfo(e,b))&&(u.updateRelatedInfo({relatedInfo:b,fieldName:g,fieldInfo:a}),this.relatedInfos.set(e,b))}};v._createClass(x,[{key:"_effectivePopupTemplate",get:function(){return z.isSome(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):
null}},{key:"_fieldInfoMap",get:function(){return n.createfieldInfoMap(n.getAllFieldInfos(this._effectivePopupTemplate),this._sourceLayer)}},{key:"_sourceLayer",get:function(){return n.getSourceLayer(this.graphic)}},{key:"graphic",set:function(a){this._set("graphic",a?a.clone():null)}},{key:"spatialReference",get:function(){return this.get("view.spatialReference")||null},set:function(a){void 0===a?this._clearOverride("spatialReference"):this._override("spatialReference",a)}},{key:"map",get:function(){return this.get("view.map")||
null},set:function(a){void 0===a?this._clearOverride("map"):this._override("map",a)}},{key:"waitingForContent",get:function(){return!!this._featureAbortController}}]);return x}(F);l.__decorate([m.property()],h.prototype,"_featureAbortController",void 0);l.__decorate([m.property({readOnly:!0,dependsOn:"graphic graphic.sourceLayer.popupTemplate.title graphic.sourceLayer.popupTemplate.content graphic.sourceLayer.popupTemplate.expressionInfos graphic.sourceLayer.popupTemplate.fieldInfos graphic.sourceLayer.popupTemplate.lastEditInfoEnabled graphic.sourceLayer.popupTemplate.outFields graphic.sourceLayer.popupTemplate.relatedRecordsInfo graphic.popupTemplate.title graphic.popupTemplate.content graphic.popupTemplate.expressionInfos graphic.popupTemplate.fieldInfos graphic.popupTemplate.lastEditInfoEnabled graphic.popupTemplate.outFields graphic.popupTemplate.relatedRecordsInfo defaultPopupTemplateEnabled".split(" ")})],
h.prototype,"_effectivePopupTemplate",null);l.__decorate([m.property({readOnly:!0,dependsOn:["_effectivePopupTemplate","_sourceLayer"]})],h.prototype,"_fieldInfoMap",null);l.__decorate([m.property({readOnly:!0,dependsOn:["graphic.layer","graphic.sourceLayer"]})],h.prototype,"_sourceLayer",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"content",void 0);l.__decorate([m.property({readOnly:!0})],h.prototype,"contentViewModels",void 0);l.__decorate([m.property({type:Boolean})],h.prototype,
"defaultPopupTemplateEnabled",void 0);l.__decorate([m.property({readOnly:!0})],h.prototype,"formattedAttributes",void 0);l.__decorate([m.property({type:H,value:null})],h.prototype,"graphic",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"lastEditInfo",void 0);l.__decorate([m.property()],h.prototype,"relatedInfos",void 0);l.__decorate([m.property({dependsOn:["view"]})],h.prototype,"spatialReference",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"title",void 0);l.__decorate([m.property({dependsOn:["view"]})],
h.prototype,"map",null);l.__decorate([m.property({readOnly:!0,dependsOn:["_featureAbortController"]})],h.prototype,"waitingForContent",null);l.__decorate([m.property()],h.prototype,"view",void 0);return h=l.__decorate([E.subclass("esri.widgets.FeatureViewModel")],h)});