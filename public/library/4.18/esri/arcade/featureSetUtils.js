// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../core/promiseUtils ../kernel ../request ../portal/Portal ../portal/PortalItem ./featureset/support/shared ./featureSetCollection ./featureset/support/cache ../core/sql/WhereClause ./featureset/actions/AttributeFilter ./featureset/actions/OrderBy ./featureset/actions/GroupBy ./featureset/actions/SpatialFilter ./featureset/actions/Top ../layers/FeatureLayer ./featureset/sources/FeatureLayerDynamic ./featureset/sources/FeatureLayerMemory ./featureset/sources/FeatureLayerRelated".split(" "),
function(r,x,n,D,w,E,F,A,B,m,G,H,I,J,K,L,t,M,N,O){function y(d,f){if(m.applicationCache){var e=m.applicationCache.getLayerInfo(d);if(e)return e.then(g=>n.resolve(new t({url:d,outFields:f,sourceJSON:g})));const b=new t({url:d,outFields:f});e=n.create((g,c)=>{b.load().then(()=>{g(b.sourceJSON)},k=>{c(k)})});m.applicationCache&&(m.applicationCache.setLayerInfo(d,e),e=e.catch(g=>{m.applicationCache.clearLayerInfo(d);throw g;}));return e.then(()=>n.resolve(b))}return n.resolve(new t({url:d,outFields:f}))}
function z(d,f,e,b,g){return y(d,["*"]).then(c=>n.resolve(v(c,f,e,b,g)))}function v(d,f=null,e=null,b=!0,g=null){return!0===d._hasMemorySource()?new N({layer:d,spatialReference:f,outFields:e,includeGeometry:b,lrucache:g}):new M({layer:d,spatialReference:f,outFields:e,includeGeometry:b,lrucache:g})}function P(d){if(null!==m.applicationCache){var f=m.applicationCache.getLayerInfo(d);if(null!==f)return f}f=w(d,{responseType:"json",query:{f:"json"}}).then(e=>e.data?n.resolve(e.data):n.resolve(null));
null!==m.applicationCache&&(m.applicationCache.setLayerInfo(d,f),f=f.catch(e=>{m.applicationCache.clearLayerInfo(d);throw e;}));return f}function Q(d,f){const e="QUERYDATAELEMTS:"+f.toString()+":"+d;if(null!==m.applicationCache){const b=m.applicationCache.getLayerInfo(e);if(null!==b)return b}d=w(d+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([f.toString()]),f:"json"}}).then(b=>{if(b.data&&(b=b.data,b.layerDataElements&&b.layerDataElements[0]))return b.layerDataElements[0];
throw Error("Not Found");});null!==m.applicationCache&&(m.applicationCache.setLayerInfo(e,d),d=d.catch(b=>{m.applicationCache.clearLayerInfo(e);throw b;}));return d}function C(d){if(null!==m.applicationCache){var f=m.applicationCache.getLayerInfo(d);if(null!==f)return f}f=w(d,{responseType:"json",query:{f:"json"}}).then(e=>e.data?(e=e.data,e.layers||(e.layers=[]),e.tables||(e.tables=[]),n.resolve(e)):n.resolve({layers:[],tables:[]}));null!==m.applicationCache&&(m.applicationCache.setLayerInfo(d,f),
f=f.catch(e=>{m.applicationCache.clearLayerInfo(d);throw e;}));return f}H.registerAction();J.registerAction();I.registerAction();K.registerAction();L.registerAction();let R=function(d){function f(b,g=null,c=null){var k=d.call(this)||this;k._map=b;k._overridespref=g;k.lrucache=c;k._instantLayers=[];return k}x._inheritsLoose(f,d);var e=f.prototype;e.makeAndAddFeatureSet=function(b,g=!0,c=null){const k=v(b,this._overridespref,null===c?["*"]:c,g,this.lrucache);this._instantLayers.push({featureset:k,opitem:b,
includeGeometry:g,outFields:JSON.stringify(c)});return k};e.featureSetByName=function(b,g=!0,c=null){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetByName(b,g,c)}catch(a){return n.reject(a)}});null===c&&(c=["*"]);c=c.slice(0);c=c.sort();var k=JSON.stringify(c);for(let a=0;a<this._instantLayers.length;a++){const h=this._instantLayers[a];if(h.opitem.title===b&&h.includeGeometry===g&&h.outFields===k)return this.resolvePromise(this._instantLayers[a].featureset)}if(k=
this._map.layers.find(a=>a instanceof t&&a.title===b?!0:!1))return this.resolvePromise(this.makeAndAddFeatureSet(k,g,c));if(this._map.tables){const a=this._map.tables.find(h=>h.title&&h.title===b||h.title&&h.title===b?!0:!1);if(a){if(a instanceof t)return this.resolvePromise(this.makeAndAddFeatureSet(a,g,c));a._materializedTable||(a._materializedTable=new t(a.outFields?a:{...a,outFields:["*"]}));return a._materializedTable.load().then(()=>this.resolvePromise(this.makeAndAddFeatureSet(a._materializedTable,
g,c)))}}return this.resolvePromise(null)};e.featureSetById=function(b,g=!0,c=["*"]){if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(()=>{try{return this.featureSetById(b,g,c)}catch(a){return n.reject(a)}});null===c&&(c=["*"]);c=c.slice(0);c=c.sort();var k=JSON.stringify(c);for(let a=0;a<this._instantLayers.length;a++){const h=this._instantLayers[a];if(h.opitem.id===b&&h.includeGeometry===g&&h.outFields===k)return this.resolvePromise(this._instantLayers[a].featureset)}if(k=
this._map.layers.find(a=>a instanceof t&&a.id===b?!0:!1))return this.resolvePromise(this.makeAndAddFeatureSet(k,g,c));if(this._map.tables){const a=this._map.tables.find(h=>h.id===b?!0:!1);if(a){if(a instanceof t)return this.resolvePromise(this.makeAndAddFeatureSet(a,g,c));a._materializedTable||(a._materializedTable=new t({...a,outFields:["*"]}));return a._materializedTable.load().then(()=>this.resolvePromise(this.makeAndAddFeatureSet(a._materializedTable,g,c)))}}return this.resolvePromise(null)};
return f}(B),S=function(d){function f(b,g=null,c=null){var k=d.call(this)||this;k._url=b;k._overridespref=g;k.lrucache=c;k.metadata=null;k._instantLayers=[];return k}x._inheritsLoose(f,d);var e=f.prototype;e.makeAndAddFeatureSet=function(b,g=!0,c=null){const k=v(b,this._overridespref,null===c?["*"]:c,g,this.lrucache);this._instantLayers.push({featureset:k,opitem:b,includeGeometry:g,outFields:JSON.stringify(c)});return k};e._loadMetaData=function(){return C(this._url).then(b=>this.metadata=b)};e.load=
function(){return this._loadMetaData()};e.clone=function(){return new f(this._url,this._overridespref,this.lrucache)};e.featureSetByName=function(b,g=!0,c=null){null===c&&(c=["*"]);c=c.slice(0);c=c.sort();const k=JSON.stringify(c);for(let a=0;a<this._instantLayers.length;a++){const h=this._instantLayers[a];if(h.opitem.title===b&&h.includeGeometry===g&&h.outFields===k)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then(a=>{let h=null;for(const l of a.layers?
a.layers:[])l.name===b&&(h=l);if(!h)for(const l of a.tables?a.tables:[])l.name===b&&(h=l);return h?y(this._url+"/"+h.id,["*"]).then(l=>this.makeAndAddFeatureSet(l,g,c)):this.resolvePromise(null)})};e.featureSetById=function(b,g=!0,c=["*"]){null===c&&(c=["*"]);c=c.slice(0);c=c.sort();const k=JSON.stringify(c);b=null!==b&&void 0!==b?b.toString():"";for(let a=0;a<this._instantLayers.length;a++){const h=this._instantLayers[a];if(h.opitem.id===b&&h.includeGeometry===g&&h.outFields===k)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then(a=>
{let h=null;for(const l of a.layers?a.layers:[])null!==l.id&&void 0!==l.id&&l.id.toString()===b&&(h=l);if(!h)for(const l of a.tables?a.tables:[])null!==l.id&&void 0!==l.id&&l.id.toString()===b&&(h=l);return h?y(this._url+"/"+h.id,["*"]).then(l=>this.makeAndAddFeatureSet(l,g,c)):this.resolvePromise(null)})};x._createClass(f,[{key:"url",get:function(){return this._url}}]);return f}(B);r.constructAssociationMetaDataFeatureSetFromUrl=function(d,f){var e=3,b=[],g=null,c={},k=null;return C(d).then(a=>{if(a.controllerDatasetLayers&&
void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers)for(const l of a.layers)c[l.id]=l.name;if(a.tables)for(const l of a.tables)c[l.id]=l.name;const h=a.controllerDatasetLayers.utilityNetworkLayerId;return Q(d,h).then(l=>{if(l){(g=l)&&g.dataElement&&void 0!==g.dataElement.schemaGeneration&&(e=g.dataElement.schemaGeneration);k={};g.dataElement.domainNetworks||(g.dataElement.domainNetworks=[]);for(const q of g.dataElement.domainNetworks){for(const p of q.edgeSources?
q.edgeSources:[])l={layerId:p.layerId,sourceId:p.sourceId,className:c[p.layerId]?c[p.layerId]:null},l.className&&(k[l.className]=l);for(const p of q.junctionSources?q.junctionSources:[])l={layerId:p.layerId,sourceId:p.sourceId,className:c[p.layerId]?c[p.layerId]:null},l.className&&(k[l.className]=l)}if(g.dataElement.terminalConfigurations)for(const q of g.dataElement.terminalConfigurations)for(const p of q.terminals)b.push({terminalId:p.terminalId,terminalName:p.terminalName});return P(d+"/"+h).then(q=>
{if(q.systemLayers&&void 0!==q.systemLayers.associationsTableId&&null!==q.systemLayers.associationsTableId){const p=[];4<=e&&(p.push("STATUS"),p.push("PERCENTALONG"));return z(d+"/"+q.systemLayers.associationsTableId.toString(),f,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...p],!1,null).then(u=>u.load()).then(u=>4<=e?(u=u.filter(G.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",
u.getFieldsIndex())),u.load()):u).then(u=>({lkp:k,associations:u,unVersion:e,terminals:b}))}return{associations:null,unVersion:e,lkp:null,terminals:[]}})}return{associations:null,unVersion:e,lkp:null,terminals:[]}})}return{associations:null,unVersion:e,lkp:null,terminals:[]}})};r.constructFeatureSet=v;r.constructFeatureSetFromPortalItem=function(d,f,e,b,g,c,k){if(m.applicationCache){const a=m.applicationCache.getLayerInfo(d+":"+c.url);if(a)return a.then(h=>{try{const l=new t({url:A.extractServiceUrl(h.url)+
"/"+f,outFields:["*"]});return n.resolve(v(l,e,b,g,k))}catch(l){return n.reject(l)}},h=>n.reject(h))}return n.create((a,h)=>{const l=(new F({id:d,portal:c})).load();m.applicationCache&&m.applicationCache.setLayerInfo(d+":"+c.url,l);l.then(q=>{try{const p=new t({url:A.extractServiceUrl(q.url)+"/"+f,outFields:["*"]});a(v(p,e,b,g,k))}catch(p){h(p)}},q=>{m.applicationCache&&m.applicationCache.clearLayerInfo(d+":"+c.url);h(q)})})};r.constructFeatureSetFromRelationship=function(d,f,e,b=null,g=null,c=!0,
k=null){let a=d.serviceUrl();if(!a)return null;a="/"===a.charAt(a.length-1)?a+f.relatedTableId.toString():a+"/"+f.relatedTableId.toString();return z(a,b,g,c,k).then(h=>new O({layer:d,relatedLayer:h,relationship:f,objectId:e,spatialReference:b,outFields:g,includeGeometry:c,lrucache:k}))};r.constructFeatureSetFromUrl=z;r.createFeatureSetCollectionFromMap=function(d,f,e=null){return new R(d,f,e)};r.createFeatureSetCollectionFromService=function(d,f,e=null){return new S(d,f,e)};r.getPortal=function(d,
f){return null===d?f:new E({url:d.field("url")})};r.initialiseMetaDataCache=function(){null===m.applicationCache&&(m.applicationCache=new m)};r.lookupUser=function(d,f,e){return D.id.findCredential(d.restUrl)?"loaded"===d.loadStatus&&""===f&&d.user&&d.user.sourceJSON&&!1===e?n.resolve(d.user.sourceJSON):""===f?w(d.restUrl+"/community/self",{responseType:"json",query:{f:"json",...!1===e?{}:{returnUserLicenseTypeExtensions:!0}}}).then(b=>b.data&&(b=b.data)&&b.username?n.resolve(b):n.resolve(null)):
w(d.restUrl+"/community/users/"+f,{responseType:"json",query:{f:"json"}}).then(b=>b.data?(b=b.data,b.error?null:n.resolve(b)):n.resolve(null)):n.resolve(null)};Object.defineProperty(r,"__esModule",{value:!0})});