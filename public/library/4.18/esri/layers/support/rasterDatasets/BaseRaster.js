// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../core/JSONSupport ../../../geometry/Point ../../../geometry/Extent ../../../geometry ../../../request ../../../core/Promise ../arcgisLayerUrl ../commonProperties ../TileInfo ../rasterFormats/RasterCodec ../rasterFunctions/pixelUtils ../RasterStorageInfo ../rasterFunctions/rasterProjectionHelper ./RawBlockCache".split(" "),
function(K,y,u,C,T,ea,A,fa,U,L,ha,ia,ja,B,V,G,M,ka,W,X,Y,Z,N,aa,O,ba,v,w){u=function(P){function H(){var a=P.apply(this,arguments)||this;a.rasterJobHandler=null;a.datasetName=null;a.datasetFormat=null;a.rasterInfo=null;a.ioConfig={sampling:"closest"};return a}K._inheritsLoose(H,P);var n=H.prototype;n.init=async function(){const a=v.load();this.addResolvingPromise(a);await this.when()};n.normalizeCtorArgs=function(a){a&&a.ioConfig&&(a={...a,ioConfig:{resolution:null,bandIds:null,sampling:"closest",
tileInfo:N.create(),...a.ioConfig}});return a};n.open=async function(a){throw new L("BaseRaster:open-not-implemented","open() is not implemented");};n.fetchTile=async function(a,b,f,d={}){var e;const {tileInfo:c}=d;a=c.lodAt(a);a=new G({x:a.resolution,y:a.resolution,spatialReference:c.spatialReference});b=this.getTileExtent(a,b,f,c);null!=(e=d.multidimensionalDefinition)&&e.length&&C.isSome(this.rasterInfo.multidimensionalInfo)&&null==d.sliceId&&(d={...d,sliceId:this.getSliceIndex(d.multidimensionalDefinition)||
0});return this.fetchPixels(b,c.size[0],c.size[1],d)};n.identify=async function(a,b={}){const {spatialReference:f,extent:d}=this.rasterInfo;var {datumTransformation:e}=b;e=v.projectPoint(a,f,e);if(!d.intersects(e))return{location:e,value:null};let c=0;if(b.srcResolution)c=v.snapPyramid(b.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel;else if(c=await this.computeBestPyramidLevelForLocation(a,b),null==c)return{location:e,value:null};a=this.identifyPixelLocation(e,c,null);if(null===
a)return{location:e,value:null};const {row:g,col:h,rowOffset:l,colOffset:k}=a;a=w.getRasterId(this.url,b.sliceId);const m=`${c}/${g}/${h}`;let p=w.getBlock(a,null,m);C.isSome(p)||(p=this.fetchRawTile(c,g,h,b),w.putBlock(a,null,m,p));b=await p;if(!(b&&b.pixels&&0<b.pixels.length))return{location:e,value:null};const r=l*this.rasterInfo.storageInfo.blockHeight+k;b=!b.mask||b.mask[r]?b.pixels.map(t=>t[r]):null;return{location:e,value:b,pyramidLevel:c}};n.fetchPixels=async function(a,b,f,d={}){a=a.clone().normalize()[0];
var e=this.rasterInfo.spatialReference,c=!a.spatialReference.equals(e),{datumTransformation:g}=d,h=new G({x:(a.xmax-a.xmin)/b,y:(a.ymax-a.ymin)/f,spatialReference:a.spatialReference}),l=d.srcResolution||(c?v.projectResolution(h,e,a,g):h);if(!l)return null;const {pyramidLevel:k,pyramidResolution:m,excessiveReading:p}=v.snapPyramid(l,this.rasterInfo,this.ioConfig.sampling);if(p)return null;var r=this.rasterInfo.storageInfo;e=c?v.projectExtent(a,e,g):a;const t=C.unwrap(this.rasterInfo.transform);t&&
(e=t.inverseTransform(e));if(null==e)return null;var q=Math.ceil((e.xmax-e.xmin)/m.x-.1),z=Math.ceil((e.ymax-e.ymin)/m.y-.1);if(8<q/b||8<z/f)return null;q=await this.fetchRawPixels(k,{x:Math.floor((e.xmin-r.origin.x)/m.x+.1),y:Math.floor((r.origin.y-e.ymax)/m.y+.1)},{width:q,height:z},d);if(!q)return null;z=0<k?r.pyramidBlockWidth:r.blockWidth;r=0<k?r.pyramidBlockHeight:r.blockHeight;if(!c&&1===q.pixelBlocks.length&&z===b&&r===f&&l.x===h.x&&l.y===h.y)return{extent:a,srcExtent:e,pixelBlock:q.pixelBlocks[0],
transformGrid:null};c=v.getProjectionOffsetGrid(a,q.extent,h,g,t);g=!d.requestRawData;h={rows:c.spacing[0],cols:c.spacing[1]};const {pixelBlocks:D,mosaicSize:E,isPartiallyFilled:I}=q;this.rasterJobHandler?b=await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:D,srcMosaicSize:E,destDimension:g?{width:b,height:f}:null,coefs:g?c.coefficients:null,sampleSpacing:g?h:null,interpolation:d.interpolation},d):(l=O.mosaic(D,E),b=g?O.approximateTransform(l,{width:b,height:f},c.coefficients,h,d.interpolation):
l);return{srcExtent:e,pixelBlock:b,transformGrid:c,extent:a,isPartiallyFilled:I}};n.fetchRawPixels=async function(a,b,f,d){const {origin:e,blockBoundary:c}=this.rasterInfo.storageInfo,g=0<a?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,h=0<a?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight;let {x:l,y:k}=b,{width:m,height:p}=f;d.buffer&&(l-=d.buffer.cols,k-=d.buffer.rows,m+=2*d.buffer.cols,p+=2*d.buffer.rows);b=Math.floor(l/
g);f=Math.floor(k/h);const r=Math.floor((l+m-1)/g),t=Math.floor((k+p-1)/h);var q=c[a];if(!q)return null;const {minRow:z,minCol:D,maxCol:E,maxRow:I}=q;if(t<z||r<D||f>I||b>E)return null;q=[];let J,Q=!1;for(var x=f;x<=t;x++)for(let F=b;F<=r;F++)x>=z&&F>=D&&I>=x&&E>=F?(J=this._fetchRawTile(a,x,F,d),this.ioConfig.allowPartialFill&&(J=B.create(R=>{J.then(ca=>R(ca)).catch(()=>{Q=!0;R(null)})})),q.push(J)):q.push(null);if(0===q.length)return null;d=await B.all(q);q={height:(t-f+1)*g,width:(r-b+1)*h};const {nativePixelSize:S,
spatialReference:da}=this.rasterInfo;x=S.x*Math.pow(2,a);a=S.y*Math.pow(2,a);return{extent:new M({xmin:e.x+b*g*x,xmax:e.x+(r+1)*g*x,ymin:e.y-(t+1)*h*a,ymax:e.y-f*h*a,spatialReference:da}),pixelBlocks:d,mosaicSize:q,isPartiallyFilled:Q}};n.fetchRawTile=async function(a,b,f,d){throw new L("BaseRaster:read-not-implemented","fetchRawTile() is not implemented");};n.computeExtent=function(a){return v.projectExtent(this.rasterInfo.extent,a)};n.decodePixelBlock=function(a,b){return!this.rasterJobHandler||
b.useCanvas?aa.decode(a,b):this.rasterJobHandler.decode({data:a,options:b})};n.request=async function(a,b,f){var d,e;const {customFetchParameters:c}=this.ioConfig,{range:g,query:h,headers:l}=b;f=null!=(d=null!=(e=f)?e:b.retryCount)?d:this.ioConfig.retryCount;d=g?{Range:`bytes=${g.from}-${g.to}`}:null;try{return await W(a,{...b,query:{...h,...c},headers:{...l,...d}})}catch(k){if(0<f)return f--,this.request(a,b,f);throw k;}};n.getSliceIndex=function(a){const {multidimensionalInfo:b}=this.rasterInfo;
if(!C.isSome(b)||null==a||!a.length)return null;let f=0;const d=a[0].variableName;for(let g=0;g<b.variables.length;g++){var e=b.variables[g];const h=e.dimensions;if(e.name!==d){f+=h.map(k=>this._getDimensionValuesCount(k)).reduce((k,m)=>k+m);break}e=h.map(k=>this._getDimensionValuesCount(k));const l=h.length;for(let k=0;k<l;k++){var c=a.filter(m=>m.dimensionName===h[k].name)[0];if(null==c)return null;c=Array.isArray(c.values[0])?c.values[0][0]:c.values[0];c=this._getIndexFromDimensions(c,h[k]);if(-1===
c)return null;e.shift();f=k===l-1?f+c:f+c*e.reduce((m,p)=>m+p)}}return f};n.updateTileInfo=function(){const {storageInfo:a,spatialReference:b,extent:f,pixelSize:d}=this.rasterInfo;if(!a.tileInfo){const c=[];var e=a.maximumPyramidLevel||0;let g=Math.max(d.x,d.y),h=1/.0254*96*g;for(let l=0;l<=e;l++)c.push({level:e-l,resolution:g,scale:h}),g*=2,h*=2;e=new G({x:f.xmin,y:f.ymax,spatialReference:b});a.tileInfo=new N({origin:e,size:[a.blockWidth,a.blockHeight],spatialReference:b,lods:c});a.isVirtualTileInfo=
!0}};n.createRemoteDatasetStorageInfo=function(a,b=512,f=512,d){const {width:e,height:c,nativeExtent:g,pixelSize:h,spatialReference:l}=a,k=new G({x:g.xmin,y:g.ymax,spatialReference:l});null==d&&(d=Math.max(0,Math.round(Math.log(Math.max(e,c))/Math.LN2-8)));const m=this._computeBlockBoundary(g,h,d,512,512);a.storageInfo=new ba({blockWidth:b,blockHeight:f,pyramidBlockWidth:b,pyramidBlockHeight:f,origin:k,firstPyramidLevel:1,maximumPyramidLevel:d,blockBoundary:m})};n.computeBestPyramidLevelForLocation=
async function(a,b){return 0};n.identifyPixelLocation=function(a,b,f){const {spatialReference:d,pixelSize:e,extent:c}=this.rasterInfo,{blockWidth:g,blockHeight:h,maximumPyramidLevel:l,pyramidScalingFactor:k,origin:m}=this.rasterInfo.storageInfo;a=v.projectPoint(a,d,f);if(!c.intersects(a)||0>b||b>l)return null;var p=Math.pow(k,b);f=(m.y-a.y)/(p*e.y)/h;p=(a.x-m.x)/(p*e.x)/g;return{pyramidLevel:b,row:Math.floor(f),col:Math.floor(p),rowOffset:Math.min(h-1,Math.floor((f-Math.floor(f))*h)),colOffset:Math.min(g-
1,Math.floor((p-Math.floor(p))*g)),srcLocation:a}};n.getTileExtent=function(a,b,f,d){const {origin:e,spatialReference:c}=d,g=d.size[0];d=d.size[1];f=e.x+f*g*a.x;b=e.y-b*d*a.y;return new M({xmin:f,xmax:f+g*a.x,ymin:b-d*a.y,ymax:b,spatialReference:c})};n._computeBlockBoundary=function(a,b,f,d,e){let {x:c,y:g}=b;b=a.xmin;const h=a.ymax,l=[{minCol:Math.floor((a.xmin-b+.1*c)/d/c),maxCol:Math.floor((a.xmax-b-.1*c)/d/c),minRow:Math.floor((h-a.ymax+.1*g)/e/g),maxRow:Math.floor((h-a.ymin-.1*g)/e/g)}];if(0<
f)for(let k=0;k<f;k++)c*=2,g*=2,l.push({minCol:Math.floor((a.xmin-b+.1*c)/d/c),maxCol:Math.floor((a.xmax-b-.1*c)/d/c),minRow:Math.floor((h-a.ymax+.1*g)/e/c),maxRow:Math.floor((h-a.ymin-.1*g)/e/c)});return l};n._fetchRawTile=function(a,b,f,d){var e=this.rasterInfo.storageInfo.blockBoundary[a];if(!e)return B.resolve(null);const {minRow:c,minCol:g,maxCol:h,maxRow:l}=e;if(b<c||f<g||b>l||f>h)return B.resolve(null);const k=w.getRasterId(this.url,d.sliceId),m=`${a}/${b}/${f}`;e=w.getBlock(k,d.registryId,
m);if(!C.isSome(e)){const p=B.createAbortController();e=this.fetchRawTile(a,b,f,{...d,signal:p.signal});w.putBlock(k,d.registryId,m,e,p);e.catch(()=>{w.deleteBlock(k,d.registryId,m)})}if(d.signal)B.onAbort(d,()=>{w.decreaseRefCount(k,d.registryId,m)});return e};n._getIndexFromDimensions=function(a,b){const {extent:f,interval:d,unit:e,values:c}=b;if(null!=c&&c.length)return Array.isArray(c[0])?c.findIndex(k=>k[0]<=a&&k[1]>=a):c.indexOf(a);if(a>f[1])return-1;const g=f[0];let h=-1;if("ISO8601"===e){var l;
switch((null==(l=b.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case "seconds":h=Math.round((a-g)/1E3/d);break;case "minutes":h=Math.round((a-g)/6E4/d);break;case "hours":h=Math.round((a-g)/36E5/d);break;case "days":h=Math.round((a-g)/864E5/d);break;case "years":h=Math.round(((new Date(a)).getUTCFullYear()-(new Date(g)).getUTCFullYear())/d);break;case "decades":h=Math.round(((new Date(a)).getUTCFullYear()-(new Date(g)).getUTCFullYear())/10/d)}return h}return Math.round((a-g)/d)};n._getDimensionValuesCount=
function(a){const {extent:b,interval:f,unit:d,values:e}=a;let c=(null==e?void 0:e.length)||0;if(c)return c;const g=b[0];if(0===c&&"ISO8601"===d){var h;switch((null==(h=a.intervalUnit)?void 0:h.toLowerCase())||"seconds"){case "seconds":c=Math.round((b[1]-b[0])/1E3/f);break;case "minutes":c=Math.round((b[1]-b[0])/6E4/f);break;case "hours":c=Math.round((b[1]-b[0])/36E5/f);break;case "days":c=Math.round((b[1]-b[0])/864E5/f);break;case "years":c=Math.round(((new Date(b[1])).getUTCFullYear()-(new Date(g)).getUTCFullYear())/
f);break;case "decades":c=Math.round(((new Date(b[1])).getUTCFullYear()-(new Date(g)).getUTCFullYear())/10/f)}return c}return Math.round((b[1]-b[0])/f)};K._createClass(H,[{key:"url",set:function(a){this._set("url",Y.sanitizeUrl(a,T.getLogger(this.declaredClass)))}}]);return H}(X.EsriPromiseMixin(V.JSONSupport));y.__decorate([A.property(Z.url)],u.prototype,"url",null);y.__decorate([A.property({type:String,json:{write:!0}})],u.prototype,"datasetName",void 0);y.__decorate([A.property({type:String,json:{write:!0}})],
u.prototype,"datasetFormat",void 0);y.__decorate([A.property()],u.prototype,"rasterInfo",void 0);y.__decorate([A.property()],u.prototype,"ioConfig",void 0);y.__decorate([A.property()],u.prototype,"sourceJSON",void 0);return u=y.__decorate([U.subclass("esri.layers.support.rasterDatasets.BaseRaster")],u)});