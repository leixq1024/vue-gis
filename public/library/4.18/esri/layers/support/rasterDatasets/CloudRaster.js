// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/Error ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/promiseUtils ../../../geometry/SpatialReference ../../../geometry/Point ../../../geometry/Extent ../../../geometry ../../../tasks/support/FeatureSet ../TileInfo ../RasterInfo ../RasterStorageInfo ./BaseRaster ./DBFParser".split(" "),
function(H,v,q,I,X,Y,D,Z,J,K,aa,ba,ca,L,M,E,N,da,O,P,Q,R,S,T){const m=new Map;m.set("int16","esriFieldTypeSmallInteger");m.set("int32","esriFieldTypeInteger");m.set("int64","esriFieldTypeInteger");m.set("float32","esriFieldTypeSingle");m.set("float64","esriFieldTypeDouble");m.set("text","esriFieldTypeString");q=function(F){function w(){var a=F.apply(this,arguments)||this;a.storageInfo=null;a.datasetFormat="CRF";return a}H._inheritsLoose(w,F);var k=w.prototype;k.open=async function(a){await this.init();
({data:a}=await this.request(this.url+"/conf.json",{signal:null==a?void 0:a.signal}));if(!this._validateHeader(a))throw new K("cloudraster:open","Invalid or unsupported conf.json.");this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const {storageInfo:b,rasterInfo:c}=this._parseHeader(a);"thematic"===c.dataType&&(a=await this._fetchAuxiliaryInformation(),c.attributeTable=a);this._set("storageInfo",b);this._set("rasterInfo",c);this.ioConfig.retryCount=this.ioConfig.retryCount||0};k.fetchRawTile=
async function(a,b,c,d={}){a=this.rasterInfo.storageInfo.maximumPyramidLevel-a;if(0>a)return null;a=this._buildCacheFilePath(a,b,c,d.multidimensionalDefinition);b=this._getIndexRecordFromBundle(b,c);c=await this.request(a,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:d.signal});if(!c)return null;c=new Uint8Array(c.data);b=this._getTileEndAndContentType(c,b);return 0===b.recordSize?null:(d=await this.request(a,{range:{from:b.position,to:b.position+b.recordSize},
responseType:"array-buffer",signal:d.signal}))?this.decodePixelBlock(d.data,{width:this.rasterInfo.storageInfo.tileInfo.size[0],height:this.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null}):null};k._validateHeader=function(a){const b="origin extent geodataXform LODInfos blockWidth blockHeight bandCount pixelType pixelSizeX pixelSizeY format packetSize".split(" ");return a&&"RasterInfo"===a.type&&!b.some(c=>!a[c])};k._parseHeader=function(a){var b;const c="u1 u2 u4 u8 s8 u16 s16 u32 s32 f32 f64".split(" ")[a.pixelType],
{bandCount:d,histograms:g,colormap:e,blockWidth:n,blockHeight:r,firstPyramidLevel:U,maximumPyramidLevel:x}=a,V=a.statistics&&a.statistics.map(p=>({min:p.min,max:p.max,avg:p.mean,stddev:p.standardDeviation,median:p.median,mode:p.mode})),t=new M(a.extent.spatialReference||a.geodataXform.spatialReference),u=new N({xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,spatialReference:t}),y=new E({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:t}),W=null!=(b=a.properties)?b:{};var z=
a.format.toLowerCase().replace("cache/","");b=new E(a.origin.x,a.origin.y,t);let A,f;if(e&&e.colors)for(A=[],f=0;f<e.colors.length;f++){var h=e.colors[f];var l=e.values?e.values[f]:f;A.push([l,h&255,h<<16>>>24,h<<8>>>24,h>>>24])}h=a.LODInfos;l=[];for(f=0;f<h.levels.length;f++)l.push({level:h.levels[f],resolution:h.resolutions[f],scale:96/.0254*h.resolutions[f]});h=new P({dpi:96,lods:l,format:z,origin:b,size:[n,r],spatialReference:t});z={recordSize:8,packetSize:a.packetSize,headerSize:a.packetSize*
a.packetSize*8+64};l=Math.round((u.xmax-u.xmin)/y.x);const B=Math.round((u.ymax-u.ymin)/y.y),G=[{maxCol:Math.ceil(l/n)-1,maxRow:Math.ceil(B/r)-1,minCol:0,minRow:0}];let C=2;if(0<x)for(f=0;f<x;f++)G.push({maxCol:Math.ceil(l/C/n)-1,maxRow:Math.ceil(B/C/r)-1,minCol:0,minRow:0}),C*=2;a=new Q({width:l,height:B,pixelType:c,bandCount:d,extent:u,spatialReference:t,pixelSize:y,keyProperties:W,statistics:V,histograms:g,multidimensionalInfo:a.mdInfo,colormap:A,storageInfo:new R({blockWidth:n,blockHeight:r,pyramidBlockWidth:n,
pyramidBlockHeight:r,origin:b,tileInfo:h,firstPyramidLevel:U,maximumPyramidLevel:x,blockBoundary:G})});return{storageInfo:z,rasterInfo:a}};k._fetchAuxiliaryInformation=async function(a){var b=this.request(this.url+"/conf.vat.json",{signal:a}).then(d=>d.data).catch(()=>null);a=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:a}).then(d=>d.data).catch(()=>null);b=await L.all([b,a]);let c;if(b[0]){a=b[0].fields;const d=b[0].values;if(a&&d){a=a.map(e=>({type:"OID"===e.name?"esriFieldTypeOID":
m.get(e.type),name:e.name,alias:e.alias||e.name}));const g=d.map(e=>({attributes:e}));a&&d&&(c={fields:a,features:g})}}!c&&b[1]&&(c=T.parse(b[1]).recordSet);return O.fromJSON(c)};k._buildCacheFilePath=function(a,b,c,d){var g=this.storageInfo.packetSize;c=Math.floor(c/g)*g;b="R"+this._toHexString4(Math.floor(b/g)*g)+"C"+this._toHexString4(c);g="L";g=10<=a?g+a.toString():g+("0"+a.toString());({multidimensionalInfo:a}=this.rasterInfo);const e=null==d?void 0:d[0];if(!I.isSome(a)||!e)return`${this.url}/_alllayers/${g}/${b}.bundle`;
d=a.variables.filter(n=>n.name===e.variableName)[0].dimensions[0].values.indexOf(e.values[0]).toString(16);a=4-d.length;for(c=0;c<a;c++)d="0"+d;return`${this.url}/_alllayers/${e.variableName}/${"S"+d}/${g}/${b}.bundle`};k._getIndexRecordFromBundle=function(a,b){const c=this.storageInfo.packetSize;a=a%c*c+b%c;if(0>a)throw"Invalid level / row / col";return a*this.storageInfo.recordSize+64};k._getTileEndAndContentType=function(a,b){a=a.subarray(b,b+8);b=0;let c;for(c=0;5>c;c++)b|=(a[c]&255)<<8*c;const d=
b&0xffffffffff;b=0;for(c=5;8>c;c++)b|=(a[c]&255)<<8*(c-5);return{position:d,recordSize:b&0xffffffffff}};k._toHexString4=function(a){a=a.toString(16);if(4!==a.length){let b=4-a.length;for(;0<b--;)a="0"+a}return a};return w}(S);v.__decorate([D.property({readOnly:!0})],q.prototype,"storageInfo",void 0);v.__decorate([D.property({type:String,json:{write:!0}})],q.prototype,"datasetFormat",void 0);return q=v.__decorate([J.subclass("esri.layers.support.rasterDatasets.CloudRaster")],q)});