// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define(["exports","../../../geometry/Extent","../RasterInfo","./xmlUtilities","../wmsUtils"],function(F,C,G,a,M){function N(b){const d=a.getElementValues(b,"requestResponseCRSs").map(e=>e.split(":")[1]);b=a.getElementValues(b,"nativeCRSs").map(e=>e.split(":")[1]);return{requestResponseCRSs:d,nativeCRSs:b}}function O(b){const d=a.getElementValues(b,"interpolationMethod"),e=b.getAttribute("default");return null!=e?[e].concat(d.filter(h=>h.toLowerCase()!==e.toLowerCase())):d}function H(b){return null==
b?["nearest"]:b.map(d=>{d=d.toLowerCase();return-1<d.indexOf("nearest")?"nearest":-1<d.indexOf("linear")?"bilinear":-1<d.indexOf("cubic")?"cubic":null}).filter(d=>!!d)}function P(b=null){if(!b)return{resolution:null,units:null};let d=b.toUpperCase();var e=["Y","M","D"];const h=["H","M","S"];b="Years Months Days Hours Minutes Seconds".split(" ");let f;-1===d.indexOf("PT")?(d=d.slice(1),e=e.findIndex(k=>-1<d.indexOf(k)),-1<e&&(f=b[e])):(d=d.slice(2),e=h.findIndex(k=>-1<d.indexOf(k)),f=b[3+e]);return{resolution:parseFloat(d.substring(0,
d.length-1)),units:f}}function J(b){var d=a.getElements(b,"timeposition");if(0<d.length){b=[];for(var e=0;e<d.length;e++)b.push(new Date(a.getElementValue(d[e])));return{begin:b[0],end:b[b.length-1],values:b}}return(e=a.getElement(b,"timePeriod"))?(d=new Date(a.getElementValue(e,"beginPosition")),b=new Date(a.getElementValue(e,"endPosition")),e=a.getElementValue(e,"timeResolution"),e=P(e),{begin:d,end:b,...e}):null}function Q(b,d){b=b.filter(h=>-1===h.identifier.toLowerCase().indexOf("field_1")&&
!h.axis.some(f=>"band"===f.identifier.toLowerCase()));const e=[];b.length&&b.forEach(h=>{var f;const k=h.axis.map(g=>{const c=g.values.map(m=>parseFloat(m.trim())),l=[Math.min.apply(null,c),Math.max.apply(null,c)];return{name:g.identifier.trim(),description:"",field:g.identifier.trim(),unit:g.valuesUnit?g.valuesUnit.trim():"",hasRegularIntervals:!1,values:c,extent:l}});e.push({name:h.identifier.trim(),description:null!=(f=null==h?void 0:h.description.trim())?f:"",unit:"",dimensions:k})});if(d.temporalDomain){const {begin:h,
end:f,values:k,units:g,resolution:c}=d.temporalDomain;e.forEach(l=>{l.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:null==k?void 0:k.map(m=>m.getTime()),hasRegularIntervals:!k,interval:c,intervalUnit:g,extent:[h.getTime(),f.getTime()]})})}return e.length?{variables:e}:null}function R(b){var d,e=a.getElement(b,"SpatialDomain"),h=a.getElement(e,"GridCRS"),f=a.getElementValue(h,"GridBaseCRS"),k=a.getElementValue(h,"GridOrigin");k=null!=(d=null==k?void 0:k.split(" ").map(t=>parseFloat(t)))?
d:[0,0];d=a.getSpaceDelimitedNumericValues(h,"GridOffsets");e=a.getElements(e,"BoundingBox");let g;for(h=0;h<e.length;h++){var c,l=null==(c=e[h].getAttribute("crs"))?void 0:c.toLowerCase();if(null!=l)if(-1<l.indexOf("imagecrs")){var m=a.getSpaceDelimitedNumericValues(e[h],"LowerCorner");l=a.getSpaceDelimitedNumericValues(e[h],"UpperCorner");g=l[0]-m[0]+1;m=l[1]-m[1]+1}else if(0<l.indexOf("epsg")){var p=l.split(":");p=parseInt(p[p.length-1],10);var n=a.getSpaceDelimitedNumericValues(e[h],"LowerCorner");
l=a.getSpaceDelimitedNumericValues(e[h],"UpperCorner");n=new C({xmin:n[0],ymin:n[1],xmax:l[0],ymax:l[1],spatialReference:{wkid:p}})}}c=g>m;e=n.xmax-n.xmin>n.ymax-n.ymin;h=!1;M.coordsReversed(p)&&(c===e?h=!1:(h=!0,n=new C({xmin:n.ymin,ymin:n.xmin,xmax:n.ymax,ymax:n.xmax,spatialReference:{wkid:p}})));f={columns:g,rows:m,origin:{x:k[0],y:k[1]},offset:{x:d[0],y:d[1]},gridBaseCRS:f,envelope:n,useEPSGAxis:h};b=(b=a.getElement(b,"temporalDomain"))?J(b):null;return{spatialDomain:f,temporalDomain:b}}function S(b){const d=
a.getElement(b,"Envelope")||a.getElement(b,"EnvelopeWithTimePeriod");var e=d.getAttribute("srsName"),h=e.slice(e.lastIndexOf("/")+1);const f=d.getAttribute("axisLabels");var k=a.getSpaceDelimitedNumericValues(d,"lowerCorner"),g=a.getSpaceDelimitedNumericValues(d,"upperCorner");h=(e=!"y lat latitude north nor n b".split(" ").some(m=>m===f[0].toLowerCase()))?new C({xmin:k[0],ymin:k[1],xmax:g[0],ymax:g[1],spatialReference:{wkid:parseInt(h,10)}}):new C({xmin:k[1],ymin:k[0],xmax:g[1],ymax:g[0],spatialReference:{wkid:parseInt(h,
10)}});k={mins:k,maxs:g};g=d.getAttribute("uomLabels").trim().split(" ");let c,l;a.isSameTagIgnoreNS(d,"EnvelopeWithTimePeriod")&&(c=new Date(a.getElementValue(b,"beginPosition")),l=new Date(a.getElementValue(b,"endPosition")));return{envelope:h,axisLabels:f,uomLabels:g.length?g:null,envelopeAllDims:k,beginPosition:c,endPosition:l,isEastFirst:e}}function T(b){let d=1,e="";Math.abs(b-1/24)<1/24*.01?e="Hours":.01>Math.abs(b-1)?e="Days":1>b?(d=Math.round(24*b),e="Hours"):27.99<b&&31.01>b?e="Months":
12>Math.round(b/30)?e="Months":364.99<b&&366.01>b&&(e="Years");return{interval:d,intervalUnit:e}}function U(b,d,e){const h=[];for(var f=0;f<b.length;f++){var k=b[f];for(var g=0;g<k.length;g++)-1===k[g].name.toLowerCase().indexOf("band")&&h.push(k[g])}const c=[];if(h.length){const l=[];for(b=2;b<e.axisLabels.length;b++){g=(d.uomLabels&&d.uomLabels.length)>b?d.uomLabels[b]:"";(f=-1<e.axisLabels[b].toLowerCase().indexOf("time")||"iso8601"===g.toLowerCase())?(g=T(e.offset[b]),k=g.interval,g=g.intervalUnit):
k=e.offset[b];const m=[];f?(m.push((new Date).setTime(864E5*(d.envelopeAllDims.mins[b]-25569))),m.push((new Date).setTime(864E5*(d.envelopeAllDims.maxs[b]-25569)))):(m.push(d.envelopeAllDims.mins[b]),m.push(d.envelopeAllDims.maxs[b]));l.push({name:e.axisLabels[b].trim(),description:e.axisLabels[b].trim(),unit:d.uomLabels&&d.uomLabels.length>b?d.uomLabels[b].trim():"",hasRegularIntervals:!0,extent:m,interval:k,intervalUnit:g})}h.forEach(m=>c.push({name:m.name.trim(),description:m.description.trim(),
unit:m.uom.trim(),dimensions:l}));if(c.length)return{variables:c}}return null}function V(b){var d=a.getElement(b,"RectifiedGrid"),e=a.getSpaceDelimitedNumericValues(d,"low"),h=a.getSpaceDelimitedNumericValues(d,"high");b=[];for(var f=0;f<e.length;f++)b.push(h[f]-e[f]+1);const k=a.getElementValue(d,"axisLabels").split(" ");e=a.getSpaceDelimitedNumericValues(d,"origin/pos");h=a.getElements(d,"offsetVector");d=[];for(f=0;f<h.length;f++)d.push(parseFloat(a.getElementValue(h[f]).split(" ")[f]));let g;
"y lat latitude north nor n b".split(" ").some(c=>c===k[0].toLowerCase())?(h=b[1],f=b[0],g={y:Math.abs(d[0]),x:Math.abs(d[1])}):(h=b[0],f=b[1],g={x:Math.abs(d[0]),y:Math.abs(d[1])});return{columns:h,rows:f,origin:e,offset:d,resolution:g,gridSamples:b,axisLabels:k}}F.parseCoverages=function(b,d){let e=null;e="string"===typeof b?(new DOMParser).parseFromString(b,"text/xml"):b;if("1.0.0"===d)return a.getElements(e,"CoverageOffering").map(h=>{{var f={version:"1.0"};var k=[];for(var g=0;g<h.childNodes.length;g++){var c=
h.childNodes[g];if(1===c.nodeType)if(a.isSameTagIgnoreNS(c,"description"))f.description=a.getElementValue(c);else if(a.isSameTagIgnoreNS(c,"name"))f.name=a.getElementValue(c);else if(a.isSameTagIgnoreNS(c,"label"))f.label=a.getElementValue(c);else if(a.isSameTagIgnoreNS(c,"supportedFormats"))f.supportedFormats=a.getElementValues(c,"formats");else if(a.isSameTagIgnoreNS(c,"supportedCRSs"))f.supportedCRSs=N(c);else if(a.isSameTagIgnoreNS(c,"supportedInterpolations"))f.supportedInterpolations=O(c);else if(a.isSameTagIgnoreNS(c,
"lonLatEnvelope")){var l=a.getElements(c,"pos");c=a.getSpaceDelimitedNumericValues(l[0]);l=a.getSpaceDelimitedNumericValues(l[1]);c=new C({xmin:c[0],ymin:c[1],xmax:l[0],ymax:l[1],spatialReference:{wkid:4326}});f.lonLatEnvelope=c}else if(a.isSameTagIgnoreNS(c,"rangeSet")){k=[];c=a.getElements(c,"RangeSet");l=[];for(var m=0;m<c.length;m++){var p=a.getElementValue(c[m],"name"),n=a.getElementValue(c[m],"label"),t=[],r=a.getElements(c[m],"AxisDescription");for(let v=0;v<r.length;v++){const D=a.getElementValue(r[v],
"name"),I=a.getElementValue(r[v],"label"),A=a.getElementValues(r[v],"singleValue");if(0===A.length){var q=a.getElementValue(r[v],"min");const y=a.getElementValue(r[v],"max"),z=Number(a.getElementValue(r[v],"res"))||1;if(null!==q&&null!==y)for(q=parseInt(q,10);q<=parseInt(y,10);q+=z)A.push(q.toString())}"band"===D.toLowerCase()&&(l=A);t.push({name:D,label:I,values:A})}k.push({name:p,label:n,axis:t})}k={rangeSet:k,bandNames:l};f.rangeSet=k.rangeSet;k=k.bandNames}else a.isSameTagIgnoreNS(c,"domainSet")&&
(l=a.getElement(c,"spatialDomain"),p=a.getElement(l,"Envelope")||a.getElement(l,"EnvelopeWithTimePeriod"),m=p.getAttribute("srsName").split(":"),m=m[m.length-1],n=a.getElements(p,"pos"),p=a.getSpaceDelimitedNumericValues(n[0]),n=a.getSpaceDelimitedNumericValues(n[1]),m=new C({xmin:p[0],ymin:p[1],xmax:n[0],ymax:n[1],spatialReference:{wkid:parseInt(m,10)}}),p=a.getElement(l,"RectifiedGrid"),n=a.getElementValue(p,"low").split(" "),t=a.getElementValue(p,"high").split(" "),p=parseInt(t[0],10)-parseInt(n[0],
10)+1,n=parseInt(t[1],10)-parseInt(n[1],10)+1,t=a.getSpaceDelimitedNumericValues(l,"origin/pos"),r=a.getElements(l,"offsetVector"),l=parseFloat(a.getElementValue(r[0]).split(" ")[0]),r=parseFloat(a.getElementValue(r[1]).split(" ")[1]),l={envelope:m,columns:p,rows:n,offset:{x:l,y:r},origin:{x:t[0],y:t[1]}},c=(c=a.getElement(c,"temporalDomain"))?J(c):null,c={spatialDomain:l,temporalDomain:c},f.domainSet=c)}h=H(f.supportedInterpolations);const {name:x,description:u,label:w,lonLatEnvelope:B,supportedFormats:E}=
f;({spatialDomain:g}=f.domainSet);g=new G({width:g.columns,height:g.rows,pixelSize:{x:Math.abs(g.offset.x),y:Math.abs(g.offset.y)},extent:g.envelope,spatialReference:g.envelope.spatialReference,bandCount:k.length||1});f={id:x,title:f.name,description:u||w,lonLatEnvelope:B,rasterInfo:g,bandNames:k,supportedFormats:E,supportedInterpolations:h,coverageDescription:f,version:"1.0.0",useEPSGAxis:!1}}return f});b=a.getElements(e,"CoverageDescription");return"1.1.0"===d||"1.1.1"===d||"1.1.2"===d?b.map(h=>
{{var f=[];var k=[];const p={supportedFormats:f,supportedCRSs:k,version:"1.1"};for(var g=0;g<h.childNodes.length;g++){var c=h.childNodes[g];if(1===c.nodeType){var l=a.getNodeNameIgnoreNS(c).toLowerCase();switch(l){case "title":case "abstract":case "identifier":p[l]=a.getElementValue(c);break;case "supportedformat":c=a.getElementValue(c);-1===f.indexOf(c)&&f.push(c);break;case "supportedcrs":c=a.getElementValue(c);-1===k.indexOf(c)&&k.push(c);break;case "range":var m=[];c=a.getElements(c,"Field");
l=[];for(let u=0;u<c.length;u++){const w=a.getElementValue(c[u],"Identifier"),B=a.getElementValue(c[u],"Description"),E=a.getElementValue(c[u],"Definition"),v=a.getElementValue(c[u],"Abstract"),D=a.getElementValue(c[u],"Title"),I=a.getElementValues(c[u],"InterpolationMethod"),A=[],y=a.getElements(c[u],"Axis");for(let z=0;z<y.length;z++){const K=y[z].getAttribute("identifier"),W=a.getElementValue(y[z],"valuesUnit"),X=a.getElementValue(y[z],"DataType"),L=a.getElementValues(y[z],"Key");"band"===K.toLowerCase()&&
(l=L);A.push({identifier:K,valuesUnit:W,dataType:X,values:L})}m.push({identifier:w,description:B,definition:E,abstract:v,title:D,supportedInterpolations:I,axis:A})}m={rangeSet:m,bandNames:l};p.range=m.rangeSet;m=m.bandNames;break;case "domain":p.domain=R(c)}}}h=H(p.range[0].supportedInterpolations);const {identifier:n,abstract:t,title:r,domain:q,range:x}=p;k={x:Math.abs(q.spatialDomain.offset.x),y:Math.abs(q.spatialDomain.offset.y)};g=Q(x,q);k=new G({width:q.spatialDomain.columns,height:q.spatialDomain.rows,
pixelSize:k,extent:q.spatialDomain.envelope,spatialReference:q.spatialDomain.envelope.spatialReference,bandCount:m.length||1,multidimensionalInfo:g});f={id:n,title:p.title,description:t||r,lonLatEnvelope:null,bandNames:m,rasterInfo:k,supportedFormats:f,supportedInterpolations:h,coverageDescription:p,version:d,useEPSGAxis:q.spatialDomain.useEPSGAxis}}return f}):b.map(h=>{{var f={version:"2.0"};var k=[];for(let t=0;t<h.childNodes.length;t++){var g=h.childNodes[t];if(1===g.nodeType)if(a.isSameTagIgnoreNS(g,
"coverageId"))f.coverageId=a.getElementValue(g);else if(a.isSameTagIgnoreNS(g,"ServiceParameters"))f.serviceParameters={supportedFormats:a.getElementValues(g,"nativeFormat")};else if(a.isSameTagIgnoreNS(g,"boundedBy"))f.boundedBy=S(g);else if(a.isSameTagIgnoreNS(g,"rangeType")){{k=[];g=a.getElements(g,"DataRecord");const r=[];for(let q=0;q<g.length;q++){const x=a.getElements(g[q],"field"),u=[];for(let w=0;w<x.length;w++){const B=x[w].getAttribute("name"),E=a.getElementValue(x[w],"description")||"",
v=a.getElement(x[w],"uom").getAttribute("code")||"",D=a.getSpaceDelimitedNumericValues(x[w],"interval");-1<B.toLowerCase().indexOf("band")&&r.push(B);u.push({name:B,description:E,uom:v,allowedValues:D})}k.push(u)}k={rangeType:k,bandNames:r}}f.rangeType=k.rangeType;k=k.bandNames}else a.isSameTagIgnoreNS(g,"domainSet")&&(f.domainSet=V(g))}const {coverageId:c,boundedBy:l,domainSet:m,rangeType:p,serviceParameters:n}=f;h=U(p,l,m);h=new G({width:m.columns,height:m.rows,pixelSize:m.resolution,extent:l.envelope,
spatialReference:l.envelope.spatialReference,bandCount:k.length||1,multidimensionalInfo:h});f={id:c,title:c,description:c,lonLatEnvelope:null,bandNames:k,rasterInfo:h,supportedFormats:n.supportedFormats,supportedInterpolations:null,coverageDescription:f,version:"1.0.0",useEPSGAxis:!1}}return f})};F.standardizeInterpolations=H;Object.defineProperty(F,"__esModule",{value:!0})});