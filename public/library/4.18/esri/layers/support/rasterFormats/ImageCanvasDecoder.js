// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define(["../../../core/Error","../../../core/promiseUtils","../../../chunks/Zlib"],function(v,p,z){return function(){function n(b){b&&(this.canvas=b.canvas,this.ctx=b.ctx||b.canvas&&b.canvas.getContext("2d"))}n.prototype.decode=function(b,e,m){if(!b||10>b.byteLength)throw new v("imagecanvasdecoder: decode","required a valid encoded data as input.");let {width:c,height:d,format:k}=e;const {applyJpegMask:w}=e;if(w&&(!c||!d))throw new v("imagecanvasdecoder: decode","image width and height are needed to apply jpeg mask directly to canvas");
return p.create((x,y)=>{let h=null;"jpg"===k&&w&&(h=n.getMask(b,e));const A=new Blob([new Uint8Array(b)],{type:"jpg"==="image/"+k?"jpeg":k}),q=URL.createObjectURL(A),l=new Image;let f;l.src=q;l.onload=()=>{URL.revokeObjectURL(q);if(p.isAborted(m))y(p.createAbortError());else{c=l.width;d=l.height;if(this.canvas){if(this.canvas.width!==c||this.canvas.height!==d)this.canvas.width=c,this.canvas.height=d;this.ctx.clearRect(0,0,c,d)}else this.canvas=document.createElement("canvas"),this.canvas.width=c,
this.canvas.height=d,this.ctx=this.canvas.getContext("2d");this.ctx.drawImage(l,0,0);var g=this.ctx.getImageData(0,0,c,d);f=g.data;var a;if(e.renderOnCanvas){if(h)for(a=0;a<h.length;a++)f[4*a+3]=h[a]?255:0;this.ctx.putImageData(g,0,0);x(null)}else{g=c*d;var r=new Uint8Array(g),t=new Uint8Array(g),u=new Uint8Array(g);if(h)for(a=0;a<g;a++)r[a]=f[4*a],t[a]=f[4*a+1],u[a]=f[4*a+2];else for(h=new Uint8Array(g),a=0;a<g;a++)r[a]=f[4*a],t[a]=f[4*a+1],u[a]=f[4*a+2],h[a]=f[4*a+3];x({width:c,height:d,pixels:[r,
t,u],mask:h,pixelType:"u8"})}}};l.onerror=()=>{URL.revokeObjectURL(q);y("cannot load image")}})};n.getMask=function(b,e){let m=null;try{var c=new Uint8Array(b);b=0;var d=c.length-2;for(b=Math.ceil(c.length/2);b<d&&(255!==c[b]||217!==c[b+1]);b++);b+=2;if(b<c.length-1){const k=(new z.Zlib(c.subarray(b))).getBytes();m=new Uint8Array(e.width*e.height);e=0;for(c=0;c<k.length;c++)for(d=7;0<=d;d--)m[e++]=k[c]>>d&1}}catch(k){}return m};return n}()});