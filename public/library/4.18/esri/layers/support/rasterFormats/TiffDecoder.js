// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/Zlib ../../../chunks/Jpg ../rasterDatasets/byteStreamUtils ./Lzw ./TiffTags ./utils".split(" "),function(H,O,R,ca,da,J,S){function T(b,a){let e="unknown";3===b?e="f32":1===b?1===a?e="u1":2===a?e="u2":4===a?e="u4":8>=a?e="u8":16>=a?e="u16":32>=a&&(e="u32"):2===b&&(8>=a?e="s8":16>=a?e="s16":32>=a&&(e="s32"));return e}function L(b){let a=null;switch(b?b.toLowerCase():"f32"){case "u1":case "u2":case "u4":case "u8":a=Uint8Array;break;case "u16":a=Uint16Array;break;case "u32":a=
Uint32Array;break;case "s8":a=Int8Array;break;case "s16":a=Int16Array;break;case "s32":a=Int32Array;break;default:a=Float32Array}return a}function ea(b,a){return{x:a[0]*b.x+a[1]*b.y+a[2],y:a[3]*b.x+a[4]*b.y+a[5]}}function D(b,a){return(b=b.get(a))&&b.values}function y(b,a){return(b=b.get(a))&&b.values[0]}function P(b,a,e,k=0,c=J.TIFF_TAGS,l=4){var d=8===l;const m=d?Q(new DataView(b,e,8),0,a):(new DataView(b,e,2)).getUint16(0,a),f=4+2*l;var g=d?8:2;d=g+m*f;if(e+d>b.byteLength)return{success:!1,ifd:null,
nextIFD:null,requiredBufferSize:d};const n=e+d+4<=b.byteLength?M(new DataView(b,e+d,8===l?8:4),0,a,8===l):null;e+=g;g=new Map;let h,w,q,x,A;for(let t=0;t<m;t++){var u=new DataView(b,e+f*t,f);h=u.getUint16(0,a);q=u.getUint16(2,a);w=J.getTagName(h,c);2===l?(x=u.getUint16(4,a),A=u.getUint16(6,a)):4===l?(x=u.getUint32(4,a),A=u.getUint32(8,a)):8===l&&(x=M(u,4,a,!0),A=M(u,12,a,!0));u={id:h,type:q,valueCount:x,valueOffset:A,values:null};U(b,a,u,k,!1,l);g.set(w,u)}return{success:!0,ifd:g,nextIFD:n,requiredBufferSize:d}}
function U(b,a,e,k=0,c=!1,l=4){if(e.values)return!0;var d=e.type,m=e.valueCount,f=e.valueOffset;let g=[];var n=V[d],h=8*n,w=m*n,q=m*V[d]*8;l=8===l?64:32;if(q>l&&w>(c?b.byteLength:b?b.byteLength-f+k:0))return e.offlineOffsetSize=[f,w],e.values=null,!1;if(q<=l)if(a||(f>>>=32-q),1===m)g=[f];else if(64===l)for(b=f>>>0,f=Math.round((f-b)/4294967296),a=b,n=32,b=1;b<=m;b++)w=32-h*b%32,n<h?(w=a<<w>>>32-n,k=f<<32-n>>>32-n,a=f,g.push(w+k*Math.pow(2,h-n)),n-=32-(h-n)):(g.push(a<<w>>>32-h),n-=h),0===n&&(n=32,
a=f);else for(b=1;b<=m;b++)g.push(f<<32-h*b>>>32-h);else for(f-=k,c&&(f=0),m=f;m<f+w;m+=n){switch(d){case 1:h=(new DataView(b,m,1)).getUint8(0);break;case 2:h=(new DataView(b,m,1)).getUint8(0);break;case 3:h=(new DataView(b,m,2)).getUint16(0,a);break;case 4:h=(new DataView(b,m,4)).getUint32(0,a);break;case 5:h=(new DataView(b,m,4)).getUint32(0,a)/(new DataView(b,m+4,4)).getUint32(0,a);break;case 6:h=(new DataView(b,m,1)).getInt8(0);break;case 7:h=(new DataView(b,m,1)).getUint8(0);break;case 8:h=(new DataView(b,
m,2)).getInt16(0,a);break;case 9:h=(new DataView(b,m,4)).getInt32(0,a);break;case 10:h=(new DataView(b,m,4)).getInt32(0,a)/(new DataView(b,m+4,4)).getInt32(0,a);break;case 11:h=(new DataView(b,m,4)).getFloat32(0,a);break;case 12:h=(new DataView(b,m,8)).getFloat64(0,a);break;case 16:case 18:h=Q(new DataView(b,m,8),0,a);break;case 17:c=new DataView(b,m,8);k=(h=a)?c.getInt32(0,h):c.getUint32(0,h);c=h?c.getUint32(4,h):c.getInt32(4,h);q=0<=(h?k:c)?1:-1;h?k*=q:c*=q;h=q*(h?4294967296*c+k:4294967296*k+c);
break;default:h=null}g.push(h)}if(2===d){d="";f=g;g=[];for(b=0;b<f.length;b++)0===f[b]&&""!==d?(g.push(d),d=""):d+=String.fromCharCode(f[b]);""===d&&0!==g.length||g.push(d)}e.values=g;return!0}function W(b){var a=b[0];const e=y(a,"TILEWIDTH"),k=y(a,"TILELENGTH"),c=y(a,"IMAGEWIDTH"),l=y(a,"IMAGELENGTH");var d=y(a,"BITSPERSAMPLE");const m=y(a,"SAMPLESPERPIXEL");var f=y(a,"SAMPLEFORMAT")||1;const g=T(f,d),n=D(a,"PLANARCONFIGURATION")?2===D(a,"PLANARCONFIGURATION")[0]:!1;var h=D(a,"GDAL_NODATA");let w;
null!=h&&("string"===typeof h[0]?(w=h.map(E=>parseFloat(E)),w.some(E=>isNaN(E))&&(w=null)):"number"===typeof h[0]&&(w=h));var q=y(a,"COMPRESSION")||1;switch(q){case 1:h="NONE";break;case 2:case 3:case 4:case 32771:h="CCITT";break;case 5:h="LZW";break;case 6:case 7:h="JPEG";break;case 32773:h="PACKBITS";break;case 8:case 32946:h="DEFLATE";break;case 34712:h="JPEG2000";break;default:h=String(q)}let x=!0,A="";1!==q&&5!==q&&6!==q&&8!==q&&32946!==q&&(x=!1,A+="unsupported tag compression "+q);3<f&&(x=!1,
A+="unsupported tag sampleFormat "+f);0!==d%8&&(x=!1,A+="unsupported tag bitsPerSample "+d);d=y(a,"GEOASCIIPARAMS");if(d){var u=(u=d.split("|").filter(E=>-1<E.indexOf("ESRI PE String \x3d "))[0])?u.replace("ESRI PE String \x3d ",""):"";u=0===u.indexOf("PROJCS")||0===u.indexOf("GEOGCS")?{wkid:null,wkt:u}:null}d=D(a,"GEOTIEPOINTS");f=D(a,"GEOPIXELSCALE");q=D(a,"GEOTRANSMATRIX");var t=a.has("GEOKEYDIRECTORY")?a.get("GEOKEYDIRECTORY").data:null;a=!1;if(t){a=2===y(t,"GTRasterTypeGeoKey");var r=y(t,"GTModelTypeGeoKey");
2===r?(t=y(t,"GeographicTypeGeoKey"),1024<=t&&32766>=t&&(u={wkid:t})):1===r&&(t=y(t,"ProjectedCSTypeGeoKey"),1024<=t&&32766>=t&&(u={wkid:t}))}if(f&&d&&6<=d.length){var v=[f[0],0,d[3]-d[0]*f[0],0,-Math.abs(f[1]),d[4]-d[1]*f[1]];a&&(v[2]-=.5*v[0]+.5*v[1],v[5]-=.5*v[3]+.5*v[4])}else q&&16===q.length&&(v=[q[0],q[1],q[3],q[4],q[5],q[7]]);if(v){var C=[{x:0,y:l},{x:0,y:0},{x:c,y:l},{x:c,y:0}];f=d=Number.POSITIVE_INFINITY;t=q=Number.NEGATIVE_INFINITY;for(r=0;r<C.length;r++)a=ea(C[r],v),d=a.x>d?d:a.x,q=a.x<
q?q:a.x,f=a.y>f?f:a.y,t=a.y<t?t:a.y;C={xmin:d,xmax:q,ymin:f,ymax:t,spatialReference:u}}v=b.filter(E=>1===y(E,"NEWSUBFILETYPE"));let G,p,F,B;0<v.length&&(G=Math.round(Math.log(c/y(v[0],"IMAGEWIDTH"))/Math.LN2),p=Math.round(Math.log(c/y(v[v.length-1],"IMAGEWIDTH"))/Math.LN2),F=y(v[v.length-1],"TILEWIDTH"),B=y(v[v.length-1],"TILEHEIGHT"));F=0<p?F||e:null;B=0<p?B||k:null;let z;e&&(z=[{maxCol:Math.ceil(c/e)-1,maxRow:Math.ceil(l/k)-1,minRow:0,minCol:0}],v.forEach(E=>{z.push({maxCol:Math.ceil(y(E,"IMAGEWIDTH")/
y(E,"TILEWIDTH"))-1,maxRow:Math.ceil(y(E,"IMAGELENGTH")/y(E,"TILELENGTH"))-1,minRow:0,minCol:0})}));b=y(b[0],"GDAL_METADATA");b=fa(b);return{width:c,height:l,tileWidth:e,tileHeight:k,planes:m,isBSQ:n,pixelType:g,compression:h,noData:w,isSupported:x,message:A,extent:C,firstPyramidLevel:G,maximumPyramidLevel:p,pyramidBlockWidth:F,pyramidBlockHeight:B,tileBoundary:z,metadata:b}}function X(b){const {littleEndian:a,isBigTiff:e,firstIFD:k}=Y(b);var c=k;const l=[];do if(c=Z(b,a,c,0,J.TIFF_TAGS,e?8:4),c.success)l.push(c.ifd),
c=c.nextIFD;else break;while(0<c);return{...W(l),littleEndian:a,isBigTiff:e,ifds:l}}function Q(b,a,e){const k=b.getUint32(a,e);b=b.getUint32(a+4,e);return e?4294967296*b+k:4294967296*k+b}function M(b,a,e,k){return k?Q(b,a,e):b.getUint32(a,e)}function Y(b){var a=new DataView(b,0,16),e=a.getUint16(0,!1);b=null;if(18761===e)b=!0;else if(19789===e)b=!1;else throw"unexpected endianess byte";var k=a.getUint16(2,b);if(42!==k&&43!==k)throw"unexpected tiff identifier";e=4;if(k=43===k){const c=a.getUint16(e,
b);e+=2;if(8!==c)throw"unsupported bigtiff version";if(0!==a.getUint16(e,b))throw"unsupported bigtiff version";e+=2}a=M(a,e,b,k);return{littleEndian:b,isBigTiff:k,firstIFD:a}}function Z(b,a,e,k=0,c=J.TIFF_TAGS,l=4){e=P(b,a,e,k,c,l);let d;const m=e.ifd;m&&(J.ifdTags.forEach((f,g)=>{m.has(g)&&(d=m.get(g),d.data=P(b,a,d.valueOffset-k,k,f).ifd)}),m.has("GEOKEYDIRECTORY")&&(d=m.get("GEOKEYDIRECTORY"),(c=d.values)&&4<c.length&&(c=c[0]+"."+c[1]+"."+c[2],d.data=P(b,a,d.valueOffset+6-k,k,J.GEO_KEYS,2).ifd,
d.data&&d.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[c]}))),m.has("XMP")&&(d=m.get("XMP"),c=d.values,"number"===typeof c[0]&&7===d.type&&(d.values=[ca.bytesToUTF8(new Uint8Array(c))])));return e}const V=[0,1,1,2,4,8,1,1,2,4,8,4,8,-1,-1,-1,8,8,8],aa=function(b,a,e,k,c){var l=S.isPlatformLittleEndian===a,d=y(e,"BITSPERSAMPLE"),m=y(e,"SAMPLEFORMAT")||1;d=T(m,d);m=y(e,"COMPRESSION")||1;e=L(d);if(1===m){var f=b.slice(k,k+c);var g=new Uint8Array(f)}else 8===m||32946===
m?(g=new Uint8Array(b,k,c),g=new O.Zlib(g),b=g.getBytes(),f=new ArrayBuffer(b.length),g=new Uint8Array(f),g.set(b)):6===m?(g=new Uint8Array(b,k,c),f=new R.Jpg,f.parse(g),b=f.getData(f.width,f.height,!0),f=new ArrayBuffer(b.length),g=new Uint8Array(f),g.set(b)):5===m&&(g=da.decode(b,k,c,a),f=g.buffer);if("u8"!==d&&"s8"!==d&&!l)switch(f=new ArrayBuffer(g.length),l=new Uint8Array(f),d){case "u16":case "s16":for(d=0;d<g.length;d+=2)l[d]=g[d+1],l[d+1]=g[d];break;case "u32":case "s32":case "f32":for(d=
0;d<g.length;d+=4)l[d]=g[d+3],l[d+1]=g[d+2],l[d+2]=g[d+1],l[d+3]=g[d]}return new e(f)},ha=function(b,a,e){if(!(b&&0<b.length&&a&&e))return null;let k,c,l;const d=b[0].length,m=b.length,f=new Uint8Array(d);for(let n=0;n<m;n++)if(k=b[n],c=a[n],l=e[n],0===n)for(var g=0;g<d;g++)f[g]=k[g]<c||k[g]>l?0:1;else for(g=0;g<d;g++)f[g]&&(f[g]=k[g]<c||k[g]>l?0:1);return f},fa=function(b){if(!b)return null;var a=b.match(/<Item(.*?)Item>/gi);if(!a||0===a.length)return null;b=new Map;var e;for(var k=0;k<a.length;k++){var c=
a[k];var l=c.slice(6,c.indexOf("\x3e"));var d=c.indexOf("sample\x3d");-1<d&&(e=c.slice(d+8,c.indexOf('"',d+8)));d=c.indexOf("name\x3d");-1<d&&(l=c.slice(d+6,c.indexOf('"',d+6)));l&&(c=c.slice(c.indexOf("\x3e")+1,c.indexOf("\x3c/Item\x3e")).trim(),null!=e?b.has(l)?b.get(l)[e]=c:b.set(l,[c]):b.set(l,c));e=null}a=b.get("STATISTICS_MINIMUM");l=b.get("STATISTICS_MAXIMUM");k=b.get("STATISTICS_MEAN");c=b.get("STATISTICS_STDDEV");e=null;if(a&&l)for(e=[],d=0;d<a.length;d++)e.push({min:parseFloat(a[d]),max:parseFloat(l[d]),
avg:k&&parseFloat(k[d]),stddev:c&&parseFloat(c[d])});l=b.get("BandName");k=b.get("WavelengthMin");c=b.get("WavelengthMax");a=null;if(l)for(a=[],d=0;d<l.length;d++)a.push({BandName:l[d],WavelengthMin:k&&parseFloat(k[d]),WavelengthMax:c&&parseFloat(c[d])});l=b.get("DataType");return{statistics:e,bandProperties:a,dataType:l,rawMetadata:b}};H.decode=function(b,a){a=a||X(b);const {ifds:e,noData:k}=a;if(0===e.length)throw"no valid image file directory";var c=e[0];const l=k?k[0]:null;if(a.tileWidth){var d=
D(c,"TILEOFFSETS");if(void 0===d)c=null;else{var m=D(c,"TILEBYTECOUNTS"),f=a.tileWidth,g=a.tileHeight,{width:n,height:h,pixelType:w,isBSQ:q}=a,x=a.planes,A=n*h,u=D(c,"BITSPERSAMPLE")[0],t=L(w),r=[];for(var v=0;v<x;v++)r.push(new t(A));var C,G;A=Math.ceil(n/f);if(0===u%8)for(u=0;u<d.length;u++){var p=Math.floor(u/A)*g;var F=u%A*f;v=p*n+F;t=aa(b,a.littleEndian,c,d[u],m[u]);var B=0;var z=v;F=Math.min(f,n-F);var E=Math.min(g,h-p);for(p=0;p<x;p++){var ba=r[p];if(q)for(C=0;C<E;C++)for(z=v+C*n,B=f*g*p+C*
f,G=0;G<F;G++,z++,B++)ba[z]=t[B];else for(C=0;C<E;C++)for(z=v+C*n,B=C*f*x+p,G=0;G<F;G++,z++,B+=x)ba[z]=t[B]}}c={width:n,height:h,pixelType:w,pixels:r}}}else if(d=S.isPlatformLittleEndian===a.littleEndian,A=D(c,"STRIPOFFSETS"),void 0===A)c=null;else{var {width:I,height:N,pixelType:K}=a;a=a.planes;m=I*N;u=D(c,"BITSPERSAMPLE")[0];f=L(K);g=new f(m*a);t=D(c,"STRIPBYTECOUNTS");v=D(c,"ROWSPERSTRIP")[0];B=D(c,"COMPRESSION")?D(c,"COMPRESSION")[0]:1;p=v;if(0===u%8)for(c=0;c<A.length;c++){F=c*v*I*a;p=(c+1)*
v>N?N-c*v:v;if("u8"===K||"s8"===K||d)8===B||32946===B?(r=new Uint8Array(b,A[c],t[c]),r=new O.Zlib(r),C=r.getBytes(),z=new ArrayBuffer(C.length),r=new Uint8Array(z),r.set(C),r.length!==p*I*a*u/8&&console.log("strip byte counts is different than expected")):6===B?(r=new Uint8Array(b,A[c],t[c]),z=new R.Jpg,z.parse(r),p=z.getData(z.width,z.height,!0),z=new ArrayBuffer(p.length),r=new Uint8Array(z),r.set(p)):1===B&&(t[c]!==p*I*a*u/8&&console.log("strip byte counts is different than expected"),z=b.slice(A[c],
A[c]+t[c]));else switch(6===B||8===B||32946===B?(r=new Uint8Array(b,A[c],t[c]),r=new O.Zlib(r),r=r.getBytes(),z=new ArrayBuffer(r.length),x=new Uint8Array(z),r.length!==p*I*a*u/8&&console.log("strip byte counts is different than expected")):1===B&&(t[c]!==p*I*a*u/8&&console.log("strip byte counts is different than expected"),z=new ArrayBuffer(t[c]),r=new Uint8Array(b,A[c],t[c]),x=new Uint8Array(z)),K){case "u16":case "s16":for(p=0;p<r.length;p+=2)x[p]=r[p+1],x[p+1]=r[p];break;case "u32":case "s32":case "f32":for(p=
0;p<r.length;p+=4)x[p]=r[p+3],x[p+1]=r[p+2],x[p+2]=r[p+1],x[p+3]=r[p]}p=new f(z);g.set(p,F)}r=[];if(1===a)r.push(g);else for(c=0;c<a;c++){x=new f(m);for(b=0;b<m;b++)x[b]=g[b*a+c];r.push(x)}c={width:I,height:N,pixelType:K,pixels:r}}if(null!==l){c.mask=new Uint8Array(c.width*c.height);if(1E24<Math.abs(l))for(b=0;b<c.width*c.height;b++)c.mask[b]=1E-6>Math.abs((c.pixels[0][b]-l)/l)?0:1;else for(b=0;b<c.width*c.height;b++)c.mask[b]=c.pixels[0][b]===l?0:1;c.noDataValue=l}return c};H.decodeTileOrStrip=function(b,
a){const {headerInfo:e,ifd:k}=a;var c=aa(b,e.littleEndian,k,a.offset||0,a.size||b.byteLength);const {pixelType:l,isBSQ:d,planes:m}=e;var f=L(l);b=c.length/m;const g=[];for(var n=0;n<m;n++){var h=new f(b);if(d)h=c.slice(b*n,b*(n+1));else for(var w=0;w<b;w++)h[w]=c[w*m+n];g.push(h)}c=y(k,"TILEWIDTH");f=y(k,"TILELENGTH");h=e.noData?e.noData[0]:null;n=(w=e.metadata?e.metadata.statistics:null)?w.map(x=>x.min):null;w=w?w.map(x=>x.max):null;let q;if(null!=h)if(q=new Uint8Array(b),1E24<Math.abs(h))for(a=
0;a<b;a++)q[a]=1E-6>Math.abs((g[0][a]-h)/h)?0:1;else for(a=0;a<b;a++)q[a]=g[0][a]===h?0:1;else n&&w&&a.applyMinMaxConstraint&&(q=ha(g,n,w));return{pixelType:l,width:c,height:f,pixels:g,mask:q,noDataValue:h}};H.getImageInfo=W;H.parseFieldValues=U;H.parseHeader=X;H.parseIFD=Z;H.parseSignature=Y;Object.defineProperty(H,"__esModule",{value:!0})});