// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../geometry/support/WKIDUnitConversion ../../geometry/SpatialReference ../../geometry/Point ../../geometry/Extent ../../geometry/projectionEllipsoid ./TileInfo".split(" "),function(w,E,y,F,z,G,H,I){function r(a,b){return(a=b.getElementsByTagName(a))&&0<a.length?a[0]:null}function u(a,b){return Array.prototype.slice.call(b.getElementsByTagName(a)).map(d=>d.textContent)}function p(a,b){a.split("\x3e").forEach(d=>{b&&(b=r(d,b))});return b&&b.textContent}function v(a,
b,d,e){let f;Array.prototype.slice.call(e.childNodes).some(c=>{if(-1<c.nodeName.indexOf(a)){var g=r(b,c);g=g&&g.textContent;if(g===d||d.split(":")&&d.split(":")[1]===g)return f=c,!0}return!1});return f}function A(a,b){const d=[];var e=a.layerMap.get(b);if(e){var f=Array.prototype.slice.call(e.getElementsByTagName("ResourceURL"));e=e.getElementsByTagName("Dimension");if(e.length){var c=p("Identifier",e[0]);var g=u("Default",e[0])||u("Value",e[0])}if(1<e.length){var m=p("Identifier",e[1]);var n=u("Default",
e[1])||u("Value",e[1])}a.dimensionMap.set(b,{dimensions:g,dimensions2:n});f.forEach(l=>{let h=l.getAttribute("template");if("tile"===l.getAttribute("resourceType")){if(c&&g.length)if(-1<h.indexOf("{"+c+"}"))h=h.replace("{"+c+"}","{dimensionValue}");else{var k=h.toLowerCase().indexOf("{"+c.toLowerCase()+"}");-1<k&&(h=h.substring(0,k)+"{dimensionValue}"+h.substring(k+c.length+2))}m&&n.length&&(-1<h.indexOf("{"+m+"}")?h=h.replace("{"+m+"}","{dimensionValue2}"):(k=h.toLowerCase().indexOf("{"+m.toLowerCase()+
"}"),-1<k&&(h=h.substring(0,k)+"{dimensionValue2}"+h.substring(k+m.length+2))));d.push({template:h,format:l.getAttribute("format"),resourceType:"tile"})}});return d}}function J(a,b){return Array.prototype.slice.call(a.getElementsByTagName("Style")).map(d=>{var e=r("LegendURL",d),f=r("Keywords",d);f=f&&u("Keyword",f);e=e&&e.getAttribute("xlink:href");b&&(e=e&&e.replace(/^http:/i,"https:"));return{abstract:p("Abstract",d),id:p("Identifier",d),isDefault:"true"===d.getAttribute("isDefault"),keywords:f,
legendUrl:e,title:p("Title",d)}})}function K(a,b){return u("TileMatrixSet",a).map(d=>L(d,a,b))}function L(a,b,d){b=v("TileMatrixSetLink","TileMatrixSet",a,b);b=u("TileMatrix",b);const e=v("TileMatrixSet","Identifier",a,d);d=M(e);const f=d.spatialReference,c=f.wkid;var g=r("TileMatrix",e);g=[parseInt(p("TileWidth",g),10),parseInt(p("TileHeight",g),10)];const m=[];b.length?b.forEach((n,l)=>{n=v("TileMatrix","Identifier",n,e);m.push(B(n,c,l,a))}):Array.prototype.slice.call(e.getElementsByTagName("TileMatrix")).forEach((n,
l)=>{m.push(B(n,c,l,a))});b=N(e,d,g,m[0]);return{id:a,fullExtent:b.toJSON(),tileInfo:(new I({dpi:96,spatialReference:f,size:g,origin:d,lods:m})).toJSON()}}function M(a){let b=p("SupportedCRS",a);b&&(b=b.toLowerCase());let d=parseInt(b.split(":").pop(),10);if(900913===d||3857===d)d=102100;let e=!1;if(-1<b.indexOf("crs84")||-1<b.indexOf("crs:84"))d=4326,e=!0;else if(-1<b.indexOf("crs83")||-1<b.indexOf("crs:83"))d=4269,e=!0;else if(-1<b.indexOf("crs27")||-1<b.indexOf("crs:27"))d=4267,e=!0;const f=new F({wkid:d});
a=r("TileMatrix",a);var c=p("TopLeftCorner",a).split(" ");a=c[0].split("E").map(h=>Number(h));c=c[1].split("E").map(h=>Number(h));let g=a[0],m=c[0],n;1<a.length&&(g=a[0]*Math.pow(10,a[1]));1<c.length&&(m=c[0]*Math.pow(10,c[1]));const l=e&&4326===d&&90===g&&-180===m;C.some((h,k)=>{const q=Number(b.split(":").pop());if(q>=h[0]&&q<=h[1]||4326===d&&(!e||l))return n=new z(m,g,f),!0;k===C.length-1&&(n=new z(g,m,f));return!1});return n}function N(a,b,d,e){var f=r("BoundingBox",a);if(f){var c=p("LowerCorner",
f).split(" ");var g=p("UpperCorner",f).split(" ")}c&&1<c.length&&g&&1<g.length?(a=parseFloat(c[0]),d=parseFloat(c[1]),c=parseFloat(g[0]),g=parseFloat(g[1])):(a=r("TileMatrix",a),c=parseFloat(p("MatrixWidth",a)),f=parseFloat(p("MatrixHeight",a)),a=b.x,g=b.y,c=a+c*d[0]*e.resolution,d=g-f*d[1]*e.resolution);return new G(a,d,c,g,b.spatialReference)}function B(a,b,d,e){const f=p("Identifier",a);a=p("ScaleDenominator",a).split("E").map(c=>Number(c));a=1<a.length?a[0]*Math.pow(10,a[1]):a[0];b=D(b,a,e);return{level:d,
levelValue:f,scale:1.058267716535433*a,resolution:b}}function D(a,b,d){a=y.hasOwnProperty(String(a))?y.values[y[a]]:"default028mm"===d?6370997*Math.PI/180:H.getReferenceEllipsoidFromWKID(a).metersPerDegree;return 7*b/25E3/a}const C=[[3819,3819],[3821,3824],[3889,3889],[3906,3906],[4001,4025],[4027,4036],[4039,4047],[4052,4055],[4074,4075],[4080,4081],[4120,4176],[4178,4185],[4188,4216],[4218,4289],[4291,4304],[4306,4319],[4322,4326],[4463,4463],[4470,4470],[4475,4475],[4483,4483],[4490,4490],[4555,
4558],[4600,4646],[4657,4765],[4801,4811],[4813,4821],[4823,4824],[4901,4904],[5013,5013],[5132,5132],[5228,5229],[5233,5233],[5246,5246],[5252,5252],[5264,5264],[5324,5340],[5354,5354],[5360,5360],[5365,5365],[5370,5373],[5381,5381],[5393,5393],[5451,5451],[5464,5464],[5467,5467],[5489,5489],[5524,5524],[5527,5527],[5546,5546],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,
2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3038,3051],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3150,3151],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3389,3390],[3416,3417],[3833,3841],[3844,3850],[3854,3854],[3873,3885],[3907,3910],[4026,4026],[4037,4038],[4417,4417],[4434,4434],[4491,4554],[4839,4839],[5048,5048],[5105,5130],[5253,5259],[5269,5275],[5343,5349],[5479,5482],[5518,5519],[5520,5520],[20004,20032],[20064,20092],[21413,21423],[21473,21483],
[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]];w.getTileUrlFromResourceUrls=function(a,b,d,e,f,c,g,m){var {dimensionMap:n}=a;a=A(a,b);const l=n.get(b).dimensions&&n.get(b).dimensions[0];b=n.get(b).dimensions2&&n.get(b).dimensions2[0];n="";if(a&&0<a.length){let h=null;a.some(k=>k.format===e?(h=k,!0):!1);h||(h=a[g%a.length]);
n=h.template.replace(/\{Style\}/gi,f).replace(/\{TileMatrixSet\}/gi,d).replace(/\{TileMatrix\}/gi,c).replace(/\{TileRow\}/gi,""+g).replace(/\{TileCol\}/gi,""+m).replace(/\{dimensionValue\}/gi,l).replace(/\{dimensionValue2\}/gi,b)}return n};w.getTileUrlTemplateFromResourceUrls=function(a,b,d,e){const {dimensionMap:f}=a;a=A(a,b);let c="";if(a&&0<a.length){const g=f.get(b).dimensions&&f.get(b).dimensions[0];b=f.get(b).dimensions2&&f.get(b).dimensions2[0];c=a[0].template;c.indexOf(".xxx")===c.length-
4&&(c=c.slice(0,c.length-4));c=c.replace(/\{Style\}/gi,e);c=c.replace(/\{TileMatrixSet\}/gi,d);c=c.replace(/\{TileMatrix\}/gi,"{level}");c=c.replace(/\{TileRow\}/gi,"{row}");c=c.replace(/\{TileCol\}/gi,"{col}");c=c.replace(/\{dimensionValue\}/gi,g);c=c.replace(/\{dimensionValue2\}/gi,b)}return c};w.parseCapabilities=function(a,b){a=a.replace(/ows:/gi,"");var d=(new DOMParser).parseFromString(a,"text/xml").documentElement;const e=new Map;a=new Map;const f=r("Contents",d);if(!f)throw new E("wmtslayer:wmts-capabilities-xml-is-not-valid");
var c=r("OperationsMetadata",d);c=(c=(c=c&&c.querySelector("[name\x3d'GetTile']"))&&c.getElementsByTagName("Get"))&&Array.prototype.slice.call(c);const g=b&&b.url&&-1<b.url.indexOf("https");let m=b.serviceMode,n,l=b&&b.url,h;c&&c.length&&c.some(k=>{const q=r("Constraint",k);if(!q||v("AllowedValues","Value",m,q))return l=k.attributes[0].nodeValue,!0;if(!q||v("AllowedValues","Value","RESTful",q)||v("AllowedValues","Value","REST",q))h=k.attributes[0].nodeValue;else if(!q||v("AllowedValues","Value","KVP",
q))n=k.attributes[0].nodeValue;return!1});l||(h?(l=h,m="RESTful"):n?(l=n,m="KVP"):l=(b=r("ServiceMetadataURL",d))&&b.getAttribute("xlink:href"));b=l.indexOf("1.0.0/");-1===b&&"RESTful"===m?l+="/":-1<b&&(l=l.substring(0,b));"KVP"===m&&(l+=-1<b?"":"?");g&&(l=l.replace(/^http:/i,"https:"));d=p("ServiceIdentification\x3eAccessConstraints",d);b=Array.prototype.slice.call(f.getElementsByTagName("Layer")).map(k=>{var q=p("Identifier",k);e.set(q,k);{const O=p("Abstract",k),P=u("Format",k);var t=r("WGS84BoundingBox",
k);var x=t?p("LowerCorner",t).split(" "):["-180","-90"];t=t?p("UpperCorner",t).split(" "):["180","90"];x={xmin:parseFloat(x[0]),ymin:parseFloat(x[1]),xmax:parseFloat(t[0]),ymax:parseFloat(t[1]),spatialReference:{wkid:4326}};t=J(k,g);const Q=p("Title",k);k=K(k,f);q={id:q,fullExtent:x,description:O,formats:P,styles:t,title:Q,tileMatrixSets:k}}return q});return{copyright:d,layers:b,tileUrl:l,serviceMode:m,layerMap:e,dimensionMap:a}};w.parseResourceInfo=function(a){a.layers.forEach(b=>{b.tileMatrixSets.forEach(d=>
{const e=d.tileInfo;96!==e.dpi&&(e.lods.forEach(f=>{f.scale=96*f.scale/e.dpi;f.resolution=D(e.spatialReference.wkid,90.71428571428571*f.scale/96,d.id)}),e.dpi=96)})});return a};Object.defineProperty(w,"__esModule",{value:!0})});