// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../core/maybe ../../core/Logger ../../core/Error ../../geometry/support/spatialReferenceUtils ../../request ../support/fieldType ../graphics/OptimizedFeatureSet ../graphics/featureConversionUtils ../support/FieldsIndex ../../tasks/support/FeatureSet ../graphics/data/projectionSupport ../graphics/sources/geojson/geojson ../graphics/sources/support/clientSideDefaults".split(" "),function(k,r,F,p,m,n,G,H,u,I,J,v,w,K){async function C(a,c,b){a=await D(a,c,b);return u.convertToFeatureSet(a)}
async function D(a,c,b){var g;const {capabilities:{query:{maxRecordCount:e}},collectionId:h,layerDefinition:l,url:d}=a;a=`${d}/collections/${h}/items`;const {geometry:q,num:E,start:x,timeExtent:L,where:M}=c;c=r.isSome(c.outSpatialReference)?c.outSpatialReference:m.WGS84;var y=v.project(q,m.WGS84);y=N(y);const P=O(L),R=Q(M);({data:b}=await n(a,{...b,query:{bbox:y,datetime:P,query:R,limit:null!=E?E:null!=x&&void 0!==x?10:e,startindex:x,f:"json"}}));a=null==(g=b.links)?void 0:g.filter(t=>"next"===t.rel);
g=0!==(null==a?void 0:a.length);const {fields:S,globalIdField:T,hasM:U,hasZ:z,objectIdField:A}=l;a=l.geometryType;b=w.createOptimizedFeatures(b,{geometryType:a,hasZ:z,objectIdFieldName:A});if(!m.equals(c,m.WGS84))for(var f of b)f.geometry&&(f.geometry=u.convertFromGeometry(v.project(u.convertToGeometry(f.geometry,a,z,!1),m.WGS84,c)));for(const t of b)t.objectId=t.attributes[A];f=new H;f.exceededTransferLimit=g;f.features=b;f.fields=S;f.geometryType=a;f.globalIdFieldName=T;f.hasM=U;f.hasZ=z;f.objectIdFieldName=
A;f.spatialReference=c||m.WGS84;return f}function N(a){if(r.isNone(a))return null;const {xmin:c,ymin:b,xmax:g,ymax:e}=a;return`${c},${b},${g},${e}`}function O(a){if(r.isNone(a))return null;const {start:c,end:b}=a;return`${c?c.toISOString():".."}/${b?b.toISOString():".."}`}function Q(a){return r.isNone(a)||!a||"1\x3d1"===a?null:a}const B=F.getLogger("esri.layers.graphics.sources.ogcfeature");k.getCollectionDefinition=async function(a,c,b,g,e=5){try{await v.checkProjectionSupport(m.WGS84,b.spatialReference)}catch{throw new p("ogc-feature-layer:projection-not-supported",
"Projection not supported");}({data:a}=await n(`${a}/collections/${c}/items`,{signal:g,query:{limit:e,f:"json"}}));await w.validateGeoJSON(a);const h=w.inferLayerProperties(a,{geometryType:b.geometryType});a=b.fields||h.fields||[];c=null!=b.hasZ?b.hasZ:h.hasZ;g=h.geometryType;const l=b.objectIdField||h.objectIdFieldName||"OBJECTID";b=b.timeInfo;if(e=a.find(q=>q.name===l))e.type="esriFieldTypeOID",e.editable=!1,e.nullable=!1;else{if(!h.objectIdFieldType)throw new p("ogc-feature-layer:missing-feature-id",
"Collection geojson require a feature id as a unique identifier");a.unshift({name:l,alias:l,type:"esriFieldTypeOID",editable:!1,nullable:!1})}l!==h.objectIdFieldName&&(e=a.find(q=>q.name===h.objectIdFieldName))&&(e.type="esriFieldTypeInteger");if(!g)throw new p("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");a===h.fields&&0<h.unknownFields.length&&B.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",
details:{unknownFields:h.unknownFields}});for(var d of a){null==d.name&&(d.name=d.alias);null==d.alias&&(d.alias=d.name);"esriFieldTypeOID"!==d.type&&"esriFieldTypeGlobalID"!==d.type&&(d.editable=null==d.editable?!0:!!d.editable,d.nullable=null==d.nullable?!0:!!d.nullable);if(!d.name)throw new p("ogc-feature-layer:invalid-field-name","field name is missing",{field:d});if(-1===G.kebabDict.jsonValues.indexOf(d.type))throw new p("ogc-feature-layer:invalid-field-type",`invalid type for field "${d.name}"`,
{field:d});}b&&(d=new I(a),b.startTimeField&&((e=d.get(b.startTimeField))?(b.startTimeField=e.name,e.type="esriFieldTypeDate"):b.startTimeField=null),b.endTimeField&&((e=d.get(b.endTimeField))?(b.endTimeField=e.name,e.type="esriFieldTypeDate"):b.endTimeField=null),b.trackIdField&&((d=d.get(b.trackIdField))?b.trackIdField=d.name:(b.trackIdField=null,B.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:b}}))),b.startTimeField||b.endTimeField||
(B.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:b}}),b=null));return{drawingInfo:K.createDrawingInfo(g),geometryType:g,fields:a,hasZ:!!c,objectIdField:l,timeInfo:b}};k.getServerCollection=async function(a,c,b){({data:a}=await n(`${a}/collections/${c}`,{signal:b,query:{f:"json"}}));return a};k.getServerCollections=async function(a,c){({data:a}=await n(`${a}/collections`,{signal:c,query:{f:"json"}}));return a};k.getServerConformance=
async function(a,c){({data:a}=await n(`${a}/conformance`,{signal:c,query:{f:"json"}}));return a};k.getServerLandingPage=async function(a,c){({data:a}=await n(a,{signal:c,query:{f:"json"}}));return a};k.queryFeatureSet=async function(a,c,b){a=await C(a,c,b);return J.fromJSON(a)};k.queryFeatureSetJSON=C;k.queryOptimizedFeatureSet=D;Object.defineProperty(k,"__esModule",{value:!0})});