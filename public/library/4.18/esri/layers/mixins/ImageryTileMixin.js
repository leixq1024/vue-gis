// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/has ../../core/maybe ../../core/Logger ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/property ../../core/accessorSupport/decorators/aliasOf ../../core/jsonMap ../../core/accessorSupport/decorators/subclass ../../core/urlUtils ../../core/uuid ../../portal/support/resourceExtension ../../geometry/support/spatialReferenceUtils ../../geometry/SpatialReference ../../geometry/Extent ../../geometry ../../request ../../rasterRenderers ../support/arcgisLayerUrl ../support/commonProperties ../support/TileInfo ../support/DimensionalDefinition ../support/RasterJobHandler ../../renderers/support/rasterRendererHelper ../../renderers/support/RasterSymbolizer".split(" "),
function(n,p,f,I,v,w,J,g,k,K,x,L,M,N,y,z,A,O,B,C,D,E,q,r,F,m,G){const t=w.getLogger("esri.layers.mixins.ImageryTileMixin");n.ImageryTileMixin=c=>{c=function(u){function l(){var a=u.apply(this,arguments)||this;a._rasterJobHandler={instance:null,refCount:0,connectionPromise:null};a.bandIds=null;a.copyright=null;a.fullExtent=null;a.interpolation="nearest";a.raster=null;a.rasterInfo=null;a.sourceJSON=null;a.spatialReference=null;a.tileInfo=null;a.symbolizer=null;return a}p._inheritsLoose(l,u);var h=l.prototype;
h.updateRenderer=async function(){if(this.loaded&&JSON.stringify(this._cachedRendererJson)!==JSON.stringify(this.renderer)){var a=this._rasterJobHandler.instance;a&&(this.symbolizer.rendererJSON=this.renderer.toJSON(),this.symbolizer.bind(),await a.updateSymbolizer(this.symbolizer),this._cachedRendererJson=this.renderer.toJSON())}};h.applyRenderer=async function(a,b){var d=a&&a.pixelBlock;if(!(d&&d.pixels&&0<d.pixels.length))return null;this.updateRenderer();d=this._rasterJobHandler.instance;const {bandIds:e}=
this;return d?await d.symbolize({...a,simpleStretchParams:b,bandIds:e}):this.symbolizer.symbolize({...a,simpleStretchParams:b,bandIds:e})};h.getTileUrl=function(a,b,d){return"RasterTileServer"===this.raster.datasetFormat?`${this.url}/tile/${a}/${b}/${d}`:""};h.getCompatibleTileInfo=function(a,b){if(!this.loaded)return null;const d=y.getInfo(a);return q.create({size:256,spatialReference:a,origin:d?{x:d.origin[0],y:d.origin[1]}:{x:b.xmin,y:b.ymax}})};h.getCompatibleFullExtent=function(a){return this.loaded?
this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(a)?this._compatibleFullExtent:this._compatibleFullExtent=this.raster.computeExtent(a):null};h.fetchTile=async function(a,b,d,e={}){if(e.requestAsImageElement)return a=this.getTileUrl(a,b,d),B(a,{responseType:"image",query:{sliceId:this._sliceId,_ts:e.timestamp},signal:e.signal}).then(H=>H.data);await this._initJobHandler();this.multidimensionalDefinition&&(e={multidimensionalDefinition:this.multidimensionalDefinition,sliceId:this._sliceId,
...e});"raster-shaded-relief"===this.renderer.type&&(e={buffer:{cols:1,rows:1},...e});return this.raster.fetchTile(a,b,d,e)};h.fetchPixels=async function(a,b,d,e){await this._initJobHandler();this.multidimensionalDefinition&&(e={multidimensionalDefinition:this.multidimensionalDefinition,sliceId:this._sliceId,...e});return this.raster.fetchPixels(a,b,d,e)};h.identify=function(a,b={}){this.multidimensionalDefinition&&!b.multidimensionalDefinition&&(b={...b,multidimensionalDefinition:this.multidimensionalDefinition});
return this.raster.identify(a,b)};h.increaseRasterJobHandlerUsage=function(){this._rasterJobHandler.refCount++};h.decreaseRasterJobHandlerUsage=function(){this._rasterJobHandler.refCount--;0>=this._rasterJobHandler.refCount&&this._shutdownJobHandler()};h._configDefaultSettings=function(){this._configDefaultInterpolation();this._configDefaultSlice();this._configDefaultRenderer()};h._initJobHandler=function(){if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;
const a=new F;this._rasterJobHandler.connectionPromise=a.initialize().then(()=>{this._rasterJobHandler.instance=a;this.raster.rasterJobHandler=a;this.renderer&&this.updateRenderer()}).catch(()=>null);return this._rasterJobHandler.connectionPromise};h._shutdownJobHandler=function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy();this._rasterJobHandler.instance=null;this._rasterJobHandler.connectionPromise=null;this._rasterJobHandler.refCount=0;this.raster.rasterJobHandler=
null};h._configDefaultInterpolation=function(){if(null==this.interpolation){var a;const b=m.getDefaultInterpolation(this.rasterInfo,this.raster.tileType,null==(a=this.sourceJSON)?void 0:a.defaultResamplingMethod);this._set("interpolation",b)}};h._configDefaultSlice=function(){const {multidimensionalInfo:a}=this.raster.rasterInfo;if(v.isSome(a)){if(!this.multidimensionalDefinition){const b=a.variables[0],d=[];b.dimensions.forEach(e=>{d.push(new r({variableName:b.name,dimensionName:e.name,values:e.hasRegularIntervals?
e.extent[0]:e.values[0],isSlice:!0}))});this.multidimensionalDefinition=d}this._sliceId=this.raster.getSliceIndex(this.multidimensionalDefinition)}};h._configDefaultRenderer=function(){const a=this.raster.rasterInfo;this.bandIds||(this.bandIds=m.getDefaultBandCombination(a));if(!this.renderer){var b;this.renderer=m.createDefaultRenderer(a,{bandIds:this.bandIds,variableName:null==(b=this.multidimensionalDefinition)?void 0:b[0].variableName})}this.symbolizer?(this.symbolizer.rendererJSON=this.renderer.toJSON(),
this.symbolizer.rasterInfo=a):this.symbolizer=new G({rendererJSON:this.renderer.toJSON(),rasterInfo:a});this.symbolizer.bind()||t.warn("imagery-tile-mixin","The given renderer is not supported by the layer.")};p._createClass(l,[{key:"multidimensionalDefinition",set:function(a){this.raster&&(this._sliceId=this.raster.getSliceIndex(a));this._set("multidimensionalDefinition",a)}},{key:"url",set:function(a){this._set("url",D.sanitizeUrl(a,t))}},{key:"renderer",set:function(a){this._set("renderer",a);
this.updateRenderer()}}]);return l}(c);f.__decorate([g.property()],c.prototype,"_cachedRendererJson",void 0);f.__decorate([g.property()],c.prototype,"_sliceId",void 0);f.__decorate([g.property()],c.prototype,"_compatibleFullExtent",void 0);f.__decorate([g.property()],c.prototype,"_rasterJobHandler",void 0);f.__decorate([g.property()],c.prototype,"bandIds",void 0);f.__decorate([g.property()],c.prototype,"copyright",void 0);f.__decorate([g.property({type:A}),k.aliasOf("rasterInfo.extent")],c.prototype,
"fullExtent",void 0);f.__decorate([g.property()],c.prototype,"interpolation",void 0);f.__decorate([g.property({type:[r]})],c.prototype,"multidimensionalDefinition",null);f.__decorate([g.property()],c.prototype,"raster",void 0);f.__decorate([g.property({readOnly:!0}),k.aliasOf("raster.rasterInfo")],c.prototype,"rasterInfo",void 0);f.__decorate([g.property()],c.prototype,"sourceJSON",void 0);f.__decorate([g.property({type:z}),k.aliasOf("rasterInfo.spatialReference")],c.prototype,"spatialReference",
void 0);f.__decorate([g.property({type:q,dependsOn:["rasterInfo"]}),k.aliasOf("rasterInfo.storageInfo.tileInfo")],c.prototype,"tileInfo",void 0);f.__decorate([g.property(E.url)],c.prototype,"url",null);f.__decorate([g.property({types:C.rasterRendererTypes})],c.prototype,"renderer",null);f.__decorate([g.property()],c.prototype,"symbolizer",void 0);return c=f.__decorate([x.subclass("esri.layers.ImageryTileMixin")],c)};Object.defineProperty(n,"__esModule",{value:!0})});