// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/lang ../config ../core/maybe ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/jsonMap ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../core/promiseUtils ../core/accessorSupport/write ../geometry/support/spatialReferenceUtils ../geometry/SpatialReference ../geometry/Extent ../core/Collection ../PopupTemplate ../request ../Graphic ../core/Handles ../core/CollectionFlattener ./Layer ../core/MultiOriginJSONSupport ./support/arcgisLayerUrl ./support/commonProperties ./mixins/OperationalLayer ./mixins/BlendLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ../geometry/support/scaleUtils ./support/wmsUtils ./support/ExportWMSImageParameters ./support/WMSSublayer".split(" "),
function(u,f,x,H,C,I,fa,J,l,K,v,L,z,M,ha,ia,N,O,P,y,Q,D,R,A,S,E,T,c,U,V,F,W,X,Y,Z,aa,ba,ca,w,da,B){function ea(m,n){return m.some(g=>{for(const b in g)if(O.willPropertyWrite(g,b,null,n))return!0;return!1})}function G(m,n,g){const b=new Map;m.every(a=>null==a.id)&&(m=H.clone(m),m.forEach((a,d)=>a.id=d));for(const a of m){const d=new B;d.read(a,n);-1===(null==g?void 0:g.indexOf(d.name))&&(d.visible=!1);b.set(d.id,d)}n=[];for(const a of m)m=b.get(a.id),null!=a.parentLayerId&&0<=a.parentLayerId?(g=b.get(a.parentLayerId),
g.sublayers||(g.sublayers=new D),g.sublayers.unshift(m)):n.unshift(m);return n}x=new K.JSONMap({bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml"},{ignoreUnknown:!1});c=function(m){function n(...b){var a=m.call(this,...b)||this;a._sublayersHandles=new E;a.allSublayers=new T({root:u._assertThisInitialized(a),rootCollectionNames:["sublayers"],getChildrenFunction(d){return d.sublayers}});a.customParameters=null;a.customLayerParameters=null;a.copyright=null;a.description=
null;a.dimensions=null;a.fullExtent=null;a.fullExtents=null;a.featureInfoFormat=null;a.featureInfoUrl=null;a.imageFormat=null;a.imageMaxHeight=2048;a.imageMaxWidth=2048;a.imageTransparency=!0;a.legendEnabled=!0;a.mapUrl=null;a.isReference=null;a.operationalLayerType="WMS";a.spatialReference=null;a.spatialReferences=null;a.sublayers=null;a.type="wms";a.url=null;a.version=null;a.watch("sublayers",(d,h)=>{h&&(h.forEach(k=>{k.layer=null}),a._sublayersHandles.removeAll(),a._sublayersHandles=null);d&&(d.forEach(k=>
{k.parent=u._assertThisInitialized(a);k.layer=u._assertThisInitialized(a)}),a._sublayersHandles||(a._sublayersHandles=new E),a._sublayersHandles.add([d.on("after-add",({item:k})=>{k.parent=u._assertThisInitialized(a);k.layer=u._assertThisInitialized(a)}),d.on("after-remove",({item:k})=>{k.parent=null;k.layer=null})]))},!0);return a}u._inheritsLoose(n,m);var g=n.prototype;g.normalizeCtorArgs=function(b,a){return"string"===typeof b?{url:b,...a}:b};g.destroy=function(){var b;null==(b=this._exportWMSImageParameters)?
void 0:b.destroy()};g.load=function(b){const a=I.isSome(b)?b.signal:null;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},b).then(()=>this._fetchService(a),()=>this._fetchService(a)));return N.resolve(this)};g.readFullExtentFromItemOrMap=function(b,a){b=a.extent;return new Q({xmin:b[0][0],ymin:b[0][1],xmax:b[1][0],ymax:b[1][1]})};g.writeFullExtent=function(b,a){a.extent=[[b.xmin,b.ymin],[b.xmax,b.ymax]]};g.readImageFormat=function(b,a){return(b=a.supportedImageFormatTypes)&&-1<
b.indexOf("image/png")?"image/png":b&&b[0]};g.readSpatialReferenceFromItemOrDocument=function(b,a){return new y(a.spatialReferences[0])};g.writeSpatialReferences=function(b,a){const d=this.spatialReference&&this.spatialReference.wkid;b&&d?(a.spatialReferences=b.filter(h=>h!==d),a.spatialReferences.unshift(d)):a.spatialReferences=b};g.readSublayersFromItemOrMap=function(b,a,d){return G(a.layers,d,a.visibleLayers)};g.readSublayers=function(b,a,d){return G(a.layers,d)};g.writeSublayers=function(b,a,
d,h){a.layers=[];const k=new Map;b=b.flatten(({sublayers:e})=>e&&e.toArray()).toArray();b.forEach(e=>{"number"===typeof e.parent.id&&(k.has(e.parent.id)?k.get(e.parent.id).push(e.id):k.set(e.parent.id,[e.id]))});b.forEach(e=>{const p={sublayer:e,...h},t=e.write({parentLayerId:"number"===typeof e.parent.id?e.parent.id:-1},p);k.has(e.id)&&(t.sublayerIds=k.get(e.id));!e.sublayers&&e.name&&(e=e.write({},p),delete e.id,a.layers.push(e))});a.visibleLayers=b.filter(e=>e.visible&&!e.sublayers).map(e=>e.name)};
g.createExportImageParameters=function(b,a,d,h){var k;d=h&&h.pixelRatio||1;a=ca.getScale({extent:b,width:a})*d;null==(k=this._exportWMSImageParameters)?void 0:k.destroy();this._exportWMSImageParameters=new da({layer:this,extent:b,scale:a});return this._exportWMSImageParameters.toJSON()};g.fetchImage=async function(b,a,d,h){var k,e;const p=this.mapUrl;b=this.createExportImageParameters(b,a,d,h);if(!b.layers)return h=document.createElement("canvas"),h.width=a,h.height=d,h;const t=null==h?void 0:null==
(k=h.timeExtent)?void 0:k.start;k=null==h?void 0:null==(e=h.timeExtent)?void 0:e.end;e=t&&k?t.getTime()===k.getTime()?w.toISOString(t):`${w.toISOString(t)}/${w.toISOString(k)}`:void 0;a={responseType:"image",query:this._mixCustomParameters({width:a,height:d,...b,time:e}),signal:null==h?void 0:h.signal};null!=h&&h.timestamp&&(a.query={_ts:h.timestamp,...a.query});return A(p,a).then(q=>q.data)};g.fetchFeatureInfo=function(b,a,d,h,k){const e=w.getPopupLayers(this._exportWMSImageParameters.visibleSublayers);
if(!this.featureInfoUrl||!e)return null;h={query_layers:e,request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:a,height:d,..."1.3.0"===this.version?{I:h,J:k}:{x:h,y:k}};let p={...this.createExportImageParameters(b,a,d),...h};p=this._mixCustomParameters(p);return A(this.featureInfoUrl,{query:p,responseType:"text"}).then(t=>{let q=this.featureInfoUrl;q+=-1===q.indexOf("?")?"?":"";for(var r in p)q+="?"===q.substring(q.length-1,q.length)?"":"\x26",q+=r+"\x3d"+p[r];r=document.createElement("iframe");
r.src=q;r.frameBorder="0";r.marginHeight="0";r.marginWidth="0";r.innerHTML=t.data;r.style.width="100%";return new S({sourceLayer:this,popupTemplate:new R({title:this.title,content:r})})})};g.findSublayerById=function(b){return this.allSublayers.find(a=>a.id===b)};g.findSublayerByName=function(b){return this.allSublayers.find(a=>a.name===b)};g.supportsSpatialReference=function(b){return V.isWmsServer(this.url)||this.spatialReferences.some(a=>{a=900913===a?y.WebMercator:new y({wkid:a});return P.equals(a,
b)})};g._fetchService=async function(b){this.resourceInfo||(this.parsedUrl.query&&this.parsedUrl.query.service&&(this.parsedUrl.query.SERVICE=this.parsedUrl.query.service,delete this.parsedUrl.query.service),this.parsedUrl.query&&this.parsedUrl.query.request&&(this.parsedUrl.query.REQUEST=this.parsedUrl.query.request,delete this.parsedUrl.query.request),b=await A(this.parsedUrl.path,{query:{SERVICE:"WMS",REQUEST:"GetCapabilities",...this.parsedUrl.query,...this.customParameters},responseType:"xml",
signal:b}),this.resourceInfo=w.parseCapabilities(b.data));this.parsedUrl&&(b=new M.Url(this.parsedUrl.path),"https"!==b.scheme||b.port&&"443"!==b.port||-1!==C.request.httpsDomains.indexOf(b.host)||C.request.httpsDomains.push(b.host));this.read(this.resourceInfo,{origin:"service"})};g._mixCustomParameters=function(b){if(!this.customLayerParameters&&!this.customParameters)return b;const a={...this.customParameters,...this.customLayerParameters};for(const d in a)b[d.toLowerCase()]=a[d];return b};return n}(X.BlendLayer(ba.TemporalLayer(Z.RefreshableLayer(aa.ScaleRangeLayer(W.OperationalLayer(Y.PortalLayer(U.MultiOriginJSONMixin(c))))))));
f.__decorate([l.property({readOnly:!0})],c.prototype,"allSublayers",void 0);f.__decorate([l.property({json:{type:Object,write:!0}})],c.prototype,"customParameters",void 0);f.__decorate([l.property({json:{type:Object,write:!0}})],c.prototype,"customLayerParameters",void 0);f.__decorate([l.property({type:String,json:{write:!0}})],c.prototype,"copyright",void 0);f.__decorate([l.property()],c.prototype,"description",void 0);f.__decorate([l.property({readOnly:!0})],c.prototype,"dimensions",void 0);f.__decorate([l.property({json:{type:[[Number]],
read:{source:"extent"},write:{target:"extent"},origins:{service:{read:{source:"extent"}}}}})],c.prototype,"fullExtent",void 0);f.__decorate([v.reader(["web-document","portal-item"],"fullExtent",["extent"])],c.prototype,"readFullExtentFromItemOrMap",null);f.__decorate([z.writer(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],c.prototype,"writeFullExtent",null);f.__decorate([l.property()],c.prototype,"fullExtents",void 0);f.__decorate([l.property({type:String,json:{write:{ignoreOrigin:!0}}})],
c.prototype,"featureInfoFormat",void 0);f.__decorate([l.property({type:String,json:{write:{ignoreOrigin:!0}}})],c.prototype,"featureInfoUrl",void 0);f.__decorate([l.property({type:String,json:{origins:{"web-document":{default:"image/png",type:x.jsonValues,read:{reader:x.read,source:"format"},write:{writer:x.write,target:"format"}}}}})],c.prototype,"imageFormat",void 0);f.__decorate([v.reader("imageFormat",["supportedImageFormatTypes"])],c.prototype,"readImageFormat",null);f.__decorate([l.property({type:Number,
json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],c.prototype,"imageMaxHeight",void 0);f.__decorate([l.property({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],c.prototype,"imageMaxWidth",void 0);f.__decorate([l.property()],c.prototype,"imageTransparency",void 0);f.__decorate([l.property(F.legendEnabled)],c.prototype,"legendEnabled",void 0);f.__decorate([l.property({type:["show","hide","hide-children"]})],c.prototype,"listMode",void 0);f.__decorate([l.property({type:String,
json:{write:{ignoreOrigin:!0}}})],c.prototype,"mapUrl",void 0);f.__decorate([l.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],c.prototype,"isReference",void 0);f.__decorate([l.property({type:["WMS"]})],c.prototype,"operationalLayerType",void 0);f.__decorate([l.property({type:y,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],c.prototype,"spatialReference",void 0);f.__decorate([v.reader(["web-document","portal-item"],"spatialReference",
["spatialReferences"])],c.prototype,"readSpatialReferenceFromItemOrDocument",null);f.__decorate([l.property({type:[J.Integer],json:{read:{source:"spatialReferences"},write:{ignoreOrigin:!0}}})],c.prototype,"spatialReferences",void 0);f.__decorate([z.writer(["web-document","portal-item"],"spatialReferences")],c.prototype,"writeSpatialReferences",null);f.__decorate([l.property({type:D.ofType(B),json:{write:{target:"layers",overridePolicy(m,n,g){if(ea(this.allSublayers,g))return{ignoreOrigin:!0}}}}})],
c.prototype,"sublayers",void 0);f.__decorate([v.reader(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],c.prototype,"readSublayersFromItemOrMap",null);f.__decorate([v.reader("service","sublayers",["layers"])],c.prototype,"readSublayers",null);f.__decorate([z.writer("sublayers",{layers:{type:[B]},visibleLayers:{type:[String]}})],c.prototype,"writeSublayers",null);f.__decorate([l.property({json:{read:!1},readOnly:!0,value:"wms"})],c.prototype,"type",void 0);f.__decorate([l.property(F.url)],
c.prototype,"url",void 0);f.__decorate([l.property({type:String,json:{write:{ignoreOrigin:!0}}})],c.prototype,"version",void 0);return c=f.__decorate([L.subclass("esri.layers.WMSLayer")],c)});