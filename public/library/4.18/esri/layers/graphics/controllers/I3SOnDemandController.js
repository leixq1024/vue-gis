// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/has ../../../core/maybe ../../../core/Logger ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/property ../../../core/jsonMap ../../../core/accessorSupport/decorators/subclass ../../../core/urlUtils ../../../core/uuid ../../../portal/support/resourceExtension ../../../core/PooledArray ../../../core/promiseUtils ../../../core/Accessor ../../../core/Promise ../../../core/Handles ../../../core/watchUtils ../../../geometry/support/aaBoundingRect ../../../geometry/projection ../../support/PromiseQueue ../../../views/support/Scheduler ../../../geometry/support/aaBoundingBox ../../../views/support/layerViewUtils ../dehydratedFeatures ../../../views/3d/support/extentUtils ../../../views/3d/layers/i3s/I3SFrameTask ../../../views/3d/layers/i3s/I3SUtil ../../../views/3d/layers/i3s/I3SIndex ../../../views/3d/layers/i3s/I3SLodHandling ../../../views/3d/layers/i3s/I3SNodeLoader ../../../views/3d/layers/i3s/I3SStreamDataController ../../../views/3d/layers/i3s/I3SViewportQueries".split(" "),
function(B,l,H,f,h,W,m,X,I,Y,Z,aa,u,p,J,K,L,C,D,M,N,O,P,w,Q,R,S,x,T,U,v,E,V){function y(r,n){return f.isSome(r)&&r.length===n.length&&r.every(e=>0<=z(n,e.name))}function z(r,n){n=n.toLowerCase();for(let e=0;e<r.length;e++)if(r[e].name.toLowerCase()===n)return e;return-1}const t=h.getLogger("esri.layers.graphics.controllers.I3SOnDemandController");h=function(r){function n(a){a=r.call(this,a)||this;a.screenSizeFactor=0;a.featureTarget=5E4;a.fixedFeatureTarget=!1;a.updating=!0;a.updatingProgress=1;a.leavesReached=
!1;a.scaleVisibilityEnabled=!0;a.uncompressedTextureDownsamplingEnabled=!1;a._featureLOD=1;a._stableFeatureLOD=!1;a._isIdle=!1;a._cameraDirty=!0;a._invisibleDirty=!1;a._newLoadingNodes=new u({deallocator:null});a._loadedNodeScales=new Map;a._modificationsNodeFilteringArray=new u;a._downloadingCount=0;a._loadingNodes=new Map;a._updatingNodes=new Map;a._progressMaxNumNodes=1;a._requiredAttributes=[];a._requiredAttributesDirty=!0;a._updatesDisabled=!1;a.disableIDBCache=!1;a._disableMemCache=!1;a._restartNodeLoading=
!1;a._fields=null;a._attributeStorageInfo=null;a._handles=new L;a._idleQueue=new N;a._elevationUpdateNodes=new u({deallocator:null});a._errorCount=0;return a}B._inheritsLoose(n,r);var e=n.prototype;e.initialize=function(){this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData;this._lodHandling=new U(this.layerView);const a=this.layerView.i3slayer;this.layer=a;this._defaultGeometrySchema=a.store.defaultGeometrySchema;this.disableIDBCache=H("disable-feature:idb-cache");
"fields"in a&&(this._fields=a.fields,this._attributeStorageInfo=a.attributeStorageInfo);this.addResolvingPromise(p.all([this.layer.when(),this.layerView.when()]).then(()=>{if(!this.destroyed&&this.layerView&&!this.layerView.destroyed){var b=this.layerView.view;this._setClippingArea(b.clippingArea);var c=this.layerView.view.resourceController;this._handles.add([C.init(b,"pointsOfInterest.focus.renderLocation",d=>this._pointOfInterestChanged(d)),c.memoryController.events.on("quality-changed",()=>this._setCameraDirty()),
C.init(this.layerView,"suspended",d=>{const g=d?()=>this._updateViewData():()=>this._updateIdleState(!0),k=d?()=>{}:()=>this._updateIdleState(!1);this._idleStateCallbacks?(d&&this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=g,this._idleStateCallbacks.idleEnd=k):this._idleStateCallbacks=c.scheduler.registerIdleStateCallbacks(g,k)}),S.addTask(this.layerView.view.resourceController.scheduler,{update:(d,g)=>this._frame(d,g),needsUpdate:()=>this.updating}),this.watch("uncompressedTextureDownsamplingEnabled",
()=>this.restartNodeLoading()),this.watch(["featureTarget","fixedFeatureTarget"],()=>{this._setCameraDirty();this._stableFeatureLOD=!1}),b.state.watch("camera",()=>this._setCameraDirty()),this.layer.watch("elevationInfo",()=>this._elevationInfoChanged()),this.layer.watch(["minScale","maxScale"],()=>this._scaleBoundsChanged()),this.layerView.watch("lodFactor",()=>this._setCameraDirty()),this.layerView.watch("availableFields?",()=>this._requiredFieldsChange()),this.layerView.watch("holeFilling",d=>
f.isSome(this._index)&&(this._index.holeFilling=d))]);this._updateScaleHandles();this._viewportQueries=new V(this.crsIndex,b.renderCoordsHelper,b.state.camera,this._clippingArea,b.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this.lod,angleDependentLoD:.5>this.lod});this._index=new T.I3SIndex(a,this.indexStreamController,this._viewportQueries,t,this.layerView.holeFilling,d=>this.layerView.isNodeLoaded(d),d=>this.layerView.isNodeReloading(d),
d=>this._shouldLoadNode(d),d=>this._enableFromGPUCache(d,1),d=>this._needsUpdate(d),()=>!this.indexStreamController.busy,d=>this.layerView.computeVisibilityObb?this.layerView.computeVisibilityObb(d):null);b=f.isSome(this.layer.modifications)&&this.layer.modifications&&0<this.layer.modifications.length;this._index.imModificationsChanged(b);this._startNodeLoading()}}));this._tmpPoint=Q.makeDehydratedPoint(0,0,0,this.crsIndex)};e.updateNodeModificationStatus=function(a){const b=this._index,c=this.layerView;
f.isSome(b)&&c&&c.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),a.forAll(d=>{d=b.getNode(d);f.isSome(d)&&this._modificationsNodeFilteringArray.push(d)}),c.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)};e.destroy=function(){this.cancelNodeLoading();this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null);this._handles.destroy();this._nodeLoader=null;q.prune();f.isSome(A)&&
(A.remove(),A=null)};e._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const a=this._attributeStorageInfo,b=this._fields,c=this.layer.objectIdField;return this.layerView.availableFields.map(d=>{const g=z(a,d);d=z(b,d);return 0<=g&&0<=d?{index:g,name:b[d].name,field:b[d],attributeStorageInfo:a[g]}:null}).filter(d=>null!=d&&d.name!==c)};e._requiredFieldsChange=function(){const a=this._getRequiredAttributes();y(this._requiredAttributes,
a)||(this._requiredAttributes=a,this._requiredAttributesDirty=!1,this.restartNodeLoading())};e.requestUpdate=function(){this._requiredAttributesDirty=!0;this.restartNodeLoading()};e._setClippingArea=function(a){const b=P.create();R.projectToBoundingBox(a,b,this.layerView.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null};e._pointOfInterestChanged=function(a){f.isSome(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(a),f.isSome(this._index)&&(this._index.progressiveLoadPenalty=
F.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))};e.updateClippingArea=function(a){this._setClippingArea(a);f.isSome(this._viewportQueries)&&f.isSome(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache());this._setCameraDirty()};e._setCameraDirty=function(){this._cameraDirty=!0;this.notifyChange("rootNodeVisible");this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()};e.updateElevationChanged=function(a,
b){const c=this._index;if(!f.isNone(c)){var d=c.rootNode;if(!f.isNone(d)){var g=this._elevationUpdateNodes;g.clear();x.findIntersectingNodes(a,b,d,this.crsIndex,c,k=>g.push(k.index));g.forAll(k=>{c.invalidateBoundingVolumeCache(k);k===d.index&&this.notifyChange("rootNodeVisible")});g.length&&this.restartNodeLoading()}}};e.getParentIndex=function(a){return f.isSome(this._index)&&this._index.getParentIndex(a)};e._elevationInfoChanged=function(){f.isSome(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo);
this._setCameraDirty()};e._updateScaleHandles=function(){this._handles.remove("scale-bounds");this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",a=>this._scaleUpdateHandler(a)),"scale-bounds")};e._scaleBoundsChanged=function(){this.areScaleBoundsActive||this._loadedNodeScales.clear();this._updateScaleHandles();this._setCameraDirty()};e._scaleUpdateHandler=function(a){this._updateScaleInBoundingRect(a.scale,a.extent,a.spatialReference);this._setCameraDirty()};
e._updateScaleInBoundingRect=function(a,b,c){const d=this._index;f.isNone(d)||!f.isNone(d.rootNode)&&M.projectBoundingRect(b,c,G,this.crsIndex)&&this._loadedNodeScales.forEach((g,k)=>{g=d.getNode(k);f.isSome(g)&&D.containsPoint(G,g.mbs)&&this._loadedNodeScales.set(k,a)})};e.restartNodeLoading=function(){this._restartNodeLoading=!0;this.cancelNodeLoading();this._evaluateUpdating()};e.schedule=function(a,b){return this._idleQueue.push(a,b)};e.reschedule=function(a,b){return this._idleQueue.unshift(a,
b)};e._frame=function(a,b){if(this.layerView.suspended)return this._updateViewData(),this._evaluateUpdating(),-Infinity;if(!this.layerView.visible||f.isNone(this._index))return-Infinity;this._processLogError(a,b);return this._index.getPriority()};e._processLogError=function(a,b){try{this._process(a,b)}catch(c){50>this._errorCount?t.error("Error during processing: "+c):50===this._errorCount&&t.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}};e._process=
function(a,b){this._restartNodeLoading&&this._startNodeLoading();if(null!=this._nodeLoader&&!f.isNone(this._index)){this._updateViewData();this._invisibleDirty&&this._removeInvisibleNodes(a)&&(this._invisibleDirty=!1);this.isIntegratedMesh&&(a.enabled=!1);a.run(()=>this._processIndex(a));this._updateFeatureLOD();a.run(()=>this._processCache(a));this.isIntegratedMesh&&(a.enabled=!0);for(a.run(()=>this._processNodes(a,b));!a.done&&this._idleQueue.process();)a.madeProgress();a.run(()=>this._prefetchIndex());
b.numIndexLoading+=this._index.getIndexLoading();b.numNodesLoading+=this._downloadingCount;a.run(()=>this._lodHandling.lodGlobalHandling(a));this._evaluateUpdating()}};e._processIndex=function(a){if(f.isNone(this._index))return!1;this._index.dirty&&(this._newLoadingNodes.clear(),this._index.update([...this._loadingNodes.keys()],a,b=>this.updateNodeModificationStatus(b)),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,
this._index.updates.missing.length)),a=this._index.featureEstimate.leavesReached,this._index.isLoading()||a===this._get("leavesReached")||this._set("leavesReached",a));return this._index.load()};e._prefetchIndex=function(){return f.isNone(this._index)||0<this._loadingNodes.size||0<this._index.updates.add.length?!1:this._index.prefetch()};e._updateFeatureLOD=function(){if(this.isGraphics3D&&!f.isNone(this._index)&&!f.isNone(this._viewportQueries)){var a=!this._index.isLoading(),b=this.featureTarget*
this.baseLOD,c=this._index.featureEstimate;c.estimate=c.estimate||b/2;if(500<this._index.getIndexMissing()){if(1E-4>=this._featureLOD)return;this._featureLOD/=1.5;this._stableFeatureLOD=!1}else if(a&&c.estimate<b){if(c.leavesReached||1E4<=this._featureLOD||this._stableFeatureLOD)return;this._featureLOD*=Math.min(10,Math.max(b/c.estimate,1.001));a=this.lod;b=this._index.checkFeatureTarget(b,a);b!==a&&(this._featureLOD=b/this.baseLOD,this._stableFeatureLOD=!0)}else if(c.estimate>1.2*b||a&&c.estimate>
b){if(1E-4>=this._featureLOD)return;this._featureLOD/=1+.25*(c.estimate/b-1);this._stableFeatureLOD=!1}else return;this._featureLOD=Math.min(1E4,Math.max(1E-4,this._featureLOD));this._viewportQueries.updateScreenSpaceErrorBias(this.lod);this._index.requestUpdate()}};e._processCache=function(a){const b=this._index;if(f.isNone(b))return!1;for(;0<this._newLoadingNodes.length&&!a.done;){var c=this._newLoadingNodes.pop();for(c=b.getParent(c);f.isSome(c)&&!this.layerView.isNodeLoaded(c.index)&&this._isNodeInScaleBounds(c);c=
b.getParent(c.index))if(this._enableFromGPUCache(c,0)){a.madeProgress();break}}return a.hasProgressed};e._processNodes=function(a,b){if(f.isNone(this._index))return!1;let c=(this._isIdle?100:2)-this._loadingNodes.size;const d=this._index.updates;d.cancel.forEach(this._cancelNode,this);for(d.cancel=[];0<d.remove.length&&!a.done;)this.layerView.removeNode(d.remove.pop()),a.madeProgress();for(;0<d.update.length&&!a.done;){var g=this._index.getNode(d.update.pop());f.isSome(g)&&(this._updateLoadedNode(g),
a.madeProgress())}for(;0<d.add.length&&!a.done&&0<c;){--c;g=this._index.getNode(d.add.back());if(f.isNone(g)||2!==g.cacheState&&!this._hasNodeLoadToken(b))break;d.add.pop();this._loadNode(g);a.madeProgress()}return a.hasProgressed};e._cancelAllNodes=function(){this._loadingNodes.forEach(a=>a.abort());this._loadingNodes.clear();this._updatingNodes.forEach(a=>a.abort());this._updatingNodes.clear()};e._cancelNode=function(a){const b=this._loadingNodes.get(a);b&&(b.abort(),this._loadingNodes.delete(a))};
e._hasNodeLoadToken=function(a){return!this._isIdle&&2<=a.numNodesLoading+this._loadingNodes.size?!1:!this.dataStreamController.busy};e._evaluateUpdating=function(){var a=!1,b=0;this.layerView.suspended?b=(a=this._cameraDirty)?.5:1:(a=f.isSome(this._index)?this._index.getIndexMissing():0,b=f.isSome(this._index)?this._index.updates.add.length:0,b=a+3*b+2*this._loadingNodes.size,a=!!(0<b||0<this._updatingNodes.size||this._restartNodeLoading||this._cameraDirty||0<this._idleQueue.length||this._lodHandling&&
this._lodHandling.requiresLODGlobalHandling),0===b&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(b,this._progressMaxNumNodes),b=1-b/this._progressMaxNumNodes);a!==this.updating&&this._set("updating",a);b!==this.updatingProgress&&this._set("updatingProgress",b)};e._updateViewData=function(){if(this._cameraDirty&&!f.isNone(this._index)&&!f.isNone(this._viewportQueries)){var a=this.layerView.view,b=a.state.camera;this.screenSizeFactor=1/(b.perScreenPixelRatio/2);this._viewportQueries.updateCamera(b);
this._viewportQueries.setPointOfInterest(a.pointsOfInterest.focus.renderLocation);this._viewportQueries.updateScreenSpaceErrorBias(this.lod);this._index.invalidateVisibilityCache();this._index.progressiveLoadPenalty=F.distancePenalty*this._viewportQueries.distCameraToPOI();this._index.requestUpdate();this._stableFeatureLOD=!1;this._invisibleDirty=!0;this._cameraDirty=!1;this.notifyChange("rootNodeVisible")}};e._getProgressiveLoadFactor=function(){return 1>this.layerView.view.resourceController.memoryController.memoryFactor?
1:this.layerView.progressiveLoadFactor};e.isGeometryVisible=function(a){return f.isSome(this._index)&&this._index.isGeometryVisible(a.index)};e.updateVisibility=function(a){f.isSome(this._index)&&this._index.invalidateNodeVisibilityCache(a)};e.updateBoundingVolume=function(a){f.isSome(this._index)&&this._index.invalidateBoundingVolumeCache(a)};e.invalidateGeometryVisibility=function(a){f.isSome(this._index)&&this._index.invalidateGeometryVisibility(a)};e.invalidateVisibilityObbs=function(){f.isSome(this._index)&&
this._index.invalidateVisibilityObbs()};e.modificationsChanged=function(){if(f.isSome(this._index)){const a=f.isSome(this.layer.modifications)&&this.layer.modifications&&0<this.layer.modifications.length;this._index.imModificationsChanged(a)}this._invisibleDirty=!0};e._shouldLoadNode=function(a){return this._lodHandling.shouldLoadNode(a)&&!this._shouldDropNode(a)&&this._isNodeInScaleBounds(a)?f.isSome(this._index)?this._index.isGeometryVisible(a.index):!1:!1};e._shouldDropNode=function(a){if(f.isNone(this._viewportQueries))return!1;
const b=this.lodDropFactor;return 1<=b||!this._lodHandling.hasNoVisibleChildren(a)?!1:Math.abs(this._viewportQueries.calcCameraDistanceToCenter(a))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*b};e._startNodeLoading=function(){this._restartNodeLoading=!1;const a=this._index;if(!(this._updatesDisabled||f.isNone(a)||f.isNone(this._viewportQueries))){this._updateViewData();this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),
this._requiredAttributesDirty=!1);var b=v.TextureFormat.Normal;this.layerView.useCompressedTextures?b=v.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(b=v.TextureFormat.Downsampled);this._nodeLoader=new v(this.layer,this.dataStreamController,t,this._defaultGeometrySchema,this._requiredAttributes,{textureFormat:b,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid});a.requestUpdate();this._lodHandling.startNodeLoading(c=>this._isNodeInScaleBounds(c),
(c,d)=>this._removeNodes(c,d,1),a,{maxLodLevel:this._viewportQueries.maxLodLevel});this._evaluateUpdating()}};e.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index};e.cancelNodeLoading=function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())};e._removeInvisibleNodes=function(a){const b=this._index;if(f.isNone(b)||f.isNone(this._viewportQueries))return!1;
q.clear();this.layerView.getLoadedNodeIndices(q);const c=0===this._viewportQueries.maxDistance,d=c?()=>!1:g=>this._shouldDropNode(g);q.filterInPlace(g=>{const k=b.getNode(g);return f.isNone(k)||!b.isGeometryVisible(g)||d(k)||!this._isNodeInScaleBounds(k)});0<q.length&&this._lodHandling.setLodGlobalDirty();this._removeNodes(q,a,0);if(c&&1>this.lodDropFactor)return!1;if(0===q.length)return!0;q.clear();return!1};e.markNodeToRemove=function(a){q.push(a)};e.removeMarkedNodes=function(){this._removeNodes(q,
O.noBudget,0)};e._removeNodes=function(a,b,c){const d=a.length;if(0!==d&&!b.done){for(f.isSome(this._index)&&this._index.requestUpdate();0<a.length&&!b.done;){const g=a.pop(),k=this._index;1===c&&this.layerView.nodeFadeoutEnabled&&f.isSome(k)&&k.isGeometryVisible(g)?this.layerView.fadeNode(g,1,!0):this.layerView.removeNode(g);b.madeProgress()}if(0<this._loadedNodeScales.size)for(b=a.length;b<d;b++)this._loadedNodeScales.delete(a.data[b])}};e._needsUpdate=function(a){if(!a.resources.hasFeatureData||
this._updatingNodes.has(a.index))return!1;a=this.layerView.getLoadedAttributes(a.index);return null!=a&&a!==this._requiredAttributes};e._updateLoadedNode=function(a){const b=p.createAbortController();this._updatingNodes.set(a.index,b);const c=this.layerView.getLoadedAttributes(a.index);(y(c,this._requiredAttributes)?p.resolve(this.layerView.getAttributeData(a.index)):this._nodeLoader.loadAttributes(a,this._requiredAttributes,b.signal)).then(d=>this.schedule(()=>this.layerView.updateAttributes(a.index,
{loadedAttributes:this._requiredAttributes,attributeData:d},b.signal),b.signal)).catch(d=>{if(!p.isAbortError(d))return this.layerView.updateAttributes(a.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},b.signal)}).catch(()=>{}).then(()=>{this._updatingNodes.delete(a.index);this._evaluateUpdating()});this._evaluateUpdating()};e._loadNode=function(a){if(this._loadingNodes.has(a.index))t.error("already loading node "+a.index);else{var b=p.createAbortController();this._loadingNodes.set(a.index,
b);var c=()=>{this._loadingNodes.get(a.index)===b&&this._loadingNodes.delete(a.index);this._evaluateUpdating()};this._evaluateUpdating();this._loadAndAddNode(a,b.signal).then(c).catch(d=>{c();if(!p.isAbortError(d))throw d;})}};e._loadAndAddNode=function(a,b){return 1===a.cacheState?this._loadUncached(a,b):this._loadCached(a,b).then(c=>{c||(a.cacheState=1,f.isSome(this._index)&&this._index.updates.add.push(a.index))}).catch(c=>{if(!p.isAbortError(c))throw a.cacheState=1,c;})};e._enableFromGPUCache=
function(a,b){if(this._disableMemCache||f.isNone(this._index))return!1;if(0===b&&!this._index.useNodeAsHole(a.index))return!0;const c=this._loadCachedGPUData(a);if(!c)return!1;this.layerView.addCachedGPUData(a,c,b);this._nodeAdded();return!0};e._loadCachedGPUData=function(a){a=this.layerView.loadCachedGPUData(a);if(f.isSome(a)&&f.isSome(a.attributeInfo)&&y(a.attributeInfo.loadedAttributes,this._requiredAttributes))return a;this.layerView.deleteCachedGPUData(a);return null};e._nodeAdded=function(){f.isSome(this._index)&&
this._index.requestUpdate();this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()};e._loadCached=function(a,b){if(this._enableFromGPUCache(a,1))return p.resolve(!0);const c=this.layerView;return!this.disableIDBCache&&c.loadCachedNodeData&&c.addCachedNodeData?this.schedule(()=>c.loadCachedNodeData(a,b,(d,g)=>this._nodeLoader.loadTextures(a,d,g)),b).then(d=>{if(f.isNone(d))return!1;const g=this._requiredAttributes;return this.reschedule(()=>this._nodeLoader.loadAttributes(a,g,b),b).then(k=>
this.reschedule(()=>c.addCachedNodeData(a,d,{loadedAttributes:g,attributeData:k},b),b)).then(()=>{this._nodeAdded();return!0})}):p.resolve(!1)};e._loadUncached=function(a,b){this._downloadingCount++;return this._nodeLoader.loadNodeData(a,b).catch(c=>{this._downloadingCount--;throw c;}).then(c=>{this._downloadingCount--;return this.schedule(()=>this.layerView.addNode(a,c,b),b)}).then(()=>{this._nodeAdded();a.cacheState=2}).catch(c=>{if(!p.isAbortError(c))throw t.error("#loadNodeData()",this.layer,
`Failed to load node '${a.id}'`,c),a.failed=!0,f.isSome(this._index)&&this._index.requestUpdate(),c;})};e._updateIdleState=function(a){a!==this._isIdle&&(this._isIdle=a,this._evaluateUpdating(),a&&this._index&&f.isSome(this._index)&&this._index.resetFailedNodes())};e._getScale=function(a){if(this._loadedNodeScales.has(a.index))return this._loadedNodeScales.get(a.index);this._tmpPoint.x=a.mbs[0];this._tmpPoint.y=a.mbs[1];this._tmpPoint.z=a.mbs[2];const b=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);
this.layerView.isNodeLoaded(a.index)&&this._loadedNodeScales.set(a.index,b);return b};e._isNodeInScaleBounds=function(a){if(!this.areScaleBoundsActive)return!0;a=this._getScale(a);const {minScale:b,maxScale:c}=w.extractSafeScaleBounds(this.layer);return w.scaleBoundsPredicate(a,b,c)};e.updateStats=function(a){a.index=f.isSome(this._index)?this._index.size:0;this.isGraphics3D&&(a.detail=this._featureLOD,a.target=this.featureTarget*this.baseLOD);f.isSome(this._index)&&this._index.updateStats(a)};e.notifyLODUpdate=
function(){this._lodHandling.setLodGlobalDirty();this._evaluateUpdating();f.isSome(this._index)&&this._index.requestUpdate()};B._createClass(n,[{key:"isMeshPyramid",get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"indexStreamController",get:function(){const a=this.layerView.view.resourceController.createStreamDataRequester(2);return new E.I3SStreamDataController(a)}},
{key:"dataStreamController",get:function(){const a=this.layerView.view.resourceController.createStreamDataRequester(3);return new E.I3SStreamDataController(a)}},{key:"crsVertex",get:function(){return x.getVertexCrs(this.layer)}},{key:"crsIndex",get:function(){return x.getIndexCrs(this.layer)}},{key:"rootNodeVisible",get:function(){if(f.isSome(this._index)){const a=this._index.rootNode;if(f.isSome(a))return this._updateViewData(),this._index.isNodeVisible(a.index)}return!0}},{key:"isIntegratedMesh",
get:function(){return"integrated-mesh"===this.layer.type}},{key:"areScaleBoundsActive",get:function(){const {minScale:a,maxScale:b}=w.extractSafeScaleBounds(this.layer);return this.scaleVisibilityEnabled&&(0<a||0<b)}},{key:"unloadedMemoryEstimate",get:function(){return f.isNone(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}},{key:"indexDepth",get:function(){return f.isSome(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(a){this.layerView.loadCachedGPUData&&
this.layerView.addCachedGPUData||(this._disableMemCache=!0);this._disableMemCache=a}},{key:"lod",get:function(){return this._featureLOD*this.baseLOD}},{key:"baseLOD",get:function(){const a=this.layerView.lodFactor,b=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(0<a?a:1)*b}},{key:"lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;const a=this.layerView.view.resourceController.memoryController;return(Math.min(a.memoryFactor,.5)-
a.minQuality)/(.5-a.minQuality)}},{key:"test",get:function(){const a=this;return{index:this._index,set disableUpdates(b){(a._updatesDisabled=b)?a.cancelNodeLoading():a.requestUpdate()},set disableIDBCache(b){a.disableIDBCache=b},set ignoreServiceObb(b){f.isSome(a._index)&&(a._index.ignoreServiceObb=b)},shouldLoadNode:b=>a._shouldLoadNode(b)}}}]);return n}(K.EsriPromiseMixin(J));l.__decorate([m.property({readOnly:!0})],h.prototype,"isMeshPyramid",null);l.__decorate([m.property({readOnly:!0})],h.prototype,
"isGraphics3D",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"indexStreamController",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"dataStreamController",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"crsVertex",null);l.__decorate([m.property({readOnly:!0})],h.prototype,"crsIndex",null);l.__decorate([m.property()],h.prototype,"screenSizeFactor",void 0);l.__decorate([m.property()],h.prototype,"featureTarget",void 0);l.__decorate([m.property()],h.prototype,"fixedFeatureTarget",
void 0);l.__decorate([m.property()],h.prototype,"layerView",void 0);l.__decorate([m.property()],h.prototype,"layer",void 0);l.__decorate([m.property({readOnly:!0})],h.prototype,"updating",void 0);l.__decorate([m.property({readOnly:!0})],h.prototype,"updatingProgress",void 0);l.__decorate([m.property({readOnly:!0})],h.prototype,"leavesReached",void 0);l.__decorate([m.property({constructOnly:!0})],h.prototype,"scaleVisibilityEnabled",void 0);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],h.prototype,
"rootNodeVisible",null);l.__decorate([m.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],h.prototype,"uncompressedTextureDownsamplingEnabled",void 0);h=l.__decorate([I.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],h);const q=new u({deallocator:null});let A;const F={factorIM:.2,factor3dObject:.05,distancePenalty:10},G=D.create();return h});