// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../core/promiseUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./projectionSupport ../../../geometry/support/quantizationUtils ./attributeSupport ./AttributesBuilder ../../../chunks/spatialQuerySupport ./timeSupport".split(" "),function(R,K,w,G,S,L,M,T,H,y,U){function N(l){return l.substr(24,12)+l.substr(19,4)+l.substr(16,2)+l.substr(14,2)+l.substr(11,2)+l.substr(9,2)+l.substr(6,2)+l.substr(4,
2)+l.substr(2,2)+l.substr(0,2)}function O(l,f,a,b){if(a&&"esriFieldTypeDate"===a.type){const c=(new Date(l)).getTime(),e=(new Date(f)).getTime();if(!isNaN(c)&&!isNaN(e))return b?e-c:c-e}return"number"===typeof l&&"number"===typeof f?b?f-l:l-f:"string"===typeof l&&"string"===typeof f?(l=l.toUpperCase(),f=f.toUpperCase(),!a||"esriFieldTypeGUID"!==a.type&&"esriFieldTypeGlobalID"!==a.type?b=(b?l>f:l<f)?-1:(b?l<f:l>f)?1:0:(a=N(l),f=N(f),b=(b?a>f:a<f)?-1:(b?a<f:a>f)?1:0),b):b?1:-1}return function(){function l(a,
b,c){this.items=a;this.queryGeometry=b;this.definitionExpression=c.definitionExpression;this.geometryType=c.geometryType;this.hasM=c.hasM;this.hasZ=c.hasZ;this.objectIdField=c.objectIdField;this.spatialReference=c.spatialReference;this.fieldsIndex=c.fieldsIndex;this.timeInfo=c.timeInfo;this.featureAdapter=c.featureAdapter;this.aggregateAdapter=c.aggregateAdapter}var f=l.prototype;f.createQueryResponseForCount=function(a){const b=new H(a,this.featureAdapter,this.fieldsIndex);if(!a.outStatistics)return b.countDistinctValues(this.items);
const {groupByFieldsForStatistics:c,having:e}=a;if(null==c||!c.length)return 1;const d=new Map,k=new Map,n=new Set;a=a.outStatistics;for(const g of a){({statisticType:a}=g);a="exceedslimit"!==a?g.onStatisticField:void 0;if(!k.has(a)){var h=[];for(const m of c){const t=this._getAttributeValues(b,m,d);h.push(t)}k.set(a,this._calculateUniqueValues(h))}a=k.get(a);for(const m in a){const {data:t,items:z}=a[m];h=t.join(",");e&&!b.validateItems(z,e)||n.add(h)}}return n.size};f.createQueryResponse=function(a){let b;
b=a.outStatistics?a.outStatistics.some(c=>"exceedslimit"===c.statisticType)?this._createExceedsLimitQueryResponse(a):this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a);a.returnQueryGeometry&&(G.isValid(a.outSR)&&!G.equals(this.queryGeometry.spatialReference,a.outSR)?b.queryGeometry=y.cleanFromGeometryEngine({spatialReference:a.outSR,...L.project(this.queryGeometry,this.queryGeometry.spatialReference,a.outSR)}):b.queryGeometry=y.cleanFromGeometryEngine({spatialReference:a.outSR,
...this.queryGeometry}));return b};f.executeAttributesQuery=function(a){var b=T.getWhereClause(a.where,this.fieldsIndex);if(!b)return w.resolve(this);if(b.isStandardized){let c=0;const e=[];for(const d of this.items)b.testFeature(d,this.featureAdapter)&&(e[c++]=d);b=new l(e,this.queryGeometry,this);b.definitionExpression=a.where;return w.resolve(b)}return w.reject(new TypeError("Where clause is not standardized"))};f.executeAggregateIdsQuery=function(a){if(!a.aggregateIds||!a.aggregateIds.length||
K.isNone(this.aggregateAdapter))return w.resolve(this);const b=new Set;for(const e of a.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(e).forEach(d=>b.add(d));const c=this.featureAdapter.getObjectId;return w.resolve(new l(this.items.filter(e=>b.has(c(e))),this.queryGeometry,this))};f.executeObjectIdsQuery=function(a){if(!a.objectIds||!a.objectIds.length)return w.resolve(this);const b=new Set(a.objectIds),c=this.featureAdapter.getObjectId;return w.resolve(new l(this.items.filter(e=>b.has(c(e))),
this.queryGeometry,this))};f.executeTimeQuery=function(a){a=U.getTimeOperator(this.timeInfo,a.timeExtent,this.featureAdapter);if(!K.isSome(a))return w.resolve(this);a=this.items.filter(a);return w.resolve(new l(a,this.queryGeometry,this))};f.filterLatest=function(){const {trackIdField:a,startTimeField:b,endTimeField:c}=this.timeInfo;var e=c||b;const d=new Map,k=this.featureAdapter.getAttribute;for(const n of this.items){const h=k(n,a),g=k(n,e),m=d.get(h);(!m||g>k(m,e))&&d.set(h,n)}e=Array.from(d.values());
return w.resolve(new l(e,this.queryGeometry,this))};f.project=async function(a){if(!a||G.equals(this.spatialReference,a))return this;const b=this.featureAdapter,c=(await L.projectMany(this.items.map(e=>y.getGeometry(this.geometryType,this.hasZ,this.hasM,b.getGeometry(e))),this.spatialReference,a)).map((e,d)=>b.cloneWithGeometry(this.items[d],S.convertFromGeometry(e,this.hasZ,this.hasM)));return new l(c,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,
hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:a,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})};f._sortFeatures=function(a,b,c){if(1<a.length&&b&&b.length)for(const e of b.reverse()){b=e.split(" ");const d=b[0],k=this.fieldsIndex.get(d),n=b[1]&&"desc"===b[1].toLowerCase();a.sort((h,g)=>{h=c(h,d,k);g=c(g,d,k);return O(h,g,k,n)})}};f._createFeatureQueryResponse=function(a){const b=this.items,{geometryType:c,hasM:e,hasZ:d,objectIdField:k,
spatialReference:n}=this,{outFields:h,outSR:g,quantizationParameters:m,resultRecordCount:t,resultOffset:z,returnZ:x,returnM:B}=a,C=null!=t?b.length>(z||0)+t:!1,q=h&&(-1<h.indexOf("*")?[...this.fieldsIndex.fields]:h.map(p=>this.fieldsIndex.get(p)));return{exceededTransferLimit:C,features:this._createFeatures(a,b),fields:q,geometryType:c,hasM:e&&B,hasZ:d&&x,objectIdFieldName:k,spatialReference:y.cleanFromGeometryEngine(g?g:n),transform:m&&M.toQuantizationTransform(m)||null}};f._createFeatures=function(a,
b){const c=new H(a,this.featureAdapter,this.fieldsIndex),{hasM:e,hasZ:d}=this,{orderByFields:k,quantizationParameters:n,returnGeometry:h,returnCentroid:g,maxAllowableOffset:m,resultOffset:t,resultRecordCount:z,returnZ:x=!1,returnM:B=!1}=a,C=d&&x,q=e&&B;a=[];var p=0;b=[...b];this._sortFeatures(b,k,(r,A,D)=>c.getFieldValue(r,A,D));if(h||g){var u=M.toQuantizationTransform(n);if(h&&!g)for(var v of b)a[p++]={attributes:c.getAttributes(v),geometry:y.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(v),
m,u,C,q)};else if(!h&&g)for(const r of b)a[p++]={attributes:c.getAttributes(r),centroid:y.transformCentroid(this,this.featureAdapter.getCentroid(r,this),u)};else for(const r of b)a[p++]={attributes:c.getAttributes(r),centroid:y.transformCentroid(this,this.featureAdapter.getCentroid(r,this),u),geometry:y.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(r),m,u,C,q)}}else for(u of b)(v=c.getAttributes(u))&&(a[p++]={attributes:v});p=t||0;null!=z&&(a=a.slice(p,Math.min(a.length,
p+z)));return a};f._createExceedsLimitQueryResponse=function(a){var b=!1;let c=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY;b=Number.POSITIVE_INFINITY;for(const d of a.outStatistics)if("exceedslimit"===d.statisticType){c=null!=d.maxPointCount?d.maxPointCount:Number.POSITIVE_INFINITY;e=null!=d.maxRecordCount?d.maxRecordCount:Number.POSITIVE_INFINITY;b=null!=d.maxVertexCount?d.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)b=this.items.length>c;else if(this.items.length>
e)b=!0;else{a=this.hasZ?this.hasM?4:3:this.hasM?3:2;const d=this.featureAdapter;b=this.items.reduce((k,n)=>{n=d.getGeometry(n);return k+(n&&n.coords.length||0)},0)/a>b}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(b)}}]}};f._createStatisticsQueryResponse=function(a){var b={attributes:{}};const c=[],e=new Map,d=new Map,k=new Map,n=new Map,h=new H(a,this.featureAdapter,
this.fieldsIndex);var g=a.outStatistics;const {groupByFieldsForStatistics:m,having:t,orderByFields:z}=a;a=m&&m.length;const x=!!a,B=x&&m[0],C=x&&!this.fieldsIndex.get(B);for(const r of g){const {outStatisticFieldName:A,statisticType:D}=r;g=r;var q="exceedslimit"!==D?r.onStatisticField:void 0;const P="percentile_disc"===D||"percentile_cont"===D,V=x&&1===a&&(q===B||C)&&"count"===D;if(x){if(!k.has(q)){var p=[];for(const I of m){var u=this._getAttributeValues(h,I,e);p.push(u)}k.set(q,this._calculateUniqueValues(p))}p=
k.get(q);for(const I in p){const {count:W,data:Q,items:X,itemPositions:Y}=p[I];u=Q.join(",");if(!t||h.validateItems(X,t)){const J=n.get(u)||{attributes:{}};var v=null;if(V)v=W;else{const E=this._getAttributeValues(h,q,e);v=Y.map(F=>E[F]);v=P&&"statisticParameters"in g?this._getPercentileValue(g,v):this._getStatisticValue(g,v)}J.attributes[A]=v;m.forEach((E,F)=>J.attributes[this.fieldsIndex.get(E)?E:`EXPR_${F+1}`]=Q[F]);n.set(u,J)}}}else q=this._getAttributeValues(h,q,e),b.attributes[A]=P&&"statisticParameters"in
g?this._getPercentileValue(g,q):this._getStatisticValue(g,q,d);c.push({name:A,alias:A,type:"esriFieldTypeDouble"})}b=x?Array.from(n.values()):[b];this._sortFeatures(b,z,(r,A)=>r.attributes[A]);return{fields:c,features:b}};f._getStatisticValue=function(a,b,c){const {onStatisticField:e,statisticType:d}=a;a=c&&c.has(e)?c.get(e):this._calculateStatistics(b);c&&c.set(e,a);return a["var"===d?"variance":d]};f._getPercentileValue=function(a,b){const {onStatisticField:c,statisticParameters:e,statisticType:d}=
a,{value:k,orderBy:n}=e,h="desc"===n,g=this.fieldsIndex.get(c);a=[...b].filter(m=>null!=m).sort((m,t)=>O(m,t,g,h));return this._calculatePercentile(a,k,"percentile_disc"===d)};f._getAttributeValues=function(a,b,c){if(c.has(b))return c.get(b);const e=this.fieldsIndex.get(b),d=this.items.map(k=>a.getFieldValue(k,b,e));c.set(b,d);return d};f._calculateStatistics=function(a){let b=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,e=null,d=null,k=null,n=null;const h=[];let g=0;for(const m of a)"string"===
typeof m?g++:null==m||isNaN(m)||(e+=m,b=Math.min(b,m),c=Math.max(c,m),h.push(m),g++);if(g){d=e/g;a=0;for(const m of h)a+=Math.pow(m-d,2);n=1<g?a/(g-1):0;k=Math.sqrt(n)}else c=b=null;return{avg:d,count:g,max:c,min:b,stddev:k,sum:e,variance:n}};f._calculateUniqueValues=function(a){const b={},c=this.items,e=c.length;for(let d=0;d<e;d++){const k=c[d],n=[];for(const g of a)n.push(g[d]);const h=n.join(",");null==b[h]?b[h]={count:1,data:n,items:[k],itemPositions:[d]}:(b[h].count++,b[h].items.push(k),b[h].itemPositions.push(d))}return b};
f._calculatePercentile=function(a,b,c){if(0===a.length)return null;if(0>=b)return a[0];if(1<=b)return a[a.length-1];var e=(a.length-1)*b,d=Math.floor(e);b=d+1;e%=1;d=a[d];const k=a[b];return b>=a.length||c||"string"===typeof d||"string"===typeof k?d:d*(1-e)+k*e};R._createClass(l,[{key:"size",get:function(){return this.items.length}}]);return l}()});