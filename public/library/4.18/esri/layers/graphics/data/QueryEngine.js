// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/lang ../../../core/maybe ../../../core/Error ../../../core/promiseUtils ../../../geometry/support/spatialReferenceUtils ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../core/unitUtils ../../../core/MemCache ../../../geometry/support/aaBoundingRect ../../support/PromiseQueue ../../support/FieldsIndex ./QueryEngineCapabilities ../../../geometry/support/aaBoundingBox ./projectionSupport ./attributeSupport ../../../chunks/spatialQuerySupport ./timeSupport ./QueryEngineResult".split(" "),
function(A,L,w,M,v,N,G,O,H,B,I,C,P,Q,R,x,J,r,l,S,t){function T(u){return u.every(h=>"exceedslimit"!==h.statisticType)}const y=new Set,U=new I.MemCacheStorage(2E6);let V=0,Y=function(){function u(a){this.capabilities={query:R.queryCapabilities};this.geometryType=a.geometryType;this.hasM=a.hasM;this.hasZ=a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.featureStore=a.featureStore;this.aggregateAdapter=a.aggregateAdapter;
this._changeHandle=this.featureStore.events.on("changed",()=>this.clearCache());this.timeInfo=a.timeInfo;a.cacheSpatialQueries&&(this._geometryQueryCache=new I.MemCache(V++ +"$$",U));this.fieldsIndex=new Q(a.fields);a.scheduler&&a.task&&(this._frameQueue=new P,this._frameTask=a.scheduler.registerTask(a.task,b=>this._update(b),()=>0<this._frameQueue.length))}var h=u.prototype;h.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=
null);this.clearCache();this._geometryQueryCache&&this._geometryQueryCache.destroy();this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null);this.fieldsIndex.destroy()};h.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._timeExtent=this._allItems=null};h.executeQuery=async function(a={},b){let c=w.clone(a),d;try{c=await this._schedule(()=>l.normalizeQuery(c,this.definitionExpression,this.spatialReference),b),c=await this._reschedule(()=>this._checkQuerySupport(c),
b),d=await this._reschedule(()=>this._executeGeometryQuery(c,b),b),d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),b),d=await this._reschedule(()=>d.executeObjectIdsQuery(c),b),d=await this._reschedule(()=>d.executeTimeQuery(c),b),d=await this._reschedule(()=>d.executeAttributesQuery(c),b)}catch(f){if(f!==l.QUERY_ENGINE_EMPTY_RESULT)throw f;d=new t([],null,this)}return d.createQueryResponse(c)};h.executeQueryForCount=async function(a={},b){let c=w.clone(a),d;c.returnGeometry=!1;c.returnCentroid=
!1;c.outSR=null;try{c=await this._schedule(()=>l.normalizeQuery(c,this.definitionExpression,this.spatialReference),b),c=await this._reschedule(()=>this._checkQuerySupport(c),b),d=await this._reschedule(()=>this._executeGeometryQuery(c,b),b),d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),b),d=await this._reschedule(()=>d.executeObjectIdsQuery(c),b),d=await this._reschedule(()=>d.executeTimeQuery(c),b),d=await this._reschedule(()=>d.executeAttributesQuery(c),b)}catch(f){if(f!==l.QUERY_ENGINE_EMPTY_RESULT)throw f;
return 0}return d.createQueryResponseForCount(c)};h.executeQueryForExtent=async function(a={},b){let c=w.clone(a),d;a=c.outSR;try{c=await this._schedule(()=>l.normalizeQuery(c,this.definitionExpression,this.spatialReference),b);c=await this._reschedule(()=>this._checkQuerySupport(c),b);c.returnGeometry=!0;c.returnCentroid=!1;c.outSR=null;d=await this._reschedule(()=>this._executeGeometryQuery(c,b),b);d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),b);d=await this._reschedule(()=>d.executeObjectIdsQuery(c),
b);d=await this._reschedule(()=>d.executeTimeQuery(c),b);d=await this._reschedule(()=>d.executeAttributesQuery(c),b);const f=d.size;if(!f)return{count:f,extent:null};x.set(p,x.NEGATIVE_INFINITY);this.featureStore.forEachBounds(d.items,g=>x.expandWithAABB(p,g),W);const k={xmin:p[0],ymin:p[1],xmax:p[3],ymax:p[4],spatialReference:l.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(p[2])&&isFinite(p[5])&&(k.zmin=p[2],k.zmax=p[5]);const e=J.project(k,d.spatialReference,a);e.spatialReference=
l.cleanFromGeometryEngine(a||this.spatialReference);if(0===e.xmax-e.xmin){const g=B.getMetersPerUnitForSR(e.spatialReference);e.xmin-=g;e.xmax+=g}if(0===e.ymax-e.ymin){const g=B.getMetersPerUnitForSR(e.spatialReference);e.ymin-=g;e.ymax+=g}if(this.hasZ&&null!=e.zmin&&null!=e.zmax&&0===e.zmax-e.zmin){const g=B.getMetersPerUnitForSR(e.spatialReference);e.zmin-=g;e.zmax+=g}return{count:f,extent:e}}catch(f){if(f===l.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw f;}};h.executeQueryForIds=
async function(a={},b){return this.executeQueryForIdSet(a,b).then(c=>Array.from(c))};h.executeQueryForIdSet=async function(a={},b){let c=w.clone(a),d;c.returnGeometry=!1;c.returnCentroid=!1;c.outSR=null;try{c=await this._schedule(()=>l.normalizeQuery(c,this.definitionExpression,this.spatialReference),b);c=await this._reschedule(()=>this._checkQuerySupport(c),b);d=await this._reschedule(()=>this._executeGeometryQuery(c,b),b);d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),b);d=await this._reschedule(()=>
d.executeObjectIdsQuery(c),b);d=await this._reschedule(()=>d.executeTimeQuery(c),b);d=await this._reschedule(()=>d.executeAttributesQuery(c),b);const f=d.items,k=new Set;await this._reschedule(()=>{for(const e of f)k.add(d.featureAdapter.getObjectId(e))},b);return k}catch(f){if(f===l.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw f;}};h.executeQueryForLatestObservations=async function(a={},b){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new v("feature-store:unsupported-query","Missing timeInfo or timeInfo.trackIdField",
{query:a,timeInfo:this.timeInfo});let c=w.clone(a),d;try{c=await this._schedule(()=>l.normalizeQuery(c,this.definitionExpression,this.spatialReference),b),c=await this._reschedule(()=>this._checkQuerySupport(c),b),d=await this._reschedule(()=>this._executeGeometryQuery(c,b),b),d=await this._reschedule(()=>d.executeAggregateIdsQuery(c),b),d=await this._reschedule(()=>d.executeObjectIdsQuery(c),b),d=await this._reschedule(()=>d.executeTimeQuery(c),b),d=await this._reschedule(()=>d.executeAttributesQuery(c),
b),d=await this._reschedule(()=>d.filterLatest(),b)}catch(f){if(f!==l.QUERY_ENGINE_EMPTY_RESULT)throw f;d=new t([],null,this)}return d.createQueryResponse(c)};h._schedule=async function(a,b){return this._frameQueue?this._frameQueue.push(a,b):a()};h._reschedule=async function(a,b){return this._frameQueue?this._frameQueue.unshift(a,b):a()};h._update=function(a){for(this._budget=a;!a.done&&this._frameQueue&&this._frameQueue.process();)a.madeProgress();this._budget=null};h._getAll=function(){if(!this._allItems){const a=
[];this.featureStore.forEach(b=>a.push(b));this._allItems=new t(a,null,this)}return this._allItems};h._executeGeometryQuery=async function(a,b){const {geometry:c,outSR:d,spatialRel:f}=a,k=G.isValid(d)&&!G.equals(this.spatialReference,d),e=this._geometryQueryCache?k?JSON.stringify({geometry:c,spatialRelationship:f,outSpatialReference:d}):JSON.stringify({geometry:c,spatialRelationship:f}):null;if(e){var g=this._geometryQueryCache.get(e);if(!M.isUndefined(g))return g}g=async m=>{if(k&&(a.returnGeometry||
a.returnCentroid))return m=await m.project(d),e&&this._geometryQueryCache.put(e,m,m.size||1),m;e&&this._geometryQueryCache.put(e,m,m.size||1);return m};if(!c)return g(this._getAll());const n=this.featureAdapter;if("esriSpatialRelDisjoint"===f){const m=this._searchFeatures(this._getQueryBBoxes(c));if(!m.length)return g(this._getAll());let D,K;const E=new Set;for(var q of m)E.add(n.getObjectId(q));await this._reschedule(()=>{let F=0;D=Array(E.size);this.featureStore.forEach(z=>D[F++]=z);K=E},b);q=await this._reschedule(async()=>
{const F=await l.getSpatialQueryOperator(f,c,this.geometryType,this.hasZ,this.hasM);return new t(await this._runSpatialFilter(D,z=>!K.has(n.getObjectId(z))||F(n.getGeometry(z)),b),c,this)},b);return g(q)}q=this._searchFeatures(this._getQueryBBoxes(c));if(!q.length)return g=new t([],c,this),e&&this._geometryQueryCache.put(e,g,g.size||1),g;if(this._canExecuteSoloPass(c,a))return g(new t(q,c,this));const X=await l.getSpatialQueryOperator(f,c,this.geometryType,this.hasZ,this.hasM);q=await this._runSpatialFilter(q,
m=>X(n.getGeometry(m)),b);return g(new t(q,c,this))};h._runSpatialFilter=async function(a,b,c){if(!b)return a;if(!this._budget)return a.filter(e=>b(e));let d=0;const f=[],k=async()=>{for(;d<a.length;){const e=a[d];b(e)&&f.push(e);this._budget.done&&await this._reschedule(()=>k(),c);++d}};return this._reschedule(()=>k(),c).then(()=>f)};h._canExecuteSoloPass=function(a,b){const {geometryType:c}=this;({spatialRel:b}=b);return l.canQueryWithRBush(a)&&("esriSpatialRelEnvelopeIntersects"===b||"esriGeometryPoint"===
c&&("esriSpatialRelIntersects"===b||"esriSpatialRelContains"===b||"esriSpatialRelWithin"===b))};h._getQueryBBoxes=function(a){if(l.canQueryWithRBush(a)){if(H.isExtent(a))return[C.fromValues(a.xmin,a.ymin,a.xmax,a.ymax)];if(H.isPolygon(a))return a.rings.map(b=>C.fromValues(Math.min(b[0][0],b[2][0]),Math.min(b[0][1],b[2][1]),Math.max(b[0][0],b[2][0]),Math.max(b[0][1],b[2][1])))}return[O.getBoundsXY(C.create(),a)]};h._searchFeatures=function(a){for(const d of a)this.featureStore.forEachInBounds(d,f=>
{y.add(f)});const b=Array(y.size);let c=0;y.forEach(d=>b[c++]=d);y.clear();return b};h._checkQuerySupport=async function(a){if(0>a.distance||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text)throw new v("feature-store:unsupported-query","Unsupported query options",{query:a});return N.all([this._checkAttributesQuerySupport(a),this._checkStatisticsQuerySupport(a),l.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),J.checkProjectionSupport(this.spatialReference,
a.outSR)]).then(()=>a)};h._checkAttributesQuerySupport=function(a){const {outFields:b,orderByFields:c,returnDistinctValues:d,outStatistics:f}=a,k=f?f.map(e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase()):[];if(c&&0<c.length){const e=c.map(g=>{const n=g.toLowerCase();return-1<n.indexOf(" asc")?n.split(" asc")[0]:-1<n.indexOf(" desc")?n.split(" desc")[0]:g}).filter(g=>-1===k.indexOf(g));r.validateFields(this.fieldsIndex,e,"orderByFields contains missing fields")}if(b&&0<b.length)r.validateFields(this.fieldsIndex,
b,"outFields contains missing fields");else if(d)throw new v("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:a});r.validateWhere(this.fieldsIndex,a.where)};h._checkStatisticsQuerySupport=async function(a){const {outStatistics:b,groupByFieldsForStatistics:c,having:d}=a;var f=c&&c.length,k=b&&b.length;if(d){if(!f||!k)throw new v("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:a});
r.validateHaving(this.fieldsIndex,d,b)}if(k&&T(b)){k=b.map(e=>e.onStatisticField);r.validateFields(this.fieldsIndex,k,"onStatisticFields contains missing fields");f&&r.validateFields(this.fieldsIndex,c,"groupByFieldsForStatistics contains missing fields");for(const e of b){const {onStatisticField:g,statisticType:n}=e;if(("percentile_disc"===n||"percentile_cont"===n)&&"statisticParameters"in e){if({statisticParameters:f}=e,!f)throw new v("feature-store:unsupported-query","statisticParamters should be set for percentile type",
{definition:e,query:a});}else if("count"!==n&&g&&r.hasInvalidFieldType(g,this.fieldsIndex))throw new v("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:e,query:a});}}};L._createClass(u,[{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}},{key:"fullExtent",get:function(){const a=this.featureStore.fullBounds;return a?{xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:l.cleanFromGeometryEngine(this.spatialReference)}:null}},{key:"timeExtent",
get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:this._timeExtent=S.getTimeExtent(this.timeInfo,this.featureStore):null}}]);return u}();const W=x.create(),p=x.create();A.Feature=function(u,h=null,a,b,c){this.attributes=u;this.geometry=a;this.centroid=b;this.filterFlags=c;this.groupId=-1;this.displayId=h};A.default=Y;Object.defineProperty(A,"__esModule",{value:!0})});