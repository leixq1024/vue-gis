// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/promiseUtils ../../../../support/arcadeOnDemand ../../../../tasks/support/ClassBreaksDefinition ../../../../tasks/support/generateRendererUtils ../../utils ../../../../renderers/support/heatmapUtils".split(" "),function(m,E,N,O,P,x,F){function G(a,b,c){b=null==b?-Infinity:b;c=null==c?Infinity:c;return a.filter(d=>null!=d&&t(d)&&d>=b&&d<=c)}async function v(a,b){const c=a.field,d="function"===typeof c,e=a.valueExpression,h=a.normalizationType,l=a.normalizationField,
g=a.normalizationTotal,f=[];a=a.view;let k=null,p=null;if(e){if(!u){const {arcadeUtils:r}=await N.loadArcade();u=r}k=u.createFunction(e);p=a&&u.getViewInfo({viewingMode:"2d"===a.type?"map":a.viewingMode,scale:a.scale,spatialReference:a.spatialReference})}if(!b)return f;b.forEach(r=>{var q=r.attributes;if(e){var n=u.createExecContext(r,p);n=u.executeFunction(k,n)}else d?n=c.call(null,r):q&&(n=q[c]);h&&null!=n&&t(n)&&(q=q&&parseFloat(q[l]),"log"===h&&0!==n?n=Math.log(n)*Math.LOG10E:"percent-of-total"===
h&&t(g)&&0!==g?n=n/g*100:"field"===h&&t(q)&&0!==q&&(n/=q));f.push(n)});return f}function Q(a,b){let c=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,e=null,h=null;var l=null;let g=null;for(var f of a)e+=f,c=Math.min(c,f),d=Math.max(d,f);if(f=a.length){h=e/f;l=0;for(const k of a)l+=Math.pow(k-h,2);g=b?1<f?l/(f-1):0:0<f?l/f:0;l=Math.sqrt(g)}else d=c=null;return{avg:h,count:f,max:d,min:c,stddev:l,sum:e,variance:g}}function H(a){const b=a.field,c=a.classificationMethod||"equal-interval",d=a.normalizationType,
e=a.normalizationField,h=new O;h.classificationField=b;h.breakCount=a.breakCount;h.classificationMethod=c;h.standardDeviationInterval="standard-deviation"===c?a.standardDeviationInterval||1:void 0;h.normalizationType=d;h.normalizationField="field"===d?e:void 0;return h}function I(a,b){let c=b.classBreaks;const d=c[0].minValue,e=c[c.length-1].maxValue,h="standard-deviation"===a.classificationMethod,l=R;c=c.map(g=>{const f=g.label;g={minValue:g.minValue,maxValue:g.maxValue,label:f};if(h&&f){const k=
f.match(l).map(p=>+p.trim());2===k.length?(g.minStdDev=k[0],g.maxStdDev=k[1],0>k[0]&&0<k[1]&&(g.hasAvg=!0)):1===k.length&&(-1<f.indexOf("\x3c")?(g.minStdDev=null,g.maxStdDev=k[0]):-1<f.indexOf("\x3e")&&(g.minStdDev=k[0],g.maxStdDev=null))}return g});return{minValue:d,maxValue:e,classBreakInfos:c,normalizationTotal:b.normalizationTotal}}function B(a,b,c){b=(b-a)/c;const d=[];let e;for(let h=1;h<=c;h++)e=a+b,e=Number(e.toFixed(16)),d.push([a,e]),a=e;return d}function J(a){const {field:b,normalizationType:c,
normalizationField:d,normalizationTotal:e,layer:h}=a;a=x.isIntegerField(h,b);let l=b;"percent-of-total"===c?l=`((${a?x.castIntegerFieldToFloat(b):b} / ${e}) * 100)`:"log"===c?l=`(log(${b}) * ${S})`:"field"===c&&(l=`(${a?x.castIntegerFieldToFloat(b):b} / ${d})`);return l}function T(a,b){let c=-1;for(let d=a.length-1;0<=d;d--)if(b>=a[d][0]){c=d;break}return c}function K(a,b){let c;b=b.toLowerCase();if(a)for(const d in a)if(d.toLowerCase()!==b){c=a[d];break}return c}function C(a,b){let c;b=b.toLowerCase();
if(a)for(const d in a)if(d.toLowerCase()===b){c=a[d];break}return c}function D(a,b){if(b)for(const c in a)a[c].label=b[c];return{count:a}}function L(a,b,c){const d=a.count;a=[];c&&b&&"coded-value"===b.type&&b.codedValues.forEach(e=>{e=e.code;d.hasOwnProperty(e)||(d[e]={data:e,count:0})});for(const e in d)b=d[e],a.push({value:b.data,count:b.count,label:b.label});return{uniqueValueInfos:a}}function t(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a}const U=/_value$/i,R=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,
S=Math.LOG10E,M="min max avg stddev count sum variance".split(" ");let u=null;m.calculateClassBreaksFromMemory=async function(a,b){var c=a.normalizationTotal;const d=H({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5});b=await v(a,b);b=G(b,a.minValue,a.maxValue);c=P.createGenerateRendererClassBreaks({definition:d,values:b,normalizationTotal:c});
return I(a,c)};m.calculateHeatmapStats=function(a,b=10,c,d,e,h){const l=new Float64Array(e*h),g=F.createKernel(b);b=Math.round(3*b);let f=Number.POSITIVE_INFINITY,k=Number.NEGATIVE_INFINITY;var p=0;let r=0,q=0,n=0;c=F.createValueFunction(d,c);for(const {geometry:y,attributes:V}of a){a=y.x-b;d=y.y-b;const W=Math.max(0,a);p=Math.max(0,d);const X=Math.min(h,y.y+b),Y=Math.min(e,y.x+b),Z=+c(V);for(let z=p;z<X;z++){const aa=g[z-d];for(let A=W;A<Y;A++){p=z*e+A;var w=l[p];p=l[p]+=aa*g[A-a]*Z;w=p-w;r+=w;q+=
w*w;p<f&&(f=p);p>k&&(k=p);n++}}}return n?{mean:r/n,stdDev:Math.sqrt((q-r*r/n)/n),min:f,max:k,mid:(k-f)/2,count:n}:{mean:0,stddev:0,min:0,max:0,mid:0,count:0}};m.calculateHistogramFromMemory=async function(a,b,c){const {min:d,max:e,normTotal:h}=b,l=a.numBins||10,g=b.intervals||B(d,e,l);b=g.map((f,k)=>({minValue:g[k][0],maxValue:g[k][1],count:0}));a=await v(a,c);for(const f of a)null!=f&&f>=d&&f<=e&&(a=T(g,f),-1<a&&b[a].count++);return{bins:b,minValue:d,maxValue:e,normalizationTotal:h}};m.calculateStatsFromMemory=
async function(a,b,c){b=await v(a,b);b=G(b,a.minValue,a.maxValue);const d=Q(b,!a.normalizationType);c&&["avg","stddev","variance"].forEach(e=>{null!=d[e]&&(d[e]=Math.ceil(d[e]))});return d};m.calculateUniqueValuesFromMemory=async function(a,b,c){b=await v(a,b);const d={};for(let e of b){if(null==e||"string"===typeof e&&""===e.trim())e=null;null==d[e]?d[e]={count:1,data:e}:d[e].count++}return L({count:d},c,a.returnAllCodedValues)};m.createCBDefn=H;m.createUVResult=L;m.generateBinParams=function(a){const b=
[],c=a.classBreaks,d=c[0].minValue,e=c[c.length-1].maxValue;c.forEach(h=>{b.push([h.minValue,h.maxValue])});return{min:d,max:e,intervals:b,sqlExpr:J({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,layer:a.layer}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};m.getDataValues=v;m.getEqualIntervalBins=B;m.getFieldExpr=J;m.getHistogramFromFeatureSet=function(a,b,c,d,e){const h={};a&&a.features&&a.features.forEach(g=>
{var f=g.attributes;g=K(f,"countOFExpr");f=C(f,"countOFExpr");0!==g&&(h[g]=f)});const l=[];B(b,c,d).forEach((g,f)=>{f=(f+1).toString();l.push({minValue:g[0],maxValue:g[1],count:h.hasOwnProperty(f)?h[f]:0})});return{bins:l,minValue:b,maxValue:c,normalizationTotal:e}};m.getMissingFields=async function(a,b,c){const d=[];if(b)for(const e of b)b=a.getField(e),"availableFields"in c&&-1===c.availableFields.indexOf(b.name)&&d.push(b.name);return d};m.getSummaryStatisticsFromFeatureSet=function(a,b){a=(a=
a&&a.features)&&a[0]&&a[0].attributes;const c={};for(const d in a)c[d.replace(U,"").toLowerCase()]=a[d];c.min===c.max&&null!=c.min&&null==c.stddev&&(c.stddev=c.variance=0);b&&("min max avg stddev sum variance".split(" ").forEach(d=>{null!=c[d]&&(c[d]=Math.ceil(c[d]))}),c.min===c.max&&null!=c.min&&(c.avg=c.min,c.stddev=c.variance=0));return c};m.getUniqueValuesFromFeatureSet=function(a,b,c,d,e){const h="countOF"+(c||"Expr"),l={};let g=!1;(a&&a.features).forEach(f=>{var k=f.attributes;f=C(k,h);k=c?
C(k,c):K(k,h);null===k&&0===f&&(g=!0);if(null==k||"string"===typeof k&&""===k.trim())k=null;null==l[k]?l[k]={count:f,data:k}:l[k].count+=f});return c&&g?b.queryFeatureCount(c+" is NULL",e).then(f=>{l["null"].count+=f||0;return D(l,d)}).catch(()=>{E.throwIfAborted(e);return D(l,d)}):E.resolve(D(l,d))};m.isValidNumber=t;m.msSinceUnixEpochSQL=function(a,b){return x.getDateDiffSQL(a,new Date(0),b,"milliseconds").sqlExpression};m.processSummaryStatisticsResult=function(a){let b;for(b in a)-1<M.indexOf(b)&&
(t(a[b])||(a[b]=null));return a};m.resolveCBResult=I;m.statisticTypes=M;Object.defineProperty(m,"__esModule",{value:!0})});