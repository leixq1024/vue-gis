// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("exports ../../core/maybe ../../core/Error ../../core/promiseUtils ../../renderers/support/AuthoringInfo ../../renderers/Renderer ../../renderers/ClassBreaksRenderer ../../renderers/UniqueValueRenderer ../../renderers/DictionaryRenderer ../../renderers/DotDensityRenderer ../../renderers/HeatmapRenderer ../../renderers/SimpleRenderer ../../renderers/support/jsonUtils ../../geometry/support/scaleUtils ../support/utils ../support/adapters/support/layerUtils ../statistics/spatialStatistics ../heuristics/outline ./support/utils ./support/dotDensityUtils ../statistics/summaryStatisticsForAttributes ../statistics/support/attributeDensity ../../chunks/dotDensity".split(" "),
function(t,p,k,q,x,N,O,P,Q,y,R,S,T,u,z,v,A,B,r,m,C,D,w){async function E(a){if(!(a&&a.layer&&a.view&&a.attributes&&a.attributes.length))throw new k("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(8<a.attributes.length)throw new k("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");a={...a};var b=[2,1];const c=v.createLayerAdapter(a.layer,b);a.layer=c;a.dotBlendingEnabled=null==a.dotBlendingEnabled?
!0:a.dotBlendingEnabled;a.dotValueOptimizationEnabled=null==a.dotValueOptimizationEnabled?!0:a.dotValueOptimizationEnabled;if(!c)throw new k("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+v.getLayerTypeLabels(b).join(", "));b=p.isSome(a.signal)?{signal:a.signal}:null;await q.all([a.view.when(),c.load(b)]);if("polygon"!==c.geometryType)throw new k("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");return a}async function F(a){let b=
a.dotDensityScheme,c=null;var e=null;e=await r.getBasemapInfo(a.basemap,a.view);c=p.isSome(e.basemapId)?e.basemapId:null;e=p.isSome(e.basemapTheme)?e.basemapTheme:null;if(b)return{scheme:w.cloneScheme(b),basemapId:c,basemapTheme:e};if(a=w.getSchemes({basemap:c,numColors:a.attributes.length,basemapTheme:e}))b=a.primaryScheme,c=a.basemapId,e=a.basemapTheme;return{scheme:b,basemapId:c,basemapTheme:e}}async function G(a){const {view:b,layer:c,attributes:e,signal:g}=a;a=await c.getSampleFeatures({view:b,
sampleSize:500,returnGeometry:!0,signal:g});const [d,h]=await q.all([A({features:a,geometryType:c.geometryType}),C({layer:c,attributes:e,includeZeros:!1,includeNegatives:!1,view:b,signal:g})]);a="avgSize"in d&&d.avgSize;const f=h.avg;if(!a)throw new k("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!f)throw new k("dot-density-renderer:insufficient-info","Average attribute value is invalid");const n=u.getResolutionForScale(b.scale,b.spatialReference);return{dotValue:m.roundValue(f/
(a*a/(n*n)*.1))||1,referenceScale:b.scale,minSliderValue:1,maxSliderValue:m.roundValue(f)}}async function H(a){const {view:b,layer:c,attributes:e,signal:g}=a;a=[];for(var d of e){var h=await z.getFieldsList({field:d.field,valueExpression:d.valueExpression});a.push(...h)}d=await c.getSampleFeatures({view:b,sampleSize:500,requiredFields:a,returnGeometry:!0,signal:g});d=await D({features:d,attributes:e,includeZeros:!1,includeNegatives:!1,view:b});if(!d.avgDensity||!d.minDensity||!d.maxDensity)throw new k("dot-density-renderer:insufficient-info",
"Invalid density values");a=u.getResolutionForScale(b.scale,b.spatialReference);const f=a*a;a=m.roundValue(d.minDensity*f);h=m.roundValue(d.maxDensity*f);d=m.roundValue(d.avgDensity*f*10)||1;d>h&&(d=h);return{dotValue:d,referenceScale:b.scale,minSliderValue:a,maxSliderValue:h}}t.createRenderer=async function(a){var b=await E(a),c=b.layer;const e=c.geometryType,g=(a=await F(b))&&a.scheme;if(!g)throw new k("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");c={layer:c,view:b.view,
attributes:b.attributes,signal:b.signal};const d={layer:b.layer,view:b.view,signal:b.signal},[h,f]=await q.all([b.trueDensity?H(c):G(c),b.outlineOptimizationEnabled?B(d):null]),{dotValue:n,referenceScale:I,minSliderValue:J,maxSliderValue:K}=h,L=r.createColors(g.colors,b.attributes.length);c=b.attributes.map((l,M)=>({field:l.field,valueExpression:l.valueExpression,label:l.label,valueExpressionTitle:l.valueExpressionTitle,color:L[M]}));b=new y({attributes:c,dotBlendingEnabled:b.dotBlendingEnabled,outline:f?
r.getSymbolOutlineFromScheme(g,e,f.opacity):null,dotValue:n,referenceScale:b.dotValueOptimizationEnabled?I:null,legendOptions:b.legendOptions});f&&f.visualVariables&&f.visualVariables.length&&(b.visualVariables=f.visualVariables.map(l=>l.clone()));b.authoringInfo=new x({type:"dot-density",minSliderValue:J,maxSliderValue:K});return{renderer:b,dotDensityScheme:g,basemapId:a.basemapId,basemapTheme:a.basemapTheme}};Object.defineProperty(t,"__esModule",{value:!0})});