// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("require exports ../core/maybe ../core/jsonMap ../core/Error ../core/promiseUtils ../geometry/support/spatialReferenceUtils ../geometry/support/contains ../geometry/support/intersects ../geometry/support/extentUtils ../geometry/support/jsonUtils ../core/unitUtils ../geometry/support/normalizeUtils ../layers/graphics/OptimizedGeometry ../layers/graphics/featureConversionUtils ../layers/graphics/centroid ../layers/graphics/data/projectionSupport ../layers/graphics/contains".split(" "),function(H,
k,I,J,w,q,n,C,K,L,m,M,N,p,l,O,r,D){function E(b,a,d,c=b.hasZ,e=b.hasM){const g=b.hasZ&&c,h=b.hasM&&e;return d?(b=l.quantizeOptimizedGeometry(x,a,b.hasZ,b.hasM,"esriGeometryPoint",d,c,e),l.convertToPoint(b,g,h)):l.convertToPoint(a,g,h)}function t(b,a,d,c,e,g,h=a,f=d){const u=a&&h,v=d&&f;c=c?"coords"in c?c:c.geometry:null;if(!c)return null;if(e)return a=l.generalizeOptimizedGeometry(P,c,a,d,b,e,h,f),g&&(a=l.quantizeOptimizedGeometry(x,a,u,v,b,g)),y[b](a,u,v);if(g)return g=l.quantizeOptimizedGeometry(x,
c,a,d,b,g,h,f),y[b](g,u,v);l.removeZMValues(F,c,a,d,h,f);return y[b](F,u,v)}async function z(b,a,d){if(!b)return null;var {where:c}=b;b.where=c=c&&c.trim();if(!c||/^1 *= *1$/.test(c)||a&&a===c)b.where=null;if(!b.geometry)return b;a=await Q(b);b.distance=0;b.units=null;"esriSpatialRelEnvelopeIntersects"===b.spatialRel&&({spatialReference:c}=b.geometry,a=L.getGeometryExtent(a),a.spatialReference=c);b.geometry=a;await r.checkProjectionSupport(a.spatialReference,d);a=(await N.normalizeCentralMeridian(m.fromJSON(a)))[0];
if(I.isNone(a))throw A;a=a.toJSON();a=await r.project(a,a.spatialReference,d);if(!a)throw A;a.spatialReference=d;b.geometry=a;return b}async function Q(b){const {geometry:a,distance:d,units:c}=b;if(null==d||"vertexAttributes"in a)return a;var e=a.spatialReference;b=c?R.fromJSON(c):M.getUnitString(e);e=e&&(n.isGeographic(e)||n.isWebMercator(e))?a:await r.checkProjectionSupport(e,n.WGS84).then(()=>r.project(a,n.WGS84));return(await G())(e.spatialReference,e,d,b)}function B(){return new Promise(function(b,
a){H(["../geometry/geometryEngineJSON"],b,a)})}function G(){return B().then(b=>b.geodesicBuffer)}const R=new J.JSONMap({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),A=Object.freeze({}),F=new p,P=new p,x=new p,y={esriGeometryPoint:l.convertToPoint,esriGeometryPolyline:l.convertToPolyline,esriGeometryPolygon:l.convertToPolygon,esriGeometryMultipoint:l.convertToMultipoint},
S=(b,a)=>"_geVersion"!==b?a:void 0,T={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null};var U={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,
esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},V={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},W={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};k.QUERY_ENGINE_EMPTY_RESULT=A;k.canQueryWithRBush=function(b){if(m.isExtent(b))return!0;if(m.isPolygon(b)){for(const a of b.rings)if(5!==
a.length||a[0][0]!==a[1][0]||a[0][0]!==a[4][0]||a[2][0]!==a[3][0]||a[0][1]!==a[3][1]||a[0][1]!==a[4][1]||a[1][1]!==a[2][1])return!1;return!0}return!1};k.checkSpatialQuerySupport=async function(b,a,d){const {spatialRel:c,geometry:e}=b;if(e){if(!0!==U[c])throw new w("feature-store:unsupported-query","Unsupported query spatial relationship",{query:b});if(n.isValid(e.spatialReference)&&n.isValid(d)){if(!0!==V[m.getJsonType(e)])throw new w("feature-store:unsupported-query","Unsupported query geometry type",
{query:b});if(!0!==W[a])throw new w("feature-store:unsupported-query","Unsupported layer geometry type",{query:b});if(b.outSR)return r.checkProjectionSupport(b.geometry&&b.geometry.spatialReference,b.outSR)}}};k.cleanFromGeometryEngine=function(b){return b&&"_geVersion"in b?JSON.parse(JSON.stringify(b,S)):b};k.getCentroid=function(b,a,d){if("esriGeometryPolygon"!==b.geometryType||!a||!a.centroid&&!a.geometry)return null;a.centroid||(a.centroid=O.getCentroidOptimizedGeometry(new p,a.geometry,b.hasZ,
b.hasM));return E(b,a.centroid,d)};k.getGeodesicBufferOperator=G;k.getGeometry=t;k.getSpatialQueryOperator=function(b,a,d,c,e){if(m.isPolygon(a)&&"esriGeometryPoint"===d&&("esriSpatialRelIntersects"===b||"esriSpatialRelContains"===b)){const g=l.convertFromPolygon(new p,a,!1,!1);return q.resolve(h=>D.polygonContainsPoint(g,!1,!1,h))}if(m.isPolygon(a)&&"esriGeometryMultipoint"===d){const g=l.convertFromPolygon(new p,a,!1,!1);if("esriSpatialRelContains"===b)return q.resolve(h=>D.polygonContainsMultipoint(g,
!1,!1,h,c,e))}if(m.isExtent(a)&&"esriGeometryPoint"===d&&("esriSpatialRelIntersects"===b||"esriSpatialRelContains"===b))return q.resolve(g=>C.extentContainsPoint(a,t(d,c,e,g)));if(m.isExtent(a)&&"esriGeometryMultipoint"===d&&"esriSpatialRelContains"===b)return q.resolve(g=>C.extentContainsMultipoint(a,t(d,c,e,g)));if(m.isExtent(a)&&"esriSpatialRelIntersects"===b){const g=K.getExtentIntersector(d);return q.resolve(h=>g(a,t(d,c,e,h)))}return B().then(g=>{const h=g[T[b]].bind(null,a.spatialReference,
a);return f=>h(t(d,c,e,f))})};k.importGeometryEngine=B;k.normalizeFilter=async function(b,a,d){return z(b,a,d)};k.normalizeQuery=async function(b,a,d){const {outFields:c,orderByFields:e,groupByFieldsForStatistics:g,outStatistics:h}=b;if(c)for(var f=0;f<c.length;f++)c[f]=c[f].trim();if(e)for(f=0;f<e.length;f++)e[f]=e[f].trim();if(g)for(f=0;f<g.length;f++)g[f]=g[f].trim();if(h)for(f=0;f<h.length;f++)h[f].onStatisticField&&(h[f].onStatisticField=h[f].onStatisticField.trim());b.geometry&&!b.outSR&&(b.outSR=
b.geometry.spatialReference);return z(b,a,d)};k.normalizeQueryLike=z;k.transformCentroid=E});