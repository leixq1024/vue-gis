// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.18/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/has ../core/lang ../core/maybe ../core/string ../core/Logger ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/property ../core/jsonMap ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../core/Error ../core/urlUtils ../core/uuid ../portal/support/resourceExtension ../core/promiseUtils ../support/arcadeOnDemand ../layers/support/fieldUtils ../Color ../symbols/CIMSymbol ../request ./Renderer ./mixins/VisualVariablesMixin ../core/LRUCache".split(" "),
function(x,n,l,r,t,D,E,N,p,O,F,y,G,P,Q,R,u,z,H,I,J,A,K,L,M){var w;const B=E.getLogger("esri.renderers.DictionaryRenderer");l=w=function(q){function v(a){a=q.call(this,a)||this;a._ongoingRequests=new Map;a._symbolCache=new M(100);a.config=null;a.fieldMap=null;a.scaleExpression=null;a.scaleExpressionTitle=null;a.url=null;a.type="dictionary";return a}x._inheritsLoose(v,q);var h=v.prototype;h.writeData=function(a,b){a&&(b.scalingExpressionInfo={expression:a,returnType:"number"})};h.writeVisualVariables=
function(a,b,c,e){null!=e&&e.origin||q.prototype.writeVisualVariables.call(this,a,b,c,e)};h.clone=function(){return new w({config:r.clone(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:r.clone(this.fieldMap),url:r.clone(this.url),visualVariables:r.clone(this.visualVariables)})};h.getSymbolAsync=async function(a,b){this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(b));try{var c=await this._dictionaryPromise}catch(g){if(u.isAbortError(g))return this._dictionaryPromise=
null}var e={};if(this.fieldMap)for(var f of this._symbolFields){var d=this.fieldMap[f];e[f]=d&&null!==a.attributes[d]&&void 0!==a.attributes[d]?""+a.attributes[d]:""}a=c(e,b);if(!a||"string"!==typeof a)return null;const k=D.numericHash(a).toString();if(c=this._symbolCache.get(k))return c.catch(()=>{this._symbolCache.pop(k)}),c;e=a.split(";");a=[];c=[];for(const g of e)if(g&&0!==g.length)if(-1!==g.indexOf("po:"))d=g.substr(3).split("|"),3===d.length&&(e=d[0],f=d[1],d=d[2],"DashTemplate"===f?d=d.split(" ").map(m=>
Number(m)):"Color"===f?(d=(new I(d)).toRgba(),d=[d[0],d[1],d[2],255*d[3]]):d=Number(d),c.push({primitiveName:e,propertyName:f,value:d}));else if(-1!==g.indexOf("|"))for(const m of g.split("|"))this._itemNames.has(m)&&a.push(m);else this._itemNames.has(g)&&a.push(g);b=this._cimPartsToCIMSymbol(a,c,b);this._symbolCache.put(k,b,1);return b};h.collectRequiredFields=async function(a,b){await this.collectVVRequiredFields(a,b);this.scaleExpression&&await H.collectArcadeFieldNames(a,b,this.scaleExpression);
b=b.map(c=>c.name);for(const c in this.fieldMap)0>b.indexOf(this.fieldMap[c])||a.add(this.fieldMap[c])};h.fetchResources=async function(a){if(this._dictionaryPromise)return this._dictionaryPromise;if(this.url){var b=t.isSome(a)?a.abortOptions:null;b=A(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},...b});var [{data:c}]=await u.all([b,z.loadArcade()]);if(!c)throw this._dictionaryPromise=null,new G("esri.renderers.DictionaryRenderer","Bad dictionary data!");
b=c.expression;var e=c.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+c.cimRefTemplateUrl;this._itemNames=new Set(c.itemsNames);this._symbolFields=e.symbol;c={};if(this.config){const k=this.config;for(var f in k)c[f]=k[f]}for(var d of e.configuration)c.hasOwnProperty(d.name)||(c[d.name]=d.value);f=[];if(t.isSome(a)&&a.fields&&this.fieldMap)for(const k of this._symbolFields){const g=this.fieldMap[k];d=a.fields.filter(m=>m.name===g);0<d.length&&f.push({...d[0],name:k})}return this._dictionaryPromise=
z.createDictionaryExpression(b,t.isSome(a)?a.spatialReference:null,f,c).then(k=>{const g={scale:0};return(m,C)=>{m=k.repurposeFeature({geometry:null,attributes:m});g.scale=t.isSome(C)?C.scale:void 0;return k.evaluate({$feature:m,$view:g})}}).catch(k=>{B.error("Creating dictinoary expression failed:",k);return null})}B.error("no valid URL!")};h.getSymbol=function(){return null};h.getSymbols=function(){return[]};h.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((a,
b)=>a+b.getAttributeHash(),"")};h.getMeshHash=function(){return`${this.url}-${JSON.stringify(this.fieldMap)}`};h.getSymbolFields=function(){return this._symbolFields};h._getSymbolPart=async function(a,b){if(this._ongoingRequests.has(a))return this._ongoingRequests.get(a).then(e=>e.data);const c=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,a);b=A(c,{responseType:"json",query:{f:"json"},...b});this._ongoingRequests.set(a,b);try{return(await b).data}catch(e){return this._ongoingRequests.delete(a),
u.reject(e)}};h._combineSymbolParts=function(a,b){if(!a||0===a.length)return null;if(1===a.length)return{type:"CIMSymbolReference",symbol:a[0],primitiveOverrides:b};const c={...a[0],symbolLayers:[]};for(const e of a)c.symbolLayers.unshift(...e.symbolLayers);return{type:"CIMSymbolReference",symbol:c,primitiveOverrides:b}};h._cimPartsToCIMSymbol=async function(a,b,c){const e=Array(a.length);for(let f=0;f<a.length;f++)e[f]=this._getSymbolPart(a[f],c);a=await u.all(e);return new J({data:this._combineSymbolParts(a,
b)})};x._createClass(v,[{key:"arcadeRequired",get:function(){return!0}}]);return v}(L.VisualVariablesMixin(K));n.__decorate([p.property({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],l.prototype,"config",void 0);n.__decorate([p.property({type:Object,json:{write:!0}})],l.prototype,"fieldMap",void 0);n.__decorate([p.property({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],l.prototype,"scaleExpression",void 0);n.__decorate([y.writer("scaleExpression")],
l.prototype,"writeData",null);n.__decorate([p.property({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(q){return{enabled:!!q&&!!this.scaleExpression}}}}})],l.prototype,"scaleExpressionTitle",void 0);n.__decorate([p.property({type:String,json:{write:!0}})],l.prototype,"url",void 0);n.__decorate([y.writer("visualVariables")],l.prototype,"writeVisualVariables",null);return l=w=n.__decorate([F.subclass("esri.renderers.DictionaryRenderer")],
l)});